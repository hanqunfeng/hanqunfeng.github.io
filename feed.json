{"version":"https://jsonfeed.org/version/1","name":"飘逸峰的博客","home_page_url":"https://blog.hanqunfeng.com","feed_url":"https://blog.hanqunfeng.com/feed.json","author":{"name":"飘逸峰"},"items":[{"id":"https://blog.hanqunfeng.com/2023/08/08/spring-boot-security-session-rememberme/","url":"https://blog.hanqunfeng.com/2023/08/08/spring-boot-security-session-rememberme/","title":"SpringBoot Security--Session管理与RememberMe","content_html":"<!--\n **加粗**\n *斜体*\n ***加粗并斜体***\n ~~删除线~~\n ==突出显示==\n `突出显示(推荐)`\n ++下划线++\n ~下标~\n ^上标^\n 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.\n 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600)\n\n +++ **点击折叠**\n 这是被隐藏的内容\n +++\n\n::: tips success warning danger\n这里是容器内的内容\n:::\n\n% note info % success warning danger\n这里是容器内的内容\n% endnote %\n\n -->\n<h2 id=\"摘要\">摘要</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>本文介绍在SpringBoot Security中的Session管理与RememberMe</p>\n</li>\n<li class=\"lvl-2\">\n<p>实现了基于内存、Jdbc和Redis三种配置方式</p>\n</li>\n<li class=\"lvl-2\">\n<p>本文基于SpringBoot-2.7.14和SpringBoot-3.1.2</p>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"Security配置类\">Security配置类</h2>\n<h3 id=\"SpringBoot-2-7-14\">SpringBoot-2.7.14</h3>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.hanqf.config;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> com.hanqf.common.security.CP_UserDetailsService;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.hanqf.common.support.CP_ImageFilter;</span><br><span class=\"line\"><span class=\"keyword\">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Bean;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Configuration;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.authentication.AuthenticationManager;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.config.annotation.authentication.configuration.AuthenticationConfiguration;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.config.http.SessionCreationPolicy;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.core.session.SessionRegistry;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.crypto.password.PasswordEncoder;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.web.SecurityFilterChain;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.web.authentication.rememberme.PersistentTokenRepository;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.web.csrf.CookieCsrfTokenRepository;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.web.util.matcher.AntPathRequestMatcher;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * &lt;h1&gt;springboot升级到2.7.x以后的配置方法&lt;/h1&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Slf4j</span></span><br><span class=\"line\"><span class=\"meta\">@Configuration</span></span><br><span class=\"line\"><span class=\"meta\">@EnableGlobalMethodSecurity(prePostEnabled = true)</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">SpringSecurityConfig</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">    * session注册器，默认是基于内存的SessionRegistryImpl，也可以配置为jdbc或redis，下文会介绍</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> SessionRegistry sessionRegistry;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">    * Token存储库，用于记录remember me的用户信息，默认是基于内存的InMemoryTokenRepositoryImpl，也可以配置为jdbc或redis，下文会介绍</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> PersistentTokenRepository persistentTokenRepository;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">    * 验证码过滤器，负责登录时验证用户提交的验证码是否有效，本文对此不做介绍</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> CP_ImageFilter imageFilter;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">    * 不需要进行验证的url数组</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> String[] ignorings = &#123; <span class=\"string\">&quot;/login.do*&quot;</span>, <span class=\"string\">&quot;/**/*.json*&quot;</span>, <span class=\"string\">&quot;/**/*.xml*&quot;</span>, <span class=\"string\">&quot;/druid/**&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;/forgotPassword.do&quot;</span>, <span class=\"string\">&quot;/forgotPasswordEmail.do&quot;</span>, <span class=\"string\">&quot;/resetPassword.do&quot;</span></span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * AuthenticationManager（认证管理器）</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@Bean</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> AuthenticationManager <span class=\"title function_\">authenticationManager</span><span class=\"params\">(AuthenticationConfiguration authenticationConfiguration)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        log.info(<span class=\"string\">&quot;AuthenticationManager&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> authenticationConfiguration.getAuthenticationManager();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 定义一个能够与 HttpServletRequest 匹配的过滤器链。以确定它是否适用于该请求。</span></span><br><span class=\"line\"><span class=\"comment\">     * springboot升级到2.7.x以后的配置方式</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@Bean</span></span><br><span class=\"line\">    SecurityFilterChain <span class=\"title function_\">filterChain</span><span class=\"params\">(HttpSecurity http)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        log.info(<span class=\"string\">&quot;HttpSecurity&quot;</span>);</span><br><span class=\"line\">        <span class=\"comment\">//解决不允许显示在iframe中的问题</span></span><br><span class=\"line\">        http.headers().frameOptions().disable();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 设置拦截规则</span></span><br><span class=\"line\">        http.authorizeRequests()</span><br><span class=\"line\">                <span class=\"comment\">// 不需要验证的url</span></span><br><span class=\"line\">                .antMatchers(ignorings).permitAll()</span><br><span class=\"line\">                <span class=\"comment\">// 登录即可访问的url</span></span><br><span class=\"line\">                .antMatchers(<span class=\"string\">&quot;/&quot;</span>).authenticated()</span><br><span class=\"line\">                .antMatchers(<span class=\"string\">&quot;/index.do*&quot;</span>).authenticated()</span><br><span class=\"line\">                .antMatchers(<span class=\"string\">&quot;/welcome.do*&quot;</span>).authenticated()</span><br><span class=\"line\">                <span class=\"comment\">// 自定义规则进行验证,基于权限管理模型的认证,public Boolean hasPerssion(HttpServletRequest request, Authentication authentication)，本文不做介绍</span></span><br><span class=\"line\">                .antMatchers(<span class=\"string\">&quot;/**/*.do*&quot;</span>).access(<span class=\"string\">&quot;@rbacService.hasPerssion(request,authentication)&quot;</span>)</span><br><span class=\"line\">                .and()</span><br><span class=\"line\">                <span class=\"comment\">// 登录成功但是权限验证失败后的跳转地址</span></span><br><span class=\"line\">                .exceptionHandling().accessDeniedPage(<span class=\"string\">&quot;/access/denied.do&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 开启默认登录页面</span></span><br><span class=\"line\">        <span class=\"comment\">// http.formLogin();</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 自定义登录页面</span></span><br><span class=\"line\">        http.formLogin()</span><br><span class=\"line\">                .loginPage(<span class=\"string\">&quot;/login.do&quot;</span>)  <span class=\"comment\">// 登录页面</span></span><br><span class=\"line\">                .failureUrl(<span class=\"string\">&quot;/login.do?login_error=1&quot;</span>) <span class=\"comment\">// 登录失败跳转页面</span></span><br><span class=\"line\">                .defaultSuccessUrl(<span class=\"string\">&quot;/index.do&quot;</span>, <span class=\"literal\">true</span>)  <span class=\"comment\">// 登录成功默认跳转页面，这里设置true表示无论请求哪个地址，登录成功后都跳转到该页面</span></span><br><span class=\"line\">                .loginProcessingUrl(<span class=\"string\">&quot;/j_spring_security_check&quot;</span>) <span class=\"comment\">// 登录页面中的提交登录验证url, 默认 /login</span></span><br><span class=\"line\">                .usernameParameter(<span class=\"string\">&quot;j_username&quot;</span>)  <span class=\"comment\">// 登录页面中的用户名参数，默认username</span></span><br><span class=\"line\">                .passwordParameter(<span class=\"string\">&quot;j_password&quot;</span>)  <span class=\"comment\">// 登录页面中的密码参数，默认password</span></span><br><span class=\"line\">                .permitAll();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//关闭csrf，如果默认开启csrf，则在生成页面时会自动在每个form中增加一个隐藏属性&lt;input type=&quot;hidden&quot; name=&quot;_csrf&quot; value=&quot;95e8706b-8d22-4d62-9a27-3da5993e0a7d&quot;&gt;，</span></span><br><span class=\"line\">        <span class=\"comment\">// 实际上就是&lt;input type=&quot;hidden&quot; th:name=&quot;$&#123;_csrf.parameterName&#125;&quot; th:value=&quot;$&#123;_csrf.token&#125;&quot; /&gt;，js中如果需要使用时也可以使用该属性</span></span><br><span class=\"line\">        <span class=\"comment\">//http.csrf().disable();</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//开启csrf，默认开启，csrf不会拦截get请求</span></span><br><span class=\"line\">        http.csrf()</span><br><span class=\"line\">                <span class=\"comment\">//.csrfTokenRepository(new CookieCsrfTokenRepository()) //令牌存储方式，CookieCsrfTokenRepository或者HttpSessionCsrfTokenRepository，默认HttpSessionCsrfTokenRepository</span></span><br><span class=\"line\">                .csrfTokenRepository(CookieCsrfTokenRepository.withHttpOnlyFalse()) <span class=\"comment\">//关闭仅支持http浏览器请求，这样ajax和postMan都可以访问，header需要带上X-CSRF-TOKEN</span></span><br><span class=\"line\">                .ignoringAntMatchers(<span class=\"string\">&quot;/**/json.do*&quot;</span>, <span class=\"string\">&quot;/**/xml.do*&quot;</span>); <span class=\"comment\">//哪些不需要csrf，非浏览器直接访问的地址需要进行屏蔽，因为csrf标签只有页面会自动生成，另外认证接口也需要屏蔽，因为需要第一次获取CSRF-TOKEN</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 自定义注销，这里需要注意的是，如果启用了csrf(默认就是开启)，则logout只能是post提交，如果要get提交，则必须如下配置</span></span><br><span class=\"line\">        http.logout()</span><br><span class=\"line\">                <span class=\"comment\">// 在注销时清除认证信息</span></span><br><span class=\"line\">                .clearAuthentication(<span class=\"literal\">true</span>)</span><br><span class=\"line\">                .logoutRequestMatcher(<span class=\"keyword\">new</span> <span class=\"title class_\">AntPathRequestMatcher</span>(<span class=\"string\">&quot;/logout.do&quot;</span>)) <span class=\"comment\">//get</span></span><br><span class=\"line\">                <span class=\"comment\">//.logoutUrl(&quot;/logout.do&quot;)  //post</span></span><br><span class=\"line\">                .logoutSuccessUrl(<span class=\"string\">&quot;/login.do&quot;</span>)</span><br><span class=\"line\">                <span class=\"comment\">// 在注销时使HttpSession失效</span></span><br><span class=\"line\">                .invalidateHttpSession(<span class=\"literal\">true</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// session管理</span></span><br><span class=\"line\">        http.sessionManagement()</span><br><span class=\"line\">                <span class=\"comment\">//默认开启session</span></span><br><span class=\"line\">                .sessionCreationPolicy(SessionCreationPolicy.IF_REQUIRED)</span><br><span class=\"line\">                <span class=\"comment\">//每次登录验证将创建一个新的session</span></span><br><span class=\"line\">                .sessionFixation().migrateSession()</span><br><span class=\"line\">                <span class=\"comment\">//同一个用户最大的登录数量</span></span><br><span class=\"line\">                .maximumSessions(<span class=\"number\">1</span>)</span><br><span class=\"line\">                <span class=\"comment\">//true表示已经登录就不予许再次登录，false表示允许再次登录但是之前的登录会下线。</span></span><br><span class=\"line\">                .maxSessionsPreventsLogin(<span class=\"literal\">false</span>)</span><br><span class=\"line\">                <span class=\"comment\">//session被下线(超时)之后的显示页面</span></span><br><span class=\"line\">                .expiredUrl(<span class=\"string\">&quot;/access/sameLogin.do&quot;</span>)</span><br><span class=\"line\">                <span class=\"comment\">// 会话注册器</span></span><br><span class=\"line\">                .sessionRegistry(sessionRegistry);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// sessionRegistry是session注册器，默认是基于内存的SessionRegistryImpl，此时当用户注销时，Spring Security的默认行为是不会主动从SessionRegistry中移除相关的SessionInformation对象。这意味着注销后，SessionRegistryImpl中仍然保留该用户的会话信息。</span></span><br><span class=\"line\">        <span class=\"comment\">// 但是SessionRegistryImpl里对session的销毁和改变进行了事件监听，我们只需要注册事件发布者HttpSessionEventPublisher即可实现session的自动清理。</span></span><br><span class=\"line\">        <span class=\"comment\">//SessionRegistryImpl使用map来维护session信息，这样在分布式系统(多个副本)中获取会话数就不准确了，</span></span><br><span class=\"line\">        <span class=\"comment\">// 所以这里我们可以使用基于SpringSession的SpringSessionBackedSessionRegistry，其可以绑定基于jdbc的JdbcIndexedSessionRepository或者基于redis的RedisIndexedSessionRepository</span></span><br><span class=\"line\">        <span class=\"comment\">// 如果使用SpringSessionBackedSessionRegistry，这里就不需要HttpSessionEventPublisher的Bean，因为这里Session管理全部交由SpringSession去管理，也就是Session的相关清理工作会自动帮助我们完成。</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// RemeberMe</span></span><br><span class=\"line\">        <span class=\"comment\">//http.rememberMe().key(&quot;webmvc#FD637E6D9C0F1A5A67082AF56CE32485&quot;);</span></span><br><span class=\"line\">        <span class=\"comment\">//两周内免登录</span></span><br><span class=\"line\">        http.rememberMe()</span><br><span class=\"line\">                .rememberMeParameter(<span class=\"string\">&quot;_spring_security_remember_me&quot;</span>) <span class=\"comment\">// 默认 remember-me</span></span><br><span class=\"line\">                .rememberMeCookieName(<span class=\"string\">&quot;remember-me-cookie&quot;</span>)  <span class=\"comment\">//保存在浏览器端的cookie的名称，如果不设置默认也是remember-me</span></span><br><span class=\"line\">                .tokenValiditySeconds(<span class=\"number\">60</span> * <span class=\"number\">60</span> * <span class=\"number\">24</span> * <span class=\"number\">14</span>) <span class=\"comment\">// 单位秒 两周=60*60*24*14</span></span><br><span class=\"line\">                .tokenRepository(persistentTokenRepository); <span class=\"comment\">//Token存储库，用于记录remember me的用户信息，默认内存，也可以配置为数据库或者redis;</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 验证码过滤器</span></span><br><span class=\"line\">        http.addFilterBefore(imageFilter, UsernamePasswordAuthenticationFilter.class);</span><br><span class=\"line\">        <span class=\"comment\">// 设置userDetailsService</span></span><br><span class=\"line\">        http.userDetailsService(userDetailsService());</span><br><span class=\"line\">        <span class=\"keyword\">return</span> http.build();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * ignore的url</span></span><br><span class=\"line\"><span class=\"comment\">     * 如果你需要忽略URL，请考虑通过HttpSecurity.authorizeHttpRequests的permitAll来实现。</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"comment\">//@Bean</span></span><br><span class=\"line\">    <span class=\"comment\">//public WebSecurityCustomizer webSecurityCustomizer() &#123;</span></span><br><span class=\"line\">    <span class=\"comment\">//    return web -&gt; web.ignoring().antMatchers(ignorings);</span></span><br><span class=\"line\">    <span class=\"comment\">//&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 登录的时候需要获取用户信息，只有登录的时候使用，其余时候使用http.authorizeRequests()中配置的验证规则（验证时，用户名和权限都确定了）</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@Bean</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> CP_UserDetailsService <span class=\"title function_\">userDetailsService</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        log.info(<span class=\"string\">&quot;CP_UserDetailsService&quot;</span>);</span><br><span class=\"line\">        <span class=\"type\">CP_UserDetailsService</span> <span class=\"variable\">userDetailsService</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">CP_UserDetailsService</span>();</span><br><span class=\"line\">        <span class=\"keyword\">return</span> userDetailsService;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 认证日志</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@Bean</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> org.springframework.security.authentication.event.LoggerListener <span class=\"title function_\">loggerListener</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        log.info(<span class=\"string\">&quot;org.springframework.security.authentication.event.LoggerListener&quot;</span>);</span><br><span class=\"line\">        org.springframework.security.authentication.event.<span class=\"type\">LoggerListener</span> <span class=\"variable\">loggerListener</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">org</span>.springframework.security.authentication.event.LoggerListener();</span><br><span class=\"line\">        <span class=\"keyword\">return</span> loggerListener;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 请求日志</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@Bean</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> org.springframework.security.access.event.LoggerListener <span class=\"title function_\">eventLoggerListener</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        log.info(<span class=\"string\">&quot;org.springframework.security.access.event.LoggerListener&quot;</span>);</span><br><span class=\"line\">        org.springframework.security.access.event.<span class=\"type\">LoggerListener</span> <span class=\"variable\">eventLoggerListener</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">org</span>.springframework.security.access.event.LoggerListener();</span><br><span class=\"line\">        <span class=\"keyword\">return</span> eventLoggerListener;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 密码加密，在进行登录验证时会自动将页面提交的密码通过其进行加密</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@Bean</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> PasswordEncoder <span class=\"title function_\">passwordEncoder</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">BCryptPasswordEncoder</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"SpringBoot-3-1-2\">SpringBoot-3.1.2</h3>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.hanqf.config;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> com.hanqf.support.security.CP_ImageFilter;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.hanqf.support.security.CP_RbacService;</span><br><span class=\"line\"><span class=\"keyword\">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Bean;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Configuration;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.authentication.AuthenticationManager;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.authentication.event.LoggerListener;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.authorization.AuthorizationDecision;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.config.annotation.authentication.configuration.AuthenticationConfiguration;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.config.annotation.method.configuration.EnableMethodSecurity;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.config.annotation.web.configurers.HeadersConfigurer;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.config.http.SessionCreationPolicy;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.core.session.SessionRegistry;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.core.userdetails.User;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.core.userdetails.UserDetails;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.crypto.password.PasswordEncoder;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.provisioning.InMemoryUserDetailsManager;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.web.SecurityFilterChain;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.web.authentication.rememberme.PersistentTokenRepository;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.web.csrf.CookieCsrfTokenRepository;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.web.util.matcher.AntPathRequestMatcher;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Arrays;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.List;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * &lt;h1&gt;springboot升级到3.x.x以后的配置方法&lt;/h1&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Slf4j</span></span><br><span class=\"line\"><span class=\"meta\">@Configuration</span></span><br><span class=\"line\"><span class=\"meta\">@EnableMethodSecurity</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">SpringSecurityConfig</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> SessionRegistry sessionRegistry;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> PersistentTokenRepository persistentTokenRepository;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> CP_RbacService rbacService;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> CP_ImageFilter imageFilter;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> String[] ignorings = &#123;<span class=\"string\">&quot;/email/**&quot;</span>, <span class=\"string\">&quot;/actuator*/**&quot;</span>, <span class=\"string\">&quot;/admin*/**&quot;</span>, <span class=\"string\">&quot;/logger**&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;/rabbitmq/**&quot;</span>, <span class=\"string\">&quot;/checkcode/**&quot;</span>, <span class=\"string\">&quot;/resource/**&quot;</span>, <span class=\"string\">&quot;/**/*.jsp&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;/access/sameLogin.do&quot;</span>, <span class=\"string\">&quot;/**/*.json*&quot;</span>, <span class=\"string\">&quot;/**/*.xml*&quot;</span>, <span class=\"string\">&quot;/druid/**&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;/forgotPassword.do&quot;</span>, <span class=\"string\">&quot;/forgotPasswordEmail.do&quot;</span>, <span class=\"string\">&quot;/resetPassword.do&quot;</span></span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> List&lt;AntPathRequestMatcher&gt; ignoringsMatcherList;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">static</span> &#123;</span><br><span class=\"line\">       ignoringsMatcherList = Arrays.stream(ignorings).map(AntPathRequestMatcher::antMatcher).toList();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 获取AuthenticationManager（认证管理器），登录时认证使用</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> authenticationConfiguration</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span></span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@throws</span> Exception</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@Bean</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> AuthenticationManager <span class=\"title function_\">authenticationManager</span><span class=\"params\">(AuthenticationConfiguration authenticationConfiguration)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        log.info(<span class=\"string\">&quot;AuthenticationManager&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> authenticationConfiguration.getAuthenticationManager();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Bean</span></span><br><span class=\"line\">    SecurityFilterChain <span class=\"title function_\">filterChain</span><span class=\"params\">(HttpSecurity http)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        log.info(<span class=\"string\">&quot;HttpSecurity&quot;</span>);</span><br><span class=\"line\">        <span class=\"comment\">//解决不允许显示在iframe的问题</span></span><br><span class=\"line\">        http.headers(httpSecurityHeadersConfigurer -&gt; httpSecurityHeadersConfigurer</span><br><span class=\"line\">                .frameOptions(HeadersConfigurer.FrameOptionsConfig::disable));</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 设置拦截规则</span></span><br><span class=\"line\">        http.authorizeHttpRequests(authorizationManagerRequestMatcherRegistry -&gt; authorizationManagerRequestMatcherRegistry</span><br><span class=\"line\">                .requestMatchers(ignoringsMatcherList.toArray(AntPathRequestMatcher[]::<span class=\"keyword\">new</span>)).permitAll()</span><br><span class=\"line\">                .requestMatchers(AntPathRequestMatcher.antMatcher(<span class=\"string\">&quot;/login.do*&quot;</span>)).permitAll() <span class=\"comment\">// 登录请求不拦截</span></span><br><span class=\"line\">                .requestMatchers(AntPathRequestMatcher.antMatcher(<span class=\"string\">&quot;/index.do*&quot;</span>)).authenticated()</span><br><span class=\"line\">                .requestMatchers(AntPathRequestMatcher.antMatcher(<span class=\"string\">&quot;/*.do*&quot;</span>), AntPathRequestMatcher.antMatcher(<span class=\"string\">&quot;/**/*.do*&quot;</span>)).access((authentication, context) -&gt;</span><br><span class=\"line\">                        <span class=\"keyword\">new</span> <span class=\"title class_\">AuthorizationDecision</span>(rbacService.hasPerssion(context.getRequest(),authentication.get()))));</span><br><span class=\"line\">            <span class=\"comment\">// 这种方式效果同上，都是开启自定义认证</span></span><br><span class=\"line\">            <span class=\"comment\">//  .requestMatchers(AntPathRequestMatcher.antMatcher(&quot;/*.do*&quot;),AntPathRequestMatcher.antMatcher(&quot;/**/*.do*&quot;)).access(webExpressionAuthorizationManager()));</span></span><br><span class=\"line\"></span><br><span class=\"line\">        http.exceptionHandling(exceptionHandlingCustomizer -&gt; exceptionHandlingCustomizer</span><br><span class=\"line\">                .accessDeniedPage(<span class=\"string\">&quot;/access/denied.do&quot;</span>));</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 开启默认登录页面</span></span><br><span class=\"line\">        http.formLogin(httpSecurityFormLoginConfigurer -&gt; httpSecurityFormLoginConfigurer</span><br><span class=\"line\">                .loginPage(<span class=\"string\">&quot;/login.do&quot;</span>)</span><br><span class=\"line\">                .failureUrl(<span class=\"string\">&quot;/login.do?login_error=1&quot;</span>)</span><br><span class=\"line\">                .defaultSuccessUrl(<span class=\"string\">&quot;/index.do&quot;</span>, <span class=\"literal\">true</span>)</span><br><span class=\"line\">                .loginProcessingUrl(<span class=\"string\">&quot;/j_spring_security_check&quot;</span>) <span class=\"comment\">// 默认 /login</span></span><br><span class=\"line\">                .usernameParameter(<span class=\"string\">&quot;j_username&quot;</span>)  <span class=\"comment\">// 默认username</span></span><br><span class=\"line\">                .passwordParameter(<span class=\"string\">&quot;j_password&quot;</span>)  <span class=\"comment\">// 默认password</span></span><br><span class=\"line\">                .permitAll());</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//开启csrf，默认开启，csrf不会拦截get请求</span></span><br><span class=\"line\">        http.csrf(httpSecurityCsrfConfigurer -&gt; httpSecurityCsrfConfigurer</span><br><span class=\"line\">                <span class=\"comment\">//关闭仅支持http浏览器请求，这样ajax和postMan都可以访问，header需要带上X-CSRF-TOKEN</span></span><br><span class=\"line\">                .csrfTokenRepository(CookieCsrfTokenRepository.withHttpOnlyFalse())</span><br><span class=\"line\">                <span class=\"comment\">//哪些不需要csrf，非浏览器直接访问的地址需要进行屏蔽，因为csrf标签只有页面会自动生成，另外认证接口也需要屏蔽，因为需要第一次获取CSRF-TOKEN</span></span><br><span class=\"line\">                .ignoringRequestMatchers(AntPathRequestMatcher.antMatcher(<span class=\"string\">&quot;/**/json.do*&quot;</span>), AntPathRequestMatcher.antMatcher(<span class=\"string\">&quot;/**/xml.do*&quot;</span>)));</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 自定义注销，这里需要注意的是，如果启用了csrf(默认就是开启)，则logout只能是post提交，如果要get提交，则必须如下配置</span></span><br><span class=\"line\">        http.logout(httpSecurityLogoutConfigurer -&gt; httpSecurityLogoutConfigurer</span><br><span class=\"line\">                <span class=\"comment\">// 在注销时清除认证信息</span></span><br><span class=\"line\">                .clearAuthentication(<span class=\"literal\">true</span>)</span><br><span class=\"line\">                .logoutRequestMatcher(AntPathRequestMatcher.antMatcher(<span class=\"string\">&quot;/logout.do&quot;</span>)) <span class=\"comment\">//get</span></span><br><span class=\"line\">                <span class=\"comment\">//.logoutUrl(&quot;/logout.do&quot;)  //post</span></span><br><span class=\"line\">                .logoutSuccessUrl(<span class=\"string\">&quot;/login.do&quot;</span>)</span><br><span class=\"line\">                <span class=\"comment\">// 在注销时使HttpSession失效</span></span><br><span class=\"line\">                .invalidateHttpSession(<span class=\"literal\">true</span>));</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// session管理</span></span><br><span class=\"line\">        http.sessionManagement(httpSecuritySessionManagementConfigurer -&gt; httpSecuritySessionManagementConfigurer</span><br><span class=\"line\">                <span class=\"comment\">//默认开启session</span></span><br><span class=\"line\">                .sessionCreationPolicy(SessionCreationPolicy.IF_REQUIRED)</span><br><span class=\"line\">                <span class=\"comment\">//每次登录验证将创建一个新的session</span></span><br><span class=\"line\">                .sessionFixation().migrateSession()</span><br><span class=\"line\">                <span class=\"comment\">//同一个用户最大的登录数量</span></span><br><span class=\"line\">                .maximumSessions(<span class=\"number\">1</span>)</span><br><span class=\"line\">                <span class=\"comment\">//true表示已经登录就不予许再次登录，false表示允许再次登录但是之前的登录会下线。</span></span><br><span class=\"line\">                .maxSessionsPreventsLogin(<span class=\"literal\">false</span>)</span><br><span class=\"line\">                <span class=\"comment\">//session被下线(超时)之后的显示页面</span></span><br><span class=\"line\">                .expiredUrl(<span class=\"string\">&quot;/access/sameLogin.do&quot;</span>)</span><br><span class=\"line\">                .sessionRegistry(sessionRegistry));</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// RemeberMe 两周内免登录</span></span><br><span class=\"line\">        http.rememberMe(httpSecurityRememberMeConfigurer -&gt; httpSecurityRememberMeConfigurer</span><br><span class=\"line\">                .rememberMeParameter(<span class=\"string\">&quot;_spring_security_remember_me&quot;</span>) <span class=\"comment\">// 默认 remember-me</span></span><br><span class=\"line\">                .rememberMeCookieName(<span class=\"string\">&quot;remember-me-cookie&quot;</span>)  <span class=\"comment\">//保存在浏览器端的cookie的名称，如果不设置默认也是remember-me</span></span><br><span class=\"line\">                .tokenValiditySeconds(<span class=\"number\">60</span> * <span class=\"number\">60</span> * <span class=\"number\">24</span> * <span class=\"number\">14</span>)</span><br><span class=\"line\">                .tokenRepository(persistentTokenRepository));</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//设置userDetailsService</span></span><br><span class=\"line\">        http.userDetailsService(userDetailsService());</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 设置过滤器，这里是验证码过滤器</span></span><br><span class=\"line\">        http.addFilterBefore(imageFilter, UsernamePasswordAuthenticationFilter.class);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> http.build();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * web表达式认证管理器，支持自定义认证</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\"><span class=\"comment\">//    private WebExpressionAuthorizationManager webExpressionAuthorizationManager() &#123;</span></span><br><span class=\"line\"><span class=\"comment\">//        final var expressionHandler = new DefaultHttpSecurityExpressionHandler();</span></span><br><span class=\"line\"><span class=\"comment\">//        expressionHandler.setApplicationContext(applicationContext);</span></span><br><span class=\"line\"><span class=\"comment\">//        final var authorizationManager = new WebExpressionAuthorizationManager(&quot;@rbacService.hasPerssion(request,authentication)&quot;);</span></span><br><span class=\"line\"><span class=\"comment\">//        // 一定要设置expressionHandler，否则不生效</span></span><br><span class=\"line\"><span class=\"comment\">//        authorizationManager.setExpressionHandler(expressionHandler);</span></span><br><span class=\"line\"><span class=\"comment\">//        return authorizationManager;</span></span><br><span class=\"line\"><span class=\"comment\">//    &#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 基于内存的userDetailsService</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@Bean</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> InMemoryUserDetailsManager <span class=\"title function_\">userDetailsService</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        <span class=\"type\">UserDetails</span> <span class=\"variable\">user</span> <span class=\"operator\">=</span> User.builder()</span><br><span class=\"line\">                .username(<span class=\"string\">&quot;user&quot;</span>)</span><br><span class=\"line\">                <span class=\"comment\">// 123456</span></span><br><span class=\"line\">                .password(<span class=\"string\">&quot;$2a$10$JHj.XB.5RtpY60JEuTTGjuIT4m.hYT1yWoevJ6inU6Q7JE1qcvTYC&quot;</span>)</span><br><span class=\"line\">                .roles(<span class=\"string\">&quot;USER&quot;</span>)</span><br><span class=\"line\">                .build();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">UserDetails</span> <span class=\"variable\">admin</span> <span class=\"operator\">=</span> User.builder()</span><br><span class=\"line\">                .username(<span class=\"string\">&quot;admin&quot;</span>)</span><br><span class=\"line\">                <span class=\"comment\">// 123456</span></span><br><span class=\"line\">                .password(<span class=\"string\">&quot;$2a$10$JHj.XB.5RtpY60JEuTTGjuIT4m.hYT1yWoevJ6inU6Q7JE1qcvTYC&quot;</span>)</span><br><span class=\"line\">                .roles(<span class=\"string\">&quot;ADMIN&quot;</span>)</span><br><span class=\"line\">                .build();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">InMemoryUserDetailsManager</span>(user, admin);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 认证日志</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@Bean</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> LoggerListener <span class=\"title function_\">loggerListener</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        log.info(<span class=\"string\">&quot;org.springframework.security.authentication.event.LoggerListener&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">LoggerListener</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 密码加密策略</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@Bean</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> PasswordEncoder <span class=\"title function_\">passwordEncoder</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        log.info(<span class=\"string\">&quot;BCryptPasswordEncoder&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">BCryptPasswordEncoder</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"SessionRegistry–Session注册器\">SessionRegistry–Session注册器</h2>\n<h3 id=\"基于内存–SessionRegistryImpl\">基于内存–SessionRegistryImpl</h3>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.hanqf.config;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Bean;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Configuration;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.core.session.SessionRegistry;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.core.session.SessionRegistryImpl;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.web.session.HttpSessionEventPublisher;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * &lt;h1&gt;CommonSessionSpringSecurityConfig&lt;/h1&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Configuration</span></span><br><span class=\"line\"><span class=\"meta\">@Slf4j</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">CommonSessionSpringSecurityConfig</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 用于跟踪用户的会话信息，包括已经认证的用户和它们的会话（Session）。</span></span><br><span class=\"line\"><span class=\"comment\">     * 每当用户成功进行身份认证并建立了一个新的会话时，SessionRegistry将负责将该会话添加到其内部的数据结构中。</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@Bean</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> SessionRegistry <span class=\"title function_\">sessionRegistry</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        log.info(<span class=\"string\">&quot;CommonSessionRegistry&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">SessionRegistryImpl</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * session事件发布者</span></span><br><span class=\"line\"><span class=\"comment\">     * 如果使用SpringSessionBackedSessionRegistry，这里就不需要HttpSessionEventPublisher的Bean，而是交由SpringSession来管理</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@Bean</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> HttpSessionEventPublisher <span class=\"title function_\">httpSessionEventPublisher</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">HttpSessionEventPublisher</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"基于Spring-Session的jdbc\">基于Spring-Session的jdbc</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>maven依赖</p>\n</li>\n</ul>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.session<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-session-jdbc<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>建表语句<br>\n建表语句可在<code>spring-session-jdbc-[version].jar</code>的<code>org.springframework.session.jdbc</code>包路径中查看</p>\n</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.hanqf.config;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Configuration;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.session.jdbc.config.annotation.web.http.EnableJdbcHttpSession;</span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * &lt;h1&gt;jdbc-session&lt;/h1&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Configuration</span></span><br><span class=\"line\"><span class=\"meta\">@EnableJdbcHttpSession</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">JdbcSessionConfig</span> &#123;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.hanqf.config;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.boot.autoconfigure.AutoConfigureAfter;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Bean;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Configuration;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.core.session.SessionRegistry;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.session.jdbc.JdbcIndexedSessionRepository;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.session.security.SpringSessionBackedSessionRegistry;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * &lt;h1&gt;JdbcSessionSpringSecurityConfig&lt;/h1&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"meta\">@Slf4j</span></span><br><span class=\"line\"><span class=\"meta\">@Configuration</span></span><br><span class=\"line\"><span class=\"meta\">@AutoConfigureAfter(JdbcSessionConfig.class)</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">JdbcSessionSpringSecurityConfig</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> JdbcIndexedSessionRepository sessionRepository;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Bean</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> SessionRegistry <span class=\"title function_\">springSessionBackedSessionRegistry</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        log.info(<span class=\"string\">&quot;JdbcSessionRegistry&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">SpringSessionBackedSessionRegistry</span>&lt;&gt;(sessionRepository);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"基于Spring-Session的redis\">基于Spring-Session的redis</h3>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.session<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-session-data-redis<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.hanqf.config;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Configuration;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.session.data.redis.config.annotation.web.http.EnableRedisHttpSession;</span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * RedisSessionConfig</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"meta\">@Configuration</span></span><br><span class=\"line\"><span class=\"meta\">@EnableRedisHttpSession</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">RedisSessionConfig</span> &#123;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.hanqf.config;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.boot.autoconfigure.AutoConfigureAfter;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Bean;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Configuration;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.core.session.SessionRegistry;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.session.data.redis.RedisIndexedSessionRepository;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.session.security.SpringSessionBackedSessionRegistry;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * &lt;h1&gt;RedisSessionSpringSecurityConfig&lt;/h1&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"meta\">@Slf4j</span></span><br><span class=\"line\"><span class=\"meta\">@Configuration</span></span><br><span class=\"line\"><span class=\"meta\">@AutoConfigureAfter(RedisSessionConfig.class)</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">RedisSessionSpringSecurityConfig</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> RedisIndexedSessionRepository sessionRepository;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Bean</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> SessionRegistry <span class=\"title function_\">springSessionBackedSessionRegistry</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        log.info(<span class=\"string\">&quot;RedisSessionRegistry&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">SpringSessionBackedSessionRegistry</span>&lt;&gt;(sessionRepository);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"获取当前所有登录用户信息\">获取当前所有登录用户信息</h2>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.hanqf.common.session;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Date;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Map;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * &lt;h1&gt;HttpSession服务类&lt;/h1&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">interface</span> <span class=\"title class_\">HttpSessionService</span> &#123;</span><br><span class=\"line\">    Map&lt;String, Date&gt; <span class=\"title function_\">getAllPrincipals</span><span class=\"params\">()</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"基于内存–SessionRegistryImpl-2\">基于内存–SessionRegistryImpl</h3>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.hanqf.config;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> com.hanqf.common.session.HttpSessionService;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.core.session.SessionInformation;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.core.session.SessionRegistry;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.core.userdetails.User;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.stereotype.Component;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Date;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.HashMap;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Map;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Component</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">CommonHttpSessionService</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">HttpSessionService</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    SessionRegistry sessionRegistry;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> Map&lt;String, Date&gt; <span class=\"title function_\">getAllPrincipals</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        Map&lt;String, Date&gt; lastActivityDates = <span class=\"keyword\">new</span> <span class=\"title class_\">HashMap</span>&lt;&gt;();</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (Object principal : sessionRegistry.getAllPrincipals()) &#123;</span><br><span class=\"line\">            <span class=\"type\">String</span> <span class=\"variable\">username</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;&quot;</span>;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (principal <span class=\"keyword\">instanceof</span> User) &#123;</span><br><span class=\"line\">                username = ((User) principal).getUsername();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"comment\">// a principal may have multiple active sessions</span></span><br><span class=\"line\">            <span class=\"keyword\">for</span> (SessionInformation session : sessionRegistry.getAllSessions(</span><br><span class=\"line\">                    principal, <span class=\"literal\">false</span>)) &#123;</span><br><span class=\"line\">                <span class=\"comment\">// no last activity stored</span></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (lastActivityDates.get(username) == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">                    lastActivityDates.put(username, session.getLastRequest());</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                    <span class=\"comment\">// check to see if this session is newer than the last</span></span><br><span class=\"line\">                    <span class=\"comment\">// stored</span></span><br><span class=\"line\">                    <span class=\"type\">Date</span> <span class=\"variable\">prevLastRequest</span> <span class=\"operator\">=</span> lastActivityDates.get(username);</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (session.getLastRequest().after(prevLastRequest)) &#123;</span><br><span class=\"line\">                        <span class=\"comment\">// update if so</span></span><br><span class=\"line\">                        lastActivityDates.put(username, session.getLastRequest());</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> lastActivityDates;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"基于Spring-Session的jdbc-2\">基于Spring-Session的jdbc</h3>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.hanqf.config;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> com.hanqf.common.session.HttpSessionService;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.hanqf.function.session.dao.SpringSessionJpaRepository;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.hanqf.function.session.model.SpringSession;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.stereotype.Component;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Date;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.HashMap;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.List;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Map;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Component</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">JdbcHttpSessionService</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">HttpSessionService</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 基于JPA的dao对象，对应表为spring_session</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> SpringSessionJpaRepository springSessionJpaRepository;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> Map&lt;String, Date&gt; <span class=\"title function_\">getAllPrincipals</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        Map&lt;String, Date&gt; map = <span class=\"keyword\">new</span> <span class=\"title class_\">HashMap</span>&lt;&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">final</span> List&lt;SpringSession&gt; sessionList = springSessionJpaRepository.findSpringSessionsByExpiryTimeAfter(<span class=\"keyword\">new</span> <span class=\"title class_\">Date</span>().getTime());</span><br><span class=\"line\">            <span class=\"keyword\">for</span> (SpringSession springSession : sessionList) &#123;</span><br><span class=\"line\">                map.put(springSession.getPrincipalName(), <span class=\"keyword\">new</span> <span class=\"title class_\">Date</span>(springSession.getLastAccessTime()));</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> map;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"基于Spring-Session的redis-2\">基于Spring-Session的redis</h3>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.hanqf.config;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.hanqf.common.session.HttpSessionService;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.session.data.redis.RedisIndexedSessionRepository;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.stereotype.Component;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Date;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.HashMap;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Map;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Set;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Component</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">RedisHttpSessionService</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">HttpSessionService</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"type\">String</span> <span class=\"variable\">SESSION_SESSIONS</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;spring:session:index:org.springframework.session.FindByIndexNameSessionRepository.PRINCIPAL_NAME_INDEX_NAME:&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> RedisIndexedSessionRepository sessionRepository;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> ObjectMapper objectMapper;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> Map&lt;String, Date&gt; <span class=\"title function_\">getAllPrincipals</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        Map&lt;String, Date&gt; map = <span class=\"keyword\">new</span> <span class=\"title class_\">HashMap</span>&lt;&gt;();</span><br><span class=\"line\">        <span class=\"keyword\">final</span> Set&lt;String&gt; keys = redisTemplate.keys(SESSION_SESSIONS + <span class=\"string\">&quot;*&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">for</span> (String key : keys) &#123;</span><br><span class=\"line\">                <span class=\"type\">String</span> <span class=\"variable\">principalName</span> <span class=\"operator\">=</span> key.replace(SESSION_SESSIONS, <span class=\"string\">&quot;&quot;</span>);</span><br><span class=\"line\">                <span class=\"keyword\">final</span> <span class=\"type\">Map</span> <span class=\"variable\">byPrincipalName</span> <span class=\"operator\">=</span> sessionRepository.findByPrincipalName(principalName);</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (byPrincipalName != <span class=\"literal\">null</span> &amp;&amp; byPrincipalName.size() &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">final</span> <span class=\"type\">String</span> <span class=\"variable\">json</span> <span class=\"operator\">=</span> objectMapper.writeValueAsString(byPrincipalName);</span><br><span class=\"line\">                    <span class=\"keyword\">final</span> Map&lt;String, RedisSessionPojo&gt; redisSessionMap = objectMapper.readerForMapOf(RedisSessionPojo.class).readValue(json);</span><br><span class=\"line\">                    <span class=\"keyword\">for</span> (String mapKey : redisSessionMap.keySet()) &#123;</span><br><span class=\"line\">                        <span class=\"keyword\">final</span> <span class=\"type\">RedisSessionPojo</span> <span class=\"variable\">redisSession</span> <span class=\"operator\">=</span> redisSessionMap.get(mapKey);</span><br><span class=\"line\">                        <span class=\"keyword\">if</span> (!redisSession.getExpired()) &#123;</span><br><span class=\"line\">                            map.put(principalName, redisSession.getLastAccessedTime());</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> map;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Data</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">RedisSessionPojo</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> String id;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> Object attributeNames;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> String maxInactiveInterval;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> Boolean expired;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> Date lastAccessedTime;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> String creationTime;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"Remember-Me\">Remember-Me</h2>\n<h3 id=\"基于内存–InMemoryTokenRepositoryImpl\">基于内存–InMemoryTokenRepositoryImpl</h3>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.hanqf.config;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Bean;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Configuration;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.web.authentication.rememberme.InMemoryTokenRepositoryImpl;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.web.authentication.rememberme.PersistentTokenRepository;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Slf4j</span></span><br><span class=\"line\"><span class=\"meta\">@Configuration</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">CommonRememberMeConfig</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Bean</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> PersistentTokenRepository <span class=\"title function_\">persistentTokenRepository</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        log.info(<span class=\"string\">&quot;InMemoryTokenRepositoryImpl&quot;</span>);</span><br><span class=\"line\">        <span class=\"type\">InMemoryTokenRepositoryImpl</span> <span class=\"variable\">tokenRepository</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">InMemoryTokenRepositoryImpl</span>();</span><br><span class=\"line\">        <span class=\"keyword\">return</span> tokenRepository;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"基于jdbc\">基于jdbc</h3>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.hanqf.config;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Bean;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Configuration;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.web.authentication.rememberme.JdbcTokenRepositoryImpl;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.web.authentication.rememberme.PersistentTokenRepository;</span><br><span class=\"line\"><span class=\"keyword\">import</span> javax.sql.DataSource;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Slf4j</span></span><br><span class=\"line\"><span class=\"meta\">@Configuration</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">JdbcRememberMeConfig</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> DataSource dataSource;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * RemeberMe</span></span><br><span class=\"line\"><span class=\"comment\">     * 配置从数据库中获取token</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * CREATE TABLE `persistent_logins` (</span></span><br><span class=\"line\"><span class=\"comment\">     * `username` varchar(64) NOT NULL,</span></span><br><span class=\"line\"><span class=\"comment\">     * `series` varchar(64) NOT NULL,</span></span><br><span class=\"line\"><span class=\"comment\">     * `token` varchar(64) NOT NULL,</span></span><br><span class=\"line\"><span class=\"comment\">     * `last_used` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,</span></span><br><span class=\"line\"><span class=\"comment\">     * PRIMARY KEY (`series`)</span></span><br><span class=\"line\"><span class=\"comment\">     * ) ENGINE=InnoDB DEFAULT CHARSET=utf8;</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@Bean</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> PersistentTokenRepository <span class=\"title function_\">persistentTokenRepository</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        log.info(<span class=\"string\">&quot;JdbcTokenRepositoryImpl&quot;</span>);</span><br><span class=\"line\">        <span class=\"type\">JdbcTokenRepositoryImpl</span> <span class=\"variable\">tokenRepository</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">JdbcTokenRepositoryImpl</span>();</span><br><span class=\"line\">        <span class=\"comment\">//自动创建表，第一次运行时可是设置为true，让其自动创建表</span></span><br><span class=\"line\">        tokenRepository.setCreateTableOnStartup(<span class=\"literal\">false</span>);</span><br><span class=\"line\">        tokenRepository.setDataSource(dataSource);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> tokenRepository;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"基于redis\">基于redis</h3>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.hanqf.config;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> com.hanqf.common.RedisTokenRepositoryImpl;</span><br><span class=\"line\"><span class=\"keyword\">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.boot.autoconfigure.AutoConfigureAfter;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Bean;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Configuration;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.web.authentication.rememberme.PersistentTokenRepository;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Slf4j</span></span><br><span class=\"line\"><span class=\"meta\">@Configuration</span></span><br><span class=\"line\"><span class=\"meta\">@AutoConfigureAfter(RedisConfig.class)</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">RedisRememberMeConfig</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> RedisTemplate&lt;String ,Object&gt; redisTemplate;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * RemeberMe</span></span><br><span class=\"line\"><span class=\"comment\">     * redis，springSecurity没有提供基于redis的PersistentTokenRepository，需要我们自己创建</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@Bean</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> PersistentTokenRepository <span class=\"title function_\">persistentTokenRepository</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        log.info(<span class=\"string\">&quot;RedisTokenRepositoryImpl&quot;</span>);</span><br><span class=\"line\">        <span class=\"type\">RedisTokenRepositoryImpl</span> <span class=\"variable\">tokenRepository</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">RedisTokenRepositoryImpl</span>(redisTemplate);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> tokenRepository;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>自定义基于Redis的PersistentTokenRepository</p>\n</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.hanqf.common;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.dao.DataIntegrityViolationException;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.web.authentication.rememberme.PersistentRememberMeToken;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.web.authentication.rememberme.PersistentTokenRepository;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Date;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.HashMap;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Map;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.concurrent.TimeUnit;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Slf4j</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">RedisTokenRepositoryImpl</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">PersistentTokenRepository</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"type\">String</span> <span class=\"variable\">SERIES_PREFIX</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;spring:security:rememberMe:series:&quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"type\">String</span> <span class=\"variable\">USERNAME_PREFIX</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;spring:security:rememberMe:username:&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"title function_\">RedisTokenRepositoryImpl</span><span class=\"params\">(RedisTemplate&lt;String, Object&gt; redisTemplate)</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">this</span>.redisTemplate = redisTemplate;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> String <span class=\"title function_\">generateKey</span><span class=\"params\">(String prefix, String <span class=\"keyword\">var</span>)</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> prefix + <span class=\"keyword\">var</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">createNewToken</span><span class=\"params\">(PersistentRememberMeToken token)</span> &#123;</span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">key</span> <span class=\"operator\">=</span> generateKey(SERIES_PREFIX, token.getSeries());</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (Boolean.TRUE.equals(redisTemplate.persist(key))) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">DataIntegrityViolationException</span>(<span class=\"string\">&quot;Series Id &#x27;&quot;</span> + token.getSeries() + <span class=\"string\">&quot;&#x27; already exists!&quot;</span>);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">//创建一个hashmap</span></span><br><span class=\"line\">            Map&lt;String, String&gt; map = <span class=\"keyword\">new</span> <span class=\"title class_\">HashMap</span>&lt;&gt;();</span><br><span class=\"line\">            map.put(<span class=\"string\">&quot;username&quot;</span>, token.getUsername());</span><br><span class=\"line\">            map.put(<span class=\"string\">&quot;tokenValue&quot;</span>, token.getTokenValue());</span><br><span class=\"line\">            map.put(<span class=\"string\">&quot;date&quot;</span>, String.valueOf(token.getDate().getTime()));</span><br><span class=\"line\">            map.put(<span class=\"string\">&quot;series&quot;</span>, token.getSeries());</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//这里不能直接将PersistentRememberMeToken对象存入redis，因为这里使用的RedisTemplate是基于json的，要求对象必须有无参构造方法以及属性的setter和getter方法</span></span><br><span class=\"line\">            redisTemplate.opsForValue().set(key, map);</span><br><span class=\"line\">            redisTemplate.expire(key, <span class=\"number\">14</span>, TimeUnit.DAYS);</span><br><span class=\"line\">            redisTemplate.opsForValue().set(generateKey(USERNAME_PREFIX, token.getUsername()), token.getSeries());</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">updateToken</span><span class=\"params\">(String series, String tokenValue, Date lastUsed)</span> &#123;</span><br><span class=\"line\">        <span class=\"type\">PersistentRememberMeToken</span> <span class=\"variable\">token</span> <span class=\"operator\">=</span> <span class=\"built_in\">this</span>.getTokenForSeries(series);</span><br><span class=\"line\">        <span class=\"type\">PersistentRememberMeToken</span> <span class=\"variable\">newToken</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">PersistentRememberMeToken</span>(token.getUsername(), series, tokenValue, <span class=\"keyword\">new</span> <span class=\"title class_\">Date</span>());</span><br><span class=\"line\">        <span class=\"comment\">//创建一个hashmap</span></span><br><span class=\"line\">        Map&lt;String, String&gt; map = <span class=\"keyword\">new</span> <span class=\"title class_\">HashMap</span>&lt;&gt;();</span><br><span class=\"line\">        map.put(<span class=\"string\">&quot;username&quot;</span>, newToken.getUsername());</span><br><span class=\"line\">        map.put(<span class=\"string\">&quot;tokenValue&quot;</span>, newToken.getTokenValue());</span><br><span class=\"line\">        map.put(<span class=\"string\">&quot;date&quot;</span>, String.valueOf(newToken.getDate().getTime()));</span><br><span class=\"line\">        map.put(<span class=\"string\">&quot;series&quot;</span>, newToken.getSeries());</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">key</span> <span class=\"operator\">=</span> generateKey(SERIES_PREFIX, series);</span><br><span class=\"line\">        redisTemplate.opsForValue().set(key, map);</span><br><span class=\"line\">        redisTemplate.expire(key, <span class=\"number\">14</span>, TimeUnit.DAYS);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> PersistentRememberMeToken <span class=\"title function_\">getTokenForSeries</span><span class=\"params\">(String seriesId)</span> &#123;</span><br><span class=\"line\">        Map&lt;String, String&gt; map = (Map) redisTemplate.opsForValue().get(generateKey(SERIES_PREFIX, seriesId));</span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">username</span> <span class=\"operator\">=</span> map.get(<span class=\"string\">&quot;username&quot;</span>);</span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">tokenValue</span> <span class=\"operator\">=</span> map.get(<span class=\"string\">&quot;tokenValue&quot;</span>);</span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">date</span> <span class=\"operator\">=</span> map.get(<span class=\"string\">&quot;date&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"literal\">null</span> == username || <span class=\"literal\">null</span> == tokenValue || <span class=\"literal\">null</span> == date) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"type\">Long</span> <span class=\"variable\">timestamp</span> <span class=\"operator\">=</span> Long.valueOf(date);</span><br><span class=\"line\">        <span class=\"type\">Date</span> <span class=\"variable\">time</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Date</span>(timestamp);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">PersistentRememberMeToken</span> <span class=\"variable\">rememberMeToken</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">PersistentRememberMeToken</span>(username, seriesId, tokenValue, time);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> rememberMeToken;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">removeUserTokens</span><span class=\"params\">(String username)</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">//可能redis版本低于6用不了getAndDelete</span></span><br><span class=\"line\"><span class=\"comment\">//            String series = (String) redisTemplate.opsForValue().getAndDelete(generateKey(USERNAME_PREFIX, username));</span></span><br><span class=\"line\">            <span class=\"type\">String</span> <span class=\"variable\">series</span> <span class=\"operator\">=</span> (String) redisTemplate.opsForValue().get(generateKey(USERNAME_PREFIX, username));</span><br><span class=\"line\">            redisTemplate.delete(generateKey(USERNAME_PREFIX, username));</span><br><span class=\"line\">            redisTemplate.delete(generateKey(SERIES_PREFIX, series));</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">            log.error(e.getMessage());</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n","content_text":"摘要 本文介绍在SpringBoot Security中的Session管理与RememberMe 实现了基于内存、Jdbc和Redis三种配置方式 本文基于SpringBoot-2.7.14和SpringBoot-3.1.2 Security配置类 SpringBoot-2.7.14 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214package com.hanqf.config;import com.hanqf.common.security.CP_UserDetailsService;import com.hanqf.common.support.CP_ImageFilter;import lombok.extern.slf4j.Slf4j;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;import org.springframework.context.annotation.Bean;import org.springframework.context.annotation.Configuration;import org.springframework.security.authentication.AuthenticationManager;import org.springframework.security.config.annotation.authentication.configuration.AuthenticationConfiguration;import org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;import org.springframework.security.config.annotation.web.builders.HttpSecurity;import org.springframework.security.config.http.SessionCreationPolicy;import org.springframework.security.core.session.SessionRegistry;import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;import org.springframework.security.crypto.password.PasswordEncoder;import org.springframework.security.web.SecurityFilterChain;import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;import org.springframework.security.web.authentication.rememberme.PersistentTokenRepository;import org.springframework.security.web.csrf.CookieCsrfTokenRepository;import org.springframework.security.web.util.matcher.AntPathRequestMatcher;/** * &lt;h1&gt;springboot升级到2.7.x以后的配置方法&lt;/h1&gt; */@Slf4j@Configuration@EnableGlobalMethodSecurity(prePostEnabled = true)public class SpringSecurityConfig &#123; /** * session注册器，默认是基于内存的SessionRegistryImpl，也可以配置为jdbc或redis，下文会介绍 */ @Autowired private SessionRegistry sessionRegistry; /** * Token存储库，用于记录remember me的用户信息，默认是基于内存的InMemoryTokenRepositoryImpl，也可以配置为jdbc或redis，下文会介绍 */ @Autowired private PersistentTokenRepository persistentTokenRepository; /** * 验证码过滤器，负责登录时验证用户提交的验证码是否有效，本文对此不做介绍 */ @Autowired private CP_ImageFilter imageFilter; /** * 不需要进行验证的url数组 */ private String[] ignorings = &#123; &quot;/login.do*&quot;, &quot;/**/*.json*&quot;, &quot;/**/*.xml*&quot;, &quot;/druid/**&quot;, &quot;/forgotPassword.do&quot;, &quot;/forgotPasswordEmail.do&quot;, &quot;/resetPassword.do&quot; &#125;; /** * AuthenticationManager（认证管理器） */ @Bean public AuthenticationManager authenticationManager(AuthenticationConfiguration authenticationConfiguration) throws Exception &#123; log.info(&quot;AuthenticationManager&quot;); return authenticationConfiguration.getAuthenticationManager(); &#125; /** * 定义一个能够与 HttpServletRequest 匹配的过滤器链。以确定它是否适用于该请求。 * springboot升级到2.7.x以后的配置方式 */ @Bean SecurityFilterChain filterChain(HttpSecurity http) throws Exception &#123; log.info(&quot;HttpSecurity&quot;); //解决不允许显示在iframe中的问题 http.headers().frameOptions().disable(); // 设置拦截规则 http.authorizeRequests() // 不需要验证的url .antMatchers(ignorings).permitAll() // 登录即可访问的url .antMatchers(&quot;/&quot;).authenticated() .antMatchers(&quot;/index.do*&quot;).authenticated() .antMatchers(&quot;/welcome.do*&quot;).authenticated() // 自定义规则进行验证,基于权限管理模型的认证,public Boolean hasPerssion(HttpServletRequest request, Authentication authentication)，本文不做介绍 .antMatchers(&quot;/**/*.do*&quot;).access(&quot;@rbacService.hasPerssion(request,authentication)&quot;) .and() // 登录成功但是权限验证失败后的跳转地址 .exceptionHandling().accessDeniedPage(&quot;/access/denied.do&quot;); // 开启默认登录页面 // http.formLogin(); // 自定义登录页面 http.formLogin() .loginPage(&quot;/login.do&quot;) // 登录页面 .failureUrl(&quot;/login.do?login_error=1&quot;) // 登录失败跳转页面 .defaultSuccessUrl(&quot;/index.do&quot;, true) // 登录成功默认跳转页面，这里设置true表示无论请求哪个地址，登录成功后都跳转到该页面 .loginProcessingUrl(&quot;/j_spring_security_check&quot;) // 登录页面中的提交登录验证url, 默认 /login .usernameParameter(&quot;j_username&quot;) // 登录页面中的用户名参数，默认username .passwordParameter(&quot;j_password&quot;) // 登录页面中的密码参数，默认password .permitAll(); //关闭csrf，如果默认开启csrf，则在生成页面时会自动在每个form中增加一个隐藏属性&lt;input type=&quot;hidden&quot; name=&quot;_csrf&quot; value=&quot;95e8706b-8d22-4d62-9a27-3da5993e0a7d&quot;&gt;， // 实际上就是&lt;input type=&quot;hidden&quot; th:name=&quot;$&#123;_csrf.parameterName&#125;&quot; th:value=&quot;$&#123;_csrf.token&#125;&quot; /&gt;，js中如果需要使用时也可以使用该属性 //http.csrf().disable(); //开启csrf，默认开启，csrf不会拦截get请求 http.csrf() //.csrfTokenRepository(new CookieCsrfTokenRepository()) //令牌存储方式，CookieCsrfTokenRepository或者HttpSessionCsrfTokenRepository，默认HttpSessionCsrfTokenRepository .csrfTokenRepository(CookieCsrfTokenRepository.withHttpOnlyFalse()) //关闭仅支持http浏览器请求，这样ajax和postMan都可以访问，header需要带上X-CSRF-TOKEN .ignoringAntMatchers(&quot;/**/json.do*&quot;, &quot;/**/xml.do*&quot;); //哪些不需要csrf，非浏览器直接访问的地址需要进行屏蔽，因为csrf标签只有页面会自动生成，另外认证接口也需要屏蔽，因为需要第一次获取CSRF-TOKEN // 自定义注销，这里需要注意的是，如果启用了csrf(默认就是开启)，则logout只能是post提交，如果要get提交，则必须如下配置 http.logout() // 在注销时清除认证信息 .clearAuthentication(true) .logoutRequestMatcher(new AntPathRequestMatcher(&quot;/logout.do&quot;)) //get //.logoutUrl(&quot;/logout.do&quot;) //post .logoutSuccessUrl(&quot;/login.do&quot;) // 在注销时使HttpSession失效 .invalidateHttpSession(true); // session管理 http.sessionManagement() //默认开启session .sessionCreationPolicy(SessionCreationPolicy.IF_REQUIRED) //每次登录验证将创建一个新的session .sessionFixation().migrateSession() //同一个用户最大的登录数量 .maximumSessions(1) //true表示已经登录就不予许再次登录，false表示允许再次登录但是之前的登录会下线。 .maxSessionsPreventsLogin(false) //session被下线(超时)之后的显示页面 .expiredUrl(&quot;/access/sameLogin.do&quot;) // 会话注册器 .sessionRegistry(sessionRegistry); // sessionRegistry是session注册器，默认是基于内存的SessionRegistryImpl，此时当用户注销时，Spring Security的默认行为是不会主动从SessionRegistry中移除相关的SessionInformation对象。这意味着注销后，SessionRegistryImpl中仍然保留该用户的会话信息。 // 但是SessionRegistryImpl里对session的销毁和改变进行了事件监听，我们只需要注册事件发布者HttpSessionEventPublisher即可实现session的自动清理。 //SessionRegistryImpl使用map来维护session信息，这样在分布式系统(多个副本)中获取会话数就不准确了， // 所以这里我们可以使用基于SpringSession的SpringSessionBackedSessionRegistry，其可以绑定基于jdbc的JdbcIndexedSessionRepository或者基于redis的RedisIndexedSessionRepository // 如果使用SpringSessionBackedSessionRegistry，这里就不需要HttpSessionEventPublisher的Bean，因为这里Session管理全部交由SpringSession去管理，也就是Session的相关清理工作会自动帮助我们完成。 // RemeberMe //http.rememberMe().key(&quot;webmvc#FD637E6D9C0F1A5A67082AF56CE32485&quot;); //两周内免登录 http.rememberMe() .rememberMeParameter(&quot;_spring_security_remember_me&quot;) // 默认 remember-me .rememberMeCookieName(&quot;remember-me-cookie&quot;) //保存在浏览器端的cookie的名称，如果不设置默认也是remember-me .tokenValiditySeconds(60 * 60 * 24 * 14) // 单位秒 两周=60*60*24*14 .tokenRepository(persistentTokenRepository); //Token存储库，用于记录remember me的用户信息，默认内存，也可以配置为数据库或者redis; // 验证码过滤器 http.addFilterBefore(imageFilter, UsernamePasswordAuthenticationFilter.class); // 设置userDetailsService http.userDetailsService(userDetailsService()); return http.build(); &#125; /** * ignore的url * 如果你需要忽略URL，请考虑通过HttpSecurity.authorizeHttpRequests的permitAll来实现。 */ //@Bean //public WebSecurityCustomizer webSecurityCustomizer() &#123; // return web -&gt; web.ignoring().antMatchers(ignorings); //&#125; /** * 登录的时候需要获取用户信息，只有登录的时候使用，其余时候使用http.authorizeRequests()中配置的验证规则（验证时，用户名和权限都确定了） */ @Bean public CP_UserDetailsService userDetailsService() &#123; log.info(&quot;CP_UserDetailsService&quot;); CP_UserDetailsService userDetailsService = new CP_UserDetailsService(); return userDetailsService; &#125; /** * 认证日志 */ @Bean public org.springframework.security.authentication.event.LoggerListener loggerListener() &#123; log.info(&quot;org.springframework.security.authentication.event.LoggerListener&quot;); org.springframework.security.authentication.event.LoggerListener loggerListener = new org.springframework.security.authentication.event.LoggerListener(); return loggerListener; &#125; /** * 请求日志 */ @Bean public org.springframework.security.access.event.LoggerListener eventLoggerListener() &#123; log.info(&quot;org.springframework.security.access.event.LoggerListener&quot;); org.springframework.security.access.event.LoggerListener eventLoggerListener = new org.springframework.security.access.event.LoggerListener(); return eventLoggerListener; &#125; /** * 密码加密，在进行登录验证时会自动将页面提交的密码通过其进行加密 */ @Bean public PasswordEncoder passwordEncoder() &#123; return new BCryptPasswordEncoder(); &#125;&#125; SpringBoot-3.1.2 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215package com.hanqf.config;import com.hanqf.support.security.CP_ImageFilter;import com.hanqf.support.security.CP_RbacService;import lombok.extern.slf4j.Slf4j;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.context.annotation.Bean;import org.springframework.context.annotation.Configuration;import org.springframework.security.authentication.AuthenticationManager;import org.springframework.security.authentication.event.LoggerListener;import org.springframework.security.authorization.AuthorizationDecision;import org.springframework.security.config.annotation.authentication.configuration.AuthenticationConfiguration;import org.springframework.security.config.annotation.method.configuration.EnableMethodSecurity;import org.springframework.security.config.annotation.web.builders.HttpSecurity;import org.springframework.security.config.annotation.web.configurers.HeadersConfigurer;import org.springframework.security.config.http.SessionCreationPolicy;import org.springframework.security.core.session.SessionRegistry;import org.springframework.security.core.userdetails.User;import org.springframework.security.core.userdetails.UserDetails;import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;import org.springframework.security.crypto.password.PasswordEncoder;import org.springframework.security.provisioning.InMemoryUserDetailsManager;import org.springframework.security.web.SecurityFilterChain;import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;import org.springframework.security.web.authentication.rememberme.PersistentTokenRepository;import org.springframework.security.web.csrf.CookieCsrfTokenRepository;import org.springframework.security.web.util.matcher.AntPathRequestMatcher;import java.util.Arrays;import java.util.List;/** * &lt;h1&gt;springboot升级到3.x.x以后的配置方法&lt;/h1&gt; */@Slf4j@Configuration@EnableMethodSecuritypublic class SpringSecurityConfig &#123; @Autowired private SessionRegistry sessionRegistry; @Autowired private PersistentTokenRepository persistentTokenRepository; @Autowired private CP_RbacService rbacService; @Autowired private CP_ImageFilter imageFilter; private static String[] ignorings = &#123;&quot;/email/**&quot;, &quot;/actuator*/**&quot;, &quot;/admin*/**&quot;, &quot;/logger**&quot;, &quot;/rabbitmq/**&quot;, &quot;/checkcode/**&quot;, &quot;/resource/**&quot;, &quot;/**/*.jsp&quot;, &quot;/access/sameLogin.do&quot;, &quot;/**/*.json*&quot;, &quot;/**/*.xml*&quot;, &quot;/druid/**&quot;, &quot;/forgotPassword.do&quot;, &quot;/forgotPasswordEmail.do&quot;, &quot;/resetPassword.do&quot; &#125;; private static List&lt;AntPathRequestMatcher&gt; ignoringsMatcherList; static &#123; ignoringsMatcherList = Arrays.stream(ignorings).map(AntPathRequestMatcher::antMatcher).toList(); &#125; /** * 获取AuthenticationManager（认证管理器），登录时认证使用 * * @param authenticationConfiguration * @return * @throws Exception */ @Bean public AuthenticationManager authenticationManager(AuthenticationConfiguration authenticationConfiguration) throws Exception &#123; log.info(&quot;AuthenticationManager&quot;); return authenticationConfiguration.getAuthenticationManager(); &#125; @Bean SecurityFilterChain filterChain(HttpSecurity http) throws Exception &#123; log.info(&quot;HttpSecurity&quot;); //解决不允许显示在iframe的问题 http.headers(httpSecurityHeadersConfigurer -&gt; httpSecurityHeadersConfigurer .frameOptions(HeadersConfigurer.FrameOptionsConfig::disable)); // 设置拦截规则 http.authorizeHttpRequests(authorizationManagerRequestMatcherRegistry -&gt; authorizationManagerRequestMatcherRegistry .requestMatchers(ignoringsMatcherList.toArray(AntPathRequestMatcher[]::new)).permitAll() .requestMatchers(AntPathRequestMatcher.antMatcher(&quot;/login.do*&quot;)).permitAll() // 登录请求不拦截 .requestMatchers(AntPathRequestMatcher.antMatcher(&quot;/index.do*&quot;)).authenticated() .requestMatchers(AntPathRequestMatcher.antMatcher(&quot;/*.do*&quot;), AntPathRequestMatcher.antMatcher(&quot;/**/*.do*&quot;)).access((authentication, context) -&gt; new AuthorizationDecision(rbacService.hasPerssion(context.getRequest(),authentication.get())))); // 这种方式效果同上，都是开启自定义认证 // .requestMatchers(AntPathRequestMatcher.antMatcher(&quot;/*.do*&quot;),AntPathRequestMatcher.antMatcher(&quot;/**/*.do*&quot;)).access(webExpressionAuthorizationManager())); http.exceptionHandling(exceptionHandlingCustomizer -&gt; exceptionHandlingCustomizer .accessDeniedPage(&quot;/access/denied.do&quot;)); // 开启默认登录页面 http.formLogin(httpSecurityFormLoginConfigurer -&gt; httpSecurityFormLoginConfigurer .loginPage(&quot;/login.do&quot;) .failureUrl(&quot;/login.do?login_error=1&quot;) .defaultSuccessUrl(&quot;/index.do&quot;, true) .loginProcessingUrl(&quot;/j_spring_security_check&quot;) // 默认 /login .usernameParameter(&quot;j_username&quot;) // 默认username .passwordParameter(&quot;j_password&quot;) // 默认password .permitAll()); //开启csrf，默认开启，csrf不会拦截get请求 http.csrf(httpSecurityCsrfConfigurer -&gt; httpSecurityCsrfConfigurer //关闭仅支持http浏览器请求，这样ajax和postMan都可以访问，header需要带上X-CSRF-TOKEN .csrfTokenRepository(CookieCsrfTokenRepository.withHttpOnlyFalse()) //哪些不需要csrf，非浏览器直接访问的地址需要进行屏蔽，因为csrf标签只有页面会自动生成，另外认证接口也需要屏蔽，因为需要第一次获取CSRF-TOKEN .ignoringRequestMatchers(AntPathRequestMatcher.antMatcher(&quot;/**/json.do*&quot;), AntPathRequestMatcher.antMatcher(&quot;/**/xml.do*&quot;))); // 自定义注销，这里需要注意的是，如果启用了csrf(默认就是开启)，则logout只能是post提交，如果要get提交，则必须如下配置 http.logout(httpSecurityLogoutConfigurer -&gt; httpSecurityLogoutConfigurer // 在注销时清除认证信息 .clearAuthentication(true) .logoutRequestMatcher(AntPathRequestMatcher.antMatcher(&quot;/logout.do&quot;)) //get //.logoutUrl(&quot;/logout.do&quot;) //post .logoutSuccessUrl(&quot;/login.do&quot;) // 在注销时使HttpSession失效 .invalidateHttpSession(true)); // session管理 http.sessionManagement(httpSecuritySessionManagementConfigurer -&gt; httpSecuritySessionManagementConfigurer //默认开启session .sessionCreationPolicy(SessionCreationPolicy.IF_REQUIRED) //每次登录验证将创建一个新的session .sessionFixation().migrateSession() //同一个用户最大的登录数量 .maximumSessions(1) //true表示已经登录就不予许再次登录，false表示允许再次登录但是之前的登录会下线。 .maxSessionsPreventsLogin(false) //session被下线(超时)之后的显示页面 .expiredUrl(&quot;/access/sameLogin.do&quot;) .sessionRegistry(sessionRegistry)); // RemeberMe 两周内免登录 http.rememberMe(httpSecurityRememberMeConfigurer -&gt; httpSecurityRememberMeConfigurer .rememberMeParameter(&quot;_spring_security_remember_me&quot;) // 默认 remember-me .rememberMeCookieName(&quot;remember-me-cookie&quot;) //保存在浏览器端的cookie的名称，如果不设置默认也是remember-me .tokenValiditySeconds(60 * 60 * 24 * 14) .tokenRepository(persistentTokenRepository)); //设置userDetailsService http.userDetailsService(userDetailsService()); // 设置过滤器，这里是验证码过滤器 http.addFilterBefore(imageFilter, UsernamePasswordAuthenticationFilter.class); return http.build(); &#125; /** * web表达式认证管理器，支持自定义认证 */// private WebExpressionAuthorizationManager webExpressionAuthorizationManager() &#123;// final var expressionHandler = new DefaultHttpSecurityExpressionHandler();// expressionHandler.setApplicationContext(applicationContext);// final var authorizationManager = new WebExpressionAuthorizationManager(&quot;@rbacService.hasPerssion(request,authentication)&quot;);// // 一定要设置expressionHandler，否则不生效// authorizationManager.setExpressionHandler(expressionHandler);// return authorizationManager;// &#125; /** * 基于内存的userDetailsService */ @Bean public InMemoryUserDetailsManager userDetailsService() &#123; UserDetails user = User.builder() .username(&quot;user&quot;) // 123456 .password(&quot;$2a$10$JHj.XB.5RtpY60JEuTTGjuIT4m.hYT1yWoevJ6inU6Q7JE1qcvTYC&quot;) .roles(&quot;USER&quot;) .build(); UserDetails admin = User.builder() .username(&quot;admin&quot;) // 123456 .password(&quot;$2a$10$JHj.XB.5RtpY60JEuTTGjuIT4m.hYT1yWoevJ6inU6Q7JE1qcvTYC&quot;) .roles(&quot;ADMIN&quot;) .build(); return new InMemoryUserDetailsManager(user, admin); &#125; /** * 认证日志 */ @Bean public LoggerListener loggerListener() &#123; log.info(&quot;org.springframework.security.authentication.event.LoggerListener&quot;); return new LoggerListener(); &#125; /** * 密码加密策略 */ @Bean public PasswordEncoder passwordEncoder() &#123; log.info(&quot;BCryptPasswordEncoder&quot;); return new BCryptPasswordEncoder(); &#125;&#125; SessionRegistry–Session注册器 基于内存–SessionRegistryImpl 12345678910111213141516171819202122232425262728293031323334353637package com.hanqf.config;import lombok.extern.slf4j.Slf4j;import org.springframework.context.annotation.Bean;import org.springframework.context.annotation.Configuration;import org.springframework.security.core.session.SessionRegistry;import org.springframework.security.core.session.SessionRegistryImpl;import org.springframework.security.web.session.HttpSessionEventPublisher;/** * &lt;h1&gt;CommonSessionSpringSecurityConfig&lt;/h1&gt; */@Configuration@Slf4jpublic class CommonSessionSpringSecurityConfig &#123; /** * 用于跟踪用户的会话信息，包括已经认证的用户和它们的会话（Session）。 * 每当用户成功进行身份认证并建立了一个新的会话时，SessionRegistry将负责将该会话添加到其内部的数据结构中。 */ @Bean public SessionRegistry sessionRegistry() &#123; log.info(&quot;CommonSessionRegistry&quot;); return new SessionRegistryImpl(); &#125; /** * session事件发布者 * 如果使用SpringSessionBackedSessionRegistry，这里就不需要HttpSessionEventPublisher的Bean，而是交由SpringSession来管理 */ @Bean public HttpSessionEventPublisher httpSessionEventPublisher() &#123; return new HttpSessionEventPublisher(); &#125;&#125; 基于Spring-Session的jdbc maven依赖 1234&lt;dependency&gt; &lt;groupId&gt;org.springframework.session&lt;/groupId&gt; &lt;artifactId&gt;spring-session-jdbc&lt;/artifactId&gt;&lt;/dependency&gt; 建表语句 建表语句可在spring-session-jdbc-[version].jar的org.springframework.session.jdbc包路径中查看 123456789101112package com.hanqf.config;import org.springframework.context.annotation.Configuration;import org.springframework.session.jdbc.config.annotation.web.http.EnableJdbcHttpSession;/** * &lt;h1&gt;jdbc-session&lt;/h1&gt; */@Configuration@EnableJdbcHttpSessionpublic class JdbcSessionConfig &#123;&#125; 12345678910111213141516171819202122232425262728package com.hanqf.config;import lombok.extern.slf4j.Slf4j;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.boot.autoconfigure.AutoConfigureAfter;import org.springframework.context.annotation.Bean;import org.springframework.context.annotation.Configuration;import org.springframework.security.core.session.SessionRegistry;import org.springframework.session.jdbc.JdbcIndexedSessionRepository;import org.springframework.session.security.SpringSessionBackedSessionRegistry;/** * &lt;h1&gt;JdbcSessionSpringSecurityConfig&lt;/h1&gt; */@Slf4j@Configuration@AutoConfigureAfter(JdbcSessionConfig.class)public class JdbcSessionSpringSecurityConfig &#123; @Autowired private JdbcIndexedSessionRepository sessionRepository; @Bean public SessionRegistry springSessionBackedSessionRegistry() &#123; log.info(&quot;JdbcSessionRegistry&quot;); return new SpringSessionBackedSessionRegistry&lt;&gt;(sessionRepository); &#125;&#125; 基于Spring-Session的redis 1234&lt;dependency&gt; &lt;groupId&gt;org.springframework.session&lt;/groupId&gt; &lt;artifactId&gt;spring-session-data-redis&lt;/artifactId&gt;&lt;/dependency&gt; 1234567891011package com.hanqf.config;import org.springframework.context.annotation.Configuration;import org.springframework.session.data.redis.config.annotation.web.http.EnableRedisHttpSession;/** * RedisSessionConfig */@Configuration@EnableRedisHttpSessionpublic class RedisSessionConfig &#123;&#125; 1234567891011121314151617181920212223242526272829package com.hanqf.config;import lombok.extern.slf4j.Slf4j;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.boot.autoconfigure.AutoConfigureAfter;import org.springframework.context.annotation.Bean;import org.springframework.context.annotation.Configuration;import org.springframework.security.core.session.SessionRegistry;import org.springframework.session.data.redis.RedisIndexedSessionRepository;import org.springframework.session.security.SpringSessionBackedSessionRegistry;/** * &lt;h1&gt;RedisSessionSpringSecurityConfig&lt;/h1&gt; */@Slf4j@Configuration@AutoConfigureAfter(RedisSessionConfig.class)public class RedisSessionSpringSecurityConfig &#123; @Autowired private RedisIndexedSessionRepository sessionRepository; @Bean public SessionRegistry springSessionBackedSessionRegistry() &#123; log.info(&quot;RedisSessionRegistry&quot;); return new SpringSessionBackedSessionRegistry&lt;&gt;(sessionRepository); &#125;&#125; 获取当前所有登录用户信息 1234567891011package com.hanqf.common.session;import java.util.Date;import java.util.Map;/** * &lt;h1&gt;HttpSession服务类&lt;/h1&gt; */public interface HttpSessionService &#123; Map&lt;String, Date&gt; getAllPrincipals();&#125; 基于内存–SessionRegistryImpl 12345678910111213141516171819202122232425262728293031323334353637383940414243444546package com.hanqf.config;import com.hanqf.common.session.HttpSessionService;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.security.core.session.SessionInformation;import org.springframework.security.core.session.SessionRegistry;import org.springframework.security.core.userdetails.User;import org.springframework.stereotype.Component;import java.util.Date;import java.util.HashMap;import java.util.Map;@Componentpublic class CommonHttpSessionService implements HttpSessionService &#123; @Autowired SessionRegistry sessionRegistry; @Override public Map&lt;String, Date&gt; getAllPrincipals() &#123; Map&lt;String, Date&gt; lastActivityDates = new HashMap&lt;&gt;(); for (Object principal : sessionRegistry.getAllPrincipals()) &#123; String username = &quot;&quot;; if (principal instanceof User) &#123; username = ((User) principal).getUsername(); &#125; // a principal may have multiple active sessions for (SessionInformation session : sessionRegistry.getAllSessions( principal, false)) &#123; // no last activity stored if (lastActivityDates.get(username) == null) &#123; lastActivityDates.put(username, session.getLastRequest()); &#125; else &#123; // check to see if this session is newer than the last // stored Date prevLastRequest = lastActivityDates.get(username); if (session.getLastRequest().after(prevLastRequest)) &#123; // update if so lastActivityDates.put(username, session.getLastRequest()); &#125; &#125; &#125; &#125; return lastActivityDates; &#125;&#125; 基于Spring-Session的jdbc 12345678910111213141516171819202122232425262728293031323334353637package com.hanqf.config;import com.hanqf.common.session.HttpSessionService;import com.hanqf.function.session.dao.SpringSessionJpaRepository;import com.hanqf.function.session.model.SpringSession;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.stereotype.Component;import java.util.Date;import java.util.HashMap;import java.util.List;import java.util.Map;@Componentpublic class JdbcHttpSessionService implements HttpSessionService &#123; /** * 基于JPA的dao对象，对应表为spring_session */ @Autowired private SpringSessionJpaRepository springSessionJpaRepository; @Override public Map&lt;String, Date&gt; getAllPrincipals() &#123; Map&lt;String, Date&gt; map = new HashMap&lt;&gt;(); try &#123; final List&lt;SpringSession&gt; sessionList = springSessionJpaRepository.findSpringSessionsByExpiryTimeAfter(new Date().getTime()); for (SpringSession springSession : sessionList) &#123; map.put(springSession.getPrincipalName(), new Date(springSession.getLastAccessTime())); &#125; &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; return map; &#125;&#125; 基于Spring-Session的redis 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263package com.hanqf.config;import com.fasterxml.jackson.databind.ObjectMapper;import com.hanqf.common.session.HttpSessionService;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.data.redis.core.RedisTemplate;import org.springframework.session.data.redis.RedisIndexedSessionRepository;import org.springframework.stereotype.Component;import java.util.Date;import java.util.HashMap;import java.util.Map;import java.util.Set;@Componentpublic class RedisHttpSessionService implements HttpSessionService &#123; private final String SESSION_SESSIONS = &quot;spring:session:index:org.springframework.session.FindByIndexNameSessionRepository.PRINCIPAL_NAME_INDEX_NAME:&quot;; @Autowired private RedisTemplate&lt;String, Object&gt; redisTemplate; @Autowired private RedisIndexedSessionRepository sessionRepository; @Autowired private ObjectMapper objectMapper; @Override public Map&lt;String, Date&gt; getAllPrincipals() &#123; Map&lt;String, Date&gt; map = new HashMap&lt;&gt;(); final Set&lt;String&gt; keys = redisTemplate.keys(SESSION_SESSIONS + &quot;*&quot;); try &#123; for (String key : keys) &#123; String principalName = key.replace(SESSION_SESSIONS, &quot;&quot;); final Map byPrincipalName = sessionRepository.findByPrincipalName(principalName); if (byPrincipalName != null &amp;&amp; byPrincipalName.size() &gt; 0) &#123; final String json = objectMapper.writeValueAsString(byPrincipalName); final Map&lt;String, RedisSessionPojo&gt; redisSessionMap = objectMapper.readerForMapOf(RedisSessionPojo.class).readValue(json); for (String mapKey : redisSessionMap.keySet()) &#123; final RedisSessionPojo redisSession = redisSessionMap.get(mapKey); if (!redisSession.getExpired()) &#123; map.put(principalName, redisSession.getLastAccessedTime()); &#125; &#125; &#125; &#125; &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; return map; &#125;&#125;@Datapublic class RedisSessionPojo &#123; private String id; private Object attributeNames; private String maxInactiveInterval; private Boolean expired; private Date lastAccessedTime; private String creationTime;&#125; Remember-Me 基于内存–InMemoryTokenRepositoryImpl 12345678910111213141516171819package com.hanqf.config;import lombok.extern.slf4j.Slf4j;import org.springframework.context.annotation.Bean;import org.springframework.context.annotation.Configuration;import org.springframework.security.web.authentication.rememberme.InMemoryTokenRepositoryImpl;import org.springframework.security.web.authentication.rememberme.PersistentTokenRepository;@Slf4j@Configurationpublic class CommonRememberMeConfig &#123; @Bean public PersistentTokenRepository persistentTokenRepository() &#123; log.info(&quot;InMemoryTokenRepositoryImpl&quot;); InMemoryTokenRepositoryImpl tokenRepository = new InMemoryTokenRepositoryImpl(); return tokenRepository; &#125;&#125; 基于jdbc 123456789101112131415161718192021222324252627282930313233343536373839package com.hanqf.config;import lombok.extern.slf4j.Slf4j;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.context.annotation.Bean;import org.springframework.context.annotation.Configuration;import org.springframework.security.web.authentication.rememberme.JdbcTokenRepositoryImpl;import org.springframework.security.web.authentication.rememberme.PersistentTokenRepository;import javax.sql.DataSource;@Slf4j@Configurationpublic class JdbcRememberMeConfig &#123; @Autowired private DataSource dataSource; /** * RemeberMe * 配置从数据库中获取token * * CREATE TABLE `persistent_logins` ( * `username` varchar(64) NOT NULL, * `series` varchar(64) NOT NULL, * `token` varchar(64) NOT NULL, * `last_used` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP, * PRIMARY KEY (`series`) * ) ENGINE=InnoDB DEFAULT CHARSET=utf8; */ @Bean public PersistentTokenRepository persistentTokenRepository() &#123; log.info(&quot;JdbcTokenRepositoryImpl&quot;); JdbcTokenRepositoryImpl tokenRepository = new JdbcTokenRepositoryImpl(); //自动创建表，第一次运行时可是设置为true，让其自动创建表 tokenRepository.setCreateTableOnStartup(false); tokenRepository.setDataSource(dataSource); return tokenRepository; &#125;&#125; 基于redis 123456789101112131415161718192021222324252627282930package com.hanqf.config;import com.hanqf.common.RedisTokenRepositoryImpl;import lombok.extern.slf4j.Slf4j;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.boot.autoconfigure.AutoConfigureAfter;import org.springframework.context.annotation.Bean;import org.springframework.context.annotation.Configuration;import org.springframework.data.redis.core.RedisTemplate;import org.springframework.security.web.authentication.rememberme.PersistentTokenRepository;@Slf4j@Configuration@AutoConfigureAfter(RedisConfig.class)public class RedisRememberMeConfig &#123; @Autowired private RedisTemplate&lt;String ,Object&gt; redisTemplate; /** * RemeberMe * redis，springSecurity没有提供基于redis的PersistentTokenRepository，需要我们自己创建 */ @Bean public PersistentTokenRepository persistentTokenRepository() &#123; log.info(&quot;RedisTokenRepositoryImpl&quot;); RedisTokenRepositoryImpl tokenRepository = new RedisTokenRepositoryImpl(redisTemplate); return tokenRepository; &#125;&#125; 自定义基于Redis的PersistentTokenRepository 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596package com.hanqf.common;import lombok.extern.slf4j.Slf4j;import org.springframework.dao.DataIntegrityViolationException;import org.springframework.data.redis.core.RedisTemplate;import org.springframework.security.web.authentication.rememberme.PersistentRememberMeToken;import org.springframework.security.web.authentication.rememberme.PersistentTokenRepository;import java.util.Date;import java.util.HashMap;import java.util.Map;import java.util.concurrent.TimeUnit;@Slf4jpublic class RedisTokenRepositoryImpl implements PersistentTokenRepository &#123; private final String SERIES_PREFIX = &quot;spring:security:rememberMe:series:&quot;; private final String USERNAME_PREFIX = &quot;spring:security:rememberMe:username:&quot;; private RedisTemplate&lt;String, Object&gt; redisTemplate; public RedisTokenRepositoryImpl(RedisTemplate&lt;String, Object&gt; redisTemplate) &#123; this.redisTemplate = redisTemplate; &#125; private String generateKey(String prefix, String var) &#123; return prefix + var; &#125; @Override public void createNewToken(PersistentRememberMeToken token) &#123; String key = generateKey(SERIES_PREFIX, token.getSeries()); if (Boolean.TRUE.equals(redisTemplate.persist(key))) &#123; throw new DataIntegrityViolationException(&quot;Series Id &#x27;&quot; + token.getSeries() + &quot;&#x27; already exists!&quot;); &#125; else &#123; //创建一个hashmap Map&lt;String, String&gt; map = new HashMap&lt;&gt;(); map.put(&quot;username&quot;, token.getUsername()); map.put(&quot;tokenValue&quot;, token.getTokenValue()); map.put(&quot;date&quot;, String.valueOf(token.getDate().getTime())); map.put(&quot;series&quot;, token.getSeries()); //这里不能直接将PersistentRememberMeToken对象存入redis，因为这里使用的RedisTemplate是基于json的，要求对象必须有无参构造方法以及属性的setter和getter方法 redisTemplate.opsForValue().set(key, map); redisTemplate.expire(key, 14, TimeUnit.DAYS); redisTemplate.opsForValue().set(generateKey(USERNAME_PREFIX, token.getUsername()), token.getSeries()); &#125; &#125; @Override public void updateToken(String series, String tokenValue, Date lastUsed) &#123; PersistentRememberMeToken token = this.getTokenForSeries(series); PersistentRememberMeToken newToken = new PersistentRememberMeToken(token.getUsername(), series, tokenValue, new Date()); //创建一个hashmap Map&lt;String, String&gt; map = new HashMap&lt;&gt;(); map.put(&quot;username&quot;, newToken.getUsername()); map.put(&quot;tokenValue&quot;, newToken.getTokenValue()); map.put(&quot;date&quot;, String.valueOf(newToken.getDate().getTime())); map.put(&quot;series&quot;, newToken.getSeries()); String key = generateKey(SERIES_PREFIX, series); redisTemplate.opsForValue().set(key, map); redisTemplate.expire(key, 14, TimeUnit.DAYS); &#125; @Override public PersistentRememberMeToken getTokenForSeries(String seriesId) &#123; Map&lt;String, String&gt; map = (Map) redisTemplate.opsForValue().get(generateKey(SERIES_PREFIX, seriesId)); String username = map.get(&quot;username&quot;); String tokenValue = map.get(&quot;tokenValue&quot;); String date = map.get(&quot;date&quot;); if (null == username || null == tokenValue || null == date) &#123; return null; &#125; Long timestamp = Long.valueOf(date); Date time = new Date(timestamp); PersistentRememberMeToken rememberMeToken = new PersistentRememberMeToken(username, seriesId, tokenValue, time); return rememberMeToken; &#125; @Override public void removeUserTokens(String username) &#123; try &#123; //可能redis版本低于6用不了getAndDelete// String series = (String) redisTemplate.opsForValue().getAndDelete(generateKey(USERNAME_PREFIX, username)); String series = (String) redisTemplate.opsForValue().get(generateKey(USERNAME_PREFIX, username)); redisTemplate.delete(generateKey(USERNAME_PREFIX, username)); redisTemplate.delete(generateKey(SERIES_PREFIX, series)); &#125; catch (Exception e) &#123; log.error(e.getMessage()); &#125; &#125;&#125;","summary":"摘要 本文介绍在SpringBoot Security中的Session管理与RememberMe 实现了基于内存、Jdbc和Redis三种配置方式 本文基于SpringBoot-2.7.14和SpringBoot-3.1.2","date_published":"2023-08-08T14:30:05.000Z","tags":["技术","springboot","springsecurity","java"]},{"id":"https://blog.hanqunfeng.com/2023/07/19/aws-eks19-autoscaler-karpenter/","url":"https://blog.hanqunfeng.com/2023/07/19/aws-eks19-autoscaler-karpenter/","title":"AWS-EKS-19--Autoscaling 之 Karpenter","content_html":"<!--\n **加粗**\n *斜体*\n ***加粗并斜体***\n ~~删除线~~\n ==突出显示==\n `突出显示(推荐)`\n ++下划线++\n ~下标~\n ^上标^\n 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.\n 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600)\n\n +++ **点击折叠**\n 这是被隐藏的内容\n +++\n\n::: tips success warning danger\n这里是容器内的内容\n:::\n\n% note info % success warning danger\n这里是容器内的内容\n% endnote %\n\n -->\n<h2 id=\"摘要\">摘要</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>本文介绍EKS集群Autoscaling 之 Karpenter</p>\n</li>\n<li class=\"lvl-2\">\n<p>参考资料：</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\"><a href=\"https://docs.aws.amazon.com/zh_cn/eks/latest/userguide\">Amazon EKS用户指南</a></li>\n<li class=\"lvl-6\"><a href=\"https://kubernetes.io/zh-cn/docs/home/\">Kubernetes 文档</a></li>\n</ul>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"Karperter是什么？\">Karperter是什么？</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><a href=\"https://karpenter.sh/docs/\">Karpenter</a> 是一个开源集群自动缩放器，可以自动为不可安排的pod提供新节点。Karpenter评估了挂起的pod的聚合资源需求，并选择运行它们的最佳实例类型。它将自动扩展或终止没有任何非daemonset pod的实例，以减少浪费。它还支持整合功能，该功能将积极移动pod，并用更便宜的版本删除或替换节点，以降低集群成本。</p>\n</li>\n<li class=\"lvl-2\">\n<p>Karpenter 是aws为 k8s 构建的能用于生产环境的开源的工作节点动态调度控制器。</p>\n</li>\n<li class=\"lvl-2\">\n<p>在Karpenter推出之前，Kubernetes用户主要依靠Amazon EC2 Auto Scaling组和Kubernetes Cluster Autoscaler（CAS）来动态调整其集群的计算容量。</p>\n</li>\n<li class=\"lvl-2\">\n<p>相较于传统的 Cluster Autoscaler 工具，Karpenter 具有调度速度快、更灵活、资源利用率高等众多优势，另外，Karpenter与Kubernetes版本没有那么紧密耦合（像CAS那样），所以其是 EKS 自动扩缩容的首选方案，两者的比较可以参考下图。</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>特 性</th>\n<th>Cluster Autoscaler</th>\n<th>Karpenter</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>资源管理</td>\n<td>Cluster Autoscaler基于现有节点的资源利用率采用反应性方法来扩展节点。</td>\n<td>Karpenter基于未调度的Pod的当前资源需求采取主动方法来进行节点预配。</td>\n</tr>\n<tr>\n<td>节点管理</td>\n<td>Cluster Autoscaler根据当前工作负载的资源需求来管理节点，使用预定义的自动缩放组。</td>\n<td>Karpenter根据自定义预配程序的配置来扩展、预配和管理节点。</td>\n</tr>\n<tr>\n<td>扩展</td>\n<td>Cluster Autoscaler更专注于节点级别的扩展，这意味着它可以有效地添加更多的节点以满足需求的增加。 但这也意味着它在缩减资源方面可能不太有效。</td>\n<td>Karpenter根据特定的工作负载需求提供更有效和精细的扩展功能。换句话说，它根据实际使用情况进行扩展。它还允许用户指定特定的扩展策略或规则以满足其需求。</td>\n</tr>\n<tr>\n<td>调度</td>\n<td>使用Cluster Autoscaler进行调度更简单，因为它是根据工作负载的当前需求设计的进行扩展或缩减。</td>\n<td>Karpenter可以根据可用区和资源需求有效地调度工作负载。它可以尝试通过Spot实例来优化成本，但它不会知道你已经在aws帐号中做的任何承诺，如RI（预留实例）或Savings Plans（储蓄计划）。</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"Karpenter-运行环境准备\">Karpenter 运行环境准备</h2>\n<h3 id=\"设置环境变量\">设置环境变量</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># aws认证profile</span></span><br><span class=\"line\">$ AWS_PROFILE=eks-us-west-2</span><br><span class=\"line\"><span class=\"comment\"># EKS集群名称</span></span><br><span class=\"line\">$ CLUSTER_NAME=eks-lexing</span><br><span class=\"line\"><span class=\"comment\"># AWS分区</span></span><br><span class=\"line\"><span class=\"comment\"># if you are not using standard partitions, you may need to configure to aws-cn / aws-us-gov</span></span><br><span class=\"line\">$ AWS_PARTITION=<span class=\"string\">&quot;aws&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># EKS所在的Region</span></span><br><span class=\"line\">$ AWS_REGION=<span class=\"string\">&quot;<span class=\"subst\">$(aws configure list | grep region | tr -s <span class=\"string\">&quot; &quot;</span> | cut -d<span class=\"string\">&quot; &quot;</span> -f3)</span>&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># EKS配置OIDC的Endpoint</span></span><br><span class=\"line\">$ OIDC_ENDPOINT=<span class=\"string\">&quot;<span class=\"subst\">$(aws eks describe-cluster --name $&#123;CLUSTER_NAME&#125; --query <span class=\"string\">&quot;cluster.identity.oidc.issuer&quot;</span> --output text)</span>&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># aws帐号ID</span></span><br><span class=\"line\">$ AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query <span class=\"string\">&#x27;Account&#x27;</span> --output text)</span><br></pre></td></tr></table></figure>\n<h3 id=\"创建-Karpenter-的-node-需要的-role\">创建 Karpenter 的 node 需要的 role</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>1.创建role</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ <span class=\"built_in\">echo</span> <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;Version&quot;: &quot;2012-10-17&quot;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;Statement&quot;: [</span></span><br><span class=\"line\"><span class=\"string\">        &#123;</span></span><br><span class=\"line\"><span class=\"string\">            &quot;Effect&quot;: &quot;Allow&quot;,</span></span><br><span class=\"line\"><span class=\"string\">            &quot;Principal&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">                &quot;Service&quot;: &quot;ec2.amazonaws.com&quot;</span></span><br><span class=\"line\"><span class=\"string\">            &#125;,</span></span><br><span class=\"line\"><span class=\"string\">            &quot;Action&quot;: &quot;sts:AssumeRole&quot;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;</span></span><br><span class=\"line\"><span class=\"string\">    ]</span></span><br><span class=\"line\"><span class=\"string\">&#125;&#x27;</span> &gt; node-trust-policy.json</span><br><span class=\"line\"></span><br><span class=\"line\">$ aws iam create-role --role-name <span class=\"string\">&quot;KarpenterNodeRole-<span class=\"variable\">$&#123;CLUSTER_NAME&#125;</span>&quot;</span> \\</span><br><span class=\"line\">    --assume-role-policy-document file://node-trust-policy.json</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;Role&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;Path&quot;</span>: <span class=\"string\">&quot;/&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;RoleName&quot;</span>: <span class=\"string\">&quot;KarpenterNodeRole-eks-lexing&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;RoleId&quot;</span>: <span class=\"string\">&quot;AROA22DP3G4GH4RZQFGR7&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;Arn&quot;</span>: <span class=\"string\">&quot;arn:aws:iam::743263909644:role/KarpenterNodeRole-eks-lexing&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;CreateDate&quot;</span>: <span class=\"string\">&quot;2023-07-19T07:20:17+00:00&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;AssumeRolePolicyDocument&quot;</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;Version&quot;</span>: <span class=\"string\">&quot;2012-10-17&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;Statement&quot;</span>: [</span><br><span class=\"line\">                &#123;</span><br><span class=\"line\">                    <span class=\"string\">&quot;Effect&quot;</span>: <span class=\"string\">&quot;Allow&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;Principal&quot;</span>: &#123;</span><br><span class=\"line\">                        <span class=\"string\">&quot;Service&quot;</span>: <span class=\"string\">&quot;ec2.amazonaws.com&quot;</span></span><br><span class=\"line\">                    &#125;,</span><br><span class=\"line\">                    <span class=\"string\">&quot;Action&quot;</span>: <span class=\"string\">&quot;sts:AssumeRole&quot;</span></span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            ]</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>2.给这个 role 添加 policy</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ aws iam attach-role-policy --role-name <span class=\"string\">&quot;KarpenterNodeRole-<span class=\"variable\">$&#123;CLUSTER_NAME&#125;</span>&quot;</span> \\</span><br><span class=\"line\">    --policy-arn arn:<span class=\"variable\">$&#123;AWS_PARTITION&#125;</span>:iam::aws:policy/AmazonEKSWorkerNodePolicy</span><br><span class=\"line\"></span><br><span class=\"line\">$ aws iam attach-role-policy --role-name <span class=\"string\">&quot;KarpenterNodeRole-<span class=\"variable\">$&#123;CLUSTER_NAME&#125;</span>&quot;</span> \\</span><br><span class=\"line\">    --policy-arn arn:<span class=\"variable\">$&#123;AWS_PARTITION&#125;</span>:iam::aws:policy/AmazonEKS_CNI_Policy</span><br><span class=\"line\"></span><br><span class=\"line\">$ aws iam attach-role-policy --role-name <span class=\"string\">&quot;KarpenterNodeRole-<span class=\"variable\">$&#123;CLUSTER_NAME&#125;</span>&quot;</span> \\</span><br><span class=\"line\">    --policy-arn arn:<span class=\"variable\">$&#123;AWS_PARTITION&#125;</span>:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly</span><br><span class=\"line\"></span><br><span class=\"line\">$ aws iam attach-role-policy --role-name <span class=\"string\">&quot;KarpenterNodeRole-<span class=\"variable\">$&#123;CLUSTER_NAME&#125;</span>&quot;</span> \\</span><br><span class=\"line\">    --policy-arn arn:<span class=\"variable\">$&#123;AWS_PARTITION&#125;</span>:iam::aws:policy/AmazonSSMManagedInstanceCore</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>3.把 role 授予 EC2 的 instance profile</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ aws iam create-instance-profile \\</span><br><span class=\"line\">    --instance-profile-name <span class=\"string\">&quot;KarpenterNodeInstanceProfile-<span class=\"variable\">$&#123;CLUSTER_NAME&#125;</span>&quot;</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;InstanceProfile&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;Path&quot;</span>: <span class=\"string\">&quot;/&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;InstanceProfileName&quot;</span>: <span class=\"string\">&quot;KarpenterNodeInstanceProfile-eks-lexing&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;InstanceProfileId&quot;</span>: <span class=\"string\">&quot;AIPA22DP3G4GBMSNSBEQF&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;Arn&quot;</span>: <span class=\"string\">&quot;arn:aws:iam::743263909644:instance-profile/KarpenterNodeInstanceProfile-eks-lexing&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;CreateDate&quot;</span>: <span class=\"string\">&quot;2023-07-19T07:24:19+00:00&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;Roles&quot;</span>: []</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">$ aws iam add-role-to-instance-profile \\</span><br><span class=\"line\">    --instance-profile-name <span class=\"string\">&quot;KarpenterNodeInstanceProfile-<span class=\"variable\">$&#123;CLUSTER_NAME&#125;</span>&quot;</span> \\</span><br><span class=\"line\">    --role-name <span class=\"string\">&quot;KarpenterNodeRole-<span class=\"variable\">$&#123;CLUSTER_NAME&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"创建-Karpenter-controller-需要的-role\">创建 Karpenter controller 需要的 role</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>1.创建role</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ <span class=\"built_in\">cat</span> &lt;&lt; <span class=\"string\">EOF &gt; controller-trust-policy.json</span></span><br><span class=\"line\"><span class=\"string\">&#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;Version&quot;: &quot;2012-10-17&quot;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;Statement&quot;: [</span></span><br><span class=\"line\"><span class=\"string\">        &#123;</span></span><br><span class=\"line\"><span class=\"string\">            &quot;Effect&quot;: &quot;Allow&quot;,</span></span><br><span class=\"line\"><span class=\"string\">            &quot;Principal&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">                &quot;Federated&quot;: &quot;arn:$&#123;AWS_PARTITION&#125;:iam::$&#123;AWS_ACCOUNT_ID&#125;:oidc-provider/$&#123;OIDC_ENDPOINT#*//&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\">            &#125;,</span></span><br><span class=\"line\"><span class=\"string\">            &quot;Action&quot;: &quot;sts:AssumeRoleWithWebIdentity&quot;,</span></span><br><span class=\"line\"><span class=\"string\">            &quot;Condition&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">                &quot;StringEquals&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">                    &quot;$&#123;OIDC_ENDPOINT#*//&#125;:aud&quot;: &quot;sts.amazonaws.com&quot;,</span></span><br><span class=\"line\"><span class=\"string\">                    &quot;$&#123;OIDC_ENDPOINT#*//&#125;:sub&quot;: &quot;system:serviceaccount:karpenter:karpenter&quot;</span></span><br><span class=\"line\"><span class=\"string\">                &#125;</span></span><br><span class=\"line\"><span class=\"string\">            &#125;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;</span></span><br><span class=\"line\"><span class=\"string\">    ]</span></span><br><span class=\"line\"><span class=\"string\">&#125;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ aws iam create-role --role-name KarpenterControllerRole-<span class=\"variable\">$&#123;CLUSTER_NAME&#125;</span> \\</span><br><span class=\"line\">    --assume-role-policy-document file://controller-trust-policy.json</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;Role&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;Path&quot;</span>: <span class=\"string\">&quot;/&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;RoleName&quot;</span>: <span class=\"string\">&quot;KarpenterControllerRole-eks-lexing&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;RoleId&quot;</span>: <span class=\"string\">&quot;AROA22DP3G4GLRLLAPW6T&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;Arn&quot;</span>: <span class=\"string\">&quot;arn:aws:iam::743263909644:role/KarpenterControllerRole-eks-lexing&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;CreateDate&quot;</span>: <span class=\"string\">&quot;2023-07-19T07:28:09+00:00&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;AssumeRolePolicyDocument&quot;</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;Version&quot;</span>: <span class=\"string\">&quot;2012-10-17&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;Statement&quot;</span>: [</span><br><span class=\"line\">                &#123;</span><br><span class=\"line\">                    <span class=\"string\">&quot;Effect&quot;</span>: <span class=\"string\">&quot;Allow&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;Principal&quot;</span>: &#123;</span><br><span class=\"line\">                        <span class=\"string\">&quot;Federated&quot;</span>: <span class=\"string\">&quot;arn:aws:iam::743263909644:oidc-provider/oidc.eks.us-west-2.amazonaws.com/id/1029FF88CB872B6B7A1CC65D44191A56&quot;</span></span><br><span class=\"line\">                    &#125;,</span><br><span class=\"line\">                    <span class=\"string\">&quot;Action&quot;</span>: <span class=\"string\">&quot;sts:AssumeRoleWithWebIdentity&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;Condition&quot;</span>: &#123;</span><br><span class=\"line\">                        <span class=\"string\">&quot;StringEquals&quot;</span>: &#123;</span><br><span class=\"line\">                            <span class=\"string\">&quot;oidc.eks.us-west-2.amazonaws.com/id/1029FF88CB872B6B7A1CC65D44191A56:aud&quot;</span>: <span class=\"string\">&quot;sts.amazonaws.com&quot;</span>,</span><br><span class=\"line\">                            <span class=\"string\">&quot;oidc.eks.us-west-2.amazonaws.com/id/1029FF88CB872B6B7A1CC65D44191A56:sub&quot;</span>: <span class=\"string\">&quot;system:serviceaccount:karpenter:karpenter&quot;</span></span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            ]</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>2.为role配置policy</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ <span class=\"built_in\">cat</span> &lt;&lt; <span class=\"string\">EOF &gt; controller-policy.json</span></span><br><span class=\"line\"><span class=\"string\">&#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;Statement&quot;: [</span></span><br><span class=\"line\"><span class=\"string\">        &#123;</span></span><br><span class=\"line\"><span class=\"string\">            &quot;Action&quot;: [</span></span><br><span class=\"line\"><span class=\"string\">                &quot;ssm:GetParameter&quot;,</span></span><br><span class=\"line\"><span class=\"string\">                &quot;ec2:DescribeImages&quot;,</span></span><br><span class=\"line\"><span class=\"string\">                &quot;ec2:RunInstances&quot;,</span></span><br><span class=\"line\"><span class=\"string\">                &quot;ec2:DescribeSubnets&quot;,</span></span><br><span class=\"line\"><span class=\"string\">                &quot;ec2:DescribeSecurityGroups&quot;,</span></span><br><span class=\"line\"><span class=\"string\">                &quot;ec2:DescribeLaunchTemplates&quot;,</span></span><br><span class=\"line\"><span class=\"string\">                &quot;ec2:DescribeInstances&quot;,</span></span><br><span class=\"line\"><span class=\"string\">                &quot;ec2:DescribeInstanceTypes&quot;,</span></span><br><span class=\"line\"><span class=\"string\">                &quot;ec2:DescribeInstanceTypeOfferings&quot;,</span></span><br><span class=\"line\"><span class=\"string\">                &quot;ec2:DescribeAvailabilityZones&quot;,</span></span><br><span class=\"line\"><span class=\"string\">                &quot;ec2:DeleteLaunchTemplate&quot;,</span></span><br><span class=\"line\"><span class=\"string\">                &quot;ec2:CreateTags&quot;,</span></span><br><span class=\"line\"><span class=\"string\">                &quot;ec2:CreateLaunchTemplate&quot;,</span></span><br><span class=\"line\"><span class=\"string\">                &quot;ec2:CreateFleet&quot;,</span></span><br><span class=\"line\"><span class=\"string\">                &quot;ec2:DescribeSpotPriceHistory&quot;,</span></span><br><span class=\"line\"><span class=\"string\">                &quot;pricing:GetProducts&quot;</span></span><br><span class=\"line\"><span class=\"string\">            ],</span></span><br><span class=\"line\"><span class=\"string\">            &quot;Effect&quot;: &quot;Allow&quot;,</span></span><br><span class=\"line\"><span class=\"string\">            &quot;Resource&quot;: &quot;*&quot;,</span></span><br><span class=\"line\"><span class=\"string\">            &quot;Sid&quot;: &quot;Karpenter&quot;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;,</span></span><br><span class=\"line\"><span class=\"string\">        &#123;</span></span><br><span class=\"line\"><span class=\"string\">            &quot;Action&quot;: &quot;ec2:TerminateInstances&quot;,</span></span><br><span class=\"line\"><span class=\"string\">            &quot;Condition&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">                &quot;StringLike&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">                    &quot;ec2:ResourceTag/karpenter.sh/provisioner-name&quot;: &quot;*&quot;</span></span><br><span class=\"line\"><span class=\"string\">                &#125;</span></span><br><span class=\"line\"><span class=\"string\">            &#125;,</span></span><br><span class=\"line\"><span class=\"string\">            &quot;Effect&quot;: &quot;Allow&quot;,</span></span><br><span class=\"line\"><span class=\"string\">            &quot;Resource&quot;: &quot;*&quot;,</span></span><br><span class=\"line\"><span class=\"string\">            &quot;Sid&quot;: &quot;ConditionalEC2Termination&quot;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;,</span></span><br><span class=\"line\"><span class=\"string\">        &#123;</span></span><br><span class=\"line\"><span class=\"string\">            &quot;Effect&quot;: &quot;Allow&quot;,</span></span><br><span class=\"line\"><span class=\"string\">            &quot;Action&quot;: &quot;iam:PassRole&quot;,</span></span><br><span class=\"line\"><span class=\"string\">            &quot;Resource&quot;: &quot;arn:$&#123;AWS_PARTITION&#125;:iam::$&#123;AWS_ACCOUNT_ID&#125;:role/KarpenterNodeRole-$&#123;CLUSTER_NAME&#125;&quot;,</span></span><br><span class=\"line\"><span class=\"string\">            &quot;Sid&quot;: &quot;PassNodeIAMRole&quot;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;,</span></span><br><span class=\"line\"><span class=\"string\">        &#123;</span></span><br><span class=\"line\"><span class=\"string\">            &quot;Effect&quot;: &quot;Allow&quot;,</span></span><br><span class=\"line\"><span class=\"string\">            &quot;Action&quot;: &quot;eks:DescribeCluster&quot;,</span></span><br><span class=\"line\"><span class=\"string\">            &quot;Resource&quot;: &quot;arn:$&#123;AWS_PARTITION&#125;:eks:$&#123;AWS_REGION&#125;:$&#123;AWS_ACCOUNT_ID&#125;:cluster/$&#123;CLUSTER_NAME&#125;&quot;,</span></span><br><span class=\"line\"><span class=\"string\">            &quot;Sid&quot;: &quot;EKSClusterEndpointLookup&quot;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;</span></span><br><span class=\"line\"><span class=\"string\">    ],</span></span><br><span class=\"line\"><span class=\"string\">    &quot;Version&quot;: &quot;2012-10-17&quot;</span></span><br><span class=\"line\"><span class=\"string\">&#125;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ aws iam put-role-policy --role-name KarpenterControllerRole-<span class=\"variable\">$&#123;CLUSTER_NAME&#125;</span> \\</span><br><span class=\"line\">    --policy-name KarpenterControllerPolicy-<span class=\"variable\">$&#123;CLUSTER_NAME&#125;</span> \\</span><br><span class=\"line\">    --policy-document file://controller-policy.json</span><br></pre></td></tr></table></figure>\n<h3 id=\"为所有子网和安全组添加标签\">为所有子网和安全组添加标签</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>1.为节点组内的子网打标签</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ <span class=\"keyword\">for</span> NODEGROUP <span class=\"keyword\">in</span> $(aws eks list-nodegroups --cluster-name <span class=\"variable\">$&#123;CLUSTER_NAME&#125;</span> --query <span class=\"string\">&#x27;nodegroups&#x27;</span> --output text)</span><br><span class=\"line\">  <span class=\"keyword\">do</span> aws ec2 create-tags \\</span><br><span class=\"line\">        --tags <span class=\"string\">&quot;Key=karpenter.sh/discovery,Value=<span class=\"variable\">$&#123;CLUSTER_NAME&#125;</span>&quot;</span> \\</span><br><span class=\"line\">        --resources $(aws eks describe-nodegroup --cluster-name <span class=\"variable\">$&#123;CLUSTER_NAME&#125;</span> \\</span><br><span class=\"line\">        --nodegroup-name <span class=\"variable\">$NODEGROUP</span> --query <span class=\"string\">&#x27;nodegroup.subnets&#x27;</span> --output text )</span><br><span class=\"line\">  <span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>2.给托管节点组的运行模版的安全组打标签</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 获取节点组</span></span><br><span class=\"line\">$ NODEGROUP=$(aws eks list-nodegroups --cluster-name <span class=\"variable\">$&#123;CLUSTER_NAME&#125;</span> \\</span><br><span class=\"line\">    --query <span class=\"string\">&#x27;nodegroups[0]&#x27;</span> --output text)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 获取节点组的启动模板及其版本号</span></span><br><span class=\"line\">$ LAUNCH_TEMPLATE=$(aws eks describe-nodegroup --cluster-name <span class=\"variable\">$&#123;CLUSTER_NAME&#125;</span> \\</span><br><span class=\"line\">    --nodegroup-name <span class=\"variable\">$&#123;NODEGROUP&#125;</span> --query <span class=\"string\">&#x27;nodegroup.launchTemplate.&#123;id:id,version:version&#125;&#x27;</span> \\</span><br><span class=\"line\">    --output text | <span class=\"built_in\">tr</span> -s <span class=\"string\">&quot;\\t&quot;</span> <span class=\"string\">&quot;,&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 获取启动模板的安全组</span></span><br><span class=\"line\">$ SECURITY_GROUPS=$(aws ec2 describe-launch-template-versions \\</span><br><span class=\"line\">    --launch-template-id <span class=\"variable\">$&#123;LAUNCH_TEMPLATE%,*&#125;</span> --versions <span class=\"variable\">$&#123;LAUNCH_TEMPLATE#*,&#125;</span> \\</span><br><span class=\"line\">    --query <span class=\"string\">&#x27;LaunchTemplateVersions[0].LaunchTemplateData.[NetworkInterfaces[0].Groups||SecurityGroupIds]&#x27;</span> \\</span><br><span class=\"line\">    --output text)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 为安全组打标签</span></span><br><span class=\"line\">$ aws ec2 create-tags \\</span><br><span class=\"line\">    --tags <span class=\"string\">&quot;Key=karpenter.sh/discovery,Value=<span class=\"variable\">$&#123;CLUSTER_NAME&#125;</span>&quot;</span> \\</span><br><span class=\"line\">    --resources <span class=\"variable\">$&#123;SECURITY_GROUPS&#125;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"更新-aws-auth-ConfigMap\">更新 aws-auth ConfigMap</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>将上面为node创建的role加入到集群权限</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubectl edit configmap aws-auth -n kube-system</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 在 mapRoles 下添加如下内容</span></span><br><span class=\"line\">- <span class=\"built_in\">groups</span>:</span><br><span class=\"line\">  - system:bootstrappers</span><br><span class=\"line\">  - system:nodes</span><br><span class=\"line\">  rolearn: arn:aws:iam::743263909644:role/KarpenterNodeRole-eks-lexing</span><br><span class=\"line\">  username: system:node:&#123;&#123;EC2PrivateDNSName&#125;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 或者通过命令行直接添加</span></span><br><span class=\"line\">$ eksctl create iamidentitymapping --cluster eks-lexing \\</span><br><span class=\"line\">  --arn arn:aws:iam::743263909644:role/KarpenterNodeRole-eks-lexing \\</span><br><span class=\"line\">  --username system:node:&#123;&#123;EC2PrivateDNSName&#125;&#125; \\</span><br><span class=\"line\">  --group system:bootstrappers \\</span><br><span class=\"line\">  --group system:nodes \\</span><br><span class=\"line\">  --no-duplicate-arns</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>编辑后完整的内容如下:</p>\n</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\">  <span class=\"attr\">mapRoles:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">    - groups:</span></span><br><span class=\"line\"><span class=\"string\">      - system:bootstrappers</span></span><br><span class=\"line\"><span class=\"string\">      - system:nodes</span></span><br><span class=\"line\"><span class=\"string\">      rolearn: arn:aws:iam::743263909644:role/eksctl-eks-lexing-nodegroup-ng-4d-NodeInstanceRole-Y28EPJO9XYDG</span></span><br><span class=\"line\"><span class=\"string\">      username: system:node:&#123;&#123;EC2PrivateDNSName&#125;&#125;</span></span><br><span class=\"line\"><span class=\"string\">    - groups:</span></span><br><span class=\"line\"><span class=\"string\">      - system:bootstrappers</span></span><br><span class=\"line\"><span class=\"string\">      - system:nodes</span></span><br><span class=\"line\"><span class=\"string\">      rolearn: arn:aws:iam::743263909644:role/KarpenterNodeRole-eks-lexing</span></span><br><span class=\"line\"><span class=\"string\">      username: system:node:&#123;&#123;EC2PrivateDNSName&#125;&#125;</span></span><br><span class=\"line\"><span class=\"string\"></span>  <span class=\"attr\">mapUsers:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">    - groups:</span></span><br><span class=\"line\"><span class=\"string\">      - eks-console-dashboard-full-access-group</span></span><br><span class=\"line\"><span class=\"string\">      userarn: arn:aws:iam::743263909644:user/ekstest</span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"attr\">kind:</span> <span class=\"string\">ConfigMap</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">creationTimestamp:</span> <span class=\"string\">&quot;2023-06-28T06:30:56Z&quot;</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">aws-auth</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">kube-system</span></span><br><span class=\"line\">  <span class=\"attr\">resourceVersion:</span> <span class=\"string\">&quot;7544319&quot;</span></span><br><span class=\"line\">  <span class=\"attr\">uid:</span> <span class=\"string\">5e488d60-6ce0-4657-9a08-bbd17d048f0c</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>查看授权信息</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ eksctl get iamidentitymapping --cluster eks-lexing</span><br><span class=\"line\">ARN\t\t\t\t\t\t\t\t\t\t\t\tUSERNAME\t\t\t\tGROUPS\t\t\t\t\tACCOUNT</span><br><span class=\"line\">arn:aws:iam::743263909644:role/KarpenterNodeRole-eks-lexing\t\t\t\t\tsystem:node:&#123;&#123;EC2PrivateDNSName&#125;&#125;\tsystem:bootstrappers,system:nodes</span><br><span class=\"line\">arn:aws:iam::743263909644:role/eksctl-eks-lexing-nodegroup-ng-4d-NodeInstanceRole-Y28EPJO9XYDG\tsystem:node:&#123;&#123;EC2PrivateDNSName&#125;&#125;\tsystem:bootstrappers,system:nodes</span><br><span class=\"line\">arn:aws:iam::743263909644:user/ekstest\t\t\t\t\t\t\t\t\t\t\t\t\teks-console-dashboard-full-access-group</span><br></pre></td></tr></table></figure>\n<h2 id=\"部署-Karpenter\">部署 Karpenter</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>1.设置环境变量</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 当前最新版是 v0.29.1 , https://github.com/aws/karpenter/releases</span></span><br><span class=\"line\"><span class=\"built_in\">export</span> KARPENTER_VERSION=v0.29.1</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>2.创建 karpenter.yaml 模版</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ helm template karpenter oci://public.ecr.aws/karpenter/karpenter --version <span class=\"variable\">$&#123;KARPENTER_VERSION&#125;</span> \\</span><br><span class=\"line\">    --namespace karpenter \\</span><br><span class=\"line\">    --<span class=\"built_in\">set</span> settings.aws.defaultInstanceProfile=KarpenterNodeInstanceProfile-<span class=\"variable\">$&#123;CLUSTER_NAME&#125;</span> \\</span><br><span class=\"line\">    --<span class=\"built_in\">set</span> settings.aws.clusterName=<span class=\"variable\">$&#123;CLUSTER_NAME&#125;</span> \\</span><br><span class=\"line\">    --<span class=\"built_in\">set</span> serviceAccount.annotations.<span class=\"string\">&quot;eks\\.amazonaws\\.com/role-arn&quot;</span>=<span class=\"string\">&quot;arn:<span class=\"variable\">$&#123;AWS_PARTITION&#125;</span>:iam::<span class=\"variable\">$&#123;AWS_ACCOUNT_ID&#125;</span>:role/KarpenterControllerRole-<span class=\"variable\">$&#123;CLUSTER_NAME&#125;</span>&quot;</span> \\</span><br><span class=\"line\">    --<span class=\"built_in\">set</span> controller.resources.requests.cpu=1 \\</span><br><span class=\"line\">    --<span class=\"built_in\">set</span> controller.resources.requests.memory=1Gi \\</span><br><span class=\"line\">    --<span class=\"built_in\">set</span> controller.resources.limits.cpu=1 \\</span><br><span class=\"line\">    --<span class=\"built_in\">set</span> controller.resources.limits.memory=1Gi &gt; karpenter.yaml</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>3.设置节点亲和性，编辑<code>karpenter.yaml</code>，找到karpenter deployment的亲和性配置，修改为如下内容，注意这里<code>ng-4d9024eb</code>要替换为你的<code>$&#123;NODEGROUP&#125;</code>。关节K8s<code>节点亲和性</code>的介绍可以参考官方文档<a href=\"https://kubernetes.io/zh-cn/docs/concepts/scheduling-eviction/assign-pod-node/#affinity-and-anti-affinity\">亲和性与反亲和性</a></p>\n</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">affinity:</span></span><br><span class=\"line\">  <span class=\"attr\">nodeAffinity:</span></span><br><span class=\"line\">    <span class=\"attr\">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class=\"line\">        <span class=\"attr\">nodeSelectorTerms:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">matchExpressions:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"attr\">key:</span> <span class=\"string\">karpenter.sh/provisioner-name</span></span><br><span class=\"line\">            <span class=\"attr\">operator:</span> <span class=\"string\">DoesNotExist</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">matchExpressions:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"attr\">key:</span> <span class=\"string\">eks.amazonaws.com/nodegroup</span></span><br><span class=\"line\">            <span class=\"attr\">operator:</span> <span class=\"string\">In</span></span><br><span class=\"line\">            <span class=\"attr\">values:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">ng-4d9024eb</span></span><br><span class=\"line\">  <span class=\"attr\">podAntiAffinity:</span></span><br><span class=\"line\">    <span class=\"attr\">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">topologyKey:</span> <span class=\"string\">&quot;kubernetes.io/hostname&quot;</span></span><br></pre></td></tr></table></figure>\n<div class=\"tips\">\n<p><em><strong>为其他关键集群工作负载设置nodeAffinity</strong></em></p>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">例如 CoreDNS，Controller，CNI，CSI 和 Operator 等，这些 workload 对弹性要求不高但是稳定性要求比较高，建议部署在创建EKS时的节点组运行。</li>\n<li class=\"lvl-2\">为这些关键负载设置nodeAffinity</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">affinity:</span></span><br><span class=\"line\">  <span class=\"attr\">nodeAffinity:</span></span><br><span class=\"line\">    <span class=\"attr\">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class=\"line\">        <span class=\"attr\">nodeSelectorTerms:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">matchExpressions:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"attr\">key:</span> <span class=\"string\">eks.amazonaws.com/nodegroup</span></span><br><span class=\"line\">            <span class=\"attr\">operator:</span> <span class=\"string\">In</span></span><br><span class=\"line\">            <span class=\"attr\">values:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">$&#123;NODEGROUP&#125;</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">比如设置<code>k edit deploy ebs-csi-controller -n kube-system</code>，添加好<code>nodeAffinity</code>后保存，然后查看对应的pod是否重启成功，如果一只处于<code>pending</code>状态，可以试着重启</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ k scale deploy ebs-csi-controller --replicas 0 -n kube-system</span><br><span class=\"line\">$ k scale deploy ebs-csi-controller --replicas 2 -n kube-system</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">设置好所有关键负载后，可以重启一下 karpenter</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ k scale deploy karpenter --replicas 0 -n karpenter</span><br><span class=\"line\">$ k scale deploy karpenter --replicas 2 -n karpenter</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">\n<p>查看 karpenter 日志是否正常</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ k logs deployments/karpenter -f -n karpenter</span><br></pre></td></tr></table></figure>\n</div>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>4.部署 karpenter 及其 相关资源</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 创建Namespace</span></span><br><span class=\"line\">$ kubectl create namespace karpenter</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 下载karpenter 相关资源</span></span><br><span class=\"line\"><span class=\"comment\"># karpenter的版本分支，正常karpenter发布时都会打branch，比如：release-v0.28.1，不过我在github上没有找到v0.29.1的branch，所以这里就指定 main 了</span></span><br><span class=\"line\">$ KARPENTER_BRANCH=main</span><br><span class=\"line\">$ curl -O <span class=\"string\">&quot;https://raw.githubusercontent.com/aws/karpenter/<span class=\"variable\">$&#123;KARPENTER_BRANCH&#125;</span>/pkg/apis/crds/karpenter.sh_provisioners.yaml&quot;</span></span><br><span class=\"line\">$ curl -O <span class=\"string\">&quot;https://raw.githubusercontent.com/aws/karpenter/<span class=\"variable\">$&#123;KARPENTER_BRANCH&#125;</span>/pkg/apis/crds/karpenter.k8s.aws_awsnodetemplates.yaml&quot;</span></span><br><span class=\"line\">$ curl -O <span class=\"string\">&quot;https://raw.githubusercontent.com/aws/karpenter/<span class=\"variable\">$&#123;KARPENTER_BRANCH&#125;</span>/pkg/apis/crds/karpenter.sh_machines.yaml &quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 部署karpenter 相关资源</span></span><br><span class=\"line\">$ kubectl apply -f karpenter.sh_provisioners.yaml</span><br><span class=\"line\">$ kubectl apply -f karpenter.k8s.aws_awsnodetemplates.yaml</span><br><span class=\"line\">$ kubectl apply -f karpenter.sh_machines.yaml</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 部署karpenter</span></span><br><span class=\"line\">$ k apply -f karpenter.yaml</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>5.创建默认的供应者(provisioner)</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\"><a href=\"https://karpenter.sh/docs/concepts/provisioners/\">Provisioner</a>与<a href=\"https://karpenter.sh/docs/concepts/node-templates/\">AWSNodeTemplate</a>是karpenter在K8s中的自定义资源。</li>\n<li class=\"lvl-6\"><code>Provisioner</code> 对 Karpenter 可创建的节点以及可在这些节点上运行的 Pod 设置约束。如果没有配置至少一个<code>Provisioner</code>，Karpenter 将不会执行任何操作。</li>\n<li class=\"lvl-6\">关于<code>Provisioner</code>支持的配置项可以参考<a href=\"https://karpenter.sh/docs/concepts/provisioners/\">官方文档</a>，比如下面就限制了被管控的节点必须符合两个条件：</li>\n</ul>\n<blockquote>\n<p>1.实例类别必须在[c, m, r]中<br>\n2.实例的生成代次必须大于2。比如 实例类型为 <code>c1.xxx，m1.xxx，m2.xxx</code>就不符合要求</p>\n</blockquote>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\"><code>AWSNodeTemplate</code>节点模板启用AWS特定设置的配置。关于<code>AWSNodeTemplate</code>支持的配置项可以参考<a href=\"https://karpenter.sh/docs/concepts/node-templates/\">官方文档</a>，比如默认节点关联的存储为20G gp3，如果要修改为40G可以在spec下指定如下内容，先创建后编辑也可以，但只有修改后新创建的节点才会使用新的配置。</li>\n</ul>\n  <figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">blockDeviceMappings:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">deviceName:</span> <span class=\"string\">/dev/xvda</span></span><br><span class=\"line\">  <span class=\"attr\">ebs:</span></span><br><span class=\"line\">    <span class=\"attr\">volumeType:</span> <span class=\"string\">gp3</span></span><br><span class=\"line\">    <span class=\"attr\">volumeSize:</span> <span class=\"string\">40Gi</span></span><br><span class=\"line\">    <span class=\"attr\">deleteOnTermination:</span> <span class=\"literal\">true</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">\n<p><code>Provisioner</code>需要与<code>AWSNodeTemplate</code>关联使用，通过在<code>Provisioner</code>的<code>providerRef</code>中指定<code>AWSNodeTemplate</code>的<code>name</code>进行关联，一个<code>AWSNodeTemplate</code>可以被多个<code>Provisioner</code>关联。</p>\n</li>\n<li class=\"lvl-6\">\n<p>配置的每个 <code>Provisioner</code> 均由 Karpenter 循环遍历。在 <code>Provisioner</code> 中定义污点以限制可以在 Karpenter 创建的节点上运行的 Pod。建议创建互斥的 <code>Provisioner</code>。因此任何 Pod 都不应该匹配多个 <code>Provisioner</code>。如果匹配多个<code>Provisioner</code>，Karpenter将使用权重最高的<code>Provisioner</code> 。关于K8s中<code>污点</code>的介绍可以参考官方文档<a href=\"https://kubernetes.io/zh-cn/docs/concepts/scheduling-eviction/taint-and-toleration/\">污点和容忍度</a></p>\n</li>\n<li class=\"lvl-6\">\n<p>下面是一个最基本的<code>Provisioner</code>定义，你可以根据需要创建自己的<code>Provisioner</code>，可以参考<a href=\"https://karpenter.sh/docs/concepts/provisioners/\">官方文档</a>或者查看<a href=\"https://github.com/aws/karpenter/tree/v0.29.1/examples/provisioner\">provisioner examples</a>中的示例。</p>\n</li>\n</ul>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 创建 default Provisioner</span></span><br><span class=\"line\">$ <span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF | kubectl apply -f -</span></span><br><span class=\"line\"><span class=\"string\">apiVersion: karpenter.sh/v1alpha5</span></span><br><span class=\"line\"><span class=\"string\">kind: Provisioner</span></span><br><span class=\"line\"><span class=\"string\">metadata:</span></span><br><span class=\"line\"><span class=\"string\">  name: default</span></span><br><span class=\"line\"><span class=\"string\">spec:</span></span><br><span class=\"line\"><span class=\"string\">  requirements:</span></span><br><span class=\"line\"><span class=\"string\">    - key: karpenter.k8s.aws/instance-category</span></span><br><span class=\"line\"><span class=\"string\">      operator: In</span></span><br><span class=\"line\"><span class=\"string\">      values: [c, m, r]</span></span><br><span class=\"line\"><span class=\"string\">    - key: karpenter.k8s.aws/instance-generation</span></span><br><span class=\"line\"><span class=\"string\">      operator: Gt</span></span><br><span class=\"line\"><span class=\"string\">      values: [&quot;2&quot;]</span></span><br><span class=\"line\"><span class=\"string\">  providerRef:</span></span><br><span class=\"line\"><span class=\"string\">    name: default</span></span><br><span class=\"line\"><span class=\"string\">---</span></span><br><span class=\"line\"><span class=\"string\">apiVersion: karpenter.k8s.aws/v1alpha1</span></span><br><span class=\"line\"><span class=\"string\">kind: AWSNodeTemplate</span></span><br><span class=\"line\"><span class=\"string\">metadata:</span></span><br><span class=\"line\"><span class=\"string\">  name: default</span></span><br><span class=\"line\"><span class=\"string\">spec:</span></span><br><span class=\"line\"><span class=\"string\">  subnetSelector:</span></span><br><span class=\"line\"><span class=\"string\">    karpenter.sh/discovery: &quot;$&#123;CLUSTER_NAME&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\">  securityGroupSelector:</span></span><br><span class=\"line\"><span class=\"string\">    karpenter.sh/discovery: &quot;$&#123;CLUSTER_NAME&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>查看 karpenter 状态</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ k get pod -n karpenter</span><br><span class=\"line\">NAME                         READY   STATUS    RESTARTS   AGE</span><br><span class=\"line\">karpenter-789bbcbfd7-htj6z   1/1     Running   0          101s</span><br><span class=\"line\">karpenter-789bbcbfd7-rlxfp   1/1     Running   0          101s</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>查看 karpenter 日志是否正常</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ k logs deployments/karpenter -f -n karpenter</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>karpenter创建新的节点时不会在原有的节点组中进行，所以为了摆脱从节点组添加的实例，我们可以将节点组缩小到最小大小</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 如果您有一个多AZ节点组，我们建议至少2个实例。</span></span><br><span class=\"line\">$ aws eks update-nodegroup-config --cluster-name <span class=\"variable\">$&#123;CLUSTER_NAME&#125;</span> \\</span><br><span class=\"line\">    --nodegroup-name <span class=\"variable\">$&#123;NODEGROUP&#125;</span> \\</span><br><span class=\"line\">    --scaling-config <span class=\"string\">&quot;minSize=2,maxSize=2,desiredSize=2&quot;</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>关停Cluster Autoscaler(CAS)<br>\n如果EKS中已经开启了CAS，则安装Karpenter后需要关闭CAS</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubectl scale deploy/cluster-autoscaler -n kube-system --replicas=0</span><br></pre></td></tr></table></figure>\n<h2 id=\"测试\">测试</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>查看当前node信息</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ k get node</span><br><span class=\"line\">NAME                                           STATUS   ROLES    AGE   VERSION</span><br><span class=\"line\">ip-192-168-16-155.us-west-2.compute.internal   Ready    &lt;none&gt;   19d   v1.26.4-eks-0a21954</span><br><span class=\"line\">ip-192-168-48-14.us-west-2.compute.internal    Ready    &lt;none&gt;   19d   v1.26.4-eks-0a21954</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>采用 <a href=\"/2023/07/18/aws-eks18-autoscaler-cas/\" title=\"AWS-EKS-18--Autoscaling 之 Cluster Autoscaler(CAS)\">AWS-EKS-18--Autoscaling 之 Cluster Autoscaler(CAS)</a> 中的测试方法，将deploy的副本数设置为50，过一会查看node情况</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 可以看到node数量已经变为3了，说明扩容成功</span></span><br><span class=\"line\">$ k get node</span><br><span class=\"line\">NAME                                           STATUS   ROLES    AGE   VERSION</span><br><span class=\"line\">ip-192-168-16-155.us-west-2.compute.internal   Ready    &lt;none&gt;   19d   v1.26.4-eks-0a21954</span><br><span class=\"line\">ip-192-168-34-126.us-west-2.compute.internal   Ready    &lt;none&gt;   47s   v1.26.6-eks-a5565ad</span><br><span class=\"line\">ip-192-168-48-14.us-west-2.compute.internal    Ready    &lt;none&gt;   19d   v1.26.4-eks-0a21954</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/Rx3wJO.png\" alt=\"\" width=\"1000\" height=\"800\"></p>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>缩容测试用的deploy，副本数设置为1，过一会发现node节点并没有被终止，这是为什么呢？</p>\n</li>\n</ul>\n<blockquote>\n<p>默认情况下，Karpenter不会主动终止节点，需要为其设置终止节点的方式，参考<a href=\"https://karpenter.sh/docs/concepts/deprovisioning/\">Karpenter官方文档Deprovisioning部分</a></p>\n</blockquote>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>在<code>Provisioner</code>中设置节点终止的方式</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\"><code>spec.ttlSecondsAfterEmpty</code>: 当最后一个工作负载（非守护程序集）pod停止在节点上运行时，Karpenter会注意到。从那时起，Karpenter在提供程序中等待<code>ttlSecondsAfterEmpty</code>设置的秒数，然后Karpenter请求删除节点。此功能可以通过删除不再用于工作负载的节点来降低成本。</li>\n<li class=\"lvl-6\"><code>spec.ttlSecondsUntilExpired</code>: Karpenter 将根据<code>Provisioner</code>的<code>ttlSecondsUntilExpired</code>值将节点注释为过期，并在节点生存了设定秒数后取消配置节点。节点过期的一种用例是定期回收节点。</li>\n<li class=\"lvl-6\"><code>spec.consolidation.enabled</code>: 实现整合，通过删除不需要的节点和缩减无法删除的节点的规模来降低集群成本。与<code>ttlSecondsAfterEmpty</code>参数互斥。</li>\n</ul>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 编辑 default provisioner，并为其指定 spec.ttlSecondsAfterEmpty: 30，表示空闲超过30秒则终止节点。</span></span><br><span class=\"line\">$ k edit provisioners.karpenter.sh default</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">karpenter.sh/v1alpha5</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Provisioner</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">kubectl.kubernetes.io/last-applied-configuration:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">      &#123;&quot;apiVersion&quot;:&quot;karpenter.sh/v1alpha5&quot;,&quot;kind&quot;:&quot;Provisioner&quot;,&quot;metadata&quot;:&#123;&quot;annotations&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\"></span>  <span class=\"attr\">creationTimestamp:</span> <span class=\"string\">&quot;2023-07-19T09:49:43Z&quot;</span></span><br><span class=\"line\">  <span class=\"attr\">generation:</span> <span class=\"number\">3</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">default</span></span><br><span class=\"line\">  <span class=\"attr\">resourceVersion:</span> <span class=\"string\">&quot;7987578&quot;</span></span><br><span class=\"line\">  <span class=\"attr\">uid:</span> <span class=\"string\">5716142b-2b9f-493c-a049-e4304cdf82d4</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">providerRef:</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">default</span></span><br><span class=\"line\">  <span class=\"attr\">requirements:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">key:</span> <span class=\"string\">karpenter.k8s.aws/instance-category</span></span><br><span class=\"line\">    <span class=\"attr\">operator:</span> <span class=\"string\">In</span></span><br><span class=\"line\">    <span class=\"attr\">values:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">c</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">m</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">r</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">key:</span> <span class=\"string\">karpenter.k8s.aws/instance-generation</span></span><br><span class=\"line\">    <span class=\"attr\">operator:</span> <span class=\"string\">Gt</span></span><br><span class=\"line\">    <span class=\"attr\">values:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">&quot;2&quot;</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">key:</span> <span class=\"string\">kubernetes.io/os</span></span><br><span class=\"line\">    <span class=\"attr\">operator:</span> <span class=\"string\">In</span></span><br><span class=\"line\">    <span class=\"attr\">values:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">linux</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">key:</span> <span class=\"string\">kubernetes.io/arch</span></span><br><span class=\"line\">    <span class=\"attr\">operator:</span> <span class=\"string\">In</span></span><br><span class=\"line\">    <span class=\"attr\">values:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">amd64</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">key:</span> <span class=\"string\">karpenter.sh/capacity-type</span></span><br><span class=\"line\">    <span class=\"attr\">operator:</span> <span class=\"string\">In</span></span><br><span class=\"line\">    <span class=\"attr\">values:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">on-demand</span></span><br><span class=\"line\">  <span class=\"attr\">ttlSecondsAfterEmpty:</span> <span class=\"number\">30</span></span><br><span class=\"line\"><span class=\"attr\">status:</span></span><br><span class=\"line\">  <span class=\"attr\">resources:</span></span><br><span class=\"line\">    <span class=\"attr\">cpu:</span> <span class=\"string\">&quot;2&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">ephemeral-storage:</span> <span class=\"string\">20959212Ki</span></span><br><span class=\"line\">    <span class=\"attr\">memory:</span> <span class=\"string\">3900360Ki</span></span><br><span class=\"line\">    <span class=\"attr\">pods:</span> <span class=\"string\">&quot;29&quot;</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>等待30秒后查看node情况，新创建的node已经成功终止</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ k get node</span><br><span class=\"line\">NAME                                           STATUS   ROLES    AGE   VERSION</span><br><span class=\"line\">ip-192-168-16-155.us-west-2.compute.internal   Ready    &lt;none&gt;   19d   v1.26.4-eks-0a21954</span><br><span class=\"line\">ip-192-168-48-14.us-west-2.compute.internal    Ready    &lt;none&gt;   19d   v1.26.4-eks-0a21954</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>创建和终止节点的过程可以通过日志进行观察</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ k logs deployments/karpenter -f -n karpenter</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 以下创建节点的日志</span></span><br><span class=\"line\">2023-07-20T09:03:54.763Z\tINFO\tcontroller.provisioner\tfound provisionable pod(s)\t&#123;<span class=\"string\">&quot;commit&quot;</span>: <span class=\"string\">&quot;5b469b8-dirty&quot;</span>, <span class=\"string\">&quot;pods&quot;</span>: 17&#125;</span><br><span class=\"line\">2023-07-20T09:03:54.763Z\tINFO\tcontroller.provisioner\tcomputed new machine(s) to fit pod(s)\t&#123;<span class=\"string\">&quot;commit&quot;</span>: <span class=\"string\">&quot;5b469b8-dirty&quot;</span>, <span class=\"string\">&quot;machines&quot;</span>: 1, <span class=\"string\">&quot;pods&quot;</span>: 17&#125;</span><br><span class=\"line\">2023-07-20T09:03:54.788Z\tINFO\tcontroller.provisioner\tcreated machine\t&#123;<span class=\"string\">&quot;commit&quot;</span>: <span class=\"string\">&quot;5b469b8-dirty&quot;</span>, <span class=\"string\">&quot;provisioner&quot;</span>: <span class=\"string\">&quot;default&quot;</span>, <span class=\"string\">&quot;requests&quot;</span>: &#123;<span class=\"string\">&quot;cpu&quot;</span>:<span class=\"string\">&quot;155m&quot;</span>,<span class=\"string\">&quot;memory&quot;</span>:<span class=\"string\">&quot;120Mi&quot;</span>,<span class=\"string\">&quot;pods&quot;</span>:<span class=\"string\">&quot;21&quot;</span>&#125;, <span class=\"string\">&quot;instance-types&quot;</span>: <span class=\"string\">&quot;c3.2xlarge, c3.large, c3.xlarge, c4.2xlarge, c4.large and 95 other(s)&quot;</span>&#125;</span><br><span class=\"line\">2023-07-20T09:03:54.978Z\tDEBUG\tcontroller.machine.lifecycle\tcreated launch template\t&#123;<span class=\"string\">&quot;commit&quot;</span>: <span class=\"string\">&quot;5b469b8-dirty&quot;</span>, <span class=\"string\">&quot;machine&quot;</span>: <span class=\"string\">&quot;default-c6jkx&quot;</span>, <span class=\"string\">&quot;provisioner&quot;</span>: <span class=\"string\">&quot;default&quot;</span>, <span class=\"string\">&quot;launch-template-name&quot;</span>: <span class=\"string\">&quot;karpenter.k8s.aws/2892028901667059566&quot;</span>, <span class=\"string\">&quot;id&quot;</span>: <span class=\"string\">&quot;lt-0ef53ab2c4909f493&quot;</span>&#125;</span><br><span class=\"line\">2023-07-20T09:03:55.108Z\tDEBUG\tcontroller.machine.lifecycle\tcreated launch template\t&#123;<span class=\"string\">&quot;commit&quot;</span>: <span class=\"string\">&quot;5b469b8-dirty&quot;</span>, <span class=\"string\">&quot;machine&quot;</span>: <span class=\"string\">&quot;default-c6jkx&quot;</span>, <span class=\"string\">&quot;provisioner&quot;</span>: <span class=\"string\">&quot;default&quot;</span>, <span class=\"string\">&quot;launch-template-name&quot;</span>: <span class=\"string\">&quot;karpenter.k8s.aws/1810058814439854165&quot;</span>, <span class=\"string\">&quot;id&quot;</span>: <span class=\"string\">&quot;lt-02cda7252a2d29e16&quot;</span>&#125;</span><br><span class=\"line\">2023-07-20T09:03:57.095Z\tINFO\tcontroller.machine.lifecycle\tlaunched machine\t&#123;<span class=\"string\">&quot;commit&quot;</span>: <span class=\"string\">&quot;5b469b8-dirty&quot;</span>, <span class=\"string\">&quot;machine&quot;</span>: <span class=\"string\">&quot;default-c6jkx&quot;</span>, <span class=\"string\">&quot;provisioner&quot;</span>: <span class=\"string\">&quot;default&quot;</span>, <span class=\"string\">&quot;provider-id&quot;</span>: <span class=\"string\">&quot;aws:///us-west-2d/i-0bb92e04b7192cafd&quot;</span>, <span class=\"string\">&quot;instance-type&quot;</span>: <span class=\"string\">&quot;c6a.large&quot;</span>, <span class=\"string\">&quot;zone&quot;</span>: <span class=\"string\">&quot;us-west-2d&quot;</span>, <span class=\"string\">&quot;capacity-type&quot;</span>: <span class=\"string\">&quot;on-demand&quot;</span>, <span class=\"string\">&quot;allocatable&quot;</span>: &#123;<span class=\"string\">&quot;cpu&quot;</span>:<span class=\"string\">&quot;1930m&quot;</span>,<span class=\"string\">&quot;ephemeral-storage&quot;</span>:<span class=\"string\">&quot;17Gi&quot;</span>,<span class=\"string\">&quot;memory&quot;</span>:<span class=\"string\">&quot;3114Mi&quot;</span>,<span class=\"string\">&quot;pods&quot;</span>:<span class=\"string\">&quot;29&quot;</span>&#125;&#125;</span><br><span class=\"line\">2023-07-20T09:04:14.473Z\tDEBUG\tcontroller.machine.lifecycle\tregistered machine\t&#123;<span class=\"string\">&quot;commit&quot;</span>: <span class=\"string\">&quot;5b469b8-dirty&quot;</span>, <span class=\"string\">&quot;machine&quot;</span>: <span class=\"string\">&quot;default-c6jkx&quot;</span>, <span class=\"string\">&quot;provisioner&quot;</span>: <span class=\"string\">&quot;default&quot;</span>, <span class=\"string\">&quot;provider-id&quot;</span>: <span class=\"string\">&quot;aws:///us-west-2d/i-0bb92e04b7192cafd&quot;</span>, <span class=\"string\">&quot;node&quot;</span>: <span class=\"string\">&quot;ip-192-168-79-236.us-west-2.compute.internal&quot;</span>&#125;</span><br><span class=\"line\">2023-07-20T09:04:28.620Z\tDEBUG\tcontroller.machine.lifecycle\tinitialized machine&#123;<span class=\"string\">&quot;commit&quot;</span>: <span class=\"string\">&quot;5b469b8-dirty&quot;</span>, <span class=\"string\">&quot;machine&quot;</span>: <span class=\"string\">&quot;default-c6jkx&quot;</span>, <span class=\"string\">&quot;provisioner&quot;</span>: <span class=\"string\">&quot;default&quot;</span>, <span class=\"string\">&quot;provider-id&quot;</span>: <span class=\"string\">&quot;aws:///us-west-2d/i-0bb92e04b7192cafd&quot;</span>, <span class=\"string\">&quot;node&quot;</span>: <span class=\"string\">&quot;ip-192-168-79-236.us-west-2.compute.internal&quot;</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 以下是终止节点的日志</span></span><br><span class=\"line\">2023-07-20T09:05:46.420Z\tDEBUG\tcontroller.machine.disruption\tmarking machine as empty\t&#123;<span class=\"string\">&quot;commit&quot;</span>: <span class=\"string\">&quot;5b469b8-dirty&quot;</span>, <span class=\"string\">&quot;machine&quot;</span>: <span class=\"string\">&quot;default-c6jkx&quot;</span>&#125;</span><br><span class=\"line\">2023-07-20T09:06:20.642Z\tINFO\tcontroller.deprovisioning\tdeprovisioning via emptiness delete, terminating 1 machines ip-192-168-79-236.us-west-2.compute.internal/c6a.large/on-demand\t&#123;<span class=\"string\">&quot;commit&quot;</span>: <span class=\"string\">&quot;5b469b8-dirty&quot;</span>&#125;</span><br><span class=\"line\">2023-07-20T09:06:20.699Z\tINFO\tcontroller.termination\tcordoned node\t&#123;<span class=\"string\">&quot;commit&quot;</span>: <span class=\"string\">&quot;5b469b8-dirty&quot;</span>, <span class=\"string\">&quot;node&quot;</span>: <span class=\"string\">&quot;ip-192-168-79-236.us-west-2.compute.internal&quot;</span>&#125;</span><br><span class=\"line\">2023-07-20T09:06:21.026Z\tINFO\tcontroller.termination\tdeleted node\t&#123;<span class=\"string\">&quot;commit&quot;</span>: <span class=\"string\">&quot;5b469b8-dirty&quot;</span>, <span class=\"string\">&quot;node&quot;</span>: <span class=\"string\">&quot;ip-192-168-79-236.us-west-2.compute.internal&quot;</span>&#125;</span><br><span class=\"line\">2023-07-20T09:06:21.288Z\tINFO\tcontroller.machine.termination\tdeleted machine\t&#123;<span class=\"string\">&quot;commit&quot;</span>: <span class=\"string\">&quot;5b469b8-dirty&quot;</span>, <span class=\"string\">&quot;machine&quot;</span>: <span class=\"string\">&quot;default-c6jkx&quot;</span>, <span class=\"string\">&quot;node&quot;</span>: <span class=\"string\">&quot;ip-192-168-79-236.us-west-2.compute.internal&quot;</span>, <span class=\"string\">&quot;provisioner&quot;</span>: <span class=\"string\">&quot;default&quot;</span>, <span class=\"string\">&quot;provider-id&quot;</span>: <span class=\"string\">&quot;aws:///us-west-2d/i-0bb92e04b7192cafd&quot;</span>&#125;</span><br></pre></td></tr></table></figure>\n<div class=\"tips\">\n<p><em><strong>小贴士</strong></em><br>\n当Karpenter管理的Node节点由于某种原因不可用时(比如我们在AWS控制台终止了EC2或通过命令行删除节点<code>k delete node nodeName</code>)，Karpenter会立刻为我们创建一个新的Node节点，并在其上重启Pod。</p>\n</div>\n<h2 id=\"参考资料\">参考资料</h2>\n<p><a href=\"https://karpenter.sh/docs/getting-started/migrating-from-cas/\">从Cluster Autoscaler迁移</a><br>\n<a href=\"https://aws.amazon.com/cn/blogs/china/migration-of-cluster-autoscaler-to-karpenter-on-eks/\">EKS Cluster Autoscaler 迁移 Karpenter 实践</a><br>\n<a href=\"https://aws.github.io/aws-eks-best-practices/karpenter/\">Karpenter Best Practices</a></p>\n","content_text":"摘要 本文介绍EKS集群Autoscaling 之 Karpenter 参考资料： Amazon EKS用户指南 Kubernetes 文档 Karperter是什么？ Karpenter 是一个开源集群自动缩放器，可以自动为不可安排的pod提供新节点。Karpenter评估了挂起的pod的聚合资源需求，并选择运行它们的最佳实例类型。它将自动扩展或终止没有任何非daemonset pod的实例，以减少浪费。它还支持整合功能，该功能将积极移动pod，并用更便宜的版本删除或替换节点，以降低集群成本。 Karpenter 是aws为 k8s 构建的能用于生产环境的开源的工作节点动态调度控制器。 在Karpenter推出之前，Kubernetes用户主要依靠Amazon EC2 Auto Scaling组和Kubernetes Cluster Autoscaler（CAS）来动态调整其集群的计算容量。 相较于传统的 Cluster Autoscaler 工具，Karpenter 具有调度速度快、更灵活、资源利用率高等众多优势，另外，Karpenter与Kubernetes版本没有那么紧密耦合（像CAS那样），所以其是 EKS 自动扩缩容的首选方案，两者的比较可以参考下图。 特 性 Cluster Autoscaler Karpenter 资源管理 Cluster Autoscaler基于现有节点的资源利用率采用反应性方法来扩展节点。 Karpenter基于未调度的Pod的当前资源需求采取主动方法来进行节点预配。 节点管理 Cluster Autoscaler根据当前工作负载的资源需求来管理节点，使用预定义的自动缩放组。 Karpenter根据自定义预配程序的配置来扩展、预配和管理节点。 扩展 Cluster Autoscaler更专注于节点级别的扩展，这意味着它可以有效地添加更多的节点以满足需求的增加。 但这也意味着它在缩减资源方面可能不太有效。 Karpenter根据特定的工作负载需求提供更有效和精细的扩展功能。换句话说，它根据实际使用情况进行扩展。它还允许用户指定特定的扩展策略或规则以满足其需求。 调度 使用Cluster Autoscaler进行调度更简单，因为它是根据工作负载的当前需求设计的进行扩展或缩减。 Karpenter可以根据可用区和资源需求有效地调度工作负载。它可以尝试通过Spot实例来优化成本，但它不会知道你已经在aws帐号中做的任何承诺，如RI（预留实例）或Savings Plans（储蓄计划）。 Karpenter 运行环境准备 设置环境变量 12345678910111213# aws认证profile$ AWS_PROFILE=eks-us-west-2# EKS集群名称$ CLUSTER_NAME=eks-lexing# AWS分区# if you are not using standard partitions, you may need to configure to aws-cn / aws-us-gov$ AWS_PARTITION=&quot;aws&quot;# EKS所在的Region$ AWS_REGION=&quot;$(aws configure list | grep region | tr -s &quot; &quot; | cut -d&quot; &quot; -f3)&quot;# EKS配置OIDC的Endpoint$ OIDC_ENDPOINT=&quot;$(aws eks describe-cluster --name $&#123;CLUSTER_NAME&#125; --query &quot;cluster.identity.oidc.issuer&quot; --output text)&quot;# aws帐号ID$ AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query &#x27;Account&#x27; --output text) 创建 Karpenter 的 node 需要的 role 1.创建role 123456789101112131415161718192021222324252627282930313233343536$ echo &#x27;&#123; &quot;Version&quot;: &quot;2012-10-17&quot;, &quot;Statement&quot;: [ &#123; &quot;Effect&quot;: &quot;Allow&quot;, &quot;Principal&quot;: &#123; &quot;Service&quot;: &quot;ec2.amazonaws.com&quot; &#125;, &quot;Action&quot;: &quot;sts:AssumeRole&quot; &#125; ]&#125;&#x27; &gt; node-trust-policy.json$ aws iam create-role --role-name &quot;KarpenterNodeRole-$&#123;CLUSTER_NAME&#125;&quot; \\ --assume-role-policy-document file://node-trust-policy.json&#123; &quot;Role&quot;: &#123; &quot;Path&quot;: &quot;/&quot;, &quot;RoleName&quot;: &quot;KarpenterNodeRole-eks-lexing&quot;, &quot;RoleId&quot;: &quot;AROA22DP3G4GH4RZQFGR7&quot;, &quot;Arn&quot;: &quot;arn:aws:iam::743263909644:role/KarpenterNodeRole-eks-lexing&quot;, &quot;CreateDate&quot;: &quot;2023-07-19T07:20:17+00:00&quot;, &quot;AssumeRolePolicyDocument&quot;: &#123; &quot;Version&quot;: &quot;2012-10-17&quot;, &quot;Statement&quot;: [ &#123; &quot;Effect&quot;: &quot;Allow&quot;, &quot;Principal&quot;: &#123; &quot;Service&quot;: &quot;ec2.amazonaws.com&quot; &#125;, &quot;Action&quot;: &quot;sts:AssumeRole&quot; &#125; ] &#125; &#125;&#125; 2.给这个 role 添加 policy 1234567891011$ aws iam attach-role-policy --role-name &quot;KarpenterNodeRole-$&#123;CLUSTER_NAME&#125;&quot; \\ --policy-arn arn:$&#123;AWS_PARTITION&#125;:iam::aws:policy/AmazonEKSWorkerNodePolicy$ aws iam attach-role-policy --role-name &quot;KarpenterNodeRole-$&#123;CLUSTER_NAME&#125;&quot; \\ --policy-arn arn:$&#123;AWS_PARTITION&#125;:iam::aws:policy/AmazonEKS_CNI_Policy$ aws iam attach-role-policy --role-name &quot;KarpenterNodeRole-$&#123;CLUSTER_NAME&#125;&quot; \\ --policy-arn arn:$&#123;AWS_PARTITION&#125;:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly$ aws iam attach-role-policy --role-name &quot;KarpenterNodeRole-$&#123;CLUSTER_NAME&#125;&quot; \\ --policy-arn arn:$&#123;AWS_PARTITION&#125;:iam::aws:policy/AmazonSSMManagedInstanceCore 3.把 role 授予 EC2 的 instance profile 12345678910111213141516$ aws iam create-instance-profile \\ --instance-profile-name &quot;KarpenterNodeInstanceProfile-$&#123;CLUSTER_NAME&#125;&quot;&#123; &quot;InstanceProfile&quot;: &#123; &quot;Path&quot;: &quot;/&quot;, &quot;InstanceProfileName&quot;: &quot;KarpenterNodeInstanceProfile-eks-lexing&quot;, &quot;InstanceProfileId&quot;: &quot;AIPA22DP3G4GBMSNSBEQF&quot;, &quot;Arn&quot;: &quot;arn:aws:iam::743263909644:instance-profile/KarpenterNodeInstanceProfile-eks-lexing&quot;, &quot;CreateDate&quot;: &quot;2023-07-19T07:24:19+00:00&quot;, &quot;Roles&quot;: [] &#125;&#125;$ aws iam add-role-to-instance-profile \\ --instance-profile-name &quot;KarpenterNodeInstanceProfile-$&#123;CLUSTER_NAME&#125;&quot; \\ --role-name &quot;KarpenterNodeRole-$&#123;CLUSTER_NAME&#125;&quot; 创建 Karpenter controller 需要的 role 1.创建role 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950$ cat &lt;&lt; EOF &gt; controller-trust-policy.json&#123; &quot;Version&quot;: &quot;2012-10-17&quot;, &quot;Statement&quot;: [ &#123; &quot;Effect&quot;: &quot;Allow&quot;, &quot;Principal&quot;: &#123; &quot;Federated&quot;: &quot;arn:$&#123;AWS_PARTITION&#125;:iam::$&#123;AWS_ACCOUNT_ID&#125;:oidc-provider/$&#123;OIDC_ENDPOINT#*//&#125;&quot; &#125;, &quot;Action&quot;: &quot;sts:AssumeRoleWithWebIdentity&quot;, &quot;Condition&quot;: &#123; &quot;StringEquals&quot;: &#123; &quot;$&#123;OIDC_ENDPOINT#*//&#125;:aud&quot;: &quot;sts.amazonaws.com&quot;, &quot;$&#123;OIDC_ENDPOINT#*//&#125;:sub&quot;: &quot;system:serviceaccount:karpenter:karpenter&quot; &#125; &#125; &#125; ]&#125;EOF$ aws iam create-role --role-name KarpenterControllerRole-$&#123;CLUSTER_NAME&#125; \\ --assume-role-policy-document file://controller-trust-policy.json&#123; &quot;Role&quot;: &#123; &quot;Path&quot;: &quot;/&quot;, &quot;RoleName&quot;: &quot;KarpenterControllerRole-eks-lexing&quot;, &quot;RoleId&quot;: &quot;AROA22DP3G4GLRLLAPW6T&quot;, &quot;Arn&quot;: &quot;arn:aws:iam::743263909644:role/KarpenterControllerRole-eks-lexing&quot;, &quot;CreateDate&quot;: &quot;2023-07-19T07:28:09+00:00&quot;, &quot;AssumeRolePolicyDocument&quot;: &#123; &quot;Version&quot;: &quot;2012-10-17&quot;, &quot;Statement&quot;: [ &#123; &quot;Effect&quot;: &quot;Allow&quot;, &quot;Principal&quot;: &#123; &quot;Federated&quot;: &quot;arn:aws:iam::743263909644:oidc-provider/oidc.eks.us-west-2.amazonaws.com/id/1029FF88CB872B6B7A1CC65D44191A56&quot; &#125;, &quot;Action&quot;: &quot;sts:AssumeRoleWithWebIdentity&quot;, &quot;Condition&quot;: &#123; &quot;StringEquals&quot;: &#123; &quot;oidc.eks.us-west-2.amazonaws.com/id/1029FF88CB872B6B7A1CC65D44191A56:aud&quot;: &quot;sts.amazonaws.com&quot;, &quot;oidc.eks.us-west-2.amazonaws.com/id/1029FF88CB872B6B7A1CC65D44191A56:sub&quot;: &quot;system:serviceaccount:karpenter:karpenter&quot; &#125; &#125; &#125; ] &#125; &#125;&#125; 2.为role配置policy 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657$ cat &lt;&lt; EOF &gt; controller-policy.json&#123; &quot;Statement&quot;: [ &#123; &quot;Action&quot;: [ &quot;ssm:GetParameter&quot;, &quot;ec2:DescribeImages&quot;, &quot;ec2:RunInstances&quot;, &quot;ec2:DescribeSubnets&quot;, &quot;ec2:DescribeSecurityGroups&quot;, &quot;ec2:DescribeLaunchTemplates&quot;, &quot;ec2:DescribeInstances&quot;, &quot;ec2:DescribeInstanceTypes&quot;, &quot;ec2:DescribeInstanceTypeOfferings&quot;, &quot;ec2:DescribeAvailabilityZones&quot;, &quot;ec2:DeleteLaunchTemplate&quot;, &quot;ec2:CreateTags&quot;, &quot;ec2:CreateLaunchTemplate&quot;, &quot;ec2:CreateFleet&quot;, &quot;ec2:DescribeSpotPriceHistory&quot;, &quot;pricing:GetProducts&quot; ], &quot;Effect&quot;: &quot;Allow&quot;, &quot;Resource&quot;: &quot;*&quot;, &quot;Sid&quot;: &quot;Karpenter&quot; &#125;, &#123; &quot;Action&quot;: &quot;ec2:TerminateInstances&quot;, &quot;Condition&quot;: &#123; &quot;StringLike&quot;: &#123; &quot;ec2:ResourceTag/karpenter.sh/provisioner-name&quot;: &quot;*&quot; &#125; &#125;, &quot;Effect&quot;: &quot;Allow&quot;, &quot;Resource&quot;: &quot;*&quot;, &quot;Sid&quot;: &quot;ConditionalEC2Termination&quot; &#125;, &#123; &quot;Effect&quot;: &quot;Allow&quot;, &quot;Action&quot;: &quot;iam:PassRole&quot;, &quot;Resource&quot;: &quot;arn:$&#123;AWS_PARTITION&#125;:iam::$&#123;AWS_ACCOUNT_ID&#125;:role/KarpenterNodeRole-$&#123;CLUSTER_NAME&#125;&quot;, &quot;Sid&quot;: &quot;PassNodeIAMRole&quot; &#125;, &#123; &quot;Effect&quot;: &quot;Allow&quot;, &quot;Action&quot;: &quot;eks:DescribeCluster&quot;, &quot;Resource&quot;: &quot;arn:$&#123;AWS_PARTITION&#125;:eks:$&#123;AWS_REGION&#125;:$&#123;AWS_ACCOUNT_ID&#125;:cluster/$&#123;CLUSTER_NAME&#125;&quot;, &quot;Sid&quot;: &quot;EKSClusterEndpointLookup&quot; &#125; ], &quot;Version&quot;: &quot;2012-10-17&quot;&#125;EOF$ aws iam put-role-policy --role-name KarpenterControllerRole-$&#123;CLUSTER_NAME&#125; \\ --policy-name KarpenterControllerPolicy-$&#123;CLUSTER_NAME&#125; \\ --policy-document file://controller-policy.json 为所有子网和安全组添加标签 1.为节点组内的子网打标签 123456$ for NODEGROUP in $(aws eks list-nodegroups --cluster-name $&#123;CLUSTER_NAME&#125; --query &#x27;nodegroups&#x27; --output text) do aws ec2 create-tags \\ --tags &quot;Key=karpenter.sh/discovery,Value=$&#123;CLUSTER_NAME&#125;&quot; \\ --resources $(aws eks describe-nodegroup --cluster-name $&#123;CLUSTER_NAME&#125; \\ --nodegroup-name $NODEGROUP --query &#x27;nodegroup.subnets&#x27; --output text ) done 2.给托管节点组的运行模版的安全组打标签 12345678910111213141516171819# 获取节点组$ NODEGROUP=$(aws eks list-nodegroups --cluster-name $&#123;CLUSTER_NAME&#125; \\ --query &#x27;nodegroups[0]&#x27; --output text)# 获取节点组的启动模板及其版本号$ LAUNCH_TEMPLATE=$(aws eks describe-nodegroup --cluster-name $&#123;CLUSTER_NAME&#125; \\ --nodegroup-name $&#123;NODEGROUP&#125; --query &#x27;nodegroup.launchTemplate.&#123;id:id,version:version&#125;&#x27; \\ --output text | tr -s &quot;\\t&quot; &quot;,&quot;)# 获取启动模板的安全组$ SECURITY_GROUPS=$(aws ec2 describe-launch-template-versions \\ --launch-template-id $&#123;LAUNCH_TEMPLATE%,*&#125; --versions $&#123;LAUNCH_TEMPLATE#*,&#125; \\ --query &#x27;LaunchTemplateVersions[0].LaunchTemplateData.[NetworkInterfaces[0].Groups||SecurityGroupIds]&#x27; \\ --output text)# 为安全组打标签$ aws ec2 create-tags \\ --tags &quot;Key=karpenter.sh/discovery,Value=$&#123;CLUSTER_NAME&#125;&quot; \\ --resources $&#123;SECURITY_GROUPS&#125; 更新 aws-auth ConfigMap 将上面为node创建的role加入到集群权限 12345678910111213141516$ kubectl edit configmap aws-auth -n kube-system# 在 mapRoles 下添加如下内容- groups: - system:bootstrappers - system:nodes rolearn: arn:aws:iam::743263909644:role/KarpenterNodeRole-eks-lexing username: system:node:&#123;&#123;EC2PrivateDNSName&#125;&#125;# 或者通过命令行直接添加$ eksctl create iamidentitymapping --cluster eks-lexing \\ --arn arn:aws:iam::743263909644:role/KarpenterNodeRole-eks-lexing \\ --username system:node:&#123;&#123;EC2PrivateDNSName&#125;&#125; \\ --group system:bootstrappers \\ --group system:nodes \\ --no-duplicate-arns 编辑后完整的内容如下: 123456789101112131415161718192021222324apiVersion: v1data: mapRoles: | - groups: - system:bootstrappers - system:nodes rolearn: arn:aws:iam::743263909644:role/eksctl-eks-lexing-nodegroup-ng-4d-NodeInstanceRole-Y28EPJO9XYDG username: system:node:&#123;&#123;EC2PrivateDNSName&#125;&#125; - groups: - system:bootstrappers - system:nodes rolearn: arn:aws:iam::743263909644:role/KarpenterNodeRole-eks-lexing username: system:node:&#123;&#123;EC2PrivateDNSName&#125;&#125; mapUsers: | - groups: - eks-console-dashboard-full-access-group userarn: arn:aws:iam::743263909644:user/ekstestkind: ConfigMapmetadata: creationTimestamp: &quot;2023-06-28T06:30:56Z&quot; name: aws-auth namespace: kube-system resourceVersion: &quot;7544319&quot; uid: 5e488d60-6ce0-4657-9a08-bbd17d048f0c 查看授权信息 12345$ eksctl get iamidentitymapping --cluster eks-lexingARN USERNAME GROUPS ACCOUNTarn:aws:iam::743263909644:role/KarpenterNodeRole-eks-lexing system:node:&#123;&#123;EC2PrivateDNSName&#125;&#125; system:bootstrappers,system:nodesarn:aws:iam::743263909644:role/eksctl-eks-lexing-nodegroup-ng-4d-NodeInstanceRole-Y28EPJO9XYDG system:node:&#123;&#123;EC2PrivateDNSName&#125;&#125; system:bootstrappers,system:nodesarn:aws:iam::743263909644:user/ekstest eks-console-dashboard-full-access-group 部署 Karpenter 1.设置环境变量 12# 当前最新版是 v0.29.1 , https://github.com/aws/karpenter/releasesexport KARPENTER_VERSION=v0.29.1 2.创建 karpenter.yaml 模版 123456789$ helm template karpenter oci://public.ecr.aws/karpenter/karpenter --version $&#123;KARPENTER_VERSION&#125; \\ --namespace karpenter \\ --set settings.aws.defaultInstanceProfile=KarpenterNodeInstanceProfile-$&#123;CLUSTER_NAME&#125; \\ --set settings.aws.clusterName=$&#123;CLUSTER_NAME&#125; \\ --set serviceAccount.annotations.&quot;eks\\.amazonaws\\.com/role-arn&quot;=&quot;arn:$&#123;AWS_PARTITION&#125;:iam::$&#123;AWS_ACCOUNT_ID&#125;:role/KarpenterControllerRole-$&#123;CLUSTER_NAME&#125;&quot; \\ --set controller.resources.requests.cpu=1 \\ --set controller.resources.requests.memory=1Gi \\ --set controller.resources.limits.cpu=1 \\ --set controller.resources.limits.memory=1Gi &gt; karpenter.yaml 3.设置节点亲和性，编辑karpenter.yaml，找到karpenter deployment的亲和性配置，修改为如下内容，注意这里ng-4d9024eb要替换为你的$&#123;NODEGROUP&#125;。关节K8s节点亲和性的介绍可以参考官方文档亲和性与反亲和性 123456789101112131415affinity: nodeAffinity: requiredDuringSchedulingIgnoredDuringExecution: nodeSelectorTerms: - matchExpressions: - key: karpenter.sh/provisioner-name operator: DoesNotExist - matchExpressions: - key: eks.amazonaws.com/nodegroup operator: In values: - ng-4d9024eb podAntiAffinity: requiredDuringSchedulingIgnoredDuringExecution: - topologyKey: &quot;kubernetes.io/hostname&quot; 为其他关键集群工作负载设置nodeAffinity 例如 CoreDNS，Controller，CNI，CSI 和 Operator 等，这些 workload 对弹性要求不高但是稳定性要求比较高，建议部署在创建EKS时的节点组运行。 为这些关键负载设置nodeAffinity 123456789affinity: nodeAffinity: requiredDuringSchedulingIgnoredDuringExecution: nodeSelectorTerms: - matchExpressions: - key: eks.amazonaws.com/nodegroup operator: In values: - $&#123;NODEGROUP&#125; 比如设置k edit deploy ebs-csi-controller -n kube-system，添加好nodeAffinity后保存，然后查看对应的pod是否重启成功，如果一只处于pending状态，可以试着重启 12$ k scale deploy ebs-csi-controller --replicas 0 -n kube-system$ k scale deploy ebs-csi-controller --replicas 2 -n kube-system 设置好所有关键负载后，可以重启一下 karpenter 12$ k scale deploy karpenter --replicas 0 -n karpenter$ k scale deploy karpenter --replicas 2 -n karpenter 查看 karpenter 日志是否正常 1$ k logs deployments/karpenter -f -n karpenter 4.部署 karpenter 及其 相关资源 1234567891011121314151617# 创建Namespace$ kubectl create namespace karpenter# 下载karpenter 相关资源# karpenter的版本分支，正常karpenter发布时都会打branch，比如：release-v0.28.1，不过我在github上没有找到v0.29.1的branch，所以这里就指定 main 了$ KARPENTER_BRANCH=main$ curl -O &quot;https://raw.githubusercontent.com/aws/karpenter/$&#123;KARPENTER_BRANCH&#125;/pkg/apis/crds/karpenter.sh_provisioners.yaml&quot;$ curl -O &quot;https://raw.githubusercontent.com/aws/karpenter/$&#123;KARPENTER_BRANCH&#125;/pkg/apis/crds/karpenter.k8s.aws_awsnodetemplates.yaml&quot;$ curl -O &quot;https://raw.githubusercontent.com/aws/karpenter/$&#123;KARPENTER_BRANCH&#125;/pkg/apis/crds/karpenter.sh_machines.yaml &quot;# 部署karpenter 相关资源$ kubectl apply -f karpenter.sh_provisioners.yaml$ kubectl apply -f karpenter.k8s.aws_awsnodetemplates.yaml$ kubectl apply -f karpenter.sh_machines.yaml# 部署karpenter$ k apply -f karpenter.yaml 5.创建默认的供应者(provisioner) Provisioner与AWSNodeTemplate是karpenter在K8s中的自定义资源。 Provisioner 对 Karpenter 可创建的节点以及可在这些节点上运行的 Pod 设置约束。如果没有配置至少一个Provisioner，Karpenter 将不会执行任何操作。 关于Provisioner支持的配置项可以参考官方文档，比如下面就限制了被管控的节点必须符合两个条件： 1.实例类别必须在[c, m, r]中 2.实例的生成代次必须大于2。比如 实例类型为 c1.xxx，m1.xxx，m2.xxx就不符合要求 AWSNodeTemplate节点模板启用AWS特定设置的配置。关于AWSNodeTemplate支持的配置项可以参考官方文档，比如默认节点关联的存储为20G gp3，如果要修改为40G可以在spec下指定如下内容，先创建后编辑也可以，但只有修改后新创建的节点才会使用新的配置。 123456blockDeviceMappings:- deviceName: /dev/xvda ebs: volumeType: gp3 volumeSize: 40Gi deleteOnTermination: true Provisioner需要与AWSNodeTemplate关联使用，通过在Provisioner的providerRef中指定AWSNodeTemplate的name进行关联，一个AWSNodeTemplate可以被多个Provisioner关联。 配置的每个 Provisioner 均由 Karpenter 循环遍历。在 Provisioner 中定义污点以限制可以在 Karpenter 创建的节点上运行的 Pod。建议创建互斥的 Provisioner。因此任何 Pod 都不应该匹配多个 Provisioner。如果匹配多个Provisioner，Karpenter将使用权重最高的Provisioner 。关于K8s中污点的介绍可以参考官方文档污点和容忍度 下面是一个最基本的Provisioner定义，你可以根据需要创建自己的Provisioner，可以参考官方文档或者查看provisioner examples中的示例。 123456789101112131415161718192021222324252627# 创建 default Provisioner$ cat &lt;&lt;EOF | kubectl apply -f -apiVersion: karpenter.sh/v1alpha5kind: Provisionermetadata: name: defaultspec: requirements: - key: karpenter.k8s.aws/instance-category operator: In values: [c, m, r] - key: karpenter.k8s.aws/instance-generation operator: Gt values: [&quot;2&quot;] providerRef: name: default---apiVersion: karpenter.k8s.aws/v1alpha1kind: AWSNodeTemplatemetadata: name: defaultspec: subnetSelector: karpenter.sh/discovery: &quot;$&#123;CLUSTER_NAME&#125;&quot; securityGroupSelector: karpenter.sh/discovery: &quot;$&#123;CLUSTER_NAME&#125;&quot;EOF 查看 karpenter 状态 1234$ k get pod -n karpenterNAME READY STATUS RESTARTS AGEkarpenter-789bbcbfd7-htj6z 1/1 Running 0 101skarpenter-789bbcbfd7-rlxfp 1/1 Running 0 101s 查看 karpenter 日志是否正常 1$ k logs deployments/karpenter -f -n karpenter karpenter创建新的节点时不会在原有的节点组中进行，所以为了摆脱从节点组添加的实例，我们可以将节点组缩小到最小大小 1234# 如果您有一个多AZ节点组，我们建议至少2个实例。$ aws eks update-nodegroup-config --cluster-name $&#123;CLUSTER_NAME&#125; \\ --nodegroup-name $&#123;NODEGROUP&#125; \\ --scaling-config &quot;minSize=2,maxSize=2,desiredSize=2&quot; 关停Cluster Autoscaler(CAS) 如果EKS中已经开启了CAS，则安装Karpenter后需要关闭CAS 1$ kubectl scale deploy/cluster-autoscaler -n kube-system --replicas=0 测试 查看当前node信息 1234$ k get nodeNAME STATUS ROLES AGE VERSIONip-192-168-16-155.us-west-2.compute.internal Ready &lt;none&gt; 19d v1.26.4-eks-0a21954ip-192-168-48-14.us-west-2.compute.internal Ready &lt;none&gt; 19d v1.26.4-eks-0a21954 采用 AWS-EKS-18--Autoscaling 之 Cluster Autoscaler(CAS) 中的测试方法，将deploy的副本数设置为50，过一会查看node情况 123456# 可以看到node数量已经变为3了，说明扩容成功$ k get nodeNAME STATUS ROLES AGE VERSIONip-192-168-16-155.us-west-2.compute.internal Ready &lt;none&gt; 19d v1.26.4-eks-0a21954ip-192-168-34-126.us-west-2.compute.internal Ready &lt;none&gt; 47s v1.26.6-eks-a5565adip-192-168-48-14.us-west-2.compute.internal Ready &lt;none&gt; 19d v1.26.4-eks-0a21954 缩容测试用的deploy，副本数设置为1，过一会发现node节点并没有被终止，这是为什么呢？ 默认情况下，Karpenter不会主动终止节点，需要为其设置终止节点的方式，参考Karpenter官方文档Deprovisioning部分 在Provisioner中设置节点终止的方式 spec.ttlSecondsAfterEmpty: 当最后一个工作负载（非守护程序集）pod停止在节点上运行时，Karpenter会注意到。从那时起，Karpenter在提供程序中等待ttlSecondsAfterEmpty设置的秒数，然后Karpenter请求删除节点。此功能可以通过删除不再用于工作负载的节点来降低成本。 spec.ttlSecondsUntilExpired: Karpenter 将根据Provisioner的ttlSecondsUntilExpired值将节点注释为过期，并在节点生存了设定秒数后取消配置节点。节点过期的一种用例是定期回收节点。 spec.consolidation.enabled: 实现整合，通过删除不需要的节点和缩减无法删除的节点的规模来降低集群成本。与ttlSecondsAfterEmpty参数互斥。 12# 编辑 default provisioner，并为其指定 spec.ttlSecondsAfterEmpty: 30，表示空闲超过30秒则终止节点。$ k edit provisioners.karpenter.sh default 1234567891011121314151617181920212223242526272829303132333435363738394041424344apiVersion: karpenter.sh/v1alpha5kind: Provisionermetadata: annotations: kubectl.kubernetes.io/last-applied-configuration: | &#123;&quot;apiVersion&quot;:&quot;karpenter.sh/v1alpha5&quot;,&quot;kind&quot;:&quot;Provisioner&quot;,&quot;metadata&quot;:&#123;&quot;annotations&quot;:&#123; creationTimestamp: &quot;2023-07-19T09:49:43Z&quot; generation: 3 name: default resourceVersion: &quot;7987578&quot; uid: 5716142b-2b9f-493c-a049-e4304cdf82d4spec: providerRef: name: default requirements: - key: karpenter.k8s.aws/instance-category operator: In values: - c - m - r - key: karpenter.k8s.aws/instance-generation operator: Gt values: - &quot;2&quot; - key: kubernetes.io/os operator: In values: - linux - key: kubernetes.io/arch operator: In values: - amd64 - key: karpenter.sh/capacity-type operator: In values: - on-demand ttlSecondsAfterEmpty: 30status: resources: cpu: &quot;2&quot; ephemeral-storage: 20959212Ki memory: 3900360Ki pods: &quot;29&quot; 等待30秒后查看node情况，新创建的node已经成功终止 1234$ k get nodeNAME STATUS ROLES AGE VERSIONip-192-168-16-155.us-west-2.compute.internal Ready &lt;none&gt; 19d v1.26.4-eks-0a21954ip-192-168-48-14.us-west-2.compute.internal Ready &lt;none&gt; 19d v1.26.4-eks-0a21954 创建和终止节点的过程可以通过日志进行观察 12345678910111213141516171819$ k logs deployments/karpenter -f -n karpenter# 以下创建节点的日志2023-07-20T09:03:54.763Z INFO controller.provisioner found provisionable pod(s) &#123;&quot;commit&quot;: &quot;5b469b8-dirty&quot;, &quot;pods&quot;: 17&#125;2023-07-20T09:03:54.763Z INFO controller.provisioner computed new machine(s) to fit pod(s) &#123;&quot;commit&quot;: &quot;5b469b8-dirty&quot;, &quot;machines&quot;: 1, &quot;pods&quot;: 17&#125;2023-07-20T09:03:54.788Z INFO controller.provisioner created machine &#123;&quot;commit&quot;: &quot;5b469b8-dirty&quot;, &quot;provisioner&quot;: &quot;default&quot;, &quot;requests&quot;: &#123;&quot;cpu&quot;:&quot;155m&quot;,&quot;memory&quot;:&quot;120Mi&quot;,&quot;pods&quot;:&quot;21&quot;&#125;, &quot;instance-types&quot;: &quot;c3.2xlarge, c3.large, c3.xlarge, c4.2xlarge, c4.large and 95 other(s)&quot;&#125;2023-07-20T09:03:54.978Z DEBUG controller.machine.lifecycle created launch template &#123;&quot;commit&quot;: &quot;5b469b8-dirty&quot;, &quot;machine&quot;: &quot;default-c6jkx&quot;, &quot;provisioner&quot;: &quot;default&quot;, &quot;launch-template-name&quot;: &quot;karpenter.k8s.aws/2892028901667059566&quot;, &quot;id&quot;: &quot;lt-0ef53ab2c4909f493&quot;&#125;2023-07-20T09:03:55.108Z DEBUG controller.machine.lifecycle created launch template &#123;&quot;commit&quot;: &quot;5b469b8-dirty&quot;, &quot;machine&quot;: &quot;default-c6jkx&quot;, &quot;provisioner&quot;: &quot;default&quot;, &quot;launch-template-name&quot;: &quot;karpenter.k8s.aws/1810058814439854165&quot;, &quot;id&quot;: &quot;lt-02cda7252a2d29e16&quot;&#125;2023-07-20T09:03:57.095Z INFO controller.machine.lifecycle launched machine &#123;&quot;commit&quot;: &quot;5b469b8-dirty&quot;, &quot;machine&quot;: &quot;default-c6jkx&quot;, &quot;provisioner&quot;: &quot;default&quot;, &quot;provider-id&quot;: &quot;aws:///us-west-2d/i-0bb92e04b7192cafd&quot;, &quot;instance-type&quot;: &quot;c6a.large&quot;, &quot;zone&quot;: &quot;us-west-2d&quot;, &quot;capacity-type&quot;: &quot;on-demand&quot;, &quot;allocatable&quot;: &#123;&quot;cpu&quot;:&quot;1930m&quot;,&quot;ephemeral-storage&quot;:&quot;17Gi&quot;,&quot;memory&quot;:&quot;3114Mi&quot;,&quot;pods&quot;:&quot;29&quot;&#125;&#125;2023-07-20T09:04:14.473Z DEBUG controller.machine.lifecycle registered machine &#123;&quot;commit&quot;: &quot;5b469b8-dirty&quot;, &quot;machine&quot;: &quot;default-c6jkx&quot;, &quot;provisioner&quot;: &quot;default&quot;, &quot;provider-id&quot;: &quot;aws:///us-west-2d/i-0bb92e04b7192cafd&quot;, &quot;node&quot;: &quot;ip-192-168-79-236.us-west-2.compute.internal&quot;&#125;2023-07-20T09:04:28.620Z DEBUG controller.machine.lifecycle initialized machine&#123;&quot;commit&quot;: &quot;5b469b8-dirty&quot;, &quot;machine&quot;: &quot;default-c6jkx&quot;, &quot;provisioner&quot;: &quot;default&quot;, &quot;provider-id&quot;: &quot;aws:///us-west-2d/i-0bb92e04b7192cafd&quot;, &quot;node&quot;: &quot;ip-192-168-79-236.us-west-2.compute.internal&quot;&#125;# 以下是终止节点的日志2023-07-20T09:05:46.420Z DEBUG controller.machine.disruption marking machine as empty &#123;&quot;commit&quot;: &quot;5b469b8-dirty&quot;, &quot;machine&quot;: &quot;default-c6jkx&quot;&#125;2023-07-20T09:06:20.642Z INFO controller.deprovisioning deprovisioning via emptiness delete, terminating 1 machines ip-192-168-79-236.us-west-2.compute.internal/c6a.large/on-demand &#123;&quot;commit&quot;: &quot;5b469b8-dirty&quot;&#125;2023-07-20T09:06:20.699Z INFO controller.termination cordoned node &#123;&quot;commit&quot;: &quot;5b469b8-dirty&quot;, &quot;node&quot;: &quot;ip-192-168-79-236.us-west-2.compute.internal&quot;&#125;2023-07-20T09:06:21.026Z INFO controller.termination deleted node &#123;&quot;commit&quot;: &quot;5b469b8-dirty&quot;, &quot;node&quot;: &quot;ip-192-168-79-236.us-west-2.compute.internal&quot;&#125;2023-07-20T09:06:21.288Z INFO controller.machine.termination deleted machine &#123;&quot;commit&quot;: &quot;5b469b8-dirty&quot;, &quot;machine&quot;: &quot;default-c6jkx&quot;, &quot;node&quot;: &quot;ip-192-168-79-236.us-west-2.compute.internal&quot;, &quot;provisioner&quot;: &quot;default&quot;, &quot;provider-id&quot;: &quot;aws:///us-west-2d/i-0bb92e04b7192cafd&quot;&#125; 小贴士 当Karpenter管理的Node节点由于某种原因不可用时(比如我们在AWS控制台终止了EC2或通过命令行删除节点k delete node nodeName)，Karpenter会立刻为我们创建一个新的Node节点，并在其上重启Pod。 参考资料 从Cluster Autoscaler迁移 EKS Cluster Autoscaler 迁移 Karpenter 实践 Karpenter Best Practices","summary":"摘要 本文介绍EKS集群Autoscaling 之 Karpenter 参考资料： Amazon EKS用户指南 Kubernetes 文档","date_published":"2023-07-19T12:30:05.000Z","tags":["技术","aws","eks","java"]},{"id":"https://blog.hanqunfeng.com/2023/07/18/aws-eks18-autoscaler-cas/","url":"https://blog.hanqunfeng.com/2023/07/18/aws-eks18-autoscaler-cas/","title":"AWS-EKS-18--Autoscaling 之 Cluster Autoscaler(CAS)","content_html":"<!--\n **加粗**\n *斜体*\n ***加粗并斜体***\n ~~删除线~~\n ==突出显示==\n `突出显示(推荐)`\n ++下划线++\n ~下标~\n ^上标^\n 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.\n 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600)\n\n +++ **点击折叠**\n 这是被隐藏的内容\n +++\n\n::: tips success warning danger\n这里是容器内的内容\n:::\n\n% note info % success warning danger\n这里是容器内的内容\n% endnote %\n\n -->\n<h2 id=\"摘要\">摘要</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>本文介绍EKS集群Autoscaling 之 Cluster Autoscaler(CAS)</p>\n</li>\n<li class=\"lvl-2\">\n<p>参考资料：</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\"><a href=\"https://docs.aws.amazon.com/zh_cn/eks/latest/userguide\">Amazon EKS用户指南</a></li>\n<li class=\"lvl-6\"><a href=\"https://kubernetes.io/zh-cn/docs/home/\">Kubernetes 文档</a></li>\n</ul>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"EKS集群Autoscaling\">EKS集群Autoscaling</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>弹性伸缩是一项功能，可以自动上下伸缩您的资源以满足不断变化的需求。</p>\n</li>\n<li class=\"lvl-2\">\n<p>Amazon EKS 支持两款自动扩缩产品:</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\"><a href=\"https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/cloudprovider/aws/README.md\">Cluster Autoscaler(CAS) </a>，本文就介绍这款产品的使用方法。</li>\n<li class=\"lvl-6\"><a href=\"https://karpenter.sh/docs/\">Karpenter</a>，参看 <a href=\"/2023/07/19/aws-eks19-autoscaler-karpenter/\" title=\"AWS-EKS-19--Autoscaling 之 Karpenter\">AWS-EKS-19--Autoscaling 之 Karpenter</a></li>\n</ul>\n</li>\n</ul>\n<h2 id=\"Cluster-Autoscaler-CAS-是什么？\">Cluster Autoscaler(CAS)是什么？</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>Cluster Autoscaler</code> 是一个可以自动调整<code>Kubernetes</code>集群大小的组件，以便所有<code>pod</code>都有运行的地方，并且没有不需要的节点。支持多个公共云提供商。</p>\n</li>\n<li class=\"lvl-2\">\n<p><code>AWS EKS</code>集群自动扩容功能可以基于<code>Cluster Autoscaler</code>自动调整集群中node的数量以适应需求变化。</p>\n</li>\n<li class=\"lvl-2\">\n<p><code>Cluster Autoscaler</code>一般以Deployment的方式部署在K8s中，通过<code>service account</code>赋予的权限来访问<code>AWS autoscaling group</code>资源，并控制node（EC2）的增减。</p>\n</li>\n<li class=\"lvl-2\">\n<p><code>AWS EKS Cluster Autoscaler</code> 以 <code>Amazon EC2 Auto Scaling Groups</code>服务为基础对node进行扩容，所以其扩容或缩容时，也要遵守节点组扩缩中的配置<br>\n<img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/igPla5.png\" alt=\"\" width=\"300\" height=\"300\"></p>\n</li>\n<li class=\"lvl-2\">\n<p>当有新的Pod无法在现有node上schedule时会触发扩容，当node空闲超过10min时，会触发缩容。</p>\n</li>\n<li class=\"lvl-2\">\n<p><code>Cluster Autoscaler</code>的镜像版本要求与K8s版本匹配，所以当EKS(K8s)升级时，<code>Cluster Autoscaler</code>的镜像也要进行升级。</p>\n</li>\n</ul>\n<h2 id=\"创建IAM策略和角色\">创建IAM策略和角色</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>创建Policy：<code>cluster-autoscaler-policy.json</code></p>\n</li>\n</ul>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;Version&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;2012-10-17&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;Statement&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">      <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">        <span class=\"attr\">&quot;Effect&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;Allow&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">        <span class=\"attr\">&quot;Action&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">          <span class=\"string\">&quot;autoscaling:DescribeAutoScalingGroups&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">          <span class=\"string\">&quot;autoscaling:DescribeAutoScalingInstances&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">          <span class=\"string\">&quot;autoscaling:DescribeLaunchConfigurations&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">          <span class=\"string\">&quot;autoscaling:DescribeScalingActivities&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">          <span class=\"string\">&quot;autoscaling:DescribeTags&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">          <span class=\"string\">&quot;ec2:DescribeInstanceTypes&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">          <span class=\"string\">&quot;ec2:DescribeLaunchTemplateVersions&quot;</span></span><br><span class=\"line\">        <span class=\"punctuation\">]</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">        <span class=\"attr\">&quot;Resource&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span><span class=\"string\">&quot;*&quot;</span><span class=\"punctuation\">]</span></span><br><span class=\"line\">      <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">        <span class=\"attr\">&quot;Effect&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;Allow&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">        <span class=\"attr\">&quot;Action&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">          <span class=\"string\">&quot;autoscaling:SetDesiredCapacity&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">          <span class=\"string\">&quot;autoscaling:TerminateInstanceInAutoScalingGroup&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">          <span class=\"string\">&quot;ec2:DescribeImages&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">          <span class=\"string\">&quot;ec2:GetInstanceTypesFromInstanceRequirements&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">          <span class=\"string\">&quot;eks:DescribeNodegroup&quot;</span></span><br><span class=\"line\">        <span class=\"punctuation\">]</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">        <span class=\"attr\">&quot;Resource&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span><span class=\"string\">&quot;*&quot;</span><span class=\"punctuation\">]</span></span><br><span class=\"line\">      <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">    <span class=\"punctuation\">]</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ <span class=\"built_in\">export</span> AWS_PROFILE=eks-ty-old</span><br><span class=\"line\">$ aws iam create-policy \\</span><br><span class=\"line\">    --policy-name AmazonEKSClusterAutoscalerPolicy \\</span><br><span class=\"line\">    --policy-document file://cluster-autoscaler-policy.json</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;Policy&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;PolicyName&quot;</span>: <span class=\"string\">&quot;AmazonEKSClusterAutoscalerPolicy&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;PolicyId&quot;</span>: <span class=\"string\">&quot;ANPA22DP3G4GBZ4RXQA2J&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;Arn&quot;</span>: <span class=\"string\">&quot;arn:aws:iam::743263909644:policy/AmazonEKSClusterAutoscalerPolicy&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;Path&quot;</span>: <span class=\"string\">&quot;/&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;DefaultVersionId&quot;</span>: <span class=\"string\">&quot;v1&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;AttachmentCount&quot;</span>: 0,</span><br><span class=\"line\">        <span class=\"string\">&quot;PermissionsBoundaryUsageCount&quot;</span>: 0,</span><br><span class=\"line\">        <span class=\"string\">&quot;IsAttachable&quot;</span>: <span class=\"literal\">true</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;CreateDate&quot;</span>: <span class=\"string\">&quot;2023-07-18T09:31:24+00:00&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;UpdateDate&quot;</span>: <span class=\"string\">&quot;2023-07-18T09:31:24+00:00&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>创建IAM Role的信任关系：<code>trust-policy.json</code></p>\n</li>\n</ul>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;Version&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;2012-10-17&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;Statement&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">        <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">            <span class=\"attr\">&quot;Effect&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;Allow&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">            <span class=\"attr\">&quot;Principal&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">                <span class=\"attr\">&quot;Federated&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;arn:aws:iam::743263909644:oidc-provider/oidc.eks.us-west-2.amazonaws.com/id/1029FF88CB872B6B7A1CC65D44191A56&quot;</span></span><br><span class=\"line\">            <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">            <span class=\"attr\">&quot;Action&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;sts:AssumeRoleWithWebIdentity&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">            <span class=\"attr\">&quot;Condition&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">                <span class=\"attr\">&quot;StringEquals&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">                    <span class=\"attr\">&quot;oidc.eks.us-west-2.amazonaws.com/id/1029FF88CB872B6B7A1CC65D44191A56:aud&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;sts.amazonaws.com&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">                    <span class=\"attr\">&quot;oidc.eks.us-west-2.amazonaws.com/id/1029FF88CB872B6B7A1CC65D44191A56:sub&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;system:serviceaccount:kube-system:cluster-autoscaler&quot;</span></span><br><span class=\"line\">                <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">            <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">        <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">    <span class=\"punctuation\">]</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>创建 IAM Role</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ aws iam create-role \\</span><br><span class=\"line\">  --role-name AmazonEKSClusterAutoscalerRole \\</span><br><span class=\"line\">  --assume-role-policy-document file://<span class=\"string\">&quot;trust-policy.json&quot;</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;Role&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;Path&quot;</span>: <span class=\"string\">&quot;/&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;RoleName&quot;</span>: <span class=\"string\">&quot;AmazonEKSClusterAutoscalerRole&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;RoleId&quot;</span>: <span class=\"string\">&quot;AROA22DP3G4GHSSPEOMUH&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;Arn&quot;</span>: <span class=\"string\">&quot;arn:aws:iam::743263909644:role/AmazonEKSClusterAutoscalerRole&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;CreateDate&quot;</span>: <span class=\"string\">&quot;2023-07-18T09:39:54+00:00&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;AssumeRolePolicyDocument&quot;</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;Version&quot;</span>: <span class=\"string\">&quot;2012-10-17&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;Statement&quot;</span>: [</span><br><span class=\"line\">                &#123;</span><br><span class=\"line\">                    <span class=\"string\">&quot;Effect&quot;</span>: <span class=\"string\">&quot;Allow&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;Principal&quot;</span>: &#123;</span><br><span class=\"line\">                        <span class=\"string\">&quot;Federated&quot;</span>: <span class=\"string\">&quot;arn:aws:iam::743263909644:oidc-provider/oidc.eks.us-west-2.amazonaws.com/id/1029FF88CB872B6B7A1CC65D44191A56&quot;</span></span><br><span class=\"line\">                    &#125;,</span><br><span class=\"line\">                    <span class=\"string\">&quot;Action&quot;</span>: <span class=\"string\">&quot;sts:AssumeRoleWithWebIdentity&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;Condition&quot;</span>: &#123;</span><br><span class=\"line\">                        <span class=\"string\">&quot;StringEquals&quot;</span>: &#123;</span><br><span class=\"line\">                            <span class=\"string\">&quot;oidc.eks.us-west-2.amazonaws.com/id/1029FF88CB872B6B7A1CC65D44191A56:aud&quot;</span>: <span class=\"string\">&quot;sts.amazonaws.com&quot;</span>,</span><br><span class=\"line\">                            <span class=\"string\">&quot;oidc.eks.us-west-2.amazonaws.com/id/1029FF88CB872B6B7A1CC65D44191A56:sub&quot;</span>: <span class=\"string\">&quot;system:serviceaccount:kube-system:cluster-autoscaler&quot;</span></span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            ]</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>为 Role 添加 Policy</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ aws iam attach-role-policy \\</span><br><span class=\"line\">  --policy-arn arn:aws:iam::743263909644:policy/AmazonEKSClusterAutoscalerPolicy \\</span><br><span class=\"line\">  --role-name AmazonEKSClusterAutoscalerRole</span><br></pre></td></tr></table></figure>\n<h2 id=\"部署Cluster-Autoscaler\">部署Cluster Autoscaler</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>下载Autoscaler yaml文件</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#下载yaml文件，github仓库中的文件下载路径格式为：https://raw.githubusercontent.com/&lt;Owner&gt;/&lt;RepositoryName&gt;/&lt;branch&gt;/&lt;FilePath&gt;</span></span><br><span class=\"line\">$ wget https://raw.githubusercontent.com/kubernetes/autoscaler/master/cluster-autoscaler/cloudprovider/aws/examples/cluster-autoscaler-autodiscover.yaml</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 获取使用git命令，这里只clone出指定文件</span></span><br><span class=\"line\">$ git <span class=\"built_in\">clone</span> --depth 1 https://github.com/kubernetes/autoscaler --branch master --single-branch cluster-autoscaler/cloudprovider/aws/examples/cluster-autoscaler-autodiscover.yaml</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>修改yaml文件配置<br>\n打开<code>Cluster Autoscaler</code>的<a href=\"https://github.com/kubernetes/autoscaler/releases\">github地址</a>，查看与EKS版本匹配的最新Autoscaler镜像版本<br>\n<img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/GBArR8.png\" alt=\"\" width=\"600\" height=\"600\"></p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">1.把cluster-autoscaler的镜像版本换成上面查到的版本1.26.3</li>\n<li class=\"lvl-6\">2.查找并替换“<YOUR CLUSTER NAME>”为我们EKS的名称: <code>eks-lexing</code></li>\n<li class=\"lvl-6\">3.在EKS的名称“tsEKS”下面，并添加以下两行</li>\n</ul>\n  <figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- --balance-similar-node-groups</span><br><span class=\"line\">- --skip-nodes-with-system-pods=false</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p><code>--balance-similar-node-groups</code>：此选项用于启用集群节点组的负载均衡功能。当你有多个具有相似容量的节点组时，启用此选项可以确保 Cluster Autoscaler 尽可能均衡地在这些节点组之间分配 Pod。它帮助确保节点组的资源利用率更加平衡，以提高集群的整体性能。<br>\n<code>--skip-nodes-with-system-pods=false</code>：此选项用于设置是否跳过具有系统 Pod 的节点。默认情况下，Cluster Autoscaler 会跳过具有系统 Pod（如 kube-system 命名空间中的核心组件）的节点，以确保这些关键组件的正常运行。将该选项设置为 false，即禁用跳过具有系统 Pod 的节点，可以让 Cluster Autoscaler 考虑包括具有系统 Pod 的节点在内的所有节点进行调整。</p>\n</blockquote>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">4.为ServiceAccount添加IMA Role注解，注意一定要添加这个注解后再进行部署，否则会提示没有权限<br>\n<img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/98SQ9l.png\" alt=\"\" width=\"1200\" height=\"600\"><br>\n<img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/88IL8W.png\" alt=\"\" width=\"1200\" height=\"300\"></li>\n</ul>\n</li>\n<li class=\"lvl-2\">\n<p>部署Cluster Autoscaler</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubectl apply -f cluster-autoscaler-autodiscover.yaml</span><br><span class=\"line\">serviceaccount/cluster-autoscaler created</span><br><span class=\"line\">clusterrole.rbac.authorization.k8s.io/cluster-autoscaler created</span><br><span class=\"line\">role.rbac.authorization.k8s.io/cluster-autoscaler created</span><br><span class=\"line\">clusterrolebinding.rbac.authorization.k8s.io/cluster-autoscaler created</span><br><span class=\"line\">rolebinding.rbac.authorization.k8s.io/cluster-autoscaler created</span><br><span class=\"line\">deployment.apps/cluster-autoscaler created</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>查看Cluster Autoscaler Deployment</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># cluster-autoscaler</span></span><br><span class=\"line\">$ k get deploy</span><br><span class=\"line\">NAME                           READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class=\"line\">aws-load-balancer-controller   2/2     2            2           14d</span><br><span class=\"line\">cluster-autoscaler             1/1     1            1           9m10s</span><br><span class=\"line\">coredns                        2/2     2            2           20d</span><br><span class=\"line\">ebs-csi-controller             2/2     2            2           20d</span><br><span class=\"line\">efs-csi-controller             2/2     2            2           15d</span><br><span class=\"line\">metrics-server                 1/1     1            1           20d</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>给autoscaler deployment打patch，增加annotation</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 这个注解的作用是告诉 Kubernetes 系统不要将这些 Pod 标记为可以被安全驱逐（evict）的 Pod。</span></span><br><span class=\"line\"><span class=\"comment\"># 通过将 cluster-autoscaler 部署的 Pod 标记为不可安全驱逐，可以避免 Cluster Autoscaler 将这些关键组件的 Pod 视为可以被删除的对象。</span></span><br><span class=\"line\">$ kubectl patch deployment cluster-autoscaler \\</span><br><span class=\"line\">  -n kube-system \\</span><br><span class=\"line\">  -p <span class=\"string\">&#x27;&#123;&quot;spec&quot;:&#123;&quot;template&quot;:&#123;&quot;metadata&quot;:&#123;&quot;annotations&quot;:&#123;&quot;cluster-autoscaler.kubernetes.io/safe-to-evict&quot;: &quot;false&quot;&#125;&#125;&#125;&#125;&#125;&#x27;</span></span><br><span class=\"line\">deployment.apps/cluster-autoscaler patched</span><br></pre></td></tr></table></figure>\n<h2 id=\"测试\">测试</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>查看当前node节点</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ k get node</span><br><span class=\"line\">NAME                                           STATUS   ROLES    AGE   VERSION</span><br><span class=\"line\">ip-192-168-16-155.us-west-2.compute.internal   Ready    &lt;none&gt;   18d   v1.26.4-eks-0a21954</span><br><span class=\"line\">ip-192-168-48-14.us-west-2.compute.internal    Ready    &lt;none&gt;   18d   v1.26.4-eks-0a21954</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>创建测试用的deployment：<code>testDeploy.yaml</code></p>\n</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nginx-deployment</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">test</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">nginx:1.20.2</span></span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">80</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ k apply -f testDeploy.yaml</span><br><span class=\"line\">deployment.apps/nginx-deployment created</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 扩容</span></span><br><span class=\"line\"><span class=\"comment\"># 因为我这里的节点实例类型为 m5.large，所以replicas要设置的大一些</span></span><br><span class=\"line\">k scale deploy nginx-deployment --replicas 50 -n <span class=\"built_in\">test</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>过一会查看node情况</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 可以看到新创建了一个node节点</span></span><br><span class=\"line\">$ k get node</span><br><span class=\"line\">NAME                                           STATUS   ROLES    AGE   VERSION</span><br><span class=\"line\">ip-192-168-16-155.us-west-2.compute.internal   Ready    &lt;none&gt;   18d   v1.26.4-eks-0a21954</span><br><span class=\"line\">ip-192-168-48-14.us-west-2.compute.internal    Ready    &lt;none&gt;   18d   v1.26.4-eks-0a21954</span><br><span class=\"line\">ip-192-168-86-167.us-west-2.compute.internal   Ready    &lt;none&gt;   68s   v1.26.4-eks-0a21954</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># pod也都正常运行</span></span><br><span class=\"line\">$ k get pod -n <span class=\"built_in\">test</span></span><br><span class=\"line\">NAME                                     READY   STATUS    RESTARTS   AGE</span><br><span class=\"line\">nginx-deployment-7876b754ff-2nd5k        1/1     Running   0          111s</span><br><span class=\"line\">nginx-deployment-7876b754ff-2ppvw        1/1     Running   0          111s</span><br><span class=\"line\">nginx-deployment-7876b754ff-45csw        1/1     Running   0          110s</span><br><span class=\"line\">nginx-deployment-7876b754ff-46tmf        1/1     Running   0          111s</span><br><span class=\"line\">nginx-deployment-7876b754ff-5vt8p        1/1     Running   0          110s</span><br><span class=\"line\">nginx-deployment-7876b754ff-66ztw        1/1     Running   0          111s</span><br><span class=\"line\">nginx-deployment-7876b754ff-77f4d        1/1     Running   0          110s</span><br><span class=\"line\">nginx-deployment-7876b754ff-8jj92        1/1     Running   0          111s</span><br><span class=\"line\">nginx-deployment-7876b754ff-8kj97        1/1     Running   0          111s</span><br><span class=\"line\">nginx-deployment-7876b754ff-9c8kr        1/1     Running   0          111s</span><br><span class=\"line\">nginx-deployment-7876b754ff-9szmq        1/1     Running   0          111s</span><br><span class=\"line\">nginx-deployment-7876b754ff-blbqd        1/1     Running   0          111s</span><br><span class=\"line\">nginx-deployment-7876b754ff-bpppd        1/1     Running   0          111s</span><br><span class=\"line\">nginx-deployment-7876b754ff-c46sb        1/1     Running   0          111s</span><br><span class=\"line\">nginx-deployment-7876b754ff-d5b45        1/1     Running   0          111s</span><br><span class=\"line\">………………………………</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>缩容deploy</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 将副本降为1</span></span><br><span class=\"line\">$ k scale deploy nginx-deployment --replicas 1 -n <span class=\"built_in\">test</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 测试完成可以删除</span></span><br><span class=\"line\">$ k delete -f testDeploy.yaml</span><br><span class=\"line\">deployment.apps <span class=\"string\">&quot;nginx-deployment&quot;</span> deleted</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>大约过10几分钟就可以看到新增的node已经下线</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ k get node</span><br><span class=\"line\">NAME                                           STATUS   ROLES    AGE   VERSION</span><br><span class=\"line\">ip-192-168-16-155.us-west-2.compute.internal   Ready    &lt;none&gt;   18d   v1.26.4-eks-0a21954</span><br><span class=\"line\">ip-192-168-48-14.us-west-2.compute.internal    Ready    &lt;none&gt;   18d   v1.26.4-eks-0a21954</span><br></pre></td></tr></table></figure>\n<h2 id=\"升级Cluster-Autoscaler\">升级Cluster Autoscaler</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>Cluster Autoscaler</code>的镜像版本要求与K8s版本匹配，所以当EKS(K8s)升级时，<code>Cluster Autoscaler</code>的镜像也要进行升级。</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubectl <span class=\"built_in\">set</span> image deployment cluster-autoscaler \\</span><br><span class=\"line\">  -n kube-system \\</span><br><span class=\"line\">  cluster-autoscaler=registry.k8s.io/autoscaling/cluster-autoscaler:v&lt;x.x.x&gt;</span><br><span class=\"line\"><span class=\"comment\"># 或者直接编辑也是可以的</span></span><br><span class=\"line\">$ k edit deploy -n kube-system cluster-autoscaler</span><br></pre></td></tr></table></figure>\n<h2 id=\"关闭Cluster-Autoscaler\">关闭Cluster Autoscaler</h2>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ k scale deploy cluster-autoscaler -n kube-system --replicas 0</span><br><span class=\"line\">deployment.apps/cluster-autoscaler scaled</span><br><span class=\"line\"></span><br><span class=\"line\">$ k get deploy</span><br><span class=\"line\">NAME                           READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class=\"line\">aws-load-balancer-controller   2/2     2            2           14d</span><br><span class=\"line\">cluster-autoscaler             0/0     0            0           20h</span><br><span class=\"line\">coredns                        2/2     2            2           21d</span><br><span class=\"line\">ebs-csi-controller             2/2     2            2           20d</span><br><span class=\"line\">efs-csi-controller             2/2     2            2           15d</span><br><span class=\"line\">metrics-server                 1/1     1            1           21d</span><br></pre></td></tr></table></figure>","content_text":"摘要 本文介绍EKS集群Autoscaling 之 Cluster Autoscaler(CAS) 参考资料： Amazon EKS用户指南 Kubernetes 文档 EKS集群Autoscaling 弹性伸缩是一项功能，可以自动上下伸缩您的资源以满足不断变化的需求。 Amazon EKS 支持两款自动扩缩产品: Cluster Autoscaler(CAS) ，本文就介绍这款产品的使用方法。 Karpenter，参看 AWS-EKS-19--Autoscaling 之 Karpenter Cluster Autoscaler(CAS)是什么？ Cluster Autoscaler 是一个可以自动调整Kubernetes集群大小的组件，以便所有pod都有运行的地方，并且没有不需要的节点。支持多个公共云提供商。 AWS EKS集群自动扩容功能可以基于Cluster Autoscaler自动调整集群中node的数量以适应需求变化。 Cluster Autoscaler一般以Deployment的方式部署在K8s中，通过service account赋予的权限来访问AWS autoscaling group资源，并控制node（EC2）的增减。 AWS EKS Cluster Autoscaler 以 Amazon EC2 Auto Scaling Groups服务为基础对node进行扩容，所以其扩容或缩容时，也要遵守节点组扩缩中的配置 当有新的Pod无法在现有node上schedule时会触发扩容，当node空闲超过10min时，会触发缩容。 Cluster Autoscaler的镜像版本要求与K8s版本匹配，所以当EKS(K8s)升级时，Cluster Autoscaler的镜像也要进行升级。 创建IAM策略和角色 创建Policy：cluster-autoscaler-policy.json 1234567891011121314151617181920212223242526272829&#123; &quot;Version&quot;: &quot;2012-10-17&quot;, &quot;Statement&quot;: [ &#123; &quot;Effect&quot;: &quot;Allow&quot;, &quot;Action&quot;: [ &quot;autoscaling:DescribeAutoScalingGroups&quot;, &quot;autoscaling:DescribeAutoScalingInstances&quot;, &quot;autoscaling:DescribeLaunchConfigurations&quot;, &quot;autoscaling:DescribeScalingActivities&quot;, &quot;autoscaling:DescribeTags&quot;, &quot;ec2:DescribeInstanceTypes&quot;, &quot;ec2:DescribeLaunchTemplateVersions&quot; ], &quot;Resource&quot;: [&quot;*&quot;] &#125;, &#123; &quot;Effect&quot;: &quot;Allow&quot;, &quot;Action&quot;: [ &quot;autoscaling:SetDesiredCapacity&quot;, &quot;autoscaling:TerminateInstanceInAutoScalingGroup&quot;, &quot;ec2:DescribeImages&quot;, &quot;ec2:GetInstanceTypesFromInstanceRequirements&quot;, &quot;eks:DescribeNodegroup&quot; ], &quot;Resource&quot;: [&quot;*&quot;] &#125; ] &#125; 123456789101112131415161718$ export AWS_PROFILE=eks-ty-old$ aws iam create-policy \\ --policy-name AmazonEKSClusterAutoscalerPolicy \\ --policy-document file://cluster-autoscaler-policy.json&#123; &quot;Policy&quot;: &#123; &quot;PolicyName&quot;: &quot;AmazonEKSClusterAutoscalerPolicy&quot;, &quot;PolicyId&quot;: &quot;ANPA22DP3G4GBZ4RXQA2J&quot;, &quot;Arn&quot;: &quot;arn:aws:iam::743263909644:policy/AmazonEKSClusterAutoscalerPolicy&quot;, &quot;Path&quot;: &quot;/&quot;, &quot;DefaultVersionId&quot;: &quot;v1&quot;, &quot;AttachmentCount&quot;: 0, &quot;PermissionsBoundaryUsageCount&quot;: 0, &quot;IsAttachable&quot;: true, &quot;CreateDate&quot;: &quot;2023-07-18T09:31:24+00:00&quot;, &quot;UpdateDate&quot;: &quot;2023-07-18T09:31:24+00:00&quot; &#125;&#125; 创建IAM Role的信任关系：trust-policy.json 123456789101112131415161718&#123; &quot;Version&quot;: &quot;2012-10-17&quot;, &quot;Statement&quot;: [ &#123; &quot;Effect&quot;: &quot;Allow&quot;, &quot;Principal&quot;: &#123; &quot;Federated&quot;: &quot;arn:aws:iam::743263909644:oidc-provider/oidc.eks.us-west-2.amazonaws.com/id/1029FF88CB872B6B7A1CC65D44191A56&quot; &#125;, &quot;Action&quot;: &quot;sts:AssumeRoleWithWebIdentity&quot;, &quot;Condition&quot;: &#123; &quot;StringEquals&quot;: &#123; &quot;oidc.eks.us-west-2.amazonaws.com/id/1029FF88CB872B6B7A1CC65D44191A56:aud&quot;: &quot;sts.amazonaws.com&quot;, &quot;oidc.eks.us-west-2.amazonaws.com/id/1029FF88CB872B6B7A1CC65D44191A56:sub&quot;: &quot;system:serviceaccount:kube-system:cluster-autoscaler&quot; &#125; &#125; &#125; ]&#125; 创建 IAM Role 123456789101112131415161718192021222324252627282930$ aws iam create-role \\ --role-name AmazonEKSClusterAutoscalerRole \\ --assume-role-policy-document file://&quot;trust-policy.json&quot;&#123; &quot;Role&quot;: &#123; &quot;Path&quot;: &quot;/&quot;, &quot;RoleName&quot;: &quot;AmazonEKSClusterAutoscalerRole&quot;, &quot;RoleId&quot;: &quot;AROA22DP3G4GHSSPEOMUH&quot;, &quot;Arn&quot;: &quot;arn:aws:iam::743263909644:role/AmazonEKSClusterAutoscalerRole&quot;, &quot;CreateDate&quot;: &quot;2023-07-18T09:39:54+00:00&quot;, &quot;AssumeRolePolicyDocument&quot;: &#123; &quot;Version&quot;: &quot;2012-10-17&quot;, &quot;Statement&quot;: [ &#123; &quot;Effect&quot;: &quot;Allow&quot;, &quot;Principal&quot;: &#123; &quot;Federated&quot;: &quot;arn:aws:iam::743263909644:oidc-provider/oidc.eks.us-west-2.amazonaws.com/id/1029FF88CB872B6B7A1CC65D44191A56&quot; &#125;, &quot;Action&quot;: &quot;sts:AssumeRoleWithWebIdentity&quot;, &quot;Condition&quot;: &#123; &quot;StringEquals&quot;: &#123; &quot;oidc.eks.us-west-2.amazonaws.com/id/1029FF88CB872B6B7A1CC65D44191A56:aud&quot;: &quot;sts.amazonaws.com&quot;, &quot;oidc.eks.us-west-2.amazonaws.com/id/1029FF88CB872B6B7A1CC65D44191A56:sub&quot;: &quot;system:serviceaccount:kube-system:cluster-autoscaler&quot; &#125; &#125; &#125; ] &#125; &#125;&#125; 为 Role 添加 Policy 123$ aws iam attach-role-policy \\ --policy-arn arn:aws:iam::743263909644:policy/AmazonEKSClusterAutoscalerPolicy \\ --role-name AmazonEKSClusterAutoscalerRole 部署Cluster Autoscaler 下载Autoscaler yaml文件 12345#下载yaml文件，github仓库中的文件下载路径格式为：https://raw.githubusercontent.com/&lt;Owner&gt;/&lt;RepositoryName&gt;/&lt;branch&gt;/&lt;FilePath&gt;$ wget https://raw.githubusercontent.com/kubernetes/autoscaler/master/cluster-autoscaler/cloudprovider/aws/examples/cluster-autoscaler-autodiscover.yaml# 获取使用git命令，这里只clone出指定文件$ git clone --depth 1 https://github.com/kubernetes/autoscaler --branch master --single-branch cluster-autoscaler/cloudprovider/aws/examples/cluster-autoscaler-autodiscover.yaml 修改yaml文件配置 打开Cluster Autoscaler的github地址，查看与EKS版本匹配的最新Autoscaler镜像版本 1.把cluster-autoscaler的镜像版本换成上面查到的版本1.26.3 2.查找并替换“”为我们EKS的名称: eks-lexing 3.在EKS的名称“tsEKS”下面，并添加以下两行 12- --balance-similar-node-groups- --skip-nodes-with-system-pods=false --balance-similar-node-groups：此选项用于启用集群节点组的负载均衡功能。当你有多个具有相似容量的节点组时，启用此选项可以确保 Cluster Autoscaler 尽可能均衡地在这些节点组之间分配 Pod。它帮助确保节点组的资源利用率更加平衡，以提高集群的整体性能。 --skip-nodes-with-system-pods=false：此选项用于设置是否跳过具有系统 Pod 的节点。默认情况下，Cluster Autoscaler 会跳过具有系统 Pod（如 kube-system 命名空间中的核心组件）的节点，以确保这些关键组件的正常运行。将该选项设置为 false，即禁用跳过具有系统 Pod 的节点，可以让 Cluster Autoscaler 考虑包括具有系统 Pod 的节点在内的所有节点进行调整。 4.为ServiceAccount添加IMA Role注解，注意一定要添加这个注解后再进行部署，否则会提示没有权限 部署Cluster Autoscaler 1234567$ kubectl apply -f cluster-autoscaler-autodiscover.yamlserviceaccount/cluster-autoscaler createdclusterrole.rbac.authorization.k8s.io/cluster-autoscaler createdrole.rbac.authorization.k8s.io/cluster-autoscaler createdclusterrolebinding.rbac.authorization.k8s.io/cluster-autoscaler createdrolebinding.rbac.authorization.k8s.io/cluster-autoscaler createddeployment.apps/cluster-autoscaler created 查看Cluster Autoscaler Deployment 123456789# cluster-autoscaler$ k get deployNAME READY UP-TO-DATE AVAILABLE AGEaws-load-balancer-controller 2/2 2 2 14dcluster-autoscaler 1/1 1 1 9m10scoredns 2/2 2 2 20debs-csi-controller 2/2 2 2 20defs-csi-controller 2/2 2 2 15dmetrics-server 1/1 1 1 20d 给autoscaler deployment打patch，增加annotation 123456# 这个注解的作用是告诉 Kubernetes 系统不要将这些 Pod 标记为可以被安全驱逐（evict）的 Pod。# 通过将 cluster-autoscaler 部署的 Pod 标记为不可安全驱逐，可以避免 Cluster Autoscaler 将这些关键组件的 Pod 视为可以被删除的对象。$ kubectl patch deployment cluster-autoscaler \\ -n kube-system \\ -p &#x27;&#123;&quot;spec&quot;:&#123;&quot;template&quot;:&#123;&quot;metadata&quot;:&#123;&quot;annotations&quot;:&#123;&quot;cluster-autoscaler.kubernetes.io/safe-to-evict&quot;: &quot;false&quot;&#125;&#125;&#125;&#125;&#125;&#x27;deployment.apps/cluster-autoscaler patched 测试 查看当前node节点 1234$ k get nodeNAME STATUS ROLES AGE VERSIONip-192-168-16-155.us-west-2.compute.internal Ready &lt;none&gt; 18d v1.26.4-eks-0a21954ip-192-168-48-14.us-west-2.compute.internal Ready &lt;none&gt; 18d v1.26.4-eks-0a21954 创建测试用的deployment：testDeploy.yaml 12345678910111213141516171819202122apiVersion: apps/v1kind: Deploymentmetadata: name: nginx-deployment namespace: test labels: app: nginxspec: replicas: 1 selector: matchLabels: app: nginx template: metadata: labels: app: nginx spec: containers: - name: nginx image: nginx:1.20.2 ports: - containerPort: 80 123456$ k apply -f testDeploy.yamldeployment.apps/nginx-deployment created# 扩容# 因为我这里的节点实例类型为 m5.large，所以replicas要设置的大一些k scale deploy nginx-deployment --replicas 50 -n test 过一会查看node情况 1234567891011121314151617181920212223242526# 可以看到新创建了一个node节点$ k get nodeNAME STATUS ROLES AGE VERSIONip-192-168-16-155.us-west-2.compute.internal Ready &lt;none&gt; 18d v1.26.4-eks-0a21954ip-192-168-48-14.us-west-2.compute.internal Ready &lt;none&gt; 18d v1.26.4-eks-0a21954ip-192-168-86-167.us-west-2.compute.internal Ready &lt;none&gt; 68s v1.26.4-eks-0a21954# pod也都正常运行$ k get pod -n testNAME READY STATUS RESTARTS AGEnginx-deployment-7876b754ff-2nd5k 1/1 Running 0 111snginx-deployment-7876b754ff-2ppvw 1/1 Running 0 111snginx-deployment-7876b754ff-45csw 1/1 Running 0 110snginx-deployment-7876b754ff-46tmf 1/1 Running 0 111snginx-deployment-7876b754ff-5vt8p 1/1 Running 0 110snginx-deployment-7876b754ff-66ztw 1/1 Running 0 111snginx-deployment-7876b754ff-77f4d 1/1 Running 0 110snginx-deployment-7876b754ff-8jj92 1/1 Running 0 111snginx-deployment-7876b754ff-8kj97 1/1 Running 0 111snginx-deployment-7876b754ff-9c8kr 1/1 Running 0 111snginx-deployment-7876b754ff-9szmq 1/1 Running 0 111snginx-deployment-7876b754ff-blbqd 1/1 Running 0 111snginx-deployment-7876b754ff-bpppd 1/1 Running 0 111snginx-deployment-7876b754ff-c46sb 1/1 Running 0 111snginx-deployment-7876b754ff-d5b45 1/1 Running 0 111s……………………………… 缩容deploy 123456# 将副本降为1$ k scale deploy nginx-deployment --replicas 1 -n test# 测试完成可以删除$ k delete -f testDeploy.yamldeployment.apps &quot;nginx-deployment&quot; deleted 大约过10几分钟就可以看到新增的node已经下线 1234$ k get nodeNAME STATUS ROLES AGE VERSIONip-192-168-16-155.us-west-2.compute.internal Ready &lt;none&gt; 18d v1.26.4-eks-0a21954ip-192-168-48-14.us-west-2.compute.internal Ready &lt;none&gt; 18d v1.26.4-eks-0a21954 升级Cluster Autoscaler Cluster Autoscaler的镜像版本要求与K8s版本匹配，所以当EKS(K8s)升级时，Cluster Autoscaler的镜像也要进行升级。 12345$ kubectl set image deployment cluster-autoscaler \\ -n kube-system \\ cluster-autoscaler=registry.k8s.io/autoscaling/cluster-autoscaler:v&lt;x.x.x&gt;# 或者直接编辑也是可以的$ k edit deploy -n kube-system cluster-autoscaler 关闭Cluster Autoscaler 1234567891011$ k scale deploy cluster-autoscaler -n kube-system --replicas 0deployment.apps/cluster-autoscaler scaled$ k get deployNAME READY UP-TO-DATE AVAILABLE AGEaws-load-balancer-controller 2/2 2 2 14dcluster-autoscaler 0/0 0 0 20hcoredns 2/2 2 2 21debs-csi-controller 2/2 2 2 20defs-csi-controller 2/2 2 2 15dmetrics-server 1/1 1 1 21d","summary":"摘要 本文介绍EKS集群Autoscaling 之 Cluster Autoscaler(CAS) 参考资料： Amazon EKS用户指南 Kubernetes 文档","date_published":"2023-07-18T12:30:05.000Z","tags":["技术","aws","eks","java"]},{"id":"https://blog.hanqunfeng.com/2023/07/17/aws-eks17-hpa/","url":"https://blog.hanqunfeng.com/2023/07/17/aws-eks17-hpa/","title":"AWS-EKS-17--Horizontal Pod Autoscaler（HPA）","content_html":"<!--\n **加粗**\n *斜体*\n ***加粗并斜体***\n ~~删除线~~\n ==突出显示==\n `突出显示(推荐)`\n ++下划线++\n ~下标~\n ^上标^\n 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.\n 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600)\n\n +++ **点击折叠**\n 这是被隐藏的内容\n +++\n\n::: tips success warning danger\n这里是容器内的内容\n:::\n\n% note info % success warning danger\n这里是容器内的内容\n% endnote %\n\n -->\n<h2 id=\"摘要\">摘要</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>本文介绍在EKS集群下创建HPA的方法</p>\n</li>\n<li class=\"lvl-2\">\n<p>参考资料：</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\"><a href=\"https://docs.aws.amazon.com/zh_cn/eks/latest/userguide\">Amazon EKS用户指南</a></li>\n<li class=\"lvl-6\"><a href=\"https://kubernetes.io/zh-cn/docs/home/\">Kubernetes 文档</a></li>\n</ul>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"Horizontal-Pod-Autoscaler-简介\">Horizontal Pod Autoscaler 简介</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Horizontal Pod Autoscaler（HPA）基于资源 CPU 利用率自动调整 deployment、replication controller 或者 replica 中 pod 的数量，这有助于您的应用程序进行扩展以满足增长的需求，或在不需要资源时进行缩减，从而释放出节点用于其他应用程序。当您设置目标 CPU 利用率百分比时，HPA 扩展或缩减应用程序来尝试满足该目标。</p>\n</li>\n<li class=\"lvl-2\">\n<p>Kubernetes 本身已经包含了 HPA 的 controller，所以不需要额外的安装或部署。</p>\n</li>\n<li class=\"lvl-2\">\n<p>HPA 需要获取 metrics 信息，metrics 信息需要从 Metrics Server 中获取或者从第三方软件获取，关于如何在EKS中安装Metrics Server可以查看 <a href=\"/2023/07/07/aws-eks11-metrics/\" title=\"AWS-EKS-11--安装 Kubernetes Metrics Server\">AWS-EKS-11--安装 Kubernetes Metrics Server</a>。</p>\n</li>\n<li class=\"lvl-2\">\n<p>HPA 会周期性(默认15秒)查询目标资源的使用情况，然后和 HPA 中定义的值做比较，并根据比较结果相应的调整 pod 数量。</p>\n</li>\n<li class=\"lvl-2\">\n<p>创建pod时，必须为其设定cpu资源，用于与目标值进行比较，目前v2版本的HPA除了支持CPU的对比，还可以设定其它指标，具体参考<a href=\"https://kubernetes.io/zh-cn/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/\">HorizontalPodAutoscaler 演练</a>。</p>\n</li>\n</ul>\n<h2 id=\"示例\">示例</h2>\n<p>参考<a href=\"https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/horizontal-pod-autoscaler.html\">官方示例</a></p>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>定义资源yaml</p>\n</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># php-apache.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">php-apache</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">run:</span> <span class=\"string\">php-apache</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">run:</span> <span class=\"string\">php-apache</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">php-apache</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">registry.k8s.io/hpa-example</span></span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">80</span></span><br><span class=\"line\">        <span class=\"attr\">resources:</span></span><br><span class=\"line\">          <span class=\"attr\">limits:</span></span><br><span class=\"line\">            <span class=\"attr\">cpu:</span> <span class=\"string\">500m</span>   <span class=\"comment\"># 最多可使用资源，500m（0.5 个 CPU）</span></span><br><span class=\"line\">          <span class=\"attr\">requests:</span></span><br><span class=\"line\">            <span class=\"attr\">cpu:</span> <span class=\"string\">200m</span>   <span class=\"comment\"># 期望使用资源（desiredMetricValue），200m（0.2 个 CPU）</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">php-apache</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">run:</span> <span class=\"string\">php-apache</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">port:</span> <span class=\"number\">80</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">run:</span> <span class=\"string\">php-apache</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>部署yaml</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ k apply -f php-apache.yaml</span><br><span class=\"line\">deployment.apps/php-apache created</span><br><span class=\"line\">service/php-apache created</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>创建HPA</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 创建了一个叫“php-apache”的 HPA，与 deployment 的名称相同，可以用 --name=&#x27;hpa-name&#x27; 指定hpa的名称</span></span><br><span class=\"line\"><span class=\"comment\"># replicas 变动范围是最小 1，最大 10</span></span><br><span class=\"line\"><span class=\"comment\"># 目标cpu利用率为 50%，上面我们设定 CPU request 值为 200m，所以当平均cpu值为 100m 时就会触发 autoscale</span></span><br><span class=\"line\"><span class=\"comment\"># 这里说平均cpu，是指所有pod的cpu利用率的平均值</span></span><br><span class=\"line\">$ k autoscale deployment php-apache --cpu-percent=50 --min=1 --max=10</span><br><span class=\"line\">horizontalpodautoscaler.autoscaling/php-apache autoscaled</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 也可以通过yaml创建</span></span><br><span class=\"line\">apiVersion: autoscaling/v2</span><br><span class=\"line\">kind: HorizontalPodAutoscaler</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: php-apache</span><br><span class=\"line\">  namespace: <span class=\"built_in\">test</span></span><br><span class=\"line\">spec:</span><br><span class=\"line\">  maxReplicas: 10</span><br><span class=\"line\">  minReplicas: 1</span><br><span class=\"line\">  metrics:</span><br><span class=\"line\">  - resource:</span><br><span class=\"line\">      name: cpu</span><br><span class=\"line\">      target:</span><br><span class=\"line\">        averageUtilization: 50</span><br><span class=\"line\">        <span class=\"built_in\">type</span>: Utilization</span><br><span class=\"line\">    <span class=\"built_in\">type</span>: Resource</span><br><span class=\"line\">  scaleTargetRef:</span><br><span class=\"line\">    apiVersion: apps/v1</span><br><span class=\"line\">    kind: Deployment</span><br><span class=\"line\">    name: php-apache</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>查看HPA</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ k get hpa</span><br><span class=\"line\">NAME         REFERENCE               TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class=\"line\">php-apache   Deployment/php-apache   0%/50%    1         10        1          29s</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>测试HPA</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 通过运行容器为 Web 服务器创建负载</span></span><br><span class=\"line\"><span class=\"comment\"># 这里利用 busybox 镜像临时生成一个 pod，用 while 循环不停的访问 php-apache 的 service，而 php-apache 中的 hpa-example 镜像已经配置了进行消耗 CPU 的计算网页，所以 php-apache pod 的 CPU 负载会很快增长</span></span><br><span class=\"line\"><span class=\"comment\"># 该命令会一直运行，直到 Ctrl+C</span></span><br><span class=\"line\">$ kubectl run -i \\</span><br><span class=\"line\">    --<span class=\"built_in\">tty</span> load-generator \\</span><br><span class=\"line\">    --<span class=\"built_in\">rm</span> --image=busybox \\</span><br><span class=\"line\">    --restart=Never \\</span><br><span class=\"line\">    -- /bin/sh -c <span class=\"string\">&quot;while sleep 0.01; do wget -q -O- http://php-apache; done&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 上面的命令运行一会后再开一个终端查看hpa的情况，可以看到已经发生扩容了</span></span><br><span class=\"line\">$ k get hpa</span><br><span class=\"line\">NAME         REFERENCE               TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class=\"line\">php-apache   Deployment/php-apache   57%/50%   1         10        7          5m27s</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 运行一段时间后发现hpa稳定在8个，说明此时pod的数量已经满足平均cpu使用率小于50%的目标</span></span><br><span class=\"line\">$ k get hpa</span><br><span class=\"line\">NAME         REFERENCE               TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class=\"line\">php-apache   Deployment/php-apache   43%/50%   1         10        8          20m</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看pod的cpu使用情况，虽然此时也有个别的pod大于100m，但是8个pod的平均cpu是小于100m的，此时就不会再进行扩容了</span></span><br><span class=\"line\">$ k top pod</span><br><span class=\"line\">NAME                                     CPU(cores)   MEMORY(bytes)</span><br><span class=\"line\">php-apache-7495ff8f5b-2kjsc              98m          11Mi</span><br><span class=\"line\">php-apache-7495ff8f5b-49vb9              85m          11Mi</span><br><span class=\"line\">php-apache-7495ff8f5b-65r62              100m         11Mi</span><br><span class=\"line\">php-apache-7495ff8f5b-7mn9l              79m          11Mi</span><br><span class=\"line\">php-apache-7495ff8f5b-7njtt              74m          11Mi</span><br><span class=\"line\">php-apache-7495ff8f5b-8n5t6              88m          11Mi</span><br><span class=\"line\">php-apache-7495ff8f5b-spvnh              103m         11Mi</span><br><span class=\"line\">php-apache-7495ff8f5b-w64f4              101m         11Mi</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>此时<code>Ctrl+C</code>中断测试容器，过一会查看hpa和pod的情况，可以看到平均 CPU 负载已经降到 0 了，但 REPLICAS 还是 8 个，不会立即降低，不要着急，大约5分钟左右 REPLICAS 最终变为 1</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ k get hpa</span><br><span class=\"line\">NAME         REFERENCE               TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class=\"line\">php-apache   Deployment/php-apache   0%/50%    1         10        8          26m</span><br><span class=\"line\">$ k top pod</span><br><span class=\"line\">NAME                                     CPU(cores)   MEMORY(bytes)</span><br><span class=\"line\">php-apache-7495ff8f5b-2kjsc              1m           11Mi</span><br><span class=\"line\">php-apache-7495ff8f5b-49vb9              1m           11Mi</span><br><span class=\"line\">php-apache-7495ff8f5b-65r62              1m           11Mi</span><br><span class=\"line\">php-apache-7495ff8f5b-7mn9l              1m           11Mi</span><br><span class=\"line\">php-apache-7495ff8f5b-7njtt              1m           11Mi</span><br><span class=\"line\">php-apache-7495ff8f5b-8n5t6              1m           11Mi</span><br><span class=\"line\">php-apache-7495ff8f5b-spvnh              1m           11Mi</span><br><span class=\"line\">php-apache-7495ff8f5b-w64f4              1m           11Mi</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 可以看到hpa的 AGE 在26m时还是8个，30m时就降为1个了</span></span><br><span class=\"line\">$ k get hpa</span><br><span class=\"line\">NAME         REFERENCE               TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class=\"line\">php-apache   Deployment/php-apache   0%/50%    1         10        1          30m</span><br></pre></td></tr></table></figure>\n<h2 id=\"删除HPA\">删除HPA</h2>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ k delete hpa php-apache</span><br><span class=\"line\">horizontalpodautoscaler.autoscaling <span class=\"string\">&quot;php-apache&quot;</span> deleted</span><br></pre></td></tr></table></figure>\n","content_text":"摘要 本文介绍在EKS集群下创建HPA的方法 参考资料： Amazon EKS用户指南 Kubernetes 文档 Horizontal Pod Autoscaler 简介 Horizontal Pod Autoscaler（HPA）基于资源 CPU 利用率自动调整 deployment、replication controller 或者 replica 中 pod 的数量，这有助于您的应用程序进行扩展以满足增长的需求，或在不需要资源时进行缩减，从而释放出节点用于其他应用程序。当您设置目标 CPU 利用率百分比时，HPA 扩展或缩减应用程序来尝试满足该目标。 Kubernetes 本身已经包含了 HPA 的 controller，所以不需要额外的安装或部署。 HPA 需要获取 metrics 信息，metrics 信息需要从 Metrics Server 中获取或者从第三方软件获取，关于如何在EKS中安装Metrics Server可以查看 AWS-EKS-11--安装 Kubernetes Metrics Server。 HPA 会周期性(默认15秒)查询目标资源的使用情况，然后和 HPA 中定义的值做比较，并根据比较结果相应的调整 pod 数量。 创建pod时，必须为其设定cpu资源，用于与目标值进行比较，目前v2版本的HPA除了支持CPU的对比，还可以设定其它指标，具体参考HorizontalPodAutoscaler 演练。 示例 参考官方示例 定义资源yaml 123456789101112131415161718192021222324252627282930313233343536# php-apache.yamlapiVersion: apps/v1kind: Deploymentmetadata: name: php-apachespec: selector: matchLabels: run: php-apache template: metadata: labels: run: php-apache spec: containers: - name: php-apache image: registry.k8s.io/hpa-example ports: - containerPort: 80 resources: limits: cpu: 500m # 最多可使用资源，500m（0.5 个 CPU） requests: cpu: 200m # 期望使用资源（desiredMetricValue），200m（0.2 个 CPU）---apiVersion: v1kind: Servicemetadata: name: php-apache labels: run: php-apachespec: ports: - port: 80 selector: run: php-apache 部署yaml 123$ k apply -f php-apache.yamldeployment.apps/php-apache createdservice/php-apache created 创建HPA 123456789101112131415161718192021222324252627# 创建了一个叫“php-apache”的 HPA，与 deployment 的名称相同，可以用 --name=&#x27;hpa-name&#x27; 指定hpa的名称# replicas 变动范围是最小 1，最大 10# 目标cpu利用率为 50%，上面我们设定 CPU request 值为 200m，所以当平均cpu值为 100m 时就会触发 autoscale# 这里说平均cpu，是指所有pod的cpu利用率的平均值$ k autoscale deployment php-apache --cpu-percent=50 --min=1 --max=10horizontalpodautoscaler.autoscaling/php-apache autoscaled# 也可以通过yaml创建apiVersion: autoscaling/v2kind: HorizontalPodAutoscalermetadata: name: php-apache namespace: testspec: maxReplicas: 10 minReplicas: 1 metrics: - resource: name: cpu target: averageUtilization: 50 type: Utilization type: Resource scaleTargetRef: apiVersion: apps/v1 kind: Deployment name: php-apache 查看HPA 123$ k get hpaNAME REFERENCE TARGETS MINPODS MAXPODS REPLICAS AGEphp-apache Deployment/php-apache 0%/50% 1 10 1 29s 测试HPA 12345678910111213141516171819202122232425262728293031# 通过运行容器为 Web 服务器创建负载# 这里利用 busybox 镜像临时生成一个 pod，用 while 循环不停的访问 php-apache 的 service，而 php-apache 中的 hpa-example 镜像已经配置了进行消耗 CPU 的计算网页，所以 php-apache pod 的 CPU 负载会很快增长# 该命令会一直运行，直到 Ctrl+C$ kubectl run -i \\ --tty load-generator \\ --rm --image=busybox \\ --restart=Never \\ -- /bin/sh -c &quot;while sleep 0.01; do wget -q -O- http://php-apache; done&quot;# 上面的命令运行一会后再开一个终端查看hpa的情况，可以看到已经发生扩容了$ k get hpaNAME REFERENCE TARGETS MINPODS MAXPODS REPLICAS AGEphp-apache Deployment/php-apache 57%/50% 1 10 7 5m27s# 运行一段时间后发现hpa稳定在8个，说明此时pod的数量已经满足平均cpu使用率小于50%的目标$ k get hpaNAME REFERENCE TARGETS MINPODS MAXPODS REPLICAS AGEphp-apache Deployment/php-apache 43%/50% 1 10 8 20m# 查看pod的cpu使用情况，虽然此时也有个别的pod大于100m，但是8个pod的平均cpu是小于100m的，此时就不会再进行扩容了$ k top podNAME CPU(cores) MEMORY(bytes)php-apache-7495ff8f5b-2kjsc 98m 11Miphp-apache-7495ff8f5b-49vb9 85m 11Miphp-apache-7495ff8f5b-65r62 100m 11Miphp-apache-7495ff8f5b-7mn9l 79m 11Miphp-apache-7495ff8f5b-7njtt 74m 11Miphp-apache-7495ff8f5b-8n5t6 88m 11Miphp-apache-7495ff8f5b-spvnh 103m 11Miphp-apache-7495ff8f5b-w64f4 101m 11Mi 此时Ctrl+C中断测试容器，过一会查看hpa和pod的情况，可以看到平均 CPU 负载已经降到 0 了，但 REPLICAS 还是 8 个，不会立即降低，不要着急，大约5分钟左右 REPLICAS 最终变为 1 123456789101112131415161718$ k get hpaNAME REFERENCE TARGETS MINPODS MAXPODS REPLICAS AGEphp-apache Deployment/php-apache 0%/50% 1 10 8 26m$ k top podNAME CPU(cores) MEMORY(bytes)php-apache-7495ff8f5b-2kjsc 1m 11Miphp-apache-7495ff8f5b-49vb9 1m 11Miphp-apache-7495ff8f5b-65r62 1m 11Miphp-apache-7495ff8f5b-7mn9l 1m 11Miphp-apache-7495ff8f5b-7njtt 1m 11Miphp-apache-7495ff8f5b-8n5t6 1m 11Miphp-apache-7495ff8f5b-spvnh 1m 11Miphp-apache-7495ff8f5b-w64f4 1m 11Mi# 可以看到hpa的 AGE 在26m时还是8个，30m时就降为1个了$ k get hpaNAME REFERENCE TARGETS MINPODS MAXPODS REPLICAS AGEphp-apache Deployment/php-apache 0%/50% 1 10 1 30m 删除HPA 12$ k delete hpa php-apachehorizontalpodautoscaler.autoscaling &quot;php-apache&quot; deleted","summary":"摘要 本文介绍在EKS集群下创建HPA的方法 参考资料： Amazon EKS用户指南 Kubernetes 文档","date_published":"2023-07-17T12:30:05.000Z","tags":["技术","aws","eks","java"]},{"id":"https://blog.hanqunfeng.com/2023/07/14/aws-eks16-servcieaccount/","url":"https://blog.hanqunfeng.com/2023/07/14/aws-eks16-servcieaccount/","title":"AWS-EKS-16--聊一聊ServiceAccount","content_html":"<!--\n **加粗**\n *斜体*\n ***加粗并斜体***\n ~~删除线~~\n ==突出显示==\n `突出显示(推荐)`\n ++下划线++\n ~下标~\n ^上标^\n 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.\n 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600)\n\n +++ **点击折叠**\n 这是被隐藏的内容\n +++\n\n::: tips success warning danger\n这里是容器内的内容\n:::\n\n% note info % success warning danger\n这里是容器内的内容\n% endnote %\n\n -->\n<h2 id=\"摘要\">摘要</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>本文聊一聊ServiceAccount</p>\n</li>\n<li class=\"lvl-2\">\n<p>参考资料：</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\"><a href=\"https://docs.aws.amazon.com/zh_cn/eks/latest/userguide\">Amazon EKS用户指南</a></li>\n<li class=\"lvl-6\"><a href=\"https://kubernetes.io/zh-cn/docs/home/\">Kubernetes 文档</a></li>\n</ul>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"聊一聊ServiceAccount\">聊一聊ServiceAccount</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>网上关于ServiceAccount的介绍有很多，但大多都比较晦涩难懂，不好理解，这里我基于自己的理解聊一聊ServiceAccount。</p>\n</li>\n<li class=\"lvl-2\">\n<p>ServiceAccount是k8s中的用户，其被定义在namespace下，可以被关联到pod上，使其获得相应的权限。</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">ServiceAccount可以与k8s中的Role或者ClusterRole进行绑定，以使其具有访问k8s内部资源的权限，当pod关联ServiceAccount后也就获得了相应的权限。参考<a href=\"/2023/07/07/aws-eks12-dashboard/\" title=\"AWS-EKS-12--部署 Dashboard UI\">AWS-EKS-12--部署 Dashboard UI</a></li>\n</ul>\n  <figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># dashboard-adminuser.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">admin-user</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">kubernetes-dashboard</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ClusterRoleBinding</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">admin-user</span></span><br><span class=\"line\"><span class=\"attr\">roleRef:</span></span><br><span class=\"line\">  <span class=\"attr\">apiGroup:</span> <span class=\"string\">rbac.authorization.k8s.io</span></span><br><span class=\"line\">  <span class=\"attr\">kind:</span> <span class=\"string\">ClusterRole</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">cluster-admin</span></span><br><span class=\"line\"><span class=\"attr\">subjects:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">admin-user</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">kubernetes-dashboard</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">ServiceAccount也可以被关联到IAM Role，以使其具有访问AWS资源的权限。当pod关联ServiceAccount后就获得了访问AWS资源的权限。参考<a href=\"/2023/07/13/aws-eks15-auth-pod/\" title=\"AWS-EKS-15--EKS权限管理(下)Pod 是如何调用 AWS 资源的\">AWS-EKS-15--EKS权限管理(下)Pod 是如何调用 AWS 资源的</a></li>\n</ul>\n  <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ eksctl create iamserviceaccount \\</span><br><span class=\"line\">--cluster=eks-lexing \\</span><br><span class=\"line\">--profile eks-us-west-2 \\</span><br><span class=\"line\">--namespace=kube-system \\</span><br><span class=\"line\">--name=aws-load-balancer-controller \\</span><br><span class=\"line\">--role-name AmazonEKSLoadBalancerControllerRole \\</span><br><span class=\"line\">--attach-policy-arn=arn:aws:iam::743263909644:policy/AWSLoadBalancerControllerIAMPolicy \\</span><br><span class=\"line\">--approve</span><br></pre></td></tr></table></figure>\n</li>\n<li class=\"lvl-2\">\n<p>ServiceAccount default 在 Kubernetes 中是默认存在的，它通常与运行在 Pod 内的应用程序关联，用于与 Kubernetes API 服务器进行身份验证和授权。default ServiceAccount 是每个命名空间中的默认 ServiceAccount，如果没有为 Pod 显式指定 ServiceAccount，则会自动关联到 default ServiceAccount。</p>\n</li>\n<li class=\"lvl-2\">\n<p>default ServiceAccount的权限是由所分配的角色（Role）或集群角色（ClusterRole）定义的。在默认情况下，default ServiceAccount没有任何特权或访问权限。它只能访问其所在命名空间的一些基本资源，例如查看自身的 Pod、Service、Endpoints 等。</p>\n</li>\n</ul>\n<h3 id=\"创建SA\">创建SA</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 方式1，使用kubectl命令行直接创建</span></span><br><span class=\"line\">$ kubectl create serviceaccount &lt;serviceaccount-name&gt; -n &lt;namespace&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 方式2，基于yaml</span></span><br><span class=\"line\"><span class=\"comment\"># sa.yaml</span></span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: ServiceAccount</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: &lt;serviceaccount-name&gt;</span><br><span class=\"line\">  namespace: &lt;namespace&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">$ kubectl apply -f sa.yaml</span><br></pre></td></tr></table></figure>\n<h3 id=\"查询SA\">查询SA</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ k get sa -n kubernetes-dashboard</span><br><span class=\"line\">NAME                   SECRETS   AGE</span><br><span class=\"line\">admin-user             0         8d</span><br><span class=\"line\">default                0         8d</span><br><span class=\"line\">kubernetes-dashboard   0         8d</span><br></pre></td></tr></table></figure>\n<h3 id=\"SA与Role或者ClusterRole进行绑定\">SA与Role或者ClusterRole进行绑定</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>SA绑定Role</p>\n</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">my-service-account</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">test</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Role</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">my-role</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">test</span>                                <span class=\"comment\"># 与ClusterRole的区别就是Role要绑定到Namespace</span></span><br><span class=\"line\"><span class=\"attr\">rules:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;&quot;</span>]                                <span class=\"comment\"># 限定API组，为空则为默认的 core API 组</span></span><br><span class=\"line\">  <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;pods&quot;</span>, <span class=\"string\">&quot;services&quot;</span>, <span class=\"string\">&quot;configmaps&quot;</span>]  <span class=\"comment\"># 要访问的资源</span></span><br><span class=\"line\">  <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;get&quot;</span>, <span class=\"string\">&quot;list&quot;</span>, <span class=\"string\">&quot;watch&quot;</span>]                <span class=\"comment\"># 开放的权限</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">RoleBinding</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">my-role-binding</span></span><br><span class=\"line\"><span class=\"attr\">subjects:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">my-service-account</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">test</span></span><br><span class=\"line\"><span class=\"attr\">roleRef:</span></span><br><span class=\"line\">  <span class=\"attr\">kind:</span> <span class=\"string\">Role</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">my-role</span></span><br><span class=\"line\">  <span class=\"attr\">apiGroup:</span> <span class=\"string\">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>SA绑定ClusterRole</p>\n</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">my-service-account</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">test</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ClusterRole</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">my-cluster-role</span></span><br><span class=\"line\"><span class=\"attr\">rules:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;&quot;</span>]</span><br><span class=\"line\">  <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;pods&quot;</span>, <span class=\"string\">&quot;services&quot;</span>, <span class=\"string\">&quot;configmaps&quot;</span>]</span><br><span class=\"line\">  <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;get&quot;</span>, <span class=\"string\">&quot;list&quot;</span>, <span class=\"string\">&quot;watch&quot;</span>]</span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ClusterRoleBinding</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">my-cluster-role-binding</span></span><br><span class=\"line\"><span class=\"attr\">subjects:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">my-service-account</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">test</span></span><br><span class=\"line\"><span class=\"attr\">roleRef:</span></span><br><span class=\"line\">  <span class=\"attr\">kind:</span> <span class=\"string\">ClusterRole</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">my-cluster-role</span></span><br><span class=\"line\">  <span class=\"attr\">apiGroup:</span> <span class=\"string\">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure>\n<div class=\"tips\">\n<p><em><strong>API组</strong></em><br>\nKubernetes中有许多常见的API组，每个API组都包含一组相关的资源。以下是一些常见的API组：</p>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\"><code>core</code>：该API组是Kubernetes中的默认API组，包含核心资源，如pods、services、configmaps、secrets等。</li>\n<li class=\"lvl-2\"><code>apps</code>：该API组包含应用程序相关的资源，如deployments、replicasets、daemonsets、statefulsets等。</li>\n<li class=\"lvl-2\"><code>batch</code>：该API组包含批处理作业相关的资源，如jobs、cronjobs等。</li>\n<li class=\"lvl-2\"><code>extensions</code>：这是Kubernetes早期版本中广泛使用的API组，现在已经被<code>apps</code>和<code>networking.k8s.io</code> API组所取代。它包含一些资源，如replicationcontrollers、ingresses等。</li>\n<li class=\"lvl-2\"><code>networking.k8s.io</code>：该API组包含与网络相关的资源，如ingresses、networkpolicies等。</li>\n<li class=\"lvl-2\"><code>storage.k8s.io</code>：该API组包含存储相关的资源，如storageclasses、persistentvolumes、persistentvolumeclaims等。</li>\n<li class=\"lvl-2\"><code>autoscaling</code>：该API组包含自动扩展相关的资源，如horizontalpodautoscalers。</li>\n<li class=\"lvl-2\"><code>rbac.authorization.k8s.io</code>：该API组包含与角色和访问控制相关的资源，如roles、rolebindings、clusterroles、clusterrolebindings等。<br>\n这只是一小部分常见的API组，实际上还有许多其他的API组，根据您的Kubernetes集群的版本和所使用的插件，可能会有其他自定义的API组。您可以使用<code>kubectl api-resources</code>命令查看集群中所有可用的API组和资源。</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 这里 APIVERSION 中版本中斜线前面的就是 API组名称 ,没有斜线的就是默认的 core 组</span></span><br><span class=\"line\">$ kubectl api-resources</span><br><span class=\"line\">NAME                              SHORTNAMES   APIVERSION                             NAMESPACED   KIND</span><br><span class=\"line\">bindings                                       v1                                     <span class=\"literal\">true</span>         Binding</span><br><span class=\"line\">componentstatuses                 cs           v1                                     <span class=\"literal\">false</span>        ComponentStatus</span><br><span class=\"line\">configmaps                        cm           v1                                     <span class=\"literal\">true</span>         ConfigMap</span><br><span class=\"line\">endpoints                         ep           v1                                     <span class=\"literal\">true</span>         Endpoints</span><br><span class=\"line\">events                            ev           v1                                     <span class=\"literal\">true</span>         Event</span><br><span class=\"line\">limitranges                       limits       v1                                     <span class=\"literal\">true</span>         LimitRange</span><br><span class=\"line\">namespaces                        ns           v1                                     <span class=\"literal\">false</span>        Namespace</span><br><span class=\"line\">nodes                             no           v1                                     <span class=\"literal\">false</span>        Node</span><br><span class=\"line\">persistentvolumeclaims            pvc          v1                                     <span class=\"literal\">true</span>         PersistentVolumeClaim</span><br><span class=\"line\">persistentvolumes                 pv           v1                                     <span class=\"literal\">false</span>        PersistentVolume</span><br><span class=\"line\">pods                              po           v1                                     <span class=\"literal\">true</span>         Pod</span><br><span class=\"line\">podtemplates                                   v1                                     <span class=\"literal\">true</span>         PodTemplate</span><br><span class=\"line\">replicationcontrollers            rc           v1                                     <span class=\"literal\">true</span>         ReplicationController</span><br><span class=\"line\">resourcequotas                    quota        v1                                     <span class=\"literal\">true</span>         ResourceQuota</span><br><span class=\"line\">secrets                                        v1                                     <span class=\"literal\">true</span>         Secret</span><br><span class=\"line\">serviceaccounts                   sa           v1                                     <span class=\"literal\">true</span>         ServiceAccount</span><br><span class=\"line\">services                          svc          v1                                     <span class=\"literal\">true</span>         Service</span><br><span class=\"line\">mutatingwebhookconfigurations                  admissionregistration.k8s.io/v1        <span class=\"literal\">false</span>        MutatingWebhookConfiguration</span><br><span class=\"line\">validatingwebhookconfigurations                admissionregistration.k8s.io/v1        <span class=\"literal\">false</span>        ValidatingWebhookConfiguration</span><br><span class=\"line\">customresourcedefinitions         crd,crds     apiextensions.k8s.io/v1                <span class=\"literal\">false</span>        CustomResourceDefinition</span><br><span class=\"line\">apiservices                                    apiregistration.k8s.io/v1              <span class=\"literal\">false</span>        APIService</span><br><span class=\"line\">controllerrevisions                            apps/v1                                <span class=\"literal\">true</span>         ControllerRevision</span><br><span class=\"line\">daemonsets                        ds           apps/v1                                <span class=\"literal\">true</span>         DaemonSet</span><br><span class=\"line\">deployments                       deploy       apps/v1                                <span class=\"literal\">true</span>         Deployment</span><br><span class=\"line\">replicasets                       rs           apps/v1                                <span class=\"literal\">true</span>         ReplicaSet</span><br><span class=\"line\">statefulsets                      sts          apps/v1                                <span class=\"literal\">true</span>         StatefulSet</span><br><span class=\"line\">tokenreviews                                   authentication.k8s.io/v1               <span class=\"literal\">false</span>        TokenReview</span><br><span class=\"line\">localsubjectaccessreviews                      authorization.k8s.io/v1                <span class=\"literal\">true</span>         LocalSubjectAccessReview</span><br><span class=\"line\">selfsubjectaccessreviews                       authorization.k8s.io/v1                <span class=\"literal\">false</span>        SelfSubjectAccessReview</span><br><span class=\"line\">selfsubjectrulesreviews                        authorization.k8s.io/v1                <span class=\"literal\">false</span>        SelfSubjectRulesReview</span><br><span class=\"line\">subjectaccessreviews                           authorization.k8s.io/v1                <span class=\"literal\">false</span>        SubjectAccessReview</span><br><span class=\"line\">horizontalpodautoscalers          hpa          autoscaling/v2                         <span class=\"literal\">true</span>         HorizontalPodAutoscaler</span><br><span class=\"line\">cronjobs                          cj           batch/v1                               <span class=\"literal\">true</span>         CronJob</span><br><span class=\"line\"><span class=\"built_in\">jobs</span>                                           batch/v1                               <span class=\"literal\">true</span>         Job</span><br><span class=\"line\">certificatesigningrequests        csr          certificates.k8s.io/v1                 <span class=\"literal\">false</span>        CertificateSigningRequest</span><br><span class=\"line\">leases                                         coordination.k8s.io/v1                 <span class=\"literal\">true</span>         Lease</span><br><span class=\"line\">eniconfigs                                     crd.k8s.amazonaws.com/v1alpha1         <span class=\"literal\">false</span>        ENIConfig</span><br><span class=\"line\">endpointslices                                 discovery.k8s.io/v1                    <span class=\"literal\">true</span>         EndpointSlice</span><br><span class=\"line\">ingressclassparams                             elbv2.k8s.aws/v1beta1                  <span class=\"literal\">false</span>        IngressClassParams</span><br><span class=\"line\">targetgroupbindings                            elbv2.k8s.aws/v1beta1                  <span class=\"literal\">true</span>         TargetGroupBinding</span><br><span class=\"line\">events                            ev           events.k8s.io/v1                       <span class=\"literal\">true</span>         Event</span><br><span class=\"line\">flowschemas                                    flowcontrol.apiserver.k8s.io/v1beta3   <span class=\"literal\">false</span>        FlowSchema</span><br><span class=\"line\">prioritylevelconfigurations                    flowcontrol.apiserver.k8s.io/v1beta3   <span class=\"literal\">false</span>        PriorityLevelConfiguration</span><br><span class=\"line\">nodes                                          metrics.k8s.io/v1beta1                 <span class=\"literal\">false</span>        NodeMetrics</span><br><span class=\"line\">pods                                           metrics.k8s.io/v1beta1                 <span class=\"literal\">true</span>         PodMetrics</span><br><span class=\"line\">ingressclasses                                 networking.k8s.io/v1                   <span class=\"literal\">false</span>        IngressClass</span><br><span class=\"line\">ingresses                         ing          networking.k8s.io/v1                   <span class=\"literal\">true</span>         Ingress</span><br><span class=\"line\">networkpolicies                   netpol       networking.k8s.io/v1                   <span class=\"literal\">true</span>         NetworkPolicy</span><br><span class=\"line\">runtimeclasses                                 node.k8s.io/v1                         <span class=\"literal\">false</span>        RuntimeClass</span><br><span class=\"line\">poddisruptionbudgets              pdb          policy/v1                              <span class=\"literal\">true</span>         PodDisruptionBudget</span><br><span class=\"line\">clusterrolebindings                            rbac.authorization.k8s.io/v1           <span class=\"literal\">false</span>        ClusterRoleBinding</span><br><span class=\"line\">clusterroles                                   rbac.authorization.k8s.io/v1           <span class=\"literal\">false</span>        ClusterRole</span><br><span class=\"line\">rolebindings                                   rbac.authorization.k8s.io/v1           <span class=\"literal\">true</span>         RoleBinding</span><br><span class=\"line\">roles                                          rbac.authorization.k8s.io/v1           <span class=\"literal\">true</span>         Role</span><br><span class=\"line\">priorityclasses                   pc           scheduling.k8s.io/v1                   <span class=\"literal\">false</span>        PriorityClass</span><br><span class=\"line\">csidrivers                                     storage.k8s.io/v1                      <span class=\"literal\">false</span>        CSIDriver</span><br><span class=\"line\">csinodes                                       storage.k8s.io/v1                      <span class=\"literal\">false</span>        CSINode</span><br><span class=\"line\">csistoragecapacities                           storage.k8s.io/v1                      <span class=\"literal\">true</span>         CSIStorageCapacity</span><br><span class=\"line\">storageclasses                    sc           storage.k8s.io/v1                      <span class=\"literal\">false</span>        StorageClass</span><br><span class=\"line\">volumeattachments                              storage.k8s.io/v1                      <span class=\"literal\">false</span>        VolumeAttachment</span><br><span class=\"line\">securitygrouppolicies             sgp          vpcresources.k8s.aws/v1beta1           <span class=\"literal\">true</span>         SecurityGroupPolicy</span><br></pre></td></tr></table></figure>\n</div>\n<h3 id=\"SA与Deployment或者Pod关联\">SA与Deployment或者Pod关联</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>SA与Deployment关联</p>\n</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">my-deployment</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">3</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">my-app</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">my-app</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">serviceAccountName:</span> <span class=\"string\">my-service-account</span>  <span class=\"comment\"># 指定sa名称</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">my-container</span></span><br><span class=\"line\">          <span class=\"attr\">image:</span> <span class=\"string\">my-image</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>SA与Pod关联</p>\n</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Pod</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">my-pod</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">serviceAccountName:</span> <span class=\"string\">my-service-account</span>     <span class=\"comment\"># 指定sa名称</span></span><br><span class=\"line\">  <span class=\"attr\">containers:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">my-container</span></span><br><span class=\"line\">      <span class=\"attr\">image:</span> <span class=\"string\">my-image</span></span><br></pre></td></tr></table></figure>\n<div class=\"tips\">\n<p><em><strong>小贴士</strong></em></p>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">serviceAccount 和 serviceAccountName 是 Kubernetes YAML 配置中用于关联 Service Account 的两个属性，它们有一些区别：</li>\n<li class=\"lvl-2\">serviceAccountName：这是一个字符串属性，用于指定要与 Pod 或 Deployment 关联的 Service Account 的名称。它是最常用的属性，只需提供 Service Account 的名称即可。示例：serviceAccountName: my-service-account</li>\n<li class=\"lvl-2\">serviceAccount：这是一个对象属性，用于指定要与 Pod 或 Deployment 关联的 Service Account 的更详细信息。它可以提供 Service Account 的名称和命名空间。示例：</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">serviceAccount:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">my-service-account</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">my-namespace</span></span><br></pre></td></tr></table></figure>\n<p>注意：namespace 字段是可选的，如果不指定，它将使用当前 Pod 或 Deployment 所在的命名空间。</p>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">总结来说，serviceAccountName 是一种更简洁的方式，只需提供 Service Account 的名称。而 serviceAccount 则可以提供更多关于 Service Account 的详细信息，如名称和命名空间。在大多数情况下，使用 serviceAccountName 就足够了，除非需要更精细地控制 Service Account 的属性。</li>\n</ul>\n</div>\n<h3 id=\"查询指定的SA被绑定到哪些角色\">查询指定的SA被绑定到哪些角色</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubectl get rolebindings,clusterrolebindings -A \\</span><br><span class=\"line\">-o <span class=\"string\">&#x27;custom-columns=KIND:.kind,NAMESPACE:.metadata.namespace,NAME:.metadata.name,ROLE-KIND:.roleRef.kind,ROLE:.roleRef.name, SUBJECT-KIND:.subjects[*].kind,SUBJECT-NAMESPACE:.subjects[*].namespace,SUBJECT-NAME:.subjects[*].name&#x27;</span> \\</span><br><span class=\"line\">| (<span class=\"built_in\">head</span> -n 1 &amp;&amp; awk <span class=\"string\">&#x27;&#123;if ($8 == &quot;kubernetes-dashboard&quot;) print&#125;&#x27;</span>)</span><br><span class=\"line\">KIND                 NAMESPACE              NAME                                                           ROLE-KIND     ROLE                                                    SUBJECT-KIND         SUBJECT-NAMESPACE      SUBJECT-NAME</span><br><span class=\"line\">RoleBinding          kubernetes-dashboard   kubernetes-dashboard                                           Role          kubernetes-dashboard                                   ServiceAccount        kubernetes-dashboard   kubernetes-dashboard</span><br><span class=\"line\">ClusterRoleBinding   &lt;none&gt;                 kubernetes-dashboard                                           ClusterRole   kubernetes-dashboard                                   ServiceAccount        kubernetes-dashboard   kubernetes-dashboard</span><br></pre></td></tr></table></figure>\n<h3 id=\"查询指定的SA被关联到哪些deploy\">查询指定的SA被关联到哪些deploy</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ k get deploy -A \\</span><br><span class=\"line\">-o <span class=\"string\">&#x27;custom-columns=NAMESPACE:.metadata.namespace,NAME:.metadata.name,SERVICEACCOUNT:.spec.template.spec.serviceAccountName&#x27;</span> \\</span><br><span class=\"line\">| (<span class=\"built_in\">head</span> -n 1 &amp;&amp; awk <span class=\"string\">&#x27;&#123;if ($3 == &quot;kubernetes-dashboard&quot;) print&#125;&#x27;</span>)</span><br><span class=\"line\">NAMESPACE              NAME                           SERVICEACCOUNT</span><br><span class=\"line\">kubernetes-dashboard   dashboard-metrics-scraper      kubernetes-dashboard</span><br><span class=\"line\">kubernetes-dashboard   kubernetes-dashboard           kubernetes-dashboard</span><br></pre></td></tr></table></figure>\n<h3 id=\"查询指定的SA被关联到哪些pod\">查询指定的SA被关联到哪些pod</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ k get pod -A \\</span><br><span class=\"line\">-o <span class=\"string\">&#x27;custom-columns=NAMESPACE:.metadata.namespace,NAME:.metadata.name,SERVICEACCOUNT:.spec.serviceAccountName&#x27;</span> \\</span><br><span class=\"line\">| (<span class=\"built_in\">head</span> -n 1 &amp;&amp; awk <span class=\"string\">&#x27;&#123;if ($3 == &quot;kubernetes-dashboard&quot;) print&#125;&#x27;</span>)</span><br><span class=\"line\">NAMESPACE              NAME                                            SERVICEACCOUNT</span><br><span class=\"line\">kubernetes-dashboard   dashboard-metrics-scraper-7bc864c59-sqjq8       kubernetes-dashboard</span><br><span class=\"line\">kubernetes-dashboard   kubernetes-dashboard-6c7ccbcf87-zb2hb           kubernetes-dashboard</span><br></pre></td></tr></table></figure>\n<h3 id=\"编辑SA\">编辑SA</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>比如我们要为已经创建好的SA关联AWS IAM角色，需要编辑SA，将IAM角色添加到SA的注释中。</p>\n</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">$</span> <span class=\"string\">k</span> <span class=\"string\">edit</span> <span class=\"string\">sa</span> <span class=\"string\">-n</span> <span class=\"string\">kube-system</span> <span class=\"string\">aws-load-balancer-controller</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">eks.amazonaws.com/role-arn:</span> <span class=\"string\">arn:aws:iam::743263909644:role/AmazonEKSLoadBalancerControllerRole</span></span><br><span class=\"line\">  <span class=\"attr\">creationTimestamp:</span> <span class=\"string\">&quot;2023-07-04T09:20:41Z&quot;</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/managed-by:</span> <span class=\"string\">eksctl</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">aws-load-balancer-controller</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">kube-system</span></span><br><span class=\"line\">  <span class=\"attr\">resourceVersion:</span> <span class=\"string\">&quot;1707669&quot;</span></span><br><span class=\"line\">  <span class=\"attr\">uid:</span> <span class=\"string\">857200a6-2e16-4939-bbbc-483dd579acbb</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>也可以直接通过命令行添加注解</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubectl annotate serviceaccount aws-load-balancer-controller \\</span><br><span class=\"line\">  -n kube-system \\</span><br><span class=\"line\">  eks.amazonaws.com/role-arn=arn:aws:iam::743263909644:role/AmazonEKSLoadBalancerControll</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ServiceAccount被修改过后，关联的pod需要重新启动才能生效。</p>\n</li>\n</ul>\n","content_text":"摘要 本文聊一聊ServiceAccount 参考资料： Amazon EKS用户指南 Kubernetes 文档 聊一聊ServiceAccount 网上关于ServiceAccount的介绍有很多，但大多都比较晦涩难懂，不好理解，这里我基于自己的理解聊一聊ServiceAccount。 ServiceAccount是k8s中的用户，其被定义在namespace下，可以被关联到pod上，使其获得相应的权限。 ServiceAccount可以与k8s中的Role或者ClusterRole进行绑定，以使其具有访问k8s内部资源的权限，当pod关联ServiceAccount后也就获得了相应的权限。参考AWS-EKS-12--部署 Dashboard UI 12345678910111213141516171819# dashboard-adminuser.yamlapiVersion: v1kind: ServiceAccountmetadata: name: admin-user namespace: kubernetes-dashboard---apiVersion: rbac.authorization.k8s.io/v1kind: ClusterRoleBindingmetadata: name: admin-userroleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: cluster-adminsubjects:- kind: ServiceAccount name: admin-user namespace: kubernetes-dashboard ServiceAccount也可以被关联到IAM Role，以使其具有访问AWS资源的权限。当pod关联ServiceAccount后就获得了访问AWS资源的权限。参考AWS-EKS-15--EKS权限管理(下)Pod 是如何调用 AWS 资源的 12345678$ eksctl create iamserviceaccount \\--cluster=eks-lexing \\--profile eks-us-west-2 \\--namespace=kube-system \\--name=aws-load-balancer-controller \\--role-name AmazonEKSLoadBalancerControllerRole \\--attach-policy-arn=arn:aws:iam::743263909644:policy/AWSLoadBalancerControllerIAMPolicy \\--approve ServiceAccount default 在 Kubernetes 中是默认存在的，它通常与运行在 Pod 内的应用程序关联，用于与 Kubernetes API 服务器进行身份验证和授权。default ServiceAccount 是每个命名空间中的默认 ServiceAccount，如果没有为 Pod 显式指定 ServiceAccount，则会自动关联到 default ServiceAccount。 default ServiceAccount的权限是由所分配的角色（Role）或集群角色（ClusterRole）定义的。在默认情况下，default ServiceAccount没有任何特权或访问权限。它只能访问其所在命名空间的一些基本资源，例如查看自身的 Pod、Service、Endpoints 等。 创建SA 123456789101112# 方式1，使用kubectl命令行直接创建$ kubectl create serviceaccount &lt;serviceaccount-name&gt; -n &lt;namespace&gt;# 方式2，基于yaml# sa.yamlapiVersion: v1kind: ServiceAccountmetadata: name: &lt;serviceaccount-name&gt; namespace: &lt;namespace&gt;$ kubectl apply -f sa.yaml 查询SA 12345$ k get sa -n kubernetes-dashboardNAME SECRETS AGEadmin-user 0 8ddefault 0 8dkubernetes-dashboard 0 8d SA与Role或者ClusterRole进行绑定 SA绑定Role 12345678910111213141516171819202122232425262728apiVersion: v1kind: ServiceAccountmetadata: name: my-service-account namespace: test---apiVersion: rbac.authorization.k8s.io/v1kind: Rolemetadata: name: my-role namespace: test # 与ClusterRole的区别就是Role要绑定到Namespacerules:- apiGroups: [&quot;&quot;] # 限定API组，为空则为默认的 core API 组 resources: [&quot;pods&quot;, &quot;services&quot;, &quot;configmaps&quot;] # 要访问的资源 verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;] # 开放的权限---apiVersion: rbac.authorization.k8s.io/v1kind: RoleBindingmetadata: name: my-role-bindingsubjects:- kind: ServiceAccount name: my-service-account namespace: testroleRef: kind: Role name: my-role apiGroup: rbac.authorization.k8s.io SA绑定ClusterRole 123456789101112131415161718192021222324252627apiVersion: v1kind: ServiceAccountmetadata: name: my-service-account namespace: test---apiVersion: rbac.authorization.k8s.io/v1kind: ClusterRolemetadata: name: my-cluster-rolerules:- apiGroups: [&quot;&quot;] resources: [&quot;pods&quot;, &quot;services&quot;, &quot;configmaps&quot;] verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;]---apiVersion: rbac.authorization.k8s.io/v1kind: ClusterRoleBindingmetadata: name: my-cluster-role-bindingsubjects:- kind: ServiceAccount name: my-service-account namespace: testroleRef: kind: ClusterRole name: my-cluster-role apiGroup: rbac.authorization.k8s.io API组 Kubernetes中有许多常见的API组，每个API组都包含一组相关的资源。以下是一些常见的API组： core：该API组是Kubernetes中的默认API组，包含核心资源，如pods、services、configmaps、secrets等。 apps：该API组包含应用程序相关的资源，如deployments、replicasets、daemonsets、statefulsets等。 batch：该API组包含批处理作业相关的资源，如jobs、cronjobs等。 extensions：这是Kubernetes早期版本中广泛使用的API组，现在已经被apps和networking.k8s.io API组所取代。它包含一些资源，如replicationcontrollers、ingresses等。 networking.k8s.io：该API组包含与网络相关的资源，如ingresses、networkpolicies等。 storage.k8s.io：该API组包含存储相关的资源，如storageclasses、persistentvolumes、persistentvolumeclaims等。 autoscaling：该API组包含自动扩展相关的资源，如horizontalpodautoscalers。 rbac.authorization.k8s.io：该API组包含与角色和访问控制相关的资源，如roles、rolebindings、clusterroles、clusterrolebindings等。 这只是一小部分常见的API组，实际上还有许多其他的API组，根据您的Kubernetes集群的版本和所使用的插件，可能会有其他自定义的API组。您可以使用kubectl api-resources命令查看集群中所有可用的API组和资源。 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364# 这里 APIVERSION 中版本中斜线前面的就是 API组名称 ,没有斜线的就是默认的 core 组$ kubectl api-resourcesNAME SHORTNAMES APIVERSION NAMESPACED KINDbindings v1 true Bindingcomponentstatuses cs v1 false ComponentStatusconfigmaps cm v1 true ConfigMapendpoints ep v1 true Endpointsevents ev v1 true Eventlimitranges limits v1 true LimitRangenamespaces ns v1 false Namespacenodes no v1 false Nodepersistentvolumeclaims pvc v1 true PersistentVolumeClaimpersistentvolumes pv v1 false PersistentVolumepods po v1 true Podpodtemplates v1 true PodTemplatereplicationcontrollers rc v1 true ReplicationControllerresourcequotas quota v1 true ResourceQuotasecrets v1 true Secretserviceaccounts sa v1 true ServiceAccountservices svc v1 true Servicemutatingwebhookconfigurations admissionregistration.k8s.io/v1 false MutatingWebhookConfigurationvalidatingwebhookconfigurations admissionregistration.k8s.io/v1 false ValidatingWebhookConfigurationcustomresourcedefinitions crd,crds apiextensions.k8s.io/v1 false CustomResourceDefinitionapiservices apiregistration.k8s.io/v1 false APIServicecontrollerrevisions apps/v1 true ControllerRevisiondaemonsets ds apps/v1 true DaemonSetdeployments deploy apps/v1 true Deploymentreplicasets rs apps/v1 true ReplicaSetstatefulsets sts apps/v1 true StatefulSettokenreviews authentication.k8s.io/v1 false TokenReviewlocalsubjectaccessreviews authorization.k8s.io/v1 true LocalSubjectAccessReviewselfsubjectaccessreviews authorization.k8s.io/v1 false SelfSubjectAccessReviewselfsubjectrulesreviews authorization.k8s.io/v1 false SelfSubjectRulesReviewsubjectaccessreviews authorization.k8s.io/v1 false SubjectAccessReviewhorizontalpodautoscalers hpa autoscaling/v2 true HorizontalPodAutoscalercronjobs cj batch/v1 true CronJobjobs batch/v1 true Jobcertificatesigningrequests csr certificates.k8s.io/v1 false CertificateSigningRequestleases coordination.k8s.io/v1 true Leaseeniconfigs crd.k8s.amazonaws.com/v1alpha1 false ENIConfigendpointslices discovery.k8s.io/v1 true EndpointSliceingressclassparams elbv2.k8s.aws/v1beta1 false IngressClassParamstargetgroupbindings elbv2.k8s.aws/v1beta1 true TargetGroupBindingevents ev events.k8s.io/v1 true Eventflowschemas flowcontrol.apiserver.k8s.io/v1beta3 false FlowSchemaprioritylevelconfigurations flowcontrol.apiserver.k8s.io/v1beta3 false PriorityLevelConfigurationnodes metrics.k8s.io/v1beta1 false NodeMetricspods metrics.k8s.io/v1beta1 true PodMetricsingressclasses networking.k8s.io/v1 false IngressClassingresses ing networking.k8s.io/v1 true Ingressnetworkpolicies netpol networking.k8s.io/v1 true NetworkPolicyruntimeclasses node.k8s.io/v1 false RuntimeClasspoddisruptionbudgets pdb policy/v1 true PodDisruptionBudgetclusterrolebindings rbac.authorization.k8s.io/v1 false ClusterRoleBindingclusterroles rbac.authorization.k8s.io/v1 false ClusterRolerolebindings rbac.authorization.k8s.io/v1 true RoleBindingroles rbac.authorization.k8s.io/v1 true Rolepriorityclasses pc scheduling.k8s.io/v1 false PriorityClasscsidrivers storage.k8s.io/v1 false CSIDrivercsinodes storage.k8s.io/v1 false CSINodecsistoragecapacities storage.k8s.io/v1 true CSIStorageCapacitystorageclasses sc storage.k8s.io/v1 false StorageClassvolumeattachments storage.k8s.io/v1 false VolumeAttachmentsecuritygrouppolicies sgp vpcresources.k8s.aws/v1beta1 true SecurityGroupPolicy SA与Deployment或者Pod关联 SA与Deployment关联 123456789101112131415161718apiVersion: apps/v1kind: Deploymentmetadata: name: my-deploymentspec: replicas: 3 selector: matchLabels: app: my-app template: metadata: labels: app: my-app spec: serviceAccountName: my-service-account # 指定sa名称 containers: - name: my-container image: my-image SA与Pod关联 123456789apiVersion: v1kind: Podmetadata: name: my-podspec: serviceAccountName: my-service-account # 指定sa名称 containers: - name: my-container image: my-image 小贴士 serviceAccount 和 serviceAccountName 是 Kubernetes YAML 配置中用于关联 Service Account 的两个属性，它们有一些区别： serviceAccountName：这是一个字符串属性，用于指定要与 Pod 或 Deployment 关联的 Service Account 的名称。它是最常用的属性，只需提供 Service Account 的名称即可。示例：serviceAccountName: my-service-account serviceAccount：这是一个对象属性，用于指定要与 Pod 或 Deployment 关联的 Service Account 的更详细信息。它可以提供 Service Account 的名称和命名空间。示例： 123serviceAccount: name: my-service-account namespace: my-namespace 注意：namespace 字段是可选的，如果不指定，它将使用当前 Pod 或 Deployment 所在的命名空间。 总结来说，serviceAccountName 是一种更简洁的方式，只需提供 Service Account 的名称。而 serviceAccount 则可以提供更多关于 Service Account 的详细信息，如名称和命名空间。在大多数情况下，使用 serviceAccountName 就足够了，除非需要更精细地控制 Service Account 的属性。 查询指定的SA被绑定到哪些角色 123456$ kubectl get rolebindings,clusterrolebindings -A \\-o &#x27;custom-columns=KIND:.kind,NAMESPACE:.metadata.namespace,NAME:.metadata.name,ROLE-KIND:.roleRef.kind,ROLE:.roleRef.name, SUBJECT-KIND:.subjects[*].kind,SUBJECT-NAMESPACE:.subjects[*].namespace,SUBJECT-NAME:.subjects[*].name&#x27; \\| (head -n 1 &amp;&amp; awk &#x27;&#123;if ($8 == &quot;kubernetes-dashboard&quot;) print&#125;&#x27;)KIND NAMESPACE NAME ROLE-KIND ROLE SUBJECT-KIND SUBJECT-NAMESPACE SUBJECT-NAMERoleBinding kubernetes-dashboard kubernetes-dashboard Role kubernetes-dashboard ServiceAccount kubernetes-dashboard kubernetes-dashboardClusterRoleBinding &lt;none&gt; kubernetes-dashboard ClusterRole kubernetes-dashboard ServiceAccount kubernetes-dashboard kubernetes-dashboard 查询指定的SA被关联到哪些deploy 123456$ k get deploy -A \\-o &#x27;custom-columns=NAMESPACE:.metadata.namespace,NAME:.metadata.name,SERVICEACCOUNT:.spec.template.spec.serviceAccountName&#x27; \\| (head -n 1 &amp;&amp; awk &#x27;&#123;if ($3 == &quot;kubernetes-dashboard&quot;) print&#125;&#x27;)NAMESPACE NAME SERVICEACCOUNTkubernetes-dashboard dashboard-metrics-scraper kubernetes-dashboardkubernetes-dashboard kubernetes-dashboard kubernetes-dashboard 查询指定的SA被关联到哪些pod 123456$ k get pod -A \\-o &#x27;custom-columns=NAMESPACE:.metadata.namespace,NAME:.metadata.name,SERVICEACCOUNT:.spec.serviceAccountName&#x27; \\| (head -n 1 &amp;&amp; awk &#x27;&#123;if ($3 == &quot;kubernetes-dashboard&quot;) print&#125;&#x27;)NAMESPACE NAME SERVICEACCOUNTkubernetes-dashboard dashboard-metrics-scraper-7bc864c59-sqjq8 kubernetes-dashboardkubernetes-dashboard kubernetes-dashboard-6c7ccbcf87-zb2hb kubernetes-dashboard 编辑SA 比如我们要为已经创建好的SA关联AWS IAM角色，需要编辑SA，将IAM角色添加到SA的注释中。 12345678910111213$ k edit sa -n kube-system aws-load-balancer-controllerapiVersion: v1kind: ServiceAccountmetadata: annotations: eks.amazonaws.com/role-arn: arn:aws:iam::743263909644:role/AmazonEKSLoadBalancerControllerRole creationTimestamp: &quot;2023-07-04T09:20:41Z&quot; labels: app.kubernetes.io/managed-by: eksctl name: aws-load-balancer-controller namespace: kube-system resourceVersion: &quot;1707669&quot; uid: 857200a6-2e16-4939-bbbc-483dd579acbb 也可以直接通过命令行添加注解 123$ kubectl annotate serviceaccount aws-load-balancer-controller \\ -n kube-system \\ eks.amazonaws.com/role-arn=arn:aws:iam::743263909644:role/AmazonEKSLoadBalancerControll ServiceAccount被修改过后，关联的pod需要重新启动才能生效。","summary":"摘要 本文聊一聊ServiceAccount 参考资料： Amazon EKS用户指南 Kubernetes 文档","date_published":"2023-07-14T12:30:05.000Z","tags":["技术","aws","eks","java"]},{"id":"https://blog.hanqunfeng.com/2023/07/13/aws-eks15-auth-pod/","url":"https://blog.hanqunfeng.com/2023/07/13/aws-eks15-auth-pod/","title":"AWS-EKS-15--EKS权限管理(下)Pod 是如何调用 AWS 资源的","content_html":"<!--\n **加粗**\n *斜体*\n ***加粗并斜体***\n ~~删除线~~\n ==突出显示==\n `突出显示(推荐)`\n ++下划线++\n ~下标~\n ^上标^\n 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.\n 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600)\n\n +++ **点击折叠**\n 这是被隐藏的内容\n +++\n\n::: tips success warning danger\n这里是容器内的内容\n:::\n\n% note info % success warning danger\n这里是容器内的内容\n% endnote %\n\n -->\n<h2 id=\"摘要\">摘要</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>本文介绍为EKS集群的 Pod 调用 AWS 资源的方法</p>\n</li>\n<li class=\"lvl-2\">\n<p>参考资料：</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\"><a href=\"https://docs.aws.amazon.com/zh_cn/eks/latest/userguide\">Amazon EKS用户指南</a></li>\n<li class=\"lvl-6\"><a href=\"https://kubernetes.io/zh-cn/docs/home/\">Kubernetes 文档</a></li>\n</ul>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"原理解析\">原理解析</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>在Pod中访问AWS资源，如获取S3中的文件，将ingress绑定到ELB，等等，这些操作都需要被授予相应的权限才可以正常访问。</p>\n</li>\n<li class=\"lvl-2\">\n<p>在AWS IAM中的Role可以被授权给基于OIDC身份提供商的外部用户，而在EKS集群中的pod对于AWS IAM来说就属于外部用户，AWS会通过IAM OIDC对这些外部用户的有效性进行校验。</p>\n</li>\n<li class=\"lvl-2\">\n<p>前文已经介绍过<a href=\"/2023/07/07/aws-eks03-oidc/\" title=\"AWS-EKS-03--创建 IAM OIDC 身份提供商\">如何为EKS创建 IAM OIDC 身份提供商</a>，在EKS(K8s)中，并不是直接对Pod进行权限校验，而是ServcieAccount，在 K8s 中，ServiceAccount 是一种用于身份验证和授权的机制，它为 Pod 提供了一个身份标识。每个 Pod 都与一个 ServiceAccount 相关联，并且可以使用该 ServiceAccount 获取与其关联的身份凭据。</p>\n</li>\n<li class=\"lvl-2\">\n<p>在EKS（K8s）中可以将ServcieAccount与AWS IAM Role进行绑定，同时将ServcieAccount与Pod进行关联，这样Pod也就具备了相应的IAM Role。</p>\n</li>\n<li class=\"lvl-2\">\n<p>EKS（K8s）的 ServcieAccount 通过 Idp（EKS OpenID Connect provider）获得 ID_token并将其发送给 IAM Identity providers ，IAM Identity providers负责获取OIDC的key并验证ID_token的有效性。</p>\n</li>\n<li class=\"lvl-2\">\n<p>当ServcieAccount通过IAM OIDC身份校验后，关联的Pod就可以使用相对应的Role获得访问AWS资源的权限。</p>\n</li>\n<li class=\"lvl-2\">\n<p>创建Pod时，如果没有为其指定关联的ServcieAccount，则默认使用Pod所在Namespace下的名称为<code>default</code>的ServcieAccount，创建Namespace时会自动为其创建该缺省的ServcieAccount，默认其没有绑定任何IAM Role，则缺省继承NodeGroup的IAM Role，NodeGroup的IAM Role是在创建EKS集群时自动创建的，其具有对ECR存储库的只读访问、允许Amazon EKS工作节点连接到Amazon EKS群集等权限。<br>\n<img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/fXD4pY.png\" alt=\"\" width=\"1200\" height=\"800\"></p>\n</li>\n<li class=\"lvl-2\">\n<p>Amazon EKS Pod Identity Webhook 会查看与 service account 关联的 Pods，并向 Pod 提供下列环境变量</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">AWS_ROLE_ARN=arn:aws:iam::&lt;ACCOUNT_ID&gt;:role/&lt;IAM_ROLE_NAME&gt;</li>\n<li class=\"lvl-6\">AWS_WEB_IDENTITY_TOKEN_FILE=/var/run/secrets/eks.amazonaws.com/serviceaccount/token</li>\n</ul>\n</li>\n<li class=\"lvl-2\">\n<p><code>AWS_ROLE_ARN</code>就是绑定到ServiceAccount上的IAM Role，<code>AWS_WEB_IDENTITY_TOKEN_FILE</code>就是要发送给IAM Identity providers的ID_token。</p>\n</li>\n<li class=\"lvl-2\">\n<p>默认只有以 root 用户运行的容器才有权限访问 web identity token 文件，当以其它用户运行容器时，需要用 fsGroup 指定一个 groupID。在 Amazon EKS 中，可以将 fsGroup 设置为 65534。这是 Kubernetes 中的推荐做法，因为这个值对应于 nobody 用户和 nogroup 组的 ID。使用 fsGroup: 65534 将确保容器中的非 root 用户具有适当的权限来访问 Web Identity Token 文件。</p>\n</li>\n</ul>\n<h2 id=\"案例分析\">案例分析</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>前面在<a href=\"/2023/07/07/aws-eks07-loadbalancer/\" title=\"AWS-EKS-07--安装 AWS Load Balancer Controller 附加组件\">安装 AWS Load Balancer Controller 附加组件</a>时，通过如下方式进行授权</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ curl -O https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/v2.4.7/docs/install/iam_policy.json</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 使用上一步中下载的策略创建一个 IAM policy</span></span><br><span class=\"line\">$ aws iam create-policy \\</span><br><span class=\"line\">    --profile eks-us-west-2 \\</span><br><span class=\"line\">    --policy-name AWSLoadBalancerControllerIAMPolicy \\</span><br><span class=\"line\">    --policy-document file://iam_policy.json</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 在 AWS Load Balancer Controller 的 kube-system 命名空间中创建名为 aws-load-balancer-controller 的 Kubernetes 服务账户，并使用 IAM 角色的名称注释 Kubernetes 服务账户。</span></span><br><span class=\"line\">$ eksctl create iamserviceaccount \\</span><br><span class=\"line\">  --cluster=eks-lexing \\</span><br><span class=\"line\">  --profile eks-us-west-2 \\</span><br><span class=\"line\">  --namespace=kube-system \\</span><br><span class=\"line\">  --name=aws-load-balancer-controller \\</span><br><span class=\"line\">  --role-name AmazonEKSLoadBalancerControllerRole \\</span><br><span class=\"line\">  --attach-policy-arn=arn:aws:iam::743263909644:policy/AWSLoadBalancerControllerIAMPolicy \\</span><br><span class=\"line\">  --approve</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>上面是先通过<code>aws iam create-policy</code>命令创建了一个策略，然后通过<code>eksctl create iamserviceaccount</code>命令为EKS(K8s)创建了一个ServiceAccount，同时创建了一个IAM Role与ServiceAccount绑定，并将该Role与上面创建的策略进行关联。</p>\n</li>\n<li class=\"lvl-2\">\n<p>所以实际上，上面的一个命令干了四件事</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">\n<p>1.创建了一个名称为<code>AmazonEKSLoadBalancerControllerRole</code>的IAM角色并关联新建的名称为<code>AWSLoadBalancerControllerIAMPolicy</code>的策略<br>\n<img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/xl0OSL.png\" alt=\"\" width=\"1200\" height=\"600\"></p>\n</li>\n<li class=\"lvl-6\">\n<p>2.在k8s的<code>kube-system</code>namespace下创建了一个名称为<code>aws-load-balancer-controller</code>的ServiceAccount</p>\n</li>\n</ul>\n  <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ k get sa -n kube-system aws-load-balancer-controller</span><br><span class=\"line\">NAME                           SECRETS   AGE</span><br><span class=\"line\">aws-load-balancer-controller   0         9d</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">3.在名称为<code>AmazonEKSLoadBalancerControllerRole</code>的IAM角色的信任关系中指定认证方式为OIDC，并且关联名称为<code>aws-load-balancer-controller</code>的ServiceAccount。</li>\n</ul>\n<p><img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/MkTXd5.png\" alt=\"\" width=\"1200\" height=\"500\"></p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">\n<p>4.在名称为<code>aws-load-balancer-controller</code>的ServiceAccount中关联上面的角色<code>AmazonEKSLoadBalancerControllerRole</code>，就是添加注释<code>eks.amazonaws.com/role-arn: arn:aws:iam::743263909644:role/AmazonEKSLoadBalancerControll</code>。</p>\n</li>\n</ul>\n  <figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">$</span> <span class=\"string\">k</span> <span class=\"string\">edit</span> <span class=\"string\">sa</span> <span class=\"string\">-n</span> <span class=\"string\">kube-system</span> <span class=\"string\">aws-load-balancer-controller</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">eks.amazonaws.com/role-arn:</span> <span class=\"string\">arn:aws:iam::743263909644:role/AmazonEKSLoadBalancerControll</span></span><br><span class=\"line\"><span class=\"attr\">creationTimestamp:</span> <span class=\"string\">&quot;2023-07-04T09:20:41Z&quot;</span></span><br><span class=\"line\"><span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/managed-by:</span> <span class=\"string\">eksctl</span></span><br><span class=\"line\"><span class=\"attr\">name:</span> <span class=\"string\">aws-load-balancer-controller</span></span><br><span class=\"line\"><span class=\"attr\">namespace:</span> <span class=\"string\">kube-system</span></span><br><span class=\"line\"><span class=\"attr\">resourceVersion:</span> <span class=\"string\">&quot;1707669&quot;</span></span><br><span class=\"line\"><span class=\"attr\">uid:</span> <span class=\"string\">857200a6-2e16-4939-bbbc-483dd579acbb</span></span><br></pre></td></tr></table></figure>\n</li>\n<li class=\"lvl-2\">\n<p>然后在创建Pod时，为Pod指定<code>serviceAccountName: aws-load-balancer-controller</code></p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-4\">默认情况下，在 Kubernetes 中启动的 Pod 不会以 root 用户身份运行，所以在使用基于 OIDC 的身份认证时，当以非 root 用户运行容器时，可以使用 fsGroup 来指定一个组 ID（group ID），以便容器中的用户具有访问 Web Identity Token 文件的权限。在 Amazon EKS 中，可以将 fsGroup 设置为 65534。这是 Kubernetes 中的推荐做法，因为这个值对应于 nobody 用户和 nogroup 组的 ID。使用 fsGroup: 65534 将确保容器中的非 root 用户具有适当的权限来访问 Web Identity Token 文件，确保容器中的用户具有访问 <code>/var/run/secrets/eks.amazonaws.com/serviceaccount/token</code> 文件的权限。</li>\n</ul>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubectl edit deployment -n kube-system aws-load-balancer-controller</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/rSKtJm.png\" alt=\"\"></p>\n<div class=\"tips\">\n<p><em><strong>使用aws命令创建角色并关联SA</strong></em></p>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">创建Policy</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ curl -O https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/v2.4.7/docs/install/iam_policy.json</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 使用上一步中下载的策略创建一个 IAM policy</span></span><br><span class=\"line\">$ aws iam create-policy \\</span><br><span class=\"line\">    --profile eks-us-west-2 \\</span><br><span class=\"line\">    --policy-name AWSLoadBalancerControllerIAMPolicy \\</span><br><span class=\"line\">    --policy-document file://iam_policy.json</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">创建<code>trust-policy.json</code>，用于描述IAM Role的信任关系</li>\n</ul>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;Version&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;2012-10-17&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;Statement&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">        <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">            <span class=\"attr\">&quot;Effect&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;Allow&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">            <span class=\"attr\">&quot;Principal&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">                <span class=\"attr\">&quot;Federated&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;arn:aws:iam::743263909644:oidc-provider/oidc.eks.us-west-2.amazonaws.com/id/1029FF88CB872B6B7A1CC65D44191A56&quot;</span></span><br><span class=\"line\">            <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">            <span class=\"attr\">&quot;Action&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;sts:AssumeRoleWithWebIdentity&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">            <span class=\"attr\">&quot;Condition&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">                <span class=\"attr\">&quot;StringEquals&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">                    <span class=\"attr\">&quot;oidc.eks.us-west-2.amazonaws.com/id/1029FF88CB872B6B7A1CC65D44191A56:aud&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;sts.amazonaws.com&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">                    <span class=\"attr\">&quot;oidc.eks.us-west-2.amazonaws.com/id/1029FF88CB872B6B7A1CC65D44191A56:sub&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;system:serviceaccount:kube-system:aws-load-balancer-controller&quot;</span></span><br><span class=\"line\">                <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">            <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">        <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">    <span class=\"punctuation\">]</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>上述配置中的 “Condition” 部分是用于在 IAM 角色的信任策略中定义条件。该条件会限制什么样的令牌可以被信任并用于角色的身份验证和授权。<br>\n具体来说，“Condition” 对象中的 “StringEquals” 表示字符串相等的条件比较。它包含两个键值对，每个键值对都描述了一个条件。<br>\n“<a href=\"http://oidc.eks.us-west-2.amazonaws.com/id/1029FF88CB872B6B7A1CC65D44191A56:aud\">oidc.eks.us-west-2.amazonaws.com/id/1029FF88CB872B6B7A1CC65D44191A56:aud</a>”: “<a href=\"http://sts.amazonaws.com\">sts.amazonaws.com</a>”：这个条件表示 OIDC 令牌中的 “aud”（受众）字段必须与 “<a href=\"http://sts.amazonaws.com\">sts.amazonaws.com</a>” 相等。也就是说，令牌的受众必须是 AWS Security Token Service (STS)。<br>\n“<a href=\"http://oidc.eks.us-west-2.amazonaws.com/id/1029FF88CB872B6B7A1CC65D44191A56:sub\">oidc.eks.us-west-2.amazonaws.com/id/1029FF88CB872B6B7A1CC65D44191A56:sub</a>”: “system:serviceaccount:kube-system:aws-load-balancer-controller”：这个条件表示 OIDC 令牌中的 “sub”（主题）字段必须与 “system:serviceaccount:kube-system:aws-load-balancer-controller” 相等。也就是说，令牌的主题必须是 kube-system 命名空间下的 aws-load-balancer-controller Service Account。<br>\n这些条件的目的是确保只有满足这两个条件的 OIDC 令牌才能被信任，并被用于通过 OIDC 进行的身份验证和授权操作。这样可以限制对角色的访问，仅允许特定的 OIDC 令牌来获取访问权限。</p>\n</blockquote>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">创建 IAM Role</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ aws iam create-role \\</span><br><span class=\"line\">  --profile eks-us-west-2 \\</span><br><span class=\"line\">  --role-name AmazonEKSLoadBalancerControllerRole \\</span><br><span class=\"line\">  --assume-role-policy-document file://<span class=\"string\">&quot;trust-policy.json&quot;</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">\n<p>为 Role 添加 Policy</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ aws iam attach-role-policy \\</span><br><span class=\"line\">  --profile eks-us-west-2 \\</span><br><span class=\"line\">  --policy-arn arn:aws:iam::743263909644:policy/AWSLoadBalancerControllerIAMPolicy \\</span><br><span class=\"line\">  --role-name AmazonEKSLoadBalancerControllerRole</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">\n<p>创建SA</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubectl create serviceaccount aws-load-balancer-controller -n kube-system</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">\n<p>为SA绑定IAM Role</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubectl annotate serviceaccount aws-load-balancer-controller \\</span><br><span class=\"line\">  -n kube-system \\</span><br><span class=\"line\">  eks.amazonaws.com/role-arn=arn:aws:iam::743263909644:role/AmazonEKSLoadBalancerControllerRole</span><br></pre></td></tr></table></figure>\n</div>\n<h2 id=\"动手实践\">动手实践</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>搞明白了上面的原理，我们只需要按照上面那的步骤做就可以了，接下来就以Pod访问S3为例进行说明。</p>\n</li>\n<li class=\"lvl-2\">\n<p>创建新的策略或使用现有策略，这里我们使用已有的策略<code>arn:aws:iam::aws:policy/AmazonS3FullAccess</code></p>\n</li>\n<li class=\"lvl-2\">\n<p>使用<code>eksctl create iamserviceaccount</code>创建Service和IAM Role，并将它们进行绑定关联</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ eksctl create iamserviceaccount \\</span><br><span class=\"line\">  --cluster=eks-lexing \\</span><br><span class=\"line\">  --namespace=<span class=\"built_in\">test</span> \\</span><br><span class=\"line\">  --name=test-s3-sa-new \\</span><br><span class=\"line\">  --role-name TestS3Role \\</span><br><span class=\"line\">  --attach-policy-arn=arn:aws:iam::aws:policy/AmazonS3FullAccess \\</span><br><span class=\"line\">  --approve</span><br><span class=\"line\">2023-07-13 19:59:18 [ℹ]  6 existing iamserviceaccount(s) (kube-system/aws-load-balancer-controller,kube-system/aws-node,kube-system/ebs-csi-controller-sa,kube-system/efs-csi-controller-sa,<span class=\"built_in\">test</span>/test-s3-sa,<span class=\"built_in\">test</span>/testS3SA) will be excluded</span><br><span class=\"line\">2023-07-13 19:59:18 [ℹ]  1 iamserviceaccount (<span class=\"built_in\">test</span>/test-s3-sa-new) was included (based on the include/exclude rules)</span><br><span class=\"line\">2023-07-13 19:59:18 [!]  serviceaccounts that exist <span class=\"keyword\">in</span> Kubernetes will be excluded, use --override-existing-serviceaccounts to override</span><br><span class=\"line\">2023-07-13 19:59:18 [ℹ]  1 task: &#123;</span><br><span class=\"line\">    2 sequential sub-tasks: &#123;</span><br><span class=\"line\">        create IAM role <span class=\"keyword\">for</span> serviceaccount <span class=\"string\">&quot;test/test-s3-sa-new&quot;</span>,</span><br><span class=\"line\">        create serviceaccount <span class=\"string\">&quot;test/test-s3-sa-new&quot;</span>,</span><br><span class=\"line\">    &#125; &#125;2023-07-13 19:59:18 [ℹ]  building iamserviceaccount stack <span class=\"string\">&quot;eksctl-eks-lexing-addon-iamserviceaccount-test-test-s3-sa-new&quot;</span></span><br><span class=\"line\">2023-07-13 19:59:18 [ℹ]  deploying stack <span class=\"string\">&quot;eksctl-eks-lexing-addon-iamserviceaccount-test-test-s3-sa-new&quot;</span></span><br><span class=\"line\">2023-07-13 19:59:19 [ℹ]  waiting <span class=\"keyword\">for</span> CloudFormation stack <span class=\"string\">&quot;eksctl-eks-lexing-addon-iamserviceaccount-test-test-s3-sa-new&quot;</span></span><br><span class=\"line\">2023-07-13 19:59:50 [ℹ]  waiting <span class=\"keyword\">for</span> CloudFormation stack <span class=\"string\">&quot;eksctl-eks-lexing-addon-iamserviceaccount-test-test-s3-sa-new&quot;</span></span><br><span class=\"line\">2023-07-13 19:59:51 [ℹ]  created serviceaccount <span class=\"string\">&quot;test/test-s3-sa-new&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看sa，确认是否已关联IAM Role</span></span><br><span class=\"line\">$ k describe sa test-s3-sa-new</span><br><span class=\"line\">Name:                test-s3-sa-new</span><br><span class=\"line\">Namespace:           <span class=\"built_in\">test</span></span><br><span class=\"line\">Labels:              app.kubernetes.io/managed-by=eksctl</span><br><span class=\"line\">Annotations:         eks.amazonaws.com/role-arn: arn:aws:iam::743263909644:role/TestS3Role</span><br><span class=\"line\">Image pull secrets:  &lt;none&gt;</span><br><span class=\"line\">Mountable secrets:   &lt;none&gt;</span><br><span class=\"line\">Tokens:              &lt;none&gt;</span><br><span class=\"line\">Events:              &lt;none&gt;</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/IOszUm.png\" alt=\"\" width=\"1200\" height=\"600\"><br>\n<img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/oQ6D30.png\" alt=\"\" width=\"1200\" height=\"400\"></p>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>创建一个已经安装过AWS CLI的Pod，这里镜像就使用<code>amazon/aws-cli</code>，注意要指定<code>serviceAccountName: test-s3-sa-new</code></p>\n</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">deployment-test-s3-sa</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app.kubernetes.io/name:</span> <span class=\"string\">app-test-s3-sa</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app.kubernetes.io/name:</span> <span class=\"string\">app-test-s3-sa</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">serviceAccountName:</span> <span class=\"string\">test-s3-sa-new</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">image:</span> <span class=\"string\">amazon/aws-cli</span></span><br><span class=\"line\">        <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">Always</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span> <span class=\"string\">app-test-s3-sa</span></span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">80</span></span><br><span class=\"line\">        <span class=\"attr\">command:</span> [<span class=\"string\">&quot;/bin/sh&quot;</span>, <span class=\"string\">&quot;-c&quot;</span>]</span><br><span class=\"line\">        <span class=\"attr\">args:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">tail</span> <span class=\"string\">-f</span> <span class=\"string\">/dev/null</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 部署</span></span><br><span class=\"line\">$ k apply -f testS3SA.yaml</span><br><span class=\"line\">deployment.apps/deployment-test-s3-sa created</span><br><span class=\"line\"><span class=\"comment\"># 进入pod</span></span><br><span class=\"line\">$ k <span class=\"built_in\">exec</span> -it deployment-test-s3-sa-5bd985845d-mqjjp -- bash</span><br><span class=\"line\"><span class=\"comment\"># 查看当前的AWS用户信息，可以看到这里关联的是一个临时用户，但是从Arn中也能看出来其关联的角色 TestS3Role</span></span><br><span class=\"line\">bash-4.2<span class=\"comment\"># aws sts get-caller-identity</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;UserId&quot;</span>: <span class=\"string\">&quot;AROA22DP3G4GNBLHPZBAM:botocore-session-1689250618&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;Account&quot;</span>: <span class=\"string\">&quot;743263909644&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;Arn&quot;</span>: <span class=\"string\">&quot;arn:aws:sts::743263909644:assumed-role/TestS3Role/botocore-session-1689250618&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\"># 查看s3存储桶列表，查询成功，说明当前pod已经具备的访问AWS S3资源的权限</span></span><br><span class=\"line\">bash-4.2<span class=\"comment\"># aws s3 ls</span></span><br><span class=\"line\">2023-07-10 09:34:45 lexing-helm-charts</span><br><span class=\"line\"><span class=\"comment\"># 查看环境变量</span></span><br><span class=\"line\">bash-4.2<span class=\"comment\"># echo $AWS_ROLE_ARN</span></span><br><span class=\"line\">arn:aws:iam::743263909644:role/TestS3Role</span><br><span class=\"line\">bash-4.2<span class=\"comment\"># echo $AWS_WEB_IDENTITY_TOKEN_FILE</span></span><br><span class=\"line\">/var/run/secrets/eks.amazonaws.com/serviceaccount/token</span><br></pre></td></tr></table></figure>\n","content_text":"摘要 本文介绍为EKS集群的 Pod 调用 AWS 资源的方法 参考资料： Amazon EKS用户指南 Kubernetes 文档 原理解析 在Pod中访问AWS资源，如获取S3中的文件，将ingress绑定到ELB，等等，这些操作都需要被授予相应的权限才可以正常访问。 在AWS IAM中的Role可以被授权给基于OIDC身份提供商的外部用户，而在EKS集群中的pod对于AWS IAM来说就属于外部用户，AWS会通过IAM OIDC对这些外部用户的有效性进行校验。 前文已经介绍过如何为EKS创建 IAM OIDC 身份提供商，在EKS(K8s)中，并不是直接对Pod进行权限校验，而是ServcieAccount，在 K8s 中，ServiceAccount 是一种用于身份验证和授权的机制，它为 Pod 提供了一个身份标识。每个 Pod 都与一个 ServiceAccount 相关联，并且可以使用该 ServiceAccount 获取与其关联的身份凭据。 在EKS（K8s）中可以将ServcieAccount与AWS IAM Role进行绑定，同时将ServcieAccount与Pod进行关联，这样Pod也就具备了相应的IAM Role。 EKS（K8s）的 ServcieAccount 通过 Idp（EKS OpenID Connect provider）获得 ID_token并将其发送给 IAM Identity providers ，IAM Identity providers负责获取OIDC的key并验证ID_token的有效性。 当ServcieAccount通过IAM OIDC身份校验后，关联的Pod就可以使用相对应的Role获得访问AWS资源的权限。 创建Pod时，如果没有为其指定关联的ServcieAccount，则默认使用Pod所在Namespace下的名称为default的ServcieAccount，创建Namespace时会自动为其创建该缺省的ServcieAccount，默认其没有绑定任何IAM Role，则缺省继承NodeGroup的IAM Role，NodeGroup的IAM Role是在创建EKS集群时自动创建的，其具有对ECR存储库的只读访问、允许Amazon EKS工作节点连接到Amazon EKS群集等权限。 Amazon EKS Pod Identity Webhook 会查看与 service account 关联的 Pods，并向 Pod 提供下列环境变量 AWS_ROLE_ARN=arn:aws:iam::&lt;ACCOUNT_ID&gt;:role/&lt;IAM_ROLE_NAME&gt; AWS_WEB_IDENTITY_TOKEN_FILE=/var/run/secrets/eks.amazonaws.com/serviceaccount/token AWS_ROLE_ARN就是绑定到ServiceAccount上的IAM Role，AWS_WEB_IDENTITY_TOKEN_FILE就是要发送给IAM Identity providers的ID_token。 默认只有以 root 用户运行的容器才有权限访问 web identity token 文件，当以其它用户运行容器时，需要用 fsGroup 指定一个 groupID。在 Amazon EKS 中，可以将 fsGroup 设置为 65534。这是 Kubernetes 中的推荐做法，因为这个值对应于 nobody 用户和 nogroup 组的 ID。使用 fsGroup: 65534 将确保容器中的非 root 用户具有适当的权限来访问 Web Identity Token 文件。 案例分析 前面在安装 AWS Load Balancer Controller 附加组件时，通过如下方式进行授权 1234567891011121314151617$ curl -O https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/v2.4.7/docs/install/iam_policy.json# 使用上一步中下载的策略创建一个 IAM policy$ aws iam create-policy \\ --profile eks-us-west-2 \\ --policy-name AWSLoadBalancerControllerIAMPolicy \\ --policy-document file://iam_policy.json# 在 AWS Load Balancer Controller 的 kube-system 命名空间中创建名为 aws-load-balancer-controller 的 Kubernetes 服务账户，并使用 IAM 角色的名称注释 Kubernetes 服务账户。$ eksctl create iamserviceaccount \\ --cluster=eks-lexing \\ --profile eks-us-west-2 \\ --namespace=kube-system \\ --name=aws-load-balancer-controller \\ --role-name AmazonEKSLoadBalancerControllerRole \\ --attach-policy-arn=arn:aws:iam::743263909644:policy/AWSLoadBalancerControllerIAMPolicy \\ --approve 上面是先通过aws iam create-policy命令创建了一个策略，然后通过eksctl create iamserviceaccount命令为EKS(K8s)创建了一个ServiceAccount，同时创建了一个IAM Role与ServiceAccount绑定，并将该Role与上面创建的策略进行关联。 所以实际上，上面的一个命令干了四件事 1.创建了一个名称为AmazonEKSLoadBalancerControllerRole的IAM角色并关联新建的名称为AWSLoadBalancerControllerIAMPolicy的策略 2.在k8s的kube-systemnamespace下创建了一个名称为aws-load-balancer-controller的ServiceAccount 123$ k get sa -n kube-system aws-load-balancer-controllerNAME SECRETS AGEaws-load-balancer-controller 0 9d 3.在名称为AmazonEKSLoadBalancerControllerRole的IAM角色的信任关系中指定认证方式为OIDC，并且关联名称为aws-load-balancer-controller的ServiceAccount。 4.在名称为aws-load-balancer-controller的ServiceAccount中关联上面的角色AmazonEKSLoadBalancerControllerRole，就是添加注释eks.amazonaws.com/role-arn: arn:aws:iam::743263909644:role/AmazonEKSLoadBalancerControll。 12345678910111213$ k edit sa -n kube-system aws-load-balancer-controllerapiVersion: v1kind: ServiceAccountmetadata:annotations: eks.amazonaws.com/role-arn: arn:aws:iam::743263909644:role/AmazonEKSLoadBalancerControllcreationTimestamp: &quot;2023-07-04T09:20:41Z&quot;labels: app.kubernetes.io/managed-by: eksctlname: aws-load-balancer-controllernamespace: kube-systemresourceVersion: &quot;1707669&quot;uid: 857200a6-2e16-4939-bbbc-483dd579acbb 然后在创建Pod时，为Pod指定serviceAccountName: aws-load-balancer-controller 默认情况下，在 Kubernetes 中启动的 Pod 不会以 root 用户身份运行，所以在使用基于 OIDC 的身份认证时，当以非 root 用户运行容器时，可以使用 fsGroup 来指定一个组 ID（group ID），以便容器中的用户具有访问 Web Identity Token 文件的权限。在 Amazon EKS 中，可以将 fsGroup 设置为 65534。这是 Kubernetes 中的推荐做法，因为这个值对应于 nobody 用户和 nogroup 组的 ID。使用 fsGroup: 65534 将确保容器中的非 root 用户具有适当的权限来访问 Web Identity Token 文件，确保容器中的用户具有访问 /var/run/secrets/eks.amazonaws.com/serviceaccount/token 文件的权限。 1$ kubectl edit deployment -n kube-system aws-load-balancer-controller 使用aws命令创建角色并关联SA 创建Policy 1234567$ curl -O https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/v2.4.7/docs/install/iam_policy.json# 使用上一步中下载的策略创建一个 IAM policy$ aws iam create-policy \\ --profile eks-us-west-2 \\ --policy-name AWSLoadBalancerControllerIAMPolicy \\ --policy-document file://iam_policy.json 创建trust-policy.json，用于描述IAM Role的信任关系 123456789101112131415161718&#123; &quot;Version&quot;: &quot;2012-10-17&quot;, &quot;Statement&quot;: [ &#123; &quot;Effect&quot;: &quot;Allow&quot;, &quot;Principal&quot;: &#123; &quot;Federated&quot;: &quot;arn:aws:iam::743263909644:oidc-provider/oidc.eks.us-west-2.amazonaws.com/id/1029FF88CB872B6B7A1CC65D44191A56&quot; &#125;, &quot;Action&quot;: &quot;sts:AssumeRoleWithWebIdentity&quot;, &quot;Condition&quot;: &#123; &quot;StringEquals&quot;: &#123; &quot;oidc.eks.us-west-2.amazonaws.com/id/1029FF88CB872B6B7A1CC65D44191A56:aud&quot;: &quot;sts.amazonaws.com&quot;, &quot;oidc.eks.us-west-2.amazonaws.com/id/1029FF88CB872B6B7A1CC65D44191A56:sub&quot;: &quot;system:serviceaccount:kube-system:aws-load-balancer-controller&quot; &#125; &#125; &#125; ]&#125; 上述配置中的 “Condition” 部分是用于在 IAM 角色的信任策略中定义条件。该条件会限制什么样的令牌可以被信任并用于角色的身份验证和授权。 具体来说，“Condition” 对象中的 “StringEquals” 表示字符串相等的条件比较。它包含两个键值对，每个键值对都描述了一个条件。 “oidc.eks.us-west-2.amazonaws.com/id/1029FF88CB872B6B7A1CC65D44191A56:aud”: “sts.amazonaws.com”：这个条件表示 OIDC 令牌中的 “aud”（受众）字段必须与 “sts.amazonaws.com” 相等。也就是说，令牌的受众必须是 AWS Security Token Service (STS)。 “oidc.eks.us-west-2.amazonaws.com/id/1029FF88CB872B6B7A1CC65D44191A56:sub”: “system:serviceaccount:kube-system:aws-load-balancer-controller”：这个条件表示 OIDC 令牌中的 “sub”（主题）字段必须与 “system:serviceaccount:kube-system:aws-load-balancer-controller” 相等。也就是说，令牌的主题必须是 kube-system 命名空间下的 aws-load-balancer-controller Service Account。 这些条件的目的是确保只有满足这两个条件的 OIDC 令牌才能被信任，并被用于通过 OIDC 进行的身份验证和授权操作。这样可以限制对角色的访问，仅允许特定的 OIDC 令牌来获取访问权限。 创建 IAM Role 1234$ aws iam create-role \\ --profile eks-us-west-2 \\ --role-name AmazonEKSLoadBalancerControllerRole \\ --assume-role-policy-document file://&quot;trust-policy.json&quot; 为 Role 添加 Policy 1234$ aws iam attach-role-policy \\ --profile eks-us-west-2 \\ --policy-arn arn:aws:iam::743263909644:policy/AWSLoadBalancerControllerIAMPolicy \\ --role-name AmazonEKSLoadBalancerControllerRole 创建SA 1$ kubectl create serviceaccount aws-load-balancer-controller -n kube-system 为SA绑定IAM Role 123$ kubectl annotate serviceaccount aws-load-balancer-controller \\ -n kube-system \\ eks.amazonaws.com/role-arn=arn:aws:iam::743263909644:role/AmazonEKSLoadBalancerControllerRole 动手实践 搞明白了上面的原理，我们只需要按照上面那的步骤做就可以了，接下来就以Pod访问S3为例进行说明。 创建新的策略或使用现有策略，这里我们使用已有的策略arn:aws:iam::aws:policy/AmazonS3FullAccess 使用eksctl create iamserviceaccount创建Service和IAM Role，并将它们进行绑定关联 123456789101112131415161718192021222324252627282930$ eksctl create iamserviceaccount \\ --cluster=eks-lexing \\ --namespace=test \\ --name=test-s3-sa-new \\ --role-name TestS3Role \\ --attach-policy-arn=arn:aws:iam::aws:policy/AmazonS3FullAccess \\ --approve2023-07-13 19:59:18 [ℹ] 6 existing iamserviceaccount(s) (kube-system/aws-load-balancer-controller,kube-system/aws-node,kube-system/ebs-csi-controller-sa,kube-system/efs-csi-controller-sa,test/test-s3-sa,test/testS3SA) will be excluded2023-07-13 19:59:18 [ℹ] 1 iamserviceaccount (test/test-s3-sa-new) was included (based on the include/exclude rules)2023-07-13 19:59:18 [!] serviceaccounts that exist in Kubernetes will be excluded, use --override-existing-serviceaccounts to override2023-07-13 19:59:18 [ℹ] 1 task: &#123; 2 sequential sub-tasks: &#123; create IAM role for serviceaccount &quot;test/test-s3-sa-new&quot;, create serviceaccount &quot;test/test-s3-sa-new&quot;, &#125; &#125;2023-07-13 19:59:18 [ℹ] building iamserviceaccount stack &quot;eksctl-eks-lexing-addon-iamserviceaccount-test-test-s3-sa-new&quot;2023-07-13 19:59:18 [ℹ] deploying stack &quot;eksctl-eks-lexing-addon-iamserviceaccount-test-test-s3-sa-new&quot;2023-07-13 19:59:19 [ℹ] waiting for CloudFormation stack &quot;eksctl-eks-lexing-addon-iamserviceaccount-test-test-s3-sa-new&quot;2023-07-13 19:59:50 [ℹ] waiting for CloudFormation stack &quot;eksctl-eks-lexing-addon-iamserviceaccount-test-test-s3-sa-new&quot;2023-07-13 19:59:51 [ℹ] created serviceaccount &quot;test/test-s3-sa-new&quot;# 查看sa，确认是否已关联IAM Role$ k describe sa test-s3-sa-newName: test-s3-sa-newNamespace: testLabels: app.kubernetes.io/managed-by=eksctlAnnotations: eks.amazonaws.com/role-arn: arn:aws:iam::743263909644:role/TestS3RoleImage pull secrets: &lt;none&gt;Mountable secrets: &lt;none&gt;Tokens: &lt;none&gt;Events: &lt;none&gt; 创建一个已经安装过AWS CLI的Pod，这里镜像就使用amazon/aws-cli，注意要指定serviceAccountName: test-s3-sa-new 123456789101112131415161718192021222324apiVersion: apps/v1kind: Deploymentmetadata: name: deployment-test-s3-saspec: selector: matchLabels: app.kubernetes.io/name: app-test-s3-sa replicas: 1 template: metadata: labels: app.kubernetes.io/name: app-test-s3-sa spec: serviceAccountName: test-s3-sa-new containers: - image: amazon/aws-cli imagePullPolicy: Always name: app-test-s3-sa ports: - containerPort: 80 command: [&quot;/bin/sh&quot;, &quot;-c&quot;] args: - tail -f /dev/null 1234567891011121314151617181920# 部署$ k apply -f testS3SA.yamldeployment.apps/deployment-test-s3-sa created# 进入pod$ k exec -it deployment-test-s3-sa-5bd985845d-mqjjp -- bash# 查看当前的AWS用户信息，可以看到这里关联的是一个临时用户，但是从Arn中也能看出来其关联的角色 TestS3Rolebash-4.2# aws sts get-caller-identity&#123; &quot;UserId&quot;: &quot;AROA22DP3G4GNBLHPZBAM:botocore-session-1689250618&quot;, &quot;Account&quot;: &quot;743263909644&quot;, &quot;Arn&quot;: &quot;arn:aws:sts::743263909644:assumed-role/TestS3Role/botocore-session-1689250618&quot;&#125;# 查看s3存储桶列表，查询成功，说明当前pod已经具备的访问AWS S3资源的权限bash-4.2# aws s3 ls2023-07-10 09:34:45 lexing-helm-charts# 查看环境变量bash-4.2# echo $AWS_ROLE_ARNarn:aws:iam::743263909644:role/TestS3Rolebash-4.2# echo $AWS_WEB_IDENTITY_TOKEN_FILE/var/run/secrets/eks.amazonaws.com/serviceaccount/token","summary":"摘要 本文介绍为EKS集群的 Pod 调用 AWS 资源的方法 参考资料： Amazon EKS用户指南 Kubernetes 文档","date_published":"2023-07-13T12:30:05.000Z","tags":["技术","aws","eks","java"]},{"id":"https://blog.hanqunfeng.com/2023/07/10/aws-eks14-helm/","url":"https://blog.hanqunfeng.com/2023/07/10/aws-eks14-helm/","title":"AWS-EKS-14--Helm","content_html":"<!--\n **加粗**\n *斜体*\n ***加粗并斜体***\n ~~删除线~~\n ==突出显示==\n `突出显示(推荐)`\n ++下划线++\n ~下标~\n ^上标^\n 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.\n 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600)\n\n +++ **点击折叠**\n 这是被隐藏的内容\n +++\n\n::: tips success warning danger\n这里是容器内的内容\n:::\n\n% note info % success warning danger\n这里是容器内的内容\n% endnote %\n\n -->\n<h2 id=\"摘要\">摘要</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>本文介绍为Helm的使用方法</p>\n</li>\n<li class=\"lvl-2\">\n<p>参考资料：</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\"><a href=\"https://docs.aws.amazon.com/zh_cn/eks/latest/userguide\">Amazon EKS用户指南</a></li>\n<li class=\"lvl-6\"><a href=\"https://kubernetes.io/zh-cn/docs/home/\">Kubernetes 文档</a></li>\n</ul>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"Helm\">Helm</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><a href=\"https://helm.sh/zh/docs/\">官网文档</a></p>\n</li>\n<li class=\"lvl-2\">\n<p>Helm 是 Kubernetes 的包管理器，类似于 Linux 下的包管理工具如 yum、apt 等。可以方便的将之前打包好的 yaml 文件部署到 Kunernetes 上。</p>\n</li>\n</ul>\n<h3 id=\"为什么要引入-Helm\">为什么要引入 Helm</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>在以往的应用部署过程当中，我们需要先编写一个 yaml 文件，然后该文件中包含 deployment、Service、Ingress 等等。</p>\n</li>\n<li class=\"lvl-2\">\n<p>如果说需要部署的是单一、少数服务的应用，那么完全可以使用 yaml 文件的方式，这样会很简单。但是在实际的项目当中，微服务的数量基本不可能是一个，可能是几十个，如果说再用 yaml 文件的部署方式，那就意味着需要编写几十个 yaml 文件，这就会导致 数量多、维护难 等诸多问题。</p>\n</li>\n<li class=\"lvl-2\">\n<p>针对上述问题，Helm 的引入使用则可以将所有的 yaml 文件进行一个整体的管理，而且它能够实现 yaml 文件的高效复用。</p>\n</li>\n<li class=\"lvl-2\">\n<p>Helm 具备如下的能力：<br>\n简化部署 ：Helm允许使用单个命令轻松部署和管理应用程序，从而简化了整个部署过程；<br>\n高度可配置：Helm Charts提供了高度可配置的选项，可以轻松自定义和修改应用程序的部署配置；<br>\n版本控制 ：Helm允许管理应用程序的多个版本，从而轻松实现版本控制和回滚；<br>\n模板化：Helm Charts使用YAML模板来定义Kubernetes对象的配置，从而简化了配置过程，并提高了可重复性和可扩展性；<br>\n应用程序库：Helm具有应用程序库的概念，可以轻松地共享和重用Helm Charts，从而简化了多个应用程序的部署和管理；<br>\n插件系统：Helm拥有一个强大的插件系统，允许您扩展和定制Helm的功能，以满足特定的需求和要求。</p>\n</li>\n</ul>\n<h3 id=\"核心概念\">核心概念</h3>\n<table>\n<thead>\n<tr>\n<th>概念</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Chart</td>\n<td>一个Helm包，其中包含了运行一个应用所需要的镜像、依赖和资源定义等，还可能包含Kubernetes集群中的服务定义，类似Homebrew中的formula、APT的dpkg或者Yum的rpm文件</td>\n</tr>\n<tr>\n<td>Repository</td>\n<td>存储Helm Charts的地方</td>\n</tr>\n<tr>\n<td>Release</td>\n<td>Chart在k8s上运行的Chart的一个实例，例如，如果一个MySQL Chart想在服务器上运行两个数据库，可以将这个Chart安装两次，并在每次安装中生成自己的Release以及Release名称。</td>\n</tr>\n<tr>\n<td>Value</td>\n<td>Helm Chart的参数，用于配置Kubernetes对象</td>\n</tr>\n<tr>\n<td>Template</td>\n<td>使用Go模板语言生成Kubernetes对象的定义文件</td>\n</tr>\n<tr>\n<td>Namespace</td>\n<td>Kubernetes中用于隔离资源的逻辑分区</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"Helm的基本使用\">Helm的基本使用</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>当您已经安装好了Helm之后，您可以添加一个chart 仓库。从 <a href=\"https://artifacthub.io/packages/search?kind=0\">Artifact Hub</a> 中查找有效的Helm chart仓库。</p>\n</li>\n<li class=\"lvl-2\">\n<p>另外常用的仓库有<a href=\"https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts\">阿里云</a>、<a href=\"http://mirror.azure.cn/kubernetes/charts/\">微软</a></p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 添加仓库</span></span><br><span class=\"line\"><span class=\"comment\"># 语法 ：helm repo add 仓库名称 仓库地址</span></span><br><span class=\"line\"><span class=\"comment\"># 添加 eks-charts 存储库</span></span><br><span class=\"line\">$ helm repo add eks https://aws.github.io/eks-charts</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 更新指定仓库索引，以确保您拥有最新的图表</span></span><br><span class=\"line\">$ helm repo update eks</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 更新全部仓库索引</span></span><br><span class=\"line\">$ helm repo update</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看已经添加的仓库</span></span><br><span class=\"line\">$ helm repo list</span><br><span class=\"line\">NAME              \tURL</span><br><span class=\"line\">eks               \thttps://aws.github.io/eks-charts</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 搜索，默认展示最新的版本</span></span><br><span class=\"line\">$ helm search repo load-balancer</span><br><span class=\"line\">NAME                            \tCHART VERSION\tAPP VERSION\tDESCRIPTION</span><br><span class=\"line\">eks/aws-load-balancer-controller\t1.5.4        \tv2.5.3     \tAWS Load Balancer Controller Helm chart <span class=\"keyword\">for</span> Kub...</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 搜索全部版本</span></span><br><span class=\"line\">$ helm search repo load-balancer -l</span><br><span class=\"line\">NAME                            \tCHART VERSION\tAPP VERSION\tDESCRIPTION</span><br><span class=\"line\">eks/aws-load-balancer-controller\t1.5.4        \tv2.5.3     \tAWS Load Balancer Controller Helm chart <span class=\"keyword\">for</span> Kub...</span><br><span class=\"line\">eks/aws-load-balancer-controller\t1.5.3        \tv2.5.2     \tAWS Load Balancer Controller Helm chart <span class=\"keyword\">for</span> Kub...</span><br><span class=\"line\">eks/aws-load-balancer-controller\t1.5.2        \tv2.5.1     \tAWS Load Balancer Controller Helm chart <span class=\"keyword\">for</span> Kub...</span><br><span class=\"line\">eks/aws-load-balancer-controller\t1.5.1        \tv2.5.1     \tAWS Load Balancer Controller Helm chart <span class=\"keyword\">for</span> Kub...</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 在全部版本中搜索大于等于指定版本</span></span><br><span class=\"line\">$ helm search repo load-balancer --version ^1.5.1 -l</span><br><span class=\"line\">NAME                            \tCHART VERSION\tAPP VERSION\tDESCRIPTION</span><br><span class=\"line\">eks/aws-load-balancer-controller\t1.5.4        \tv2.5.3     \tAWS Load Balancer Controller Helm chart <span class=\"keyword\">for</span> Kub...</span><br><span class=\"line\">eks/aws-load-balancer-controller\t1.5.3        \tv2.5.2     \tAWS Load Balancer Controller Helm chart <span class=\"keyword\">for</span> Kub...</span><br><span class=\"line\">eks/aws-load-balancer-controller\t1.5.2        \tv2.5.1     \tAWS Load Balancer Controller Helm chart <span class=\"keyword\">for</span> Kub...</span><br><span class=\"line\">eks/aws-load-balancer-controller\t1.5.1        \tv2.5.1     \tAWS Load Balancer Controller Helm chart <span class=\"keyword\">for</span> Kub...</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 安装 AWS Load Balancer Controller 的最新版本，--set指定Values</span></span><br><span class=\"line\">$ helm install aws-load-balancer-controller eks/aws-load-balancer-controller \\</span><br><span class=\"line\">  -n kube-system \\</span><br><span class=\"line\">  --<span class=\"built_in\">set</span> clusterName=eks-lexing \\</span><br><span class=\"line\">  --<span class=\"built_in\">set</span> serviceAccount.create=<span class=\"literal\">false</span> \\</span><br><span class=\"line\">  --<span class=\"built_in\">set</span> serviceAccount.name=aws-load-balancer-controller</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 安装 AWS Load Balancer Controller 的指定版本，--version 1.5.4</span></span><br><span class=\"line\">$ helm install aws-load-balancer-controller eks/aws-load-balancer-controller \\</span><br><span class=\"line\">  -n kube-system \\</span><br><span class=\"line\">  --<span class=\"built_in\">set</span> clusterName=eks-lexing \\</span><br><span class=\"line\">  --<span class=\"built_in\">set</span> serviceAccount.create=<span class=\"literal\">false</span> \\</span><br><span class=\"line\">  --<span class=\"built_in\">set</span> serviceAccount.name=aws-load-balancer-controller</span><br><span class=\"line\">  --version 1.5.4</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看全部命名空间下已经安装的包</span></span><br><span class=\"line\">$ helm list --all-namespaces</span><br><span class=\"line\">NAME                        \tNAMESPACE  \tREVISION\tUPDATED                             \tSTATUS  \tCHART                             \tAPP VERSION</span><br><span class=\"line\">aws-load-balancer-controller\tkube-system\t2       \t2023-07-04 17:31:37.839466 +0800 CST\tdeployed\taws-load-balancer-controller-1.5.4\tv2.5.3</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看指定命名空间下已经安装的包</span></span><br><span class=\"line\">$ helm list -n kube-system</span><br><span class=\"line\"><span class=\"comment\"># 关键字过滤</span></span><br><span class=\"line\">$ helm list -n kube-system --filter load-balancer</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 获取Values，用户指定的，即安装或升级时通过--set等方式设置的</span></span><br><span class=\"line\">$ helm get values aws-load-balancer-controller -n kube-system</span><br><span class=\"line\">USER-SUPPLIED VALUES:</span><br><span class=\"line\">clusterName: eks-lexing</span><br><span class=\"line\">serviceAccount:</span><br><span class=\"line\">  create: <span class=\"literal\">false</span></span><br><span class=\"line\">  name: aws-load-balancer-controller</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 获取Values，全部Values，都可以进行替换</span></span><br><span class=\"line\">$ helm get values aws-load-balancer-controller -n kube-system --all</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 升级安装，升级时只需要指定要改变的部分</span></span><br><span class=\"line\">$ helm upgrade aws-load-balancer-controller eks/aws-load-balancer-controller \\</span><br><span class=\"line\">  -n kube-system \\</span><br><span class=\"line\">  --<span class=\"built_in\">set</span> clusterName=eks-lexing \\</span><br><span class=\"line\">  --<span class=\"built_in\">set</span> serviceAccount.create=<span class=\"literal\">false</span> \\</span><br><span class=\"line\">  --<span class=\"built_in\">set</span> serviceAccount.name=aws-load-balancer-controller</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看历史安装记录</span></span><br><span class=\"line\">$ helm <span class=\"built_in\">history</span> -n kube-system aws-load-balancer-controller</span><br><span class=\"line\">REVISION\tUPDATED                 \tSTATUS    \tCHART                             \tAPP VERSION\tDESCRIPTION</span><br><span class=\"line\">1       \tTue Jul  4 17:26:05 2023\tsuperseded\taws-load-balancer-controller-1.5.4\tv2.5.3     \tInstall complete</span><br><span class=\"line\">2       \tTue Jul  4 17:31:37 2023\tdeployed  \taws-load-balancer-controller-1.5.4\tv2.5.3     \tUpgrade complete</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 回滚到指定修订号，修订号通过 helm history 查看</span></span><br><span class=\"line\">$ helm rollback -n kube-system aws-load-balancer-controller 1</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 显示已命名发布的状态</span></span><br><span class=\"line\">$ helm status -n kube-system aws-load-balancer-controller</span><br><span class=\"line\">NAME: aws-load-balancer-controller</span><br><span class=\"line\">LAST DEPLOYED: Tue Jul  4 17:31:37 2023</span><br><span class=\"line\">NAMESPACE: kube-system</span><br><span class=\"line\">STATUS: deployed</span><br><span class=\"line\">REVISION: 2</span><br><span class=\"line\">TEST SUITE: None</span><br><span class=\"line\">NOTES:</span><br><span class=\"line\">AWS Load Balancer controller installed!</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 卸载</span></span><br><span class=\"line\">$ helm uninstall aws-load-balancer-controller -n kube-system</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 删除仓库</span></span><br><span class=\"line\">$ helm repo remove eks</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看helm客户端环境信息</span></span><br><span class=\"line\">$ helm <span class=\"built_in\">env</span></span><br><span class=\"line\">HELM_BIN=<span class=\"string\">&quot;helm&quot;</span></span><br><span class=\"line\">HELM_BURST_LIMIT=<span class=\"string\">&quot;100&quot;</span></span><br><span class=\"line\">HELM_CACHE_HOME=<span class=\"string\">&quot;/Users/hanqf/Library/Caches/helm&quot;</span></span><br><span class=\"line\">HELM_CONFIG_HOME=<span class=\"string\">&quot;/Users/hanqf/Library/Preferences/helm&quot;</span></span><br><span class=\"line\">HELM_DATA_HOME=<span class=\"string\">&quot;/Users/hanqf/Library/helm&quot;</span></span><br><span class=\"line\">HELM_DEBUG=<span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">HELM_KUBEAPISERVER=<span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">HELM_KUBEASGROUPS=<span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">HELM_KUBEASUSER=<span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">HELM_KUBECAFILE=<span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">HELM_KUBECONTEXT=<span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">HELM_KUBEINSECURE_SKIP_TLS_VERIFY=<span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">HELM_KUBETLS_SERVER_NAME=<span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">HELM_KUBETOKEN=<span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">HELM_MAX_HISTORY=<span class=\"string\">&quot;10&quot;</span></span><br><span class=\"line\">HELM_NAMESPACE=<span class=\"string\">&quot;test&quot;</span></span><br><span class=\"line\">HELM_PLUGINS=<span class=\"string\">&quot;/Users/hanqf/Library/helm/plugins&quot;</span></span><br><span class=\"line\">HELM_REGISTRY_CONFIG=<span class=\"string\">&quot;/Users/hanqf/Library/Preferences/helm/registry/config.json&quot;</span></span><br><span class=\"line\">HELM_REPOSITORY_CACHE=<span class=\"string\">&quot;/Users/hanqf/Library/Caches/helm/repository&quot;</span></span><br><span class=\"line\">HELM_REPOSITORY_CONFIG=<span class=\"string\">&quot;/Users/hanqf/Library/Preferences/helm/repositories.yaml&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 展示指定chart的全部信息 （values.yaml, Chart.yaml, README）</span></span><br><span class=\"line\">$ helm show all eks/aws-load-balancer-controller</span><br><span class=\"line\"><span class=\"comment\"># 只展示chart.yaml</span></span><br><span class=\"line\">$ helm show chart eks/aws-load-balancer-controller</span><br><span class=\"line\"><span class=\"comment\"># 只展示values.yaml</span></span><br><span class=\"line\">$ helm show values eks/aws-load-balancer-controller</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#下载指定的包，这里会下载 aws-load-balancer-controller-1.5.4.tgz</span></span><br><span class=\"line\">$ helm pull eks/aws-load-balancer-controller</span><br><span class=\"line\"><span class=\"comment\"># 下载并解压到指定目录</span></span><br><span class=\"line\">$ helm pull eks/aws-load-balancer-controller --untar --untardir ./</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"自定义-Chart-部署应用\">自定义 Chart 部署应用</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 创建一个chart</span></span><br><span class=\"line\">$ helm create mychart</span><br><span class=\"line\">Creating mychart</span><br><span class=\"line\"></span><br><span class=\"line\">$ <span class=\"built_in\">ls</span></span><br><span class=\"line\">mychart</span><br><span class=\"line\"></span><br><span class=\"line\">$ exa -T mychart</span><br><span class=\"line\">mychart</span><br><span class=\"line\">├── Chart.yaml</span><br><span class=\"line\">├── charts</span><br><span class=\"line\">├── templates</span><br><span class=\"line\">│  ├── _helpers.tpl</span><br><span class=\"line\">│  ├── deployment.yaml</span><br><span class=\"line\">│  ├── hpa.yaml</span><br><span class=\"line\">│  ├── ingress.yaml</span><br><span class=\"line\">│  ├── NOTES.txt</span><br><span class=\"line\">│  ├── service.yaml</span><br><span class=\"line\">│  ├── serviceaccount.yaml</span><br><span class=\"line\">│  └── tests</span><br><span class=\"line\">│     └── test-connection.yaml</span><br><span class=\"line\">└── values.yaml</span><br></pre></td></tr></table></figure>\n<table>\n<thead>\n<tr>\n<th>文件</th>\n<th>含义</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>charts</td>\n<td>一个普通的空文件，一般也不会写入内容</td>\n</tr>\n<tr>\n<td>Chart.yaml</td>\n<td>当前 chart 属性的配置信息</td>\n</tr>\n<tr>\n<td>templates</td>\n<td>自己定义的 yaml 文件存于此</td>\n</tr>\n<tr>\n<td>values.yaml</td>\n<td>定义 yaml 文件的全局配置</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Chart.yaml: 包含Chart的元数据和依赖项</p>\n</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">chart</span> <span class=\"string\">API</span> <span class=\"string\">版本</span> <span class=\"string\">（必需）</span>  <span class=\"comment\">#必须有</span></span><br><span class=\"line\"><span class=\"attr\">name:</span> <span class=\"string\">chart名称</span> <span class=\"string\">（必需）</span>     <span class=\"comment\"># 必须有</span></span><br><span class=\"line\"><span class=\"attr\">version:</span> <span class=\"string\">指定</span> <span class=\"string\">chart</span> <span class=\"string\">版本（必需），打包时的版本号</span> <span class=\"comment\"># 必须有</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">kubeVersion:</span> <span class=\"string\">兼容Kubernetes版本的语义化版本（可选）</span></span><br><span class=\"line\"><span class=\"attr\">description:</span> <span class=\"string\">一句话对这个项目的描述（可选）</span></span><br><span class=\"line\"><span class=\"attr\">type:</span> <span class=\"string\">chart类型</span> <span class=\"string\">（可选）</span></span><br><span class=\"line\"><span class=\"attr\">keywords:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">关于项目的一组关键字（可选）</span></span><br><span class=\"line\"><span class=\"attr\">home:</span> <span class=\"string\">项目home页面的URL</span> <span class=\"string\">（可选）</span></span><br><span class=\"line\"><span class=\"attr\">sources:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">项目源码的URL列表（可选）</span></span><br><span class=\"line\"><span class=\"attr\">dependencies:</span> <span class=\"comment\"># chart 依赖列表 （可选）</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">chart名称</span> <span class=\"string\">(nginx)</span></span><br><span class=\"line\">    <span class=\"attr\">version:</span> <span class=\"string\">chart版本</span> <span class=\"string\">(&quot;1.2.3&quot;)</span></span><br><span class=\"line\">    <span class=\"attr\">repository:</span> <span class=\"string\">（可选）仓库URL</span> <span class=\"string\">(&quot;https://example.com/charts&quot;)</span> <span class=\"string\">或别名</span> <span class=\"string\">(&quot;@repo-name&quot;)</span></span><br><span class=\"line\">    <span class=\"attr\">condition:</span> <span class=\"string\">（可选）</span> <span class=\"string\">解析为布尔值的yaml路径，用于启用/禁用chart</span> <span class=\"string\">(e.g.</span> <span class=\"string\">subchart1.enabled</span> <span class=\"string\">)</span></span><br><span class=\"line\">    <span class=\"attr\">tags:</span> <span class=\"comment\"># （可选）</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">用于一次启用/禁用</span> <span class=\"string\">一组chart的tag</span></span><br><span class=\"line\">    <span class=\"attr\">import-values:</span> <span class=\"comment\"># （可选）</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">ImportValue</span> <span class=\"string\">保存源值到导入父键的映射。每项可以是字符串或者一对子/父列表项</span></span><br><span class=\"line\">    <span class=\"attr\">alias:</span> <span class=\"string\">（可选）</span> <span class=\"string\">chart中使用的别名。当你要多次添加相同的chart时会很有用</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">maintainers:</span> <span class=\"comment\"># （可选） # 可能用到</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">维护者名字</span> <span class=\"string\">（每个维护者都需要）</span></span><br><span class=\"line\">    <span class=\"attr\">email:</span> <span class=\"string\">维护者邮箱</span> <span class=\"string\">（每个维护者可选）</span></span><br><span class=\"line\">    <span class=\"attr\">url:</span> <span class=\"string\">维护者URL</span> <span class=\"string\">（每个维护者可选）</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">icon:</span> <span class=\"string\">用做icon的SVG或PNG图片URL</span> <span class=\"string\">（可选）</span></span><br><span class=\"line\"><span class=\"attr\">appVersion:</span> <span class=\"string\">包含的应用版本（可选）。不需要是语义化，建议使用引号</span></span><br><span class=\"line\"><span class=\"attr\">deprecated:</span> <span class=\"string\">不被推荐的chart</span> <span class=\"string\">（可选，布尔值）</span></span><br><span class=\"line\"><span class=\"attr\">annotations:</span></span><br><span class=\"line\">  <span class=\"attr\">example:</span> <span class=\"string\">按名称输入的批注列表</span> <span class=\"string\">（可选）.</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>示例：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v2</span></span><br><span class=\"line\"><span class=\"attr\">name:</span> <span class=\"string\">mychart</span></span><br><span class=\"line\"><span class=\"attr\">description:</span> <span class=\"string\">A</span> <span class=\"string\">Helm</span> <span class=\"string\">chart</span> <span class=\"string\">for</span> <span class=\"string\">Kubernetes</span></span><br><span class=\"line\"><span class=\"attr\">version:</span> <span class=\"number\">0.1</span><span class=\"number\">.0</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>values.yaml: 包含应用程序的默认配置值，如下示例：</p>\n</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">image:</span></span><br><span class=\"line\">  <span class=\"attr\">repository:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">  <span class=\"attr\">tag:</span> <span class=\"string\">&#x27;1.19.8&#x27;</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>templates: 模板文件，各种k8s资源yaml，在模板文件中可以通过 .Values对象访问到 values.yaml里的配置<br>\n示例：我们可以依据需要创建各种k8s资源的yaml文件，这里为了演示方便，删除templates下全部文件，然后创建deployment.yaml</p>\n</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># deployment.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nginx-helm-&#123;&#123;</span> <span class=\"string\">.Values.image.repository</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">nginx-helm</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">nginx-helm</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">nginx-helm</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> &#123;&#123; <span class=\"string\">.Values.image.repository</span> &#125;&#125;<span class=\"string\">:&#123;&#123;</span> <span class=\"string\">.Values.image.tag</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">80</span></span><br><span class=\"line\">          <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>安装自定义Chart</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ helm install mychart mychart</span><br><span class=\"line\">NAME: mychart</span><br><span class=\"line\">LAST DEPLOYED: Mon Jul 10 16:36:13 2023</span><br><span class=\"line\">NAMESPACE: <span class=\"built_in\">test</span></span><br><span class=\"line\">STATUS: deployed</span><br><span class=\"line\">REVISION: 1</span><br><span class=\"line\">TEST SUITE: None</span><br><span class=\"line\"></span><br><span class=\"line\">$ helm list</span><br><span class=\"line\">NAME   \tNAMESPACE\tREVISION\tUPDATED                             \tSTATUS  \tCHART        \tAPP VERSION</span><br><span class=\"line\">mychart\t<span class=\"built_in\">test</span>     \t1       \t2023-07-10 16:36:13.707877 +0800 CST\tdeployed\tmychart-0.1.0</span><br><span class=\"line\"></span><br><span class=\"line\">$ k get deploy</span><br><span class=\"line\">NAME               READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class=\"line\">nginx-helm-nginx   1/1     1            1           94s</span><br><span class=\"line\"></span><br><span class=\"line\">$ k describe deploy nginx-helm-nginx | grep Image</span><br><span class=\"line\">    Image:        nginx:1.19.8</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>升级Chart<br>\n这里修改 values.yaml 中镜像的版本</p>\n</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">image:</span></span><br><span class=\"line\">  <span class=\"attr\">repository:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">  <span class=\"attr\">tag:</span> <span class=\"string\">&#x27;1.20.2&#x27;</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ upgrade mychart mychart</span><br><span class=\"line\">Release <span class=\"string\">&quot;mychart&quot;</span> has been upgraded. Happy Helming!</span><br><span class=\"line\">NAME: mychart</span><br><span class=\"line\">LAST DEPLOYED: Mon Jul 10 16:46:03 2023</span><br><span class=\"line\">NAMESPACE: <span class=\"built_in\">test</span></span><br><span class=\"line\">STATUS: deployed</span><br><span class=\"line\">REVISION: 2</span><br><span class=\"line\">TEST SUITE: None</span><br><span class=\"line\"></span><br><span class=\"line\">$ k describe deploy nginx-helm-nginx | grep Image</span><br><span class=\"line\">    Image:        nginx:1.20.2</span><br></pre></td></tr></table></figure>\n<h3 id=\"发布Chart\">发布Chart</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>需要一个Chart仓库，可以使用harbor构建私有仓库，我这里使用aws，所以就用S3作为Chart仓库。</p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://aws.amazon.com/cn/blogs/china/build-helm-chart-warehouse-based-on-aws-ecr-or-s3/\">基于 AWS ECR 或 S3 搭建 Helm Chart 仓库</a></p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 安装helm-S3插件</span></span><br><span class=\"line\">$ helm plugin install https://github.com/hypnoglow/helm-s3.git</span><br><span class=\"line\">Downloading and installing helm-s3 v0.14.0 ...</span><br><span class=\"line\">Checksum is valid.</span><br><span class=\"line\">Installed plugin: s3</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 指定操作s3的profile，因为helm不支持指定profile，所以这里可以使用环境变量的方式</span></span><br><span class=\"line\">$ <span class=\"built_in\">export</span> AWS_PROFILE=eks-us-west-2</span><br><span class=\"line\"><span class=\"comment\"># 初始化 S3 目录（假设名为 lexing-helm-charts 的S3存储桶已经存在）</span></span><br><span class=\"line\">$ helm s3 init s3://lexing-helm-charts/charts/</span><br><span class=\"line\">Initialized empty repository at s3://lexing-helm-charts/charts/</span><br><span class=\"line\"><span class=\"comment\"># 添加仓库到本地</span></span><br><span class=\"line\">$ helm repo add lexing-helm-charts s3://lexing-helm-charts/charts/</span><br><span class=\"line\"><span class=\"comment\"># 查看lexing-helm-charts repo是否已经添加到本地</span></span><br><span class=\"line\">$ helm repo list</span><br><span class=\"line\">NAME              \tURL</span><br><span class=\"line\">aws-efs-csi-driver\thttps://kubernetes-sigs.github.io/aws-efs-csi-driver/</span><br><span class=\"line\">eks               \thttps://aws.github.io/eks-charts</span><br><span class=\"line\">aliyun            \thttps://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts</span><br><span class=\"line\">lexing-helm-charts\ts3://lexing-helm-charts/charts/</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>打包Chart</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ helm package mychart</span><br><span class=\"line\">Successfully packaged chart and saved it to: /Users/hanqf/Desktop/k8sDir/helm-chart/mychart-0.1.0.tgz</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>chart 上传到 S3</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 指定操作s3的profile，因为helm不支持指定profile，所以这里可以使用环境变量的方式</span></span><br><span class=\"line\">$ <span class=\"built_in\">export</span> AWS_PROFILE=eks-us-west-2</span><br><span class=\"line\"><span class=\"comment\"># 推送my-nginx helm chart 到 S3</span></span><br><span class=\"line\">$ helm s3 push mychart-0.1.0.tgz lexing-helm-charts --force</span><br><span class=\"line\">Successfully uploaded the chart to the repository.</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>搜索chart并安装</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 搜索</span></span><br><span class=\"line\">$ helm search repo mychart</span><br><span class=\"line\">NAME                      \tCHART VERSION\tAPP VERSION\tDESCRIPTION</span><br><span class=\"line\">lexing-helm-charts/mychart\t0.1.0        \t           \tA Helm chart <span class=\"keyword\">for</span> Kubernetes</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 从Helm s3 repo 安装my-nginx chart到EKS/ Kubernetes集群</span></span><br><span class=\"line\">$ helm install mychart lexing-helm-charts/mychart</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 升级安装</span></span><br><span class=\"line\">$ helm upgrade mychart lexing-helm-charts/mychart --<span class=\"built_in\">set</span> image.tag=1.20.2</span><br></pre></td></tr></table></figure>\n<h2 id=\"Helm的执行安装顺序\">Helm的执行安装顺序</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Namespace</span><br><span class=\"line\">NetworkPolicy</span><br><span class=\"line\">ResourceQuota</span><br><span class=\"line\">LimitRange</span><br><span class=\"line\">PodSecurityPolicy</span><br><span class=\"line\">PodDisruptionBudget</span><br><span class=\"line\">ServiceAccount</span><br><span class=\"line\">Secret</span><br><span class=\"line\">SecretList</span><br><span class=\"line\">ConfigMap</span><br><span class=\"line\">StorageClass</span><br><span class=\"line\">PersistentVolume</span><br><span class=\"line\">PersistentVolumeClaim</span><br><span class=\"line\">CustomResourceDefinition</span><br><span class=\"line\">ClusterRole</span><br><span class=\"line\">ClusterRoleList</span><br><span class=\"line\">ClusterRoleBinding</span><br><span class=\"line\">ClusterRoleBindingList</span><br><span class=\"line\">Role</span><br><span class=\"line\">RoleList</span><br><span class=\"line\">RoleBinding</span><br><span class=\"line\">RoleBindingList</span><br><span class=\"line\">Service</span><br><span class=\"line\">DaemonSet</span><br><span class=\"line\">Pod</span><br><span class=\"line\">ReplicationController</span><br><span class=\"line\">ReplicaSet</span><br><span class=\"line\">Deployment</span><br><span class=\"line\">HorizontalPodAutoscaler</span><br><span class=\"line\">StatefulSet</span><br><span class=\"line\">Job</span><br><span class=\"line\">CronJob</span><br><span class=\"line\">Ingress</span><br><span class=\"line\">APIService</span><br></pre></td></tr></table></figure>\n","content_text":"摘要 本文介绍为Helm的使用方法 参考资料： Amazon EKS用户指南 Kubernetes 文档 Helm 官网文档 Helm 是 Kubernetes 的包管理器，类似于 Linux 下的包管理工具如 yum、apt 等。可以方便的将之前打包好的 yaml 文件部署到 Kunernetes 上。 为什么要引入 Helm 在以往的应用部署过程当中，我们需要先编写一个 yaml 文件，然后该文件中包含 deployment、Service、Ingress 等等。 如果说需要部署的是单一、少数服务的应用，那么完全可以使用 yaml 文件的方式，这样会很简单。但是在实际的项目当中，微服务的数量基本不可能是一个，可能是几十个，如果说再用 yaml 文件的部署方式，那就意味着需要编写几十个 yaml 文件，这就会导致 数量多、维护难 等诸多问题。 针对上述问题，Helm 的引入使用则可以将所有的 yaml 文件进行一个整体的管理，而且它能够实现 yaml 文件的高效复用。 Helm 具备如下的能力： 简化部署 ：Helm允许使用单个命令轻松部署和管理应用程序，从而简化了整个部署过程； 高度可配置：Helm Charts提供了高度可配置的选项，可以轻松自定义和修改应用程序的部署配置； 版本控制 ：Helm允许管理应用程序的多个版本，从而轻松实现版本控制和回滚； 模板化：Helm Charts使用YAML模板来定义Kubernetes对象的配置，从而简化了配置过程，并提高了可重复性和可扩展性； 应用程序库：Helm具有应用程序库的概念，可以轻松地共享和重用Helm Charts，从而简化了多个应用程序的部署和管理； 插件系统：Helm拥有一个强大的插件系统，允许您扩展和定制Helm的功能，以满足特定的需求和要求。 核心概念 概念 描述 Chart 一个Helm包，其中包含了运行一个应用所需要的镜像、依赖和资源定义等，还可能包含Kubernetes集群中的服务定义，类似Homebrew中的formula、APT的dpkg或者Yum的rpm文件 Repository 存储Helm Charts的地方 Release Chart在k8s上运行的Chart的一个实例，例如，如果一个MySQL Chart想在服务器上运行两个数据库，可以将这个Chart安装两次，并在每次安装中生成自己的Release以及Release名称。 Value Helm Chart的参数，用于配置Kubernetes对象 Template 使用Go模板语言生成Kubernetes对象的定义文件 Namespace Kubernetes中用于隔离资源的逻辑分区 Helm的基本使用 当您已经安装好了Helm之后，您可以添加一个chart 仓库。从 Artifact Hub 中查找有效的Helm chart仓库。 另外常用的仓库有阿里云、微软 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142# 添加仓库# 语法 ：helm repo add 仓库名称 仓库地址# 添加 eks-charts 存储库$ helm repo add eks https://aws.github.io/eks-charts# 更新指定仓库索引，以确保您拥有最新的图表$ helm repo update eks# 更新全部仓库索引$ helm repo update# 查看已经添加的仓库$ helm repo listNAME URLeks https://aws.github.io/eks-charts# 搜索，默认展示最新的版本$ helm search repo load-balancerNAME CHART VERSION APP VERSION DESCRIPTIONeks/aws-load-balancer-controller 1.5.4 v2.5.3 AWS Load Balancer Controller Helm chart for Kub...# 搜索全部版本$ helm search repo load-balancer -lNAME CHART VERSION APP VERSION DESCRIPTIONeks/aws-load-balancer-controller 1.5.4 v2.5.3 AWS Load Balancer Controller Helm chart for Kub...eks/aws-load-balancer-controller 1.5.3 v2.5.2 AWS Load Balancer Controller Helm chart for Kub...eks/aws-load-balancer-controller 1.5.2 v2.5.1 AWS Load Balancer Controller Helm chart for Kub...eks/aws-load-balancer-controller 1.5.1 v2.5.1 AWS Load Balancer Controller Helm chart for Kub...# 在全部版本中搜索大于等于指定版本$ helm search repo load-balancer --version ^1.5.1 -lNAME CHART VERSION APP VERSION DESCRIPTIONeks/aws-load-balancer-controller 1.5.4 v2.5.3 AWS Load Balancer Controller Helm chart for Kub...eks/aws-load-balancer-controller 1.5.3 v2.5.2 AWS Load Balancer Controller Helm chart for Kub...eks/aws-load-balancer-controller 1.5.2 v2.5.1 AWS Load Balancer Controller Helm chart for Kub...eks/aws-load-balancer-controller 1.5.1 v2.5.1 AWS Load Balancer Controller Helm chart for Kub...# 安装 AWS Load Balancer Controller 的最新版本，--set指定Values$ helm install aws-load-balancer-controller eks/aws-load-balancer-controller \\ -n kube-system \\ --set clusterName=eks-lexing \\ --set serviceAccount.create=false \\ --set serviceAccount.name=aws-load-balancer-controller# 安装 AWS Load Balancer Controller 的指定版本，--version 1.5.4$ helm install aws-load-balancer-controller eks/aws-load-balancer-controller \\ -n kube-system \\ --set clusterName=eks-lexing \\ --set serviceAccount.create=false \\ --set serviceAccount.name=aws-load-balancer-controller --version 1.5.4# 查看全部命名空间下已经安装的包$ helm list --all-namespacesNAME NAMESPACE REVISION UPDATED STATUS CHART APP VERSIONaws-load-balancer-controller kube-system 2 2023-07-04 17:31:37.839466 +0800 CST deployed aws-load-balancer-controller-1.5.4 v2.5.3# 查看指定命名空间下已经安装的包$ helm list -n kube-system# 关键字过滤$ helm list -n kube-system --filter load-balancer# 获取Values，用户指定的，即安装或升级时通过--set等方式设置的$ helm get values aws-load-balancer-controller -n kube-systemUSER-SUPPLIED VALUES:clusterName: eks-lexingserviceAccount: create: false name: aws-load-balancer-controller# 获取Values，全部Values，都可以进行替换$ helm get values aws-load-balancer-controller -n kube-system --all# 升级安装，升级时只需要指定要改变的部分$ helm upgrade aws-load-balancer-controller eks/aws-load-balancer-controller \\ -n kube-system \\ --set clusterName=eks-lexing \\ --set serviceAccount.create=false \\ --set serviceAccount.name=aws-load-balancer-controller# 查看历史安装记录$ helm history -n kube-system aws-load-balancer-controllerREVISION UPDATED STATUS CHART APP VERSION DESCRIPTION1 Tue Jul 4 17:26:05 2023 superseded aws-load-balancer-controller-1.5.4 v2.5.3 Install complete2 Tue Jul 4 17:31:37 2023 deployed aws-load-balancer-controller-1.5.4 v2.5.3 Upgrade complete# 回滚到指定修订号，修订号通过 helm history 查看$ helm rollback -n kube-system aws-load-balancer-controller 1# 显示已命名发布的状态$ helm status -n kube-system aws-load-balancer-controllerNAME: aws-load-balancer-controllerLAST DEPLOYED: Tue Jul 4 17:31:37 2023NAMESPACE: kube-systemSTATUS: deployedREVISION: 2TEST SUITE: NoneNOTES:AWS Load Balancer controller installed!# 卸载$ helm uninstall aws-load-balancer-controller -n kube-system# 删除仓库$ helm repo remove eks# 查看helm客户端环境信息$ helm envHELM_BIN=&quot;helm&quot;HELM_BURST_LIMIT=&quot;100&quot;HELM_CACHE_HOME=&quot;/Users/hanqf/Library/Caches/helm&quot;HELM_CONFIG_HOME=&quot;/Users/hanqf/Library/Preferences/helm&quot;HELM_DATA_HOME=&quot;/Users/hanqf/Library/helm&quot;HELM_DEBUG=&quot;false&quot;HELM_KUBEAPISERVER=&quot;&quot;HELM_KUBEASGROUPS=&quot;&quot;HELM_KUBEASUSER=&quot;&quot;HELM_KUBECAFILE=&quot;&quot;HELM_KUBECONTEXT=&quot;&quot;HELM_KUBEINSECURE_SKIP_TLS_VERIFY=&quot;false&quot;HELM_KUBETLS_SERVER_NAME=&quot;&quot;HELM_KUBETOKEN=&quot;&quot;HELM_MAX_HISTORY=&quot;10&quot;HELM_NAMESPACE=&quot;test&quot;HELM_PLUGINS=&quot;/Users/hanqf/Library/helm/plugins&quot;HELM_REGISTRY_CONFIG=&quot;/Users/hanqf/Library/Preferences/helm/registry/config.json&quot;HELM_REPOSITORY_CACHE=&quot;/Users/hanqf/Library/Caches/helm/repository&quot;HELM_REPOSITORY_CONFIG=&quot;/Users/hanqf/Library/Preferences/helm/repositories.yaml&quot;# 展示指定chart的全部信息 （values.yaml, Chart.yaml, README）$ helm show all eks/aws-load-balancer-controller# 只展示chart.yaml$ helm show chart eks/aws-load-balancer-controller# 只展示values.yaml$ helm show values eks/aws-load-balancer-controller#下载指定的包，这里会下载 aws-load-balancer-controller-1.5.4.tgz$ helm pull eks/aws-load-balancer-controller# 下载并解压到指定目录$ helm pull eks/aws-load-balancer-controller --untar --untardir ./ 自定义 Chart 部署应用 12345678910111213141516171819202122# 创建一个chart$ helm create mychartCreating mychart$ lsmychart$ exa -T mychartmychart├── Chart.yaml├── charts├── templates│ ├── _helpers.tpl│ ├── deployment.yaml│ ├── hpa.yaml│ ├── ingress.yaml│ ├── NOTES.txt│ ├── service.yaml│ ├── serviceaccount.yaml│ └── tests│ └── test-connection.yaml└── values.yaml 文件 含义 charts 一个普通的空文件，一般也不会写入内容 Chart.yaml 当前 chart 属性的配置信息 templates 自己定义的 yaml 文件存于此 values.yaml 定义 yaml 文件的全局配置 Chart.yaml: 包含Chart的元数据和依赖项 12345678910111213141516171819202122232425262728293031323334apiVersion: chart API 版本 （必需） #必须有name: chart名称 （必需） # 必须有version: 指定 chart 版本（必需），打包时的版本号 # 必须有kubeVersion: 兼容Kubernetes版本的语义化版本（可选）description: 一句话对这个项目的描述（可选）type: chart类型 （可选）keywords: - 关于项目的一组关键字（可选）home: 项目home页面的URL （可选）sources: - 项目源码的URL列表（可选）dependencies: # chart 依赖列表 （可选） - name: chart名称 (nginx) version: chart版本 (&quot;1.2.3&quot;) repository: （可选）仓库URL (&quot;https://example.com/charts&quot;) 或别名 (&quot;@repo-name&quot;) condition: （可选） 解析为布尔值的yaml路径，用于启用/禁用chart (e.g. subchart1.enabled ) tags: # （可选） - 用于一次启用/禁用 一组chart的tag import-values: # （可选） - ImportValue 保存源值到导入父键的映射。每项可以是字符串或者一对子/父列表项 alias: （可选） chart中使用的别名。当你要多次添加相同的chart时会很有用maintainers: # （可选） # 可能用到 - name: 维护者名字 （每个维护者都需要） email: 维护者邮箱 （每个维护者可选） url: 维护者URL （每个维护者可选）icon: 用做icon的SVG或PNG图片URL （可选）appVersion: 包含的应用版本（可选）。不需要是语义化，建议使用引号deprecated: 不被推荐的chart （可选，布尔值）annotations: example: 按名称输入的批注列表 （可选）. 示例： 1234apiVersion: v2name: mychartdescription: A Helm chart for Kubernetesversion: 0.1.0 values.yaml: 包含应用程序的默认配置值，如下示例： 123image: repository: nginx tag: &#x27;1.19.8&#x27; templates: 模板文件，各种k8s资源yaml，在模板文件中可以通过 .Values对象访问到 values.yaml里的配置 示例：我们可以依据需要创建各种k8s资源的yaml文件，这里为了演示方便，删除templates下全部文件，然后创建deployment.yaml 12345678910111213141516171819202122# deployment.yamlapiVersion: apps/v1kind: Deploymentmetadata: name: nginx-helm-&#123;&#123; .Values.image.repository &#125;&#125;spec: replicas: 1 selector: matchLabels: app: nginx-helm template: metadata: labels: app: nginx-helm spec: containers: - name: nginx-helm image: &#123;&#123; .Values.image.repository &#125;&#125;:&#123;&#123; .Values.image.tag &#125;&#125; ports: - containerPort: 80 protocol: TCP 安装自定义Chart 123456789101112131415161718$ helm install mychart mychartNAME: mychartLAST DEPLOYED: Mon Jul 10 16:36:13 2023NAMESPACE: testSTATUS: deployedREVISION: 1TEST SUITE: None$ helm listNAME NAMESPACE REVISION UPDATED STATUS CHART APP VERSIONmychart test 1 2023-07-10 16:36:13.707877 +0800 CST deployed mychart-0.1.0$ k get deployNAME READY UP-TO-DATE AVAILABLE AGEnginx-helm-nginx 1/1 1 1 94s$ k describe deploy nginx-helm-nginx | grep Image Image: nginx:1.19.8 升级Chart 这里修改 values.yaml 中镜像的版本 123image: repository: nginx tag: &#x27;1.20.2&#x27; 1234567891011$ upgrade mychart mychartRelease &quot;mychart&quot; has been upgraded. Happy Helming!NAME: mychartLAST DEPLOYED: Mon Jul 10 16:46:03 2023NAMESPACE: testSTATUS: deployedREVISION: 2TEST SUITE: None$ k describe deploy nginx-helm-nginx | grep Image Image: nginx:1.20.2 发布Chart 需要一个Chart仓库，可以使用harbor构建私有仓库，我这里使用aws，所以就用S3作为Chart仓库。 基于 AWS ECR 或 S3 搭建 Helm Chart 仓库 1234567891011121314151617181920# 安装helm-S3插件$ helm plugin install https://github.com/hypnoglow/helm-s3.gitDownloading and installing helm-s3 v0.14.0 ...Checksum is valid.Installed plugin: s3# 指定操作s3的profile，因为helm不支持指定profile，所以这里可以使用环境变量的方式$ export AWS_PROFILE=eks-us-west-2# 初始化 S3 目录（假设名为 lexing-helm-charts 的S3存储桶已经存在）$ helm s3 init s3://lexing-helm-charts/charts/Initialized empty repository at s3://lexing-helm-charts/charts/# 添加仓库到本地$ helm repo add lexing-helm-charts s3://lexing-helm-charts/charts/# 查看lexing-helm-charts repo是否已经添加到本地$ helm repo listNAME URLaws-efs-csi-driver https://kubernetes-sigs.github.io/aws-efs-csi-driver/eks https://aws.github.io/eks-chartsaliyun https://kubernetes.oss-cn-hangzhou.aliyuncs.com/chartslexing-helm-charts s3://lexing-helm-charts/charts/ 打包Chart 12$ helm package mychartSuccessfully packaged chart and saved it to: /Users/hanqf/Desktop/k8sDir/helm-chart/mychart-0.1.0.tgz chart 上传到 S3 12345# 指定操作s3的profile，因为helm不支持指定profile，所以这里可以使用环境变量的方式$ export AWS_PROFILE=eks-us-west-2# 推送my-nginx helm chart 到 S3$ helm s3 push mychart-0.1.0.tgz lexing-helm-charts --forceSuccessfully uploaded the chart to the repository. 搜索chart并安装 12345678910# 搜索$ helm search repo mychartNAME CHART VERSION APP VERSION DESCRIPTIONlexing-helm-charts/mychart 0.1.0 A Helm chart for Kubernetes# 从Helm s3 repo 安装my-nginx chart到EKS/ Kubernetes集群$ helm install mychart lexing-helm-charts/mychart# 升级安装$ helm upgrade mychart lexing-helm-charts/mychart --set image.tag=1.20.2 Helm的执行安装顺序 12345678910111213141516171819202122232425262728293031323334NamespaceNetworkPolicyResourceQuotaLimitRangePodSecurityPolicyPodDisruptionBudgetServiceAccountSecretSecretListConfigMapStorageClassPersistentVolumePersistentVolumeClaimCustomResourceDefinitionClusterRoleClusterRoleListClusterRoleBindingClusterRoleBindingListRoleRoleListRoleBindingRoleBindingListServiceDaemonSetPodReplicationControllerReplicaSetDeploymentHorizontalPodAutoscalerStatefulSetJobCronJobIngressAPIService","summary":"摘要 本文介绍为Helm的使用方法 参考资料： Amazon EKS用户指南 Kubernetes 文档","date_published":"2023-07-10T12:30:05.000Z","tags":["技术","aws","eks","java"]},{"id":"https://blog.hanqunfeng.com/2023/07/07/aws-eks13-kubectl/","url":"https://blog.hanqunfeng.com/2023/07/07/aws-eks13-kubectl/","title":"AWS-EKS-13--Kubectl","content_html":"<!--\n **加粗**\n *斜体*\n ***加粗并斜体***\n ~~删除线~~\n ==突出显示==\n `突出显示(推荐)`\n ++下划线++\n ~下标~\n ^上标^\n 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.\n 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600)\n\n +++ **点击折叠**\n 这是被隐藏的内容\n +++\n\n::: tips success warning danger\n这里是容器内的内容\n:::\n\n% note info % success warning danger\n这里是容器内的内容\n% endnote %\n\n -->\n<h2 id=\"摘要\">摘要</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>本文介绍kubectl命令的使用方法</p>\n</li>\n<li class=\"lvl-2\">\n<p>参考资料：</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\"><a href=\"https://docs.aws.amazon.com/zh_cn/eks/latest/userguide\">Amazon EKS用户指南</a></li>\n<li class=\"lvl-6\"><a href=\"https://kubernetes.io/zh-cn/docs/home/\">Kubernetes 文档</a></li>\n</ul>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"kubectl命令\">kubectl命令</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Kubernetes 提供 kubectl 是使用 Kubernetes API 与 Kubernetes 集群的控制面进行通信的命令行工具。</p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://kubernetes.io/zh-cn/docs/reference/kubectl/\">官网文档</a></p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubectl <span class=\"built_in\">help</span></span><br><span class=\"line\">kubectl controls the Kubernetes cluster manager.</span><br><span class=\"line\"></span><br><span class=\"line\"> Find more information at: https://kubernetes.io/docs/reference/kubectl/</span><br><span class=\"line\"></span><br><span class=\"line\">Basic Commands (Beginner):</span><br><span class=\"line\">  create          Create a resource from a file or from stdin</span><br><span class=\"line\">  expose          Take a replication controller, service, deployment or pod and</span><br><span class=\"line\">expose it as a new Kubernetes service</span><br><span class=\"line\">  run             在集群上运行特定镜像</span><br><span class=\"line\">  <span class=\"built_in\">set</span>             为对象设置指定特性</span><br><span class=\"line\"></span><br><span class=\"line\">Basic Commands (Intermediate):</span><br><span class=\"line\">  explain         Get documentation <span class=\"keyword\">for</span> a resource</span><br><span class=\"line\">  get             显示一个或多个资源</span><br><span class=\"line\">  edit            编辑服务器上的资源</span><br><span class=\"line\">  delete          Delete resources by file names, stdin, resources and names, or</span><br><span class=\"line\">by resources and label selector</span><br><span class=\"line\"></span><br><span class=\"line\">Deploy Commands:</span><br><span class=\"line\">  rollout         Manage the rollout of a resource</span><br><span class=\"line\">  scale           Set a new size <span class=\"keyword\">for</span> a deployment, replica <span class=\"built_in\">set</span>, or replication</span><br><span class=\"line\">controller</span><br><span class=\"line\">  autoscale       Auto-scale a deployment, replica <span class=\"built_in\">set</span>, stateful <span class=\"built_in\">set</span>, or</span><br><span class=\"line\">replication controller</span><br><span class=\"line\"></span><br><span class=\"line\">Cluster Management Commands:</span><br><span class=\"line\">  certificate     修改证书资源。</span><br><span class=\"line\">  cluster-info    Display cluster information</span><br><span class=\"line\">  top             Display resource (CPU/memory) usage</span><br><span class=\"line\">  cordon          标记节点为不可调度</span><br><span class=\"line\">  uncordon        标记节点为可调度</span><br><span class=\"line\">  drain           清空节点以准备维护</span><br><span class=\"line\">  taint           更新一个或者多个节点上的污点</span><br><span class=\"line\"></span><br><span class=\"line\">Troubleshooting and Debugging Commands:</span><br><span class=\"line\">  describe        显示特定资源或资源组的详细信息</span><br><span class=\"line\">  logs            打印 Pod 中容器的日志</span><br><span class=\"line\">  attach          挂接到一个运行中的容器</span><br><span class=\"line\">  <span class=\"built_in\">exec</span>            在某个容器中执行一个命令</span><br><span class=\"line\">  port-forward    将一个或多个本地端口转发到某个 Pod</span><br><span class=\"line\">  proxy           运行一个指向 Kubernetes API 服务器的代理</span><br><span class=\"line\">  <span class=\"built_in\">cp</span>              Copy files and directories to and from containers</span><br><span class=\"line\">  auth            Inspect authorization</span><br><span class=\"line\">  debug           Create debugging sessions <span class=\"keyword\">for</span> troubleshooting workloads and nodes</span><br><span class=\"line\">  events          List events</span><br><span class=\"line\"></span><br><span class=\"line\">Advanced Commands:</span><br><span class=\"line\">  diff            Diff the live version against a would-be applied version</span><br><span class=\"line\">  apply           Apply a configuration to a resource by file name or stdin</span><br><span class=\"line\">  patch           Update fields of a resource</span><br><span class=\"line\">  replace         Replace a resource by file name or stdin</span><br><span class=\"line\">  <span class=\"built_in\">wait</span>            Experimental: Wait <span class=\"keyword\">for</span> a specific condition on one or many</span><br><span class=\"line\">resources</span><br><span class=\"line\">  kustomize       Build a kustomization target from a directory or URL.</span><br><span class=\"line\"></span><br><span class=\"line\">Settings Commands:</span><br><span class=\"line\">  label           更新某资源上的标签</span><br><span class=\"line\">  annotate        更新一个资源的注解</span><br><span class=\"line\">  completion      Output shell completion code <span class=\"keyword\">for</span> the specified shell (bash, zsh, fish, or powershell)</span><br><span class=\"line\"></span><br><span class=\"line\">Other Commands:</span><br><span class=\"line\">  alpha           Commands <span class=\"keyword\">for</span> features <span class=\"keyword\">in</span> alpha</span><br><span class=\"line\">  api-resources   Print the supported API resources on the server</span><br><span class=\"line\">  api-versions    Print the supported API versions on the server, <span class=\"keyword\">in</span> the form of <span class=\"string\">&quot;group/version&quot;</span></span><br><span class=\"line\">  config          修改 kubeconfig 文件</span><br><span class=\"line\">  plugin          Provides utilities <span class=\"keyword\">for</span> interacting with plugins</span><br><span class=\"line\">  version         输出客户端和服务端的版本信息</span><br></pre></td></tr></table></figure>\n<h2 id=\"context-集群-相关\">context[集群]相关</h2>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看client和server版本，注意此时必须连上server端</span></span><br><span class=\"line\">k version</span><br><span class=\"line\">k version --output=yaml/json</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 只查看client版本</span></span><br><span class=\"line\">k version --client --short</span><br><span class=\"line\">k version --client --output=yaml</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看所有资源信息，会显示name，shortname，版本，KIND等等</span></span><br><span class=\"line\">k api-resources</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看全部context配置，会显示所有context，当前context前面会用星号标识，同时显示其默认的namespace</span></span><br><span class=\"line\">k config get-contexts</span><br><span class=\"line\"><span class=\"comment\"># 查看当前context</span></span><br><span class=\"line\">k config current-context</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 切换到指定的context，后面跟上面命令查询出来的context的名称，同时修改k8s的配置文件，默认在~/.kube/config 文件</span></span><br><span class=\"line\">k config use-context eks-lexing</span><br><span class=\"line\"><span class=\"comment\"># 作用同上，都是切换上下文</span></span><br><span class=\"line\">k config <span class=\"built_in\">set</span> current-context ekstest</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 修改当前context的名称</span></span><br><span class=\"line\">k config rename-context $(k config current-context) ty-hk-eks</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看~/.kube/config 文件</span></span><br><span class=\"line\">k config view</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 列出所有插件文件路径</span></span><br><span class=\"line\">k plugin list</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看集群信息</span></span><br><span class=\"line\">k cluster-info</span><br></pre></td></tr></table></figure>\n<h2 id=\"节点相关\">节点相关</h2>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看当前集群下的node</span></span><br><span class=\"line\">k get nodes</span><br><span class=\"line\"><span class=\"comment\"># 显示更多信息，比如ip地址</span></span><br><span class=\"line\">k get nodes -o wide</span><br></pre></td></tr></table></figure>\n<h2 id=\"namespace–ns相关\">namespace–ns相关</h2>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 获取当前集群下所有namespace</span></span><br><span class=\"line\">k get namespaces</span><br><span class=\"line\"><span class=\"comment\"># namespace可以简写为ns</span></span><br><span class=\"line\">k get ns</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看当前默认的namespace</span></span><br><span class=\"line\">k config get-contexts $(k config current-context)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 设置当前集群缺省的namespace，同时修改k8s的配置文件，默认在~/.kube/config 文件</span></span><br><span class=\"line\">k config set-context --current --namespace=default</span><br><span class=\"line\">k config set-context $(k config current-context) --namespace default</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建一个新的namespace</span></span><br><span class=\"line\">k create namespace hanqf</span><br><span class=\"line\">k create ns hanqf</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 不创建，只生成yaml文件</span></span><br><span class=\"line\">k create ns hanqf --dry-run=client -o yaml &gt; namespace_hanqf.yaml</span><br><span class=\"line\"><span class=\"comment\"># 基于yaml创建namespace</span></span><br><span class=\"line\">k apply -f namespace_hanqf.yaml</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 删除namespace，删除的同时会删除namespace下的所有资源</span></span><br><span class=\"line\">k delete namespace hanqf</span><br></pre></td></tr></table></figure>\n<h2 id=\"pod–po相关\">pod–po相关</h2>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 获取当前namespace下的pod</span></span><br><span class=\"line\">k get pods</span><br><span class=\"line\"><span class=\"comment\"># 显示更多信息，比如ip地址</span></span><br><span class=\"line\">k get pods -o wide</span><br><span class=\"line\"><span class=\"comment\"># 列出标签</span></span><br><span class=\"line\">k get pods --show-labels</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 显示所有namespace下的pod</span></span><br><span class=\"line\">k get pods -A</span><br><span class=\"line\"><span class=\"comment\"># 显示指定namespace下的pod</span></span><br><span class=\"line\">k get pods -n jx-git-operator</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建pod</span></span><br><span class=\"line\">k run nginx --image=nginx:1.9 --port=80</span><br><span class=\"line\"><span class=\"comment\"># 生成yaml</span></span><br><span class=\"line\">k run nginx --image=nginx:1.9 --port=80 --dry-run=client -o yaml &gt; nginx.yaml</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看pod创建后的配置信息，可以使用k apply -f nginx2.yaml重新创建pod</span></span><br><span class=\"line\">k get pods nginx --output=yaml &gt; nginx2.yaml</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 执行yaml配置创建</span></span><br><span class=\"line\">k apply -f pod.yaml</span><br></pre></td></tr></table></figure>\n<h2 id=\"controller相关\">controller相关</h2>\n<p><img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/oYVIIm.jpg\" alt=\"\"><br>\n<img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/MyEcr0.jpg\" alt=\"\" width=\"1200\" height=\"400\"></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 获取当前namespace下的deployment</span></span><br><span class=\"line\">k get deployments</span><br><span class=\"line\"><span class=\"comment\"># 查看指定的deployment的配置信息</span></span><br><span class=\"line\">k describe deployments test-nginx</span><br><span class=\"line\"><span class=\"comment\"># 编辑指定的deployment</span></span><br><span class=\"line\">k edit deployments test-nginx</span><br><span class=\"line\"><span class=\"comment\"># 删除指定的deployment</span></span><br><span class=\"line\">k delete deployments test-nginx</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 以下同上</span></span><br><span class=\"line\"><span class=\"comment\"># 获取当前namespace下的statefulset，job,cronjob，daemonset</span></span><br><span class=\"line\">k get statefulsets</span><br><span class=\"line\">k get <span class=\"built_in\">jobs</span></span><br><span class=\"line\">k get cronjobs</span><br><span class=\"line\">k get daemonsets</span><br></pre></td></tr></table></figure>\n<h3 id=\"deployment–deploy\">deployment–deploy</h3>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># deploy.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">myngx</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">3</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">myngx</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">     <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">myngx</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">image:</span> <span class=\"string\">nginx:1.7.9</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span> <span class=\"string\">myngx</span></span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">80</span></span><br><span class=\"line\">        <span class=\"attr\">resources:</span></span><br><span class=\"line\">          <span class=\"attr\">requests:</span></span><br><span class=\"line\">            <span class=\"attr\">cpu:</span> <span class=\"string\">8m</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 命令行创建deploy</span></span><br><span class=\"line\">k create deployment test-nginx --image=nginx:1.9 --port=80 --replicas=2</span><br><span class=\"line\"><span class=\"comment\"># 创建yaml</span></span><br><span class=\"line\">k create deployment test-nginx --image=nginx:1.9 --port=80 --replicas=2 --dry-run=client -o yaml &gt; deploy_new.yaml</span><br><span class=\"line\"><span class=\"comment\"># 创建delpoyment</span></span><br><span class=\"line\">k apply -f deploy_new.yaml</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看deploy对应的rs信息，会显示升级历史</span></span><br><span class=\"line\">k get rs -owide -l app=test-nginx</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 重新启动deploy</span></span><br><span class=\"line\">kubectl rollout restart deployment test-nginx</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看全部deployment</span></span><br><span class=\"line\">k get deploy</span><br><span class=\"line\"><span class=\"comment\"># 将指定的deployment输出到yaml</span></span><br><span class=\"line\">k get deploy myngx -o yaml &gt; deploy_nginx.yaml</span><br><span class=\"line\"><span class=\"comment\"># 删除deployment</span></span><br><span class=\"line\">k delete deploy myngx</span><br><span class=\"line\"><span class=\"comment\"># 重新创建deployment</span></span><br><span class=\"line\">k apply -f deploy_nginx.yaml</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 扩缩容，pod不支持扩缩容，只有rs,deploy,sts等高级别controller才有扩缩容能力</span></span><br><span class=\"line\">k scale deploy myngx --replicas=4</span><br><span class=\"line\"><span class=\"comment\"># rs,deploy,sts等高级别controller都具有自愈能力，如果其下的pod被删除了，会自动重新创建新的pod</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 修改deploy</span></span><br><span class=\"line\"><span class=\"comment\"># 方式1：编辑配置，就是vim，保存后立即生效</span></span><br><span class=\"line\">k edit deploy test-nginx</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 方式2: 命令行，比如修改过镜像版本</span></span><br><span class=\"line\"><span class=\"comment\"># k set image deployment deploy名称 镜像名称=镜像</span></span><br><span class=\"line\">k <span class=\"built_in\">set</span> image deployment test-nginx nginx=nginx:1.7.9</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看升级是否成功</span></span><br><span class=\"line\">k rollout status -w deployment test-nginx</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看deploy对应的rs信息，会显示升级历史</span></span><br><span class=\"line\">k get rs -owide -l app=test-nginx</span><br><span class=\"line\"><span class=\"comment\"># 查看历史版本记录，每行前有个版本号</span></span><br><span class=\"line\">k rollout <span class=\"built_in\">history</span> deploy test-nginx</span><br><span class=\"line\"><span class=\"comment\"># 查看指定历史版本号的详细信息</span></span><br><span class=\"line\">k rollout <span class=\"built_in\">history</span> deploy test-nginx --revision=2</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 回退到上一个版本</span></span><br><span class=\"line\">k rollout undo deploy test-nginx</span><br><span class=\"line\"><span class=\"comment\"># 回退到指定的版本</span></span><br><span class=\"line\">k rollout undo deploy test-nginx --to-revision=2</span><br></pre></td></tr></table></figure>\n<h3 id=\"daemonset–ds\">daemonset–ds</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>每个node都会创建一个pod，当有新的node加入进来时，pod会自动被daemonset调度到新的node上，同理删除node，该node上的pod也会被移除</p>\n</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ds1.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">DaemonSet</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">ds1</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">kube-system</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">k8s-app:</span> <span class=\"string\">fluentd-logging</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">name:</span> <span class=\"string\">mynginx</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span> <span class=\"string\">mynginx</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">tolerations:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">key:</span> <span class=\"string\">node-role.kubernetes.io/master</span></span><br><span class=\"line\">        <span class=\"attr\">effect:</span> <span class=\"string\">NoSchedule</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">mynginx</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">nginx:1.7.9</span></span><br><span class=\"line\">        <span class=\"attr\">resources:</span></span><br><span class=\"line\">          <span class=\"attr\">limits:</span></span><br><span class=\"line\">            <span class=\"attr\">memory:</span> <span class=\"string\">200Mi</span></span><br><span class=\"line\">          <span class=\"attr\">requests:</span></span><br><span class=\"line\">            <span class=\"attr\">cpu:</span> <span class=\"string\">100m</span></span><br><span class=\"line\">            <span class=\"attr\">memory:</span> <span class=\"string\">200Mi</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 创建ds</span></span><br><span class=\"line\">k apply -f ds1.yaml</span><br><span class=\"line\"><span class=\"comment\"># daemonset不支持使用create创建，但其格式与deployment差不多，可以先通过create创建deploy的yaml，然后对其进行修改，</span></span><br><span class=\"line\"><span class=\"comment\"># 如修改 apiVersion 和 kind，同时还要去掉replicas，另外需要加上tolerance的配置，保证其在master节点上也能部署</span></span><br><span class=\"line\">k run nginx --image=nginx:1.9 --dry-run -o yaml &gt; ds_new.yaml</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查询ds</span></span><br><span class=\"line\">k get ds -n kube-system</span><br><span class=\"line\"><span class=\"comment\"># 删除</span></span><br><span class=\"line\">k delete ds -n kube-system ds1</span><br></pre></td></tr></table></figure>\n<h3 id=\"job\">job</h3>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># job.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">batch/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Job</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">job-demo</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">name:</span> <span class=\"string\">job-demo</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">restartPolicy:</span> <span class=\"string\">Never</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">counter</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">busybox</span></span><br><span class=\"line\">        <span class=\"attr\">command:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">&quot;bin/sh&quot;</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">&quot;-c&quot;</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">&quot;for i in 9 8 7 6 5 4 3 2 1; do echo $i; done&quot;</span></span><br><span class=\"line\">        <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">k apply -f job.yaml</span><br><span class=\"line\">k get <span class=\"built_in\">jobs</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"cronjob–cj\">cronjob–cj</h3>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># cronjob.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">batch/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">CronJob</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">cronjob-demo</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">schedule:</span> <span class=\"string\">&quot;*/1 * * * *&quot;</span></span><br><span class=\"line\">  <span class=\"attr\">jobTemplate:</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">template:</span></span><br><span class=\"line\">        <span class=\"attr\">spec:</span></span><br><span class=\"line\">          <span class=\"attr\">restartPolicy:</span> <span class=\"string\">OnFailure</span></span><br><span class=\"line\">          <span class=\"attr\">containers:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">hello</span></span><br><span class=\"line\">            <span class=\"attr\">image:</span> <span class=\"string\">busybox</span></span><br><span class=\"line\">            <span class=\"attr\">args:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">&quot;bin/sh&quot;</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">&quot;-c&quot;</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">&quot;for i in 9 8 7 6 5 4 3 2 1; do echo $i; done&quot;</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">k apply -f cronjob.yaml</span><br><span class=\"line\">k get cronjob -o wide</span><br><span class=\"line\">k get job</span><br></pre></td></tr></table></figure>\n<h3 id=\"statefulset–sts\">statefulset–sts</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>sts的特性<br>\n● 稳定的、唯一的网络标识。<br>\n● 稳定的、持久化的存储。<br>\n● 有序的、优雅的部署和扩展。<br>\n● 有序的、优雅的删除和停止。</p>\n</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># sts.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">StatefulSet</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">web</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">serviceName:</span> <span class=\"string\">&quot;nginx&quot;</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">3</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">nginx:1.9</span></span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">80</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">web</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">k apply -f sts.yaml</span><br><span class=\"line\">k get sts -owide</span><br></pre></td></tr></table></figure>\n<h2 id=\"label标签\">label标签</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>controller和service等都是基于标签选择器关联pod的，所以在指定label时一定要准确唯一</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 可以为任何资源设置标签</span></span><br><span class=\"line\"><span class=\"comment\"># k label 资源类型 资源名称 key=value</span></span><br><span class=\"line\">k label deploy myngx app=<span class=\"built_in\">test</span></span><br><span class=\"line\"><span class=\"comment\"># 查看标签</span></span><br><span class=\"line\">k get deploy --show-labels</span><br><span class=\"line\"><span class=\"comment\"># 查看指定的标签值，标签会占用一列进行展示，多个标签使用逗号分隔，如果资源不存在该标签，则为空</span></span><br><span class=\"line\">k get pod -L app,run</span><br><span class=\"line\"><span class=\"comment\"># 只列出给定标签和值的资源</span></span><br><span class=\"line\">k get pod -l app=<span class=\"built_in\">test</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"Configmap–cm\">Configmap–cm</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>用来存储配置文件的 kubernetes 资源对象，配置内容都存储在 etcd 中</p>\n</li>\n<li class=\"lvl-2\">\n<p>创建方法</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 通过直接在命令行中指定 configmap 参数创建，即--from-literal</span></span><br><span class=\"line\">$ k create configmap config-map1 --from-literal=db.host=mysql.db --from-literal=db.port=<span class=\"string\">&#x27;3306&#x27;</span></span><br><span class=\"line\">$ k describe cm config-map1</span><br><span class=\"line\">Name:         config-map1</span><br><span class=\"line\">Namespace:    <span class=\"built_in\">test</span></span><br><span class=\"line\">Labels:       &lt;none&gt;</span><br><span class=\"line\">Annotations:  &lt;none&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">Data</span><br><span class=\"line\">====</span><br><span class=\"line\">db.host:</span><br><span class=\"line\">----</span><br><span class=\"line\">mysql.db</span><br><span class=\"line\">db.port:</span><br><span class=\"line\">----</span><br><span class=\"line\">3306</span><br><span class=\"line\"></span><br><span class=\"line\">BinaryData</span><br><span class=\"line\">====</span><br><span class=\"line\"></span><br><span class=\"line\">Events:  &lt;none&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 通过指定文件创建，即将一个配置文件创建为一个 ConfigMap --from-file=&lt;文件&gt;</span></span><br><span class=\"line\"><span class=\"comment\"># 如果不指定key，则文件名称作为key</span></span><br><span class=\"line\">$ vi configs/app.properties</span><br><span class=\"line\">db.host mysql.db</span><br><span class=\"line\">db.port 3306</span><br><span class=\"line\"></span><br><span class=\"line\">$ k create configmap config-map2 --from-file=key1=./configs/app.properties</span><br><span class=\"line\">$ k describe cm config-map2</span><br><span class=\"line\">Name:         config-map2</span><br><span class=\"line\">Namespace:    <span class=\"built_in\">test</span></span><br><span class=\"line\">Labels:       &lt;none&gt;</span><br><span class=\"line\">Annotations:  &lt;none&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">Data</span><br><span class=\"line\">====</span><br><span class=\"line\">key1:</span><br><span class=\"line\">----</span><br><span class=\"line\">db.host mysql.db</span><br><span class=\"line\">db.port 3306</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">BinaryData</span><br><span class=\"line\">====</span><br><span class=\"line\"></span><br><span class=\"line\">Events:  &lt;none&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 通过指定目录创建，即将一个目录下的所有配置文件创建为一个 ConfigMap，--from-file=&lt;目录&gt;</span></span><br><span class=\"line\">$ k create configmap config-map3 --from-file=./configs</span><br><span class=\"line\">$ k describe cm config-map3</span><br><span class=\"line\">Name:         config-map3</span><br><span class=\"line\">Namespace:    <span class=\"built_in\">test</span></span><br><span class=\"line\">Labels:       &lt;none&gt;</span><br><span class=\"line\">Annotations:  &lt;none&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">Data</span><br><span class=\"line\">====</span><br><span class=\"line\">app-copy.properties:</span><br><span class=\"line\">----</span><br><span class=\"line\">db.host mysql.db</span><br><span class=\"line\">db.port 3306</span><br><span class=\"line\"></span><br><span class=\"line\">app.properties:</span><br><span class=\"line\">----</span><br><span class=\"line\">db.host mysql.db</span><br><span class=\"line\">db.port 3306</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">BinaryData</span><br><span class=\"line\">====</span><br><span class=\"line\"></span><br><span class=\"line\">Events:  &lt;none&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 事先写好标准的 configmap 的 yaml 文件，然后 kubectl create -f 创建</span></span><br><span class=\"line\">$ vim config-map4.yaml</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">data:</span><br><span class=\"line\">  db.host: mysql.db</span><br><span class=\"line\">  db.port: <span class=\"string\">&quot;3306&quot;</span> <span class=\"comment\"># 数字一定要用双引号括起来</span></span><br><span class=\"line\">kind: ConfigMap</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: config-map4</span><br><span class=\"line\"></span><br><span class=\"line\">$ k apply -f config-map4.yaml</span><br><span class=\"line\">$ k describe cm config-map4</span><br><span class=\"line\">Name:         config-map4</span><br><span class=\"line\">Namespace:    <span class=\"built_in\">test</span></span><br><span class=\"line\">Labels:       &lt;none&gt;</span><br><span class=\"line\">Annotations:  &lt;none&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">Data</span><br><span class=\"line\">====</span><br><span class=\"line\">db.host:</span><br><span class=\"line\">----</span><br><span class=\"line\">mysql.db</span><br><span class=\"line\">db.port:</span><br><span class=\"line\">----</span><br><span class=\"line\">3306</span><br><span class=\"line\"></span><br><span class=\"line\">BinaryData</span><br><span class=\"line\">====</span><br><span class=\"line\"></span><br><span class=\"line\">Events:  &lt;none&gt;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>使用方法</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">## 通过环境变量使用</span></span><br><span class=\"line\"><span class=\"comment\"># 1.使用 valueFrom、configMapKeyRef、name、key 指定要用的 key:</span></span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Pod</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: app</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  containers:</span><br><span class=\"line\">  - name: app</span><br><span class=\"line\">    image: centos</span><br><span class=\"line\">    <span class=\"built_in\">env</span>:</span><br><span class=\"line\">    - name: DB_HOST  <span class=\"comment\"># 环境变量名称</span></span><br><span class=\"line\">      valueFrom:</span><br><span class=\"line\">        configMapKeyRef:</span><br><span class=\"line\">          name: config-map4 <span class=\"comment\"># cm名称</span></span><br><span class=\"line\">          key: db.host      <span class=\"comment\"># cm中的key</span></span><br><span class=\"line\"><span class=\"comment\"># 2.通过 envFrom、configMapRef、name 使得 configmap 中的所有 key/value 对都自动变成环境变量</span></span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Pod</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: app</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  containers:</span><br><span class=\"line\">  - name: app</span><br><span class=\"line\">    image: centos</span><br><span class=\"line\">    envFrom:</span><br><span class=\"line\">      configMapRef:</span><br><span class=\"line\">        name: config-map4</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## 在启动命令中引用</span></span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Pod</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: app</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  containers:</span><br><span class=\"line\">  - name: app</span><br><span class=\"line\">    image: centos</span><br><span class=\"line\">    <span class=\"built_in\">command</span>: [<span class=\"string\">&quot;/bin/sh&quot;</span>]</span><br><span class=\"line\">    args: [<span class=\"string\">&quot;-c&quot;</span>, <span class=\"string\">&quot;while true; do echo <span class=\"subst\">$(DB_HOST)</span> <span class=\"subst\">$(DB_PORT)</span> &gt;&gt; /out.txt; sleep 5; done&quot;</span>]</span><br><span class=\"line\">    <span class=\"built_in\">env</span>:</span><br><span class=\"line\">    - name: DB_HOST</span><br><span class=\"line\">      valueFrom:</span><br><span class=\"line\">        configMapKeyRef:</span><br><span class=\"line\">          name: config-map4</span><br><span class=\"line\">          key: db.host</span><br><span class=\"line\">    - name: DB_PORT</span><br><span class=\"line\">      valueFrom:</span><br><span class=\"line\">        configMapKeyRef:</span><br><span class=\"line\">          name: config-map4</span><br><span class=\"line\">          key: db.port</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## 作为 volume 挂载使用</span></span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Pod</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: app</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  containers:</span><br><span class=\"line\">  - name: app</span><br><span class=\"line\">    image: centos</span><br><span class=\"line\">    <span class=\"built_in\">command</span>: [<span class=\"string\">&quot;/bin/sh&quot;</span>]</span><br><span class=\"line\">    args: [<span class=\"string\">&quot;-c&quot;</span>, <span class=\"string\">&quot;while true; do cat /tmp/config.properties &gt;&gt; /out.txt; sleep 5; done&quot;</span>]</span><br><span class=\"line\">    volumeMounts:</span><br><span class=\"line\">    - name: config-map3</span><br><span class=\"line\">      mountPath: /tmp/config.properties <span class=\"comment\"># 挂载到的文件</span></span><br><span class=\"line\">      subPath: app.properties  <span class=\"comment\"># 被挂载的文件，即cm中的多个文件中的一个</span></span><br><span class=\"line\">  volumes:</span><br><span class=\"line\">  - name: config-map3</span><br><span class=\"line\">    configMap:</span><br><span class=\"line\">      name: config-map3</span><br></pre></td></tr></table></figure>\n<h2 id=\"Secrets\">Secrets</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Secret 解决了密码、token、密钥等敏感数据的配置问题，而不需要把这些敏感数据暴露到镜像或者 Pod Spec 中。</p>\n</li>\n<li class=\"lvl-2\">\n<p>Secret 可以以 Volume 或者环境变量的方式使用。</p>\n</li>\n</ul>\n<h3 id=\"Secrets-类型\">Secrets 类型</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>创建 Secret 时，你可以使用 Secret 资源的 type 字段，或者与其等价的 kubectl 命令行参数（如果有的话）为其设置类型。</p>\n</li>\n<li class=\"lvl-2\">\n<p>Kubernetes 提供若干种内置的类型，用于一些常见的使用场景。 针对这些类型，Kubernetes 所执行的合法性检查操作以及对其所实施的限制各不相同。</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>内置类型</th>\n<th>用法</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>Opaque</code></td>\n<td>用户定义的任意数据</td>\n</tr>\n<tr>\n<td><code>kubernetes.io/service-account-token</code></td>\n<td>服务账号令牌</td>\n</tr>\n<tr>\n<td><code>kubernetes.io/dockercfg</code></td>\n<td>~/.dockercfg 文件的序列化形式</td>\n</tr>\n<tr>\n<td><code>kubernetes.io/dockerconfigjson</code></td>\n<td>~/.docker/config.json 文件的序列化形式</td>\n</tr>\n<tr>\n<td><code>kubernetes.io/basic-auth</code></td>\n<td>用于基本身份认证的凭据</td>\n</tr>\n<tr>\n<td><code>kubernetes.io/ssh-auth</code></td>\n<td>用于 SSH 身份认证的凭据</td>\n</tr>\n<tr>\n<td><code>kubernetes.io/tls</code></td>\n<td>用于 TLS 客户端或者服务器端的数据</td>\n</tr>\n<tr>\n<td><code>bootstrap.kubernetes.io/token</code></td>\n<td>启动引导令牌数据</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>通过为 Secret 对象的 type 字段设置一个非空的字符串值，你也可以定义并使用自己 Secret 类型（如果 type 值为空字符串，则被视为 Opaque 类型）。</p>\n</li>\n<li class=\"lvl-2\">\n<p>关于Secret类型的进一步说请查看<a href=\"https://kubernetes.io/zh-cn/docs/concepts/configuration/secret/\">https://kubernetes.io/zh-cn/docs/concepts/configuration/secret/</a>，以下示例仅对常用的<code>Opaque</code>进行说明。</p>\n</li>\n</ul>\n<h3 id=\"创建-Secret\">创建 Secret</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 配置文件创建</span></span><br><span class=\"line\">$ <span class=\"built_in\">echo</span> -n <span class=\"string\">&#x27;my-app&#x27;</span> | <span class=\"built_in\">base64</span></span><br><span class=\"line\">bXktYXBw</span><br><span class=\"line\">$ <span class=\"built_in\">echo</span> -n <span class=\"string\">&#x27;39528$vdg7Jb&#x27;</span> | <span class=\"built_in\">base64</span></span><br><span class=\"line\">Mzk1MjgkdmRnN0pi</span><br><span class=\"line\"><span class=\"comment\"># 配置文件</span></span><br><span class=\"line\"><span class=\"comment\"># secret.yaml</span></span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Secret</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: test-secret</span><br><span class=\"line\">data:</span><br><span class=\"line\">  username: bXktYXBw  <span class=\"comment\"># value必须是警告base64加密后的值</span></span><br><span class=\"line\">  password: Mzk1MjgkdmRnN0pi</span><br><span class=\"line\"></span><br><span class=\"line\">$ k apply -f secret.yaml</span><br><span class=\"line\">$ k describe secrets test-secret</span><br><span class=\"line\">Name:         test-secret</span><br><span class=\"line\">Namespace:    <span class=\"built_in\">test</span></span><br><span class=\"line\">Labels:       &lt;none&gt;</span><br><span class=\"line\">Annotations:  &lt;none&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">Type:  Opaque</span><br><span class=\"line\"></span><br><span class=\"line\">Data</span><br><span class=\"line\">====</span><br><span class=\"line\">username:  6 bytes</span><br><span class=\"line\">password:  12 bytes</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 命令行创建，此时明文创建即可</span></span><br><span class=\"line\">$ kubectl create secret generic test-secret2 --from-literal=<span class=\"string\">&#x27;username=my-app&#x27;</span> --from-literal=<span class=\"string\">&#x27;password=39528$vdg7Jb&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 文件创建</span></span><br><span class=\"line\">$ kubectl create secret generic ssh-key-secret --from-file=ssh-privatekey=/path/to/.ssh/id_rsa --from-file=ssh-publickey=/path/to/.ssh/id_rsa.pub</span><br></pre></td></tr></table></figure>\n<h3 id=\"使用-Secret\">使用 Secret</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>创建一个可以通过卷访问 Secret 数据的 Pod</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># secret-pod.yaml</span></span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Pod</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: secret-test-pod</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  containers:</span><br><span class=\"line\">    - name: test-container</span><br><span class=\"line\">      image: nginx</span><br><span class=\"line\">      volumeMounts:</span><br><span class=\"line\">        <span class=\"comment\"># name 必须与下面的卷名匹配</span></span><br><span class=\"line\">        - name: secret-volume</span><br><span class=\"line\">          mountPath: /etc/secret-volume</span><br><span class=\"line\">          readOnly: <span class=\"literal\">true</span></span><br><span class=\"line\">  <span class=\"comment\"># Secret 数据通过一个卷暴露给该 Pod 中的容器</span></span><br><span class=\"line\">  volumes:</span><br><span class=\"line\">    - name: secret-volume</span><br><span class=\"line\">      secret:</span><br><span class=\"line\">        secretName: test-secret</span><br><span class=\"line\"></span><br><span class=\"line\">$ k apply -f secret-pod.yaml</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 输出包含两个文件，每个对应一个 Secret 数据条目</span></span><br><span class=\"line\">$ kubectl <span class=\"built_in\">exec</span> -i -t secret-test-pod -- <span class=\"built_in\">ls</span> /etc/secret-volume</span><br><span class=\"line\">password  username</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>映射 Secret 键到特定文件路径</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">来自 mysecret 的键 username 可以在路径 /etc/foo/my-group/my-username 下供容器使用，而不是路径 /etc/foo/username</li>\n<li class=\"lvl-6\">来自该 Secret 的键 password 没有映射到任何路径</li>\n</ul>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Pod</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: mypod</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  containers:</span><br><span class=\"line\">  - name: mypod</span><br><span class=\"line\">    image: redis</span><br><span class=\"line\">    volumeMounts:</span><br><span class=\"line\">    - name: foo</span><br><span class=\"line\">      mountPath: <span class=\"string\">&quot;/etc/foo&quot;</span></span><br><span class=\"line\">      readOnly: <span class=\"literal\">true</span></span><br><span class=\"line\">  volumes:</span><br><span class=\"line\">  - name: foo</span><br><span class=\"line\">    secret:</span><br><span class=\"line\">      secretName: mysecret</span><br><span class=\"line\">      items:</span><br><span class=\"line\">      - key: username</span><br><span class=\"line\">        path: my-group/my-username</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>使用来自 Secret 中的数据定义容器变量</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ k create secret generic backend-user --from-literal=backend-username=<span class=\"string\">&#x27;backend-admin&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># pod-single-secret-env-variable.yaml</span></span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">  kind: Pod</span><br><span class=\"line\">  metadata:</span><br><span class=\"line\">    name: env-single-secret</span><br><span class=\"line\">  spec:</span><br><span class=\"line\">    containers:</span><br><span class=\"line\">    - name: envars-test-container</span><br><span class=\"line\">      image: nginx</span><br><span class=\"line\">      <span class=\"built_in\">env</span>:</span><br><span class=\"line\">      - name: SECRET_USERNAME</span><br><span class=\"line\">        valueFrom:</span><br><span class=\"line\">          secretKeyRef:</span><br><span class=\"line\">            name: backend-user</span><br><span class=\"line\">            key: backend-username</span><br><span class=\"line\">$ k apply -f pod-single-secret-env-variable.yaml</span><br><span class=\"line\">$ k <span class=\"built_in\">exec</span> -i -t env-single-secret -- /bin/sh -c <span class=\"string\">&#x27;echo $SECRET_USERNAME&#x27;</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>将 Secret 中的所有键值偶对定义为环境变量</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ k create secret generic test-secret --from-literal=username=<span class=\"string\">&#x27;my-app&#x27;</span> --from-literal=password=<span class=\"string\">&#x27;39528$vdg7Jb&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># pod-secret-envFrom.yaml</span></span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">  kind: Pod</span><br><span class=\"line\">  metadata:</span><br><span class=\"line\">    name: envfrom-secret</span><br><span class=\"line\">  spec:</span><br><span class=\"line\">    containers:</span><br><span class=\"line\">    - name: envars-test-container</span><br><span class=\"line\">      image: nginx</span><br><span class=\"line\">      envFrom:</span><br><span class=\"line\">      - secretRef:</span><br><span class=\"line\">          name: test-secret</span><br><span class=\"line\">$ k apply -f pod-secret-envFrom.yaml</span><br><span class=\"line\">$ k <span class=\"built_in\">exec</span> -i -t envfrom-secret -- /bin/sh -c <span class=\"string\">&#x27;echo &quot;username: $username\\npassword: $password\\n&quot;&#x27;</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"service–svc\">service–svc</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>svc负责解决端口映射的问题</p>\n</li>\n<li class=\"lvl-2\">\n<p>Kubernetes ServiceTypes 允许指定你所需要的 Service 类型。</p>\n</li>\n<li class=\"lvl-2\">\n<p>可用的 type 值及其行为有：</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">ClusterIP<br>\n通过集群的内部 IP 暴露服务，选择该值时服务只能够在集群内部访问。 这也是你没有为服务显式指定 type 时使用的默认值。 你可以使用 Ingress 或者 Gateway API 向公众暴露服务。</li>\n<li class=\"lvl-6\">NodePort<br>\n通过每个节点上的 IP 和静态端口（NodePort）暴露服务。 为了让节点端口可用，Kubernetes 设置了集群 IP 地址，这等同于你请求 type: ClusterIP 的服务。</li>\n<li class=\"lvl-6\">LoadBalancer<br>\n使用云提供商的负载均衡器向外部暴露服务。 Kubernetes 不直接提供负载均衡组件；你必须提供一个，或者将你的 Kubernetes 集群与云提供商集成。</li>\n<li class=\"lvl-6\">ExternalName<br>\n将服务映射到 externalName 字段的内容（例如，映射到主机名 api.foo.bar.example）。 该映射将集群的 DNS 服务器配置为返回具有该外部主机名值的 CNAME 记录。 无需创建任何类型代理。</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"NodePort\">NodePort</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>可以让 kubernetes 在其所在节点上保留一个端口（所有节点上都使用相同的端口号），然后将传入的连接转发给 pod</p>\n</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># svc-nodeport.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">   <span class=\"attr\">name:</span> <span class=\"string\">svc-nodeport</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">   <span class=\"attr\">ports:</span></span><br><span class=\"line\">   <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">test-nginx</span></span><br><span class=\"line\">     <span class=\"attr\">port:</span> <span class=\"number\">3080</span></span><br><span class=\"line\">     <span class=\"attr\">targetPort:</span> <span class=\"number\">80</span></span><br><span class=\"line\">     <span class=\"attr\">nodePort:</span> <span class=\"number\">32115</span> <span class=\"comment\"># 此处指定具体的端口，不能重复，如果没有配置则随机创建</span></span><br><span class=\"line\">   <span class=\"attr\">selector:</span></span><br><span class=\"line\">     <span class=\"attr\">app:</span> <span class=\"string\">test-nginx</span></span><br><span class=\"line\">   <span class=\"attr\">type:</span> <span class=\"string\">NodePort</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"ClusterIP\">ClusterIP</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>提供虚拟ip</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 基于delpoyment创建service</span></span><br><span class=\"line\">k expose deployment test-nginx --name svc-cluster-ip --port=3280 --target-port=80 --<span class=\"built_in\">type</span>=ClusterIP</span><br><span class=\"line\"><span class=\"comment\"># 不创建，只生成yaml文件</span></span><br><span class=\"line\">k expose deployment test-nginx --name svc-cluster-ip --port=3280 --target-port=80 --<span class=\"built_in\">type</span>=ClusterIP --dry-run=client -o yaml &gt; svc-cluster-ip.yaml</span><br><span class=\"line\"><span class=\"comment\"># 基于yaml创建service</span></span><br><span class=\"line\">k apply -f svc-cluster-ip.yaml</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Headless service clusterIP：基于statefulset创建service</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">不提供虚拟ip，而是返回具体的pod地址，并且基于如下规则查找：<br>\n<code>$&#123;podName&#125;.$&#123;headlessServiceName即svcName&#125;.$&#123;namespace&#125;.$&#123;clusterDomainName&#125;</code>，<br>\n同一个namespace的pod访问时一般指定到${headlessServiceName}即可，跨namespace时需要指定到${namespace}</li>\n</ul>\n</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># svc-sts-web.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">port:</span> <span class=\"number\">80</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">web</span></span><br><span class=\"line\">  <span class=\"attr\">clusterIP:</span> <span class=\"string\">None</span> <span class=\"comment\"># 这里必须设置为None</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">nginx</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"LoadBalancer\">LoadBalancer</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>相比 NodePort 方式可以通过任何节点的 指定 端口访问内部的 pod，LoadBalancer 方式拥有自己独一无二的可公开访问的 IP 地址；</p>\n</li>\n<li class=\"lvl-2\">\n<p>LoadBalance 其实是 NodePort 的一种扩展，使得服务可以通过一个专用的负载均衡器来访问。</p>\n</li>\n<li class=\"lvl-2\">\n<p>如果是自建k8s，Kubernetes 没 有 为 裸 机 集 群 提 供 网 络 负 载 平 衡 器 的 实 现，所以需要安装一个LoadBalancer，比如 MetaLb 负载均衡，这里不做赘述。</p>\n</li>\n<li class=\"lvl-2\">\n<p>EKS<a href=\"/2023/07/07/aws-eks07-loadbalancer/\" title=\"AWS-EKS-07--安装 AWS Load Balancer Controller 附加组件\">安装 AWS Load Balancer Controller 附加组件</a>后即可提供支持。</p>\n</li>\n</ul>\n<h3 id=\"可以基于pod直接创建svc\">可以基于pod直接创建svc</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 启动一个pod，默认的label是 run=nginx-app</span></span><br><span class=\"line\">kubectl run nginx-app --image=nginx --restart=Never --port=80</span><br><span class=\"line\"><span class=\"comment\"># 为pod添加标签</span></span><br><span class=\"line\">k label pod nginx-app app=nginx-app</span><br><span class=\"line\"><span class=\"comment\"># 创建一个svc的yaml文件，其selector为app: nginx-app，这里没有指定nodePort，创建时会随机分配一个端口</span></span><br><span class=\"line\"><span class=\"comment\"># 也可以修改生成的yaml文件，使其符合要求</span></span><br><span class=\"line\">kubectl create svc nodeport nginx-app --tcp=80:80 --dry-run -o yaml &gt; svc_pod.yaml</span><br><span class=\"line\">k apply -f svc_pod.yaml</span><br></pre></td></tr></table></figure>\n<h3 id=\"查看svc\">查看svc</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看svc，注意查看TYPE，CLUSTER-IP ，EXTERNAL-IP，PORT显示的不同之处</span></span><br><span class=\"line\">&gt; k get svc -o wide</span><br><span class=\"line\">NAME                    TYPE           CLUSTER-IP       EXTERNAL-IP                                                               PORT(S)          AGE    SELECTOR</span><br><span class=\"line\">nginx                   ClusterIP      None             &lt;none&gt;                                                                    80/TCP           130m   app=nginx</span><br><span class=\"line\">svc-loadbalance-nginx   LoadBalancer   172.20.57.83     aa39ab20daad5447da7ee7d283ab2a83-1210832584.ap-east-1.elb.amazonaws.com   3081:32116/TCP   10m    app=test-nginx</span><br><span class=\"line\">svc-test-nginx          NodePort       172.20.39.12     &lt;none&gt;                                                                    3080:32115/TCP   18h    app=test-nginx</span><br><span class=\"line\">test-loadbalancer-new   LoadBalancer   172.20.242.126   a2774e4dc02ad42cc97c54fc9968624b-882652598.ap-east-1.elb.amazonaws.com    3282:31212/TCP   10s    app=test-nginx</span><br><span class=\"line\">test-nginx-new          ClusterIP      172.20.144.96    &lt;none&gt;                                                                    3280/TCP         162m   app=test-nginx</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看endpoint--ep</span></span><br><span class=\"line\">k get endpoints</span><br><span class=\"line\">&gt; k get ep</span><br><span class=\"line\">NAME                    ENDPOINTS                                            AGE</span><br><span class=\"line\">nginx                   10.25.113.205:80,10.25.142.172:80,10.25.148.165:80   132m</span><br><span class=\"line\">svc-loadbalance-nginx   10.25.116.40:80,10.25.121.198:80,10.25.122.75:80     12m</span><br><span class=\"line\">svc-test-nginx          10.25.116.40:80,10.25.121.198:80,10.25.122.75:80     18h</span><br><span class=\"line\">test-loadbalancer-new   10.25.116.40:80,10.25.121.198:80,10.25.122.75:80     2m11s</span><br><span class=\"line\">test-nginx-new          10.25.116.40:80,10.25.121.198:80,10.25.122.75:80     164m</span><br></pre></td></tr></table></figure>\n<h2 id=\"Ingress\">Ingress</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Ingress将来自集群外部的 HTTP 和 HTTPS 路由暴露给集群 内的服务。流量路由由 Ingress 资源上定义的规则控制。</p>\n</li>\n<li class=\"lvl-2\">\n<p>私有k8s不提供Ingress，需要自行安装。</p>\n</li>\n<li class=\"lvl-2\">\n<p>基于aws-eks等云服务通过<a href=\"/2023/07/07/aws-eks07-loadbalancer/\" title=\"AWS-EKS-07--安装 AWS Load Balancer Controller 附加组件\">安装 AWS Load Balancer Controller 附加组件</a>提供Ingress功能。</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">k get ing</span><br><span class=\"line\">k get ing -A</span><br><span class=\"line\">k get ing -n <span class=\"built_in\">test</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"HPA：Horizontal-Pod-Autoscaler-自动弹性伸缩\">HPA：Horizontal Pod Autoscaler 自动弹性伸缩</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>实现hpa的前提是k8s集群中<a href=\"/2023/07/07/aws-eks11-metrics/\" title=\"AWS-EKS-11--安装 Kubernetes Metrics Server\">部署 metrics-server</a>，其可对node和pod占用CPU、内存的情况进行监控。</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 基于deployment创建hpa</span></span><br><span class=\"line\">k autoscale deployment test-nginx --max=3 --min=1 --cpu-percent=60</span><br><span class=\"line\"><span class=\"comment\"># 最多3个pod，最少1个pod，基于cpu使用情况，超过60%时进行扩容</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看hpa</span></span><br><span class=\"line\">k get hpa</span><br></pre></td></tr></table></figure>\n<h2 id=\"其它命令\">其它命令</h2>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 进入pod</span></span><br><span class=\"line\">k <span class=\"built_in\">exec</span> podName -it -- sh</span><br><span class=\"line\">k <span class=\"built_in\">exec</span> podName -it -- /bin/bash</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 监视变化 -w</span></span><br><span class=\"line\">k get deploy -w</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 不显示标题头 --no-headers=true</span></span><br><span class=\"line\">k get pods --no-headers=<span class=\"literal\">true</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看pod的日志输出</span></span><br><span class=\"line\">k logs podName</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 编辑一个资源，直接编辑已经部署的资源yaml</span></span><br><span class=\"line\">k edit deploy app</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看一个资源的部署情况</span></span><br><span class=\"line\">k describe deploy app</span><br></pre></td></tr></table></figure>","content_text":"摘要 本文介绍kubectl命令的使用方法 参考资料： Amazon EKS用户指南 Kubernetes 文档 kubectl命令 Kubernetes 提供 kubectl 是使用 Kubernetes API 与 Kubernetes 集群的控制面进行通信的命令行工具。 官网文档 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768$ kubectl helpkubectl controls the Kubernetes cluster manager. Find more information at: https://kubernetes.io/docs/reference/kubectl/Basic Commands (Beginner): create Create a resource from a file or from stdin expose Take a replication controller, service, deployment or pod andexpose it as a new Kubernetes service run 在集群上运行特定镜像 set 为对象设置指定特性Basic Commands (Intermediate): explain Get documentation for a resource get 显示一个或多个资源 edit 编辑服务器上的资源 delete Delete resources by file names, stdin, resources and names, orby resources and label selectorDeploy Commands: rollout Manage the rollout of a resource scale Set a new size for a deployment, replica set, or replicationcontroller autoscale Auto-scale a deployment, replica set, stateful set, orreplication controllerCluster Management Commands: certificate 修改证书资源。 cluster-info Display cluster information top Display resource (CPU/memory) usage cordon 标记节点为不可调度 uncordon 标记节点为可调度 drain 清空节点以准备维护 taint 更新一个或者多个节点上的污点Troubleshooting and Debugging Commands: describe 显示特定资源或资源组的详细信息 logs 打印 Pod 中容器的日志 attach 挂接到一个运行中的容器 exec 在某个容器中执行一个命令 port-forward 将一个或多个本地端口转发到某个 Pod proxy 运行一个指向 Kubernetes API 服务器的代理 cp Copy files and directories to and from containers auth Inspect authorization debug Create debugging sessions for troubleshooting workloads and nodes events List eventsAdvanced Commands: diff Diff the live version against a would-be applied version apply Apply a configuration to a resource by file name or stdin patch Update fields of a resource replace Replace a resource by file name or stdin wait Experimental: Wait for a specific condition on one or manyresources kustomize Build a kustomization target from a directory or URL.Settings Commands: label 更新某资源上的标签 annotate 更新一个资源的注解 completion Output shell completion code for the specified shell (bash, zsh, fish, or powershell)Other Commands: alpha Commands for features in alpha api-resources Print the supported API resources on the server api-versions Print the supported API versions on the server, in the form of &quot;group/version&quot; config 修改 kubeconfig 文件 plugin Provides utilities for interacting with plugins version 输出客户端和服务端的版本信息 context[集群]相关 1234567891011121314151617181920212223242526272829303132# 查看client和server版本，注意此时必须连上server端k versionk version --output=yaml/json# 只查看client版本k version --client --shortk version --client --output=yaml# 查看所有资源信息，会显示name，shortname，版本，KIND等等k api-resources# 查看全部context配置，会显示所有context，当前context前面会用星号标识，同时显示其默认的namespacek config get-contexts# 查看当前contextk config current-context# 切换到指定的context，后面跟上面命令查询出来的context的名称，同时修改k8s的配置文件，默认在~/.kube/config 文件k config use-context eks-lexing# 作用同上，都是切换上下文k config set current-context ekstest# 修改当前context的名称k config rename-context $(k config current-context) ty-hk-eks# 查看~/.kube/config 文件k config view# 列出所有插件文件路径k plugin list# 查看集群信息k cluster-info 节点相关 1234# 查看当前集群下的nodek get nodes# 显示更多信息，比如ip地址k get nodes -o wide namespace–ns相关 1234567891011121314151617181920212223# 获取当前集群下所有namespacek get namespaces# namespace可以简写为nsk get ns# 查看当前默认的namespacek config get-contexts $(k config current-context)# 设置当前集群缺省的namespace，同时修改k8s的配置文件，默认在~/.kube/config 文件k config set-context --current --namespace=defaultk config set-context $(k config current-context) --namespace default# 创建一个新的namespacek create namespace hanqfk create ns hanqf# 不创建，只生成yaml文件k create ns hanqf --dry-run=client -o yaml &gt; namespace_hanqf.yaml# 基于yaml创建namespacek apply -f namespace_hanqf.yaml# 删除namespace，删除的同时会删除namespace下的所有资源k delete namespace hanqf pod–po相关 12345678910111213141516171819202122# 获取当前namespace下的podk get pods# 显示更多信息，比如ip地址k get pods -o wide# 列出标签k get pods --show-labels# 显示所有namespace下的podk get pods -A# 显示指定namespace下的podk get pods -n jx-git-operator# 创建podk run nginx --image=nginx:1.9 --port=80# 生成yamlk run nginx --image=nginx:1.9 --port=80 --dry-run=client -o yaml &gt; nginx.yaml# 查看pod创建后的配置信息，可以使用k apply -f nginx2.yaml重新创建podk get pods nginx --output=yaml &gt; nginx2.yaml# 执行yaml配置创建k apply -f pod.yaml controller相关 123456789101112131415# 获取当前namespace下的deploymentk get deployments# 查看指定的deployment的配置信息k describe deployments test-nginx# 编辑指定的deploymentk edit deployments test-nginx# 删除指定的deploymentk delete deployments test-nginx# 以下同上# 获取当前namespace下的statefulset，job,cronjob，daemonsetk get statefulsetsk get jobsk get cronjobsk get daemonsets deployment–deploy 1234567891011121314151617181920212223# deploy.yamlapiVersion: apps/v1kind: Deploymentmetadata: name: myngxspec: replicas: 3 selector: matchLabels: app: myngx template: metadata: labels: app: myngx spec: containers: - image: nginx:1.7.9 name: myngx ports: - containerPort: 80 resources: requests: cpu: 8m 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950# 命令行创建deployk create deployment test-nginx --image=nginx:1.9 --port=80 --replicas=2# 创建yamlk create deployment test-nginx --image=nginx:1.9 --port=80 --replicas=2 --dry-run=client -o yaml &gt; deploy_new.yaml# 创建delpoymentk apply -f deploy_new.yaml# 查看deploy对应的rs信息，会显示升级历史k get rs -owide -l app=test-nginx# 重新启动deploykubectl rollout restart deployment test-nginx# 查看全部deploymentk get deploy# 将指定的deployment输出到yamlk get deploy myngx -o yaml &gt; deploy_nginx.yaml# 删除deploymentk delete deploy myngx# 重新创建deploymentk apply -f deploy_nginx.yaml# 扩缩容，pod不支持扩缩容，只有rs,deploy,sts等高级别controller才有扩缩容能力k scale deploy myngx --replicas=4# rs,deploy,sts等高级别controller都具有自愈能力，如果其下的pod被删除了，会自动重新创建新的pod# 修改deploy# 方式1：编辑配置，就是vim，保存后立即生效k edit deploy test-nginx# 方式2: 命令行，比如修改过镜像版本# k set image deployment deploy名称 镜像名称=镜像k set image deployment test-nginx nginx=nginx:1.7.9# 查看升级是否成功k rollout status -w deployment test-nginx# 查看deploy对应的rs信息，会显示升级历史k get rs -owide -l app=test-nginx# 查看历史版本记录，每行前有个版本号k rollout history deploy test-nginx# 查看指定历史版本号的详细信息k rollout history deploy test-nginx --revision=2# 回退到上一个版本k rollout undo deploy test-nginx# 回退到指定的版本k rollout undo deploy test-nginx --to-revision=2 daemonset–ds 每个node都会创建一个pod，当有新的node加入进来时，pod会自动被daemonset调度到新的node上，同理删除node，该node上的pod也会被移除 1234567891011121314151617181920212223242526272829# ds1.yamlapiVersion: apps/v1kind: DaemonSetmetadata: name: ds1 namespace: kube-system labels: k8s-app: fluentd-loggingspec: selector: matchLabels: name: mynginx template: metadata: labels: name: mynginx spec: tolerations: - key: node-role.kubernetes.io/master effect: NoSchedule containers: - name: mynginx image: nginx:1.7.9 resources: limits: memory: 200Mi requests: cpu: 100m memory: 200Mi 12345678910# 创建dsk apply -f ds1.yaml# daemonset不支持使用create创建，但其格式与deployment差不多，可以先通过create创建deploy的yaml，然后对其进行修改，# 如修改 apiVersion 和 kind，同时还要去掉replicas，另外需要加上tolerance的配置，保证其在master节点上也能部署k run nginx --image=nginx:1.9 --dry-run -o yaml &gt; ds_new.yaml# 查询dsk get ds -n kube-system# 删除k delete ds -n kube-system ds1 job 12345678910111213141516171819# job.yamlapiVersion: batch/v1kind: Jobmetadata: name: job-demospec: template: metadata: name: job-demo spec: restartPolicy: Never containers: - name: counter image: busybox command: - &quot;bin/sh&quot; - &quot;-c&quot; - &quot;for i in 9 8 7 6 5 4 3 2 1; do echo $i; done&quot; imagePullPolicy: IfNotPresent 12k apply -f job.yamlk get jobs cronjob–cj 12345678910111213141516171819# cronjob.yamlapiVersion: batch/v1kind: CronJobmetadata: name: cronjob-demospec: schedule: &quot;*/1 * * * *&quot; jobTemplate: spec: template: spec: restartPolicy: OnFailure containers: - name: hello image: busybox args: - &quot;bin/sh&quot; - &quot;-c&quot; - &quot;for i in 9 8 7 6 5 4 3 2 1; do echo $i; done&quot; 123k apply -f cronjob.yamlk get cronjob -o widek get job statefulset–sts sts的特性 ● 稳定的、唯一的网络标识。 ● 稳定的、持久化的存储。 ● 有序的、优雅的部署和扩展。 ● 有序的、优雅的删除和停止。 12345678910111213141516171819202122# sts.yamlapiVersion: apps/v1kind: StatefulSetmetadata: name: webspec: serviceName: &quot;nginx&quot; replicas: 3 selector: matchLabels: app: nginx template: metadata: labels: app: nginx spec: containers: - name: nginx image: nginx:1.9 ports: - containerPort: 80 name: web 12k apply -f sts.yamlk get sts -owide label标签 controller和service等都是基于标签选择器关联pod的，所以在指定label时一定要准确唯一 123456789# 可以为任何资源设置标签# k label 资源类型 资源名称 key=valuek label deploy myngx app=test# 查看标签k get deploy --show-labels# 查看指定的标签值，标签会占用一列进行展示，多个标签使用逗号分隔，如果资源不存在该标签，则为空k get pod -L app,run# 只列出给定标签和值的资源k get pod -l app=test Configmap–cm 用来存储配置文件的 kubernetes 资源对象，配置内容都存储在 etcd 中 创建方法 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104# 通过直接在命令行中指定 configmap 参数创建，即--from-literal$ k create configmap config-map1 --from-literal=db.host=mysql.db --from-literal=db.port=&#x27;3306&#x27;$ k describe cm config-map1Name: config-map1Namespace: testLabels: &lt;none&gt;Annotations: &lt;none&gt;Data====db.host:----mysql.dbdb.port:----3306BinaryData====Events: &lt;none&gt;# 通过指定文件创建，即将一个配置文件创建为一个 ConfigMap --from-file=&lt;文件&gt;# 如果不指定key，则文件名称作为key$ vi configs/app.propertiesdb.host mysql.dbdb.port 3306$ k create configmap config-map2 --from-file=key1=./configs/app.properties$ k describe cm config-map2Name: config-map2Namespace: testLabels: &lt;none&gt;Annotations: &lt;none&gt;Data====key1:----db.host mysql.dbdb.port 3306BinaryData====Events: &lt;none&gt;# 通过指定目录创建，即将一个目录下的所有配置文件创建为一个 ConfigMap，--from-file=&lt;目录&gt;$ k create configmap config-map3 --from-file=./configs$ k describe cm config-map3Name: config-map3Namespace: testLabels: &lt;none&gt;Annotations: &lt;none&gt;Data====app-copy.properties:----db.host mysql.dbdb.port 3306app.properties:----db.host mysql.dbdb.port 3306BinaryData====Events: &lt;none&gt;# 事先写好标准的 configmap 的 yaml 文件，然后 kubectl create -f 创建$ vim config-map4.yamlapiVersion: v1data: db.host: mysql.db db.port: &quot;3306&quot; # 数字一定要用双引号括起来kind: ConfigMapmetadata: name: config-map4$ k apply -f config-map4.yaml$ k describe cm config-map4Name: config-map4Namespace: testLabels: &lt;none&gt;Annotations: &lt;none&gt;Data====db.host:----mysql.dbdb.port:----3306BinaryData====Events: &lt;none&gt; 使用方法 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273## 通过环境变量使用# 1.使用 valueFrom、configMapKeyRef、name、key 指定要用的 key:apiVersion: v1kind: Podmetadata: name: appspec: containers: - name: app image: centos env: - name: DB_HOST # 环境变量名称 valueFrom: configMapKeyRef: name: config-map4 # cm名称 key: db.host # cm中的key# 2.通过 envFrom、configMapRef、name 使得 configmap 中的所有 key/value 对都自动变成环境变量apiVersion: v1kind: Podmetadata: name: appspec: containers: - name: app image: centos envFrom: configMapRef: name: config-map4## 在启动命令中引用apiVersion: v1kind: Podmetadata: name: appspec: containers: - name: app image: centos command: [&quot;/bin/sh&quot;] args: [&quot;-c&quot;, &quot;while true; do echo $(DB_HOST) $(DB_PORT) &gt;&gt; /out.txt; sleep 5; done&quot;] env: - name: DB_HOST valueFrom: configMapKeyRef: name: config-map4 key: db.host - name: DB_PORT valueFrom: configMapKeyRef: name: config-map4 key: db.port## 作为 volume 挂载使用apiVersion: v1kind: Podmetadata: name: appspec: containers: - name: app image: centos command: [&quot;/bin/sh&quot;] args: [&quot;-c&quot;, &quot;while true; do cat /tmp/config.properties &gt;&gt; /out.txt; sleep 5; done&quot;] volumeMounts: - name: config-map3 mountPath: /tmp/config.properties # 挂载到的文件 subPath: app.properties # 被挂载的文件，即cm中的多个文件中的一个 volumes: - name: config-map3 configMap: name: config-map3 Secrets Secret 解决了密码、token、密钥等敏感数据的配置问题，而不需要把这些敏感数据暴露到镜像或者 Pod Spec 中。 Secret 可以以 Volume 或者环境变量的方式使用。 Secrets 类型 创建 Secret 时，你可以使用 Secret 资源的 type 字段，或者与其等价的 kubectl 命令行参数（如果有的话）为其设置类型。 Kubernetes 提供若干种内置的类型，用于一些常见的使用场景。 针对这些类型，Kubernetes 所执行的合法性检查操作以及对其所实施的限制各不相同。 内置类型 用法 Opaque 用户定义的任意数据 kubernetes.io/service-account-token 服务账号令牌 kubernetes.io/dockercfg ~/.dockercfg 文件的序列化形式 kubernetes.io/dockerconfigjson ~/.docker/config.json 文件的序列化形式 kubernetes.io/basic-auth 用于基本身份认证的凭据 kubernetes.io/ssh-auth 用于 SSH 身份认证的凭据 kubernetes.io/tls 用于 TLS 客户端或者服务器端的数据 bootstrap.kubernetes.io/token 启动引导令牌数据 通过为 Secret 对象的 type 字段设置一个非空的字符串值，你也可以定义并使用自己 Secret 类型（如果 type 值为空字符串，则被视为 Opaque 类型）。 关于Secret类型的进一步说请查看https://kubernetes.io/zh-cn/docs/concepts/configuration/secret/，以下示例仅对常用的Opaque进行说明。 创建 Secret 12345678910111213141516171819202122232425262728293031323334# 配置文件创建$ echo -n &#x27;my-app&#x27; | base64bXktYXBw$ echo -n &#x27;39528$vdg7Jb&#x27; | base64Mzk1MjgkdmRnN0pi# 配置文件# secret.yamlapiVersion: v1kind: Secretmetadata: name: test-secretdata: username: bXktYXBw # value必须是警告base64加密后的值 password: Mzk1MjgkdmRnN0pi$ k apply -f secret.yaml$ k describe secrets test-secretName: test-secretNamespace: testLabels: &lt;none&gt;Annotations: &lt;none&gt;Type: OpaqueData====username: 6 bytespassword: 12 bytes# 命令行创建，此时明文创建即可$ kubectl create secret generic test-secret2 --from-literal=&#x27;username=my-app&#x27; --from-literal=&#x27;password=39528$vdg7Jb&#x27;# 文件创建$ kubectl create secret generic ssh-key-secret --from-file=ssh-privatekey=/path/to/.ssh/id_rsa --from-file=ssh-publickey=/path/to/.ssh/id_rsa.pub 使用 Secret 创建一个可以通过卷访问 Secret 数据的 Pod 12345678910111213141516171819202122232425# secret-pod.yamlapiVersion: v1kind: Podmetadata: name: secret-test-podspec: containers: - name: test-container image: nginx volumeMounts: # name 必须与下面的卷名匹配 - name: secret-volume mountPath: /etc/secret-volume readOnly: true # Secret 数据通过一个卷暴露给该 Pod 中的容器 volumes: - name: secret-volume secret: secretName: test-secret$ k apply -f secret-pod.yaml# 输出包含两个文件，每个对应一个 Secret 数据条目$ kubectl exec -i -t secret-test-pod -- ls /etc/secret-volumepassword username 映射 Secret 键到特定文件路径 来自 mysecret 的键 username 可以在路径 /etc/foo/my-group/my-username 下供容器使用，而不是路径 /etc/foo/username 来自该 Secret 的键 password 没有映射到任何路径 12345678910111213141516171819apiVersion: v1kind: Podmetadata: name: mypodspec: containers: - name: mypod image: redis volumeMounts: - name: foo mountPath: &quot;/etc/foo&quot; readOnly: true volumes: - name: foo secret: secretName: mysecret items: - key: username path: my-group/my-username 使用来自 Secret 中的数据定义容器变量 123456789101112131415161718$ k create secret generic backend-user --from-literal=backend-username=&#x27;backend-admin&#x27;# pod-single-secret-env-variable.yamlapiVersion: v1 kind: Pod metadata: name: env-single-secret spec: containers: - name: envars-test-container image: nginx env: - name: SECRET_USERNAME valueFrom: secretKeyRef: name: backend-user key: backend-username$ k apply -f pod-single-secret-env-variable.yaml$ k exec -i -t env-single-secret -- /bin/sh -c &#x27;echo $SECRET_USERNAME&#x27; 将 Secret 中的所有键值偶对定义为环境变量 123456789101112131415$ k create secret generic test-secret --from-literal=username=&#x27;my-app&#x27; --from-literal=password=&#x27;39528$vdg7Jb&#x27;# pod-secret-envFrom.yamlapiVersion: v1 kind: Pod metadata: name: envfrom-secret spec: containers: - name: envars-test-container image: nginx envFrom: - secretRef: name: test-secret$ k apply -f pod-secret-envFrom.yaml$ k exec -i -t envfrom-secret -- /bin/sh -c &#x27;echo &quot;username: $username\\npassword: $password\\n&quot;&#x27; service–svc svc负责解决端口映射的问题 Kubernetes ServiceTypes 允许指定你所需要的 Service 类型。 可用的 type 值及其行为有： ClusterIP 通过集群的内部 IP 暴露服务，选择该值时服务只能够在集群内部访问。 这也是你没有为服务显式指定 type 时使用的默认值。 你可以使用 Ingress 或者 Gateway API 向公众暴露服务。 NodePort 通过每个节点上的 IP 和静态端口（NodePort）暴露服务。 为了让节点端口可用，Kubernetes 设置了集群 IP 地址，这等同于你请求 type: ClusterIP 的服务。 LoadBalancer 使用云提供商的负载均衡器向外部暴露服务。 Kubernetes 不直接提供负载均衡组件；你必须提供一个，或者将你的 Kubernetes 集群与云提供商集成。 ExternalName 将服务映射到 externalName 字段的内容（例如，映射到主机名 api.foo.bar.example）。 该映射将集群的 DNS 服务器配置为返回具有该外部主机名值的 CNAME 记录。 无需创建任何类型代理。 NodePort 可以让 kubernetes 在其所在节点上保留一个端口（所有节点上都使用相同的端口号），然后将传入的连接转发给 pod 1234567891011121314# svc-nodeport.yamlapiVersion: v1kind: Servicemetadata: name: svc-nodeportspec: ports: - name: test-nginx port: 3080 targetPort: 80 nodePort: 32115 # 此处指定具体的端口，不能重复，如果没有配置则随机创建 selector: app: test-nginx type: NodePort ClusterIP 提供虚拟ip 123456# 基于delpoyment创建servicek expose deployment test-nginx --name svc-cluster-ip --port=3280 --target-port=80 --type=ClusterIP# 不创建，只生成yaml文件k expose deployment test-nginx --name svc-cluster-ip --port=3280 --target-port=80 --type=ClusterIP --dry-run=client -o yaml &gt; svc-cluster-ip.yaml# 基于yaml创建servicek apply -f svc-cluster-ip.yaml Headless service clusterIP：基于statefulset创建service 不提供虚拟ip，而是返回具体的pod地址，并且基于如下规则查找： $&#123;podName&#125;.$&#123;headlessServiceName即svcName&#125;.$&#123;namespace&#125;.$&#123;clusterDomainName&#125;， 同一个namespace的pod访问时一般指定到${headlessServiceName}即可，跨namespace时需要指定到${namespace} 1234567891011121314# svc-sts-web.yamlapiVersion: v1kind: Servicemetadata: name: nginx labels: app: nginxspec: ports: - port: 80 name: web clusterIP: None # 这里必须设置为None selector: app: nginx LoadBalancer 相比 NodePort 方式可以通过任何节点的 指定 端口访问内部的 pod，LoadBalancer 方式拥有自己独一无二的可公开访问的 IP 地址； LoadBalance 其实是 NodePort 的一种扩展，使得服务可以通过一个专用的负载均衡器来访问。 如果是自建k8s，Kubernetes 没 有 为 裸 机 集 群 提 供 网 络 负 载 平 衡 器 的 实 现，所以需要安装一个LoadBalancer，比如 MetaLb 负载均衡，这里不做赘述。 EKS安装 AWS Load Balancer Controller 附加组件后即可提供支持。 可以基于pod直接创建svc 12345678# 启动一个pod，默认的label是 run=nginx-appkubectl run nginx-app --image=nginx --restart=Never --port=80# 为pod添加标签k label pod nginx-app app=nginx-app# 创建一个svc的yaml文件，其selector为app: nginx-app，这里没有指定nodePort，创建时会随机分配一个端口# 也可以修改生成的yaml文件，使其符合要求kubectl create svc nodeport nginx-app --tcp=80:80 --dry-run -o yaml &gt; svc_pod.yamlk apply -f svc_pod.yaml 查看svc 123456789101112131415161718# 查看svc，注意查看TYPE，CLUSTER-IP ，EXTERNAL-IP，PORT显示的不同之处&gt; k get svc -o wideNAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE SELECTORnginx ClusterIP None &lt;none&gt; 80/TCP 130m app=nginxsvc-loadbalance-nginx LoadBalancer 172.20.57.83 aa39ab20daad5447da7ee7d283ab2a83-1210832584.ap-east-1.elb.amazonaws.com 3081:32116/TCP 10m app=test-nginxsvc-test-nginx NodePort 172.20.39.12 &lt;none&gt; 3080:32115/TCP 18h app=test-nginxtest-loadbalancer-new LoadBalancer 172.20.242.126 a2774e4dc02ad42cc97c54fc9968624b-882652598.ap-east-1.elb.amazonaws.com 3282:31212/TCP 10s app=test-nginxtest-nginx-new ClusterIP 172.20.144.96 &lt;none&gt; 3280/TCP 162m app=test-nginx# 查看endpoint--epk get endpoints&gt; k get epNAME ENDPOINTS AGEnginx 10.25.113.205:80,10.25.142.172:80,10.25.148.165:80 132msvc-loadbalance-nginx 10.25.116.40:80,10.25.121.198:80,10.25.122.75:80 12msvc-test-nginx 10.25.116.40:80,10.25.121.198:80,10.25.122.75:80 18htest-loadbalancer-new 10.25.116.40:80,10.25.121.198:80,10.25.122.75:80 2m11stest-nginx-new 10.25.116.40:80,10.25.121.198:80,10.25.122.75:80 164m Ingress Ingress将来自集群外部的 HTTP 和 HTTPS 路由暴露给集群 内的服务。流量路由由 Ingress 资源上定义的规则控制。 私有k8s不提供Ingress，需要自行安装。 基于aws-eks等云服务通过安装 AWS Load Balancer Controller 附加组件提供Ingress功能。 123k get ingk get ing -Ak get ing -n test HPA：Horizontal Pod Autoscaler 自动弹性伸缩 实现hpa的前提是k8s集群中部署 metrics-server，其可对node和pod占用CPU、内存的情况进行监控。 123456# 基于deployment创建hpak autoscale deployment test-nginx --max=3 --min=1 --cpu-percent=60# 最多3个pod，最少1个pod，基于cpu使用情况，超过60%时进行扩容# 查看hpak get hpa 其它命令 123456789101112131415161718# 进入podk exec podName -it -- shk exec podName -it -- /bin/bash# 监视变化 -wk get deploy -w# 不显示标题头 --no-headers=truek get pods --no-headers=true# 查看pod的日志输出k logs podName# 编辑一个资源，直接编辑已经部署的资源yamlk edit deploy app# 查看一个资源的部署情况k describe deploy app","summary":"摘要 本文介绍kubectl命令的使用方法 参考资料： Amazon EKS用户指南 Kubernetes 文档","date_published":"2023-07-07T15:50:05.000Z","tags":["技术","aws","eks","java"]},{"id":"https://blog.hanqunfeng.com/2023/07/07/aws-eks12-dashboard/","url":"https://blog.hanqunfeng.com/2023/07/07/aws-eks12-dashboard/","title":"AWS-EKS-12--部署 Dashboard UI","content_html":"<!--\n **加粗**\n *斜体*\n ***加粗并斜体***\n ~~删除线~~\n ==突出显示==\n `突出显示(推荐)`\n ++下划线++\n ~下标~\n ^上标^\n 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.\n 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600)\n\n +++ **点击折叠**\n 这是被隐藏的内容\n +++\n\n::: tips success warning danger\n这里是容器内的内容\n:::\n\n% note info % success warning danger\n这里是容器内的内容\n% endnote %\n\n -->\n<h2 id=\"摘要\">摘要</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>本文介绍为EKS集群部署 Dashboard UI</p>\n</li>\n<li class=\"lvl-2\">\n<p>参考资料：</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\"><a href=\"https://docs.aws.amazon.com/zh_cn/eks/latest/userguide\">Amazon EKS用户指南</a></li>\n<li class=\"lvl-6\"><a href=\"https://kubernetes.io/zh-cn/docs/home/\">Kubernetes 文档</a></li>\n</ul>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"部署-Dashboard-UI\">部署 Dashboard UI</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><a href=\"https://kubernetes.io/zh-cn/docs/tasks/access-application-cluster/web-ui-dashboard/\">官方文档</a></p>\n</li>\n<li class=\"lvl-2\">\n<p>部署服务</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.7.0/aio/deploy/recommended.yaml</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>创建用户</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">Dashboard 支持使用 Bearer 令牌登录。</li>\n<li class=\"lvl-6\"><a href=\"https://github.com/kubernetes/dashboard/blob/master/docs/user/access-control/creating-sample-user.md\">创建用户</a></li>\n</ul>\n</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># dashboard-adminuser.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">admin-user</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">kubernetes-dashboard</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ClusterRoleBinding</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">admin-user</span></span><br><span class=\"line\"><span class=\"attr\">roleRef:</span></span><br><span class=\"line\">  <span class=\"attr\">apiGroup:</span> <span class=\"string\">rbac.authorization.k8s.io</span></span><br><span class=\"line\">  <span class=\"attr\">kind:</span> <span class=\"string\">ClusterRole</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">cluster-admin</span></span><br><span class=\"line\"><span class=\"attr\">subjects:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">admin-user</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">kubernetes-dashboard</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>授权</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-4\">这里创建一个 sa <code>admin-user</code>和 ClusterRoleBinding <code>admin-user</code>，利用 ClusterRoleBinding 赋予 sa 访问集群的 admin 权限</li>\n</ul>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 向dashboard的服务帐户授予管理员权限</span></span><br><span class=\"line\">$ k apply -f dashboard-adminuser.yaml</span><br><span class=\"line\">serviceaccount/admin-user created</span><br><span class=\"line\">clusterrolebinding.rbac.authorization.k8s.io/admin-user created</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>获取登录令牌<br>\n<em><strong>k8s-1.24后就不再为ServiceAccout提供默认的无到期时间的Secret了，而是需要获取有效期为3600秒的token</strong></em></p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 获取登录令牌，这就是一个JWT，可以在 https://jwt.io 中查看解析后的内容</span></span><br><span class=\"line\">$ kubectl -n kubernetes-dashboard create token admin-user</span><br><span class=\"line\">eyJhbGciOiJSUzI1NiIsImtpZCI6IjgzMWNkMmM1YTE0YWYzZmYzZWU1MzQwYWIxZWRmNmRjN2Q3ZmI1NGQifQ.eyJhdWQiOlsiaHR0cHM6Ly9rdWJlcm5ldGVzLmRlZmF1bHQuc3ZjIl0sImV4cCI6MTY4OTMwNjUyMSwiaWF0IjoxNjg5MzAyOTIxLCJpc3MiOiJodHRwczovL29pZGMuZWtzLnVzLXdlc3QtMi5hbCIsInNlcnZpY2VhY2NvdW50Ijp7Im5hbWUiOiJhZG1pbi11c2VyIiwidWlkIjoiNDdiZGE0MmQtYTc3YS00NzUzLTg3NjItOTZmNmFmODA3ODI2In19LCJuYmYiOjE2ODkzMDI5MjEsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlcm5ldGVzLWRhc2hib2FyZDphZG1pbi11c2VyIn0.fELZiBXQfh2Mn0h8EHbb6BjDSCvHvB2cUDPenbwgMuKIE2NY-pHJdWA0ydZZYGM1aGg2TN0CHZQSMCEAyD3xqXzJF12dThlgVIAXWUWB_PK5_OQ9FSEHJuY2pSvnS0yhtRirbhJFzovYuxymFZjnZWuAJiPlt9k4DCp7rSIIZu89TRzwAlKh_SEnjCMaV4Fvy_Eq7eAxaXHPtatYLrz7vO12vZSA</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 令牌有效期为3600秒，到期后需要重启获取令牌并重新登录。这点不是很方便。加上 -o yaml 即可看到过期时间</span></span><br><span class=\"line\">$ kubectl -n kubernetes-dashboard create token admin-user -o yaml</span><br><span class=\"line\">apiVersion: authentication.k8s.io/v1</span><br><span class=\"line\">kind: TokenRequest</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  creationTimestamp: <span class=\"string\">&quot;2023-07-07T02:48:41Z&quot;</span></span><br><span class=\"line\">  name: admin-user</span><br><span class=\"line\">  namespace: kubernetes-dashboard</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  audiences:</span><br><span class=\"line\">  - https://kubernetes.default.svc</span><br><span class=\"line\">  boundObjectRef: null</span><br><span class=\"line\">  expirationSeconds: 3600</span><br><span class=\"line\">status:</span><br><span class=\"line\">  expirationTimestamp: <span class=\"string\">&quot;2023-07-07T03:48:41Z&quot;</span></span><br><span class=\"line\">  token: eyJhbGciOiJSUzI1NiIsImtpZCI6IjgzMWNkMmM1YTE0YWYzZmYzZWU1MzQwYWIxZWRmNmRjN2Q3ZmI1NGQifQ.eyJhdWQiOlsiaHR0cHM6Ly9rdWJlcm5ldGVzLmRlZmF1bHQuc3ZjIl0sImV4cCI6MTY4OTMwNjUyMSwiaWF0IjoxNjg5MzAyOTIxLCJpc3MiOiJodHRwczovL29pZGMuZWtzLnVzLXdlc3QtMi5hbCIsInNlcnZpY2VhY2NvdW50Ijp7Im5hbWUiOiJhZG1pbi11c2VyIiwidWlkIjoiNDdiZGE0MmQtYTc3YS00NzUzLTg3NjItOTZmNmFmODA3ODI2In19LCJuYmYiOjE2ODkzMDI5MjEsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlcm5ldGVzLWRhc2hib2FyZDphZG1pbi11c2VyIn0.fELZiBXQfh2Mn0h8EHbb6BjDSCvHvB2cUDPenbwgMuKIE2NY-pHJdWA0ydZZYGM1aGg2TN0CHZQSMCEAyD3xqXzJF12dThlgVIAXWUWB_PK5_OQ9FSEHJuY2pSvnS0yhtRirbhJFzovYuxymFZjnZWuAJiPlt9k4DCp7rSIIZu89TRzwAlKh_SEnjCMaV4Fvy_Eq7eAxaXHPtatYLrz7vO12vZSA</span><br></pre></td></tr></table></figure>\n<h2 id=\"访问Dashboard\">访问Dashboard</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>查看Dashboard 的 service，可以看到 Dashboard 的 Service 的类型都是 ClusterIP，所以我们是无法从外部访问到 Dashboard 的。</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubectl get svc -n kubernetes-dashboard</span><br><span class=\"line\">NAME                        TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE</span><br><span class=\"line\">dashboard-metrics-scraper   ClusterIP   10.100.76.198   &lt;none&gt;        8000/TCP   12m</span><br><span class=\"line\">kubernetes-dashboard        ClusterIP   10.100.171.79   &lt;none&gt;        443/TCP    12m</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>这时我们有两种方法访问 Dashboard</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-4\">把 Dashboard 映射到本地</li>\n<li class=\"lvl-4\">利用 ingress 和 ALB 把外部请求转发到 Dashboard</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"把-Dashboard-映射到本地\">把 Dashboard 映射到本地</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>我们可以用 kubectl proxy，也可以用 port-forward</p>\n</li>\n</ul>\n<h4 id=\"利用-kubectl-proxy\">利用 kubectl proxy</h4>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>开启代理</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 默认8001端口</span></span><br><span class=\"line\">~ kubectl proxy</span><br><span class=\"line\">Starting to serve on 127.0.0.1:8001</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 指定端口</span></span><br><span class=\"line\">~ kubectl proxy --port 8888</span><br><span class=\"line\">Starting to serve on 127.0.0.1:8888</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 关闭代理</span></span><br><span class=\"line\">Ctrl+C</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>本地访问</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">可以通过 <a href=\"http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/\">http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/</a> 访问。</li>\n<li class=\"lvl-6\">登录时选择token登录，输入上面获取到的令牌即可，令牌有效期为3600秒，到期后需要重启获取令牌并重新登录。</li>\n</ul>\n</li>\n</ul>\n<p><img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/IDKZ0Z.jpg\" alt=\"\" width=\"1200\" height=\"700\"></p>\n<h4 id=\"利用-kubectl-port-forward\">利用 kubectl port-forward</h4>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>上面利用 kubectl proxy的方法是把整个 apiserver 通过 proxy 映射到本地，下面我们只把 dashboard 的 deployment(Pod)映射到本地。</p>\n</li>\n<li class=\"lvl-2\">\n<p>首先，我们先要获得 Pod 的访问端口</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubectl get ep -n kubernetes-dashboard</span><br><span class=\"line\">NAME                        ENDPOINTS             AGE</span><br><span class=\"line\">dashboard-metrics-scraper   192.168.10.200:8000   5d4h</span><br><span class=\"line\">kubernetes-dashboard        192.168.20.125:8443   5d4h</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-4\">\n<p>说明：kubernetes-dashboard 对应的 ENDPOINTS 就是pod的ip和端口，这里开启的就是pod的8443端口。</p>\n</li>\n</ul>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>运行以下命令获得 Dashboard deployment 的 name</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubectl get deployment -n kubernetes-dashboard</span><br><span class=\"line\">NAME                        READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class=\"line\">dashboard-metrics-scraper   1/1     1            1           5d4h</span><br><span class=\"line\">kubernetes-dashboard        1/1     1            1           5d4h</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-4\">\n<p>说明：kubernetes-dashboard 是 Deployment 的名称</p>\n</li>\n</ul>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>开启本地端口映射，这里映射到本地的8888端口</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubectl port-forward deployment/kubernetes-dashboard -n kubernetes-dashboard 8888:8443</span><br><span class=\"line\">Forwarding from 127.0.0.1:8888 -&gt; 8443</span><br><span class=\"line\">Forwarding from [::1]:8888 -&gt; 8443</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-4\">\n<p>可以通过 <a href=\"https://localhost:8888/#/login\">https://localhost:8888/#/login</a> 访问。</p>\n</li>\n<li class=\"lvl-4\">\n<p>登录时选择token登录，输入上面获取到的令牌即可，令牌有效期为3600秒，到期后需要重启获取令牌并重新登录。</p>\n</li>\n</ul>\n<h3 id=\"利用-ingress-和-ALB-把外部请求转发到-Dashboard\">利用 ingress 和 ALB 把外部请求转发到 Dashboard</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>proxy，port-forward 可以把 apiserver 或者某个 deployment 映射到本地，这对调试一些应用来说很有用处。</p>\n</li>\n<li class=\"lvl-2\">\n<p>不过，这两个都是前台命令，每次查看 Dashboard 都要先运行一下，使用起来确实不方便，下面介绍如何利用 ALB 访问 Dashboard。</p>\n</li>\n<li class=\"lvl-2\">\n<p>前面我们已经介绍过<a href=\"/2023/07/07/aws-eks09-service-ingress/\" title=\"AWS-EKS-09--创建基于LoadBalancer的service和ingress\">创建基于LoadBalancer的service和ingress</a>，接下来我们就在此基础上完成后续的步骤。</p>\n</li>\n</ul>\n<h4 id=\"创建ingress\">创建ingress</h4>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># dashboard-ingress.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">networking.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">kubernetes-dashboard</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">dashboard</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">alb.ingress.kubernetes.io/actions.ssl-redirect:</span> <span class=\"string\">&#x27;&#123;&quot;Type&quot;: &quot;redirect&quot;, &quot;RedirectConfig&quot;:&#123; &quot;Protocol&quot;: &quot;HTTPS&quot;, &quot;Port&quot;: &quot;443&quot;, &quot;StatusCode&quot;: &quot;HTTP_301&quot;&#125;&#125;&#x27;</span>  <span class=\"comment\"># http重定向到https</span></span><br><span class=\"line\">    <span class=\"attr\">alb.ingress.kubernetes.io/certificate-arn:</span> <span class=\"string\">arn:aws:acm:us-west-2:743263909655:certificate/e2e3fa54-98ab-427a-9f09-4861122831323e</span> <span class=\"comment\"># https证书，就是上面创建的证书的arn</span></span><br><span class=\"line\">    <span class=\"attr\">alb.ingress.kubernetes.io/listen-ports:</span> <span class=\"string\">&#x27;[&#123;&quot;HTTP&quot;: 80&#125;, &#123;&quot;HTTPS&quot;:443&#125;]&#x27;</span> <span class=\"comment\"># 监听端口</span></span><br><span class=\"line\">    <span class=\"attr\">alb.ingress.kubernetes.io/scheme:</span> <span class=\"string\">internet-facing</span> <span class=\"comment\"># 开放外网访问</span></span><br><span class=\"line\">    <span class=\"attr\">alb.ingress.kubernetes.io/target-type:</span> <span class=\"string\">ip</span></span><br><span class=\"line\">    <span class=\"attr\">alb.ingress.kubernetes.io/backend-protocol:</span> <span class=\"string\">HTTPS</span> <span class=\"comment\"># 转发请求用的协议，默认是HTTP</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">ingressClassName:</span> <span class=\"string\">alb</span> <span class=\"comment\"># 指定ingressclass类型，k8s-1.18及以后的版本推荐这种配置方式，旧版本需要在注释中加入 kubernetes.io/ingress.class: alb</span></span><br><span class=\"line\">  <span class=\"attr\">rules:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">host:</span> <span class=\"string\">dashboard.hanqunfeng.com</span> <span class=\"comment\"># 域名绑定，需要到域名服务商处进行域名解析，CNAME到当前生成的elb</span></span><br><span class=\"line\">      <span class=\"attr\">http:</span></span><br><span class=\"line\">        <span class=\"attr\">paths:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">path:</span> <span class=\"string\">/</span> <span class=\"comment\"># 重定向配置，这里必须配置，否则不能实现重定向</span></span><br><span class=\"line\">          <span class=\"attr\">pathType:</span> <span class=\"string\">Prefix</span></span><br><span class=\"line\">          <span class=\"attr\">backend:</span></span><br><span class=\"line\">            <span class=\"attr\">service:</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">ssl-redirect</span></span><br><span class=\"line\">              <span class=\"attr\">port:</span></span><br><span class=\"line\">                <span class=\"attr\">name:</span> <span class=\"string\">use-annotation</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">path:</span> <span class=\"string\">/</span></span><br><span class=\"line\">          <span class=\"attr\">pathType:</span> <span class=\"string\">Prefix</span></span><br><span class=\"line\">          <span class=\"attr\">backend:</span></span><br><span class=\"line\">            <span class=\"attr\">service:</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">kubernetes-dashboard</span></span><br><span class=\"line\">              <span class=\"attr\">port:</span></span><br><span class=\"line\">                <span class=\"attr\">number:</span> <span class=\"number\">443</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-4\">\n<p>这里要注意一点，一定要配置<code>alb.ingress.kubernetes.io/backend-protocol: HTTPS</code>，这是转发请求用的协议，默认是HTTP，但是Dashboard应用本身要求访问请求使用HTTPS，所以这里指定HTTPS。如果不指定，则在后面用浏览器访问Dashboard时会报下列错误</p>\n</li>\n</ul>\n  <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Client sent an HTTP request to an HTTPS server.</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 部署ingress</span></span><br><span class=\"line\">$ k apply -f dashboard-ingress.yaml</span><br><span class=\"line\">ingress.networking.k8s.io/dashboard created</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看ingress状态</span></span><br><span class=\"line\">$ k describe ing -n kubernetes-dashboard dashboard</span><br><span class=\"line\">Name:             dashboard</span><br><span class=\"line\">Labels:           &lt;none&gt;</span><br><span class=\"line\">Namespace:        kubernetes-dashboard</span><br><span class=\"line\">Address:          k8s-kubernet-dashboar-043481379b-1952890389.us-west-2.elb.amazonaws.com</span><br><span class=\"line\">Ingress Class:    alb</span><br><span class=\"line\">Default backend:  &lt;default&gt;</span><br><span class=\"line\">Rules:</span><br><span class=\"line\">  Host                      Path  Backends</span><br><span class=\"line\">  ----                      ----  --------</span><br><span class=\"line\">  dashboard.hanqunfeng.com</span><br><span class=\"line\">                            /   ssl-redirect:use-annotation (&lt;error: endpoints <span class=\"string\">&quot;ssl-redirect&quot;</span> not found&gt;)</span><br><span class=\"line\">                            /   kubernetes-dashboard:443 (192.168.20.125:8443)</span><br><span class=\"line\">Annotations:                alb.ingress.kubernetes.io/actions.ssl-redirect:</span><br><span class=\"line\">                              &#123;<span class=\"string\">&quot;Type&quot;</span>: <span class=\"string\">&quot;redirect&quot;</span>, <span class=\"string\">&quot;RedirectConfig&quot;</span>:&#123; <span class=\"string\">&quot;Protocol&quot;</span>: <span class=\"string\">&quot;HTTPS&quot;</span>, <span class=\"string\">&quot;Port&quot;</span>: <span class=\"string\">&quot;443&quot;</span>, <span class=\"string\">&quot;StatusCode&quot;</span>: <span class=\"string\">&quot;HTTP_301&quot;</span>&#125;&#125;</span><br><span class=\"line\">                            alb.ingress.kubernetes.io/backend-protocol: HTTPS</span><br><span class=\"line\">                            alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:us-west-2:743263909655:certificate/e2e3fa54-98ab-427a-9f09-4861122831323e</span><br><span class=\"line\">                            alb.ingress.kubernetes.io/listen-ports: [&#123;<span class=\"string\">&quot;HTTP&quot;</span>: 80&#125;, &#123;<span class=\"string\">&quot;HTTPS&quot;</span>:443&#125;]</span><br><span class=\"line\">                            alb.ingress.kubernetes.io/scheme: internet-facing</span><br><span class=\"line\">                            alb.ingress.kubernetes.io/target-type: ip</span><br><span class=\"line\">Events:</span><br><span class=\"line\">  Type    Reason                  Age    From     Message</span><br><span class=\"line\">  ----    ------                  ----   ----     -------</span><br><span class=\"line\">  Normal  SuccessfullyReconciled  9m16s  ingress  Successfully reconciled</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>完成域名解析后可以访问：<a href=\"https://dashboard.hanqunfeng.com\">https://dashboard.hanqunfeng.com</a></p>\n</li>\n</ul>\n<h2 id=\"清理帐号\">清理帐号</h2>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 删除管理员ServiceAccount和ClusterRoleBinding</span></span><br><span class=\"line\">$ kubectl -n kubernetes-dashboard delete serviceaccount admin-user</span><br><span class=\"line\">$ kubectl -n kubernetes-dashboard delete clusterrolebinding admin-user</span><br></pre></td></tr></table></figure>\n<h2 id=\"后记\">后记</h2>\n<p>这玩意就是查看资源方便一些，创建资源还是需要精通yaml。</p>\n","content_text":"摘要 本文介绍为EKS集群部署 Dashboard UI 参考资料： Amazon EKS用户指南 Kubernetes 文档 部署 Dashboard UI 官方文档 部署服务 1$ kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.7.0/aio/deploy/recommended.yaml 创建用户 Dashboard 支持使用 Bearer 令牌登录。 创建用户 12345678910111213141516171819# dashboard-adminuser.yamlapiVersion: v1kind: ServiceAccountmetadata: name: admin-user namespace: kubernetes-dashboard---apiVersion: rbac.authorization.k8s.io/v1kind: ClusterRoleBindingmetadata: name: admin-userroleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: cluster-adminsubjects:- kind: ServiceAccount name: admin-user namespace: kubernetes-dashboard 授权 这里创建一个 sa admin-user和 ClusterRoleBinding admin-user，利用 ClusterRoleBinding 赋予 sa 访问集群的 admin 权限 1234# 向dashboard的服务帐户授予管理员权限$ k apply -f dashboard-adminuser.yamlserviceaccount/admin-user createdclusterrolebinding.rbac.authorization.k8s.io/admin-user created 获取登录令牌 k8s-1.24后就不再为ServiceAccout提供默认的无到期时间的Secret了，而是需要获取有效期为3600秒的token 1234567891011121314151617181920# 获取登录令牌，这就是一个JWT，可以在 https://jwt.io 中查看解析后的内容$ kubectl -n kubernetes-dashboard create token admin-usereyJhbGciOiJSUzI1NiIsImtpZCI6IjgzMWNkMmM1YTE0YWYzZmYzZWU1MzQwYWIxZWRmNmRjN2Q3ZmI1NGQifQ.eyJhdWQiOlsiaHR0cHM6Ly9rdWJlcm5ldGVzLmRlZmF1bHQuc3ZjIl0sImV4cCI6MTY4OTMwNjUyMSwiaWF0IjoxNjg5MzAyOTIxLCJpc3MiOiJodHRwczovL29pZGMuZWtzLnVzLXdlc3QtMi5hbCIsInNlcnZpY2VhY2NvdW50Ijp7Im5hbWUiOiJhZG1pbi11c2VyIiwidWlkIjoiNDdiZGE0MmQtYTc3YS00NzUzLTg3NjItOTZmNmFmODA3ODI2In19LCJuYmYiOjE2ODkzMDI5MjEsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlcm5ldGVzLWRhc2hib2FyZDphZG1pbi11c2VyIn0.fELZiBXQfh2Mn0h8EHbb6BjDSCvHvB2cUDPenbwgMuKIE2NY-pHJdWA0ydZZYGM1aGg2TN0CHZQSMCEAyD3xqXzJF12dThlgVIAXWUWB_PK5_OQ9FSEHJuY2pSvnS0yhtRirbhJFzovYuxymFZjnZWuAJiPlt9k4DCp7rSIIZu89TRzwAlKh_SEnjCMaV4Fvy_Eq7eAxaXHPtatYLrz7vO12vZSA# 令牌有效期为3600秒，到期后需要重启获取令牌并重新登录。这点不是很方便。加上 -o yaml 即可看到过期时间$ kubectl -n kubernetes-dashboard create token admin-user -o yamlapiVersion: authentication.k8s.io/v1kind: TokenRequestmetadata: creationTimestamp: &quot;2023-07-07T02:48:41Z&quot; name: admin-user namespace: kubernetes-dashboardspec: audiences: - https://kubernetes.default.svc boundObjectRef: null expirationSeconds: 3600status: expirationTimestamp: &quot;2023-07-07T03:48:41Z&quot; token: eyJhbGciOiJSUzI1NiIsImtpZCI6IjgzMWNkMmM1YTE0YWYzZmYzZWU1MzQwYWIxZWRmNmRjN2Q3ZmI1NGQifQ.eyJhdWQiOlsiaHR0cHM6Ly9rdWJlcm5ldGVzLmRlZmF1bHQuc3ZjIl0sImV4cCI6MTY4OTMwNjUyMSwiaWF0IjoxNjg5MzAyOTIxLCJpc3MiOiJodHRwczovL29pZGMuZWtzLnVzLXdlc3QtMi5hbCIsInNlcnZpY2VhY2NvdW50Ijp7Im5hbWUiOiJhZG1pbi11c2VyIiwidWlkIjoiNDdiZGE0MmQtYTc3YS00NzUzLTg3NjItOTZmNmFmODA3ODI2In19LCJuYmYiOjE2ODkzMDI5MjEsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlcm5ldGVzLWRhc2hib2FyZDphZG1pbi11c2VyIn0.fELZiBXQfh2Mn0h8EHbb6BjDSCvHvB2cUDPenbwgMuKIE2NY-pHJdWA0ydZZYGM1aGg2TN0CHZQSMCEAyD3xqXzJF12dThlgVIAXWUWB_PK5_OQ9FSEHJuY2pSvnS0yhtRirbhJFzovYuxymFZjnZWuAJiPlt9k4DCp7rSIIZu89TRzwAlKh_SEnjCMaV4Fvy_Eq7eAxaXHPtatYLrz7vO12vZSA 访问Dashboard 查看Dashboard 的 service，可以看到 Dashboard 的 Service 的类型都是 ClusterIP，所以我们是无法从外部访问到 Dashboard 的。 1234$ kubectl get svc -n kubernetes-dashboardNAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGEdashboard-metrics-scraper ClusterIP 10.100.76.198 &lt;none&gt; 8000/TCP 12mkubernetes-dashboard ClusterIP 10.100.171.79 &lt;none&gt; 443/TCP 12m 这时我们有两种方法访问 Dashboard 把 Dashboard 映射到本地 利用 ingress 和 ALB 把外部请求转发到 Dashboard 把 Dashboard 映射到本地 我们可以用 kubectl proxy，也可以用 port-forward 利用 kubectl proxy 开启代理 12345678910# 默认8001端口~ kubectl proxyStarting to serve on 127.0.0.1:8001# 指定端口~ kubectl proxy --port 8888Starting to serve on 127.0.0.1:8888# 关闭代理Ctrl+C 本地访问 可以通过 http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/ 访问。 登录时选择token登录，输入上面获取到的令牌即可，令牌有效期为3600秒，到期后需要重启获取令牌并重新登录。 利用 kubectl port-forward 上面利用 kubectl proxy的方法是把整个 apiserver 通过 proxy 映射到本地，下面我们只把 dashboard 的 deployment(Pod)映射到本地。 首先，我们先要获得 Pod 的访问端口 1234$ kubectl get ep -n kubernetes-dashboardNAME ENDPOINTS AGEdashboard-metrics-scraper 192.168.10.200:8000 5d4hkubernetes-dashboard 192.168.20.125:8443 5d4h 说明：kubernetes-dashboard 对应的 ENDPOINTS 就是pod的ip和端口，这里开启的就是pod的8443端口。 运行以下命令获得 Dashboard deployment 的 name 1234$ kubectl get deployment -n kubernetes-dashboardNAME READY UP-TO-DATE AVAILABLE AGEdashboard-metrics-scraper 1/1 1 1 5d4hkubernetes-dashboard 1/1 1 1 5d4h 说明：kubernetes-dashboard 是 Deployment 的名称 开启本地端口映射，这里映射到本地的8888端口 123$ kubectl port-forward deployment/kubernetes-dashboard -n kubernetes-dashboard 8888:8443Forwarding from 127.0.0.1:8888 -&gt; 8443Forwarding from [::1]:8888 -&gt; 8443 可以通过 https://localhost:8888/#/login 访问。 登录时选择token登录，输入上面获取到的令牌即可，令牌有效期为3600秒，到期后需要重启获取令牌并重新登录。 利用 ingress 和 ALB 把外部请求转发到 Dashboard proxy，port-forward 可以把 apiserver 或者某个 deployment 映射到本地，这对调试一些应用来说很有用处。 不过，这两个都是前台命令，每次查看 Dashboard 都要先运行一下，使用起来确实不方便，下面介绍如何利用 ALB 访问 Dashboard。 前面我们已经介绍过创建基于LoadBalancer的service和ingress，接下来我们就在此基础上完成后续的步骤。 创建ingress 12345678910111213141516171819202122232425262728293031323334# dashboard-ingress.yamlapiVersion: networking.k8s.io/v1kind: Ingressmetadata: namespace: kubernetes-dashboard name: dashboard annotations: alb.ingress.kubernetes.io/actions.ssl-redirect: &#x27;&#123;&quot;Type&quot;: &quot;redirect&quot;, &quot;RedirectConfig&quot;:&#123; &quot;Protocol&quot;: &quot;HTTPS&quot;, &quot;Port&quot;: &quot;443&quot;, &quot;StatusCode&quot;: &quot;HTTP_301&quot;&#125;&#125;&#x27; # http重定向到https alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:us-west-2:743263909655:certificate/e2e3fa54-98ab-427a-9f09-4861122831323e # https证书，就是上面创建的证书的arn alb.ingress.kubernetes.io/listen-ports: &#x27;[&#123;&quot;HTTP&quot;: 80&#125;, &#123;&quot;HTTPS&quot;:443&#125;]&#x27; # 监听端口 alb.ingress.kubernetes.io/scheme: internet-facing # 开放外网访问 alb.ingress.kubernetes.io/target-type: ip alb.ingress.kubernetes.io/backend-protocol: HTTPS # 转发请求用的协议，默认是HTTPspec: ingressClassName: alb # 指定ingressclass类型，k8s-1.18及以后的版本推荐这种配置方式，旧版本需要在注释中加入 kubernetes.io/ingress.class: alb rules: - host: dashboard.hanqunfeng.com # 域名绑定，需要到域名服务商处进行域名解析，CNAME到当前生成的elb http: paths: - path: / # 重定向配置，这里必须配置，否则不能实现重定向 pathType: Prefix backend: service: name: ssl-redirect port: name: use-annotation - path: / pathType: Prefix backend: service: name: kubernetes-dashboard port: number: 443 这里要注意一点，一定要配置alb.ingress.kubernetes.io/backend-protocol: HTTPS，这是转发请求用的协议，默认是HTTP，但是Dashboard应用本身要求访问请求使用HTTPS，所以这里指定HTTPS。如果不指定，则在后面用浏览器访问Dashboard时会报下列错误 1Client sent an HTTP request to an HTTPS server. 1234567891011121314151617181920212223242526272829# 部署ingress$ k apply -f dashboard-ingress.yamlingress.networking.k8s.io/dashboard created# 查看ingress状态$ k describe ing -n kubernetes-dashboard dashboardName: dashboardLabels: &lt;none&gt;Namespace: kubernetes-dashboardAddress: k8s-kubernet-dashboar-043481379b-1952890389.us-west-2.elb.amazonaws.comIngress Class: albDefault backend: &lt;default&gt;Rules: Host Path Backends ---- ---- -------- dashboard.hanqunfeng.com / ssl-redirect:use-annotation (&lt;error: endpoints &quot;ssl-redirect&quot; not found&gt;) / kubernetes-dashboard:443 (192.168.20.125:8443)Annotations: alb.ingress.kubernetes.io/actions.ssl-redirect: &#123;&quot;Type&quot;: &quot;redirect&quot;, &quot;RedirectConfig&quot;:&#123; &quot;Protocol&quot;: &quot;HTTPS&quot;, &quot;Port&quot;: &quot;443&quot;, &quot;StatusCode&quot;: &quot;HTTP_301&quot;&#125;&#125; alb.ingress.kubernetes.io/backend-protocol: HTTPS alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:us-west-2:743263909655:certificate/e2e3fa54-98ab-427a-9f09-4861122831323e alb.ingress.kubernetes.io/listen-ports: [&#123;&quot;HTTP&quot;: 80&#125;, &#123;&quot;HTTPS&quot;:443&#125;] alb.ingress.kubernetes.io/scheme: internet-facing alb.ingress.kubernetes.io/target-type: ipEvents: Type Reason Age From Message ---- ------ ---- ---- ------- Normal SuccessfullyReconciled 9m16s ingress Successfully reconciled 完成域名解析后可以访问：https://dashboard.hanqunfeng.com 清理帐号 123# 删除管理员ServiceAccount和ClusterRoleBinding$ kubectl -n kubernetes-dashboard delete serviceaccount admin-user$ kubectl -n kubernetes-dashboard delete clusterrolebinding admin-user 后记 这玩意就是查看资源方便一些，创建资源还是需要精通yaml。","summary":"摘要 本文介绍为EKS集群部署 Dashboard UI 参考资料： Amazon EKS用户指南 Kubernetes 文档","date_published":"2023-07-07T15:30:05.000Z","tags":["技术","aws","eks","java"]},{"id":"https://blog.hanqunfeng.com/2023/07/07/aws-eks11-metrics/","url":"https://blog.hanqunfeng.com/2023/07/07/aws-eks11-metrics/","title":"AWS-EKS-11--安装 Kubernetes Metrics Server","content_html":"<!--\n **加粗**\n *斜体*\n ***加粗并斜体***\n ~~删除线~~\n ==突出显示==\n `突出显示(推荐)`\n ++下划线++\n ~下标~\n ^上标^\n 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.\n 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600)\n\n +++ **点击折叠**\n 这是被隐藏的内容\n +++\n\n::: tips success warning danger\n这里是容器内的内容\n:::\n\n% note info % success warning danger\n这里是容器内的内容\n% endnote %\n\n -->\n<h2 id=\"摘要\">摘要</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>本文介绍为EKS集群安装 Kubernetes Metrics Server</p>\n</li>\n<li class=\"lvl-2\">\n<p>参考资料：</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\"><a href=\"https://docs.aws.amazon.com/zh_cn/eks/latest/userguide\">Amazon EKS用户指南</a></li>\n<li class=\"lvl-6\"><a href=\"https://kubernetes.io/zh-cn/docs/home/\">Kubernetes 文档</a></li>\n</ul>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"安装-Kubernetes-Metrics-Server\">安装 Kubernetes Metrics Server</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Metrics Server是Kubernetes内置自动缩放管道的可扩展、高效的容器资源指标来源。</p>\n</li>\n<li class=\"lvl-2\">\n<p>Metrics Server从Kubelets收集资源指标，并通过Metrics API在Kubernetes apiserver中公开它们，供Horizontal Pod Autoscaler和Vertical Pod Autoscaler使用。</p>\n</li>\n<li class=\"lvl-2\">\n<p>指标API也可以通过kubectl top访问，从而更容易调试自动缩放管道。</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 使用以下命令部署 Metrics Server</span></span><br><span class=\"line\">~ kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml</span><br><span class=\"line\"><span class=\"comment\"># 使用以下命令验证 metrics-server 部署是否运行所需数量的 Pods</span></span><br><span class=\"line\">~ kubectl get deployment metrics-server -n kube-system</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看metrics-server的资源</span></span><br><span class=\"line\">~ k get all -n kube-system -l k8s-app=metrics-server</span><br><span class=\"line\">NAME                                  READY   STATUS    RESTARTS   AGE</span><br><span class=\"line\">pod/metrics-server-55c774cdbb-6qpz8   1/1     Running   0          14h</span><br><span class=\"line\"></span><br><span class=\"line\">NAME                     TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE</span><br><span class=\"line\">service/metrics-server   ClusterIP   10.100.231.92   &lt;none&gt;        443/TCP   43h</span><br><span class=\"line\"></span><br><span class=\"line\">NAME                             READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class=\"line\">deployment.apps/metrics-server   1/1     1            1           43h</span><br><span class=\"line\"></span><br><span class=\"line\">NAME                                        DESIRED   CURRENT   READY   AGE</span><br><span class=\"line\">replicaset.apps/metrics-server-55c774cdbb   1         1         1       43h</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 自能查看node和pod的指标</span></span><br><span class=\"line\">~ k top node</span><br><span class=\"line\">NAME                                           CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%</span><br><span class=\"line\">ip-192-168-16-155.us-west-2.compute.internal   29m          1%     544Mi           7%</span><br><span class=\"line\">ip-192-168-48-14.us-west-2.compute.internal    32m          1%     569Mi           8%</span><br><span class=\"line\"></span><br><span class=\"line\">~ k top pod</span><br><span class=\"line\">NAMESPACE     NAME                                  CPU(cores)   MEMORY(bytes)</span><br><span class=\"line\">kube-system   aws-node-fzh9v                        3m           36Mi</span><br><span class=\"line\">kube-system   aws-node-t62f8                        3m           36Mi</span><br></pre></td></tr></table></figure>","content_text":"摘要 本文介绍为EKS集群安装 Kubernetes Metrics Server 参考资料： Amazon EKS用户指南 Kubernetes 文档 安装 Kubernetes Metrics Server Metrics Server是Kubernetes内置自动缩放管道的可扩展、高效的容器资源指标来源。 Metrics Server从Kubelets收集资源指标，并通过Metrics API在Kubernetes apiserver中公开它们，供Horizontal Pod Autoscaler和Vertical Pod Autoscaler使用。 指标API也可以通过kubectl top访问，从而更容易调试自动缩放管道。 1234567891011121314151617181920212223242526272829# 使用以下命令部署 Metrics Server~ kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml# 使用以下命令验证 metrics-server 部署是否运行所需数量的 Pods~ kubectl get deployment metrics-server -n kube-system# 查看metrics-server的资源~ k get all -n kube-system -l k8s-app=metrics-serverNAME READY STATUS RESTARTS AGEpod/metrics-server-55c774cdbb-6qpz8 1/1 Running 0 14hNAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGEservice/metrics-server ClusterIP 10.100.231.92 &lt;none&gt; 443/TCP 43hNAME READY UP-TO-DATE AVAILABLE AGEdeployment.apps/metrics-server 1/1 1 1 43hNAME DESIRED CURRENT READY AGEreplicaset.apps/metrics-server-55c774cdbb 1 1 1 43h# 自能查看node和pod的指标~ k top nodeNAME CPU(cores) CPU% MEMORY(bytes) MEMORY%ip-192-168-16-155.us-west-2.compute.internal 29m 1% 544Mi 7%ip-192-168-48-14.us-west-2.compute.internal 32m 1% 569Mi 8%~ k top podNAMESPACE NAME CPU(cores) MEMORY(bytes)kube-system aws-node-fzh9v 3m 36Mikube-system aws-node-t62f8 3m 36Mi","summary":"摘要 本文介绍为EKS集群安装 Kubernetes Metrics Server 参考资料： Amazon EKS用户指南 Kubernetes 文档","date_published":"2023-07-07T15:20:05.000Z","tags":["技术","aws","eks","java"]},{"id":"https://blog.hanqunfeng.com/2023/07/07/aws-eks10-iam-share/","url":"https://blog.hanqunfeng.com/2023/07/07/aws-eks10-iam-share/","title":"AWS-EKS-10--EKS权限管理(上)向其他 IAM 用户授予权限","content_html":"<!--\n **加粗**\n *斜体*\n ***加粗并斜体***\n ~~删除线~~\n ==突出显示==\n `突出显示(推荐)`\n ++下划线++\n ~下标~\n ^上标^\n 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.\n 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600)\n\n +++ **点击折叠**\n 这是被隐藏的内容\n +++\n\n::: tips success warning danger\n这里是容器内的内容\n:::\n\n% note info % success warning danger\n这里是容器内的内容\n% endnote %\n\n -->\n<h2 id=\"摘要\">摘要</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>本文介绍EKS集群如何向其他 IAM 用户授予权限</p>\n</li>\n<li class=\"lvl-2\">\n<p>参考资料：</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\"><a href=\"https://docs.aws.amazon.com/zh_cn/eks/latest/userguide\">Amazon EKS用户指南</a></li>\n<li class=\"lvl-6\"><a href=\"https://kubernetes.io/zh-cn/docs/home/\">Kubernetes 文档</a></li>\n</ul>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"EKS权限管理\">EKS权限管理</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>创建EKS集群后，默认只有创建集群的 IAM 主体可以访问并管理EKS集群，实际业务中，我们需要将EKS的全部或部分权限分配给指定的用户，就需要对该用户进行授权。</p>\n</li>\n<li class=\"lvl-2\">\n<p>对于 AWS EKS 的权限管理，主要有以下三个方面内容</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">IAM 用户、Role 或者 Account 访问 EKS 相关资源。这里的资源是指 EKS 集群本身的 AWS 资源。比如，EKS 集群信息配置，EC2 节点等等，这里不包括 K8s 中的资源。这部分直接在AWS IAM中进行授权即可。</li>\n<li class=\"lvl-6\">IAM 用户、Role 或者 Account 访问 EKS K8s 资源，这里的资源是指 K8s 内部的资源，比如，K8s 内部的 service account、deployment、service 等等。本章重点讲这部分内容。</li>\n<li class=\"lvl-6\">K8s 内部 Pod 调用 AWS 的资源。比如，通过创建 Ingress 来创建 AWS ALB。这部分在<a href=\"/2023/07/13/aws-eks15-auth-pod/\" title=\"AWS-EKS-15--EKS权限管理(下)Pod 是如何调用 AWS 资源的\">EKS权限管理(下)Pod 是如何调用 AWS 资源的</a>中介绍。</li>\n</ul>\n</li>\n<li class=\"lvl-2\">\n<p>与IAM用户授权相关的是头两条，即要使 IAM 用户能够访问 EKS 集群本身的 AWS 资源，又要能够访问 K8s 内部的资源。</p>\n</li>\n</ul>\n<h2 id=\"创建-IAM-用户并授权其访问EKS资源\">创建 IAM 用户并授权其访问EKS资源</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>关于如何在IAM中创建用户并授予相应的策略属于<a href=\"https://docs.aws.amazon.com/zh_cn/IAM/latest/UserGuide/introduction.html\">AWS IAM权限管理</a>的范畴，不是本文的重点，作者默认读者已掌握这些内容，重点理解用户、组、角色和策略之间的关系。读者也可以参考<a href=\"https://zhuanlan.zhihu.com/p/379235758\">一文搞懂 AWS IAM 权限 基础篇上 理论</a></p>\n</li>\n<li class=\"lvl-2\">\n<p>在AWS控制台中创建一个用户<code>ekstest</code>，为了保证最小权限原则，这里只为其分配一个内联策略(只针对关联用户)，同时为其创建访问密钥。注意必须为用户至少分配如下策略，以保证IAM用户有权限查看 EKS 集群，否则使用密钥无法通过命令行连通EKS。</p>\n</li>\n</ul>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">\t<span class=\"attr\">&quot;Version&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;2012-10-17&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t<span class=\"attr\">&quot;Statement&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">\t\t<span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">\t\t\t<span class=\"attr\">&quot;Sid&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;VisualEditor0&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t\t\t<span class=\"attr\">&quot;Effect&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;Allow&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t\t\t<span class=\"attr\">&quot;Action&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;eks:DescribeCluster&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t\t\t<span class=\"attr\">&quot;Resource&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;arn:aws:eks:us-west-2:743263909655:cluster/eks-lexing&quot;</span></span><br><span class=\"line\">\t\t<span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">\t<span class=\"punctuation\">]</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"向-IAM-用户授予访问K8s资源的权限\">向 IAM 用户授予访问K8s资源的权限</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>创建集群的 IAM 主体是唯一可以访问集群的主体。向其他 IAM 主体授予权限，以便它们可以访问您的集群。</p>\n</li>\n<li class=\"lvl-2\">\n<p>ConfigMap aws-auth 在我们向 EKS 添加 node 时就自动创建了，它的作用是允许 node 加入集群。</p>\n</li>\n<li class=\"lvl-2\">\n<p>aws-auth 的另一个作用是控制 AWS 用户或者 role 访问 K8s 内部的资源（准确的说是把外部 IAM 用户与 K8s 内部用户做映射）。</p>\n</li>\n<li class=\"lvl-2\">\n<p>现在 aws-auth 中只有一个 mapRoles，这里的 rolearn 就是我们之前创建EKS时自动创建的，为 EC2 提供权限。</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 通过eksctl查看 ConfigMap 中的aws-auth映射</span></span><br><span class=\"line\">$ eksctl get iamidentitymapping --cluster eks-lexing --profile eks-us-west-2</span><br><span class=\"line\">ARN                                                USERNAME                GROUPS                    ACCOUNT</span><br><span class=\"line\">arn:aws:iam::743263909655:role/eksctl-eks-lexing-nodegroup-ng-4d-NodeInstanceRole-Y55EPJO9XYDG    system:node:&#123;&#123;EC2PrivateDNSName&#125;&#125;    system:bootstrappers,system:nodes</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 也可以通过kubectl查看configmap aws-auth</span></span><br><span class=\"line\">$ kubectl describe configmap -n kube-system aws-auth</span><br><span class=\"line\">Name:         aws-auth</span><br><span class=\"line\">Namespace:    kube-system</span><br><span class=\"line\">Labels:       &lt;none&gt;</span><br><span class=\"line\">Annotations:  &lt;none&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">Data</span><br><span class=\"line\">====</span><br><span class=\"line\">mapRoles:</span><br><span class=\"line\">----</span><br><span class=\"line\">- <span class=\"built_in\">groups</span>:</span><br><span class=\"line\">  - system:bootstrappers</span><br><span class=\"line\">  - system:nodes</span><br><span class=\"line\">  rolearn: arn:aws:iam::743263909655:role/eksctl-eks-lexing-nodegroup-ng-4d-NodeInstanceRole-Y55EPJO9XYDG</span><br><span class=\"line\">  username: system:node:&#123;&#123;EC2PrivateDNSName&#125;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">mapUsers:</span><br><span class=\"line\">----</span><br><span class=\"line\">[]</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">BinaryData</span><br><span class=\"line\">====</span><br><span class=\"line\"></span><br><span class=\"line\">Events:  &lt;none&gt;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>授权–1.角色与组绑定</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 所有命名空间中的 Kubernetes 资源，文件中的组名称为 eks-console-dashboard-full-access-group</span></span><br><span class=\"line\">$ curl -O https://s3.us-west-2.amazonaws.com/amazon-eks/docs/eks-console-full-access.yaml</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 特定命名空间中的 Kubernetes 资源 - 此文件中的命名空间为 default，请依据需要修改命名空间名称。文件中的组名为 eks-console-dashboard-restricted-access-group</span></span><br><span class=\"line\">$ curl -O https://s3.us-west-2.amazonaws.com/amazon-eks/docs/eks-console-restricted-access.yaml</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 这里以所有资源为例</span></span><br><span class=\"line\">$ kubectl apply -f eks-console-full-access.yaml</span><br><span class=\"line\">clusterrole.rbac.authorization.k8s.io/eks-console-dashboard-full-access-clusterrole created</span><br><span class=\"line\">clusterrolebinding.rbac.authorization.k8s.io/eks-console-dashboard-full-access-binding created</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>查看上面的yaml文件，可以看到里面定义了<code>ClusterRole</code>和<code>ClusterRoleBinding</code>以及<code>Role</code>和<code>RoleBinding</code>，这是K8s中的 <code>RBAC(Role-based access control )</code> 授权模块中的4个对象:</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\"><code>Role</code>：设置对 K8s 资源访问的具体权限，与某个 namesapce 相关联</li>\n<li class=\"lvl-6\"><code>ClusterRole</code>：与 <code>Role</code> 类似，区别是不与某个 namepsace 相关联，针对整个 Cluster</li>\n<li class=\"lvl-6\"><code>RoleBinding</code>：把<code>User|Group|ServiceAccount</code>和 <code>Role</code> 绑定，使其获得具体权限</li>\n<li class=\"lvl-6\"><code>ClusterRoleBinding</code>：与 <code>RoleBinding</code> 类似，把<code>User|Group|ServiceAccount</code>和<code>ClusterRole</code>绑定，区别是不与某个 namepsace 相关联</li>\n</ul>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看集群角色及其绑定</span></span><br><span class=\"line\">k get ClusterRole</span><br><span class=\"line\">k get ClusterRoleBinding</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看角色及其绑定</span></span><br><span class=\"line\">k get Role -A</span><br><span class=\"line\">k get RoleBinding -A</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>授权–2.用户与组绑定</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 为用户添加映射，这里为用户 ekstest 添加权限策略</span></span><br><span class=\"line\">$ eksctl create iamidentitymapping \\</span><br><span class=\"line\">    --cluster eks-lexing --profile eks-us-west-2 \\</span><br><span class=\"line\">    --arn arn:aws:iam::743263909655:user/ekstest \\</span><br><span class=\"line\">    --group eks-console-dashboard-full-access-group \\</span><br><span class=\"line\">    --no-duplicate-arns</span><br><span class=\"line\">2023-07-05 16:28:51 [ℹ]  checking arn arn:aws:iam::743263909655:user/ekstest against entries <span class=\"keyword\">in</span> the auth ConfigMap</span><br><span class=\"line\">2023-07-05 16:28:51 [ℹ]  adding identity <span class=\"string\">&quot;arn:aws:iam::743263909655:user/ekstest&quot;</span> to auth ConfigMap</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 再次通过eksctl查看 ConfigMap 中的aws-auth映射</span></span><br><span class=\"line\">$ eksctl get iamidentitymapping --cluster eks-lexing --profile eks-us-west-2</span><br><span class=\"line\">ARN                                                USERNAME                GROUPS                    ACCOUNT</span><br><span class=\"line\">arn:aws:iam::743263909655:role/eksctl-eks-lexing-nodegroup-ng-4d-NodeInstanceRole-Y55EPJO9XYDG    system:node:&#123;&#123;EC2PrivateDNSName&#125;&#125;    system:bootstrappers,system:nodes</span><br><span class=\"line\">arn:aws:iam::743263909655:user/ekstest                                                    eks-console-dashboard-full-access-group</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 也可以通过kubectl再次查看configmap aws-auth</span></span><br><span class=\"line\"><span class=\"comment\"># 实际上直接编辑也可以: kubectl edit configmap -n kube-system aws-auth</span></span><br><span class=\"line\">$ kubectl describe configmap -n kube-system aws-auth</span><br><span class=\"line\">Name:         aws-auth</span><br><span class=\"line\">Namespace:    kube-system</span><br><span class=\"line\">Labels:       &lt;none&gt;</span><br><span class=\"line\">Annotations:  &lt;none&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">Data</span><br><span class=\"line\">====</span><br><span class=\"line\">mapRoles:</span><br><span class=\"line\">----</span><br><span class=\"line\">- <span class=\"built_in\">groups</span>:</span><br><span class=\"line\">  - system:bootstrappers</span><br><span class=\"line\">  - system:nodes</span><br><span class=\"line\">  rolearn: arn:aws:iam::743263909655:role/eksctl-eks-lexing-nodegroup-ng-4d-NodeInstanceRole-Y55EPJO9XYDG</span><br><span class=\"line\">  username: system:node:&#123;&#123;EC2PrivateDNSName&#125;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">mapUsers:</span><br><span class=\"line\">----</span><br><span class=\"line\">- <span class=\"built_in\">groups</span>:</span><br><span class=\"line\">  - eks-console-dashboard-full-access-group</span><br><span class=\"line\">  userarn: arn:aws:iam::743263909655:user/ekstest</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">BinaryData</span><br><span class=\"line\">====</span><br><span class=\"line\"></span><br><span class=\"line\">Events:  &lt;none&gt;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>此时使用 ekstest 的访问密钥就可以通过命令行访问eks了</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 配置aws访问密钥</span></span><br><span class=\"line\">$ aws configure --profile ekstest</span><br><span class=\"line\">AWS Access Key ID [None]: AKIA22DP3</span><br><span class=\"line\">AWS Secret Access Key [None]: 9ajQeyy/AiaAC0n1</span><br><span class=\"line\">Default region name [None]: us-west-2</span><br><span class=\"line\">Default output format [None]: json</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 更新 ~/.kube/config</span></span><br><span class=\"line\">$ <span class=\"built_in\">export</span> AWS_PROFILE=ekstest</span><br><span class=\"line\">$ aws eks update-kubeconfig --name eks-lexing</span><br><span class=\"line\">Added new context arn:aws:eks:us-west-2:743263909655:cluster/eks-lexing to /Users/hanqf/.kube/config</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 测试命令</span></span><br><span class=\"line\">$ k get node</span><br><span class=\"line\">NAME                                           STATUS   ROLES    AGE   VERSION</span><br><span class=\"line\">ip-192-168-16-155.us-west-2.compute.internal   Ready    &lt;none&gt;   13d   v1.26.4-eks-0a21954</span><br><span class=\"line\">ip-192-168-48-14.us-west-2.compute.internal    Ready    &lt;none&gt;   13d   v1.26.4-eks-0a21954</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>此时 ekstest 还不能通过aws控制台中访问eks资源，还需要为其在IAM中授予必要的EKS策略，下面的策略是授予IAM用户对EKS的完全访问权限。</p>\n</li>\n</ul>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;Version&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;2012-10-17&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;Statement&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">        <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">            <span class=\"attr\">&quot;Sid&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;VisualEditor0&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">            <span class=\"attr\">&quot;Effect&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;Allow&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">            <span class=\"attr\">&quot;Action&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;eks:*&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">            <span class=\"attr\">&quot;Resource&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;*&quot;</span></span><br><span class=\"line\">        <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">    <span class=\"punctuation\">]</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"取消授权\">取消授权</h2>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ eksctl delete iamidentitymapping \\</span><br><span class=\"line\">    --cluster eks-lexing --profile eks-us-west-2 \\</span><br><span class=\"line\">    --arn arn:aws:iam::743263909655:user/ekstest</span><br><span class=\"line\">2023-07-05 09:12:29 [ℹ]  removing identity <span class=\"string\">&quot;arn:aws:iam::743263909655:user/ekstest&quot;</span> from auth ConfigMap (username = <span class=\"string\">&quot;&quot;</span>, <span class=\"built_in\">groups</span> = [<span class=\"string\">&quot;eks-console-dashboard-full-access-group&quot;</span>])</span><br><span class=\"line\"></span><br><span class=\"line\">$ eksctl get iamidentitymapping --cluster eks-lexing --profile eks-ty-old</span><br><span class=\"line\">ARN                                                USERNAME                GROUPS                    ACCOUNT</span><br><span class=\"line\">arn:aws:iam::743263909655:role/eksctl-eks-lexing-nodegroup-ng-4d-NodeInstanceRole-Y55EPJO9XYDG    system:node:&#123;&#123;EC2PrivateDNSName&#125;&#125;    system:bootstrappers,system:nodes</span><br></pre></td></tr></table></figure>","content_text":"摘要 本文介绍EKS集群如何向其他 IAM 用户授予权限 参考资料： Amazon EKS用户指南 Kubernetes 文档 EKS权限管理 创建EKS集群后，默认只有创建集群的 IAM 主体可以访问并管理EKS集群，实际业务中，我们需要将EKS的全部或部分权限分配给指定的用户，就需要对该用户进行授权。 对于 AWS EKS 的权限管理，主要有以下三个方面内容 IAM 用户、Role 或者 Account 访问 EKS 相关资源。这里的资源是指 EKS 集群本身的 AWS 资源。比如，EKS 集群信息配置，EC2 节点等等，这里不包括 K8s 中的资源。这部分直接在AWS IAM中进行授权即可。 IAM 用户、Role 或者 Account 访问 EKS K8s 资源，这里的资源是指 K8s 内部的资源，比如，K8s 内部的 service account、deployment、service 等等。本章重点讲这部分内容。 K8s 内部 Pod 调用 AWS 的资源。比如，通过创建 Ingress 来创建 AWS ALB。这部分在EKS权限管理(下)Pod 是如何调用 AWS 资源的中介绍。 与IAM用户授权相关的是头两条，即要使 IAM 用户能够访问 EKS 集群本身的 AWS 资源，又要能够访问 K8s 内部的资源。 创建 IAM 用户并授权其访问EKS资源 关于如何在IAM中创建用户并授予相应的策略属于AWS IAM权限管理的范畴，不是本文的重点，作者默认读者已掌握这些内容，重点理解用户、组、角色和策略之间的关系。读者也可以参考一文搞懂 AWS IAM 权限 基础篇上 理论 在AWS控制台中创建一个用户ekstest，为了保证最小权限原则，这里只为其分配一个内联策略(只针对关联用户)，同时为其创建访问密钥。注意必须为用户至少分配如下策略，以保证IAM用户有权限查看 EKS 集群，否则使用密钥无法通过命令行连通EKS。 1234567891011&#123; &quot;Version&quot;: &quot;2012-10-17&quot;, &quot;Statement&quot;: [ &#123; &quot;Sid&quot;: &quot;VisualEditor0&quot;, &quot;Effect&quot;: &quot;Allow&quot;, &quot;Action&quot;: &quot;eks:DescribeCluster&quot;, &quot;Resource&quot;: &quot;arn:aws:eks:us-west-2:743263909655:cluster/eks-lexing&quot; &#125; ]&#125; 向 IAM 用户授予访问K8s资源的权限 创建集群的 IAM 主体是唯一可以访问集群的主体。向其他 IAM 主体授予权限，以便它们可以访问您的集群。 ConfigMap aws-auth 在我们向 EKS 添加 node 时就自动创建了，它的作用是允许 node 加入集群。 aws-auth 的另一个作用是控制 AWS 用户或者 role 访问 K8s 内部的资源（准确的说是把外部 IAM 用户与 K8s 内部用户做映射）。 现在 aws-auth 中只有一个 mapRoles，这里的 rolearn 就是我们之前创建EKS时自动创建的，为 EC2 提供权限。 12345678910111213141516171819202122232425262728293031# 通过eksctl查看 ConfigMap 中的aws-auth映射$ eksctl get iamidentitymapping --cluster eks-lexing --profile eks-us-west-2ARN USERNAME GROUPS ACCOUNTarn:aws:iam::743263909655:role/eksctl-eks-lexing-nodegroup-ng-4d-NodeInstanceRole-Y55EPJO9XYDG system:node:&#123;&#123;EC2PrivateDNSName&#125;&#125; system:bootstrappers,system:nodes# 也可以通过kubectl查看configmap aws-auth$ kubectl describe configmap -n kube-system aws-authName: aws-authNamespace: kube-systemLabels: &lt;none&gt;Annotations: &lt;none&gt;Data====mapRoles:----- groups: - system:bootstrappers - system:nodes rolearn: arn:aws:iam::743263909655:role/eksctl-eks-lexing-nodegroup-ng-4d-NodeInstanceRole-Y55EPJO9XYDG username: system:node:&#123;&#123;EC2PrivateDNSName&#125;&#125;mapUsers:----[]BinaryData====Events: &lt;none&gt; 授权–1.角色与组绑定 12345678910# 所有命名空间中的 Kubernetes 资源，文件中的组名称为 eks-console-dashboard-full-access-group$ curl -O https://s3.us-west-2.amazonaws.com/amazon-eks/docs/eks-console-full-access.yaml# 特定命名空间中的 Kubernetes 资源 - 此文件中的命名空间为 default，请依据需要修改命名空间名称。文件中的组名为 eks-console-dashboard-restricted-access-group$ curl -O https://s3.us-west-2.amazonaws.com/amazon-eks/docs/eks-console-restricted-access.yaml# 这里以所有资源为例$ kubectl apply -f eks-console-full-access.yamlclusterrole.rbac.authorization.k8s.io/eks-console-dashboard-full-access-clusterrole createdclusterrolebinding.rbac.authorization.k8s.io/eks-console-dashboard-full-access-binding created 查看上面的yaml文件，可以看到里面定义了ClusterRole和ClusterRoleBinding以及Role和RoleBinding，这是K8s中的 RBAC(Role-based access control ) 授权模块中的4个对象: Role：设置对 K8s 资源访问的具体权限，与某个 namesapce 相关联 ClusterRole：与 Role 类似，区别是不与某个 namepsace 相关联，针对整个 Cluster RoleBinding：把User|Group|ServiceAccount和 Role 绑定，使其获得具体权限 ClusterRoleBinding：与 RoleBinding 类似，把User|Group|ServiceAccount和ClusterRole绑定，区别是不与某个 namepsace 相关联 1234567# 查看集群角色及其绑定k get ClusterRolek get ClusterRoleBinding# 查看角色及其绑定k get Role -Ak get RoleBinding -A 授权–2.用户与组绑定 1234567891011121314151617181920212223242526272829303132333435363738394041424344# 为用户添加映射，这里为用户 ekstest 添加权限策略$ eksctl create iamidentitymapping \\ --cluster eks-lexing --profile eks-us-west-2 \\ --arn arn:aws:iam::743263909655:user/ekstest \\ --group eks-console-dashboard-full-access-group \\ --no-duplicate-arns2023-07-05 16:28:51 [ℹ] checking arn arn:aws:iam::743263909655:user/ekstest against entries in the auth ConfigMap2023-07-05 16:28:51 [ℹ] adding identity &quot;arn:aws:iam::743263909655:user/ekstest&quot; to auth ConfigMap# 再次通过eksctl查看 ConfigMap 中的aws-auth映射$ eksctl get iamidentitymapping --cluster eks-lexing --profile eks-us-west-2ARN USERNAME GROUPS ACCOUNTarn:aws:iam::743263909655:role/eksctl-eks-lexing-nodegroup-ng-4d-NodeInstanceRole-Y55EPJO9XYDG system:node:&#123;&#123;EC2PrivateDNSName&#125;&#125; system:bootstrappers,system:nodesarn:aws:iam::743263909655:user/ekstest eks-console-dashboard-full-access-group# 也可以通过kubectl再次查看configmap aws-auth# 实际上直接编辑也可以: kubectl edit configmap -n kube-system aws-auth$ kubectl describe configmap -n kube-system aws-authName: aws-authNamespace: kube-systemLabels: &lt;none&gt;Annotations: &lt;none&gt;Data====mapRoles:----- groups: - system:bootstrappers - system:nodes rolearn: arn:aws:iam::743263909655:role/eksctl-eks-lexing-nodegroup-ng-4d-NodeInstanceRole-Y55EPJO9XYDG username: system:node:&#123;&#123;EC2PrivateDNSName&#125;&#125;mapUsers:----- groups: - eks-console-dashboard-full-access-group userarn: arn:aws:iam::743263909655:user/ekstestBinaryData====Events: &lt;none&gt; 此时使用 ekstest 的访问密钥就可以通过命令行访问eks了 123456789101112131415161718# 配置aws访问密钥$ aws configure --profile ekstestAWS Access Key ID [None]: AKIA22DP3AWS Secret Access Key [None]: 9ajQeyy/AiaAC0n1Default region name [None]: us-west-2Default output format [None]: json# 更新 ~/.kube/config$ export AWS_PROFILE=ekstest$ aws eks update-kubeconfig --name eks-lexingAdded new context arn:aws:eks:us-west-2:743263909655:cluster/eks-lexing to /Users/hanqf/.kube/config# 测试命令$ k get nodeNAME STATUS ROLES AGE VERSIONip-192-168-16-155.us-west-2.compute.internal Ready &lt;none&gt; 13d v1.26.4-eks-0a21954ip-192-168-48-14.us-west-2.compute.internal Ready &lt;none&gt; 13d v1.26.4-eks-0a21954 此时 ekstest 还不能通过aws控制台中访问eks资源，还需要为其在IAM中授予必要的EKS策略，下面的策略是授予IAM用户对EKS的完全访问权限。 1234567891011&#123; &quot;Version&quot;: &quot;2012-10-17&quot;, &quot;Statement&quot;: [ &#123; &quot;Sid&quot;: &quot;VisualEditor0&quot;, &quot;Effect&quot;: &quot;Allow&quot;, &quot;Action&quot;: &quot;eks:*&quot;, &quot;Resource&quot;: &quot;*&quot; &#125; ]&#125; 取消授权 12345678$ eksctl delete iamidentitymapping \\ --cluster eks-lexing --profile eks-us-west-2 \\ --arn arn:aws:iam::743263909655:user/ekstest2023-07-05 09:12:29 [ℹ] removing identity &quot;arn:aws:iam::743263909655:user/ekstest&quot; from auth ConfigMap (username = &quot;&quot;, groups = [&quot;eks-console-dashboard-full-access-group&quot;])$ eksctl get iamidentitymapping --cluster eks-lexing --profile eks-ty-oldARN USERNAME GROUPS ACCOUNTarn:aws:iam::743263909655:role/eksctl-eks-lexing-nodegroup-ng-4d-NodeInstanceRole-Y55EPJO9XYDG system:node:&#123;&#123;EC2PrivateDNSName&#125;&#125; system:bootstrappers,system:nodes","summary":"摘要 本文介绍EKS集群如何向其他 IAM 用户授予权限 参考资料： Amazon EKS用户指南 Kubernetes 文档","date_published":"2023-07-07T15:10:05.000Z","tags":["技术","aws","eks","java"]},{"id":"https://blog.hanqunfeng.com/2023/07/07/aws-eks09-service-ingress/","url":"https://blog.hanqunfeng.com/2023/07/07/aws-eks09-service-ingress/","title":"AWS-EKS-09--创建基于LoadBalancer的service和ingress","content_html":"<!--\n **加粗**\n *斜体*\n ***加粗并斜体***\n ~~删除线~~\n ==突出显示==\n `突出显示(推荐)`\n ++下划线++\n ~下标~\n ^上标^\n 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.\n 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600)\n\n +++ **点击折叠**\n 这是被隐藏的内容\n +++\n\n::: tips success warning danger\n这里是容器内的内容\n:::\n\n% note info % success warning danger\n这里是容器内的内容\n% endnote %\n\n -->\n<h2 id=\"摘要\">摘要</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>本文介绍为EKS集群创建基于LoadBalancer的service和ingress</p>\n</li>\n<li class=\"lvl-2\">\n<p>参考资料：</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\"><a href=\"https://docs.aws.amazon.com/zh_cn/eks/latest/userguide\">Amazon EKS用户指南</a></li>\n<li class=\"lvl-6\"><a href=\"https://kubernetes.io/zh-cn/docs/home/\">Kubernetes 文档</a></li>\n</ul>\n</li>\n</ul>\n<span id=\"more\"></span>\n<p>前置条件：<a href=\"/2023/07/07/aws-eks07-loadbalancer/\" title=\"AWS-EKS-07--安装 AWS Load Balancer Controller 附加组件\">安装 AWS Load Balancer Controller 附加组件</a></p>\n<h2 id=\"Service\">Service</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>service与elb的绑定关系是通过注释实现的。这里service必须设置为LoadBalancer，一个service就对应一个elb。</p>\n</li>\n<li class=\"lvl-2\">\n<p>创建服务后，请勿编辑注释。如果需要对其进行修改，请删除相应服务对象，然后使用此注释的所需值重新创建它。</p>\n</li>\n<li class=\"lvl-2\">\n<p><code>service.beta.kubernetes.io/aws-load-balancer-scheme: internet-facing</code> 表示允许外网访问，如果只允许集群内部访问，则去掉该注释即可。</p>\n</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># eks-loadbalancer-service.yaml</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Namespace</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nlb-sample-app</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nlb-sample-app</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">nlb-sample-app</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">3</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">          <span class=\"attr\">image:</span> <span class=\"string\">public.ecr.aws/nginx/nginx:1.21</span></span><br><span class=\"line\">          <span class=\"attr\">ports:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">tcp</span></span><br><span class=\"line\">              <span class=\"attr\">containerPort:</span> <span class=\"number\">80</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nlb-sample-service</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">nlb-sample-app</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">service.beta.kubernetes.io/aws-load-balancer-type:</span> <span class=\"string\">external</span></span><br><span class=\"line\">    <span class=\"attr\">service.beta.kubernetes.io/aws-load-balancer-nlb-target-type:</span> <span class=\"string\">ip</span></span><br><span class=\"line\">    <span class=\"attr\">service.beta.kubernetes.io/aws-load-balancer-scheme:</span> <span class=\"string\">internet-facing</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">port:</span> <span class=\"number\">80</span></span><br><span class=\"line\">      <span class=\"attr\">targetPort:</span> <span class=\"number\">80</span></span><br><span class=\"line\">      <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">  <span class=\"attr\">type:</span> <span class=\"string\">LoadBalancer</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">nginx</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ k apply -f eks-loadbalancer-service.yaml</span><br><span class=\"line\">$ k get svc -n nlb-sample-app</span><br><span class=\"line\">NAME                 TYPE           CLUSTER-IP       EXTERNAL-IP                                                                     PORT(S)        AGE</span><br><span class=\"line\">nlb-sample-service   LoadBalancer   10.100.176.186   k8s-nlbsampl-nlbsampl-f492eca1e5-b4b9dd61dd8724e6.elb.us-west-2.amazonaws.com   80:31743/TCP   6m11s</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/3mCM0b.jpg\" alt=\"\" width=\"1200\" height=\"600\"><br>\n<img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/1sPJve.jpg\" alt=\"\" width=\"800\" height=\"400\"></p>\n<h2 id=\"Ingress\">Ingress</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ingress与elb的绑定关系也是通过注释实现的，一个ingress绑定一个elb，可以同时对多个service提供映射。</p>\n</li>\n<li class=\"lvl-2\">\n<p>为了支持https，需要先创建证书，我这里有一个域名<code>hanqunfeng.com</code>，通过<code>AWS Certificate Manager</code>创建证书</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">我这里使用的是根证书，注意这里一定要添加一个 <code>*.hanqunfeng.com</code> 的域名，否则使用子域名时会提示证书不匹配<br>\n<img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/AWgUqD.jpg\" alt=\"\" width=\"1200\" height=\"800\"></li>\n<li class=\"lvl-6\">去域名服务商处进行域名解析，配制好后等待证书颁发，耗时10分钟左右吧<br>\n<img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/myJkbW.jpg\" alt=\"\" width=\"1200\" height=\"800\"><br>\n<img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/uuAGn7.jpg\" alt=\"\" width=\"1200\" height=\"150\"></li>\n</ul>\n</li>\n<li class=\"lvl-2\">\n<p>测试用的service.yaml</p>\n</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Namespace</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">game-2048</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">game-2048</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">deployment-2048</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app.kubernetes.io/name:</span> <span class=\"string\">app-2048</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">5</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app.kubernetes.io/name:</span> <span class=\"string\">app-2048</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">image:</span> <span class=\"string\">public.ecr.aws/l6m2t8p7/docker-2048:latest</span></span><br><span class=\"line\">        <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">Always</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span> <span class=\"string\">app-2048</span></span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">80</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">game-2048</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">service-2048</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">port:</span> <span class=\"number\">80</span></span><br><span class=\"line\">      <span class=\"attr\">targetPort:</span> <span class=\"number\">80</span></span><br><span class=\"line\">      <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">  <span class=\"attr\">type:</span> <span class=\"string\">ClusterIP</span>   <span class=\"comment\"># 也可以配置为 NodePort 或者 LoadBalancer</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/name:</span> <span class=\"string\">app-2048</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ k apply -f service.yaml</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>测试用的ingress.yaml</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">这里为了演示，host都指向了同一个service</li>\n<li class=\"lvl-6\">ingress是通过注释实现与elb的绑定，包括监听端口、80重定向到443、https证书等等</li>\n</ul>\n</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">networking.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">game-2048</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">ingress-2048</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">alb.ingress.kubernetes.io/actions.ssl-redirect:</span> <span class=\"string\">&#x27;&#123;&quot;Type&quot;: &quot;redirect&quot;, &quot;RedirectConfig&quot;:&#123; &quot;Protocol&quot;: &quot;HTTPS&quot;, &quot;Port&quot;: &quot;443&quot;, &quot;StatusCode&quot;: &quot;HTTP_301&quot;&#125;&#125;&#x27;</span>  <span class=\"comment\"># http重定向到https</span></span><br><span class=\"line\">    <span class=\"attr\">alb.ingress.kubernetes.io/certificate-arn:</span> <span class=\"string\">arn:aws:acm:us-west-2:743263909655:certificate/e2e3fa54-98ab-427a-9f09-486a9831323e</span> <span class=\"comment\"># https证书，就是上面创建的证书的arn</span></span><br><span class=\"line\">    <span class=\"attr\">alb.ingress.kubernetes.io/listen-ports:</span> <span class=\"string\">&#x27;[&#123;&quot;HTTP&quot;: 80&#125;, &#123;&quot;HTTPS&quot;:443&#125;]&#x27;</span> <span class=\"comment\"># 监听端口</span></span><br><span class=\"line\">    <span class=\"attr\">alb.ingress.kubernetes.io/scheme:</span> <span class=\"string\">internet-facing</span> <span class=\"comment\"># 开放外网访问</span></span><br><span class=\"line\">    <span class=\"attr\">alb.ingress.kubernetes.io/target-type:</span> <span class=\"string\">ip</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">ingressClassName:</span> <span class=\"string\">alb</span> <span class=\"comment\"># 指定ingressclass类型，k8s-1.18及以后的版本推荐这种配置方式，旧版本需要在注释中加入 kubernetes.io/ingress.class: alb</span></span><br><span class=\"line\">  <span class=\"attr\">rules:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">host:</span> <span class=\"string\">eks.hanqunfeng.com</span> <span class=\"comment\"># 域名绑定，需要到域名服务商处进行域名解析，CNAME到当前生成的elb</span></span><br><span class=\"line\">      <span class=\"attr\">http:</span></span><br><span class=\"line\">        <span class=\"attr\">paths:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">path:</span> <span class=\"string\">/</span> <span class=\"comment\"># 重定向配置，这里必须配置，否则不能实现重定向</span></span><br><span class=\"line\">          <span class=\"attr\">pathType:</span> <span class=\"string\">Prefix</span></span><br><span class=\"line\">          <span class=\"attr\">backend:</span></span><br><span class=\"line\">            <span class=\"attr\">service:</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">ssl-redirect</span></span><br><span class=\"line\">              <span class=\"attr\">port:</span></span><br><span class=\"line\">                <span class=\"attr\">name:</span> <span class=\"string\">use-annotation</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">path:</span> <span class=\"string\">/</span></span><br><span class=\"line\">          <span class=\"attr\">pathType:</span> <span class=\"string\">Prefix</span></span><br><span class=\"line\">          <span class=\"attr\">backend:</span></span><br><span class=\"line\">            <span class=\"attr\">service:</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">service-2048</span></span><br><span class=\"line\">              <span class=\"attr\">port:</span></span><br><span class=\"line\">                <span class=\"attr\">number:</span> <span class=\"number\">80</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">host:</span> <span class=\"string\">aws.hanqunfeng.com</span></span><br><span class=\"line\">      <span class=\"attr\">http:</span></span><br><span class=\"line\">        <span class=\"attr\">paths:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">path:</span> <span class=\"string\">/*</span></span><br><span class=\"line\">          <span class=\"attr\">pathType:</span> <span class=\"string\">ImplementationSpecific</span></span><br><span class=\"line\">          <span class=\"attr\">backend:</span></span><br><span class=\"line\">            <span class=\"attr\">service:</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">ssl-redirect</span></span><br><span class=\"line\">              <span class=\"attr\">port:</span></span><br><span class=\"line\">                <span class=\"attr\">name:</span> <span class=\"string\">use-annotation</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">path:</span> <span class=\"string\">/*</span></span><br><span class=\"line\">          <span class=\"attr\">pathType:</span> <span class=\"string\">ImplementationSpecific</span></span><br><span class=\"line\">          <span class=\"attr\">backend:</span></span><br><span class=\"line\">            <span class=\"attr\">service:</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">service-2048</span></span><br><span class=\"line\">              <span class=\"attr\">port:</span></span><br><span class=\"line\">                <span class=\"attr\">number:</span> <span class=\"number\">80</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 部署ingress</span></span><br><span class=\"line\">$ k apply -f ingress.yaml</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看ingress</span></span><br><span class=\"line\">$ k describe ing -n game-2048 ingress-2048</span><br><span class=\"line\">Name:             ingress-2048</span><br><span class=\"line\">Labels:           &lt;none&gt;</span><br><span class=\"line\">Namespace:        game-2048</span><br><span class=\"line\">Address:          k8s-game2048-ingress2-1ca4fafb1f-272829398.us-west-2.elb.amazonaws.com</span><br><span class=\"line\">Ingress Class:    alb</span><br><span class=\"line\">Default backend:  &lt;default&gt;</span><br><span class=\"line\">Rules:</span><br><span class=\"line\">  Host                Path  Backends</span><br><span class=\"line\">  ----                ----  --------</span><br><span class=\"line\">  eks.hanqunfeng.com</span><br><span class=\"line\">                      /   ssl-redirect:use-annotation (&lt;error: endpoints <span class=\"string\">&quot;ssl-redirect&quot;</span> not found&gt;)</span><br><span class=\"line\">                      /   service-2048:80 (192.168.0.196:80,192.168.20.125:80,192.168.22.188:80 + 2 more...)</span><br><span class=\"line\">  aws.hanqunfeng.com</span><br><span class=\"line\">                      /*   ssl-redirect:use-annotation (&lt;error: endpoints <span class=\"string\">&quot;ssl-redirect&quot;</span> not found&gt;)</span><br><span class=\"line\">                      /*   service-2048:80 (192.168.0.196:80,192.168.20.125:80,192.168.22.188:80 + 2 more...)</span><br><span class=\"line\">Annotations:          alb.ingress.kubernetes.io/actions.ssl-redirect:</span><br><span class=\"line\">                        &#123;<span class=\"string\">&quot;Type&quot;</span>: <span class=\"string\">&quot;redirect&quot;</span>, <span class=\"string\">&quot;RedirectConfig&quot;</span>:&#123; <span class=\"string\">&quot;Protocol&quot;</span>: <span class=\"string\">&quot;HTTPS&quot;</span>, <span class=\"string\">&quot;Port&quot;</span>: <span class=\"string\">&quot;443&quot;</span>, <span class=\"string\">&quot;StatusCode&quot;</span>: <span class=\"string\">&quot;HTTP_301&quot;</span>&#125;&#125;</span><br><span class=\"line\">                      alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:us-west-2:743263909655:certificate/e2e3fa54-98ab-427a-9f09-486a9831323e</span><br><span class=\"line\">                      alb.ingress.kubernetes.io/listen-ports: [&#123;<span class=\"string\">&quot;HTTP&quot;</span>: 80&#125;, &#123;<span class=\"string\">&quot;HTTPS&quot;</span>:443&#125;]</span><br><span class=\"line\">                      alb.ingress.kubernetes.io/scheme: internet-facing</span><br><span class=\"line\">                      alb.ingress.kubernetes.io/target-type: ip</span><br><span class=\"line\">Events:</span><br><span class=\"line\">  Type    Reason                  Age   From     Message</span><br><span class=\"line\">  ----    ------                  ----  ----     -------</span><br><span class=\"line\">  Normal  SuccessfullyReconciled  2s    ingress  Successfully reconciled</span><br></pre></td></tr></table></figure>\n<div class=\"tips\">\n<p><em><strong>在 Kubernetes Ingress 规则中，pathType 有三种可能的取值</strong></em></p>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">Exact: 使用 Exact 类型时，请求的路径必须与规则中指定的路径完全匹配，包括大小写。这是最精确的匹配方式。</li>\n<li class=\"lvl-2\">Prefix: 使用 Prefix 类型时，请求的路径只需以规则中指定的路径为前缀即可匹配。这种方式可以处理以指定路径为前缀的所有请求。</li>\n<li class=\"lvl-2\">ImplementationSpecific: 使用 ImplementationSpecific 类型时，路径匹配的行为由 Ingress 控制器的具体实现决定。这种类型的路径匹配方式在不同的 Ingress 控制器中可能会有所差异，因此具体行为可能会因实现而异。在 AWS ALB Ingress Controller 中，pathType 的 ImplementationSpecific 类型可以与多个 AWS Load Balancer 的功能集成，包括 Application Load Balancer (ALB)、Network Load Balancer (NLB) 和 Classic Load Balancer (CLB)。我们这里使用的是ALB。</li>\n</ul>\n</div>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ingress创建的elb<br>\n<img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/X1v4p4.jpg\" alt=\"\" width=\"1200\" height=\"800\"><br>\n<img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/36bhEE.jpg\" alt=\"\" width=\"1200\" height=\"500\"><br>\n<img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/UilkuJ.jpg\" alt=\"\" width=\"1200\" height=\"500\"></p>\n</li>\n<li class=\"lvl-2\">\n<p>域名解析配置<br>\n<img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/AcPHl2.jpg\" alt=\"\" width=\"1200\" height=\"300\"><br>\n<img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/DSZBrG.jpg\" alt=\"\" width=\"800\" height=\"800\"></p>\n</li>\n</ul>\n","content_text":"摘要 本文介绍为EKS集群创建基于LoadBalancer的service和ingress 参考资料： Amazon EKS用户指南 Kubernetes 文档 前置条件：安装 AWS Load Balancer Controller 附加组件 Service service与elb的绑定关系是通过注释实现的。这里service必须设置为LoadBalancer，一个service就对应一个elb。 创建服务后，请勿编辑注释。如果需要对其进行修改，请删除相应服务对象，然后使用此注释的所需值重新创建它。 service.beta.kubernetes.io/aws-load-balancer-scheme: internet-facing 表示允许外网访问，如果只允许集群内部访问，则去掉该注释即可。 12345678910111213141516171819202122232425262728293031323334353637383940414243444546# eks-loadbalancer-service.yaml---apiVersion: v1kind: Namespacemetadata: name: nlb-sample-app---apiVersion: apps/v1kind: Deploymentmetadata: name: nlb-sample-app namespace: nlb-sample-appspec: replicas: 3 selector: matchLabels: app: nginx template: metadata: labels: app: nginx spec: containers: - name: nginx image: public.ecr.aws/nginx/nginx:1.21 ports: - name: tcp containerPort: 80---apiVersion: v1kind: Servicemetadata: name: nlb-sample-service namespace: nlb-sample-app annotations: service.beta.kubernetes.io/aws-load-balancer-type: external service.beta.kubernetes.io/aws-load-balancer-nlb-target-type: ip service.beta.kubernetes.io/aws-load-balancer-scheme: internet-facingspec: ports: - port: 80 targetPort: 80 protocol: TCP type: LoadBalancer selector: app: nginx 1234$ k apply -f eks-loadbalancer-service.yaml$ k get svc -n nlb-sample-appNAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGEnlb-sample-service LoadBalancer 10.100.176.186 k8s-nlbsampl-nlbsampl-f492eca1e5-b4b9dd61dd8724e6.elb.us-west-2.amazonaws.com 80:31743/TCP 6m11s Ingress ingress与elb的绑定关系也是通过注释实现的，一个ingress绑定一个elb，可以同时对多个service提供映射。 为了支持https，需要先创建证书，我这里有一个域名hanqunfeng.com，通过AWS Certificate Manager创建证书 我这里使用的是根证书，注意这里一定要添加一个 *.hanqunfeng.com 的域名，否则使用子域名时会提示证书不匹配 去域名服务商处进行域名解析，配制好后等待证书颁发，耗时10分钟左右吧 测试用的service.yaml 12345678910111213141516171819202122232425262728293031323334353637383940apiVersion: v1kind: Namespacemetadata: name: game-2048---apiVersion: apps/v1kind: Deploymentmetadata: namespace: game-2048 name: deployment-2048spec: selector: matchLabels: app.kubernetes.io/name: app-2048 replicas: 5 template: metadata: labels: app.kubernetes.io/name: app-2048 spec: containers: - image: public.ecr.aws/l6m2t8p7/docker-2048:latest imagePullPolicy: Always name: app-2048 ports: - containerPort: 80---apiVersion: v1kind: Servicemetadata: namespace: game-2048 name: service-2048spec: ports: - port: 80 targetPort: 80 protocol: TCP type: ClusterIP # 也可以配置为 NodePort 或者 LoadBalancer selector: app.kubernetes.io/name: app-2048 1$ k apply -f service.yaml 测试用的ingress.yaml 这里为了演示，host都指向了同一个service ingress是通过注释实现与elb的绑定，包括监听端口、80重定向到443、https证书等等 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748apiVersion: networking.k8s.io/v1kind: Ingressmetadata: namespace: game-2048 name: ingress-2048 annotations: alb.ingress.kubernetes.io/actions.ssl-redirect: &#x27;&#123;&quot;Type&quot;: &quot;redirect&quot;, &quot;RedirectConfig&quot;:&#123; &quot;Protocol&quot;: &quot;HTTPS&quot;, &quot;Port&quot;: &quot;443&quot;, &quot;StatusCode&quot;: &quot;HTTP_301&quot;&#125;&#125;&#x27; # http重定向到https alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:us-west-2:743263909655:certificate/e2e3fa54-98ab-427a-9f09-486a9831323e # https证书，就是上面创建的证书的arn alb.ingress.kubernetes.io/listen-ports: &#x27;[&#123;&quot;HTTP&quot;: 80&#125;, &#123;&quot;HTTPS&quot;:443&#125;]&#x27; # 监听端口 alb.ingress.kubernetes.io/scheme: internet-facing # 开放外网访问 alb.ingress.kubernetes.io/target-type: ipspec: ingressClassName: alb # 指定ingressclass类型，k8s-1.18及以后的版本推荐这种配置方式，旧版本需要在注释中加入 kubernetes.io/ingress.class: alb rules: - host: eks.hanqunfeng.com # 域名绑定，需要到域名服务商处进行域名解析，CNAME到当前生成的elb http: paths: - path: / # 重定向配置，这里必须配置，否则不能实现重定向 pathType: Prefix backend: service: name: ssl-redirect port: name: use-annotation - path: / pathType: Prefix backend: service: name: service-2048 port: number: 80 - host: aws.hanqunfeng.com http: paths: - path: /* pathType: ImplementationSpecific backend: service: name: ssl-redirect port: name: use-annotation - path: /* pathType: ImplementationSpecific backend: service: name: service-2048 port: number: 80 123456789101112131415161718192021222324252627282930# 部署ingress$ k apply -f ingress.yaml# 查看ingress$ k describe ing -n game-2048 ingress-2048Name: ingress-2048Labels: &lt;none&gt;Namespace: game-2048Address: k8s-game2048-ingress2-1ca4fafb1f-272829398.us-west-2.elb.amazonaws.comIngress Class: albDefault backend: &lt;default&gt;Rules: Host Path Backends ---- ---- -------- eks.hanqunfeng.com / ssl-redirect:use-annotation (&lt;error: endpoints &quot;ssl-redirect&quot; not found&gt;) / service-2048:80 (192.168.0.196:80,192.168.20.125:80,192.168.22.188:80 + 2 more...) aws.hanqunfeng.com /* ssl-redirect:use-annotation (&lt;error: endpoints &quot;ssl-redirect&quot; not found&gt;) /* service-2048:80 (192.168.0.196:80,192.168.20.125:80,192.168.22.188:80 + 2 more...)Annotations: alb.ingress.kubernetes.io/actions.ssl-redirect: &#123;&quot;Type&quot;: &quot;redirect&quot;, &quot;RedirectConfig&quot;:&#123; &quot;Protocol&quot;: &quot;HTTPS&quot;, &quot;Port&quot;: &quot;443&quot;, &quot;StatusCode&quot;: &quot;HTTP_301&quot;&#125;&#125; alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:us-west-2:743263909655:certificate/e2e3fa54-98ab-427a-9f09-486a9831323e alb.ingress.kubernetes.io/listen-ports: [&#123;&quot;HTTP&quot;: 80&#125;, &#123;&quot;HTTPS&quot;:443&#125;] alb.ingress.kubernetes.io/scheme: internet-facing alb.ingress.kubernetes.io/target-type: ipEvents: Type Reason Age From Message ---- ------ ---- ---- ------- Normal SuccessfullyReconciled 2s ingress Successfully reconciled 在 Kubernetes Ingress 规则中，pathType 有三种可能的取值 Exact: 使用 Exact 类型时，请求的路径必须与规则中指定的路径完全匹配，包括大小写。这是最精确的匹配方式。 Prefix: 使用 Prefix 类型时，请求的路径只需以规则中指定的路径为前缀即可匹配。这种方式可以处理以指定路径为前缀的所有请求。 ImplementationSpecific: 使用 ImplementationSpecific 类型时，路径匹配的行为由 Ingress 控制器的具体实现决定。这种类型的路径匹配方式在不同的 Ingress 控制器中可能会有所差异，因此具体行为可能会因实现而异。在 AWS ALB Ingress Controller 中，pathType 的 ImplementationSpecific 类型可以与多个 AWS Load Balancer 的功能集成，包括 Application Load Balancer (ALB)、Network Load Balancer (NLB) 和 Classic Load Balancer (CLB)。我们这里使用的是ALB。 ingress创建的elb 域名解析配置","summary":"摘要 本文介绍为EKS集群创建基于LoadBalancer的service和ingress 参考资料： Amazon EKS用户指南 Kubernetes 文档","date_published":"2023-07-07T14:50:05.000Z","tags":["技术","aws","eks","java"]},{"id":"https://blog.hanqunfeng.com/2023/07/07/aws-eks08-upgrade-eks/","url":"https://blog.hanqunfeng.com/2023/07/07/aws-eks08-upgrade-eks/","title":"AWS-EKS-08--升级集群与删除集群","content_html":"<!--\n **加粗**\n *斜体*\n ***加粗并斜体***\n ~~删除线~~\n ==突出显示==\n `突出显示(推荐)`\n ++下划线++\n ~下标~\n ^上标^\n 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.\n 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600)\n\n +++ **点击折叠**\n 这是被隐藏的内容\n +++\n\n::: tips success warning danger\n这里是容器内的内容\n:::\n\n% note info % success warning danger\n这里是容器内的内容\n% endnote %\n\n -->\n<h2 id=\"摘要\">摘要</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>本文介绍为EKS集群升级和集群删除的方法</p>\n</li>\n<li class=\"lvl-2\">\n<p>参考资料：</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\"><a href=\"https://docs.aws.amazon.com/zh_cn/eks/latest/userguide\">Amazon EKS用户指南</a></li>\n<li class=\"lvl-6\"><a href=\"https://kubernetes.io/zh-cn/docs/home/\">Kubernetes 文档</a></li>\n</ul>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"升级集群\">升级集群</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>eks升级分为server端升级，工作节点升级，客户端kubectl升级</p>\n</li>\n<li class=\"lvl-2\">\n<p>可以通过aws控制台升级集群，页面上点点按钮就可以了，这里给出的是通过命令行升级集群的方式</p>\n</li>\n<li class=\"lvl-2\">\n<p>每次升级只能升级一个次要版本</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 每次升级只能升级一个次要版本，先查看当前版本，当前server端是1.25，client端是1.24，最好也升级一下本地的kubectl client</span></span><br><span class=\"line\">$ kubectl version --short</span><br><span class=\"line\"></span><br><span class=\"line\">Flag --short has been deprecated, and will be removed <span class=\"keyword\">in</span> the future. The --short output will become the default.</span><br><span class=\"line\">Client Version: v1.24.2</span><br><span class=\"line\">Kustomize Version: v4.5.4</span><br><span class=\"line\">Server Version: v1.25.10-eks-c12679a</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>将集群升级到1.26</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ eksctl upgrade cluster --name eks-lexing --profile eks-us-west-2 --version 1.26 --approve</span><br><span class=\"line\">2023-06-29 19:03:35 [ℹ]  will upgrade cluster <span class=\"string\">&quot;eks-lexing&quot;</span> control plane from current version <span class=\"string\">&quot;1.25&quot;</span> to <span class=\"string\">&quot;1.26&quot;</span></span><br><span class=\"line\">2023-06-29 19:11:27 [✔]  cluster <span class=\"string\">&quot;eks-lexing&quot;</span> control plane has been upgraded to version <span class=\"string\">&quot;1.26&quot;</span></span><br><span class=\"line\">2023-06-29 19:11:27 [ℹ]  you will need to follow the upgrade procedure <span class=\"keyword\">for</span> all of nodegroups and add-ons</span><br><span class=\"line\">2023-06-29 19:11:29 [ℹ]  re-building cluster stack <span class=\"string\">&quot;eksctl-eks-lexing-cluster&quot;</span></span><br><span class=\"line\">2023-06-29 19:11:29 [✔]  all resources <span class=\"keyword\">in</span> cluster stack <span class=\"string\">&quot;eksctl-eks-lexing-cluster&quot;</span> are up-to-date</span><br><span class=\"line\">2023-06-29 19:11:30 [ℹ]  checking security group configuration <span class=\"keyword\">for</span> all nodegroups</span><br><span class=\"line\">2023-06-29 19:11:30 [ℹ]  all nodegroups have up-to-date cloudformation templates</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看server版本</span></span><br><span class=\"line\">$ kubectl version --short</span><br><span class=\"line\">Flag --short has been deprecated, and will be removed <span class=\"keyword\">in</span> the future. The --short output will become the default.</span><br><span class=\"line\">Client Version: v1.24.2</span><br><span class=\"line\">Kustomize Version: v4.5.4</span><br><span class=\"line\">Server Version: v1.26.6-eks-a5565ad</span><br><span class=\"line\">WARNING: version difference between client (1.24) and server (1.26) exceeds the supported minor version skew of +/-1</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>升级kubectl: 参看<a href=\"https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/install-kubectl.html\">安装或更新 kubectl</a></p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 进入到kubectl命令所在目录</span></span><br><span class=\"line\">$ <span class=\"built_in\">cd</span> /usr/local/bin</span><br><span class=\"line\"><span class=\"comment\"># 备份原命令</span></span><br><span class=\"line\">$ <span class=\"built_in\">mv</span> kubectl kubectl.back</span><br><span class=\"line\"><span class=\"comment\"># 下载指定版本</span></span><br><span class=\"line\">$ curl -O https://s3.us-west-2.amazonaws.com/amazon-eks/1.26.4/2023-05-11/bin/darwin/amd64/kubectl</span><br><span class=\"line\"><span class=\"comment\"># 授予执行权限</span></span><br><span class=\"line\">$ <span class=\"built_in\">chmod</span> +x kubectl</span><br><span class=\"line\"><span class=\"comment\"># 查看版本</span></span><br><span class=\"line\">$ k version --short</span><br><span class=\"line\">Flag --short has been deprecated, and will be removed <span class=\"keyword\">in</span> the future. The --short output will become the default.</span><br><span class=\"line\">Client Version: v1.26.4-eks-0a21954</span><br><span class=\"line\">Kustomize Version: v4.5.7</span><br><span class=\"line\">Server Version: v1.26.6-eks-a5565ad</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>升级work节点机版本</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看节点组信息，看到type为managed，表示被托管的节点组，这里要注意，托管和非托管升级方式是不一样的</span></span><br><span class=\"line\">$ eksctl get nodegroup --cluster eks-lexing --profile eks-us-west-2</span><br><span class=\"line\">CLUSTER        NODEGROUP    STATUS    CREATED            MIN SIZE    MAX SIZE    DESIRED CAPACITY    INSTANCE TYPE    IMAGE ID    ASG NAME                    TYPE</span><br><span class=\"line\">eks-lexing    ng-4d9024eb    ACTIVE    2023-06-28T06:30:03Z    2        2        m5.large    AL2_x86_64    eks-ng-4d9024eb-20c48058-e974-c6ec-786a-516c31131604    managed</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看节点组上的k8s版本信息，实际上节点组信息可以通过控制台查看--&gt; EKS-集群--计算</span></span><br><span class=\"line\">$ aws eks describe-nodegroup --cluster-name eks-lexing --profile eks-us-west-2 --nodegroup-name ng-4d9024eb --query <span class=\"string\">&#x27;nodegroup.version&#x27;</span> --output text</span><br><span class=\"line\">1.25</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看节点信息，这里也会显示k8s的版本，可以看到是v1.25.9</span></span><br><span class=\"line\">$ k get node -owide</span><br><span class=\"line\">NAME                                           STATUS   ROLES    AGE   VERSION               INTERNAL-IP      EXTERNAL-IP     OS-IMAGE         KERNEL-VERSION                  CONTAINER-RUNTIME</span><br><span class=\"line\">ip-192-168-25-29.us-west-2.compute.internal    Ready    &lt;none&gt;   28h   v1.25.9-eks-0a21954   192.168.25.29    35.87.26.4      Amazon Linux 2   5.10.179-168.710.amzn2.x86_64   containerd://1.6.19</span><br><span class=\"line\">ip-192-168-47-168.us-west-2.compute.internal   Ready    &lt;none&gt;   28h   v1.25.9-eks-0a21954   192.168.47.168   54.185.178.28   Amazon Linux 2   5.10.179-168.710.amzn2.x86_64   containerd://1.6.19</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 升级节点组，每次也只升级一个次要版本，2个node就用时20多分钟，还是比较慢的</span></span><br><span class=\"line\">$ eksctl upgrade nodegroup --name=ng-4d9024eb --cluster=eks-lexing --profile=eks-us-west-2 --kubernetes-version=1.26</span><br><span class=\"line\">2023-06-29 19:31:24 [ℹ]  setting ForceUpdateEnabled value to <span class=\"literal\">false</span></span><br><span class=\"line\">2023-06-29 19:31:24 [ℹ]  updating nodegroup stack</span><br><span class=\"line\">2023-06-29 19:31:26 [ℹ]  waiting <span class=\"keyword\">for</span> CloudFormation changeset <span class=\"string\">&quot;eksctl-update-nodegroup-1688038284&quot;</span> <span class=\"keyword\">for</span> stack <span class=\"string\">&quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;</span></span><br><span class=\"line\">2023-06-29 19:31:57 [ℹ]  waiting <span class=\"keyword\">for</span> CloudFormation changeset <span class=\"string\">&quot;eksctl-update-nodegroup-1688038284&quot;</span> <span class=\"keyword\">for</span> stack <span class=\"string\">&quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;</span></span><br><span class=\"line\">2023-06-29 19:31:58 [ℹ]  waiting <span class=\"keyword\">for</span> CloudFormation stack <span class=\"string\">&quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;</span></span><br><span class=\"line\">2023-06-29 19:32:29 [ℹ]  waiting <span class=\"keyword\">for</span> CloudFormation stack <span class=\"string\">&quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;</span></span><br><span class=\"line\">2023-06-29 19:32:30 [ℹ]  upgrading nodegroup version</span><br><span class=\"line\">2023-06-29 19:32:30 [ℹ]  updating nodegroup stack</span><br><span class=\"line\">2023-06-29 19:32:31 [ℹ]  waiting <span class=\"keyword\">for</span> CloudFormation changeset <span class=\"string\">&quot;eksctl-update-nodegroup-1688038350&quot;</span> <span class=\"keyword\">for</span> stack <span class=\"string\">&quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;</span></span><br><span class=\"line\">2023-06-29 19:33:03 [ℹ]  waiting <span class=\"keyword\">for</span> CloudFormation changeset <span class=\"string\">&quot;eksctl-update-nodegroup-1688038350&quot;</span> <span class=\"keyword\">for</span> stack <span class=\"string\">&quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;</span></span><br><span class=\"line\">2023-06-29 19:33:04 [ℹ]  waiting <span class=\"keyword\">for</span> CloudFormation stack <span class=\"string\">&quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;</span></span><br><span class=\"line\">2023-06-29 19:33:35 [ℹ]  waiting <span class=\"keyword\">for</span> CloudFormation stack <span class=\"string\">&quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;</span></span><br><span class=\"line\">2023-06-29 19:34:33 [ℹ]  waiting <span class=\"keyword\">for</span> CloudFormation stack <span class=\"string\">&quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;</span></span><br><span class=\"line\">2023-06-29 19:36:24 [ℹ]  waiting <span class=\"keyword\">for</span> CloudFormation stack <span class=\"string\">&quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;</span></span><br><span class=\"line\">2023-06-29 19:38:11 [ℹ]  waiting <span class=\"keyword\">for</span> CloudFormation stack <span class=\"string\">&quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;</span></span><br><span class=\"line\">2023-06-29 19:39:11 [ℹ]  waiting <span class=\"keyword\">for</span> CloudFormation stack <span class=\"string\">&quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;</span></span><br><span class=\"line\">2023-06-29 19:39:58 [ℹ]  waiting <span class=\"keyword\">for</span> CloudFormation stack <span class=\"string\">&quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;</span></span><br><span class=\"line\">2023-06-29 19:41:28 [ℹ]  waiting <span class=\"keyword\">for</span> CloudFormation stack <span class=\"string\">&quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;</span></span><br><span class=\"line\">2023-06-29 19:43:27 [ℹ]  waiting <span class=\"keyword\">for</span> CloudFormation stack <span class=\"string\">&quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;</span></span><br><span class=\"line\">2023-06-29 19:44:26 [ℹ]  waiting <span class=\"keyword\">for</span> CloudFormation stack <span class=\"string\">&quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;</span></span><br><span class=\"line\">2023-06-29 19:45:48 [ℹ]  waiting <span class=\"keyword\">for</span> CloudFormation stack <span class=\"string\">&quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;</span></span><br><span class=\"line\">2023-06-29 19:47:06 [ℹ]  waiting <span class=\"keyword\">for</span> CloudFormation stack <span class=\"string\">&quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;</span></span><br><span class=\"line\">2023-06-29 19:48:35 [ℹ]  waiting <span class=\"keyword\">for</span> CloudFormation stack <span class=\"string\">&quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;</span></span><br><span class=\"line\">2023-06-29 19:50:04 [ℹ]  waiting <span class=\"keyword\">for</span> CloudFormation stack <span class=\"string\">&quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;</span></span><br><span class=\"line\">2023-06-29 19:50:44 [ℹ]  waiting <span class=\"keyword\">for</span> CloudFormation stack <span class=\"string\">&quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;</span></span><br><span class=\"line\">2023-06-29 19:51:57 [ℹ]  waiting <span class=\"keyword\">for</span> CloudFormation stack <span class=\"string\">&quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;</span></span><br><span class=\"line\">2023-06-29 19:53:36 [ℹ]  waiting <span class=\"keyword\">for</span> CloudFormation stack <span class=\"string\">&quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;</span></span><br><span class=\"line\">2023-06-29 19:53:36 [ℹ]  nodegroup successfully upgraded</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 再次查看版本</span></span><br><span class=\"line\">$ aws eks describe-nodegroup --cluster-name eks-lexing --profile eks-us-west-2 --nodegroup-name ng-4d9024eb --query <span class=\"string\">&#x27;nodegroup.version&#x27;</span> --output text</span><br><span class=\"line\">1.26</span><br><span class=\"line\"></span><br><span class=\"line\">$ k get node -owide</span><br><span class=\"line\">NAME                                          STATUS   ROLES    AGE   VERSION               INTERNAL-IP     EXTERNAL-IP      OS-IMAGE         KERNEL-VERSION                  CONTAINER-RUNTIME</span><br><span class=\"line\">ip-192-168-48-14.us-west-2.compute.internal   Ready    &lt;none&gt;   20m   v1.26.4-eks-0a21954   192.168.48.14   54.212.74.15     Amazon Linux 2   5.10.179-168.710.amzn2.x86_64   containerd://1.6.19</span><br><span class=\"line\">ip-192-168-69-81.us-west-2.compute.internal   Ready    &lt;none&gt;   21m   v1.26.4-eks-0a21954   192.168.69.81   44.242.163.187   Amazon Linux 2   5.10.179-168.710.amzn2.x86_64   containerd://1.6.19</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>升级之后可以登录aws控制台查看一下相关插件是否需要升级，如果需要直接在页面上点击升级即可。</p>\n</li>\n</ul>\n<h2 id=\"删除集群\">删除集群</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>从<a href=\"https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/delete-cluster.html\">官方文档</a>中可以看到可以使用 eksctl、AWS Management Console 或 AWS CLI 删除集群，这里以eksctl为例说明。</p>\n</li>\n<li class=\"lvl-2\">\n<p>如果集群中具有与负载均衡器关联的有效服务，则必须先删除这些服务，然后再删除集群，以便正确删除负载均衡器。否则，VPC 中可能有阻止您删除 VPC 的孤立资源。</p>\n</li>\n<li class=\"lvl-2\">\n<p>列出集群中运行的所有服务</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubectl get svc --all-namespaces</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>删除具有关联的 EXTERNAL-IP 值的任何服务。这些服务的前面配置了一个 Elastic Load Balancing 负载均衡器，您必须从 Kubernetes 中将其删除才能释放负载均衡器和关联资源</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubectl delete svc `service-name`</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>删除集群</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 运行时间基于当前集群所使用的资源规模，超过10分钟</span></span><br><span class=\"line\">$ eksctl delete cluster --name eks-lexing  --profile myProfile</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>删除完成后检查一下对应的ec2,负载均衡器,目标群组,vpc,安全组,弹性ip,卷,net网关以及CloudFormation<br>\n是否都已经删除，如果有遗漏需要手工删除。</p>\n</li>\n</ul>\n","content_text":"摘要 本文介绍为EKS集群升级和集群删除的方法 参考资料： Amazon EKS用户指南 Kubernetes 文档 升级集群 eks升级分为server端升级，工作节点升级，客户端kubectl升级 可以通过aws控制台升级集群，页面上点点按钮就可以了，这里给出的是通过命令行升级集群的方式 每次升级只能升级一个次要版本 1234567# 每次升级只能升级一个次要版本，先查看当前版本，当前server端是1.25，client端是1.24，最好也升级一下本地的kubectl client$ kubectl version --shortFlag --short has been deprecated, and will be removed in the future. The --short output will become the default.Client Version: v1.24.2Kustomize Version: v4.5.4Server Version: v1.25.10-eks-c12679a 将集群升级到1.26 12345678910111213141516$ eksctl upgrade cluster --name eks-lexing --profile eks-us-west-2 --version 1.26 --approve2023-06-29 19:03:35 [ℹ] will upgrade cluster &quot;eks-lexing&quot; control plane from current version &quot;1.25&quot; to &quot;1.26&quot;2023-06-29 19:11:27 [✔] cluster &quot;eks-lexing&quot; control plane has been upgraded to version &quot;1.26&quot;2023-06-29 19:11:27 [ℹ] you will need to follow the upgrade procedure for all of nodegroups and add-ons2023-06-29 19:11:29 [ℹ] re-building cluster stack &quot;eksctl-eks-lexing-cluster&quot;2023-06-29 19:11:29 [✔] all resources in cluster stack &quot;eksctl-eks-lexing-cluster&quot; are up-to-date2023-06-29 19:11:30 [ℹ] checking security group configuration for all nodegroups2023-06-29 19:11:30 [ℹ] all nodegroups have up-to-date cloudformation templates# 查看server版本$ kubectl version --shortFlag --short has been deprecated, and will be removed in the future. The --short output will become the default.Client Version: v1.24.2Kustomize Version: v4.5.4Server Version: v1.26.6-eks-a5565adWARNING: version difference between client (1.24) and server (1.26) exceeds the supported minor version skew of +/-1 升级kubectl: 参看安装或更新 kubectl 1234567891011121314# 进入到kubectl命令所在目录$ cd /usr/local/bin# 备份原命令$ mv kubectl kubectl.back# 下载指定版本$ curl -O https://s3.us-west-2.amazonaws.com/amazon-eks/1.26.4/2023-05-11/bin/darwin/amd64/kubectl# 授予执行权限$ chmod +x kubectl# 查看版本$ k version --shortFlag --short has been deprecated, and will be removed in the future. The --short output will become the default.Client Version: v1.26.4-eks-0a21954Kustomize Version: v4.5.7Server Version: v1.26.6-eks-a5565ad 升级work节点机版本 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354# 查看节点组信息，看到type为managed，表示被托管的节点组，这里要注意，托管和非托管升级方式是不一样的$ eksctl get nodegroup --cluster eks-lexing --profile eks-us-west-2CLUSTER NODEGROUP STATUS CREATED MIN SIZE MAX SIZE DESIRED CAPACITY INSTANCE TYPE IMAGE ID ASG NAME TYPEeks-lexing ng-4d9024eb ACTIVE 2023-06-28T06:30:03Z 2 2 m5.large AL2_x86_64 eks-ng-4d9024eb-20c48058-e974-c6ec-786a-516c31131604 managed# 查看节点组上的k8s版本信息，实际上节点组信息可以通过控制台查看--&gt; EKS-集群--计算$ aws eks describe-nodegroup --cluster-name eks-lexing --profile eks-us-west-2 --nodegroup-name ng-4d9024eb --query &#x27;nodegroup.version&#x27; --output text1.25# 查看节点信息，这里也会显示k8s的版本，可以看到是v1.25.9$ k get node -owideNAME STATUS ROLES AGE VERSION INTERNAL-IP EXTERNAL-IP OS-IMAGE KERNEL-VERSION CONTAINER-RUNTIMEip-192-168-25-29.us-west-2.compute.internal Ready &lt;none&gt; 28h v1.25.9-eks-0a21954 192.168.25.29 35.87.26.4 Amazon Linux 2 5.10.179-168.710.amzn2.x86_64 containerd://1.6.19ip-192-168-47-168.us-west-2.compute.internal Ready &lt;none&gt; 28h v1.25.9-eks-0a21954 192.168.47.168 54.185.178.28 Amazon Linux 2 5.10.179-168.710.amzn2.x86_64 containerd://1.6.19# 升级节点组，每次也只升级一个次要版本，2个node就用时20多分钟，还是比较慢的$ eksctl upgrade nodegroup --name=ng-4d9024eb --cluster=eks-lexing --profile=eks-us-west-2 --kubernetes-version=1.262023-06-29 19:31:24 [ℹ] setting ForceUpdateEnabled value to false2023-06-29 19:31:24 [ℹ] updating nodegroup stack2023-06-29 19:31:26 [ℹ] waiting for CloudFormation changeset &quot;eksctl-update-nodegroup-1688038284&quot; for stack &quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;2023-06-29 19:31:57 [ℹ] waiting for CloudFormation changeset &quot;eksctl-update-nodegroup-1688038284&quot; for stack &quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;2023-06-29 19:31:58 [ℹ] waiting for CloudFormation stack &quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;2023-06-29 19:32:29 [ℹ] waiting for CloudFormation stack &quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;2023-06-29 19:32:30 [ℹ] upgrading nodegroup version2023-06-29 19:32:30 [ℹ] updating nodegroup stack2023-06-29 19:32:31 [ℹ] waiting for CloudFormation changeset &quot;eksctl-update-nodegroup-1688038350&quot; for stack &quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;2023-06-29 19:33:03 [ℹ] waiting for CloudFormation changeset &quot;eksctl-update-nodegroup-1688038350&quot; for stack &quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;2023-06-29 19:33:04 [ℹ] waiting for CloudFormation stack &quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;2023-06-29 19:33:35 [ℹ] waiting for CloudFormation stack &quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;2023-06-29 19:34:33 [ℹ] waiting for CloudFormation stack &quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;2023-06-29 19:36:24 [ℹ] waiting for CloudFormation stack &quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;2023-06-29 19:38:11 [ℹ] waiting for CloudFormation stack &quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;2023-06-29 19:39:11 [ℹ] waiting for CloudFormation stack &quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;2023-06-29 19:39:58 [ℹ] waiting for CloudFormation stack &quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;2023-06-29 19:41:28 [ℹ] waiting for CloudFormation stack &quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;2023-06-29 19:43:27 [ℹ] waiting for CloudFormation stack &quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;2023-06-29 19:44:26 [ℹ] waiting for CloudFormation stack &quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;2023-06-29 19:45:48 [ℹ] waiting for CloudFormation stack &quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;2023-06-29 19:47:06 [ℹ] waiting for CloudFormation stack &quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;2023-06-29 19:48:35 [ℹ] waiting for CloudFormation stack &quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;2023-06-29 19:50:04 [ℹ] waiting for CloudFormation stack &quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;2023-06-29 19:50:44 [ℹ] waiting for CloudFormation stack &quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;2023-06-29 19:51:57 [ℹ] waiting for CloudFormation stack &quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;2023-06-29 19:53:36 [ℹ] waiting for CloudFormation stack &quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;2023-06-29 19:53:36 [ℹ] nodegroup successfully upgraded# 再次查看版本$ aws eks describe-nodegroup --cluster-name eks-lexing --profile eks-us-west-2 --nodegroup-name ng-4d9024eb --query &#x27;nodegroup.version&#x27; --output text1.26$ k get node -owideNAME STATUS ROLES AGE VERSION INTERNAL-IP EXTERNAL-IP OS-IMAGE KERNEL-VERSION CONTAINER-RUNTIMEip-192-168-48-14.us-west-2.compute.internal Ready &lt;none&gt; 20m v1.26.4-eks-0a21954 192.168.48.14 54.212.74.15 Amazon Linux 2 5.10.179-168.710.amzn2.x86_64 containerd://1.6.19ip-192-168-69-81.us-west-2.compute.internal Ready &lt;none&gt; 21m v1.26.4-eks-0a21954 192.168.69.81 44.242.163.187 Amazon Linux 2 5.10.179-168.710.amzn2.x86_64 containerd://1.6.19 升级之后可以登录aws控制台查看一下相关插件是否需要升级，如果需要直接在页面上点击升级即可。 删除集群 从官方文档中可以看到可以使用 eksctl、AWS Management Console 或 AWS CLI 删除集群，这里以eksctl为例说明。 如果集群中具有与负载均衡器关联的有效服务，则必须先删除这些服务，然后再删除集群，以便正确删除负载均衡器。否则，VPC 中可能有阻止您删除 VPC 的孤立资源。 列出集群中运行的所有服务 1$ kubectl get svc --all-namespaces 删除具有关联的 EXTERNAL-IP 值的任何服务。这些服务的前面配置了一个 Elastic Load Balancing 负载均衡器，您必须从 Kubernetes 中将其删除才能释放负载均衡器和关联资源 1$ kubectl delete svc `service-name` 删除集群 12# 运行时间基于当前集群所使用的资源规模，超过10分钟$ eksctl delete cluster --name eks-lexing --profile myProfile 删除完成后检查一下对应的ec2,负载均衡器,目标群组,vpc,安全组,弹性ip,卷,net网关以及CloudFormation 是否都已经删除，如果有遗漏需要手工删除。","summary":"摘要 本文介绍为EKS集群升级和集群删除的方法 参考资料： Amazon EKS用户指南 Kubernetes 文档","date_published":"2023-07-07T14:40:05.000Z","tags":["技术","aws","eks","java"]},{"id":"https://blog.hanqunfeng.com/2023/07/07/aws-eks07-loadbalancer/","url":"https://blog.hanqunfeng.com/2023/07/07/aws-eks07-loadbalancer/","title":"AWS-EKS-07--安装 AWS Load Balancer Controller 附加组件","content_html":"<!--\n **加粗**\n *斜体*\n ***加粗并斜体***\n ~~删除线~~\n ==突出显示==\n `突出显示(推荐)`\n ++下划线++\n ~下标~\n ^上标^\n 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.\n 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600)\n\n +++ **点击折叠**\n 这是被隐藏的内容\n +++\n\n::: tips success warning danger\n这里是容器内的内容\n:::\n\n% note info % success warning danger\n这里是容器内的内容\n% endnote %\n\n -->\n<h2 id=\"摘要\">摘要</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>本文介绍为EKS集群安装 AWS Load Balancer Controller 附加组件</p>\n</li>\n<li class=\"lvl-2\">\n<p>参考资料：</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\"><a href=\"https://docs.aws.amazon.com/zh_cn/eks/latest/userguide\">Amazon EKS用户指南</a></li>\n<li class=\"lvl-6\"><a href=\"https://kubernetes.io/zh-cn/docs/home/\">Kubernetes 文档</a></li>\n</ul>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"安装-AWS-Load-Balancer-Controller-附加组件\">安装 AWS Load Balancer Controller 附加组件</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>AWS Load Balancer Controller 管理适用于 Kubernetes 集群的 AWS 弹性负载均衡器。此控制器预置以下资源：</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">当您创建 Kubernetes Ingress 时的 AWS 应用程序负载均衡器 (ALB, Application Load Balancer)。</li>\n<li class=\"lvl-6\">当您创建 LoadBalancer 类型的 Kubernetes 服务时的 AWS 网络负载均衡器（NLB）。</li>\n</ul>\n</li>\n<li class=\"lvl-2\">\n<p>关于如何创建ingress和service，后面会介绍。</p>\n</li>\n</ul>\n<h3 id=\"创建一个-IAM-policy\">创建一个 IAM policy</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 下载 AWS Load Balancer Controller 的 IAM policy，该策略允许负载均衡器代表您调用 AWS API。</span></span><br><span class=\"line\">$ curl -O https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/v2.4.7/docs/install/iam_policy.json</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 使用上一步中下载的策略创建一个 IAM policy</span></span><br><span class=\"line\">$ aws iam create-policy \\</span><br><span class=\"line\">    --profile eks-us-west-2 \\</span><br><span class=\"line\">    --policy-name AWSLoadBalancerControllerIAMPolicy \\</span><br><span class=\"line\">    --policy-document file://iam_policy.json</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;Policy&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;PolicyName&quot;</span>: <span class=\"string\">&quot;AWSLoadBalancerControllerIAMPolicy&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;PolicyId&quot;</span>: <span class=\"string\">&quot;ANPA22DP3G4GO5O54MRRX&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;Arn&quot;</span>: <span class=\"string\">&quot;arn:aws:iam::743263909655:policy/AWSLoadBalancerControllerIAMPolicy&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;Path&quot;</span>: <span class=\"string\">&quot;/&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;DefaultVersionId&quot;</span>: <span class=\"string\">&quot;v1&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;AttachmentCount&quot;</span>: 0,</span><br><span class=\"line\">        <span class=\"string\">&quot;PermissionsBoundaryUsageCount&quot;</span>: 0,</span><br><span class=\"line\">        <span class=\"string\">&quot;IsAttachable&quot;</span>: <span class=\"literal\">true</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;CreateDate&quot;</span>: <span class=\"string\">&quot;2023-07-04T09:15:56+00:00&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;UpdateDate&quot;</span>: <span class=\"string\">&quot;2023-07-04T09:15:56+00:00&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"创建一个-IAM-角色\">创建一个 IAM 角色</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 在 AWS Load Balancer Controller 的 kube-system 命名空间中创建名为 aws-load-balancer-controller 的 Kubernetes 服务账户，并使用 IAM 角色的名称注释 Kubernetes 服务账户。</span></span><br><span class=\"line\">$ eksctl create iamserviceaccount \\</span><br><span class=\"line\">  --cluster=eks-lexing \\</span><br><span class=\"line\">  --profile eks-us-west-2 \\</span><br><span class=\"line\">  --namespace=kube-system \\</span><br><span class=\"line\">  --name=aws-load-balancer-controller \\</span><br><span class=\"line\">  --role-name AmazonEKSLoadBalancerControllerRole \\</span><br><span class=\"line\">  --attach-policy-arn=arn:aws:iam::743263909655:policy/AWSLoadBalancerControllerIAMPolicy \\</span><br><span class=\"line\">  --approve</span><br><span class=\"line\">2023-07-04 17:20:08 [ℹ]  3 existing iamserviceaccount(s) (kube-system/aws-node,kube-system/ebs-csi-controller-sa,kube-system/efs-csi-controller-sa) will be excluded</span><br><span class=\"line\">2023-07-04 17:20:08 [ℹ]  1 iamserviceaccount (kube-system/aws-load-balancer-controller) was included (based on the include/exclude rules)</span><br><span class=\"line\">2023-07-04 17:20:08 [!]  serviceaccounts that exist <span class=\"keyword\">in</span> Kubernetes will be excluded, use --override-existing-serviceaccounts to override</span><br><span class=\"line\">2023-07-04 17:20:08 [ℹ]  1 task: &#123;</span><br><span class=\"line\">    2 sequential sub-tasks: &#123;</span><br><span class=\"line\">        create IAM role <span class=\"keyword\">for</span> serviceaccount <span class=\"string\">&quot;kube-system/aws-load-balancer-controller&quot;</span>,</span><br><span class=\"line\">        create serviceaccount <span class=\"string\">&quot;kube-system/aws-load-balancer-controller&quot;</span>,</span><br><span class=\"line\">    &#125; &#125;2023-07-04 17:20:08 [ℹ]  building iamserviceaccount stack <span class=\"string\">&quot;eksctl-eks-lexing-addon-iamserviceaccount-kube-system-aws-load-balancer-controller&quot;</span></span><br><span class=\"line\">2023-07-04 17:20:09 [ℹ]  deploying stack <span class=\"string\">&quot;eksctl-eks-lexing-addon-iamserviceaccount-kube-system-aws-load-balancer-controller&quot;</span></span><br><span class=\"line\">2023-07-04 17:20:09 [ℹ]  waiting <span class=\"keyword\">for</span> CloudFormation stack <span class=\"string\">&quot;eksctl-eks-lexing-addon-iamserviceaccount-kube-system-aws-load-balancer-controller&quot;</span></span><br><span class=\"line\">2023-07-04 17:20:40 [ℹ]  waiting <span class=\"keyword\">for</span> CloudFormation stack <span class=\"string\">&quot;eksctl-eks-lexing-addon-iamserviceaccount-kube-system-aws-load-balancer-controller&quot;</span></span><br><span class=\"line\">2023-07-04 17:20:41 [ℹ]  created serviceaccount <span class=\"string\">&quot;kube-system/aws-load-balancer-controller&quot;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"使用-Helm-V3来安装-AWS-Load-Balancer-Controller\">使用 Helm V3来安装 AWS Load Balancer Controller</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 添加 eks-charts 存储库</span></span><br><span class=\"line\">$ helm repo add eks https://aws.github.io/eks-charts</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 更新您的本地存储库，以确保您拥有最新的图表</span></span><br><span class=\"line\">$ helm repo update eks</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 安装 AWS Load Balancer Controller</span></span><br><span class=\"line\">$ helm install aws-load-balancer-controller eks/aws-load-balancer-controller \\</span><br><span class=\"line\">  -n kube-system \\</span><br><span class=\"line\">  --<span class=\"built_in\">set</span> clusterName=eks-lexing \\</span><br><span class=\"line\">  --<span class=\"built_in\">set</span> serviceAccount.create=<span class=\"literal\">false</span> \\</span><br><span class=\"line\">  --<span class=\"built_in\">set</span> serviceAccount.name=aws-load-balancer-controller</span><br><span class=\"line\">NAME: aws-load-balancer-controller</span><br><span class=\"line\">LAST DEPLOYED: Tue Jul  4 17:26:05 2023</span><br><span class=\"line\">NAMESPACE: kube-system</span><br><span class=\"line\">STATUS: deployed</span><br><span class=\"line\">REVISION: 1</span><br><span class=\"line\">TEST SUITE: None</span><br><span class=\"line\">NOTES:</span><br><span class=\"line\">AWS Load Balancer controller installed!</span><br></pre></td></tr></table></figure>\n<h3 id=\"验证控制器是否已经安装\">验证控制器是否已经安装</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看deployment</span></span><br><span class=\"line\">$ kubectl get deployment -n kube-system aws-load-balancer-controller</span><br><span class=\"line\">NAME                           READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class=\"line\">aws-load-balancer-controller   2/2     2            2           21s</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看ingressclasses</span></span><br><span class=\"line\">$ k get ingressclasses</span><br><span class=\"line\">NAME   CONTROLLER            PARAMETERS   AGE</span><br><span class=\"line\">alb    ingress.k8s.aws/alb   &lt;none&gt;       21s</span><br></pre></td></tr></table></figure>\n<h3 id=\"更新AWS-Load-Balancer-Controller\">更新AWS Load Balancer Controller</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>已部署的图表不会自动接收安全更新。当新图表可用时，您需要手动升级到新图表。</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 更新AWS Load Balancer Controller</span></span><br><span class=\"line\">$ kubectl apply -k <span class=\"string\">&quot;github.com/aws/eks-charts/stable/aws-load-balancer-controller/crds?ref=master&quot;</span></span><br><span class=\"line\">Warning: resource customresourcedefinitions/ingressclassparams.elbv2.k8s.aws is missing the kubectl.kubernetes.io/last-applied-configuration annotation <span class=\"built_in\">which</span> is required by kubectl apply. kubectl apply should only be used on resources created declaratively by either kubectl create --save-config or kubectl apply. The missing annotation will be patched automatically.</span><br><span class=\"line\">customresourcedefinition.apiextensions.k8s.io/ingressclassparams.elbv2.k8s.aws configured</span><br><span class=\"line\">Warning: resource customresourcedefinitions/targetgroupbindings.elbv2.k8s.aws is missing the kubectl.kubernetes.io/last-applied-configuration annotation <span class=\"built_in\">which</span> is required by kubectl apply. kubectl apply should only be used on resources created declaratively by either kubectl create --save-config or kubectl apply. The missing annotation will be patched automatically.</span><br><span class=\"line\">customresourcedefinition.apiextensions.k8s.io/targetgroupbindings.elbv2.k8s.aws configured</span><br><span class=\"line\"></span><br><span class=\"line\">$ helm upgrade aws-load-balancer-controller eks/aws-load-balancer-controller \\</span><br><span class=\"line\">  -n kube-system \\</span><br><span class=\"line\">  --<span class=\"built_in\">set</span> clusterName=eks-lexing \\</span><br><span class=\"line\">  --<span class=\"built_in\">set</span> serviceAccount.create=<span class=\"literal\">false</span> \\</span><br><span class=\"line\">  --<span class=\"built_in\">set</span> serviceAccount.name=aws-load-balancer-controller</span><br><span class=\"line\">Release <span class=\"string\">&quot;aws-load-balancer-controller&quot;</span> has been upgraded. Happy Helming!</span><br><span class=\"line\">NAME: aws-load-balancer-controller</span><br><span class=\"line\">LAST DEPLOYED: Tue Jul  4 17:31:37 2023</span><br><span class=\"line\">NAMESPACE: kube-system</span><br><span class=\"line\">STATUS: deployed</span><br><span class=\"line\">REVISION: 2</span><br><span class=\"line\">TEST SUITE: None</span><br><span class=\"line\">NOTES:</span><br><span class=\"line\">AWS Load Balancer controller installed!</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>可以先查看是否有可用更新</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看通过helm已经安装了哪些发布包及其版本</span></span><br><span class=\"line\">$ helm list --all-namespaces</span><br><span class=\"line\">NAME                        \tNAMESPACE  \tREVISION\tUPDATED                             \tSTATUS  \tCHART                             \tAPP VERSION</span><br><span class=\"line\">aws-efs-csi-driver          \tkube-system\t3       \t2023-07-03 16:08:38.481521 +0800 CST\tdeployed\taws-efs-csi-driver-2.4.6          \t1.5.7</span><br><span class=\"line\">aws-load-balancer-controller\tkube-system\t2       \t2023-07-04 17:31:37.839466 +0800 CST\tdeployed\taws-load-balancer-controller-1.5.4\tv2.5.3</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 更新仓库最新的索引</span></span><br><span class=\"line\">$ helm repo update</span><br><span class=\"line\">Hang tight <span class=\"keyword\">while</span> we grab the latest from your chart repositories...</span><br><span class=\"line\">...Successfully got an update from the <span class=\"string\">&quot;aws-efs-csi-driver&quot;</span> chart repository</span><br><span class=\"line\">...Successfully got an update from the <span class=\"string\">&quot;eks&quot;</span> chart repository</span><br><span class=\"line\">Update Complete. ⎈Happy Helming!⎈</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看可用的最新版本</span></span><br><span class=\"line\">$ helm search repo load-balancer</span><br><span class=\"line\">NAME                            \tCHART VERSION\tAPP VERSION\tDESCRIPTION</span><br><span class=\"line\">eks/aws-load-balancer-controller\t1.5.4        \tv2.5.3     \tAWS Load Balancer Controller Helm chart <span class=\"keyword\">for</span> Kub...</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看所有版本</span></span><br><span class=\"line\">$ helm search repo load-balancer -l</span><br><span class=\"line\">NAME                            \tCHART VERSION\tAPP VERSION\tDESCRIPTION</span><br><span class=\"line\">eks/aws-load-balancer-controller\t1.5.4        \tv2.5.3     \tAWS Load Balancer Controller Helm chart <span class=\"keyword\">for</span> Kub...</span><br><span class=\"line\">eks/aws-load-balancer-controller\t1.5.3        \tv2.5.2     \tAWS Load Balancer Controller Helm chart <span class=\"keyword\">for</span> Kub...</span><br><span class=\"line\">eks/aws-load-balancer-controller\t1.5.2        \tv2.5.1     \tAWS Load Balancer Controller Helm chart <span class=\"keyword\">for</span> Kub...</span><br><span class=\"line\">eks/aws-load-balancer-controller\t1.5.1        \tv2.5.1     \tAWS Load Balancer Controller Helm chart <span class=\"keyword\">for</span> Kub...</span><br><span class=\"line\">eks/aws-load-balancer-controller\t1.5.0        \tv2.5.0     \tAWS Load Balancer Controller Helm chart <span class=\"keyword\">for</span> Kub...</span><br><span class=\"line\">eks/aws-load-balancer-controller\t1.4.8        \tv2.4.7     \tAWS Load Balancer Controller Helm chart <span class=\"keyword\">for</span> Kub...</span><br><span class=\"line\">eks/aws-load-balancer-controller\t1.4.7        \tv2.4.6     \tAWS Load Balancer Controller Helm chart <span class=\"keyword\">for</span> Kub...</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>","content_text":"摘要 本文介绍为EKS集群安装 AWS Load Balancer Controller 附加组件 参考资料： Amazon EKS用户指南 Kubernetes 文档 安装 AWS Load Balancer Controller 附加组件 AWS Load Balancer Controller 管理适用于 Kubernetes 集群的 AWS 弹性负载均衡器。此控制器预置以下资源： 当您创建 Kubernetes Ingress 时的 AWS 应用程序负载均衡器 (ALB, Application Load Balancer)。 当您创建 LoadBalancer 类型的 Kubernetes 服务时的 AWS 网络负载均衡器（NLB）。 关于如何创建ingress和service，后面会介绍。 创建一个 IAM policy 12345678910111213141516171819202122# 下载 AWS Load Balancer Controller 的 IAM policy，该策略允许负载均衡器代表您调用 AWS API。$ curl -O https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/v2.4.7/docs/install/iam_policy.json# 使用上一步中下载的策略创建一个 IAM policy$ aws iam create-policy \\ --profile eks-us-west-2 \\ --policy-name AWSLoadBalancerControllerIAMPolicy \\ --policy-document file://iam_policy.json&#123; &quot;Policy&quot;: &#123; &quot;PolicyName&quot;: &quot;AWSLoadBalancerControllerIAMPolicy&quot;, &quot;PolicyId&quot;: &quot;ANPA22DP3G4GO5O54MRRX&quot;, &quot;Arn&quot;: &quot;arn:aws:iam::743263909655:policy/AWSLoadBalancerControllerIAMPolicy&quot;, &quot;Path&quot;: &quot;/&quot;, &quot;DefaultVersionId&quot;: &quot;v1&quot;, &quot;AttachmentCount&quot;: 0, &quot;PermissionsBoundaryUsageCount&quot;: 0, &quot;IsAttachable&quot;: true, &quot;CreateDate&quot;: &quot;2023-07-04T09:15:56+00:00&quot;, &quot;UpdateDate&quot;: &quot;2023-07-04T09:15:56+00:00&quot; &#125;&#125; 创建一个 IAM 角色 123456789101112131415161718192021# 在 AWS Load Balancer Controller 的 kube-system 命名空间中创建名为 aws-load-balancer-controller 的 Kubernetes 服务账户，并使用 IAM 角色的名称注释 Kubernetes 服务账户。$ eksctl create iamserviceaccount \\ --cluster=eks-lexing \\ --profile eks-us-west-2 \\ --namespace=kube-system \\ --name=aws-load-balancer-controller \\ --role-name AmazonEKSLoadBalancerControllerRole \\ --attach-policy-arn=arn:aws:iam::743263909655:policy/AWSLoadBalancerControllerIAMPolicy \\ --approve2023-07-04 17:20:08 [ℹ] 3 existing iamserviceaccount(s) (kube-system/aws-node,kube-system/ebs-csi-controller-sa,kube-system/efs-csi-controller-sa) will be excluded2023-07-04 17:20:08 [ℹ] 1 iamserviceaccount (kube-system/aws-load-balancer-controller) was included (based on the include/exclude rules)2023-07-04 17:20:08 [!] serviceaccounts that exist in Kubernetes will be excluded, use --override-existing-serviceaccounts to override2023-07-04 17:20:08 [ℹ] 1 task: &#123; 2 sequential sub-tasks: &#123; create IAM role for serviceaccount &quot;kube-system/aws-load-balancer-controller&quot;, create serviceaccount &quot;kube-system/aws-load-balancer-controller&quot;, &#125; &#125;2023-07-04 17:20:08 [ℹ] building iamserviceaccount stack &quot;eksctl-eks-lexing-addon-iamserviceaccount-kube-system-aws-load-balancer-controller&quot;2023-07-04 17:20:09 [ℹ] deploying stack &quot;eksctl-eks-lexing-addon-iamserviceaccount-kube-system-aws-load-balancer-controller&quot;2023-07-04 17:20:09 [ℹ] waiting for CloudFormation stack &quot;eksctl-eks-lexing-addon-iamserviceaccount-kube-system-aws-load-balancer-controller&quot;2023-07-04 17:20:40 [ℹ] waiting for CloudFormation stack &quot;eksctl-eks-lexing-addon-iamserviceaccount-kube-system-aws-load-balancer-controller&quot;2023-07-04 17:20:41 [ℹ] created serviceaccount &quot;kube-system/aws-load-balancer-controller&quot; 使用 Helm V3来安装 AWS Load Balancer Controller 1234567891011121314151617181920# 添加 eks-charts 存储库$ helm repo add eks https://aws.github.io/eks-charts# 更新您的本地存储库，以确保您拥有最新的图表$ helm repo update eks# 安装 AWS Load Balancer Controller$ helm install aws-load-balancer-controller eks/aws-load-balancer-controller \\ -n kube-system \\ --set clusterName=eks-lexing \\ --set serviceAccount.create=false \\ --set serviceAccount.name=aws-load-balancer-controllerNAME: aws-load-balancer-controllerLAST DEPLOYED: Tue Jul 4 17:26:05 2023NAMESPACE: kube-systemSTATUS: deployedREVISION: 1TEST SUITE: NoneNOTES:AWS Load Balancer controller installed! 验证控制器是否已经安装 123456789# 查看deployment$ kubectl get deployment -n kube-system aws-load-balancer-controllerNAME READY UP-TO-DATE AVAILABLE AGEaws-load-balancer-controller 2/2 2 2 21s# 查看ingressclasses$ k get ingressclassesNAME CONTROLLER PARAMETERS AGEalb ingress.k8s.aws/alb &lt;none&gt; 21s 更新AWS Load Balancer Controller 已部署的图表不会自动接收安全更新。当新图表可用时，您需要手动升级到新图表。 123456789101112131415161718192021# 更新AWS Load Balancer Controller$ kubectl apply -k &quot;github.com/aws/eks-charts/stable/aws-load-balancer-controller/crds?ref=master&quot;Warning: resource customresourcedefinitions/ingressclassparams.elbv2.k8s.aws is missing the kubectl.kubernetes.io/last-applied-configuration annotation which is required by kubectl apply. kubectl apply should only be used on resources created declaratively by either kubectl create --save-config or kubectl apply. The missing annotation will be patched automatically.customresourcedefinition.apiextensions.k8s.io/ingressclassparams.elbv2.k8s.aws configuredWarning: resource customresourcedefinitions/targetgroupbindings.elbv2.k8s.aws is missing the kubectl.kubernetes.io/last-applied-configuration annotation which is required by kubectl apply. kubectl apply should only be used on resources created declaratively by either kubectl create --save-config or kubectl apply. The missing annotation will be patched automatically.customresourcedefinition.apiextensions.k8s.io/targetgroupbindings.elbv2.k8s.aws configured$ helm upgrade aws-load-balancer-controller eks/aws-load-balancer-controller \\ -n kube-system \\ --set clusterName=eks-lexing \\ --set serviceAccount.create=false \\ --set serviceAccount.name=aws-load-balancer-controllerRelease &quot;aws-load-balancer-controller&quot; has been upgraded. Happy Helming!NAME: aws-load-balancer-controllerLAST DEPLOYED: Tue Jul 4 17:31:37 2023NAMESPACE: kube-systemSTATUS: deployedREVISION: 2TEST SUITE: NoneNOTES:AWS Load Balancer controller installed! 可以先查看是否有可用更新 1234567891011121314151617181920212223242526272829# 查看通过helm已经安装了哪些发布包及其版本$ helm list --all-namespacesNAME NAMESPACE REVISION UPDATED STATUS CHART APP VERSIONaws-efs-csi-driver kube-system 3 2023-07-03 16:08:38.481521 +0800 CST deployed aws-efs-csi-driver-2.4.6 1.5.7aws-load-balancer-controller kube-system 2 2023-07-04 17:31:37.839466 +0800 CST deployed aws-load-balancer-controller-1.5.4 v2.5.3# 更新仓库最新的索引$ helm repo updateHang tight while we grab the latest from your chart repositories......Successfully got an update from the &quot;aws-efs-csi-driver&quot; chart repository...Successfully got an update from the &quot;eks&quot; chart repositoryUpdate Complete. ⎈Happy Helming!⎈# 查看可用的最新版本$ helm search repo load-balancerNAME CHART VERSION APP VERSION DESCRIPTIONeks/aws-load-balancer-controller 1.5.4 v2.5.3 AWS Load Balancer Controller Helm chart for Kub...# 查看所有版本$ helm search repo load-balancer -lNAME CHART VERSION APP VERSION DESCRIPTIONeks/aws-load-balancer-controller 1.5.4 v2.5.3 AWS Load Balancer Controller Helm chart for Kub...eks/aws-load-balancer-controller 1.5.3 v2.5.2 AWS Load Balancer Controller Helm chart for Kub...eks/aws-load-balancer-controller 1.5.2 v2.5.1 AWS Load Balancer Controller Helm chart for Kub...eks/aws-load-balancer-controller 1.5.1 v2.5.1 AWS Load Balancer Controller Helm chart for Kub...eks/aws-load-balancer-controller 1.5.0 v2.5.0 AWS Load Balancer Controller Helm chart for Kub...eks/aws-load-balancer-controller 1.4.8 v2.4.7 AWS Load Balancer Controller Helm chart for Kub...eks/aws-load-balancer-controller 1.4.7 v2.4.6 AWS Load Balancer Controller Helm chart for Kub...","summary":"摘要 本文介绍为EKS集群安装 AWS Load Balancer Controller 附加组件 参考资料： Amazon EKS用户指南 Kubernetes 文档","date_published":"2023-07-07T14:33:05.000Z","tags":["技术","aws","eks","java"]},{"id":"https://blog.hanqunfeng.com/2023/07/07/aws-eks06-efs-csi/","url":"https://blog.hanqunfeng.com/2023/07/07/aws-eks06-efs-csi/","title":"AWS-EKS-06--安装 Amazon EFS CSI 驱动程序","content_html":"<!--\n **加粗**\n *斜体*\n ***加粗并斜体***\n ~~删除线~~\n ==突出显示==\n `突出显示(推荐)`\n ++下划线++\n ~下标~\n ^上标^\n 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.\n 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600)\n\n +++ **点击折叠**\n 这是被隐藏的内容\n +++\n\n::: tips success warning danger\n这里是容器内的内容\n:::\n\n% note info % success warning danger\n这里是容器内的内容\n% endnote %\n\n -->\n<h2 id=\"摘要\">摘要</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>本文介绍为EKS集群安装 Amazon EFS CSI 驱动程序</p>\n</li>\n<li class=\"lvl-2\">\n<p>参考资料：</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\"><a href=\"https://docs.aws.amazon.com/zh_cn/eks/latest/userguide\">Amazon EKS用户指南</a></li>\n<li class=\"lvl-6\"><a href=\"https://kubernetes.io/zh-cn/docs/home/\">Kubernetes 文档</a></li>\n</ul>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"EFS和EBS的选择？\">EFS和EBS的选择？</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>如果是同一个Pod内的多个容器之间的存储共享，您可以考虑使用EBS卷。</p>\n</li>\n<li class=\"lvl-2\">\n<p>如果是不同的Pod之间的存储共享，此时由于可能跨可用区，您可以考虑使用EFS文件系统。</p>\n</li>\n</ul>\n<h2 id=\"安装-Amazon-EFS-CSI-驱动程序\">安装 Amazon EFS CSI 驱动程序</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>创建 IAM policy和角色</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 从 GitHub 下载 IAM policy 文档</span></span><br><span class=\"line\">$ curl -O https://raw.githubusercontent.com/kubernetes-sigs/aws-efs-csi-driver/master/docs/iam-policy-example.json</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建策略</span></span><br><span class=\"line\">$ aws iam create-policy --profile eks-us-west-2 \\</span><br><span class=\"line\">    --policy-name AmazonEKS_EFS_CSI_Driver_Policy \\</span><br><span class=\"line\">    --policy-document file://iam-policy-example.json</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;Policy&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;PolicyName&quot;</span>: <span class=\"string\">&quot;AmazonEKS_EFS_CSI_Driver_Policy&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;PolicyId&quot;</span>: <span class=\"string\">&quot;ANPA22DP3G4GHPABMGFXG&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;Arn&quot;</span>: <span class=\"string\">&quot;arn:aws:iam::743263909655:policy/AmazonEKS_EFS_CSI_Driver_Policy&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;Path&quot;</span>: <span class=\"string\">&quot;/&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;DefaultVersionId&quot;</span>: <span class=\"string\">&quot;v1&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;AttachmentCount&quot;</span>: 0,</span><br><span class=\"line\">        <span class=\"string\">&quot;PermissionsBoundaryUsageCount&quot;</span>: 0,</span><br><span class=\"line\">        <span class=\"string\">&quot;IsAttachable&quot;</span>: <span class=\"literal\">true</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;CreateDate&quot;</span>: <span class=\"string\">&quot;2023-07-03T07:35:31+00:00&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;UpdateDate&quot;</span>: <span class=\"string\">&quot;2023-07-03T07:35:31+00:00&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\"># 创建 IAM 角色并向其附加此 IAM policy</span></span><br><span class=\"line\"><span class=\"comment\"># 注意这里并没有指定角色名称，所以会自动生成一个角色名称并绑定到SA上</span></span><br><span class=\"line\">$ eksctl create iamserviceaccount \\</span><br><span class=\"line\">    --cluster eks-lexing \\</span><br><span class=\"line\">    --profile eks-us-west-2 \\</span><br><span class=\"line\">    --namespace kube-system \\</span><br><span class=\"line\">    --name efs-csi-controller-sa \\</span><br><span class=\"line\">    --attach-policy-arn arn:aws:iam::743263909655:policy/AmazonEKS_EFS_CSI_Driver_Policy \\</span><br><span class=\"line\">    --approve</span><br><span class=\"line\">2023-07-03 15:38:07 [ℹ]  2 existing iamserviceaccount(s) (kube-system/aws-node,kube-system/ebs-csi-controller-sa) will be excluded</span><br><span class=\"line\">2023-07-03 15:38:07 [ℹ]  1 iamserviceaccount (kube-system/efs-csi-controller-sa) was included (based on the include/exclude rules)</span><br><span class=\"line\">2023-07-03 15:38:07 [!]  serviceaccounts that exist <span class=\"keyword\">in</span> Kubernetes will be excluded, use --override-existing-serviceaccounts to override</span><br><span class=\"line\">2023-07-03 15:38:07 [ℹ]  1 task: &#123;</span><br><span class=\"line\">    2 sequential sub-tasks: &#123;</span><br><span class=\"line\">        create IAM role <span class=\"keyword\">for</span> serviceaccount <span class=\"string\">&quot;kube-system/efs-csi-controller-sa&quot;</span>,</span><br><span class=\"line\">        create serviceaccount <span class=\"string\">&quot;kube-system/efs-csi-controller-sa&quot;</span>,</span><br><span class=\"line\">    &#125; &#125;2023-07-03 15:38:07 [ℹ]  building iamserviceaccount stack <span class=\"string\">&quot;eksctl-eks-lexing-addon-iamserviceaccount-kube-system-efs-csi-controller-sa&quot;</span></span><br><span class=\"line\">2023-07-03 15:38:08 [ℹ]  deploying stack <span class=\"string\">&quot;eksctl-eks-lexing-addon-iamserviceaccount-kube-system-efs-csi-controller-sa&quot;</span></span><br><span class=\"line\">2023-07-03 15:38:08 [ℹ]  waiting <span class=\"keyword\">for</span> CloudFormation stack <span class=\"string\">&quot;eksctl-eks-lexing-addon-iamserviceaccount-kube-system-efs-csi-controller-sa&quot;</span></span><br><span class=\"line\">2023-07-03 15:38:39 [ℹ]  waiting <span class=\"keyword\">for</span> CloudFormation stack <span class=\"string\">&quot;eksctl-eks-lexing-addon-iamserviceaccount-kube-system-efs-csi-controller-sa&quot;</span></span><br><span class=\"line\">2023-07-03 15:38:40 [ℹ]  created serviceaccount <span class=\"string\">&quot;kube-system/efs-csi-controller-sa&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看创建后的SA，这里可以看到自动创建的角色名称</span></span><br><span class=\"line\">$ k describe sa efs-csi-controller-sa</span><br><span class=\"line\">Name:                efs-csi-controller-sa</span><br><span class=\"line\">Namespace:           kube-system</span><br><span class=\"line\">Labels:              app.kubernetes.io/managed-by=eksctl</span><br><span class=\"line\">Annotations:         eks.amazonaws.com/role-arn: arn:aws:iam::743263909644:role/eksctl-eks-lexing-addon-iamserviceaccount-ku-Role1-BOQ7WRWAQDOY</span><br><span class=\"line\">Image pull secrets:  &lt;none&gt;</span><br><span class=\"line\">Mountable secrets:   &lt;none&gt;</span><br><span class=\"line\">Tokens:              &lt;none&gt;</span><br><span class=\"line\">Events:              &lt;none&gt;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>安装 Amazon EFS 驱动程序</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 添加 Helm 存储库。</span></span><br><span class=\"line\">$ helm repo add aws-efs-csi-driver https://kubernetes-sigs.github.io/aws-efs-csi-driver/</span><br><span class=\"line\"><span class=\"comment\"># 更新存储库</span></span><br><span class=\"line\">$ helm repo update aws-efs-csi-driver</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 使用 Helm Chart 安装驱动程序的版本。</span></span><br><span class=\"line\"><span class=\"comment\"># 请将存储库地址替换为集群的容器镜像地址:https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/add-ons-images.html</span></span><br><span class=\"line\">$ helm upgrade -i aws-efs-csi-driver aws-efs-csi-driver/aws-efs-csi-driver \\</span><br><span class=\"line\">    --namespace kube-system \\</span><br><span class=\"line\">    --<span class=\"built_in\">set</span> image.repository=602401143452.dkr.ecr.us-west-2.amazonaws.com/eks/aws-efs-csi-driver \\</span><br><span class=\"line\">    --<span class=\"built_in\">set</span> controller.serviceAccount.create=<span class=\"literal\">false</span> \\</span><br><span class=\"line\">    --<span class=\"built_in\">set</span> controller.serviceAccount.name=efs-csi-controller-sa</span><br><span class=\"line\">Release <span class=\"string\">&quot;aws-efs-csi-driver&quot;</span> has been upgraded. Happy Helming!</span><br><span class=\"line\">NAME: aws-efs-csi-driver</span><br><span class=\"line\">LAST DEPLOYED: Mon Jul  3 16:08:38 2023</span><br><span class=\"line\">NAMESPACE: kube-system</span><br><span class=\"line\">STATUS: deployed</span><br><span class=\"line\">REVISION: 1</span><br><span class=\"line\">TEST SUITE: None</span><br><span class=\"line\">NOTES:</span><br><span class=\"line\">To verify that aws-efs-csi-driver has started, run:</span><br><span class=\"line\"></span><br><span class=\"line\">    kubectl get pod -n kube-system -l <span class=\"string\">&quot;app.kubernetes.io/name=aws-efs-csi-driver,app.kubernetes.io/instance=aws-efs-csi-driver&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看pod启动情况</span></span><br><span class=\"line\">$ kubectl get pod -n kube-system -l <span class=\"string\">&quot;app.kubernetes.io/name=aws-efs-csi-driver,app.kubernetes.io/instance=aws-efs-csi-driver&quot;</span></span><br><span class=\"line\">NAME                                  READY   STATUS    RESTARTS   AGE</span><br><span class=\"line\">efs-csi-controller-5c86cf4947-77dxh   3/3     Running   0          23s</span><br><span class=\"line\">efs-csi-controller-5c86cf4947-w6s6m   3/3     Running   0          23s</span><br><span class=\"line\">efs-csi-node-22mbf                    3/3     Running   0          7m41s</span><br><span class=\"line\">efs-csi-node-swc6t                    3/3     Running   0          7m40s</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#  如果pod启动失败，可能是镜像下载的问题，可以先删除deploy后重新执行 helm upgrade ...</span></span><br><span class=\"line\">$ k delete deploy -n kube-system efs-csi-controller</span><br></pre></td></tr></table></figure>\n<h2 id=\"创建-Amazon-EFS-文件系统\">创建 Amazon EFS 文件系统</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>创建安全组</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 检索您的集群所在的 VPC ID，并将其存储在变量中，以便在后续步骤中使用。</span></span><br><span class=\"line\">$ vpc_id=$(aws eks describe-cluster \\</span><br><span class=\"line\">    --name eks-lexing \\</span><br><span class=\"line\">    --profile eks-us-west-2 \\</span><br><span class=\"line\">    --query <span class=\"string\">&quot;cluster.resourcesVpcConfig.vpcId&quot;</span> \\</span><br><span class=\"line\">    --output text)</span><br><span class=\"line\">$ <span class=\"built_in\">echo</span> <span class=\"variable\">$vpc_id</span></span><br><span class=\"line\">vpc-088a65d5af782c20a</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 检索您的集群的 VPC 的 CIDR 范围，并将其存储在变量中，以便在后续步骤中使用</span></span><br><span class=\"line\">$ cidr_range=$(aws ec2 describe-vpcs \\</span><br><span class=\"line\">    --vpc-ids <span class=\"variable\">$vpc_id</span> \\</span><br><span class=\"line\">    --profile eks-us-west-2 \\</span><br><span class=\"line\">    --query <span class=\"string\">&quot;Vpcs[].CidrBlock&quot;</span> \\</span><br><span class=\"line\">    --output text)</span><br><span class=\"line\">$ <span class=\"built_in\">echo</span> <span class=\"variable\">$cidr_range</span></span><br><span class=\"line\">192.168.0.0/16</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建一个安全组，该安全组包含一条允许您的 Amazon EFS 挂载点的入站 NFS 流量的入站规则</span></span><br><span class=\"line\">$ security_group_id=$(aws ec2 create-security-group \\</span><br><span class=\"line\">    --group-name MyEfsSecurityGroup \\</span><br><span class=\"line\">    --description <span class=\"string\">&quot;My EFS security group&quot;</span> \\</span><br><span class=\"line\">    --vpc-id <span class=\"variable\">$vpc_id</span> \\</span><br><span class=\"line\">    --profile eks-us-west-2 \\</span><br><span class=\"line\">    --output text)</span><br><span class=\"line\">$ <span class=\"built_in\">echo</span> <span class=\"variable\">$security_group_id</span></span><br><span class=\"line\">sg-0d77e111b519834be</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建一条入站规则，该入站规则允许来自您的集群 VPC 的 CIDR 的入站 NFS 流量。</span></span><br><span class=\"line\">$ aws ec2 authorize-security-group-ingress \\</span><br><span class=\"line\">    --profile eks-us-west-2 \\</span><br><span class=\"line\">    --group-id <span class=\"variable\">$security_group_id</span> \\</span><br><span class=\"line\">    --protocol tcp \\</span><br><span class=\"line\">    --port 2049 \\</span><br><span class=\"line\">    --cidr <span class=\"variable\">$cidr_range</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;Return&quot;</span>: <span class=\"literal\">true</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;SecurityGroupRules&quot;</span>: [</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;SecurityGroupRuleId&quot;</span>: <span class=\"string\">&quot;sgr-09e1d9d2ec6d9bbe9&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;GroupId&quot;</span>: <span class=\"string\">&quot;sg-0d77e111b519834be&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;GroupOwnerId&quot;</span>: <span class=\"string\">&quot;743263909644&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;IsEgress&quot;</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;IpProtocol&quot;</span>: <span class=\"string\">&quot;tcp&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;FromPort&quot;</span>: 2049,</span><br><span class=\"line\">            <span class=\"string\">&quot;ToPort&quot;</span>: 2049,</span><br><span class=\"line\">            <span class=\"string\">&quot;CidrIpv4&quot;</span>: <span class=\"string\">&quot;192.168.0.0/16&quot;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    ]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/mgMVfF.jpg\" alt=\"\" width=\"1200\" height=\"600\"></p>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>创建EFS</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 创建文件系统</span></span><br><span class=\"line\">$ file_system_id=$(aws efs create-file-system \\</span><br><span class=\"line\">    --profile eks-us-west-2 \\</span><br><span class=\"line\">    --performance-mode generalPurpose \\</span><br><span class=\"line\">    --query <span class=\"string\">&#x27;FileSystemId&#x27;</span> \\</span><br><span class=\"line\">    --output text)</span><br><span class=\"line\">$ <span class=\"built_in\">echo</span> <span class=\"variable\">$file_system_id</span></span><br><span class=\"line\">fs-09447193939058538</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/pt4Y4d.jpg\" alt=\"\" width=\"1200\" height=\"300\"></p>\n<h2 id=\"EFS挂载目标和安全组（网络配置）\">EFS挂载目标和安全组（网络配置）</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>确定集群中节点所在的子网的 ID 以及子网所在的可用区</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 创建挂载目标</span></span><br><span class=\"line\"><span class=\"comment\"># 确定您的集群节点的 IP 地址</span></span><br><span class=\"line\">$ kubectl get nodes</span><br><span class=\"line\">NAME                                           STATUS   ROLES    AGE     VERSION</span><br><span class=\"line\">ip-192-168-16-155.us-west-2.compute.internal   Ready    &lt;none&gt;   3d20h   v1.26.4-eks-0a21954</span><br><span class=\"line\">ip-192-168-48-14.us-west-2.compute.internal    Ready    &lt;none&gt;   3d21h   v1.26.4-eks-0a21954</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 确定 VPC 中子网的 ID 以及子网所在的可用区</span></span><br><span class=\"line\">$ aws ec2 describe-subnets \\</span><br><span class=\"line\">    --profile eks-us-west-2 \\</span><br><span class=\"line\">    --filters <span class=\"string\">&quot;Name=vpc-id,Values=<span class=\"variable\">$vpc_id</span>&quot;</span> \\</span><br><span class=\"line\">    --query <span class=\"string\">&#x27;Subnets[*].&#123;SubnetId: SubnetId,AvailabilityZone: AvailabilityZone,CidrBlock: CidrBlock&#125;&#x27;</span> \\</span><br><span class=\"line\">    --output table</span><br><span class=\"line\">----------------------------------------------------------------------</span><br><span class=\"line\">|                           DescribeSubnets                          |</span><br><span class=\"line\">+------------------+--------------------+----------------------------+</span><br><span class=\"line\">| AvailabilityZone |     CidrBlock      |         SubnetId           |</span><br><span class=\"line\">+------------------+--------------------+----------------------------+</span><br><span class=\"line\">|  us-west-2b      |  192.168.128.0/19  |  subnet-0e3290a40a483710d  |</span><br><span class=\"line\">|  us-west-2a      |  192.168.96.0/19   |  subnet-0f6ec8eb7dafcccc0  |</span><br><span class=\"line\">|  us-west-2b      |  192.168.32.0/19   |  subnet-035d3e96d37614fc4  |</span><br><span class=\"line\">|  us-west-2d      |  192.168.64.0/19   |  subnet-0ca60ec494d31c2cb  |</span><br><span class=\"line\">|  us-west-2a      |  192.168.0.0/19    |  subnet-04c4cbdbfdfd8d0d5  |</span><br><span class=\"line\">|  us-west-2d      |  192.168.160.0/19  |  subnet-026f4c6fd339f0dbd  |</span><br><span class=\"line\">+------------------+--------------------+----------------------------+</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 计算node节点的网络地址</span></span><br><span class=\"line\"><span class=\"comment\"># 如下为linux下使用ipcalc命令的方式</span></span><br><span class=\"line\">$ ipcalc -n 192.168.16.155/19</span><br><span class=\"line\">NETWORK=192.168.0.0</span><br><span class=\"line\">$ ipcalc -n 192.168.48.14/19</span><br><span class=\"line\">NETWORK=192.168.32.0</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># mac下使用ipcalc命令，安装 ： brew install ipcalc</span></span><br><span class=\"line\">$ ipcalc -b 192.168.16.155/19 | grep Network</span><br><span class=\"line\">Network:   192.168.0.0/19</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 192-168-16-155 节点的ip地址是属于 |  us-west-2a      |  192.168.0.0/19    |  subnet-04c4cbdbfdfd8d0d5  |</span></span><br><span class=\"line\"><span class=\"comment\"># 192-168-48-14  节点的ip地址是属于 |  us-west-2b      |  192.168.32.0/19   |  subnet-035d3e96d37614fc4  |</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>为节点所在的子网添加挂载目标</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 为每个 AZ 中有节点的子网运行一次挂载命令，注意替换相应的子网 ID，所以这里两个节点都要创建挂载目标</span></span><br><span class=\"line\">$ aws efs create-mount-target \\</span><br><span class=\"line\">    --profile eks-us-west-2 \\</span><br><span class=\"line\">    --file-system-id <span class=\"variable\">$file_system_id</span> \\</span><br><span class=\"line\">    --subnet-id subnet-04c4cbdbfdfd8d0d5 \\</span><br><span class=\"line\">    --security-groups <span class=\"variable\">$security_group_id</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;OwnerId&quot;</span>: <span class=\"string\">&quot;743263909644&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;MountTargetId&quot;</span>: <span class=\"string\">&quot;fsmt-0368ff60b5e4c39ed&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;FileSystemId&quot;</span>: <span class=\"string\">&quot;fs-09447193939058538&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;SubnetId&quot;</span>: <span class=\"string\">&quot;subnet-04c4cbdbfdfd8d0d5&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;LifeCycleState&quot;</span>: <span class=\"string\">&quot;creating&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;IpAddress&quot;</span>: <span class=\"string\">&quot;192.168.4.196&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;NetworkInterfaceId&quot;</span>: <span class=\"string\">&quot;eni-03068e2d0265fe8e8&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;AvailabilityZoneId&quot;</span>: <span class=\"string\">&quot;usw2-az1&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;AvailabilityZoneName&quot;</span>: <span class=\"string\">&quot;us-west-2a&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;VpcId&quot;</span>: <span class=\"string\">&quot;vpc-088a65d5af782c20a&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">$ aws efs create-mount-target \\</span><br><span class=\"line\">    --profile eks-us-west-2 \\</span><br><span class=\"line\">    --file-system-id <span class=\"variable\">$file_system_id</span> \\</span><br><span class=\"line\">    --subnet-id subnet-035d3e96d37614fc4 \\</span><br><span class=\"line\">    --security-groups <span class=\"variable\">$security_group_id</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;OwnerId&quot;</span>: <span class=\"string\">&quot;743263909644&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;MountTargetId&quot;</span>: <span class=\"string\">&quot;fsmt-0612899b2439161c7&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;FileSystemId&quot;</span>: <span class=\"string\">&quot;fs-09447193939058538&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;SubnetId&quot;</span>: <span class=\"string\">&quot;subnet-035d3e96d37614fc4&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;LifeCycleState&quot;</span>: <span class=\"string\">&quot;creating&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;IpAddress&quot;</span>: <span class=\"string\">&quot;192.168.62.58&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;NetworkInterfaceId&quot;</span>: <span class=\"string\">&quot;eni-051bfd62c82bc0b51&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;AvailabilityZoneId&quot;</span>: <span class=\"string\">&quot;usw2-az2&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;AvailabilityZoneName&quot;</span>: <span class=\"string\">&quot;us-west-2b&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;VpcId&quot;</span>: <span class=\"string\">&quot;vpc-088a65d5af782c20a&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 检索文件系统的装载目标列表</span></span><br><span class=\"line\">$ aws efs describe-mount-targets --file-system-id <span class=\"variable\">$file_system_id</span> --profile eks-us-west-2</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;MountTargets&quot;</span>: [</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;OwnerId&quot;</span>: <span class=\"string\">&quot;743263909644&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;MountTargetId&quot;</span>: <span class=\"string\">&quot;fsmt-0368ff60b5e4c39ed&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;FileSystemId&quot;</span>: <span class=\"string\">&quot;fs-09447193939058538&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;SubnetId&quot;</span>: <span class=\"string\">&quot;subnet-04c4cbdbfdfd8d0d5&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;LifeCycleState&quot;</span>: <span class=\"string\">&quot;available&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;IpAddress&quot;</span>: <span class=\"string\">&quot;192.168.4.196&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;NetworkInterfaceId&quot;</span>: <span class=\"string\">&quot;eni-03068e2d0265fe8e8&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;AvailabilityZoneId&quot;</span>: <span class=\"string\">&quot;usw2-az1&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;AvailabilityZoneName&quot;</span>: <span class=\"string\">&quot;us-west-2a&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;VpcId&quot;</span>: <span class=\"string\">&quot;vpc-088a65d5af782c20a&quot;</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;OwnerId&quot;</span>: <span class=\"string\">&quot;743263909644&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;MountTargetId&quot;</span>: <span class=\"string\">&quot;fsmt-0612899b2439161c7&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;FileSystemId&quot;</span>: <span class=\"string\">&quot;fs-09447193939058538&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;SubnetId&quot;</span>: <span class=\"string\">&quot;subnet-035d3e96d37614fc4&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;LifeCycleState&quot;</span>: <span class=\"string\">&quot;available&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;IpAddress&quot;</span>: <span class=\"string\">&quot;192.168.62.58&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;NetworkInterfaceId&quot;</span>: <span class=\"string\">&quot;eni-051bfd62c82bc0b51&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;AvailabilityZoneId&quot;</span>: <span class=\"string\">&quot;usw2-az2&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;AvailabilityZoneName&quot;</span>: <span class=\"string\">&quot;us-west-2b&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;VpcId&quot;</span>: <span class=\"string\">&quot;vpc-088a65d5af782c20a&quot;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    ]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"删除EFS\">删除EFS</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>在使用AWS CLI命令删除文件系统之前，必须先删除为文件系统创建的所有装载目标和接入点。</p>\n</li>\n<li class=\"lvl-2\">\n<p>删除现有的挂载目标</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 注意要替换 --mount-target-id fsmt-0368ff60b5e4c39ed，要删除几个挂载目标就执行几次命令</span></span><br><span class=\"line\">$ aws efs delete-mount-target \\</span><br><span class=\"line\">    --mount-target-id fsmt-0368ff60b5e4c39ed \\</span><br><span class=\"line\">    --profile eks-us-west-2</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>删除efs</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 控制台也可以删除</span></span><br><span class=\"line\">$ aws efs delete-file-system \\</span><br><span class=\"line\">    --file-system-id <span class=\"variable\">$file_system_id</span>  \\</span><br><span class=\"line\">    --profile eks-us-west-2</span><br></pre></td></tr></table></figure>\n<h2 id=\"测试\">测试</h2>\n<h3 id=\"Dynamic-demo\">Dynamic-demo</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>检索您的 Amazon EFS 文件系统 ID。您可以在 Amazon EFS 控制台中查找此信息，或者使用以下 AWS CLI 命令。</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 检索您的 Amazon EFS 文件系统 ID</span></span><br><span class=\"line\">$ aws efs describe-file-systems --profile eks-us-west-2 --query <span class=\"string\">&quot;FileSystems[*].FileSystemId&quot;</span> --output text</span><br><span class=\"line\">fs-09447193939058538</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>创建storageclass</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># storageclass.yaml，fileSystemId: fs-09447193939058538</span></span><br><span class=\"line\">kind: StorageClass</span><br><span class=\"line\">apiVersion: storage.k8s.io/v1</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: efs-sc</span><br><span class=\"line\">provisioner: efs.csi.aws.com <span class=\"comment\"># 指定用于动态卷分配的 CSI 驱动程序</span></span><br><span class=\"line\">parameters:</span><br><span class=\"line\">  provisioningMode: efs-ap <span class=\"comment\"># 指定 EFS 文件系统的挂载模式为 &quot;efs-ap&quot;。这表示 EFS 将以 AccessPoint 的形式挂载到 Kubernetes Pod 中</span></span><br><span class=\"line\">  fileSystemId: fs-09447193939058538 <span class=\"comment\"># 指定用于动态卷分配的 EFS 文件系统的 ID</span></span><br><span class=\"line\">  directoryPerms: <span class=\"string\">&quot;700&quot;</span> <span class=\"comment\"># 指定新创建的目录的权限模式。这里的 &quot;700&quot; 表示目录的权限为 rwx------。</span></span><br><span class=\"line\">  gidRangeStart: <span class=\"string\">&quot;1000&quot;</span> <span class=\"comment\"># 可选参数，指定新创建的目录的 GID 范围的起始值。</span></span><br><span class=\"line\">  gidRangeEnd: <span class=\"string\">&quot;2000&quot;</span> <span class=\"comment\"># 可选参数，指定新创建的目录的 GID 范围的结束值。</span></span><br><span class=\"line\">  basePath: <span class=\"string\">&quot;/dynamic_provisioning&quot;</span> <span class=\"comment\"># 可选参数，指定新创建的目录的基本路径。这里的 &quot;/dynamic_provisioning&quot; 是一个示例路径，你可以根据需要设置合适的基本路径。</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># provisioningMode 可以设置以下值：</span></span><br><span class=\"line\"><span class=\"comment\"># efs-ap: 使用 Access Point（访问点）模式挂载 EFS 文件系统。在此模式下，每个挂载点都会创建一个唯一的访问点，并授予 Pod 对该访问点的访问权限。每个访问点都可以独立设置权限和配额，从而实现更好的隔离和控制。</span></span><br><span class=\"line\"><span class=\"comment\"># efs-csi: 使用传统的 EFS CSI 挂载模式。在此模式下，使用文件系统 ID 直接挂载整个 EFS 文件系统，而不是使用访问点。这种模式下的挂载是共享的，所有使用该存储类的 Pod 都将共享相同的文件系统和权限。</span></span><br><span class=\"line\"><span class=\"comment\"># provisioningMode 的默认值是 efs-csi。</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 部署</span></span><br><span class=\"line\">$ k apply -f storageclass.yaml</span><br><span class=\"line\">storageclass.storage.k8s.io/efs-sc created</span><br><span class=\"line\"><span class=\"comment\"># 查看sc</span></span><br><span class=\"line\">$ k get sc</span><br><span class=\"line\">NAME            PROVISIONER             RECLAIMPOLICY   VOLUMEBINDINGMODE      ALLOWVOLUMEEXPANSION   AGE</span><br><span class=\"line\">efs-sc          efs.csi.aws.com         Delete          Immediate              <span class=\"literal\">false</span>                  7s</span><br><span class=\"line\">gp2 (default)   kubernetes.io/aws-ebs   Delete          WaitForFirstConsumer   <span class=\"literal\">false</span>                  5d3h</span><br><span class=\"line\">gp3             ebs.csi.aws.com         Delete          WaitForFirstConsumer   <span class=\"literal\">true</span>                   5d</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>创建pvc，指定 storageClassName: efs-sc</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># pvc.yaml</span></span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: PersistentVolumeClaim</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: efs-claim</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  accessModes:</span><br><span class=\"line\">    - ReadWriteMany</span><br><span class=\"line\">  storageClassName: efs-sc</span><br><span class=\"line\">  resources:</span><br><span class=\"line\">    requests:</span><br><span class=\"line\">      storage: 5Gi</span><br><span class=\"line\"><span class=\"comment\"># 部署pvc</span></span><br><span class=\"line\">$ k apply -f pvc.yaml</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>创建pod</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># pod.yaml</span></span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Pod</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: efs-app</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  containers:</span><br><span class=\"line\">    - name: app</span><br><span class=\"line\">      image: centos</span><br><span class=\"line\">      <span class=\"built_in\">command</span>: [<span class=\"string\">&quot;/bin/sh&quot;</span>]</span><br><span class=\"line\">      args: [<span class=\"string\">&quot;-c&quot;</span>, <span class=\"string\">&quot;while true; do echo <span class=\"subst\">$(date -u)</span> &gt;&gt; /data/out; sleep 5; done&quot;</span>]</span><br><span class=\"line\">      volumeMounts:</span><br><span class=\"line\">        - name: persistent-storage</span><br><span class=\"line\">          mountPath: /data</span><br><span class=\"line\">  volumes:</span><br><span class=\"line\">    - name: persistent-storage</span><br><span class=\"line\">      persistentVolumeClaim:</span><br><span class=\"line\">        claimName: efs-claim</span><br><span class=\"line\"><span class=\"comment\"># 部署pod</span></span><br><span class=\"line\">$ k apply -f pod.yaml</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>查看</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看pv</span></span><br><span class=\"line\">$ k get pv</span><br><span class=\"line\">NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                STORAGECLASS   REASON   AGE</span><br><span class=\"line\">pvc-edc00435-ef8e-49c6-9e3d-9697735e7108   5Gi        RWX            Delete           Bound    <span class=\"built_in\">test</span>/efs-claim       efs-sc                  62s</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看pvc</span></span><br><span class=\"line\">$ k get pvc</span><br><span class=\"line\">NAME            STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class=\"line\">efs-claim       Bound    pvc-edc00435-ef8e-49c6-9e3d-9697735e7108   5Gi        RWX            efs-sc         72s</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看pod</span></span><br><span class=\"line\">$ k get pods -o wide</span><br><span class=\"line\">NAME                  READY   STATUS    RESTARTS   AGE     IP               NODE                                           NOMINATED NODE   READINESS GATES</span><br><span class=\"line\">efs-app               1/1     Running   0          2m41s   192.168.34.220   ip-192-168-48-14.us-west-2.compute.internal    &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看输出</span></span><br><span class=\"line\">$ k <span class=\"built_in\">exec</span> -it efs-app -- bash -c <span class=\"string\">&quot;cat data/out&quot;</span></span><br><span class=\"line\">Mon Jul 3 09:39:49 UTC 2023</span><br><span class=\"line\">Mon Jul 3 09:39:54 UTC 2023</span><br><span class=\"line\">Mon Jul 3 09:39:59 UTC 2023</span><br><span class=\"line\">Mon Jul 3 09:40:04 UTC 2023</span><br><span class=\"line\">Mon Jul 3 09:40:09 UTC 2023</span><br><span class=\"line\">…………………………………………………………………………</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看挂载</span></span><br><span class=\"line\">$ k <span class=\"built_in\">exec</span> -it efs-app -- bash -c <span class=\"string\">&quot;df -h&quot;</span></span><br><span class=\"line\">Filesystem      Size  Used Avail Use% Mounted on</span><br><span class=\"line\">overlay          80G  4.2G   76G   6% /</span><br><span class=\"line\">tmpfs            64M     0   64M   0% /dev</span><br><span class=\"line\">tmpfs           3.8G     0  3.8G   0% /sys/fs/cgroup</span><br><span class=\"line\">127.0.0.1:/     8.0E     0  8.0E   0% /data</span><br><span class=\"line\">/dev/nvme0n1p1   80G  4.2G   76G   6% /etc/hosts</span><br><span class=\"line\">shm              64M     0   64M   0% /dev/shm</span><br><span class=\"line\">tmpfs           6.9G   12K  6.9G   1% /run/secrets/kubernetes.io/serviceaccount</span><br><span class=\"line\">tmpfs           3.8G     0  3.8G   0% /proc/acpi</span><br><span class=\"line\">tmpfs           3.8G     0  3.8G   0% /sys/firmware</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>此时只删除pod并重新创建pod，则之前的磁盘数据还在。如果删除pvc并重建pvc，则原先的数据就没有了。</p>\n</li>\n<li class=\"lvl-2\">\n<p>删除测试用例</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ k delete -f pod.yaml</span><br><span class=\"line\">$ k delete -f pvc.yaml</span><br><span class=\"line\">$ k delete -f storageclass.yaml</span><br></pre></td></tr></table></figure>\n<h3 id=\"Static-demo\">Static-demo</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 示例项目</span></span><br><span class=\"line\">$ git <span class=\"built_in\">clone</span> https://github.com/kubernetes-sigs/aws-efs-csi-driver.git</span><br><span class=\"line\"><span class=\"comment\"># 这个目录下有很多示例</span></span><br><span class=\"line\">$ <span class=\"built_in\">cd</span> aws-efs-csi-driver/examples/kubernetes/</span><br><span class=\"line\"><span class=\"comment\"># 比如这里以 multiple_pods 为例说明，两个pod挂载同一个efs</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># storageclass.yaml</span></span><br><span class=\"line\"><span class=\"comment\"># provisioningMode 的默认值是 efs-csi</span></span><br><span class=\"line\">kind: StorageClass</span><br><span class=\"line\">apiVersion: storage.k8s.io/v1</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: efs-sc</span><br><span class=\"line\">provisioner: efs.csi.aws.com</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># pv.yaml</span></span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: PersistentVolume</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: efs-pv</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  capacity:</span><br><span class=\"line\">    storage: 5Gi  <span class=\"comment\"># efs会忽略，efs是没有大小限制的，但是为了符合k8s创建pv的语法规则，这里随便写一个值</span></span><br><span class=\"line\">  volumeMode: Filesystem</span><br><span class=\"line\">  accessModes:</span><br><span class=\"line\">    - ReadWriteMany  <span class=\"comment\"># 支持多个pod同时读写</span></span><br><span class=\"line\">  persistentVolumeReclaimPolicy: Retain</span><br><span class=\"line\">  storageClassName: efs-sc</span><br><span class=\"line\">  csi:</span><br><span class=\"line\">    driver: efs.csi.aws.com</span><br><span class=\"line\">    volumeHandle: fs-09447193939058538</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># claim.yaml</span></span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: PersistentVolumeClaim</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: efs-claim</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  accessModes:</span><br><span class=\"line\">    - ReadWriteMany  <span class=\"comment\"># 支持多个pod同时读写</span></span><br><span class=\"line\">  storageClassName: efs-sc</span><br><span class=\"line\">  resources:</span><br><span class=\"line\">    requests:</span><br><span class=\"line\">      storage: 5Gi</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># pod1.yaml</span></span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Pod</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: app1</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  containers:</span><br><span class=\"line\">  - name: app1</span><br><span class=\"line\">    image: busybox</span><br><span class=\"line\">    <span class=\"built_in\">command</span>: [<span class=\"string\">&quot;/bin/sh&quot;</span>]</span><br><span class=\"line\">    args: [<span class=\"string\">&quot;-c&quot;</span>, <span class=\"string\">&quot;while true; do echo <span class=\"subst\">$(date -u)</span> &gt;&gt; /data/out1.txt; sleep 5; done&quot;</span>]</span><br><span class=\"line\">    volumeMounts:</span><br><span class=\"line\">    - name: persistent-storage</span><br><span class=\"line\">      mountPath: /data</span><br><span class=\"line\">  volumes:</span><br><span class=\"line\">  - name: persistent-storage</span><br><span class=\"line\">    persistentVolumeClaim:</span><br><span class=\"line\">      claimName: efs-claim</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># pod2.yaml</span></span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Pod</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: app2</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  containers:</span><br><span class=\"line\">  - name: app2</span><br><span class=\"line\">    image: busybox</span><br><span class=\"line\">    <span class=\"built_in\">command</span>: [<span class=\"string\">&quot;/bin/sh&quot;</span>]</span><br><span class=\"line\">    args: [<span class=\"string\">&quot;-c&quot;</span>, <span class=\"string\">&quot;while true; do echo <span class=\"subst\">$(date -u)</span> &gt;&gt; /data2/out2.txt; sleep 5; done&quot;</span>]</span><br><span class=\"line\">    volumeMounts:</span><br><span class=\"line\">    - name: persistent-storage</span><br><span class=\"line\">      mountPath: /data2</span><br><span class=\"line\">  volumes:</span><br><span class=\"line\">  - name: persistent-storage</span><br><span class=\"line\">    persistentVolumeClaim:</span><br><span class=\"line\">      claimName: efs-claim</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 编辑 specs/pv.yaml 文件并将 volumeHandle 值替换为您的 Amazon EFS 文件系统 ID</span></span><br><span class=\"line\">$ k apply -f specs/</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看pv</span></span><br><span class=\"line\">$ k get pv</span><br><span class=\"line\">NAME     CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM            STORAGECLASS   REASON   AGE</span><br><span class=\"line\">efs-pv   5Gi        RWX            Retain           Bound    <span class=\"built_in\">test</span>/efs-claim   efs-sc                  9m11s</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看pvc</span></span><br><span class=\"line\">$ k get pvc</span><br><span class=\"line\">NAME        STATUS   VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class=\"line\">efs-claim   Bound    efs-pv   5Gi        RWX            efs-sc         9m16s~</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看pod</span></span><br><span class=\"line\">$ k get pod</span><br><span class=\"line\">NAME   READY   STATUS    RESTARTS   AGE</span><br><span class=\"line\">app1   1/1     Running   0          9m20s</span><br><span class=\"line\">app2   1/1     Running   0          9m19s</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 两个pod挂载的是同一个efs，所以两个pod内部会看到对方的文件</span></span><br><span class=\"line\">$ k <span class=\"built_in\">exec</span> -it app1 -- <span class=\"built_in\">ls</span> /data</span><br><span class=\"line\">dynamic_provisioning  out1.txt              out2.txt</span><br><span class=\"line\"></span><br><span class=\"line\">$ k <span class=\"built_in\">exec</span> -it app2 -- <span class=\"built_in\">ls</span> /data2</span><br><span class=\"line\">dynamic_provisioning  out1.txt              out2.txt</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 清除测试内容</span></span><br><span class=\"line\">$ k delete -f specs/</span><br></pre></td></tr></table></figure>\n","content_text":"摘要 本文介绍为EKS集群安装 Amazon EFS CSI 驱动程序 参考资料： Amazon EKS用户指南 Kubernetes 文档 EFS和EBS的选择？ 如果是同一个Pod内的多个容器之间的存储共享，您可以考虑使用EBS卷。 如果是不同的Pod之间的存储共享，此时由于可能跨可用区，您可以考虑使用EFS文件系统。 安装 Amazon EFS CSI 驱动程序 创建 IAM policy和角色 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253# 从 GitHub 下载 IAM policy 文档$ curl -O https://raw.githubusercontent.com/kubernetes-sigs/aws-efs-csi-driver/master/docs/iam-policy-example.json# 创建策略$ aws iam create-policy --profile eks-us-west-2 \\ --policy-name AmazonEKS_EFS_CSI_Driver_Policy \\ --policy-document file://iam-policy-example.json&#123; &quot;Policy&quot;: &#123; &quot;PolicyName&quot;: &quot;AmazonEKS_EFS_CSI_Driver_Policy&quot;, &quot;PolicyId&quot;: &quot;ANPA22DP3G4GHPABMGFXG&quot;, &quot;Arn&quot;: &quot;arn:aws:iam::743263909655:policy/AmazonEKS_EFS_CSI_Driver_Policy&quot;, &quot;Path&quot;: &quot;/&quot;, &quot;DefaultVersionId&quot;: &quot;v1&quot;, &quot;AttachmentCount&quot;: 0, &quot;PermissionsBoundaryUsageCount&quot;: 0, &quot;IsAttachable&quot;: true, &quot;CreateDate&quot;: &quot;2023-07-03T07:35:31+00:00&quot;, &quot;UpdateDate&quot;: &quot;2023-07-03T07:35:31+00:00&quot; &#125;&#125;# 创建 IAM 角色并向其附加此 IAM policy# 注意这里并没有指定角色名称，所以会自动生成一个角色名称并绑定到SA上$ eksctl create iamserviceaccount \\ --cluster eks-lexing \\ --profile eks-us-west-2 \\ --namespace kube-system \\ --name efs-csi-controller-sa \\ --attach-policy-arn arn:aws:iam::743263909655:policy/AmazonEKS_EFS_CSI_Driver_Policy \\ --approve2023-07-03 15:38:07 [ℹ] 2 existing iamserviceaccount(s) (kube-system/aws-node,kube-system/ebs-csi-controller-sa) will be excluded2023-07-03 15:38:07 [ℹ] 1 iamserviceaccount (kube-system/efs-csi-controller-sa) was included (based on the include/exclude rules)2023-07-03 15:38:07 [!] serviceaccounts that exist in Kubernetes will be excluded, use --override-existing-serviceaccounts to override2023-07-03 15:38:07 [ℹ] 1 task: &#123; 2 sequential sub-tasks: &#123; create IAM role for serviceaccount &quot;kube-system/efs-csi-controller-sa&quot;, create serviceaccount &quot;kube-system/efs-csi-controller-sa&quot;, &#125; &#125;2023-07-03 15:38:07 [ℹ] building iamserviceaccount stack &quot;eksctl-eks-lexing-addon-iamserviceaccount-kube-system-efs-csi-controller-sa&quot;2023-07-03 15:38:08 [ℹ] deploying stack &quot;eksctl-eks-lexing-addon-iamserviceaccount-kube-system-efs-csi-controller-sa&quot;2023-07-03 15:38:08 [ℹ] waiting for CloudFormation stack &quot;eksctl-eks-lexing-addon-iamserviceaccount-kube-system-efs-csi-controller-sa&quot;2023-07-03 15:38:39 [ℹ] waiting for CloudFormation stack &quot;eksctl-eks-lexing-addon-iamserviceaccount-kube-system-efs-csi-controller-sa&quot;2023-07-03 15:38:40 [ℹ] created serviceaccount &quot;kube-system/efs-csi-controller-sa&quot;# 查看创建后的SA，这里可以看到自动创建的角色名称$ k describe sa efs-csi-controller-saName: efs-csi-controller-saNamespace: kube-systemLabels: app.kubernetes.io/managed-by=eksctlAnnotations: eks.amazonaws.com/role-arn: arn:aws:iam::743263909644:role/eksctl-eks-lexing-addon-iamserviceaccount-ku-Role1-BOQ7WRWAQDOYImage pull secrets: &lt;none&gt;Mountable secrets: &lt;none&gt;Tokens: &lt;none&gt;Events: &lt;none&gt; 安装 Amazon EFS 驱动程序 12345678910111213141516171819202122232425262728293031323334# 添加 Helm 存储库。$ helm repo add aws-efs-csi-driver https://kubernetes-sigs.github.io/aws-efs-csi-driver/# 更新存储库$ helm repo update aws-efs-csi-driver# 使用 Helm Chart 安装驱动程序的版本。# 请将存储库地址替换为集群的容器镜像地址:https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/add-ons-images.html$ helm upgrade -i aws-efs-csi-driver aws-efs-csi-driver/aws-efs-csi-driver \\ --namespace kube-system \\ --set image.repository=602401143452.dkr.ecr.us-west-2.amazonaws.com/eks/aws-efs-csi-driver \\ --set controller.serviceAccount.create=false \\ --set controller.serviceAccount.name=efs-csi-controller-saRelease &quot;aws-efs-csi-driver&quot; has been upgraded. Happy Helming!NAME: aws-efs-csi-driverLAST DEPLOYED: Mon Jul 3 16:08:38 2023NAMESPACE: kube-systemSTATUS: deployedREVISION: 1TEST SUITE: NoneNOTES:To verify that aws-efs-csi-driver has started, run: kubectl get pod -n kube-system -l &quot;app.kubernetes.io/name=aws-efs-csi-driver,app.kubernetes.io/instance=aws-efs-csi-driver&quot;# 查看pod启动情况$ kubectl get pod -n kube-system -l &quot;app.kubernetes.io/name=aws-efs-csi-driver,app.kubernetes.io/instance=aws-efs-csi-driver&quot;NAME READY STATUS RESTARTS AGEefs-csi-controller-5c86cf4947-77dxh 3/3 Running 0 23sefs-csi-controller-5c86cf4947-w6s6m 3/3 Running 0 23sefs-csi-node-22mbf 3/3 Running 0 7m41sefs-csi-node-swc6t 3/3 Running 0 7m40s# 如果pod启动失败，可能是镜像下载的问题，可以先删除deploy后重新执行 helm upgrade ...$ k delete deploy -n kube-system efs-csi-controller 创建 Amazon EFS 文件系统 创建安全组 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950# 检索您的集群所在的 VPC ID，并将其存储在变量中，以便在后续步骤中使用。$ vpc_id=$(aws eks describe-cluster \\ --name eks-lexing \\ --profile eks-us-west-2 \\ --query &quot;cluster.resourcesVpcConfig.vpcId&quot; \\ --output text)$ echo $vpc_idvpc-088a65d5af782c20a# 检索您的集群的 VPC 的 CIDR 范围，并将其存储在变量中，以便在后续步骤中使用$ cidr_range=$(aws ec2 describe-vpcs \\ --vpc-ids $vpc_id \\ --profile eks-us-west-2 \\ --query &quot;Vpcs[].CidrBlock&quot; \\ --output text)$ echo $cidr_range192.168.0.0/16# 创建一个安全组，该安全组包含一条允许您的 Amazon EFS 挂载点的入站 NFS 流量的入站规则$ security_group_id=$(aws ec2 create-security-group \\ --group-name MyEfsSecurityGroup \\ --description &quot;My EFS security group&quot; \\ --vpc-id $vpc_id \\ --profile eks-us-west-2 \\ --output text)$ echo $security_group_idsg-0d77e111b519834be# 创建一条入站规则，该入站规则允许来自您的集群 VPC 的 CIDR 的入站 NFS 流量。$ aws ec2 authorize-security-group-ingress \\ --profile eks-us-west-2 \\ --group-id $security_group_id \\ --protocol tcp \\ --port 2049 \\ --cidr $cidr_range&#123; &quot;Return&quot;: true, &quot;SecurityGroupRules&quot;: [ &#123; &quot;SecurityGroupRuleId&quot;: &quot;sgr-09e1d9d2ec6d9bbe9&quot;, &quot;GroupId&quot;: &quot;sg-0d77e111b519834be&quot;, &quot;GroupOwnerId&quot;: &quot;743263909644&quot;, &quot;IsEgress&quot;: false, &quot;IpProtocol&quot;: &quot;tcp&quot;, &quot;FromPort&quot;: 2049, &quot;ToPort&quot;: 2049, &quot;CidrIpv4&quot;: &quot;192.168.0.0/16&quot; &#125; ]&#125; 创建EFS 12345678# 创建文件系统$ file_system_id=$(aws efs create-file-system \\ --profile eks-us-west-2 \\ --performance-mode generalPurpose \\ --query &#x27;FileSystemId&#x27; \\ --output text)$ echo $file_system_idfs-09447193939058538 EFS挂载目标和安全组（网络配置） 确定集群中节点所在的子网的 ID 以及子网所在的可用区 123456789101112131415161718192021222324252627282930313233343536373839# 创建挂载目标# 确定您的集群节点的 IP 地址$ kubectl get nodesNAME STATUS ROLES AGE VERSIONip-192-168-16-155.us-west-2.compute.internal Ready &lt;none&gt; 3d20h v1.26.4-eks-0a21954ip-192-168-48-14.us-west-2.compute.internal Ready &lt;none&gt; 3d21h v1.26.4-eks-0a21954# 确定 VPC 中子网的 ID 以及子网所在的可用区$ aws ec2 describe-subnets \\ --profile eks-us-west-2 \\ --filters &quot;Name=vpc-id,Values=$vpc_id&quot; \\ --query &#x27;Subnets[*].&#123;SubnetId: SubnetId,AvailabilityZone: AvailabilityZone,CidrBlock: CidrBlock&#125;&#x27; \\ --output table----------------------------------------------------------------------| DescribeSubnets |+------------------+--------------------+----------------------------+| AvailabilityZone | CidrBlock | SubnetId |+------------------+--------------------+----------------------------+| us-west-2b | 192.168.128.0/19 | subnet-0e3290a40a483710d || us-west-2a | 192.168.96.0/19 | subnet-0f6ec8eb7dafcccc0 || us-west-2b | 192.168.32.0/19 | subnet-035d3e96d37614fc4 || us-west-2d | 192.168.64.0/19 | subnet-0ca60ec494d31c2cb || us-west-2a | 192.168.0.0/19 | subnet-04c4cbdbfdfd8d0d5 || us-west-2d | 192.168.160.0/19 | subnet-026f4c6fd339f0dbd |+------------------+--------------------+----------------------------+# 计算node节点的网络地址# 如下为linux下使用ipcalc命令的方式$ ipcalc -n 192.168.16.155/19NETWORK=192.168.0.0$ ipcalc -n 192.168.48.14/19NETWORK=192.168.32.0# mac下使用ipcalc命令，安装 ： brew install ipcalc$ ipcalc -b 192.168.16.155/19 | grep NetworkNetwork: 192.168.0.0/19# 192-168-16-155 节点的ip地址是属于 | us-west-2a | 192.168.0.0/19 | subnet-04c4cbdbfdfd8d0d5 |# 192-168-48-14 节点的ip地址是属于 | us-west-2b | 192.168.32.0/19 | subnet-035d3e96d37614fc4 | 为节点所在的子网添加挂载目标 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667# 为每个 AZ 中有节点的子网运行一次挂载命令，注意替换相应的子网 ID，所以这里两个节点都要创建挂载目标$ aws efs create-mount-target \\ --profile eks-us-west-2 \\ --file-system-id $file_system_id \\ --subnet-id subnet-04c4cbdbfdfd8d0d5 \\ --security-groups $security_group_id&#123; &quot;OwnerId&quot;: &quot;743263909644&quot;, &quot;MountTargetId&quot;: &quot;fsmt-0368ff60b5e4c39ed&quot;, &quot;FileSystemId&quot;: &quot;fs-09447193939058538&quot;, &quot;SubnetId&quot;: &quot;subnet-04c4cbdbfdfd8d0d5&quot;, &quot;LifeCycleState&quot;: &quot;creating&quot;, &quot;IpAddress&quot;: &quot;192.168.4.196&quot;, &quot;NetworkInterfaceId&quot;: &quot;eni-03068e2d0265fe8e8&quot;, &quot;AvailabilityZoneId&quot;: &quot;usw2-az1&quot;, &quot;AvailabilityZoneName&quot;: &quot;us-west-2a&quot;, &quot;VpcId&quot;: &quot;vpc-088a65d5af782c20a&quot;&#125;$ aws efs create-mount-target \\ --profile eks-us-west-2 \\ --file-system-id $file_system_id \\ --subnet-id subnet-035d3e96d37614fc4 \\ --security-groups $security_group_id&#123; &quot;OwnerId&quot;: &quot;743263909644&quot;, &quot;MountTargetId&quot;: &quot;fsmt-0612899b2439161c7&quot;, &quot;FileSystemId&quot;: &quot;fs-09447193939058538&quot;, &quot;SubnetId&quot;: &quot;subnet-035d3e96d37614fc4&quot;, &quot;LifeCycleState&quot;: &quot;creating&quot;, &quot;IpAddress&quot;: &quot;192.168.62.58&quot;, &quot;NetworkInterfaceId&quot;: &quot;eni-051bfd62c82bc0b51&quot;, &quot;AvailabilityZoneId&quot;: &quot;usw2-az2&quot;, &quot;AvailabilityZoneName&quot;: &quot;us-west-2b&quot;, &quot;VpcId&quot;: &quot;vpc-088a65d5af782c20a&quot;&#125;# 检索文件系统的装载目标列表$ aws efs describe-mount-targets --file-system-id $file_system_id --profile eks-us-west-2&#123; &quot;MountTargets&quot;: [ &#123; &quot;OwnerId&quot;: &quot;743263909644&quot;, &quot;MountTargetId&quot;: &quot;fsmt-0368ff60b5e4c39ed&quot;, &quot;FileSystemId&quot;: &quot;fs-09447193939058538&quot;, &quot;SubnetId&quot;: &quot;subnet-04c4cbdbfdfd8d0d5&quot;, &quot;LifeCycleState&quot;: &quot;available&quot;, &quot;IpAddress&quot;: &quot;192.168.4.196&quot;, &quot;NetworkInterfaceId&quot;: &quot;eni-03068e2d0265fe8e8&quot;, &quot;AvailabilityZoneId&quot;: &quot;usw2-az1&quot;, &quot;AvailabilityZoneName&quot;: &quot;us-west-2a&quot;, &quot;VpcId&quot;: &quot;vpc-088a65d5af782c20a&quot; &#125;, &#123; &quot;OwnerId&quot;: &quot;743263909644&quot;, &quot;MountTargetId&quot;: &quot;fsmt-0612899b2439161c7&quot;, &quot;FileSystemId&quot;: &quot;fs-09447193939058538&quot;, &quot;SubnetId&quot;: &quot;subnet-035d3e96d37614fc4&quot;, &quot;LifeCycleState&quot;: &quot;available&quot;, &quot;IpAddress&quot;: &quot;192.168.62.58&quot;, &quot;NetworkInterfaceId&quot;: &quot;eni-051bfd62c82bc0b51&quot;, &quot;AvailabilityZoneId&quot;: &quot;usw2-az2&quot;, &quot;AvailabilityZoneName&quot;: &quot;us-west-2b&quot;, &quot;VpcId&quot;: &quot;vpc-088a65d5af782c20a&quot; &#125; ]&#125; 删除EFS 在使用AWS CLI命令删除文件系统之前，必须先删除为文件系统创建的所有装载目标和接入点。 删除现有的挂载目标 1234# 注意要替换 --mount-target-id fsmt-0368ff60b5e4c39ed，要删除几个挂载目标就执行几次命令$ aws efs delete-mount-target \\ --mount-target-id fsmt-0368ff60b5e4c39ed \\ --profile eks-us-west-2 删除efs 1234# 控制台也可以删除$ aws efs delete-file-system \\ --file-system-id $file_system_id \\ --profile eks-us-west-2 测试 Dynamic-demo 检索您的 Amazon EFS 文件系统 ID。您可以在 Amazon EFS 控制台中查找此信息，或者使用以下 AWS CLI 命令。 123# 检索您的 Amazon EFS 文件系统 ID$ aws efs describe-file-systems --profile eks-us-west-2 --query &quot;FileSystems[*].FileSystemId&quot; --output textfs-09447193939058538 创建storageclass 12345678910111213141516171819202122232425262728# storageclass.yaml，fileSystemId: fs-09447193939058538kind: StorageClassapiVersion: storage.k8s.io/v1metadata: name: efs-scprovisioner: efs.csi.aws.com # 指定用于动态卷分配的 CSI 驱动程序parameters: provisioningMode: efs-ap # 指定 EFS 文件系统的挂载模式为 &quot;efs-ap&quot;。这表示 EFS 将以 AccessPoint 的形式挂载到 Kubernetes Pod 中 fileSystemId: fs-09447193939058538 # 指定用于动态卷分配的 EFS 文件系统的 ID directoryPerms: &quot;700&quot; # 指定新创建的目录的权限模式。这里的 &quot;700&quot; 表示目录的权限为 rwx------。 gidRangeStart: &quot;1000&quot; # 可选参数，指定新创建的目录的 GID 范围的起始值。 gidRangeEnd: &quot;2000&quot; # 可选参数，指定新创建的目录的 GID 范围的结束值。 basePath: &quot;/dynamic_provisioning&quot; # 可选参数，指定新创建的目录的基本路径。这里的 &quot;/dynamic_provisioning&quot; 是一个示例路径，你可以根据需要设置合适的基本路径。# provisioningMode 可以设置以下值：# efs-ap: 使用 Access Point（访问点）模式挂载 EFS 文件系统。在此模式下，每个挂载点都会创建一个唯一的访问点，并授予 Pod 对该访问点的访问权限。每个访问点都可以独立设置权限和配额，从而实现更好的隔离和控制。# efs-csi: 使用传统的 EFS CSI 挂载模式。在此模式下，使用文件系统 ID 直接挂载整个 EFS 文件系统，而不是使用访问点。这种模式下的挂载是共享的，所有使用该存储类的 Pod 都将共享相同的文件系统和权限。# provisioningMode 的默认值是 efs-csi。# 部署$ k apply -f storageclass.yamlstorageclass.storage.k8s.io/efs-sc created# 查看sc$ k get scNAME PROVISIONER RECLAIMPOLICY VOLUMEBINDINGMODE ALLOWVOLUMEEXPANSION AGEefs-sc efs.csi.aws.com Delete Immediate false 7sgp2 (default) kubernetes.io/aws-ebs Delete WaitForFirstConsumer false 5d3hgp3 ebs.csi.aws.com Delete WaitForFirstConsumer true 5d 创建pvc，指定 storageClassName: efs-sc 1234567891011121314# pvc.yamlapiVersion: v1kind: PersistentVolumeClaimmetadata: name: efs-claimspec: accessModes: - ReadWriteMany storageClassName: efs-sc resources: requests: storage: 5Gi# 部署pvc$ k apply -f pvc.yaml 创建pod 1234567891011121314151617181920# pod.yamlapiVersion: v1kind: Podmetadata: name: efs-appspec: containers: - name: app image: centos command: [&quot;/bin/sh&quot;] args: [&quot;-c&quot;, &quot;while true; do echo $(date -u) &gt;&gt; /data/out; sleep 5; done&quot;] volumeMounts: - name: persistent-storage mountPath: /data volumes: - name: persistent-storage persistentVolumeClaim: claimName: efs-claim# 部署pod$ k apply -f pod.yaml 查看 123456789101112131415161718192021222324252627282930313233343536# 查看pv$ k get pvNAME CAPACITY ACCESS MODES RECLAIM POLICY STATUS CLAIM STORAGECLASS REASON AGEpvc-edc00435-ef8e-49c6-9e3d-9697735e7108 5Gi RWX Delete Bound test/efs-claim efs-sc 62s# 查看pvc$ k get pvcNAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGEefs-claim Bound pvc-edc00435-ef8e-49c6-9e3d-9697735e7108 5Gi RWX efs-sc 72s# 查看pod$ k get pods -o wideNAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATESefs-app 1/1 Running 0 2m41s 192.168.34.220 ip-192-168-48-14.us-west-2.compute.internal &lt;none&gt; &lt;none&gt;# 查看输出$ k exec -it efs-app -- bash -c &quot;cat data/out&quot;Mon Jul 3 09:39:49 UTC 2023Mon Jul 3 09:39:54 UTC 2023Mon Jul 3 09:39:59 UTC 2023Mon Jul 3 09:40:04 UTC 2023Mon Jul 3 09:40:09 UTC 2023…………………………………………………………………………# 查看挂载$ k exec -it efs-app -- bash -c &quot;df -h&quot;Filesystem Size Used Avail Use% Mounted onoverlay 80G 4.2G 76G 6% /tmpfs 64M 0 64M 0% /devtmpfs 3.8G 0 3.8G 0% /sys/fs/cgroup127.0.0.1:/ 8.0E 0 8.0E 0% /data/dev/nvme0n1p1 80G 4.2G 76G 6% /etc/hostsshm 64M 0 64M 0% /dev/shmtmpfs 6.9G 12K 6.9G 1% /run/secrets/kubernetes.io/serviceaccounttmpfs 3.8G 0 3.8G 0% /proc/acpitmpfs 3.8G 0 3.8G 0% /sys/firmware 此时只删除pod并重新创建pod，则之前的磁盘数据还在。如果删除pvc并重建pvc，则原先的数据就没有了。 删除测试用例 123$ k delete -f pod.yaml$ k delete -f pvc.yaml$ k delete -f storageclass.yaml Static-demo 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111# 示例项目$ git clone https://github.com/kubernetes-sigs/aws-efs-csi-driver.git# 这个目录下有很多示例$ cd aws-efs-csi-driver/examples/kubernetes/# 比如这里以 multiple_pods 为例说明，两个pod挂载同一个efs# storageclass.yaml# provisioningMode 的默认值是 efs-csikind: StorageClassapiVersion: storage.k8s.io/v1metadata: name: efs-scprovisioner: efs.csi.aws.com# pv.yamlapiVersion: v1kind: PersistentVolumemetadata: name: efs-pvspec: capacity: storage: 5Gi # efs会忽略，efs是没有大小限制的，但是为了符合k8s创建pv的语法规则，这里随便写一个值 volumeMode: Filesystem accessModes: - ReadWriteMany # 支持多个pod同时读写 persistentVolumeReclaimPolicy: Retain storageClassName: efs-sc csi: driver: efs.csi.aws.com volumeHandle: fs-09447193939058538# claim.yamlapiVersion: v1kind: PersistentVolumeClaimmetadata: name: efs-claimspec: accessModes: - ReadWriteMany # 支持多个pod同时读写 storageClassName: efs-sc resources: requests: storage: 5Gi# pod1.yamlapiVersion: v1kind: Podmetadata: name: app1spec: containers: - name: app1 image: busybox command: [&quot;/bin/sh&quot;] args: [&quot;-c&quot;, &quot;while true; do echo $(date -u) &gt;&gt; /data/out1.txt; sleep 5; done&quot;] volumeMounts: - name: persistent-storage mountPath: /data volumes: - name: persistent-storage persistentVolumeClaim: claimName: efs-claim# pod2.yamlapiVersion: v1kind: Podmetadata: name: app2spec: containers: - name: app2 image: busybox command: [&quot;/bin/sh&quot;] args: [&quot;-c&quot;, &quot;while true; do echo $(date -u) &gt;&gt; /data2/out2.txt; sleep 5; done&quot;] volumeMounts: - name: persistent-storage mountPath: /data2 volumes: - name: persistent-storage persistentVolumeClaim: claimName: efs-claim# 编辑 specs/pv.yaml 文件并将 volumeHandle 值替换为您的 Amazon EFS 文件系统 ID$ k apply -f specs/# 查看pv$ k get pvNAME CAPACITY ACCESS MODES RECLAIM POLICY STATUS CLAIM STORAGECLASS REASON AGEefs-pv 5Gi RWX Retain Bound test/efs-claim efs-sc 9m11s# 查看pvc$ k get pvcNAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGEefs-claim Bound efs-pv 5Gi RWX efs-sc 9m16s~# 查看pod$ k get podNAME READY STATUS RESTARTS AGEapp1 1/1 Running 0 9m20sapp2 1/1 Running 0 9m19s# 两个pod挂载的是同一个efs，所以两个pod内部会看到对方的文件$ k exec -it app1 -- ls /datadynamic_provisioning out1.txt out2.txt$ k exec -it app2 -- ls /data2dynamic_provisioning out1.txt out2.txt# 清除测试内容$ k delete -f specs/","summary":"摘要 本文介绍为EKS集群安装 Amazon EFS CSI 驱动程序 参考资料： Amazon EKS用户指南 Kubernetes 文档","date_published":"2023-07-07T14:31:05.000Z","tags":["技术","aws","eks","java"]},{"id":"https://blog.hanqunfeng.com/2023/07/07/aws-eks05-ebs-csi/","url":"https://blog.hanqunfeng.com/2023/07/07/aws-eks05-ebs-csi/","title":"AWS-EKS-05--安装 Amazon EBS CSI 驱动程序","content_html":"<!--\n **加粗**\n *斜体*\n ***加粗并斜体***\n ~~删除线~~\n ==突出显示==\n `突出显示(推荐)`\n ++下划线++\n ~下标~\n ^上标^\n 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.\n 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600)\n\n +++ **点击折叠**\n 这是被隐藏的内容\n +++\n\n::: tips success warning danger\n这里是容器内的内容\n:::\n\n% note info % success warning danger\n这里是容器内的内容\n% endnote %\n\n -->\n<h2 id=\"摘要\">摘要</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>本文介绍在EKS集群中安装 Amazon EBS CSI 驱动程序过程</p>\n</li>\n<li class=\"lvl-2\">\n<p>参考资料：</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\"><a href=\"https://docs.aws.amazon.com/zh_cn/eks/latest/userguide\">Amazon EKS用户指南</a></li>\n<li class=\"lvl-6\"><a href=\"https://kubernetes.io/zh-cn/docs/home/\">Kubernetes 文档</a></li>\n</ul>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"安装-Amazon-EBS-CSI-驱动程序\">安装 Amazon EBS CSI 驱动程序</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>如果您计划将工作负载部署到使用 Amazon EBS 卷的集群，并且您创建了 1.23 或更高版本的集群，则在部署工作负载之前，您必须将 Amazon EBS CSI 驱动程序 安装到您的集群。</p>\n</li>\n<li class=\"lvl-2\">\n<p>使用 eksctl 创建 Amazon EBS CSI 驱动程序 IAM 角色</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 使用以下命令创建 IAM 角色并附加所需的 AWS 托管策略。此命令将部署 AWS CloudFormation 堆栈，该堆栈将创建 IAM 角色，并会将 IAM policy 附加到该堆栈。如果您的集群位于 AWS GovCloud（美国东部）或 AWS GovCloud（美国西部）AWS 区域，则将 arn:aws: 替换为 arn:aws-us-gov:。</span></span><br><span class=\"line\"><span class=\"comment\"># 注意这里附加的策略是AWS托管策略</span></span><br><span class=\"line\">$ eksctl create iamserviceaccount \\</span><br><span class=\"line\">    --name ebs-csi-controller-sa \\</span><br><span class=\"line\">    --namespace kube-system \\</span><br><span class=\"line\">    --cluster eks-lexing \\</span><br><span class=\"line\">    --profile eks-us-west-2 \\</span><br><span class=\"line\">    --role-name AmazonEKS_EBS_CSI_DriverRole \\</span><br><span class=\"line\">    --role-only \\</span><br><span class=\"line\">    --attach-policy-arn arn:aws:iam::aws:policy/service-role/AmazonEBSCSIDriverPolicy \\</span><br><span class=\"line\">    --approve</span><br><span class=\"line\">2023-06-28 16:16:05 [ℹ]  1 iamserviceaccount (kube-system/ebs-csi-controller-sa) was included (based on the include/exclude rules)</span><br><span class=\"line\">2023-06-28 16:16:05 [!]  serviceaccounts <span class=\"keyword\">in</span> Kubernetes will not be created or modified, since the option --role-only is used</span><br><span class=\"line\">2023-06-28 16:16:05 [ℹ]  1 task: &#123; create IAM role <span class=\"keyword\">for</span> serviceaccount <span class=\"string\">&quot;kube-system/ebs-csi-controller-sa&quot;</span> &#125;</span><br><span class=\"line\">2023-06-28 16:16:05 [ℹ]  building iamserviceaccount stack <span class=\"string\">&quot;eksctl-eks-lexing-addon-iamserviceaccount-kube-system-ebs-csi-controller-sa&quot;</span></span><br><span class=\"line\">2023-06-28 16:16:06 [ℹ]  deploying stack <span class=\"string\">&quot;eksctl-eks-lexing-addon-iamserviceaccount-kube-system-ebs-csi-controller-sa&quot;</span></span><br><span class=\"line\">2023-06-28 16:16:06 [ℹ]  waiting <span class=\"keyword\">for</span> CloudFormation stack <span class=\"string\">&quot;eksctl-eks-lexing-addon-iamserviceaccount-kube-system-ebs-csi-controller-sa&quot;</span></span><br><span class=\"line\">2023-06-28 16:16:37 [ℹ]  waiting <span class=\"keyword\">for</span> CloudFormation stack <span class=\"string\">&quot;eksctl-eks-lexing-addon-iamserviceaccount-kube-system-ebs-csi-controller-sa&quot;</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>将Amazon EBS CSI 驱动程序添加到集群</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 运行以下命令。如果您的集群位于 AWS GovCloud（美国东部）或 AWS GovCloud（美国西部）AWS 区域，则将 arn:aws: 替换为 arn:aws-us-gov:。</span></span><br><span class=\"line\">$ eksctl create addon --name aws-ebs-csi-driver --cluster eks-lexing --profile eks-us-west-2 --service-account-role-arn arn:aws:iam::743263909655:role/AmazonEKS_EBS_CSI_DriverRole --force</span><br><span class=\"line\">2023-06-28 16:23:59 [ℹ]  Kubernetes version <span class=\"string\">&quot;1.25&quot;</span> <span class=\"keyword\">in</span> use by cluster <span class=\"string\">&quot;eks-lexing&quot;</span></span><br><span class=\"line\">2023-06-28 16:24:00 [ℹ]  using provided ServiceAccountRoleARN <span class=\"string\">&quot;arn:aws:iam::743263909655:role/AmazonEKS_EBS_CSI_DriverRole&quot;</span></span><br><span class=\"line\">2023-06-28 16:24:00 [ℹ]  creating addon</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>检查 Amazon EBS CSI 驱动程序的当前版本，注意这里如果有可用更新，UPDATE AVAILABLE会显示，默认安装是最新版本</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ eksctl get addon --name aws-ebs-csi-driver --cluster eks-lexing --profile eks-us-west-2</span><br><span class=\"line\">2023-06-28 16:24:08 [ℹ]  Kubernetes version <span class=\"string\">&quot;1.25&quot;</span> <span class=\"keyword\">in</span> use by cluster <span class=\"string\">&quot;eks-lexing&quot;</span></span><br><span class=\"line\">2023-06-28 16:24:09 [ℹ]  to see issues <span class=\"keyword\">for</span> an addon run `eksctl get addon --name &lt;addon-name&gt; --cluster &lt;cluster-name&gt;`</span><br><span class=\"line\">NAME            VERSION            STATUS        ISSUES    IAMROLE            UPDATE AVAILABLE    CONFIGURATION VALUES</span><br><span class=\"line\">aws-ebs-csi-driver    v1.19.0-eksbuild.2    CREATING    0    arn:aws:iam::743263909655:role/AmazonEKS_EBS_CSI_DriverRole</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>插件安装完成后可以查看已经安装的资源，Name中含有 ebs-csi</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">~ k get all -n kube-system -l app.kubernetes.io/component=csi-driver</span><br><span class=\"line\">NAME                                      READY   STATUS    RESTARTS   AGE</span><br><span class=\"line\">pod/ebs-csi-controller-5f945bbdfc-m2smb   6/6     Running   0          10m</span><br><span class=\"line\">pod/ebs-csi-controller-5f945bbdfc-nfl97   6/6     Running   0          10m</span><br><span class=\"line\">pod/ebs-csi-node-kmtv9                    3/3     Running   0          10m</span><br><span class=\"line\">pod/ebs-csi-node-tdw7m                    3/3     Running   0          10m</span><br><span class=\"line\"></span><br><span class=\"line\">NAME                                  DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR              AGE</span><br><span class=\"line\">daemonset.apps/ebs-csi-node           2         2         2       2            2           kubernetes.io/os=linux     42h</span><br><span class=\"line\">daemonset.apps/ebs-csi-node-windows   0         0         0       0            0           kubernetes.io/os=windows   42h</span><br><span class=\"line\"></span><br><span class=\"line\">NAME                                 READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class=\"line\">deployment.apps/ebs-csi-controller   2/2     2            2           42h</span><br><span class=\"line\"></span><br><span class=\"line\">NAME                                            DESIRED   CURRENT   READY   AGE</span><br><span class=\"line\">replicaset.apps/ebs-csi-controller-57ff9dc5fc   0         0         0       42h</span><br><span class=\"line\">replicaset.apps/ebs-csi-controller-5f945bbdfc   2         2         2       10m</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>此时可以通过aws控制台对eks的Amazon EBS CSI 驱动程序进行管理，后续升级可以直接在控制台进行<br>\n<img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/hTiCSv.png\" alt=\"\" width=\"1200\" height=\"600\"></p>\n</li>\n<li class=\"lvl-2\">\n<p>查看Amazon EBS CSI 驱动程序的所有可用版本号</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ aws eks describe-addon-versions --addon-name aws-ebs-csi-driver --profile eks-us-west-2</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>更新 Amazon EBS CSI 驱动程序 ，–force 表示强制更新</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看是否有更新，可以看到UPDATE下有个可用更新版本 v1.20.0-eksbuild.1</span></span><br><span class=\"line\">$ eksctl get addon --name aws-ebs-csi-driver --cluster eks-lexing --profile eks-us-west-2</span><br><span class=\"line\">2023-06-30 10:21:31 [ℹ]  Kubernetes version <span class=\"string\">&quot;1.26&quot;</span> <span class=\"keyword\">in</span> use by cluster <span class=\"string\">&quot;eks-lexing&quot;</span></span><br><span class=\"line\">2023-06-30 10:21:32 [ℹ]  to see issues <span class=\"keyword\">for</span> an addon run `eksctl get addon --name &lt;addon-name&gt; --cluster &lt;cluster-name&gt;`</span><br><span class=\"line\">NAME            VERSION            STATUS    ISSUES    IAMROLE                                UPDATE AVAILABLE    CONFIGURATION VALUES</span><br><span class=\"line\">aws-ebs-csi-driver    v1.19.0-eksbuild.2    ACTIVE    0    arn:aws:iam::743263909644:role/AmazonEKS_EBS_CSI_DriverRole    v1.20.0-eksbuild.1</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 更新到v1.20.0-eksbuild.1</span></span><br><span class=\"line\">$ eksctl update addon --name aws-ebs-csi-driver --version v1.20.0-eksbuild.1 --cluster eks-lexing --profile eks-us-west-2 --force</span><br><span class=\"line\">2023-06-30 10:22:23 [ℹ]  Kubernetes version <span class=\"string\">&quot;1.26&quot;</span> <span class=\"keyword\">in</span> use by cluster <span class=\"string\">&quot;eks-lexing&quot;</span></span><br><span class=\"line\">2023-06-30 10:22:24 [ℹ]  new version provided v1.20.0-eksbuild.1</span><br><span class=\"line\">2023-06-30 10:22:24 [ℹ]  updating addon</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>删除 Amazon EBS CSI 驱动程序</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ eksctl delete addon --cluster eks-lexing --profile eks-us-west-2 --name aws-ebs-csi-driver --preserve</span><br></pre></td></tr></table></figure>\n<div class=\"tips\">\n<p><em><strong>默认eks为我们创建好了一个sc:gp2</strong></em></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 默认的gp2配置yaml,其被设置为默认存储类</span></span><br><span class=\"line\">kind: StorageClass</span><br><span class=\"line\">apiVersion: storage.k8s.io/v1</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: gp2</span><br><span class=\"line\">  annotations:</span><br><span class=\"line\">    storageclass.kubernetes.io/is-default-class: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">provisioner: kubernetes.io/aws-ebs</span><br><span class=\"line\">parameters:</span><br><span class=\"line\">  <span class=\"built_in\">type</span>: gp2</span><br><span class=\"line\">  fsType: ext4</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># storageclass.kubernetes.io/is-default-class: &quot;true&quot; 这个注释表示其是默认存储类</span></span><br></pre></td></tr></table></figure>\n<p><em><strong>关于默认存储类的说明</strong></em></p>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">在 AWS 的 Amazon EKS（Elastic Kubernetes Service）中，将一个 StorageClass（SC）设置为默认存储类具有以下作用：\n<ul class=\"lvl-3\">\n<li class=\"lvl-6\">自动分配: 当没有显式指定 StorageClass 的情况下，如果某个 Persistent Volume Claim（PVC）没有指定所需的 StorageClass，则默认会选择设置为默认存储类的 StorageClass 进行 PVC 的动态分配。</li>\n<li class=\"lvl-6\">简化配置: 默认存储类可以简化 PVC 的配置，因为您不需要为每个 PVC 显式指定 StorageClass。只需创建 PVC，并且它将自动使用默认存储类进行分配。</li>\n<li class=\"lvl-6\">默认设置: 默认存储类是集群级别的默认设置，适用于没有显式指定 StorageClass 的 PVC。这样可以确保在没有特定要求的情况下，PVC 可以使用预定义的默认存储类。</li>\n<li class=\"lvl-6\">在 AWS EKS 中，只能有一个 StorageClass 被设置为默认存储类。这是因为默认存储类是集群范围的全局设置，它用于满足未显式指定 StorageClass 的 PVC 的需求。如果有多个 StorageClass 被设置为默认，会导致混乱和不确定性，因为 Kubernetes 将无法确定使用哪个默认存储类。</li>\n<li class=\"lvl-6\">如果需要为不同的 PVC 使用不同的默认存储类，可以通过为每个 PVC 显式指定所需的 StorageClass 来实现，而不是依赖默认存储类。</li>\n<li class=\"lvl-6\">总结来说，通过设置默认存储类，您可以简化 PVC 的配置并定义集群范围的默认设置。但是，在 AWS EKS 中，只能有一个默认存储类。</li>\n</ul>\n</li>\n</ul>\n</div>\n<h2 id=\"使用说明\">使用说明</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>创建StorageClass</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 创建基于gp3的sc</span></span><br><span class=\"line\"><span class=\"comment\"># create-sc-gp3.yaml</span></span><br><span class=\"line\">apiVersion: storage.k8s.io/v1</span><br><span class=\"line\">kind: StorageClass</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: gp3</span><br><span class=\"line\">provisioner: ebs.csi.aws.com</span><br><span class=\"line\">volumeBindingMode: WaitForFirstConsumer</span><br><span class=\"line\">parameters:</span><br><span class=\"line\">  <span class=\"built_in\">type</span>: gp3</span><br><span class=\"line\">allowVolumeExpansion: <span class=\"literal\">true</span></span><br><span class=\"line\">reclaimPolicy: Delete</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 部署</span></span><br><span class=\"line\">$ k apply -f create-sc-gp3.yaml</span><br><span class=\"line\"><span class=\"comment\"># 查看sc</span></span><br><span class=\"line\">$ k get sc</span><br><span class=\"line\">NAME            PROVISIONER             RECLAIMPOLICY   VOLUMEBINDINGMODE      ALLOWVOLUMEEXPANSION   AGE</span><br><span class=\"line\">gp2 (default)   kubernetes.io/aws-ebs   Delete          WaitForFirstConsumer   <span class=\"literal\">false</span>                  175m</span><br><span class=\"line\">gp3             ebs.csi.aws.com         Delete          WaitForFirstConsumer   <span class=\"literal\">true</span>                   6s</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 虽然创建sc时没有为其指定默认存储类，我们可以通过如下命令将指定的sc设置为默认存储类</span></span><br><span class=\"line\">$ k annotate storageclass gp3 storageclass.kubernetes.io/is-default-class=<span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"comment\"># 此时原gp2的默认存储类不会被去掉</span></span><br><span class=\"line\">$ k get sc</span><br><span class=\"line\">NAME            PROVISIONER             RECLAIMPOLICY   VOLUMEBINDINGMODE      ALLOWVOLUMEEXPANSION   AGE</span><br><span class=\"line\">gp2 (default)   kubernetes.io/aws-ebs   Delete          WaitForFirstConsumer   <span class=\"literal\">false</span>                  20h</span><br><span class=\"line\">gp3 (default)   ebs.csi.aws.com         Delete          WaitForFirstConsumer   <span class=\"literal\">true</span>                   17h</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 取消指定的sc为默认存储类</span></span><br><span class=\"line\">$ k annotate storageclass --overwrite=<span class=\"literal\">true</span> gp3 storageclass.kubernetes.io/is-default-class=<span class=\"literal\">false</span></span><br></pre></td></tr></table></figure>\n<div class=\"tips\">\n<p><em><strong>配置说明</strong></em></p>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">provisioner</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># provisioner 定义了用于动态分配 PV 的存储插件或存储后端。它指定了负责创建和管理 PV 的控制器。</span><br><span class=\"line\"># provisioner 的值通常是存储提供商或存储插件的名称，例如</span><br><span class=\"line\"># kubernetes.io/aws-ebs（用于 Amazon EBS）、</span><br><span class=\"line\"># kubernetes.io/gce-pd（用于 Google Compute Engine PD）等。</span><br><span class=\"line\"># 不同的存储插件或存储后端可能具有不同的特性和配置选项。</span><br><span class=\"line\"># 这里的ebs.csi.aws.com就是我们安装的Amazon EBS CSI 附加组件。</span><br><span class=\"line\"></span><br><span class=\"line\"># 在 AWS 的 Amazon EKS（Elastic Kubernetes Service）中，创建 StorageClass（SC）时，支持以下一些常见的 provisioner（供应商）选项：</span><br><span class=\"line\"># kubernetes.io/aws-ebs: 这是用于 Amazon EBS（Elastic Block Store）的默认 provisioner。它允许在 EKS 集群上动态分配和管理基于 Amazon EBS 的持久卷（PV）。</span><br><span class=\"line\"># kubernetes.io/aws-s3: 这是用于 Amazon S3（Simple Storage Service）的 provisioner。它允许在 EKS 集群中创建和管理基于 Amazon S3 的持久卷。</span><br><span class=\"line\"># kubernetes.io/azure-disk: 这是用于 Azure Disk 的 provisioner。它允许在 EKS 集群上动态分配和管理基于 Azure Disk 的持久卷。</span><br><span class=\"line\"># kubernetes.io/azure-file: 这是用于 Azure File 的 provisioner。它允许在 EKS 集群中创建和管理基于 Azure File 的持久卷。</span><br><span class=\"line\"># 这些是一些常见的 provisioner，但实际上，您还可以使用其他存储插件或自定义 provisioner，以满足您特定的存储需求。不同的存储插件和供应商可能会支持不同的 provisioner，具体取决于您所使用的存储插件和存储后端。</span><br><span class=\"line\"># 在创建 StorageClass 时，您需要指定适当的 provisioner 标识符，以便 Kubernetes 和 EKS 能够根据指定的 provisioner 来分配和管理持久卷。</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">allowVolumeExpansion</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># allowVolumeExpansion 是一个布尔值参数，用于指定是否允许 PVC 的大小在运行时进行扩展。</span><br><span class=\"line\"># 如果将其设置为 true，则表示 PVC 可以动态扩展其大小以满足需求。</span><br><span class=\"line\"># 如果将其设置为 false，则 PVC 的大小将在创建时被固定，并且不能在后续进行扩展。</span><br><span class=\"line\"># 这取决于存储后端是否支持 PVC 大小的动态调整。</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">\n<p>volumeBindingMode</p>\n</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 在创建 StorageClass 时，可以指定 volumeBindingMode 来定义持久卷（Persistent Volume，PV）与 Persistent Volume Claim（PVC）之间的绑定行为。volumeBindingMode 可以具有以下几种选项：</span><br><span class=\"line\"># Immediate: 当使用 Immediate 绑定模式时，Kubernetes 立即绑定 PVC 和 PV。这意味着在创建 PVC 时，Kubernetes 将立即选择并绑定一个可用的 PV。这种模式适用于那些支持动态供应的存储后端。</span><br><span class=\"line\"># WaitForFirstConsumer: 使用 WaitForFirstConsumer 绑定模式时，PV 不会立即绑定到 PVC。PV 只有在第一个 Pod 试图使用 PVC 时才会绑定。这种模式适用于那些需要在 Pod 实际使用 PVC 之前进行一些准备工作的存储后端。例如，如果需要在创建 PV 后手动配置外部存储系统。</span><br><span class=\"line\"># Delayed: Delayed 绑定模式类似于 WaitForFirstConsumer，但不支持多个 Pod 使用同一个 PVC。只有当 Pod 被调度到节点并使用 PVC 时，PV 才会绑定。这种模式适用于那些只支持单个 Pod 使用 PVC 的存储后端。与 WaitForFirstConsumer 模式相比，Delayed 模式对 PV 和 PVC 之间的绑定更加延迟。</span><br><span class=\"line\"># Unknown: 如果未指定 volumeBindingMode，则默认为 Unknown。这意味着 Kubernetes 控制器或存储系统将决定如何绑定 PV 和 PVC。这种情况下，存储系统或云提供商的默认行为将适用。</span><br><span class=\"line\"></span><br><span class=\"line\">Amazon EBS CSI 只支持 Immediate 和 WaitForFirstConsumer，默认是Immediate。</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">\n<p>reclaimPolicy</p>\n</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 在 Kubernetes 中，reclaimPolicy 是指定持久卷（Persistent Volume，PV）的回收策略。reclaimPolicy 可以具有以下几种选项：</span><br><span class=\"line\"># Retain: 使用 Retain 回收策略时，PV 的数据将被保留，而不会被自动删除。当 PV 和其对应的 Persistent Volume Claim（PVC）之间的关系解除时，PV 不会被回收或删除。管理员需要手动处理 PV 的回收或重新使用。</span><br><span class=\"line\"># Delete: Delete 回收策略表示在 PV 和 PVC 之间的关系解除时，PV 将被自动删除和回收。PV 中存储的数据将被清除，且无法恢复。这是最常见的回收策略，适用于临时数据或不需要长期保留的情况。</span><br><span class=\"line\"># Recycle: Recycle 回收策略是 Kubernetes 早期版本中使用的一种策略，但在 Kubernetes v1.7 版本之后已被弃用。该策略在解除 PV 和 PVC 之间的关系后，会尝试清除 PV 中的数据，使其可以被其他 PVC 重新使用。但这个清除过程仅限于删除 PV 上的文件，而不会对 PV 进行格式化或重建。</span><br><span class=\"line\"># External: External 回收策略表示在 PV 和 PVC 之间的关系解除时，PV 的回收和删除操作由外部的存储管理系统或管理员处理。Kubernetes 不会主动回收或删除 PV，而是委托给外部系统进行处理。</span><br><span class=\"line\"></span><br><span class=\"line\">Amazon EBS CSI 只支持 Retain 和 Delete，默认是Delete。</span><br></pre></td></tr></table></figure>\n</div>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>创建PVC</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">create-pvc.yaml</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: PersistentVolumeClaim</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: ebs-gp3-claim</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  accessModes:</span><br><span class=\"line\">    - ReadWriteOnce</span><br><span class=\"line\">  storageClassName: gp3</span><br><span class=\"line\">  resources:</span><br><span class=\"line\">    requests:</span><br><span class=\"line\">      storage: 4Gi</span><br><span class=\"line\"></span><br><span class=\"line\">$ k apply -f create-pvc.yaml</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># pvc指定的sc中的volumeBindingMode是WaitForFirstConsumer，只有被使用到时才会去真正申请资源，所以此时看到的状态一直都会是Pending</span></span><br><span class=\"line\">$ k get pvc</span><br><span class=\"line\">NAME            STATUS    VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class=\"line\">ebs-gp3-claim   Pending                                      gp3            2m51s</span><br></pre></td></tr></table></figure>\n<div class=\"tips\">\n<p><em><strong>配置说明</strong></em></p>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">accessModes</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 在 Kubernetes 中，PVC 是用于声明性地请求持久化存储资源的对象。它定义了 Pod 对持久卷（Persistent Volume，PV）的访问要求。PVC 可以指定不同的 accessModes，以确定 Pod 如何访问与之绑定的 PV。以下是 PVC 可能的 accessModes：</span><br><span class=\"line\"># ReadWriteOnce (RWO): 此模式表示 PVC 可以被一个单个 Pod 以读写的方式挂载。这意味着 PVC 只能被一个 Pod 使用，而且可以同时读取和写入数据。这是许多常见应用程序的默认模式，例如关系型数据库。</span><br><span class=\"line\"># ReadOnlyMany (ROX): 此模式表示 PVC 可以被多个 Pod 以只读的方式挂载。这意味着多个 Pod 可以同时读取数据，但不能写入。通常用于需要共享只读数据的场景，例如日志收集或静态内容的共享。</span><br><span class=\"line\"># ReadWriteMany (RWX): 此模式表示 PVC 可以被多个 Pod 以读写的方式挂载。这意味着多个 Pod 可以同时读取和写入数据。然而，不是所有的存储插件都支持此模式，因此需要确保所使用的存储后端能够满足该要求。这是最具挑战性的模式，因为需要提供多个 Pod 之间的数据同步和一致性。</span><br><span class=\"line\"></span><br><span class=\"line\">需要注意的是，Amazon EBS CSI 目前只支持 ReadWriteOnce 访问模式，即每个卷只能被单个 Pod 以读写方式挂载。ReadOnlyMany 和 ReadWriteMany 访问模式在 Amazon EBS CSI 中尚未支持。</span><br><span class=\"line\"></span><br><span class=\"line\">如果您需要多个 Pod 可以同时以只读方式访问卷，您可以考虑使用 Amazon EFS（Elastic File System），它提供了 ReadWriteMany 访问模式，以满足多个 Pod 的同时只读访问需求。</span><br></pre></td></tr></table></figure>\n</div>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>申请ebs资源</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 可以创建一个pod绑定这个pvc就可以看到资源被申请了</span></span><br><span class=\"line\"><span class=\"comment\"># create-pod.yaml</span></span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Pod</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: app</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  containers:</span><br><span class=\"line\">  - name: app</span><br><span class=\"line\">    image: centos</span><br><span class=\"line\">    <span class=\"built_in\">command</span>: [<span class=\"string\">&quot;/bin/sh&quot;</span>]</span><br><span class=\"line\">    args: [<span class=\"string\">&quot;-c&quot;</span>, <span class=\"string\">&quot;while true; do echo <span class=\"subst\">$(date -u)</span> &gt;&gt; /data/out.txt; sleep 5; done&quot;</span>]</span><br><span class=\"line\">    volumeMounts:</span><br><span class=\"line\">    - name: persistent-storage</span><br><span class=\"line\">      mountPath: /data</span><br><span class=\"line\">  volumes:</span><br><span class=\"line\">  - name: persistent-storage</span><br><span class=\"line\">    persistentVolumeClaim:</span><br><span class=\"line\">      claimName: ebs-gp3-claim</span><br><span class=\"line\"></span><br><span class=\"line\">$ k apply -f create-pod.yaml</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看pv和pvc</span></span><br><span class=\"line\">$  k get pv</span><br><span class=\"line\">NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                STORAGECLASS   REASON   AGE</span><br><span class=\"line\">pvc-02700260-b5e0-40bf-8c72-c1afad9e103e   4Gi        RWO            Delete           Bound    <span class=\"built_in\">test</span>/ebs-gp3-claim   gp3                     4m34s</span><br><span class=\"line\">$ k get pvc</span><br><span class=\"line\">NAME            STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class=\"line\">ebs-gp3-claim   Bound    pvc-02700260-b5e0-40bf-8c72-c1afad9e103e   4Gi        RWO            gp3            9m27s</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># VolumeHandle:      vol-0362860fb03d9d618 就是实际的EBS卷ID</span></span><br><span class=\"line\">$ k describe pv pvc-02700260-b5e0-40bf-8c72-c1afad9e103e</span><br><span class=\"line\">Name:              pvc-02700260-b5e0-40bf-8c72-c1afad9e103e</span><br><span class=\"line\">Labels:            &lt;none&gt;</span><br><span class=\"line\">Annotations:       pv.kubernetes.io/provisioned-by: ebs.csi.aws.com</span><br><span class=\"line\">                   volume.kubernetes.io/provisioner-deletion-secret-name:</span><br><span class=\"line\">                   volume.kubernetes.io/provisioner-deletion-secret-namespace:</span><br><span class=\"line\">Finalizers:        [kubernetes.io/pv-protection external-attacher/ebs-csi-aws-com]</span><br><span class=\"line\">StorageClass:      gp3</span><br><span class=\"line\">Status:            Bound</span><br><span class=\"line\">Claim:             <span class=\"built_in\">test</span>/ebs-gp3-claim</span><br><span class=\"line\">Reclaim Policy:    Delete</span><br><span class=\"line\">Access Modes:      RWO</span><br><span class=\"line\">VolumeMode:        Filesystem</span><br><span class=\"line\">Capacity:          4Gi</span><br><span class=\"line\">Node Affinity:</span><br><span class=\"line\">  Required Terms:</span><br><span class=\"line\">    Term 0:        topology.ebs.csi.aws.com/zone <span class=\"keyword\">in</span> [us-west-2b]</span><br><span class=\"line\">Message:</span><br><span class=\"line\">Source:</span><br><span class=\"line\">    Type:              CSI (a Container Storage Interface (CSI) volume <span class=\"built_in\">source</span>)</span><br><span class=\"line\">    Driver:            ebs.csi.aws.com</span><br><span class=\"line\">    FSType:            ext4</span><br><span class=\"line\">    VolumeHandle:      vol-0362860fb03d9d618</span><br><span class=\"line\">    ReadOnly:          <span class=\"literal\">false</span></span><br><span class=\"line\">    VolumeAttributes:      storage.kubernetes.io/csiProvisionerIdentity=1687940646992-1017-ebs.csi.aws.com</span><br><span class=\"line\">Events:                &lt;none&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Used By 中展示的就是当前正在使用pvc的pod</span></span><br><span class=\"line\">$ k describe pvc ebs-gp3-claim</span><br><span class=\"line\">Name:          ebs-gp3-claim</span><br><span class=\"line\">Namespace:     <span class=\"built_in\">test</span></span><br><span class=\"line\">StorageClass:  gp3</span><br><span class=\"line\">Status:        Bound</span><br><span class=\"line\">Volume:        pvc-02700260-b5e0-40bf-8c72-c1afad9e103e</span><br><span class=\"line\">Labels:        &lt;none&gt;</span><br><span class=\"line\">Annotations:   pv.kubernetes.io/bind-completed: <span class=\"built_in\">yes</span></span><br><span class=\"line\">               pv.kubernetes.io/bound-by-controller: <span class=\"built_in\">yes</span></span><br><span class=\"line\">               volume.beta.kubernetes.io/storage-provisioner: ebs.csi.aws.com</span><br><span class=\"line\">               volume.kubernetes.io/selected-node: ip-192-168-48-14.us-west-2.compute.internal</span><br><span class=\"line\">               volume.kubernetes.io/storage-provisioner: ebs.csi.aws.com</span><br><span class=\"line\">Finalizers:    [kubernetes.io/pvc-protection]</span><br><span class=\"line\">Capacity:      4Gi</span><br><span class=\"line\">Access Modes:  RWO</span><br><span class=\"line\">VolumeMode:    Filesystem</span><br><span class=\"line\">Used By:       app-56df75755d-2phz4</span><br><span class=\"line\">               app-56df75755d-cvjvc</span><br><span class=\"line\">               app-56df75755d-xx9gh</span><br><span class=\"line\">Events:        &lt;none&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 此时如果删除pod，则其对应的pvc并不会被删除，之前申请到的ebs也不会被清除</span></span><br><span class=\"line\">$ k delete -f create-pod.yaml</span><br><span class=\"line\">$ k get pod</span><br><span class=\"line\">No resources found <span class=\"keyword\">in</span> <span class=\"built_in\">test</span> namespace.</span><br><span class=\"line\"></span><br><span class=\"line\">$ k get pv</span><br><span class=\"line\">NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                STORAGECLASS   REASON   AGE</span><br><span class=\"line\">pvc-02700260-b5e0-40bf-8c72-c1afad9e103e   4Gi        RWO            Delete           Bound    <span class=\"built_in\">test</span>/ebs-gp3-claim   gp3                     9m47s</span><br><span class=\"line\">$ k get pvc</span><br><span class=\"line\">NAME            STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class=\"line\">ebs-gp3-claim   Bound    pvc-02700260-b5e0-40bf-8c72-c1afad9e103e   4Gi        RWO            gp3            14m</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 此时如果重新创建pod并关联该pvc，则磁盘依旧有效，并且是不会被清空的</span></span><br><span class=\"line\">$ k apply -f create-pod.yaml</span><br><span class=\"line\"><span class=\"comment\"># 查看pod的输出，可以看到中间有个超过5秒的间隔，这就是pod被删除然后又重建的间隔时间，说明磁盘没有被清空重建</span></span><br><span class=\"line\">$ k <span class=\"built_in\">exec</span> -it app -- <span class=\"built_in\">tail</span> -f /data/out.txt</span><br><span class=\"line\">Thu Jun 29 01:51:31 UTC 2023</span><br><span class=\"line\">Thu Jun 29 01:51:36 UTC 2023</span><br><span class=\"line\">Thu Jun 29 01:51:41 UTC 2023</span><br><span class=\"line\">Thu Jun 29 01:53:25 UTC 2023</span><br><span class=\"line\">Thu Jun 29 01:53:30 UTC 2023</span><br><span class=\"line\">Thu Jun 29 01:53:35 UTC 2023</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 如果要彻底删除磁盘，需要删除pvc，sc中的reclaimPolicy是Delete才会被删除</span></span><br><span class=\"line\">$ k delete -f create-pvc.yaml</span><br><span class=\"line\">persistentvolumeclaim <span class=\"string\">&quot;ebs-gp3-claim&quot;</span> deleted</span><br><span class=\"line\">$ k get pvc</span><br><span class=\"line\">No resources found <span class=\"keyword\">in</span> <span class=\"built_in\">test</span> namespace.</span><br><span class=\"line\">$ k get pv</span><br><span class=\"line\">No resources found</span><br></pre></td></tr></table></figure>\n<h2 id=\"一个deployment并挂载ebs的示例\">一个deployment并挂载ebs的示例</h2>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># deployment-volume.yaml</span></span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: PersistentVolumeClaim</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: ebs-gp3-claim</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  accessModes:</span><br><span class=\"line\">    - ReadWriteOnce</span><br><span class=\"line\">  storageClassName: gp3</span><br><span class=\"line\">  resources:</span><br><span class=\"line\">    requests:</span><br><span class=\"line\">      storage: 4Gi</span><br><span class=\"line\"></span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: apps/v1</span><br><span class=\"line\">kind: Deployment</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: app</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  replicas: 3</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      app: app</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">     labels:</span><br><span class=\"line\">        app: app</span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      containers:</span><br><span class=\"line\">      - name: app</span><br><span class=\"line\">        image: centos</span><br><span class=\"line\">        <span class=\"built_in\">command</span>: [<span class=\"string\">&quot;/bin/sh&quot;</span>]</span><br><span class=\"line\">        args: [<span class=\"string\">&quot;-c&quot;</span>, <span class=\"string\">&quot;while true; do echo <span class=\"subst\">$(date -u)</span> &gt;&gt; /data/out.txt; sleep 5; done&quot;</span>]</span><br><span class=\"line\">        volumeMounts:</span><br><span class=\"line\">        - name: persistent-storage</span><br><span class=\"line\">          mountPath: /data</span><br><span class=\"line\">      volumes:</span><br><span class=\"line\">      - name: persistent-storage</span><br><span class=\"line\">        persistentVolumeClaim:</span><br><span class=\"line\">          claimName: ebs-gp3-claim</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 部署</span></span><br><span class=\"line\">~ k deploy -f deployment-volume.yaml</span><br><span class=\"line\"><span class=\"comment\"># 查看deploy</span></span><br><span class=\"line\">~ k get deploy</span><br><span class=\"line\">NAME   READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class=\"line\">app    3/3     3            3           85s</span><br><span class=\"line\"></span><br><span class=\"line\">~ k get pod</span><br><span class=\"line\">NAME                  READY   STATUS              RESTARTS   AGE</span><br><span class=\"line\">app-699cf8fdd-fk8vs   0/1     Running             0          90s</span><br><span class=\"line\">app-699cf8fdd-gpk7m   0/1     Running             0          90s</span><br><span class=\"line\">app-699cf8fdd-h5mbr   0/1     Running             0          90s</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 可以看到3个pod在同时写入一个文件</span></span><br><span class=\"line\">~ k <span class=\"built_in\">exec</span> -it app-699cf8fdd-fk8vs -- <span class=\"built_in\">head</span> /data/out.txt</span><br><span class=\"line\">Fri Jul 7 09:55:21 UTC 2023</span><br><span class=\"line\">Fri Jul 7 09:55:21 UTC 2023</span><br><span class=\"line\">Fri Jul 7 09:55:21 UTC 2023</span><br><span class=\"line\">Fri Jul 7 09:55:26 UTC 2023</span><br><span class=\"line\">Fri Jul 7 09:55:26 UTC 2023</span><br><span class=\"line\">Fri Jul 7 09:55:26 UTC 2023</span><br><span class=\"line\">Fri Jul 7 09:55:31 UTC 2023</span><br><span class=\"line\">Fri Jul 7 09:55:31 UTC 2023</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 重启deploy</span></span><br><span class=\"line\">~ k rollout restart deployment app</span><br><span class=\"line\">deployment.apps/app restarted</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 可以看到重新启动了3个pod，并且终止了原先启动的3个pod</span></span><br><span class=\"line\">~ k get pod</span><br><span class=\"line\">NAME                   READY   STATUS        RESTARTS   AGE</span><br><span class=\"line\">app-667968b659-62dpl   1/1     Running       0          6s</span><br><span class=\"line\">app-667968b659-7x6wj   1/1     Running       0          4s</span><br><span class=\"line\">app-667968b659-n2rvz   1/1     Running       0          2s</span><br><span class=\"line\">app-699cf8fdd-fk8vs    1/1     Terminating   0          287s</span><br><span class=\"line\">app-699cf8fdd-gpk7m    1/1     Terminating   0          287s</span><br><span class=\"line\">app-699cf8fdd-h5mbr    1/1     Terminating   0          287s</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 可以看到重启deploy后，文件内容依旧存在</span></span><br><span class=\"line\">~ k <span class=\"built_in\">exec</span> -it app-667968b659-62dpl -- <span class=\"built_in\">head</span> /data/out.txt</span><br><span class=\"line\">Fri Jul 7 09:55:21 UTC 2023</span><br><span class=\"line\">Fri Jul 7 09:55:21 UTC 2023</span><br><span class=\"line\">Fri Jul 7 09:55:21 UTC 2023</span><br><span class=\"line\">Fri Jul 7 09:55:26 UTC 2023</span><br><span class=\"line\">Fri Jul 7 09:55:26 UTC 2023</span><br><span class=\"line\">Fri Jul 7 09:55:26 UTC 2023</span><br><span class=\"line\">Fri Jul 7 09:55:31 UTC 2023</span><br><span class=\"line\">Fri Jul 7 09:55:31 UTC 2023</span><br></pre></td></tr></table></figure>\n<h3 id=\"讨论\">讨论</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>这里注意一下，k8s-1.23版本创建时会成功，但是重启不成功，只会重新启动成功一个pod，另外两个pod会失败，提示pvc已经被一个pod关联了，但是1.25版就可以创建和重启时都可以成功，不确定是否和Amazon EBS CSI 版本有关系。</p>\n</li>\n</ul>\n<h2 id=\"后记\">后记</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>这里要注意一个问题，如果pv被pvc绑定，此时是无法删除pv的，同理pvc被其它资源关联，也是不能被删除的，需要先删除对应的资源才可以。</p>\n</li>\n<li class=\"lvl-2\">\n<p>EBS不能跨可用区，如果pod部署在不同的可用区，则不能使用ebs作为存储，此时可以使用EFS。</p>\n</li>\n</ul>\n","content_text":"摘要 本文介绍在EKS集群中安装 Amazon EBS CSI 驱动程序过程 参考资料： Amazon EKS用户指南 Kubernetes 文档 安装 Amazon EBS CSI 驱动程序 如果您计划将工作负载部署到使用 Amazon EBS 卷的集群，并且您创建了 1.23 或更高版本的集群，则在部署工作负载之前，您必须将 Amazon EBS CSI 驱动程序 安装到您的集群。 使用 eksctl 创建 Amazon EBS CSI 驱动程序 IAM 角色 123456789101112131415161718# 使用以下命令创建 IAM 角色并附加所需的 AWS 托管策略。此命令将部署 AWS CloudFormation 堆栈，该堆栈将创建 IAM 角色，并会将 IAM policy 附加到该堆栈。如果您的集群位于 AWS GovCloud（美国东部）或 AWS GovCloud（美国西部）AWS 区域，则将 arn:aws: 替换为 arn:aws-us-gov:。# 注意这里附加的策略是AWS托管策略$ eksctl create iamserviceaccount \\ --name ebs-csi-controller-sa \\ --namespace kube-system \\ --cluster eks-lexing \\ --profile eks-us-west-2 \\ --role-name AmazonEKS_EBS_CSI_DriverRole \\ --role-only \\ --attach-policy-arn arn:aws:iam::aws:policy/service-role/AmazonEBSCSIDriverPolicy \\ --approve2023-06-28 16:16:05 [ℹ] 1 iamserviceaccount (kube-system/ebs-csi-controller-sa) was included (based on the include/exclude rules)2023-06-28 16:16:05 [!] serviceaccounts in Kubernetes will not be created or modified, since the option --role-only is used2023-06-28 16:16:05 [ℹ] 1 task: &#123; create IAM role for serviceaccount &quot;kube-system/ebs-csi-controller-sa&quot; &#125;2023-06-28 16:16:05 [ℹ] building iamserviceaccount stack &quot;eksctl-eks-lexing-addon-iamserviceaccount-kube-system-ebs-csi-controller-sa&quot;2023-06-28 16:16:06 [ℹ] deploying stack &quot;eksctl-eks-lexing-addon-iamserviceaccount-kube-system-ebs-csi-controller-sa&quot;2023-06-28 16:16:06 [ℹ] waiting for CloudFormation stack &quot;eksctl-eks-lexing-addon-iamserviceaccount-kube-system-ebs-csi-controller-sa&quot;2023-06-28 16:16:37 [ℹ] waiting for CloudFormation stack &quot;eksctl-eks-lexing-addon-iamserviceaccount-kube-system-ebs-csi-controller-sa&quot; 将Amazon EBS CSI 驱动程序添加到集群 12345# 运行以下命令。如果您的集群位于 AWS GovCloud（美国东部）或 AWS GovCloud（美国西部）AWS 区域，则将 arn:aws: 替换为 arn:aws-us-gov:。$ eksctl create addon --name aws-ebs-csi-driver --cluster eks-lexing --profile eks-us-west-2 --service-account-role-arn arn:aws:iam::743263909655:role/AmazonEKS_EBS_CSI_DriverRole --force2023-06-28 16:23:59 [ℹ] Kubernetes version &quot;1.25&quot; in use by cluster &quot;eks-lexing&quot;2023-06-28 16:24:00 [ℹ] using provided ServiceAccountRoleARN &quot;arn:aws:iam::743263909655:role/AmazonEKS_EBS_CSI_DriverRole&quot;2023-06-28 16:24:00 [ℹ] creating addon 检查 Amazon EBS CSI 驱动程序的当前版本，注意这里如果有可用更新，UPDATE AVAILABLE会显示，默认安装是最新版本 12345$ eksctl get addon --name aws-ebs-csi-driver --cluster eks-lexing --profile eks-us-west-22023-06-28 16:24:08 [ℹ] Kubernetes version &quot;1.25&quot; in use by cluster &quot;eks-lexing&quot;2023-06-28 16:24:09 [ℹ] to see issues for an addon run `eksctl get addon --name &lt;addon-name&gt; --cluster &lt;cluster-name&gt;`NAME VERSION STATUS ISSUES IAMROLE UPDATE AVAILABLE CONFIGURATION VALUESaws-ebs-csi-driver v1.19.0-eksbuild.2 CREATING 0 arn:aws:iam::743263909655:role/AmazonEKS_EBS_CSI_DriverRole 插件安装完成后可以查看已经安装的资源，Name中含有 ebs-csi 1234567891011121314151617~ k get all -n kube-system -l app.kubernetes.io/component=csi-driverNAME READY STATUS RESTARTS AGEpod/ebs-csi-controller-5f945bbdfc-m2smb 6/6 Running 0 10mpod/ebs-csi-controller-5f945bbdfc-nfl97 6/6 Running 0 10mpod/ebs-csi-node-kmtv9 3/3 Running 0 10mpod/ebs-csi-node-tdw7m 3/3 Running 0 10mNAME DESIRED CURRENT READY UP-TO-DATE AVAILABLE NODE SELECTOR AGEdaemonset.apps/ebs-csi-node 2 2 2 2 2 kubernetes.io/os=linux 42hdaemonset.apps/ebs-csi-node-windows 0 0 0 0 0 kubernetes.io/os=windows 42hNAME READY UP-TO-DATE AVAILABLE AGEdeployment.apps/ebs-csi-controller 2/2 2 2 42hNAME DESIRED CURRENT READY AGEreplicaset.apps/ebs-csi-controller-57ff9dc5fc 0 0 0 42hreplicaset.apps/ebs-csi-controller-5f945bbdfc 2 2 2 10m 此时可以通过aws控制台对eks的Amazon EBS CSI 驱动程序进行管理，后续升级可以直接在控制台进行 查看Amazon EBS CSI 驱动程序的所有可用版本号 1$ aws eks describe-addon-versions --addon-name aws-ebs-csi-driver --profile eks-us-west-2 更新 Amazon EBS CSI 驱动程序 ，–force 表示强制更新 123456789101112# 查看是否有更新，可以看到UPDATE下有个可用更新版本 v1.20.0-eksbuild.1$ eksctl get addon --name aws-ebs-csi-driver --cluster eks-lexing --profile eks-us-west-22023-06-30 10:21:31 [ℹ] Kubernetes version &quot;1.26&quot; in use by cluster &quot;eks-lexing&quot;2023-06-30 10:21:32 [ℹ] to see issues for an addon run `eksctl get addon --name &lt;addon-name&gt; --cluster &lt;cluster-name&gt;`NAME VERSION STATUS ISSUES IAMROLE UPDATE AVAILABLE CONFIGURATION VALUESaws-ebs-csi-driver v1.19.0-eksbuild.2 ACTIVE 0 arn:aws:iam::743263909644:role/AmazonEKS_EBS_CSI_DriverRole v1.20.0-eksbuild.1# 更新到v1.20.0-eksbuild.1$ eksctl update addon --name aws-ebs-csi-driver --version v1.20.0-eksbuild.1 --cluster eks-lexing --profile eks-us-west-2 --force2023-06-30 10:22:23 [ℹ] Kubernetes version &quot;1.26&quot; in use by cluster &quot;eks-lexing&quot;2023-06-30 10:22:24 [ℹ] new version provided v1.20.0-eksbuild.12023-06-30 10:22:24 [ℹ] updating addon 删除 Amazon EBS CSI 驱动程序 1$ eksctl delete addon --cluster eks-lexing --profile eks-us-west-2 --name aws-ebs-csi-driver --preserve 默认eks为我们创建好了一个sc:gp2 12345678910111213# 默认的gp2配置yaml,其被设置为默认存储类kind: StorageClassapiVersion: storage.k8s.io/v1metadata: name: gp2 annotations: storageclass.kubernetes.io/is-default-class: &quot;true&quot;provisioner: kubernetes.io/aws-ebsparameters: type: gp2 fsType: ext4# storageclass.kubernetes.io/is-default-class: &quot;true&quot; 这个注释表示其是默认存储类 关于默认存储类的说明 在 AWS 的 Amazon EKS（Elastic Kubernetes Service）中，将一个 StorageClass（SC）设置为默认存储类具有以下作用： 自动分配: 当没有显式指定 StorageClass 的情况下，如果某个 Persistent Volume Claim（PVC）没有指定所需的 StorageClass，则默认会选择设置为默认存储类的 StorageClass 进行 PVC 的动态分配。 简化配置: 默认存储类可以简化 PVC 的配置，因为您不需要为每个 PVC 显式指定 StorageClass。只需创建 PVC，并且它将自动使用默认存储类进行分配。 默认设置: 默认存储类是集群级别的默认设置，适用于没有显式指定 StorageClass 的 PVC。这样可以确保在没有特定要求的情况下，PVC 可以使用预定义的默认存储类。 在 AWS EKS 中，只能有一个 StorageClass 被设置为默认存储类。这是因为默认存储类是集群范围的全局设置，它用于满足未显式指定 StorageClass 的 PVC 的需求。如果有多个 StorageClass 被设置为默认，会导致混乱和不确定性，因为 Kubernetes 将无法确定使用哪个默认存储类。 如果需要为不同的 PVC 使用不同的默认存储类，可以通过为每个 PVC 显式指定所需的 StorageClass 来实现，而不是依赖默认存储类。 总结来说，通过设置默认存储类，您可以简化 PVC 的配置并定义集群范围的默认设置。但是，在 AWS EKS 中，只能有一个默认存储类。 使用说明 创建StorageClass 12345678910111213141516171819202122232425262728293031# 创建基于gp3的sc# create-sc-gp3.yamlapiVersion: storage.k8s.io/v1kind: StorageClassmetadata: name: gp3provisioner: ebs.csi.aws.comvolumeBindingMode: WaitForFirstConsumerparameters: type: gp3allowVolumeExpansion: truereclaimPolicy: Delete# 部署$ k apply -f create-sc-gp3.yaml# 查看sc$ k get scNAME PROVISIONER RECLAIMPOLICY VOLUMEBINDINGMODE ALLOWVOLUMEEXPANSION AGEgp2 (default) kubernetes.io/aws-ebs Delete WaitForFirstConsumer false 175mgp3 ebs.csi.aws.com Delete WaitForFirstConsumer true 6s# 虽然创建sc时没有为其指定默认存储类，我们可以通过如下命令将指定的sc设置为默认存储类$ k annotate storageclass gp3 storageclass.kubernetes.io/is-default-class=true# 此时原gp2的默认存储类不会被去掉$ k get scNAME PROVISIONER RECLAIMPOLICY VOLUMEBINDINGMODE ALLOWVOLUMEEXPANSION AGEgp2 (default) kubernetes.io/aws-ebs Delete WaitForFirstConsumer false 20hgp3 (default) ebs.csi.aws.com Delete WaitForFirstConsumer true 17h# 取消指定的sc为默认存储类$ k annotate storageclass --overwrite=true gp3 storageclass.kubernetes.io/is-default-class=false 配置说明 provisioner 1234567891011121314# provisioner 定义了用于动态分配 PV 的存储插件或存储后端。它指定了负责创建和管理 PV 的控制器。# provisioner 的值通常是存储提供商或存储插件的名称，例如# kubernetes.io/aws-ebs（用于 Amazon EBS）、# kubernetes.io/gce-pd（用于 Google Compute Engine PD）等。# 不同的存储插件或存储后端可能具有不同的特性和配置选项。# 这里的ebs.csi.aws.com就是我们安装的Amazon EBS CSI 附加组件。# 在 AWS 的 Amazon EKS（Elastic Kubernetes Service）中，创建 StorageClass（SC）时，支持以下一些常见的 provisioner（供应商）选项：# kubernetes.io/aws-ebs: 这是用于 Amazon EBS（Elastic Block Store）的默认 provisioner。它允许在 EKS 集群上动态分配和管理基于 Amazon EBS 的持久卷（PV）。# kubernetes.io/aws-s3: 这是用于 Amazon S3（Simple Storage Service）的 provisioner。它允许在 EKS 集群中创建和管理基于 Amazon S3 的持久卷。# kubernetes.io/azure-disk: 这是用于 Azure Disk 的 provisioner。它允许在 EKS 集群上动态分配和管理基于 Azure Disk 的持久卷。# kubernetes.io/azure-file: 这是用于 Azure File 的 provisioner。它允许在 EKS 集群中创建和管理基于 Azure File 的持久卷。# 这些是一些常见的 provisioner，但实际上，您还可以使用其他存储插件或自定义 provisioner，以满足您特定的存储需求。不同的存储插件和供应商可能会支持不同的 provisioner，具体取决于您所使用的存储插件和存储后端。# 在创建 StorageClass 时，您需要指定适当的 provisioner 标识符，以便 Kubernetes 和 EKS 能够根据指定的 provisioner 来分配和管理持久卷。 allowVolumeExpansion 1234# allowVolumeExpansion 是一个布尔值参数，用于指定是否允许 PVC 的大小在运行时进行扩展。# 如果将其设置为 true，则表示 PVC 可以动态扩展其大小以满足需求。# 如果将其设置为 false，则 PVC 的大小将在创建时被固定，并且不能在后续进行扩展。# 这取决于存储后端是否支持 PVC 大小的动态调整。 volumeBindingMode 1234567# 在创建 StorageClass 时，可以指定 volumeBindingMode 来定义持久卷（Persistent Volume，PV）与 Persistent Volume Claim（PVC）之间的绑定行为。volumeBindingMode 可以具有以下几种选项：# Immediate: 当使用 Immediate 绑定模式时，Kubernetes 立即绑定 PVC 和 PV。这意味着在创建 PVC 时，Kubernetes 将立即选择并绑定一个可用的 PV。这种模式适用于那些支持动态供应的存储后端。# WaitForFirstConsumer: 使用 WaitForFirstConsumer 绑定模式时，PV 不会立即绑定到 PVC。PV 只有在第一个 Pod 试图使用 PVC 时才会绑定。这种模式适用于那些需要在 Pod 实际使用 PVC 之前进行一些准备工作的存储后端。例如，如果需要在创建 PV 后手动配置外部存储系统。# Delayed: Delayed 绑定模式类似于 WaitForFirstConsumer，但不支持多个 Pod 使用同一个 PVC。只有当 Pod 被调度到节点并使用 PVC 时，PV 才会绑定。这种模式适用于那些只支持单个 Pod 使用 PVC 的存储后端。与 WaitForFirstConsumer 模式相比，Delayed 模式对 PV 和 PVC 之间的绑定更加延迟。# Unknown: 如果未指定 volumeBindingMode，则默认为 Unknown。这意味着 Kubernetes 控制器或存储系统将决定如何绑定 PV 和 PVC。这种情况下，存储系统或云提供商的默认行为将适用。Amazon EBS CSI 只支持 Immediate 和 WaitForFirstConsumer，默认是Immediate。 reclaimPolicy 1234567# 在 Kubernetes 中，reclaimPolicy 是指定持久卷（Persistent Volume，PV）的回收策略。reclaimPolicy 可以具有以下几种选项：# Retain: 使用 Retain 回收策略时，PV 的数据将被保留，而不会被自动删除。当 PV 和其对应的 Persistent Volume Claim（PVC）之间的关系解除时，PV 不会被回收或删除。管理员需要手动处理 PV 的回收或重新使用。# Delete: Delete 回收策略表示在 PV 和 PVC 之间的关系解除时，PV 将被自动删除和回收。PV 中存储的数据将被清除，且无法恢复。这是最常见的回收策略，适用于临时数据或不需要长期保留的情况。# Recycle: Recycle 回收策略是 Kubernetes 早期版本中使用的一种策略，但在 Kubernetes v1.7 版本之后已被弃用。该策略在解除 PV 和 PVC 之间的关系后，会尝试清除 PV 中的数据，使其可以被其他 PVC 重新使用。但这个清除过程仅限于删除 PV 上的文件，而不会对 PV 进行格式化或重建。# External: External 回收策略表示在 PV 和 PVC 之间的关系解除时，PV 的回收和删除操作由外部的存储管理系统或管理员处理。Kubernetes 不会主动回收或删除 PV，而是委托给外部系统进行处理。Amazon EBS CSI 只支持 Retain 和 Delete，默认是Delete。 创建PVC 12345678910111213141516171819create-pvc.yamlapiVersion: v1kind: PersistentVolumeClaimmetadata: name: ebs-gp3-claimspec: accessModes: - ReadWriteOnce storageClassName: gp3 resources: requests: storage: 4Gi$ k apply -f create-pvc.yaml# pvc指定的sc中的volumeBindingMode是WaitForFirstConsumer，只有被使用到时才会去真正申请资源，所以此时看到的状态一直都会是Pending$ k get pvcNAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGEebs-gp3-claim Pending gp3 2m51s 配置说明 accessModes 12345678# 在 Kubernetes 中，PVC 是用于声明性地请求持久化存储资源的对象。它定义了 Pod 对持久卷（Persistent Volume，PV）的访问要求。PVC 可以指定不同的 accessModes，以确定 Pod 如何访问与之绑定的 PV。以下是 PVC 可能的 accessModes：# ReadWriteOnce (RWO): 此模式表示 PVC 可以被一个单个 Pod 以读写的方式挂载。这意味着 PVC 只能被一个 Pod 使用，而且可以同时读取和写入数据。这是许多常见应用程序的默认模式，例如关系型数据库。# ReadOnlyMany (ROX): 此模式表示 PVC 可以被多个 Pod 以只读的方式挂载。这意味着多个 Pod 可以同时读取数据，但不能写入。通常用于需要共享只读数据的场景，例如日志收集或静态内容的共享。# ReadWriteMany (RWX): 此模式表示 PVC 可以被多个 Pod 以读写的方式挂载。这意味着多个 Pod 可以同时读取和写入数据。然而，不是所有的存储插件都支持此模式，因此需要确保所使用的存储后端能够满足该要求。这是最具挑战性的模式，因为需要提供多个 Pod 之间的数据同步和一致性。需要注意的是，Amazon EBS CSI 目前只支持 ReadWriteOnce 访问模式，即每个卷只能被单个 Pod 以读写方式挂载。ReadOnlyMany 和 ReadWriteMany 访问模式在 Amazon EBS CSI 中尚未支持。如果您需要多个 Pod 可以同时以只读方式访问卷，您可以考虑使用 Amazon EFS（Elastic File System），它提供了 ReadWriteMany 访问模式，以满足多个 Pod 的同时只读访问需求。 申请ebs资源 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110# 可以创建一个pod绑定这个pvc就可以看到资源被申请了# create-pod.yamlapiVersion: v1kind: Podmetadata: name: appspec: containers: - name: app image: centos command: [&quot;/bin/sh&quot;] args: [&quot;-c&quot;, &quot;while true; do echo $(date -u) &gt;&gt; /data/out.txt; sleep 5; done&quot;] volumeMounts: - name: persistent-storage mountPath: /data volumes: - name: persistent-storage persistentVolumeClaim: claimName: ebs-gp3-claim$ k apply -f create-pod.yaml# 查看pv和pvc$ k get pvNAME CAPACITY ACCESS MODES RECLAIM POLICY STATUS CLAIM STORAGECLASS REASON AGEpvc-02700260-b5e0-40bf-8c72-c1afad9e103e 4Gi RWO Delete Bound test/ebs-gp3-claim gp3 4m34s$ k get pvcNAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGEebs-gp3-claim Bound pvc-02700260-b5e0-40bf-8c72-c1afad9e103e 4Gi RWO gp3 9m27s# VolumeHandle: vol-0362860fb03d9d618 就是实际的EBS卷ID$ k describe pv pvc-02700260-b5e0-40bf-8c72-c1afad9e103eName: pvc-02700260-b5e0-40bf-8c72-c1afad9e103eLabels: &lt;none&gt;Annotations: pv.kubernetes.io/provisioned-by: ebs.csi.aws.com volume.kubernetes.io/provisioner-deletion-secret-name: volume.kubernetes.io/provisioner-deletion-secret-namespace:Finalizers: [kubernetes.io/pv-protection external-attacher/ebs-csi-aws-com]StorageClass: gp3Status: BoundClaim: test/ebs-gp3-claimReclaim Policy: DeleteAccess Modes: RWOVolumeMode: FilesystemCapacity: 4GiNode Affinity: Required Terms: Term 0: topology.ebs.csi.aws.com/zone in [us-west-2b]Message:Source: Type: CSI (a Container Storage Interface (CSI) volume source) Driver: ebs.csi.aws.com FSType: ext4 VolumeHandle: vol-0362860fb03d9d618 ReadOnly: false VolumeAttributes: storage.kubernetes.io/csiProvisionerIdentity=1687940646992-1017-ebs.csi.aws.comEvents: &lt;none&gt;# Used By 中展示的就是当前正在使用pvc的pod$ k describe pvc ebs-gp3-claimName: ebs-gp3-claimNamespace: testStorageClass: gp3Status: BoundVolume: pvc-02700260-b5e0-40bf-8c72-c1afad9e103eLabels: &lt;none&gt;Annotations: pv.kubernetes.io/bind-completed: yes pv.kubernetes.io/bound-by-controller: yes volume.beta.kubernetes.io/storage-provisioner: ebs.csi.aws.com volume.kubernetes.io/selected-node: ip-192-168-48-14.us-west-2.compute.internal volume.kubernetes.io/storage-provisioner: ebs.csi.aws.comFinalizers: [kubernetes.io/pvc-protection]Capacity: 4GiAccess Modes: RWOVolumeMode: FilesystemUsed By: app-56df75755d-2phz4 app-56df75755d-cvjvc app-56df75755d-xx9ghEvents: &lt;none&gt;# 此时如果删除pod，则其对应的pvc并不会被删除，之前申请到的ebs也不会被清除$ k delete -f create-pod.yaml$ k get podNo resources found in test namespace.$ k get pvNAME CAPACITY ACCESS MODES RECLAIM POLICY STATUS CLAIM STORAGECLASS REASON AGEpvc-02700260-b5e0-40bf-8c72-c1afad9e103e 4Gi RWO Delete Bound test/ebs-gp3-claim gp3 9m47s$ k get pvcNAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGEebs-gp3-claim Bound pvc-02700260-b5e0-40bf-8c72-c1afad9e103e 4Gi RWO gp3 14m# 此时如果重新创建pod并关联该pvc，则磁盘依旧有效，并且是不会被清空的$ k apply -f create-pod.yaml# 查看pod的输出，可以看到中间有个超过5秒的间隔，这就是pod被删除然后又重建的间隔时间，说明磁盘没有被清空重建$ k exec -it app -- tail -f /data/out.txtThu Jun 29 01:51:31 UTC 2023Thu Jun 29 01:51:36 UTC 2023Thu Jun 29 01:51:41 UTC 2023Thu Jun 29 01:53:25 UTC 2023Thu Jun 29 01:53:30 UTC 2023Thu Jun 29 01:53:35 UTC 2023# 如果要彻底删除磁盘，需要删除pvc，sc中的reclaimPolicy是Delete才会被删除$ k delete -f create-pvc.yamlpersistentvolumeclaim &quot;ebs-gp3-claim&quot; deleted$ k get pvcNo resources found in test namespace.$ k get pvNo resources found 一个deployment并挂载ebs的示例 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889# deployment-volume.yamlapiVersion: v1kind: PersistentVolumeClaimmetadata: name: ebs-gp3-claimspec: accessModes: - ReadWriteOnce storageClassName: gp3 resources: requests: storage: 4Gi---apiVersion: apps/v1kind: Deploymentmetadata: name: appspec: replicas: 3 selector: matchLabels: app: app template: metadata: labels: app: app spec: containers: - name: app image: centos command: [&quot;/bin/sh&quot;] args: [&quot;-c&quot;, &quot;while true; do echo $(date -u) &gt;&gt; /data/out.txt; sleep 5; done&quot;] volumeMounts: - name: persistent-storage mountPath: /data volumes: - name: persistent-storage persistentVolumeClaim: claimName: ebs-gp3-claim# 部署~ k deploy -f deployment-volume.yaml# 查看deploy~ k get deployNAME READY UP-TO-DATE AVAILABLE AGEapp 3/3 3 3 85s~ k get podNAME READY STATUS RESTARTS AGEapp-699cf8fdd-fk8vs 0/1 Running 0 90sapp-699cf8fdd-gpk7m 0/1 Running 0 90sapp-699cf8fdd-h5mbr 0/1 Running 0 90s# 可以看到3个pod在同时写入一个文件~ k exec -it app-699cf8fdd-fk8vs -- head /data/out.txtFri Jul 7 09:55:21 UTC 2023Fri Jul 7 09:55:21 UTC 2023Fri Jul 7 09:55:21 UTC 2023Fri Jul 7 09:55:26 UTC 2023Fri Jul 7 09:55:26 UTC 2023Fri Jul 7 09:55:26 UTC 2023Fri Jul 7 09:55:31 UTC 2023Fri Jul 7 09:55:31 UTC 2023# 重启deploy~ k rollout restart deployment appdeployment.apps/app restarted# 可以看到重新启动了3个pod，并且终止了原先启动的3个pod~ k get podNAME READY STATUS RESTARTS AGEapp-667968b659-62dpl 1/1 Running 0 6sapp-667968b659-7x6wj 1/1 Running 0 4sapp-667968b659-n2rvz 1/1 Running 0 2sapp-699cf8fdd-fk8vs 1/1 Terminating 0 287sapp-699cf8fdd-gpk7m 1/1 Terminating 0 287sapp-699cf8fdd-h5mbr 1/1 Terminating 0 287s# 可以看到重启deploy后，文件内容依旧存在~ k exec -it app-667968b659-62dpl -- head /data/out.txtFri Jul 7 09:55:21 UTC 2023Fri Jul 7 09:55:21 UTC 2023Fri Jul 7 09:55:21 UTC 2023Fri Jul 7 09:55:26 UTC 2023Fri Jul 7 09:55:26 UTC 2023Fri Jul 7 09:55:26 UTC 2023Fri Jul 7 09:55:31 UTC 2023Fri Jul 7 09:55:31 UTC 2023 讨论 这里注意一下，k8s-1.23版本创建时会成功，但是重启不成功，只会重新启动成功一个pod，另外两个pod会失败，提示pvc已经被一个pod关联了，但是1.25版就可以创建和重启时都可以成功，不确定是否和Amazon EBS CSI 版本有关系。 后记 这里要注意一个问题，如果pv被pvc绑定，此时是无法删除pv的，同理pvc被其它资源关联，也是不能被删除的，需要先删除对应的资源才可以。 EBS不能跨可用区，如果pod部署在不同的可用区，则不能使用ebs作为存储，此时可以使用EFS。","summary":"摘要 本文介绍在EKS集群中安装 Amazon EBS CSI 驱动程序过程 参考资料： Amazon EKS用户指南 Kubernetes 文档","date_published":"2023-07-07T14:30:05.000Z","tags":["技术","aws","eks","java"]},{"id":"https://blog.hanqunfeng.com/2023/07/07/aws-eks04-vpc-cni/","url":"https://blog.hanqunfeng.com/2023/07/07/aws-eks04-vpc-cni/","title":"AWS-EKS-04--安装 Amazon VPC CNI","content_html":"<!--\n **加粗**\n *斜体*\n ***加粗并斜体***\n ~~删除线~~\n ==突出显示==\n `突出显示(推荐)`\n ++下划线++\n ~下标~\n ^上标^\n 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.\n 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600)\n\n +++ **点击折叠**\n 这是被隐藏的内容\n +++\n\n::: tips success warning danger\n这里是容器内的内容\n:::\n\n% note info % success warning danger\n这里是容器内的内容\n% endnote %\n\n -->\n<h2 id=\"摘要\">摘要</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>本文介绍在EKS集群中安装 Amazon VPC CNI的过程</p>\n</li>\n<li class=\"lvl-2\">\n<p>参考资料：</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\"><a href=\"https://docs.aws.amazon.com/zh_cn/eks/latest/userguide\">Amazon EKS用户指南</a></li>\n<li class=\"lvl-6\"><a href=\"https://kubernetes.io/zh-cn/docs/home/\">Kubernetes 文档</a></li>\n</ul>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"安装Amazon-VPC-CNI-plugin-for-Kubernetes\">安装Amazon VPC CNI plugin for Kubernetes</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Amazon VPC CNI plugin for Kubernetes 是 Amazon EKS 集群中用于 Pod 联网的联网插件。该插件负责向 Kubernetes 节点分配 VPC IP 地址并为每个节点上的 Pods 配置所需网络。</p>\n</li>\n<li class=\"lvl-2\">\n<p>如果您使用 AWS Management Console 部署了集群，则可以跳过此步骤。AWS Management Console在默认情况下会部署 Amazon VPC CNI plugin for Kubernetes、CoreDNS、kube-proxy Amazon EKS 附加组件。<br>\n如果您使用 eksctl 或 AWS CLI 部署集群，则 Amazon VPC CNI plugin for Kubernetes、CoreDNS 和 kube-proxy 自行管理的附加组件将会被部署。您可以将使用您的集群部署的 Amazon VPC CNI plugin for Kubernetes、CoreDNS 和 kube-proxy 自行管理的附加组件迁移到 Amazon EKS 附加组件中。为了遵循最小特权原则，AWS建议我们将<code>AmazonEKS_CNI_Policy</code>策略附加到专门用于Amazon VPC CNI附加组件的单独角色。</p>\n</li>\n<li class=\"lvl-2\">\n<p>创建 IAM 角色</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 确定您的集群的 IP 系列</span></span><br><span class=\"line\">$ aws eks describe-cluster --name eks-lexing  --profile eks-us-west-2 | grep ipFamily</span><br><span class=\"line\">            <span class=\"string\">&quot;ipFamily&quot;</span>: <span class=\"string\">&quot;ipv4&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># 使用与您的集群的 IP 系列匹配的命令创建 IAM 角色并将 IAM policy 附加到该角色。此命令创建并部署一个创建 IAM 角色的 AWS CloudFormation 堆栈，向其附加您指定的策略，并使用所创建 IAM 角色的 ARN 对现有 aws-node Kubernetes 服务账户添加注释。</span></span><br><span class=\"line\">$ eksctl create iamserviceaccount --name aws-node --namespace kube-system \\</span><br><span class=\"line\">    --cluster eks-lexing --profile eks-us-west-2 \\</span><br><span class=\"line\">    --role-name AmazonEKSVPCCNIRole \\</span><br><span class=\"line\">    --attach-policy-arn arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy \\</span><br><span class=\"line\">    --override-existing-serviceaccounts \\</span><br><span class=\"line\">    --approve</span><br><span class=\"line\"> 2023-06-30 16:38:30 [ℹ]  1 existing iamserviceaccount(s) (kube-system/ebs-csi-controller-sa) will be excluded</span><br><span class=\"line\">2023-06-30 16:38:30 [ℹ]  1 iamserviceaccount (kube-system/aws-node) was included (based on the include/exclude rules)</span><br><span class=\"line\">2023-06-30 16:38:30 [!]  metadata of serviceaccounts that exist <span class=\"keyword\">in</span> Kubernetes will be updated, as --override-existing-serviceaccounts was <span class=\"built_in\">set</span></span><br><span class=\"line\">2023-06-30 16:38:30 [ℹ]  1 task: &#123;</span><br><span class=\"line\">    2 sequential sub-tasks: &#123;</span><br><span class=\"line\">        create IAM role <span class=\"keyword\">for</span> serviceaccount <span class=\"string\">&quot;kube-system/aws-node&quot;</span>,</span><br><span class=\"line\">        create serviceaccount <span class=\"string\">&quot;kube-system/aws-node&quot;</span>,</span><br><span class=\"line\">    &#125; &#125;2023-06-30 16:38:30 [ℹ]  building iamserviceaccount stack <span class=\"string\">&quot;eksctl-eks-lexing-addon-iamserviceaccount-kube-system-aws-node&quot;</span></span><br><span class=\"line\">2023-06-30 16:38:31 [ℹ]  deploying stack <span class=\"string\">&quot;eksctl-eks-lexing-addon-iamserviceaccount-kube-system-aws-node&quot;</span></span><br><span class=\"line\">2023-06-30 16:38:31 [ℹ]  waiting <span class=\"keyword\">for</span> CloudFormation stack <span class=\"string\">&quot;eksctl-eks-lexing-addon-iamserviceaccount-kube-system-aws-node&quot;</span></span><br><span class=\"line\">2023-06-30 16:39:02 [ℹ]  waiting <span class=\"keyword\">for</span> CloudFormation stack <span class=\"string\">&quot;eksctl-eks-lexing-addon-iamserviceaccount-kube-system-aws-node&quot;</span></span><br><span class=\"line\">2023-06-30 16:39:04 [ℹ]  serviceaccount <span class=\"string\">&quot;kube-system/aws-node&quot;</span> already exists</span><br><span class=\"line\">2023-06-30 16:39:04 [ℹ]  updated serviceaccount <span class=\"string\">&quot;kube-system/aws-node&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 重新部署 Amazon VPC CNI plugin for KubernetesPods</span></span><br><span class=\"line\"><span class=\"comment\"># 删除并重新创建任何与服务账户关联的现有 Pods，以应用凭证环境变量。注释未应用于目前在没有注释的情况下运行的 Pods。以下命令删除现有的 aws-node DaemonSet Pods 并使用服务账户注释部署它们。</span></span><br><span class=\"line\">$ kubectl delete Pods -n kube-system -l k8s-app=aws-node</span><br><span class=\"line\">pod <span class=\"string\">&quot;aws-node-fzh9v&quot;</span> deleted</span><br><span class=\"line\">pod <span class=\"string\">&quot;aws-node-t62f8&quot;</span> deleted</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 确认 Pods 已全部重新启动</span></span><br><span class=\"line\">$ kubectl get pods -n kube-system -l k8s-app=aws-node</span><br><span class=\"line\">NAME             READY   STATUS    RESTARTS   AGE</span><br><span class=\"line\">aws-node-q2zfb   1/1     Running   0          11s</span><br><span class=\"line\">aws-node-rmfbk   1/1     Running   0          11s</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 描述 Pods 之一并确保 AWS_WEB_IDENTITY_TOKEN_FILE 和 AWS_ROLE_ARN 环境变量存在。</span></span><br><span class=\"line\">$ kubectl describe pod -n kube-system aws-node-q2zfb | grep <span class=\"string\">&#x27;AWS_ROLE_ARN:\\|AWS_WEB_IDENTITY_TOKEN_FILE:&#x27;</span></span><br><span class=\"line\">      AWS_ROLE_ARN:                 arn:aws:iam::743263909655:role/AmazonEKSVPCCNIRole</span><br><span class=\"line\">      AWS_WEB_IDENTITY_TOKEN_FILE:  /var/run/secrets/eks.amazonaws.com/serviceaccount/token</span><br><span class=\"line\">      AWS_ROLE_ARN:                           arn:aws:iam::743263909655:role/AmazonEKSVPCCNIRole</span><br><span class=\"line\">      AWS_WEB_IDENTITY_TOKEN_FILE:            /var/run/secrets/eks.amazonaws.com/serviceaccount/token</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>配置好上面的IAM角色后，要从节点 IAM 角色中删除 CNI 策略</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">在角色列表中搜索 eksNodeRole、AmazonEKSNodeRole 或 NodeInstanceRole，应该存在一个，我这里就是存在 NodeInstanceRole，如果一个都不存在就先参照上文创建一个新的IAM角色<br>\n<img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/Dih0XN.png\" alt=\"\" width=\"900\" height=\"300\"></li>\n<li class=\"lvl-6\">删除策略 AmazonEKS_CNI_Policy<br>\n<img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/VX6Ro8.png\" alt=\"\" width=\"900\" height=\"600\"></li>\n<li class=\"lvl-6\">也可以通过命令行删除角色中的策略</li>\n</ul>\n  <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">aws iam detach-role-policy --profile eks-us-west-2 --role-name eksctl-eks-lexing-nodegroup-ng-4d-NodeInstanceRole-Y28EPJO9XYDG --policy-arn arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy</span><br></pre></td></tr></table></figure>\n</li>\n<li class=\"lvl-2\">\n<p>安装Amazon VPC CNI plugin for Kubernetes</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看集群上当前安装的附加组件版本</span></span><br><span class=\"line\">$ kubectl describe daemonset aws-node --namespace kube-system | grep amazon-k8s-cni: | <span class=\"built_in\">cut</span> -d : -f 3</span><br><span class=\"line\">v1.12.2-eksbuild.1</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看集群上当前安装的附加组件类型。根据您创建集群时使用的工具，您的集群上目前可能没有安装 Amazon EKS 附加组件类型</span></span><br><span class=\"line\">$ aws eks describe-addon --cluster-name eks-lexing --profile eks-us-west-2 --addon-name vpc-cni --query addon.addonVersion --output text</span><br><span class=\"line\"></span><br><span class=\"line\">An error occurred (ResourceNotFoundException) when calling the DescribeAddon operation: No addon: vpc-cni found <span class=\"keyword\">in</span> cluster: eks-lexing</span><br><span class=\"line\"><span class=\"comment\"># 如果返回版本号，则表明您的集群上安装有 Amazon EKS 附加组件类型，且您不需要完成此过程的其余步骤。如果返回错误，则表明您的集群上安装有 Amazon EKS 类型的附加组件。完成此过程的其余步骤以进行安装。</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 使用 AWS CLI 创建附加组件，注意这里--addon-version的版本号要与https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/managing-vpc-cni.html中的k8s版本相对应</span></span><br><span class=\"line\"><span class=\"comment\"># AmazonEKSVPCCNIRole就是上面创建的角色的名称</span></span><br><span class=\"line\">$ aws eks create-addon --cluster-name eks-lexing --profile eks-us-west-2 \\</span><br><span class=\"line\">    --addon-name vpc-cni \\</span><br><span class=\"line\">    --addon-version v1.12.6-eksbuild.2 \\</span><br><span class=\"line\">    --resolve-conflicts OVERWRITE \\</span><br><span class=\"line\">    --service-account-role-arn arn:aws:iam::743263909655:role/AmazonEKSVPCCNIRole</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;addon&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;addonName&quot;</span>: <span class=\"string\">&quot;vpc-cni&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;clusterName&quot;</span>: <span class=\"string\">&quot;eks-lexing&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;status&quot;</span>: <span class=\"string\">&quot;CREATING&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;addonVersion&quot;</span>: <span class=\"string\">&quot;v1.12.6-eksbuild.2&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;health&quot;</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;issues&quot;</span>: []</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;addonArn&quot;</span>: <span class=\"string\">&quot;arn:aws:eks:us-west-2:743263909655:addon/eks-lexing/vpc-cni/bcc485cc-cf4c-f8c6-84da-55c66044e0ff&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;createdAt&quot;</span>: <span class=\"string\">&quot;2023-06-30T17:19:24.457000+08:00&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;modifiedAt&quot;</span>: <span class=\"string\">&quot;2023-06-30T17:19:24.475000+08:00&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;serviceAccountRoleArn&quot;</span>: <span class=\"string\">&quot;arn:aws:iam::743263909655:role/AmazonEKSVPCCNIRole&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;tags&quot;</span>: &#123;&#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 确认您的集群的 Kubernetes 版本的附加组件最新版本已添加到您的集群</span></span><br><span class=\"line\">$ aws eks describe-addon --cluster-name eks-lexing --profile eks-us-west-2 --addon-name vpc-cni --query addon.addonVersion --output text</span><br><span class=\"line\">v1.12.6-eksbuild.2</span><br><span class=\"line\"></span><br><span class=\"line\">$ kubectl describe daemonset aws-node --namespace kube-system | grep amazon-k8s-cni: | <span class=\"built_in\">cut</span> -d : -f 3</span><br><span class=\"line\">v1.12.6-eksbuild.2</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>此时可以通过aws控制台对eks的 Amazon VPC CNI 插件进行管理，后续升级可以直接在控制台进行<br>\n<img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/53TeZU.png\" alt=\"\" width=\"1200\" height=\"600\"></p>\n</li>\n</ul>\n<h2 id=\"查看eks的所有可用组件\">查看eks的所有可用组件</h2>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看都有哪些组件</span></span><br><span class=\"line\">$ eksctl utils describe-addon-versions --kubernetes-version 1.26 --profile eks-us-west-2 | grep AddonName</span><br><span class=\"line\">            <span class=\"string\">&quot;AddonName&quot;</span>: <span class=\"string\">&quot;kube-proxy&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;AddonName&quot;</span>: <span class=\"string\">&quot;adot&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;AddonName&quot;</span>: <span class=\"string\">&quot;aws-guardduty-agent&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;AddonName&quot;</span>: <span class=\"string\">&quot;vpc-cni&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;AddonName&quot;</span>: <span class=\"string\">&quot;kubecost_kubecost&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;AddonName&quot;</span>: <span class=\"string\">&quot;coredns&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;AddonName&quot;</span>: <span class=\"string\">&quot;aws-ebs-csi-driver&quot;</span>,</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看某个组件有哪些版本</span></span><br><span class=\"line\">$ eksctl utils describe-addon-versions --kubernetes-version 1.26 --name vpc-cni --profile eks-us-west-2 | grep AddonVersion</span><br><span class=\"line\">            <span class=\"string\">&quot;AddonVersions&quot;</span>: [</span><br><span class=\"line\">                    <span class=\"string\">&quot;AddonVersion&quot;</span>: <span class=\"string\">&quot;v1.13.2-eksbuild.1&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;AddonVersion&quot;</span>: <span class=\"string\">&quot;v1.13.0-eksbuild.1&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;AddonVersion&quot;</span>: <span class=\"string\">&quot;v1.12.6-eksbuild.2&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;AddonVersion&quot;</span>: <span class=\"string\">&quot;v1.12.6-eksbuild.1&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;AddonVersion&quot;</span>: <span class=\"string\">&quot;v1.12.5-eksbuild.2&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;AddonVersion&quot;</span>: <span class=\"string\">&quot;v1.12.0-eksbuild.2&quot;</span>,</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 确定您要创建的附加组件是 Amazon EKS 还是 AWS Marketplace 附加组件，如果未返回输出，则该附加组件是 Amazon EKS。如果返回输出，则该附加组件是 AWS Marketplace 附加组件。</span></span><br><span class=\"line\">$ eksctl utils describe-addon-versions --kubernetes-version 1.26 --name vpc-cni --profile eks-us-west-2 | grep ProductUrl</span><br><span class=\"line\"></span><br><span class=\"line\">$ eksctl utils describe-addon-versions --kubernetes-version 1.26 --name kubecost_kubecost --profile  eks-us-west-2 | grep ProductUrl</span><br><span class=\"line\">                <span class=\"string\">&quot;ProductUrl&quot;</span>: <span class=\"string\">&quot;https://aws.amazon.com/marketplace/pp?sku=753cea16-f450-4cfa-93eb-f55dcde11e91&quot;</span></span><br></pre></td></tr></table></figure>","content_text":"摘要 本文介绍在EKS集群中安装 Amazon VPC CNI的过程 参考资料： Amazon EKS用户指南 Kubernetes 文档 安装Amazon VPC CNI plugin for Kubernetes Amazon VPC CNI plugin for Kubernetes 是 Amazon EKS 集群中用于 Pod 联网的联网插件。该插件负责向 Kubernetes 节点分配 VPC IP 地址并为每个节点上的 Pods 配置所需网络。 如果您使用 AWS Management Console 部署了集群，则可以跳过此步骤。AWS Management Console在默认情况下会部署 Amazon VPC CNI plugin for Kubernetes、CoreDNS、kube-proxy Amazon EKS 附加组件。 如果您使用 eksctl 或 AWS CLI 部署集群，则 Amazon VPC CNI plugin for Kubernetes、CoreDNS 和 kube-proxy 自行管理的附加组件将会被部署。您可以将使用您的集群部署的 Amazon VPC CNI plugin for Kubernetes、CoreDNS 和 kube-proxy 自行管理的附加组件迁移到 Amazon EKS 附加组件中。为了遵循最小特权原则，AWS建议我们将AmazonEKS_CNI_Policy策略附加到专门用于Amazon VPC CNI附加组件的单独角色。 创建 IAM 角色 123456789101112131415161718192021222324252627282930313233343536373839404142# 确定您的集群的 IP 系列$ aws eks describe-cluster --name eks-lexing --profile eks-us-west-2 | grep ipFamily &quot;ipFamily&quot;: &quot;ipv4&quot;# 使用与您的集群的 IP 系列匹配的命令创建 IAM 角色并将 IAM policy 附加到该角色。此命令创建并部署一个创建 IAM 角色的 AWS CloudFormation 堆栈，向其附加您指定的策略，并使用所创建 IAM 角色的 ARN 对现有 aws-node Kubernetes 服务账户添加注释。$ eksctl create iamserviceaccount --name aws-node --namespace kube-system \\ --cluster eks-lexing --profile eks-us-west-2 \\ --role-name AmazonEKSVPCCNIRole \\ --attach-policy-arn arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy \\ --override-existing-serviceaccounts \\ --approve 2023-06-30 16:38:30 [ℹ] 1 existing iamserviceaccount(s) (kube-system/ebs-csi-controller-sa) will be excluded2023-06-30 16:38:30 [ℹ] 1 iamserviceaccount (kube-system/aws-node) was included (based on the include/exclude rules)2023-06-30 16:38:30 [!] metadata of serviceaccounts that exist in Kubernetes will be updated, as --override-existing-serviceaccounts was set2023-06-30 16:38:30 [ℹ] 1 task: &#123; 2 sequential sub-tasks: &#123; create IAM role for serviceaccount &quot;kube-system/aws-node&quot;, create serviceaccount &quot;kube-system/aws-node&quot;, &#125; &#125;2023-06-30 16:38:30 [ℹ] building iamserviceaccount stack &quot;eksctl-eks-lexing-addon-iamserviceaccount-kube-system-aws-node&quot;2023-06-30 16:38:31 [ℹ] deploying stack &quot;eksctl-eks-lexing-addon-iamserviceaccount-kube-system-aws-node&quot;2023-06-30 16:38:31 [ℹ] waiting for CloudFormation stack &quot;eksctl-eks-lexing-addon-iamserviceaccount-kube-system-aws-node&quot;2023-06-30 16:39:02 [ℹ] waiting for CloudFormation stack &quot;eksctl-eks-lexing-addon-iamserviceaccount-kube-system-aws-node&quot;2023-06-30 16:39:04 [ℹ] serviceaccount &quot;kube-system/aws-node&quot; already exists2023-06-30 16:39:04 [ℹ] updated serviceaccount &quot;kube-system/aws-node&quot;# 重新部署 Amazon VPC CNI plugin for KubernetesPods# 删除并重新创建任何与服务账户关联的现有 Pods，以应用凭证环境变量。注释未应用于目前在没有注释的情况下运行的 Pods。以下命令删除现有的 aws-node DaemonSet Pods 并使用服务账户注释部署它们。$ kubectl delete Pods -n kube-system -l k8s-app=aws-nodepod &quot;aws-node-fzh9v&quot; deletedpod &quot;aws-node-t62f8&quot; deleted# 确认 Pods 已全部重新启动$ kubectl get pods -n kube-system -l k8s-app=aws-nodeNAME READY STATUS RESTARTS AGEaws-node-q2zfb 1/1 Running 0 11saws-node-rmfbk 1/1 Running 0 11s# 描述 Pods 之一并确保 AWS_WEB_IDENTITY_TOKEN_FILE 和 AWS_ROLE_ARN 环境变量存在。$ kubectl describe pod -n kube-system aws-node-q2zfb | grep &#x27;AWS_ROLE_ARN:\\|AWS_WEB_IDENTITY_TOKEN_FILE:&#x27; AWS_ROLE_ARN: arn:aws:iam::743263909655:role/AmazonEKSVPCCNIRole AWS_WEB_IDENTITY_TOKEN_FILE: /var/run/secrets/eks.amazonaws.com/serviceaccount/token AWS_ROLE_ARN: arn:aws:iam::743263909655:role/AmazonEKSVPCCNIRole AWS_WEB_IDENTITY_TOKEN_FILE: /var/run/secrets/eks.amazonaws.com/serviceaccount/token 配置好上面的IAM角色后，要从节点 IAM 角色中删除 CNI 策略 在角色列表中搜索 eksNodeRole、AmazonEKSNodeRole 或 NodeInstanceRole，应该存在一个，我这里就是存在 NodeInstanceRole，如果一个都不存在就先参照上文创建一个新的IAM角色 删除策略 AmazonEKS_CNI_Policy 也可以通过命令行删除角色中的策略 1aws iam detach-role-policy --profile eks-us-west-2 --role-name eksctl-eks-lexing-nodegroup-ng-4d-NodeInstanceRole-Y28EPJO9XYDG --policy-arn arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy 安装Amazon VPC CNI plugin for Kubernetes 12345678910111213141516171819202122232425262728293031323334353637383940# 查看集群上当前安装的附加组件版本$ kubectl describe daemonset aws-node --namespace kube-system | grep amazon-k8s-cni: | cut -d : -f 3v1.12.2-eksbuild.1# 查看集群上当前安装的附加组件类型。根据您创建集群时使用的工具，您的集群上目前可能没有安装 Amazon EKS 附加组件类型$ aws eks describe-addon --cluster-name eks-lexing --profile eks-us-west-2 --addon-name vpc-cni --query addon.addonVersion --output textAn error occurred (ResourceNotFoundException) when calling the DescribeAddon operation: No addon: vpc-cni found in cluster: eks-lexing# 如果返回版本号，则表明您的集群上安装有 Amazon EKS 附加组件类型，且您不需要完成此过程的其余步骤。如果返回错误，则表明您的集群上安装有 Amazon EKS 类型的附加组件。完成此过程的其余步骤以进行安装。# 使用 AWS CLI 创建附加组件，注意这里--addon-version的版本号要与https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/managing-vpc-cni.html中的k8s版本相对应# AmazonEKSVPCCNIRole就是上面创建的角色的名称$ aws eks create-addon --cluster-name eks-lexing --profile eks-us-west-2 \\ --addon-name vpc-cni \\ --addon-version v1.12.6-eksbuild.2 \\ --resolve-conflicts OVERWRITE \\ --service-account-role-arn arn:aws:iam::743263909655:role/AmazonEKSVPCCNIRole&#123; &quot;addon&quot;: &#123; &quot;addonName&quot;: &quot;vpc-cni&quot;, &quot;clusterName&quot;: &quot;eks-lexing&quot;, &quot;status&quot;: &quot;CREATING&quot;, &quot;addonVersion&quot;: &quot;v1.12.6-eksbuild.2&quot;, &quot;health&quot;: &#123; &quot;issues&quot;: [] &#125;, &quot;addonArn&quot;: &quot;arn:aws:eks:us-west-2:743263909655:addon/eks-lexing/vpc-cni/bcc485cc-cf4c-f8c6-84da-55c66044e0ff&quot;, &quot;createdAt&quot;: &quot;2023-06-30T17:19:24.457000+08:00&quot;, &quot;modifiedAt&quot;: &quot;2023-06-30T17:19:24.475000+08:00&quot;, &quot;serviceAccountRoleArn&quot;: &quot;arn:aws:iam::743263909655:role/AmazonEKSVPCCNIRole&quot;, &quot;tags&quot;: &#123;&#125; &#125;&#125;# 确认您的集群的 Kubernetes 版本的附加组件最新版本已添加到您的集群$ aws eks describe-addon --cluster-name eks-lexing --profile eks-us-west-2 --addon-name vpc-cni --query addon.addonVersion --output textv1.12.6-eksbuild.2$ kubectl describe daemonset aws-node --namespace kube-system | grep amazon-k8s-cni: | cut -d : -f 3v1.12.6-eksbuild.2 此时可以通过aws控制台对eks的 Amazon VPC CNI 插件进行管理，后续升级可以直接在控制台进行 查看eks的所有可用组件 12345678910111213141516171819202122232425# 查看都有哪些组件$ eksctl utils describe-addon-versions --kubernetes-version 1.26 --profile eks-us-west-2 | grep AddonName &quot;AddonName&quot;: &quot;kube-proxy&quot;, &quot;AddonName&quot;: &quot;adot&quot;, &quot;AddonName&quot;: &quot;aws-guardduty-agent&quot;, &quot;AddonName&quot;: &quot;vpc-cni&quot;, &quot;AddonName&quot;: &quot;kubecost_kubecost&quot;, &quot;AddonName&quot;: &quot;coredns&quot;, &quot;AddonName&quot;: &quot;aws-ebs-csi-driver&quot;,# 查看某个组件有哪些版本$ eksctl utils describe-addon-versions --kubernetes-version 1.26 --name vpc-cni --profile eks-us-west-2 | grep AddonVersion &quot;AddonVersions&quot;: [ &quot;AddonVersion&quot;: &quot;v1.13.2-eksbuild.1&quot;, &quot;AddonVersion&quot;: &quot;v1.13.0-eksbuild.1&quot;, &quot;AddonVersion&quot;: &quot;v1.12.6-eksbuild.2&quot;, &quot;AddonVersion&quot;: &quot;v1.12.6-eksbuild.1&quot;, &quot;AddonVersion&quot;: &quot;v1.12.5-eksbuild.2&quot;, &quot;AddonVersion&quot;: &quot;v1.12.0-eksbuild.2&quot;,# 确定您要创建的附加组件是 Amazon EKS 还是 AWS Marketplace 附加组件，如果未返回输出，则该附加组件是 Amazon EKS。如果返回输出，则该附加组件是 AWS Marketplace 附加组件。$ eksctl utils describe-addon-versions --kubernetes-version 1.26 --name vpc-cni --profile eks-us-west-2 | grep ProductUrl$ eksctl utils describe-addon-versions --kubernetes-version 1.26 --name kubecost_kubecost --profile eks-us-west-2 | grep ProductUrl &quot;ProductUrl&quot;: &quot;https://aws.amazon.com/marketplace/pp?sku=753cea16-f450-4cfa-93eb-f55dcde11e91&quot;","summary":"摘要 本文介绍在EKS集群中安装 Amazon VPC CNI的过程 参考资料： Amazon EKS用户指南 Kubernetes 文档","date_published":"2023-07-07T13:30:05.000Z","tags":["技术","aws","eks","java"]},{"id":"https://blog.hanqunfeng.com/2023/07/07/aws-eks03-oidc/","url":"https://blog.hanqunfeng.com/2023/07/07/aws-eks03-oidc/","title":"AWS-EKS-03--创建 IAM OIDC 身份提供商","content_html":"<!--\n **加粗**\n *斜体*\n ***加粗并斜体***\n ~~删除线~~\n ==突出显示==\n `突出显示(推荐)`\n ++下划线++\n ~下标~\n ^上标^\n 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.\n 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600)\n\n +++ **点击折叠**\n 这是被隐藏的内容\n +++\n\n::: tips success warning danger\n这里是容器内的内容\n:::\n\n% note info % success warning danger\n这里是容器内的内容\n% endnote %\n\n -->\n<h2 id=\"摘要\">摘要</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>本文介绍为EKS集群创建 IAM OIDC 身份提供商</p>\n</li>\n<li class=\"lvl-2\">\n<p>参考资料：</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\"><a href=\"https://docs.aws.amazon.com/zh_cn/eks/latest/userguide\">Amazon EKS用户指南</a></li>\n<li class=\"lvl-6\"><a href=\"https://kubernetes.io/zh-cn/docs/home/\">Kubernetes 文档</a></li>\n</ul>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"为集群创建-IAM-OIDC-身份提供商\">为集群创建 IAM OIDC 身份提供商</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>要使用某些 Amazon EKS 附加组件，或启用个别 Kubernetes 工作负载以具有特定 AWS Identity and Access Management（IAM）权限，请为集群创建 IAM OpenID Connect（OIDC）提供商。</p>\n</li>\n<li class=\"lvl-2\">\n<p>只需为集群创建一次 IAM OIDC 提供商。</p>\n</li>\n<li class=\"lvl-2\">\n<p>确定您的账户中是否已存在具有您的集群 ID 的 IAM OIDC 提供商</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 确定集群是否拥有现有 IAM OIDC 提供商。检索集群的 OIDC 提供商 ID 并将其存储在变量中</span></span><br><span class=\"line\">$ oidc_id=$(aws eks describe-cluster --name eks-lexing --profile eks-us-west-2 --query <span class=\"string\">&quot;cluster.identity.oidc.issuer&quot;</span> --output text | <span class=\"built_in\">cut</span> -d <span class=\"string\">&#x27;/&#x27;</span> -f 5)</span><br><span class=\"line\"><span class=\"comment\"># 如果下面的命令返回了输出，则表示您的集群已经有 IAM OIDC 提供商，您可以跳过下一步。如果没有返回输出，则您必须为集群创建 IAM OIDC 提供商。</span></span><br><span class=\"line\">$ aws iam --profile eks-us-west-2 list-open-id-connect-providers | grep <span class=\"variable\">$oidc_id</span> | <span class=\"built_in\">cut</span> -d <span class=\"string\">&quot;/&quot;</span> -f4</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>使用以下命令为您的集群创建 IAM OIDC 身份提供商</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ eksctl utils associate-iam-oidc-provider --cluster eks-lexing --profile eks-us-west-2 --approve</span><br><span class=\"line\">2023-06-28 15:38:20 [ℹ]  will create IAM Open ID Connect provider <span class=\"keyword\">for</span> cluster <span class=\"string\">&quot;eks-lexing&quot;</span> <span class=\"keyword\">in</span> <span class=\"string\">&quot;us-west-2&quot;</span></span><br><span class=\"line\">2023-06-28 15:38:21 [✔]  created IAM Open ID Connect provider <span class=\"keyword\">for</span> cluster <span class=\"string\">&quot;eks-lexing&quot;</span> <span class=\"keyword\">in</span> <span class=\"string\">&quot;us-west-2&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看集群的 OIDC 提供商 URL，如果该命令返回为空，则说明尚未创建IAM OIDC 身份提供商</span></span><br><span class=\"line\">$ aws eks describe-cluster --name eks-lexing --query <span class=\"string\">&quot;cluster.identity.oidc.issuer&quot;</span> --output text --profile eks-us-west-2</span><br><span class=\"line\">https://oidc.eks.us-west-2.amazonaws.com/id/1029FF88CB8725555A1CC65D44191A56</span><br><span class=\"line\"></span><br><span class=\"line\">$ aws iam --profile eks-us-west-2 list-open-id-connect-providers | grep <span class=\"variable\">$oidc_id</span> | <span class=\"built_in\">cut</span> -d <span class=\"string\">&quot;/&quot;</span> -f4</span><br><span class=\"line\">1029FF88CB8725555A1CC65D44191A56<span class=\"string\">&quot;</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"查看OIDC元数据\">查看OIDC元数据</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>在集群的 OIDC 提供商 URL后面加上<code>/.well-known/openid-configuration</code></p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ curl https://oidc.eks.us-west-2.amazonaws.com/id/1029FF88CB8725555A1CC65D44191A56/.well-known/openid-configuration -s| python -m json.tool</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;authorization_endpoint&quot;</span>: <span class=\"string\">&quot;urn:kubernetes:programmatic_authorization&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;claims_supported&quot;</span>: [</span><br><span class=\"line\">        <span class=\"string\">&quot;sub&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;iss&quot;</span></span><br><span class=\"line\">    ],</span><br><span class=\"line\">    <span class=\"string\">&quot;id_token_signing_alg_values_supported&quot;</span>: [</span><br><span class=\"line\">        <span class=\"string\">&quot;RS256&quot;</span></span><br><span class=\"line\">    ],</span><br><span class=\"line\">    <span class=\"string\">&quot;issuer&quot;</span>: <span class=\"string\">&quot;https://oidc.eks.us-west-2.amazonaws.com/id/1029FF88CB8725555A1CC65D44191A56&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;jwks_uri&quot;</span>: <span class=\"string\">&quot;https://oidc.eks.us-west-2.amazonaws.com/id/1029FF88CB8725555A1CC65D44191A56/keys&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;response_types_supported&quot;</span>: [</span><br><span class=\"line\">        <span class=\"string\">&quot;id_token&quot;</span></span><br><span class=\"line\">    ],</span><br><span class=\"line\">    <span class=\"string\">&quot;subject_types_supported&quot;</span>: [</span><br><span class=\"line\">        <span class=\"string\">&quot;public&quot;</span></span><br><span class=\"line\">    ]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>然后查看<code>jwks_uri</code>中的url，这里的keys就是 IAM 用来验证 EKS service account 发送过来的 ID_token 是否有效的。</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl https://oidc.eks.us-west-2.amazonaws.com/id/1029FF88CB8725555A1CC65D44191A56/keys -s | python -m json.tool</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;keys&quot;</span>: [</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;alg&quot;</span>: <span class=\"string\">&quot;RS256&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;e&quot;</span>: <span class=\"string\">&quot;AQAB&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;kid&quot;</span>: <span class=\"string\">&quot;4e49f2d2c6c8550c55556b01637a93a8a4f941e5&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;kty&quot;</span>: <span class=\"string\">&quot;RSA&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;n&quot;</span>: <span class=\"string\">&quot;rEKprAR5nRAHfulQyyI9unXUNpczPCKZO8hXVuTiKrwlzdI7pETs6g0hWQaKe96n4p-KERF-dc-KajboMqrCfsff7boVJdnA9k8CljwKvt-5ILyXe07ASZQkkbDgpY30GNvMB7tbhiwkaNjuBzrLsO2Ipom5rzlK3i6rjHxp3O94BgMbMMt4trvWtJ9vmhWILihkl_e8--5JOOzjjeNcrNoK_o5LxbHSetaALoGAk-XbCmUeFDWvLQ&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;use&quot;</span>: <span class=\"string\">&quot;sig&quot;</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;alg&quot;</span>: <span class=\"string\">&quot;RS256&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;e&quot;</span>: <span class=\"string\">&quot;AQAB&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;kid&quot;</span>: <span class=\"string\">&quot;831cd2c5a14af3ff3ee5555ab1edf6dc7d7fb54d&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;kty&quot;</span>: <span class=\"string\">&quot;RSA&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;n&quot;</span>: <span class=\"string\">&quot;xdlnMmc1lUGyVlt58621Arf-2Ytxxe5HCiBguYe1Y4DYvfxTzknH3x07Q1sMQLNGHV_4d-bT29ufhAnht6AaLcuxtxaonEcMArh95bnuau6-GFMe06XaBYlMDoTcf_czTGdI4On7veJtMpSsNlHNj507Jn6mcH8TGHIl6qRwj9NZSaoADrkDO87O-w71l1c2a3m0us1vWir0QJdZ3J2al4k1Qm7KZT-dN9rs2LquQS0s6MTX-VdQLFb&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;use&quot;</span>: <span class=\"string\">&quot;sig&quot;</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;alg&quot;</span>: <span class=\"string\">&quot;RS256&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;e&quot;</span>: <span class=\"string\">&quot;AQAB&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;kid&quot;</span>: <span class=\"string\">&quot;eba5269e0fedd9431af2755550dd09f85bec7ad0&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;kty&quot;</span>: <span class=\"string\">&quot;RSA&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;n&quot;</span>: <span class=\"string\">&quot;qzfrIdEsOebdO243KkkGOl8r1rXiErQXwjK0RspvrX6roV6uJg6gBT0qBN7nM1J92WNVNte-3UhcBfm_hdBHRfib8zN_AvMNZ04Yc76hri7xTqa1iHFLl8823YEBnP_FSM97rdzsz_wCNkBM8bzsD-Cg4KMqrrY_qzFFymBRHPklBLyJudJN1zv8_dCXbDzBKtQo8UklM3MuSLsIf1TZGDbpemEpvNO-mu9UDVEccw0oeMPPKx6K_br&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;use&quot;</span>: <span class=\"string\">&quot;sig&quot;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    ]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>","content_text":"摘要 本文介绍为EKS集群创建 IAM OIDC 身份提供商 参考资料： Amazon EKS用户指南 Kubernetes 文档 为集群创建 IAM OIDC 身份提供商 要使用某些 Amazon EKS 附加组件，或启用个别 Kubernetes 工作负载以具有特定 AWS Identity and Access Management（IAM）权限，请为集群创建 IAM OpenID Connect（OIDC）提供商。 只需为集群创建一次 IAM OIDC 提供商。 确定您的账户中是否已存在具有您的集群 ID 的 IAM OIDC 提供商 1234# 确定集群是否拥有现有 IAM OIDC 提供商。检索集群的 OIDC 提供商 ID 并将其存储在变量中$ oidc_id=$(aws eks describe-cluster --name eks-lexing --profile eks-us-west-2 --query &quot;cluster.identity.oidc.issuer&quot; --output text | cut -d &#x27;/&#x27; -f 5)# 如果下面的命令返回了输出，则表示您的集群已经有 IAM OIDC 提供商，您可以跳过下一步。如果没有返回输出，则您必须为集群创建 IAM OIDC 提供商。$ aws iam --profile eks-us-west-2 list-open-id-connect-providers | grep $oidc_id | cut -d &quot;/&quot; -f4 使用以下命令为您的集群创建 IAM OIDC 身份提供商 12345678910$ eksctl utils associate-iam-oidc-provider --cluster eks-lexing --profile eks-us-west-2 --approve2023-06-28 15:38:20 [ℹ] will create IAM Open ID Connect provider for cluster &quot;eks-lexing&quot; in &quot;us-west-2&quot;2023-06-28 15:38:21 [✔] created IAM Open ID Connect provider for cluster &quot;eks-lexing&quot; in &quot;us-west-2&quot;# 查看集群的 OIDC 提供商 URL，如果该命令返回为空，则说明尚未创建IAM OIDC 身份提供商$ aws eks describe-cluster --name eks-lexing --query &quot;cluster.identity.oidc.issuer&quot; --output text --profile eks-us-west-2https://oidc.eks.us-west-2.amazonaws.com/id/1029FF88CB8725555A1CC65D44191A56$ aws iam --profile eks-us-west-2 list-open-id-connect-providers | grep $oidc_id | cut -d &quot;/&quot; -f41029FF88CB8725555A1CC65D44191A56&quot; 查看OIDC元数据 在集群的 OIDC 提供商 URL后面加上/.well-known/openid-configuration 12345678910111213141516171819$ curl https://oidc.eks.us-west-2.amazonaws.com/id/1029FF88CB8725555A1CC65D44191A56/.well-known/openid-configuration -s| python -m json.tool&#123; &quot;authorization_endpoint&quot;: &quot;urn:kubernetes:programmatic_authorization&quot;, &quot;claims_supported&quot;: [ &quot;sub&quot;, &quot;iss&quot; ], &quot;id_token_signing_alg_values_supported&quot;: [ &quot;RS256&quot; ], &quot;issuer&quot;: &quot;https://oidc.eks.us-west-2.amazonaws.com/id/1029FF88CB8725555A1CC65D44191A56&quot;, &quot;jwks_uri&quot;: &quot;https://oidc.eks.us-west-2.amazonaws.com/id/1029FF88CB8725555A1CC65D44191A56/keys&quot;, &quot;response_types_supported&quot;: [ &quot;id_token&quot; ], &quot;subject_types_supported&quot;: [ &quot;public&quot; ]&#125; 然后查看jwks_uri中的url，这里的keys就是 IAM 用来验证 EKS service account 发送过来的 ID_token 是否有效的。 1234567891011121314151617181920212223242526272829curl https://oidc.eks.us-west-2.amazonaws.com/id/1029FF88CB8725555A1CC65D44191A56/keys -s | python -m json.tool&#123; &quot;keys&quot;: [ &#123; &quot;alg&quot;: &quot;RS256&quot;, &quot;e&quot;: &quot;AQAB&quot;, &quot;kid&quot;: &quot;4e49f2d2c6c8550c55556b01637a93a8a4f941e5&quot;, &quot;kty&quot;: &quot;RSA&quot;, &quot;n&quot;: &quot;rEKprAR5nRAHfulQyyI9unXUNpczPCKZO8hXVuTiKrwlzdI7pETs6g0hWQaKe96n4p-KERF-dc-KajboMqrCfsff7boVJdnA9k8CljwKvt-5ILyXe07ASZQkkbDgpY30GNvMB7tbhiwkaNjuBzrLsO2Ipom5rzlK3i6rjHxp3O94BgMbMMt4trvWtJ9vmhWILihkl_e8--5JOOzjjeNcrNoK_o5LxbHSetaALoGAk-XbCmUeFDWvLQ&quot;, &quot;use&quot;: &quot;sig&quot; &#125;, &#123; &quot;alg&quot;: &quot;RS256&quot;, &quot;e&quot;: &quot;AQAB&quot;, &quot;kid&quot;: &quot;831cd2c5a14af3ff3ee5555ab1edf6dc7d7fb54d&quot;, &quot;kty&quot;: &quot;RSA&quot;, &quot;n&quot;: &quot;xdlnMmc1lUGyVlt58621Arf-2Ytxxe5HCiBguYe1Y4DYvfxTzknH3x07Q1sMQLNGHV_4d-bT29ufhAnht6AaLcuxtxaonEcMArh95bnuau6-GFMe06XaBYlMDoTcf_czTGdI4On7veJtMpSsNlHNj507Jn6mcH8TGHIl6qRwj9NZSaoADrkDO87O-w71l1c2a3m0us1vWir0QJdZ3J2al4k1Qm7KZT-dN9rs2LquQS0s6MTX-VdQLFb&quot;, &quot;use&quot;: &quot;sig&quot; &#125;, &#123; &quot;alg&quot;: &quot;RS256&quot;, &quot;e&quot;: &quot;AQAB&quot;, &quot;kid&quot;: &quot;eba5269e0fedd9431af2755550dd09f85bec7ad0&quot;, &quot;kty&quot;: &quot;RSA&quot;, &quot;n&quot;: &quot;qzfrIdEsOebdO243KkkGOl8r1rXiErQXwjK0RspvrX6roV6uJg6gBT0qBN7nM1J92WNVNte-3UhcBfm_hdBHRfib8zN_AvMNZ04Yc76hri7xTqa1iHFLl8823YEBnP_FSM97rdzsz_wCNkBM8bzsD-Cg4KMqrrY_qzFFymBRHPklBLyJudJN1zv8_dCXbDzBKtQo8UklM3MuSLsIf1TZGDbpemEpvNO-mu9UDVEccw0oeMPPKx6K_br&quot;, &quot;use&quot;: &quot;sig&quot; &#125; ]&#125;","summary":"摘要 本文介绍为EKS集群创建 IAM OIDC 身份提供商 参考资料： Amazon EKS用户指南 Kubernetes 文档","date_published":"2023-07-07T12:30:05.000Z","tags":["技术","aws","eks","java"]},{"id":"https://blog.hanqunfeng.com/2023/07/06/aws-eks02-create-eks/","url":"https://blog.hanqunfeng.com/2023/07/06/aws-eks02-create-eks/","title":"AWS-EKS-02--创建集群","content_html":"<!--\n **加粗**\n *斜体*\n ***加粗并斜体***\n ~~删除线~~\n ==突出显示==\n `突出显示(推荐)`\n ++下划线++\n ~下标~\n ^上标^\n 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.\n 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600)\n\n +++ **点击折叠**\n 这是被隐藏的内容\n +++\n\n::: tips success warning danger\n这里是容器内的内容\n:::\n\n% note info % success warning danger\n这里是容器内的内容\n% endnote %\n\n -->\n<h2 id=\"摘要\">摘要</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>本文介绍在AWS中创建EKS集群的过程</p>\n</li>\n<li class=\"lvl-2\">\n<p>参考资料：</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\"><a href=\"https://docs.aws.amazon.com/zh_cn/eks/latest/userguide\">Amazon EKS用户指南</a></li>\n<li class=\"lvl-6\"><a href=\"https://kubernetes.io/zh-cn/docs/home/\">Kubernetes 文档</a></li>\n</ul>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"创建eks集群\">创建eks集群</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>使用<code>eksctl</code><a href=\"https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/create-cluster.html\">创建集群</a>，当前默认安装k8s-1.25，如果要安装其它<a href=\"https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/kubernetes-versions.html\">EKS支持的k8s版本</a>，比如要安装1.26，则需要加上<code>--version 1.26</code></p>\n</li>\n<li class=\"lvl-2\">\n<p>如下命令会创建新的VPC，并基于该VPC创建一个新的eks集群，默认创建2个工作节点</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 当前默认是安装k8s-1.25，安装过程大约15分钟，</span></span><br><span class=\"line\">$ eksctl create cluster --name eks-lexing  --profile eks-us-west-2</span><br><span class=\"line\">2023-06-27 16:49:07 [ℹ]  eksctl version 0.146.0</span><br><span class=\"line\">2023-06-27 16:49:07 [ℹ]  using region us-west-2</span><br><span class=\"line\">2023-06-27 16:49:07 [ℹ]  setting availability zones to [us-west-2a us-west-2b us-west-2d]</span><br><span class=\"line\">2023-06-27 16:49:08 [ℹ]  subnets <span class=\"keyword\">for</span> us-west-2a - public:192.168.0.0/19 private:192.168.96.0/19</span><br><span class=\"line\">2023-06-27 16:49:08 [ℹ]  subnets <span class=\"keyword\">for</span> us-west-2b - public:192.168.32.0/19 private:192.168.128.0/19</span><br><span class=\"line\">2023-06-27 16:49:08 [ℹ]  subnets <span class=\"keyword\">for</span> us-west-2d - public:192.168.64.0/19 private:192.168.160.0/19</span><br><span class=\"line\">2023-06-27 16:49:08 [ℹ]  nodegroup <span class=\"string\">&quot;ng-4d9024eb&quot;</span> will use <span class=\"string\">&quot;&quot;</span> [AmazonLinux2/1.25]</span><br><span class=\"line\">2023-06-27 16:49:08 [ℹ]  using Kubernetes version 1.25</span><br><span class=\"line\">2023-06-27 16:49:08 [ℹ]  creating EKS cluster <span class=\"string\">&quot;eks-lexing&quot;</span> <span class=\"keyword\">in</span> <span class=\"string\">&quot;us-west-2&quot;</span> region with managed nodes</span><br><span class=\"line\">2023-06-27 16:49:08 [ℹ]  will create 2 separate CloudFormation stacks <span class=\"keyword\">for</span> cluster itself and the initial managed nodegroup</span><br><span class=\"line\">2023-06-27 16:49:08 [ℹ]  <span class=\"keyword\">if</span> you encounter any issues, check CloudFormation console or try <span class=\"string\">&#x27;eksctl utils describe-stacks --region=us-west-2 --cluster=eks-lexing&#x27;</span></span><br><span class=\"line\">2023-06-27 16:49:08 [ℹ]  Kubernetes API endpoint access will use default of &#123;publicAccess=<span class=\"literal\">true</span>, privateAccess=<span class=\"literal\">false</span>&#125; <span class=\"keyword\">for</span> cluster <span class=\"string\">&quot;eks-lexing&quot;</span> <span class=\"keyword\">in</span> <span class=\"string\">&quot;us-west-2&quot;</span></span><br><span class=\"line\">2023-06-27 16:49:08 [ℹ]  CloudWatch logging will not be enabled <span class=\"keyword\">for</span> cluster <span class=\"string\">&quot;eks-lexing&quot;</span> <span class=\"keyword\">in</span> <span class=\"string\">&quot;us-west-2&quot;</span></span><br><span class=\"line\">2023-06-27 16:49:08 [ℹ]  you can <span class=\"built_in\">enable</span> it with <span class=\"string\">&#x27;eksctl utils update-cluster-logging --enable-types=&#123;SPECIFY-YOUR-LOG-TYPES-HERE (e.g. all)&#125; --region=us-west-2 --cluster=eks-lexing&#x27;</span></span><br><span class=\"line\">2023-06-27 16:49:08 [ℹ]</span><br><span class=\"line\">2 sequential tasks: &#123; create cluster control plane <span class=\"string\">&quot;eks-lexing&quot;</span>,</span><br><span class=\"line\">    2 sequential sub-tasks: &#123;</span><br><span class=\"line\">        <span class=\"built_in\">wait</span> <span class=\"keyword\">for</span> control plane to become ready,</span><br><span class=\"line\">        create managed nodegroup <span class=\"string\">&quot;ng-4d9024eb&quot;</span>,</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">2023-06-27 16:49:08 [ℹ]  building cluster stack <span class=\"string\">&quot;eksctl-eks-lexing-cluster&quot;</span></span><br><span class=\"line\">2023-06-27 16:49:09 [ℹ]  deploying stack <span class=\"string\">&quot;eksctl-eks-lexing-cluster&quot;</span></span><br><span class=\"line\">2023-06-27 16:49:39 [ℹ]  waiting <span class=\"keyword\">for</span> CloudFormation stack <span class=\"string\">&quot;eksctl-eks-lexing-cluster&quot;</span></span><br><span class=\"line\">2023-06-27 16:50:09 [ℹ]  waiting <span class=\"keyword\">for</span> CloudFormation stack <span class=\"string\">&quot;eksctl-eks-lexing-cluster&quot;</span></span><br><span class=\"line\">2023-06-27 16:51:09 [ℹ]  waiting <span class=\"keyword\">for</span> CloudFormation stack <span class=\"string\">&quot;eksctl-eks-lexing-cluster&quot;</span></span><br><span class=\"line\">2023-06-27 16:52:09 [ℹ]  waiting <span class=\"keyword\">for</span> CloudFormation stack <span class=\"string\">&quot;eksctl-eks-lexing-cluster&quot;</span></span><br><span class=\"line\">2023-06-27 16:53:09 [ℹ]  waiting <span class=\"keyword\">for</span> CloudFormation stack <span class=\"string\">&quot;eksctl-eks-lexing-cluster&quot;</span></span><br><span class=\"line\">2023-06-27 16:54:09 [ℹ]  waiting <span class=\"keyword\">for</span> CloudFormation stack <span class=\"string\">&quot;eksctl-eks-lexing-cluster&quot;</span></span><br><span class=\"line\">2023-06-27 16:55:09 [ℹ]  waiting <span class=\"keyword\">for</span> CloudFormation stack <span class=\"string\">&quot;eksctl-eks-lexing-cluster&quot;</span></span><br><span class=\"line\">2023-06-27 16:56:10 [ℹ]  waiting <span class=\"keyword\">for</span> CloudFormation stack <span class=\"string\">&quot;eksctl-eks-lexing-cluster&quot;</span></span><br><span class=\"line\">2023-06-27 16:57:10 [ℹ]  waiting <span class=\"keyword\">for</span> CloudFormation stack <span class=\"string\">&quot;eksctl-eks-lexing-cluster&quot;</span></span><br><span class=\"line\">2023-06-27 16:58:10 [ℹ]  waiting <span class=\"keyword\">for</span> CloudFormation stack <span class=\"string\">&quot;eksctl-eks-lexing-cluster&quot;</span></span><br><span class=\"line\">2023-06-27 17:00:15 [ℹ]  building managed nodegroup stack <span class=\"string\">&quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;</span></span><br><span class=\"line\">2023-06-27 17:00:16 [ℹ]  deploying stack <span class=\"string\">&quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;</span></span><br><span class=\"line\">2023-06-27 17:00:16 [ℹ]  waiting <span class=\"keyword\">for</span> CloudFormation stack <span class=\"string\">&quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;</span></span><br><span class=\"line\">2023-06-27 17:00:46 [ℹ]  waiting <span class=\"keyword\">for</span> CloudFormation stack <span class=\"string\">&quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;</span></span><br><span class=\"line\">2023-06-27 17:01:25 [ℹ]  waiting <span class=\"keyword\">for</span> CloudFormation stack <span class=\"string\">&quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;</span></span><br><span class=\"line\">2023-06-27 17:03:16 [ℹ]  waiting <span class=\"keyword\">for</span> CloudFormation stack <span class=\"string\">&quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;</span></span><br><span class=\"line\">2023-06-27 17:03:16 [ℹ]  waiting <span class=\"keyword\">for</span> the control plane to become ready</span><br><span class=\"line\">2023-06-27 17:03:16 [✔]  saved kubeconfig as <span class=\"string\">&quot;/Users/hanqf/.kube/config&quot;</span></span><br><span class=\"line\">2023-06-27 17:03:16 [ℹ]  no tasks</span><br><span class=\"line\">2023-06-27 17:03:16 [✔]  all EKS cluster resources <span class=\"keyword\">for</span> <span class=\"string\">&quot;eks-lexing&quot;</span> have been created</span><br><span class=\"line\">2023-06-27 17:03:17 [ℹ]  nodegroup <span class=\"string\">&quot;ng-4d9024eb&quot;</span> has 2 node(s)</span><br><span class=\"line\">2023-06-27 17:03:17 [ℹ]  node <span class=\"string\">&quot;ip-192-168-16-155.us-west-2.compute.internal&quot;</span> is ready</span><br><span class=\"line\">2023-06-27 17:03:17 [ℹ]  node <span class=\"string\">&quot;ip-192-168-48-14.us-west-2.compute.internal&quot;</span> is ready</span><br><span class=\"line\">2023-06-27 17:03:17 [ℹ]  waiting <span class=\"keyword\">for</span> at least 2 node(s) to become ready <span class=\"keyword\">in</span> <span class=\"string\">&quot;ng-4d9024eb&quot;</span></span><br><span class=\"line\">2023-06-27 17:03:17 [ℹ]  nodegroup <span class=\"string\">&quot;ng-4d9024eb&quot;</span> has 2 node(s)</span><br><span class=\"line\">2023-06-27 17:03:17 [ℹ]  node <span class=\"string\">&quot;ip-192-168-16-155.us-west-2.compute.internal&quot;</span> is ready</span><br><span class=\"line\">2023-06-27 17:03:17 [ℹ]  node <span class=\"string\">&quot;ip-192-168-48-14.us-west-2.compute.internal&quot;</span> is ready</span><br><span class=\"line\">2023-06-27 17:03:19 [ℹ]  kubectl <span class=\"built_in\">command</span> should work with <span class=\"string\">&quot;/Users/hanqf/.kube/config&quot;</span>, try <span class=\"string\">&#x27;kubectl get nodes&#x27;</span></span><br><span class=\"line\">2023-06-27 17:03:19 [✔]  EKS cluster <span class=\"string\">&quot;eks-lexing&quot;</span> <span class=\"keyword\">in</span> <span class=\"string\">&quot;us-west-2&quot;</span> region is ready</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>eks集群创建成功后会在<code>~/.kube/config</code>文件中自动加上集群的配置信息</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">clusters:</span><br><span class=\"line\">- cluster:</span><br><span class=\"line\">    certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUMvakNDQWVhZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwcmRXSmwKY201bGRHVnpNQjRYRFRJek1EWXlPREEyTWpNeU1Wb1hEVE16TURZeU5UQTJNak15TVZvd0ZURVRNQkVHQTFVRQpBeE1LYTNWaVpYSnVaWFJsY3pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTXJVCk94RHJUTHR1lKeWUzUkQxQXFpeTdnUCtROApGdGNOSkNaUzJHSkV3d1hYcmZEK25YL0F1dFo2NVh0ZVR0KzdNZmdnQW1UVWNSaTM0cEhJcVhmN0R0eHY2VnhJCnVBUk9rbzhQRWIyNUpsYVRDRU9GWkRHeXJPdjlDMjE0ZEdudzJFRFV2QVJMR0E1bW5PN0EwanZlRG1zQWcrTzgKZGx3PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==</span><br><span class=\"line\">    server: https://1029FF88CB872B655555565D44191A56.gr7.us-west-2.eks.amazonaws.com</span><br><span class=\"line\">  name: eks-lexing.us-west-2.eksctl.io</span><br><span class=\"line\">contexts:</span><br><span class=\"line\">- context:</span><br><span class=\"line\">    cluster: eks-lexing.us-west-2.eksctl.io</span><br><span class=\"line\">    user: hanqunfeng@eks-lexing.us-west-2.eksctl.io</span><br><span class=\"line\">  name: hanqunfeng@eks-lexing.us-west-2.eksctl.io</span><br><span class=\"line\">current-context: hanqunfeng@eks-lexing.us-west-2.eksctl.io</span><br><span class=\"line\">kind: Config</span><br><span class=\"line\">preferences: &#123;&#125;</span><br><span class=\"line\"><span class=\"built_in\">users</span>:</span><br><span class=\"line\">- name: hanqunfeng@eks-lexing.us-west-2.eksctl.io</span><br><span class=\"line\">  user:</span><br><span class=\"line\">    <span class=\"built_in\">exec</span>:</span><br><span class=\"line\">      apiVersion: client.authentication.k8s.io/v1beta1</span><br><span class=\"line\">      args:</span><br><span class=\"line\">      - eks</span><br><span class=\"line\">      - get-token</span><br><span class=\"line\">      - --output</span><br><span class=\"line\">      - json</span><br><span class=\"line\">      - --cluster-name</span><br><span class=\"line\">      - eks-lexing</span><br><span class=\"line\">      - --region</span><br><span class=\"line\">      - us-west-2</span><br><span class=\"line\">      <span class=\"built_in\">command</span>: aws</span><br><span class=\"line\">      <span class=\"built_in\">env</span>:</span><br><span class=\"line\">      - name: AWS_STS_REGIONAL_ENDPOINTS</span><br><span class=\"line\">        value: regional</span><br><span class=\"line\">      - name: AWS_PROFILE</span><br><span class=\"line\">        value: eks-us-west-2</span><br><span class=\"line\">      interactiveMode: IfAvailable</span><br><span class=\"line\">      provideClusterInfo: <span class=\"literal\">false</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>~/.kube/config</code>文件说明</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\"><code>clusters</code> : 集群基本信息，可以配置多个，其包含<code>certificate-authority-data</code>–证书和<code>server</code>–API 服务器终端节点，这部分内容可以在aws控制台&quot;EKS–集群–eks-lexing&quot;中查看到。</li>\n<li class=\"lvl-6\"><code>users</code> : 用户认证信息，可以配置多个，这里可以看到是基于<code>aws</code>命令进行认证的。</li>\n<li class=\"lvl-6\"><code>contexts</code> : 上下文环境信息，这部分会将<code>clusters</code>与<code>users</code>进行一对一关联。</li>\n<li class=\"lvl-6\"><code>current-context</code> : 当前默认的集群上下文。</li>\n<li class=\"lvl-6\">文件内容编辑后立即生效。</li>\n</ul>\n</li>\n<li class=\"lvl-2\">\n<p>如果要在<code>~/.kube/config</code>中加入已经创建好的集群，可以通过如下命令实现，当然，手工编辑文件也可以。</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ aws eks update-kubeconfig --name eks-lexing  --profile eks-us-west-2</span><br><span class=\"line\"><span class=\"comment\"># 或者</span></span><br><span class=\"line\">$ <span class=\"built_in\">export</span> AWS_PROFILE=eks-us-west-2</span><br><span class=\"line\">$ aws eks update-kubeconfig --name eks-lexing</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>通过当前IAM帐号创建的eks，则只有该帐号有权限管理和查看，如果希望其它帐号也有权限，则需要进行授权，这个后面会介绍。</p>\n</li>\n<li class=\"lvl-2\">\n<p>验证是否可以访问集群</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看节点组信息</span></span><br><span class=\"line\">$ eksctl get nodegroup --cluster eks-lexing --profile eks-us-west-2</span><br><span class=\"line\">CLUSTER\t\tNODEGROUP\tSTATUS\tCREATED\t\t\tMIN SIZE\tMAX SIZE\tDESIRED CAPACITY\tINSTANCE TYPE\tIMAGE ID\tASG NAME\t\t\t\tTYPE</span><br><span class=\"line\">eks-lexing\tng-4d9024eb\tACTIVE\t2023-06-28T06:30:03Z\t2\t\t5\t\t2\t\t\tm5.large\tAL2_x86_64\teks-ng-4d9024eb-20c48058-e974-c6ec-786a-516c31131604\tmanaged</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看集群的命名空间，这里使用了kubectl的别名k</span></span><br><span class=\"line\">$ k get ns</span><br><span class=\"line\">NAME              STATUS   AGE</span><br><span class=\"line\">default           Active   11m</span><br><span class=\"line\">kube-node-lease   Active   11m</span><br><span class=\"line\">kube-public       Active   11m</span><br><span class=\"line\">kube-system       Active   11m</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>登录aws控制台，查看<code>us-west-2</code>下的<code>EC2</code>,<code>VPC</code>,<code>CloudFormation</code>,<code>EKS</code>等等，可以看到相应的资源已经创建完成。<br>\nEC2实例: 工作节点实例<br>\n<img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/eENw5L.png\" alt=\"\" width=\"1200\" height=\"300\"><br>\nEBS: 工作节点挂载的卷<br>\n<img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/MQx1yO.png\" alt=\"\" width=\"1200\" height=\"300\"><br>\nAuto Scaling 组: 节点组<br>\n<img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/KOusMS.png\" alt=\"\" width=\"900\" height=\"300\"><br>\n弹性IP:<br>\n<img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/EdMBgh.png\" alt=\"\" width=\"1200\" height=\"300\"><br>\n安全组：<br>\n<img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/N77sRk.png\" alt=\"\" width=\"1200\" height=\"400\"><br>\nVPC:<br>\n<img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/ucZYmM.png\" alt=\"\" width=\"1200\" height=\"800\"><br>\nEKS: 这里eks升级到1.26了，升级eks后面会介绍<br>\n<img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/pGZpve.png\" alt=\"\" width=\"1200\" height=\"800\"></p>\n</li>\n</ul>\n<div class=\"tips\">\n<p><em><strong>小贴士</strong></em><br>\n不要手工修改<code>EC2</code>下关于eks的Auto Scaling 组，如果要修改弹性伸缩，需要在<code>EKS</code>的工作节点组的配置中进行修改<br>\n<img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/PDOeyT.png\" alt=\"\" width=\"400\" height=\"400\"></p>\n</div>\n<h2 id=\"后续\">后续</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>上面我们就完成了通过命令行在新的VPC下创建全新eks集群的过程，其它创建方式详见<a href=\"https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/create-cluster.html\">AWS帮助文档</a>，但是这还没完，为了更好的使用aws为我们提供的资源和服务，我们还需要为这个eks集群做一些必要操作：</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">\n<a href=\"/2023/07/07/aws-eks03-oidc/\" title=\"AWS-EKS-03--创建 IAM OIDC 身份提供商\">创建 IAM OIDC 身份提供商</a>\n</li>\n<li class=\"lvl-6\">\n<a href=\"/2023/07/07/aws-eks04-vpc-cni/\" title=\"AWS-EKS-04--安装 Amazon VPC CNI\">配置 Amazon VPC CNI plugin for Kubernetes 将 IAM 角色用于服务账户</a>\n</li>\n<li class=\"lvl-6\">\n<a href=\"/2023/07/07/aws-eks05-ebs-csi/\" title=\"AWS-EKS-05--安装 Amazon EBS CSI 驱动程序\">安装 Amazon EBS CSI 驱动程序</a>\n</li>\n<li class=\"lvl-6\">\n<a href=\"/2023/07/07/aws-eks06-efs-csi/\" title=\"AWS-EKS-06--安装 Amazon EFS CSI 驱动程序\">安装 Amazon EFS CSI 驱动程序</a>\n</li>\n<li class=\"lvl-6\">\n<a href=\"/2023/07/07/aws-eks07-loadbalancer/\" title=\"AWS-EKS-07--安装 AWS Load Balancer Controller 附加组件\">安装 AWS Load Balancer Controller 附加组件</a>\n</li>\n<li class=\"lvl-6\">\n<a href=\"/2023/07/07/aws-eks11-metrics/\" title=\"AWS-EKS-11--安装 Kubernetes Metrics Server\">安装 Kubernetes Metrics Server</a>\n</li>\n<li class=\"lvl-6\">\n<a href=\"/2023/07/18/aws-eks18-autoscaler-cas/\" title=\"AWS-EKS-18--Autoscaling 之 Cluster Autoscaler(CAS)\">安装 Autoscaling 之 Cluster Autoscaler(CAS)</a>\n</li>\n</ul>\n</li>\n</ul>\n","content_text":"摘要 本文介绍在AWS中创建EKS集群的过程 参考资料： Amazon EKS用户指南 Kubernetes 文档 创建eks集群 使用eksctl创建集群，当前默认安装k8s-1.25，如果要安装其它EKS支持的k8s版本，比如要安装1.26，则需要加上--version 1.26 如下命令会创建新的VPC，并基于该VPC创建一个新的eks集群，默认创建2个工作节点 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354# 当前默认是安装k8s-1.25，安装过程大约15分钟，$ eksctl create cluster --name eks-lexing --profile eks-us-west-22023-06-27 16:49:07 [ℹ] eksctl version 0.146.02023-06-27 16:49:07 [ℹ] using region us-west-22023-06-27 16:49:07 [ℹ] setting availability zones to [us-west-2a us-west-2b us-west-2d]2023-06-27 16:49:08 [ℹ] subnets for us-west-2a - public:192.168.0.0/19 private:192.168.96.0/192023-06-27 16:49:08 [ℹ] subnets for us-west-2b - public:192.168.32.0/19 private:192.168.128.0/192023-06-27 16:49:08 [ℹ] subnets for us-west-2d - public:192.168.64.0/19 private:192.168.160.0/192023-06-27 16:49:08 [ℹ] nodegroup &quot;ng-4d9024eb&quot; will use &quot;&quot; [AmazonLinux2/1.25]2023-06-27 16:49:08 [ℹ] using Kubernetes version 1.252023-06-27 16:49:08 [ℹ] creating EKS cluster &quot;eks-lexing&quot; in &quot;us-west-2&quot; region with managed nodes2023-06-27 16:49:08 [ℹ] will create 2 separate CloudFormation stacks for cluster itself and the initial managed nodegroup2023-06-27 16:49:08 [ℹ] if you encounter any issues, check CloudFormation console or try &#x27;eksctl utils describe-stacks --region=us-west-2 --cluster=eks-lexing&#x27;2023-06-27 16:49:08 [ℹ] Kubernetes API endpoint access will use default of &#123;publicAccess=true, privateAccess=false&#125; for cluster &quot;eks-lexing&quot; in &quot;us-west-2&quot;2023-06-27 16:49:08 [ℹ] CloudWatch logging will not be enabled for cluster &quot;eks-lexing&quot; in &quot;us-west-2&quot;2023-06-27 16:49:08 [ℹ] you can enable it with &#x27;eksctl utils update-cluster-logging --enable-types=&#123;SPECIFY-YOUR-LOG-TYPES-HERE (e.g. all)&#125; --region=us-west-2 --cluster=eks-lexing&#x27;2023-06-27 16:49:08 [ℹ]2 sequential tasks: &#123; create cluster control plane &quot;eks-lexing&quot;, 2 sequential sub-tasks: &#123; wait for control plane to become ready, create managed nodegroup &quot;ng-4d9024eb&quot;, &#125;&#125;2023-06-27 16:49:08 [ℹ] building cluster stack &quot;eksctl-eks-lexing-cluster&quot;2023-06-27 16:49:09 [ℹ] deploying stack &quot;eksctl-eks-lexing-cluster&quot;2023-06-27 16:49:39 [ℹ] waiting for CloudFormation stack &quot;eksctl-eks-lexing-cluster&quot;2023-06-27 16:50:09 [ℹ] waiting for CloudFormation stack &quot;eksctl-eks-lexing-cluster&quot;2023-06-27 16:51:09 [ℹ] waiting for CloudFormation stack &quot;eksctl-eks-lexing-cluster&quot;2023-06-27 16:52:09 [ℹ] waiting for CloudFormation stack &quot;eksctl-eks-lexing-cluster&quot;2023-06-27 16:53:09 [ℹ] waiting for CloudFormation stack &quot;eksctl-eks-lexing-cluster&quot;2023-06-27 16:54:09 [ℹ] waiting for CloudFormation stack &quot;eksctl-eks-lexing-cluster&quot;2023-06-27 16:55:09 [ℹ] waiting for CloudFormation stack &quot;eksctl-eks-lexing-cluster&quot;2023-06-27 16:56:10 [ℹ] waiting for CloudFormation stack &quot;eksctl-eks-lexing-cluster&quot;2023-06-27 16:57:10 [ℹ] waiting for CloudFormation stack &quot;eksctl-eks-lexing-cluster&quot;2023-06-27 16:58:10 [ℹ] waiting for CloudFormation stack &quot;eksctl-eks-lexing-cluster&quot;2023-06-27 17:00:15 [ℹ] building managed nodegroup stack &quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;2023-06-27 17:00:16 [ℹ] deploying stack &quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;2023-06-27 17:00:16 [ℹ] waiting for CloudFormation stack &quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;2023-06-27 17:00:46 [ℹ] waiting for CloudFormation stack &quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;2023-06-27 17:01:25 [ℹ] waiting for CloudFormation stack &quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;2023-06-27 17:03:16 [ℹ] waiting for CloudFormation stack &quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;2023-06-27 17:03:16 [ℹ] waiting for the control plane to become ready2023-06-27 17:03:16 [✔] saved kubeconfig as &quot;/Users/hanqf/.kube/config&quot;2023-06-27 17:03:16 [ℹ] no tasks2023-06-27 17:03:16 [✔] all EKS cluster resources for &quot;eks-lexing&quot; have been created2023-06-27 17:03:17 [ℹ] nodegroup &quot;ng-4d9024eb&quot; has 2 node(s)2023-06-27 17:03:17 [ℹ] node &quot;ip-192-168-16-155.us-west-2.compute.internal&quot; is ready2023-06-27 17:03:17 [ℹ] node &quot;ip-192-168-48-14.us-west-2.compute.internal&quot; is ready2023-06-27 17:03:17 [ℹ] waiting for at least 2 node(s) to become ready in &quot;ng-4d9024eb&quot;2023-06-27 17:03:17 [ℹ] nodegroup &quot;ng-4d9024eb&quot; has 2 node(s)2023-06-27 17:03:17 [ℹ] node &quot;ip-192-168-16-155.us-west-2.compute.internal&quot; is ready2023-06-27 17:03:17 [ℹ] node &quot;ip-192-168-48-14.us-west-2.compute.internal&quot; is ready2023-06-27 17:03:19 [ℹ] kubectl command should work with &quot;/Users/hanqf/.kube/config&quot;, try &#x27;kubectl get nodes&#x27;2023-06-27 17:03:19 [✔] EKS cluster &quot;eks-lexing&quot; in &quot;us-west-2&quot; region is ready eks集群创建成功后会在~/.kube/config文件中自动加上集群的配置信息 123456789101112131415161718192021222324252627282930313233343536apiVersion: v1clusters:- cluster: certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUMvakNDQWVhZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwcmRXSmwKY201bGRHVnpNQjRYRFRJek1EWXlPREEyTWpNeU1Wb1hEVE16TURZeU5UQTJNak15TVZvd0ZURVRNQkVHQTFVRQpBeE1LYTNWaVpYSnVaWFJsY3pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTXJVCk94RHJUTHR1lKeWUzUkQxQXFpeTdnUCtROApGdGNOSkNaUzJHSkV3d1hYcmZEK25YL0F1dFo2NVh0ZVR0KzdNZmdnQW1UVWNSaTM0cEhJcVhmN0R0eHY2VnhJCnVBUk9rbzhQRWIyNUpsYVRDRU9GWkRHeXJPdjlDMjE0ZEdudzJFRFV2QVJMR0E1bW5PN0EwanZlRG1zQWcrTzgKZGx3PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg== server: https://1029FF88CB872B655555565D44191A56.gr7.us-west-2.eks.amazonaws.com name: eks-lexing.us-west-2.eksctl.iocontexts:- context: cluster: eks-lexing.us-west-2.eksctl.io user: hanqunfeng@eks-lexing.us-west-2.eksctl.io name: hanqunfeng@eks-lexing.us-west-2.eksctl.iocurrent-context: hanqunfeng@eks-lexing.us-west-2.eksctl.iokind: Configpreferences: &#123;&#125;users:- name: hanqunfeng@eks-lexing.us-west-2.eksctl.io user: exec: apiVersion: client.authentication.k8s.io/v1beta1 args: - eks - get-token - --output - json - --cluster-name - eks-lexing - --region - us-west-2 command: aws env: - name: AWS_STS_REGIONAL_ENDPOINTS value: regional - name: AWS_PROFILE value: eks-us-west-2 interactiveMode: IfAvailable provideClusterInfo: false ~/.kube/config文件说明 clusters : 集群基本信息，可以配置多个，其包含certificate-authority-data–证书和server–API 服务器终端节点，这部分内容可以在aws控制台&quot;EKS–集群–eks-lexing&quot;中查看到。 users : 用户认证信息，可以配置多个，这里可以看到是基于aws命令进行认证的。 contexts : 上下文环境信息，这部分会将clusters与users进行一对一关联。 current-context : 当前默认的集群上下文。 文件内容编辑后立即生效。 如果要在~/.kube/config中加入已经创建好的集群，可以通过如下命令实现，当然，手工编辑文件也可以。 1234$ aws eks update-kubeconfig --name eks-lexing --profile eks-us-west-2# 或者$ export AWS_PROFILE=eks-us-west-2$ aws eks update-kubeconfig --name eks-lexing 通过当前IAM帐号创建的eks，则只有该帐号有权限管理和查看，如果希望其它帐号也有权限，则需要进行授权，这个后面会介绍。 验证是否可以访问集群 123456789101112# 查看节点组信息$ eksctl get nodegroup --cluster eks-lexing --profile eks-us-west-2CLUSTER NODEGROUP STATUS CREATED MIN SIZE MAX SIZE DESIRED CAPACITY INSTANCE TYPE IMAGE ID ASG NAME TYPEeks-lexing ng-4d9024eb ACTIVE 2023-06-28T06:30:03Z 2 5 2 m5.large AL2_x86_64 eks-ng-4d9024eb-20c48058-e974-c6ec-786a-516c31131604 managed# 查看集群的命名空间，这里使用了kubectl的别名k$ k get nsNAME STATUS AGEdefault Active 11mkube-node-lease Active 11mkube-public Active 11mkube-system Active 11m 登录aws控制台，查看us-west-2下的EC2,VPC,CloudFormation,EKS等等，可以看到相应的资源已经创建完成。 EC2实例: 工作节点实例 EBS: 工作节点挂载的卷 Auto Scaling 组: 节点组 弹性IP: 安全组： VPC: EKS: 这里eks升级到1.26了，升级eks后面会介绍 小贴士 不要手工修改EC2下关于eks的Auto Scaling 组，如果要修改弹性伸缩，需要在EKS的工作节点组的配置中进行修改 后续 上面我们就完成了通过命令行在新的VPC下创建全新eks集群的过程，其它创建方式详见AWS帮助文档，但是这还没完，为了更好的使用aws为我们提供的资源和服务，我们还需要为这个eks集群做一些必要操作： 创建 IAM OIDC 身份提供商 配置 Amazon VPC CNI plugin for Kubernetes 将 IAM 角色用于服务账户 安装 Amazon EBS CSI 驱动程序 安装 Amazon EFS CSI 驱动程序 安装 AWS Load Balancer Controller 附加组件 安装 Kubernetes Metrics Server 安装 Autoscaling 之 Cluster Autoscaler(CAS)","summary":"摘要 本文介绍在AWS中创建EKS集群的过程 参考资料： Amazon EKS用户指南 Kubernetes 文档","date_published":"2023-07-06T15:30:05.000Z","tags":["技术","aws","eks","java"]},{"id":"https://blog.hanqunfeng.com/2023/07/06/aws-eks01-install-tool/","url":"https://blog.hanqunfeng.com/2023/07/06/aws-eks01-install-tool/","title":"AWS-EKS-01--命令行工具","content_html":"<!--\n **加粗**\n *斜体*\n ***加粗并斜体***\n ~~删除线~~\n ==突出显示==\n `突出显示(推荐)`\n ++下划线++\n ~下标~\n ^上标^\n 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.\n 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600)\n\n +++ **点击折叠**\n 这是被隐藏的内容\n +++\n\n::: tips success warning danger\n这里是容器内的内容\n:::\n\n% note info % success warning danger\n这里是容器内的内容\n% endnote %\n\n -->\n<h2 id=\"摘要\">摘要</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>本文介绍在AWS中创建EKS集群的过程中会使用到的命令行工具的安装方法</p>\n</li>\n<li class=\"lvl-2\">\n<p>参考资料：</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\"><a href=\"https://docs.aws.amazon.com/zh_cn/eks/latest/userguide\">Amazon EKS用户指南</a></li>\n<li class=\"lvl-6\"><a href=\"https://kubernetes.io/zh-cn/docs/home/\">Kubernetes 文档</a></li>\n</ul>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"安装命令行工具\">安装命令行工具</h2>\n<h3 id=\"AWS-CLI\">AWS CLI</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><a href=\"https://docs.aws.amazon.com/zh_cn/cli/latest/userguide/cli-chap-welcome.html\">AWS Command Line Interface (AWS CLI)</a> 是一种开源工具，让您能够在命令行 Shell 中使用命令与 AWS 服务进行交互。</p>\n</li>\n<li class=\"lvl-2\">\n<p>要使用 AWS CLI 访问 AWS 服务，您需要 AWS 账户 和 IAM 凭证。运行 AWS CLI 命令时，AWS CLI 需要有权访问这些 AWS 凭证。为了提高 AWS 账户的安全性，建议您不要使用根账户凭证。您应创建一个具有最低权限的用户来为将在 AWS 中运行的任务提供访问凭证。</p>\n</li>\n<li class=\"lvl-2\">\n<p>登录AWS控制台，在IAM里创建一个用户，为了方便对资源进行管理可以授予其管理员访问权限(AdministratorAccess)，并在其安全凭证中创建一个新的访问密钥。</p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://docs.aws.amazon.com/zh_cn/cli/latest/userguide/getting-started-install.html\">安装AWS CLI</a>，这里以mac为例</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ curl <span class=\"string\">&quot;https://awscli.amazonaws.com/AWSCLIV2.pkg&quot;</span> -o <span class=\"string\">&quot;AWSCLIV2.pkg&quot;</span></span><br><span class=\"line\">$ sudo installer -pkg AWSCLIV2.pkg -target /</span><br><span class=\"line\">$ <span class=\"built_in\">which</span> aws</span><br><span class=\"line\">/usr/local/bin/aws</span><br><span class=\"line\">$ aws --version</span><br><span class=\"line\">aws-cli/2.12.3 Python/3.11.4 Darwin/21.6.0 exe/x86_64 prompt/off</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>升级时重新执行上面的的安装过程即可</p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-completion.html\">命令提示补全</a>，以zsh为例，在<code>~/.zshrc</code>中添加如下内容，为了立即生效可以执行<code>source ~/.zshrc</code></p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">autoload</span> bashcompinit &amp;&amp; bashcompinit</span><br><span class=\"line\"><span class=\"built_in\">autoload</span> -Uz compinit &amp;&amp; compinit</span><br><span class=\"line\">complete -C <span class=\"string\">&#x27;/usr/local/bin/aws_completer&#x27;</span> aws</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>配置文件在<code>~/.aws</code>目录下，分为 <code>config</code> 和 <code>credentials</code>，可以设置多份凭证，设置时可以直接编辑对应的配置文件，也可以通过如下命令设置</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 默认default，这里配置上用户的访问密钥</span></span><br><span class=\"line\">$ aws configure</span><br><span class=\"line\">AWS Access Key ID [None]: AKIAIOSFODNN7EXAMPLE</span><br><span class=\"line\">AWS Secret Access Key [None]: wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY</span><br><span class=\"line\">Default region name [None]: us-west-1</span><br><span class=\"line\">Default output format [None]: json</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 指定profile，后面所有命令中涉及到凭证的部分都使用该profile</span></span><br><span class=\"line\">$ aws configure --profile eks-us-west-2</span><br><span class=\"line\">AWS Access Key ID [None]: AKIAIOSFODNN7EXAMPLE</span><br><span class=\"line\">AWS Secret Access Key [None]: wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY</span><br><span class=\"line\">Default region name [None]: us-west-2</span><br><span class=\"line\">Default output format [None]: json</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看配置</span></span><br><span class=\"line\">$ <span class=\"built_in\">cat</span> ~/.aws/config</span><br><span class=\"line\">[default]</span><br><span class=\"line\">region = us-west-1</span><br><span class=\"line\">output = json</span><br><span class=\"line\">[profile eks-us-west-2]</span><br><span class=\"line\">region = us-west-2</span><br><span class=\"line\">output = json</span><br><span class=\"line\"></span><br><span class=\"line\">$ <span class=\"built_in\">cat</span> ~/.aws/credentials</span><br><span class=\"line\">[default]</span><br><span class=\"line\">aws_access_key_id = AKIAIOSFODNN7EXAMPLE</span><br><span class=\"line\">aws_secret_access_key = wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY</span><br><span class=\"line\">[eks-us-west-2]</span><br><span class=\"line\">aws_access_key_id = AKIAIOSFODNN7EXAMPLE</span><br><span class=\"line\">aws_secret_access_key = wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看所有profile</span></span><br><span class=\"line\">$ aws configure list-profiles</span><br><span class=\"line\">default</span><br><span class=\"line\">eks-us-west-2</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看指定的profile的信息</span></span><br><span class=\"line\">$ aws configure list --profile eks-us-west-2</span><br><span class=\"line\">      Name                    Value             Type    Location</span><br><span class=\"line\">      ----                    -----             ----    --------</span><br><span class=\"line\">   profile               eks-us-west-2           manual    --profile</span><br><span class=\"line\">access_key     ****************IP6L shared-credentials-file</span><br><span class=\"line\">secret_key     ****************OIQU shared-credentials-file</span><br><span class=\"line\">    region                us-west-2      config-file    ~/.aws/config</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看与profile对应的用户信息</span></span><br><span class=\"line\">$ aws sts get-caller-identity --profile eks-us-west-2</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;UserId&quot;</span>: <span class=\"string\">&quot;AIDA55DP3G4GIDWF2GNIR&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;Account&quot;</span>: <span class=\"string\">&quot;743263909655&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;Arn&quot;</span>: <span class=\"string\">&quot;arn:aws:iam::743263909655:user/hanqunfeng&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>使用aws命令时，如果不指定<code>--profile</code>，则默认使用<code>default</code>对应的认证信息，也可以通过环境变量指定要使用的profile</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ <span class=\"built_in\">export</span> AWS_PROFILE=eks-us-west-2</span><br></pre></td></tr></table></figure>\n<h3 id=\"kubectl\">kubectl</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Kubectl 是一个命令行工具，用于与 Kubernetes API 服务器进行通信。这个命令非常重要，后面会有一节专门介绍。</p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/install-kubectl.html\">安装或更新 kubectl</a>，这里以mac为例</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 从 Amazon S3 为集群的 Kubernetes 版本下载二进制文件</span></span><br><span class=\"line\"><span class=\"comment\"># 这里下载Kubernetes 1.26</span></span><br><span class=\"line\">$ curl -O https://s3.us-west-2.amazonaws.com/amazon-eks/1.26.4/2023-05-11/bin/darwin/amd64/kubectl</span><br><span class=\"line\"><span class=\"comment\"># 授予执行权限</span></span><br><span class=\"line\">$ <span class=\"built_in\">chmod</span> +x ./kubectl</span><br><span class=\"line\"><span class=\"comment\"># 将命令复制到 $PATH 中</span></span><br><span class=\"line\">$ sudo <span class=\"built_in\">mv</span> ./kubectl /usr/local/bin/kubectl</span><br><span class=\"line\"><span class=\"comment\"># 查看kubectl版本，由于此时还没有配置k8s的server端，所以这里只查看client的的信息</span></span><br><span class=\"line\">$ kubectl version --client -o yaml</span><br><span class=\"line\"></span><br><span class=\"line\">clientVersion:</span><br><span class=\"line\">  buildDate: <span class=\"string\">&quot;2023-04-15T00:36:29Z&quot;</span></span><br><span class=\"line\">  compiler: gc</span><br><span class=\"line\">  gitCommit: 4a3479673cb6d9b63f1c69a67b57de30a4d9b781</span><br><span class=\"line\">  gitTreeState: clean</span><br><span class=\"line\">  gitVersion: v1.26.4-eks-0a21954</span><br><span class=\"line\">  goVersion: go1.19.8</span><br><span class=\"line\">  major: <span class=\"string\">&quot;1&quot;</span></span><br><span class=\"line\">  minor: 26+</span><br><span class=\"line\">  platform: darwin/amd64</span><br><span class=\"line\">kustomizeVersion: v4.5.7</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>升级时重新执行上面的的安装过程即可</p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://kubernetes.io/zh-cn/docs/tasks/tools/install-kubectl-macos/\">命令提示补全和别名设置</a>，以zsh为例，在<code>~/.zshrc</code>中添加如下内容，为了立即生效可以执行<code>source ~/.zshrc</code></p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># k8s client kubectl</span></span><br><span class=\"line\"><span class=\"built_in\">source</span> &lt;(kubectl completion zsh)</span><br><span class=\"line\"><span class=\"built_in\">alias</span> k=kubectl</span><br><span class=\"line\"><span class=\"comment\"># change namespace</span></span><br><span class=\"line\"><span class=\"built_in\">alias</span> kn=<span class=\"string\">&quot;k config set-context --current --namespace&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Delete Now</span></span><br><span class=\"line\"><span class=\"built_in\">alias</span> kdp=<span class=\"string\">&quot;k delete pod --grace-period=0 --force&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># View current context</span></span><br><span class=\"line\"><span class=\"comment\"># 直接设置别名的方式不行，因为在设置alias时，$(k config current-context)就会被执行了，所以不会根据当时情况进行替换，可以使用函数来实现</span></span><br><span class=\"line\"><span class=\"comment\"># alias kcc=&quot;k config get-contexts $(k config current-context)&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># 注意这里函数不能使用字母 k 开头，会报错 &quot;defining function based on alias `k&#x27;&quot;</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">cc</span></span>() &#123;</span><br><span class=\"line\">   k config get-contexts $(k config current-context)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\"># 然后再将函数设置别名即可实现</span></span><br><span class=\"line\"><span class=\"built_in\">alias</span> kcc=cc</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>kubectl的配置文件为<code>~/.kube/config</code>，在创建eks集群时会进一步介绍。</p>\n</li>\n</ul>\n<h3 id=\"eksctl\">eksctl</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>eksctl 是一款简单的命令行工具，用于在 Amazon EKS 上创建和管理 Kubernetes 集群。eksctl 提供使用 Amazon EKS 节点创建新集群的最快、最简单的方式。</p>\n</li>\n<li class=\"lvl-2\">\n<p><code>eksctl</code>与<code>AWS CLI</code>共用认证信息，即<code>~/.aws</code>下的配置</p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://github.com/weaveworks/eksctl/blob/main/README.md#installation\">安装或更新 eksctl</a>，这里以mac为例</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># for ARM systems, set ARCH to: `arm64`, `armv6` or `armv7`</span></span><br><span class=\"line\">$ ARCH=amd64</span><br><span class=\"line\">$ PLATFORM=$(<span class=\"built_in\">uname</span> -s)_<span class=\"variable\">$ARCH</span></span><br><span class=\"line\"><span class=\"comment\"># 下载</span></span><br><span class=\"line\">$ curl -sLO <span class=\"string\">&quot;https://github.com/weaveworks/eksctl/releases/latest/download/eksctl_<span class=\"variable\">$PLATFORM</span>.tar.gz&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (Optional) Verify checksum</span></span><br><span class=\"line\">$ curl -sL <span class=\"string\">&quot;https://github.com/weaveworks/eksctl/releases/latest/download/eksctl_checksums.txt&quot;</span> | grep <span class=\"variable\">$PLATFORM</span> | <span class=\"built_in\">sha256sum</span> --check</span><br><span class=\"line\"><span class=\"comment\"># 解压</span></span><br><span class=\"line\">$ tar -xzf eksctl_<span class=\"variable\">$PLATFORM</span>.tar.gz -C /tmp &amp;&amp; <span class=\"built_in\">rm</span> eksctl_<span class=\"variable\">$PLATFORM</span>.tar.gz</span><br><span class=\"line\"><span class=\"comment\"># 移动到$PATH</span></span><br><span class=\"line\">$ sudo <span class=\"built_in\">mv</span> /tmp/eksctl /usr/local/bin</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看版本</span></span><br><span class=\"line\">$ eksctl version</span><br><span class=\"line\"></span><br><span class=\"line\">0.146.0</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>升级时重新执行上面的的安装过程即可</p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://eksctl.io/introduction/#shell-completion\">代码补全</a>，以zsh为例</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ <span class=\"built_in\">mkdir</span> -p ~/.zsh/completion/</span><br><span class=\"line\">$ eksctl completion zsh &gt; ~/.zsh/completion/_eksctl</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 并将以下内容放入~/.zshrc中：</span></span><br><span class=\"line\">fpath=(<span class=\"variable\">$fpath</span> ~/.zsh/completion)</span><br><span class=\"line\"><span class=\"built_in\">autoload</span> -U compinit</span><br><span class=\"line\">compinit</span><br></pre></td></tr></table></figure>\n<h3 id=\"helm\">helm</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><a href=\"https://helm.sh/zh/docs/\">Helm</a> 是 Kubernetes 的包管理器</p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://helm.sh/zh/docs/intro/install/\">安装或更新 Helm</a>，在<a href=\"https://github.com/helm/helm/releases\">Helm 版本</a>中下载对应的版本，以mac为例</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 下载</span></span><br><span class=\"line\">$ curl -O https://get.helm.sh/helm-v3.12.1-darwin-amd64.tar.gz</span><br><span class=\"line\"><span class=\"comment\"># 解压</span></span><br><span class=\"line\">$ tar -zxvf helm-v3.12.1-darwin-amd64.tar.gz</span><br><span class=\"line\"><span class=\"comment\"># 移动到$PATH</span></span><br><span class=\"line\">$ sudo <span class=\"built_in\">mv</span> darwin-amd64/helm /usr/local/bin/helm</span><br><span class=\"line\"><span class=\"comment\"># 查看版本</span></span><br><span class=\"line\">$ helm version --short</span><br><span class=\"line\"></span><br><span class=\"line\">v3.12.1+gf32a527</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>升级时重新执行上面的的安装过程即可</p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://helm.sh/zh/docs/helm/helm_completion_zsh/\">命令提示补全</a>，以zsh为例，在<code>~/.zshrc</code>中添加如下内容，为了立即生效可以执行<code>source ~/.zshrc</code></p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">source</span> &lt;(helm completion zsh)</span><br></pre></td></tr></table></figure>\n","content_text":"摘要 本文介绍在AWS中创建EKS集群的过程中会使用到的命令行工具的安装方法 参考资料： Amazon EKS用户指南 Kubernetes 文档 安装命令行工具 AWS CLI AWS Command Line Interface (AWS CLI) 是一种开源工具，让您能够在命令行 Shell 中使用命令与 AWS 服务进行交互。 要使用 AWS CLI 访问 AWS 服务，您需要 AWS 账户 和 IAM 凭证。运行 AWS CLI 命令时，AWS CLI 需要有权访问这些 AWS 凭证。为了提高 AWS 账户的安全性，建议您不要使用根账户凭证。您应创建一个具有最低权限的用户来为将在 AWS 中运行的任务提供访问凭证。 登录AWS控制台，在IAM里创建一个用户，为了方便对资源进行管理可以授予其管理员访问权限(AdministratorAccess)，并在其安全凭证中创建一个新的访问密钥。 安装AWS CLI，这里以mac为例 123456$ curl &quot;https://awscli.amazonaws.com/AWSCLIV2.pkg&quot; -o &quot;AWSCLIV2.pkg&quot;$ sudo installer -pkg AWSCLIV2.pkg -target /$ which aws/usr/local/bin/aws$ aws --versionaws-cli/2.12.3 Python/3.11.4 Darwin/21.6.0 exe/x86_64 prompt/off 升级时重新执行上面的的安装过程即可 命令提示补全，以zsh为例，在~/.zshrc中添加如下内容，为了立即生效可以执行source ~/.zshrc 123autoload bashcompinit &amp;&amp; bashcompinitautoload -Uz compinit &amp;&amp; compinitcomplete -C &#x27;/usr/local/bin/aws_completer&#x27; aws 配置文件在~/.aws目录下，分为 config 和 credentials，可以设置多份凭证，设置时可以直接编辑对应的配置文件，也可以通过如下命令设置 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152# 默认default，这里配置上用户的访问密钥$ aws configureAWS Access Key ID [None]: AKIAIOSFODNN7EXAMPLEAWS Secret Access Key [None]: wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEYDefault region name [None]: us-west-1Default output format [None]: json# 指定profile，后面所有命令中涉及到凭证的部分都使用该profile$ aws configure --profile eks-us-west-2AWS Access Key ID [None]: AKIAIOSFODNN7EXAMPLEAWS Secret Access Key [None]: wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEYDefault region name [None]: us-west-2Default output format [None]: json# 查看配置$ cat ~/.aws/config[default]region = us-west-1output = json[profile eks-us-west-2]region = us-west-2output = json$ cat ~/.aws/credentials[default]aws_access_key_id = AKIAIOSFODNN7EXAMPLEaws_secret_access_key = wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY[eks-us-west-2]aws_access_key_id = AKIAIOSFODNN7EXAMPLEaws_secret_access_key = wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY# 查看所有profile$ aws configure list-profilesdefaulteks-us-west-2# 查看指定的profile的信息$ aws configure list --profile eks-us-west-2 Name Value Type Location ---- ----- ---- -------- profile eks-us-west-2 manual --profileaccess_key ****************IP6L shared-credentials-filesecret_key ****************OIQU shared-credentials-file region us-west-2 config-file ~/.aws/config# 查看与profile对应的用户信息$ aws sts get-caller-identity --profile eks-us-west-2&#123; &quot;UserId&quot;: &quot;AIDA55DP3G4GIDWF2GNIR&quot;, &quot;Account&quot;: &quot;743263909655&quot;, &quot;Arn&quot;: &quot;arn:aws:iam::743263909655:user/hanqunfeng&quot;&#125; 使用aws命令时，如果不指定--profile，则默认使用default对应的认证信息，也可以通过环境变量指定要使用的profile 1$ export AWS_PROFILE=eks-us-west-2 kubectl Kubectl 是一个命令行工具，用于与 Kubernetes API 服务器进行通信。这个命令非常重要，后面会有一节专门介绍。 安装或更新 kubectl，这里以mac为例 123456789101112131415161718192021# 从 Amazon S3 为集群的 Kubernetes 版本下载二进制文件# 这里下载Kubernetes 1.26$ curl -O https://s3.us-west-2.amazonaws.com/amazon-eks/1.26.4/2023-05-11/bin/darwin/amd64/kubectl# 授予执行权限$ chmod +x ./kubectl# 将命令复制到 $PATH 中$ sudo mv ./kubectl /usr/local/bin/kubectl# 查看kubectl版本，由于此时还没有配置k8s的server端，所以这里只查看client的的信息$ kubectl version --client -o yamlclientVersion: buildDate: &quot;2023-04-15T00:36:29Z&quot; compiler: gc gitCommit: 4a3479673cb6d9b63f1c69a67b57de30a4d9b781 gitTreeState: clean gitVersion: v1.26.4-eks-0a21954 goVersion: go1.19.8 major: &quot;1&quot; minor: 26+ platform: darwin/amd64kustomizeVersion: v4.5.7 升级时重新执行上面的的安装过程即可 命令提示补全和别名设置，以zsh为例，在~/.zshrc中添加如下内容，为了立即生效可以执行source ~/.zshrc 123456789101112131415161718# k8s client kubectlsource &lt;(kubectl completion zsh)alias k=kubectl# change namespacealias kn=&quot;k config set-context --current --namespace&quot;# Delete Nowalias kdp=&quot;k delete pod --grace-period=0 --force&quot;# View current context# 直接设置别名的方式不行，因为在设置alias时，$(k config current-context)就会被执行了，所以不会根据当时情况进行替换，可以使用函数来实现# alias kcc=&quot;k config get-contexts $(k config current-context)&quot;# 注意这里函数不能使用字母 k 开头，会报错 &quot;defining function based on alias `k&#x27;&quot;cc() &#123; k config get-contexts $(k config current-context)&#125;# 然后再将函数设置别名即可实现alias kcc=cc kubectl的配置文件为~/.kube/config，在创建eks集群时会进一步介绍。 eksctl eksctl 是一款简单的命令行工具，用于在 Amazon EKS 上创建和管理 Kubernetes 集群。eksctl 提供使用 Amazon EKS 节点创建新集群的最快、最简单的方式。 eksctl与AWS CLI共用认证信息，即~/.aws下的配置 安装或更新 eksctl，这里以mac为例 1234567891011121314151617# for ARM systems, set ARCH to: `arm64`, `armv6` or `armv7`$ ARCH=amd64$ PLATFORM=$(uname -s)_$ARCH# 下载$ curl -sLO &quot;https://github.com/weaveworks/eksctl/releases/latest/download/eksctl_$PLATFORM.tar.gz&quot;# (Optional) Verify checksum$ curl -sL &quot;https://github.com/weaveworks/eksctl/releases/latest/download/eksctl_checksums.txt&quot; | grep $PLATFORM | sha256sum --check# 解压$ tar -xzf eksctl_$PLATFORM.tar.gz -C /tmp &amp;&amp; rm eksctl_$PLATFORM.tar.gz# 移动到$PATH$ sudo mv /tmp/eksctl /usr/local/bin# 查看版本$ eksctl version0.146.0 升级时重新执行上面的的安装过程即可 代码补全，以zsh为例 1234567$ mkdir -p ~/.zsh/completion/$ eksctl completion zsh &gt; ~/.zsh/completion/_eksctl# 并将以下内容放入~/.zshrc中：fpath=($fpath ~/.zsh/completion)autoload -U compinitcompinit helm Helm 是 Kubernetes 的包管理器 安装或更新 Helm，在Helm 版本中下载对应的版本，以mac为例 12345678910# 下载$ curl -O https://get.helm.sh/helm-v3.12.1-darwin-amd64.tar.gz# 解压$ tar -zxvf helm-v3.12.1-darwin-amd64.tar.gz# 移动到$PATH$ sudo mv darwin-amd64/helm /usr/local/bin/helm# 查看版本$ helm version --shortv3.12.1+gf32a527 升级时重新执行上面的的安装过程即可 命令提示补全，以zsh为例，在~/.zshrc中添加如下内容，为了立即生效可以执行source ~/.zshrc 1source &lt;(helm completion zsh)","summary":"摘要 本文介绍在AWS中创建EKS集群的过程中会使用到的命令行工具的安装方法 参考资料： Amazon EKS用户指南 Kubernetes 文档","date_published":"2023-07-06T14:30:05.000Z","tags":["技术","aws","eks","java"]},{"id":"https://blog.hanqunfeng.com/2023/05/29/java-concurrency12-ForkJoinPool/","url":"https://blog.hanqunfeng.com/2023/05/29/java-concurrency12-ForkJoinPool/","title":"Java并发编程--线程池之ForkJoinPool","content_html":"<!--\n **加粗**\n *斜体*\n ***加粗并斜体***\n ~~删除线~~\n ==突出显示==\n `突出显示(推荐)`\n ++下划线++\n ~下标~\n ^上标^\n 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.\n 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600)\n\n +++ **点击折叠**\n 这是被隐藏的内容\n +++\n\n::: tips success warning danger\n这里是容器内的内容\n:::\n\n% note info % success warning danger\n这里是容器内的内容\n% endnote %\n\n -->\n<h2 id=\"摘要\">摘要</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>本文介绍线程池ForkJoinPool相关技术</p>\n</li>\n<li class=\"lvl-2\">\n<p>本文基于<code>jdk1.8</code></p>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"Fork-Join框架介绍\">Fork/Join框架介绍</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>Fork/Join</code>是一个是一个并行计算的框架，主要就是用来支持分治任务模型的，这个计算框架里的 <code>Fork</code>对应的是分治任务模型里的任务分解，<code>Join</code> 对应的是结果合并。</p>\n</li>\n<li class=\"lvl-2\">\n<p>它的核心思想是将一个大任务分成许多小任务，然后并行执行这些小任务，最终将它们的结果合并成一个大的结果。</p>\n</li>\n<li class=\"lvl-2\">\n<p><code>Fork/Join</code>模式是实现任务并行性的一种常用模式，它将大任务递归地分解成小任务，然后利用多线程并行执行这些小任务。</p>\n</li>\n<li class=\"lvl-2\">\n<p><code>Fork/Join</code>框架的主要组成部分是<code>ForkJoinPool</code>、<code>ForkJoinTask</code>。<code>ForkJoinPool</code>是一个线程池，它用于管理<code>Fork/Join</code>任务的执行。<code>ForkJoinTask</code>是一个抽象类，用于表示可以被分割成更小部分的任务。</p>\n</li>\n<li class=\"lvl-2\">\n<p><code>Fork/Join</code>框架更适合执行CPU密集型任务，同时需要避免在<code>ForkJoinPool</code>中提交大量的阻塞型任务，以免影响整个线程池的性能。</p>\n</li>\n</ul>\n<h3 id=\"应用场景\">应用场景</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>1.递归分解型任务<br>\n<code>Fork/Join</code>框架特别适用于递归分解型的任务，例如排序、归并、遍历等。这些任务通常可以将大的任务分解成若干个子任务，每个子任务可以独立执行，并且可以通过归并操作将子任务的结果合并成一个有序的结果。</p>\n</li>\n<li class=\"lvl-2\">\n<p>2.数组处理<br>\n<code>Fork/Join</code>框架还可以用于数组的处理，例如数组的排序、查找、统计等。在处理大型数组时，<code>Fork/Join</code>框架可以将数组分成若干个子数组，并行地处理每个子数组，最后将处理后的子数组合并成一个有序的大数组。</p>\n</li>\n<li class=\"lvl-2\">\n<p>3.并行化算法<br>\n<code>Fork/Join</code>框架还可以用于并行化算法的实现，例如并行化的图像处理算法、并行化的机器学习算法等。在这些算法中，可以将问题分解成若干个子问题，并行地解决每个子问题，然后将子问题的结果合并起来得到最终的解决方案。</p>\n</li>\n<li class=\"lvl-2\">\n<p>4.大数据处理<br>\n<code>Fork/Join</code>框架还可以用于大数据处理，例如大型日志文件的处理、大型数据库的查询等。在处理大数据时，可以将数据分成若干个分片，并行地处理每个分片，最后将处理后的分片合并成一个完整的结果</p>\n</li>\n</ul>\n<h2 id=\"ForkJoinPool介绍\">ForkJoinPool介绍</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>ForkJoinPool</code>是<code>Fork/Join</code>框架中的线程池类，它用于管理<code>Fork/Join</code>任务的线程，基于工作窃取算法（work-stealing）来实现任务的分配和执行。</p>\n</li>\n<li class=\"lvl-2\">\n<p><code>ForkJoinPool</code>类包括一些重要的方法，例如<code>submit()</code>、<code>invoke()</code>、<code>shutdown()</code>、<code>awaitTermination()</code>等，用于提交任务、执行任务、关闭线程池和等待任务的执行结果。<code>ForkJoinPool</code>类中还包括一些参数，例如线程池的大小、工作线程的优先级、任务队列的容量等，可以根据具体的应用场景进行设置。</p>\n</li>\n<li class=\"lvl-2\">\n<p>常用API</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>API/方法</th>\n<th>返回值</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>ForkJoinPool(int parallelism)</code></td>\n<td>无</td>\n<td>使用指定的并行度创建一个新的ForkJoinPool。</td>\n</tr>\n<tr>\n<td><code>invoke(ForkJoinTask&lt;T&gt; task)</code></td>\n<td>T</td>\n<td>同步执行给定的任务，并返回结果。</td>\n</tr>\n<tr>\n<td><code>submit(ForkJoinTask&lt;T&gt; task)</code></td>\n<td><code>Future&lt;T&gt;</code></td>\n<td>异步执行给定的任务，并返回一个<code>Future</code>对象，可以用于获取任务的执行结果。</td>\n</tr>\n<tr>\n<td><code>execute(ForkJoinTask&lt;?&gt; task)</code></td>\n<td>无</td>\n<td>异步执行给定的任务，没有返回值。</td>\n</tr>\n<tr>\n<td><code>awaitTermination(long timeout, TimeUnit unit)</code></td>\n<td><code>boolean</code></td>\n<td>阻塞当前线程，直到所有任务执行完成或超过指定的超时时间，并返回是否成功终止。</td>\n</tr>\n<tr>\n<td><code>isShutdown()</code></td>\n<td><code>boolean</code></td>\n<td>判断ForkJoinPool是否已经关闭。</td>\n</tr>\n<tr>\n<td><code>isTerminated()</code></td>\n<td><code>boolean</code></td>\n<td>判断ForkJoinPool中的所有任务是否已经执行完成。</td>\n</tr>\n<tr>\n<td><code>shutdown()</code></td>\n<td>无</td>\n<td>优雅地关闭ForkJoinPool，不再接受新的任务，并等待已提交的任务执行完成。</td>\n</tr>\n<tr>\n<td><code>shutdownNow()</code></td>\n<td><code>List&lt;Runnable&gt;</code></td>\n<td>强制关闭ForkJoinPool，尝试取消所有正在执行的任务，并返回等待执行的任务列表。</td>\n</tr>\n<tr>\n<td><code>getParallelism()</code></td>\n<td><code>int</code></td>\n<td>获取ForkJoinPool的并行度，即同时执行任务的线程数。</td>\n</tr>\n<tr>\n<td><code>getPoolSize()</code></td>\n<td><code>int</code></td>\n<td>获取ForkJoinPool中当前的工作线程数。</td>\n</tr>\n<tr>\n<td><code>getActiveThreadCount()</code></td>\n<td><code>int</code></td>\n<td>获取ForkJoinPool中当前活动的线程数。</td>\n</tr>\n<tr>\n<td><code>getQueuedTaskCount()</code></td>\n<td><code>long</code></td>\n<td>获取ForkJoinPool中当前等待执行的任务数。</td>\n</tr>\n<tr>\n<td><code>getRunningThreadCount()</code></td>\n<td><code>int</code></td>\n<td>获取ForkJoinPool中当前正在执行任务的线程数。</td>\n</tr>\n<tr>\n<td><code>getStealCount()</code></td>\n<td><code>long</code></td>\n<td>获取ForkJoinPool中总共发生的工作窃取次数。</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"ForkJoinPool的创建\">ForkJoinPool的创建</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ForkJoinPool中有四个核心参数，用于控制线程池的并行数、工作线程的创建、异常处理和模式指定等。各参数解释如下：</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\"><code>int parallelism</code>：指定并行级别（parallelism level）。<br>\nForkJoinPool将根据这个设定，决定工作线程的数量。如果未设置的话，将使用<code>Runtime.getRuntime().availableProcessors()</code>来设置并行级别；  <figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"title function_\">ForkJoinPool</span><span class=\"params\">(<span class=\"type\">int</span> parallelism)</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">this</span>(parallelism, defaultForkJoinWorkerThreadFactory, <span class=\"literal\">null</span>, <span class=\"literal\">false</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li class=\"lvl-6\"><code>ForkJoinWorkerThreadFactory factory</code>：ForkJoinPool在创建线程时，会通过factory来创建。<br>\n注意，这里需要实现的是<code>ForkJoinWorkerThreadFactory</code>，而不是<code>ThreadFactory</code>。如果你不指定<code>factory</code>，那么将由默认的<code>DefaultForkJoinWorkerThreadFactory</code>负责线程的创建工作；</li>\n<li class=\"lvl-6\"><code>UncaughtExceptionHandler handler</code>：指定异常处理器<br>\n当任务在运行中出错时，将由设定的处理器处理；</li>\n<li class=\"lvl-6\"><code>boolean asyncMode</code>：设置队列的工作模式。<br>\n当<code>asyncMode</code>为<code>true</code>时，将使用先进先出队列，而为<code>false</code>时则使用后进先出的模式。  <figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"title function_\">ForkJoinPool</span><span class=\"params\">(<span class=\"type\">int</span> parallelism,</span></span><br><span class=\"line\"><span class=\"params\">                ForkJoinWorkerThreadFactory factory,</span></span><br><span class=\"line\"><span class=\"params\">                UncaughtExceptionHandler handler,</span></span><br><span class=\"line\"><span class=\"params\">                <span class=\"type\">boolean</span> asyncMode)</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">this</span>(checkParallelism(parallelism),</span><br><span class=\"line\">        checkFactory(factory),</span><br><span class=\"line\">        handler,</span><br><span class=\"line\">        asyncMode ? FIFO_QUEUE : LIFO_QUEUE,</span><br><span class=\"line\">        <span class=\"string\">&quot;ForkJoinPool-&quot;</span> + nextPoolId() + <span class=\"string\">&quot;-worker-&quot;</span>);</span><br><span class=\"line\">    checkPermission();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//获取处理器数量</span></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"variable\">processors</span> <span class=\"operator\">=</span> Runtime.getRuntime().availableProcessors();</span><br><span class=\"line\"><span class=\"comment\">//构建forkjoin线程池</span></span><br><span class=\"line\"><span class=\"type\">ForkJoinPool</span> <span class=\"variable\">forkJoinPool</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ForkJoinPool</span>(processors);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//此时等同于无参创建</span></span><br><span class=\"line\"><span class=\"type\">ForkJoinPool</span> <span class=\"variable\">forkJoinPool</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ForkJoinPool</span>();</span><br></pre></td></tr></table></figure>\n<h2 id=\"ForkJoinTask介绍\">ForkJoinTask介绍</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>ForkJoinTask</code>是<code>Fork/Join</code>框架中的抽象类，它定义了执行任务的基本接口。用户可以通过继承<code>ForkJoinTask</code>类来实现自己的任务类，并重写其中的<code>compute()</code>方法来定义任务的执行逻辑。</p>\n</li>\n<li class=\"lvl-2\">\n<p>通常情况下我们不需要直接继承<code>ForkJoinTask</code>类，而只需要继承它的子类，<code>Fork/Join</code>框架提供了以下三个子类：</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\"><code>RecursiveAction</code>：用于递归执行但不需要返回结果的任务。</li>\n<li class=\"lvl-6\"><code>RecursiveTask</code> ：用于递归执行需要返回结果的任务。</li>\n<li class=\"lvl-6\"><code>CountedCompleter&lt;T&gt;</code> ：在任务完成执行后会触发执行一个自定义的钩子函数</li>\n</ul>\n</li>\n<li class=\"lvl-2\">\n<p><code>ForkJoinTask</code> 最核心的是 <code>fork()</code> 方法和 <code>join()</code>方法，承载着主要的任务协调作用，一个用于任务提交，一个用于结果获取。</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\"><code>fork()</code>–提交任务<br>\n<code>fork()</code>方法用于向当前任务所运行的线程池中提交任务。如果当前线程是<code>ForkJoinWorkerThread</code>类型，将会放入该线程的工作队列，否则放入<code>common</code>线程池的工作队列中。</li>\n<li class=\"lvl-6\"><code>join()</code>–获取任务执行结果<br>\n<code>join()</code>方法用于获取任务的执行结果。调用<code>join()</code>时，将阻塞当前线程直到对应的子任务完成运行并返回结果</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"ForkJoinPool-与-ForkJoinTask-使用示例\">ForkJoinPool 与 ForkJoinTask 使用示例</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>利用<code>fork-join</code>实现数组归并排序算法</p>\n</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> java.util.Arrays;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Random;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.concurrent.ForkJoinPool;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.concurrent.RecursiveTask;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 利用fork-join实现数组归并排序算法</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">MergeSortRecursiveTask</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">RecursiveTask</span>&lt;<span class=\"type\">int</span>[]&gt; &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"type\">int</span> threshold; <span class=\"comment\">//拆分的阈值，低于此阈值就不再进行拆分</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"type\">int</span>[] arrayToSort; <span class=\"comment\">//要排序的数组</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"title function_\">MergeSortRecursiveTask</span><span class=\"params\">(<span class=\"keyword\">final</span> <span class=\"type\">int</span>[] arrayToSort, <span class=\"keyword\">final</span> <span class=\"type\">int</span> threshold)</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">this</span>.arrayToSort = arrayToSort;</span><br><span class=\"line\">        <span class=\"built_in\">this</span>.threshold = threshold;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"type\">int</span>[] compute() &#123;</span><br><span class=\"line\">        <span class=\"comment\">//拆分后的数组长度小于阈值，直接进行排序</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (arrayToSort.length &lt;= threshold) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 调用jdk提供的排序方法</span></span><br><span class=\"line\">            Arrays.sort(arrayToSort);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> arrayToSort;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 对数组进行拆分</span></span><br><span class=\"line\">        <span class=\"type\">int</span> <span class=\"variable\">midpoint</span> <span class=\"operator\">=</span> arrayToSort.length / <span class=\"number\">2</span>;</span><br><span class=\"line\">        <span class=\"type\">int</span>[] leftArray = Arrays.copyOfRange(arrayToSort, <span class=\"number\">0</span>, midpoint);</span><br><span class=\"line\">        <span class=\"type\">int</span>[] rightArray = Arrays.copyOfRange(arrayToSort, midpoint, arrayToSort.length);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">MergeSortRecursiveTask</span> <span class=\"variable\">leftTask</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">MergeSortRecursiveTask</span>(leftArray, threshold);</span><br><span class=\"line\">        <span class=\"type\">MergeSortRecursiveTask</span> <span class=\"variable\">rightTask</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">MergeSortRecursiveTask</span>(rightArray, threshold);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 调用任务,阻塞当前线程，直到所有子任务执行完成</span></span><br><span class=\"line\">        <span class=\"comment\">// 使用invokeAll()方法同时提交多个任务，以提高任务的并行度，相当于同时fork并join</span></span><br><span class=\"line\">        invokeAll(leftTask, rightTask);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//提交任务，多个任务同时提交时，推荐使用invokeAll()</span></span><br><span class=\"line\">        <span class=\"comment\">// leftTask.fork();</span></span><br><span class=\"line\">        <span class=\"comment\">// rightTask.fork();</span></span><br><span class=\"line\">        <span class=\"comment\">//合并结果</span></span><br><span class=\"line\">        <span class=\"comment\">// leftTask.join();</span></span><br><span class=\"line\">        <span class=\"comment\">// rightTask.join();</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 合并排序结果</span></span><br><span class=\"line\">        arrayToSort = merge(leftTask.getSortedArray(), rightTask.getSortedArray());</span><br><span class=\"line\">        <span class=\"keyword\">return</span> arrayToSort;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"type\">int</span>[] getSortedArray() &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> arrayToSort;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 合并两个有序数组，并返回合并后的有序数组</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"type\">int</span>[] merge(<span class=\"keyword\">final</span> <span class=\"type\">int</span>[] leftArray, <span class=\"keyword\">final</span> <span class=\"type\">int</span>[] rightArray) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 定义用于合并结果的数组</span></span><br><span class=\"line\">        <span class=\"type\">int</span>[] mergedArray = <span class=\"keyword\">new</span> <span class=\"title class_\">int</span>[leftArray.length + rightArray.length];</span><br><span class=\"line\">        <span class=\"type\">int</span> <span class=\"variable\">mergedArrayPos</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"comment\">// 利用双指针进行两个数的比较</span></span><br><span class=\"line\">        <span class=\"type\">int</span> <span class=\"variable\">leftArrayPos</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"type\">int</span> <span class=\"variable\">rightArrayPos</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"keyword\">while</span> (leftArrayPos &lt; leftArray.length &amp;&amp; rightArrayPos &lt; rightArray.length) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 比较左右数组中的元素大小，并将较小的元素放入合并结果数组中</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (leftArray[leftArrayPos] &lt;= rightArray[rightArrayPos]) &#123;</span><br><span class=\"line\">                mergedArray[mergedArrayPos] = leftArray[leftArrayPos];</span><br><span class=\"line\">                leftArrayPos++;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                mergedArray[mergedArrayPos] = rightArray[rightArrayPos];</span><br><span class=\"line\">                rightArrayPos++;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            mergedArrayPos++;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 将剩余的左数组元素放入合并结果数组中</span></span><br><span class=\"line\">        <span class=\"keyword\">while</span> (leftArrayPos &lt; leftArray.length) &#123;</span><br><span class=\"line\">            mergedArray[mergedArrayPos] = leftArray[leftArrayPos];</span><br><span class=\"line\">            leftArrayPos++;</span><br><span class=\"line\">            mergedArrayPos++;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 将剩余的右数组元素放入合并结果数组中</span></span><br><span class=\"line\">        <span class=\"keyword\">while</span> (rightArrayPos &lt; rightArray.length) &#123;</span><br><span class=\"line\">            mergedArray[mergedArrayPos] = rightArray[rightArrayPos];</span><br><span class=\"line\">            rightArrayPos++;</span><br><span class=\"line\">            mergedArrayPos++;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 返回合并后的有序数组</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> mergedArray;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 随机生成数组</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> size 数组的大小</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"type\">int</span>[] buildRandomIntArray(<span class=\"keyword\">final</span> <span class=\"type\">int</span> size) &#123;</span><br><span class=\"line\">        <span class=\"type\">int</span>[] arrayToCalculateSumOf = <span class=\"keyword\">new</span> <span class=\"title class_\">int</span>[size];</span><br><span class=\"line\">        <span class=\"type\">Random</span> <span class=\"variable\">generator</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Random</span>();</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>; i &lt; arrayToCalculateSumOf.length; i++) &#123;</span><br><span class=\"line\">            arrayToCalculateSumOf[i] = generator.nextInt(<span class=\"number\">10000</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> arrayToCalculateSumOf;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">//拆分的阈值</span></span><br><span class=\"line\">        <span class=\"type\">int</span> <span class=\"variable\">threshold</span> <span class=\"operator\">=</span> <span class=\"number\">20</span>;</span><br><span class=\"line\">        <span class=\"type\">int</span>[] arrayToSortByMergeSort = buildRandomIntArray(<span class=\"number\">2000</span>);</span><br><span class=\"line\">        System.out.print(<span class=\"string\">&quot;排序前: &quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> element : arrayToSortByMergeSort) &#123;</span><br><span class=\"line\">            System.out.print(element + <span class=\"string\">&quot; &quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        System.out.println();</span><br><span class=\"line\">        <span class=\"comment\">//利用forkjoin排序</span></span><br><span class=\"line\">        <span class=\"type\">MergeSortRecursiveTask</span> <span class=\"variable\">mergeSortRecursiveTask</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">MergeSortRecursiveTask</span>(arrayToSortByMergeSort, threshold);</span><br><span class=\"line\">        <span class=\"comment\">//构建forkjoin线程池</span></span><br><span class=\"line\">        <span class=\"type\">ForkJoinPool</span> <span class=\"variable\">forkJoinPool</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ForkJoinPool</span>();</span><br><span class=\"line\">        <span class=\"type\">long</span> <span class=\"variable\">startTime</span> <span class=\"operator\">=</span> System.nanoTime();</span><br><span class=\"line\">        <span class=\"comment\">//执行排序任务</span></span><br><span class=\"line\">        <span class=\"keyword\">final</span> <span class=\"type\">int</span>[] mergeSortArray = forkJoinPool.invoke(mergeSortRecursiveTask);</span><br><span class=\"line\">        System.out.print(<span class=\"string\">&quot;排序后: &quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> element : mergeSortArray) &#123;</span><br><span class=\"line\">            System.out.print(element + <span class=\"string\">&quot; &quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        System.out.println();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">long</span> <span class=\"variable\">duration</span> <span class=\"operator\">=</span> System.nanoTime() - startTime;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;forkjoin排序时间: &quot;</span> + (duration / (<span class=\"number\">1000f</span> * <span class=\"number\">1000f</span>)) + <span class=\"string\">&quot;毫秒&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"ForkJoinPool工作原理\">ForkJoinPool工作原理</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>ForkJoinPool</code> 内部有多个任务队列，当我们通过 <code>ForkJoinPool</code> 的 <code>invoke()</code> 或者 <code>submit()</code> 方法提交任务时，<code>ForkJoinPool</code> 根据一定的路由规则把任务提交到一个任务队列中，如果任务在执行过程中会创建出子任务，那么子任务会提交到工作线程对应的任务队列中。</p>\n</li>\n<li class=\"lvl-2\">\n<p>如果工作线程对应的任务队列空了，是不是就没活儿干了呢？不是的，<code>ForkJoinPool</code> 支持一种叫做<code>任务窃取</code>的机制，如果工作线程空闲了，那它可以<code>窃取</code>其他工作任务队列里的任务。如此一来，所有的工作线程都不会闲下来了。</p>\n</li>\n</ul>\n<div class=\"tips\">\n<p><em><strong>小贴士</strong></em></p>\n<h2 id=\"工作窃取\">工作窃取</h2>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">工作窃取，就是允许空闲线程从繁忙线程的双端队列中窃取任务。</li>\n<li class=\"lvl-2\">默认情况下，工作线程从它自己的双端队列的头部获取任务。但是，当自己的任务为空时，线程会从其他繁忙线程双端队列的尾部中获取任务。这种方法，最大限度地减少了线程竞争任务的可能性。</li>\n</ul>\n</div>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>ForkJoinPool</code>执行流程<br>\n<img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/1bBSl8.jpg\" alt=\"\"></p>\n</li>\n</ul>\n<h2 id=\"总结\">总结</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>Fork/Join</code>是一种基于分治思想的模型，在并发处理计算型任务时有着显著的优势。其效率的提升主要得益于两个方面：</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">任务切分：将大的任务分割成更小粒度的小任务，让更多的线程参与执行；</li>\n<li class=\"lvl-6\">任务窃取：通过任务窃取，充分地利用空闲线程，并减少竞争。</li>\n</ul>\n</li>\n<li class=\"lvl-2\">\n<p>在使用<code>ForkJoinPool</code>时，需要特别注意任务的类型是否为纯函数计算类型，也就是这些任务不应该关心状态或者外界的变化，这样才是最安全的做法。如果是阻塞类型任务，那么你需要谨慎评估技术方案。虽然ForkJoinPool也能处理阻塞类型任务，但可能会带来复杂的管理成本。</p>\n</li>\n</ul>\n","content_text":"摘要 本文介绍线程池ForkJoinPool相关技术 本文基于jdk1.8 Fork/Join框架介绍 Fork/Join是一个是一个并行计算的框架，主要就是用来支持分治任务模型的，这个计算框架里的 Fork对应的是分治任务模型里的任务分解，Join 对应的是结果合并。 它的核心思想是将一个大任务分成许多小任务，然后并行执行这些小任务，最终将它们的结果合并成一个大的结果。 Fork/Join模式是实现任务并行性的一种常用模式，它将大任务递归地分解成小任务，然后利用多线程并行执行这些小任务。 Fork/Join框架的主要组成部分是ForkJoinPool、ForkJoinTask。ForkJoinPool是一个线程池，它用于管理Fork/Join任务的执行。ForkJoinTask是一个抽象类，用于表示可以被分割成更小部分的任务。 Fork/Join框架更适合执行CPU密集型任务，同时需要避免在ForkJoinPool中提交大量的阻塞型任务，以免影响整个线程池的性能。 应用场景 1.递归分解型任务 Fork/Join框架特别适用于递归分解型的任务，例如排序、归并、遍历等。这些任务通常可以将大的任务分解成若干个子任务，每个子任务可以独立执行，并且可以通过归并操作将子任务的结果合并成一个有序的结果。 2.数组处理 Fork/Join框架还可以用于数组的处理，例如数组的排序、查找、统计等。在处理大型数组时，Fork/Join框架可以将数组分成若干个子数组，并行地处理每个子数组，最后将处理后的子数组合并成一个有序的大数组。 3.并行化算法 Fork/Join框架还可以用于并行化算法的实现，例如并行化的图像处理算法、并行化的机器学习算法等。在这些算法中，可以将问题分解成若干个子问题，并行地解决每个子问题，然后将子问题的结果合并起来得到最终的解决方案。 4.大数据处理 Fork/Join框架还可以用于大数据处理，例如大型日志文件的处理、大型数据库的查询等。在处理大数据时，可以将数据分成若干个分片，并行地处理每个分片，最后将处理后的分片合并成一个完整的结果 ForkJoinPool介绍 ForkJoinPool是Fork/Join框架中的线程池类，它用于管理Fork/Join任务的线程，基于工作窃取算法（work-stealing）来实现任务的分配和执行。 ForkJoinPool类包括一些重要的方法，例如submit()、invoke()、shutdown()、awaitTermination()等，用于提交任务、执行任务、关闭线程池和等待任务的执行结果。ForkJoinPool类中还包括一些参数，例如线程池的大小、工作线程的优先级、任务队列的容量等，可以根据具体的应用场景进行设置。 常用API API/方法 返回值 描述 ForkJoinPool(int parallelism) 无 使用指定的并行度创建一个新的ForkJoinPool。 invoke(ForkJoinTask&lt;T&gt; task) T 同步执行给定的任务，并返回结果。 submit(ForkJoinTask&lt;T&gt; task) Future&lt;T&gt; 异步执行给定的任务，并返回一个Future对象，可以用于获取任务的执行结果。 execute(ForkJoinTask&lt;?&gt; task) 无 异步执行给定的任务，没有返回值。 awaitTermination(long timeout, TimeUnit unit) boolean 阻塞当前线程，直到所有任务执行完成或超过指定的超时时间，并返回是否成功终止。 isShutdown() boolean 判断ForkJoinPool是否已经关闭。 isTerminated() boolean 判断ForkJoinPool中的所有任务是否已经执行完成。 shutdown() 无 优雅地关闭ForkJoinPool，不再接受新的任务，并等待已提交的任务执行完成。 shutdownNow() List&lt;Runnable&gt; 强制关闭ForkJoinPool，尝试取消所有正在执行的任务，并返回等待执行的任务列表。 getParallelism() int 获取ForkJoinPool的并行度，即同时执行任务的线程数。 getPoolSize() int 获取ForkJoinPool中当前的工作线程数。 getActiveThreadCount() int 获取ForkJoinPool中当前活动的线程数。 getQueuedTaskCount() long 获取ForkJoinPool中当前等待执行的任务数。 getRunningThreadCount() int 获取ForkJoinPool中当前正在执行任务的线程数。 getStealCount() long 获取ForkJoinPool中总共发生的工作窃取次数。 ForkJoinPool的创建 ForkJoinPool中有四个核心参数，用于控制线程池的并行数、工作线程的创建、异常处理和模式指定等。各参数解释如下： int parallelism：指定并行级别（parallelism level）。 ForkJoinPool将根据这个设定，决定工作线程的数量。如果未设置的话，将使用Runtime.getRuntime().availableProcessors()来设置并行级别； 123public ForkJoinPool(int parallelism) &#123; this(parallelism, defaultForkJoinWorkerThreadFactory, null, false);&#125; ForkJoinWorkerThreadFactory factory：ForkJoinPool在创建线程时，会通过factory来创建。 注意，这里需要实现的是ForkJoinWorkerThreadFactory，而不是ThreadFactory。如果你不指定factory，那么将由默认的DefaultForkJoinWorkerThreadFactory负责线程的创建工作； UncaughtExceptionHandler handler：指定异常处理器 当任务在运行中出错时，将由设定的处理器处理； boolean asyncMode：设置队列的工作模式。 当asyncMode为true时，将使用先进先出队列，而为false时则使用后进先出的模式。 1234567891011public ForkJoinPool(int parallelism, ForkJoinWorkerThreadFactory factory, UncaughtExceptionHandler handler, boolean asyncMode) &#123; this(checkParallelism(parallelism), checkFactory(factory), handler, asyncMode ? FIFO_QUEUE : LIFO_QUEUE, &quot;ForkJoinPool-&quot; + nextPoolId() + &quot;-worker-&quot;); checkPermission();&#125; 1234567//获取处理器数量int processors = Runtime.getRuntime().availableProcessors();//构建forkjoin线程池ForkJoinPool forkJoinPool = new ForkJoinPool(processors);//此时等同于无参创建ForkJoinPool forkJoinPool = new ForkJoinPool(); ForkJoinTask介绍 ForkJoinTask是Fork/Join框架中的抽象类，它定义了执行任务的基本接口。用户可以通过继承ForkJoinTask类来实现自己的任务类，并重写其中的compute()方法来定义任务的执行逻辑。 通常情况下我们不需要直接继承ForkJoinTask类，而只需要继承它的子类，Fork/Join框架提供了以下三个子类： RecursiveAction：用于递归执行但不需要返回结果的任务。 RecursiveTask ：用于递归执行需要返回结果的任务。 CountedCompleter&lt;T&gt; ：在任务完成执行后会触发执行一个自定义的钩子函数 ForkJoinTask 最核心的是 fork() 方法和 join()方法，承载着主要的任务协调作用，一个用于任务提交，一个用于结果获取。 fork()–提交任务 fork()方法用于向当前任务所运行的线程池中提交任务。如果当前线程是ForkJoinWorkerThread类型，将会放入该线程的工作队列，否则放入common线程池的工作队列中。 join()–获取任务执行结果 join()方法用于获取任务的执行结果。调用join()时，将阻塞当前线程直到对应的子任务完成运行并返回结果 ForkJoinPool 与 ForkJoinTask 使用示例 利用fork-join实现数组归并排序算法 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135import java.util.Arrays;import java.util.Random;import java.util.concurrent.ForkJoinPool;import java.util.concurrent.RecursiveTask;/** * 利用fork-join实现数组归并排序算法 */public class MergeSortRecursiveTask extends RecursiveTask&lt;int[]&gt; &#123; private final int threshold; //拆分的阈值，低于此阈值就不再进行拆分 private int[] arrayToSort; //要排序的数组 public MergeSortRecursiveTask(final int[] arrayToSort, final int threshold) &#123; this.arrayToSort = arrayToSort; this.threshold = threshold; &#125; @Override protected int[] compute() &#123; //拆分后的数组长度小于阈值，直接进行排序 if (arrayToSort.length &lt;= threshold) &#123; // 调用jdk提供的排序方法 Arrays.sort(arrayToSort); return arrayToSort; &#125; // 对数组进行拆分 int midpoint = arrayToSort.length / 2; int[] leftArray = Arrays.copyOfRange(arrayToSort, 0, midpoint); int[] rightArray = Arrays.copyOfRange(arrayToSort, midpoint, arrayToSort.length); MergeSortRecursiveTask leftTask = new MergeSortRecursiveTask(leftArray, threshold); MergeSortRecursiveTask rightTask = new MergeSortRecursiveTask(rightArray, threshold); // 调用任务,阻塞当前线程，直到所有子任务执行完成 // 使用invokeAll()方法同时提交多个任务，以提高任务的并行度，相当于同时fork并join invokeAll(leftTask, rightTask); //提交任务，多个任务同时提交时，推荐使用invokeAll() // leftTask.fork(); // rightTask.fork(); //合并结果 // leftTask.join(); // rightTask.join(); // 合并排序结果 arrayToSort = merge(leftTask.getSortedArray(), rightTask.getSortedArray()); return arrayToSort; &#125; private int[] getSortedArray() &#123; return arrayToSort; &#125; /** * 合并两个有序数组，并返回合并后的有序数组 */ private int[] merge(final int[] leftArray, final int[] rightArray) &#123; // 定义用于合并结果的数组 int[] mergedArray = new int[leftArray.length + rightArray.length]; int mergedArrayPos = 0; // 利用双指针进行两个数的比较 int leftArrayPos = 0; int rightArrayPos = 0; while (leftArrayPos &lt; leftArray.length &amp;&amp; rightArrayPos &lt; rightArray.length) &#123; // 比较左右数组中的元素大小，并将较小的元素放入合并结果数组中 if (leftArray[leftArrayPos] &lt;= rightArray[rightArrayPos]) &#123; mergedArray[mergedArrayPos] = leftArray[leftArrayPos]; leftArrayPos++; &#125; else &#123; mergedArray[mergedArrayPos] = rightArray[rightArrayPos]; rightArrayPos++; &#125; mergedArrayPos++; &#125; // 将剩余的左数组元素放入合并结果数组中 while (leftArrayPos &lt; leftArray.length) &#123; mergedArray[mergedArrayPos] = leftArray[leftArrayPos]; leftArrayPos++; mergedArrayPos++; &#125; // 将剩余的右数组元素放入合并结果数组中 while (rightArrayPos &lt; rightArray.length) &#123; mergedArray[mergedArrayPos] = rightArray[rightArrayPos]; rightArrayPos++; mergedArrayPos++; &#125; // 返回合并后的有序数组 return mergedArray; &#125; /** * 随机生成数组 * @param size 数组的大小 */ private static int[] buildRandomIntArray(final int size) &#123; int[] arrayToCalculateSumOf = new int[size]; Random generator = new Random(); for (int i = 0; i &lt; arrayToCalculateSumOf.length; i++) &#123; arrayToCalculateSumOf[i] = generator.nextInt(10000); &#125; return arrayToCalculateSumOf; &#125; public static void main(String[] args) &#123; //拆分的阈值 int threshold = 20; int[] arrayToSortByMergeSort = buildRandomIntArray(2000); System.out.print(&quot;排序前: &quot;); for (int element : arrayToSortByMergeSort) &#123; System.out.print(element + &quot; &quot;); &#125; System.out.println(); //利用forkjoin排序 MergeSortRecursiveTask mergeSortRecursiveTask = new MergeSortRecursiveTask(arrayToSortByMergeSort, threshold); //构建forkjoin线程池 ForkJoinPool forkJoinPool = new ForkJoinPool(); long startTime = System.nanoTime(); //执行排序任务 final int[] mergeSortArray = forkJoinPool.invoke(mergeSortRecursiveTask); System.out.print(&quot;排序后: &quot;); for (int element : mergeSortArray) &#123; System.out.print(element + &quot; &quot;); &#125; System.out.println(); long duration = System.nanoTime() - startTime; System.out.println(&quot;forkjoin排序时间: &quot; + (duration / (1000f * 1000f)) + &quot;毫秒&quot;); &#125;&#125; ForkJoinPool工作原理 ForkJoinPool 内部有多个任务队列，当我们通过 ForkJoinPool 的 invoke() 或者 submit() 方法提交任务时，ForkJoinPool 根据一定的路由规则把任务提交到一个任务队列中，如果任务在执行过程中会创建出子任务，那么子任务会提交到工作线程对应的任务队列中。 如果工作线程对应的任务队列空了，是不是就没活儿干了呢？不是的，ForkJoinPool 支持一种叫做任务窃取的机制，如果工作线程空闲了，那它可以窃取其他工作任务队列里的任务。如此一来，所有的工作线程都不会闲下来了。 小贴士 工作窃取 工作窃取，就是允许空闲线程从繁忙线程的双端队列中窃取任务。 默认情况下，工作线程从它自己的双端队列的头部获取任务。但是，当自己的任务为空时，线程会从其他繁忙线程双端队列的尾部中获取任务。这种方法，最大限度地减少了线程竞争任务的可能性。 ForkJoinPool执行流程 总结 Fork/Join是一种基于分治思想的模型，在并发处理计算型任务时有着显著的优势。其效率的提升主要得益于两个方面： 任务切分：将大的任务分割成更小粒度的小任务，让更多的线程参与执行； 任务窃取：通过任务窃取，充分地利用空闲线程，并减少竞争。 在使用ForkJoinPool时，需要特别注意任务的类型是否为纯函数计算类型，也就是这些任务不应该关心状态或者外界的变化，这样才是最安全的做法。如果是阻塞类型任务，那么你需要谨慎评估技术方案。虽然ForkJoinPool也能处理阻塞类型任务，但可能会带来复杂的管理成本。","summary":"摘要 本文介绍线程池ForkJoinPool相关技术 本文基于jdk1.8","date_published":"2023-05-29T14:34:05.000Z","tags":["技术","java","java多线程","java"]},{"id":"https://blog.hanqunfeng.com/2023/05/25/java-concurrency11-ThreadPoolExecutor/","url":"https://blog.hanqunfeng.com/2023/05/25/java-concurrency11-ThreadPoolExecutor/","title":"Java并发编程--线程池之ThreadPoolExecutor","content_html":"<!--\n **加粗**\n *斜体*\n ***加粗并斜体***\n ~~删除线~~\n ==突出显示==\n `突出显示(推荐)`\n ++下划线++\n ~下标~\n ^上标^\n 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.\n 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600)\n\n +++ **点击折叠**\n 这是被隐藏的内容\n +++\n\n::: tips success warning danger\n这里是容器内的内容\n:::\n\n% note info % success warning danger\n这里是容器内的内容\n% endnote %\n\n -->\n<h2 id=\"摘要\">摘要</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>本文介绍线程池 ThreadPoolExecutor 相关技术</p>\n</li>\n<li class=\"lvl-2\">\n<p>本文基于<code>jdk1.8</code></p>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"线程池介绍\">线程池介绍</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>线程池是一种用于管理和复用线程的机制，它可以有效地控制并发线程的数量，减少线程创建和销毁的开销，并提高应用程序的性能和资源利用率。</p>\n</li>\n</ul>\n<h2 id=\"Java内置的线程池\">Java内置的线程池</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>FixedThreadPool（固定线程池）：该线程池包含固定数量的线程，提交的任务会在这些线程中执行。如果所有线程都正在忙于执行任务，新任务将会在任务队列中等待。</p>\n</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// nThreads是线程池中线程的数量，核心线程数和最大线程数一样</span></span><br><span class=\"line\"><span class=\"type\">ExecutorService</span> <span class=\"variable\">executor</span> <span class=\"operator\">=</span> Executors.newFixedThreadPool(<span class=\"type\">int</span> nThreads);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Executors中的newFixedThreadPool方法实现</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> ExecutorService <span class=\"title function_\">newFixedThreadPool</span><span class=\"params\">(<span class=\"type\">int</span> nThreads)</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ThreadPoolExecutor</span>(nThreads, nThreads,<span class=\"number\">0L</span>, TimeUnit.MILLISECONDS,<span class=\"keyword\">new</span> <span class=\"title class_\">LinkedBlockingQueue</span>&lt;Runnable&gt;());</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<pre><code>- 优点：具有固定数量的线程，可确保线程数始终保持在指定的数量上。适用于需要控制并发线程数的场景，可以避免线程数量过多导致系统资源耗尽。\n- 缺点：任务队列无界限制，如果任务提交速度超过线程处理速度，可能导致队列积压过多任务，最终可能导致内存溢出。不适合处理大量长时间运行的任务。\n</code></pre>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>CachedThreadPool（缓存线程池）：该线程池不固定线程数量，可以根据需要自动创建新线程，也会自动回收闲置的线程。适用于执行大量短期的任务。</p>\n</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">ExecutorService</span> <span class=\"variable\">executor</span> <span class=\"operator\">=</span> Executors.newCachedThreadPool();</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Executors中的newCachedThreadPool方法实现</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> ExecutorService <span class=\"title function_\">newCachedThreadPool</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ThreadPoolExecutor</span>(<span class=\"number\">0</span>, Integer.MAX_VALUE, <span class=\"number\">60L</span>, TimeUnit.SECONDS, <span class=\"keyword\">new</span> <span class=\"title class_\">SynchronousQueue</span>&lt;Runnable&gt;());</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<pre><code>- 优点：线程数量不固定，根据任务的提交情况动态创建和回收线程。适用于短期、异步的任务处理，能够灵活调配线程资源。\n- 缺点：由于线程数量不受限制，如果任务提交速度过快，可能导致创建过多的线程，进而消耗过多的系统资源，甚至导致系统崩溃。\n</code></pre>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>SingleThreadExecutor（单线程池）：该线程池只包含一个线程，用于顺序执行任务。如果该线程因异常而终止，会创建一个新的线程来替代。</p>\n</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">ExecutorService</span> <span class=\"variable\">executor</span> <span class=\"operator\">=</span> Executors.newSingleThreadExecutor();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Executors中的newSingleThreadExecutor方法实现</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> ExecutorService <span class=\"title function_\">newSingleThreadExecutor</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">FinalizableDelegatedExecutorService</span>(<span class=\"keyword\">new</span> <span class=\"title class_\">ThreadPoolExecutor</span>(<span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">0L</span>, TimeUnit.MILLISECONDS, <span class=\"keyword\">new</span> <span class=\"title class_\">LinkedBlockingQueue</span>&lt;Runnable&gt;()));</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<pre><code>- 优点：只有一个工作线程，保证任务按照指定顺序执行。适用于需要顺序执行任务的场景，例如需要按照任务的提交顺序进行处理。\n- 缺点：由于只有一个线程，如果该线程因为异常而终止，线程池将会创建一个新线程代替，可能会带来额外的开销。不适合处理大量耗时的任务。\n</code></pre>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ScheduledThreadPool（调度线程池）：该线程池用于定时或周期性执行任务。可以指定任务的延迟时间或执行周期。</p>\n</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// corePoolSize是线程池中核心线程的数量</span></span><br><span class=\"line\"><span class=\"type\">ScheduledExecutorService</span> <span class=\"variable\">executor</span> <span class=\"operator\">=</span> Executors.newScheduledThreadPool(<span class=\"type\">int</span> corePoolSize);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// // Executors中的newScheduledThreadPool方法实现</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> ScheduledExecutorService <span class=\"title function_\">newScheduledThreadPool</span><span class=\"params\">(<span class=\"type\">int</span> corePoolSize)</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ScheduledThreadPoolExecutor</span>(corePoolSize);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// ScheduledThreadPoolExecutor是ThreadPoolExecutor的子类</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"title function_\">ScheduledThreadPoolExecutor</span><span class=\"params\">(<span class=\"type\">int</span> corePoolSize)</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">super</span>(corePoolSize, Integer.MAX_VALUE, <span class=\"number\">0</span>, NANOSECONDS, <span class=\"keyword\">new</span> <span class=\"title class_\">DelayedWorkQueue</span>());</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<pre><code>- 优点：用于定时或周期性执行任务，可以指定任务的延迟时间或执行周期。适用于需要定时执行任务的场景。\n- 缺点：线程数量固定，如果任务过多或任务执行时间过长，可能会导致任务堆积，影响调度的准确性。\n</code></pre>\n<h3 id=\"为什么不推荐使用这些内置线程池？\">为什么不推荐使用这些内置线程池？</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>任务队列没有限制：内置线程池的任务队列默认是无界的，如果任务提交速度过快，可能会导致队列积压过多任务，最终导致内存溢出或系统资源耗尽。</p>\n</li>\n<li class=\"lvl-2\">\n<p>默认的线程拒绝策略：内置线程池的默认线程拒绝策略是抛出RejectedExecutionException，当任务提交超过线程池的处理能力时，会导致任务被拒绝执行。这可能会导致任务丢失或需要手动处理拒绝的任务。</p>\n</li>\n<li class=\"lvl-2\">\n<p>配置限制有限：内置线程池提供了一些参数来配置线程池的行为，例如核心线程数、最大线程数、任务队列等。然而，这些参数可能不足以满足复杂的业务需求。对于更复杂的场景，可能需要更高级的线程池实现或手动创建自定义线程池。</p>\n</li>\n<li class=\"lvl-2\">\n<p>缺乏监控和扩展功能：内置线程池的功能相对简单，缺乏对线程池的监控和扩展能力。在一些需要对线程池进行监控、统计或动态调整的场景下，内置线程池可能无法满足需求。</p>\n</li>\n<li class=\"lvl-2\">\n<p>鉴于上述原因，对于复杂的应用程序和具有特定需求的场景，建议使用更高级的线程池实现，例如ThreadPoolExecutor类，它提供了更多的配置选项和灵活性，以满足各种需求。此外，还可以考虑使用第三方的线程池库，如Guava或Apache Commons等，它们提供了更多功能和扩展性。自定义线程池能够更好地适应特定的业务需求，并提供更好的控制和可扩展性。</p>\n</li>\n</ul>\n<h2 id=\"ThreadPoolExecutor介绍\">ThreadPoolExecutor介绍</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ThreadPoolExecutor是Java中的一个灵活且强大的线程池实现，它提供了很多配置选项，你可以将任务提交给线程池执行，并根据需要动态调整线程池的大小和配置。它是并发编程中常用的工具，适用于各种需要处理异步任务的场景，如服务器端应用程序、多线程数据处理和并行计算等。</p>\n</li>\n<li class=\"lvl-2\">\n<p>ThreadPoolExecutor的一些关键特点：</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">1.线程池大小控制：你可以通过设置核心线程池大小（corePoolSize）和最大线程池大小（maximumPoolSize）来控制线程池中的线程数量。核心线程池大小是线程池中一直保持活动的线程数，而最大线程池大小是线程池中允许存在的最大线程数。</li>\n<li class=\"lvl-6\">2.任务排队：ThreadPoolExecutor提供了多种任务排队策略，例如无界队列（Unbounded Queue）、有界队列（Bounded Queue）和同步移交（Synchronous Transfer）。你可以根据需要选择适合的任务排队策略，以控制任务的提交和执行。</li>\n<li class=\"lvl-6\">3.线程生命周期管理：ThreadPoolExecutor负责管理线程的生命周期，包括线程的创建、执行任务和销毁。它会根据线程池的配置自动创建和回收线程，以及处理线程的异常和空闲状态。</li>\n<li class=\"lvl-6\">4.拒绝策略：当线程池无法接受新的任务时，ThreadPoolExecutor提供了多种拒绝策略来处理这种情况。例如，你可以选择丢弃任务、抛出异常或在调用者线程中执行任务。</li>\n<li class=\"lvl-6\">5.统计和监控：ThreadPoolExecutor提供了一些方法来获取线程池的状态和统计信息，比如活动线程数、已完成任务数、任务队列大小等。这些信息可以帮助你监控和调优线程池的性能。</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"ThreadPoolExecutor类的一些常用API\">ThreadPoolExecutor类的一些常用API</h2>\n<table>\n<thead>\n<tr>\n<th>方法签名</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>void execute(Runnable command)</code></td>\n<td>提交一个Runnable任务给线程池执行</td>\n</tr>\n<tr>\n<td><code>Future&lt;?&gt; submit(Runnable task)</code></td>\n<td>提交一个Runnable任务给线程池执行，并返回一个表示任务结果的Future对象</td>\n</tr>\n<tr>\n<td><code>Future&lt;T&gt; submit(Callable&lt;T&gt; task)</code></td>\n<td>提交一个Callable任务给线程池执行，并返回一个表示任务结果的Future对象</td>\n</tr>\n<tr>\n<td><code>void shutdown()</code></td>\n<td>顺序关闭线程池，不再接受新的任务</td>\n</tr>\n<tr>\n<td><code>List&lt;Runnable&gt; shutdownNow()</code></td>\n<td>立即关闭线程池，并尝试终止所有正在执行的任务，返回的是尚未开始处理的任务列表，以及已经开始但尚未完成的任务列表。</td>\n</tr>\n<tr>\n<td><code>boolean isShutdown()</code></td>\n<td>判断线程池是否已经关闭</td>\n</tr>\n<tr>\n<td><code>boolean isTerminated()</code></td>\n<td>判断线程池是否已经终止，已经终止返回true</td>\n</tr>\n<tr>\n<td><code>boolean awaitTermination(long timeout, TimeUnit unit)</code></td>\n<td>等待线程池终止，最多等待指定的时间 ，超时后仍未终止返回false</td>\n</tr>\n<tr>\n<td><code>void setCorePoolSize(int corePoolSize)</code></td>\n<td>设置核心线程池大小</td>\n</tr>\n<tr>\n<td><code>int getCorePoolSize()</code></td>\n<td>获取核心线程池大小</td>\n</tr>\n<tr>\n<td><code>void setMaximumPoolSize(int maximumPoolSize)</code></td>\n<td>设置最大线程池大小</td>\n</tr>\n<tr>\n<td><code>int getMaximumPoolSize()</code></td>\n<td>获取最大线程池大小</td>\n</tr>\n<tr>\n<td><code>void setKeepAliveTime(long time, TimeUnit unit)</code></td>\n<td>设置非核心线程的空闲时间</td>\n</tr>\n<tr>\n<td><code>long getKeepAliveTime(TimeUnit unit)</code></td>\n<td>获取非核心线程的空闲时间</td>\n</tr>\n<tr>\n<td><code>BlockingQueue&lt;Runnable&gt; getQueue()</code></td>\n<td>获取任务队列</td>\n</tr>\n<tr>\n<td><code>void setRejectedExecutionHandler(RejectedExecutionHandler handler)</code></td>\n<td>设置拒绝策略</td>\n</tr>\n<tr>\n<td><code>RejectedExecutionHandler getRejectedExecutionHandler()</code></td>\n<td>获取拒绝策略</td>\n</tr>\n<tr>\n<td><code>int getActiveCount()</code></td>\n<td>获取活动线程数</td>\n</tr>\n<tr>\n<td><code>long getCompletedTaskCount()</code></td>\n<td>获取已完成的任务数</td>\n</tr>\n<tr>\n<td><code>long getTaskCount()</code></td>\n<td>获取总任务数</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"ThreadPoolExecutor的创建与配置\">ThreadPoolExecutor的创建与配置</h2>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"variable\">corePoolSize</span> <span class=\"operator\">=</span> <span class=\"number\">5</span>; <span class=\"comment\">// 核心线程池大小</span></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"variable\">maxPoolSize</span> <span class=\"operator\">=</span> <span class=\"number\">10</span>; <span class=\"comment\">// 最大线程池大小</span></span><br><span class=\"line\"><span class=\"type\">long</span> <span class=\"variable\">keepAliveTime</span> <span class=\"operator\">=</span> <span class=\"number\">5000</span>; <span class=\"comment\">// 非核心线程的空闲时间</span></span><br><span class=\"line\"><span class=\"type\">TimeUnit</span> <span class=\"variable\">unit</span> <span class=\"operator\">=</span> TimeUnit.MILLISECONDS; <span class=\"comment\">// 空闲时间的单位</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// ThreadPoolExecutor使用任务队列来存储待执行的任务。你可以选择使用不同类型的BlockingQueue实现，比如LinkedBlockingQueue、ArrayBlockingQueue等。</span></span><br><span class=\"line\">BlockingQueue&lt;Runnable&gt; taskQueue = <span class=\"keyword\">new</span> <span class=\"title class_\">ArrayBlockingQueue</span>&lt;&gt;(<span class=\"number\">1000</span>); <span class=\"comment\">// 任务队列</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 实例化ThreadPoolExecutor类</span></span><br><span class=\"line\"><span class=\"type\">ThreadPoolExecutor</span> <span class=\"variable\">executor</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ThreadPoolExecutor</span>(corePoolSize, maxPoolSize, keepAliveTime, unit, taskQueue);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 设置拒绝策略，ThreadPoolExecutor提供了四种内置的拒绝策略:</span></span><br><span class=\"line\"><span class=\"comment\">// 1.AbortPolicy，默认策略，即当线程池无法接受新任务时，会抛出RejectedExecutionException。</span></span><br><span class=\"line\"><span class=\"comment\">// 2.CallerRunsPolicy，即当线程池无法接受新任务时，会在调用者线程中执行该任务。</span></span><br><span class=\"line\"><span class=\"comment\">// 3.DiscardPolicy，即当线程池无法接受新任务时，新任务会被直接丢弃，不会抛出异常。</span></span><br><span class=\"line\"><span class=\"comment\">// 4.DiscardOldestPolicy，会丢弃线程池中最早提交的一个任务，然后尝试重新提交被拒绝的任务。</span></span><br><span class=\"line\">executor.setRejectedExecutionHandler(<span class=\"keyword\">new</span> <span class=\"title class_\">ThreadPoolExecutor</span>.CallerRunsPolicy());</span><br></pre></td></tr></table></figure>\n<h2 id=\"ThreadPoolExecutor的调用\">ThreadPoolExecutor的调用</h2>\n<h3 id=\"没有返回值\">没有返回值</h3>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 通过调用execute()方法，将任务提交给ThreadPoolExecutor执行，这里的MyTask是实现了Runnable接口的自定义任务类。</span></span><br><span class=\"line\">executor.execute(<span class=\"keyword\">new</span> <span class=\"title class_\">MyTask</span>());</span><br></pre></td></tr></table></figure>\n<h3 id=\"有返回值\">有返回值</h3>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 通过调用submit()方法，将任务提交给ThreadPoolExecutor执行，并返回了一个Future对象，用于获取任务的执行结果。</span></span><br><span class=\"line\"><span class=\"comment\">// 这里的CallableTask是实现了Runnable接口或者Callable&lt;T&gt;接口的自定义任务类。</span></span><br><span class=\"line\">Future&lt;String&gt; future = executor.submit(<span class=\"keyword\">new</span> <span class=\"title class_\">CallableTask</span>());</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>需要注意的是，submit()方法可以接受不同类型的任务（Runnable或Callable），并返回一个Future对象。对于Runnable类型的任务，submit()方法返回的Future对象的get()方法将始终返回null。</p>\n</li>\n</ul>\n<h3 id=\"执行流程图\">执行流程图</h3>\n<p><img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/UmhNjp.png\" alt=\"\" width=\"900\" height=\"600\"></p>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>提交一个Runnable时，不管当前线程池中的线程是否空闲，只要数量小于核心线程数就会创建新线程。</p>\n</li>\n<li class=\"lvl-2\">\n<p>ThreadPoolExecutor是非公平的，比如队列满了之后提交的Runnable可能会比正在排队的Runnable先执行。</p>\n</li>\n</ul>\n<h2 id=\"ThreadPoolExecutor的关闭\">ThreadPoolExecutor的关闭</h2>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 不再接受新的任务，但是正在处理的任务和队列中尚未处理的任务会继续执行完毕</span></span><br><span class=\"line\">executor.shutdown();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 不再接受新的任务，也不再执行队列中的任务，并且会中断正在处理的任务</span></span><br><span class=\"line\"><span class=\"comment\">// 线程池会尽力停止正在执行的任务，但无法保证任务会立即停止。因此，在调用shutdownNow()后，你可以通过检查返回的任务列表来获取所有尚未处理完成的任务，并根据需要进行处理。</span></span><br><span class=\"line\">List&lt;Runnable&gt; list = executor.shutdownNow();</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>调用<code>shutdownNow()</code>也并不意味着线程池立刻就关闭了，可以通过如下方式判断线程池是否已经终止</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>方法签名</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>boolean isTerminated()</code></td>\n<td>判断线程池是否已经终止，已经终止返回true</td>\n</tr>\n<tr>\n<td><code>boolean awaitTermination(long timeout, TimeUnit unit)</code></td>\n<td>等待线程池终止，最多等待指定的时间 ，超时后仍未终止返回false</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"ThreadPoolExecutor线程池的五种状态\">ThreadPoolExecutor线程池的五种状态</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>RUNNING：会接收新任务并且会处理队列中的任务</p>\n</li>\n<li class=\"lvl-2\">\n<p>SHUTDOWN：不会接收新任务并且会处理队列中的任务</p>\n</li>\n<li class=\"lvl-2\">\n<p>STOP：不会接收新任务并且不会处理队列中的任务，并且会中断在处理的任务</p>\n</li>\n<li class=\"lvl-2\">\n<p>TIDYING：所有任务都终止了，线程池中也没有线程了，这样线程池的状态就会转为TIDYING，一旦达到此状态，就会调用线程池的terminated()</p>\n</li>\n<li class=\"lvl-2\">\n<p>TERMINATED：terminated()执行完之后就会转变为TERMINATED</p>\n</li>\n</ul>\n<p><em><strong>这五种状态并不能任意转换，只会有以下几种转换情况：</strong></em></p>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>RUNNING</code> -&gt; <code>SHUTDOWN</code>：手动调用<code>shutdown()</code>触发，或者线程池对象GC时会调用<code>finalize()</code>从而调用<code>shutdown()</code></p>\n</li>\n<li class=\"lvl-2\">\n<p><code>(RUNNING or SHUTDOWN)</code> -&gt; <code>STOP</code>：调用<code>shutdownNow()</code>触发，如果先调<code>shutdown()</code>紧着调<code>shutdownNow()</code>，就会发生<code>SHUTDOWN</code> -&gt; <code>STOP</code></p>\n</li>\n<li class=\"lvl-2\">\n<p><code>SHUTDOWN</code> -&gt; <code>TIDYING</code>：队列为空并且线程池中没有线程时自动转换</p>\n</li>\n<li class=\"lvl-2\">\n<p><code>STOP</code> -&gt; <code>TIDYING</code>：线程池中没有线程时自动转换（队列中可能还有任务，但是永远不会被执行）</p>\n</li>\n<li class=\"lvl-2\">\n<p><code>TIDYING</code> -&gt; <code>TERMINATED</code>：<code>terminated()</code>执行完后就会自动转换</p>\n</li>\n</ul>\n<h2 id=\"线程池为什么一定得是阻塞队列？\">线程池为什么一定得是阻塞队列？</h2>\n<p>线程池中的线程在运行过程中，执行完创建线程时绑定的第一个任务后，就会不断的从队列中获取任务并执行，那么如果队列中没有任务了，线程为了不自然消亡，就会阻塞在获取队列任务时，等着队列中有任务过来就会拿到任务从而去执行任务。通过这种方法能最终确保，线程池中能保留指定个数的核心线程数。</p>\n<h2 id=\"线程发生异常，会被移出线程池吗？\">线程发生异常，会被移出线程池吗？</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>会。但为了保证维持住固定的核心线程数，会再创建一个新的线程。</p>\n</li>\n<li class=\"lvl-2\">\n<p>单个任务的异常情况，不会直接影响线程池中的其他线程，线程池会继续执行其他任务，除非遇到无法处理的异常，例如线程池被关闭或发生了无法恢复的错误。</p>\n</li>\n<li class=\"lvl-2\">\n<p>然而，如果某个任务的异常没有被正确处理，可能会导致整个线程池无法正常工作。例如，如果异常被忽略或没有适当的错误日志记录，可能会导致问题的隐患积累或任务无法正确完成。</p>\n</li>\n<li class=\"lvl-2\">\n<p>因此，在使用线程池时，建议为任务提供适当的异常处理逻辑，以确保及时捕获和处理异常，以及记录错误信息。这有助于提高线程池的可靠性和稳定性。</p>\n</li>\n<li class=\"lvl-2\">\n<p>也可以为线程池配置全局异常处理逻辑，如果线程执行过程中发生了未捕获的异常，可以通过下面的方式处理异常：</p>\n</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">ThreadPoolExecutor</span> <span class=\"variable\">executor</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ThreadPoolExecutor</span>(<span class=\"number\">10</span>, <span class=\"number\">500</span>, <span class=\"number\">30</span>, TimeUnit.SECONDS, <span class=\"keyword\">new</span> <span class=\"title class_\">ArrayBlockingQueue</span>&lt;&gt;(<span class=\"number\">200</span>));</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">ThreadFactory</span> <span class=\"variable\">threadFactory</span> <span class=\"operator\">=</span> runnable -&gt; &#123;</span><br><span class=\"line\">    <span class=\"type\">Thread</span> <span class=\"variable\">t</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Thread</span>(runnable);</span><br><span class=\"line\">    t.setUncaughtExceptionHandler((thread, error) -&gt; System.out.println(thread.getName() + <span class=\"string\">&quot;:错误信息:&quot;</span> + error.getMessage()));</span><br><span class=\"line\">    <span class=\"keyword\">return</span> t;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">executor.setThreadFactory(threadFactory);</span><br></pre></td></tr></table></figure>\n<h2 id=\"线程池的核心线程数、最大线程数该如何设置？\">线程池的核心线程数、最大线程数该如何设置？</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>线程池中的核心线程数计算方法：</p>\n</li>\n</ul>\n<div class=\"tips\">\n<p><em><strong>名词解释</strong></em><br>\nCPU核心数[逻辑核] = Runtime.getRuntime().availableProcessors();<br>\n线程等待时间[阻塞时间]：指的就是线程没有使用CPU的时间，比如阻塞在了IO<br>\n线程运行总时间：指的是线程执行完某个任务的总时间<br>\n阻塞系数 = 线程等待时间[阻塞时间] / 线程运行总时间</p>\n<p>PS: 可以在压测时使用JVM提供的<code>jvisualvm</code>得到对应线程运行的<code>总时间</code>和<code>总时间(CPU)</code>，通过计算得到：<br>\n线程等待时间 = <code>总时间</code> - <code>总时间(CPU)</code><br>\n线程运行总时间 = <code>总时间</code></p>\n</div>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>1.计算密集型：内存运算，尽可能避免发生线程上下文切换<br>\n核心线程数 = CPU核心数 + 1</p>\n</li>\n<li class=\"lvl-2\">\n<p>2.IO密集型：一般文件读写、数据库读写、网络接口调用等都属于IO密集型</p>\n<blockquote>\n<p>方法1：<br>\n- 核心线程数 = CPU核心数 * (1 + 阻塞系数)<br>\n- 该方法下，通常设置为 CPU核心数 * 2，所以: 4C服务器，线程数为8个左右</p>\n</blockquote>\n<blockquote>\n<p>方法2 [推荐]：<br>\n- 核心线程数 = CPU核心数 / (1 - 阻塞系数)<br>\n- 该方法下，经验上一般阻塞系数取值为0.8~0.9，所以: 4C服务器，线程数为20 ~ 40个为宜</p>\n</blockquote>\n</li>\n</ul>\n<p><span style=\"color:red;\">PS: 经验上来讲，方法2更为准确，但以上只是理论，实际工作中情况会更复杂，比如一个应用中，可能有多个线程池，除开线程池中的线程可能还有很多其他线程，或者除开这个应用还是一些其他应用也在运行，所以实际工作中如果要确定准确的线程数，最好是压测。</span></p>\n<p><em><strong>总结</strong></em></p>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>CPU密集型任务：CPU核心数+1，这样既能充分利用CPU，也不至于有太多的上下文切换成本</p>\n</li>\n<li class=\"lvl-2\">\n<p>IO密集型任务：建议压测，或者先用公式计算出一个理论值（理论值通常都比较小）</p>\n</li>\n<li class=\"lvl-2\">\n<p>对于核心业务（访问频率高），可以把核心线程数设置为我们压测出来的结果，最大线程数可以等于核心线程数，或者大一点点，比如我们压测时可能会发现500个线程最佳，但是600个线程时也还行，此时600就可以为最大线程数</p>\n</li>\n<li class=\"lvl-2\">\n<p>对于非核心业务（访问频率不高），核心线程数可以比较小，避免操作系统去维护不必要的线程，最大线程数可以设置为我们计算或压测出来的结果。</p>\n</li>\n</ul>\n<div class=\"tips\">\n<p><em><strong>小贴士</strong></em></p>\n<h2 id=\"Tomcat中的线程池ThreadPoolExecutor\">Tomcat中的线程池<code>ThreadPoolExecutor</code></h2>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">Tomcat中有一个与JUC包下同名的<code>ThreadPoolExecutor</code>，即<code>org.apache.tomcat.util.threads.ThreadPoolExecutor</code>，它扩展了Java标准库中的<code>java.util.concurrent.ThreadPoolExecutor</code>，具有一些特定的功能和行为：\n<ul class=\"lvl-3\">\n<li class=\"lvl-6\">入队时，如果线程池的线程个数等于最大线程池数才入队，如果线程池的线程个数小于最大线程池数，会返回false，表示入队失败</li>\n<li class=\"lvl-6\">提交任务时，会先判断线程个数是否小于核心线程数，如果小于则创建线程，如果等于核心线程数，会入队，但是线程个数小于最大线程数会入队失败，从而会去创建线程</li>\n<li class=\"lvl-6\">随着任务的提交，会优先创建线程，直到线程个数等于最大线程数才会入队</li>\n<li class=\"lvl-6\">另外，提交任务时，如果正在处理的任务数小于线程池中的线程个数，那么也会直接入队，而不会去创建线程</li>\n</ul>\n</li>\n</ul>\n</div>\n","content_text":"摘要 本文介绍线程池 ThreadPoolExecutor 相关技术 本文基于jdk1.8 线程池介绍 线程池是一种用于管理和复用线程的机制，它可以有效地控制并发线程的数量，减少线程创建和销毁的开销，并提高应用程序的性能和资源利用率。 Java内置的线程池 FixedThreadPool（固定线程池）：该线程池包含固定数量的线程，提交的任务会在这些线程中执行。如果所有线程都正在忙于执行任务，新任务将会在任务队列中等待。 1234567// nThreads是线程池中线程的数量，核心线程数和最大线程数一样ExecutorService executor = Executors.newFixedThreadPool(int nThreads);// Executors中的newFixedThreadPool方法实现public static ExecutorService newFixedThreadPool(int nThreads) &#123; return new ThreadPoolExecutor(nThreads, nThreads,0L, TimeUnit.MILLISECONDS,new LinkedBlockingQueue&lt;Runnable&gt;());&#125; - 优点：具有固定数量的线程，可确保线程数始终保持在指定的数量上。适用于需要控制并发线程数的场景，可以避免线程数量过多导致系统资源耗尽。 - 缺点：任务队列无界限制，如果任务提交速度超过线程处理速度，可能导致队列积压过多任务，最终可能导致内存溢出。不适合处理大量长时间运行的任务。 CachedThreadPool（缓存线程池）：该线程池不固定线程数量，可以根据需要自动创建新线程，也会自动回收闲置的线程。适用于执行大量短期的任务。 1234567ExecutorService executor = Executors.newCachedThreadPool();// Executors中的newCachedThreadPool方法实现public static ExecutorService newCachedThreadPool() &#123; return new ThreadPoolExecutor(0, Integer.MAX_VALUE, 60L, TimeUnit.SECONDS, new SynchronousQueue&lt;Runnable&gt;());&#125; - 优点：线程数量不固定，根据任务的提交情况动态创建和回收线程。适用于短期、异步的任务处理，能够灵活调配线程资源。 - 缺点：由于线程数量不受限制，如果任务提交速度过快，可能导致创建过多的线程，进而消耗过多的系统资源，甚至导致系统崩溃。 SingleThreadExecutor（单线程池）：该线程池只包含一个线程，用于顺序执行任务。如果该线程因异常而终止，会创建一个新的线程来替代。 123456ExecutorService executor = Executors.newSingleThreadExecutor();// Executors中的newSingleThreadExecutor方法实现public static ExecutorService newSingleThreadExecutor() &#123; return new FinalizableDelegatedExecutorService(new ThreadPoolExecutor(1, 1, 0L, TimeUnit.MILLISECONDS, new LinkedBlockingQueue&lt;Runnable&gt;()));&#125; - 优点：只有一个工作线程，保证任务按照指定顺序执行。适用于需要顺序执行任务的场景，例如需要按照任务的提交顺序进行处理。 - 缺点：由于只有一个线程，如果该线程因为异常而终止，线程池将会创建一个新线程代替，可能会带来额外的开销。不适合处理大量耗时的任务。 ScheduledThreadPool（调度线程池）：该线程池用于定时或周期性执行任务。可以指定任务的延迟时间或执行周期。 123456789101112// corePoolSize是线程池中核心线程的数量ScheduledExecutorService executor = Executors.newScheduledThreadPool(int corePoolSize);// // Executors中的newScheduledThreadPool方法实现public static ScheduledExecutorService newScheduledThreadPool(int corePoolSize) &#123; return new ScheduledThreadPoolExecutor(corePoolSize);&#125;// ScheduledThreadPoolExecutor是ThreadPoolExecutor的子类public ScheduledThreadPoolExecutor(int corePoolSize) &#123; super(corePoolSize, Integer.MAX_VALUE, 0, NANOSECONDS, new DelayedWorkQueue());&#125; - 优点：用于定时或周期性执行任务，可以指定任务的延迟时间或执行周期。适用于需要定时执行任务的场景。 - 缺点：线程数量固定，如果任务过多或任务执行时间过长，可能会导致任务堆积，影响调度的准确性。 为什么不推荐使用这些内置线程池？ 任务队列没有限制：内置线程池的任务队列默认是无界的，如果任务提交速度过快，可能会导致队列积压过多任务，最终导致内存溢出或系统资源耗尽。 默认的线程拒绝策略：内置线程池的默认线程拒绝策略是抛出RejectedExecutionException，当任务提交超过线程池的处理能力时，会导致任务被拒绝执行。这可能会导致任务丢失或需要手动处理拒绝的任务。 配置限制有限：内置线程池提供了一些参数来配置线程池的行为，例如核心线程数、最大线程数、任务队列等。然而，这些参数可能不足以满足复杂的业务需求。对于更复杂的场景，可能需要更高级的线程池实现或手动创建自定义线程池。 缺乏监控和扩展功能：内置线程池的功能相对简单，缺乏对线程池的监控和扩展能力。在一些需要对线程池进行监控、统计或动态调整的场景下，内置线程池可能无法满足需求。 鉴于上述原因，对于复杂的应用程序和具有特定需求的场景，建议使用更高级的线程池实现，例如ThreadPoolExecutor类，它提供了更多的配置选项和灵活性，以满足各种需求。此外，还可以考虑使用第三方的线程池库，如Guava或Apache Commons等，它们提供了更多功能和扩展性。自定义线程池能够更好地适应特定的业务需求，并提供更好的控制和可扩展性。 ThreadPoolExecutor介绍 ThreadPoolExecutor是Java中的一个灵活且强大的线程池实现，它提供了很多配置选项，你可以将任务提交给线程池执行，并根据需要动态调整线程池的大小和配置。它是并发编程中常用的工具，适用于各种需要处理异步任务的场景，如服务器端应用程序、多线程数据处理和并行计算等。 ThreadPoolExecutor的一些关键特点： 1.线程池大小控制：你可以通过设置核心线程池大小（corePoolSize）和最大线程池大小（maximumPoolSize）来控制线程池中的线程数量。核心线程池大小是线程池中一直保持活动的线程数，而最大线程池大小是线程池中允许存在的最大线程数。 2.任务排队：ThreadPoolExecutor提供了多种任务排队策略，例如无界队列（Unbounded Queue）、有界队列（Bounded Queue）和同步移交（Synchronous Transfer）。你可以根据需要选择适合的任务排队策略，以控制任务的提交和执行。 3.线程生命周期管理：ThreadPoolExecutor负责管理线程的生命周期，包括线程的创建、执行任务和销毁。它会根据线程池的配置自动创建和回收线程，以及处理线程的异常和空闲状态。 4.拒绝策略：当线程池无法接受新的任务时，ThreadPoolExecutor提供了多种拒绝策略来处理这种情况。例如，你可以选择丢弃任务、抛出异常或在调用者线程中执行任务。 5.统计和监控：ThreadPoolExecutor提供了一些方法来获取线程池的状态和统计信息，比如活动线程数、已完成任务数、任务队列大小等。这些信息可以帮助你监控和调优线程池的性能。 ThreadPoolExecutor类的一些常用API 方法签名 描述 void execute(Runnable command) 提交一个Runnable任务给线程池执行 Future&lt;?&gt; submit(Runnable task) 提交一个Runnable任务给线程池执行，并返回一个表示任务结果的Future对象 Future&lt;T&gt; submit(Callable&lt;T&gt; task) 提交一个Callable任务给线程池执行，并返回一个表示任务结果的Future对象 void shutdown() 顺序关闭线程池，不再接受新的任务 List&lt;Runnable&gt; shutdownNow() 立即关闭线程池，并尝试终止所有正在执行的任务，返回的是尚未开始处理的任务列表，以及已经开始但尚未完成的任务列表。 boolean isShutdown() 判断线程池是否已经关闭 boolean isTerminated() 判断线程池是否已经终止，已经终止返回true boolean awaitTermination(long timeout, TimeUnit unit) 等待线程池终止，最多等待指定的时间 ，超时后仍未终止返回false void setCorePoolSize(int corePoolSize) 设置核心线程池大小 int getCorePoolSize() 获取核心线程池大小 void setMaximumPoolSize(int maximumPoolSize) 设置最大线程池大小 int getMaximumPoolSize() 获取最大线程池大小 void setKeepAliveTime(long time, TimeUnit unit) 设置非核心线程的空闲时间 long getKeepAliveTime(TimeUnit unit) 获取非核心线程的空闲时间 BlockingQueue&lt;Runnable&gt; getQueue() 获取任务队列 void setRejectedExecutionHandler(RejectedExecutionHandler handler) 设置拒绝策略 RejectedExecutionHandler getRejectedExecutionHandler() 获取拒绝策略 int getActiveCount() 获取活动线程数 long getCompletedTaskCount() 获取已完成的任务数 long getTaskCount() 获取总任务数 ThreadPoolExecutor的创建与配置 1234567891011121314151617int corePoolSize = 5; // 核心线程池大小int maxPoolSize = 10; // 最大线程池大小long keepAliveTime = 5000; // 非核心线程的空闲时间TimeUnit unit = TimeUnit.MILLISECONDS; // 空闲时间的单位// ThreadPoolExecutor使用任务队列来存储待执行的任务。你可以选择使用不同类型的BlockingQueue实现，比如LinkedBlockingQueue、ArrayBlockingQueue等。BlockingQueue&lt;Runnable&gt; taskQueue = new ArrayBlockingQueue&lt;&gt;(1000); // 任务队列// 实例化ThreadPoolExecutor类ThreadPoolExecutor executor = new ThreadPoolExecutor(corePoolSize, maxPoolSize, keepAliveTime, unit, taskQueue);// 设置拒绝策略，ThreadPoolExecutor提供了四种内置的拒绝策略:// 1.AbortPolicy，默认策略，即当线程池无法接受新任务时，会抛出RejectedExecutionException。// 2.CallerRunsPolicy，即当线程池无法接受新任务时，会在调用者线程中执行该任务。// 3.DiscardPolicy，即当线程池无法接受新任务时，新任务会被直接丢弃，不会抛出异常。// 4.DiscardOldestPolicy，会丢弃线程池中最早提交的一个任务，然后尝试重新提交被拒绝的任务。executor.setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy()); ThreadPoolExecutor的调用 没有返回值 12// 通过调用execute()方法，将任务提交给ThreadPoolExecutor执行，这里的MyTask是实现了Runnable接口的自定义任务类。executor.execute(new MyTask()); 有返回值 123// 通过调用submit()方法，将任务提交给ThreadPoolExecutor执行，并返回了一个Future对象，用于获取任务的执行结果。// 这里的CallableTask是实现了Runnable接口或者Callable&lt;T&gt;接口的自定义任务类。Future&lt;String&gt; future = executor.submit(new CallableTask()); 需要注意的是，submit()方法可以接受不同类型的任务（Runnable或Callable），并返回一个Future对象。对于Runnable类型的任务，submit()方法返回的Future对象的get()方法将始终返回null。 执行流程图 提交一个Runnable时，不管当前线程池中的线程是否空闲，只要数量小于核心线程数就会创建新线程。 ThreadPoolExecutor是非公平的，比如队列满了之后提交的Runnable可能会比正在排队的Runnable先执行。 ThreadPoolExecutor的关闭 123456// 不再接受新的任务，但是正在处理的任务和队列中尚未处理的任务会继续执行完毕executor.shutdown();// 不再接受新的任务，也不再执行队列中的任务，并且会中断正在处理的任务// 线程池会尽力停止正在执行的任务，但无法保证任务会立即停止。因此，在调用shutdownNow()后，你可以通过检查返回的任务列表来获取所有尚未处理完成的任务，并根据需要进行处理。List&lt;Runnable&gt; list = executor.shutdownNow(); 调用shutdownNow()也并不意味着线程池立刻就关闭了，可以通过如下方式判断线程池是否已经终止 方法签名 描述 boolean isTerminated() 判断线程池是否已经终止，已经终止返回true boolean awaitTermination(long timeout, TimeUnit unit) 等待线程池终止，最多等待指定的时间 ，超时后仍未终止返回false ThreadPoolExecutor线程池的五种状态 RUNNING：会接收新任务并且会处理队列中的任务 SHUTDOWN：不会接收新任务并且会处理队列中的任务 STOP：不会接收新任务并且不会处理队列中的任务，并且会中断在处理的任务 TIDYING：所有任务都终止了，线程池中也没有线程了，这样线程池的状态就会转为TIDYING，一旦达到此状态，就会调用线程池的terminated() TERMINATED：terminated()执行完之后就会转变为TERMINATED 这五种状态并不能任意转换，只会有以下几种转换情况： RUNNING -&gt; SHUTDOWN：手动调用shutdown()触发，或者线程池对象GC时会调用finalize()从而调用shutdown() (RUNNING or SHUTDOWN) -&gt; STOP：调用shutdownNow()触发，如果先调shutdown()紧着调shutdownNow()，就会发生SHUTDOWN -&gt; STOP SHUTDOWN -&gt; TIDYING：队列为空并且线程池中没有线程时自动转换 STOP -&gt; TIDYING：线程池中没有线程时自动转换（队列中可能还有任务，但是永远不会被执行） TIDYING -&gt; TERMINATED：terminated()执行完后就会自动转换 线程池为什么一定得是阻塞队列？ 线程池中的线程在运行过程中，执行完创建线程时绑定的第一个任务后，就会不断的从队列中获取任务并执行，那么如果队列中没有任务了，线程为了不自然消亡，就会阻塞在获取队列任务时，等着队列中有任务过来就会拿到任务从而去执行任务。通过这种方法能最终确保，线程池中能保留指定个数的核心线程数。 线程发生异常，会被移出线程池吗？ 会。但为了保证维持住固定的核心线程数，会再创建一个新的线程。 单个任务的异常情况，不会直接影响线程池中的其他线程，线程池会继续执行其他任务，除非遇到无法处理的异常，例如线程池被关闭或发生了无法恢复的错误。 然而，如果某个任务的异常没有被正确处理，可能会导致整个线程池无法正常工作。例如，如果异常被忽略或没有适当的错误日志记录，可能会导致问题的隐患积累或任务无法正确完成。 因此，在使用线程池时，建议为任务提供适当的异常处理逻辑，以确保及时捕获和处理异常，以及记录错误信息。这有助于提高线程池的可靠性和稳定性。 也可以为线程池配置全局异常处理逻辑，如果线程执行过程中发生了未捕获的异常，可以通过下面的方式处理异常： 123456789ThreadPoolExecutor executor = new ThreadPoolExecutor(10, 500, 30, TimeUnit.SECONDS, new ArrayBlockingQueue&lt;&gt;(200));ThreadFactory threadFactory = runnable -&gt; &#123; Thread t = new Thread(runnable); t.setUncaughtExceptionHandler((thread, error) -&gt; System.out.println(thread.getName() + &quot;:错误信息:&quot; + error.getMessage())); return t;&#125;;executor.setThreadFactory(threadFactory); 线程池的核心线程数、最大线程数该如何设置？ 线程池中的核心线程数计算方法： 名词解释 CPU核心数[逻辑核] = Runtime.getRuntime().availableProcessors(); 线程等待时间[阻塞时间]：指的就是线程没有使用CPU的时间，比如阻塞在了IO 线程运行总时间：指的是线程执行完某个任务的总时间 阻塞系数 = 线程等待时间[阻塞时间] / 线程运行总时间 PS: 可以在压测时使用JVM提供的jvisualvm得到对应线程运行的总时间和总时间(CPU)，通过计算得到： 线程等待时间 = 总时间 - 总时间(CPU) 线程运行总时间 = 总时间 1.计算密集型：内存运算，尽可能避免发生线程上下文切换 核心线程数 = CPU核心数 + 1 2.IO密集型：一般文件读写、数据库读写、网络接口调用等都属于IO密集型 方法1： - 核心线程数 = CPU核心数 * (1 + 阻塞系数) - 该方法下，通常设置为 CPU核心数 * 2，所以: 4C服务器，线程数为8个左右 方法2 [推荐]： - 核心线程数 = CPU核心数 / (1 - 阻塞系数) - 该方法下，经验上一般阻塞系数取值为0.8~0.9，所以: 4C服务器，线程数为20 ~ 40个为宜 PS: 经验上来讲，方法2更为准确，但以上只是理论，实际工作中情况会更复杂，比如一个应用中，可能有多个线程池，除开线程池中的线程可能还有很多其他线程，或者除开这个应用还是一些其他应用也在运行，所以实际工作中如果要确定准确的线程数，最好是压测。 总结 CPU密集型任务：CPU核心数+1，这样既能充分利用CPU，也不至于有太多的上下文切换成本 IO密集型任务：建议压测，或者先用公式计算出一个理论值（理论值通常都比较小） 对于核心业务（访问频率高），可以把核心线程数设置为我们压测出来的结果，最大线程数可以等于核心线程数，或者大一点点，比如我们压测时可能会发现500个线程最佳，但是600个线程时也还行，此时600就可以为最大线程数 对于非核心业务（访问频率不高），核心线程数可以比较小，避免操作系统去维护不必要的线程，最大线程数可以设置为我们计算或压测出来的结果。 小贴士 Tomcat中的线程池ThreadPoolExecutor Tomcat中有一个与JUC包下同名的ThreadPoolExecutor，即org.apache.tomcat.util.threads.ThreadPoolExecutor，它扩展了Java标准库中的java.util.concurrent.ThreadPoolExecutor，具有一些特定的功能和行为： 入队时，如果线程池的线程个数等于最大线程池数才入队，如果线程池的线程个数小于最大线程池数，会返回false，表示入队失败 提交任务时，会先判断线程个数是否小于核心线程数，如果小于则创建线程，如果等于核心线程数，会入队，但是线程个数小于最大线程数会入队失败，从而会去创建线程 随着任务的提交，会优先创建线程，直到线程个数等于最大线程数才会入队 另外，提交任务时，如果正在处理的任务数小于线程池中的线程个数，那么也会直接入队，而不会去创建线程","summary":"摘要 本文介绍线程池 ThreadPoolExecutor 相关技术 本文基于jdk1.8","date_published":"2023-05-25T15:34:05.000Z","tags":["技术","java","java多线程","java"]},{"id":"https://blog.hanqunfeng.com/2023/05/25/java-concurrency10-BlockingQueue/","url":"https://blog.hanqunfeng.com/2023/05/25/java-concurrency10-BlockingQueue/","title":"Java并发编程--BlockingQueue","content_html":"<div class=\"hbe hbe-container\" id=\"hexo-blog-encrypt\" data-wpm=\"Oh, this is an invalid password. Check and try again, please.\" data-whm=\"OOPS, these decrypted content may changed, but you can still have a look.\">\n  <script id=\"hbeData\" type=\"hbeData\" data-hmacdigest=\"f6d7b54603bea4e66ca7bcbe400d35e330bc18c7dd479491902bc306e2a09346\">83e4f756d680019cc75bb3d7e0230dd0b412a416fdea7528d7e9580f6601b2f16c3b74a5d9a5a1da5dd61984e78f0c846a143ecfd5bba379448319807926070c9261aa0fe10bb6f9896ce6f30c9802b7817ce47b5373bb66b6065433067a6176900f891b25ad8f0512f52d29ee75cd3ca8a32a796d253fa17c333d3f711ccbe24f46b73c4094a1d22189cb0a8a140cbd5a088bdb5087c3152c50047f9ab29a03520922ed1473037268b711b17e5d1379d53a4bb76ca4a83340902391de7e7ec1f38c9c8e03327ae25b45f0257dbcf824e46957a2eacb1e308b8fa8472f1b83a8bcc9a8160e981abcb3d1ba30e909ba4fba3980a0c31df7579dc87d797917337ca479a51c09ace72470072c706db76b4621711ab30673bc24149caeac1aa693d644b7692e450c13b7001eac4bd41390809513a1655a130eb440b409ae493deab0672f6807dc5a972d68746e21fe07cad0015a48f47ba88ec7783c353f9d7d333c2dcea3bc8c97a40e5466f0a5aa369c1e3847c1a7a69dda3164b71f49973f30e36e190eb60a806d1c5ea611ddf61e90662860e9f69ad3b89eacb54e7593f925c888789630a77e54c1b76f26163e3e3f286c79d0ca49c845af705deecbed52de6bf77e11dba37461f4adec200886d8ccef97801bc21c2a184a11526e81658baa8482b417f6e2b2a7f1680f18a8b9d54a093e8a2a95523879bef658d040be5ac1b76fb4fab5fdac9bc549ed8d3a97c7514aac148d18eefd093f4c3be32cdde36dba49d50f182a5b9524754252a35b87e69c29f4c208b23d956794403aa7b64cc0294ce7ad147246f8b73ff2dead1a9ffb42fbe28225d4a092417d2f75c5d79b4ba74073d830f27fe86a8af8fc7b103bedc7d2d67c8f230d835305c9e4f385b2324c1b388e6f5f7ebe30ec698ed566bdc70e14d7c15e432cf84a057c5b167716edc065a35e1ba6a88b261d46acbf43aa81fb3c227ce0044c8dc715c806896104f94ae9d7cd42cd3255e2991c71b2cd4bae2591f4f0ed84a8e4750db164e394cc3b7948d8a4c8d5c1482171a5f38e12a56ef416afd326766f9920c368e7c20eea2a32bf02abcd83d9ef84007aa4d1c55a2657162ebb7ccc3509097b914ed6e9ba8fbad114b1834e67e4b4715f3b3e236232e31f145f6e4414913ed297a8a39f9cbcca2f939cf65932b7b3d525cb4677b7d58b608cbb03846ffffec4adb7b2151b88fea005c51e53c05db1b28266b75fe1b55d306638ee6818854adfc4a3f3eab850b5d2d569bcb69a57e2cb29338f7a7d6560cdc9e5cff4422a9f8c1cfc95df0db54304d49d4869e9518a177d495750e7a6424377cbdb9477521c0fec9ffa354e4f9566351fbc722d6249a74c46b541d6f4593cc1e6635bef88ba48de4c2e85a6bf9a8bb0fd9da4857f21e0218c15075c660830c4a044a01a2ad7cf7d2e4a87bc789b2f2454e80e0ed72aef3c3d19070f04218df44f4ca11a083c5e8fd548aaafbaf7ae70fc62e5c618363bb3082e9ac6e760243f257c2f0b0224cf15fe312603c0fa81d9f79e0033e79ea9fad0b9afff0fbee56de193caad1e9077460bcb21198bb326cfa754a4ccfdc138b375e3c70541957e5665d33766672e9cb72a3a8b8b9fe494d87a3cfd26881cd0b17818658e4c423701313db70d8766210287dc8465108f2c9996d1ef6c948ab9890c2bcb7c2d370da76ffbf27d611e2d12119023f14129d5f52e32fe7d7e2fe7a7878b31481093f0d68df50f68473042d5164699288d3a99d9985c5e0fbec11fd12a8e849a4c130779ff1c8667ebbc5a5416a23138ed901c5aef969d2798e80a34be011ea61b6b32e12f555fea75e71d0ec86b1d7d977b91c05faf66f2b9622985b9c7033f056ce6f28efbb275366c907cef920bc76b8adea8d4897d239d1177f2a5777b869048df2bba775fa572876eedf15fb74336d78799cd348540161c1c6b9b51c0886f2f6583ff2201756cfbd31077e0bfdbfa99ef0eb03dcb95f4c74f262a7e7b35779b1dca6f33b226358a5e715b517b9cc38b5d2a36815ee4542721700adde7c8eab9a4d30537af69b546d3c5ce92394399078d427add8bc1e1a1908f8305e39af128d05fcc6ddbd68bdfb892247d5df0a44d4a6108043fc6c681bba47a32e06f83df57c5b819c1ec835c17b0f90d6fb79d8b814c259b04790af6f9977089df3d176d77fc6606645d0e44f548f960ffa525970ef2805c2acf0c8efb399496f5f89fe1a2bdfb662ee3419fa84068d5dbec5a1193a9e8e9d3d8d4ba7665c3022eb51ac47b36caba1d3210cacba2ed2b0945e2816d035059436669f16c2f7cadd506ea0df0cececc9055d0e1f2b8470e34f698b3d2bd4db05ea2917fac43cf17c1f6428e510f05315fc65b597cab7e38bae06e1ba921ef674766ca6f38444fe5fc7103d95a4cf062fe2c3d1dd95aecfc2b7368e7e52b9be97ac904f4d8c0b45232ae0723e025405e2ec097a520fff8ec9b16df1b5417af0c04ad80f94a2251d2a0cd7b967617012a2c7b933326d3da1a412bded92eb4276709bccde039d17b30f30dc8708887ce853317cd94ca8009895aec314d8e1931e12cb7b02c932d340a5a287a937e77cc8a5ba9ec42bcdb4bb06f8b11b1d639316f6633bbb73e33509224cc4cf45d23516c85a596472fd74e6fb5395447de3efdef0fa22f8a03cc98d00c484c38ed4b17e6d5f2e6fe4f5b28b4bd262b32b898142f334067c2c6100efd2a9853ddaeb8da57c3b4082bcdd43980c80dce47dca13a6b95c78a9166f58fdd06b87e32da3a446a82187a1ceb02bd33f301e6e79e50b0369bb11474c495ea918a72c6a2f02f08b048d4c79ce13cf3d2a929ad0ad5883dcf90589cde533ffa661911264871615a4718915c8d55e9a788d8c2f2b37e397432bb1ca1916cfb090467d0a6eeb599ae64dea23fd7be4586de260d7b192caf1f4cf616cbb011505511666d41b7708385c0744ca24bcfe4e3582d7fece5477dab9d1c44c13d636709e0408887c015dac4ff9273ba3c036b3ab21c6f48616687f5b5c16bf591ab9777e8c7df0dd2312ea1ceabdf6a882cb0117d5fb9a755ccbb6af6b0f5fbe2be4722941ef45b3ff8c97ba41a461a6cc43ab0c7ce6199f609916f011ad578151fc2d4d4618f4cc757d4e64eabef988751533230c2a0b2acc02976bc44e024262fb6c47b7caa6e41a7d8d70c1915294e812de686d1dbd6ab1cdec33074f6723f0c0314a30bd32c7f16439c83698e6f9597502175ef94b70adf333a6f2e4159544817491bf1127f5496388146b2e140fd985275fd51009c978cef40d26433056c4297fb1ec60f8fe4cd5adc1f10a9b6fc399f88848d750d5e99aec28098ccd6e8165f0bde1fb696037983e0c7273f9b0208e3c475246ebfbd8b180188571f8955d8354ebe9b9194b1a464d0e9aa3f79351b0e43d999d177d405bd06ed0c18105ca47e45d99ef37f08b148d22d759d3bd788653378ba13c0e95c0b62be9a186dcca2ea0c1568c6c8f7702ffdc418e49f8db4d735b21a1130070be77cece59ef062d0c0600fc025844af47c3df490dad2f6e294c183f90eaff1044aeb7650c77f4b5df32f1d42df423d37a8577389533871696a979dbe82f6da2f6457eee520fe3c6099af6962d09c336263549996014371a198b5bee064f62a2730107f8fa0713191089708185ff8dfc042fc4d2f1f0950a52a2a50378d23dc0ce796fc948163b45b90dacc65e1af213c96b035c3167087ca1c6231a0afcb8b29b39c643e743e6244eba9a3e132bf5456ccbb3d50cd189493c272481e9b7212ab584e9955808dd7b1ec04736b3d22269a1f18bc2c5aa88fe82fa8ed1596b76ef9a120ea42aeb75a7378a4a92be23c43b6cbe8b834a7f8dee2c3f8a9358ad2e6f61d3eb90803fe805c788972a7b94e44b6292b916a033b7cbf1f53faf11c3593b24386b7efb2e70a4a714ae6ddf2b43c85060ec3e278beb6e21c7f5a74e95633f17a43f1d6989df134ada771ec412ea515726a0100ad9eb063f1f10e8bc46a0d9daf54eab5fa0f6def477372004bd05917fedb5e13b9d647f077a4acf9d4a7858be837cec1cbe91edb9e92444441592f5fe376acd9b869d6c2f83a3f2dec87fd4c0d13e80be7f0486ae445f1952e0979d5b01c77d7a17cee95b55d7a672d98bc220c09eb15151eb14c48727513d86696434cf52cd21bbee9c8bc7c3b28d4cb6da476033c76a2c4affd2d1cacd0e7098805f1d3b1b0ec68afc07b9c3e2e5e82687d2b89bb91d9ed1c838df3e87e4ef81c18f45223725e9311677fa51da359ca79e6bc9c04f4504cd92b4370da653e8eb57f6971b56ee392464447c3a260671382f8ed4df8535fd12661c64bda592736b26a3e1a0bc49e572f59347093e901c8e7110cd6570b26255877248eb640c8ad0675fcd8a0621625534c8d003b68961cf99684d50a2c6489a2b21f47cd103b094a9f97c185702a433c9a0cec53da4a55d9d0b8ecaf39f54ea0cafeaa13686491ad4ab151305b4efc591cdc019bc214fc800d49fcc189c17504b70374af6da9d0a504ea682641c19d49ca1aa9a460877c9ed8726f8105674909a0527aadd78434365ab25110818301370ba2ba45f5a0723db2c6b132793a4aa3d0a949e54ebedd64108f09eb394ee067e96392725ddb27d5611e2dcd5789f3e9703571127e2a90471ac99575482370d331a12a002624274cdc5ecad9fdea33835fe046cecb506e448ef1e7abf210c657a1815607c3ec407f7246335d6d3fbba2955599ba4e746cf3c41a2457867dd9e16dbeea37fac9692ea10f9c6bb7b358b1ba3e32613e40c84435f72b842483651de92912f130aa0c4e200d36832966b35826b4d5d57d7058868a28c238504b9f4b094200a37e13745ea5b5340a991eb81f19c561a0a7f866e3602559cad62980513c971b3e869d7a74169720784492e0cba34ef2c18f94a5affd7edada73260f152c265891fb8baf32af5dd7df654b417dc2d529dd15a761f17650daa4442b5e4d47de58420e9a93eb19044046c30b2d18fe53a0861a5651f1869e0c2da7d6251d2cf5c36db109030f58dd85e8e599c2d64d454c13b1afd36330477c06e2fb7c78d1a4dc79a9da5061877fb26115ea57e8cfd205567d671129d611e45872b1871f53bb02dc247db16600196770805b27cba03b52499f12149f0126f5dc8768d221292cb5ee54cc64a404c6f29cb75e492262461080699f81511db7373013ceb50a889b2b562a93a92c8e58c557a10fdb8693d0650dc0fa709bc40cc8b153389cf9b03be70a38e472e8b240aa7b702d23a8ebca67c1b1e7f3fd68412ee830be97a5a907a2bba83d046b382bb5992728d7ff26f7375e4d8bff2a8e6deeacce6a8198ca6c848d4ace26b1485c58ef24026a4509fd249b2cbc4aa27b3c93d105421f27950694d88c9e2cddcd05f81e6ae6841c72384f1514b5c25f078e5c5ce04f1cff56c9e3b6dcfba82e808b4f5806776d164f9e2fb010a432fea1628f5c97ba5904d4413daa6441788721ad4007beab15f737a744cb88f5997480874ca1b05f7967be087e7ec6808bfeab49f5c3d71891998f5c8dea894a42c0489c68c6f3ca98138b8b9f98e7557afce6467f4d4d8cdd0a5eb5d8f117d584a24617229df28e3f16eb66cf49963848d2880f45b49d5d350fd760d4cec67ff4a088b227e9ebecac02fa320a0afa4e3a0988bca281f2f03074bcce4fc4d350e8643c8ecfba2bd865202f0c86be0e17af1d9e60c4a4b7e447433f5b9d6948ee2a2ff59ef8e84a1134180147b729e1e61ecfd447cfdce47fbe1492842d5dc8e83658cf7c571be24bcb6c92babdebf1f63ad7bc27b31f74b9be9ea8282473005b108c0ac1c17cf39f09549026e95cbaa1f6c6b6f0a83454ef7a4bfd11d78265c2999a87da4f4a767e924f45088151f4e1390008772b5eb276d8a81e9d3d4f9b0473d9a0dd0360bfcebc88f9a188482c4af91fed3afcbac4e1418cfb789a2a60787c5e4d3502b954177b27e7b7fecb6223a7cc4fe8938ae8b7013608958007f90d8f46cc6043ec5fd858bfb73a28171d4961eaeaca58396b13bb7b2a688e9cc08add58aa6b1dbe047a1cab4c38bdb958745cf2a65720b9be8f9b28cab5b96072250715b8b342521080248a0f039cc4c9541d4dc8f0f443de04b8ee7fd4176d66c2d17f994bf8e12f9d00ddcf3bbdf3145055dd1fc30ee6e98698191113062dba86f69dc79f62a82b6c59628fd366a2248f4e54deeb4a0bfc71bcec3a3f642f055037f5c7f3c40d9631b9ad2be012cd237db180f9b600c204da4d14ccdf4cd0500423612d10af7113767f715e4192b129023f9018c413d544aaa1dba3ac5531e92a7d0866b940bb1dd90c73a83286f523d7adb00078a86c220a06504293d6130e132a73c407a85bc876e9e0899e7528def25fad550ff8e0eab28c67b523053e266bede4225506df9c067e2887b181d7270450a034c6bcc868bd64ed6981d05b080dd7fd0bb56606beb32b9720e6876418d32a1baf644b50dd614550d817da2c1ceffafd5a200614319f89e63087026973f96b9e349adfc5e199bbb1decc4548f682a569cd4d4a1bc05972308ac266780abcd60104b47e979449e0655f7b647f4094397ed331f09e7aadcf098c39f5ccab6b8d5217c01c41cf9c3586eeba06bfd56da4372ddcf24e40e7db37914b11538cc98467bbe9520cd2488b58b37081a9648240c89ed5b877d9d7349e27fc34426e81e8c1ea3d4caf366eb007fb3fa5493c2b925ecd2432def49d786488e168c9fa338df4062f4786d94ca557576f0f9a57eaae6551ff0d462e98bd941d030ecb39a8fca3a6b13ad5b0a0bec37b24bf357e5a7c3619f67ef2374ec4e52c22c87c9c9ebc59a51d83a984697c4b2eacdb60ca6d607f4bdf38924530af472af5bd70540b621a7549c25bbce59d68f578c3dcd7ab48b7869cbf90af82abd872f125766ff1d77c97f3f2c2f527fa1fa753380aacaa772637539d816f865cb077bc2475bad216b0ed2b995b2fe44898ac4ed0bb7f03daa13a00e58459b557a1e149eab1d5b309340250ab8130d37df6b6d6872003eca48af9b575b22e1cf71332323d6d03715d117ae7eb58c74ecc8fc22a3c914255fd989e9574a1f7d9fad2248c193ef76c6c089b355f5915d1ad77025a75b27642a7676740d6ac5ec2ea4c64c35f714662c011af6eccea4ddc1f5d3f2fecd2a5795f27ffb00427c04ee39f43294330794d1776ac0c9fa117ba715fe0cb9542c3717fc1fe0a47858e6123d5dd11ea0f5b9df49d9b0ba525effd312a76d53835ba7ed0fe5c5b1e00b2061d5bf0004301a05e656c2d6ca674d09177794231d0d7fdb0bcd85e91d6207d2a3ace2337e860a27a574716c0c8f9fadd29e47e5fe3f736774e52b05d74faf7c16908719e70b7a91d365dc3749d5a0f7db55111d7f251a1dc58483b3dabf303d0221420f4e1607a932c5f23aeed2deec0d08132599b9e0338e5af42c2e7b1d8c52ac7cd97af6435a79e03b3de491373414bdcd2aec150a7f4fcb64a9981b33beb4c3cd82937cb42695303dabdf7e67dfb21fe3933e55850d8abac45c848fe1b82ccb4fa3094c1dd6b64f8b45543a6d10aece06e6b4532f745d8c087fcd5bb4ad80595d8f141e48e258b9421fadc10efadd6d591834faa512aa1f4a28fabc815726a78bc11a335392167e7835e90ba31be8d24faf62f7bcd5b36719185688cc018df06ac1648e3da0b1e199e7b3d05fad19d43e8b5c357a58811b6a139bd9c57d75d4a2ab2f8b78d2d2d0ccad9c9e77e2038e624e30a65e3f6f6f8f5db634307bb10420a54b45b10f6cea93b6e0a86bb299773134acbee4cdfd1dbf38771b48998e4de034cb04989413a146f5e7ada894b6af0d222545c2e9819e3005df0bb747507aa7c22e78de030c3697334087140ea232cd356ed932590f0ad7312312f705a74ebda359f4f764b7232c38e30e09c82336e274a702b094547d12e382fc20c19731442a9c1a9cb41c63e0ef92de3ca7fba1b43f3a8b1e31ca8931ae64620851c35bf37a3480d241d20ac72c30bc9440aaf57a49785cf53b25199148adee7d4ccf4948095730e536b0a513e7997ea8837079b12e19186da916f3d1d6211593109a5b56acedc7e226d7fb47852d563c64fbbc7820e1e960899d88ef26d15c7453e561cec1bf6ff3d9479f077ae48218c27275bf427353fa573ae605bdc09b863a6f2dbe8eb5875920bb2b463f792e70574773291a337f08208a277f785b9ceb6f608e6d46ba6e12f2b21db3bc942fdd22c1dadfc791d84dcb6b131c3e5a636bd5609b4dbe273122b6b9f38b3d0b966ed9c91c61ac382232fa8281ff5ac6d21ddaf14fc87b035d46e32a07835ac596f18e6e1d9a668e7106ab8d95fe2da5d39265979cf69bd489d909b9b3ab8655b5718250152442afa1ec1cc30a4693ad42a0dae730ab80c8409ae874a3f5b4db669af910aa16813b52082738b58b5b295187117f4a3e56dd2df22b5b9f93d8863c6b6fcdad86b9f07cab9166e135fa8ec6921f9d4d75a25669788be15685856922a23a3d0866462ae3c2280190c7a808c37ef5274bbbec3f07373a7939f2e41c43e9d945e8b1af0bea44c1686e8f3c23e91ffd74b3b5b13da19316ebd7e66fd3c07af8e004c322483ea255ceb0187bc9b315257a9199c3e7fda912e0586371bc3860631ba9941baa661af6e50852b6309a594fdce3ae841315677cfdfc9ad1ae31c7955d61181250f49dace9b6e3d3c0afd2089fd4bc52cab4a58e7836a739ca94db38eedc4fd29905d7a500cc7fcefbdc41c9b81afd6d059c7dabfb0072271ec5064d3beca44130683f177b4eea21affee070f7f403a922cfea1ded829a4bb5441c62d2db379893b49de5fb0184b02c4423eafe191688a98f2c779de3dd837d82502f13a8e64de0a7a5eef43968fb159725a0c1ab09a476beb9301418339efb37b6ebe14a51b5dab9a8125a43cf65d40368c3f7c1fd0836374335f0ff8a8689c6f0539eb81ab3b065c55479f5d06a6e77afbaab492ce92cc1f665f877b107593b86d62b65e907ef713d87bd2a70b5b359ee64d63aa30766bae5426fad34b9dcbe1e79f8a41cdf196d72780222fcaa0ff7aba0f81913bee6cb76e5e01cca5debde86fc56afe1ce4d95d7f270aebb84363a6a1cd45f3b080fb93f4f450ba2c1f715da85f30851ef081f9563618bc2e9cda086e97de22af71d46c3c2b36b847db2960d203eef8cd0967f34290eb82a674087194af529f11a7b7ac6bd0fd2af141f84fd2bcd1c7bcfcb0f40125338f9780461a7b16e94a1512860cbc08afec8e7fafeab6bc4faf9c16b464c201c17dc7872d5aa978ed419652af9d34ab02de9cf176c373512feed354f67b77db70d773968093a4af0f68af63b5b19f23a074e9393353db77c765c7d6553ba8167375c28ac01e2fc624c6a6f78ffa0a2669e6254e0887636f651d720458673737a211751ec9de5396f7d456700923b416531cfd0d6f5790d8f98327623258f1cd0549b938b279f858d5f2707c1c65355dd2536e0dbea567702adee9b682ceec6e9e3c8120fe056e507058c0ce42d64b4cee770c51ecdda400be9fda9e31eee45b18fbef74eb9a0fd88fc839777a380a87d410f0060e63a4e2a4c8b54fdd2058b3b26792889059efb14c30e06f084b8851f70d0ca15f6b473484be7dc97658ccbda61d79b9420bebf7138264c9340613076a53db1fce850be3290608737453515c97b330c8fbb36e15662c367e17f7933c0a81edc5b425d7f6a8e3aca59f27513ec4436a15f2fafc58c3ecfdf830e0af6e43d1cf35d5ddd4d407f5d06c158513b55e245729a370560a7c0b4445c1bf90a84549e64be1cde78b94fd56062175ba361e85ebe123cc6765423f1226ed3a0dd57912e2543fe9396afe87ac9cc2cf9e8d17866e17a6127774903adced156e5d41a589dd8bf6383d09ecb18f8dcd0b94bc0866847bb8a197b260672c4ea876aa710008c2cd977e1d572d44ceeb447ac4b1fa661cc42fa428a7a0869780bd2903407998ef811f2f2ece07bf0f39957cb357a74701b63a2fbe8ce893cce9cf7d55d614e499df2b40993e45dca9c2b8c88880e158ba10327c29960e84351c79706ab46f935363779b4860e9e17c31a7d9d0d90f9ab6d8b5912937d79df9d30e86b75a21a6b02f65b7abc73aeb677496b48407889c4d5e9aae03bf768e53eca887d68298e38be2dd3c4754d3c2a16b9ba6bd7f9ea7d48a5697f3a3d04f6c9c63956fc299b7ac1b91ee2ec6e468d5cf3c2403d8876a4e203a57a7c1dda47c155c67a005b360193191a09568694d3fbaea37aaf0958df08bf64860136697e71d9e18a3828d1ac5a9302c84ddf2efc26fdcf43ccd7fc6a8e819e1be5e116e57992f51e8a19dcbcb5f9b32af2530a569987c381f167fdf7d5d83b3dd79227fa28191f5f18c1e7dbaee14046e15d554c6404f462f97ea27d8e74db8c74a7213c3aa8c83b39d439b912a72a23370985e61ec1ab7889d4b423dfab10d85446443e52cae25e847fa04a5471222c39b9c99deb8e9098e1c45cf616f2f37b71a355b6dd90f18c6c674e7907270eff3cd6743b4eface4d6d144036d92fded596d9e0349521dc7b7a183d900f38020cff0721aeec89496db3ffb9a06fd19cf914c7211e6871b11724da1fb4f011c71a3ca4f9dc436247f3c8f2abb9761d7fa9f0e21bc70a1c2066d706023ef05c8011be79aa96c57e1a8266ae6af63f49b767577e2c84ae411631418a6e9d37f6f990b0215e9d620a5d8e140432a87ce10345fc2c346d89e4e6a6ab7016a41f2c0c62c7d49c5a824b782f908d657caaaba666c37afd191e1a7f04614d148f5b58e0d0faf80a6dcf54ccc055a83edde6b1742b73cfc11ce03ca9915115817bf7a3e8a40876c238543f2a565ce0d0207136793d40e5f2f49b007c660863ab1d8dad4536b639893960394dae0807c69ae0fbe4fad017011afada4bef9a02c313cc64fb72381dfdf56a179020d9f50b3ca84ba67df3dbd78f18736841e865099414b8195fc96d49f4533cd980f1ccb988db4a756ceea73b7bbd34e954d2c972e7007806ef8c51cac661a6c103c1af1601ea0a618e907b03e860ee128386a2c9e3de28eb0c8a5f83aeebb3384a1b490244de06e9982f68d49a670f28ebd9b90a83124557dca7ba0fe8c2eb0bc3244b3e226c59dc53e47598033a069c4d0ce5d6a67885c846e9e6d9a2366ee1debf56ac18f2b021fb1ac2cc38e4314397ef94b62db062cb351478a68eeb919fa693833b67bcb4b493cf2dd70f1108fcd085e3ccdf03e7a6b675ab2a87efb9b7060ed075736519178221a5b77628475145e3648e7745ffe851cde8e7a673d29d9da1b008f812aec466c277d0cfe84e40482930d6a98104fa4d0c43bec44a30905249f6665ff4e9ffc7d42f62a54e980503ab58bd3c6e5c8e48789a284aa5866f5081f7a691666472bdfadff762bc438bc264c1ba87f3f77eb7c6e40b4f253f209aba60853ecd282bb0e11659e97c94762bcecbad4cdbe109c98f94e0b513b219ab6452debdf2c2c8c616510e26201fa7b5aa1c6c314f5bfcb94592874e459d3090b9bba218cbbc14cb838c8b77f9f82cc31a1ec04a81c9c0fdb4506626b881ba41fa49d64cb153f134348b540f325a83970cda65c23a50625c3a4b3240009cf98c35d8312523a13773d3f5a7f9e18394e8d95c34fe0242e18bafe5eddb3980dda2c1431aeb723d0c1f23a2000b21f34dcb011d9fa98fcf4510c92e30eb6c9e6cd54f87fcb9db701675a63ea85259471d916c95b8c192bb557bd25031470b3643c9a641cf811ec107a70681bece5241a8b0f5af653e2d6e7b92ec1853c75e374f8d1bb0aeb6ebd50cd509c08bdd9a726a270a6dff8a62d20da4f30ee99b603ea61fbb20d29c86716b1984f4899d05d298cd9f4ee112f8e4886c4bf6a69d7b5c6e2dbc117a55e9829fdd26b4e0221a13973943753f21527f1921a1ceb21d6af250eaf15953dd476aae1b2ece7cc13c0ff7ba4dca881ccaa23da7a41e27bc93e393434027ce80161a13e078f37808e40bce1a109e9ce917d70aedcd53627ed8ee82f52c2b2cdd98b9365cabc3024a0c3421ee2d1579ba6197e86e75f28e062ee9cf8eadb4864b2719a3ecef17980932f4ceee6e3a6e790e4f9612fcb42cc6a6a68162dd45bbb519f679296d048f7d08ac9352057e2785a2e27b4ec93c94529ca4cae5fa7e3915085178518aec6dd41b300632d1957c6196c5b8212fa56574a8fe5a2ca368bbf4eb4e8177c1f8c7802dc1c9ca2f9b7c9886c7096c8e711a47a2f7a540d07bef5f50b8501c90151585768c2ad93fdc5cea6ac5c77f62aaa19d482ef30195b886a7ee250829e5267ad3364049cb2e5f1f3a3202b1346cbbc1f8db91dc32b48bde1c7b11f861e5638bd40524b3fe22fbc55a66f0cd7cc22723afb0bc1349b3db841cde1cb690853aafcbb40ba808aa702256f1b0e7fce819b81d131dad3b3bab407524bd2b633a8e3735e4f44860062e6aa2d6aade53ac7bc7ba4d895251c29e78242e864374f52f42545c50247613df699153c93853fa57147315928de8fbe1c99087abb7cbe53a9e36a97186c6ea4699cb3fd9bc6c52282f5530eb184080f5bb4f7d5354fa9a47c7d54e17d688599db82452b6c789c74910fae4606e786a38c9bb3d0ade354a6ddcc266d4062b37e5b8aae84740a22f376a7f8cf5b7646b9f3ee26ef1b098ecd3fa9ac490e541e693d2d7617f5c02341bb0bf89eddb40654ec5f52f75ab5aa59769e5fb19ffcd8105f94128f6e5ffc47af16e8dea23af508af39bce6378a5636dc8f24ad605a10b49643bb4dcf8e2b0af6d89d6685f2b76c75bca386508bc34017fcb7bf716e24ede973648f640d58521306a74d692e56623743fa6be8b3a813ec8a27595e84d439097d222b2dcd25eae774142c63f20434c1c144a5ae50dd3de78210d8f93c9f683319540651a4d3aaeec0b58f33d654591a225998fd3ac9ae351d4c77d988d4fab3ae65519772276fac0c0feb30b8b803b9fd05e46fde7243359161a64ca37299f378758d0299902e5aa46e8844e9f560a1efe78d029156f3ba12f69768be65ecd70fe43cd65129f6b959041105bbf4d63ee629b76c7c2a969414da9c197fa784c4e2d15a52bddd770656aedfe05f5e1f19e827b9b4d2f2c9ccf894d130883e0825b8f29693e881d43d87bb4553d1efec8c999b7db47433459b12a200bb7762a827a39efd58a34082f1e1a557282ae396a59c5b8538eaa8493587f8c43ab2f1fc3eae1ef40bafae86db6e67d9dee80136939498279df04f159fea75edaabc35edaa0261b0a5457a556e9e3e54f20f9df865009a3328895a0a0131c390dd6f04b081ca4e5cb573312a7c4ca19ca66a9ed0c8beda8cc531cc31929174b78bd3e38915a15ae004a55b773982b951c4bfb0ff2a3e53bf79cbf3967aff96aff49a72f9f5e25963f13afa9a40a831c9eaf3803cea9cd8c70d75970053e6f48f01adeafd933723989887c37a797d545f735de66aeb8fd83875b90ff86a28282da097553771bc5160a4f2e37439519354a7e809ed0e6e49ce18770303eea15dc12660cc1a7e8869cbeb107308e62f4391c2e384d8e1dd8129dc27ff0f9c0dc77a5ea24a5c1bbb73e70b868accc9765721a3f887ccc5f98744e1cb77d229f54ccd744abc8feeda1ace44376d042dfa16d5a4f05b951b9e3f4230a882c30c854abc4aff245116b1ea275a06b464c4c6be4f0fb1c37f82929154466674fce1bca834c7e155e00ed12bd58c86ccd9b7b3ce387d098b40ad28c803523f821305fe2a72669fa655b022eb83647d21a34180951bd720e8650dd183ee566cede11d32066e76e059747641b1dadcbc546a85fe47edd05253ba1e5b40504a285a19489d127074e6dbad100e4968bf2d72f74778f6776266f8d1383398a70c668656e0d914ad81fa6ec948c1758d3cc00e82b9e88d720bff89624ce24bb6e7de3727ccc8f612352afa1c42c142bdf6ed82b5e068b625b2bab3b9c6965da9a027ddfae4cf21f7d18dd9f815cb5792a6c66b6e3ae7b2a443e70031bb8f8d50966ce115d3679057bcac49d67e6acff6e37d37bcbde2a47307f37ab6f6eb3587615f9751cdeba992cf5b9a800b5fd37153f00f24a0e35a28694dfc485a07c28782930151f5aa9613729727ef38f16cdee9f85caead51c74914f36af66d0afaf93b6083bde53494b2377a9e15d318128332337a220101ca35499346c060b55678538b14a0f9ec06f78a3baaad7b42d9aef3cdec9b2463fb863ff4be5b4b315f5657db63cec36abe89031ed941c9d3fadaa7123e4437533727b5f95ae584957204aedaf4063520eab7e5e00c493f21479c57757a469140ed7fb10a76e62823951346f0597fcb1d487a028af57d7b81ebffceb5f1566374438c7379e4292c9c599385b8ac33df6ede72c8a0b347a22b409cd82ac41d342a41a458cc080ccb43e418cdb6fc660112c08dc2b51fe42520462fe9eb227b968a98060c4039433ee3b98d5d1710904614192d11fa93a3dbe957d1823870196a95504ef89910f816ae2414902c95f68f006a53ac02ffcdc40a01ce734636ee017f26a334ade26b857c03f65f804fad059e85af6ec4c84fc5efdd2f0d7cdb710be4cb0d371b25420f9af3e11aeeba1a52a2701126367f04050a9fc6719e313d30f8318c670567f9fd7dc626473937ff104f7ded1b0e88d23653e54d690342f3430bf2194149f7f7fb408e82e88ccbb925a28a33a136501a5568d244dc7b05ce3ab4161f00201081e327d5355f20e044fbbd264a1e7a8a4640037dbd93d38f23dacf17e7276e0c49d3f9f00cc27b3476e753540d57c983bc249691098858a921be420cdf17235f1c62604b269fa2b954b9b8a5c284b92c146470e3e727c8fe9eba346e5c545e6ebeb8a9b73d2acda344afc5cb1670f588fb370b729fcc1d4db71273b5462e1d2e53488c29c3ca33d3b623c68349b00368879f20555f56ab156e061386e9ae9214a8d09c7a58ff44280ded6f5e201484a1294cf4a0ecbff2de368a07ae676fce329ec5e76a9007f5e0bbc2098460f44706811689440ed4e96f2f3ef037ed529007ccbc9b4c125622141e507bcd7a2144d0fbd470b490ebe8b814ce42e0196cc9ffb424e1f735f22d6d998cac78ec7f28827eb6ee8921ecb96219ce8237ae88222f18ac49eee42e1881e538150adf237fa857ffce0db4954a33358e05ef3c079a388363d1e5dde5a4f49dd8083d883c63e3ba4df621d99340e4c7c55b935ffc074e10af038538d2832d5acc4266ba3ffecf92efb9f323712303500e6f190f0485ebe9b8c42f8d08bb01badc9698824849e89adcf6be6e9c850f8773743264706c4f1fb08891425bd61cdd38ab4268def881bb3908bfaaff8e90835866c27dac01a17a7bbf7630341c6215b5161b528b714939aadc142d0ce447437f93bab060b5725c63fdd114714bf7f9b0359df9ce6da37e5adadae28a47f6cd329f20369a65558d59333574482d3adadace9a6b52d5ad8d001c63eec9c99b08cb6b1c404ce1bce74b22af6953e15cb047b876aaaa8994dccebd5cf499df0719a8e2ed02c5f7ef5dce8d6ef29adfb2923fb1ce1b45a1e23956f5f34d48977fb9c56c41a4843c6486e84723bdc70f54ff53ea19c4783ec91dd6888143a5b15c032df676bbf89730f9b212deebe18bc99330900a53fee8bd9ce710e7472c05088cf276bcbec4579eff85b593ce99e9662774285faf58e345e1b4cf2c8c8b40bad5818f680c5b3dedbb85ef95149c16d510939636e5dc427e860a4b4c39853c2ee3bb02d3613a8d798d9d49b4f916c61ccb18e5f9c5712ac6c337f930595e122cc8874ec1c2a7354bedb00ebac8d5891ed93ee712a8c0ae37f8053485bfdec670e4dab9b38084dad3d307947c25f20f741dc25346b5200ac9f11726582cc6110ffef7374e746f2935322e7af52e1e9354686df437cea69de032e928ce90f3cf3e3e1d3a376938f4b8a734d8c7e9efb2a7cc90fe4206ad6e69a6ba78c3e672a1497e32ffc568ada0526bbb89850d78ccc9f9111d692d8c75d8c69ad727a90ea07fc40d222129c88aadefa7c1f54acf6304176bc4d80bb3c9f0e71906023ff99164211a0f4bf690670462982470406fe96fae01cc694a029dd2846e7b51904981321d274f48250df604143f1169d7c34b5eb29d3438c20c8b39d43f2ef0b4c7e1c6a4e89db0486136b36ab331786f583575e1f0a53529f96a56a2afe3169e2855e4bee803d91c4253b36545f93c90f0e31a04288397f52a715387f36d2d81bcbe68c22b44f2817337e3eaf33fe7bce0c38135c2afdb0503f0210ed816b5563a8f57a24230ecf056bfd3f77246545bf345a095362842b92ca4a74eb83a5be6a8bda234543db9437374ee89a7307a26dd0abea9ca843e5c9fe583eded697bd2c27fea0f3c66d2e3f44b9b06ee57582f78e49dddce5fa1cdeb0a666c9493d5c611a6eb9db25ae15493dddd94b2b7dfa882ffa1b0433097f63cd1a4f730b9012f513c5540395ce5c1d3d444ec4c99406f742c473ad5021b93e1ae4563a73435d29c9451a4343fc23eb9f8114308f801ab381f23a09becac138fdf62542805937cc96e42296b687eb1648ed14bb448c4cfae75f26ec68df2b082dd94d7e4903038847db3624c94acc04afdfcffac72e11899a9955996668de0e2bc1ee245aa71ca456a551631556fed5178769e197b6595a3366cb1233008cd749c24dd6cf32ad21bce39135c30b2f30c151a5be330f8ffec0e0c8da777ff492ca811f93f5381d447493433262591144393e0bf9b9647b4f1fa8ebc428d55d1ec7e54236c3e51f65baba4776df6f7d48d7c261290c78ebb558ab65f6ab7b46b5fe786578722d226384cf844e1730e2c85779b51e63a652958eb0f4befbf6b823fd817d4bf874d1cd0753c47128bb96dac86c8e60e47487625dde9d28cf4aca19dc58ba0dd44f4859c063e30dd93dec6fb4ede5d0b3f75b12df0995f0822dc697135167091ef5165a7b178eabeadc4a330e79fedff13ea298323edea5b0f36d50cf24e94d06b4e08499bab59a0e26e721ddc5da186566d0ac31acbe6d344e0ee5606cf6476337d0183e895650e815d9522aa5eb0ada8199e371dcab29bdcc36c44a1a462143654e5eed0af460113218e785454ee2dbc461906833c56aac780b635450124aa748cd963129846cc6d0c7b5242a210c978b2b209fb384c41257606e120ed94a853d00c1267a8ac9ec148cae56094580e3a62ad5b0794d989b51ea2c032f4bbec358e45d1941282144ae4a7c005101f08a08112d2399c288b8c75e343c0ce0b49c833e5cc46ae03311bb88f01bfc0a50fed13e1b2ae49e68deb0d3a5629b915fc4d364d62cf264d895c7d7827ad0d6a86861e3b2d886ad3b76492b426d5300d40d966cca7783d10ae95611a967d44782e0eeb770084acd374546ae0779951460270af8d1ac0aff9bc980c02066330a16690b9079a8904312e1ad3eac94cc3ca2fe62903198f339d0b0c9d38fa1de054832260a99610a52d4dc308753662aee14f6e185ff271b71b2194633830fc639bbf2e32c5b90999e67b75b66c0fa7dac4abb2c69350d988828612bf14811943e60353addc77251895195b6d488f6ec3f76849a96d689465198ffb05a341c7731f15e031fe65b623b29f6c9e1d20c5b3171e147686ad8e00182da7f17fcf3b2cdec6991bd6f3204f8b492214c86bf80459e1814675d82885c21b51cc233cfb07329e045e71f908d212292ffaa0c3bad8a730ba03672d3d5e2ff75cd0fa0ab7820e262c837901d8ce1acf70cdc94db4998cb40cb1247fcd18391a7419213545194e0fc8ebd3e771fecf32facb36e0888e263cad07187ecaf7e46b141371f2dba6641aba08d16fbe6f8539817b36b588aff2fd0549a31bc5305c097e0b9334be0a70daa6a96777c2c91d516231f116c4550e7ceeb203c7bfbad26bda653c650fbaff08941332ec2b9eb517a57d113a83916770d5742bb22d98b1909e5c7c874c3b9a570d50b6998d3d9bf081b3c69b6cc13e60772ea2eb08564d3da930c4d4eb7af11c256fd51d97063f3fb41afa34affdbc0c958458bdc630afa2b61feff9014765c29864e1a721e79a661f9cf06380c38ae1f2dc6aa77cb0f1c9ea6dd94bb41ea0912b74af3d0fa4bd90c480154deda20fa854cfc8fa14fd3a602536e9bc1ca98aa7589bc5301d7bdec875a15a6ea941ba9893959b47f68f970bcf01088b5bdd782f9df3481a4b9014ce82206fe07bb14e4384d9ff94bd205bb7e66b06223de46a40ae168176f324a9d6bd258b35147a10df017dec53626fb45ac1111d5d2088ee19db6e566d4f0a66d825108283d8fdf9040d3549ac5b8d991feb5303d4325358840ea1ae0248bfe1ea3fc7c11e3950bcb5fdcf3fe63a12b6f5ac309480e95aac966889ca799c2fe301661328a7fc4788ee9107dd49cbfadeb50ed188b375c192b93a010bd1ac4ff8f36e93c3ea11775b8461adb8791738e8df1524270098e34d12edd230c03430def1c2aad5a7bf806e4882fb166c47129bbcab5c2e4c27853c460594a458328aef06b61821e21492468625fc24269ec6e1ac1b84499d80d2ea9ef3577fe3bdca9a21155bfcb53611e5592c2af4830495cf2ee8457a948290c51849590ebf599b891c013dad2aaf36023452ae298701e7d11837af5c1b12742e927fc03c46c74d3afdf47626fd1b1695be08f38066caac83ad4edb82e2c761a238b601a395d4aac557cad43c5d27f526849f47fc1fb5201a1e22941f3a7bc765d132db234667c2ea6d014cf4af9502fae6b7c5235c967a0fe9ae5de9022506cc0c5afc874ebbcce1166edaad87fb2ca0b3ea0c90e056f499758f0c6e9dabc8e9f0e9c8f0f3745cd07dfcc2d184fd17d732e090e231596cd833e9a5ad792735bce1a89e507d04ed906a1df4fa4b792cc6b9f5bfe28250b23effca1f25ab129b859e4786a5b21042d23154647a1158ad7f21d7c11401c77de2c7943ccd07be618bf401e3c7b87aa420c3f3712c993c13d9a627611cd7a534037e4503b29a97058feb67bb6e0cc4ea4b51ffb39749a16e9f39dab59d8438be471ff1797f82338a4558f11dac3e81c0e1fed85a9fa3b59f7b70eb11a9bdd4c27983e2b44af3f701b1de3aafc2b702fd86a9bec841f332df9e95f1ead25ebdff3222b5ee36bd174a1efe3c9a474c662fa48086b509e300a2a3c1aa755e0b841206224bc8fe1dd673018606c0bb28d5efda89309ca5ef941b0ed0a86c1ce3454ef95e8790a7c5d69f520bfc2c41cb7453acc4dfe0f7c15a87d5d0cf5200ca87b4b2359c1008ff9476bc1a568b4727d92a9c30d20291cfe563e318ff01d84e01f5a3e046e3a200af13ae1c5a58827d6e3e37dd11ebc79d75a7f4e9fd9f83620f2e1b8897b155b252f4cf6b3fff2a0112a12a206fa8ac25a0d9ee649aab752dd7209cda34797f17e1f446c18835720dd0b4484be3ddff16296d6e77cdab5511867c4a0f7b077ab7be9b5431b58fbe0f189f47f544f33b4aa202bab479ffc8f7d13273578d8fc08f507ccbbbc805d88938d4894d2aa905212691ddbee7c842bbc9a151fcba6d2eb0d8636298d010b801862a5c40a9073a8675a26e69f21dbe65da96b28929ea0b8816120b2133ea877a3d161456f8b9b0b14b8688ccaa8d80f2bc17e2fd15cfcf2b2bddeea12de19260b23ed48e2d27888acda6f90858945bca05b1a9e0b3b6b25c5c4b1868b19a17fc96e6a5b3f3482280cada842f6273f94de3eac5c1239e1932d63bb3988d2e69cae2aea1abf4df71350c4fb1e426f12df8c334ba84d124840c2eddab1eb64cf5e45158b32a011d84ec212a5424847d3e5c52fa3235dad62827c0f624090684e630884df1bf23b1ef79fd93077a6de0499b515ff19207995308d93ea13efc966ddfa5c21da8d97bb46041cda3cf630b7d485586874c7d5382dd7fdeee9fb6e97699b70e9cc677d1690e6e969e231247411423c37b7af8439fc1790505c94db47a676cd012ed70f0482a705dbfbc4a99e10cec10c6fd020fcc449744192730b3c3f4f736c7dd883629b97d7d2ebe82553bddf12c88a3dc7aa572c486473306f8f9097ec1a7d1665b6d98de0cd3fba391718bdb5ba8526e150f2b46ba5365ad430e5a40d2c93cf27002fd0da38ac2d8046bbae584b31fac2ea079822872692a9b69815fdc1ff4a68d2454e8eea1ac5baa3b20b839728345893bb9febdea64d7f29ded88988eb93cd965dc4f0e7607b81e78b88d089332c696ff26cd0ed48cd5a179fe33a1280e8c56864f8cea5815ec93a838ce9d4e523b2e65c42c9e32054bafea15cfd9b8f307fbc5ca4e9bc3c2babfdd0c92328f770b1b8da111cd92a513237cf64570558ba95231b583b5f8a900b07e7d9d64338116d4c4b4dc24ceae9f8695896e1efd495d826ccfde245b8acc9ce2aa0f4b590eeec4eea2217ccd2502f9cb0af800c7e8078a88596fe43a882964a6004119afcb666071130260fcb7a958c0a427fb82ce3ef96a52d171f0966119363884713b7740f7b2ccf188f9026962f2884ec99812e893e09705a9dc03f51f929b9d371aa00f05260996e391ac6bba700795dc92ea3ac988579c7b58c84648c215e96b384cbf158ee942909feded20ef071e84bf6887a9d2f943b55f9888719503e9e5f0592cd0104ee5f0d6b32b6b98e2a434df9a1fab0254e690bd2e0a1ba136667e00d99e789ab02f2615cec901f5a864a10588baf06ab06ddd1cbbc17558b4223ce5553f1b208e871da7ae8cca95a390f6166b2cdd19a49f52a77e22303c00c8069c287097a029987fc36a015465e86c01803967a21537c30b2d46246fa56573bbabedaf6135dc7b789b2351a21d976a37a0140b49cb0af97f6edb532ce3a9acc20f79323e5a9b98bda1a9bb0ebb341bde15c38a49e75d4495fc4bdf08d90d35743251b56728e04ca3c4500ba28b98af1df12f422f42fd11dd6f47cabb0aa6eb6cb5440ab3e7b4211fe4c28e5f823fdf556bc150f4fd096ed6c9f6371b1f57f043a0f1346eaefe38aab60d28f47dac80e6699faddf9acd0a69de7607709c1b6569b75a67d309e9aa231f8341d03796a20e22595e37545fac3d47c08f9f1f897ecca634f7c6b35d0ea1f675b5fec29de1a376ef2ff0a6b31b99a5ecff5f53080e15e42e361f6a98466d867bed3a6d2d0e3110744465e6ce4222f255deabfb65c6fb97ae1b1fb1aef9453bf679c228cbc1159a7023e6f3080099de1ccd64a401b38959aca6ec207c5d2e62efbb2c5d7ebf4a20435303ff34244f4c013d0fd42da9c36de83200b2b1f25504d4991347ff1f92168ff42c6fc4eb27f0c28bd806cefb8869f243d1ac06e1c820003964e8981e8ceea347b7891b5f40ed6fc93b9c880ecf6232f384245318562160f830651bed4907a38db16d051d5491f1b09d5e62a9fe0fcd4c619654d827215f99e5a994a82896daa21650e7079131a4aa713a53a63c2ced12cb7379e41d3d44bca7e0ce121974e6b9a17ac46c09b62a0dc40abad75a6388911b4e7eec1d15a03803a4430fb8227d08ef66f65d1fd59a21b713a695840adb270fd9f710a661562b06c2ff0fd224a17db57e7d6a74a830395f5bd4b66ba980e3da2fd08f4d131b6c753624826d8f1dfd8c07945819cce272e4fd0f18985c0d766a2bdf12fbe954d4dfdfd9bd8949471267b9c53c45203bcf1f4d7c7907a1a748284339c43f6b14a3e1aff12efb4727a825450af7067ffb08703c0a1a66fdc9be267bb782a941585f8c961879afda567bb86433e0870673ebcd0bf5b1ba62cc4ff82e03e29ed2fa7373154c9330ac3224112b9526921f362f0861581487961a6415bcccb84f9114c855cc009d78d728c840e01e515ed9e8c50c612975b76e6e6d79e1f12162a72f32a5a5acbd759d9ea9e4ff514cbab863b3978295f379a590cb4560de22f1e6cd03f9452bfc914be6483132f27982388588d130d86b35ce4856f96edfe6d5bd34079a9a5dfbb4af2f92849c583ab3d667f4bbab7795ea000b4af8975e534f3be625af042c97e16cb7088125f7817cf82ce28229b44de5b472bb5af760506d8d26cf361caf7cc731bc516134dbafb9a1426c0d6e42c8bcd8cf033d6b32dffe50ee01f19b57634f4ee9bad6ca993e28d8f2a8f16d924dc01a791feba0b6d352f7e5e34fa9275b0becb138cdcac6938aaededf69602164c94966fa1108361e9d9369c98cb95f8f0c704d723dc2167bac6cf4c847fecb9442f92908fbab4eee38f1a6880d92838ab1b41da374308054825dd146ed193512302d25a8e224276ce1931607b903b43a5968336ed2f01444f57073457224bc6fe8e10d72280f7e6fa67db3720e0e04bd3b17f9977252251159d34de2f88a55cdf777ce7ed16c6c15f2922952724eefd650ef2b737745ef0f70681829e6f7cdb788c76ba997b48530238d22432539a052dc3b8122a77ca305e1a959cd67cb6c6b8a6407b53191e440a1940f4a463d7e4981f303fc96292a5b928b84fcc189f178ab1c0c6338920e18a243ac766e798823cb8afdc4b6659fdd07c633d07e1424f5dd0b218c395a568fce55a3efe0db37bad258425da28f1105f11ae0a2c475c34cdad58fe269130b1b88ea5ad42b5778fbcb5373a8572bf6b79f78b7cc7fdccbc2d745a52f3b9e3b7104610dac395f818b9602f264faa284052ceb8c05f64b470d2260195139218cc449d28038f8cfb7c9c33985d494c441957eb8f556e70b9d1e05f7b4d8f12c9ad008612dd105542ac9e492137aed1d6676bd157e2d6986df78fb861e7ec3d8f3da26cb40e06ecfe80ee03d86ad862fda7f0a2d06f75a4fd937c1a86407aaed867b15bbd968d0355652802eb73b622b3fc46d7b8b53fb62184929eeec4ea6e08df3d576fea18fee6a315a356ba3f61547f0781c7d6ad6016d34d7e9de6b864ac15051f5f157bb25a63769435a27fce34c5d17c90890ba5584d82a52a2282d7ff9cdf9eab4855c5b56ff91eefc41ff47a3cc25e789cae478128b6f9306736808d964ba579c9f63095bf7e31be26ac5f57617b7c09e3323247b5ee284e9e50f49722fdc6cfc1fdfdb502346b554f6a12a59cd324fa4f2483a58a801a2c679d2cf7d346ae56848ec5aa71db12836a3e5aea59be2c1f2779cc0e078d82a929977785f8771c62a528e7ff01fd7df081543ddda302f6b288ed200f7683cfd7475e767a1435db32919592ff3e756c5ccc5232f5e0f49be4348214c4ce5477cd5464f1cb8c8d214f2a69b382ad70d5f785f017d7f665d68535a5399c05fdc243f916025a942a169697a4e2abf75ca45602faf6183dcec79daf34421edb8f2e077cdbc910a3cdc697a30d860fa2111f8106d910e17ed82a014b2e3c9015bc913c72a97546136371208e51bc13a015e1628074f064b8083f41d8bc8e68076011b1baa3b940f91445691745b438ed74b65967872a60582bd567bd1ce189859fc120c0932979908edbad3d9e6f561fe9b2ab84d81fc9e498e0297341fef033da9ba33df9cf847fb9a39e61ca83e1ad63e7b5e1d7ca8b75adb563ac74327645a80f230945ac5dbdbdf65486e657aac9bfc3acbd033d159d02e17bc830eb1a3ab97438129b5d4fd145e5784ca261013eab772f76e1a13a92f98e87346b47ab3a77343fd827c2fccbc6d1e66e28995a43ea71e6bcf1597169704ee1038749d0a300e399e912f9cb1ba1150b78eeb27219f527cfaf09a3d79cb110616e106d61d1037fc56dfcece4d81d2416aab37f36f59cae463a4fe434d1fe55c63ee34cfd974a7863141b711409be2c083889b91503ab319c649ea8638195a65ed3f1966653161a7be3de324b5e14d7f3f89ed41c4c973d30b5d95949d09ad059762a36119129076277febaa5ada7d3f38192d5fccd0d9ccec1352de5ecb638c5690d64646e269873f1e9c57cb18007accf018b67d3c4e2aec2cb630d855c5dfe7b1bb66824c0bf7c41f1dd46db5489e33c12cb72d9df71b1035e71167580d141289e5044d4383c047bba90a7546a403dc0d59028e082d87dbdb058c771b243cc223348d8ef500e43bd8a8cbc7be7f9fb32ec797fa462c67f971a4824a57d465ab2d3a84e1f226332963c4e74d25d930aeeae7ebcfa2a454532ba73d2ebdb23ff722ed820e18bd3325d751e4d4529bad4d75d576405c1e58d69b44b70120065e4e38e70ca8bb4c680ff54881764c998e9d41b0ec469fa91bd8946c6217607882ff5ae7b7e31bf16522895a394c2a0ecfaaa86ba9b7c4f5fbb31277e9600d92fcd4e1a04d8d052a0c731fcb6b259da303a3902888413051b485e5af0cda3422166f68250d3758c365a77e97044533f91f5be3537e4abeeb0fe155b0060822fb067747c3c45f9b2a4f037bf9680d2e9ef2e8d7c65903a38ec69e329ca95faa36f30f0399a3955ddbba490e07bab1b09a30d880a4d7d117476feae8cb01720fd82212c016700675934f0902bb8f0449b7ec3dc009cb1d23d1343e5b9e7056cb2836923f70224631afb9280b9f18f66371ceb5b9e938cfdbcd7e7af991900da4dbefb49c767f09bc4f18251fd7f8b23392ede1ff4ff904467e3de27f2299672ae63b6e4dd8961452531a56b083af9e5b209d756ef2de96cb299503e93a9bbeb8d19e01bd0be5b3ed1e37438566d4bc5031a379f73834131dad7853f3db6cddf948bdcde99fd84445fa81619632876b10b15a21efb351960aded08f9e2b5a15710661c239bd907ac979d1a5e11e49c29023bb44650dcbb2dba27d64f6f355908abe68219af22e23af768e4237ca822abbc641158499f34cce19cf6c75d3958a89ec3d3d86cfd0478d377c9104afaab2388f2754423efe879e64316873e15397b6e7360b38ab2e32618e4633b17a2b580e8ce56e68690e3a25884f8489c1336b6390128dae31b388018540130b1e3142a7a496c45dca8648a0b08a39fb0239409626081e9461ea402249e4431ba10a2ee549d68bc39a2d55cec699dd52807426b2f8d392bb83c2649d2a18817b89be46a378135d09dbeda7817c3d30bfcc2adf14ebb689601e0aa45f4ee1cbd867537592840eaa08cda6b0552839160e55eb6d760f775bfffca20b44e1c950329302a43527b512fbae756a61717ce922f7a58824f92ead36f1fede843a9ae5cedb83b7552642fb7d87fb05171c2267601a83df2265098a85ce533e709f13e75f9b5bf32e9600d99e4e62284fecf894d7dbe8a7b71c079ed2b3b78130680a9b0f34ca44eb4f651d3a2be2334d0e4f12f332a7d54caa73a5b973d1b2b1f0a6e5a2ba7316a77b46ad53deea6e59907c732d2b894dc20fbdaca47da3758e7e8b6352c7211418b1531e40d005c5d0ba853a3641e2a7c263fa59568a1fe5fa482abc347a5100d6fdc5c4d4893d685e6f686a57e29a9342b1732abef9d618346148c9e9532a0694cd72b8d2e7fa464beacf7dea79ec34c49ebd97d86ce5d62cecfcf91517a33a0f429e1d5f9f86db7a040ebaa78d9db74ad43dbd8feb8046adca50706f2357e539007a9bc7d41149d6830db8ede3bc2e4ca35d27a8207da364a5c8f0a472be0ec8076801cb1d8b24dbfddeebde01312117edfee0be8f49262cfaae9257b6f760ed6dead75c4ed6643bbb3527cbe2f811634e504b8a0caba87406cc46fffb8a0f54b8ca97298737893dbbc2122535fb75075e29425580c5f055f9ab41da6d8a63557e3960a4fa60d05c214862d75419f93992217cded0453e8407d08f4997131eca679c4627955dac2ef5d29a4abdbe5461fcb4460273d23b49a447f4fd531a1c17bda3a6e637904ba94481dcb4f65b978583134b13b7ea75c4b0316dcacd76db89e15f715804d76b20a7494cf47588a6d99df19cbad1241c05420295326b0438fb5b929672dc18596963e48731bf546710a0b92281aab6e707abb1ebdb29153d77937fe158d97c77d9416bea4729e0c1290af632b1c38cc24a31a69cfb9f2af92ef344bb0e69c4c05d3c39c3e9ebdd427dec9e7ddf69bed6ac1b0411dd583a3168f2b142f36a097e7334955d97a935d8f419c54b6af0a9b984ea30f182cda4127294a4ca9c6b5947cbf8c0cd5fae3f0f2317caaa4ba8cf06d593d522fa624f739b9874cb9c0754131bdca097eecae753850c9dc2c3990ab19a277f1c57a233f067a35647ccff71c5904190a4ff8df478b830f0ef8fe0456bccc73ba270ab149e247ede0006b10713dead06834a0918ca6c422188461c444f40544a08d38e6accef84fc8cbb1ba2daf118430ffb454164c7ec56f25dcfb655eccd4c25e0dd905c1cb82d8ae890c362a15d41326ec90054c38035ccd6f4e6edc50f853a53e17bb5da71aa8ebdbe4769d1ca7abae760a1717319d012fa20692c1d8f72dcb75047c540ed29971043f89b6567052da1d0cc98607f74b585665687dd28a6ec53e327a90806866f9590393c3cb4b3f488d87b15d18de1fd723da31fdfabdb2a69f60c8dad159e592feb4914cca106e2a8a3f0de35ef96670c9377571d97fd1963266871373fda39624d2ecbb09d23d96eb50e3a43400b11b03871680971b76a9ff467da110bcf28af301a6ed7a7d6c113186ff0e14419ad6a685408de74112a0fa28fe1fae212104a4806acaa7c36602434de62b0df310d14ef7feb530d2330fa63a5a88adb88281842b21b281eb728094824e0d66d80e706afb093506caa99b3aca0b572430e8786e5e1e942afb9da1cea701dc72aba33a6182ae5e004f998376c660cb888c79e487089b62a758eab07b2f3cfa11c6bbdcc309702132499b676b2c0ef953615dbd9ddd577a4540b99c84ab295abbc50d497a9bf7d5e3049e351074eaca1597c69b465d1b419f5bce58346fc2bd438bcf3399a21e12c5bb4910d6e460d1835c8ffbd0e01ef7d73f936d9e8cd7e70b0571382b8c8de233fc774997e46c3fcd4177a383f7fecdac4532c69b1433b0da4a1fac005af923995defc731867fc67186379c7d21d04f5f5365c5e8bc2c278cc83329bc6af541d51ab473808236b7a7f3c10d91ec4f658b3cf7f86c5f4d84c2434cb0483605533608f2ecdc4c7a19b0fb17c20fd4bf8b8497b1b225c13b60c6c2a381f68a665894849add0ac5780203de31af67088c98c2caf271c3dea17aeb113b4b3ef8c42f9341b4a3f8066a3a2d15d657031cf01d9806874f641b3c46f732752700bd30c8eb891dc00a088db19651b8f3ddf46aa74e1546a74bee60c46c5430b3a1700c02a22037dc8ffb4960f4112e26178c006f32a8928aab06e3b95dec3aacaa69725a5c9e669f24709800423610a7ef03518623543cff2e0c252f51f6122e895f1429937d5b43e03715830a55a0ee8077c3f542f4e898ff90f0ef70bd3393c82cb0b8d3be5f3022785c1b069da5b9d3bd79b1a39098b3c2f47c16dc4161b89055213d4de235e117e333fa4237f4e1d7772b154a5f0b87aa12c7d24571c4c983448e72cc686c6ebe582c7780d55e15dd02c1cc97e2e3d65689577922f32ad0c5d8a7daddeb08d60ff7bef5f86fe89a1920cbc4f1c3c0138dc03a8831603eb25cbac595fa381076d03142a6f668e216d1fb994d6eb0f32bfaa04c477b1608d0a016ca75108577ce577c375a1b5cc796a5ec3563434ea9a0424ce12fa751307504cba30816f032e84c80c0a85220a9c974d992bf1464c5317a3d1693d23f9609764ad47ebc844b92bccbfb5146b67b041b751ca72dcb5ba735018ad47e3b76d1d4dde742c45604a10874a51fe143db38fb31e85c2c04b99eaa598d5381003f10e57215572df156e9668ec5aef26b792cac6bbb876ef978e342cfd3447f0fbdc163123824b05cce8a9af24d3f27a2b6dc2626ca3682de7236001e7a301ec785c6e89e00acc40cb9d35e095f76f8ac5d18cdfe164730427dd9b73224b97ecec5e4de8192eb002e16900091f2e40c37ab1d23f8bed8aced4ca9a470ff187ef449fa9ee1a6d575a4b2a03dae750cc23f6fdc87d9348ea35b4a98b7b141329f07b286fc6bc65f137667a907b578c88733cea91067e00194c448f3109e7e1fe54145d66410cd536ff32a0e247235adc5c46dafe1ecc8dc2bf688456430f07beb1218e02d242629d3757a4567bbfc204c5bed50308e91a0350c1803fcd57afd31f5d0f05c812f0c5f22e3f5b101f047281acf532343de8049d523f1b7808b38a19d4826ac3531842cbae8b396e998db7fa76756400e43c7071f7333b417b20e83c9914c209002b1fd77f88dbcc8f8bf0e0cb16b1f6e6540e122506965ce7f6eb0d94aea26a22d2eb7907534a852d9ddadfdc5dde04251c14e2a8e86b2f09b00a16fc97dc7a4423cfa17b604ecacd3917792cae39158ddece77dd10c4f22c07cee569e3fd7f1ce63d23fb8982086992543a823185546fceb20686eea9d4a3dad36a68149881a30dcb4ec1f0f8cd46859a197e169d4c825f94950fd3b64156ff2c5853735455f7e19ec40b253ba436e99a2ff2c6907a6fdf207e9a28ab57a9c4bf9c1fc70d8ce37cb9709e99b462a52dd6c3d2737b3d0775f0c40d1fa3fa67f81f47d22f2d817175d22fdf7771d46264ca6e58f6db817e04c642acd25a477bb2266fe9288d398dd915da357f26e7d0aae3e558be9daa8c8ba3a4f826fc818cb27031ff42f0a015235b1f6335b596aac0238971864b3b4f6f39baef9907d92eab58d91213ab7a8d05fe8dfe0c3cc24f0dc84e7ff939d288b253e4a55f508ca83ae049a90b547afe7f1a1f6ca2c11bc870d45ac996b2bb833707510a740f17077e472d19183f33cfe0d1ff80a648667e53579920314f5d237287a4190daca08850fb7c82d80f86fb934d36b9db8663bff4885ed8ff633b08628f1ed32c5e5a9f0b273b22718b7f812e3937dbd6f10688fe89035e7e7bffdd669dc2f4eeb1626a4df99a9e684d8a18edb8f86050a185912c35418d708bd39e0ef7257709e9e789c8c5fc7ff16060e0c32da75a809d22abaf313075a01f389756252d0219f7f748510ba33a74f630743220dba271377befde3cd97d23ca5df59d7cc758f14be328987864ad4cde040ce6f0b20a2ab79b4da13b660ba701eb9f953e45c60d9d74c8198fbe1608ee732275f20fd526744fbacac405c4ec064204bcf9e29ff7ba9af5dcf3d8d7722ba72d4c40f3f2912038d229551a25e677106c6ae06e26eefeda54b420225cb355ab0b896b04292e971ffe58df6b5331968786d85ab9ad38b60cec8b183d0c40ef4b2f3d61020efa5e2eeea8de70334ac5240bc106d198dfe3fce9e0a2f158ad94fc5969a7cf3180acf77e1f4cefbe7121b17ecb9197f6b35e0a09296d7bbf8028c83c5e9fc79914fe39a3c117985eccb79386c2e2d789328c6ba2d27f92f246f502e243b248e795127ce4e3b4fb120e8c8c5e5243caf726df97376bc0f4ed2722172a83992151a6c8ca3f6f56edd1c2dd432e6ade5878016e3f90de06abc7f52be5c7ad1da6ecd79f2019d0ba5ad50b86e073eba19142401fc366c65a3a732b28f636dd8ca39b63b067b5ea14916f76a4ccefe070f878b39534f9e9638ed1d437a1b5f69e9f0a9a85ebc53c9e54800512e5bcd4d6d8e2a38e64f5d52042d7652545a244ee310bcf25fe945c42c7b599324958b4c3cdba161bb863499564020bd263ac7746d9f97b2f4cac3815bd1d951ff65c62d8bfa0a6e7a09432a50b5f091ba2340b584c9ae7193bcb5ca61f4d7df03a74fc157bd7e827a94ce67d2c5701742d3b304376e4009c53bf922603ec927aca0550dfb871920e5d7c6e5ce166859a5f250368cb01b501b18a9a81f3056a69df9f6810be2a7ed54a4873f11896f5c0bd161a1dfc0c0eac2bd1d853b882ab130543acf6d615eed91594d87f481667f5bfc6b1e2b5b765d7e89a3d2763757b9bb60a26297c6123f1103f55f42bc1f284280b78d11e352ad6fb9d70a8ef0ad2a2a790e067b2b8df54b806868b28254d3fbd1934b59023fc0b3c8b2aff333f33eee0aee942dc0cf42a9a0586bc8e973fd499288b2ab66cf02202b3d7449e5a9875e29e44f6291f6e60e8344cc74fe7ca2c26d40bc60ace6ae1dacacbb00fb19689876a6dacf4aa3e35a6101e838280600eb887156242ac26bb78a0587267061a47d5ffccee07dc795aad20c44066e260ef461ba09117227a6464fafe1b77c58ce88d6fca235917d57dce2190ef05d32a84e0ccb2bf4c4554c16b61664b45ef78bf9f55a2db8361d101428adbe8ffeeeca7164855625c34d60f92f5bc63d93462e165ab9aba29aea77c0536c250a72a763cee087c2c45ac1119137261835032a0be661597ee1eec3d1a4075576eaf5172f87b7868cd7930fc1f29448be0c5d51084ad3251b9fa5403bff9327da3ed10d394e763dcef04f36e06e15787a548644551975845e6ab84ee10b714cee0c8bb4a146e8d0d412b64dcaaad913bb01a958c2829f15a4dc90bcbf742a3adf350e0d0068d2ae1eac18bd2c2dc62cda2df65a06cdd90ad75fb1878440eff44bcec7070c21c98d654f082379e12248c3bdf7f41538e199e13b390cbfda3485ef7410c71de4dbd35393ed7909de9f1426323f8e9e7a936bf707b5d8f259dc50454b5fdffcee09cdb40c60cac6d8fa9af04a93875ca1b14c994ab46d3d198154e5943f4de61704efc798d8ff579d81842bfe181f5683aef82a48c0ee891a7e91a90e3d878bc82ae43de2a271fd094ebd34e13eda64450b2066c92beeb3188b7c26bbabb3a3e8ae84bc0eb799b8ad214d63d1bd93620646957700eab42e98821345903225342c92eca13bc82fb2b3516b48b6b2a3f55c256123492e51dfde52736bd12cb9e73f2aae49a899b6ebab4abfe47132c606479052c4fd2fa313bd8060d13d89abd9ef83e2e7afbb4f38637e7e564010443970338190d74d744fa03b8364da5f5e46c5035f20afcce2bcce1b42d441350afef182d2b6baff51624248542fdbaed6cfb9e2cdcd478eb2c9b2ccf32306aa363cb620768961c8d5e7f888cd586d286f5ac44ab11611ae184cca8e9608481a8d0ec4f8eaf8611ce92150484bdd641e6d13607425328f4560a2632a269029e94aaad785274326dd78b5d1ef38b4ded8f604e1a94f9c51e03fd3797dfdc6598c03615e33a66f779564a7ec5da5e46098a21c1e9439cf176b88f09c69b45efd2b0abfd951516a53c2ab126186e17a99ed4ff7d5c763066fe7b48fe2c0df659d0916aad472522fd807dea32c4c514baa610ce4acc1d53d12d038c260c4ab9fc0b4fde24836e301cb8b4f303924673e09101bcf6a51dd27dce41e5aa9c661b5c29d8f1bf088d5343c6eb0c4fc2d4395c1a0c9a88b18c14ce944cba5ec378454131767f1fcb7b7bd02340f1399def4f6a6ae05bb5568e0c7eda29396525a95bd6d6dd8b7a36b5390b3914cf7c3674c1e271112c34f5a58bfaab149b32ecaf41a760426fe185c110401b3c73dbbbea681a42d9b9a6531fb3c7107b6ba967a5a9dfc091986a013ccc14e44de1326a7af1f7f18fc062ad3110a63237de44cbe7f7815f73796211bcfe346e1379cbb50342dd82d82b94e9740581e43f052332701d1132c0bffda7f1c771d1d7e52b0a1c3a08dc9c41c4d4e9bab1256299691d1407b1157dc5ed226f5521ac02d3528ccbda8d4b9747d14bb829e2e59a8e9d0133a690181d0cc34dfe5372f32e6fabf569b3506b25f189ae81a923f61e930870671d85603df7442ca564c38f4bc592c84b49c8a3dcd67692257e86c830c2c6b5134754c62c2df90113d8560abd547d3725f9a8473a533f358d8a8faea2301eb6255642dc8a886b7a0de442ff39237b54eed397b4ff13430c9b6cac20db56d949d7b631d1caeb799f0230184cbf6223f9a3d89a1fb5338156cc8eea84ea77d1382efd97e0653c4b370d66c173567ec05dbbdbfe87765c898007093ae6da889cb271db4ca66ecc9a3bd42ce4f9a469a3663d78fea07acb01b91a03a09ae9f941443d335355dd8676310d132010c1afd09bd7e75627eca60dde8032e6022c976b26617b9d5449f5fd8cd037f60147d80e8bbb7ead67b3ff760e0d5e198776afce04cecdb5102eadd3bd81176e44be9e7bfc86e897191f4db7abdd4732c09d24ac029a5e542b1b60c54a9bf94f98117b6bc017c893d94039db438f7caf371d020741e8343d47a6ae188387dcf6db3f4f7e6057d2b37cd482038335a53926a825a14ded59c785b873760bd7d2ba6484228f3bdfd9d30a769e30f8ade07dc29d488a4df31ed82825a7086803a178312367dc38e395f7eaff245a823d73abb6a366b5c20a8f786870af68df21c900fbd775a07d1356891043f580ee84dc988debd26252d4c9f60eed937ccc84fe183a034ed4acd5e3c5c4bd3680e0ccaea0c8ae4395bd1405358d5076d179910ab0eb37eecce2d561fcf1e116083b27ee8253f9e7d9bd082e86a6a775bcbd360c2d8a3f495f8d7dee7b7a603548c15f2422ce30bebc98e7db8de5c425d28e3c41dd4776e381c0f4eaec5c0da50e668c4e3d4a5c17e776ba899c64e317d4b98a08a89950077ac40d490a1520382c5859463d89941cca7e420ef4272ef6752c71f355bf15394417cb9f28e7a1fb62ba97dfb6c745b7844679af9999a6b877a666a4dc7e8be86ad78a5a7dd05b4e97de2b72532da6d09b7f8813c19981e6dd0fc3beaf2c756aad404ab03fdca2d7fdd506af4e25e0de9ed04d70a49edfe2b4967c050a0ae7117dd20736435d687bfddd389004ab09b1865903b54a0d758b95bf135e63f48cf760f42ec89706a930dc6e27c7e0caeaae293bcf90159a6d31566dabc4fa454b78bd5a1fb6e244385cc6829e6be3b4a45b8ed31700795c0976ef3df07cedb28cb70c5052dc662b1903b0ba975f0e11509684b5c66db7b4d28e2541807ea1b82a1a33f6dc446ec18ed86fac2fd25a3663671843c11e055ce6cc8328ea01b5ca3d9f24cb740a19780d7e6db8b6b08e9fc5d97be6a872a987f2bae3fd5d6564e9e2d189d2601b05cac2fc55d20bf397cdc310fd14595be22b36e63b8e551e0dbbc7bd37ee6a0c5ff49689af386f09e23a10128259628c651926f1e01ca9cf716783f0728e7d247ef4cc32a45e20e889fde5c1e3972b5c35da5db2e63665e8aa7df2d6ec597b593612c6159e4f28b6b1cbf431aba01357836294344e800bc96186bea2014f1395e9f5bf0927ea8e120d82ef05d00ff6b7b5396d0d041a1ab94c22a6887fb7f769f8f4ba8f1131ef0885385111997335d3d05092953958a3acf48dd920f0ad079e4028fffeb643e3cd8fbb015bd28c87012df76c7d5d91182ad47873fd37b53d00f295741030253383b31783958bb1f3575f29d9f5780d9b91ffb5a37b4fc82a1d889d791efea4b3b8ace142da738c170f233f4992ed377b71775bf5d4eeaf5f9f3e1c455122f7968a450a443ecc68bf98b28102423df4dd12cfafdf5cacecb552ce575af4bf31a0fce1d5b0f716ec45842a37c5a62e5a258ef0b4821e8cce985153df7def37886e76bfa2e0e88b4fdd01cb92571dd17505789d147d3c3a951b421960fc4e4a401b6b581b3ccb1a7018fb64eba19d7aa0852e5d7843ef6c08af76e4fed28a91bd82e88893f7933f46da035896aa801c14987a6bc3b0df774a409b559e1f9cc4bae6a750c4de75f75ba06a710c13ccd100e8a6168789910be891900a1c8a5155802af73b7ad5ef7d027823730894bc3da109d58748114d988d9b1aed6ca0a977bc7a24697d969eacc3beb8c5fef17d2b673acd58967b2884018587c1621bc5a60ba34b6d33f50cf3e8d1a990d7d0c6b1d6190bfe0a9ffc6fc4849a38dc319698ff4ee43435b962c646e6954f834e5815cc24f2290523097a1c7d301cfd745eace30fc5a85de3a01fd9cfab4ee02c4f967b13317a8549a566f6be72afb9faf59a9c271a43e8d86a675e1f121637d2d3cbf9624a2ee2a6d03b9de32150cd1c4fcadfdd74935283268a11df43b74cb74fcfb757518e25773bc224686658ef06138e5b0780fcd1f60e65f10b2543abec46f6ca26711a830c34a0d76b062d9daa784ab7f819e92f1fa008b058282c8deebfdfbd9cd2424973a0a7b79742667d4dbb1a934142dff70eca87096cf78fb656e64ddfec58782bfbebc51d43358608d5e2ae27b62d3cd53c0b95c197a850cc85930458981e816171b453c642f95cb83fda6dcee729900e53990650245067da6ee53f5a337895dcfd098c67b6ac571dd301c63c34579d597141fb64f2e049e9de196c129bccefbac29ca5ad58d4ac7829030913ce0ccc3acc25153826c62141d44f76dbfbcb6680cc96fd299a5bcd32ac271c97f1358d1dc0df586b8b8f0bd009b03aca9bb6636daf6654f8c8db98c91d669d7a96731c2b189baf0808f9f7d7abfc717a1208c9219b1808198a2d8d35f3bf43af5450f0c16cb36b480805c58831b3bba6a3626f042b1669491f08323123df5a14e4902d05c3147b4589d5083e011255412f0c566de473cc61941febcca4c79d127ef4e2c70c49facc09a9afbfb580de6f4a414026887e1045851053ca2fa200ced3c99d3c96b98ea8dd93d16f288147e433933f81c4e28151ce83b514a4859c8d437068669c4e15494feab6f0687025571a2c518cb5c5feb2900ff8c5270f1a249499b5dc062c66253302e69ee7fc83f27d1510e5126bf8bc566dfce5ba7da0480b41e4dca3f5adba5414b66226639669cc7f39f911081799995edfd719c54c94d730f5863ebbed45a7d25364a83e98577a90499e950e67cb7312484aa26505e76d995e0e830d673ef99e03fd5b0c8afa9d5e2bde18e5477f972bf8c7db3337ea7a64309935935d4adc8b597780237ae54a4bf1e1886d21c25dd5a0a7a407a48b0f4b5a995a125f6ae79a1f206b3f432d6a36cc85c458a2649bb183f7bdcf744cc294114dfff906c80a685c279d68c2ef9d6926289cebdad7e87772e424a225141270ba0b147e5561d0cdf8ca48d66a63e00cdb6b6fa232d47059b69262943c2e40a87a9b7f4348236bc44369784cdf5412234b95af659d3c4ffc3fcfc5b43d30e03f829fbca0a786a39d446dc1adec2540bf5121fa4f2be346c7c6ae0bc911dd854d8bb264ea88e6306d9b532f78a237b15561cd42df1aab8bb4909491f2ac6d367e673aac3a0732c127bf1e918850feabbf39a154fbdaed62ba6c36ec348329b70846d5abb0393c0323743f5a608cd023764e876e2372e7a4ef201d27279cc3cb27a8af792d39837cd940d3b73ecb3da05a3b2565466d9bcdbcbc1e8b1af6669e9da85949edc9a6f5dac0539134bf0111951e40b4c6e2e156baa474e16d695b1eda9f8d9cc22e570cd6e46b4e0a46e4c46cc75188f451e1ab56f005af5f291c8367d0611c5544345e51d2f79ee86054d5af50b1742f446028dadafef14014c695425affd90c91b7cec225374f229aa80edfe71959fcab6641d7b8e6abfc006740bb80eb8d270644eb6bcd0ebc226154196ffb2c5c98927ab9bb0c8324af8131cff788d465924232aa1ed7d44b4f1b6a0c1d0f572e8fcedd52177ae3d0b5524af1f10dff039be28fe125796a5946cbcc2b707cd5bc48945f24de8ba171044cc95c5c7e77ccc4eee17f818375d24a615ee4588cd55e411d11e973570a56ff4cc4e1b996ac30517e17972eb72d62758fb31196ff3f8b2d0619efa47dcfa35dae096cf86785c6fc105268208e857d39bc4d4a1c6472db1a00b3b9172e7cf76ffda14769d9a2e61c6a2ffce2d77e99c95407eb235dd9802844d1ccca82899abfc7e1a8524cb2b6489e381fac4c6e0a2e1020ae00df42c09d8d43cda201fd018bdd5996abb21c44eaf82024bc566bb6b7d8130cba6e9730e2bc95e2a4c7e5041eae6201bb22ac9fb9b47ea193fd19c82a256356cefcfb2db0dbcdb3595ca3162ab2b1a9b3c61a3c1c04743ee9560ea9d8afa7c8e63dd0b4659b48992c992a8c13703c35de70cd00827f43c5a6cf9398025c82262b86f1314c70c68dcb26ab5a7eb39328b553cb5c276b436e6de876d7dd007e702a6c3878789904c5b48e418a481909b379a93105a0825a9bce4fe9764262d79f8325b44d780f3c372849b355574d165528e4a505a5e882343bc05c94f31e672eb4afd41958afc717b312438c1850e7042ae6fe1b11ec9b9a36ad02ddd98c3c6076479b8f13737cf436c33d488feacff42a2751173f8da3ada3b69c32997abf80f5f7ec761a066e42580b675be76055e227083dff4e98e2aa75c6ebac7002623f0a5478d16677235b2cf829c047a383b7ec18bebffaedd9e317d98cacc682e2d563ee078b0b55a230c2ca6fef68b60d584ffdf51400d8294c718b6720c5679150f4b6eeae4868066e74a94e5dfafce3724ba36b329c933ade6123ff5eec5060d58e242e01de72f901051698c635edc59183a2368734b493650a3a97f6a5add11c294bf669997139e82350218b209b1ebf351168031535deb26915d815e9af04025777ef7bde2774962139eb2b843ac449a15d9ee877b34584999ca52fbee43c3335a7851f4db0c30197ed5f8a5de6f057f7cf8a2f2a4ec452c92176f2fda56117e17be576b965bcb677f64de5cb2dc15a8b213570bbc4bd7aabcf433b0a5eaaec3a23ad7a1fa82d1908409c2ede2d9288db66bc84b482fc1bbf191f38d716c719e1188870e8720fe3f043e92cb20c1cac614b60f193c73991a8d76aaa3779e9fdca805ce358a6738fc418491dbcae2cef2be771be6aebd1846804fe0711070f0b5bc43a53c00b039e070642a6c7281de4bb71dd5e93029d7bd62f98959d49405e0d65512e3f16cf3e9b2ecbf55549fe999e6386d21a9a355b15fd2fd1070a27c613e3f5e42c3b1b5fc00b9a0a82866f2e83d7bcb20e69997be420e59a28273a40e63d8a07333814c910681640579a05dab26f29e5581f737a5d1fa9c4660626d692bce1cc837d2224b62d60a6045e890b80952174f7e68b8297f05438565a0d167a821d14d1f9abc974861190920d20e18a3ba3cd37430cf2f8c26a85f0b21d2d27e157a80846dd392f553d4b8b8f872c852d9dfd069521e480d7fd69e5c974d4033a9ab3b8f5cdf4877229d5cd598d820ee57b15f3f3aa05be75f8c09e195e5d4796a6a858465f497f868e7b812b8d97f55bb5ced7776f918929d6980eac695b1e918ee9baec3d0d17ae3fa77a0f1cbcd0fcf396489dae0605031119ad95137b1bb5c8a46003decf0946006a79a79e420d13b7382259445f08b905997976b23ddd887250d35164733ecf9355a17182135b1b9e969afb2c523b57c04099d04b92768647904b6bed3656848491c73661e4249eab0cae87a5e60451969e50eac6faeba7fded9c941145aaea2df0b04a8ea13b04c86f7f3d38e6f0aaf470c638ae01b9441fd38c9f22e8b0ce23d6507f85f4a3c987facae7c53e1c3e8d48ea851736c5e11718270e53a962038e143351cf211b68e6d21b73a9900da497fa2778bdfb780aed280fa8f82669e4c279eb6b40f83feb0be48a2989fe4e632b0eabaa1d8b64ee4f29026153953867658490640c64172349dc1bab412aa0e29b9aca840576f0f14a87b40e5262fd4283d80ee648ef3092c84c618b7b4d18a7b47cf7c06ab29843e77a1379231d8df08f356a2dee6078388c680abfbafa2753d363d58cf0db6c732f8704ab9f1f9d0c50d42b40045206def14f507d86c18dbdf231585fccd8c2c2335c5d9983d8542babe703cf4bc3b3a7f89724d723d76034f4bc0d78216877fb44266fe4ecca5a2957e13fcb41a5aa6ba3735d3d54677e2c05be202844f6ba34d0cfc5d0f9a282f542e0890c56c4aebf212fab10a92197e3907418b1e2a42edeaecb79fb03d06b0c6adb33e8ace6ae491be4ad021f6191124309458ec1e9e3ffbe1f0a1b552f1674eaf71369e82cf0e55a23fc32c61e258192398f6529f2a5188de987f362bb9b676ff826b1558bf53e19e53faf5e6dba57a81491a16b34b07b21af425e40b997674dccd211fc8a10b2765d708d6c1a436a183e888c5aa32101031c6e4b90959930cf208df3984049065ce903d98c318bfb88d5028c500dfd749c24c2731d6c8464b6e151b907a57f48814142abf8dda1cbddf6633b12ddd3299db4eecd0bc9d50007f75197660a0b868b959172eb1cbf29a951492203f2875fe24857dedd7b9848251ba98a1bc4fd3e4b7d3cc6a5c195dcd896e874e61917feb45cea5b1cb8789a303a49cb9136a33445a190b606b15390ab144412b2001e75de026be60cc1ae3a8293e9e6197f164d9e22a6632daa923adfce0aae0c152c462dbd70a80931154804f3b96bf353b6d79afdedcd9a7a8bc8e995fce6eb84ae4dc385149a87ca55e59ea5497ddf9fe4ab182ad9bab53731e4cb9e55d25fd65aff286ecdceed16c6fe2c1a74848df05d8708d07791f7e05827d4625c183e92d664b758b968ed0941d0915d84699915ef6b3222ba780a0f14b9697f2895037d2342246b62e965012f4e9f25b28b9a6781a654d89f638277c59b139d609ff594e5a6dc5bca597c263cbe8de79abb7d6980d21b4bcd4159a8da965f4a07c40b858ebcb0f453ca5c05f009f23def8452349bdd9cba1a4c0d0a2033409698cf77a0a5051cdf93ba0c2f25c860371173484bbf27c8e1dc07c22ce05e5a5089fad0250aadf872834c92010665339971df1e9eb7d45590d9dd566abaf505c703b8b8967284e5a421b33968a9c078bb6d8340ac6d6bc780330b8550e572e6f384a42dec7afacdbc28d16bd29c3482debe4062cdef294e57233bdcadee6b8b0708e7e8b33f2f9459f65490ed2b93b79339086458531461d85851cb576cb6b24d4ff6b93909c18ecc2dbc8dda878c5cf4d905b7a8dbe999c4d70803f204910d3bb4872a5efdfb544cfa963bfafadeb01e0ccff98f5faf27eee825f9f0b2aaecc005b608030e82efe3357c1eeb9f02c041ee797f1ce216a2cf949d3d9afdc6ca55605a18d5d96c5d18e6aafa971ce64fc93a360505864c9f4bc58a8da93245656f2ba2524584c178e59e3791a2ce3127eb2801ca6e5c954287a02a041e945ebfe76c57bf3dc6938092e581532c564ed118e8ee387d45b0b4fa4726e450007f7042db4adeaf731465b6b8202e13e99b06cda1285764e12663d0acd77e7714f8dda09fec1a6c03aacf3e7428b8c21c8f8252480863705fc5a6d6987b308ea937c0c32835c957fdf8be1a2d3651c4b01b34bed2ea1789c9c56bb2c8d2ab87a381779ae077d1c2f587a5f052cfc9535d89e65e534b41139df45a8f1e7a6a4b53e10d8d8b24accc4fa55f78f2084e7870e638c94a8743b25b3f41084e0626bbe98c660e06f2ac728052c5a7f5d5ddb463f855d8fe6ec8450138fef232200ed7a64baec424fd84cae99ba56c2870fa8793cee504aa899ad6f5db540e537e914a97f71f1d7d41050234c483811d07c216f2fc991c58701deedde0da63642a948b5ea31b7fce0ac22160d5bd1b3e235a0cf90c298d6d0fea4a0d85997d67e14914a187a78e1772e8f6dad45f6ed907ede8692eaef48bcc9a42d2db79ae73eb84e13a2ddc6e23d566d50751347d91576557b54cedf7edb674a6f3c92eac486b07b7932f854998a31b4120aa11e0e57c8cf1aa936a3d6b958d2da03bf27274e191562c9304b5880d85ae21b5c91a3fd15002c49d8da5a4c6922b7cebdea1a4a6399da96e2dfcd4967019b283a3cc01d4d7a7e0333125b5b9930a325c0e49e6e0c2f7d0b268ccbaf10e2208cca75e258112faad82b2fa1e835249bf48c1bbcd5adcb3f5793a2dfe91fee74c989f7ce8091fa30c034b7b16a7cac036698440b1aec64c1bacc97f7f373353fdde6e5d5e9c2499099dbd283653a24a57b41d6d76cf4a1216de2f4cab98a1b00c7baad3e7cb33ba50c69132b5a0fbe52b5e59deb10cb8f1ed433d65ab7867f7b5d8ca16d3c1784b8e2029edaec273a33fc167efe3ee156891dc31b139809a0196aa4e7d607143150ef7ac386c938bbb37df9c2f10da0f75868a470fddf10e0b6a47b6a705e9b68a4cab9931a3834aa578506a769e0afb00f23ef42ad53ea290cdff51cd627a1a9e26221a0dc5bbf456ef919f7a58bca4c1d7515b507546330fe1838ee2d526c19104bd1706e9651e6e6a28b24fd397b0b7a67d2b1a28019cd31316ae278f284e7ed05461bb1c6264718fa622e59853dbed6ee1b845c6d88e12f415f5f90242bb7d8b1c3e60a3ee89a885b0f08d2e7fe30b8aafe48fe81e0898fb779d5ce48d0ad22f0cd5906ecd4edf2119228a807f89b65cd3fd8c2248f935236c17948484588b72cd8b4b9f16e6e21ba6f82c1c1ec18f3223e6c5f6e90fdf05f5c7347b49ea240681a97d041848e2a866777bbce9319615a0eeb237595f79d5b249b978857c7dd298456ec79dc45249dbb3bfd935287938aee7cd5958ff454d453962de18f304b9791887c331cdbb8e859f9ffcd1bb2d60b6f4fbae29f4fd1d84b2027e9b40ae59641218f9391b06987921688a27382cd9ce0ee0c0c1d5b644d743c6dd6c0fabb94e71a513cf12b1f39e1a742c40c36a4cdf546394977ac34775ec571fbf2c8f2c21f1478d1803e6f85e4a536db8c6dd81600da9aafc251894a85f934644041281448c0fef4ed2af575ea3e19e07b66cdf55fb9ffee020cd53bd559f9c46587069a5a0ce547070c22ab8a18ffd06dca8496f93a8f8b3c5653d5d6d7317c464273366e6f6bd82eb7561375b9884f4771f447cc6bd58a3730950882fd1f886b09eb4f9881ab70decd78f2e5c409f590e85e4770c45fde7814cbbb31dd7f91e212a4dda968fe3388ca236f58fdedd5e432e236bf7441408438ea4ff8860d62b86692d246a9fb78795a79318abd1e9ffb36928743e0efccbc9087c1d58a4980d5ad5bdfcdc97d855545831af9958fad1d8b29077f40ed7a096717e551a2370ec0cf802d588b412d1698f66267d9db3237b8fcec24f34f00bc82cd3a937fe8cd707b03609e9c6b98675081080e239b66fcb03d772be442b7e35721f6ed70007f0b04a1dd84f2c8f14daff6368480f9f49157277b23854fb569f67b99d88783e930e55cd812fdbd2e9da82a8beb4d36df3f0017a212876a025eed402e3a37f032c28a0df744b00710539372ffbcfcc52618a513480435511a3c121983618eaf7aee5803fea47dcc4f35b3de73e35a016fd438af9b6688b87a3d4719ec4ae0e21ab6997ce23af2c5c5323d449b38239832b105b5b4733364a3faa8b28a1882e55a59d0a04eb7e7ecdaf39767cec968297f880c97c6568b3af36b16f094904898dbb463e97151f6de2fd69826685097fbd3367e217e99b66dc8a35b7cf6fff22f1781064768e54056a65bfdfc7f1b79f1f49a7aabf3fce39f4ce159e4054aded4d53946eec70223d14f35459608b0ad2bc7f9ad74ee432ea1bdf37177e2238e7a03ec6575bc756c66893da04eb6ef9fb1081acc2fb962e8619ea694c2dce4a1ff33095c96cb7f77547f21329eba5f48c9059fe9954dedfb685abca55179473636e49bdc61b98e4391867cf6a5e9890f08bfc9efec0d343735aa14ccf643e4f588fb70f6fa75198cdc436f7404f02a366f31cbe775fbbc42886887fd5b89faeab203e6d871f5094913d4ea4683335a23caa7e97b18fc7ecd5d1fd4fdbe5f9f1214e1f2327e1a210ac19e02e995143ef141579760e2c5c66325de6d5854ef7b11fd381335f47bc7ed07d18e95a1cff9ebb4589a4a9002eeaf1143c11ae0b81cee89323e59aaaecbff7b0f104602a4d4961b3a85eccd2ec98b9fdb53fec252eef140c791ed1232b915c44925013b9a67bf77f6d1f989fe2710c09b575160bbad7b9bfbeffe8dc782d7e320a9fe3d1032aca97adefaa345a16f48fe9c31e49fe0ef1adb80d61957a15a80c3381cf120ea9e156d92cbe6893fc0f760a55a3b9cffd79a3332dfe975163fbba180a083ca8b0dba8d331d3fd8cc5b4fbf595199def06717d6b1437886f46df697a142b5f31112522b663b26250218d9fb60513087388b6a583e40199e618a30fe0e9f0de96a882144b36336ccde2a3a9aa9534e2667c20bcccb29603c5a5cc44b2c9dbfe359fe32fbcd862bc6c0069b67002245d0486ae1e80b7d15ae508f2893e854f6d3307f930a29951e89ffd9598350e4386ebca4eab69e632da169bf6de462025615aa1c0e09382a1d0c1ebd710dac819739fd636a7aae8ab2e64b309225be3d8de2a453320d0dbbd0a7f28435c1083bc393f7a4234c845550a727a05160820496b315a0bf4025b0313a311cfea41c98d818e620e6034d99d779a6afc7850573726091a32ea79055d9ad3360643ef196bd90bca4e4c16ef4afea02398cadb28013a8b9caab130c3f45c3f82795711a78b31254a4038a00b5b076d497295840d1b1cba3d2878d04b5f05019e67f0ac67d41abab2326d7d42911ebbd801aec56e72d34b06577de860ac0d975fd631cc414282de3d08950901fa509b208c538100a4b85246f110bf42c500767f73a28c4c003c100eef5ea63f8cc7b91446e3e6320272250768d16a10819acad1c3f6b00960cffd4649c551ce724f55602a44157e4986f4c91f81e5b8139cc32fae3fd4c3a5b90b75de74e847c23455af370fa0aefcc8ad92e1fdbc7a32f17b425195bff3a48528eb2144d97988f19908c45ee329130fd9643a606cee3a0345ded9af3405b295c3d9bade07279baecc5e102902a10a03437ae83d905c61c758b968d87acc200b97790967bcc27c61726e1c9a6d3c3a3a3a494a7edfdf3aa626c9dfcc43cffc8f5bdb1846eb4f5d4f8e2eb5ca9ad6b8d16cff8e4e0337858ab84f63104ad9dc7414038bbfbf0ac381af3f75e5d5d9c4038d81a5a9d432bf7a03ab9a7380868961ba536651553846d93fd0e2735f1e9db769ab6d136cb7d1edc2f400dce84ef0132d1fd4499e9492a56fd8c44506c5e890b96b3d32feb01dded445a8e896bdae27e9e28d77cba23b52a84ad337fef54b777d87bf0ea24b2f414ddeefd0a6952d1aa3063e6323268b643c0d85a3a1dd4fd11518327ecbebc2aea27f15a0084db77deca8c5878718f1a51dc90756fb6d63e9c10425dab795b3be0899a5fac6aa5de2a85bc0a27abc2a4645f8813f0af99c83708e101e111dbac8f625abbc0710077c16e9e11db20ec28decbf60f872e1b685dbeecfbb148fece8016631425dbb0a91ec49d5f7402a67120173369632f11cdc74cd70abca2f546b8c6a4c77f952de9e078ba2fcb7ce994b843ce748b5f9ea297bdfb98da33c481ab019fb9ee95f93bb285a91c904fb0c7be1d2f5250799b63720397d9e8a1c1547753934a01b8623210b38c1f802242e754c32aea6a463a30a862ef8de0c4cfd0f235f5b6a9fd2edf48b194b88c7c240df61a63c6f69ab42b33b7f368693a2577039f7656596c31bded7169bd52f8c84480f4a2455dbc180c12b47e754f3fb215ca6603224f96a0c7816fd4af07b8842a1af4ddf1fb2f421dfd5f860fa39ed457327e21509e5ea99073eaf49c96bad13ae53f119791d703574ec812e98de6c784e0711772dcdb1514507a3898572630fa1055c46b88ec4548ff8a573a8c5e3b5dbe55f0d36605e93d9d2d6f514c2d75be79c45dfbb1bedf1a36cdac1291ac8f42efca398d798f5b5d83328fa7cfe665da8920361a1c203e520d909afd6b5bbdd56f626f8ca4158d6761d6e4bb940a147e92fc5521714a8c648609b84b61caf86b64436b6db804238b969b8c0de1e3a127c5168b947021b66a2ecc8130c5fb86818ef17b0a8f09b7f27142010020d8abee1092ac138b8bcd7896e28c2488dcbea71baaba705e6e6271cedbe89dcf65994d0b985bcd7a4a966dfd817612fe581d0aa55ab1ad335c827b223255d489af809de74c41a0d488a79f7a5c4add0eb536dc50bed3e093224bde3be889be49f9ee8158982db696e8bf84ac313c63f3b38705da8f8e1e98fe55a800be71be08139b05e34e2e5e5d9110a83e291ae357ec6be442f64d25ddfcee6db08c58d66ad9c4638c8fe56b2fede260395d6b09d175f79906b1b22a164258ebe0175fd1e7ec54b5e099c8560d90ed76d5658b6a77331ef432ed6eb95f0459b26394ad920982c1806d99f59290573282207698d90bdf659a357b5898f9ab20858e079ad0d0e45e658517957aac5fce495a4bd55462252a045efe2535ddb81e481768f0b28e18cb1aa5f77229f059f6270ddb4438bfadd4c5a3dcf55cee8301f667d1200f8c76c414018f9aa6d124c25df85d075e39ba1f765e4368336a73bf118d859e28cbc612ca3bdb5ff8c4430cbc14550bc45659040035f8808e6430dd80b40b158dda449891486e62af63f2dfbd1a835ee2de29c2794483d728711d32f7c773838fb768908f2b0f29db0305b88b906baf4cfcc4c2ec51a554bb1e52e71ce7f87e9ea8e9a1aa0dffb9feb72702138a4d3a3be3a236fb255b3c67be328a9773b9007dc18dd68b73288f62a54d2b9c7d1e29982b5e82c77e90fa539d22b69e294c5976bcd9ccecf54d37049c71d91cffc4f04e2f2c490bab87768ebb6d92809bef2740558528b8deb2ab545151a1b4816a729595243e20f46061fb0ac9fa3a0b65233f3a3026d5217202221f093c6da3b2b2fea84fc727b5d1f5b4c5bd5f8e9661ebd0b4e3376ff233adcbd364c2580703f29cdddc71bbed47f5c50e604da7945d4fda11573a2e2bc54ef97e4f0261206047882d20415e2978058f8168929b8a65719adca7046579726845ca5c32249750ae2e664f3c890d6cfd8e0a925065b1724fa25b99e13621a52020a2fe828230a9248973de95fa775845b9846f3037b22f410f0531aabac968078ebbec6fbaa2b301a4999f3e8fcd433033973f7542aa3f38592aa07f8eff2918ce298093f58d58c539b88f2a800137e2c35a122d7a5bba6e6137ee5a4cfaff24a71bc23f10841f007db04d64b4ecf597ac4b465707ef80352639001931086299d0f4f6764975aa2a18871ec004df36767d27b5260520ca4fabf6f99ca61c08adef24523a71bf16f8e36c14ab69204f8307889f8029847fbd377b187d6f6ced97f2083744188ab417cabc74d5181adc7ab78e65e872eb6d054b315e2d5a1ed874e137b0c861a7c2d275d1c14ac2cdd3e5ea4586b899682e295804c5ddb3e9df6612376e108316801016b56c430763a924de9fdf88a2722cc2c31d44046589026b8167a1a009df093b3cb8aebe297baaa1f94a203111259b2655af1556bffea4bf6afe2083d74d3ca6d9e279fd8d77e098b7b60b1cf371c2c295ccc367e7feb8bd538d02f72d24675b87c82a8d38952ea7685073249f521b742b146addb29717169d2c2b6e0fa40fc0793d5d5a132986dfdf105716b2ed3e78c709c7223d9a1089a1083df8c83ee198893b2da982e8d42721e96649e2b41940ec91a3b827880940ef3e047e7e88cc1ee03a6c776d7a2041e1d2a0d1a11811ef599b2eb90b21cd86f114993ef0c7d1b3a122b4b18e98a16189382e33811c462f5db2fc2b181a3cfbee25114d8aef304b90182fb0ea6924faa96428f7186ae5935cdf9a04a257347e384fa5dd996452012cd3037d83774106dcce4a55224e7b8c166e6ad677cb260330a56afab8d29b3911e1cc74eefb69e0ed9eceac049c0a0f88d0428cf4a72526679b207fc72de6e4414febe37ffa6ba2cc68dde7d137ab852b98db6e933a8964daa47b8a1763c53e965bf265a24d4770bc9d890438549bcf949c2a86b6cac121041805ad00e4653a596127fde2fb3c066f13093eec4aac3ad45bb3d5692e9e42e65939332cf9b66cd02955aa8c537c2900804e519f95c3d84d1cd7a244cfb15325f6d87a292442aedd61fbbe11c821f4f3089e29acce70b07f7276d91c8903d8c65f499d204306e5a00911fccc3c7e71df0d84db0c4655a8b4f96be59478730da21e2531ad5273e447778a08e641200307b55d064edee181fe45fc4fb30b79f40130c2dc85ef4b25c68b8defd1be0642756868778b51cfde5dff6b674836d39ac16668446949d498c49dadc4890006bdd583feb27aa2f1f3ca67f90dea42a0071a6d348073960d55a8795df58f4081d1021f9a5c7f3bcf514f35a6bcd70ca509c18a4c412402bb50328bbae3d424f79b999d3589ab17b437d5f97a2b1fba2e2fca6300d38d86369581243ff31a8c7031d67c79d6121b5e96bbcdb1c345207dc596e6fb344403746b2f9ab9954a80c68fa6532092ae5e2172666302f4916df0406ddbc47b4afe5d94f778eb8642a8bdf49a2d1984e6c34b5b308fd5c12d4c8b87242fc509b1d45e8c3794eece56691b38054bcc6633bbebd3a631caaec3f2a4115bdec30929222650df85f77338af44f7bb681ad13d4ab9ee8168a7342229571db2c24cec039c1b6e8cb1ca75ab3e3db756d0dcd0b8cf39201958562282dcc48be8e286e67163c8d730f80b3e8f26ccd0545e1308bb09587e6e503e20cb0a2d94d69e26dc02465bfb923c7b2922de3746c1be72149d91b89dada82424cc3e8a0b9ec7f71610e26897361fca889c1260a4308a08e4e46dfcd7488f4f2a687e01767da98327042d93090ae00aff9804ca2a3e9aa88186dbe06dcb05cff5c5037481c011e52e8bbb3b47be1ba31c81cd566f493b03d1c878e040846df8dcb8bda0cf1b18b4b993b858703e8162ad158b4d7d38b4799b608e2328ac1f2e729987affc859867d677b918b0e14adc53ecd1d4209430126907c1b53a441b260f29a71fc4a868944f81a6eedad5f220bbbc5f70ca01cd5cddeca5d021d948533ba19d84822e482ef5939538b8c351e2b881726edba07c609c34a80d194324f91e9c343f93e55d1d511df082415f55cf705721284d69242620ceda9d63f72c73e43958dbd058889c93c7842de9bc568668993138099d02014ce1181828e8de79cc23cd9d352b69bfc13f32831db191ffec047dbd1e273e99b511b92703fac97fe35059d5ac8366a9ae2edf292f693f89ce0b9f4332a97bc4d7d624cd656fd45e59566f56c226755b4fe20decd098c5e284ff61e3942bb20dd5cb37e286a55812b02e1db4cfa2f42befe60f7ddd745d666aecf6c4e2a897ffd44980371d6cb54f3eda2b538e2579285aa3148c87e0986aef2c4bc63a7bc5bdca969e06f971503a6fa36cd4d89c1b2479cfb5701cd27c5f8601804c9a69eadfc735b53dc3f19a28f3fe6c26593aaada94b56b2ec79ddf047e7e186ebeecb29fb5728280204c0b3c252d23a18ba7add0310c782b16dd0baf3c21a082a1359f101d4c59aeaea99fbe4a58937f772b85b3bf6d3a54ffe0a1b0e735a55d6db542e118b64e052e5e912296e372a76346441b8c7ef65305972b7f960c12ca735a2ede2e5bb266ca16c33bce21c533b85a6dc7a1de13d69ed48addfb108d5e132433c13e17409929a8ed5bc87063e492d2845eb983c385c08815a1396f5509c3cb8813e211dd6c9734df201d80c80ddaa8d56f3ccab54a107813f5b3bbdebe76ed347522ab46ea35fc73aa1858b9224013078d32a518f7ddd933b104b306c9981d1636f621b2b8a6e1184594efb1627c2c13505c66c5d948eeaa61c991fadfc3383b81e5a488d934d472e90d2718f916d0a0a6905bad200827bc45dbbf4c0864a0c965b3254a40778a4036135a414675535befedade894abf231c938eb8fafcaa95853e171b54be3dcebf53a07d8c494bfdbf6f0d0f335ecc919bdb7e0c89675a6c749c81fba938e45c5b97155f5f2558ec831ead46a3e452cb181e5f0dab5fb072d0cea5777a8fd9c234e7d7606ab543431339a014349777fa62ac4070e40a4de12cc9113a5cb1930268bd51415c80ba6f3b7fd3d7de560c75e3178222403445fb154b1ceeef99970505bb167abd855e6aa85f1a661d3e8a8ddbac6e7a2983563788275261f7243e6e5f309cbd1e196d991bae7bcef917efa610c6986e199e9221b15dd8c1472923a7afb7c8be2aa71aff54bae2e35f692c495b6274f565e623cd6daa1ce25e2f204ec226a2e3676ef51a49a3556de7c3d9600e4ba4d5c8ae48709ac775b1c0bc45026a7b527a079e4fdc691fa9fb365aa39cad76adc719b2642490ee63033d4a4f03eaef727e042ef5c615bbc6258351fa9e0df4a9126e18024cece4768cc0b756012360d2927f13b9151ae5606ff333755bdb497f59a83ad1aef4a3361020fbb2f1b82fecc9f62a49440913a7227bac91f9f4416f7bc51555b0d82f0b8311a9cc40df832663a46ee778f9dc1111748039888929cb61d7a881e7765c4f02c31be6fc0b93907a0e2c9421597ad6361fec209635d7e6d5fb5e71323e3379a6677a31672688994f79fcf8da4cfde9b79f93d36ffb9129eaa0ccd7bc5b6dbfcd61b4f9abf98cdd44fa1ecfc483a00cbbc750af08824c226cb226673bb252a2a3f7c09eb3625bc6471e5378c94a1f8a3a18202753eb02d3d01d632e6f9f124b6f8ea139d03240f5b6f405ba99341c684112dad7c69e0ede8f78752e6859b009213062e733724858327c1fb76fac9883744032cd4035bca512e3f33afb72fd57753920fcf990a3a0ea527cb46a91f45a2e150c431be3c42358c166e66a684c3787856f50a8e1968197967027a8fff37df15b3570661aed85b3066c0d69aafe7e94db2a2370818ff951e31e67ebef7e9a4b3069a8c52fce655afa3087f02158134101316a465fb681b228cd9e050048864a2f614940ecfbaf0db06097e3d5df900cc37d71385bafdd0c772367e74c9b820229e0955fa06f8032cd8b1d89220d80fef1c2d4a67b52dc199a2644489321c438f6a937529879b74bccedec511de797142a001effd5412e5ff26860db2ea29ff99781062e3939fbb5d54fd4e13f1df79b3517904fc72d2ce2923486ee6fd30c65b4179ec0fedb992f6b6a1114fa8ba576efdc62f829b9446cb291795c9dc1125013c5e405bc58288de7dca1beaef954fb3abe85438847d9f9b7db3928e69038a56bc309a7f36fbff0db5198374a0877aad006d0ad60f8bfb1130eb4f2e42eaf031c61ac6ae167d1e3c9e33f2520e9a9df47cda24ce8b437290faaf0369033ed6f3e9bff1e49c0ad2e5ef349b7baeaa059f41f57b0b0c0d79cde6634803fcd441368451be949cbc80176019c111d1180f435b69aee24b20d8537671727cdb87a993c0a04feee74fd566795c03b97418e022de9e42a375eed10cfb9af1de01a6da424fee5beeac57b6dc434333b99a7c7bd8dc998a7a09c833285ac74fcd6914a81775ab81c9ae1dbf9d979dae6178aaf29a3c8945054296347c521457b8761eb2092b95082308e6f9d170d537bdf228d806199b0f6eb5d2057c6df1c69c93e037debfe1623924beaa53adc3273d75777e47886e8fba42a233f561b02bce1b4db4a3a795e2f802d4d8672b1375d108d7ef3a6b5e6752a90908952a32f2a44a81b1d5c12a5f6f3e80f273d33e740d6d7d34270cf918cd7bf781a64ceac65dbf0ff4db0875c31101baddf055b1bbaa4c7d388911cc8fa01dfa5f07921f22c9decd1567e86bd3c39c5eeb381320c9d7b6dd57d22cd7354000192aaff7d9dd6a1ce133a7cc1e84f0b9d32f8b4c30988f9297dd2b528621085e43b68ee2ee14031056b8320f3dbfc8642e60659daa8c50494f04414609c15196855ed18ed956bdaed69cf3cd6c340ec52de4ca33dae49a494ca7011513d1e6b30fcc302c0c05da5d0fc5badd22c220b25623d0381c868d284dc90efa38c4a7c2982293dfc857d8b331e85123cf6fc1548cca86a4f4c2d05f66bbacd15f6ffdd482f309a392988e20d16aae280b79f1ab2a0911715139af6dd432f7b5992948bfad08143c32e76d51bfc0cc202c73bd1eab990caafe874a4a480b6699fd0d735108e8c3671e0b1cd462ba07cefef328be621815d0efba3f449b3fb3a9b70d356de1381b250a8c3f79b9003f8ec3b916ab49e955467bec92480e0b1a981d9303d3e61c7851ea41958f27550a5570f9a4d2ab0a7f6c3a64e1b908737dd0d17ccc0ccf027b399eaae8ddc12d9c7f43b0616967f826668ef7bc7e5e07b3fece8d16a4a9d3be23afccd549840020e02e4faa010ac49c4dceec5b64be9a9361d5313bb7eb3e6ca85bea3a5091a84d5c96d35b70ef5cceacadc809510587e12ad902a28440bda73b4b97606cb0ce303ede7a7c26426cf6185339bf14fe475e0aef8cd323769aaac753ab966f1782dc69414e6368c6afc790a247d5740516dcf8706ef81b102fc29e803d051ca1fb6d330b63a5308f9025e2382e20566b5e56ded6e95beb22b9668a1016cc4af795565eabfdf87fb4fdf9390496417866bbbbdf28b87200ccf8e98be4d76501e9e084115572ceddc621f447553e4e95bc29e4e429e9a6ebd7c82cbf7513838ec0a1d8c2f32803703f69594c0e8eddc743e24af680ebd081b15c442e5c89dc4dbdb8f7e7664ce3304ade96108040281e79402f0e083c14f81c9a7d53c2d9f8ce24740c80b66ac3baa1e664a8db9cc377fc1e32cbf5c541988b2c5f7e876560266e1f53727cb3e40485a82ef0a7a123c07bf77eb0c59c0fb162ab496c3384863f95791512b36f3d1cea83252487d34f5f678d70abfd955b07be18ce6df0cc008a597cc143cfa5570da17da922ea3b8f8fb68a8db9aaf41ae5eb9c8b65560b4c5d06fb0b076d15d6bef814a871805ee2cf6657aac6631b68f2653fe86e9f9d3b929642c3882a2866c6d423ff7ee8e8c5548b58f37c06f81d60628b98c4c9b5a783eec684d45cb81da7a688b2ffa3275a8975e54b5f694da59f6d556d58ef2821b86c262f0fb5345e540b177e70e75de2f351efe4cc9919a790a2efb64f49993a21d6709c69d36da6457e012673717e68ef4ffc219ec8688cb1da0f87ef652b905b5882f8b8c50901a68bf1a7940f1ec522662c09bbc1970cad61a3e259bfa22ea012654f49ac251e30fed9718118ad6014d97cbde0fa86b33e0233907ec9f45d89006fd87c9a34aaeef0503c7b4e2d78a32ea835de0a0b2a16fc2fdd5d0b3b7f0cba087e47803e0956aa89eb2c060f6de9437cd178bdcd3556a37f932bfe2a57fb47d80759c3f6a298eea93e78eae986e283c174c8d3580b41e3fb661d82194f3f9e5256a24665261e12b7f562e3f6ce67eab22aebe4b8d2857442dacf9ef58f1b1495e4e041dbcdad831784b051cff0d895652c135f11f9ddb854b733700e4bddc4e8667045a1d87d5b263a645aa6f6cbf414d6187cac80899fb9859f894504d8eb555f373dcfe0b8c1622384045b88dc0608fac083abf03d1542c2a9ebd7688c504824db0d37735c8ffbd72a894ce99f1ada7ca871fdf9899d441897522e1bcf4999fc64b157e66bff4f11158076ea35d61fd5a30ead3f60657b3d0a946e5833aba88f716304d55accf5c0c4ff325ead0c61509f335a603ac520e071a94f2eb6a8d65ec6f366106a7addf9bbb9edb9e56596e6f26e77d98d5d54ae5ab3982c6be59ac1a4841f4813d9f37c25c1a52112145ca3046b0d66d552a95fcc5214eadba3890d84883f4f5c8535bf17e6929046fe712bc1de9b43a2a83e657b42915b4f47bf6cb78c6cb5910fcd7e407e7f334222294b04ba907d3a11dc2cc2cab55f2f8326c47571c01620fead91802250fd284333b5d4cf7b70ec4707be487c5ac8fc4c26d3fbda2651bd323432a127e6cf751f3918dab33ba1b6e0b4c6da756afc68115092d883d2da4596d2eb8935d565dd600cc36cfa1db063ece474defb06a4b37c633cd32d5f4a3e4b424fd016c0f5cb4009b07438a5e1411dbaa31aa4ffdb8d7dbf62ef7fdcab27ec54151b82daaef4a9dd318bc31322224ad4ecfc56034d92315b35332897fb69c5d72a8f235f2cd91009834587fc90971efc1dd98299ce1141e2dbd858bfd024283d7115b47a6fb95ceac11e609faedf387f1d662b32b900e92adc6472f304dc52615111a55a4127ebc0ddf0305b6aa767454eef741ef68d1c6f1a1dffabb4a453ebc20a3fe58804a7811bd4982a92466e15f09d6b41d846984014c9777890b50dbfc124696b8497248f85ca742531f324d576a61942b9237a16ad2ec836a87df6b47f0e83f5c41c7c82691d4bfd13cc74230e7209f2ac6099467a41c316ecfdc9d151ed456e0dc9c93693d06f9dacbd1cc9a8d1479731652eb226591f18603498d3887c5793baa725a2a4de30f8054624ee78e2f43dc3f478e3b404f43020a952a76c004364b2fb1eecf564fa7f35da03789cd666f59b2de9ece8b2256bf99ded37e593723dc99e18d498b0e9b30e2f3ede58008164e896f2d8bae39a2da4e560ba70dd3c2485f3bec7b228555a7ba30980999f6755a3b101aee07fbffbde2bf78cbefcedd8f7c38461eef5b3f1e7877278b270d35e5563589037b646d1ad4aafdb1b4881d10c67b8994e41ce43f57602af6e00837cb5d1d3c2c3d2e6fea2d99a72b5a04d21b6257e6f404012c3229aa6e1ca301536b386045cc6626536b8d6accf46f4959aff4c6dddab6ee184ef1418735d7eb155a32490c6c63db397f37c003f8540730be0bfb5eec4e42904980505cb3244f8a878607b80e02baa44782de631b5131a3ccf2b874505a42ffebdd809ad093129fb6abb01db9241aabe13efed5458b724d3e8e8f6bf6e6eea8d3dd051ae4e6ee0926cf094fea5fe79ac9e9ea182e45318881c746cc056b42031fe145f54c81423c94294b35c3c67e0d535def286d8de94050f5e4eecd4c7086d99b79e4513c977d0305ea113f162aa632274e04395582d7b179431dde440f19daa1235687d5be9f9a8da4936b9bbbef1963790fabf87e77e140fd3ed65e09ec57982c685ab7e68416e77dd5ebe5c3679542fdfe0c36aa343857566618e8d0c7ba6d71490a520ef854be68860bfa85e6ecb456723fa813019dcfda533e12d0982047997b23977ddbece260e1b3e66aeddf004b393a71de4282520ea1a909a5e59c803ae530c1f925e03d34482ad9a0fcd014dca88467d67ea1542a3270932e9e9d454b5967bf1f07e908cb4070deac514d6da0c04c7eba4f8ba50a23b84253a11a2c9c9d64bd20e61dfcc620eecd84e0ca02f84cc9a5d5791b2269c226380b628f6d76f2303eba7fe2f267fdc6c0963174772c284619c074d6ddc7412a1934ad78ab72d065b99c4db36496142c9b1329d5d35eab2b7f0019287d46d1169d27b25d94e1652c5a718042c74a285a788cd8943cdfc3c6f709e761aa919790baa74ea0a0166dcb8ae1109eacd7adeed4719d93aa68249345ee22252956ae3b3f66c93fc8454c9bf2257bb26cf0570b7e45e66280724d7d604249f6529528d928f9df5135c995e74b231dc0bd3a61fc2b33a6916c47865fb648c3fba147db1bf6c1dbf2e9ad5ac48d138e9ebdc6085016f422a580fc3c7b40dc9a59a478b0b2e73a1af5a6f66a6e5d4eeee6d0274ee63646c3461d4eb487630d8ac548fbe27d3169d35a7fd44b75907abec7422bc9a4d8792f9e87a169476c0886b2f1d4d6f53f7cd46346665e776b231afda40932ca253be112a9d06b12dae8e5e1a97541ff995ee72258fa34c93e43be5fb2773beff09c8c9f92d5da00d9f967440fa57062cdac2e1d797384090ca8584e27af02830989dff5ecc2d5d869ea6e441fa3d411f74c611bd3810719daeb5e3b0fe7ad64454ced6c47dd8df2b51006dfe2be73efe98982ccdd1c7de979d76a65b109f46abf25be04b364193ee618939aac91d9e62ae998c6358d992d41caa9f283fd7c7ba1303697859826e79f316a9031961b54ab6bac44ec3e37e94704e30e40f0011660adce54a9b5ba0eb6d4c5a57205d5aeec13cbec01e0564a3e857961948c4a0f2770579c9d35a22556ade5fbd4548e2ba50a6d21961887e9d989684931b6584f1294d11842c1748a3f539dcc0ee70a377f31046a649ae9543d98e1e43cc48a96c67e9810ca7bea34e8bf16711486eb15b11eeb10d564f5f5db3dcb9c567cf1b10738bba00be7b6eef95a74b9bbdc16a396708c975691e569ba509857dc5bcb16d3d077debb9729c61778de3ba290ecf75f54a1ed7a12cc021c5cf46298e572d0324b3a2e69f7a3fbae2d5eb677e84fd0be1f9ca985c0ab06923e876f4b866c7d6f3ed6d303d2ff4ada8cbc334aab99fc3b50cc44511e997070a656a03dcf300c44ba3598cf8a05e8524b8d963d862a193765d5dd31f019cf46cb212c74d461fbe968db73afadf475939e21535de4124a708ac1256d894e9757547d21eae544c5c9e4b22ec24d77eb6ba833159e62dd94fa38adfbc0be64a9f3db3412f2b5ef791ae945527dee9f270ace9d75e79bf6791547f7bf99da10209b78abe2f3e303a207f2319d9aa8eb4e145875d12f3b2662176ba2e098fde6d271ea892add554a22b120c973870ebd23e172101f5ba5b94fc8319d5e274f3aa4e6d1b8627bf58d99a7a92e9c25bbc4cb205bdec34cb7bc7b23ed867402b88357e897c05b3cb32d86e575cc5697f149823b7d3be5f1d09f9e085ccb283473333bc62dc1aa60bc8c9e5fb8435403d7e4524ab3d2666bd6f88713b1344638114caca9d5aa3523d579905bbbf23fb9ec9b7641f9fc0782f0f0033b978f909af937cb6d228e1ffccb42b818563749abbbd4ed1921751e37268e619a7307df07b1b3ccd1681a8bbade5e196cfc3d58ebc58ac4a77591ea8ed7fcaac7e938f4f4a70a66bcea4de706bcb0652d91e1e7148952746e09b2bb5addc5614f68fe997a4c8931f98b05c71de61b41945245cefeba7f16cd4cdbdbf8d6747811babffcc0df9f071f39c94ed59541aaa97c150a9b6742226c545c03ccf0d1c2a815298fd86fe649bdbec4fec2cde533e99fa189d177f2339f5976e92a9173ecd7cad661e839f39f5a1161e6f96eb8bf4813577ec40991a031df867b4694c2b0d27e39e2e117a114be78741922447676529ca9fcaddbcf2f4abedc26dba280a0d837c79a88aa683d4f49fd22247458062d66cacdf601c72f6abe26919fa6eb79c7fc34680f50080502bda33142fe93346cc1a17054800b5b1d1f46d60ff4c5c461efb0c5d5509710ed6a37558bbc1c84231c401619e05b373e0de0b1f4b8211c9eb2f555a5823d1c63d846e6cb3ec9d5ee0b40ab59b7ad4167b8ce0ef85390eedb5be1812ebd3d38fc4b5771e8890307beecf144e95ebeb46971b0b76d4d83fa31175719a504eb14f29a864f8de1c36ac252c50b110154768a024e71fef2c934cbd93cabe8eb509b683713fd10214405eb200a9d5801b4946c7112b4e81282325c21c88c836396c622378b0c63a3e93aea2f3d56136ad41ba2a9565fec51f505a15e137b6c853c77def8e0d7191b04e7c8f5dd8822c7bf303ff78568c896e735a2e773ecebce544b55bd19dfa05d7ee87955e9f7c932d487abedd13dddb1033fc488f64340bfa4feea3e09ea82cacb0391ec7e880ed1b2331d3c4d22f32891df3395f070f2314ed8c5af318005fb361cc15610d52b6fc392c6a9542f2e968010d3c49664b16cc97edb36a903fe6d5bd9360cbc94a98cfae9e695947f4361a87b4b4a8d9c1b7ca2efdde84c7ac9aa281a34f2b3aa78bb9d72e8272f562c</script>\n  <div class=\"hbe hbe-content\">\n    <div class=\"hbe hbe-input hbe-input-default\">\n      <input class=\"hbe hbe-input-field hbe-input-field-default\" type=\"password\" id=\"hbePass\">\n      <label class=\"hbe hbe-input-label hbe-input-label-default\" for=\"hbePass\">\n        <span class=\"hbe hbe-input-label-content hbe-input-label-content-default\">你好, 请输入密码。</span>\n      </label>\n    </div>\n  </div>\n</div>\n<script data-pjax src=\"/lib/hbe.js\"></script><link href=\"/css/hbe.style.css\" rel=\"stylesheet\" type=\"text/css\">","content_text":"83e4f756d680019cc75bb3d7e0230dd0b412a416fdea7528d7e9580f6601b2f16c3b74a5d9a5a1da5dd61984e78f0c846a143ecfd5bba379448319807926070c9261aa0fe10bb6f9896ce6f30c9802b7817ce47b5373bb66b6065433067a6176900f891b25ad8f0512f52d29ee75cd3ca8a32a796d253fa17c333d3f711ccbe24f46b73c4094a1d22189cb0a8a140cbd5a088bdb5087c3152c50047f9ab29a03520922ed1473037268b711b17e5d1379d53a4bb76ca4a83340902391de7e7ec1f38c9c8e03327ae25b45f0257dbcf824e46957a2eacb1e308b8fa8472f1b83a8bcc9a8160e981abcb3d1ba30e909ba4fba3980a0c31df7579dc87d797917337ca479a51c09ace72470072c706db76b4621711ab30673bc24149caeac1aa693d644b7692e450c13b7001eac4bd41390809513a1655a130eb440b409ae493deab0672f6807dc5a972d68746e21fe07cad0015a48f47ba88ec7783c353f9d7d333c2dcea3bc8c97a40e5466f0a5aa369c1e3847c1a7a69dda3164b71f49973f30e36e190eb60a806d1c5ea611ddf61e90662860e9f69ad3b89eacb54e7593f925c888789630a77e54c1b76f26163e3e3f286c79d0ca49c845af705deecbed52de6bf77e11dba37461f4adec200886d8ccef97801bc21c2a184a11526e81658baa8482b417f6e2b2a7f1680f18a8b9d54a093e8a2a95523879bef658d040be5ac1b76fb4fab5fdac9bc549ed8d3a97c7514aac148d18eefd093f4c3be32cdde36dba49d50f182a5b9524754252a35b87e69c29f4c208b23d956794403aa7b64cc0294ce7ad147246f8b73ff2dead1a9ffb42fbe28225d4a092417d2f75c5d79b4ba74073d830f27fe86a8af8fc7b103bedc7d2d67c8f230d835305c9e4f385b2324c1b388e6f5f7ebe30ec698ed566bdc70e14d7c15e432cf84a057c5b167716edc065a35e1ba6a88b261d46acbf43aa81fb3c227ce0044c8dc715c806896104f94ae9d7cd42cd3255e2991c71b2cd4bae2591f4f0ed84a8e4750db164e394cc3b7948d8a4c8d5c1482171a5f38e12a56ef416afd326766f9920c368e7c20eea2a32bf02abcd83d9ef84007aa4d1c55a2657162ebb7ccc3509097b914ed6e9ba8fbad114b1834e67e4b4715f3b3e236232e31f145f6e4414913ed297a8a39f9cbcca2f939cf65932b7b3d525cb4677b7d58b608cbb03846ffffec4adb7b2151b88fea005c51e53c05db1b28266b75fe1b55d306638ee6818854adfc4a3f3eab850b5d2d569bcb69a57e2cb29338f7a7d6560cdc9e5cff4422a9f8c1cfc95df0db54304d49d4869e9518a177d495750e7a6424377cbdb9477521c0fec9ffa354e4f9566351fbc722d6249a74c46b541d6f4593cc1e6635bef88ba48de4c2e85a6bf9a8bb0fd9da4857f21e0218c15075c660830c4a044a01a2ad7cf7d2e4a87bc789b2f2454e80e0ed72aef3c3d19070f04218df44f4ca11a083c5e8fd548aaafbaf7ae70fc62e5c618363bb3082e9ac6e760243f257c2f0b0224cf15fe312603c0fa81d9f79e0033e79ea9fad0b9afff0fbee56de193caad1e9077460bcb21198bb326cfa754a4ccfdc138b375e3c70541957e5665d33766672e9cb72a3a8b8b9fe494d87a3cfd26881cd0b17818658e4c423701313db70d8766210287dc8465108f2c9996d1ef6c948ab9890c2bcb7c2d370da76ffbf27d611e2d12119023f14129d5f52e32fe7d7e2fe7a7878b31481093f0d68df50f68473042d5164699288d3a99d9985c5e0fbec11fd12a8e849a4c130779ff1c8667ebbc5a5416a23138ed901c5aef969d2798e80a34be011ea61b6b32e12f555fea75e71d0ec86b1d7d977b91c05faf66f2b9622985b9c7033f056ce6f28efbb275366c907cef920bc76b8adea8d4897d239d1177f2a5777b869048df2bba775fa572876eedf15fb74336d78799cd348540161c1c6b9b51c0886f2f6583ff2201756cfbd31077e0bfdbfa99ef0eb03dcb95f4c74f262a7e7b35779b1dca6f33b226358a5e715b517b9cc38b5d2a36815ee4542721700adde7c8eab9a4d30537af69b546d3c5ce92394399078d427add8bc1e1a1908f8305e39af128d05fcc6ddbd68bdfb892247d5df0a44d4a6108043fc6c681bba47a32e06f83df57c5b819c1ec835c17b0f90d6fb79d8b814c259b04790af6f9977089df3d176d77fc6606645d0e44f548f960ffa525970ef2805c2acf0c8efb399496f5f89fe1a2bdfb662ee3419fa84068d5dbec5a1193a9e8e9d3d8d4ba7665c3022eb51ac47b36caba1d3210cacba2ed2b0945e2816d035059436669f16c2f7cadd506ea0df0cececc9055d0e1f2b8470e34f698b3d2bd4db05ea2917fac43cf17c1f6428e510f05315fc65b597cab7e38bae06e1ba921ef674766ca6f38444fe5fc7103d95a4cf062fe2c3d1dd95aecfc2b7368e7e52b9be97ac904f4d8c0b45232ae0723e025405e2ec097a520fff8ec9b16df1b5417af0c04ad80f94a2251d2a0cd7b967617012a2c7b933326d3da1a412bded92eb4276709bccde039d17b30f30dc8708887ce853317cd94ca8009895aec314d8e1931e12cb7b02c932d340a5a287a937e77cc8a5ba9ec42bcdb4bb06f8b11b1d639316f6633bbb73e33509224cc4cf45d23516c85a596472fd74e6fb5395447de3efdef0fa22f8a03cc98d00c484c38ed4b17e6d5f2e6fe4f5b28b4bd262b32b898142f334067c2c6100efd2a9853ddaeb8da57c3b4082bcdd43980c80dce47dca13a6b95c78a9166f58fdd06b87e32da3a446a82187a1ceb02bd33f301e6e79e50b0369bb11474c495ea918a72c6a2f02f08b048d4c79ce13cf3d2a929ad0ad5883dcf90589cde533ffa661911264871615a4718915c8d55e9a788d8c2f2b37e397432bb1ca1916cfb090467d0a6eeb599ae64dea23fd7be4586de260d7b192caf1f4cf616cbb011505511666d41b7708385c0744ca24bcfe4e3582d7fece5477dab9d1c44c13d636709e0408887c015dac4ff9273ba3c036b3ab21c6f48616687f5b5c16bf591ab9777e8c7df0dd2312ea1ceabdf6a882cb0117d5fb9a755ccbb6af6b0f5fbe2be4722941ef45b3ff8c97ba41a461a6cc43ab0c7ce6199f609916f011ad578151fc2d4d4618f4cc757d4e64eabef988751533230c2a0b2acc02976bc44e024262fb6c47b7caa6e41a7d8d70c1915294e812de686d1dbd6ab1cdec33074f6723f0c0314a30bd32c7f16439c83698e6f9597502175ef94b70adf333a6f2e4159544817491bf1127f5496388146b2e140fd985275fd51009c978cef40d26433056c4297fb1ec60f8fe4cd5adc1f10a9b6fc399f88848d750d5e99aec28098ccd6e8165f0bde1fb696037983e0c7273f9b0208e3c475246ebfbd8b180188571f8955d8354ebe9b9194b1a464d0e9aa3f79351b0e43d999d177d405bd06ed0c18105ca47e45d99ef37f08b148d22d759d3bd788653378ba13c0e95c0b62be9a186dcca2ea0c1568c6c8f7702ffdc418e49f8db4d735b21a1130070be77cece59ef062d0c0600fc025844af47c3df490dad2f6e294c183f90eaff1044aeb7650c77f4b5df32f1d42df423d37a8577389533871696a979dbe82f6da2f6457eee520fe3c6099af6962d09c336263549996014371a198b5bee064f62a2730107f8fa0713191089708185ff8dfc042fc4d2f1f0950a52a2a50378d23dc0ce796fc948163b45b90dacc65e1af213c96b035c3167087ca1c6231a0afcb8b29b39c643e743e6244eba9a3e132bf5456ccbb3d50cd189493c272481e9b7212ab584e9955808dd7b1ec04736b3d22269a1f18bc2c5aa88fe82fa8ed1596b76ef9a120ea42aeb75a7378a4a92be23c43b6cbe8b834a7f8dee2c3f8a9358ad2e6f61d3eb90803fe805c788972a7b94e44b6292b916a033b7cbf1f53faf11c3593b24386b7efb2e70a4a714ae6ddf2b43c85060ec3e278beb6e21c7f5a74e95633f17a43f1d6989df134ada771ec412ea515726a0100ad9eb063f1f10e8bc46a0d9daf54eab5fa0f6def477372004bd05917fedb5e13b9d647f077a4acf9d4a7858be837cec1cbe91edb9e92444441592f5fe376acd9b869d6c2f83a3f2dec87fd4c0d13e80be7f0486ae445f1952e0979d5b01c77d7a17cee95b55d7a672d98bc220c09eb15151eb14c48727513d86696434cf52cd21bbee9c8bc7c3b28d4cb6da476033c76a2c4affd2d1cacd0e7098805f1d3b1b0ec68afc07b9c3e2e5e82687d2b89bb91d9ed1c838df3e87e4ef81c18f45223725e9311677fa51da359ca79e6bc9c04f4504cd92b4370da653e8eb57f6971b56ee392464447c3a260671382f8ed4df8535fd12661c64bda592736b26a3e1a0bc49e572f59347093e901c8e7110cd6570b26255877248eb640c8ad0675fcd8a0621625534c8d003b68961cf99684d50a2c6489a2b21f47cd103b094a9f97c185702a433c9a0cec53da4a55d9d0b8ecaf39f54ea0cafeaa13686491ad4ab151305b4efc591cdc019bc214fc800d49fcc189c17504b70374af6da9d0a504ea682641c19d49ca1aa9a460877c9ed8726f8105674909a0527aadd78434365ab25110818301370ba2ba45f5a0723db2c6b132793a4aa3d0a949e54ebedd64108f09eb394ee067e96392725ddb27d5611e2dcd5789f3e9703571127e2a90471ac99575482370d331a12a002624274cdc5ecad9fdea33835fe046cecb506e448ef1e7abf210c657a1815607c3ec407f7246335d6d3fbba2955599ba4e746cf3c41a2457867dd9e16dbeea37fac9692ea10f9c6bb7b358b1ba3e32613e40c84435f72b842483651de92912f130aa0c4e200d36832966b35826b4d5d57d7058868a28c238504b9f4b094200a37e13745ea5b5340a991eb81f19c561a0a7f866e3602559cad62980513c971b3e869d7a74169720784492e0cba34ef2c18f94a5affd7edada73260f152c265891fb8baf32af5dd7df654b417dc2d529dd15a761f17650daa4442b5e4d47de58420e9a93eb19044046c30b2d18fe53a0861a5651f1869e0c2da7d6251d2cf5c36db109030f58dd85e8e599c2d64d454c13b1afd36330477c06e2fb7c78d1a4dc79a9da5061877fb26115ea57e8cfd205567d671129d611e45872b1871f53bb02dc247db16600196770805b27cba03b52499f12149f0126f5dc8768d221292cb5ee54cc64a404c6f29cb75e492262461080699f81511db7373013ceb50a889b2b562a93a92c8e58c557a10fdb8693d0650dc0fa709bc40cc8b153389cf9b03be70a38e472e8b240aa7b702d23a8ebca67c1b1e7f3fd68412ee830be97a5a907a2bba83d046b382bb5992728d7ff26f7375e4d8bff2a8e6deeacce6a8198ca6c848d4ace26b1485c58ef24026a4509fd249b2cbc4aa27b3c93d105421f27950694d88c9e2cddcd05f81e6ae6841c72384f1514b5c25f078e5c5ce04f1cff56c9e3b6dcfba82e808b4f5806776d164f9e2fb010a432fea1628f5c97ba5904d4413daa6441788721ad4007beab15f737a744cb88f5997480874ca1b05f7967be087e7ec6808bfeab49f5c3d71891998f5c8dea894a42c0489c68c6f3ca98138b8b9f98e7557afce6467f4d4d8cdd0a5eb5d8f117d584a24617229df28e3f16eb66cf49963848d2880f45b49d5d350fd760d4cec67ff4a088b227e9ebecac02fa320a0afa4e3a0988bca281f2f03074bcce4fc4d350e8643c8ecfba2bd865202f0c86be0e17af1d9e60c4a4b7e447433f5b9d6948ee2a2ff59ef8e84a1134180147b729e1e61ecfd447cfdce47fbe1492842d5dc8e83658cf7c571be24bcb6c92babdebf1f63ad7bc27b31f74b9be9ea8282473005b108c0ac1c17cf39f09549026e95cbaa1f6c6b6f0a83454ef7a4bfd11d78265c2999a87da4f4a767e924f45088151f4e1390008772b5eb276d8a81e9d3d4f9b0473d9a0dd0360bfcebc88f9a188482c4af91fed3afcbac4e1418cfb789a2a60787c5e4d3502b954177b27e7b7fecb6223a7cc4fe8938ae8b7013608958007f90d8f46cc6043ec5fd858bfb73a28171d4961eaeaca58396b13bb7b2a688e9cc08add58aa6b1dbe047a1cab4c38bdb958745cf2a65720b9be8f9b28cab5b96072250715b8b342521080248a0f039cc4c9541d4dc8f0f443de04b8ee7fd4176d66c2d17f994bf8e12f9d00ddcf3bbdf3145055dd1fc30ee6e98698191113062dba86f69dc79f62a82b6c59628fd366a2248f4e54deeb4a0bfc71bcec3a3f642f055037f5c7f3c40d9631b9ad2be012cd237db180f9b600c204da4d14ccdf4cd0500423612d10af7113767f715e4192b129023f9018c413d544aaa1dba3ac5531e92a7d0866b940bb1dd90c73a83286f523d7adb00078a86c220a06504293d6130e132a73c407a85bc876e9e0899e7528def25fad550ff8e0eab28c67b523053e266bede4225506df9c067e2887b181d7270450a034c6bcc868bd64ed6981d05b080dd7fd0bb56606beb32b9720e6876418d32a1baf644b50dd614550d817da2c1ceffafd5a200614319f89e63087026973f96b9e349adfc5e199bbb1decc4548f682a569cd4d4a1bc05972308ac266780abcd60104b47e979449e0655f7b647f4094397ed331f09e7aadcf098c39f5ccab6b8d5217c01c41cf9c3586eeba06bfd56da4372ddcf24e40e7db37914b11538cc98467bbe9520cd2488b58b37081a9648240c89ed5b877d9d7349e27fc34426e81e8c1ea3d4caf366eb007fb3fa5493c2b925ecd2432def49d786488e168c9fa338df4062f4786d94ca557576f0f9a57eaae6551ff0d462e98bd941d030ecb39a8fca3a6b13ad5b0a0bec37b24bf357e5a7c3619f67ef2374ec4e52c22c87c9c9ebc59a51d83a984697c4b2eacdb60ca6d607f4bdf38924530af472af5bd70540b621a7549c25bbce59d68f578c3dcd7ab48b7869cbf90af82abd872f125766ff1d77c97f3f2c2f527fa1fa753380aacaa772637539d816f865cb077bc2475bad216b0ed2b995b2fe44898ac4ed0bb7f03daa13a00e58459b557a1e149eab1d5b309340250ab8130d37df6b6d6872003eca48af9b575b22e1cf71332323d6d03715d117ae7eb58c74ecc8fc22a3c914255fd989e9574a1f7d9fad2248c193ef76c6c089b355f5915d1ad77025a75b27642a7676740d6ac5ec2ea4c64c35f714662c011af6eccea4ddc1f5d3f2fecd2a5795f27ffb00427c04ee39f43294330794d1776ac0c9fa117ba715fe0cb9542c3717fc1fe0a47858e6123d5dd11ea0f5b9df49d9b0ba525effd312a76d53835ba7ed0fe5c5b1e00b2061d5bf0004301a05e656c2d6ca674d09177794231d0d7fdb0bcd85e91d6207d2a3ace2337e860a27a574716c0c8f9fadd29e47e5fe3f736774e52b05d74faf7c16908719e70b7a91d365dc3749d5a0f7db55111d7f251a1dc58483b3dabf303d0221420f4e1607a932c5f23aeed2deec0d08132599b9e0338e5af42c2e7b1d8c52ac7cd97af6435a79e03b3de491373414bdcd2aec150a7f4fcb64a9981b33beb4c3cd82937cb42695303dabdf7e67dfb21fe3933e55850d8abac45c848fe1b82ccb4fa3094c1dd6b64f8b45543a6d10aece06e6b4532f745d8c087fcd5bb4ad80595d8f141e48e258b9421fadc10efadd6d591834faa512aa1f4a28fabc815726a78bc11a335392167e7835e90ba31be8d24faf62f7bcd5b36719185688cc018df06ac1648e3da0b1e199e7b3d05fad19d43e8b5c357a58811b6a139bd9c57d75d4a2ab2f8b78d2d2d0ccad9c9e77e2038e624e30a65e3f6f6f8f5db634307bb10420a54b45b10f6cea93b6e0a86bb299773134acbee4cdfd1dbf38771b48998e4de034cb04989413a146f5e7ada894b6af0d222545c2e9819e3005df0bb747507aa7c22e78de030c3697334087140ea232cd356ed932590f0ad7312312f705a74ebda359f4f764b7232c38e30e09c82336e274a702b094547d12e382fc20c19731442a9c1a9cb41c63e0ef92de3ca7fba1b43f3a8b1e31ca8931ae64620851c35bf37a3480d241d20ac72c30bc9440aaf57a49785cf53b25199148adee7d4ccf4948095730e536b0a513e7997ea8837079b12e19186da916f3d1d6211593109a5b56acedc7e226d7fb47852d563c64fbbc7820e1e960899d88ef26d15c7453e561cec1bf6ff3d9479f077ae48218c27275bf427353fa573ae605bdc09b863a6f2dbe8eb5875920bb2b463f792e70574773291a337f08208a277f785b9ceb6f608e6d46ba6e12f2b21db3bc942fdd22c1dadfc791d84dcb6b131c3e5a636bd5609b4dbe273122b6b9f38b3d0b966ed9c91c61ac382232fa8281ff5ac6d21ddaf14fc87b035d46e32a07835ac596f18e6e1d9a668e7106ab8d95fe2da5d39265979cf69bd489d909b9b3ab8655b5718250152442afa1ec1cc30a4693ad42a0dae730ab80c8409ae874a3f5b4db669af910aa16813b52082738b58b5b295187117f4a3e56dd2df22b5b9f93d8863c6b6fcdad86b9f07cab9166e135fa8ec6921f9d4d75a25669788be15685856922a23a3d0866462ae3c2280190c7a808c37ef5274bbbec3f07373a7939f2e41c43e9d945e8b1af0bea44c1686e8f3c23e91ffd74b3b5b13da19316ebd7e66fd3c07af8e004c322483ea255ceb0187bc9b315257a9199c3e7fda912e0586371bc3860631ba9941baa661af6e50852b6309a594fdce3ae841315677cfdfc9ad1ae31c7955d61181250f49dace9b6e3d3c0afd2089fd4bc52cab4a58e7836a739ca94db38eedc4fd29905d7a500cc7fcefbdc41c9b81afd6d059c7dabfb0072271ec5064d3beca44130683f177b4eea21affee070f7f403a922cfea1ded829a4bb5441c62d2db379893b49de5fb0184b02c4423eafe191688a98f2c779de3dd837d82502f13a8e64de0a7a5eef43968fb159725a0c1ab09a476beb9301418339efb37b6ebe14a51b5dab9a8125a43cf65d40368c3f7c1fd0836374335f0ff8a8689c6f0539eb81ab3b065c55479f5d06a6e77afbaab492ce92cc1f665f877b107593b86d62b65e907ef713d87bd2a70b5b359ee64d63aa30766bae5426fad34b9dcbe1e79f8a41cdf196d72780222fcaa0ff7aba0f81913bee6cb76e5e01cca5debde86fc56afe1ce4d95d7f270aebb84363a6a1cd45f3b080fb93f4f450ba2c1f715da85f30851ef081f9563618bc2e9cda086e97de22af71d46c3c2b36b847db2960d203eef8cd0967f34290eb82a674087194af529f11a7b7ac6bd0fd2af141f84fd2bcd1c7bcfcb0f40125338f9780461a7b16e94a1512860cbc08afec8e7fafeab6bc4faf9c16b464c201c17dc7872d5aa978ed419652af9d34ab02de9cf176c373512feed354f67b77db70d773968093a4af0f68af63b5b19f23a074e9393353db77c765c7d6553ba8167375c28ac01e2fc624c6a6f78ffa0a2669e6254e0887636f651d720458673737a211751ec9de5396f7d456700923b416531cfd0d6f5790d8f98327623258f1cd0549b938b279f858d5f2707c1c65355dd2536e0dbea567702adee9b682ceec6e9e3c8120fe056e507058c0ce42d64b4cee770c51ecdda400be9fda9e31eee45b18fbef74eb9a0fd88fc839777a380a87d410f0060e63a4e2a4c8b54fdd2058b3b26792889059efb14c30e06f084b8851f70d0ca15f6b473484be7dc97658ccbda61d79b9420bebf7138264c9340613076a53db1fce850be3290608737453515c97b330c8fbb36e15662c367e17f7933c0a81edc5b425d7f6a8e3aca59f27513ec4436a15f2fafc58c3ecfdf830e0af6e43d1cf35d5ddd4d407f5d06c158513b55e245729a370560a7c0b4445c1bf90a84549e64be1cde78b94fd56062175ba361e85ebe123cc6765423f1226ed3a0dd57912e2543fe9396afe87ac9cc2cf9e8d17866e17a6127774903adced156e5d41a589dd8bf6383d09ecb18f8dcd0b94bc0866847bb8a197b260672c4ea876aa710008c2cd977e1d572d44ceeb447ac4b1fa661cc42fa428a7a0869780bd2903407998ef811f2f2ece07bf0f39957cb357a74701b63a2fbe8ce893cce9cf7d55d614e499df2b40993e45dca9c2b8c88880e158ba10327c29960e84351c79706ab46f935363779b4860e9e17c31a7d9d0d90f9ab6d8b5912937d79df9d30e86b75a21a6b02f65b7abc73aeb677496b48407889c4d5e9aae03bf768e53eca887d68298e38be2dd3c4754d3c2a16b9ba6bd7f9ea7d48a5697f3a3d04f6c9c63956fc299b7ac1b91ee2ec6e468d5cf3c2403d8876a4e203a57a7c1dda47c155c67a005b360193191a09568694d3fbaea37aaf0958df08bf64860136697e71d9e18a3828d1ac5a9302c84ddf2efc26fdcf43ccd7fc6a8e819e1be5e116e57992f51e8a19dcbcb5f9b32af2530a569987c381f167fdf7d5d83b3dd79227fa28191f5f18c1e7dbaee14046e15d554c6404f462f97ea27d8e74db8c74a7213c3aa8c83b39d439b912a72a23370985e61ec1ab7889d4b423dfab10d85446443e52cae25e847fa04a5471222c39b9c99deb8e9098e1c45cf616f2f37b71a355b6dd90f18c6c674e7907270eff3cd6743b4eface4d6d144036d92fded596d9e0349521dc7b7a183d900f38020cff0721aeec89496db3ffb9a06fd19cf914c7211e6871b11724da1fb4f011c71a3ca4f9dc436247f3c8f2abb9761d7fa9f0e21bc70a1c2066d706023ef05c8011be79aa96c57e1a8266ae6af63f49b767577e2c84ae411631418a6e9d37f6f990b0215e9d620a5d8e140432a87ce10345fc2c346d89e4e6a6ab7016a41f2c0c62c7d49c5a824b782f908d657caaaba666c37afd191e1a7f04614d148f5b58e0d0faf80a6dcf54ccc055a83edde6b1742b73cfc11ce03ca9915115817bf7a3e8a40876c238543f2a565ce0d0207136793d40e5f2f49b007c660863ab1d8dad4536b639893960394dae0807c69ae0fbe4fad017011afada4bef9a02c313cc64fb72381dfdf56a179020d9f50b3ca84ba67df3dbd78f18736841e865099414b8195fc96d49f4533cd980f1ccb988db4a756ceea73b7bbd34e954d2c972e7007806ef8c51cac661a6c103c1af1601ea0a618e907b03e860ee128386a2c9e3de28eb0c8a5f83aeebb3384a1b490244de06e9982f68d49a670f28ebd9b90a83124557dca7ba0fe8c2eb0bc3244b3e226c59dc53e47598033a069c4d0ce5d6a67885c846e9e6d9a2366ee1debf56ac18f2b021fb1ac2cc38e4314397ef94b62db062cb351478a68eeb919fa693833b67bcb4b493cf2dd70f1108fcd085e3ccdf03e7a6b675ab2a87efb9b7060ed075736519178221a5b77628475145e3648e7745ffe851cde8e7a673d29d9da1b008f812aec466c277d0cfe84e40482930d6a98104fa4d0c43bec44a30905249f6665ff4e9ffc7d42f62a54e980503ab58bd3c6e5c8e48789a284aa5866f5081f7a691666472bdfadff762bc438bc264c1ba87f3f77eb7c6e40b4f253f209aba60853ecd282bb0e11659e97c94762bcecbad4cdbe109c98f94e0b513b219ab6452debdf2c2c8c616510e26201fa7b5aa1c6c314f5bfcb94592874e459d3090b9bba218cbbc14cb838c8b77f9f82cc31a1ec04a81c9c0fdb4506626b881ba41fa49d64cb153f134348b540f325a83970cda65c23a50625c3a4b3240009cf98c35d8312523a13773d3f5a7f9e18394e8d95c34fe0242e18bafe5eddb3980dda2c1431aeb723d0c1f23a2000b21f34dcb011d9fa98fcf4510c92e30eb6c9e6cd54f87fcb9db701675a63ea85259471d916c95b8c192bb557bd25031470b3643c9a641cf811ec107a70681bece5241a8b0f5af653e2d6e7b92ec1853c75e374f8d1bb0aeb6ebd50cd509c08bdd9a726a270a6dff8a62d20da4f30ee99b603ea61fbb20d29c86716b1984f4899d05d298cd9f4ee112f8e4886c4bf6a69d7b5c6e2dbc117a55e9829fdd26b4e0221a13973943753f21527f1921a1ceb21d6af250eaf15953dd476aae1b2ece7cc13c0ff7ba4dca881ccaa23da7a41e27bc93e393434027ce80161a13e078f37808e40bce1a109e9ce917d70aedcd53627ed8ee82f52c2b2cdd98b9365cabc3024a0c3421ee2d1579ba6197e86e75f28e062ee9cf8eadb4864b2719a3ecef17980932f4ceee6e3a6e790e4f9612fcb42cc6a6a68162dd45bbb519f679296d048f7d08ac9352057e2785a2e27b4ec93c94529ca4cae5fa7e3915085178518aec6dd41b300632d1957c6196c5b8212fa56574a8fe5a2ca368bbf4eb4e8177c1f8c7802dc1c9ca2f9b7c9886c7096c8e711a47a2f7a540d07bef5f50b8501c90151585768c2ad93fdc5cea6ac5c77f62aaa19d482ef30195b886a7ee250829e5267ad3364049cb2e5f1f3a3202b1346cbbc1f8db91dc32b48bde1c7b11f861e5638bd40524b3fe22fbc55a66f0cd7cc22723afb0bc1349b3db841cde1cb690853aafcbb40ba808aa702256f1b0e7fce819b81d131dad3b3bab407524bd2b633a8e3735e4f44860062e6aa2d6aade53ac7bc7ba4d895251c29e78242e864374f52f42545c50247613df699153c93853fa57147315928de8fbe1c99087abb7cbe53a9e36a97186c6ea4699cb3fd9bc6c52282f5530eb184080f5bb4f7d5354fa9a47c7d54e17d688599db82452b6c789c74910fae4606e786a38c9bb3d0ade354a6ddcc266d4062b37e5b8aae84740a22f376a7f8cf5b7646b9f3ee26ef1b098ecd3fa9ac490e541e693d2d7617f5c02341bb0bf89eddb40654ec5f52f75ab5aa59769e5fb19ffcd8105f94128f6e5ffc47af16e8dea23af508af39bce6378a5636dc8f24ad605a10b49643bb4dcf8e2b0af6d89d6685f2b76c75bca386508bc34017fcb7bf716e24ede973648f640d58521306a74d692e56623743fa6be8b3a813ec8a27595e84d439097d222b2dcd25eae774142c63f20434c1c144a5ae50dd3de78210d8f93c9f683319540651a4d3aaeec0b58f33d654591a225998fd3ac9ae351d4c77d988d4fab3ae65519772276fac0c0feb30b8b803b9fd05e46fde7243359161a64ca37299f378758d0299902e5aa46e8844e9f560a1efe78d029156f3ba12f69768be65ecd70fe43cd65129f6b959041105bbf4d63ee629b76c7c2a969414da9c197fa784c4e2d15a52bddd770656aedfe05f5e1f19e827b9b4d2f2c9ccf894d130883e0825b8f29693e881d43d87bb4553d1efec8c999b7db47433459b12a200bb7762a827a39efd58a34082f1e1a557282ae396a59c5b8538eaa8493587f8c43ab2f1fc3eae1ef40bafae86db6e67d9dee80136939498279df04f159fea75edaabc35edaa0261b0a5457a556e9e3e54f20f9df865009a3328895a0a0131c390dd6f04b081ca4e5cb573312a7c4ca19ca66a9ed0c8beda8cc531cc31929174b78bd3e38915a15ae004a55b773982b951c4bfb0ff2a3e53bf79cbf3967aff96aff49a72f9f5e25963f13afa9a40a831c9eaf3803cea9cd8c70d75970053e6f48f01adeafd933723989887c37a797d545f735de66aeb8fd83875b90ff86a28282da097553771bc5160a4f2e37439519354a7e809ed0e6e49ce18770303eea15dc12660cc1a7e8869cbeb107308e62f4391c2e384d8e1dd8129dc27ff0f9c0dc77a5ea24a5c1bbb73e70b868accc9765721a3f887ccc5f98744e1cb77d229f54ccd744abc8feeda1ace44376d042dfa16d5a4f05b951b9e3f4230a882c30c854abc4aff245116b1ea275a06b464c4c6be4f0fb1c37f82929154466674fce1bca834c7e155e00ed12bd58c86ccd9b7b3ce387d098b40ad28c803523f821305fe2a72669fa655b022eb83647d21a34180951bd720e8650dd183ee566cede11d32066e76e059747641b1dadcbc546a85fe47edd05253ba1e5b40504a285a19489d127074e6dbad100e4968bf2d72f74778f6776266f8d1383398a70c668656e0d914ad81fa6ec948c1758d3cc00e82b9e88d720bff89624ce24bb6e7de3727ccc8f612352afa1c42c142bdf6ed82b5e068b625b2bab3b9c6965da9a027ddfae4cf21f7d18dd9f815cb5792a6c66b6e3ae7b2a443e70031bb8f8d50966ce115d3679057bcac49d67e6acff6e37d37bcbde2a47307f37ab6f6eb3587615f9751cdeba992cf5b9a800b5fd37153f00f24a0e35a28694dfc485a07c28782930151f5aa9613729727ef38f16cdee9f85caead51c74914f36af66d0afaf93b6083bde53494b2377a9e15d318128332337a220101ca35499346c060b55678538b14a0f9ec06f78a3baaad7b42d9aef3cdec9b2463fb863ff4be5b4b315f5657db63cec36abe89031ed941c9d3fadaa7123e4437533727b5f95ae584957204aedaf4063520eab7e5e00c493f21479c57757a469140ed7fb10a76e62823951346f0597fcb1d487a028af57d7b81ebffceb5f1566374438c7379e4292c9c599385b8ac33df6ede72c8a0b347a22b409cd82ac41d342a41a458cc080ccb43e418cdb6fc660112c08dc2b51fe42520462fe9eb227b968a98060c4039433ee3b98d5d1710904614192d11fa93a3dbe957d1823870196a95504ef89910f816ae2414902c95f68f006a53ac02ffcdc40a01ce734636ee017f26a334ade26b857c03f65f804fad059e85af6ec4c84fc5efdd2f0d7cdb710be4cb0d371b25420f9af3e11aeeba1a52a2701126367f04050a9fc6719e313d30f8318c670567f9fd7dc626473937ff104f7ded1b0e88d23653e54d690342f3430bf2194149f7f7fb408e82e88ccbb925a28a33a136501a5568d244dc7b05ce3ab4161f00201081e327d5355f20e044fbbd264a1e7a8a4640037dbd93d38f23dacf17e7276e0c49d3f9f00cc27b3476e753540d57c983bc249691098858a921be420cdf17235f1c62604b269fa2b954b9b8a5c284b92c146470e3e727c8fe9eba346e5c545e6ebeb8a9b73d2acda344afc5cb1670f588fb370b729fcc1d4db71273b5462e1d2e53488c29c3ca33d3b623c68349b00368879f20555f56ab156e061386e9ae9214a8d09c7a58ff44280ded6f5e201484a1294cf4a0ecbff2de368a07ae676fce329ec5e76a9007f5e0bbc2098460f44706811689440ed4e96f2f3ef037ed529007ccbc9b4c125622141e507bcd7a2144d0fbd470b490ebe8b814ce42e0196cc9ffb424e1f735f22d6d998cac78ec7f28827eb6ee8921ecb96219ce8237ae88222f18ac49eee42e1881e538150adf237fa857ffce0db4954a33358e05ef3c079a388363d1e5dde5a4f49dd8083d883c63e3ba4df621d99340e4c7c55b935ffc074e10af038538d2832d5acc4266ba3ffecf92efb9f323712303500e6f190f0485ebe9b8c42f8d08bb01badc9698824849e89adcf6be6e9c850f8773743264706c4f1fb08891425bd61cdd38ab4268def881bb3908bfaaff8e90835866c27dac01a17a7bbf7630341c6215b5161b528b714939aadc142d0ce447437f93bab060b5725c63fdd114714bf7f9b0359df9ce6da37e5adadae28a47f6cd329f20369a65558d59333574482d3adadace9a6b52d5ad8d001c63eec9c99b08cb6b1c404ce1bce74b22af6953e15cb047b876aaaa8994dccebd5cf499df0719a8e2ed02c5f7ef5dce8d6ef29adfb2923fb1ce1b45a1e23956f5f34d48977fb9c56c41a4843c6486e84723bdc70f54ff53ea19c4783ec91dd6888143a5b15c032df676bbf89730f9b212deebe18bc99330900a53fee8bd9ce710e7472c05088cf276bcbec4579eff85b593ce99e9662774285faf58e345e1b4cf2c8c8b40bad5818f680c5b3dedbb85ef95149c16d510939636e5dc427e860a4b4c39853c2ee3bb02d3613a8d798d9d49b4f916c61ccb18e5f9c5712ac6c337f930595e122cc8874ec1c2a7354bedb00ebac8d5891ed93ee712a8c0ae37f8053485bfdec670e4dab9b38084dad3d307947c25f20f741dc25346b5200ac9f11726582cc6110ffef7374e746f2935322e7af52e1e9354686df437cea69de032e928ce90f3cf3e3e1d3a376938f4b8a734d8c7e9efb2a7cc90fe4206ad6e69a6ba78c3e672a1497e32ffc568ada0526bbb89850d78ccc9f9111d692d8c75d8c69ad727a90ea07fc40d222129c88aadefa7c1f54acf6304176bc4d80bb3c9f0e71906023ff99164211a0f4bf690670462982470406fe96fae01cc694a029dd2846e7b51904981321d274f48250df604143f1169d7c34b5eb29d3438c20c8b39d43f2ef0b4c7e1c6a4e89db0486136b36ab331786f583575e1f0a53529f96a56a2afe3169e2855e4bee803d91c4253b36545f93c90f0e31a04288397f52a715387f36d2d81bcbe68c22b44f2817337e3eaf33fe7bce0c38135c2afdb0503f0210ed816b5563a8f57a24230ecf056bfd3f77246545bf345a095362842b92ca4a74eb83a5be6a8bda234543db9437374ee89a7307a26dd0abea9ca843e5c9fe583eded697bd2c27fea0f3c66d2e3f44b9b06ee57582f78e49dddce5fa1cdeb0a666c9493d5c611a6eb9db25ae15493dddd94b2b7dfa882ffa1b0433097f63cd1a4f730b9012f513c5540395ce5c1d3d444ec4c99406f742c473ad5021b93e1ae4563a73435d29c9451a4343fc23eb9f8114308f801ab381f23a09becac138fdf62542805937cc96e42296b687eb1648ed14bb448c4cfae75f26ec68df2b082dd94d7e4903038847db3624c94acc04afdfcffac72e11899a9955996668de0e2bc1ee245aa71ca456a551631556fed5178769e197b6595a3366cb1233008cd749c24dd6cf32ad21bce39135c30b2f30c151a5be330f8ffec0e0c8da777ff492ca811f93f5381d447493433262591144393e0bf9b9647b4f1fa8ebc428d55d1ec7e54236c3e51f65baba4776df6f7d48d7c261290c78ebb558ab65f6ab7b46b5fe786578722d226384cf844e1730e2c85779b51e63a652958eb0f4befbf6b823fd817d4bf874d1cd0753c47128bb96dac86c8e60e47487625dde9d28cf4aca19dc58ba0dd44f4859c063e30dd93dec6fb4ede5d0b3f75b12df0995f0822dc697135167091ef5165a7b178eabeadc4a330e79fedff13ea298323edea5b0f36d50cf24e94d06b4e08499bab59a0e26e721ddc5da186566d0ac31acbe6d344e0ee5606cf6476337d0183e895650e815d9522aa5eb0ada8199e371dcab29bdcc36c44a1a462143654e5eed0af460113218e785454ee2dbc461906833c56aac780b635450124aa748cd963129846cc6d0c7b5242a210c978b2b209fb384c41257606e120ed94a853d00c1267a8ac9ec148cae56094580e3a62ad5b0794d989b51ea2c032f4bbec358e45d1941282144ae4a7c005101f08a08112d2399c288b8c75e343c0ce0b49c833e5cc46ae03311bb88f01bfc0a50fed13e1b2ae49e68deb0d3a5629b915fc4d364d62cf264d895c7d7827ad0d6a86861e3b2d886ad3b76492b426d5300d40d966cca7783d10ae95611a967d44782e0eeb770084acd374546ae0779951460270af8d1ac0aff9bc980c02066330a16690b9079a8904312e1ad3eac94cc3ca2fe62903198f339d0b0c9d38fa1de054832260a99610a52d4dc308753662aee14f6e185ff271b71b2194633830fc639bbf2e32c5b90999e67b75b66c0fa7dac4abb2c69350d988828612bf14811943e60353addc77251895195b6d488f6ec3f76849a96d689465198ffb05a341c7731f15e031fe65b623b29f6c9e1d20c5b3171e147686ad8e00182da7f17fcf3b2cdec6991bd6f3204f8b492214c86bf80459e1814675d82885c21b51cc233cfb07329e045e71f908d212292ffaa0c3bad8a730ba03672d3d5e2ff75cd0fa0ab7820e262c837901d8ce1acf70cdc94db4998cb40cb1247fcd18391a7419213545194e0fc8ebd3e771fecf32facb36e0888e263cad07187ecaf7e46b141371f2dba6641aba08d16fbe6f8539817b36b588aff2fd0549a31bc5305c097e0b9334be0a70daa6a96777c2c91d516231f116c4550e7ceeb203c7bfbad26bda653c650fbaff08941332ec2b9eb517a57d113a83916770d5742bb22d98b1909e5c7c874c3b9a570d50b6998d3d9bf081b3c69b6cc13e60772ea2eb08564d3da930c4d4eb7af11c256fd51d97063f3fb41afa34affdbc0c958458bdc630afa2b61feff9014765c29864e1a721e79a661f9cf06380c38ae1f2dc6aa77cb0f1c9ea6dd94bb41ea0912b74af3d0fa4bd90c480154deda20fa854cfc8fa14fd3a602536e9bc1ca98aa7589bc5301d7bdec875a15a6ea941ba9893959b47f68f970bcf01088b5bdd782f9df3481a4b9014ce82206fe07bb14e4384d9ff94bd205bb7e66b06223de46a40ae168176f324a9d6bd258b35147a10df017dec53626fb45ac1111d5d2088ee19db6e566d4f0a66d825108283d8fdf9040d3549ac5b8d991feb5303d4325358840ea1ae0248bfe1ea3fc7c11e3950bcb5fdcf3fe63a12b6f5ac309480e95aac966889ca799c2fe301661328a7fc4788ee9107dd49cbfadeb50ed188b375c192b93a010bd1ac4ff8f36e93c3ea11775b8461adb8791738e8df1524270098e34d12edd230c03430def1c2aad5a7bf806e4882fb166c47129bbcab5c2e4c27853c460594a458328aef06b61821e21492468625fc24269ec6e1ac1b84499d80d2ea9ef3577fe3bdca9a21155bfcb53611e5592c2af4830495cf2ee8457a948290c51849590ebf599b891c013dad2aaf36023452ae298701e7d11837af5c1b12742e927fc03c46c74d3afdf47626fd1b1695be08f38066caac83ad4edb82e2c761a238b601a395d4aac557cad43c5d27f526849f47fc1fb5201a1e22941f3a7bc765d132db234667c2ea6d014cf4af9502fae6b7c5235c967a0fe9ae5de9022506cc0c5afc874ebbcce1166edaad87fb2ca0b3ea0c90e056f499758f0c6e9dabc8e9f0e9c8f0f3745cd07dfcc2d184fd17d732e090e231596cd833e9a5ad792735bce1a89e507d04ed906a1df4fa4b792cc6b9f5bfe28250b23effca1f25ab129b859e4786a5b21042d23154647a1158ad7f21d7c11401c77de2c7943ccd07be618bf401e3c7b87aa420c3f3712c993c13d9a627611cd7a534037e4503b29a97058feb67bb6e0cc4ea4b51ffb39749a16e9f39dab59d8438be471ff1797f82338a4558f11dac3e81c0e1fed85a9fa3b59f7b70eb11a9bdd4c27983e2b44af3f701b1de3aafc2b702fd86a9bec841f332df9e95f1ead25ebdff3222b5ee36bd174a1efe3c9a474c662fa48086b509e300a2a3c1aa755e0b841206224bc8fe1dd673018606c0bb28d5efda89309ca5ef941b0ed0a86c1ce3454ef95e8790a7c5d69f520bfc2c41cb7453acc4dfe0f7c15a87d5d0cf5200ca87b4b2359c1008ff9476bc1a568b4727d92a9c30d20291cfe563e318ff01d84e01f5a3e046e3a200af13ae1c5a58827d6e3e37dd11ebc79d75a7f4e9fd9f83620f2e1b8897b155b252f4cf6b3fff2a0112a12a206fa8ac25a0d9ee649aab752dd7209cda34797f17e1f446c18835720dd0b4484be3ddff16296d6e77cdab5511867c4a0f7b077ab7be9b5431b58fbe0f189f47f544f33b4aa202bab479ffc8f7d13273578d8fc08f507ccbbbc805d88938d4894d2aa905212691ddbee7c842bbc9a151fcba6d2eb0d8636298d010b801862a5c40a9073a8675a26e69f21dbe65da96b28929ea0b8816120b2133ea877a3d161456f8b9b0b14b8688ccaa8d80f2bc17e2fd15cfcf2b2bddeea12de19260b23ed48e2d27888acda6f90858945bca05b1a9e0b3b6b25c5c4b1868b19a17fc96e6a5b3f3482280cada842f6273f94de3eac5c1239e1932d63bb3988d2e69cae2aea1abf4df71350c4fb1e426f12df8c334ba84d124840c2eddab1eb64cf5e45158b32a011d84ec212a5424847d3e5c52fa3235dad62827c0f624090684e630884df1bf23b1ef79fd93077a6de0499b515ff19207995308d93ea13efc966ddfa5c21da8d97bb46041cda3cf630b7d485586874c7d5382dd7fdeee9fb6e97699b70e9cc677d1690e6e969e231247411423c37b7af8439fc1790505c94db47a676cd012ed70f0482a705dbfbc4a99e10cec10c6fd020fcc449744192730b3c3f4f736c7dd883629b97d7d2ebe82553bddf12c88a3dc7aa572c486473306f8f9097ec1a7d1665b6d98de0cd3fba391718bdb5ba8526e150f2b46ba5365ad430e5a40d2c93cf27002fd0da38ac2d8046bbae584b31fac2ea079822872692a9b69815fdc1ff4a68d2454e8eea1ac5baa3b20b839728345893bb9febdea64d7f29ded88988eb93cd965dc4f0e7607b81e78b88d089332c696ff26cd0ed48cd5a179fe33a1280e8c56864f8cea5815ec93a838ce9d4e523b2e65c42c9e32054bafea15cfd9b8f307fbc5ca4e9bc3c2babfdd0c92328f770b1b8da111cd92a513237cf64570558ba95231b583b5f8a900b07e7d9d64338116d4c4b4dc24ceae9f8695896e1efd495d826ccfde245b8acc9ce2aa0f4b590eeec4eea2217ccd2502f9cb0af800c7e8078a88596fe43a882964a6004119afcb666071130260fcb7a958c0a427fb82ce3ef96a52d171f0966119363884713b7740f7b2ccf188f9026962f2884ec99812e893e09705a9dc03f51f929b9d371aa00f05260996e391ac6bba700795dc92ea3ac988579c7b58c84648c215e96b384cbf158ee942909feded20ef071e84bf6887a9d2f943b55f9888719503e9e5f0592cd0104ee5f0d6b32b6b98e2a434df9a1fab0254e690bd2e0a1ba136667e00d99e789ab02f2615cec901f5a864a10588baf06ab06ddd1cbbc17558b4223ce5553f1b208e871da7ae8cca95a390f6166b2cdd19a49f52a77e22303c00c8069c287097a029987fc36a015465e86c01803967a21537c30b2d46246fa56573bbabedaf6135dc7b789b2351a21d976a37a0140b49cb0af97f6edb532ce3a9acc20f79323e5a9b98bda1a9bb0ebb341bde15c38a49e75d4495fc4bdf08d90d35743251b56728e04ca3c4500ba28b98af1df12f422f42fd11dd6f47cabb0aa6eb6cb5440ab3e7b4211fe4c28e5f823fdf556bc150f4fd096ed6c9f6371b1f57f043a0f1346eaefe38aab60d28f47dac80e6699faddf9acd0a69de7607709c1b6569b75a67d309e9aa231f8341d03796a20e22595e37545fac3d47c08f9f1f897ecca634f7c6b35d0ea1f675b5fec29de1a376ef2ff0a6b31b99a5ecff5f53080e15e42e361f6a98466d867bed3a6d2d0e3110744465e6ce4222f255deabfb65c6fb97ae1b1fb1aef9453bf679c228cbc1159a7023e6f3080099de1ccd64a401b38959aca6ec207c5d2e62efbb2c5d7ebf4a20435303ff34244f4c013d0fd42da9c36de83200b2b1f25504d4991347ff1f92168ff42c6fc4eb27f0c28bd806cefb8869f243d1ac06e1c820003964e8981e8ceea347b7891b5f40ed6fc93b9c880ecf6232f384245318562160f830651bed4907a38db16d051d5491f1b09d5e62a9fe0fcd4c619654d827215f99e5a994a82896daa21650e7079131a4aa713a53a63c2ced12cb7379e41d3d44bca7e0ce121974e6b9a17ac46c09b62a0dc40abad75a6388911b4e7eec1d15a03803a4430fb8227d08ef66f65d1fd59a21b713a695840adb270fd9f710a661562b06c2ff0fd224a17db57e7d6a74a830395f5bd4b66ba980e3da2fd08f4d131b6c753624826d8f1dfd8c07945819cce272e4fd0f18985c0d766a2bdf12fbe954d4dfdfd9bd8949471267b9c53c45203bcf1f4d7c7907a1a748284339c43f6b14a3e1aff12efb4727a825450af7067ffb08703c0a1a66fdc9be267bb782a941585f8c961879afda567bb86433e0870673ebcd0bf5b1ba62cc4ff82e03e29ed2fa7373154c9330ac3224112b9526921f362f0861581487961a6415bcccb84f9114c855cc009d78d728c840e01e515ed9e8c50c612975b76e6e6d79e1f12162a72f32a5a5acbd759d9ea9e4ff514cbab863b3978295f379a590cb4560de22f1e6cd03f9452bfc914be6483132f27982388588d130d86b35ce4856f96edfe6d5bd34079a9a5dfbb4af2f92849c583ab3d667f4bbab7795ea000b4af8975e534f3be625af042c97e16cb7088125f7817cf82ce28229b44de5b472bb5af760506d8d26cf361caf7cc731bc516134dbafb9a1426c0d6e42c8bcd8cf033d6b32dffe50ee01f19b57634f4ee9bad6ca993e28d8f2a8f16d924dc01a791feba0b6d352f7e5e34fa9275b0becb138cdcac6938aaededf69602164c94966fa1108361e9d9369c98cb95f8f0c704d723dc2167bac6cf4c847fecb9442f92908fbab4eee38f1a6880d92838ab1b41da374308054825dd146ed193512302d25a8e224276ce1931607b903b43a5968336ed2f01444f57073457224bc6fe8e10d72280f7e6fa67db3720e0e04bd3b17f9977252251159d34de2f88a55cdf777ce7ed16c6c15f2922952724eefd650ef2b737745ef0f70681829e6f7cdb788c76ba997b48530238d22432539a052dc3b8122a77ca305e1a959cd67cb6c6b8a6407b53191e440a1940f4a463d7e4981f303fc96292a5b928b84fcc189f178ab1c0c6338920e18a243ac766e798823cb8afdc4b6659fdd07c633d07e1424f5dd0b218c395a568fce55a3efe0db37bad258425da28f1105f11ae0a2c475c34cdad58fe269130b1b88ea5ad42b5778fbcb5373a8572bf6b79f78b7cc7fdccbc2d745a52f3b9e3b7104610dac395f818b9602f264faa284052ceb8c05f64b470d2260195139218cc449d28038f8cfb7c9c33985d494c441957eb8f556e70b9d1e05f7b4d8f12c9ad008612dd105542ac9e492137aed1d6676bd157e2d6986df78fb861e7ec3d8f3da26cb40e06ecfe80ee03d86ad862fda7f0a2d06f75a4fd937c1a86407aaed867b15bbd968d0355652802eb73b622b3fc46d7b8b53fb62184929eeec4ea6e08df3d576fea18fee6a315a356ba3f61547f0781c7d6ad6016d34d7e9de6b864ac15051f5f157bb25a63769435a27fce34c5d17c90890ba5584d82a52a2282d7ff9cdf9eab4855c5b56ff91eefc41ff47a3cc25e789cae478128b6f9306736808d964ba579c9f63095bf7e31be26ac5f57617b7c09e3323247b5ee284e9e50f49722fdc6cfc1fdfdb502346b554f6a12a59cd324fa4f2483a58a801a2c679d2cf7d346ae56848ec5aa71db12836a3e5aea59be2c1f2779cc0e078d82a929977785f8771c62a528e7ff01fd7df081543ddda302f6b288ed200f7683cfd7475e767a1435db32919592ff3e756c5ccc5232f5e0f49be4348214c4ce5477cd5464f1cb8c8d214f2a69b382ad70d5f785f017d7f665d68535a5399c05fdc243f916025a942a169697a4e2abf75ca45602faf6183dcec79daf34421edb8f2e077cdbc910a3cdc697a30d860fa2111f8106d910e17ed82a014b2e3c9015bc913c72a97546136371208e51bc13a015e1628074f064b8083f41d8bc8e68076011b1baa3b940f91445691745b438ed74b65967872a60582bd567bd1ce189859fc120c0932979908edbad3d9e6f561fe9b2ab84d81fc9e498e0297341fef033da9ba33df9cf847fb9a39e61ca83e1ad63e7b5e1d7ca8b75adb563ac74327645a80f230945ac5dbdbdf65486e657aac9bfc3acbd033d159d02e17bc830eb1a3ab97438129b5d4fd145e5784ca261013eab772f76e1a13a92f98e87346b47ab3a77343fd827c2fccbc6d1e66e28995a43ea71e6bcf1597169704ee1038749d0a300e399e912f9cb1ba1150b78eeb27219f527cfaf09a3d79cb110616e106d61d1037fc56dfcece4d81d2416aab37f36f59cae463a4fe434d1fe55c63ee34cfd974a7863141b711409be2c083889b91503ab319c649ea8638195a65ed3f1966653161a7be3de324b5e14d7f3f89ed41c4c973d30b5d95949d09ad059762a36119129076277febaa5ada7d3f38192d5fccd0d9ccec1352de5ecb638c5690d64646e269873f1e9c57cb18007accf018b67d3c4e2aec2cb630d855c5dfe7b1bb66824c0bf7c41f1dd46db5489e33c12cb72d9df71b1035e71167580d141289e5044d4383c047bba90a7546a403dc0d59028e082d87dbdb058c771b243cc223348d8ef500e43bd8a8cbc7be7f9fb32ec797fa462c67f971a4824a57d465ab2d3a84e1f226332963c4e74d25d930aeeae7ebcfa2a454532ba73d2ebdb23ff722ed820e18bd3325d751e4d4529bad4d75d576405c1e58d69b44b70120065e4e38e70ca8bb4c680ff54881764c998e9d41b0ec469fa91bd8946c6217607882ff5ae7b7e31bf16522895a394c2a0ecfaaa86ba9b7c4f5fbb31277e9600d92fcd4e1a04d8d052a0c731fcb6b259da303a3902888413051b485e5af0cda3422166f68250d3758c365a77e97044533f91f5be3537e4abeeb0fe155b0060822fb067747c3c45f9b2a4f037bf9680d2e9ef2e8d7c65903a38ec69e329ca95faa36f30f0399a3955ddbba490e07bab1b09a30d880a4d7d117476feae8cb01720fd82212c016700675934f0902bb8f0449b7ec3dc009cb1d23d1343e5b9e7056cb2836923f70224631afb9280b9f18f66371ceb5b9e938cfdbcd7e7af991900da4dbefb49c767f09bc4f18251fd7f8b23392ede1ff4ff904467e3de27f2299672ae63b6e4dd8961452531a56b083af9e5b209d756ef2de96cb299503e93a9bbeb8d19e01bd0be5b3ed1e37438566d4bc5031a379f73834131dad7853f3db6cddf948bdcde99fd84445fa81619632876b10b15a21efb351960aded08f9e2b5a15710661c239bd907ac979d1a5e11e49c29023bb44650dcbb2dba27d64f6f355908abe68219af22e23af768e4237ca822abbc641158499f34cce19cf6c75d3958a89ec3d3d86cfd0478d377c9104afaab2388f2754423efe879e64316873e15397b6e7360b38ab2e32618e4633b17a2b580e8ce56e68690e3a25884f8489c1336b6390128dae31b388018540130b1e3142a7a496c45dca8648a0b08a39fb0239409626081e9461ea402249e4431ba10a2ee549d68bc39a2d55cec699dd52807426b2f8d392bb83c2649d2a18817b89be46a378135d09dbeda7817c3d30bfcc2adf14ebb689601e0aa45f4ee1cbd867537592840eaa08cda6b0552839160e55eb6d760f775bfffca20b44e1c950329302a43527b512fbae756a61717ce922f7a58824f92ead36f1fede843a9ae5cedb83b7552642fb7d87fb05171c2267601a83df2265098a85ce533e709f13e75f9b5bf32e9600d99e4e62284fecf894d7dbe8a7b71c079ed2b3b78130680a9b0f34ca44eb4f651d3a2be2334d0e4f12f332a7d54caa73a5b973d1b2b1f0a6e5a2ba7316a77b46ad53deea6e59907c732d2b894dc20fbdaca47da3758e7e8b6352c7211418b1531e40d005c5d0ba853a3641e2a7c263fa59568a1fe5fa482abc347a5100d6fdc5c4d4893d685e6f686a57e29a9342b1732abef9d618346148c9e9532a0694cd72b8d2e7fa464beacf7dea79ec34c49ebd97d86ce5d62cecfcf91517a33a0f429e1d5f9f86db7a040ebaa78d9db74ad43dbd8feb8046adca50706f2357e539007a9bc7d41149d6830db8ede3bc2e4ca35d27a8207da364a5c8f0a472be0ec8076801cb1d8b24dbfddeebde01312117edfee0be8f49262cfaae9257b6f760ed6dead75c4ed6643bbb3527cbe2f811634e504b8a0caba87406cc46fffb8a0f54b8ca97298737893dbbc2122535fb75075e29425580c5f055f9ab41da6d8a63557e3960a4fa60d05c214862d75419f93992217cded0453e8407d08f4997131eca679c4627955dac2ef5d29a4abdbe5461fcb4460273d23b49a447f4fd531a1c17bda3a6e637904ba94481dcb4f65b978583134b13b7ea75c4b0316dcacd76db89e15f715804d76b20a7494cf47588a6d99df19cbad1241c05420295326b0438fb5b929672dc18596963e48731bf546710a0b92281aab6e707abb1ebdb29153d77937fe158d97c77d9416bea4729e0c1290af632b1c38cc24a31a69cfb9f2af92ef344bb0e69c4c05d3c39c3e9ebdd427dec9e7ddf69bed6ac1b0411dd583a3168f2b142f36a097e7334955d97a935d8f419c54b6af0a9b984ea30f182cda4127294a4ca9c6b5947cbf8c0cd5fae3f0f2317caaa4ba8cf06d593d522fa624f739b9874cb9c0754131bdca097eecae753850c9dc2c3990ab19a277f1c57a233f067a35647ccff71c5904190a4ff8df478b830f0ef8fe0456bccc73ba270ab149e247ede0006b10713dead06834a0918ca6c422188461c444f40544a08d38e6accef84fc8cbb1ba2daf118430ffb454164c7ec56f25dcfb655eccd4c25e0dd905c1cb82d8ae890c362a15d41326ec90054c38035ccd6f4e6edc50f853a53e17bb5da71aa8ebdbe4769d1ca7abae760a1717319d012fa20692c1d8f72dcb75047c540ed29971043f89b6567052da1d0cc98607f74b585665687dd28a6ec53e327a90806866f9590393c3cb4b3f488d87b15d18de1fd723da31fdfabdb2a69f60c8dad159e592feb4914cca106e2a8a3f0de35ef96670c9377571d97fd1963266871373fda39624d2ecbb09d23d96eb50e3a43400b11b03871680971b76a9ff467da110bcf28af301a6ed7a7d6c113186ff0e14419ad6a685408de74112a0fa28fe1fae212104a4806acaa7c36602434de62b0df310d14ef7feb530d2330fa63a5a88adb88281842b21b281eb728094824e0d66d80e706afb093506caa99b3aca0b572430e8786e5e1e942afb9da1cea701dc72aba33a6182ae5e004f998376c660cb888c79e487089b62a758eab07b2f3cfa11c6bbdcc309702132499b676b2c0ef953615dbd9ddd577a4540b99c84ab295abbc50d497a9bf7d5e3049e351074eaca1597c69b465d1b419f5bce58346fc2bd438bcf3399a21e12c5bb4910d6e460d1835c8ffbd0e01ef7d73f936d9e8cd7e70b0571382b8c8de233fc774997e46c3fcd4177a383f7fecdac4532c69b1433b0da4a1fac005af923995defc731867fc67186379c7d21d04f5f5365c5e8bc2c278cc83329bc6af541d51ab473808236b7a7f3c10d91ec4f658b3cf7f86c5f4d84c2434cb0483605533608f2ecdc4c7a19b0fb17c20fd4bf8b8497b1b225c13b60c6c2a381f68a665894849add0ac5780203de31af67088c98c2caf271c3dea17aeb113b4b3ef8c42f9341b4a3f8066a3a2d15d657031cf01d9806874f641b3c46f732752700bd30c8eb891dc00a088db19651b8f3ddf46aa74e1546a74bee60c46c5430b3a1700c02a22037dc8ffb4960f4112e26178c006f32a8928aab06e3b95dec3aacaa69725a5c9e669f24709800423610a7ef03518623543cff2e0c252f51f6122e895f1429937d5b43e03715830a55a0ee8077c3f542f4e898ff90f0ef70bd3393c82cb0b8d3be5f3022785c1b069da5b9d3bd79b1a39098b3c2f47c16dc4161b89055213d4de235e117e333fa4237f4e1d7772b154a5f0b87aa12c7d24571c4c983448e72cc686c6ebe582c7780d55e15dd02c1cc97e2e3d65689577922f32ad0c5d8a7daddeb08d60ff7bef5f86fe89a1920cbc4f1c3c0138dc03a8831603eb25cbac595fa381076d03142a6f668e216d1fb994d6eb0f32bfaa04c477b1608d0a016ca75108577ce577c375a1b5cc796a5ec3563434ea9a0424ce12fa751307504cba30816f032e84c80c0a85220a9c974d992bf1464c5317a3d1693d23f9609764ad47ebc844b92bccbfb5146b67b041b751ca72dcb5ba735018ad47e3b76d1d4dde742c45604a10874a51fe143db38fb31e85c2c04b99eaa598d5381003f10e57215572df156e9668ec5aef26b792cac6bbb876ef978e342cfd3447f0fbdc163123824b05cce8a9af24d3f27a2b6dc2626ca3682de7236001e7a301ec785c6e89e00acc40cb9d35e095f76f8ac5d18cdfe164730427dd9b73224b97ecec5e4de8192eb002e16900091f2e40c37ab1d23f8bed8aced4ca9a470ff187ef449fa9ee1a6d575a4b2a03dae750cc23f6fdc87d9348ea35b4a98b7b141329f07b286fc6bc65f137667a907b578c88733cea91067e00194c448f3109e7e1fe54145d66410cd536ff32a0e247235adc5c46dafe1ecc8dc2bf688456430f07beb1218e02d242629d3757a4567bbfc204c5bed50308e91a0350c1803fcd57afd31f5d0f05c812f0c5f22e3f5b101f047281acf532343de8049d523f1b7808b38a19d4826ac3531842cbae8b396e998db7fa76756400e43c7071f7333b417b20e83c9914c209002b1fd77f88dbcc8f8bf0e0cb16b1f6e6540e122506965ce7f6eb0d94aea26a22d2eb7907534a852d9ddadfdc5dde04251c14e2a8e86b2f09b00a16fc97dc7a4423cfa17b604ecacd3917792cae39158ddece77dd10c4f22c07cee569e3fd7f1ce63d23fb8982086992543a823185546fceb20686eea9d4a3dad36a68149881a30dcb4ec1f0f8cd46859a197e169d4c825f94950fd3b64156ff2c5853735455f7e19ec40b253ba436e99a2ff2c6907a6fdf207e9a28ab57a9c4bf9c1fc70d8ce37cb9709e99b462a52dd6c3d2737b3d0775f0c40d1fa3fa67f81f47d22f2d817175d22fdf7771d46264ca6e58f6db817e04c642acd25a477bb2266fe9288d398dd915da357f26e7d0aae3e558be9daa8c8ba3a4f826fc818cb27031ff42f0a015235b1f6335b596aac0238971864b3b4f6f39baef9907d92eab58d91213ab7a8d05fe8dfe0c3cc24f0dc84e7ff939d288b253e4a55f508ca83ae049a90b547afe7f1a1f6ca2c11bc870d45ac996b2bb833707510a740f17077e472d19183f33cfe0d1ff80a648667e53579920314f5d237287a4190daca08850fb7c82d80f86fb934d36b9db8663bff4885ed8ff633b08628f1ed32c5e5a9f0b273b22718b7f812e3937dbd6f10688fe89035e7e7bffdd669dc2f4eeb1626a4df99a9e684d8a18edb8f86050a185912c35418d708bd39e0ef7257709e9e789c8c5fc7ff16060e0c32da75a809d22abaf313075a01f389756252d0219f7f748510ba33a74f630743220dba271377befde3cd97d23ca5df59d7cc758f14be328987864ad4cde040ce6f0b20a2ab79b4da13b660ba701eb9f953e45c60d9d74c8198fbe1608ee732275f20fd526744fbacac405c4ec064204bcf9e29ff7ba9af5dcf3d8d7722ba72d4c40f3f2912038d229551a25e677106c6ae06e26eefeda54b420225cb355ab0b896b04292e971ffe58df6b5331968786d85ab9ad38b60cec8b183d0c40ef4b2f3d61020efa5e2eeea8de70334ac5240bc106d198dfe3fce9e0a2f158ad94fc5969a7cf3180acf77e1f4cefbe7121b17ecb9197f6b35e0a09296d7bbf8028c83c5e9fc79914fe39a3c117985eccb79386c2e2d789328c6ba2d27f92f246f502e243b248e795127ce4e3b4fb120e8c8c5e5243caf726df97376bc0f4ed2722172a83992151a6c8ca3f6f56edd1c2dd432e6ade5878016e3f90de06abc7f52be5c7ad1da6ecd79f2019d0ba5ad50b86e073eba19142401fc366c65a3a732b28f636dd8ca39b63b067b5ea14916f76a4ccefe070f878b39534f9e9638ed1d437a1b5f69e9f0a9a85ebc53c9e54800512e5bcd4d6d8e2a38e64f5d52042d7652545a244ee310bcf25fe945c42c7b599324958b4c3cdba161bb863499564020bd263ac7746d9f97b2f4cac3815bd1d951ff65c62d8bfa0a6e7a09432a50b5f091ba2340b584c9ae7193bcb5ca61f4d7df03a74fc157bd7e827a94ce67d2c5701742d3b304376e4009c53bf922603ec927aca0550dfb871920e5d7c6e5ce166859a5f250368cb01b501b18a9a81f3056a69df9f6810be2a7ed54a4873f11896f5c0bd161a1dfc0c0eac2bd1d853b882ab130543acf6d615eed91594d87f481667f5bfc6b1e2b5b765d7e89a3d2763757b9bb60a26297c6123f1103f55f42bc1f284280b78d11e352ad6fb9d70a8ef0ad2a2a790e067b2b8df54b806868b28254d3fbd1934b59023fc0b3c8b2aff333f33eee0aee942dc0cf42a9a0586bc8e973fd499288b2ab66cf02202b3d7449e5a9875e29e44f6291f6e60e8344cc74fe7ca2c26d40bc60ace6ae1dacacbb00fb19689876a6dacf4aa3e35a6101e838280600eb887156242ac26bb78a0587267061a47d5ffccee07dc795aad20c44066e260ef461ba09117227a6464fafe1b77c58ce88d6fca235917d57dce2190ef05d32a84e0ccb2bf4c4554c16b61664b45ef78bf9f55a2db8361d101428adbe8ffeeeca7164855625c34d60f92f5bc63d93462e165ab9aba29aea77c0536c250a72a763cee087c2c45ac1119137261835032a0be661597ee1eec3d1a4075576eaf5172f87b7868cd7930fc1f29448be0c5d51084ad3251b9fa5403bff9327da3ed10d394e763dcef04f36e06e15787a548644551975845e6ab84ee10b714cee0c8bb4a146e8d0d412b64dcaaad913bb01a958c2829f15a4dc90bcbf742a3adf350e0d0068d2ae1eac18bd2c2dc62cda2df65a06cdd90ad75fb1878440eff44bcec7070c21c98d654f082379e12248c3bdf7f41538e199e13b390cbfda3485ef7410c71de4dbd35393ed7909de9f1426323f8e9e7a936bf707b5d8f259dc50454b5fdffcee09cdb40c60cac6d8fa9af04a93875ca1b14c994ab46d3d198154e5943f4de61704efc798d8ff579d81842bfe181f5683aef82a48c0ee891a7e91a90e3d878bc82ae43de2a271fd094ebd34e13eda64450b2066c92beeb3188b7c26bbabb3a3e8ae84bc0eb799b8ad214d63d1bd93620646957700eab42e98821345903225342c92eca13bc82fb2b3516b48b6b2a3f55c256123492e51dfde52736bd12cb9e73f2aae49a899b6ebab4abfe47132c606479052c4fd2fa313bd8060d13d89abd9ef83e2e7afbb4f38637e7e564010443970338190d74d744fa03b8364da5f5e46c5035f20afcce2bcce1b42d441350afef182d2b6baff51624248542fdbaed6cfb9e2cdcd478eb2c9b2ccf32306aa363cb620768961c8d5e7f888cd586d286f5ac44ab11611ae184cca8e9608481a8d0ec4f8eaf8611ce92150484bdd641e6d13607425328f4560a2632a269029e94aaad785274326dd78b5d1ef38b4ded8f604e1a94f9c51e03fd3797dfdc6598c03615e33a66f779564a7ec5da5e46098a21c1e9439cf176b88f09c69b45efd2b0abfd951516a53c2ab126186e17a99ed4ff7d5c763066fe7b48fe2c0df659d0916aad472522fd807dea32c4c514baa610ce4acc1d53d12d038c260c4ab9fc0b4fde24836e301cb8b4f303924673e09101bcf6a51dd27dce41e5aa9c661b5c29d8f1bf088d5343c6eb0c4fc2d4395c1a0c9a88b18c14ce944cba5ec378454131767f1fcb7b7bd02340f1399def4f6a6ae05bb5568e0c7eda29396525a95bd6d6dd8b7a36b5390b3914cf7c3674c1e271112c34f5a58bfaab149b32ecaf41a760426fe185c110401b3c73dbbbea681a42d9b9a6531fb3c7107b6ba967a5a9dfc091986a013ccc14e44de1326a7af1f7f18fc062ad3110a63237de44cbe7f7815f73796211bcfe346e1379cbb50342dd82d82b94e9740581e43f052332701d1132c0bffda7f1c771d1d7e52b0a1c3a08dc9c41c4d4e9bab1256299691d1407b1157dc5ed226f5521ac02d3528ccbda8d4b9747d14bb829e2e59a8e9d0133a690181d0cc34dfe5372f32e6fabf569b3506b25f189ae81a923f61e930870671d85603df7442ca564c38f4bc592c84b49c8a3dcd67692257e86c830c2c6b5134754c62c2df90113d8560abd547d3725f9a8473a533f358d8a8faea2301eb6255642dc8a886b7a0de442ff39237b54eed397b4ff13430c9b6cac20db56d949d7b631d1caeb799f0230184cbf6223f9a3d89a1fb5338156cc8eea84ea77d1382efd97e0653c4b370d66c173567ec05dbbdbfe87765c898007093ae6da889cb271db4ca66ecc9a3bd42ce4f9a469a3663d78fea07acb01b91a03a09ae9f941443d335355dd8676310d132010c1afd09bd7e75627eca60dde8032e6022c976b26617b9d5449f5fd8cd037f60147d80e8bbb7ead67b3ff760e0d5e198776afce04cecdb5102eadd3bd81176e44be9e7bfc86e897191f4db7abdd4732c09d24ac029a5e542b1b60c54a9bf94f98117b6bc017c893d94039db438f7caf371d020741e8343d47a6ae188387dcf6db3f4f7e6057d2b37cd482038335a53926a825a14ded59c785b873760bd7d2ba6484228f3bdfd9d30a769e30f8ade07dc29d488a4df31ed82825a7086803a178312367dc38e395f7eaff245a823d73abb6a366b5c20a8f786870af68df21c900fbd775a07d1356891043f580ee84dc988debd26252d4c9f60eed937ccc84fe183a034ed4acd5e3c5c4bd3680e0ccaea0c8ae4395bd1405358d5076d179910ab0eb37eecce2d561fcf1e116083b27ee8253f9e7d9bd082e86a6a775bcbd360c2d8a3f495f8d7dee7b7a603548c15f2422ce30bebc98e7db8de5c425d28e3c41dd4776e381c0f4eaec5c0da50e668c4e3d4a5c17e776ba899c64e317d4b98a08a89950077ac40d490a1520382c5859463d89941cca7e420ef4272ef6752c71f355bf15394417cb9f28e7a1fb62ba97dfb6c745b7844679af9999a6b877a666a4dc7e8be86ad78a5a7dd05b4e97de2b72532da6d09b7f8813c19981e6dd0fc3beaf2c756aad404ab03fdca2d7fdd506af4e25e0de9ed04d70a49edfe2b4967c050a0ae7117dd20736435d687bfddd389004ab09b1865903b54a0d758b95bf135e63f48cf760f42ec89706a930dc6e27c7e0caeaae293bcf90159a6d31566dabc4fa454b78bd5a1fb6e244385cc6829e6be3b4a45b8ed31700795c0976ef3df07cedb28cb70c5052dc662b1903b0ba975f0e11509684b5c66db7b4d28e2541807ea1b82a1a33f6dc446ec18ed86fac2fd25a3663671843c11e055ce6cc8328ea01b5ca3d9f24cb740a19780d7e6db8b6b08e9fc5d97be6a872a987f2bae3fd5d6564e9e2d189d2601b05cac2fc55d20bf397cdc310fd14595be22b36e63b8e551e0dbbc7bd37ee6a0c5ff49689af386f09e23a10128259628c651926f1e01ca9cf716783f0728e7d247ef4cc32a45e20e889fde5c1e3972b5c35da5db2e63665e8aa7df2d6ec597b593612c6159e4f28b6b1cbf431aba01357836294344e800bc96186bea2014f1395e9f5bf0927ea8e120d82ef05d00ff6b7b5396d0d041a1ab94c22a6887fb7f769f8f4ba8f1131ef0885385111997335d3d05092953958a3acf48dd920f0ad079e4028fffeb643e3cd8fbb015bd28c87012df76c7d5d91182ad47873fd37b53d00f295741030253383b31783958bb1f3575f29d9f5780d9b91ffb5a37b4fc82a1d889d791efea4b3b8ace142da738c170f233f4992ed377b71775bf5d4eeaf5f9f3e1c455122f7968a450a443ecc68bf98b28102423df4dd12cfafdf5cacecb552ce575af4bf31a0fce1d5b0f716ec45842a37c5a62e5a258ef0b4821e8cce985153df7def37886e76bfa2e0e88b4fdd01cb92571dd17505789d147d3c3a951b421960fc4e4a401b6b581b3ccb1a7018fb64eba19d7aa0852e5d7843ef6c08af76e4fed28a91bd82e88893f7933f46da035896aa801c14987a6bc3b0df774a409b559e1f9cc4bae6a750c4de75f75ba06a710c13ccd100e8a6168789910be891900a1c8a5155802af73b7ad5ef7d027823730894bc3da109d58748114d988d9b1aed6ca0a977bc7a24697d969eacc3beb8c5fef17d2b673acd58967b2884018587c1621bc5a60ba34b6d33f50cf3e8d1a990d7d0c6b1d6190bfe0a9ffc6fc4849a38dc319698ff4ee43435b962c646e6954f834e5815cc24f2290523097a1c7d301cfd745eace30fc5a85de3a01fd9cfab4ee02c4f967b13317a8549a566f6be72afb9faf59a9c271a43e8d86a675e1f121637d2d3cbf9624a2ee2a6d03b9de32150cd1c4fcadfdd74935283268a11df43b74cb74fcfb757518e25773bc224686658ef06138e5b0780fcd1f60e65f10b2543abec46f6ca26711a830c34a0d76b062d9daa784ab7f819e92f1fa008b058282c8deebfdfbd9cd2424973a0a7b79742667d4dbb1a934142dff70eca87096cf78fb656e64ddfec58782bfbebc51d43358608d5e2ae27b62d3cd53c0b95c197a850cc85930458981e816171b453c642f95cb83fda6dcee729900e53990650245067da6ee53f5a337895dcfd098c67b6ac571dd301c63c34579d597141fb64f2e049e9de196c129bccefbac29ca5ad58d4ac7829030913ce0ccc3acc25153826c62141d44f76dbfbcb6680cc96fd299a5bcd32ac271c97f1358d1dc0df586b8b8f0bd009b03aca9bb6636daf6654f8c8db98c91d669d7a96731c2b189baf0808f9f7d7abfc717a1208c9219b1808198a2d8d35f3bf43af5450f0c16cb36b480805c58831b3bba6a3626f042b1669491f08323123df5a14e4902d05c3147b4589d5083e011255412f0c566de473cc61941febcca4c79d127ef4e2c70c49facc09a9afbfb580de6f4a414026887e1045851053ca2fa200ced3c99d3c96b98ea8dd93d16f288147e433933f81c4e28151ce83b514a4859c8d437068669c4e15494feab6f0687025571a2c518cb5c5feb2900ff8c5270f1a249499b5dc062c66253302e69ee7fc83f27d1510e5126bf8bc566dfce5ba7da0480b41e4dca3f5adba5414b66226639669cc7f39f911081799995edfd719c54c94d730f5863ebbed45a7d25364a83e98577a90499e950e67cb7312484aa26505e76d995e0e830d673ef99e03fd5b0c8afa9d5e2bde18e5477f972bf8c7db3337ea7a64309935935d4adc8b597780237ae54a4bf1e1886d21c25dd5a0a7a407a48b0f4b5a995a125f6ae79a1f206b3f432d6a36cc85c458a2649bb183f7bdcf744cc294114dfff906c80a685c279d68c2ef9d6926289cebdad7e87772e424a225141270ba0b147e5561d0cdf8ca48d66a63e00cdb6b6fa232d47059b69262943c2e40a87a9b7f4348236bc44369784cdf5412234b95af659d3c4ffc3fcfc5b43d30e03f829fbca0a786a39d446dc1adec2540bf5121fa4f2be346c7c6ae0bc911dd854d8bb264ea88e6306d9b532f78a237b15561cd42df1aab8bb4909491f2ac6d367e673aac3a0732c127bf1e918850feabbf39a154fbdaed62ba6c36ec348329b70846d5abb0393c0323743f5a608cd023764e876e2372e7a4ef201d27279cc3cb27a8af792d39837cd940d3b73ecb3da05a3b2565466d9bcdbcbc1e8b1af6669e9da85949edc9a6f5dac0539134bf0111951e40b4c6e2e156baa474e16d695b1eda9f8d9cc22e570cd6e46b4e0a46e4c46cc75188f451e1ab56f005af5f291c8367d0611c5544345e51d2f79ee86054d5af50b1742f446028dadafef14014c695425affd90c91b7cec225374f229aa80edfe71959fcab6641d7b8e6abfc006740bb80eb8d270644eb6bcd0ebc226154196ffb2c5c98927ab9bb0c8324af8131cff788d465924232aa1ed7d44b4f1b6a0c1d0f572e8fcedd52177ae3d0b5524af1f10dff039be28fe125796a5946cbcc2b707cd5bc48945f24de8ba171044cc95c5c7e77ccc4eee17f818375d24a615ee4588cd55e411d11e973570a56ff4cc4e1b996ac30517e17972eb72d62758fb31196ff3f8b2d0619efa47dcfa35dae096cf86785c6fc105268208e857d39bc4d4a1c6472db1a00b3b9172e7cf76ffda14769d9a2e61c6a2ffce2d77e99c95407eb235dd9802844d1ccca82899abfc7e1a8524cb2b6489e381fac4c6e0a2e1020ae00df42c09d8d43cda201fd018bdd5996abb21c44eaf82024bc566bb6b7d8130cba6e9730e2bc95e2a4c7e5041eae6201bb22ac9fb9b47ea193fd19c82a256356cefcfb2db0dbcdb3595ca3162ab2b1a9b3c61a3c1c04743ee9560ea9d8afa7c8e63dd0b4659b48992c992a8c13703c35de70cd00827f43c5a6cf9398025c82262b86f1314c70c68dcb26ab5a7eb39328b553cb5c276b436e6de876d7dd007e702a6c3878789904c5b48e418a481909b379a93105a0825a9bce4fe9764262d79f8325b44d780f3c372849b355574d165528e4a505a5e882343bc05c94f31e672eb4afd41958afc717b312438c1850e7042ae6fe1b11ec9b9a36ad02ddd98c3c6076479b8f13737cf436c33d488feacff42a2751173f8da3ada3b69c32997abf80f5f7ec761a066e42580b675be76055e227083dff4e98e2aa75c6ebac7002623f0a5478d16677235b2cf829c047a383b7ec18bebffaedd9e317d98cacc682e2d563ee078b0b55a230c2ca6fef68b60d584ffdf51400d8294c718b6720c5679150f4b6eeae4868066e74a94e5dfafce3724ba36b329c933ade6123ff5eec5060d58e242e01de72f901051698c635edc59183a2368734b493650a3a97f6a5add11c294bf669997139e82350218b209b1ebf351168031535deb26915d815e9af04025777ef7bde2774962139eb2b843ac449a15d9ee877b34584999ca52fbee43c3335a7851f4db0c30197ed5f8a5de6f057f7cf8a2f2a4ec452c92176f2fda56117e17be576b965bcb677f64de5cb2dc15a8b213570bbc4bd7aabcf433b0a5eaaec3a23ad7a1fa82d1908409c2ede2d9288db66bc84b482fc1bbf191f38d716c719e1188870e8720fe3f043e92cb20c1cac614b60f193c73991a8d76aaa3779e9fdca805ce358a6738fc418491dbcae2cef2be771be6aebd1846804fe0711070f0b5bc43a53c00b039e070642a6c7281de4bb71dd5e93029d7bd62f98959d49405e0d65512e3f16cf3e9b2ecbf55549fe999e6386d21a9a355b15fd2fd1070a27c613e3f5e42c3b1b5fc00b9a0a82866f2e83d7bcb20e69997be420e59a28273a40e63d8a07333814c910681640579a05dab26f29e5581f737a5d1fa9c4660626d692bce1cc837d2224b62d60a6045e890b80952174f7e68b8297f05438565a0d167a821d14d1f9abc974861190920d20e18a3ba3cd37430cf2f8c26a85f0b21d2d27e157a80846dd392f553d4b8b8f872c852d9dfd069521e480d7fd69e5c974d4033a9ab3b8f5cdf4877229d5cd598d820ee57b15f3f3aa05be75f8c09e195e5d4796a6a858465f497f868e7b812b8d97f55bb5ced7776f918929d6980eac695b1e918ee9baec3d0d17ae3fa77a0f1cbcd0fcf396489dae0605031119ad95137b1bb5c8a46003decf0946006a79a79e420d13b7382259445f08b905997976b23ddd887250d35164733ecf9355a17182135b1b9e969afb2c523b57c04099d04b92768647904b6bed3656848491c73661e4249eab0cae87a5e60451969e50eac6faeba7fded9c941145aaea2df0b04a8ea13b04c86f7f3d38e6f0aaf470c638ae01b9441fd38c9f22e8b0ce23d6507f85f4a3c987facae7c53e1c3e8d48ea851736c5e11718270e53a962038e143351cf211b68e6d21b73a9900da497fa2778bdfb780aed280fa8f82669e4c279eb6b40f83feb0be48a2989fe4e632b0eabaa1d8b64ee4f29026153953867658490640c64172349dc1bab412aa0e29b9aca840576f0f14a87b40e5262fd4283d80ee648ef3092c84c618b7b4d18a7b47cf7c06ab29843e77a1379231d8df08f356a2dee6078388c680abfbafa2753d363d58cf0db6c732f8704ab9f1f9d0c50d42b40045206def14f507d86c18dbdf231585fccd8c2c2335c5d9983d8542babe703cf4bc3b3a7f89724d723d76034f4bc0d78216877fb44266fe4ecca5a2957e13fcb41a5aa6ba3735d3d54677e2c05be202844f6ba34d0cfc5d0f9a282f542e0890c56c4aebf212fab10a92197e3907418b1e2a42edeaecb79fb03d06b0c6adb33e8ace6ae491be4ad021f6191124309458ec1e9e3ffbe1f0a1b552f1674eaf71369e82cf0e55a23fc32c61e258192398f6529f2a5188de987f362bb9b676ff826b1558bf53e19e53faf5e6dba57a81491a16b34b07b21af425e40b997674dccd211fc8a10b2765d708d6c1a436a183e888c5aa32101031c6e4b90959930cf208df3984049065ce903d98c318bfb88d5028c500dfd749c24c2731d6c8464b6e151b907a57f48814142abf8dda1cbddf6633b12ddd3299db4eecd0bc9d50007f75197660a0b868b959172eb1cbf29a951492203f2875fe24857dedd7b9848251ba98a1bc4fd3e4b7d3cc6a5c195dcd896e874e61917feb45cea5b1cb8789a303a49cb9136a33445a190b606b15390ab144412b2001e75de026be60cc1ae3a8293e9e6197f164d9e22a6632daa923adfce0aae0c152c462dbd70a80931154804f3b96bf353b6d79afdedcd9a7a8bc8e995fce6eb84ae4dc385149a87ca55e59ea5497ddf9fe4ab182ad9bab53731e4cb9e55d25fd65aff286ecdceed16c6fe2c1a74848df05d8708d07791f7e05827d4625c183e92d664b758b968ed0941d0915d84699915ef6b3222ba780a0f14b9697f2895037d2342246b62e965012f4e9f25b28b9a6781a654d89f638277c59b139d609ff594e5a6dc5bca597c263cbe8de79abb7d6980d21b4bcd4159a8da965f4a07c40b858ebcb0f453ca5c05f009f23def8452349bdd9cba1a4c0d0a2033409698cf77a0a5051cdf93ba0c2f25c860371173484bbf27c8e1dc07c22ce05e5a5089fad0250aadf872834c92010665339971df1e9eb7d45590d9dd566abaf505c703b8b8967284e5a421b33968a9c078bb6d8340ac6d6bc780330b8550e572e6f384a42dec7afacdbc28d16bd29c3482debe4062cdef294e57233bdcadee6b8b0708e7e8b33f2f9459f65490ed2b93b79339086458531461d85851cb576cb6b24d4ff6b93909c18ecc2dbc8dda878c5cf4d905b7a8dbe999c4d70803f204910d3bb4872a5efdfb544cfa963bfafadeb01e0ccff98f5faf27eee825f9f0b2aaecc005b608030e82efe3357c1eeb9f02c041ee797f1ce216a2cf949d3d9afdc6ca55605a18d5d96c5d18e6aafa971ce64fc93a360505864c9f4bc58a8da93245656f2ba2524584c178e59e3791a2ce3127eb2801ca6e5c954287a02a041e945ebfe76c57bf3dc6938092e581532c564ed118e8ee387d45b0b4fa4726e450007f7042db4adeaf731465b6b8202e13e99b06cda1285764e12663d0acd77e7714f8dda09fec1a6c03aacf3e7428b8c21c8f8252480863705fc5a6d6987b308ea937c0c32835c957fdf8be1a2d3651c4b01b34bed2ea1789c9c56bb2c8d2ab87a381779ae077d1c2f587a5f052cfc9535d89e65e534b41139df45a8f1e7a6a4b53e10d8d8b24accc4fa55f78f2084e7870e638c94a8743b25b3f41084e0626bbe98c660e06f2ac728052c5a7f5d5ddb463f855d8fe6ec8450138fef232200ed7a64baec424fd84cae99ba56c2870fa8793cee504aa899ad6f5db540e537e914a97f71f1d7d41050234c483811d07c216f2fc991c58701deedde0da63642a948b5ea31b7fce0ac22160d5bd1b3e235a0cf90c298d6d0fea4a0d85997d67e14914a187a78e1772e8f6dad45f6ed907ede8692eaef48bcc9a42d2db79ae73eb84e13a2ddc6e23d566d50751347d91576557b54cedf7edb674a6f3c92eac486b07b7932f854998a31b4120aa11e0e57c8cf1aa936a3d6b958d2da03bf27274e191562c9304b5880d85ae21b5c91a3fd15002c49d8da5a4c6922b7cebdea1a4a6399da96e2dfcd4967019b283a3cc01d4d7a7e0333125b5b9930a325c0e49e6e0c2f7d0b268ccbaf10e2208cca75e258112faad82b2fa1e835249bf48c1bbcd5adcb3f5793a2dfe91fee74c989f7ce8091fa30c034b7b16a7cac036698440b1aec64c1bacc97f7f373353fdde6e5d5e9c2499099dbd283653a24a57b41d6d76cf4a1216de2f4cab98a1b00c7baad3e7cb33ba50c69132b5a0fbe52b5e59deb10cb8f1ed433d65ab7867f7b5d8ca16d3c1784b8e2029edaec273a33fc167efe3ee156891dc31b139809a0196aa4e7d607143150ef7ac386c938bbb37df9c2f10da0f75868a470fddf10e0b6a47b6a705e9b68a4cab9931a3834aa578506a769e0afb00f23ef42ad53ea290cdff51cd627a1a9e26221a0dc5bbf456ef919f7a58bca4c1d7515b507546330fe1838ee2d526c19104bd1706e9651e6e6a28b24fd397b0b7a67d2b1a28019cd31316ae278f284e7ed05461bb1c6264718fa622e59853dbed6ee1b845c6d88e12f415f5f90242bb7d8b1c3e60a3ee89a885b0f08d2e7fe30b8aafe48fe81e0898fb779d5ce48d0ad22f0cd5906ecd4edf2119228a807f89b65cd3fd8c2248f935236c17948484588b72cd8b4b9f16e6e21ba6f82c1c1ec18f3223e6c5f6e90fdf05f5c7347b49ea240681a97d041848e2a866777bbce9319615a0eeb237595f79d5b249b978857c7dd298456ec79dc45249dbb3bfd935287938aee7cd5958ff454d453962de18f304b9791887c331cdbb8e859f9ffcd1bb2d60b6f4fbae29f4fd1d84b2027e9b40ae59641218f9391b06987921688a27382cd9ce0ee0c0c1d5b644d743c6dd6c0fabb94e71a513cf12b1f39e1a742c40c36a4cdf546394977ac34775ec571fbf2c8f2c21f1478d1803e6f85e4a536db8c6dd81600da9aafc251894a85f934644041281448c0fef4ed2af575ea3e19e07b66cdf55fb9ffee020cd53bd559f9c46587069a5a0ce547070c22ab8a18ffd06dca8496f93a8f8b3c5653d5d6d7317c464273366e6f6bd82eb7561375b9884f4771f447cc6bd58a3730950882fd1f886b09eb4f9881ab70decd78f2e5c409f590e85e4770c45fde7814cbbb31dd7f91e212a4dda968fe3388ca236f58fdedd5e432e236bf7441408438ea4ff8860d62b86692d246a9fb78795a79318abd1e9ffb36928743e0efccbc9087c1d58a4980d5ad5bdfcdc97d855545831af9958fad1d8b29077f40ed7a096717e551a2370ec0cf802d588b412d1698f66267d9db3237b8fcec24f34f00bc82cd3a937fe8cd707b03609e9c6b98675081080e239b66fcb03d772be442b7e35721f6ed70007f0b04a1dd84f2c8f14daff6368480f9f49157277b23854fb569f67b99d88783e930e55cd812fdbd2e9da82a8beb4d36df3f0017a212876a025eed402e3a37f032c28a0df744b00710539372ffbcfcc52618a513480435511a3c121983618eaf7aee5803fea47dcc4f35b3de73e35a016fd438af9b6688b87a3d4719ec4ae0e21ab6997ce23af2c5c5323d449b38239832b105b5b4733364a3faa8b28a1882e55a59d0a04eb7e7ecdaf39767cec968297f880c97c6568b3af36b16f094904898dbb463e97151f6de2fd69826685097fbd3367e217e99b66dc8a35b7cf6fff22f1781064768e54056a65bfdfc7f1b79f1f49a7aabf3fce39f4ce159e4054aded4d53946eec70223d14f35459608b0ad2bc7f9ad74ee432ea1bdf37177e2238e7a03ec6575bc756c66893da04eb6ef9fb1081acc2fb962e8619ea694c2dce4a1ff33095c96cb7f77547f21329eba5f48c9059fe9954dedfb685abca55179473636e49bdc61b98e4391867cf6a5e9890f08bfc9efec0d343735aa14ccf643e4f588fb70f6fa75198cdc436f7404f02a366f31cbe775fbbc42886887fd5b89faeab203e6d871f5094913d4ea4683335a23caa7e97b18fc7ecd5d1fd4fdbe5f9f1214e1f2327e1a210ac19e02e995143ef141579760e2c5c66325de6d5854ef7b11fd381335f47bc7ed07d18e95a1cff9ebb4589a4a9002eeaf1143c11ae0b81cee89323e59aaaecbff7b0f104602a4d4961b3a85eccd2ec98b9fdb53fec252eef140c791ed1232b915c44925013b9a67bf77f6d1f989fe2710c09b575160bbad7b9bfbeffe8dc782d7e320a9fe3d1032aca97adefaa345a16f48fe9c31e49fe0ef1adb80d61957a15a80c3381cf120ea9e156d92cbe6893fc0f760a55a3b9cffd79a3332dfe975163fbba180a083ca8b0dba8d331d3fd8cc5b4fbf595199def06717d6b1437886f46df697a142b5f31112522b663b26250218d9fb60513087388b6a583e40199e618a30fe0e9f0de96a882144b36336ccde2a3a9aa9534e2667c20bcccb29603c5a5cc44b2c9dbfe359fe32fbcd862bc6c0069b67002245d0486ae1e80b7d15ae508f2893e854f6d3307f930a29951e89ffd9598350e4386ebca4eab69e632da169bf6de462025615aa1c0e09382a1d0c1ebd710dac819739fd636a7aae8ab2e64b309225be3d8de2a453320d0dbbd0a7f28435c1083bc393f7a4234c845550a727a05160820496b315a0bf4025b0313a311cfea41c98d818e620e6034d99d779a6afc7850573726091a32ea79055d9ad3360643ef196bd90bca4e4c16ef4afea02398cadb28013a8b9caab130c3f45c3f82795711a78b31254a4038a00b5b076d497295840d1b1cba3d2878d04b5f05019e67f0ac67d41abab2326d7d42911ebbd801aec56e72d34b06577de860ac0d975fd631cc414282de3d08950901fa509b208c538100a4b85246f110bf42c500767f73a28c4c003c100eef5ea63f8cc7b91446e3e6320272250768d16a10819acad1c3f6b00960cffd4649c551ce724f55602a44157e4986f4c91f81e5b8139cc32fae3fd4c3a5b90b75de74e847c23455af370fa0aefcc8ad92e1fdbc7a32f17b425195bff3a48528eb2144d97988f19908c45ee329130fd9643a606cee3a0345ded9af3405b295c3d9bade07279baecc5e102902a10a03437ae83d905c61c758b968d87acc200b97790967bcc27c61726e1c9a6d3c3a3a3a494a7edfdf3aa626c9dfcc43cffc8f5bdb1846eb4f5d4f8e2eb5ca9ad6b8d16cff8e4e0337858ab84f63104ad9dc7414038bbfbf0ac381af3f75e5d5d9c4038d81a5a9d432bf7a03ab9a7380868961ba536651553846d93fd0e2735f1e9db769ab6d136cb7d1edc2f400dce84ef0132d1fd4499e9492a56fd8c44506c5e890b96b3d32feb01dded445a8e896bdae27e9e28d77cba23b52a84ad337fef54b777d87bf0ea24b2f414ddeefd0a6952d1aa3063e6323268b643c0d85a3a1dd4fd11518327ecbebc2aea27f15a0084db77deca8c5878718f1a51dc90756fb6d63e9c10425dab795b3be0899a5fac6aa5de2a85bc0a27abc2a4645f8813f0af99c83708e101e111dbac8f625abbc0710077c16e9e11db20ec28decbf60f872e1b685dbeecfbb148fece8016631425dbb0a91ec49d5f7402a67120173369632f11cdc74cd70abca2f546b8c6a4c77f952de9e078ba2fcb7ce994b843ce748b5f9ea297bdfb98da33c481ab019fb9ee95f93bb285a91c904fb0c7be1d2f5250799b63720397d9e8a1c1547753934a01b8623210b38c1f802242e754c32aea6a463a30a862ef8de0c4cfd0f235f5b6a9fd2edf48b194b88c7c240df61a63c6f69ab42b33b7f368693a2577039f7656596c31bded7169bd52f8c84480f4a2455dbc180c12b47e754f3fb215ca6603224f96a0c7816fd4af07b8842a1af4ddf1fb2f421dfd5f860fa39ed457327e21509e5ea99073eaf49c96bad13ae53f119791d703574ec812e98de6c784e0711772dcdb1514507a3898572630fa1055c46b88ec4548ff8a573a8c5e3b5dbe55f0d36605e93d9d2d6f514c2d75be79c45dfbb1bedf1a36cdac1291ac8f42efca398d798f5b5d83328fa7cfe665da8920361a1c203e520d909afd6b5bbdd56f626f8ca4158d6761d6e4bb940a147e92fc5521714a8c648609b84b61caf86b64436b6db804238b969b8c0de1e3a127c5168b947021b66a2ecc8130c5fb86818ef17b0a8f09b7f27142010020d8abee1092ac138b8bcd7896e28c2488dcbea71baaba705e6e6271cedbe89dcf65994d0b985bcd7a4a966dfd817612fe581d0aa55ab1ad335c827b223255d489af809de74c41a0d488a79f7a5c4add0eb536dc50bed3e093224bde3be889be49f9ee8158982db696e8bf84ac313c63f3b38705da8f8e1e98fe55a800be71be08139b05e34e2e5e5d9110a83e291ae357ec6be442f64d25ddfcee6db08c58d66ad9c4638c8fe56b2fede260395d6b09d175f79906b1b22a164258ebe0175fd1e7ec54b5e099c8560d90ed76d5658b6a77331ef432ed6eb95f0459b26394ad920982c1806d99f59290573282207698d90bdf659a357b5898f9ab20858e079ad0d0e45e658517957aac5fce495a4bd55462252a045efe2535ddb81e481768f0b28e18cb1aa5f77229f059f6270ddb4438bfadd4c5a3dcf55cee8301f667d1200f8c76c414018f9aa6d124c25df85d075e39ba1f765e4368336a73bf118d859e28cbc612ca3bdb5ff8c4430cbc14550bc45659040035f8808e6430dd80b40b158dda449891486e62af63f2dfbd1a835ee2de29c2794483d728711d32f7c773838fb768908f2b0f29db0305b88b906baf4cfcc4c2ec51a554bb1e52e71ce7f87e9ea8e9a1aa0dffb9feb72702138a4d3a3be3a236fb255b3c67be328a9773b9007dc18dd68b73288f62a54d2b9c7d1e29982b5e82c77e90fa539d22b69e294c5976bcd9ccecf54d37049c71d91cffc4f04e2f2c490bab87768ebb6d92809bef2740558528b8deb2ab545151a1b4816a729595243e20f46061fb0ac9fa3a0b65233f3a3026d5217202221f093c6da3b2b2fea84fc727b5d1f5b4c5bd5f8e9661ebd0b4e3376ff233adcbd364c2580703f29cdddc71bbed47f5c50e604da7945d4fda11573a2e2bc54ef97e4f0261206047882d20415e2978058f8168929b8a65719adca7046579726845ca5c32249750ae2e664f3c890d6cfd8e0a925065b1724fa25b99e13621a52020a2fe828230a9248973de95fa775845b9846f3037b22f410f0531aabac968078ebbec6fbaa2b301a4999f3e8fcd433033973f7542aa3f38592aa07f8eff2918ce298093f58d58c539b88f2a800137e2c35a122d7a5bba6e6137ee5a4cfaff24a71bc23f10841f007db04d64b4ecf597ac4b465707ef80352639001931086299d0f4f6764975aa2a18871ec004df36767d27b5260520ca4fabf6f99ca61c08adef24523a71bf16f8e36c14ab69204f8307889f8029847fbd377b187d6f6ced97f2083744188ab417cabc74d5181adc7ab78e65e872eb6d054b315e2d5a1ed874e137b0c861a7c2d275d1c14ac2cdd3e5ea4586b899682e295804c5ddb3e9df6612376e108316801016b56c430763a924de9fdf88a2722cc2c31d44046589026b8167a1a009df093b3cb8aebe297baaa1f94a203111259b2655af1556bffea4bf6afe2083d74d3ca6d9e279fd8d77e098b7b60b1cf371c2c295ccc367e7feb8bd538d02f72d24675b87c82a8d38952ea7685073249f521b742b146addb29717169d2c2b6e0fa40fc0793d5d5a132986dfdf105716b2ed3e78c709c7223d9a1089a1083df8c83ee198893b2da982e8d42721e96649e2b41940ec91a3b827880940ef3e047e7e88cc1ee03a6c776d7a2041e1d2a0d1a11811ef599b2eb90b21cd86f114993ef0c7d1b3a122b4b18e98a16189382e33811c462f5db2fc2b181a3cfbee25114d8aef304b90182fb0ea6924faa96428f7186ae5935cdf9a04a257347e384fa5dd996452012cd3037d83774106dcce4a55224e7b8c166e6ad677cb260330a56afab8d29b3911e1cc74eefb69e0ed9eceac049c0a0f88d0428cf4a72526679b207fc72de6e4414febe37ffa6ba2cc68dde7d137ab852b98db6e933a8964daa47b8a1763c53e965bf265a24d4770bc9d890438549bcf949c2a86b6cac121041805ad00e4653a596127fde2fb3c066f13093eec4aac3ad45bb3d5692e9e42e65939332cf9b66cd02955aa8c537c2900804e519f95c3d84d1cd7a244cfb15325f6d87a292442aedd61fbbe11c821f4f3089e29acce70b07f7276d91c8903d8c65f499d204306e5a00911fccc3c7e71df0d84db0c4655a8b4f96be59478730da21e2531ad5273e447778a08e641200307b55d064edee181fe45fc4fb30b79f40130c2dc85ef4b25c68b8defd1be0642756868778b51cfde5dff6b674836d39ac16668446949d498c49dadc4890006bdd583feb27aa2f1f3ca67f90dea42a0071a6d348073960d55a8795df58f4081d1021f9a5c7f3bcf514f35a6bcd70ca509c18a4c412402bb50328bbae3d424f79b999d3589ab17b437d5f97a2b1fba2e2fca6300d38d86369581243ff31a8c7031d67c79d6121b5e96bbcdb1c345207dc596e6fb344403746b2f9ab9954a80c68fa6532092ae5e2172666302f4916df0406ddbc47b4afe5d94f778eb8642a8bdf49a2d1984e6c34b5b308fd5c12d4c8b87242fc509b1d45e8c3794eece56691b38054bcc6633bbebd3a631caaec3f2a4115bdec30929222650df85f77338af44f7bb681ad13d4ab9ee8168a7342229571db2c24cec039c1b6e8cb1ca75ab3e3db756d0dcd0b8cf39201958562282dcc48be8e286e67163c8d730f80b3e8f26ccd0545e1308bb09587e6e503e20cb0a2d94d69e26dc02465bfb923c7b2922de3746c1be72149d91b89dada82424cc3e8a0b9ec7f71610e26897361fca889c1260a4308a08e4e46dfcd7488f4f2a687e01767da98327042d93090ae00aff9804ca2a3e9aa88186dbe06dcb05cff5c5037481c011e52e8bbb3b47be1ba31c81cd566f493b03d1c878e040846df8dcb8bda0cf1b18b4b993b858703e8162ad158b4d7d38b4799b608e2328ac1f2e729987affc859867d677b918b0e14adc53ecd1d4209430126907c1b53a441b260f29a71fc4a868944f81a6eedad5f220bbbc5f70ca01cd5cddeca5d021d948533ba19d84822e482ef5939538b8c351e2b881726edba07c609c34a80d194324f91e9c343f93e55d1d511df082415f55cf705721284d69242620ceda9d63f72c73e43958dbd058889c93c7842de9bc568668993138099d02014ce1181828e8de79cc23cd9d352b69bfc13f32831db191ffec047dbd1e273e99b511b92703fac97fe35059d5ac8366a9ae2edf292f693f89ce0b9f4332a97bc4d7d624cd656fd45e59566f56c226755b4fe20decd098c5e284ff61e3942bb20dd5cb37e286a55812b02e1db4cfa2f42befe60f7ddd745d666aecf6c4e2a897ffd44980371d6cb54f3eda2b538e2579285aa3148c87e0986aef2c4bc63a7bc5bdca969e06f971503a6fa36cd4d89c1b2479cfb5701cd27c5f8601804c9a69eadfc735b53dc3f19a28f3fe6c26593aaada94b56b2ec79ddf047e7e186ebeecb29fb5728280204c0b3c252d23a18ba7add0310c782b16dd0baf3c21a082a1359f101d4c59aeaea99fbe4a58937f772b85b3bf6d3a54ffe0a1b0e735a55d6db542e118b64e052e5e912296e372a76346441b8c7ef65305972b7f960c12ca735a2ede2e5bb266ca16c33bce21c533b85a6dc7a1de13d69ed48addfb108d5e132433c13e17409929a8ed5bc87063e492d2845eb983c385c08815a1396f5509c3cb8813e211dd6c9734df201d80c80ddaa8d56f3ccab54a107813f5b3bbdebe76ed347522ab46ea35fc73aa1858b9224013078d32a518f7ddd933b104b306c9981d1636f621b2b8a6e1184594efb1627c2c13505c66c5d948eeaa61c991fadfc3383b81e5a488d934d472e90d2718f916d0a0a6905bad200827bc45dbbf4c0864a0c965b3254a40778a4036135a414675535befedade894abf231c938eb8fafcaa95853e171b54be3dcebf53a07d8c494bfdbf6f0d0f335ecc919bdb7e0c89675a6c749c81fba938e45c5b97155f5f2558ec831ead46a3e452cb181e5f0dab5fb072d0cea5777a8fd9c234e7d7606ab543431339a014349777fa62ac4070e40a4de12cc9113a5cb1930268bd51415c80ba6f3b7fd3d7de560c75e3178222403445fb154b1ceeef99970505bb167abd855e6aa85f1a661d3e8a8ddbac6e7a2983563788275261f7243e6e5f309cbd1e196d991bae7bcef917efa610c6986e199e9221b15dd8c1472923a7afb7c8be2aa71aff54bae2e35f692c495b6274f565e623cd6daa1ce25e2f204ec226a2e3676ef51a49a3556de7c3d9600e4ba4d5c8ae48709ac775b1c0bc45026a7b527a079e4fdc691fa9fb365aa39cad76adc719b2642490ee63033d4a4f03eaef727e042ef5c615bbc6258351fa9e0df4a9126e18024cece4768cc0b756012360d2927f13b9151ae5606ff333755bdb497f59a83ad1aef4a3361020fbb2f1b82fecc9f62a49440913a7227bac91f9f4416f7bc51555b0d82f0b8311a9cc40df832663a46ee778f9dc1111748039888929cb61d7a881e7765c4f02c31be6fc0b93907a0e2c9421597ad6361fec209635d7e6d5fb5e71323e3379a6677a31672688994f79fcf8da4cfde9b79f93d36ffb9129eaa0ccd7bc5b6dbfcd61b4f9abf98cdd44fa1ecfc483a00cbbc750af08824c226cb226673bb252a2a3f7c09eb3625bc6471e5378c94a1f8a3a18202753eb02d3d01d632e6f9f124b6f8ea139d03240f5b6f405ba99341c684112dad7c69e0ede8f78752e6859b009213062e733724858327c1fb76fac9883744032cd4035bca512e3f33afb72fd57753920fcf990a3a0ea527cb46a91f45a2e150c431be3c42358c166e66a684c3787856f50a8e1968197967027a8fff37df15b3570661aed85b3066c0d69aafe7e94db2a2370818ff951e31e67ebef7e9a4b3069a8c52fce655afa3087f02158134101316a465fb681b228cd9e050048864a2f614940ecfbaf0db06097e3d5df900cc37d71385bafdd0c772367e74c9b820229e0955fa06f8032cd8b1d89220d80fef1c2d4a67b52dc199a2644489321c438f6a937529879b74bccedec511de797142a001effd5412e5ff26860db2ea29ff99781062e3939fbb5d54fd4e13f1df79b3517904fc72d2ce2923486ee6fd30c65b4179ec0fedb992f6b6a1114fa8ba576efdc62f829b9446cb291795c9dc1125013c5e405bc58288de7dca1beaef954fb3abe85438847d9f9b7db3928e69038a56bc309a7f36fbff0db5198374a0877aad006d0ad60f8bfb1130eb4f2e42eaf031c61ac6ae167d1e3c9e33f2520e9a9df47cda24ce8b437290faaf0369033ed6f3e9bff1e49c0ad2e5ef349b7baeaa059f41f57b0b0c0d79cde6634803fcd441368451be949cbc80176019c111d1180f435b69aee24b20d8537671727cdb87a993c0a04feee74fd566795c03b97418e022de9e42a375eed10cfb9af1de01a6da424fee5beeac57b6dc434333b99a7c7bd8dc998a7a09c833285ac74fcd6914a81775ab81c9ae1dbf9d979dae6178aaf29a3c8945054296347c521457b8761eb2092b95082308e6f9d170d537bdf228d806199b0f6eb5d2057c6df1c69c93e037debfe1623924beaa53adc3273d75777e47886e8fba42a233f561b02bce1b4db4a3a795e2f802d4d8672b1375d108d7ef3a6b5e6752a90908952a32f2a44a81b1d5c12a5f6f3e80f273d33e740d6d7d34270cf918cd7bf781a64ceac65dbf0ff4db0875c31101baddf055b1bbaa4c7d388911cc8fa01dfa5f07921f22c9decd1567e86bd3c39c5eeb381320c9d7b6dd57d22cd7354000192aaff7d9dd6a1ce133a7cc1e84f0b9d32f8b4c30988f9297dd2b528621085e43b68ee2ee14031056b8320f3dbfc8642e60659daa8c50494f04414609c15196855ed18ed956bdaed69cf3cd6c340ec52de4ca33dae49a494ca7011513d1e6b30fcc302c0c05da5d0fc5badd22c220b25623d0381c868d284dc90efa38c4a7c2982293dfc857d8b331e85123cf6fc1548cca86a4f4c2d05f66bbacd15f6ffdd482f309a392988e20d16aae280b79f1ab2a0911715139af6dd432f7b5992948bfad08143c32e76d51bfc0cc202c73bd1eab990caafe874a4a480b6699fd0d735108e8c3671e0b1cd462ba07cefef328be621815d0efba3f449b3fb3a9b70d356de1381b250a8c3f79b9003f8ec3b916ab49e955467bec92480e0b1a981d9303d3e61c7851ea41958f27550a5570f9a4d2ab0a7f6c3a64e1b908737dd0d17ccc0ccf027b399eaae8ddc12d9c7f43b0616967f826668ef7bc7e5e07b3fece8d16a4a9d3be23afccd549840020e02e4faa010ac49c4dceec5b64be9a9361d5313bb7eb3e6ca85bea3a5091a84d5c96d35b70ef5cceacadc809510587e12ad902a28440bda73b4b97606cb0ce303ede7a7c26426cf6185339bf14fe475e0aef8cd323769aaac753ab966f1782dc69414e6368c6afc790a247d5740516dcf8706ef81b102fc29e803d051ca1fb6d330b63a5308f9025e2382e20566b5e56ded6e95beb22b9668a1016cc4af795565eabfdf87fb4fdf9390496417866bbbbdf28b87200ccf8e98be4d76501e9e084115572ceddc621f447553e4e95bc29e4e429e9a6ebd7c82cbf7513838ec0a1d8c2f32803703f69594c0e8eddc743e24af680ebd081b15c442e5c89dc4dbdb8f7e7664ce3304ade96108040281e79402f0e083c14f81c9a7d53c2d9f8ce24740c80b66ac3baa1e664a8db9cc377fc1e32cbf5c541988b2c5f7e876560266e1f53727cb3e40485a82ef0a7a123c07bf77eb0c59c0fb162ab496c3384863f95791512b36f3d1cea83252487d34f5f678d70abfd955b07be18ce6df0cc008a597cc143cfa5570da17da922ea3b8f8fb68a8db9aaf41ae5eb9c8b65560b4c5d06fb0b076d15d6bef814a871805ee2cf6657aac6631b68f2653fe86e9f9d3b929642c3882a2866c6d423ff7ee8e8c5548b58f37c06f81d60628b98c4c9b5a783eec684d45cb81da7a688b2ffa3275a8975e54b5f694da59f6d556d58ef2821b86c262f0fb5345e540b177e70e75de2f351efe4cc9919a790a2efb64f49993a21d6709c69d36da6457e012673717e68ef4ffc219ec8688cb1da0f87ef652b905b5882f8b8c50901a68bf1a7940f1ec522662c09bbc1970cad61a3e259bfa22ea012654f49ac251e30fed9718118ad6014d97cbde0fa86b33e0233907ec9f45d89006fd87c9a34aaeef0503c7b4e2d78a32ea835de0a0b2a16fc2fdd5d0b3b7f0cba087e47803e0956aa89eb2c060f6de9437cd178bdcd3556a37f932bfe2a57fb47d80759c3f6a298eea93e78eae986e283c174c8d3580b41e3fb661d82194f3f9e5256a24665261e12b7f562e3f6ce67eab22aebe4b8d2857442dacf9ef58f1b1495e4e041dbcdad831784b051cff0d895652c135f11f9ddb854b733700e4bddc4e8667045a1d87d5b263a645aa6f6cbf414d6187cac80899fb9859f894504d8eb555f373dcfe0b8c1622384045b88dc0608fac083abf03d1542c2a9ebd7688c504824db0d37735c8ffbd72a894ce99f1ada7ca871fdf9899d441897522e1bcf4999fc64b157e66bff4f11158076ea35d61fd5a30ead3f60657b3d0a946e5833aba88f716304d55accf5c0c4ff325ead0c61509f335a603ac520e071a94f2eb6a8d65ec6f366106a7addf9bbb9edb9e56596e6f26e77d98d5d54ae5ab3982c6be59ac1a4841f4813d9f37c25c1a52112145ca3046b0d66d552a95fcc5214eadba3890d84883f4f5c8535bf17e6929046fe712bc1de9b43a2a83e657b42915b4f47bf6cb78c6cb5910fcd7e407e7f334222294b04ba907d3a11dc2cc2cab55f2f8326c47571c01620fead91802250fd284333b5d4cf7b70ec4707be487c5ac8fc4c26d3fbda2651bd323432a127e6cf751f3918dab33ba1b6e0b4c6da756afc68115092d883d2da4596d2eb8935d565dd600cc36cfa1db063ece474defb06a4b37c633cd32d5f4a3e4b424fd016c0f5cb4009b07438a5e1411dbaa31aa4ffdb8d7dbf62ef7fdcab27ec54151b82daaef4a9dd318bc31322224ad4ecfc56034d92315b35332897fb69c5d72a8f235f2cd91009834587fc90971efc1dd98299ce1141e2dbd858bfd024283d7115b47a6fb95ceac11e609faedf387f1d662b32b900e92adc6472f304dc52615111a55a4127ebc0ddf0305b6aa767454eef741ef68d1c6f1a1dffabb4a453ebc20a3fe58804a7811bd4982a92466e15f09d6b41d846984014c9777890b50dbfc124696b8497248f85ca742531f324d576a61942b9237a16ad2ec836a87df6b47f0e83f5c41c7c82691d4bfd13cc74230e7209f2ac6099467a41c316ecfdc9d151ed456e0dc9c93693d06f9dacbd1cc9a8d1479731652eb226591f18603498d3887c5793baa725a2a4de30f8054624ee78e2f43dc3f478e3b404f43020a952a76c004364b2fb1eecf564fa7f35da03789cd666f59b2de9ece8b2256bf99ded37e593723dc99e18d498b0e9b30e2f3ede58008164e896f2d8bae39a2da4e560ba70dd3c2485f3bec7b228555a7ba30980999f6755a3b101aee07fbffbde2bf78cbefcedd8f7c38461eef5b3f1e7877278b270d35e5563589037b646d1ad4aafdb1b4881d10c67b8994e41ce43f57602af6e00837cb5d1d3c2c3d2e6fea2d99a72b5a04d21b6257e6f404012c3229aa6e1ca301536b386045cc6626536b8d6accf46f4959aff4c6dddab6ee184ef1418735d7eb155a32490c6c63db397f37c003f8540730be0bfb5eec4e42904980505cb3244f8a878607b80e02baa44782de631b5131a3ccf2b874505a42ffebdd809ad093129fb6abb01db9241aabe13efed5458b724d3e8e8f6bf6e6eea8d3dd051ae4e6ee0926cf094fea5fe79ac9e9ea182e45318881c746cc056b42031fe145f54c81423c94294b35c3c67e0d535def286d8de94050f5e4eecd4c7086d99b79e4513c977d0305ea113f162aa632274e04395582d7b179431dde440f19daa1235687d5be9f9a8da4936b9bbbef1963790fabf87e77e140fd3ed65e09ec57982c685ab7e68416e77dd5ebe5c3679542fdfe0c36aa343857566618e8d0c7ba6d71490a520ef854be68860bfa85e6ecb456723fa813019dcfda533e12d0982047997b23977ddbece260e1b3e66aeddf004b393a71de4282520ea1a909a5e59c803ae530c1f925e03d34482ad9a0fcd014dca88467d67ea1542a3270932e9e9d454b5967bf1f07e908cb4070deac514d6da0c04c7eba4f8ba50a23b84253a11a2c9c9d64bd20e61dfcc620eecd84e0ca02f84cc9a5d5791b2269c226380b628f6d76f2303eba7fe2f267fdc6c0963174772c284619c074d6ddc7412a1934ad78ab72d065b99c4db36496142c9b1329d5d35eab2b7f0019287d46d1169d27b25d94e1652c5a718042c74a285a788cd8943cdfc3c6f709e761aa919790baa74ea0a0166dcb8ae1109eacd7adeed4719d93aa68249345ee22252956ae3b3f66c93fc8454c9bf2257bb26cf0570b7e45e66280724d7d604249f6529528d928f9df5135c995e74b231dc0bd3a61fc2b33a6916c47865fb648c3fba147db1bf6c1dbf2e9ad5ac48d138e9ebdc6085016f422a580fc3c7b40dc9a59a478b0b2e73a1af5a6f66a6e5d4eeee6d0274ee63646c3461d4eb487630d8ac548fbe27d3169d35a7fd44b75907abec7422bc9a4d8792f9e87a169476c0886b2f1d4d6f53f7cd46346665e776b231afda40932ca253be112a9d06b12dae8e5e1a97541ff995ee72258fa34c93e43be5fb2773beff09c8c9f92d5da00d9f967440fa57062cdac2e1d797384090ca8584e27af02830989dff5ecc2d5d869ea6e441fa3d411f74c611bd3810719daeb5e3b0fe7ad64454ced6c47dd8df2b51006dfe2be73efe98982ccdd1c7de979d76a65b109f46abf25be04b364193ee618939aac91d9e62ae998c6358d992d41caa9f283fd7c7ba1303697859826e79f316a9031961b54ab6bac44ec3e37e94704e30e40f0011660adce54a9b5ba0eb6d4c5a57205d5aeec13cbec01e0564a3e857961948c4a0f2770579c9d35a22556ade5fbd4548e2ba50a6d21961887e9d989684931b6584f1294d11842c1748a3f539dcc0ee70a377f31046a649ae9543d98e1e43cc48a96c67e9810ca7bea34e8bf16711486eb15b11eeb10d564f5f5db3dcb9c567cf1b10738bba00be7b6eef95a74b9bbdc16a396708c975691e569ba509857dc5bcb16d3d077debb9729c61778de3ba290ecf75f54a1ed7a12cc021c5cf46298e572d0324b3a2e69f7a3fbae2d5eb677e84fd0be1f9ca985c0ab06923e876f4b866c7d6f3ed6d303d2ff4ada8cbc334aab99fc3b50cc44511e997070a656a03dcf300c44ba3598cf8a05e8524b8d963d862a193765d5dd31f019cf46cb212c74d461fbe968db73afadf475939e21535de4124a708ac1256d894e9757547d21eae544c5c9e4b22ec24d77eb6ba833159e62dd94fa38adfbc0be64a9f3db3412f2b5ef791ae945527dee9f270ace9d75e79bf6791547f7bf99da10209b78abe2f3e303a207f2319d9aa8eb4e145875d12f3b2662176ba2e098fde6d271ea892add554a22b120c973870ebd23e172101f5ba5b94fc8319d5e274f3aa4e6d1b8627bf58d99a7a92e9c25bbc4cb205bdec34cb7bc7b23ed867402b88357e897c05b3cb32d86e575cc5697f149823b7d3be5f1d09f9e085ccb283473333bc62dc1aa60bc8c9e5fb8435403d7e4524ab3d2666bd6f88713b1344638114caca9d5aa3523d579905bbbf23fb9ec9b7641f9fc0782f0f0033b978f909af937cb6d228e1ffccb42b818563749abbbd4ed1921751e37268e619a7307df07b1b3ccd1681a8bbade5e196cfc3d58ebc58ac4a77591ea8ed7fcaac7e938f4f4a70a66bcea4de706bcb0652d91e1e7148952746e09b2bb5addc5614f68fe997a4c8931f98b05c71de61b41945245cefeba7f16cd4cdbdbf8d6747811babffcc0df9f071f39c94ed59541aaa97c150a9b6742226c545c03ccf0d1c2a815298fd86fe649bdbec4fec2cde533e99fa189d177f2339f5976e92a9173ecd7cad661e839f39f5a1161e6f96eb8bf4813577ec40991a031df867b4694c2b0d27e39e2e117a114be78741922447676529ca9fcaddbcf2f4abedc26dba280a0d837c79a88aa683d4f49fd22247458062d66cacdf601c72f6abe26919fa6eb79c7fc34680f50080502bda33142fe93346cc1a17054800b5b1d1f46d60ff4c5c461efb0c5d5509710ed6a37558bbc1c84231c401619e05b373e0de0b1f4b8211c9eb2f555a5823d1c63d846e6cb3ec9d5ee0b40ab59b7ad4167b8ce0ef85390eedb5be1812ebd3d38fc4b5771e8890307beecf144e95ebeb46971b0b76d4d83fa31175719a504eb14f29a864f8de1c36ac252c50b110154768a024e71fef2c934cbd93cabe8eb509b683713fd10214405eb200a9d5801b4946c7112b4e81282325c21c88c836396c622378b0c63a3e93aea2f3d56136ad41ba2a9565fec51f505a15e137b6c853c77def8e0d7191b04e7c8f5dd8822c7bf303ff78568c896e735a2e773ecebce544b55bd19dfa05d7ee87955e9f7c932d487abedd13dddb1033fc488f64340bfa4feea3e09ea82cacb0391ec7e880ed1b2331d3c4d22f32891df3395f070f2314ed8c5af318005fb361cc15610d52b6fc392c6a9542f2e968010d3c49664b16cc97edb36a903fe6d5bd9360cbc94a98cfae9e695947f4361a87b4b4a8d9c1b7ca2efdde84c7ac9aa281a34f2b3aa78bb9d72e8272f562c 你好, 请输入密码。","summary":"本文介绍并发容器BlockingQueue相关技术","date_published":"2023-05-25T14:34:05.000Z","tags":["技术","java","java多线程","java"]},{"id":"https://blog.hanqunfeng.com/2023/05/24/java-concurrency09-container/","url":"https://blog.hanqunfeng.com/2023/05/24/java-concurrency09-container/","title":"Java并发编程--JUC并发容器","content_html":"<!--\n **加粗**\n *斜体*\n ***加粗并斜体***\n ~~删除线~~\n ==突出显示==\n `突出显示(推荐)`\n ++下划线++\n ~下标~\n ^上标^\n 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.\n 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600)\n\n +++ **点击折叠**\n 这是被隐藏的内容\n +++\n\n::: tips success warning danger\n这里是容器内的内容\n:::\n\n% note info % success warning danger\n这里是容器内的内容\n% endnote %\n\n -->\n<h2 id=\"摘要\">摘要</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>本文介绍并发容器相关技术</p>\n</li>\n<li class=\"lvl-2\">\n<p>本文基于<code>jdk1.8</code></p>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"并发容器\">并发容器</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Java的集合容器框架中，主要有四大类别：<code>List</code>、<code>Set</code>、<code>Queue</code>、<code>Map</code>，大家熟知的这些集合类<code>ArrayList</code>、<code>LinkedList</code>、<code>HashMap</code>等这些容器都是非线程安全的。</p>\n</li>\n<li class=\"lvl-2\">\n<p>为了保证线程安全，所以java提供了<code>同步容器</code>，可以简单地理解为通过<code>synchronized</code>来实现同步的容器，比如<code>Vector</code>、<code>Hashtable</code>以及<code>SynchronizedList</code>等容器，这样做的代价是削弱了并发性，当多个线程共同竞争容器级的锁时，吞吐量就会降低。</p>\n</li>\n<li class=\"lvl-2\">\n<p>因此为了解决同步容器的性能问题，所以才有了<code>并发容器</code>，<code>java.util.concurrent</code>包中提供了多种并发类容器：<br>\n<img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/Y7os2P.jpg\" alt=\"\" width=\"600\" height=\"600\"></p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>并发容器</th>\n<th>对应的非并发容器</th>\n<th>代替的同步容器</th>\n<th>实现原理</th>\n<th>应用场景</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>CopyOnWriteArrayList</td>\n<td>ArrayList</td>\n<td>Vector、synchronizedList</td>\n<td>CopyOnWriteArrayList 内部使用了一种称为“写时复制”的机制。当需要进行写操作时，它会创建一个新的数组，并将原始数组的内容复制到新数组中，然后进行写操作。一旦修改完成，新的副本会替代原始数组，成为新的数据源。<br>因此，读操作不会被写操作阻塞，读操作返回的结果可能不是最新的，但是对于许多应用场景来说，这是可以接受的。此外，由于读操作不需要加锁，因此它可以支持更高的并发度。<br><span style=\"color:red;\">需要注意的是，虽然副本会替代原始数组，但是这个替代并不是立即发生的。在修改操作期间，读操作仍然可能会访问原始数组。只有当修改完成后，才会将新的副本设置为源数组。</span></td>\n<td>1. 读多写少的场景由于 CopyOnWriteArrayList 的读操作不需要加锁，因此它非常适合在读多写少的场景中使用。例如，一个读取频率比写入频率高得多的缓存，使用 CopyOnWriteArrayList 可以提高读取性能，并减少锁竞争的开销。<br>2. 不需要实时更新的数据由于 CopyOnWriteArrayList 读取的数据可能不是最新的，因此它适合于不需要实时更新的数据。例如，在日志应用中，为了保证应用的性能，日志记录的操作可能被缓冲，并不是实时写入文件系统，而是在某个时刻批量写入。这种情况下，使用 CopyOnWriteArrayList 可以避免多个线程之间的竞争，提高应用的性能。<br><span style=\"color:red;\">注意：由于写操作的时候，需要拷贝数组，会消耗内存，如果原数组的内容比较多的情况下，可能导致 young gc 或者full gc，谨慎使用</span></td>\n</tr>\n<tr>\n<td>CopyOnWriteArraySet</td>\n<td>HashSet</td>\n<td>synchronizedSet</td>\n<td>基于CopyOnWriteArrayList实现，其唯一的不同是在add时调用的是CopyOnWriteArrayList的addIfAbsent方法，其遍历当前Object数组，如Object数组中已有了当前元素，则直接返回，如果没有则放入Object数组的尾部，并返回。</td>\n<td>同CopyOnWriteArrayList</td>\n</tr>\n<tr>\n<td>ConcurrentHashMap</td>\n<td>HashMap</td>\n<td>Hashtable、synchronizedMap</td>\n<td>在JDK1.8之前，ConcurrentHashMap使用分段锁以在保证线程安全的同时获得更大的效率。<br>JDK1.8开始舍弃了分段锁，使用自旋+CAS+synchronized关键字来实现同步。<br>这样做的好处：<br>1.节省内存空间 ，分段锁需要更多的内存空间，而大多数情况下，并发粒度达不到设置的粒度，竞争概率较小，反而导致更新的长时间等待（因为锁定一段后整个段就无法更新了）<br>2.提高GC效率。</td>\n<td>1.共享数据的线程安全：在多线程编程中，如果需要进行共享数据的读写，可以使用 ConcurrentHashMap 保证线程安全。<br>2. 缓存：ConcurrentHashMap 的高并发性能和线程安全能力，使其成为一种很好的缓存实现方案。在多线程环境下，使用 ConcurrentHashMap 作为缓存的数据结构，能够提高程序的并发性能，同时保证数据的一致性。</td>\n</tr>\n<tr>\n<td>ConcurrentSkipListMap</td>\n<td>TreeMap</td>\n<td>synchronizedSortedMap(TreeMap)</td>\n<td>基于Skip list（跳表）实现的有序映射（Map）数据结构，是一种可以代替平衡树的数据结构，默认是按照Key值升序的。</td>\n<td>ConcurrentSkipListMap适用于需要高并发性能、支持有序性和区间查询的场景，能够有效地提高系统的性能和可扩展性。</td>\n</tr>\n<tr>\n<td>ConcurrentLinkedQueue</td>\n<td>LinkedList</td>\n<td>LinkedBlockingQueue</td>\n<td>ConcurrentLinkedQueue 基于无锁算法和乐观并发策略，旨在提供高效的并发操作。它使用一个单向链表数据结构来存储元素，并且保持了先进先出（FIFO）的顺序。<br>ConcurrentLinkedQueue 是一个无界队列，它没有固定的容量限制。可以根据需要动态地增长或缩小链表的长度。<br><span style=\"color:red;\">需要注意的是，ConcurrentLinkedQueue 并不适合在迭代过程中进行修改操作，因为它的结构在并发情况下可能会发生变化。</span></td>\n<td>1.高并发环境：ConcurrentLinkedQueue 适用于需要高并发性能和线程安全的场景。由于它采用无锁算法和乐观并发策略，可以在高并发环境下提供较高的吞吐量。<br>2.生产者-消费者模式：ConcurrentLinkedQueue 在实现生产者-消费者模式时非常有用。生产者线程可以将元素添加到队列的尾部，而消费者线程可以从队列的头部获取元素，实现了解耦和并发处理。<br>3.任务调度：ConcurrentLinkedQueue 可以作为任务调度的数据结构，用于存储待执行的任务。多个线程可以从队列中获取任务并执行，从而实现任务的并发处理。</td>\n</tr>\n<tr>\n<td>ConcurrentLinkedDeque</td>\n<td>LinkedList</td>\n<td>无</td>\n<td>与ConcurrentLinkedQueue 相比 ConcurrentLinkedDeque 是基于双向链表实现的并发双端队列。它支持在队头和队尾进行插入和移除操作，保持了元素的先进先出顺序。</td>\n<td>ConcurrentLinkedDeque 适用于需要双端操作的并发场景，例如生产者-消费者模式中的多线程同时插入和移除元素的场景。</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"CopyOnWriteArrayList\">CopyOnWriteArrayList</h2>\n<table>\n<thead>\n<tr>\n<th>方法</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>int size()</code></td>\n<td>返回列表中的元素数量。</td>\n</tr>\n<tr>\n<td><code>boolean isEmpty()</code></td>\n<td>检查列表是否为空。</td>\n</tr>\n<tr>\n<td><code>boolean contains(Object o)</code></td>\n<td>检查列表是否包含指定元素。</td>\n</tr>\n<tr>\n<td><code>Iterator&lt;E&gt; iterator()</code></td>\n<td>返回一个迭代器，用于遍历列表中的元素。</td>\n</tr>\n<tr>\n<td><code>boolean add(E e)</code></td>\n<td>将元素添加到列表末尾。</td>\n</tr>\n<tr>\n<td><code>boolean remove(Object o)</code></td>\n<td>从列表中移除指定元素的第一个匹配项。</td>\n</tr>\n<tr>\n<td><code>boolean containsAll(Collection&lt;?&gt; c)</code></td>\n<td>检查列表是否包含指定集合中的所有元素。</td>\n</tr>\n<tr>\n<td><code>boolean addAll(Collection&lt;? extends E&gt; c)</code></td>\n<td>将指定集合中的所有元素添加到列表末尾。</td>\n</tr>\n<tr>\n<td><code>boolean addAll(int index, Collection&lt;? extends E&gt; c)</code></td>\n<td>将指定集合中的所有元素插入到列表的指定位置。</td>\n</tr>\n<tr>\n<td><code>boolean removeAll(Collection&lt;?&gt; c)</code></td>\n<td>移除列表中与指定集合中的元素相匹配的所有元素。</td>\n</tr>\n<tr>\n<td><code>boolean retainAll(Collection&lt;?&gt; c)</code></td>\n<td>仅保留列表中与指定集合中的元素相匹配的元素，移除其他元素。</td>\n</tr>\n<tr>\n<td><code>void clear()</code></td>\n<td>清空列表中的所有元素。</td>\n</tr>\n<tr>\n<td><code>E get(int index)</code></td>\n<td>返回列表中指定位置的元素。</td>\n</tr>\n<tr>\n<td><code>E set(int index, E element)</code></td>\n<td>用指定元素替换列表中指定位置的元素，并返回原来的元素。</td>\n</tr>\n<tr>\n<td><code>void add(int index, E element)</code></td>\n<td>在列表的指定位置插入指定元素。</td>\n</tr>\n<tr>\n<td><code>E remove(int index)</code></td>\n<td>移除列表中指定位置的元素，并返回被移除的元素。</td>\n</tr>\n<tr>\n<td><code>int indexOf(Object o)</code></td>\n<td>返回指定元素在列表中首次出现的位置索引，如果不存在，则返回 -1。</td>\n</tr>\n<tr>\n<td><code>int lastIndexOf(Object o)</code></td>\n<td>返回指定元素在列表中最后一次出现的位置索引，如果不存在，则返回 -1。</td>\n</tr>\n</tbody>\n</table>\n<div class=\"tips\">\n<p><em><strong>小贴士</strong></em></p>\n<h2 id=\"迭代器的-fail-fast-与-fail-safe-机制\">迭代器的 fail-fast 与 fail-safe 机制</h2>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">在 Java 中，迭代器（Iterator）在迭代的过程中，如果底层的集合被修改（添加或删除元素），不同的迭代器对此的表现行为是不一样的，可分为两类：Fail-Fast（快速失败）和 Fail-Safe（安全失败）。</li>\n</ul>\n<h3 id=\"fail-fast-机制\">fail-fast 机制</h3>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">fail-fast 机制是java集合(Collection)中的一种错误机制。当多个线程对同一个集合的内容进行操作时，就可能会产生 fail-fast 事件。例如：当某一个线程A通过 iterator 去遍历某集合的过程中，若该集合的内容被其他线程所改变了；那么线程A访问集合时，就会抛出ConcurrentModificationException异常，产生 fail-fast 事件。</li>\n<li class=\"lvl-2\">在 java.util 包中的集合，如 ArrayList、HashMap 等，它们的迭代器默认都是采用 Fail-Fast 机制。</li>\n<li class=\"lvl-2\">fail-fast解决方案\n<ul class=\"lvl-3\">\n<li class=\"lvl-6\">方案一：在遍历过程中所有涉及到改变modCount 值的地方全部加上synchronized 或者直接使用Collection#synchronizedList，这样就可以解决问题，但是不推荐，因为增删造成的同步锁可能会阻塞遍历操作。</li>\n<li class=\"lvl-6\">方案二：使用CopyOnWriteArrayList 替换 ArrayList，推荐使用该方案（即fail-safe）。</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"fail-safe机制\">fail-safe机制</h3>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">任何对集合结构的修改都会在一个复制的集合上进行，因此不会抛出ConcurrentModificationException。在 java.util.concurrent 包中的集合，如CopyOnWriteArrayList、ConcurrentHashMap 等，它们的迭代器一般都是采用 Fail-Safe 机制。</li>\n<li class=\"lvl-2\">缺点：\n<ul class=\"lvl-3\">\n<li class=\"lvl-6\">采用 Fail-Safe 机制的集合类都是线程安全的，但是它们无法保证数据的实时一致性，它们只能保证数据的最终一致性。在迭代过程中，如果集合被修改了，可能读取到的仍然是旧的数据。</li>\n<li class=\"lvl-6\">Fail-Safe 机制还存在另外一个问题，就是内存占用。由于这类集合一般都是通过复制来实现读写分离的，因此它们会创建出更多的对象，导致占用更多的内存，甚至可能引起频繁的垃圾回收，严重影响性能</li>\n</ul>\n</li>\n</ul>\n</div>\n<h2 id=\"CopyOnWriteArraySet\">CopyOnWriteArraySet</h2>\n<table>\n<thead>\n<tr>\n<th>方法</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>int size()</code></td>\n<td>返回集合中的元素数量。</td>\n</tr>\n<tr>\n<td><code>boolean isEmpty()</code></td>\n<td>检查集合是否为空。</td>\n</tr>\n<tr>\n<td><code>boolean contains(Object o)</code></td>\n<td>检查集合是否包含指定的元素。</td>\n</tr>\n<tr>\n<td><code>boolean add(E e)</code></td>\n<td>将指定元素添加到集合中。</td>\n</tr>\n<tr>\n<td><code>boolean remove(Object o)</code></td>\n<td>从集合中移除指定元素。</td>\n</tr>\n<tr>\n<td><code>void clear()</code></td>\n<td>清空集合中的所有元素。</td>\n</tr>\n<tr>\n<td><code>Iterator&lt;E&gt; iterator()</code></td>\n<td>返回在集合上进行迭代的迭代器。</td>\n</tr>\n<tr>\n<td><code>boolean containsAll(Collection&lt;?&gt; c)</code></td>\n<td>检查集合是否包含指定集合中的所有元素。</td>\n</tr>\n<tr>\n<td><code>boolean addAll(Collection&lt;? extends E&gt; c)</code></td>\n<td>将指定集合中的所有元素添加到集合中。</td>\n</tr>\n<tr>\n<td><code>boolean removeAll(Collection&lt;?&gt; c)</code></td>\n<td>从集合中移除指定集合中包含的所有元素。</td>\n</tr>\n<tr>\n<td><code>boolean retainAll(Collection&lt;?&gt; c)</code></td>\n<td>仅保留集合中包含在指定集合中的元素，移除其他元素。</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"CopyOnWriteArraySet与CopyOnWriteArrayList的区别\">CopyOnWriteArraySet与CopyOnWriteArrayList的区别</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>数据结构类型：CopyOnWriteArraySet 是一个基于数组的集合，而 CopyOnWriteArrayList 是一个基于数组的列表。</p>\n</li>\n<li class=\"lvl-2\">\n<p>元素的唯一性：CopyOnWriteArraySet 保证集合中的元素是唯一的，不允许重复元素的存在。而 CopyOnWriteArrayList 允许列表中存在重复元素。</p>\n</li>\n<li class=\"lvl-2\">\n<p>集合与列表的特性：CopyOnWriteArraySet 实现了 Set 接口，它是一个无序的集合，不保留插入顺序。CopyOnWriteArrayList 实现了 List 接口，它是一个有序的列表，保留插入顺序。</p>\n</li>\n</ul>\n<h3 id=\"代码示例\">代码示例</h3>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 创建 CopyOnWriteArraySet 实例</span></span><br><span class=\"line\">CopyOnWriteArraySet&lt;String&gt; set = <span class=\"keyword\">new</span> <span class=\"title class_\">CopyOnWriteArraySet</span>&lt;&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 添加元素</span></span><br><span class=\"line\">set.add(<span class=\"string\">&quot;Apple&quot;</span>);</span><br><span class=\"line\">set.add(<span class=\"string\">&quot;Banana&quot;</span>);</span><br><span class=\"line\">set.add(<span class=\"string\">&quot;Orange&quot;</span>);</span><br><span class=\"line\">set.add(<span class=\"string\">&quot;Grapes&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 打印集合元素，可能得到的输出：[Apple, Banana, Grapes, Orange]</span></span><br><span class=\"line\">System.out.println(<span class=\"string\">&quot;集合元素: &quot;</span> + set);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 创建 CopyOnWriteArrayList 实例</span></span><br><span class=\"line\">CopyOnWriteArrayList&lt;String&gt; list = <span class=\"keyword\">new</span> <span class=\"title class_\">CopyOnWriteArrayList</span>&lt;&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 添加元素</span></span><br><span class=\"line\">list.add(<span class=\"string\">&quot;Apple&quot;</span>);</span><br><span class=\"line\">list.add(<span class=\"string\">&quot;Banana&quot;</span>);</span><br><span class=\"line\">list.add(<span class=\"string\">&quot;Orange&quot;</span>);</span><br><span class=\"line\">list.add(<span class=\"string\">&quot;Grapes&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 打印列表元素，得到的输出：[Apple, Banana, Orange, Grapes]</span></span><br><span class=\"line\">System.out.println(<span class=\"string\">&quot;列表元素: &quot;</span> + list);</span><br></pre></td></tr></table></figure>\n<h2 id=\"ConcurrentHashMap\">ConcurrentHashMap</h2>\n<table>\n<thead>\n<tr>\n<th>方法</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>int size()</code></td>\n<td>返回映射中的键值对数量。</td>\n</tr>\n<tr>\n<td><code>boolean isEmpty()</code></td>\n<td>检查映射是否为空。</td>\n</tr>\n<tr>\n<td><code>boolean containsKey(Object key)</code></td>\n<td>检查映射是否包含指定的键。</td>\n</tr>\n<tr>\n<td><code>boolean containsValue(Object value)</code></td>\n<td>检查映射是否包含指定的值。</td>\n</tr>\n<tr>\n<td><code>V get(Object key)</code></td>\n<td>获取与指定键关联的值。</td>\n</tr>\n<tr>\n<td><code>V put(K key, V value)</code></td>\n<td>将指定的键值对添加到映射中。</td>\n</tr>\n<tr>\n<td><code>V remove(Object key)</code></td>\n<td>从映射中移除指定键的映射关系，并返回对应的值。</td>\n</tr>\n<tr>\n<td><code>void clear()</code></td>\n<td>清空映射中的所有键值对。</td>\n</tr>\n<tr>\n<td><code>Set&lt;K&gt; keySet()</code></td>\n<td>返回映射中所有键的集合。</td>\n</tr>\n<tr>\n<td><code>Collection&lt;V&gt; values()</code></td>\n<td>返回映射中所有值的集合。</td>\n</tr>\n<tr>\n<td><code>Set&lt;Map.Entry&lt;K, V&gt;&gt; entrySet()</code></td>\n<td>返回映射中所有键值对的集合。</td>\n</tr>\n<tr>\n<td><code>V putIfAbsent(K key, V value)</code></td>\n<td>当指定的键尚未映射到值时，将指定的键值对添加到映射中。</td>\n</tr>\n<tr>\n<td><code>boolean remove(Object key, Object value)</code></td>\n<td>从映射中移除指定键值对。</td>\n</tr>\n<tr>\n<td><code>boolean replace(K key, V oldValue, V newValue)</code></td>\n<td>用新的值替换指定键的旧值，仅当当前值与指定的旧值相等时才替换。</td>\n</tr>\n<tr>\n<td><code>V replace(K key, V value)</code></td>\n<td>用指定值替换指定键的值。</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"JDK1-7-中的ConcurrentHashMap\">JDK1.7 中的ConcurrentHashMap</h3>\n<p>在jdk1.7及其以下的版本中，结构是用Segments数组 + HashEntry数组 + 链表实现的</p>\n<h3 id=\"JDK1-8中的ConcurrentHashMap\">JDK1.8中的ConcurrentHashMap</h3>\n<p>jdk1.8抛弃了Segments分段锁的方案，而是改用了和HashMap一样的结构操作，也就是数组 + 链表+ 红黑树结构，比jdk1.7中的ConcurrentHashMap提高了效率，在并发方面，使用了<code>cas +synchronized</code>的方式保证数据的一致性</p>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>链表转化为红黑树需要满足2个条件:</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">1.链表的节点数量大于等于树化阈值8</li>\n<li class=\"lvl-6\">2.Node数组的长度大于等于最小树化容量值64</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"代码示例-2\">代码示例</h2>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> java.util.concurrent.ConcurrentHashMap;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">ConcurrentHashMapExample</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 创建 ConcurrentHashMap 实例</span></span><br><span class=\"line\">        ConcurrentHashMap&lt;String, Integer&gt; map = <span class=\"keyword\">new</span> <span class=\"title class_\">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 添加键值对</span></span><br><span class=\"line\">        map.put(<span class=\"string\">&quot;Apple&quot;</span>, <span class=\"number\">3</span>);</span><br><span class=\"line\">        map.put(<span class=\"string\">&quot;Banana&quot;</span>, <span class=\"number\">1</span>);</span><br><span class=\"line\">        map.put(<span class=\"string\">&quot;Orange&quot;</span>, <span class=\"number\">2</span>);</span><br><span class=\"line\">        map.put(<span class=\"string\">&quot;Grapes&quot;</span>, <span class=\"number\">4</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 打印映射内容，映射内容: &#123;Banana=1, Grapes=4, Orange=2, Apple=3&#125;</span></span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;映射内容: &quot;</span> + map);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 获取键值对数量</span></span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;键值对数量: &quot;</span> + map.size());</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 检查是否包含指定键</span></span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;是否包含键 &#x27;Orange&#x27;: &quot;</span> + map.containsKey(<span class=\"string\">&quot;Orange&quot;</span>));</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 获取指定键对应的值</span></span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;键 &#x27;Apple&#x27; 对应的值: &quot;</span> + map.get(<span class=\"string\">&quot;Apple&quot;</span>));</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 移除指定键的映射关系</span></span><br><span class=\"line\">        map.remove(<span class=\"string\">&quot;Banana&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 打印映射内容</span></span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;移除键 &#x27;Banana&#x27; 后的映射内容: &quot;</span> + map);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"ConcurrentSkipListMap\">ConcurrentSkipListMap</h2>\n<h3 id=\"ConcurrentSkipListMap-和-ConcurrentHashMap-是-Java-中用于并发访问的映射数据结构，它们之间有一些区别\">ConcurrentSkipListMap 和 ConcurrentHashMap 是 Java 中用于并发访问的映射数据结构，它们之间有一些区别</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>数据结构：ConcurrentSkipListMap 是基于跳表（Skip List）的数据结构实现，而 ConcurrentHashMap 是基于<code>数组 + 链表+ 红黑树</code>的数据结构实现。</p>\n</li>\n<li class=\"lvl-2\">\n<p>排序性：ConcurrentSkipListMap 是有序映射，按照键的自然顺序或自定义的比较器对键进行排序。而 ConcurrentHashMap 是无序映射，不保证键值对的顺序。</p>\n</li>\n<li class=\"lvl-2\">\n<p>并发访问性能：在高度并发的情况下，ConcurrentSkipListMap 在读取方面的性能较好，因为它支持并发读取操作，并且有序结构使得读取更高效。而 ConcurrentHashMap 在写入方面的性能较好，因为它使用<code>cas +synchronized</code>来支持并发写入操作。</p>\n</li>\n<li class=\"lvl-2\">\n<p>内存占用：通常情况下，ConcurrentSkipListMap 的内存占用比 ConcurrentHashMap 更高，因为它需要额外的存储空间来维护跳表结构。</p>\n</li>\n<li class=\"lvl-2\">\n<p>功能特性：由于有序性的特点，ConcurrentSkipListMap 提供了一些与顺序相关的方法，如 <code>firstKey()</code>、<code>lastKey()</code>、<code>subMap()</code> 等。</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>方法</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>K firstKey()</code></td>\n<td>返回映射中的第一个键。</td>\n</tr>\n<tr>\n<td><code>K lastKey()</code></td>\n<td>返回映射中的最后一个键。</td>\n</tr>\n<tr>\n<td><code>ConcurrentNavigableMap&lt;K, V&gt; subMap(K fromKey, boolean fromInclusive, K toKey, boolean toInclusive)</code></td>\n<td>返回一个视图，该视图包含映射中键的子范围。</td>\n</tr>\n<tr>\n<td><code>ConcurrentNavigableMap&lt;K, V&gt; headMap(K toKey, boolean inclusive)</code></td>\n<td>返回一个视图，该视图包含映射中小于（或小于等于）给定键的部分。</td>\n</tr>\n<tr>\n<td><code>ConcurrentNavigableMap&lt;K, V&gt; tailMap(K fromKey, boolean inclusive)</code></td>\n<td>返回一个视图，该视图包含映射中大于（或大于等于）给定键的部分。</td>\n</tr>\n<tr>\n<td><code>ConcurrentNavigableMap&lt;K, V&gt; descendingMap()</code></td>\n<td>返回与此映射相反的顺序的视图。</td>\n</tr>\n<tr>\n<td><code>ConcurrentNavigableSet&lt;K&gt; navigableKeySet()</code></td>\n<td>返回包含映射中所有键的并发可导航集合。</td>\n</tr>\n<tr>\n<td><code>ConcurrentNavigableSet&lt;K&gt; descendingKeySet()</code></td>\n<td>返回与此映射中的键相反顺序对应的并发可导航集合。</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"代码示例-3\">代码示例</h3>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> java.util.concurrent.ConcurrentSkipListMap;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">ConcurrentSkipListMapExample</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 创建 ConcurrentSkipListMap 实例</span></span><br><span class=\"line\">        ConcurrentSkipListMap&lt;Integer, String&gt; map = <span class=\"keyword\">new</span> <span class=\"title class_\">ConcurrentSkipListMap</span>&lt;&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 添加键值对</span></span><br><span class=\"line\">        map.put(<span class=\"number\">3</span>, <span class=\"string\">&quot;Apple&quot;</span>);</span><br><span class=\"line\">        map.put(<span class=\"number\">1</span>, <span class=\"string\">&quot;Banana&quot;</span>);</span><br><span class=\"line\">        map.put(<span class=\"number\">2</span>, <span class=\"string\">&quot;Orange&quot;</span>);</span><br><span class=\"line\">        map.put(<span class=\"number\">4</span>, <span class=\"string\">&quot;Grapes&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 打印映射内容，映射内容: &#123;1=Banana, 2=Orange, 3=Apple, 4=Grapes&#125;</span></span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;映射内容: &quot;</span> + map);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 获取键值对数量</span></span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;键值对数量: &quot;</span> + map.size());</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 检查是否包含指定键</span></span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;是否包含键 2: &quot;</span> + map.containsKey(<span class=\"number\">2</span>));</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 获取指定键对应的值</span></span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;键 3 对应的值: &quot;</span> + map.get(<span class=\"number\">3</span>));</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 移除指定键的映射关系</span></span><br><span class=\"line\">        map.remove(<span class=\"number\">1</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 打印映射内容</span></span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;移除键 1 后的映射内容: &quot;</span> + map);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 获取最小的键</span></span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;最小的键: &quot;</span> + map.firstKey());</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 获取最大的键</span></span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;最大的键: &quot;</span> + map.lastKey());</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 获取键小于等于 3 的子映射</span></span><br><span class=\"line\">        ConcurrentSkipListMap&lt;Integer, String&gt; subMap = map.headMap(<span class=\"number\">3</span>, <span class=\"literal\">true</span>);</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;键小于等于 3 的子映射: &quot;</span> + subMap);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<div class=\"tips\">\n<p><em><strong>小贴士</strong></em></p>\n<h2 id=\"跳表\">跳表</h2>\n<p>跳表（Skip List）是一种用于实现有序集合的数据结构，它的设计灵感来自于平衡树。跳表通过使用多层链表结构，每一层链表按照升序排列，并且每一层链表都是前一层链表的子集。这样的结构允许在搜索、插入和删除元素时具有较高的效率。</p>\n<p>跳表的核心思想是通过建立索引层来加快搜索的速度。最底层是原始链表，每个节点都包含一个元素。而上层的链表是通过原始链表中的一部分节点创建的。在每一层中，节点以一定的概率被提升到更高层，从而形成了跨越多个层级的链接。</p>\n<p>跳表的主要优点是在具有合理的设计和维护下，可以在平均情况下以 O(log n) 的时间复杂度执行搜索、插入和删除操作。这是因为每一层的节点数量是下一层的节点数量的一半，从而形成了一种对数级别的分布。</p>\n<p>以下是跳表的主要操作：</p>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">\n<p>搜索：从顶层开始，沿着每一层的链表进行比较，如果目标元素大于当前节点的值，则在当前层继续向右移动；如果目标元素小于当前节点的值，则退回到下一层继续比较。直到找到目标元素或者无法再继续向右或下移动。</p>\n</li>\n<li class=\"lvl-2\">\n<p>插入：通过搜索找到插入位置后，在每一层链表中插入新节点，并更新相应的索引层。</p>\n</li>\n<li class=\"lvl-2\">\n<p>删除：通过搜索找到要删除的节点位置后，在每一层链表中删除节点，并更新相应的索引层。</p>\n</li>\n</ul>\n<p>跳表的实现相对简单，它提供了在有序集合中进行快速搜索和更新的高效方式。然而，它的空间复杂度相对于平衡树较高，因为需要维护额外的索引层。跳表在并发环境下也需要考虑同步的问题，以确保数据的一致性和线程安全性。</p>\n<p>总结而言，跳表通过建立多层索引结构，在有序集合中实现了较快的搜索、插入和删除操作。它是一种简单而高效的数据结构，在一些场景中可以作为替代平衡树的选择。<br>\n<img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/Mffk0p.png\" alt=\"\" width=\"600\" height=\"400\"></p>\n</div>\n<h2 id=\"ConcurrentLinkedQueue\">ConcurrentLinkedQueue</h2>\n<table>\n<thead>\n<tr>\n<th>方法</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>boolean add(E e)</code></td>\n<td>将指定元素添加到队列的尾部。</td>\n</tr>\n<tr>\n<td><code>boolean offer(E e)</code></td>\n<td>将指定元素添加到队列的尾部。</td>\n</tr>\n<tr>\n<td><code>E poll()</code></td>\n<td>获取并移除队列的头部元素。</td>\n</tr>\n<tr>\n<td><code>E peek()</code></td>\n<td>获取队列的头部元素，但不移除。</td>\n</tr>\n<tr>\n<td><code>int size()</code></td>\n<td>返回队列中的元素数量。</td>\n</tr>\n<tr>\n<td><code>boolean isEmpty()</code></td>\n<td>检查队列是否为空。</td>\n</tr>\n<tr>\n<td><code>boolean contains(Object o)</code></td>\n<td>检查队列是否包含指定元素。</td>\n</tr>\n<tr>\n<td><code>boolean remove(Object o)</code></td>\n<td>从队列中移除指定元素的第一个匹配项。</td>\n</tr>\n<tr>\n<td><code>void clear()</code></td>\n<td>移除队列中的所有元素。</td>\n</tr>\n<tr>\n<td><code>boolean containsAll(Collection&lt;?&gt; c)</code></td>\n<td>检查队列是否包含指定集合中的所有元素。</td>\n</tr>\n<tr>\n<td><code>boolean addAll(Collection&lt;? extends E&gt; c)</code></td>\n<td>将指定集合中的所有元素添加到队列的尾部。</td>\n</tr>\n<tr>\n<td><code>boolean removeAll(Collection&lt;?&gt; c)</code></td>\n<td>从队列中移除包含在指定集合中的所有元素。</td>\n</tr>\n<tr>\n<td><code>boolean retainAll(Collection&lt;?&gt; c)</code></td>\n<td>仅保留队列中包含在指定集合中的元素，移除其他元素。</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"代码示例-4\">代码示例</h3>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> java.util.concurrent.ConcurrentLinkedQueue;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">ConcurrentLinkedQueueExample</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 创建 ConcurrentLinkedQueue 实例</span></span><br><span class=\"line\">        ConcurrentLinkedQueue&lt;String&gt; queue = <span class=\"keyword\">new</span> <span class=\"title class_\">ConcurrentLinkedQueue</span>&lt;&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 添加元素到队列</span></span><br><span class=\"line\">        queue.add(<span class=\"string\">&quot;Apple&quot;</span>);</span><br><span class=\"line\">        queue.add(<span class=\"string\">&quot;Banana&quot;</span>);</span><br><span class=\"line\">        queue.add(<span class=\"string\">&quot;Orange&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 获取队列元素数量</span></span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;队列元素数量: &quot;</span> + queue.size());</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 检查队列是否为空</span></span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;队列是否为空: &quot;</span> + queue.isEmpty());</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 获取并移除队列头部元素</span></span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">head</span> <span class=\"operator\">=</span> queue.poll();</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;移除的队列头部元素: &quot;</span> + head);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 获取队列头部元素</span></span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">newHead</span> <span class=\"operator\">=</span> queue.peek();</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;新的队列头部元素: &quot;</span> + newHead);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 打印队列元素</span></span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;队列元素: &quot;</span> + queue);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"ConcurrentLinkedDeque\">ConcurrentLinkedDeque</h2>\n<table>\n<thead>\n<tr>\n<th>方法</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>void addFirst(E e)</code></td>\n<td>将指定元素插入到双端队列的开头。</td>\n</tr>\n<tr>\n<td><code>void addLast(E e)</code></td>\n<td>将指定元素插入到双端队列的末尾。</td>\n</tr>\n<tr>\n<td><code>boolean offerFirst(E e)</code></td>\n<td>将指定元素插入到双端队列的开头。如果成功则返回 <code>true</code>，否则返回 <code>false</code>。</td>\n</tr>\n<tr>\n<td><code>boolean offerLast(E e)</code></td>\n<td>将指定元素插入到双端队列的末尾。如果成功则返回 <code>true</code>，否则返回 <code>false</code>。</td>\n</tr>\n<tr>\n<td><code>E pollFirst()</code></td>\n<td>获取并移除双端队列的开头元素。</td>\n</tr>\n<tr>\n<td><code>E pollLast()</code></td>\n<td>获取并移除双端队列的末尾元素。</td>\n</tr>\n<tr>\n<td><code>E peekFirst()</code></td>\n<td>获取双端队列的开头元素，但不移除。</td>\n</tr>\n<tr>\n<td><code>E peekLast()</code></td>\n<td>获取双端队列的末尾元素，但不移除。</td>\n</tr>\n<tr>\n<td><code>boolean removeFirstOccurrence(Object o)</code></td>\n<td>从双端队列中移除首次出现的指定元素。</td>\n</tr>\n<tr>\n<td><code>boolean removeLastOccurrence(Object o)</code></td>\n<td>从双端队列中移除最后一次出现的指定元素。</td>\n</tr>\n<tr>\n<td><code>void push(E e)</code></td>\n<td>将元素推入双端队列的开头。</td>\n</tr>\n<tr>\n<td><code>E pop()</code></td>\n<td>从双端队列的开头弹出一个元素。</td>\n</tr>\n<tr>\n<td><code>boolean remove(Object o)</code></td>\n<td>从双端队列中移除指定元素的第一个匹配项。</td>\n</tr>\n<tr>\n<td><code>boolean contains(Object o)</code></td>\n<td>检查双端队列是否包含指定元素。</td>\n</tr>\n<tr>\n<td><code>int size()</code></td>\n<td>返回双端队列中的元素数量。</td>\n</tr>\n<tr>\n<td><code>boolean isEmpty()</code></td>\n<td>检查双端队列是否为空。</td>\n</tr>\n<tr>\n<td><code>void clear()</code></td>\n<td>移除双端队列中的所有元素。</td>\n</tr>\n<tr>\n<td><code>boolean containsAll(Collection&lt;?&gt; c)</code></td>\n<td>检查双端队列是否包含指定集合中的所有元素。</td>\n</tr>\n<tr>\n<td><code>boolean addAll(Collection&lt;? extends E&gt; c)</code></td>\n<td>将指定集合中的所有元素添加到双端队列的末尾。</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"代码示例-5\">代码示例</h3>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> java.util.concurrent.ConcurrentLinkedDeque;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">ConcurrentLinkedDequeExample</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 创建 ConcurrentLinkedDeque 实例</span></span><br><span class=\"line\">        ConcurrentLinkedDeque&lt;String&gt; deque = <span class=\"keyword\">new</span> <span class=\"title class_\">ConcurrentLinkedDeque</span>&lt;&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 添加元素到双端队列</span></span><br><span class=\"line\">        deque.addFirst(<span class=\"string\">&quot;Apple&quot;</span>);</span><br><span class=\"line\">        deque.addLast(<span class=\"string\">&quot;Banana&quot;</span>);</span><br><span class=\"line\">        deque.addLast(<span class=\"string\">&quot;Orange&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 获取双端队列元素数量</span></span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;双端队列元素数量: &quot;</span> + deque.size());</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 检查双端队列是否为空</span></span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;双端队列是否为空: &quot;</span> + deque.isEmpty());</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 获取并移除双端队列头部元素</span></span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">head</span> <span class=\"operator\">=</span> deque.pollFirst();</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;移除的双端队列头部元素: &quot;</span> + head);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 获取双端队列头部元素</span></span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">newHead</span> <span class=\"operator\">=</span> deque.peekFirst();</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;新的双端队列头部元素: &quot;</span> + newHead);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 获取双端队列尾部元素</span></span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">tail</span> <span class=\"operator\">=</span> deque.peekLast();</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;双端队列尾部元素: &quot;</span> + tail);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 打印双端队列元素</span></span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;双端队列元素: &quot;</span> + deque);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>","content_text":"摘要 本文介绍并发容器相关技术 本文基于jdk1.8 并发容器 Java的集合容器框架中，主要有四大类别：List、Set、Queue、Map，大家熟知的这些集合类ArrayList、LinkedList、HashMap等这些容器都是非线程安全的。 为了保证线程安全，所以java提供了同步容器，可以简单地理解为通过synchronized来实现同步的容器，比如Vector、Hashtable以及SynchronizedList等容器，这样做的代价是削弱了并发性，当多个线程共同竞争容器级的锁时，吞吐量就会降低。 因此为了解决同步容器的性能问题，所以才有了并发容器，java.util.concurrent包中提供了多种并发类容器： 并发容器 对应的非并发容器 代替的同步容器 实现原理 应用场景 CopyOnWriteArrayList ArrayList Vector、synchronizedList CopyOnWriteArrayList 内部使用了一种称为“写时复制”的机制。当需要进行写操作时，它会创建一个新的数组，并将原始数组的内容复制到新数组中，然后进行写操作。一旦修改完成，新的副本会替代原始数组，成为新的数据源。因此，读操作不会被写操作阻塞，读操作返回的结果可能不是最新的，但是对于许多应用场景来说，这是可以接受的。此外，由于读操作不需要加锁，因此它可以支持更高的并发度。需要注意的是，虽然副本会替代原始数组，但是这个替代并不是立即发生的。在修改操作期间，读操作仍然可能会访问原始数组。只有当修改完成后，才会将新的副本设置为源数组。 1. 读多写少的场景由于 CopyOnWriteArrayList 的读操作不需要加锁，因此它非常适合在读多写少的场景中使用。例如，一个读取频率比写入频率高得多的缓存，使用 CopyOnWriteArrayList 可以提高读取性能，并减少锁竞争的开销。2. 不需要实时更新的数据由于 CopyOnWriteArrayList 读取的数据可能不是最新的，因此它适合于不需要实时更新的数据。例如，在日志应用中，为了保证应用的性能，日志记录的操作可能被缓冲，并不是实时写入文件系统，而是在某个时刻批量写入。这种情况下，使用 CopyOnWriteArrayList 可以避免多个线程之间的竞争，提高应用的性能。注意：由于写操作的时候，需要拷贝数组，会消耗内存，如果原数组的内容比较多的情况下，可能导致 young gc 或者full gc，谨慎使用 CopyOnWriteArraySet HashSet synchronizedSet 基于CopyOnWriteArrayList实现，其唯一的不同是在add时调用的是CopyOnWriteArrayList的addIfAbsent方法，其遍历当前Object数组，如Object数组中已有了当前元素，则直接返回，如果没有则放入Object数组的尾部，并返回。 同CopyOnWriteArrayList ConcurrentHashMap HashMap Hashtable、synchronizedMap 在JDK1.8之前，ConcurrentHashMap使用分段锁以在保证线程安全的同时获得更大的效率。JDK1.8开始舍弃了分段锁，使用自旋+CAS+synchronized关键字来实现同步。这样做的好处：1.节省内存空间 ，分段锁需要更多的内存空间，而大多数情况下，并发粒度达不到设置的粒度，竞争概率较小，反而导致更新的长时间等待（因为锁定一段后整个段就无法更新了）2.提高GC效率。 1.共享数据的线程安全：在多线程编程中，如果需要进行共享数据的读写，可以使用 ConcurrentHashMap 保证线程安全。2. 缓存：ConcurrentHashMap 的高并发性能和线程安全能力，使其成为一种很好的缓存实现方案。在多线程环境下，使用 ConcurrentHashMap 作为缓存的数据结构，能够提高程序的并发性能，同时保证数据的一致性。 ConcurrentSkipListMap TreeMap synchronizedSortedMap(TreeMap) 基于Skip list（跳表）实现的有序映射（Map）数据结构，是一种可以代替平衡树的数据结构，默认是按照Key值升序的。 ConcurrentSkipListMap适用于需要高并发性能、支持有序性和区间查询的场景，能够有效地提高系统的性能和可扩展性。 ConcurrentLinkedQueue LinkedList LinkedBlockingQueue ConcurrentLinkedQueue 基于无锁算法和乐观并发策略，旨在提供高效的并发操作。它使用一个单向链表数据结构来存储元素，并且保持了先进先出（FIFO）的顺序。ConcurrentLinkedQueue 是一个无界队列，它没有固定的容量限制。可以根据需要动态地增长或缩小链表的长度。需要注意的是，ConcurrentLinkedQueue 并不适合在迭代过程中进行修改操作，因为它的结构在并发情况下可能会发生变化。 1.高并发环境：ConcurrentLinkedQueue 适用于需要高并发性能和线程安全的场景。由于它采用无锁算法和乐观并发策略，可以在高并发环境下提供较高的吞吐量。2.生产者-消费者模式：ConcurrentLinkedQueue 在实现生产者-消费者模式时非常有用。生产者线程可以将元素添加到队列的尾部，而消费者线程可以从队列的头部获取元素，实现了解耦和并发处理。3.任务调度：ConcurrentLinkedQueue 可以作为任务调度的数据结构，用于存储待执行的任务。多个线程可以从队列中获取任务并执行，从而实现任务的并发处理。 ConcurrentLinkedDeque LinkedList 无 与ConcurrentLinkedQueue 相比 ConcurrentLinkedDeque 是基于双向链表实现的并发双端队列。它支持在队头和队尾进行插入和移除操作，保持了元素的先进先出顺序。 ConcurrentLinkedDeque 适用于需要双端操作的并发场景，例如生产者-消费者模式中的多线程同时插入和移除元素的场景。 CopyOnWriteArrayList 方法 描述 int size() 返回列表中的元素数量。 boolean isEmpty() 检查列表是否为空。 boolean contains(Object o) 检查列表是否包含指定元素。 Iterator&lt;E&gt; iterator() 返回一个迭代器，用于遍历列表中的元素。 boolean add(E e) 将元素添加到列表末尾。 boolean remove(Object o) 从列表中移除指定元素的第一个匹配项。 boolean containsAll(Collection&lt;?&gt; c) 检查列表是否包含指定集合中的所有元素。 boolean addAll(Collection&lt;? extends E&gt; c) 将指定集合中的所有元素添加到列表末尾。 boolean addAll(int index, Collection&lt;? extends E&gt; c) 将指定集合中的所有元素插入到列表的指定位置。 boolean removeAll(Collection&lt;?&gt; c) 移除列表中与指定集合中的元素相匹配的所有元素。 boolean retainAll(Collection&lt;?&gt; c) 仅保留列表中与指定集合中的元素相匹配的元素，移除其他元素。 void clear() 清空列表中的所有元素。 E get(int index) 返回列表中指定位置的元素。 E set(int index, E element) 用指定元素替换列表中指定位置的元素，并返回原来的元素。 void add(int index, E element) 在列表的指定位置插入指定元素。 E remove(int index) 移除列表中指定位置的元素，并返回被移除的元素。 int indexOf(Object o) 返回指定元素在列表中首次出现的位置索引，如果不存在，则返回 -1。 int lastIndexOf(Object o) 返回指定元素在列表中最后一次出现的位置索引，如果不存在，则返回 -1。 小贴士 迭代器的 fail-fast 与 fail-safe 机制 在 Java 中，迭代器（Iterator）在迭代的过程中，如果底层的集合被修改（添加或删除元素），不同的迭代器对此的表现行为是不一样的，可分为两类：Fail-Fast（快速失败）和 Fail-Safe（安全失败）。 fail-fast 机制 fail-fast 机制是java集合(Collection)中的一种错误机制。当多个线程对同一个集合的内容进行操作时，就可能会产生 fail-fast 事件。例如：当某一个线程A通过 iterator 去遍历某集合的过程中，若该集合的内容被其他线程所改变了；那么线程A访问集合时，就会抛出ConcurrentModificationException异常，产生 fail-fast 事件。 在 java.util 包中的集合，如 ArrayList、HashMap 等，它们的迭代器默认都是采用 Fail-Fast 机制。 fail-fast解决方案 方案一：在遍历过程中所有涉及到改变modCount 值的地方全部加上synchronized 或者直接使用Collection#synchronizedList，这样就可以解决问题，但是不推荐，因为增删造成的同步锁可能会阻塞遍历操作。 方案二：使用CopyOnWriteArrayList 替换 ArrayList，推荐使用该方案（即fail-safe）。 fail-safe机制 任何对集合结构的修改都会在一个复制的集合上进行，因此不会抛出ConcurrentModificationException。在 java.util.concurrent 包中的集合，如CopyOnWriteArrayList、ConcurrentHashMap 等，它们的迭代器一般都是采用 Fail-Safe 机制。 缺点： 采用 Fail-Safe 机制的集合类都是线程安全的，但是它们无法保证数据的实时一致性，它们只能保证数据的最终一致性。在迭代过程中，如果集合被修改了，可能读取到的仍然是旧的数据。 Fail-Safe 机制还存在另外一个问题，就是内存占用。由于这类集合一般都是通过复制来实现读写分离的，因此它们会创建出更多的对象，导致占用更多的内存，甚至可能引起频繁的垃圾回收，严重影响性能 CopyOnWriteArraySet 方法 描述 int size() 返回集合中的元素数量。 boolean isEmpty() 检查集合是否为空。 boolean contains(Object o) 检查集合是否包含指定的元素。 boolean add(E e) 将指定元素添加到集合中。 boolean remove(Object o) 从集合中移除指定元素。 void clear() 清空集合中的所有元素。 Iterator&lt;E&gt; iterator() 返回在集合上进行迭代的迭代器。 boolean containsAll(Collection&lt;?&gt; c) 检查集合是否包含指定集合中的所有元素。 boolean addAll(Collection&lt;? extends E&gt; c) 将指定集合中的所有元素添加到集合中。 boolean removeAll(Collection&lt;?&gt; c) 从集合中移除指定集合中包含的所有元素。 boolean retainAll(Collection&lt;?&gt; c) 仅保留集合中包含在指定集合中的元素，移除其他元素。 CopyOnWriteArraySet与CopyOnWriteArrayList的区别 数据结构类型：CopyOnWriteArraySet 是一个基于数组的集合，而 CopyOnWriteArrayList 是一个基于数组的列表。 元素的唯一性：CopyOnWriteArraySet 保证集合中的元素是唯一的，不允许重复元素的存在。而 CopyOnWriteArrayList 允许列表中存在重复元素。 集合与列表的特性：CopyOnWriteArraySet 实现了 Set 接口，它是一个无序的集合，不保留插入顺序。CopyOnWriteArrayList 实现了 List 接口，它是一个有序的列表，保留插入顺序。 代码示例 1234567891011121314151617181920212223// 创建 CopyOnWriteArraySet 实例CopyOnWriteArraySet&lt;String&gt; set = new CopyOnWriteArraySet&lt;&gt;();// 添加元素set.add(&quot;Apple&quot;);set.add(&quot;Banana&quot;);set.add(&quot;Orange&quot;);set.add(&quot;Grapes&quot;);// 打印集合元素，可能得到的输出：[Apple, Banana, Grapes, Orange]System.out.println(&quot;集合元素: &quot; + set);// 创建 CopyOnWriteArrayList 实例CopyOnWriteArrayList&lt;String&gt; list = new CopyOnWriteArrayList&lt;&gt;();// 添加元素list.add(&quot;Apple&quot;);list.add(&quot;Banana&quot;);list.add(&quot;Orange&quot;);list.add(&quot;Grapes&quot;);// 打印列表元素，得到的输出：[Apple, Banana, Orange, Grapes]System.out.println(&quot;列表元素: &quot; + list); ConcurrentHashMap 方法 描述 int size() 返回映射中的键值对数量。 boolean isEmpty() 检查映射是否为空。 boolean containsKey(Object key) 检查映射是否包含指定的键。 boolean containsValue(Object value) 检查映射是否包含指定的值。 V get(Object key) 获取与指定键关联的值。 V put(K key, V value) 将指定的键值对添加到映射中。 V remove(Object key) 从映射中移除指定键的映射关系，并返回对应的值。 void clear() 清空映射中的所有键值对。 Set&lt;K&gt; keySet() 返回映射中所有键的集合。 Collection&lt;V&gt; values() 返回映射中所有值的集合。 Set&lt;Map.Entry&lt;K, V&gt;&gt; entrySet() 返回映射中所有键值对的集合。 V putIfAbsent(K key, V value) 当指定的键尚未映射到值时，将指定的键值对添加到映射中。 boolean remove(Object key, Object value) 从映射中移除指定键值对。 boolean replace(K key, V oldValue, V newValue) 用新的值替换指定键的旧值，仅当当前值与指定的旧值相等时才替换。 V replace(K key, V value) 用指定值替换指定键的值。 JDK1.7 中的ConcurrentHashMap 在jdk1.7及其以下的版本中，结构是用Segments数组 + HashEntry数组 + 链表实现的 JDK1.8中的ConcurrentHashMap jdk1.8抛弃了Segments分段锁的方案，而是改用了和HashMap一样的结构操作，也就是数组 + 链表+ 红黑树结构，比jdk1.7中的ConcurrentHashMap提高了效率，在并发方面，使用了cas +synchronized的方式保证数据的一致性 链表转化为红黑树需要满足2个条件: 1.链表的节点数量大于等于树化阈值8 2.Node数组的长度大于等于最小树化容量值64 代码示例 1234567891011121314151617181920212223242526272829303132import java.util.concurrent.ConcurrentHashMap;public class ConcurrentHashMapExample &#123; public static void main(String[] args) &#123; // 创建 ConcurrentHashMap 实例 ConcurrentHashMap&lt;String, Integer&gt; map = new ConcurrentHashMap&lt;&gt;(); // 添加键值对 map.put(&quot;Apple&quot;, 3); map.put(&quot;Banana&quot;, 1); map.put(&quot;Orange&quot;, 2); map.put(&quot;Grapes&quot;, 4); // 打印映射内容，映射内容: &#123;Banana=1, Grapes=4, Orange=2, Apple=3&#125; System.out.println(&quot;映射内容: &quot; + map); // 获取键值对数量 System.out.println(&quot;键值对数量: &quot; + map.size()); // 检查是否包含指定键 System.out.println(&quot;是否包含键 &#x27;Orange&#x27;: &quot; + map.containsKey(&quot;Orange&quot;)); // 获取指定键对应的值 System.out.println(&quot;键 &#x27;Apple&#x27; 对应的值: &quot; + map.get(&quot;Apple&quot;)); // 移除指定键的映射关系 map.remove(&quot;Banana&quot;); // 打印映射内容 System.out.println(&quot;移除键 &#x27;Banana&#x27; 后的映射内容: &quot; + map); &#125;&#125; ConcurrentSkipListMap ConcurrentSkipListMap 和 ConcurrentHashMap 是 Java 中用于并发访问的映射数据结构，它们之间有一些区别 数据结构：ConcurrentSkipListMap 是基于跳表（Skip List）的数据结构实现，而 ConcurrentHashMap 是基于数组 + 链表+ 红黑树的数据结构实现。 排序性：ConcurrentSkipListMap 是有序映射，按照键的自然顺序或自定义的比较器对键进行排序。而 ConcurrentHashMap 是无序映射，不保证键值对的顺序。 并发访问性能：在高度并发的情况下，ConcurrentSkipListMap 在读取方面的性能较好，因为它支持并发读取操作，并且有序结构使得读取更高效。而 ConcurrentHashMap 在写入方面的性能较好，因为它使用cas +synchronized来支持并发写入操作。 内存占用：通常情况下，ConcurrentSkipListMap 的内存占用比 ConcurrentHashMap 更高，因为它需要额外的存储空间来维护跳表结构。 功能特性：由于有序性的特点，ConcurrentSkipListMap 提供了一些与顺序相关的方法，如 firstKey()、lastKey()、subMap() 等。 方法 描述 K firstKey() 返回映射中的第一个键。 K lastKey() 返回映射中的最后一个键。 ConcurrentNavigableMap&lt;K, V&gt; subMap(K fromKey, boolean fromInclusive, K toKey, boolean toInclusive) 返回一个视图，该视图包含映射中键的子范围。 ConcurrentNavigableMap&lt;K, V&gt; headMap(K toKey, boolean inclusive) 返回一个视图，该视图包含映射中小于（或小于等于）给定键的部分。 ConcurrentNavigableMap&lt;K, V&gt; tailMap(K fromKey, boolean inclusive) 返回一个视图，该视图包含映射中大于（或大于等于）给定键的部分。 ConcurrentNavigableMap&lt;K, V&gt; descendingMap() 返回与此映射相反的顺序的视图。 ConcurrentNavigableSet&lt;K&gt; navigableKeySet() 返回包含映射中所有键的并发可导航集合。 ConcurrentNavigableSet&lt;K&gt; descendingKeySet() 返回与此映射中的键相反顺序对应的并发可导航集合。 代码示例 123456789101112131415161718192021222324252627282930313233343536373839404142import java.util.concurrent.ConcurrentSkipListMap;public class ConcurrentSkipListMapExample &#123; public static void main(String[] args) &#123; // 创建 ConcurrentSkipListMap 实例 ConcurrentSkipListMap&lt;Integer, String&gt; map = new ConcurrentSkipListMap&lt;&gt;(); // 添加键值对 map.put(3, &quot;Apple&quot;); map.put(1, &quot;Banana&quot;); map.put(2, &quot;Orange&quot;); map.put(4, &quot;Grapes&quot;); // 打印映射内容，映射内容: &#123;1=Banana, 2=Orange, 3=Apple, 4=Grapes&#125; System.out.println(&quot;映射内容: &quot; + map); // 获取键值对数量 System.out.println(&quot;键值对数量: &quot; + map.size()); // 检查是否包含指定键 System.out.println(&quot;是否包含键 2: &quot; + map.containsKey(2)); // 获取指定键对应的值 System.out.println(&quot;键 3 对应的值: &quot; + map.get(3)); // 移除指定键的映射关系 map.remove(1); // 打印映射内容 System.out.println(&quot;移除键 1 后的映射内容: &quot; + map); // 获取最小的键 System.out.println(&quot;最小的键: &quot; + map.firstKey()); // 获取最大的键 System.out.println(&quot;最大的键: &quot; + map.lastKey()); // 获取键小于等于 3 的子映射 ConcurrentSkipListMap&lt;Integer, String&gt; subMap = map.headMap(3, true); System.out.println(&quot;键小于等于 3 的子映射: &quot; + subMap); &#125;&#125; 小贴士 跳表 跳表（Skip List）是一种用于实现有序集合的数据结构，它的设计灵感来自于平衡树。跳表通过使用多层链表结构，每一层链表按照升序排列，并且每一层链表都是前一层链表的子集。这样的结构允许在搜索、插入和删除元素时具有较高的效率。 跳表的核心思想是通过建立索引层来加快搜索的速度。最底层是原始链表，每个节点都包含一个元素。而上层的链表是通过原始链表中的一部分节点创建的。在每一层中，节点以一定的概率被提升到更高层，从而形成了跨越多个层级的链接。 跳表的主要优点是在具有合理的设计和维护下，可以在平均情况下以 O(log n) 的时间复杂度执行搜索、插入和删除操作。这是因为每一层的节点数量是下一层的节点数量的一半，从而形成了一种对数级别的分布。 以下是跳表的主要操作： 搜索：从顶层开始，沿着每一层的链表进行比较，如果目标元素大于当前节点的值，则在当前层继续向右移动；如果目标元素小于当前节点的值，则退回到下一层继续比较。直到找到目标元素或者无法再继续向右或下移动。 插入：通过搜索找到插入位置后，在每一层链表中插入新节点，并更新相应的索引层。 删除：通过搜索找到要删除的节点位置后，在每一层链表中删除节点，并更新相应的索引层。 跳表的实现相对简单，它提供了在有序集合中进行快速搜索和更新的高效方式。然而，它的空间复杂度相对于平衡树较高，因为需要维护额外的索引层。跳表在并发环境下也需要考虑同步的问题，以确保数据的一致性和线程安全性。 总结而言，跳表通过建立多层索引结构，在有序集合中实现了较快的搜索、插入和删除操作。它是一种简单而高效的数据结构，在一些场景中可以作为替代平衡树的选择。 ConcurrentLinkedQueue 方法 描述 boolean add(E e) 将指定元素添加到队列的尾部。 boolean offer(E e) 将指定元素添加到队列的尾部。 E poll() 获取并移除队列的头部元素。 E peek() 获取队列的头部元素，但不移除。 int size() 返回队列中的元素数量。 boolean isEmpty() 检查队列是否为空。 boolean contains(Object o) 检查队列是否包含指定元素。 boolean remove(Object o) 从队列中移除指定元素的第一个匹配项。 void clear() 移除队列中的所有元素。 boolean containsAll(Collection&lt;?&gt; c) 检查队列是否包含指定集合中的所有元素。 boolean addAll(Collection&lt;? extends E&gt; c) 将指定集合中的所有元素添加到队列的尾部。 boolean removeAll(Collection&lt;?&gt; c) 从队列中移除包含在指定集合中的所有元素。 boolean retainAll(Collection&lt;?&gt; c) 仅保留队列中包含在指定集合中的元素，移除其他元素。 代码示例 123456789101112131415161718192021222324252627282930import java.util.concurrent.ConcurrentLinkedQueue;public class ConcurrentLinkedQueueExample &#123; public static void main(String[] args) &#123; // 创建 ConcurrentLinkedQueue 实例 ConcurrentLinkedQueue&lt;String&gt; queue = new ConcurrentLinkedQueue&lt;&gt;(); // 添加元素到队列 queue.add(&quot;Apple&quot;); queue.add(&quot;Banana&quot;); queue.add(&quot;Orange&quot;); // 获取队列元素数量 System.out.println(&quot;队列元素数量: &quot; + queue.size()); // 检查队列是否为空 System.out.println(&quot;队列是否为空: &quot; + queue.isEmpty()); // 获取并移除队列头部元素 String head = queue.poll(); System.out.println(&quot;移除的队列头部元素: &quot; + head); // 获取队列头部元素 String newHead = queue.peek(); System.out.println(&quot;新的队列头部元素: &quot; + newHead); // 打印队列元素 System.out.println(&quot;队列元素: &quot; + queue); &#125;&#125; ConcurrentLinkedDeque 方法 描述 void addFirst(E e) 将指定元素插入到双端队列的开头。 void addLast(E e) 将指定元素插入到双端队列的末尾。 boolean offerFirst(E e) 将指定元素插入到双端队列的开头。如果成功则返回 true，否则返回 false。 boolean offerLast(E e) 将指定元素插入到双端队列的末尾。如果成功则返回 true，否则返回 false。 E pollFirst() 获取并移除双端队列的开头元素。 E pollLast() 获取并移除双端队列的末尾元素。 E peekFirst() 获取双端队列的开头元素，但不移除。 E peekLast() 获取双端队列的末尾元素，但不移除。 boolean removeFirstOccurrence(Object o) 从双端队列中移除首次出现的指定元素。 boolean removeLastOccurrence(Object o) 从双端队列中移除最后一次出现的指定元素。 void push(E e) 将元素推入双端队列的开头。 E pop() 从双端队列的开头弹出一个元素。 boolean remove(Object o) 从双端队列中移除指定元素的第一个匹配项。 boolean contains(Object o) 检查双端队列是否包含指定元素。 int size() 返回双端队列中的元素数量。 boolean isEmpty() 检查双端队列是否为空。 void clear() 移除双端队列中的所有元素。 boolean containsAll(Collection&lt;?&gt; c) 检查双端队列是否包含指定集合中的所有元素。 boolean addAll(Collection&lt;? extends E&gt; c) 将指定集合中的所有元素添加到双端队列的末尾。 代码示例 12345678910111213141516171819202122232425262728293031323334import java.util.concurrent.ConcurrentLinkedDeque;public class ConcurrentLinkedDequeExample &#123; public static void main(String[] args) &#123; // 创建 ConcurrentLinkedDeque 实例 ConcurrentLinkedDeque&lt;String&gt; deque = new ConcurrentLinkedDeque&lt;&gt;(); // 添加元素到双端队列 deque.addFirst(&quot;Apple&quot;); deque.addLast(&quot;Banana&quot;); deque.addLast(&quot;Orange&quot;); // 获取双端队列元素数量 System.out.println(&quot;双端队列元素数量: &quot; + deque.size()); // 检查双端队列是否为空 System.out.println(&quot;双端队列是否为空: &quot; + deque.isEmpty()); // 获取并移除双端队列头部元素 String head = deque.pollFirst(); System.out.println(&quot;移除的双端队列头部元素: &quot; + head); // 获取双端队列头部元素 String newHead = deque.peekFirst(); System.out.println(&quot;新的双端队列头部元素: &quot; + newHead); // 获取双端队列尾部元素 String tail = deque.peekLast(); System.out.println(&quot;双端队列尾部元素: &quot; + tail); // 打印双端队列元素 System.out.println(&quot;双端队列元素: &quot; + deque); &#125;&#125;","summary":"摘要 本文介绍并发容器相关技术 本文基于jdk1.8","date_published":"2023-05-24T14:34:05.000Z","tags":["技术","java","java多线程","java"]},{"id":"https://blog.hanqunfeng.com/2023/05/23/java-concurrency08-LockSupport/","url":"https://blog.hanqunfeng.com/2023/05/23/java-concurrency08-LockSupport/","title":"Java并发编程--JUC并发工具类之LockSupport","content_html":"<!--\n **加粗**\n *斜体*\n ***加粗并斜体***\n ~~删除线~~\n ==突出显示==\n `突出显示(推荐)`\n ++下划线++\n ~下标~\n ^上标^\n 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.\n 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600)\n\n +++ **点击折叠**\n 这是被隐藏的内容\n +++\n\n::: tips success warning danger\n这里是容器内的内容\n:::\n\n% note info % success warning danger\n这里是容器内的内容\n% endnote %\n\n -->\n<h2 id=\"摘要\">摘要</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>本文介绍LockSupport相关技术</p>\n</li>\n<li class=\"lvl-2\">\n<p>本文基于<code>jdk1.8</code></p>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"LockSupport介绍\">LockSupport介绍</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>LockSupport</code>是Java并发工具类中的一个重要成员。它提供了一种基于线程的阻塞和唤醒机制，使得线程可以在特定条件下暂停和继续执行。</p>\n</li>\n<li class=\"lvl-2\">\n<p>与传统的<code>wait()</code>和<code>notify()</code>方法相比，<code>LockSupport</code>具有以下优势：</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">精准的线程阻塞和唤醒：<br>\n<code>LockSupport</code>提供了精确控制线程阻塞和唤醒的能力。通过调用<code>LockSupport</code>类的<code>park()</code>方法，线程可以主动进入阻塞状态，直到其他线程调用了相应线程的<code>unpark()</code>方法才能被唤醒。相比之下，<code>wait()</code>和<code>notify()</code>方法的使用需要依赖于对象的监视器（monitor），并且无法指定特定的线程进行唤醒。</li>\n<li class=\"lvl-6\">不依赖于对象的监视器：<br>\n传统的<code>wait()</code>和<code>notify()</code>方法需要依赖于对象的监视器（monitor），即在synchronized块中调用。这种依赖关系可能导致代码结构上的限制，而<code>LockSupport</code>则不依赖于特定的对象，可以在任何位置进行线程的阻塞和唤醒操作。</li>\n<li class=\"lvl-6\">避免死锁问题：<br>\n在使用<code>wait()</code>和<code>notify()</code>方法时，由于需要依赖于对象的监视器，可能会出现死锁问题，例如线程A等待线程B的通知，而线程B也在等待线程A的通知，导致双方无法继续执行。<code>LockSupport</code>通过给每个线程关联一个许可（<code>permit</code>）来避免死锁问题，即使在<code>park()</code>和<code>unpark()</code>方法的调用顺序上没有特定的要求。</li>\n</ul>\n</li>\n<li class=\"lvl-2\">\n<p>总体而言，<code>LockSupport</code>是一种强大而灵活的线程阻塞和唤醒机制，能够满足并发编程中的各种需求。它的设计理念与传统的<code>wait()</code>和<code>notify()</code>方法有所不同，提供了更加直观和可控的线程调度方式。然而，在使用<code>LockSupport</code>时，仍需谨慎处理线程的阻塞和唤醒逻辑，以避免潜在的并发问题。</p>\n</li>\n</ul>\n<h2 id=\"LockSupport-API说明\">LockSupport API说明</h2>\n<table>\n<thead>\n<tr>\n<th>方法</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>void park()</code></td>\n<td>阻塞当前线程，直到被唤醒</td>\n</tr>\n<tr>\n<td><code>void park(Object blocker)</code></td>\n<td>阻塞当前线程，并关联一个阻塞对象</td>\n</tr>\n<tr>\n<td><code>void parkNanos(long nanos)</code></td>\n<td>阻塞当前线程，最多等待指定纳秒时间</td>\n</tr>\n<tr>\n<td><code>void parkNanos(Object blocker, long nanos)</code></td>\n<td>阻塞当前线程，并关联一个阻塞对象，最多等待指定纳秒时间</td>\n</tr>\n<tr>\n<td><code>void parkUntil(long deadline)</code></td>\n<td>阻塞当前线程，直到指定的绝对时间点</td>\n</tr>\n<tr>\n<td><code>void parkUntil(Object blocker, long deadline)</code></td>\n<td>阻塞当前线程，并关联一个阻塞对象，直到指定的绝对时间点</td>\n</tr>\n<tr>\n<td><code>void unpark(Thread thread)</code></td>\n<td>唤醒指定的线程</td>\n</tr>\n<tr>\n<td><code>Object getBlocker(Thread thread)</code></td>\n<td>获取指定线程关联的阻塞对象</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>其中，<code>park()</code>和<code>unpark()</code>是最常用的方法，用于线程的阻塞和唤醒操作。</p>\n</li>\n<li class=\"lvl-2\">\n<p>其他方法提供了更多灵活的线程阻塞和唤醒方式，如指定阻塞对象、等待一定时间等。</p>\n</li>\n<li class=\"lvl-2\">\n<p><code>getBlocker()</code>方法可以获取指定线程关联的阻塞对象，以便进行进一步的操作或分析。</p>\n</li>\n<li class=\"lvl-2\">\n<p>在<code>LockSupport</code>的内部实现中，会使用底层的<code>CAS</code>操作来控制线程的阻塞和唤醒。当线程调用<code>park()</code>方法时，会将线程置于等待队列，并将线程的许可状态设置为负数。当调用<code>unpark()</code>方法时，会将线程的许可状态设置为非负数，从而唤醒等待的线程。</p>\n</li>\n</ul>\n<h2 id=\"代码示例\">代码示例</h2>\n<h3 id=\"示例1–park-和unpark\">示例1–<code>park()</code>和<code>unpark()</code></h3>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> java.util.concurrent.locks.LockSupport;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">CASParkUnparkExample</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">//</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">volatile</span> <span class=\"type\">boolean</span> <span class=\"variable\">condition</span> <span class=\"operator\">=</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> &#123;</span><br><span class=\"line\">        <span class=\"type\">Thread</span> <span class=\"variable\">waiterThread</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Thread</span>(() -&gt; &#123;</span><br><span class=\"line\">            <span class=\"keyword\">while</span> (!condition) &#123;</span><br><span class=\"line\">                <span class=\"comment\">// 阻塞当前线程</span></span><br><span class=\"line\">                LockSupport.park();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            System.out.println(<span class=\"string\">&quot;Condition is true. Thread is awake.&quot;</span>);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">Thread</span> <span class=\"variable\">notifierThread</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Thread</span>(() -&gt; &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 模拟一些耗时操作</span></span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                Thread.sleep(<span class=\"number\">2000</span>);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (InterruptedException e) &#123;</span><br><span class=\"line\">                e.printStackTrace();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            condition = <span class=\"literal\">true</span>;</span><br><span class=\"line\">            <span class=\"comment\">// 唤醒等待的线程</span></span><br><span class=\"line\">            LockSupport.unpark(waiterThread);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">        waiterThread.start();</span><br><span class=\"line\">        notifierThread.start();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>在上面的示例中，<code>waiterThread</code>线程通过调用<code>LockSupport.park()</code>进入阻塞状态，直到<code>condition</code>变为<code>true</code>。<code>notifierThread</code>线程在经过一些耗时操作后，将<code>condition</code>设置为<code>true</code>，然后调用<code>LockSupport.unpark(waiterThread)</code>唤醒<code>waiterThread</code>线程。</p>\n</li>\n</ul>\n<h3 id=\"示例2–park-Object-blocker-和getBlocker-Thread-thread\">示例2–<code>park(Object blocker)</code>和<code>getBlocker(Thread thread)</code></h3>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> java.util.concurrent.locks.LockSupport;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">ParkBlockerExample</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> InterruptedException &#123;</span><br><span class=\"line\">        <span class=\"type\">Object</span> <span class=\"variable\">blocker</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Object</span>(); <span class=\"comment\">// 创建一个阻塞对象</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">Thread</span> <span class=\"variable\">thread</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Thread</span>(() -&gt; &#123;</span><br><span class=\"line\">            System.out.println(<span class=\"string\">&quot;Thread is parking...&quot;</span>);</span><br><span class=\"line\">            LockSupport.park(blocker); <span class=\"comment\">// 阻塞当前线程，并关联阻塞对象</span></span><br><span class=\"line\">            System.out.println(<span class=\"string\">&quot;Thread is unparked&quot;</span>);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">        thread.start();</span><br><span class=\"line\"></span><br><span class=\"line\">        Thread.sleep(<span class=\"number\">2000</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 获取并输出关联的阻塞对象</span></span><br><span class=\"line\">        <span class=\"type\">Object</span> <span class=\"variable\">associatedBlocker</span> <span class=\"operator\">=</span> LockSupport.getBlocker(thread);</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;Associated blocker: &quot;</span> + associatedBlocker);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 唤醒线程</span></span><br><span class=\"line\">        LockSupport.unpark(thread);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>在上述示例中，我们创建了一个阻塞对象<code>blocker</code>。在thread线程中，我们调用<code>LockSupport.park(blocker)</code>方法阻塞当前线程，并将阻塞对象与线程关联。</p>\n</li>\n<li class=\"lvl-2\">\n<p>在主线程中，我们使用<code>LockSupport.getBlocker(thread)</code>方法获取与线程关联的阻塞对象，并输出它。</p>\n</li>\n</ul>\n<h3 id=\"park方法中阻塞对象的作用\">park方法中阻塞对象的作用</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>当调用<code>LockSupport的park()</code>方法时，线程将被阻塞，等待被唤醒。<code>park(Object blocker)</code>方法是<code>park()</code>方法的一个重载形式，它允许您将一个阻塞对象与当前线程相关联。绑定阻塞对象的作用在于更好地识别和监控线程的阻塞原因。</p>\n</li>\n<li class=\"lvl-2\">\n<p>当线程被阻塞时，可以通过调用<code>getBlocker(Thread thread)</code>方法来获取与该线程相关联的阻塞对象。这样，您可以在代码中根据阻塞对象进行更精确的条件判断、监控或其他操作。</p>\n</li>\n<li class=\"lvl-2\">\n<p>以下是一些使用场景的例子，说明绑定阻塞对象的作用：</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">调试和诊断：当多个线程被阻塞时，可以使用阻塞对象来确定具体是哪个线程被阻塞，以及被阻塞的原因。通过获取阻塞对象，您可以在调试过程中定位问题，并根据阻塞对象的不同采取相应的调试措施。</li>\n<li class=\"lvl-6\">更精确的控制和唤醒：通过关联特定的阻塞对象，您可以在需要唤醒线程时，只选择唤醒与该阻塞对象相关联的线程。这种精确的唤醒机制可以避免不必要的线程唤醒，提高系统的性能和效率。</li>\n<li class=\"lvl-6\">条件等待：在某些情况下，您可能希望线程在特定条件下被阻塞，直到满足某个条件后才被唤醒。通过绑定阻塞对象，您可以根据不同的条件选择不同的阻塞对象，从而实现对不同条件的精确等待和唤醒。</li>\n</ul>\n</li>\n<li class=\"lvl-2\">\n<p>绑定阻塞对象的作用是提供更多的上下文信息，帮助您更好地理解和控制线程的阻塞状态。它可以作为一种辅助手段，用于更精确地调试、监控和控制线程的行为。</p>\n</li>\n</ul>\n<h2 id=\"ReentrantLock的阻塞唤醒机制是基于LockSupport实现的\">ReentrantLock的阻塞唤醒机制是基于LockSupport实现的</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>ReentrantLock</code>是Java中提供的可重入锁的实现，它使用了内部类<code>Sync</code>来管理锁的状态和线程的阻塞与唤醒。<code>Sync</code>类内部使用了<code>LockSupport</code>工具类来实现线程的阻塞和唤醒操作。</p>\n</li>\n<li class=\"lvl-2\">\n<p>当一个线程无法获取到<code>ReentrantLock</code>的锁时，它会被阻塞，并且进入等待状态，在这种情况下，<code>ReentrantLock</code>内部会调用<code>LockSupport.park()</code>方法阻塞当前线程。</p>\n</li>\n<li class=\"lvl-2\">\n<p>当其他线程释放了锁或者调用了<code>ReentrantLock</code>的<code>unlock()</code>方法时，被阻塞的线程将会被唤醒，此时<code>ReentrantLock</code>会通过调用<code>LockSupport.unpark()</code>方法来唤醒被阻塞的线程。</p>\n</li>\n</ul>\n","content_text":"摘要 本文介绍LockSupport相关技术 本文基于jdk1.8 LockSupport介绍 LockSupport是Java并发工具类中的一个重要成员。它提供了一种基于线程的阻塞和唤醒机制，使得线程可以在特定条件下暂停和继续执行。 与传统的wait()和notify()方法相比，LockSupport具有以下优势： 精准的线程阻塞和唤醒： LockSupport提供了精确控制线程阻塞和唤醒的能力。通过调用LockSupport类的park()方法，线程可以主动进入阻塞状态，直到其他线程调用了相应线程的unpark()方法才能被唤醒。相比之下，wait()和notify()方法的使用需要依赖于对象的监视器（monitor），并且无法指定特定的线程进行唤醒。 不依赖于对象的监视器： 传统的wait()和notify()方法需要依赖于对象的监视器（monitor），即在synchronized块中调用。这种依赖关系可能导致代码结构上的限制，而LockSupport则不依赖于特定的对象，可以在任何位置进行线程的阻塞和唤醒操作。 避免死锁问题： 在使用wait()和notify()方法时，由于需要依赖于对象的监视器，可能会出现死锁问题，例如线程A等待线程B的通知，而线程B也在等待线程A的通知，导致双方无法继续执行。LockSupport通过给每个线程关联一个许可（permit）来避免死锁问题，即使在park()和unpark()方法的调用顺序上没有特定的要求。 总体而言，LockSupport是一种强大而灵活的线程阻塞和唤醒机制，能够满足并发编程中的各种需求。它的设计理念与传统的wait()和notify()方法有所不同，提供了更加直观和可控的线程调度方式。然而，在使用LockSupport时，仍需谨慎处理线程的阻塞和唤醒逻辑，以避免潜在的并发问题。 LockSupport API说明 方法 描述 void park() 阻塞当前线程，直到被唤醒 void park(Object blocker) 阻塞当前线程，并关联一个阻塞对象 void parkNanos(long nanos) 阻塞当前线程，最多等待指定纳秒时间 void parkNanos(Object blocker, long nanos) 阻塞当前线程，并关联一个阻塞对象，最多等待指定纳秒时间 void parkUntil(long deadline) 阻塞当前线程，直到指定的绝对时间点 void parkUntil(Object blocker, long deadline) 阻塞当前线程，并关联一个阻塞对象，直到指定的绝对时间点 void unpark(Thread thread) 唤醒指定的线程 Object getBlocker(Thread thread) 获取指定线程关联的阻塞对象 其中，park()和unpark()是最常用的方法，用于线程的阻塞和唤醒操作。 其他方法提供了更多灵活的线程阻塞和唤醒方式，如指定阻塞对象、等待一定时间等。 getBlocker()方法可以获取指定线程关联的阻塞对象，以便进行进一步的操作或分析。 在LockSupport的内部实现中，会使用底层的CAS操作来控制线程的阻塞和唤醒。当线程调用park()方法时，会将线程置于等待队列，并将线程的许可状态设置为负数。当调用unpark()方法时，会将线程的许可状态设置为非负数，从而唤醒等待的线程。 代码示例 示例1–park()和unpark() 12345678910111213141516171819202122232425262728293031import java.util.concurrent.locks.LockSupport;public class CASParkUnparkExample &#123; // private static volatile boolean condition = false; public static void main(String[] args) &#123; Thread waiterThread = new Thread(() -&gt; &#123; while (!condition) &#123; // 阻塞当前线程 LockSupport.park(); &#125; System.out.println(&quot;Condition is true. Thread is awake.&quot;); &#125;); Thread notifierThread = new Thread(() -&gt; &#123; // 模拟一些耗时操作 try &#123; Thread.sleep(2000); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; condition = true; // 唤醒等待的线程 LockSupport.unpark(waiterThread); &#125;); waiterThread.start(); notifierThread.start(); &#125;&#125; 在上面的示例中，waiterThread线程通过调用LockSupport.park()进入阻塞状态，直到condition变为true。notifierThread线程在经过一些耗时操作后，将condition设置为true，然后调用LockSupport.unpark(waiterThread)唤醒waiterThread线程。 示例2–park(Object blocker)和getBlocker(Thread thread) 123456789101112131415161718192021222324import java.util.concurrent.locks.LockSupport;public class ParkBlockerExample &#123; public static void main(String[] args) throws InterruptedException &#123; Object blocker = new Object(); // 创建一个阻塞对象 Thread thread = new Thread(() -&gt; &#123; System.out.println(&quot;Thread is parking...&quot;); LockSupport.park(blocker); // 阻塞当前线程，并关联阻塞对象 System.out.println(&quot;Thread is unparked&quot;); &#125;); thread.start(); Thread.sleep(2000); // 获取并输出关联的阻塞对象 Object associatedBlocker = LockSupport.getBlocker(thread); System.out.println(&quot;Associated blocker: &quot; + associatedBlocker); // 唤醒线程 LockSupport.unpark(thread); &#125;&#125; 在上述示例中，我们创建了一个阻塞对象blocker。在thread线程中，我们调用LockSupport.park(blocker)方法阻塞当前线程，并将阻塞对象与线程关联。 在主线程中，我们使用LockSupport.getBlocker(thread)方法获取与线程关联的阻塞对象，并输出它。 park方法中阻塞对象的作用 当调用LockSupport的park()方法时，线程将被阻塞，等待被唤醒。park(Object blocker)方法是park()方法的一个重载形式，它允许您将一个阻塞对象与当前线程相关联。绑定阻塞对象的作用在于更好地识别和监控线程的阻塞原因。 当线程被阻塞时，可以通过调用getBlocker(Thread thread)方法来获取与该线程相关联的阻塞对象。这样，您可以在代码中根据阻塞对象进行更精确的条件判断、监控或其他操作。 以下是一些使用场景的例子，说明绑定阻塞对象的作用： 调试和诊断：当多个线程被阻塞时，可以使用阻塞对象来确定具体是哪个线程被阻塞，以及被阻塞的原因。通过获取阻塞对象，您可以在调试过程中定位问题，并根据阻塞对象的不同采取相应的调试措施。 更精确的控制和唤醒：通过关联特定的阻塞对象，您可以在需要唤醒线程时，只选择唤醒与该阻塞对象相关联的线程。这种精确的唤醒机制可以避免不必要的线程唤醒，提高系统的性能和效率。 条件等待：在某些情况下，您可能希望线程在特定条件下被阻塞，直到满足某个条件后才被唤醒。通过绑定阻塞对象，您可以根据不同的条件选择不同的阻塞对象，从而实现对不同条件的精确等待和唤醒。 绑定阻塞对象的作用是提供更多的上下文信息，帮助您更好地理解和控制线程的阻塞状态。它可以作为一种辅助手段，用于更精确地调试、监控和控制线程的行为。 ReentrantLock的阻塞唤醒机制是基于LockSupport实现的 ReentrantLock是Java中提供的可重入锁的实现，它使用了内部类Sync来管理锁的状态和线程的阻塞与唤醒。Sync类内部使用了LockSupport工具类来实现线程的阻塞和唤醒操作。 当一个线程无法获取到ReentrantLock的锁时，它会被阻塞，并且进入等待状态，在这种情况下，ReentrantLock内部会调用LockSupport.park()方法阻塞当前线程。 当其他线程释放了锁或者调用了ReentrantLock的unlock()方法时，被阻塞的线程将会被唤醒，此时ReentrantLock会通过调用LockSupport.unpark()方法来唤醒被阻塞的线程。","summary":"摘要 本文介绍LockSupport相关技术 本文基于jdk1.8","date_published":"2023-05-23T14:34:05.000Z","tags":["技术","java","java多线程","java"]}]}