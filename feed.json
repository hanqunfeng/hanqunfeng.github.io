{"version":"https://jsonfeed.org/version/1","name":"é£˜é€¸å³°çš„åšå®¢","home_page_url":"https://blog.hanqunfeng.com","feed_url":"https://blog.hanqunfeng.com/feed.json","author":{"name":"é£˜é€¸å³°"},"items":[{"id":"https://blog.hanqunfeng.com/2025/06/12/docker-swarm-config-secret/","url":"https://blog.hanqunfeng.com/2025/06/12/docker-swarm-config-secret/","title":"Docker Swarm ä¹‹ Config ä¸  Secret","content_html":"<!--\n **åŠ ç²—**\n *æ–œä½“*\n ***åŠ ç²—å¹¶æ–œä½“***\n ~~åˆ é™¤çº¿~~\n ==çªå‡ºæ˜¾ç¤º==\n `çªå‡ºæ˜¾ç¤º(æ¨è)`\n ++ä¸‹åˆ’çº¿++\n ~ä¸‹æ ‡~\n ^ä¸Šæ ‡^\n è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference.\n å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)\n\n +++ **ç‚¹å‡»æŠ˜å **\n è¿™æ˜¯è¢«éšè—çš„å†…å®¹\n +++\n\n::: tips success warning danger\nè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹\n:::\n\n% note info % success warning danger\nè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹\n% endnote %\n\nå¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{}\n å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ\n -->\n<h2 id=\"æ‘˜è¦\">æ‘˜è¦</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æœ¬æ–‡ä»‹ç» Docker Swarm ä¸­çš„ Config ä¸  Secret</p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://docs.docker.com\">Dockerå®˜æ–¹æ–‡æ¡£</a></p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://docs.docker.com/engine/swarm/\">Docker Swarm å®˜æ–¹æ–‡æ¡£</a></p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://docs.docker.com/reference/compose-file/\">Compose file reference</a></p>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"Config-ç®€ä»‹\">Config ç®€ä»‹</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åœ¨ Docker Swarm ä¸­ï¼ŒConfig æ˜¯ä¸€ç§ç”¨äºç®¡ç†é…ç½®èµ„æºçš„æœºåˆ¶ï¼Œå…è®¸ä½ å°†é…ç½®æ–‡ä»¶ä¸å®¹å™¨åˆ†ç¦»ï¼Œä¾¿äºåœ¨ä¸åŒç¯å¢ƒä¸­é‡ç”¨å’Œå…±äº«é…ç½®ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>Config å’Œ Volume éƒ½æ˜¯ Docker ä¸­ç”¨äºç®¡ç†æ•°æ®çš„æœºåˆ¶ï¼Œä½†å®ƒä»¬çš„è®¾è®¡ç›®çš„å’Œä½¿ç”¨åœºæ™¯æœ‰æ˜¾è‘—ä¸åŒï¼š</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>ç‰¹æ€§</th>\n<th>Config</th>\n<th>Volume</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>ç”¨é€”</td>\n<td>åªèƒ½æ˜¯æ–‡ä»¶ï¼Œç”¨äºå­˜å‚¨é…ç½®æ–‡ä»¶ã€åªè¯»æ•°æ®</td>\n<td>æ–‡ä»¶ç›®å½•å‡å¯ï¼Œå­˜å‚¨åº”ç”¨æ•°æ®ã€å¯è¯»å†™æ•°æ®</td>\n</tr>\n<tr>\n<td>å¯å˜æ€§</td>\n<td>é€šå¸¸ä¸å¯å˜ï¼ˆåªè¯»ï¼‰</td>\n<td>å¯å˜ï¼ˆè¯»å†™ï¼‰</td>\n</tr>\n<tr>\n<td>ç”Ÿå‘½å‘¨æœŸ</td>\n<td>éšæœåŠ¡éƒ¨ç½²æ›´æ–°</td>\n<td>ç‹¬ç«‹äºå®¹å™¨ç”Ÿå‘½å‘¨æœŸ</td>\n</tr>\n<tr>\n<td>å­˜å‚¨ä½ç½®</td>\n<td>å­˜å‚¨åœ¨Dockerç®¡ç†çš„å†…å­˜/æ–‡ä»¶ç³»ç»Ÿ</td>\n<td>å­˜å‚¨åœ¨ä¸»æœºæ–‡ä»¶ç³»ç»Ÿæˆ–ç½‘ç»œå­˜å‚¨</td>\n</tr>\n<tr>\n<td>Swarmæ”¯æŒ</td>\n<td>åŸç”ŸSwarmåŠŸèƒ½</td>\n<td>é€šç”¨åŠŸèƒ½</td>\n</tr>\n<tr>\n<td>æ›´æ–°æœºåˆ¶</td>\n<td>æ›´æ–°éœ€è¦é‡æ–°éƒ¨ç½²æœåŠ¡</td>\n<td>å¯åŠ¨æ€æ›´æ–°</td>\n</tr>\n<tr>\n<td>å…¸å‹ç”¨ä¾‹</td>\n<td>é…ç½®æ–‡ä»¶ã€ç¯å¢ƒå˜é‡</td>\n<td>æ•°æ®åº“æ–‡ä»¶ã€æ—¥å¿—ã€ç”¨æˆ·ä¸Šä¼ å†…å®¹</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"Config-å‘½ä»¤\">Config å‘½ä»¤</h3>\n<table>\n<thead>\n<tr>\n<th>å‘½ä»¤</th>\n<th>ä¸­æ–‡è¯´æ˜</th>\n<th>ç¤ºä¾‹</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>create</code></td>\n<td>ä»æ–‡ä»¶æˆ–æ ‡å‡†è¾“å…¥åˆ›å»ºä¸€ä¸ª config</td>\n<td><code>docker config create my_config config.txt</code></td>\n</tr>\n<tr>\n<td><code>inspect</code></td>\n<td>æ˜¾ç¤ºä¸€ä¸ªæˆ–å¤šä¸ª config çš„è¯¦ç»†ä¿¡æ¯</td>\n<td><code>docker config inspect my_config</code></td>\n</tr>\n<tr>\n<td><code>ls</code></td>\n<td>åˆ—å‡ºæ‰€æœ‰ configs</td>\n<td><code>docker config ls</code></td>\n</tr>\n<tr>\n<td><code>rm</code></td>\n<td>åˆ é™¤ä¸€ä¸ªæˆ–å¤šä¸ª config</td>\n<td><code>docker config rm my_config</code></td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"docker-config-create-åˆ›å»ºä¸€ä¸ª-config\"><code>docker config create</code>:  åˆ›å»ºä¸€ä¸ª config</h4>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ä»æ–‡ä»¶ä¸­åˆ›å»º</span></span><br><span class=\"line\">docker config create my_config my_config.json</span><br><span class=\"line\"><span class=\"comment\"># ä»æ ‡å‡†è¾“å…¥åˆ›å»º</span></span><br><span class=\"line\"><span class=\"built_in\">cat</span> my_config.json | docker config create my_config -</span><br></pre></td></tr></table></figure>\n<h4 id=\"docker-config-inspect-æŸ¥çœ‹-config-çš„ä¿¡æ¯\"><code>docker config inspect</code>:  æŸ¥çœ‹ config çš„ä¿¡æ¯</h4>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker config inspect my_config</span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡ºï¼Œå¯ä»¥çœ‹åˆ° Data å­—æ®µï¼Œç”¨ base64 è§£ç åï¼Œå°±æ˜¯ config çš„åŸå§‹å†…å®¹</span></span><br><span class=\"line\">[</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;ID&quot;</span>: <span class=\"string\">&quot;q4257t5c2wq6uvvkm4g3hssae&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;Version&quot;</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;Index&quot;</span>: 3145</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;CreatedAt&quot;</span>: <span class=\"string\">&quot;2025-06-10T06:09:25.712614071Z&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;UpdatedAt&quot;</span>: <span class=\"string\">&quot;2025-06-10T06:09:25.712614071Z&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;Spec&quot;</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;Name&quot;</span>: <span class=\"string\">&quot;my_config&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;Labels&quot;</span>: &#123;&#125;,</span><br><span class=\"line\">            <span class=\"string\">&quot;Data&quot;</span>: <span class=\"string\">&quot;WwogICAgewogICAgICAgICJJRCI6ICJxbGtsc2t2eHRocDYxaTBuYnZ6dnI2d3V3IiwKICAgICAgICAiVmVyc2lvbiI6IHsKICAgICAgICAgICAgIkluZGV4IjogMzE0NAogICAgICAgIH0sCiAgICAgICAgIkNyZWF0ZWRBdCI6ICIyMDI1LTA2LTEwVDA2OjA3OjAzLjQwMzg4OTU2NVoiLAogICAgICAgICJVcGRhdGVkQXQiOiAiMjAyNS0wNi0xMFQwNjowNzowMy40MDM4ODk1NjVaIiwKICAgICAgICAiU3BlYyI6IHsKICAgICAgICAgICAgIk5hbWUiOiAibXlfc2VjcmV0IiwKICAgICAgICAgICAgIkxhYmVscyI6IHt9CiAgICAgICAgfQogICAgfQpdCg==&quot;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">]</span><br><span class=\"line\"><span class=\"comment\"># è§£ç </span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;WwogICAgewogICAgICAgICJJRCI6ICJxbGtsc2t2eHRocDYxaTBuYnZ6dnI2d3V3IiwKICAgICAgICAiVmVyc2lvbiI6IHsKICAgICAgICAgICAgIkluZGV4IjogMzE0NAogICAgICAgIH0sCiAgICAgICAgIkNyZWF0ZWRBdCI6ICIyMDI1LTA2LTEwVDA2OjA3OjAzLjQwMzg4OTU2NVoiLAogICAgICAgICJVcGRhdGVkQXQiOiAiMjAyNS0wNi0xMFQwNjowNzowMy40MDM4ODk1NjVaIiwKICAgICAgICAiU3BlYyI6IHsKICAgICAgICAgICAgIk5hbWUiOiAibXlfc2VjcmV0IiwKICAgICAgICAgICAgIkxhYmVscyI6IHt9CiAgICAgICAgfQogICAgfQpdCg==&quot;</span> | <span class=\"built_in\">base64</span> -d</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æ›´æ˜“è¯»</span></span><br><span class=\"line\">docker config inspect --pretty my_config</span><br><span class=\"line\">docker config inspect --format <span class=\"string\">&quot;&#123;&#123;.ID&#125;&#125; &#123;&#123;.Spec.Name&#125;&#125;&quot;</span> my_config</span><br></pre></td></tr></table></figure>\n<h4 id=\"docker-config-ls-åˆ—å‡ºæ‰€æœ‰-config\"><code>docker config ls</code>:  åˆ—å‡ºæ‰€æœ‰ config</h4>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker config <span class=\"built_in\">ls</span></span><br><span class=\"line\"><span class=\"comment\">#  åªæ˜¾ç¤º ID</span></span><br><span class=\"line\">docker config <span class=\"built_in\">ls</span> -q</span><br></pre></td></tr></table></figure>\n<h4 id=\"docker-config-rm-åˆ é™¤ä¸€ä¸ªæˆ–å¤šä¸ª-config\"><code>docker config rm</code>:  åˆ é™¤ä¸€ä¸ªæˆ–å¤šä¸ª config</h4>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker config <span class=\"built_in\">rm</span> my_config</span><br><span class=\"line\"><span class=\"comment\"># åˆ é™¤å¤šä¸ª</span></span><br><span class=\"line\">docker config <span class=\"built_in\">rm</span> my_config1 my_config2</span><br><span class=\"line\"><span class=\"comment\"># åˆ é™¤æ‰€æœ‰ ï¼Œæ…é‡ä½¿ç”¨</span></span><br><span class=\"line\">docker config <span class=\"built_in\">rm</span> $(docker config <span class=\"built_in\">ls</span> -q)</span><br></pre></td></tr></table></figure>\n<h3 id=\"Stackä¸­ä½¿ç”¨Config\">Stackä¸­ä½¿ç”¨Config</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><a href=\"https://docs.docker.com/reference/compose-file/configs/\">Configs top-level elements</a></p>\n</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">configs:</span> <span class=\"comment\">#  å£°æ˜ config åˆ—è¡¨</span></span><br><span class=\"line\">  <span class=\"attr\">nginx_config:</span>  <span class=\"comment\">#  config åç§°</span></span><br><span class=\"line\">    <span class=\"attr\">file:</span> <span class=\"string\">./nginx/nginx.conf</span> <span class=\"comment\">#  config æ–‡ä»¶</span></span><br><span class=\"line\">  <span class=\"attr\">my_config:</span> <span class=\"comment\">#  ä½¿ç”¨å¤–éƒ¨ configï¼Œå³ docker config create åˆ›å»ºçš„</span></span><br><span class=\"line\">    <span class=\"attr\">external:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\">  <span class=\"attr\">web:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">nginx:alpine</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&quot;80:80&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">configs:</span> <span class=\"comment\"># æœåŠ¡ä½¿ç”¨ config</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">source:</span> <span class=\"string\">nginx_config</span> <span class=\"comment\"># æŒ‡å®š config åç§°</span></span><br><span class=\"line\">        <span class=\"attr\">target:</span> <span class=\"string\">/etc/nginx/nginx.conf</span> <span class=\"comment\"># æŒ‡å®šå®¹å™¨ä¸­é…ç½®æ–‡ä»¶å­˜æ”¾ä½ç½®</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">source:</span> <span class=\"string\">my_config</span>  <span class=\"comment\">#  ä½¿ç”¨å¤–éƒ¨ config</span></span><br><span class=\"line\">        <span class=\"attr\">target:</span> <span class=\"string\">/app/config.json</span></span><br><span class=\"line\">        <span class=\"attr\">mode:</span> <span class=\"number\">0444</span> <span class=\"comment\">#  æŒ‡å®šæƒé™</span></span><br><span class=\"line\">        <span class=\"attr\">uid:</span> <span class=\"string\">&quot;1000&quot;</span> <span class=\"comment\"># æŒ‡å®šç”¨æˆ·</span></span><br><span class=\"line\">        <span class=\"attr\">gid:</span> <span class=\"string\">&quot;1000&quot;</span> <span class=\"comment\"># æŒ‡å®šç”¨æˆ·ç»„</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"Secret-ç®€ä»‹\">Secret ç®€ä»‹</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Secrets æ˜¯ Docker ä¸“é—¨ä¸ºæ•æ„Ÿæ•°æ®è®¾è®¡çš„å®‰å…¨ç®¡ç†æœºåˆ¶ï¼Œç”¨äºå®‰å…¨åœ°å­˜å‚¨å’Œä¼ è¾“å¯†ç ã€APIå¯†é’¥ã€TLSè¯ä¹¦ç­‰æ•æ„Ÿä¿¡æ¯ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>ä¸ Configs çš„ä¸»è¦åŒºåˆ«</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>ç‰¹æ€§</th>\n<th>Secrets</th>\n<th>Configs</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>ç”¨é€”</td>\n<td>æ•æ„Ÿæ•°æ®ï¼ˆå¯†ç ã€å¯†é’¥ç­‰ï¼‰</td>\n<td>æ™®é€šé…ç½®æ–‡ä»¶</td>\n</tr>\n<tr>\n<td>å­˜å‚¨</td>\n<td>åŠ å¯†å­˜å‚¨</td>\n<td>æ˜æ–‡å­˜å‚¨</td>\n</tr>\n<tr>\n<td>ä¼ è¾“</td>\n<td>åŠ å¯†ä¼ è¾“</td>\n<td>æ˜æ–‡ä¼ è¾“</td>\n</tr>\n<tr>\n<td>è®¿é—®</td>\n<td>æŒ‚è½½ä¸ºå†…å­˜æ–‡ä»¶</td>\n<td>å¸¸è§„æ–‡ä»¶æŒ‚è½½</td>\n</tr>\n<tr>\n<td>æƒé™</td>\n<td>é»˜è®¤ä»… root å¯è¯»ï¼ˆ0440ï¼‰</td>\n<td>å¯è‡ªå®šä¹‰æƒé™</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"Secret-å‘½ä»¤\">Secret å‘½ä»¤</h3>\n<table>\n<thead>\n<tr>\n<th>å‘½ä»¤</th>\n<th>ä¸­æ–‡è¯´æ˜</th>\n<th>ç¤ºä¾‹</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>create</code></td>\n<td>ä»æ–‡ä»¶æˆ–æ ‡å‡†è¾“å…¥åˆ›å»ºä¸€ä¸ª secret</td>\n<td><code>docker secret create my_secret secret.txt</code></td>\n</tr>\n<tr>\n<td><code>inspect</code></td>\n<td>æ˜¾ç¤ºä¸€ä¸ªæˆ–å¤šä¸ª secret çš„è¯¦ç»†ä¿¡æ¯</td>\n<td><code>docker secret inspect my_secret</code></td>\n</tr>\n<tr>\n<td><code>ls</code></td>\n<td>åˆ—å‡ºæ‰€æœ‰ secrets</td>\n<td><code>docker secret ls</code></td>\n</tr>\n<tr>\n<td><code>rm</code></td>\n<td>åˆ é™¤ä¸€ä¸ªæˆ–å¤šä¸ª secret</td>\n<td><code>docker secret rm my_secret</code></td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"docker-secret-create-åˆ›å»ºä¸€ä¸ª-secret\"><code>docker secret create</code>:  åˆ›å»ºä¸€ä¸ª secret</h4>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ä»æ–‡ä»¶ä¸­åˆ›å»º</span></span><br><span class=\"line\">docker secret create my_secret my_secret.txt</span><br><span class=\"line\"><span class=\"comment\"># ä»æ ‡å‡†è¾“å…¥åˆ›å»º</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;my_secret&quot;</span> | docker secret create my_secret -</span><br></pre></td></tr></table></figure>\n<h4 id=\"docker-secret-inspect-æŸ¥çœ‹-secret-çš„ä¿¡æ¯\"><code>docker secret inspect</code>:  æŸ¥çœ‹ secret çš„ä¿¡æ¯</h4>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker secret inspect my_secret</span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡ºï¼Œå¯ä»¥çœ‹åˆ° æ²¡æœ‰ data å­—æ®µï¼Œæ‰€ä»¥æ— æ³•æŸ¥çœ‹åŸå§‹çš„å†…å®¹</span></span><br><span class=\"line\">[</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;ID&quot;</span>: <span class=\"string\">&quot;qlklskvxthp61i0nbvzvr6wuw&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;Version&quot;</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;Index&quot;</span>: 3144</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;CreatedAt&quot;</span>: <span class=\"string\">&quot;2025-06-10T06:07:03.403889565Z&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;UpdatedAt&quot;</span>: <span class=\"string\">&quot;2025-06-10T06:07:03.403889565Z&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;Spec&quot;</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;Name&quot;</span>: <span class=\"string\">&quot;my_secret&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;Labels&quot;</span>: &#123;&#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">]</span><br><span class=\"line\"><span class=\"comment\"># è¾“å‡ºæ›´æ˜“è¯»</span></span><br><span class=\"line\">docker secret inspect --pretty my_secret</span><br><span class=\"line\">docker secret inspect --format <span class=\"string\">&quot;&#123;&#123;.ID&#125;&#125; &#123;&#123;.Spec.Name&#125;&#125;&quot;</span> my_secret</span><br></pre></td></tr></table></figure>\n<h4 id=\"docker-secret-ls-åˆ—å‡ºæ‰€æœ‰çš„-secret\"><code>docker secret ls</code>:  åˆ—å‡ºæ‰€æœ‰çš„ secret</h4>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker secret <span class=\"built_in\">ls</span></span><br><span class=\"line\"><span class=\"comment\"># åˆ—å‡ºæ‰€æœ‰çš„ secret çš„ ID</span></span><br><span class=\"line\">docker secret <span class=\"built_in\">ls</span> -q</span><br><span class=\"line\">docker secret <span class=\"built_in\">ls</span> --filter name=my_secret</span><br></pre></td></tr></table></figure>\n<h4 id=\"docker-secret-rm-åˆ é™¤-secret\"><code>docker secret rm</code>:  åˆ é™¤ secret</h4>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker secret <span class=\"built_in\">rm</span> my_secret</span><br><span class=\"line\"><span class=\"comment\"># åˆ é™¤æ‰€æœ‰ï¼Œæ…é‡ä½¿ç”¨</span></span><br><span class=\"line\">docker secret <span class=\"built_in\">rm</span> $(docker secret <span class=\"built_in\">ls</span> -q)</span><br></pre></td></tr></table></figure>\n<h3 id=\"Stackä¸­ä½¿ç”¨Secret\">Stackä¸­ä½¿ç”¨Secret</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><a href=\"https://docs.docker.com/reference/compose-file/secrets/\">Secrets top-level elements</a></p>\n</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\">  <span class=\"attr\">mysql:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">mysql:8.0</span></span><br><span class=\"line\">    <span class=\"attr\">environment:</span></span><br><span class=\"line\">      <span class=\"attr\">MYSQL_ROOT_PASSWORD_FILE:</span> <span class=\"string\">/run/secrets/db_root_password</span></span><br><span class=\"line\">    <span class=\"attr\">secrets:</span> <span class=\"comment\"># å…³è”secretï¼Œå®¹å™¨å†…å…³è”è·¯å¾„ä¸º /run/secrets/&lt;secret_name&gt;</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">db_root_password</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">my_secret</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">secrets:</span> <span class=\"comment\"># å£°æ˜ secret åˆ—è¡¨</span></span><br><span class=\"line\">  <span class=\"attr\">db_root_password:</span> <span class=\"comment\">#  secret åç§°</span></span><br><span class=\"line\">    <span class=\"attr\">file:</span> <span class=\"string\">./mysql_root_password.txt</span> <span class=\"comment\">#  secret æ–‡ä»¶</span></span><br><span class=\"line\">  <span class=\"attr\">my_secret:</span> <span class=\"comment\"># ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨é¢„åˆ›å»ºçš„secret</span></span><br><span class=\"line\">    <span class=\"attr\">external:</span> <span class=\"literal\">true</span>  <span class=\"comment\"># å¼•ç”¨é¢„å…ˆåˆ›å»ºçš„secret</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ä¼˜åŒ–: ä½¿ç”¨érootç”¨æˆ·ï¼Œå¹¶éšè— secret æ–‡ä»¶</p>\n</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\">  <span class=\"attr\">mysql:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">mysql:8.0</span></span><br><span class=\"line\">    <span class=\"attr\">user:</span> <span class=\"string\">&quot;mysql:mysql&quot;</span>  <span class=\"comment\"># å…³é”®ç‚¹1ï¼šä½¿ç”¨érootç”¨æˆ·</span></span><br><span class=\"line\">    <span class=\"attr\">environment:</span></span><br><span class=\"line\">      <span class=\"attr\">MYSQL_ROOT_PASSWORD_FILE:</span> <span class=\"string\">/run/secrets/.db_root_password</span>  <span class=\"comment\"># å…³é”®ç‚¹2ï¼šéšè—æ–‡ä»¶</span></span><br><span class=\"line\">    <span class=\"attr\">secrets:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">source:</span> <span class=\"string\">db_root_password</span></span><br><span class=\"line\">        <span class=\"attr\">target:</span> <span class=\"string\">.db_root_password</span>  <span class=\"comment\"># éšè—æ–‡ä»¶å</span></span><br><span class=\"line\">        <span class=\"attr\">uid:</span> <span class=\"string\">&quot;999&quot;</span>  <span class=\"comment\"># mysqlç”¨æˆ·ID</span></span><br><span class=\"line\">        <span class=\"attr\">gid:</span> <span class=\"string\">&quot;999&quot;</span>  <span class=\"comment\"># mysqlç»„ID</span></span><br><span class=\"line\">        <span class=\"attr\">mode:</span> <span class=\"number\">0400</span>  <span class=\"comment\"># ä»…æ‹¥æœ‰è€…å¯è¯»</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">source:</span> <span class=\"string\">my_secret</span></span><br><span class=\"line\">        <span class=\"attr\">target:</span> <span class=\"string\">.my_secret</span></span><br><span class=\"line\">        <span class=\"attr\">uid:</span> <span class=\"string\">&quot;999&quot;</span></span><br><span class=\"line\">        <span class=\"attr\">gid:</span> <span class=\"string\">&quot;999&quot;</span></span><br><span class=\"line\">        <span class=\"attr\">mode:</span> <span class=\"number\">0400</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">secrets:</span></span><br><span class=\"line\">  <span class=\"attr\">db_root_password:</span></span><br><span class=\"line\">    <span class=\"attr\">file:</span> <span class=\"string\">./mysql_root_password.txt</span></span><br><span class=\"line\">  <span class=\"attr\">my_secret:</span></span><br><span class=\"line\">    <span class=\"attr\">external:</span> <span class=\"literal\">true</span></span><br></pre></td></tr></table></figure>","content_text":"æ‘˜è¦ æœ¬æ–‡ä»‹ç» Docker Swarm ä¸­çš„ Config ä¸ Secret Dockerå®˜æ–¹æ–‡æ¡£ Docker Swarm å®˜æ–¹æ–‡æ¡£ Compose file reference Config ç®€ä»‹ åœ¨ Docker Swarm ä¸­ï¼ŒConfig æ˜¯ä¸€ç§ç”¨äºç®¡ç†é…ç½®èµ„æºçš„æœºåˆ¶ï¼Œå…è®¸ä½ å°†é…ç½®æ–‡ä»¶ä¸å®¹å™¨åˆ†ç¦»ï¼Œä¾¿äºåœ¨ä¸åŒç¯å¢ƒä¸­é‡ç”¨å’Œå…±äº«é…ç½®ã€‚ Config å’Œ Volume éƒ½æ˜¯ Docker ä¸­ç”¨äºç®¡ç†æ•°æ®çš„æœºåˆ¶ï¼Œä½†å®ƒä»¬çš„è®¾è®¡ç›®çš„å’Œä½¿ç”¨åœºæ™¯æœ‰æ˜¾è‘—ä¸åŒï¼š ç‰¹æ€§ Config Volume ç”¨é€” åªèƒ½æ˜¯æ–‡ä»¶ï¼Œç”¨äºå­˜å‚¨é…ç½®æ–‡ä»¶ã€åªè¯»æ•°æ® æ–‡ä»¶ç›®å½•å‡å¯ï¼Œå­˜å‚¨åº”ç”¨æ•°æ®ã€å¯è¯»å†™æ•°æ® å¯å˜æ€§ é€šå¸¸ä¸å¯å˜ï¼ˆåªè¯»ï¼‰ å¯å˜ï¼ˆè¯»å†™ï¼‰ ç”Ÿå‘½å‘¨æœŸ éšæœåŠ¡éƒ¨ç½²æ›´æ–° ç‹¬ç«‹äºå®¹å™¨ç”Ÿå‘½å‘¨æœŸ å­˜å‚¨ä½ç½® å­˜å‚¨åœ¨Dockerç®¡ç†çš„å†…å­˜/æ–‡ä»¶ç³»ç»Ÿ å­˜å‚¨åœ¨ä¸»æœºæ–‡ä»¶ç³»ç»Ÿæˆ–ç½‘ç»œå­˜å‚¨ Swarmæ”¯æŒ åŸç”ŸSwarmåŠŸèƒ½ é€šç”¨åŠŸèƒ½ æ›´æ–°æœºåˆ¶ æ›´æ–°éœ€è¦é‡æ–°éƒ¨ç½²æœåŠ¡ å¯åŠ¨æ€æ›´æ–° å…¸å‹ç”¨ä¾‹ é…ç½®æ–‡ä»¶ã€ç¯å¢ƒå˜é‡ æ•°æ®åº“æ–‡ä»¶ã€æ—¥å¿—ã€ç”¨æˆ·ä¸Šä¼ å†…å®¹ Config å‘½ä»¤ å‘½ä»¤ ä¸­æ–‡è¯´æ˜ ç¤ºä¾‹ create ä»æ–‡ä»¶æˆ–æ ‡å‡†è¾“å…¥åˆ›å»ºä¸€ä¸ª config docker config create my_config config.txt inspect æ˜¾ç¤ºä¸€ä¸ªæˆ–å¤šä¸ª config çš„è¯¦ç»†ä¿¡æ¯ docker config inspect my_config ls åˆ—å‡ºæ‰€æœ‰ configs docker config ls rm åˆ é™¤ä¸€ä¸ªæˆ–å¤šä¸ª config docker config rm my_config docker config create: åˆ›å»ºä¸€ä¸ª config 1234# ä»æ–‡ä»¶ä¸­åˆ›å»ºdocker config create my_config my_config.json# ä»æ ‡å‡†è¾“å…¥åˆ›å»ºcat my_config.json | docker config create my_config - docker config inspect: æŸ¥çœ‹ config çš„ä¿¡æ¯ 123456789101112131415161718192021222324docker config inspect my_config## è¾“å‡ºï¼Œå¯ä»¥çœ‹åˆ° Data å­—æ®µï¼Œç”¨ base64 è§£ç åï¼Œå°±æ˜¯ config çš„åŸå§‹å†…å®¹[ &#123; &quot;ID&quot;: &quot;q4257t5c2wq6uvvkm4g3hssae&quot;, &quot;Version&quot;: &#123; &quot;Index&quot;: 3145 &#125;, &quot;CreatedAt&quot;: &quot;2025-06-10T06:09:25.712614071Z&quot;, &quot;UpdatedAt&quot;: &quot;2025-06-10T06:09:25.712614071Z&quot;, &quot;Spec&quot;: &#123; &quot;Name&quot;: &quot;my_config&quot;, &quot;Labels&quot;: &#123;&#125;, &quot;Data&quot;: &quot;WwogICAgewogICAgICAgICJJRCI6ICJxbGtsc2t2eHRocDYxaTBuYnZ6dnI2d3V3IiwKICAgICAgICAiVmVyc2lvbiI6IHsKICAgICAgICAgICAgIkluZGV4IjogMzE0NAogICAgICAgIH0sCiAgICAgICAgIkNyZWF0ZWRBdCI6ICIyMDI1LTA2LTEwVDA2OjA3OjAzLjQwMzg4OTU2NVoiLAogICAgICAgICJVcGRhdGVkQXQiOiAiMjAyNS0wNi0xMFQwNjowNzowMy40MDM4ODk1NjVaIiwKICAgICAgICAiU3BlYyI6IHsKICAgICAgICAgICAgIk5hbWUiOiAibXlfc2VjcmV0IiwKICAgICAgICAgICAgIkxhYmVscyI6IHt9CiAgICAgICAgfQogICAgfQpdCg==&quot; &#125; &#125;]# è§£ç echo &quot;WwogICAgewogICAgICAgICJJRCI6ICJxbGtsc2t2eHRocDYxaTBuYnZ6dnI2d3V3IiwKICAgICAgICAiVmVyc2lvbiI6IHsKICAgICAgICAgICAgIkluZGV4IjogMzE0NAogICAgICAgIH0sCiAgICAgICAgIkNyZWF0ZWRBdCI6ICIyMDI1LTA2LTEwVDA2OjA3OjAzLjQwMzg4OTU2NVoiLAogICAgICAgICJVcGRhdGVkQXQiOiAiMjAyNS0wNi0xMFQwNjowNzowMy40MDM4ODk1NjVaIiwKICAgICAgICAiU3BlYyI6IHsKICAgICAgICAgICAgIk5hbWUiOiAibXlfc2VjcmV0IiwKICAgICAgICAgICAgIkxhYmVscyI6IHt9CiAgICAgICAgfQogICAgfQpdCg==&quot; | base64 -d# æ›´æ˜“è¯»docker config inspect --pretty my_configdocker config inspect --format &quot;&#123;&#123;.ID&#125;&#125; &#123;&#123;.Spec.Name&#125;&#125;&quot; my_config docker config ls: åˆ—å‡ºæ‰€æœ‰ config 123docker config ls# åªæ˜¾ç¤º IDdocker config ls -q docker config rm: åˆ é™¤ä¸€ä¸ªæˆ–å¤šä¸ª config 12345docker config rm my_config# åˆ é™¤å¤šä¸ªdocker config rm my_config1 my_config2# åˆ é™¤æ‰€æœ‰ ï¼Œæ…é‡ä½¿ç”¨docker config rm $(docker config ls -q) Stackä¸­ä½¿ç”¨Config Configs top-level elements 12345678910111213141516171819configs: # å£°æ˜ config åˆ—è¡¨ nginx_config: # config åç§° file: ./nginx/nginx.conf # config æ–‡ä»¶ my_config: # ä½¿ç”¨å¤–éƒ¨ configï¼Œå³ docker config create åˆ›å»ºçš„ external: trueservices: web: image: nginx:alpine ports: - &quot;80:80&quot; configs: # æœåŠ¡ä½¿ç”¨ config - source: nginx_config # æŒ‡å®š config åç§° target: /etc/nginx/nginx.conf # æŒ‡å®šå®¹å™¨ä¸­é…ç½®æ–‡ä»¶å­˜æ”¾ä½ç½® - source: my_config # ä½¿ç”¨å¤–éƒ¨ config target: /app/config.json mode: 0444 # æŒ‡å®šæƒé™ uid: &quot;1000&quot; # æŒ‡å®šç”¨æˆ· gid: &quot;1000&quot; # æŒ‡å®šç”¨æˆ·ç»„ Secret ç®€ä»‹ Secrets æ˜¯ Docker ä¸“é—¨ä¸ºæ•æ„Ÿæ•°æ®è®¾è®¡çš„å®‰å…¨ç®¡ç†æœºåˆ¶ï¼Œç”¨äºå®‰å…¨åœ°å­˜å‚¨å’Œä¼ è¾“å¯†ç ã€APIå¯†é’¥ã€TLSè¯ä¹¦ç­‰æ•æ„Ÿä¿¡æ¯ã€‚ ä¸ Configs çš„ä¸»è¦åŒºåˆ« ç‰¹æ€§ Secrets Configs ç”¨é€” æ•æ„Ÿæ•°æ®ï¼ˆå¯†ç ã€å¯†é’¥ç­‰ï¼‰ æ™®é€šé…ç½®æ–‡ä»¶ å­˜å‚¨ åŠ å¯†å­˜å‚¨ æ˜æ–‡å­˜å‚¨ ä¼ è¾“ åŠ å¯†ä¼ è¾“ æ˜æ–‡ä¼ è¾“ è®¿é—® æŒ‚è½½ä¸ºå†…å­˜æ–‡ä»¶ å¸¸è§„æ–‡ä»¶æŒ‚è½½ æƒé™ é»˜è®¤ä»… root å¯è¯»ï¼ˆ0440ï¼‰ å¯è‡ªå®šä¹‰æƒé™ Secret å‘½ä»¤ å‘½ä»¤ ä¸­æ–‡è¯´æ˜ ç¤ºä¾‹ create ä»æ–‡ä»¶æˆ–æ ‡å‡†è¾“å…¥åˆ›å»ºä¸€ä¸ª secret docker secret create my_secret secret.txt inspect æ˜¾ç¤ºä¸€ä¸ªæˆ–å¤šä¸ª secret çš„è¯¦ç»†ä¿¡æ¯ docker secret inspect my_secret ls åˆ—å‡ºæ‰€æœ‰ secrets docker secret ls rm åˆ é™¤ä¸€ä¸ªæˆ–å¤šä¸ª secret docker secret rm my_secret docker secret create: åˆ›å»ºä¸€ä¸ª secret 1234# ä»æ–‡ä»¶ä¸­åˆ›å»ºdocker secret create my_secret my_secret.txt# ä»æ ‡å‡†è¾“å…¥åˆ›å»ºecho &quot;my_secret&quot; | docker secret create my_secret - docker secret inspect: æŸ¥çœ‹ secret çš„ä¿¡æ¯ 12345678910111213141516171819docker secret inspect my_secret## è¾“å‡ºï¼Œå¯ä»¥çœ‹åˆ° æ²¡æœ‰ data å­—æ®µï¼Œæ‰€ä»¥æ— æ³•æŸ¥çœ‹åŸå§‹çš„å†…å®¹[ &#123; &quot;ID&quot;: &quot;qlklskvxthp61i0nbvzvr6wuw&quot;, &quot;Version&quot;: &#123; &quot;Index&quot;: 3144 &#125;, &quot;CreatedAt&quot;: &quot;2025-06-10T06:07:03.403889565Z&quot;, &quot;UpdatedAt&quot;: &quot;2025-06-10T06:07:03.403889565Z&quot;, &quot;Spec&quot;: &#123; &quot;Name&quot;: &quot;my_secret&quot;, &quot;Labels&quot;: &#123;&#125; &#125; &#125;]# è¾“å‡ºæ›´æ˜“è¯»docker secret inspect --pretty my_secretdocker secret inspect --format &quot;&#123;&#123;.ID&#125;&#125; &#123;&#123;.Spec.Name&#125;&#125;&quot; my_secret docker secret ls: åˆ—å‡ºæ‰€æœ‰çš„ secret 1234docker secret ls# åˆ—å‡ºæ‰€æœ‰çš„ secret çš„ IDdocker secret ls -qdocker secret ls --filter name=my_secret docker secret rm: åˆ é™¤ secret 123docker secret rm my_secret# åˆ é™¤æ‰€æœ‰ï¼Œæ…é‡ä½¿ç”¨docker secret rm $(docker secret ls -q) Stackä¸­ä½¿ç”¨Secret Secrets top-level elements 1234567891011121314services: mysql: image: mysql:8.0 environment: MYSQL_ROOT_PASSWORD_FILE: /run/secrets/db_root_password secrets: # å…³è”secretï¼Œå®¹å™¨å†…å…³è”è·¯å¾„ä¸º /run/secrets/&lt;secret_name&gt; - db_root_password - my_secretsecrets: # å£°æ˜ secret åˆ—è¡¨ db_root_password: # secret åç§° file: ./mysql_root_password.txt # secret æ–‡ä»¶ my_secret: # ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨é¢„åˆ›å»ºçš„secret external: true # å¼•ç”¨é¢„å…ˆåˆ›å»ºçš„secret ä¼˜åŒ–: ä½¿ç”¨érootç”¨æˆ·ï¼Œå¹¶éšè— secret æ–‡ä»¶ 123456789101112131415161718192021222324services: mysql: image: mysql:8.0 user: &quot;mysql:mysql&quot; # å…³é”®ç‚¹1ï¼šä½¿ç”¨érootç”¨æˆ· environment: MYSQL_ROOT_PASSWORD_FILE: /run/secrets/.db_root_password # å…³é”®ç‚¹2ï¼šéšè—æ–‡ä»¶ secrets: - source: db_root_password target: .db_root_password # éšè—æ–‡ä»¶å uid: &quot;999&quot; # mysqlç”¨æˆ·ID gid: &quot;999&quot; # mysqlç»„ID mode: 0400 # ä»…æ‹¥æœ‰è€…å¯è¯» - source: my_secret target: .my_secret uid: &quot;999&quot; gid: &quot;999&quot; mode: 0400secrets: db_root_password: file: ./mysql_root_password.txt my_secret: external: true","summary":"æ‘˜è¦ æœ¬æ–‡ä»‹ç» Docker Swarm ä¸­çš„ Config ä¸ Secret Dockerå®˜æ–¹æ–‡æ¡£ Docker Swarm å®˜æ–¹æ–‡æ¡£ Compose file reference","date_published":"2025-06-12T14:30:05.000Z","tags":["æŠ€æœ¯","docker","docker"]},{"id":"https://blog.hanqunfeng.com/2025/06/11/docker-swarm-stack/","url":"https://blog.hanqunfeng.com/2025/06/11/docker-swarm-stack/","title":"Docker Swarm ä¹‹ æ ˆ(Stack)","content_html":"<!--\n **åŠ ç²—**\n *æ–œä½“*\n ***åŠ ç²—å¹¶æ–œä½“***\n ~~åˆ é™¤çº¿~~\n ==çªå‡ºæ˜¾ç¤º==\n `çªå‡ºæ˜¾ç¤º(æ¨è)`\n ++ä¸‹åˆ’çº¿++\n ~ä¸‹æ ‡~\n ^ä¸Šæ ‡^\n è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference.\n å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)\n\n +++ **ç‚¹å‡»æŠ˜å **\n è¿™æ˜¯è¢«éšè—çš„å†…å®¹\n +++\n\n::: tips success warning danger\nè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹\n:::\n\n% note info % success warning danger\nè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹\n% endnote %\n\nå¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{}\n å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ\n -->\n<h2 id=\"æ‘˜è¦\">æ‘˜è¦</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æœ¬æ–‡ä»‹ç» Docker Swarm çš„ æ ˆç®¡ç†</p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://docs.docker.com\">Dockerå®˜æ–¹æ–‡æ¡£</a></p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://docs.docker.com/engine/swarm/\">Docker Swarm å®˜æ–¹æ–‡æ¡£</a></p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://docs.docker.com/reference/compose-file/\">Compose file reference</a></p>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"Stackç®€ä»‹\">Stackç®€ä»‹</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å‰é¢æˆ‘ä»¬åœ¨Swarmä¸­åˆ›å»ºæœåŠ¡éƒ½æ˜¯é€šè¿‡Serviceï¼Œæ¯æ¬¡åˆ›å»ºä¸€ä¸ªï¼Œæœ‰æ²¡æœ‰ç±»ä¼¼<code>docker compose</code>çš„æ–¹å¼æ¥åˆ›å»ºå¤šä¸ªæœåŠ¡å‘¢ï¼ŸDocker Swarmä¸ºæˆ‘ä»¬æä¾›äº†Stack</p>\n</li>\n<li class=\"lvl-2\">\n<p>åœ¨ Docker Swarm ä¸­ï¼ŒStackï¼ˆæ ˆï¼‰ æ˜¯ç”¨æ¥å®šä¹‰å’Œéƒ¨ç½²ä¸€ç»„ç›¸å…³æœåŠ¡çš„é›†åˆã€‚ä½ å¯ä»¥æŠŠå®ƒçœ‹æˆæ˜¯ä¸€ä¸ªåº”ç”¨çš„æ•´ä½“ï¼Œç”±å¤šä¸ªæœåŠ¡ï¼ˆserviceï¼‰ã€ç½‘ç»œï¼ˆnetworkï¼‰ã€å·ï¼ˆvolumeï¼‰ç­‰ç»„æˆã€‚</p>\n</li>\n</ul>\n<h2 id=\"Stack-é€šå¸¸ç”¨-Docker-Compose-æ–‡ä»¶ï¼ˆYAML-æ ¼å¼ï¼‰-æè¿°\">Stack é€šå¸¸ç”¨ Docker Compose æ–‡ä»¶ï¼ˆYAML æ ¼å¼ï¼‰ æè¿°</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Stack å®Œå…¨å…¼å®¹ Docker Compose æ–‡ä»¶ï¼Œå¹¶å¯ä»¥åœ¨ compose æ–‡ä»¶ä¸­å£°æ˜å‰¯æœ¬é›†ç­‰ä¸Serviceç›¸å…³çš„é…ç½®é¡¹ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>æˆ‘ç”¨è¡¨æ ¼æ€»ç»“ä¸€ä¸‹äºŒè€…çš„å·®å¼‚ï¼Œé‡ç‚¹æ”¾åœ¨ã€ŒStack æ”¯æŒçš„é…ç½®ã€ä¸Šï¼š</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>é…ç½®é¡¹</th>\n<th>Docker Compose (æœ¬åœ°)</th>\n<th>Docker Stack (Swarm é›†ç¾¤)</th>\n<th>è¯´æ˜</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>name</code></td>\n<td>âœ…</td>\n<td>âŒ</td>\n<td>Stack ä¸æ”¯æŒ name  å±æ€§</td>\n</tr>\n<tr>\n<td><code>build</code></td>\n<td>âœ…</td>\n<td>âŒ</td>\n<td>Stack ä¸æ”¯æŒ build å±æ€§ï¼Œåªèƒ½ä½¿ç”¨image</td>\n</tr>\n<tr>\n<td><code>deploy</code></td>\n<td>âŒï¼ˆéƒ¨åˆ†æ”¯æŒï¼Œé€šå¸¸è¢«å¿½ç•¥ï¼‰</td>\n<td>âœ…ï¼ˆæ ¸å¿ƒæ”¯æŒï¼‰</td>\n<td>Stack æ”¯æŒç”¨ <code>deploy</code> å®šä¹‰å‰¯æœ¬æ•°ã€èµ„æºé™åˆ¶ã€æ›´æ–°ç­–ç•¥ç­‰</td>\n</tr>\n<tr>\n<td><code>deploy.replicas</code></td>\n<td>âŒ</td>\n<td>âœ…</td>\n<td>å®šä¹‰æœåŠ¡å‰¯æœ¬æ•°</td>\n</tr>\n<tr>\n<td><code>deploy.resources</code></td>\n<td>âŒ</td>\n<td>âœ…</td>\n<td>å®šä¹‰ CPUã€å†…å­˜é™åˆ¶</td>\n</tr>\n<tr>\n<td><code>deploy.placement</code></td>\n<td>âŒ</td>\n<td>âœ…</td>\n<td>å®šä¹‰æœåŠ¡è°ƒåº¦ç­–ç•¥ï¼ˆåœ¨å“ªäº›èŠ‚ç‚¹ä¸Šè¿è¡Œï¼‰</td>\n</tr>\n<tr>\n<td><code>deploy.update_config</code></td>\n<td>âŒ</td>\n<td>âœ…</td>\n<td>å®šä¹‰æ»šåŠ¨æ›´æ–°çš„å‚æ•°</td>\n</tr>\n<tr>\n<td><code>deploy.restart_policy</code></td>\n<td>âŒ</td>\n<td>âœ…</td>\n<td>å®šä¹‰é‡å¯ç­–ç•¥</td>\n</tr>\n<tr>\n<td><code>deploy.mode</code></td>\n<td>âŒ</td>\n<td>âœ…</td>\n<td><code>replicated</code> æˆ– <code>global</code></td>\n</tr>\n<tr>\n<td><code>depends_on</code></td>\n<td>âœ…</td>\n<td>ğŸš«ï¼ˆè¢«å¿½ç•¥ï¼‰</td>\n<td>Stack ä¸æ”¯æŒå®¹å™¨å¯åŠ¨é¡ºåºæ§åˆ¶</td>\n</tr>\n<tr>\n<td><code>build</code></td>\n<td>âœ…</td>\n<td>ğŸš«ï¼ˆè¢«å¿½ç•¥ï¼‰</td>\n<td>Stack ä¸æ”¯æŒç›´æ¥æ„å»ºé•œåƒï¼Œåªèƒ½ç”¨å·²å­˜åœ¨çš„é•œåƒ</td>\n</tr>\n<tr>\n<td><code>network.external</code></td>\n<td>âœ…</td>\n<td>âœ…</td>\n<td>éƒ½æ”¯æŒå¤–éƒ¨ç½‘ç»œ</td>\n</tr>\n<tr>\n<td><code>volumes.external</code></td>\n<td>âœ…</td>\n<td>âœ…</td>\n<td>éƒ½æ”¯æŒå¤–éƒ¨å·</td>\n</tr>\n<tr>\n<td><code>configs</code></td>\n<td>ğŸš«</td>\n<td>âœ…</td>\n<td>Stack æ”¯æŒ Config å¯¹è±¡ï¼Œé€‚åˆé…ç½®æ–‡ä»¶ç®¡ç†</td>\n</tr>\n<tr>\n<td><code>secrets</code></td>\n<td>ğŸš«</td>\n<td>âœ…</td>\n<td>Stack æ”¯æŒ Secretsï¼Œç”¨äºå®‰å…¨å­˜å‚¨æ•æ„Ÿä¿¡æ¯</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ä»¥<a href=\"https://docs.portainer.io/\">Portainer:Dockerå¯è§†åŒ–ç®¡ç†å·¥å…·</a>çš„stacké…ç½®æ–‡ä»¶ä¸ºä¾‹</p>\n</li>\n</ul>\n<blockquote>\n<p>Portainer ç¤¾åŒºç‰ˆ ï¼ˆCEï¼‰å¯è®©æ‚¨åœ¨ Dockerã€Docker Swarmã€Kubernetes å’Œ Azure ACI ä¸­è½»æ¾æ„å»ºå’Œç®¡ç†å®¹å™¨ã€‚</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -L https://downloads.portainer.io/ce-lts/portainer-agent-stack.yml -o portainer-agent-stack.yml</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">version:</span> <span class=\"string\">&quot;3.2&quot;</span> <span class=\"comment\">#  docker-composeç‰ˆæœ¬ï¼Œæ–°ç‰ˆçš„dockerå·²ç»ä¸éœ€è¦é…ç½®ç‰ˆæœ¬å·äº†</span></span><br><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\">  <span class=\"attr\">agent:</span>  <span class=\"comment\"># agentæœåŠ¡</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">portainer/agent:lts</span> <span class=\"comment\"># é•œåƒï¼Œä¸èƒ½ä½¿ç”¨ Dockerfile</span></span><br><span class=\"line\">    <span class=\"attr\">volumes:</span>  <span class=\"comment\"># æŒ‚è½½å·</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">/var/run/docker.sock:/var/run/docker.sock</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">/var/lib/docker/volumes:/var/lib/docker/volumes</span></span><br><span class=\"line\">    <span class=\"attr\">networks:</span> <span class=\"comment\"># æŒ‚è½½ç½‘ç»œï¼Œå¿…é¡»æ˜¯ overlay</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">agent_network</span></span><br><span class=\"line\">    <span class=\"attr\">deploy:</span>   <span class=\"comment\"># éƒ¨ç½²ç­–ç•¥ï¼Œservice ç‰¹æœ‰å±æ€§</span></span><br><span class=\"line\">      <span class=\"attr\">mode:</span> <span class=\"string\">global</span> <span class=\"comment\"># å…¨å±€æ¨¡å¼</span></span><br><span class=\"line\">      <span class=\"attr\">placement:</span> <span class=\"comment\"># éƒ¨ç½²æ¡ä»¶</span></span><br><span class=\"line\">        <span class=\"attr\">constraints:</span> [<span class=\"string\">node.platform.os</span> <span class=\"string\">==</span> <span class=\"string\">linux</span>] <span class=\"comment\">#  è¿è¡Œåœ¨linuxèŠ‚ç‚¹</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"attr\">portainer:</span> <span class=\"comment\">#  portaineræœåŠ¡</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">portainer/portainer-ce:lts</span> <span class=\"comment\">#  é•œåƒ</span></span><br><span class=\"line\">    <span class=\"attr\">command:</span> <span class=\"string\">-H</span> <span class=\"string\">tcp://tasks.agent:9001</span> <span class=\"string\">--tlsskipverify</span> <span class=\"comment\">#  å¯åŠ¨å‚æ•°</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span> <span class=\"comment\"># ç«¯å£æ˜ å°„</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&quot;9443:9443&quot;</span>  <span class=\"comment\"># æµè§ˆå™¨è®¿é—® https://localhost:9443</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&quot;9000:9000&quot;</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&quot;8000:8000&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">volumes:</span> <span class=\"comment\">#  æŒ‚è½½å·</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">portainer_data:/data</span></span><br><span class=\"line\">    <span class=\"attr\">networks:</span> <span class=\"comment\"># æŒ‚è½½ç½‘ç»œï¼Œä¸agentæœåŠ¡ç½‘ç»œä¸€è‡´</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">agent_network</span></span><br><span class=\"line\">    <span class=\"attr\">deploy:</span> <span class=\"comment\">#  éƒ¨ç½²é…ç½®</span></span><br><span class=\"line\">      <span class=\"attr\">mode:</span> <span class=\"string\">replicated</span> <span class=\"comment\"># å‰¯æœ¬æ¨¡å¼</span></span><br><span class=\"line\">      <span class=\"attr\">replicas:</span> <span class=\"number\">1</span> <span class=\"comment\">#  å‰¯æœ¬æ•°é‡</span></span><br><span class=\"line\">      <span class=\"attr\">placement:</span> <span class=\"comment\">#  éƒ¨ç½²æ¡ä»¶</span></span><br><span class=\"line\">        <span class=\"attr\">constraints:</span> [<span class=\"string\">node.role</span> <span class=\"string\">==</span> <span class=\"string\">manager</span>] <span class=\"comment\">#  èŠ‚ç‚¹è§’è‰²ä¸ºmanager</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">networks:</span> <span class=\"comment\">#  ç½‘ç»œå£°æ˜</span></span><br><span class=\"line\">  <span class=\"attr\">agent_network:</span> <span class=\"comment\">#  ç½‘ç»œåç§°</span></span><br><span class=\"line\">    <span class=\"attr\">driver:</span> <span class=\"string\">overlay</span> <span class=\"comment\">#  ç½‘ç»œé©±åŠ¨</span></span><br><span class=\"line\">    <span class=\"attr\">attachable:</span> <span class=\"literal\">true</span> <span class=\"comment\"># å…è®¸å®¹å™¨åŠ å…¥</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">volumes:</span> <span class=\"comment\">#  æŒ‚è½½å·å£°æ˜</span></span><br><span class=\"line\">  <span class=\"attr\">portainer_data:</span> <span class=\"comment\">#  æŒ‚è½½å·åç§°</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"Stack-å‘½ä»¤\">Stack å‘½ä»¤</h2>\n<table>\n<thead>\n<tr>\n<th>å­å‘½ä»¤</th>\n<th>ä¸­æ–‡è¯´æ˜</th>\n<th>ç¤ºä¾‹å‘½ä»¤</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>config</code></td>\n<td>è¾“å‡ºæœ€ç»ˆçš„é…ç½®æ–‡ä»¶ï¼ˆç»è¿‡åˆå¹¶ä¸å˜é‡æ›¿æ¢åï¼‰</td>\n<td><code>docker stack config -c docker-compose.yml</code></td>\n</tr>\n<tr>\n<td><code>deploy</code></td>\n<td>éƒ¨ç½²æ–° stack æˆ–æ›´æ–°å·²æœ‰ stack</td>\n<td><code>docker stack deploy -c docker-compose.yml mystack</code></td>\n</tr>\n<tr>\n<td><code>ls</code></td>\n<td>åˆ—å‡ºæ‰€æœ‰å·²éƒ¨ç½²çš„ stack</td>\n<td><code>docker stack ls</code></td>\n</tr>\n<tr>\n<td><code>ps</code></td>\n<td>æŸ¥çœ‹ stack ä¸­çš„æ‰€æœ‰ä»»åŠ¡ï¼ˆå³å„ä¸ªå®¹å™¨å®ä¾‹ï¼‰</td>\n<td><code>docker stack ps mystack</code></td>\n</tr>\n<tr>\n<td><code>rm</code></td>\n<td>åˆ é™¤ä¸€ä¸ªæˆ–å¤šä¸ª stack</td>\n<td><code>docker stack rm mystack</code></td>\n</tr>\n<tr>\n<td><code>services</code></td>\n<td>åˆ—å‡ºæŸä¸ª stack ä¸­çš„æ‰€æœ‰æœåŠ¡</td>\n<td><code>docker stack services mystack</code></td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"docker-stack-config-è¾“å‡ºæœ€ç»ˆçš„é…ç½®æ–‡ä»¶\"><code>docker stack config</code>: è¾“å‡ºæœ€ç»ˆçš„é…ç½®æ–‡ä»¶</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># æ­¤å‘½ä»¤ä¹Ÿå¯ä»¥ç”¨æ¥éªŒè¯composeæ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®ï¼Œåªä¿è¯æ ¼å¼æ­£ç¡®ï¼Œä¸ä¿è¯é€»è¾‘æ­£ç¡®</span></span><br><span class=\"line\">docker stack config -c portainer-agent-stack.yml</span><br></pre></td></tr></table></figure>\n<h3 id=\"docker-stack-deploy-éƒ¨ç½²-stack\"><code>docker stack deploy</code>: éƒ¨ç½² stack</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-3\">\n<p><code>docker stack deploy</code> == <code>docker stack up</code></p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker stack deploy -c portainer-agent-stack.yml portainer</span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡º</span></span><br><span class=\"line\">Creating network portainer_agent_network</span><br><span class=\"line\">Creating service portainer_agent</span><br><span class=\"line\">Creating service portainer_portainer</span><br></pre></td></tr></table></figure>\n<h3 id=\"docker-stack-ls-åˆ—å‡ºæ‰€æœ‰-stack\"><code>docker stack ls</code>: åˆ—å‡ºæ‰€æœ‰ stack</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>docker stack ls</code> == <code>docker stack list</code></p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker stack <span class=\"built_in\">ls</span></span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡ºï¼Œstackåç§°ä¸ºportainerï¼Œå…¶å†…éƒ¨æœ‰ä¸¤ä¸ªæœåŠ¡ï¼Œagentå’Œportainer</span></span><br><span class=\"line\">NAME        SERVICES</span><br><span class=\"line\">portainer   2</span><br></pre></td></tr></table></figure>\n<h3 id=\"docker-stack-services-æŸ¥çœ‹æœåŠ¡\"><code>docker stack services</code>:  æŸ¥çœ‹æœåŠ¡</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker stack services portainer</span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡º</span></span><br><span class=\"line\">ID             NAME                  MODE         REPLICAS   IMAGE                        PORTS</span><br><span class=\"line\">h5foyujr6jq9   portainer_agent       global       5/5        portainer/agent:lts</span><br><span class=\"line\">zcek2jtloe09   portainer_portainer   replicated   1/1        portainer/portainer-ce:lts   *:8000-&gt;8000/tcp, *:9000-&gt;9000/tcp, *:9443-&gt;9443/tcp</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## ç­‰æ•ˆ</span></span><br><span class=\"line\">docker service <span class=\"built_in\">ls</span></span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡º</span></span><br><span class=\"line\">ID             NAME                  MODE         REPLICAS   IMAGE                        PORTS</span><br><span class=\"line\">h5foyujr6jq9   portainer_agent       global       5/5        portainer/agent:lts</span><br><span class=\"line\">zcek2jtloe09   portainer_portainer   replicated   1/1        portainer/portainer-ce:lts   *:8000-&gt;8000/tcp, *:9000-&gt;9000/tcp, *:9443-&gt;9443/tcp</span><br></pre></td></tr></table></figure>\n<h3 id=\"docker-stack-ps-åˆ—å‡º-stack-ä¸‹çš„æ‰€æœ‰æœåŠ¡å®ä¾‹\"><code>docker stack ps</code>: åˆ—å‡º stack ä¸‹çš„æ‰€æœ‰æœåŠ¡å®ä¾‹</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker stack ps portainer</span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡º</span></span><br><span class=\"line\">ID             NAME                                        IMAGE                        NODE       DESIRED STATE   CURRENT STATE            ERROR     PORTS</span><br><span class=\"line\">wshk9s6gyxh1   portainer_agent.hvzkh3ip5ef8gx973z1ywahbu   portainer/agent:lts          worker2    Running         Running 30 seconds ago</span><br><span class=\"line\">n3jjzmr2fcv9   portainer_agent.kp2zerd28xgz5mmglnje0jp22   portainer/agent:lts          manager1   Running         Running 59 seconds ago</span><br><span class=\"line\">24yy1ew3tiya   portainer_agent.oymi74epagdqeprah7s81tsa2   portainer/agent:lts          manager2   Running         Running 3 minutes ago</span><br><span class=\"line\">kpo4hhdvwcwd   portainer_agent.r7388xl84nczjtnf53pwh7hla   portainer/agent:lts          manager3   Running         Running 35 seconds ago</span><br><span class=\"line\">t8xjbotfuas0   portainer_agent.xkww4853bbdgv7bv8771xibob   portainer/agent:lts          worker1    Running         Running 48 seconds ago</span><br><span class=\"line\">qox3kqypon69   portainer_portainer.1                       portainer/portainer-ce:lts   manager2   Running         Running 2 minutes ago</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## ç­‰æ•ˆ</span></span><br><span class=\"line\">docker service ps portainer_agent portainer_portainer</span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡º</span></span><br><span class=\"line\">ID             NAME                                        IMAGE                        NODE       DESIRED STATE   CURRENT STATE            ERROR     PORTS</span><br><span class=\"line\">wshk9s6gyxh1   portainer_agent.hvzkh3ip5ef8gx973z1ywahbu   portainer/agent:lts          worker2    Running         Running 7 minutes ago</span><br><span class=\"line\">n3jjzmr2fcv9   portainer_agent.kp2zerd28xgz5mmglnje0jp22   portainer/agent:lts          manager1   Running         Running 8 minutes ago</span><br><span class=\"line\">24yy1ew3tiya   portainer_agent.oymi74epagdqeprah7s81tsa2   portainer/agent:lts          manager2   Running         Running 10 minutes ago</span><br><span class=\"line\">kpo4hhdvwcwd   portainer_agent.r7388xl84nczjtnf53pwh7hla   portainer/agent:lts          manager3   Running         Running 7 minutes ago</span><br><span class=\"line\">t8xjbotfuas0   portainer_agent.xkww4853bbdgv7bv8771xibob   portainer/agent:lts          worker1    Running         Running 7 minutes ago</span><br><span class=\"line\">qox3kqypon69   portainer_portainer.1                       portainer/portainer-ce:lts   manager2   Running         Running 10 minutes ago</span><br></pre></td></tr></table></figure>\n<h3 id=\"docker-stack-rm-åœæ­¢å¹¶åˆ é™¤-stack\"><code>docker stack rm</code>: åœæ­¢å¹¶åˆ é™¤ stack</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>docker stack rm</code> == <code>docker stack remove</code> == <code>docker stack down</code></p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker stack <span class=\"built_in\">rm</span> portainer</span><br></pre></td></tr></table></figure>\n<h2 id=\"deploy-å‚æ•°è¯¦è§£\"><code>deploy</code> å‚æ•°è¯¦è§£</h2>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\">  <span class=\"attr\">my-service:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">myapp:latest</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attr\">deploy:</span></span><br><span class=\"line\">      <span class=\"attr\">replicas:</span> <span class=\"number\">3</span>  <span class=\"comment\"># æŒ‡å®šå‰¯æœ¬æ•°ï¼Œä»…åœ¨ mode: replicated ä¸‹æœ‰æ•ˆã€‚è¡¨ç¤ºåŒæ—¶è¿è¡Œ3ä¸ªå®¹å™¨å‰¯æœ¬ã€‚</span></span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"attr\">mode:</span> <span class=\"string\">replicated</span>  <span class=\"comment\"># æœåŠ¡è¿è¡Œæ¨¡å¼ï¼Œå¯é€‰å€¼ï¼š</span></span><br><span class=\"line\">                        <span class=\"comment\"># - replicatedï¼šé€šè¿‡ replicas æŒ‡å®šå‰¯æœ¬æ•°é‡ï¼ˆé»˜è®¤ï¼‰</span></span><br><span class=\"line\">                        <span class=\"comment\"># - globalï¼šæ¯ä¸ªèŠ‚ç‚¹è¿è¡Œä¸€ä¸ªå‰¯æœ¬ï¼Œå¿½ç•¥ replicas é…ç½®</span></span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"attr\">resources:</span></span><br><span class=\"line\">        <span class=\"attr\">limits:</span>         <span class=\"comment\"># å®¹å™¨çš„â€œç¡¬é™åˆ¶â€ï¼Œè¶…è¿‡ä¼šè¢«å¼ºåˆ¶é™åˆ¶</span></span><br><span class=\"line\">          <span class=\"attr\">cpus:</span> <span class=\"string\">&#x27;1.0&#x27;</span>    <span class=\"comment\"># é™åˆ¶æ¯ä¸ªå®¹å™¨æœ€å¤šä½¿ç”¨1ä¸ªé€»è¾‘ CPU</span></span><br><span class=\"line\">          <span class=\"attr\">memory:</span> <span class=\"string\">512M</span>   <span class=\"comment\"># é™åˆ¶æ¯ä¸ªå®¹å™¨æœ€å¤šä½¿ç”¨512MBå†…å­˜</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"attr\">reservations:</span>   <span class=\"comment\"># å®¹å™¨çš„â€œè½¯é™åˆ¶â€ï¼ŒSwarmè°ƒåº¦æ—¶é¢„ç•™èµ„æºå‚è€ƒå€¼ï¼ˆä¸ä¼šå¼ºåˆ¶é™åˆ¶ï¼‰</span></span><br><span class=\"line\">          <span class=\"attr\">cpus:</span> <span class=\"string\">&#x27;0.25&#x27;</span>   <span class=\"comment\"># å»ºè®®æ¯ä¸ªå®¹å™¨è‡³å°‘åˆ†é…0.25ä¸ªCPU</span></span><br><span class=\"line\">          <span class=\"attr\">memory:</span> <span class=\"string\">128M</span>   <span class=\"comment\"># å»ºè®®æ¯ä¸ªå®¹å™¨è‡³å°‘åˆ†é…128MBå†…å­˜</span></span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"attr\">restart_policy:</span></span><br><span class=\"line\">        <span class=\"attr\">condition:</span> <span class=\"string\">on-failure</span>  <span class=\"comment\"># æ§åˆ¶å®¹å™¨é‡å¯è¡Œä¸ºï¼Œå¯é€‰å€¼ï¼š</span></span><br><span class=\"line\">                               <span class=\"comment\"># - noneï¼šä¸é‡å¯</span></span><br><span class=\"line\">                               <span class=\"comment\"># - on-failureï¼šå¤±è´¥æ—¶é‡å¯ï¼ˆé0é€€å‡ºç ï¼‰</span></span><br><span class=\"line\">                               <span class=\"comment\"># - anyï¼šæ— è®ºæ˜¯å¦å¤±è´¥éƒ½é‡å¯</span></span><br><span class=\"line\">        <span class=\"attr\">delay:</span> <span class=\"string\">5s</span>              <span class=\"comment\"># é‡å¯å‰ç­‰å¾…æ—¶é—´</span></span><br><span class=\"line\">        <span class=\"attr\">max_attempts:</span> <span class=\"number\">3</span>        <span class=\"comment\"># æœ€å¤šé‡å¯3æ¬¡</span></span><br><span class=\"line\">        <span class=\"attr\">window:</span> <span class=\"string\">60s</span>            <span class=\"comment\"># åˆ¤æ–­å¤±è´¥æ¬¡æ•°çš„æ—¶é—´çª—å£ï¼ˆ60ç§’å†…æœ€å¤šå¤±è´¥3æ¬¡ï¼‰</span></span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"attr\">placement:</span></span><br><span class=\"line\">        <span class=\"attr\">constraints:</span>           <span class=\"comment\"># æŒ‡å®šå®¹å™¨è°ƒåº¦åˆ°å“ªäº›èŠ‚ç‚¹ä¸Šè¿è¡Œï¼Œå¯ç”¨æ¡ä»¶æœ‰ï¼š</span></span><br><span class=\"line\">                               <span class=\"comment\"># - node.role == manager/worker</span></span><br><span class=\"line\">                               <span class=\"comment\"># - node.hostname == xxx</span></span><br><span class=\"line\">                               <span class=\"comment\"># - node.labels.xxx == yyy</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"string\">node.role</span> <span class=\"string\">==</span> <span class=\"string\">worker</span>  <span class=\"comment\"># åªè°ƒåº¦åˆ° worker èŠ‚ç‚¹</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"attr\">preferences:</span>           <span class=\"comment\"># è°ƒåº¦åå¥½ï¼ˆä¸æ˜¯å¼ºçº¦æŸï¼‰</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"attr\">spread:</span> <span class=\"string\">node.labels.zone</span>  <span class=\"comment\"># å°†æœåŠ¡å‡åŒ€åœ°åˆ†å¸ƒåœ¨ zone æ ‡ç­¾ä¸åŒçš„èŠ‚ç‚¹ä¸Š</span></span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"attr\">update_config:</span>           <span class=\"comment\"># æ§åˆ¶æœåŠ¡æ»šåŠ¨æ›´æ–°çš„è¡Œä¸º</span></span><br><span class=\"line\">        <span class=\"attr\">parallelism:</span> <span class=\"number\">2</span>         <span class=\"comment\"># æ¯æ¬¡æœ€å¤šå¹¶å‘æ›´æ–°2ä¸ªå®¹å™¨</span></span><br><span class=\"line\">        <span class=\"attr\">delay:</span> <span class=\"string\">10s</span>             <span class=\"comment\"># æ¯æ‰¹æ›´æ–°ä¹‹é—´ç­‰å¾…10ç§’</span></span><br><span class=\"line\">        <span class=\"attr\">failure_action:</span> <span class=\"string\">rollback</span>  <span class=\"comment\"># æ›´æ–°å¤±è´¥æ—¶çš„å¤„ç†æ–¹å¼ï¼Œå¯é€‰å€¼ï¼š</span></span><br><span class=\"line\">                                  <span class=\"comment\"># - pauseï¼šæš‚åœæ›´æ–°ï¼ˆé»˜è®¤ï¼‰</span></span><br><span class=\"line\">                                  <span class=\"comment\"># - continueï¼šç»§ç»­æ›´æ–°</span></span><br><span class=\"line\">                                  <span class=\"comment\"># - rollbackï¼šå›æ»šåˆ°æ—§ç‰ˆæœ¬</span></span><br><span class=\"line\">        <span class=\"attr\">order:</span> <span class=\"string\">stop-first</span>      <span class=\"comment\"># æ§åˆ¶æ›´æ–°é¡ºåºï¼Œå¯é€‰å€¼ï¼š</span></span><br><span class=\"line\">                               <span class=\"comment\"># - stop-firstï¼ˆå…ˆåœåå¯ï¼Œé»˜è®¤ï¼‰</span></span><br><span class=\"line\">                               <span class=\"comment\"># - start-firstï¼ˆå…ˆå¯ååœï¼Œé€‚ç”¨äºæ— çŠ¶æ€æœåŠ¡ï¼‰</span></span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"attr\">rollback_config:</span>         <span class=\"comment\"># å›æ»šæ—¶çš„è¡Œä¸ºï¼Œå­—æ®µä¸ update_config ç±»ä¼¼</span></span><br><span class=\"line\">        <span class=\"attr\">parallelism:</span> <span class=\"number\">1</span>         <span class=\"comment\"># å›æ»šæ—¶æ¯æ¬¡æœ€å¤šå¤„ç†1ä¸ªå®¹å™¨</span></span><br><span class=\"line\">        <span class=\"attr\">delay:</span> <span class=\"string\">5s</span>              <span class=\"comment\"># æ¯æ‰¹å›æ»šä¹‹é—´ç­‰å¾…5ç§’</span></span><br><span class=\"line\">        <span class=\"attr\">failure_action:</span> <span class=\"string\">pause</span>  <span class=\"comment\"># å›æ»šå¤±è´¥æ—¶æš‚åœ</span></span><br><span class=\"line\">        <span class=\"attr\">order:</span> <span class=\"string\">stop-first</span>      <span class=\"comment\"># å›æ»šæ—¶å…ˆåœå†å¯</span></span><br></pre></td></tr></table></figure>","content_text":"æ‘˜è¦ æœ¬æ–‡ä»‹ç» Docker Swarm çš„ æ ˆç®¡ç† Dockerå®˜æ–¹æ–‡æ¡£ Docker Swarm å®˜æ–¹æ–‡æ¡£ Compose file reference Stackç®€ä»‹ å‰é¢æˆ‘ä»¬åœ¨Swarmä¸­åˆ›å»ºæœåŠ¡éƒ½æ˜¯é€šè¿‡Serviceï¼Œæ¯æ¬¡åˆ›å»ºä¸€ä¸ªï¼Œæœ‰æ²¡æœ‰ç±»ä¼¼docker composeçš„æ–¹å¼æ¥åˆ›å»ºå¤šä¸ªæœåŠ¡å‘¢ï¼ŸDocker Swarmä¸ºæˆ‘ä»¬æä¾›äº†Stack åœ¨ Docker Swarm ä¸­ï¼ŒStackï¼ˆæ ˆï¼‰ æ˜¯ç”¨æ¥å®šä¹‰å’Œéƒ¨ç½²ä¸€ç»„ç›¸å…³æœåŠ¡çš„é›†åˆã€‚ä½ å¯ä»¥æŠŠå®ƒçœ‹æˆæ˜¯ä¸€ä¸ªåº”ç”¨çš„æ•´ä½“ï¼Œç”±å¤šä¸ªæœåŠ¡ï¼ˆserviceï¼‰ã€ç½‘ç»œï¼ˆnetworkï¼‰ã€å·ï¼ˆvolumeï¼‰ç­‰ç»„æˆã€‚ Stack é€šå¸¸ç”¨ Docker Compose æ–‡ä»¶ï¼ˆYAML æ ¼å¼ï¼‰ æè¿° Stack å®Œå…¨å…¼å®¹ Docker Compose æ–‡ä»¶ï¼Œå¹¶å¯ä»¥åœ¨ compose æ–‡ä»¶ä¸­å£°æ˜å‰¯æœ¬é›†ç­‰ä¸Serviceç›¸å…³çš„é…ç½®é¡¹ã€‚ æˆ‘ç”¨è¡¨æ ¼æ€»ç»“ä¸€ä¸‹äºŒè€…çš„å·®å¼‚ï¼Œé‡ç‚¹æ”¾åœ¨ã€ŒStack æ”¯æŒçš„é…ç½®ã€ä¸Šï¼š é…ç½®é¡¹ Docker Compose (æœ¬åœ°) Docker Stack (Swarm é›†ç¾¤) è¯´æ˜ name âœ… âŒ Stack ä¸æ”¯æŒ name å±æ€§ build âœ… âŒ Stack ä¸æ”¯æŒ build å±æ€§ï¼Œåªèƒ½ä½¿ç”¨image deploy âŒï¼ˆéƒ¨åˆ†æ”¯æŒï¼Œé€šå¸¸è¢«å¿½ç•¥ï¼‰ âœ…ï¼ˆæ ¸å¿ƒæ”¯æŒï¼‰ Stack æ”¯æŒç”¨ deploy å®šä¹‰å‰¯æœ¬æ•°ã€èµ„æºé™åˆ¶ã€æ›´æ–°ç­–ç•¥ç­‰ deploy.replicas âŒ âœ… å®šä¹‰æœåŠ¡å‰¯æœ¬æ•° deploy.resources âŒ âœ… å®šä¹‰ CPUã€å†…å­˜é™åˆ¶ deploy.placement âŒ âœ… å®šä¹‰æœåŠ¡è°ƒåº¦ç­–ç•¥ï¼ˆåœ¨å“ªäº›èŠ‚ç‚¹ä¸Šè¿è¡Œï¼‰ deploy.update_config âŒ âœ… å®šä¹‰æ»šåŠ¨æ›´æ–°çš„å‚æ•° deploy.restart_policy âŒ âœ… å®šä¹‰é‡å¯ç­–ç•¥ deploy.mode âŒ âœ… replicated æˆ– global depends_on âœ… ğŸš«ï¼ˆè¢«å¿½ç•¥ï¼‰ Stack ä¸æ”¯æŒå®¹å™¨å¯åŠ¨é¡ºåºæ§åˆ¶ build âœ… ğŸš«ï¼ˆè¢«å¿½ç•¥ï¼‰ Stack ä¸æ”¯æŒç›´æ¥æ„å»ºé•œåƒï¼Œåªèƒ½ç”¨å·²å­˜åœ¨çš„é•œåƒ network.external âœ… âœ… éƒ½æ”¯æŒå¤–éƒ¨ç½‘ç»œ volumes.external âœ… âœ… éƒ½æ”¯æŒå¤–éƒ¨å· configs ğŸš« âœ… Stack æ”¯æŒ Config å¯¹è±¡ï¼Œé€‚åˆé…ç½®æ–‡ä»¶ç®¡ç† secrets ğŸš« âœ… Stack æ”¯æŒ Secretsï¼Œç”¨äºå®‰å…¨å­˜å‚¨æ•æ„Ÿä¿¡æ¯ ä»¥Portainer:Dockerå¯è§†åŒ–ç®¡ç†å·¥å…·çš„stacké…ç½®æ–‡ä»¶ä¸ºä¾‹ Portainer ç¤¾åŒºç‰ˆ ï¼ˆCEï¼‰å¯è®©æ‚¨åœ¨ Dockerã€Docker Swarmã€Kubernetes å’Œ Azure ACI ä¸­è½»æ¾æ„å»ºå’Œç®¡ç†å®¹å™¨ã€‚ 1curl -L https://downloads.portainer.io/ce-lts/portainer-agent-stack.yml -o portainer-agent-stack.yml 1234567891011121314151617181920212223242526272829303132333435363738version: &quot;3.2&quot; # docker-composeç‰ˆæœ¬ï¼Œæ–°ç‰ˆçš„dockerå·²ç»ä¸éœ€è¦é…ç½®ç‰ˆæœ¬å·äº†services: agent: # agentæœåŠ¡ image: portainer/agent:lts # é•œåƒï¼Œä¸èƒ½ä½¿ç”¨ Dockerfile volumes: # æŒ‚è½½å· - /var/run/docker.sock:/var/run/docker.sock - /var/lib/docker/volumes:/var/lib/docker/volumes networks: # æŒ‚è½½ç½‘ç»œï¼Œå¿…é¡»æ˜¯ overlay - agent_network deploy: # éƒ¨ç½²ç­–ç•¥ï¼Œservice ç‰¹æœ‰å±æ€§ mode: global # å…¨å±€æ¨¡å¼ placement: # éƒ¨ç½²æ¡ä»¶ constraints: [node.platform.os == linux] # è¿è¡Œåœ¨linuxèŠ‚ç‚¹ portainer: # portaineræœåŠ¡ image: portainer/portainer-ce:lts # é•œåƒ command: -H tcp://tasks.agent:9001 --tlsskipverify # å¯åŠ¨å‚æ•° ports: # ç«¯å£æ˜ å°„ - &quot;9443:9443&quot; # æµè§ˆå™¨è®¿é—® https://localhost:9443 - &quot;9000:9000&quot; - &quot;8000:8000&quot; volumes: # æŒ‚è½½å· - portainer_data:/data networks: # æŒ‚è½½ç½‘ç»œï¼Œä¸agentæœåŠ¡ç½‘ç»œä¸€è‡´ - agent_network deploy: # éƒ¨ç½²é…ç½® mode: replicated # å‰¯æœ¬æ¨¡å¼ replicas: 1 # å‰¯æœ¬æ•°é‡ placement: # éƒ¨ç½²æ¡ä»¶ constraints: [node.role == manager] # èŠ‚ç‚¹è§’è‰²ä¸ºmanagernetworks: # ç½‘ç»œå£°æ˜ agent_network: # ç½‘ç»œåç§° driver: overlay # ç½‘ç»œé©±åŠ¨ attachable: true # å…è®¸å®¹å™¨åŠ å…¥volumes: # æŒ‚è½½å·å£°æ˜ portainer_data: # æŒ‚è½½å·åç§° Stack å‘½ä»¤ å­å‘½ä»¤ ä¸­æ–‡è¯´æ˜ ç¤ºä¾‹å‘½ä»¤ config è¾“å‡ºæœ€ç»ˆçš„é…ç½®æ–‡ä»¶ï¼ˆç»è¿‡åˆå¹¶ä¸å˜é‡æ›¿æ¢åï¼‰ docker stack config -c docker-compose.yml deploy éƒ¨ç½²æ–° stack æˆ–æ›´æ–°å·²æœ‰ stack docker stack deploy -c docker-compose.yml mystack ls åˆ—å‡ºæ‰€æœ‰å·²éƒ¨ç½²çš„ stack docker stack ls ps æŸ¥çœ‹ stack ä¸­çš„æ‰€æœ‰ä»»åŠ¡ï¼ˆå³å„ä¸ªå®¹å™¨å®ä¾‹ï¼‰ docker stack ps mystack rm åˆ é™¤ä¸€ä¸ªæˆ–å¤šä¸ª stack docker stack rm mystack services åˆ—å‡ºæŸä¸ª stack ä¸­çš„æ‰€æœ‰æœåŠ¡ docker stack services mystack docker stack config: è¾“å‡ºæœ€ç»ˆçš„é…ç½®æ–‡ä»¶ 12# æ­¤å‘½ä»¤ä¹Ÿå¯ä»¥ç”¨æ¥éªŒè¯composeæ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®ï¼Œåªä¿è¯æ ¼å¼æ­£ç¡®ï¼Œä¸ä¿è¯é€»è¾‘æ­£ç¡®docker stack config -c portainer-agent-stack.yml docker stack deploy: éƒ¨ç½² stack docker stack deploy == docker stack up 12345docker stack deploy -c portainer-agent-stack.yml portainer## è¾“å‡ºCreating network portainer_agent_networkCreating service portainer_agentCreating service portainer_portainer docker stack ls: åˆ—å‡ºæ‰€æœ‰ stack docker stack ls == docker stack list 1234docker stack ls## è¾“å‡ºï¼Œstackåç§°ä¸ºportainerï¼Œå…¶å†…éƒ¨æœ‰ä¸¤ä¸ªæœåŠ¡ï¼Œagentå’ŒportainerNAME SERVICESportainer 2 docker stack services: æŸ¥çœ‹æœåŠ¡ 123456789101112docker stack services portainer## è¾“å‡ºID NAME MODE REPLICAS IMAGE PORTSh5foyujr6jq9 portainer_agent global 5/5 portainer/agent:ltszcek2jtloe09 portainer_portainer replicated 1/1 portainer/portainer-ce:lts *:8000-&gt;8000/tcp, *:9000-&gt;9000/tcp, *:9443-&gt;9443/tcp## ç­‰æ•ˆdocker service ls## è¾“å‡ºID NAME MODE REPLICAS IMAGE PORTSh5foyujr6jq9 portainer_agent global 5/5 portainer/agent:ltszcek2jtloe09 portainer_portainer replicated 1/1 portainer/portainer-ce:lts *:8000-&gt;8000/tcp, *:9000-&gt;9000/tcp, *:9443-&gt;9443/tcp docker stack ps: åˆ—å‡º stack ä¸‹çš„æ‰€æœ‰æœåŠ¡å®ä¾‹ 1234567891011121314151617181920docker stack ps portainer## è¾“å‡ºID NAME IMAGE NODE DESIRED STATE CURRENT STATE ERROR PORTSwshk9s6gyxh1 portainer_agent.hvzkh3ip5ef8gx973z1ywahbu portainer/agent:lts worker2 Running Running 30 seconds agon3jjzmr2fcv9 portainer_agent.kp2zerd28xgz5mmglnje0jp22 portainer/agent:lts manager1 Running Running 59 seconds ago24yy1ew3tiya portainer_agent.oymi74epagdqeprah7s81tsa2 portainer/agent:lts manager2 Running Running 3 minutes agokpo4hhdvwcwd portainer_agent.r7388xl84nczjtnf53pwh7hla portainer/agent:lts manager3 Running Running 35 seconds agot8xjbotfuas0 portainer_agent.xkww4853bbdgv7bv8771xibob portainer/agent:lts worker1 Running Running 48 seconds agoqox3kqypon69 portainer_portainer.1 portainer/portainer-ce:lts manager2 Running Running 2 minutes ago## ç­‰æ•ˆdocker service ps portainer_agent portainer_portainer## è¾“å‡ºID NAME IMAGE NODE DESIRED STATE CURRENT STATE ERROR PORTSwshk9s6gyxh1 portainer_agent.hvzkh3ip5ef8gx973z1ywahbu portainer/agent:lts worker2 Running Running 7 minutes agon3jjzmr2fcv9 portainer_agent.kp2zerd28xgz5mmglnje0jp22 portainer/agent:lts manager1 Running Running 8 minutes ago24yy1ew3tiya portainer_agent.oymi74epagdqeprah7s81tsa2 portainer/agent:lts manager2 Running Running 10 minutes agokpo4hhdvwcwd portainer_agent.r7388xl84nczjtnf53pwh7hla portainer/agent:lts manager3 Running Running 7 minutes agot8xjbotfuas0 portainer_agent.xkww4853bbdgv7bv8771xibob portainer/agent:lts worker1 Running Running 7 minutes agoqox3kqypon69 portainer_portainer.1 portainer/portainer-ce:lts manager2 Running Running 10 minutes ago docker stack rm: åœæ­¢å¹¶åˆ é™¤ stack docker stack rm == docker stack remove == docker stack down 1docker stack rm portainer deploy å‚æ•°è¯¦è§£ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455services: my-service: image: myapp:latest deploy: replicas: 3 # æŒ‡å®šå‰¯æœ¬æ•°ï¼Œä»…åœ¨ mode: replicated ä¸‹æœ‰æ•ˆã€‚è¡¨ç¤ºåŒæ—¶è¿è¡Œ3ä¸ªå®¹å™¨å‰¯æœ¬ã€‚ mode: replicated # æœåŠ¡è¿è¡Œæ¨¡å¼ï¼Œå¯é€‰å€¼ï¼š # - replicatedï¼šé€šè¿‡ replicas æŒ‡å®šå‰¯æœ¬æ•°é‡ï¼ˆé»˜è®¤ï¼‰ # - globalï¼šæ¯ä¸ªèŠ‚ç‚¹è¿è¡Œä¸€ä¸ªå‰¯æœ¬ï¼Œå¿½ç•¥ replicas é…ç½® resources: limits: # å®¹å™¨çš„â€œç¡¬é™åˆ¶â€ï¼Œè¶…è¿‡ä¼šè¢«å¼ºåˆ¶é™åˆ¶ cpus: &#x27;1.0&#x27; # é™åˆ¶æ¯ä¸ªå®¹å™¨æœ€å¤šä½¿ç”¨1ä¸ªé€»è¾‘ CPU memory: 512M # é™åˆ¶æ¯ä¸ªå®¹å™¨æœ€å¤šä½¿ç”¨512MBå†…å­˜ reservations: # å®¹å™¨çš„â€œè½¯é™åˆ¶â€ï¼ŒSwarmè°ƒåº¦æ—¶é¢„ç•™èµ„æºå‚è€ƒå€¼ï¼ˆä¸ä¼šå¼ºåˆ¶é™åˆ¶ï¼‰ cpus: &#x27;0.25&#x27; # å»ºè®®æ¯ä¸ªå®¹å™¨è‡³å°‘åˆ†é…0.25ä¸ªCPU memory: 128M # å»ºè®®æ¯ä¸ªå®¹å™¨è‡³å°‘åˆ†é…128MBå†…å­˜ restart_policy: condition: on-failure # æ§åˆ¶å®¹å™¨é‡å¯è¡Œä¸ºï¼Œå¯é€‰å€¼ï¼š # - noneï¼šä¸é‡å¯ # - on-failureï¼šå¤±è´¥æ—¶é‡å¯ï¼ˆé0é€€å‡ºç ï¼‰ # - anyï¼šæ— è®ºæ˜¯å¦å¤±è´¥éƒ½é‡å¯ delay: 5s # é‡å¯å‰ç­‰å¾…æ—¶é—´ max_attempts: 3 # æœ€å¤šé‡å¯3æ¬¡ window: 60s # åˆ¤æ–­å¤±è´¥æ¬¡æ•°çš„æ—¶é—´çª—å£ï¼ˆ60ç§’å†…æœ€å¤šå¤±è´¥3æ¬¡ï¼‰ placement: constraints: # æŒ‡å®šå®¹å™¨è°ƒåº¦åˆ°å“ªäº›èŠ‚ç‚¹ä¸Šè¿è¡Œï¼Œå¯ç”¨æ¡ä»¶æœ‰ï¼š # - node.role == manager/worker # - node.hostname == xxx # - node.labels.xxx == yyy - node.role == worker # åªè°ƒåº¦åˆ° worker èŠ‚ç‚¹ preferences: # è°ƒåº¦åå¥½ï¼ˆä¸æ˜¯å¼ºçº¦æŸï¼‰ - spread: node.labels.zone # å°†æœåŠ¡å‡åŒ€åœ°åˆ†å¸ƒåœ¨ zone æ ‡ç­¾ä¸åŒçš„èŠ‚ç‚¹ä¸Š update_config: # æ§åˆ¶æœåŠ¡æ»šåŠ¨æ›´æ–°çš„è¡Œä¸º parallelism: 2 # æ¯æ¬¡æœ€å¤šå¹¶å‘æ›´æ–°2ä¸ªå®¹å™¨ delay: 10s # æ¯æ‰¹æ›´æ–°ä¹‹é—´ç­‰å¾…10ç§’ failure_action: rollback # æ›´æ–°å¤±è´¥æ—¶çš„å¤„ç†æ–¹å¼ï¼Œå¯é€‰å€¼ï¼š # - pauseï¼šæš‚åœæ›´æ–°ï¼ˆé»˜è®¤ï¼‰ # - continueï¼šç»§ç»­æ›´æ–° # - rollbackï¼šå›æ»šåˆ°æ—§ç‰ˆæœ¬ order: stop-first # æ§åˆ¶æ›´æ–°é¡ºåºï¼Œå¯é€‰å€¼ï¼š # - stop-firstï¼ˆå…ˆåœåå¯ï¼Œé»˜è®¤ï¼‰ # - start-firstï¼ˆå…ˆå¯ååœï¼Œé€‚ç”¨äºæ— çŠ¶æ€æœåŠ¡ï¼‰ rollback_config: # å›æ»šæ—¶çš„è¡Œä¸ºï¼Œå­—æ®µä¸ update_config ç±»ä¼¼ parallelism: 1 # å›æ»šæ—¶æ¯æ¬¡æœ€å¤šå¤„ç†1ä¸ªå®¹å™¨ delay: 5s # æ¯æ‰¹å›æ»šä¹‹é—´ç­‰å¾…5ç§’ failure_action: pause # å›æ»šå¤±è´¥æ—¶æš‚åœ order: stop-first # å›æ»šæ—¶å…ˆåœå†å¯","summary":"æ‘˜è¦ æœ¬æ–‡ä»‹ç» Docker Swarm çš„ æ ˆç®¡ç† Dockerå®˜æ–¹æ–‡æ¡£ Docker Swarm å®˜æ–¹æ–‡æ¡£ Compose file reference","date_published":"2025-06-11T14:30:05.000Z","tags":["æŠ€æœ¯","docker","docker"]},{"id":"https://blog.hanqunfeng.com/2025/06/11/docker-swarm-overlay/","url":"https://blog.hanqunfeng.com/2025/06/11/docker-swarm-overlay/","title":"Docker Swarm ä¹‹ ç½‘ç»œ(Overlay)","content_html":"<!--\n **åŠ ç²—**\n *æ–œä½“*\n ***åŠ ç²—å¹¶æ–œä½“***\n ~~åˆ é™¤çº¿~~\n ==çªå‡ºæ˜¾ç¤º==\n `çªå‡ºæ˜¾ç¤º(æ¨è)`\n ++ä¸‹åˆ’çº¿++\n ~ä¸‹æ ‡~\n ^ä¸Šæ ‡^\n è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference.\n å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)\n\n +++ **ç‚¹å‡»æŠ˜å **\n è¿™æ˜¯è¢«éšè—çš„å†…å®¹\n +++\n\n::: tips success warning danger\nè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹\n:::\n\n% note info % success warning danger\nè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹\n% endnote %\n\nå¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{}\n å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ\n -->\n<h2 id=\"æ‘˜è¦\">æ‘˜è¦</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æœ¬æ–‡ä»‹ç» Docker Swarm çš„ ç½‘ç»œ(Overlay)</p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://docs.docker.com\">Dockerå®˜æ–¹æ–‡æ¡£</a></p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://docs.docker.com/engine/swarm/\">Docker Swarm å®˜æ–¹æ–‡æ¡£</a></p>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"Overlay-ç®€ä»‹\">Overlay ç®€ä»‹</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åœ¨ Docker Swarm ä¸­ï¼Œoverlay ç½‘ç»œ æ˜¯ä¸€ç§åˆ†å¸ƒå¼ç½‘ç»œé©±åŠ¨ï¼Œç”¨äºå°†é›†ç¾¤ä¸­ä¸åŒä¸»æœºä¸Šçš„å®¹å™¨è¿æ¥åˆ°åŒä¸€ä¸ªé€»è¾‘ç½‘ç»œä¸­ï¼Œå°±åƒå®ƒä»¬åœ¨åŒä¸€å°ä¸»æœºä¸Šä¸€æ ·ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>å½“ä½ ä½¿ç”¨ Docker Swarm éƒ¨ç½²æœåŠ¡æ—¶ï¼ŒSwarm ä¼šè‡ªåŠ¨ä½¿ç”¨ overlay ç½‘ç»œæ¥è¿æ¥ä¸åŒèŠ‚ç‚¹ä¸Šçš„å®¹å™¨ï¼Œå®ç°æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡ï¼Œä¿è¯å®¹å™¨é—´çš„é€šä¿¡å®‰å…¨ï¼ˆé€šè¿‡åŠ å¯†ï¼‰ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>overlay ç½‘ç»œç‰¹ç‚¹</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-4\">è·¨ä¸»æœºé€šä¿¡ï¼šå®¹å™¨æ— è®ºåœ¨å“ªä¸ªèŠ‚ç‚¹ä¸Šï¼Œéƒ½å¯ä»¥ä½¿ç”¨ overlay ç½‘ç»œè¿›è¡Œé€šä¿¡ã€‚</li>\n<li class=\"lvl-4\">å†…ç½®æœåŠ¡å‘ç°ï¼šå®¹å™¨ä¹‹é—´å¯ä»¥é€šè¿‡æœåŠ¡åç§°ç›´æ¥é€šä¿¡ã€‚</li>\n<li class=\"lvl-4\">æ”¯æŒåŠ å¯†ï¼šSwarm çš„ overlay ç½‘ç»œæ”¯æŒæ•°æ®åŠ å¯†ï¼Œæé«˜å®‰å…¨æ€§ã€‚</li>\n<li class=\"lvl-4\">è‡ªåŠ¨é…ç½®ï¼šSwarm ä¼šè‡ªåŠ¨ä¸º overlay ç½‘ç»œåˆ†é…å­ç½‘ã€ç®¡ç† IP ç­‰ã€‚</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"Swarm-ä¸­çš„-overlay-ç½‘ç»œ\">Swarm ä¸­çš„ overlay ç½‘ç»œ</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å½“æˆ‘ä»¬åˆå§‹åŒ–Swarm æ—¶ï¼ŒSwarm ä¼šè‡ªåŠ¨åˆ›å»ºä¸¤ä¸ªnetworkï¼Œä¸€ä¸ªæ˜¯ bridge networkï¼š<code>docker_gwbridge</code> ï¼Œä¸€ä¸ªæ˜¯ overlay networkï¼š<code>ingress</code>ã€‚</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker network <span class=\"built_in\">ls</span></span><br><span class=\"line\">NETWORK ID     NAME              DRIVER    SCOPE</span><br><span class=\"line\">6b7aadbbd180   bridge            bridge    <span class=\"built_in\">local</span></span><br><span class=\"line\">5ddadf5d0608   docker_gwbridge   bridge    <span class=\"built_in\">local</span></span><br><span class=\"line\">21c6f5b1bedd   host              host      <span class=\"built_in\">local</span></span><br><span class=\"line\">idx465x3jg68   ingress           overlay   swarm</span><br><span class=\"line\">a770c5ad4b13   none              null      <span class=\"built_in\">local</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"docker-gwbridge\"><code>docker_gwbridge</code></h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æŸ¥çœ‹ <code>docker_gwbridge</code> è¯¦æƒ…ï¼Œå…¶ç½‘æ®µä¸º <code>172.18.0.0/16</code>ï¼Œç½‘å…³ä¸º <code>172.18.0.1</code>ï¼Œå†…éƒ¨æœ‰ä¸€ä¸ªå®¹å™¨ <code>ingress-sbox</code></p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker inspect docker_gwbridge</span><br><span class=\"line\">[</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;Name&quot;</span>: <span class=\"string\">&quot;docker_gwbridge&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;Id&quot;</span>: <span class=\"string\">&quot;5ddadf5d06086fcdad5890b8d59edcca4b1293bde23a26f1968fd6114fcaec93&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;Created&quot;</span>: <span class=\"string\">&quot;2025-06-08T07:29:52.119033035-04:00&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;Scope&quot;</span>: <span class=\"string\">&quot;local&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;Driver&quot;</span>: <span class=\"string\">&quot;bridge&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;EnableIPv6&quot;</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;IPAM&quot;</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;Driver&quot;</span>: <span class=\"string\">&quot;default&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;Options&quot;</span>: null,</span><br><span class=\"line\">            <span class=\"string\">&quot;Config&quot;</span>: [</span><br><span class=\"line\">                &#123;</span><br><span class=\"line\">                    <span class=\"string\">&quot;Subnet&quot;</span>: <span class=\"string\">&quot;172.18.0.0/16&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;Gateway&quot;</span>: <span class=\"string\">&quot;172.18.0.1&quot;</span></span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            ]</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;Internal&quot;</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;Attachable&quot;</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;Ingress&quot;</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;ConfigFrom&quot;</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;Network&quot;</span>: <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;ConfigOnly&quot;</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;Containers&quot;</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;ingress-sbox&quot;</span>: &#123;</span><br><span class=\"line\">                <span class=\"string\">&quot;Name&quot;</span>: <span class=\"string\">&quot;gateway_ingress-sbox&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;EndpointID&quot;</span>: <span class=\"string\">&quot;4764160a1b048da6d325a2f14165a981a446892ea3b4ebb12e20ee689fdac397&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;MacAddress&quot;</span>: <span class=\"string\">&quot;02:42:ac:12:00:02&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;IPv4Address&quot;</span>: <span class=\"string\">&quot;172.18.0.2/16&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;IPv6Address&quot;</span>: <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;Options&quot;</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;com.docker.network.bridge.enable_icc&quot;</span>: <span class=\"string\">&quot;false&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;com.docker.network.bridge.enable_ip_masquerade&quot;</span>: <span class=\"string\">&quot;true&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;com.docker.network.bridge.name&quot;</span>: <span class=\"string\">&quot;docker_gwbridge&quot;</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;Labels&quot;</span>: &#123;&#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">]</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å…ˆæ¥çœ‹è¿™ä¸ªç½‘æ®µ <code>172.18.0.0/16</code>ï¼Œæˆ‘ä»¬æŸ¥çœ‹ä¸»æœºçš„ç½‘ç»œå’Œè·¯ç”±è¡¨ï¼Œå¯ä»¥çœ‹åˆ° <code>261: docker_gwbridge</code>ï¼Œå…¶IPåœ°å€ä¸º <code>172.18.0.1</code>ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å°±å¯ä»¥çŸ¥é“ <code>docker_gwbridge</code> å°±æ˜¯è¿æ¥åˆ°<code>261: docker_gwbridge</code>è¿™å—ç½‘å¡ä¸Šçš„ï¼Œå¦å¤–å½“å‰è¿˜æœ‰ä¸€ä¸ª<code>263: veth3176100@if262</code>è™šæ‹Ÿç½‘ç»œæ¥å£ä¹Ÿè¿æ¥åˆ°<code>261: docker_gwbridge</code>ä¸Šï¼Œé€šè¿‡è·¯ç”±è¡¨æˆ‘ä»¬å¾—çŸ¥å…¶æœ€ç»ˆè¿æ¥åˆ°<code>2: enp0s5</code>ä¸Šï¼Œä¹Ÿå°±æ˜¯è¿™å°ä¸»æœºçš„ç½‘å¡ã€‚</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ip a</span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡ºç»“æœ</span></span><br><span class=\"line\">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class=\"line\">    <span class=\"built_in\">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class=\"line\">    inet 127.0.0.1/8 scope host lo</span><br><span class=\"line\">       valid_lft forever preferred_lft forever</span><br><span class=\"line\">    inet6 ::1/128 scope host</span><br><span class=\"line\">       valid_lft forever preferred_lft forever</span><br><span class=\"line\">2: enp0s5: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000</span><br><span class=\"line\">    <span class=\"built_in\">link</span>/ether 00:1c:42:49:12:82 brd ff:ff:ff:ff:ff:ff</span><br><span class=\"line\">    inet 10.211.55.10/24 brd 10.211.55.255 scope global noprefixroute enp0s5</span><br><span class=\"line\">       valid_lft forever preferred_lft forever</span><br><span class=\"line\">    inet6 fdb2:2c26:f4e4:0:21c:42ff:fe49:1282/64 scope global dynamic noprefixroute</span><br><span class=\"line\">       valid_lft 2591886sec preferred_lft 604686sec</span><br><span class=\"line\">    inet6 fe80::21c:42ff:fe49:1282/64 scope <span class=\"built_in\">link</span> noprefixroute</span><br><span class=\"line\">       valid_lft forever preferred_lft forever</span><br><span class=\"line\">3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default</span><br><span class=\"line\">    <span class=\"built_in\">link</span>/ether 02:42:5c:31:<span class=\"built_in\">cd</span>:30 brd ff:ff:ff:ff:ff:ff</span><br><span class=\"line\">    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0</span><br><span class=\"line\">       valid_lft forever preferred_lft forever</span><br><span class=\"line\">    inet6 fe80::42:5cff:fe31:cd30/64 scope <span class=\"built_in\">link</span></span><br><span class=\"line\">       valid_lft forever preferred_lft forever</span><br><span class=\"line\">261: docker_gwbridge: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span><br><span class=\"line\">    <span class=\"built_in\">link</span>/ether 02:42:fe:e3:ca:f7 brd ff:ff:ff:ff:ff:ff</span><br><span class=\"line\">    inet 172.18.0.1/16 brd 172.18.255.255 scope global docker_gwbridge</span><br><span class=\"line\">       valid_lft forever preferred_lft forever</span><br><span class=\"line\">    inet6 fe80::42:feff:fee3:caf7/64 scope <span class=\"built_in\">link</span></span><br><span class=\"line\">       valid_lft forever preferred_lft forever</span><br><span class=\"line\">263: veth3176100@if262: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker_gwbridge state UP group default</span><br><span class=\"line\">    <span class=\"built_in\">link</span>/ether 96:4b:c1:d9:83:c5 brd ff:ff:ff:ff:ff:ff link-netnsid 1</span><br><span class=\"line\">    inet6 fe80::944b:c1ff:fed9:83c5/64 scope <span class=\"built_in\">link</span></span><br><span class=\"line\">       valid_lft forever preferred_lft forever</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹è·¯ç”±è¡¨</span></span><br><span class=\"line\">route -n</span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡ºç»“æœï¼Œå…¶ç›®çš„åœ°å€æœ€ç»ˆéƒ½ä¼šè½¬åˆ°ç½‘å…³ 10.211.55.1 ä¸Š</span></span><br><span class=\"line\">Kernel IP routing table</span><br><span class=\"line\">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class=\"line\">0.0.0.0         10.211.55.1     0.0.0.0         UG    100    0        0 enp0s5</span><br><span class=\"line\">10.211.55.0     0.0.0.0         255.255.255.0   U     100    0        0 enp0s5</span><br><span class=\"line\">172.17.0.0      0.0.0.0         255.255.0.0     U     0      0        0 docker0</span><br><span class=\"line\">172.18.0.0      0.0.0.0         255.255.0.0     U     0      0        0 docker_gwbridge</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹docker_gwbridgeç½‘æ¡¥è®¾å¤‡ä¿¡æ¯ï¼Œå¯ä»¥çœ‹åˆ°å…¶æŒ‚è½½äº†ä¸€ä¸ªè™šæ‹Ÿç½‘å¡ veth3176100</span></span><br><span class=\"line\">brctl show docker_gwbridge</span><br><span class=\"line\">bridge name     bridge <span class=\"built_in\">id</span>               STP enabled     interfaces</span><br><span class=\"line\">docker_gwbridge         8000.0242fee3caf7       no              veth3176100</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æŒ‰ç†è¯´<code>263: veth3176100@if262</code>è™šæ‹Ÿç½‘ç»œæ¥å£åº”è¯¥å¯¹åº”åˆ°ä¸€ä¸ªå®¹å™¨ä¸Šï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬å°±çœ‹ä¸€çœ‹è¿™ä¸ªå®¹å™¨ <code>ingress-sbox</code>ï¼Œå½“å‰dockerä¸­å¹¶æ²¡æœ‰è¿™ä¸ªå®¹å™¨ï¼Œé‚£ä¹ˆè¿™ä¸ªå®¹å™¨åœ¨å“ªé‡Œå‘¢ï¼Ÿdockeråˆ›å»ºçš„å®¹å™¨éƒ½ä¼šæœ‰ä¸€ä¸ªç½‘ç»œå‘½åç©ºé—´ï¼Œå…¶ä¿å­˜åœ¨å®¿ä¸»æœºçš„<code>/var/run/docker/netns/</code>ä¸‹</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> /var/run/docker/netns/</span><br><span class=\"line\"><span class=\"built_in\">ls</span></span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡ºï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬è¿˜çœŸçš„å‘ç°äº†ä¸è¿™ä¸ªå®¹å™¨åç§°ç±»ä¼¼çš„ç½‘ç»œå‘½åç©ºé—´ï¼Œå®¹å™¨åç§°æ˜¯ä¸­åˆ’çº¿ï¼Œç½‘ç»œå‘½åç©ºé—´åç§°æ˜¯ä¸‹åˆ’çº¿</span></span><br><span class=\"line\">1-idx465x3jg  ingress_sbox</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>è¿›å…¥è¿™ä¸ªç½‘ç»œï¼Œæˆ‘ä»¬å°±æ‰¾åˆ°ä¸å®¿ä¸»æœºä¸Šçš„è™šæ‹Ÿç½‘ç»œæ¥å£å¯¹åº”çš„å®¹å™¨ç½‘ç»œæ¥å£äº†ï¼š<code>262: eth1@if263</code></p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nsenter --net=ingress_sbox ip a</span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡º</span></span><br><span class=\"line\">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class=\"line\">    <span class=\"built_in\">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class=\"line\">    inet 127.0.0.1/8 scope host lo</span><br><span class=\"line\">       valid_lft forever preferred_lft forever</span><br><span class=\"line\">    inet6 ::1/128 scope host</span><br><span class=\"line\">       valid_lft forever preferred_lft forever</span><br><span class=\"line\">259: eth0@if260: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UP group default</span><br><span class=\"line\">    <span class=\"built_in\">link</span>/ether 02:42:0a:00:00:02 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br><span class=\"line\">    inet 10.0.0.2/24 brd 10.0.0.255 scope global eth0</span><br><span class=\"line\">       valid_lft forever preferred_lft forever</span><br><span class=\"line\">262: eth1@if263: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span><br><span class=\"line\">    <span class=\"built_in\">link</span>/ether 02:42:ac:12:00:02 brd ff:ff:ff:ff:ff:ff link-netnsid 1</span><br><span class=\"line\">    inet 172.18.0.2/16 brd 172.18.255.255 scope global eth1</span><br><span class=\"line\">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªç½‘ç»œæ¥å£ <code>259: eth0@if260</code>ï¼Œå®ƒåˆæ˜¯ä¸è°å¯¹æ¥çš„å‘¢ï¼Ÿåˆ«ç€æ€¥ï¼Œæˆ‘ä»¬æ¥ç€å¾€ä¸‹çœ‹ã€‚</p>\n</li>\n</ul>\n<h3 id=\"ingress\"><code>ingress</code></h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æŸ¥çœ‹ <code>ingress</code> è¯¦æƒ…ï¼Œå…¶ç½‘æ®µä¸º <code>10.0.0.0/24</code>ï¼Œç½‘å…³ä¸º <code>10.0.0.1</code>ï¼Œå†…éƒ¨æœ‰ä¸€ä¸ªå®¹å™¨ <code>ingress-sbox</code>ï¼Œå¦å¤–å…¶æœ‰ä¸€ä¸ª<code>Peers</code>å±æ€§ï¼Œå†…éƒ¨åŒ…å«äº†é›†ç¾¤ä¸­æ‰€æœ‰çš„èŠ‚ç‚¹IPï¼Œæ‰€ä»¥ä»è¿™é‡Œä¹Ÿèƒ½å¤§æ¦‚çŒœå‡ºè¿™ä¸ªç½‘ç»œæ˜¯è´Ÿè´£èŠ‚ç‚¹é—´é€šä¿¡çš„ã€‚</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker network inspect ingress</span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡º</span></span><br><span class=\"line\">[</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;Name&quot;</span>: <span class=\"string\">&quot;ingress&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;Id&quot;</span>: <span class=\"string\">&quot;idx465x3jg682fmceumsio297&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;Created&quot;</span>: <span class=\"string\">&quot;2025-06-08T07:29:51.734714967-04:00&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;Scope&quot;</span>: <span class=\"string\">&quot;swarm&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;Driver&quot;</span>: <span class=\"string\">&quot;overlay&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;EnableIPv6&quot;</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;IPAM&quot;</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;Driver&quot;</span>: <span class=\"string\">&quot;default&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;Options&quot;</span>: null,</span><br><span class=\"line\">            <span class=\"string\">&quot;Config&quot;</span>: [</span><br><span class=\"line\">                &#123;</span><br><span class=\"line\">                    <span class=\"string\">&quot;Subnet&quot;</span>: <span class=\"string\">&quot;10.0.0.0/24&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;Gateway&quot;</span>: <span class=\"string\">&quot;10.0.0.1&quot;</span></span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            ]</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;Internal&quot;</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;Attachable&quot;</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;Ingress&quot;</span>: <span class=\"literal\">true</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;ConfigFrom&quot;</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;Network&quot;</span>: <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;ConfigOnly&quot;</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;Containers&quot;</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;ingress-sbox&quot;</span>: &#123;</span><br><span class=\"line\">                <span class=\"string\">&quot;Name&quot;</span>: <span class=\"string\">&quot;ingress-endpoint&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;EndpointID&quot;</span>: <span class=\"string\">&quot;fd05086c5104e28c75dbed3e3b308236aaa0e87b698dad6186c23c81755bb009&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;MacAddress&quot;</span>: <span class=\"string\">&quot;02:42:0a:00:00:02&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;IPv4Address&quot;</span>: <span class=\"string\">&quot;10.0.0.2/24&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;IPv6Address&quot;</span>: <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;Options&quot;</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;com.docker.network.driver.overlay.vxlanid_list&quot;</span>: <span class=\"string\">&quot;4096&quot;</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;Labels&quot;</span>: &#123;&#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;Peers&quot;</span>: [</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                <span class=\"string\">&quot;Name&quot;</span>: <span class=\"string\">&quot;4969a4611607&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;IP&quot;</span>: <span class=\"string\">&quot;10.211.55.10&quot;</span></span><br><span class=\"line\">            &#125;,</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                <span class=\"string\">&quot;Name&quot;</span>: <span class=\"string\">&quot;ae3756658a26&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;IP&quot;</span>: <span class=\"string\">&quot;10.211.55.14&quot;</span></span><br><span class=\"line\">            &#125;,</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                <span class=\"string\">&quot;Name&quot;</span>: <span class=\"string\">&quot;f12309731131&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;IP&quot;</span>: <span class=\"string\">&quot;10.211.55.13&quot;</span></span><br><span class=\"line\">            &#125;,</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                <span class=\"string\">&quot;Name&quot;</span>: <span class=\"string\">&quot;de5000b11067&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;IP&quot;</span>: <span class=\"string\">&quot;10.211.55.12&quot;</span></span><br><span class=\"line\">            &#125;,</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                <span class=\"string\">&quot;Name&quot;</span>: <span class=\"string\">&quot;377001904d63&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;IP&quot;</span>: <span class=\"string\">&quot;10.211.55.11&quot;</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        ]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">]</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æˆ‘ä»¬è¿˜æ˜¯å…ˆæ¥çœ‹è¿™ä¸ªç½‘å…³<code>10.0.0.1</code>ï¼Œåœ¨å“ªå‘¢ï¼Ÿå®¿ä¸»æœºçš„ç½‘ç»œè®¾å¤‡ä¸­å¹¶æ²¡æœ‰ï¼Œæ‰€ä»¥å®ƒåº”è¯¥æ˜¯dockeråˆ›å»ºçš„ï¼Œæˆ‘ä»¬è¿˜æ˜¯è¦ä»<code>/var/run/docker/netns</code>ä¸­æŸ¥çœ‹ä¸€ä¸‹ï¼Œè¿™é‡Œè¿˜æœ‰ä¸€ä¸ªåç§°ä¸º <code>1-idx465x3jg</code> çš„ç½‘ç»œå‘½åç©ºé—´ï¼Œæˆ‘ä»¬è¿›å»çœ‹çœ‹</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nsenter --net=/var/run/docker/netns/1-idx465x3jg ip a</span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡º</span></span><br><span class=\"line\">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class=\"line\">    <span class=\"built_in\">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class=\"line\">    inet 127.0.0.1/8 scope host lo</span><br><span class=\"line\">       valid_lft forever preferred_lft forever</span><br><span class=\"line\">    inet6 ::1/128 scope host</span><br><span class=\"line\">       valid_lft forever preferred_lft forever</span><br><span class=\"line\">258: vxlan0@if258: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue master br0 state UNKNOWN group default</span><br><span class=\"line\">    <span class=\"built_in\">link</span>/ether 32:c9:a4:01:8a:19 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br><span class=\"line\">2: br0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UP group default</span><br><span class=\"line\">    <span class=\"built_in\">link</span>/ether 32:c9:a4:01:8a:19 brd ff:ff:ff:ff:ff:ff</span><br><span class=\"line\">    inet 10.0.0.1/24 brd 10.0.0.255 scope global br0</span><br><span class=\"line\">       valid_lft forever preferred_lft forever</span><br><span class=\"line\">260: veth0@if259: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue master br0 state UP group default</span><br><span class=\"line\">    <span class=\"built_in\">link</span>/ether 8a:d3:52:ac:7d:<span class=\"built_in\">cd</span> brd ff:ff:ff:ff:ff:ff link-netnsid 1</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åœ¨è¿™é‡Œæˆ‘ä»¬æ‰¾åˆ°äº†<code>2: br0</code>ï¼Œå…¶IPåœ°å€ä¸º<code>10.0.0.1</code>ï¼Œæ‰€ä»¥å®ƒå°±æ˜¯æˆ‘ä»¬è¦æ‰¾çš„ç½‘å…³ã€‚å…¶ä¸Šé¢è¿˜æŒ‚è½½äº†ä¸¤ä¸ªç½‘ç»œè®¾å¤‡ï¼Œä¸€ä¸ªæ˜¯ <code>260: veth0@if259</code>ï¼Œè¿™ä¸ªå°±æ˜¯ä¸<code>ingress_sbox</code> ä¸­<code>259: eth0@if260</code>å¯¹åº”çš„ç½‘ç»œæ¥å£ ï¼Œå¦ä¸€ä¸ªæ˜¯ <code>258: vxlan0@if258</code>ï¼Œå…¶åŸºäº<code>vxlan</code>åè®®ï¼Œè´Ÿè´£é›†ç¾¤è·¨ä¸»æœºé€šä¿¡ã€‚</p>\n</li>\n</ul>\n<h3 id=\"overlayæ€»ç»“\">overlayæ€»ç»“</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>docker_gwbridge</code>ä¸­çš„å®¹å™¨<code>ingress-sbox</code>ï¼Œå…¶æœ‰ä¸¤å—ç½‘å¡ï¼Œä¸€å—å¯¹æ¥å®¿ä¸»æœºä¸Šçš„ <code>261: docker_gwbridge</code>ï¼Œå¦ä¸€å—å¯¹æ¥<code>/var/run/docker/netns/1-idx465x3jg</code>ä¸­çš„ <code>2: br0</code>ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>å®é™…ä¸ŠSwarmä¸­çš„æ‰€æœ‰å®¹å™¨éƒ½æœ‰ä¸¤ä¸ªç½‘å¡ï¼Œä¸€å—å¯¹æ¥å®¿ä¸»æœºä¸Šçš„ <code>261: docker_gwbridge</code>ï¼Œå¦ä¸€å—å¯¹æ¥<code>/var/run/docker/netns/1-idx465x3jg</code>ä¸­çš„ <code>2: br0</code>ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>å½“è¯·æ±‚åˆ°è¾¾å®¿ä¸»æœºæ—¶ï¼Œä¼šé€šè¿‡<code>enp0s5</code>è½¬å‘åˆ°<code>docker_gwbridge</code>ï¼Œç„¶åå…ˆè¢«è½¬åˆ°<code>ingress-sbox</code>å®¹å™¨ï¼Œç„¶åå†ç»è¿‡å…¶è½¬å‘åˆ°<code>br0</code>ç½‘å…³ï¼Œå†ç”±å®ƒè´Ÿè´£æŸ¥æ‰¾ç›®æ ‡å®¹å™¨ã€‚å¦‚æœç›®æ ‡å®¹å™¨ä¸åœ¨æœ¬èŠ‚ç‚¹ï¼Œåˆ™é€šè¿‡<code>vxlan0</code>ç½‘ç»œæ¥å£è½¬å‘åˆ°å…¶å®ƒèŠ‚ç‚¹è¿›è¡ŒæŸ¥æ‰¾ï¼Œä¸­é—´ç»è¿‡ä¸€ç³»åˆ—çš„ç½‘ç»œåœ°å€è½¬æ¢ã€‚</p>\n</li>\n</ul>\n<p><img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/9UVZzm.png\" alt=\"\"></p>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å½“ä½ é€šè¿‡<code>docker network create --driver overlay my-network</code>åˆ›å»ºä¸€ä¸ªoverlayç½‘ç»œæ—¶ï¼ŒDockerä¼šåˆ›å»ºä¸€ä¸ªç±»ä¼¼â€œingressâ€çš„ç½‘ç»œç»“æ„(æ–°çš„<code>br0</code>)ï¼Œå¦‚æœä¸æŒ‡å®šipæ®µï¼Œå…¶ipæ®µä¼šä»<code>10.0.1.0/24</code>å¼€å§‹ï¼Œä¾æ¬¡é€’å¢ä¸€ä¸ªç½‘æ®µã€‚ä½†ä¼šå…±ç”¨<code>docker_gwbridge</code>ã€‚</p>\n</li>\n</ul>\n<h2 id=\"æŸ¥çœ‹overlayç½‘ç»œä¸­çš„è´Ÿè½½å‡è¡¡\">æŸ¥çœ‹overlayç½‘ç»œä¸­çš„è´Ÿè½½å‡è¡¡</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å¯åŠ¨ä¸€ä¸ªservice</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker service create --name my-nginx --replicas 5 --publish 80:80 nginx</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æŸ¥çœ‹<code>ingress_sbox</code>çš„<code>iptables</code>æ•°æ®é“¾ä¸­çš„ mangle è¡¨</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nsenter --net=/var/run/docker/netns/ingress_sbox iptables -nvL -t mangle</span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡ºç»“æœï¼Œè¿™é‡Œçœ‹åˆ° PREROUTING é“¾ä¸­æœ‰ä¸€æ¡ç›‘å¬80ç«¯å£çš„è§„åˆ™ï¼Œå…¶è¢«æ‰“äº†Markæ ‡è®°: 0x105ï¼Œæ¢ç®—ä¸º10è¿›åˆ¶ï¼š261</span></span><br><span class=\"line\">Chain PREROUTING (policy ACCEPT 0 packets, 0 bytes)</span><br><span class=\"line\"> pkts bytes target     prot opt <span class=\"keyword\">in</span>     out     <span class=\"built_in\">source</span>               destination</span><br><span class=\"line\">    0     0 MARK       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:80 MARK <span class=\"built_in\">set</span> 0x105</span><br><span class=\"line\"></span><br><span class=\"line\">Chain INPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class=\"line\"> pkts bytes target     prot opt <span class=\"keyword\">in</span>     out     <span class=\"built_in\">source</span>               destination</span><br><span class=\"line\">    0     0 MARK       all  --  *      *       0.0.0.0/0            10.0.0.33            MARK <span class=\"built_in\">set</span> 0x105</span><br><span class=\"line\"></span><br><span class=\"line\">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</span><br><span class=\"line\"> pkts bytes target     prot opt <span class=\"keyword\">in</span>     out     <span class=\"built_in\">source</span>               destination</span><br><span class=\"line\"></span><br><span class=\"line\">Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class=\"line\"> pkts bytes target     prot opt <span class=\"keyword\">in</span>     out     <span class=\"built_in\">source</span>               destination</span><br><span class=\"line\"></span><br><span class=\"line\">Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes)</span><br><span class=\"line\"> pkts bytes target     prot opt <span class=\"keyword\">in</span>     out     <span class=\"built_in\">source</span>               destination</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>é€šè¿‡<code>ipvsadm</code>æŸ¥çœ‹è´Ÿè½½å‡è¡¡ä¿¡æ¯</p>\n</li>\n</ul>\n<blockquote>\n<p>ipvsadm æ˜¯ Linux ä¸‹ç®¡ç† IPVSï¼ˆIP Virtual Serverï¼‰è´Ÿè½½å‡è¡¡å™¨çš„å‘½ä»¤ä¹‹ä¸€</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># å¦‚æœæ²¡æœ‰ipvsadmï¼Œåˆ™å®‰è£…</span></span><br><span class=\"line\">dnf install ipvsadm -y</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹ipvsä¿¡æ¯</span></span><br><span class=\"line\">nsenter --net=/var/run/docker/netns/ingress_sbox ipvsadm -Ln</span><br><span class=\"line\"><span class=\"comment\"># -Lï¼šè¡¨ç¤ºåˆ—å‡ºå½“å‰ IPVS çš„è§„åˆ™å’ŒçŠ¶æ€ï¼ˆListï¼‰ã€‚</span></span><br><span class=\"line\"><span class=\"comment\"># -nï¼šè¡¨ç¤ºä»¥æ•°å­—æ–¹å¼æ˜¾ç¤ºåœ°å€å’Œç«¯å£ï¼Œè€Œä¸è¿›è¡Œ DNS è§£ææˆ–ç«¯å£åè§£æï¼ˆå³ï¼šIP å’Œç«¯å£å·ä»¥æ•°å­—æ˜¾ç¤ºï¼Œæ›´ç›´è§‚ï¼Œä¹Ÿæ›´å¿«ï¼‰ã€‚</span></span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡ºï¼Œå¯ä»¥çœ‹åˆ° FWM 261 rrï¼Œè¿™é‡Œrrè¡¨ç¤ºè½®è¯¢</span></span><br><span class=\"line\">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class=\"line\">Prot LocalAddress:Port Scheduler Flags</span><br><span class=\"line\">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class=\"line\">FWM  261 rr</span><br><span class=\"line\">  -&gt; 10.0.0.34:0                  Masq    1      0          0</span><br><span class=\"line\">  -&gt; 10.0.0.35:0                  Masq    1      0          0</span><br><span class=\"line\">  -&gt; 10.0.0.36:0                  Masq    1      0          0</span><br><span class=\"line\">  -&gt; 10.0.0.37:0                  Masq    1      0          0</span><br><span class=\"line\">  -&gt; 10.0.0.38:0                  Masq    1      0          0</span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡ºè§£é‡Š</span></span><br><span class=\"line\"><span class=\"comment\"># Prot: åè®®ï¼ˆTCP/UDPï¼‰,è¿™é‡Œæ˜¯ FWMï¼Œè¡¨ç¤ºFirewall Markï¼ˆé˜²ç«å¢™æ ‡è®°ï¼‰æ¨¡å¼</span></span><br><span class=\"line\"><span class=\"comment\"># LocalAddress:Port: æœ¬åœ°åœ°å€å’Œç«¯å£å·ï¼Œè¿™é‡Œæ˜¯ 261 ï¼Œè¿™æ˜¯é˜²ç«å¢™æ ‡è®°å€¼ï¼ˆmark å€¼ï¼‰,å°±æ˜¯ä¸Šé¢çœ‹åˆ°çš„é‚£ä¸ª16è¿›åˆ¶ 0x105</span></span><br><span class=\"line\"><span class=\"comment\"># Scheduler: è°ƒåº¦ç®—æ³•ï¼Œè¿™é‡Œæ˜¯ rrï¼Œè¡¨ç¤ºè½®è¯¢(round-robin)ï¼Œè°ƒåº¦ç®—æ³•è¿˜æœ‰ wrrï¼ˆåŠ æƒè½®è¯¢ï¼‰ã€lcï¼ˆæœ€å°‘è¿æ¥ï¼‰ç­‰</span></span><br><span class=\"line\"><span class=\"comment\"># RemoteAddress:Port: è¿œç¨‹åœ°å€å’Œç«¯å£å·ï¼Œè¿™é‡Œæ˜¯ 10.0.0.34:0ï¼Œè¡¨ç¤ºè´Ÿè½½å‡è¡¡åˆ°çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œåé¢åŒç†</span></span><br><span class=\"line\"><span class=\"comment\"># Forward: è½¬å‘ç­–ç•¥ï¼Œè¿™é‡Œæ˜¯ Masqï¼Œè¡¨ç¤ºå°†è´Ÿè½½å‡è¡¡åˆ°çš„èŠ‚ç‚¹çš„IPåœ°å€è½¬æ¢æˆå®¿ä¸»æœºçš„IPåœ°å€ï¼Œå³ Masqueradeï¼ˆä¼ªè£…ï¼‰ã€‚è½¬å‘æ–¹å¼ï¼ˆå¦‚ï¼šMasqã€Tunnelã€Direct Routeï¼‰</span></span><br><span class=\"line\"><span class=\"comment\"># Weight: æƒé‡ï¼Œè¿™é‡Œæ˜¯ 1ï¼Œè¡¨ç¤ºè´Ÿè½½å‡è¡¡åˆ°çš„èŠ‚ç‚¹çš„æƒé‡ï¼Œé»˜è®¤ä¸º 1</span></span><br><span class=\"line\"><span class=\"comment\"># ActiveConn: å½“å‰æ´»åŠ¨è¿æ¥æ•°ï¼Œè¿™é‡Œæ˜¯ 0</span></span><br><span class=\"line\"><span class=\"comment\"># InActConn: å½“å‰ä¸æ´»åŠ¨è¿æ¥æ•°ï¼ˆç­‰å¾…å…³é—­çš„è¿æ¥ï¼‰ï¼Œè¿™é‡Œæ˜¯ 0</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"VXLANæ˜¯ä»€ä¹ˆï¼Ÿ\">VXLANæ˜¯ä»€ä¹ˆï¼Ÿ</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>VXLANï¼ˆVirtual Extensible LANï¼‰æ˜¯ Cisco å…¬å¸å¼€å‘çš„ä¸€ç§è™šæ‹Ÿå±€åŸŸç½‘ï¼ˆVLANï¼‰æŠ€æœ¯ï¼Œå®ƒå¯ä»¥å°†å¤šä¸ª VLAN é€»è¾‘åˆ†ç»„ï¼Œå¹¶ä½¿ç”¨å•ä¸ªç‰©ç†ç½‘ç»œè¿›è¡Œç®¡ç†ã€‚VXLAN çš„ä¸»è¦ä½œç”¨æ˜¯æé«˜ç½‘ç»œæ€§èƒ½å’Œæ‰©å±•æ€§ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>å®ƒæœ¬è´¨ä¸Šæ˜¯ä¸€ç§ ç½‘ç»œå°è£…åè®®ï¼ˆoverlay protocolï¼‰ï¼Œç”¨æ¥åœ¨å·²æœ‰çš„ IP ç½‘ç»œä¹‹ä¸Šï¼Œæ„å»ºäºŒå±‚ï¼ˆL2ï¼‰è™šæ‹Ÿç½‘ç»œã€‚</p>\n</li>\n</ul>\n<h3 id=\"ä¸ºä»€ä¹ˆéœ€è¦-VXLANï¼Ÿ\">ä¸ºä»€ä¹ˆéœ€è¦ VXLANï¼Ÿ</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åœ¨ä¼ ç»Ÿæ•°æ®ä¸­å¿ƒæˆ–äº‘è®¡ç®—ä¸­ï¼Œç»å¸¸æœ‰è¿™æ ·çš„éœ€æ±‚ï¼š</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">è·¨ä¸åŒç‰©ç†ç½‘ç»œæˆ–å­ç½‘ï¼Œéƒ¨ç½²åœ¨ä¸åŒæœåŠ¡å™¨ä¸Šçš„è™šæ‹Ÿæœºæˆ–å®¹å™¨ï¼Œè¦èƒ½åƒåœ¨åŒä¸€ä¸ªäºŒå±‚ç½‘ç»œé‡Œä¸€æ ·ç›´æ¥é€šä¿¡ã€‚</li>\n<li class=\"lvl-6\">VLANï¼ˆ802.1Qï¼‰æä¾›çš„äºŒå±‚éš”ç¦»èƒ½åŠ›åªæœ‰ 12 bit VLAN IDï¼ˆæœ€å¤š 4096 ä¸ª VLANï¼‰ï¼Œåœ¨å¤§å‹æ•°æ®ä¸­å¿ƒè¿œè¿œä¸å¤Ÿç”¨ã€‚</li>\n</ul>\n</li>\n<li class=\"lvl-2\">\n<p>æ•°æ®ä¸­å¿ƒæƒ³è¦æ›´å¥½çš„å¼¹æ€§ã€è·¨åŒºåŸŸéƒ¨ç½²ã€å®¹å™¨ç¼–æ’ã€å¤§è§„æ¨¡ç§Ÿæˆ·éš”ç¦»ã€‚</p>\n</li>\n</ul>\n<h3 id=\"VXLAN-æ ¸å¿ƒåŸç†\">VXLAN æ ¸å¿ƒåŸç†</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>VXLAN é€šè¿‡å°è£…çš„æ–¹å¼ï¼ŒæŠŠäºŒå±‚ä»¥å¤ªç½‘å¸§åŒ…åœ¨ UDP æ•°æ®æŠ¥é‡Œï¼Œåœ¨ä¸‰å±‚ IP ç½‘ç»œä¸­ä¼ é€’ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>å°è£…æ ¼å¼å¤§è‡´æ˜¯ï¼š</p>\n</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">+-------------------------+</span><br><span class=\"line\">| å¤–å±‚IPå¤´ (IP Header)    |</span><br><span class=\"line\">+-------------------------+</span><br><span class=\"line\">| å¤–å±‚UDPå¤´ (UDP Header)  |</span><br><span class=\"line\">+-------------------------+</span><br><span class=\"line\">| VXLANå¤´ (VXLAN Header)  |</span><br><span class=\"line\">+-------------------------+</span><br><span class=\"line\">| å†…å±‚äºŒå±‚å¸§ (Ethernet)   |</span><br><span class=\"line\">+-------------------------+</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å¤–å±‚ IP/UDP ç”¨äºä¸‰å±‚ä¼ è¾“</p>\n</li>\n<li class=\"lvl-2\">\n<p>å†…å±‚ä¿ç•™åŸæœ¬çš„äºŒå±‚ä»¥å¤ªç½‘å¸§ï¼ˆå¦‚ MAC åœ°å€ï¼‰</p>\n</li>\n<li class=\"lvl-2\">\n<p>VXLAN å¤´éƒ¨é‡Œé¢åŒ…å«äº†ä¸€ä¸ª VNI (VXLAN Network Identifier)ï¼š24 bitï¼Œå¯æ”¯æŒ 1600ä¸‡ä¸ªè™šæ‹Ÿç½‘ç»œ</p>\n</li>\n<li class=\"lvl-2\">\n<p>ç®€å•ç¤ºæ„å›¾</p>\n</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">VM1 (10.1.1.1) â€”â€”&gt; VTEP1 â€”â€”&gt; Underlay IPç½‘ç»œ â€”â€”&gt; VTEP2 â€”â€”&gt; VM2 (10.1.1.2)</span><br><span class=\"line\"></span><br><span class=\"line\">VTEP1 å°è£…ï¼š</span><br><span class=\"line\">  å†…å±‚ä»¥å¤ªç½‘å¸§  + VXLANå¤´ (VNI) + UDP + IP</span><br><span class=\"line\"></span><br><span class=\"line\">VTEP2 è§£å°è£…ï¼š</span><br><span class=\"line\">  å»æ‰å¤–å±‚å¤´éƒ¨ï¼Œè¿˜åŸåŸå§‹äºŒå±‚å¸§</span><br></pre></td></tr></table></figure>","content_text":"æ‘˜è¦ æœ¬æ–‡ä»‹ç» Docker Swarm çš„ ç½‘ç»œ(Overlay) Dockerå®˜æ–¹æ–‡æ¡£ Docker Swarm å®˜æ–¹æ–‡æ¡£ Overlay ç®€ä»‹ åœ¨ Docker Swarm ä¸­ï¼Œoverlay ç½‘ç»œ æ˜¯ä¸€ç§åˆ†å¸ƒå¼ç½‘ç»œé©±åŠ¨ï¼Œç”¨äºå°†é›†ç¾¤ä¸­ä¸åŒä¸»æœºä¸Šçš„å®¹å™¨è¿æ¥åˆ°åŒä¸€ä¸ªé€»è¾‘ç½‘ç»œä¸­ï¼Œå°±åƒå®ƒä»¬åœ¨åŒä¸€å°ä¸»æœºä¸Šä¸€æ ·ã€‚ å½“ä½ ä½¿ç”¨ Docker Swarm éƒ¨ç½²æœåŠ¡æ—¶ï¼ŒSwarm ä¼šè‡ªåŠ¨ä½¿ç”¨ overlay ç½‘ç»œæ¥è¿æ¥ä¸åŒèŠ‚ç‚¹ä¸Šçš„å®¹å™¨ï¼Œå®ç°æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡ï¼Œä¿è¯å®¹å™¨é—´çš„é€šä¿¡å®‰å…¨ï¼ˆé€šè¿‡åŠ å¯†ï¼‰ã€‚ overlay ç½‘ç»œç‰¹ç‚¹ è·¨ä¸»æœºé€šä¿¡ï¼šå®¹å™¨æ— è®ºåœ¨å“ªä¸ªèŠ‚ç‚¹ä¸Šï¼Œéƒ½å¯ä»¥ä½¿ç”¨ overlay ç½‘ç»œè¿›è¡Œé€šä¿¡ã€‚ å†…ç½®æœåŠ¡å‘ç°ï¼šå®¹å™¨ä¹‹é—´å¯ä»¥é€šè¿‡æœåŠ¡åç§°ç›´æ¥é€šä¿¡ã€‚ æ”¯æŒåŠ å¯†ï¼šSwarm çš„ overlay ç½‘ç»œæ”¯æŒæ•°æ®åŠ å¯†ï¼Œæé«˜å®‰å…¨æ€§ã€‚ è‡ªåŠ¨é…ç½®ï¼šSwarm ä¼šè‡ªåŠ¨ä¸º overlay ç½‘ç»œåˆ†é…å­ç½‘ã€ç®¡ç† IP ç­‰ã€‚ Swarm ä¸­çš„ overlay ç½‘ç»œ å½“æˆ‘ä»¬åˆå§‹åŒ–Swarm æ—¶ï¼ŒSwarm ä¼šè‡ªåŠ¨åˆ›å»ºä¸¤ä¸ªnetworkï¼Œä¸€ä¸ªæ˜¯ bridge networkï¼šdocker_gwbridge ï¼Œä¸€ä¸ªæ˜¯ overlay networkï¼šingressã€‚ 1234567docker network lsNETWORK ID NAME DRIVER SCOPE6b7aadbbd180 bridge bridge local5ddadf5d0608 docker_gwbridge bridge local21c6f5b1bedd host host localidx465x3jg68 ingress overlay swarma770c5ad4b13 none null local docker_gwbridge æŸ¥çœ‹ docker_gwbridge è¯¦æƒ…ï¼Œå…¶ç½‘æ®µä¸º 172.18.0.0/16ï¼Œç½‘å…³ä¸º 172.18.0.1ï¼Œå†…éƒ¨æœ‰ä¸€ä¸ªå®¹å™¨ ingress-sbox 12345678910111213141516171819202122232425262728293031323334353637383940414243docker inspect docker_gwbridge[ &#123; &quot;Name&quot;: &quot;docker_gwbridge&quot;, &quot;Id&quot;: &quot;5ddadf5d06086fcdad5890b8d59edcca4b1293bde23a26f1968fd6114fcaec93&quot;, &quot;Created&quot;: &quot;2025-06-08T07:29:52.119033035-04:00&quot;, &quot;Scope&quot;: &quot;local&quot;, &quot;Driver&quot;: &quot;bridge&quot;, &quot;EnableIPv6&quot;: false, &quot;IPAM&quot;: &#123; &quot;Driver&quot;: &quot;default&quot;, &quot;Options&quot;: null, &quot;Config&quot;: [ &#123; &quot;Subnet&quot;: &quot;172.18.0.0/16&quot;, &quot;Gateway&quot;: &quot;172.18.0.1&quot; &#125; ] &#125;, &quot;Internal&quot;: false, &quot;Attachable&quot;: false, &quot;Ingress&quot;: false, &quot;ConfigFrom&quot;: &#123; &quot;Network&quot;: &quot;&quot; &#125;, &quot;ConfigOnly&quot;: false, &quot;Containers&quot;: &#123; &quot;ingress-sbox&quot;: &#123; &quot;Name&quot;: &quot;gateway_ingress-sbox&quot;, &quot;EndpointID&quot;: &quot;4764160a1b048da6d325a2f14165a981a446892ea3b4ebb12e20ee689fdac397&quot;, &quot;MacAddress&quot;: &quot;02:42:ac:12:00:02&quot;, &quot;IPv4Address&quot;: &quot;172.18.0.2/16&quot;, &quot;IPv6Address&quot;: &quot;&quot; &#125; &#125;, &quot;Options&quot;: &#123; &quot;com.docker.network.bridge.enable_icc&quot;: &quot;false&quot;, &quot;com.docker.network.bridge.enable_ip_masquerade&quot;: &quot;true&quot;, &quot;com.docker.network.bridge.name&quot;: &quot;docker_gwbridge&quot; &#125;, &quot;Labels&quot;: &#123;&#125; &#125;] å…ˆæ¥çœ‹è¿™ä¸ªç½‘æ®µ 172.18.0.0/16ï¼Œæˆ‘ä»¬æŸ¥çœ‹ä¸»æœºçš„ç½‘ç»œå’Œè·¯ç”±è¡¨ï¼Œå¯ä»¥çœ‹åˆ° 261: docker_gwbridgeï¼Œå…¶IPåœ°å€ä¸º 172.18.0.1ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å°±å¯ä»¥çŸ¥é“ docker_gwbridge å°±æ˜¯è¿æ¥åˆ°261: docker_gwbridgeè¿™å—ç½‘å¡ä¸Šçš„ï¼Œå¦å¤–å½“å‰è¿˜æœ‰ä¸€ä¸ª263: veth3176100@if262è™šæ‹Ÿç½‘ç»œæ¥å£ä¹Ÿè¿æ¥åˆ°261: docker_gwbridgeä¸Šï¼Œé€šè¿‡è·¯ç”±è¡¨æˆ‘ä»¬å¾—çŸ¥å…¶æœ€ç»ˆè¿æ¥åˆ°2: enp0s5ä¸Šï¼Œä¹Ÿå°±æ˜¯è¿™å°ä¸»æœºçš„ç½‘å¡ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647ip a## è¾“å‡ºç»“æœ1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 inet 127.0.0.1/8 scope host lo valid_lft forever preferred_lft forever inet6 ::1/128 scope host valid_lft forever preferred_lft forever2: enp0s5: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000 link/ether 00:1c:42:49:12:82 brd ff:ff:ff:ff:ff:ff inet 10.211.55.10/24 brd 10.211.55.255 scope global noprefixroute enp0s5 valid_lft forever preferred_lft forever inet6 fdb2:2c26:f4e4:0:21c:42ff:fe49:1282/64 scope global dynamic noprefixroute valid_lft 2591886sec preferred_lft 604686sec inet6 fe80::21c:42ff:fe49:1282/64 scope link noprefixroute valid_lft forever preferred_lft forever3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default link/ether 02:42:5c:31:cd:30 brd ff:ff:ff:ff:ff:ff inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0 valid_lft forever preferred_lft forever inet6 fe80::42:5cff:fe31:cd30/64 scope link valid_lft forever preferred_lft forever261: docker_gwbridge: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default link/ether 02:42:fe:e3:ca:f7 brd ff:ff:ff:ff:ff:ff inet 172.18.0.1/16 brd 172.18.255.255 scope global docker_gwbridge valid_lft forever preferred_lft forever inet6 fe80::42:feff:fee3:caf7/64 scope link valid_lft forever preferred_lft forever263: veth3176100@if262: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker_gwbridge state UP group default link/ether 96:4b:c1:d9:83:c5 brd ff:ff:ff:ff:ff:ff link-netnsid 1 inet6 fe80::944b:c1ff:fed9:83c5/64 scope link valid_lft forever preferred_lft forever# æŸ¥çœ‹è·¯ç”±è¡¨route -n## è¾“å‡ºç»“æœï¼Œå…¶ç›®çš„åœ°å€æœ€ç»ˆéƒ½ä¼šè½¬åˆ°ç½‘å…³ 10.211.55.1 ä¸ŠKernel IP routing tableDestination Gateway Genmask Flags Metric Ref Use Iface0.0.0.0 10.211.55.1 0.0.0.0 UG 100 0 0 enp0s510.211.55.0 0.0.0.0 255.255.255.0 U 100 0 0 enp0s5172.17.0.0 0.0.0.0 255.255.0.0 U 0 0 0 docker0172.18.0.0 0.0.0.0 255.255.0.0 U 0 0 0 docker_gwbridge# æŸ¥çœ‹docker_gwbridgeç½‘æ¡¥è®¾å¤‡ä¿¡æ¯ï¼Œå¯ä»¥çœ‹åˆ°å…¶æŒ‚è½½äº†ä¸€ä¸ªè™šæ‹Ÿç½‘å¡ veth3176100brctl show docker_gwbridgebridge name bridge id STP enabled interfacesdocker_gwbridge 8000.0242fee3caf7 no veth3176100 æŒ‰ç†è¯´263: veth3176100@if262è™šæ‹Ÿç½‘ç»œæ¥å£åº”è¯¥å¯¹åº”åˆ°ä¸€ä¸ªå®¹å™¨ä¸Šï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬å°±çœ‹ä¸€çœ‹è¿™ä¸ªå®¹å™¨ ingress-sboxï¼Œå½“å‰dockerä¸­å¹¶æ²¡æœ‰è¿™ä¸ªå®¹å™¨ï¼Œé‚£ä¹ˆè¿™ä¸ªå®¹å™¨åœ¨å“ªé‡Œå‘¢ï¼Ÿdockeråˆ›å»ºçš„å®¹å™¨éƒ½ä¼šæœ‰ä¸€ä¸ªç½‘ç»œå‘½åç©ºé—´ï¼Œå…¶ä¿å­˜åœ¨å®¿ä¸»æœºçš„/var/run/docker/netns/ä¸‹ 1234cd /var/run/docker/netns/ls## è¾“å‡ºï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬è¿˜çœŸçš„å‘ç°äº†ä¸è¿™ä¸ªå®¹å™¨åç§°ç±»ä¼¼çš„ç½‘ç»œå‘½åç©ºé—´ï¼Œå®¹å™¨åç§°æ˜¯ä¸­åˆ’çº¿ï¼Œç½‘ç»œå‘½åç©ºé—´åç§°æ˜¯ä¸‹åˆ’çº¿1-idx465x3jg ingress_sbox è¿›å…¥è¿™ä¸ªç½‘ç»œï¼Œæˆ‘ä»¬å°±æ‰¾åˆ°ä¸å®¿ä¸»æœºä¸Šçš„è™šæ‹Ÿç½‘ç»œæ¥å£å¯¹åº”çš„å®¹å™¨ç½‘ç»œæ¥å£äº†ï¼š262: eth1@if263 12345678910111213141516nsenter --net=ingress_sbox ip a## è¾“å‡º1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 inet 127.0.0.1/8 scope host lo valid_lft forever preferred_lft forever inet6 ::1/128 scope host valid_lft forever preferred_lft forever259: eth0@if260: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UP group default link/ether 02:42:0a:00:00:02 brd ff:ff:ff:ff:ff:ff link-netnsid 0 inet 10.0.0.2/24 brd 10.0.0.255 scope global eth0 valid_lft forever preferred_lft forever262: eth1@if263: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default link/ether 02:42:ac:12:00:02 brd ff:ff:ff:ff:ff:ff link-netnsid 1 inet 172.18.0.2/16 brd 172.18.255.255 scope global eth1 valid_lft forever preferred_lft forever è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªç½‘ç»œæ¥å£ 259: eth0@if260ï¼Œå®ƒåˆæ˜¯ä¸è°å¯¹æ¥çš„å‘¢ï¼Ÿåˆ«ç€æ€¥ï¼Œæˆ‘ä»¬æ¥ç€å¾€ä¸‹çœ‹ã€‚ ingress æŸ¥çœ‹ ingress è¯¦æƒ…ï¼Œå…¶ç½‘æ®µä¸º 10.0.0.0/24ï¼Œç½‘å…³ä¸º 10.0.0.1ï¼Œå†…éƒ¨æœ‰ä¸€ä¸ªå®¹å™¨ ingress-sboxï¼Œå¦å¤–å…¶æœ‰ä¸€ä¸ªPeerså±æ€§ï¼Œå†…éƒ¨åŒ…å«äº†é›†ç¾¤ä¸­æ‰€æœ‰çš„èŠ‚ç‚¹IPï¼Œæ‰€ä»¥ä»è¿™é‡Œä¹Ÿèƒ½å¤§æ¦‚çŒœå‡ºè¿™ä¸ªç½‘ç»œæ˜¯è´Ÿè´£èŠ‚ç‚¹é—´é€šä¿¡çš„ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364docker network inspect ingress## è¾“å‡º[ &#123; &quot;Name&quot;: &quot;ingress&quot;, &quot;Id&quot;: &quot;idx465x3jg682fmceumsio297&quot;, &quot;Created&quot;: &quot;2025-06-08T07:29:51.734714967-04:00&quot;, &quot;Scope&quot;: &quot;swarm&quot;, &quot;Driver&quot;: &quot;overlay&quot;, &quot;EnableIPv6&quot;: false, &quot;IPAM&quot;: &#123; &quot;Driver&quot;: &quot;default&quot;, &quot;Options&quot;: null, &quot;Config&quot;: [ &#123; &quot;Subnet&quot;: &quot;10.0.0.0/24&quot;, &quot;Gateway&quot;: &quot;10.0.0.1&quot; &#125; ] &#125;, &quot;Internal&quot;: false, &quot;Attachable&quot;: false, &quot;Ingress&quot;: true, &quot;ConfigFrom&quot;: &#123; &quot;Network&quot;: &quot;&quot; &#125;, &quot;ConfigOnly&quot;: false, &quot;Containers&quot;: &#123; &quot;ingress-sbox&quot;: &#123; &quot;Name&quot;: &quot;ingress-endpoint&quot;, &quot;EndpointID&quot;: &quot;fd05086c5104e28c75dbed3e3b308236aaa0e87b698dad6186c23c81755bb009&quot;, &quot;MacAddress&quot;: &quot;02:42:0a:00:00:02&quot;, &quot;IPv4Address&quot;: &quot;10.0.0.2/24&quot;, &quot;IPv6Address&quot;: &quot;&quot; &#125; &#125;, &quot;Options&quot;: &#123; &quot;com.docker.network.driver.overlay.vxlanid_list&quot;: &quot;4096&quot; &#125;, &quot;Labels&quot;: &#123;&#125;, &quot;Peers&quot;: [ &#123; &quot;Name&quot;: &quot;4969a4611607&quot;, &quot;IP&quot;: &quot;10.211.55.10&quot; &#125;, &#123; &quot;Name&quot;: &quot;ae3756658a26&quot;, &quot;IP&quot;: &quot;10.211.55.14&quot; &#125;, &#123; &quot;Name&quot;: &quot;f12309731131&quot;, &quot;IP&quot;: &quot;10.211.55.13&quot; &#125;, &#123; &quot;Name&quot;: &quot;de5000b11067&quot;, &quot;IP&quot;: &quot;10.211.55.12&quot; &#125;, &#123; &quot;Name&quot;: &quot;377001904d63&quot;, &quot;IP&quot;: &quot;10.211.55.11&quot; &#125; ] &#125;] æˆ‘ä»¬è¿˜æ˜¯å…ˆæ¥çœ‹è¿™ä¸ªç½‘å…³10.0.0.1ï¼Œåœ¨å“ªå‘¢ï¼Ÿå®¿ä¸»æœºçš„ç½‘ç»œè®¾å¤‡ä¸­å¹¶æ²¡æœ‰ï¼Œæ‰€ä»¥å®ƒåº”è¯¥æ˜¯dockeråˆ›å»ºçš„ï¼Œæˆ‘ä»¬è¿˜æ˜¯è¦ä»/var/run/docker/netnsä¸­æŸ¥çœ‹ä¸€ä¸‹ï¼Œè¿™é‡Œè¿˜æœ‰ä¸€ä¸ªåç§°ä¸º 1-idx465x3jg çš„ç½‘ç»œå‘½åç©ºé—´ï¼Œæˆ‘ä»¬è¿›å»çœ‹çœ‹ 12345678910111213141516nsenter --net=/var/run/docker/netns/1-idx465x3jg ip a## è¾“å‡º1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 inet 127.0.0.1/8 scope host lo valid_lft forever preferred_lft forever inet6 ::1/128 scope host valid_lft forever preferred_lft forever258: vxlan0@if258: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue master br0 state UNKNOWN group default link/ether 32:c9:a4:01:8a:19 brd ff:ff:ff:ff:ff:ff link-netnsid 02: br0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UP group default link/ether 32:c9:a4:01:8a:19 brd ff:ff:ff:ff:ff:ff inet 10.0.0.1/24 brd 10.0.0.255 scope global br0 valid_lft forever preferred_lft forever260: veth0@if259: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue master br0 state UP group default link/ether 8a:d3:52:ac:7d:cd brd ff:ff:ff:ff:ff:ff link-netnsid 1 åœ¨è¿™é‡Œæˆ‘ä»¬æ‰¾åˆ°äº†2: br0ï¼Œå…¶IPåœ°å€ä¸º10.0.0.1ï¼Œæ‰€ä»¥å®ƒå°±æ˜¯æˆ‘ä»¬è¦æ‰¾çš„ç½‘å…³ã€‚å…¶ä¸Šé¢è¿˜æŒ‚è½½äº†ä¸¤ä¸ªç½‘ç»œè®¾å¤‡ï¼Œä¸€ä¸ªæ˜¯ 260: veth0@if259ï¼Œè¿™ä¸ªå°±æ˜¯ä¸ingress_sbox ä¸­259: eth0@if260å¯¹åº”çš„ç½‘ç»œæ¥å£ ï¼Œå¦ä¸€ä¸ªæ˜¯ 258: vxlan0@if258ï¼Œå…¶åŸºäºvxlanåè®®ï¼Œè´Ÿè´£é›†ç¾¤è·¨ä¸»æœºé€šä¿¡ã€‚ overlayæ€»ç»“ docker_gwbridgeä¸­çš„å®¹å™¨ingress-sboxï¼Œå…¶æœ‰ä¸¤å—ç½‘å¡ï¼Œä¸€å—å¯¹æ¥å®¿ä¸»æœºä¸Šçš„ 261: docker_gwbridgeï¼Œå¦ä¸€å—å¯¹æ¥/var/run/docker/netns/1-idx465x3jgä¸­çš„ 2: br0ã€‚ å®é™…ä¸ŠSwarmä¸­çš„æ‰€æœ‰å®¹å™¨éƒ½æœ‰ä¸¤ä¸ªç½‘å¡ï¼Œä¸€å—å¯¹æ¥å®¿ä¸»æœºä¸Šçš„ 261: docker_gwbridgeï¼Œå¦ä¸€å—å¯¹æ¥/var/run/docker/netns/1-idx465x3jgä¸­çš„ 2: br0ã€‚ å½“è¯·æ±‚åˆ°è¾¾å®¿ä¸»æœºæ—¶ï¼Œä¼šé€šè¿‡enp0s5è½¬å‘åˆ°docker_gwbridgeï¼Œç„¶åå…ˆè¢«è½¬åˆ°ingress-sboxå®¹å™¨ï¼Œç„¶åå†ç»è¿‡å…¶è½¬å‘åˆ°br0ç½‘å…³ï¼Œå†ç”±å®ƒè´Ÿè´£æŸ¥æ‰¾ç›®æ ‡å®¹å™¨ã€‚å¦‚æœç›®æ ‡å®¹å™¨ä¸åœ¨æœ¬èŠ‚ç‚¹ï¼Œåˆ™é€šè¿‡vxlan0ç½‘ç»œæ¥å£è½¬å‘åˆ°å…¶å®ƒèŠ‚ç‚¹è¿›è¡ŒæŸ¥æ‰¾ï¼Œä¸­é—´ç»è¿‡ä¸€ç³»åˆ—çš„ç½‘ç»œåœ°å€è½¬æ¢ã€‚ å½“ä½ é€šè¿‡docker network create --driver overlay my-networkåˆ›å»ºä¸€ä¸ªoverlayç½‘ç»œæ—¶ï¼ŒDockerä¼šåˆ›å»ºä¸€ä¸ªç±»ä¼¼â€œingressâ€çš„ç½‘ç»œç»“æ„(æ–°çš„br0)ï¼Œå¦‚æœä¸æŒ‡å®šipæ®µï¼Œå…¶ipæ®µä¼šä»10.0.1.0/24å¼€å§‹ï¼Œä¾æ¬¡é€’å¢ä¸€ä¸ªç½‘æ®µã€‚ä½†ä¼šå…±ç”¨docker_gwbridgeã€‚ æŸ¥çœ‹overlayç½‘ç»œä¸­çš„è´Ÿè½½å‡è¡¡ å¯åŠ¨ä¸€ä¸ªservice 1docker service create --name my-nginx --replicas 5 --publish 80:80 nginx æŸ¥çœ‹ingress_sboxçš„iptablesæ•°æ®é“¾ä¸­çš„ mangle è¡¨ 123456789101112131415161718nsenter --net=/var/run/docker/netns/ingress_sbox iptables -nvL -t mangle## è¾“å‡ºç»“æœï¼Œè¿™é‡Œçœ‹åˆ° PREROUTING é“¾ä¸­æœ‰ä¸€æ¡ç›‘å¬80ç«¯å£çš„è§„åˆ™ï¼Œå…¶è¢«æ‰“äº†Markæ ‡è®°: 0x105ï¼Œæ¢ç®—ä¸º10è¿›åˆ¶ï¼š261Chain PREROUTING (policy ACCEPT 0 packets, 0 bytes) pkts bytes target prot opt in out source destination 0 0 MARK tcp -- * * 0.0.0.0/0 0.0.0.0/0 tcp dpt:80 MARK set 0x105Chain INPUT (policy ACCEPT 0 packets, 0 bytes) pkts bytes target prot opt in out source destination 0 0 MARK all -- * * 0.0.0.0/0 10.0.0.33 MARK set 0x105Chain FORWARD (policy ACCEPT 0 packets, 0 bytes) pkts bytes target prot opt in out source destinationChain OUTPUT (policy ACCEPT 0 packets, 0 bytes) pkts bytes target prot opt in out source destinationChain POSTROUTING (policy ACCEPT 0 packets, 0 bytes) pkts bytes target prot opt in out source destination é€šè¿‡ipvsadmæŸ¥çœ‹è´Ÿè½½å‡è¡¡ä¿¡æ¯ ipvsadm æ˜¯ Linux ä¸‹ç®¡ç† IPVSï¼ˆIP Virtual Serverï¼‰è´Ÿè½½å‡è¡¡å™¨çš„å‘½ä»¤ä¹‹ä¸€ 12345678910111213141516171819202122232425# å¦‚æœæ²¡æœ‰ipvsadmï¼Œåˆ™å®‰è£…dnf install ipvsadm -y# æŸ¥çœ‹ipvsä¿¡æ¯nsenter --net=/var/run/docker/netns/ingress_sbox ipvsadm -Ln# -Lï¼šè¡¨ç¤ºåˆ—å‡ºå½“å‰ IPVS çš„è§„åˆ™å’ŒçŠ¶æ€ï¼ˆListï¼‰ã€‚# -nï¼šè¡¨ç¤ºä»¥æ•°å­—æ–¹å¼æ˜¾ç¤ºåœ°å€å’Œç«¯å£ï¼Œè€Œä¸è¿›è¡Œ DNS è§£ææˆ–ç«¯å£åè§£æï¼ˆå³ï¼šIP å’Œç«¯å£å·ä»¥æ•°å­—æ˜¾ç¤ºï¼Œæ›´ç›´è§‚ï¼Œä¹Ÿæ›´å¿«ï¼‰ã€‚## è¾“å‡ºï¼Œå¯ä»¥çœ‹åˆ° FWM 261 rrï¼Œè¿™é‡Œrrè¡¨ç¤ºè½®è¯¢IP Virtual Server version 1.2.1 (size=4096)Prot LocalAddress:Port Scheduler Flags -&gt; RemoteAddress:Port Forward Weight ActiveConn InActConnFWM 261 rr -&gt; 10.0.0.34:0 Masq 1 0 0 -&gt; 10.0.0.35:0 Masq 1 0 0 -&gt; 10.0.0.36:0 Masq 1 0 0 -&gt; 10.0.0.37:0 Masq 1 0 0 -&gt; 10.0.0.38:0 Masq 1 0 0## è¾“å‡ºè§£é‡Š# Prot: åè®®ï¼ˆTCP/UDPï¼‰,è¿™é‡Œæ˜¯ FWMï¼Œè¡¨ç¤ºFirewall Markï¼ˆé˜²ç«å¢™æ ‡è®°ï¼‰æ¨¡å¼# LocalAddress:Port: æœ¬åœ°åœ°å€å’Œç«¯å£å·ï¼Œè¿™é‡Œæ˜¯ 261 ï¼Œè¿™æ˜¯é˜²ç«å¢™æ ‡è®°å€¼ï¼ˆmark å€¼ï¼‰,å°±æ˜¯ä¸Šé¢çœ‹åˆ°çš„é‚£ä¸ª16è¿›åˆ¶ 0x105# Scheduler: è°ƒåº¦ç®—æ³•ï¼Œè¿™é‡Œæ˜¯ rrï¼Œè¡¨ç¤ºè½®è¯¢(round-robin)ï¼Œè°ƒåº¦ç®—æ³•è¿˜æœ‰ wrrï¼ˆåŠ æƒè½®è¯¢ï¼‰ã€lcï¼ˆæœ€å°‘è¿æ¥ï¼‰ç­‰# RemoteAddress:Port: è¿œç¨‹åœ°å€å’Œç«¯å£å·ï¼Œè¿™é‡Œæ˜¯ 10.0.0.34:0ï¼Œè¡¨ç¤ºè´Ÿè½½å‡è¡¡åˆ°çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œåé¢åŒç†# Forward: è½¬å‘ç­–ç•¥ï¼Œè¿™é‡Œæ˜¯ Masqï¼Œè¡¨ç¤ºå°†è´Ÿè½½å‡è¡¡åˆ°çš„èŠ‚ç‚¹çš„IPåœ°å€è½¬æ¢æˆå®¿ä¸»æœºçš„IPåœ°å€ï¼Œå³ Masqueradeï¼ˆä¼ªè£…ï¼‰ã€‚è½¬å‘æ–¹å¼ï¼ˆå¦‚ï¼šMasqã€Tunnelã€Direct Routeï¼‰# Weight: æƒé‡ï¼Œè¿™é‡Œæ˜¯ 1ï¼Œè¡¨ç¤ºè´Ÿè½½å‡è¡¡åˆ°çš„èŠ‚ç‚¹çš„æƒé‡ï¼Œé»˜è®¤ä¸º 1# ActiveConn: å½“å‰æ´»åŠ¨è¿æ¥æ•°ï¼Œè¿™é‡Œæ˜¯ 0# InActConn: å½“å‰ä¸æ´»åŠ¨è¿æ¥æ•°ï¼ˆç­‰å¾…å…³é—­çš„è¿æ¥ï¼‰ï¼Œè¿™é‡Œæ˜¯ 0 VXLANæ˜¯ä»€ä¹ˆï¼Ÿ VXLANï¼ˆVirtual Extensible LANï¼‰æ˜¯ Cisco å…¬å¸å¼€å‘çš„ä¸€ç§è™šæ‹Ÿå±€åŸŸç½‘ï¼ˆVLANï¼‰æŠ€æœ¯ï¼Œå®ƒå¯ä»¥å°†å¤šä¸ª VLAN é€»è¾‘åˆ†ç»„ï¼Œå¹¶ä½¿ç”¨å•ä¸ªç‰©ç†ç½‘ç»œè¿›è¡Œç®¡ç†ã€‚VXLAN çš„ä¸»è¦ä½œç”¨æ˜¯æé«˜ç½‘ç»œæ€§èƒ½å’Œæ‰©å±•æ€§ã€‚ å®ƒæœ¬è´¨ä¸Šæ˜¯ä¸€ç§ ç½‘ç»œå°è£…åè®®ï¼ˆoverlay protocolï¼‰ï¼Œç”¨æ¥åœ¨å·²æœ‰çš„ IP ç½‘ç»œä¹‹ä¸Šï¼Œæ„å»ºäºŒå±‚ï¼ˆL2ï¼‰è™šæ‹Ÿç½‘ç»œã€‚ ä¸ºä»€ä¹ˆéœ€è¦ VXLANï¼Ÿ åœ¨ä¼ ç»Ÿæ•°æ®ä¸­å¿ƒæˆ–äº‘è®¡ç®—ä¸­ï¼Œç»å¸¸æœ‰è¿™æ ·çš„éœ€æ±‚ï¼š è·¨ä¸åŒç‰©ç†ç½‘ç»œæˆ–å­ç½‘ï¼Œéƒ¨ç½²åœ¨ä¸åŒæœåŠ¡å™¨ä¸Šçš„è™šæ‹Ÿæœºæˆ–å®¹å™¨ï¼Œè¦èƒ½åƒåœ¨åŒä¸€ä¸ªäºŒå±‚ç½‘ç»œé‡Œä¸€æ ·ç›´æ¥é€šä¿¡ã€‚ VLANï¼ˆ802.1Qï¼‰æä¾›çš„äºŒå±‚éš”ç¦»èƒ½åŠ›åªæœ‰ 12 bit VLAN IDï¼ˆæœ€å¤š 4096 ä¸ª VLANï¼‰ï¼Œåœ¨å¤§å‹æ•°æ®ä¸­å¿ƒè¿œè¿œä¸å¤Ÿç”¨ã€‚ æ•°æ®ä¸­å¿ƒæƒ³è¦æ›´å¥½çš„å¼¹æ€§ã€è·¨åŒºåŸŸéƒ¨ç½²ã€å®¹å™¨ç¼–æ’ã€å¤§è§„æ¨¡ç§Ÿæˆ·éš”ç¦»ã€‚ VXLAN æ ¸å¿ƒåŸç† VXLAN é€šè¿‡å°è£…çš„æ–¹å¼ï¼ŒæŠŠäºŒå±‚ä»¥å¤ªç½‘å¸§åŒ…åœ¨ UDP æ•°æ®æŠ¥é‡Œï¼Œåœ¨ä¸‰å±‚ IP ç½‘ç»œä¸­ä¼ é€’ã€‚ å°è£…æ ¼å¼å¤§è‡´æ˜¯ï¼š 123456789+-------------------------+| å¤–å±‚IPå¤´ (IP Header) |+-------------------------+| å¤–å±‚UDPå¤´ (UDP Header) |+-------------------------+| VXLANå¤´ (VXLAN Header) |+-------------------------+| å†…å±‚äºŒå±‚å¸§ (Ethernet) |+-------------------------+ å¤–å±‚ IP/UDP ç”¨äºä¸‰å±‚ä¼ è¾“ å†…å±‚ä¿ç•™åŸæœ¬çš„äºŒå±‚ä»¥å¤ªç½‘å¸§ï¼ˆå¦‚ MAC åœ°å€ï¼‰ VXLAN å¤´éƒ¨é‡Œé¢åŒ…å«äº†ä¸€ä¸ª VNI (VXLAN Network Identifier)ï¼š24 bitï¼Œå¯æ”¯æŒ 1600ä¸‡ä¸ªè™šæ‹Ÿç½‘ç»œ ç®€å•ç¤ºæ„å›¾ 1234567VM1 (10.1.1.1) â€”â€”&gt; VTEP1 â€”â€”&gt; Underlay IPç½‘ç»œ â€”â€”&gt; VTEP2 â€”â€”&gt; VM2 (10.1.1.2)VTEP1 å°è£…ï¼š å†…å±‚ä»¥å¤ªç½‘å¸§ + VXLANå¤´ (VNI) + UDP + IPVTEP2 è§£å°è£…ï¼š å»æ‰å¤–å±‚å¤´éƒ¨ï¼Œè¿˜åŸåŸå§‹äºŒå±‚å¸§","summary":"æ‘˜è¦ æœ¬æ–‡ä»‹ç» Docker Swarm çš„ ç½‘ç»œ(Overlay) Dockerå®˜æ–¹æ–‡æ¡£ Docker Swarm å®˜æ–¹æ–‡æ¡£","date_published":"2025-06-11T13:30:05.000Z","tags":["æŠ€æœ¯","docker","docker"]},{"id":"https://blog.hanqunfeng.com/2025/06/10/docker-swarm-service/","url":"https://blog.hanqunfeng.com/2025/06/10/docker-swarm-service/","title":"Docker Swarm ä¹‹ æœåŠ¡(Service)","content_html":"<!--\n **åŠ ç²—**\n *æ–œä½“*\n ***åŠ ç²—å¹¶æ–œä½“***\n ~~åˆ é™¤çº¿~~\n ==çªå‡ºæ˜¾ç¤º==\n `çªå‡ºæ˜¾ç¤º(æ¨è)`\n ++ä¸‹åˆ’çº¿++\n ~ä¸‹æ ‡~\n ^ä¸Šæ ‡^\n è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference.\n å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)\n\n +++ **ç‚¹å‡»æŠ˜å **\n è¿™æ˜¯è¢«éšè—çš„å†…å®¹\n +++\n\n::: tips success warning danger\nè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹\n:::\n\n% note info % success warning danger\nè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹\n% endnote %\n\nå¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{}\n å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ\n -->\n<h2 id=\"æ‘˜è¦\">æ‘˜è¦</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æœ¬æ–‡ä»‹ç» Docker Swarm çš„ æœåŠ¡ç®¡ç†</p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://docs.docker.com\">Dockerå®˜æ–¹æ–‡æ¡£</a></p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://docs.docker.com/engine/swarm/\">Docker Swarm å®˜æ–¹æ–‡æ¡£</a></p>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"Service-ä¸-Task\">Service ä¸ Task</h2>\n<h3 id=\"ä»€ä¹ˆæ˜¯-Serviceï¼Ÿ\">ä»€ä¹ˆæ˜¯ Serviceï¼Ÿ</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Service æ˜¯ç”¨æˆ·å®šä¹‰çš„æœåŠ¡æŠ½è±¡ï¼Œä¸€ä¸ª Service è¡¨ç¤ºä½ å¸Œæœ›åœ¨ Swarm é›†ç¾¤ä¸­è¿è¡Œçš„æŸä¸ªâ€œåº”ç”¨â€ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>å®ƒå®šä¹‰äº†ä½ è¦è¿è¡Œçš„å®¹å™¨é•œåƒã€å¯åŠ¨å‘½ä»¤ã€å‰¯æœ¬æ•°é‡ã€ç½‘ç»œé…ç½®ã€ç¯å¢ƒå˜é‡ã€ç«¯å£æ˜ å°„ç­‰ä¿¡æ¯ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>å¯ä»¥ç±»æ¯”æˆ Kubernetes ä¸­çš„ Deploymentï¼Œä»£è¡¨çš„æ˜¯â€œæœŸæœ›çŠ¶æ€â€ã€‚</p>\n</li>\n</ul>\n<h3 id=\"ä»€ä¹ˆæ˜¯-Taskï¼Ÿ\">ä»€ä¹ˆæ˜¯ Taskï¼Ÿ</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Task æ˜¯ Service çš„å®é™…æ‰§è¡Œå®ä¾‹ï¼ŒSwarm ä¼šæ ¹æ® Service çš„é…ç½®ç”Ÿæˆ Taskã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>Serviceä¸­çš„æ¯ä¸ªå‰¯æœ¬å¯¹åº”ä¸€ä¸ª Taskï¼Œæ¯ä¸€ä¸ª Task ä»£è¡¨ä¸€ä¸ªè¦åœ¨æŸä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œçš„å®¹å™¨ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>Task çš„çŠ¶æ€ç”± Swarm ç®¡ç†ï¼Œå®ƒè´Ÿè´£å¯åŠ¨ã€è°ƒåº¦ã€é‡å¯ç­‰ç”Ÿå‘½å‘¨æœŸæ“ä½œã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>å½“æŸä¸ª Task å´©æºƒï¼ŒSwarm ä¼šè‡ªåŠ¨é‡æ–°è°ƒåº¦ä¸€ä¸ªæ–°çš„ Task æ¥æ›¿ä»£å®ƒã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>Task æ˜¯ä¸å¯å˜çš„ï¼Œä¸€æ—¦åˆ›å»ºä¸èƒ½ä¿®æ”¹ï¼Œæ›´æ–° Service ä¼šåˆ›å»ºæ–°çš„ Taskã€‚</p>\n</li>\n</ul>\n<h3 id=\"ç¤ºä¾‹\">ç¤ºä¾‹</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åˆ›å»ºä¸€ä¸ªåä¸º nginx çš„ Serviceï¼Œå¹¶æŒ‡å®šé•œåƒä¸º nginx:latestï¼Œå¹¶è®¾ç½®å‰¯æœ¬æ•°ä¸º 3ã€‚</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker service create --name nginx --replicas 3 nginx:latest</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>è¿™é‡Œåˆ›å»ºäº†ä¸€ä¸ªåä¸º nginx çš„ Serviceï¼Œå¹¶è®¾ç½®äº†å‰¯æœ¬æ•°ä¸º 3ï¼Œå³Swarmä¼šåˆ›å»º3ä¸ªTaskæ¥å®Œæˆè¿™ä¸ªä»»åŠ¡ï¼Œæ¯ä¸ª Task æœ€ç»ˆä¼šå¯¹åº”ä¸€ä¸ªå…·ä½“çš„nginxå®¹å™¨ã€‚</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>é¡¹ç›®</th>\n<th>Service</th>\n<th>Task</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>å®šä¹‰</td>\n<td>ç”¨æˆ·å®šä¹‰çš„æœåŠ¡é…ç½®</td>\n<td>æœåŠ¡é…ç½®ç”Ÿæˆçš„æ‰§è¡Œå•å…ƒ</td>\n</tr>\n<tr>\n<td>æ•°é‡å…³ç³»</td>\n<td>ä¸€ä¸ª Service åŒ…å«å¤šä¸ª Task</td>\n<td>ä¸€ä¸ª Task å±äºä¸€ä¸ª Service</td>\n</tr>\n<tr>\n<td>çŠ¶æ€</td>\n<td>æè¿°â€œæœŸæœ›çŠ¶æ€â€</td>\n<td>ä»£è¡¨â€œå®é™…çŠ¶æ€â€</td>\n</tr>\n<tr>\n<td>ç”Ÿå‘½å‘¨æœŸ</td>\n<td>å¯ä»¥æ›´æ–°</td>\n<td>ä¸å¯å˜ï¼Œæ›´æ–°æ„å‘³ç€é‡æ–°åˆ›å»º</td>\n</tr>\n<tr>\n<td>ç®¡ç†è€…</td>\n<td>ç”±ç”¨æˆ·ç®¡ç†</td>\n<td>å®Œå…¨ç”± Swarm è°ƒåº¦å’Œç®¡ç†</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"Service-ç›¸å…³å‘½ä»¤\">Service ç›¸å…³å‘½ä»¤</h2>\n<table>\n<thead>\n<tr>\n<th>å‘½ä»¤</th>\n<th>ä¸­æ–‡è¯´æ˜</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>create</td>\n<td>åˆ›å»ºä¸€ä¸ªæ–°çš„æœåŠ¡</td>\n</tr>\n<tr>\n<td>inspect</td>\n<td>æ˜¾ç¤ºä¸€ä¸ªæˆ–å¤šä¸ªæœåŠ¡çš„è¯¦ç»†ä¿¡æ¯</td>\n</tr>\n<tr>\n<td>logs</td>\n<td>è·å–æœåŠ¡æˆ–ä»»åŠ¡çš„æ—¥å¿—</td>\n</tr>\n<tr>\n<td>ls</td>\n<td>åˆ—å‡ºæ‰€æœ‰æœåŠ¡</td>\n</tr>\n<tr>\n<td>ps</td>\n<td>åˆ—å‡ºä¸€ä¸ªæˆ–å¤šä¸ªæœåŠ¡çš„ä»»åŠ¡ï¼ˆTaskï¼‰</td>\n</tr>\n<tr>\n<td>rm</td>\n<td>åˆ é™¤ä¸€ä¸ªæˆ–å¤šä¸ªæœåŠ¡</td>\n</tr>\n<tr>\n<td>rollback</td>\n<td>å›æ»šæœåŠ¡çš„é…ç½®æ›´æ”¹</td>\n</tr>\n<tr>\n<td>scale</td>\n<td>æ‰©ç¼©ä¸€ä¸ªæˆ–å¤šä¸ªå¯å¤åˆ¶æœåŠ¡çš„å‰¯æœ¬æ•°é‡</td>\n</tr>\n<tr>\n<td>update</td>\n<td>æ›´æ–°æœåŠ¡é…ç½®</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"docker-service-create-åˆ›å»ºæœåŠ¡\"><code>docker service create</code>:  åˆ›å»ºæœåŠ¡</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å¸¸ç”¨å‚æ•°è¯´æ˜</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>å‚æ•°</th>\n<th>è¯´æ˜</th>\n<th>ç¤ºä¾‹å‘½ä»¤ï¼ˆå«è¯´æ˜ï¼‰</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>--name</code></td>\n<td>æŒ‡å®šæœåŠ¡åç§°</td>\n<td><code>docker service create --name my-web nginx</code><br>â†’ åˆ›å»ºä¸€ä¸ªåä¸º <code>my-web</code> çš„ nginx æœåŠ¡</td>\n</tr>\n<tr>\n<td><code>--replicas</code></td>\n<td>è®¾ç½®å‰¯æœ¬æ•°é‡ï¼ˆä»…é€‚ç”¨äº replicated æ¨¡å¼ï¼‰</td>\n<td><code>docker service create --replicas 3 nginx</code><br>â†’ å¯åŠ¨ 3 ä¸ª nginx å‰¯æœ¬</td>\n</tr>\n<tr>\n<td><code>--publish</code> æˆ– <code>-p</code></td>\n<td>æ˜ å°„ç«¯å£ï¼ˆæ ¼å¼å¦‚ <code>80:80</code>ï¼‰</td>\n<td><code>docker service create -p 8080:80 nginx</code><br>â†’ å°†å®¹å™¨çš„ 80 ç«¯å£æ˜ å°„åˆ°ä¸»æœº 8080</td>\n</tr>\n<tr>\n<td><code>--env</code> æˆ– <code>-e</code></td>\n<td>è®¾ç½®ç¯å¢ƒå˜é‡</td>\n<td><code>docker service create -e ENV=prod nginx</code><br>â†’ è®¾ç½®ç¯å¢ƒå˜é‡ <code>ENV=prod</code></td>\n</tr>\n<tr>\n<td><code>--mount</code></td>\n<td>è®¾ç½®æ•°æ®å·æŒ‚è½½</td>\n<td><code>docker service create --mount type=bind,src=/data,target=/app nginx</code><br>â†’ å°†ä¸»æœºçš„ <code>/data</code> ç›®å½•æŒ‚è½½åˆ°å®¹å™¨å†… <code>/app</code></td>\n</tr>\n<tr>\n<td><code>--constraint</code></td>\n<td>è®¾ç½®éƒ¨ç½²çº¦æŸï¼ˆå¦‚æŒ‡å®šèŠ‚ç‚¹ï¼‰</td>\n<td><code>docker service create --constraint 'node.labels.type == web' nginx</code><br>â†’ ä»…éƒ¨ç½²åœ¨å¸¦æ ‡ç­¾ <code>type=web</code> çš„èŠ‚ç‚¹ä¸Š</td>\n</tr>\n<tr>\n<td><code>--network</code></td>\n<td>æŒ‡å®šæœåŠ¡æ‰€å±çš„ç½‘ç»œï¼ˆé€šå¸¸ä½¿ç”¨ overlay ç½‘ç»œï¼‰</td>\n<td><code>docker service create --network my-net nginx</code><br>â†’ å°†æœåŠ¡è¿æ¥åˆ°è‡ªå®šä¹‰ç½‘ç»œ <code>my-net</code></td>\n</tr>\n<tr>\n<td><code>--detach</code> æˆ– <code>-d</code></td>\n<td>åå°è¿è¡ŒæœåŠ¡ï¼ˆé»˜è®¤è¡Œä¸ºï¼‰</td>\n<td><code>docker service create -d nginx</code><br>â†’ åå°åˆ›å»ºæœåŠ¡ï¼Œä¸é˜»å¡ç»ˆç«¯ï¼Œå› ä¸ºæ˜¯é»˜è®¤è¡Œä¸ºï¼Œæ‰€ä»¥ä¸åŠ  -d ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œserviceä¸æ”¯æŒåƒ docker run é‚£æ ·æ”¯æŒå‰å°è¿è¡Œ</td>\n</tr>\n<tr>\n<td><code>--limit-cpu</code> / <code>--limit-memory</code></td>\n<td>è®¾ç½®èµ„æºé™åˆ¶</td>\n<td><code>docker service create --limit-cpu 0.5 --limit-memory 256M nginx</code><br>â†’ æ¯ä¸ªä»»åŠ¡æœ€å¤šä½¿ç”¨ 0.5 ä¸ª CPU å’Œ 256MB å†…å­˜</td>\n</tr>\n<tr>\n<td><code>--restart-condition</code></td>\n<td>è®¾ç½®é‡å¯ç­–ç•¥ï¼ˆå¦‚ on-failureã€anyã€noneï¼‰</td>\n<td><code>docker service create --restart-condition on-failure nginx</code><br>â†’ ä»…å½“å®¹å™¨å¤±è´¥æ—¶è‡ªåŠ¨é‡å¯</td>\n</tr>\n<tr>\n<td><code>--mode</code></td>\n<td>æŒ‡å®šæœåŠ¡è¿è¡Œæ¨¡å¼ï¼Œæ”¯æŒï¼š<code>replicated</code>ã€<code>global</code>ã€<code>replicated-job</code>ã€<code>global-job</code></td>\n<td><code>docker service create --mode global nginx</code><br>â†’ åœ¨é›†ç¾¤æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œä¸€ä¸ª nginx å®ä¾‹</td>\n</tr>\n</tbody>\n</table>\n<blockquote>\n<p>cpu ä¸ å†…å­˜é™åˆ¶</p>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th>å‚æ•°</th>\n<th>æ„ä¹‰</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>--limit-cpu 1.0</code></td>\n<td>é™åˆ¶æ¯ä¸ªå®¹å™¨æœ€å¤šä½¿ç”¨ 1 æ ¸ CPUæ—¶é—´ , 1 CPU = åœ¨æ¯ä¸ªè°ƒåº¦å‘¨æœŸä¸­å¯å æ»¡ CPU çš„å…¨éƒ¨æ—¶é—´ä»½é¢(ä¸€ä¸ªå‘¨æœŸæ—¶é—´é»˜è®¤100ms)</td>\n</tr>\n<tr>\n<td><code>--limit-cpu 0.5</code></td>\n<td>é™åˆ¶æ¯ä¸ªå®¹å™¨æœ€å¤šä½¿ç”¨ 50% çš„å•æ ¸CPUæ—¶é—´</td>\n</tr>\n<tr>\n<td><code>--limit-cpu 3.5</code></td>\n<td>æ¯ä¸ªå®¹å™¨æœ€å¤šå¯ä»¥ä½¿ç”¨ 3.5 æ ¸çš„ CPU æ—¶é—´ï¼Œç”±è°ƒåº¦å™¨å†³å®šåˆ†é…ã€‚å¹¶ä¸æ˜¯é™åˆ¶æˆåªèƒ½è·‘åœ¨ä¸€ä¸ªæ ¸ä¸Šï¼Œè€Œæ˜¯é™åˆ¶â€œæ€»å…±ä½¿ç”¨ä¸è¶…è¿‡ 3.5 æ ¸çš„æ—¶é—´ç‰‡â€ã€‚</td>\n</tr>\n<tr>\n<td><code>--limit-memory 512M</code></td>\n<td>é™åˆ¶æ¯ä¸ªå®¹å™¨æœ€å¤šä½¿ç”¨æŒ‡å®šå†…å­˜ï¼ˆå¦‚ 512Mï¼‰</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æœåŠ¡è¿è¡Œæ¨¡å¼ï¼ˆâ€“modeï¼‰è¯¦è§£</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>æ¨¡å¼åç§°</th>\n<th>è¯´æ˜</th>\n<th>ä½¿ç”¨åœºæ™¯ç¤ºä¾‹</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>replicated</code></td>\n<td>é»˜è®¤æ¨¡å¼ã€‚ç”¨æˆ·æŒ‡å®šéœ€è¦è¿è¡Œå¤šå°‘ä¸ªå‰¯æœ¬ï¼ŒSwarm åœ¨åˆé€‚çš„èŠ‚ç‚¹ä¸Šè°ƒåº¦è¿™äº›å‰¯æœ¬ã€‚</td>\n<td>å…¸å‹çš„ Web æœåŠ¡ï¼Œå¦‚ nginxã€Node.jsã€Java åº”ç”¨ç­‰</td>\n</tr>\n<tr>\n<td><code>global</code></td>\n<td>æ¯ä¸ªå¯ç”¨èŠ‚ç‚¹åªéƒ¨ç½²ä¸€ä¸ªä»»åŠ¡å®ä¾‹ï¼Œä¸éœ€è¦ç”¨æˆ·æŒ‡å®šå‰¯æœ¬æ•°ã€‚</td>\n<td>ç³»ç»Ÿçº§æœåŠ¡ï¼Œå¦‚æ—¥å¿—æ”¶é›†å™¨ï¼ˆFluentdï¼‰ã€ç›‘æ§ä»£ç†ï¼ˆPrometheus node exporterï¼‰</td>\n</tr>\n<tr>\n<td><code>replicated-job</code></td>\n<td>åœ¨å¤šä¸ªèŠ‚ç‚¹ä¸Š<strong>æŒ‰å‰¯æœ¬æ•°</strong>è¿è¡Œä¸€æ¬¡æ€§ä»»åŠ¡ï¼Œä»»åŠ¡å®Œæˆåå³é€€å‡ºã€‚</td>\n<td>æ•°æ®å¤„ç†ã€æ‰¹å¤„ç†ä»»åŠ¡ï¼Œå¦‚è½¬æ¢æ–‡ä»¶æˆ–è·‘ ETL</td>\n</tr>\n<tr>\n<td><code>global-job</code></td>\n<td>åœ¨<strong>æ‰€æœ‰èŠ‚ç‚¹ä¸Šå„è¿è¡Œä¸€æ¬¡</strong>çš„çŸ­æš‚ä»»åŠ¡ï¼Œæ‰§è¡Œå®Œæ¯•å³é€€å‡ºã€‚</td>\n<td>åˆå§‹åŒ–è„šæœ¬ã€æ¯å°æœºå™¨ä¸Šè¿è¡Œä¸€æ¬¡çš„æ•°æ®æ¸…æ´—ã€åˆå§‹åŒ–ç¯å¢ƒä»»åŠ¡ç­‰</td>\n</tr>\n</tbody>\n</table>\n<blockquote>\n<p>job æ¨¡å¼é€šå¸¸é…åˆé•œåƒä¸­è®¾å®šçš„å…¥å£å‘½ä»¤ä½¿ç”¨ï¼Œä¸é€‚ç”¨äºé•¿æœŸè¿è¡Œçš„æœåŠ¡ã€‚<br>\nreplicated å’Œ global æ¨¡å¼é€‚ç”¨äºæŒç»­è¿è¡Œçš„æœåŠ¡ï¼ŒSwarm ä¼šè‡ªåŠ¨é‡å¯å¤±è´¥çš„ä»»åŠ¡ã€‚</p>\n</blockquote>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æœåŠ¡é‡å¯ç­–ç•¥ï¼ˆâ€“restart-conditionï¼‰è¯¦è§£</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>å€¼</th>\n<th>å«ä¹‰è¯´æ˜</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>none</code></td>\n<td>ä¸é‡å¯ä»»åŠ¡ã€‚å³ä½¿ä»»åŠ¡å¤±è´¥ï¼Œä¹Ÿä¸ä¼šå°è¯•æ¢å¤ã€‚é€‚ç”¨äºçŸ­ç”Ÿå‘½å‘¨æœŸçš„ä»»åŠ¡æˆ–æµ‹è¯•æœåŠ¡ã€‚</td>\n</tr>\n<tr>\n<td><code>on-failure</code></td>\n<td><strong>ä»…åœ¨ä»»åŠ¡å¼‚å¸¸å¤±è´¥æ—¶</strong>ï¼ˆexit code é 0ï¼‰è‡ªåŠ¨é‡å¯ã€‚å¸¸ç”¨äºå¯èƒ½å¶å‘å¤±è´¥çš„æœåŠ¡ã€‚</td>\n</tr>\n<tr>\n<td><code>any</code>ï¼ˆé»˜è®¤ï¼‰</td>\n<td><strong>æ— è®ºä»»åŠ¡å¦‚ä½•é€€å‡º</strong>ï¼ˆåŒ…æ‹¬æ­£å¸¸é€€å‡ºæˆ–å¤±è´¥ï¼‰ï¼Œéƒ½ä¼šå°è¯•é‡å¯ã€‚é€‚ç”¨äºæŒç»­è¿è¡ŒæœåŠ¡ã€‚</td>\n</tr>\n</tbody>\n</table>\n<blockquote>\n<p>æƒ…æ™¯æ€»ç»“</p>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th>æƒ…æ™¯</th>\n<th><code>none</code></th>\n<th><code>on-failure</code></th>\n<th><code>any</code></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>æœåŠ¡è¿è¡Œæ—¶å´©æºƒï¼ˆexit code â‰  0ï¼‰</td>\n<td>âŒ ä¸é‡å¯</td>\n<td>âœ… è‡ªåŠ¨é‡å¯</td>\n<td>âœ… è‡ªåŠ¨é‡å¯</td>\n</tr>\n<tr>\n<td>æœåŠ¡æ­£å¸¸ç»“æŸï¼ˆexit code = 0ï¼‰</td>\n<td>âŒ ä¸é‡å¯</td>\n<td>âŒ ä¸é‡å¯</td>\n<td>âœ… è‡ªåŠ¨é‡å¯</td>\n</tr>\n<tr>\n<td>æŒç»­è¿è¡Œå‹æœåŠ¡ï¼ˆå¦‚ nginxï¼‰</td>\n<td>âŒ ä¸æ¨è</td>\n<td>å¯ç”¨</td>\n<td>âœ… æ¨è</td>\n</tr>\n<tr>\n<td>ä¸€æ¬¡æ€§ä»»åŠ¡ï¼ˆå¦‚æ‰¹å¤„ç†ã€æ•°æ®åˆå§‹åŒ–ï¼‰</td>\n<td>âœ… æ¨è</td>\n<td>å¯ç”¨</td>\n<td>âŒ ä¸æ¨è</td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"docker-service-create-ä½¿ç”¨ç¤ºä¾‹\"><code>docker service create</code> ä½¿ç”¨ç¤ºä¾‹</h4>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åˆ›å»ºä¸€ä¸ªåä¸º my-nginx çš„æœåŠ¡ï¼Œå¹¶æŒ‡å®š 3 ä¸ªå‰¯æœ¬ï¼Œå°† 80 ç«¯å£æ˜ å°„åˆ°ä¸»æœºçš„ 80 ç«¯å£ï¼Œå¹¶ä½¿ç”¨ nginx é•œåƒ</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># æ­¤æ—¶åœ¨æµè§ˆå™¨ä¸­è¾“å…¥Swarmä¸­ä»»æ„èŠ‚ç‚¹çš„IPåœ°å€ï¼Œå³å¯è®¿é—®åˆ°NginxæœåŠ¡ï¼Œå³ä½¿ä»»åŠ¡æ²¡æœ‰è¢«åˆ†é…åˆ°è¿™ä¸ªèŠ‚ç‚¹ï¼Œä¹Ÿèƒ½è®¿é—®åˆ°NginxæœåŠ¡ï¼Œè¿™å°±æ˜¯Swarmçš„è´Ÿè½½å‡è¡¡åŠŸèƒ½</span></span><br><span class=\"line\">docker service create \\</span><br><span class=\"line\">  --name my-nginx \\</span><br><span class=\"line\">  --replicas 3 \\</span><br><span class=\"line\">  --publish 80:80 \\</span><br><span class=\"line\">  nginx</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åˆ›å»ºä¸€ä¸ªåä¸º log-agent çš„å…¨å±€æœåŠ¡ï¼Œå¹¶ä½¿ç”¨ fluentd é•œåƒï¼Œå³æ¯ä¸ªèŠ‚ç‚¹éƒ½ä¼šè¿è¡Œä¸€ä¸ª fluentd å®¹å™¨</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># global</span></span><br><span class=\"line\">docker service create --name log-agent --mode global fluentd</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åˆ›å»ºä¸€ä¸ªåç§°ä¸º web-app çš„æœåŠ¡ï¼Œå¹¶è®¾ç½®ç¯å¢ƒå˜é‡ NODE_ENV=production ï¼ŒæŒ‚è½½ /data ç›®å½•åˆ°å®¹å™¨çš„ /app/data ç›®å½•ï¼Œå¹¶è®¾ç½® 2 ä¸ªå‰¯æœ¬ï¼Œå¹¶ä¸”æŒ‡å®šå¯åŠ¨å®¹å™¨çš„å‘½ä»¤ä¸º node server.js</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker service create \\</span><br><span class=\"line\">  --name web-app \\</span><br><span class=\"line\">  --<span class=\"built_in\">env</span> NODE_ENV=production \\</span><br><span class=\"line\">  --mount <span class=\"built_in\">type</span>=<span class=\"built_in\">bind</span>,src=/data,target=/app/data \\</span><br><span class=\"line\">  --replicas 2 \\</span><br><span class=\"line\">  node:18 node server.js</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åˆ›å»ºä¸€ä¸ªåç§°ä¸º db çš„æœåŠ¡ï¼Œå¹¶æŒ‡å®šè¿è¡Œåœ¨å…·æœ‰ role=db æ ‡ç­¾çš„èŠ‚ç‚¹ä¸Šï¼Œå¹¶ä¸”ä½¿ç”¨åä¸º db-data çš„å·æŒ‚è½½æ•°æ®</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># åˆ›å»ºæ•°æ®å·</span></span><br><span class=\"line\">docker volume create db-data</span><br><span class=\"line\"><span class=\"comment\"># åˆ›å»ºæœåŠ¡</span></span><br><span class=\"line\">docker service create \\</span><br><span class=\"line\">  --name db \\</span><br><span class=\"line\">  --constraint <span class=\"string\">&#x27;node.labels.role == db&#x27;</span> \\</span><br><span class=\"line\">  --mount <span class=\"built_in\">type</span>=volume,<span class=\"built_in\">source</span>=db-data,target=/var/lib/mysql \\</span><br><span class=\"line\">  mysql:8</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ä½¿ç”¨ on-failure ç­–ç•¥ï¼Œä»…åœ¨å¤±è´¥æ—¶è‡ªåŠ¨é‡å¯</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker service create \\</span><br><span class=\"line\">  --name unstable-worker \\</span><br><span class=\"line\">  --restart-condition on-failure \\</span><br><span class=\"line\">  my-worker-image</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æŒ‡å®šç½‘ç»œï¼Œç½‘ç»œé©±åŠ¨ç±»å‹ä¸º overlay</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># å…ˆåœ¨managerèŠ‚ç‚¹ä¸Šåˆ›å»ºä¸€ä¸ª overlay ç½‘ç»œï¼ˆé€‚ç”¨äº Swarm æ¨¡å¼ï¼‰</span></span><br><span class=\"line\">docker network create --driver overlay my-overlay-net</span><br><span class=\"line\"><span class=\"comment\"># åˆ›å»ºé©±åŠ¨ç±»å‹ä¸º overlay çš„ç½‘ç»œï¼Œä¼šç«‹å³åŒæ­¥æ‰€æœ‰ manager èŠ‚ç‚¹ï¼Œä½†ä¸ä¼šåŒæ­¥åˆ° worker èŠ‚ç‚¹ï¼Œåªæœ‰å½“ä»»åŠ¡è¢«åˆ†é…åˆ° worker èŠ‚ç‚¹æ—¶ï¼Œè¯¥ç½‘ç»œæ‰ä¼šåŒæ­¥åˆ° worker èŠ‚ç‚¹</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># åˆ›å»ºæœåŠ¡å¹¶åŠ å…¥è¯¥ç½‘ç»œ</span></span><br><span class=\"line\">docker service create \\</span><br><span class=\"line\">  --name web-service \\</span><br><span class=\"line\">  --network my-overlay-net \\</span><br><span class=\"line\">  --replicas 5 \\</span><br><span class=\"line\">  nginx</span><br><span class=\"line\">  <span class=\"comment\"># --network: æŒ‡å®šæœåŠ¡è¿è¡Œæ—¶è¿æ¥åˆ°è¯¥ç½‘ç»œï¼Œè¿™æ ·åœ¨åŒä¸€ä¸ªç½‘ç»œä¸­çš„æœåŠ¡ä¹‹é—´å¯ä»¥ä½¿ç”¨ æœåŠ¡åäº’ç›¸è®¿é—®ï¼Œå®ç°æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡ã€‚</span></span><br></pre></td></tr></table></figure>\n<div class=\"tips\">\n<p><em><strong>å°è´´å£«</strong></em></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker network <span class=\"built_in\">ls</span></span><br><span class=\"line\">NETWORK ID     NAME              DRIVER    SCOPE</span><br><span class=\"line\">6b7aadbbd180   bridge            bridge    <span class=\"built_in\">local</span></span><br><span class=\"line\">5ddadf5d0608   docker_gwbridge   bridge    <span class=\"built_in\">local</span></span><br><span class=\"line\">21c6f5b1bedd   host              host      <span class=\"built_in\">local</span></span><br><span class=\"line\">idx465x3jg68   ingress           overlay   swarm</span><br><span class=\"line\">a770c5ad4b13   none              null      <span class=\"built_in\">local</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">åˆå§‹åŒ–Swarmé›†ç¾¤åï¼Œä¼šåˆ›å»ºä¸€ä¸ªé»˜è®¤çš„ overlay ç½‘ç»œ: ingressï¼Œå¦‚æœæˆ‘ä»¬åˆ›å»ºæœåŠ¡æ—¶æ²¡æœ‰æŒ‡å®šç½‘ç»œï¼Œé‚£ä¹ˆæœåŠ¡å°±ä¼šåŠ å…¥ ingress ç½‘ç»œã€‚</li>\n<li class=\"lvl-2\">ä½†æ˜¯è¿™ä¸ªé»˜è®¤çš„ ingress ç½‘ç»œå¹¶ä¸èƒ½ç”¨äºæœåŠ¡ä¹‹é—´é€šè¿‡æœåŠ¡åç§°äº’ç›¸è®¿é—®ï¼Œä½†å¯ä»¥é€šè¿‡IPæˆ–Hostnameè®¿é—®æœåŠ¡ã€‚</li>\n<li class=\"lvl-2\">é»˜è®¤çš„ ingress ç½‘ç»œä»…ç”¨äº ingress è´Ÿè½½å‡è¡¡ï¼ˆå³ -p ç«¯å£æ˜ å°„ï¼‰ï¼Œä¸æ”¯æŒæœåŠ¡å†…éƒ¨é€šä¿¡æˆ– DNS æœåŠ¡å‘ç°ã€‚</li>\n<li class=\"lvl-2\">å¦å¤–ï¼Œåˆå§‹åŒ–Swarmé›†ç¾¤åï¼Œè¿˜ä¼šåˆ›å»ºä¸€ä¸ªé»˜è®¤çš„ bridge ç½‘ç»œ: docker_gwbridgeï¼Œè´Ÿè´£è¿æ¥ Swarm é›†ç¾¤çš„ Overlay ç½‘ç»œä¸å®¿ä¸»æœºç½‘ç»œï¼Œè´Ÿè´£è·¨èŠ‚ç‚¹çš„æµé‡è½¬å‘\n<ul class=\"lvl-3\">\n<li class=\"lvl-4\">å½“ä¸€ä¸ªå®¹å™¨åœ¨ Overlay ç½‘ç»œé‡Œè®¿é—®å¤–éƒ¨ IPï¼Œæ¯”å¦‚è®¿é—®å…¬ç½‘ï¼Œæµé‡æœ€ç»ˆé€šè¿‡ docker_gwbridge ç½‘ç»œå‡ºå£å‡ºå»ã€‚</li>\n<li class=\"lvl-4\">èŠ‚ç‚¹é—´ VXLAN éš§é“çš„æµé‡ä¹Ÿä¼šå€ŸåŠ©æ­¤ç½‘ç»œæ¡¥æ¥åˆ°å®¿ä¸»æœºçš„ç‰©ç†ç½‘ç»œæ¥å£ã€‚</li>\n</ul>\n</li>\n</ul>\n</div>\n<h3 id=\"docker-service-ls-åˆ—å‡ºæ‰€æœ‰æœåŠ¡\"><code>docker service ls</code>: åˆ—å‡ºæ‰€æœ‰æœåŠ¡</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker service <span class=\"built_in\">ls</span></span><br><span class=\"line\">ID             NAME       MODE         REPLICAS   IMAGE          PORTS</span><br><span class=\"line\">dmnztimv3pb8   my-nginx   replicated   2/2        nginx:latest   *:80-&gt;80/tcp</span><br></pre></td></tr></table></figure>\n<h3 id=\"docker-service-inspect-æŸ¥çœ‹æœåŠ¡è¯¦æƒ…\"><code>docker service inspect</code>: æŸ¥çœ‹æœåŠ¡è¯¦æƒ…</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker service inspect my-nginx</span><br></pre></td></tr></table></figure>\n<h3 id=\"docker-service-log-æŸ¥çœ‹æœåŠ¡æ—¥å¿—\"><code>docker service log</code>: æŸ¥çœ‹æœåŠ¡æ—¥å¿—</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹æŒ‡å®šæœåŠ¡ä¸‹æ‰€æœ‰ä»»åŠ¡çš„æ—¥å¿—</span></span><br><span class=\"line\">docker service logs my-nginx</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹æŒ‡å®šä»»åŠ¡çš„æ—¥å¿—ï¼ŒæŒ‡å®šä»»åŠ¡IDï¼Œä¸æ”¯æŒä»»åŠ¡åç§°</span></span><br><span class=\"line\">docker service logs p4tats0f9npk</span><br><span class=\"line\"><span class=\"comment\"># æ»šåŠ¨æŸ¥çœ‹æ—¥å¿—</span></span><br><span class=\"line\">docker service logs -f my-nginx</span><br></pre></td></tr></table></figure>\n<h3 id=\"docker-service-ps-åˆ—å‡ºæœåŠ¡ä»»åŠ¡\"><code>docker service ps</code>: åˆ—å‡ºæœåŠ¡ä»»åŠ¡</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker service ps my-nginx</span><br><span class=\"line\">ID             NAME         IMAGE          NODE       DESIRED STATE   CURRENT STATE            ERROR     PORTS</span><br><span class=\"line\">p4tats0f9npk   my-nginx.1   nginx:latest   manager1   Running         Running 13 minutes ago</span><br><span class=\"line\">v7z383xy7dso   my-nginx.2   nginx:latest   manager2   Running         Running 15 minutes ago</span><br></pre></td></tr></table></figure>\n<h3 id=\"docker-service-scale-æ‰©å®¹-ç¼©å®¹æœåŠ¡\"><code>docker service scale</code>: æ‰©å®¹/ç¼©å®¹æœåŠ¡</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># å¯åŠ¨ä¸€ä¸ªæœåŠ¡</span></span><br><span class=\"line\">docker service create \\</span><br><span class=\"line\">  --name my-nginx \\</span><br><span class=\"line\">  --replicas 3 \\</span><br><span class=\"line\">  --publish 80:80 \\</span><br><span class=\"line\">  nginx</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹æœåŠ¡ä»»åŠ¡</span></span><br><span class=\"line\">docker service ps my-nginx</span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡º</span></span><br><span class=\"line\">ID             NAME         IMAGE          NODE       DESIRED STATE   CURRENT STATE            ERROR     PORTS</span><br><span class=\"line\">p4tats0f9npk   my-nginx.1   nginx:latest   manager1   Running         Running 14 seconds ago</span><br><span class=\"line\">v7z383xy7dso   my-nginx.2   nginx:latest   manager2   Running         Running 2 minutes ago</span><br><span class=\"line\">w0sm5ixvi6eb   my-nginx.3   nginx:latest   worker2    Running         Running 4 seconds ago</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æ‰©å®¹åˆ°5ä¸ªä»»åŠ¡</span></span><br><span class=\"line\">docker service scale my-nginx=5</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹æœåŠ¡ä»»åŠ¡</span></span><br><span class=\"line\">docker service ps my-nginx</span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡º</span></span><br><span class=\"line\">ID             NAME         IMAGE          NODE       DESIRED STATE   CURRENT STATE                    ERROR     PORTS</span><br><span class=\"line\">p4tats0f9npk   my-nginx.1   nginx:latest   manager1   Running         Running about a minute ago</span><br><span class=\"line\">v7z383xy7dso   my-nginx.2   nginx:latest   manager2   Running         Running 3 minutes ago</span><br><span class=\"line\">w0sm5ixvi6eb   my-nginx.3   nginx:latest   worker2    Running         Running about a minute ago</span><br><span class=\"line\">ksbeflwg3mcj   my-nginx.4   nginx:latest   worker1    Running         Running less than a second ago</span><br><span class=\"line\">iw4zlm56n1x8   my-nginx.5   nginx:latest   manager3   Running         Running less than a second ago</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ç¼©å®¹åˆ°2ä¸ªäººä»»åŠ¡</span></span><br><span class=\"line\">docker service scale my-nginx=2</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹æœåŠ¡ä»»åŠ¡</span></span><br><span class=\"line\">docker service ps my-nginx</span><br><span class=\"line\">ID             NAME         IMAGE          NODE       DESIRED STATE   CURRENT STATE           ERROR     PORTS</span><br><span class=\"line\">p4tats0f9npk   my-nginx.1   nginx:latest   manager1   Running         Running 2 minutes ago</span><br><span class=\"line\">v7z383xy7dso   my-nginx.2   nginx:latest   manager2   Running         Running 4 minutes ago</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># è¿˜å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤è¿›è¡Œæ‰©ç¼©å®¹</span></span><br><span class=\"line\">docker service update --replicas=5 my-nginx</span><br></pre></td></tr></table></figure>\n<h3 id=\"docker-service-update-æ›´æ–°æœåŠ¡\"><code>docker service update</code>: æ›´æ–°æœåŠ¡</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æ”¯æŒçš„å‚æ•°</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>å‚æ•°</th>\n<th>è¯´æ˜</th>\n<th>ç¤ºä¾‹</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>--image</code></td>\n<td>æ›´æ–°æœåŠ¡ä½¿ç”¨çš„é•œåƒ</td>\n<td><code>--image nginx:1.25</code></td>\n</tr>\n<tr>\n<td><code>--replicas</code></td>\n<td>è®¾ç½®æœåŠ¡çš„å‰¯æœ¬æ•°é‡ï¼ˆä»…é€‚ç”¨äº replicated æ¨¡å¼ï¼‰</td>\n<td><code>--replicas 5</code></td>\n</tr>\n<tr>\n<td><code>--env-add</code></td>\n<td>æ·»åŠ ç¯å¢ƒå˜é‡</td>\n<td><code>--env-add DEBUG=true</code></td>\n</tr>\n<tr>\n<td><code>--env-rm</code></td>\n<td>ç§»é™¤ç¯å¢ƒå˜é‡</td>\n<td><code>--env-rm OLD_VAR</code></td>\n</tr>\n<tr>\n<td><code>--publish-add</code></td>\n<td>æ·»åŠ ç«¯å£æ˜ å°„</td>\n<td><code>--publish-add published=8080,target=80</code></td>\n</tr>\n<tr>\n<td><code>--publish-rm</code></td>\n<td>ç§»é™¤ç«¯å£æ˜ å°„</td>\n<td><code>--publish-rm 80</code></td>\n</tr>\n<tr>\n<td><code>--mount-add</code></td>\n<td>æ·»åŠ æŒ‚è½½</td>\n<td><code>--mount-add type=bind,src=/data,dst=/data</code></td>\n</tr>\n<tr>\n<td><code>--mount-rm</code></td>\n<td>ç§»é™¤æŒ‚è½½</td>\n<td><code>--mount-rm /data</code></td>\n</tr>\n<tr>\n<td><code>--constraint-add</code></td>\n<td>æ·»åŠ éƒ¨ç½²çº¦æŸ</td>\n<td><code>--constraint-add 'node.labels.zone==east'</code></td>\n</tr>\n<tr>\n<td><code>--constraint-rm</code></td>\n<td>ç§»é™¤éƒ¨ç½²çº¦æŸ</td>\n<td><code>--constraint-rm 'node.labels.zone==east'</code></td>\n</tr>\n<tr>\n<td><code>--limit-cpu</code></td>\n<td>è®¾ç½® CPU é™åˆ¶</td>\n<td><code>--limit-cpu 0.5</code></td>\n</tr>\n<tr>\n<td><code>--limit-memory</code></td>\n<td>è®¾ç½®å†…å­˜é™åˆ¶</td>\n<td><code>--limit-memory 256M</code></td>\n</tr>\n<tr>\n<td><code>--restart-condition</code></td>\n<td>è®¾ç½®é‡å¯ç­–ç•¥ï¼ˆnoneã€on-failureã€anyï¼‰</td>\n<td><code>--restart-condition on-failure</code></td>\n</tr>\n<tr>\n<td><code>--update-delay</code></td>\n<td>è®¾ç½®ä»»åŠ¡æ›´æ–°ä¹‹é—´çš„å»¶è¿Ÿ</td>\n<td><code>--update-delay 10s</code></td>\n</tr>\n<tr>\n<td><code>--update-parallelism</code></td>\n<td>è®¾ç½®å¹¶å‘æ›´æ–°ä»»åŠ¡çš„æ•°é‡</td>\n<td><code>--update-parallelism 2</code></td>\n</tr>\n<tr>\n<td><code>--update-order</code></td>\n<td>è®¾ç½®æ›´æ–°é¡ºåºï¼ˆstart-first æˆ– stop-firstï¼‰</td>\n<td><code>--update-order start-first</code></td>\n</tr>\n<tr>\n<td><code>--update-failure-action</code></td>\n<td>æ›´æ–°å¤±è´¥åçš„åŠ¨ä½œï¼ˆpauseã€continueã€rollbackï¼‰</td>\n<td><code>--update-failure-action rollback</code></td>\n</tr>\n<tr>\n<td><code>--rollback</code></td>\n<td>å›æ»šåˆ°ä¸Šä¸€æ¬¡æˆåŠŸé…ç½®</td>\n<td><code>--rollback</code></td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ç¤ºä¾‹</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker service update \\</span><br><span class=\"line\">  --image nginx:1.25 \\</span><br><span class=\"line\">  --replicas 4 \\</span><br><span class=\"line\">  --env-add ENV=prod \\</span><br><span class=\"line\">  --limit-memory 512M \\</span><br><span class=\"line\">  --limit-cpu 1.0 \\</span><br><span class=\"line\">  --update-delay 10s \\</span><br><span class=\"line\">  --update-parallelism 2 \\</span><br><span class=\"line\">  --update-failure-action rollback \\</span><br><span class=\"line\">  my-nginx</span><br></pre></td></tr></table></figure>\n<h3 id=\"docker-service-rollback-å›æ»šæœåŠ¡\"><code>docker service rollback</code>: å›æ»šæœåŠ¡</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ä¼šå°†æœåŠ¡å›æ»šåˆ°ä¸Šä¸€æ¬¡æˆåŠŸéƒ¨ç½²çš„ç‰ˆæœ¬ï¼ŒåŒ…æ‹¬é•œåƒã€ç¯å¢ƒå˜é‡ã€éƒ¨ç½²çº¦æŸç­‰ã€‚</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># docker service rollback &lt;service_name&gt;</span></span><br><span class=\"line\">docker service rollback my-nginx</span><br></pre></td></tr></table></figure>\n<h3 id=\"docker-service-rm-åˆ é™¤æœåŠ¡\"><code>docker service rm</code>: åˆ é™¤æœåŠ¡</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åˆ é™¤æœåŠ¡ä¼šåœæ­¢æœåŠ¡å¹¶åˆ é™¤æœåŠ¡ã€‚</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># docker service rm &lt;service_name&gt;</span></span><br><span class=\"line\">docker service <span class=\"built_in\">rm</span> my-nginx</span><br></pre></td></tr></table></figure>\n<h2 id=\"ç»éªŒæŠ€å·§\">ç»éªŒæŠ€å·§</h2>\n<h3 id=\"å¦‚ä½•è®©ä»»åŠ¡è¿è¡Œåœ¨æŒ‡å®šçš„èŠ‚ç‚¹ä¸Šï¼Ÿ\">å¦‚ä½•è®©ä»»åŠ¡è¿è¡Œåœ¨æŒ‡å®šçš„èŠ‚ç‚¹ä¸Šï¼Ÿ</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åˆ›å»ºæœåŠ¡æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ <code>--constraint</code> å‚æ•°æŒ‡å®šèŠ‚ç‚¹çš„æ ‡ç­¾ï¼Œä½¿å…¶è¿è¡Œåœ¨å…·æœ‰æŒ‡å®šæ ‡ç­¾çš„èŠ‚ç‚¹ä¸Šã€‚</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ç»™ç»“ç‚¹åŠ æ ‡ç­¾</span></span><br><span class=\"line\">docker node update --label-add <span class=\"built_in\">env</span>=prod worker1</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># node.labels æ˜¯Swarmå†…ç½®å±æ€§ï¼Œè¡¨ç¤ºèŠ‚ç‚¹çš„æ ‡ç­¾ï¼Œè¿™é‡ŒæŒ‡å®šèŠ‚ç‚¹æ ‡ç­¾ä¸º env=prod</span></span><br><span class=\"line\">docker service create \\</span><br><span class=\"line\">--name my-nginx \\</span><br><span class=\"line\">--replicas 2 \\</span><br><span class=\"line\">--constraint <span class=\"string\">&#x27;node.labels.env == prod&#x27;</span> \\</span><br><span class=\"line\">nginx:latest</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># è¿™é‡Œè¦æ³¨æ„ï¼Œè¿è¡Œä»»åŠ¡åå¦‚æœä¿®æ”¹äº†nodeçš„æ ‡ç­¾ï¼Œé‚£ä¹ˆä»»åŠ¡å°±ä¼šé‡æ–°åˆ†é…ï¼Œåˆ†é…æ˜¯å¦‚æœæ‰¾ä¸åˆ°ç¬¦åˆæ ‡ç­¾çš„èŠ‚ç‚¹ï¼Œå°±ä¼šè¿è¡Œå¤±è´¥ã€‚</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åªèƒ½è¿è¡Œåœ¨ç®¡ç†èŠ‚ç‚¹ä¸Š</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># node.role æ˜¯ Swarm çš„å†…ç½®å±æ€§ï¼Œè¡¨ç¤ºèŠ‚ç‚¹çš„ç±»å‹ï¼Œå€¼ä¸º manager æˆ– workerã€‚</span></span><br><span class=\"line\">docker service create \\</span><br><span class=\"line\">  --name manager-only-service \\</span><br><span class=\"line\">  --constraint <span class=\"string\">&#x27;node.role == manager&#x27;</span> \\</span><br><span class=\"line\">  nginx</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Swarm å†…ç½®å±æ€§</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>å±æ€§å</th>\n<th>ç¤ºä¾‹å€¼</th>\n<th>è¯´æ˜</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>node.id</code></td>\n<td><code>node.id == abcd1234</code></td>\n<td>èŠ‚ç‚¹çš„å”¯ä¸€ IDï¼ˆå¯ç”¨ <code>docker node ls</code> æŸ¥çœ‹ï¼‰</td>\n</tr>\n<tr>\n<td><code>node.hostname</code></td>\n<td><code>node.hostname == manager-1</code></td>\n<td>èŠ‚ç‚¹ä¸»æœºå</td>\n</tr>\n<tr>\n<td><code>node.role</code></td>\n<td><code>node.role == manager</code> æˆ– <code>node.role == worker</code></td>\n<td>èŠ‚ç‚¹åœ¨ Swarm ä¸­çš„è§’è‰²ï¼ˆç®¡ç†/å·¥ä½œï¼‰</td>\n</tr>\n<tr>\n<td><code>engine.labels.*</code></td>\n<td><code>engine.labels.disk == ssd</code></td>\n<td>Docker å¼•æ“çº§åˆ«çš„æ ‡ç­¾ï¼ˆéœ€æ‰‹åŠ¨è®¾ç½®ï¼‰</td>\n</tr>\n<tr>\n<td><code>node.platform.os</code></td>\n<td><code>node.platform.os == linux</code></td>\n<td>èŠ‚ç‚¹æ“ä½œç³»ç»Ÿç±»å‹</td>\n</tr>\n<tr>\n<td><code>node.platform.arch</code></td>\n<td><code>node.platform.arch == x86_64</code></td>\n<td>èŠ‚ç‚¹æ¶æ„ç±»å‹ï¼ˆå¦‚ <code>arm64</code>, <code>x86_64</code>ï¼‰</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"å¦‚ä½•è®¿é—®ServiceæœåŠ¡ï¼Ÿ\">å¦‚ä½•è®¿é—®ServiceæœåŠ¡ï¼Ÿ</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># å¯åŠ¨ä¸€ä¸ªserviceï¼Œ3ä¸ªå‰¯æœ¬ï¼Œé•œåƒä¸º whoamiï¼Œè¿™ä¸ªé•œåƒä¼šè¿”å›å½“å‰è®¿é—®çš„å®¹å™¨çš„IDï¼Œå³è¿”å›çš„Hostname</span></span><br><span class=\"line\">docker service create --name <span class=\"built_in\">whoami</span> \\</span><br><span class=\"line\">  --replicas 3 \\</span><br><span class=\"line\">  -p 80:80 \\</span><br><span class=\"line\">  traefik/whoami</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹serviceæœåŠ¡è¿è¡Œåœ¨å“ªäº›èŠ‚ç‚¹ä¸Šï¼Œçœ‹åˆ°è¿™é‡Œåªæœ‰ manager1\\manager2\\worker2 èŠ‚ç‚¹ä¸Šè¿è¡Œï¼Œæ³¨æ„è¿™é‡Œçœ‹åˆ°çš„IDæ˜¯Task IDï¼Œå¹¶éå®¹å™¨ID</span></span><br><span class=\"line\">docker service ps <span class=\"built_in\">whoami</span></span><br><span class=\"line\">ID             NAME       IMAGE                   NODE       DESIRED STATE   CURRENT STATE            ERROR     PORTS</span><br><span class=\"line\">u1elzp22hyvm   whoami.1   traefik/whoami:latest   manager2   Running         Running 2 minutes ago</span><br><span class=\"line\">4cent1kfgghb   whoami.2   traefik/whoami:latest   worker2    Running         Running 17 seconds ago</span><br><span class=\"line\">lu6u6j8ji0uq   whoami.3   traefik/whoami:latest   manager1   Running         Running 40 seconds ago</span><br><span class=\"line\"><span class=\"comment\"># å¦‚æœå¸Œæœ›æŸ¥è¯¢æŸä¸ªServiceçš„æ‰€æœ‰å®¹å™¨çš„IDï¼Œå¯ä»¥æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤</span></span><br><span class=\"line\">docker service ps <span class=\"built_in\">whoami</span> -q | xargs docker inspect --format <span class=\"string\">&#x27;&#123;&#123;.Status.ContainerStatus.ContainerID&#125;&#125;&#x27;</span> | <span class=\"built_in\">cut</span> -c 1-12</span><br><span class=\"line\">a3fb63bde8e7</span><br><span class=\"line\">a14e30a02987</span><br><span class=\"line\">549610f3a1e9</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æ­¤æ—¶æˆ‘ä»¬é€šè¿‡curlè®¿é—® Swarm é›†ç¾¤ä¸­çš„ä»»æ„ä¸€ä¸ªèŠ‚ç‚¹çš„IPï¼Œéƒ½å¯ä»¥è®¿é—®åˆ°è¿™ä¸ªæœåŠ¡ï¼Œæ¯”å¦‚ <code>curl 10.211.55.12</code>ï¼Œè¿™æ˜¯ manager3 èŠ‚ç‚¹çš„ IP åœ°å€ï¼Œè™½ç„¶è¿™ä¸ªæœåŠ¡å¹¶æ²¡æœ‰åœ¨ manager3 èŠ‚ç‚¹ä¸Šè¿è¡Œï¼Œä½†æ˜¯æˆ‘ä»¬ä¾æ—§å¯ä»¥è®¿é—®åˆ°è¿™ä¸ªæœåŠ¡ï¼Œä¸ä»…å¦‚æ­¤ï¼Œæ¯æ¬¡è¿è¡Œå‘½ä»¤è¿”å›çš„Hostname(å°±æ˜¯å®¹å™¨ID)éƒ½ä¼šå‘ç”Ÿå˜åŒ–ï¼Œå…¶æ•ˆæœå°±æ˜¯åœ¨å„ä¸ªè¿è¡Œçš„å®¹å™¨é—´è½®è¯¢ï¼Œè¿™å°±æ˜¯ Swarm é›†ç¾¤çš„è´Ÿè½½å‡è¡¡æ•ˆæœã€‚</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl http://10.211.55.12</span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡º</span></span><br><span class=\"line\">Hostname: a3fb63bde8e7   <span class=\"comment\"># å®¹å™¨ID</span></span><br><span class=\"line\">IP: 127.0.0.1</span><br><span class=\"line\">IP: ::1</span><br><span class=\"line\">IP: 10.0.0.36            <span class=\"comment\"># å®¹å™¨IPï¼Œå¯¹æ¥ br0</span></span><br><span class=\"line\">IP: 172.18.0.4           <span class=\"comment\"># å®¹å™¨IPï¼Œå¯¹æ¥ docker_gwbridge</span></span><br><span class=\"line\">RemoteAddr: 10.0.0.6:52964</span><br><span class=\"line\">GET / HTTP/1.1</span><br><span class=\"line\">Host: 10.211.55.12</span><br><span class=\"line\">User-Agent: curl/7.61.1</span><br><span class=\"line\">Accept: */*</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åœ¨é›†ç¾¤å†…éƒ¨è®¿é—®æœåŠ¡ï¼Œå»ºè®®å°†æ‰€æœ‰æœåŠ¡è¿è¡Œåœ¨ç›¸åŒçš„networkä¸­ï¼Œè¿™æ ·å¯ä»¥ä¸åŒçš„serviceä¹‹é—´å¯ä»¥é€šè¿‡æœåŠ¡åç§°è®¿é—®æœåŠ¡ï¼Œåœ¨é›†ç¾¤å¤–éƒ¨ï¼Œå¯ä»¥é€šè¿‡nginxç­‰ä»£ç†è®¿é—®æœåŠ¡ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>å¯ä»¥ç¼–å†™ä¸€ä¸ªè„šæœ¬æ–¹ä¾¿æŸ¥çœ‹serviceä¸containerçš„è¿è¡Œå…³ç³»ï¼Œæ¯”å¦‚ï¼šdocker_service_container</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"><span class=\"comment\"># filename: docker_service_container</span></span><br><span class=\"line\"><span class=\"comment\"># ç”¨æ³•æç¤º</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> [ -z <span class=\"string\">&quot;<span class=\"variable\">$1</span>&quot;</span> ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">&quot;ç”¨æ³•: <span class=\"variable\">$0</span> &lt;SERVICE_NAME&gt;&quot;</span></span><br><span class=\"line\">  <span class=\"built_in\">exit</span> 1</span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\"><span class=\"comment\"># serviceåç§°</span></span><br><span class=\"line\">SERVCIE_NAME=<span class=\"variable\">$1</span></span><br><span class=\"line\"><span class=\"comment\"># æ‰€å±network,é»˜è®¤ ingressï¼Œè¿™é‡Œè¦æ³¨æ„ä¸€ä¸‹ï¼Œå¦‚æœæ˜¯è‡ªå®šä¹‰çš„overlayç½‘ç»œï¼Œåªèƒ½è·å–åˆ°å½“å‰ä¸»æœºä¸Šçš„å®¹å™¨IP</span></span><br><span class=\"line\">NETWORK=<span class=\"variable\">$2</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> [ -z <span class=\"string\">&quot;<span class=\"variable\">$2</span>&quot;</span> ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">  NETWORK=$(docker service inspect <span class=\"variable\">$SERVCIE_NAME</span> --format <span class=\"string\">&#x27;&#123;&#123;json .Endpoint.VirtualIPs&#125;&#125;&#x27;</span> | jq <span class=\"string\">&#x27;.[0].NetworkID&#x27;</span> | sed <span class=\"string\">&#x27;s/&quot;//g&#x27;</span>)</span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># NETWORK=$&#123;2:-ingress&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">d1=$(<span class=\"built_in\">echo</span> -e <span class=\"string\">&quot;SERVICE-ID TASK-ID CONTAINER-ID NODE-ID&quot;</span> | awk <span class=\"string\">&#x27;&#123;printf &quot;%-12s    %-12s    %-12s    %-12s\\n&quot;, substr($1,1,12), substr($2,1,12), substr($3,1,12), substr($4,1,12)&#125;&#x27;</span> ;\\</span><br><span class=\"line\">docker service ps <span class=\"variable\">$SERVCIE_NAME</span> --filter <span class=\"string\">&quot;desired-state=running&quot;</span> -q | xargs docker inspect --format <span class=\"string\">&#x27;&#123;&#123;.ServiceID&#125;&#125;    &#123;&#123;.ID&#125;&#125;    &#123;&#123;.Status.ContainerStatus.ContainerID&#125;&#125;    &#123;&#123;.NodeID&#125;&#125;&#x27;</span> \\</span><br><span class=\"line\">| awk <span class=\"string\">&#x27;&#123;printf &quot;%-12s    %-12s    %-12s    %-12s\\n&quot;, substr($1,1,12), substr($2,1,12), substr($3,1,12), substr($4,1,12)&#125;&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#echo &quot;$d1&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">d2=$(docker service ps <span class=\"variable\">$SERVCIE_NAME</span> --filter <span class=\"string\">&quot;desired-state=running&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#echo &quot;$d2&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">nn1=$(awk <span class=\"string\">&#x27;</span></span><br><span class=\"line\"><span class=\"string\">NR==FNR &amp;&amp; FNR &gt; 1 &#123;</span></span><br><span class=\"line\"><span class=\"string\">  id = $1</span></span><br><span class=\"line\"><span class=\"string\">  name = $2</span></span><br><span class=\"line\"><span class=\"string\">  node = $4</span></span><br><span class=\"line\"><span class=\"string\">  desired = $5</span></span><br><span class=\"line\"><span class=\"string\">  # æ‹¼æ¥ CURRENT STATEï¼ˆä»ç¬¬6åˆ—å¼€å§‹çš„æ‰€æœ‰å­—æ®µï¼‰</span></span><br><span class=\"line\"><span class=\"string\">  current = &quot;&quot;</span></span><br><span class=\"line\"><span class=\"string\">  for (i=6; i&lt;=NF; i++) &#123;</span></span><br><span class=\"line\"><span class=\"string\">    current = current $i &quot; &quot;</span></span><br><span class=\"line\"><span class=\"string\">  &#125;</span></span><br><span class=\"line\"><span class=\"string\">  gsub(/ /, &quot;-&quot;, current)</span></span><br><span class=\"line\"><span class=\"string\">  current = substr(current, 1, length(current)-1)  # å»æ‰æœ€åç©ºæ ¼</span></span><br><span class=\"line\"><span class=\"string\">  info[id] = name &quot;\\t&quot; node &quot;\\t&quot; desired &quot;\\t&quot; current</span></span><br><span class=\"line\"><span class=\"string\">  next</span></span><br><span class=\"line\"><span class=\"string\">&#125;</span></span><br><span class=\"line\"><span class=\"string\">FNR==1 &#123;</span></span><br><span class=\"line\"><span class=\"string\">  print $0 &quot;\\tTASK-NAME\\tNODE\\tDESIRED_STATE\\tCURRENT_STATE&quot;</span></span><br><span class=\"line\"><span class=\"string\">  next</span></span><br><span class=\"line\"><span class=\"string\">&#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123;</span></span><br><span class=\"line\"><span class=\"string\">  print $0 &quot;\\t&quot; info[$2]</span></span><br><span class=\"line\"><span class=\"string\">&#125;</span></span><br><span class=\"line\"><span class=\"string\">&#x27;</span> &lt;(<span class=\"built_in\">echo</span> <span class=\"string\">&quot;<span class=\"variable\">$d2</span>&quot;</span>) &lt;(<span class=\"built_in\">echo</span> <span class=\"string\">&quot;<span class=\"variable\">$d1</span>&quot;</span>) | <span class=\"built_in\">tail</span> -n +2 | column -t)</span><br><span class=\"line\"></span><br><span class=\"line\">nn2=$(<span class=\"built_in\">echo</span> <span class=\"string\">&quot;CONTAINER-ID IP&quot;</span>;docker network inspect <span class=\"variable\">$&#123;NETWORK&#125;</span> -f <span class=\"string\">&#x27;&#123;&#123;range $id, $container := .Containers&#125;&#125;&#123;&#123;slice $id 0 12&#125;&#125; &#123;&#123;$container.Name&#125;&#125; &#123;&#123;$container.IPv4Address&#125;&#125;&#123;&#123;println&#125;&#125;&#123;&#123;end&#125;&#125;&#x27;</span> | grep <span class=\"variable\">$SERVCIE_NAME</span> | awk -F <span class=\"string\">&quot; &quot;</span> <span class=\"string\">&#x27;&#123;print $1&quot; &quot;$3&#125;&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">awk <span class=\"string\">&#x27;</span></span><br><span class=\"line\"><span class=\"string\">NR==FNR &#123; ip[$1]=$2; next &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; print $0, ip[$3] &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#x27;</span> &lt;(<span class=\"built_in\">echo</span> <span class=\"string\">&quot;<span class=\"variable\">$nn2</span>&quot;</span>) &lt;(<span class=\"built_in\">echo</span> <span class=\"string\">&quot;<span class=\"variable\">$nn1</span>&quot;</span>) | column -t</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>è¿è¡Œ</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">chmod</span> +x /usr/local/bin/docker-swarm-service</span><br><span class=\"line\"><span class=\"comment\"># æ‰§è¡Œè„šæœ¬</span></span><br><span class=\"line\">docker-swarm-service <span class=\"built_in\">whoami</span></span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡º</span></span><br><span class=\"line\">SERVICE-ID    TASK-ID       CONTAINER-ID  NODE-ID       TASK-NAME  NODE      DESIRED_STATE  CURRENT_STATE              IP</span><br><span class=\"line\">snuhv0g2dm1q  czisrjrp8k2t  9e4ce349971c  kp2zerd28xgz  whoami.1   manager1  Running        Running-about-an-hour-ago  10.0.0.35/24</span><br><span class=\"line\">snuhv0g2dm1q  tvbkwmnafedw  0d586021260d  kp2zerd28xgz  whoami.2   manager1  Running        Running-about-an-hour-ago  10.0.0.36/24</span><br><span class=\"line\">snuhv0g2dm1q  815qp859a1f4  449d5e1a231d  kp2zerd28xgz  whoami.3   manager1  Running        Running-about-an-hour-ago  10.0.0.15/24</span><br></pre></td></tr></table></figure>\n","content_text":"æ‘˜è¦ æœ¬æ–‡ä»‹ç» Docker Swarm çš„ æœåŠ¡ç®¡ç† Dockerå®˜æ–¹æ–‡æ¡£ Docker Swarm å®˜æ–¹æ–‡æ¡£ Service ä¸ Task ä»€ä¹ˆæ˜¯ Serviceï¼Ÿ Service æ˜¯ç”¨æˆ·å®šä¹‰çš„æœåŠ¡æŠ½è±¡ï¼Œä¸€ä¸ª Service è¡¨ç¤ºä½ å¸Œæœ›åœ¨ Swarm é›†ç¾¤ä¸­è¿è¡Œçš„æŸä¸ªâ€œåº”ç”¨â€ã€‚ å®ƒå®šä¹‰äº†ä½ è¦è¿è¡Œçš„å®¹å™¨é•œåƒã€å¯åŠ¨å‘½ä»¤ã€å‰¯æœ¬æ•°é‡ã€ç½‘ç»œé…ç½®ã€ç¯å¢ƒå˜é‡ã€ç«¯å£æ˜ å°„ç­‰ä¿¡æ¯ã€‚ å¯ä»¥ç±»æ¯”æˆ Kubernetes ä¸­çš„ Deploymentï¼Œä»£è¡¨çš„æ˜¯â€œæœŸæœ›çŠ¶æ€â€ã€‚ ä»€ä¹ˆæ˜¯ Taskï¼Ÿ Task æ˜¯ Service çš„å®é™…æ‰§è¡Œå®ä¾‹ï¼ŒSwarm ä¼šæ ¹æ® Service çš„é…ç½®ç”Ÿæˆ Taskã€‚ Serviceä¸­çš„æ¯ä¸ªå‰¯æœ¬å¯¹åº”ä¸€ä¸ª Taskï¼Œæ¯ä¸€ä¸ª Task ä»£è¡¨ä¸€ä¸ªè¦åœ¨æŸä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œçš„å®¹å™¨ã€‚ Task çš„çŠ¶æ€ç”± Swarm ç®¡ç†ï¼Œå®ƒè´Ÿè´£å¯åŠ¨ã€è°ƒåº¦ã€é‡å¯ç­‰ç”Ÿå‘½å‘¨æœŸæ“ä½œã€‚ å½“æŸä¸ª Task å´©æºƒï¼ŒSwarm ä¼šè‡ªåŠ¨é‡æ–°è°ƒåº¦ä¸€ä¸ªæ–°çš„ Task æ¥æ›¿ä»£å®ƒã€‚ Task æ˜¯ä¸å¯å˜çš„ï¼Œä¸€æ—¦åˆ›å»ºä¸èƒ½ä¿®æ”¹ï¼Œæ›´æ–° Service ä¼šåˆ›å»ºæ–°çš„ Taskã€‚ ç¤ºä¾‹ åˆ›å»ºä¸€ä¸ªåä¸º nginx çš„ Serviceï¼Œå¹¶æŒ‡å®šé•œåƒä¸º nginx:latestï¼Œå¹¶è®¾ç½®å‰¯æœ¬æ•°ä¸º 3ã€‚ 1docker service create --name nginx --replicas 3 nginx:latest è¿™é‡Œåˆ›å»ºäº†ä¸€ä¸ªåä¸º nginx çš„ Serviceï¼Œå¹¶è®¾ç½®äº†å‰¯æœ¬æ•°ä¸º 3ï¼Œå³Swarmä¼šåˆ›å»º3ä¸ªTaskæ¥å®Œæˆè¿™ä¸ªä»»åŠ¡ï¼Œæ¯ä¸ª Task æœ€ç»ˆä¼šå¯¹åº”ä¸€ä¸ªå…·ä½“çš„nginxå®¹å™¨ã€‚ é¡¹ç›® Service Task å®šä¹‰ ç”¨æˆ·å®šä¹‰çš„æœåŠ¡é…ç½® æœåŠ¡é…ç½®ç”Ÿæˆçš„æ‰§è¡Œå•å…ƒ æ•°é‡å…³ç³» ä¸€ä¸ª Service åŒ…å«å¤šä¸ª Task ä¸€ä¸ª Task å±äºä¸€ä¸ª Service çŠ¶æ€ æè¿°â€œæœŸæœ›çŠ¶æ€â€ ä»£è¡¨â€œå®é™…çŠ¶æ€â€ ç”Ÿå‘½å‘¨æœŸ å¯ä»¥æ›´æ–° ä¸å¯å˜ï¼Œæ›´æ–°æ„å‘³ç€é‡æ–°åˆ›å»º ç®¡ç†è€… ç”±ç”¨æˆ·ç®¡ç† å®Œå…¨ç”± Swarm è°ƒåº¦å’Œç®¡ç† Service ç›¸å…³å‘½ä»¤ å‘½ä»¤ ä¸­æ–‡è¯´æ˜ create åˆ›å»ºä¸€ä¸ªæ–°çš„æœåŠ¡ inspect æ˜¾ç¤ºä¸€ä¸ªæˆ–å¤šä¸ªæœåŠ¡çš„è¯¦ç»†ä¿¡æ¯ logs è·å–æœåŠ¡æˆ–ä»»åŠ¡çš„æ—¥å¿— ls åˆ—å‡ºæ‰€æœ‰æœåŠ¡ ps åˆ—å‡ºä¸€ä¸ªæˆ–å¤šä¸ªæœåŠ¡çš„ä»»åŠ¡ï¼ˆTaskï¼‰ rm åˆ é™¤ä¸€ä¸ªæˆ–å¤šä¸ªæœåŠ¡ rollback å›æ»šæœåŠ¡çš„é…ç½®æ›´æ”¹ scale æ‰©ç¼©ä¸€ä¸ªæˆ–å¤šä¸ªå¯å¤åˆ¶æœåŠ¡çš„å‰¯æœ¬æ•°é‡ update æ›´æ–°æœåŠ¡é…ç½® docker service create: åˆ›å»ºæœåŠ¡ å¸¸ç”¨å‚æ•°è¯´æ˜ å‚æ•° è¯´æ˜ ç¤ºä¾‹å‘½ä»¤ï¼ˆå«è¯´æ˜ï¼‰ --name æŒ‡å®šæœåŠ¡åç§° docker service create --name my-web nginxâ†’ åˆ›å»ºä¸€ä¸ªåä¸º my-web çš„ nginx æœåŠ¡ --replicas è®¾ç½®å‰¯æœ¬æ•°é‡ï¼ˆä»…é€‚ç”¨äº replicated æ¨¡å¼ï¼‰ docker service create --replicas 3 nginxâ†’ å¯åŠ¨ 3 ä¸ª nginx å‰¯æœ¬ --publish æˆ– -p æ˜ å°„ç«¯å£ï¼ˆæ ¼å¼å¦‚ 80:80ï¼‰ docker service create -p 8080:80 nginxâ†’ å°†å®¹å™¨çš„ 80 ç«¯å£æ˜ å°„åˆ°ä¸»æœº 8080 --env æˆ– -e è®¾ç½®ç¯å¢ƒå˜é‡ docker service create -e ENV=prod nginxâ†’ è®¾ç½®ç¯å¢ƒå˜é‡ ENV=prod --mount è®¾ç½®æ•°æ®å·æŒ‚è½½ docker service create --mount type=bind,src=/data,target=/app nginxâ†’ å°†ä¸»æœºçš„ /data ç›®å½•æŒ‚è½½åˆ°å®¹å™¨å†… /app --constraint è®¾ç½®éƒ¨ç½²çº¦æŸï¼ˆå¦‚æŒ‡å®šèŠ‚ç‚¹ï¼‰ docker service create --constraint 'node.labels.type == web' nginxâ†’ ä»…éƒ¨ç½²åœ¨å¸¦æ ‡ç­¾ type=web çš„èŠ‚ç‚¹ä¸Š --network æŒ‡å®šæœåŠ¡æ‰€å±çš„ç½‘ç»œï¼ˆé€šå¸¸ä½¿ç”¨ overlay ç½‘ç»œï¼‰ docker service create --network my-net nginxâ†’ å°†æœåŠ¡è¿æ¥åˆ°è‡ªå®šä¹‰ç½‘ç»œ my-net --detach æˆ– -d åå°è¿è¡ŒæœåŠ¡ï¼ˆé»˜è®¤è¡Œä¸ºï¼‰ docker service create -d nginxâ†’ åå°åˆ›å»ºæœåŠ¡ï¼Œä¸é˜»å¡ç»ˆç«¯ï¼Œå› ä¸ºæ˜¯é»˜è®¤è¡Œä¸ºï¼Œæ‰€ä»¥ä¸åŠ  -d ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œserviceä¸æ”¯æŒåƒ docker run é‚£æ ·æ”¯æŒå‰å°è¿è¡Œ --limit-cpu / --limit-memory è®¾ç½®èµ„æºé™åˆ¶ docker service create --limit-cpu 0.5 --limit-memory 256M nginxâ†’ æ¯ä¸ªä»»åŠ¡æœ€å¤šä½¿ç”¨ 0.5 ä¸ª CPU å’Œ 256MB å†…å­˜ --restart-condition è®¾ç½®é‡å¯ç­–ç•¥ï¼ˆå¦‚ on-failureã€anyã€noneï¼‰ docker service create --restart-condition on-failure nginxâ†’ ä»…å½“å®¹å™¨å¤±è´¥æ—¶è‡ªåŠ¨é‡å¯ --mode æŒ‡å®šæœåŠ¡è¿è¡Œæ¨¡å¼ï¼Œæ”¯æŒï¼šreplicatedã€globalã€replicated-jobã€global-job docker service create --mode global nginxâ†’ åœ¨é›†ç¾¤æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œä¸€ä¸ª nginx å®ä¾‹ cpu ä¸ å†…å­˜é™åˆ¶ å‚æ•° æ„ä¹‰ --limit-cpu 1.0 é™åˆ¶æ¯ä¸ªå®¹å™¨æœ€å¤šä½¿ç”¨ 1 æ ¸ CPUæ—¶é—´ , 1 CPU = åœ¨æ¯ä¸ªè°ƒåº¦å‘¨æœŸä¸­å¯å æ»¡ CPU çš„å…¨éƒ¨æ—¶é—´ä»½é¢(ä¸€ä¸ªå‘¨æœŸæ—¶é—´é»˜è®¤100ms) --limit-cpu 0.5 é™åˆ¶æ¯ä¸ªå®¹å™¨æœ€å¤šä½¿ç”¨ 50% çš„å•æ ¸CPUæ—¶é—´ --limit-cpu 3.5 æ¯ä¸ªå®¹å™¨æœ€å¤šå¯ä»¥ä½¿ç”¨ 3.5 æ ¸çš„ CPU æ—¶é—´ï¼Œç”±è°ƒåº¦å™¨å†³å®šåˆ†é…ã€‚å¹¶ä¸æ˜¯é™åˆ¶æˆåªèƒ½è·‘åœ¨ä¸€ä¸ªæ ¸ä¸Šï¼Œè€Œæ˜¯é™åˆ¶â€œæ€»å…±ä½¿ç”¨ä¸è¶…è¿‡ 3.5 æ ¸çš„æ—¶é—´ç‰‡â€ã€‚ --limit-memory 512M é™åˆ¶æ¯ä¸ªå®¹å™¨æœ€å¤šä½¿ç”¨æŒ‡å®šå†…å­˜ï¼ˆå¦‚ 512Mï¼‰ æœåŠ¡è¿è¡Œæ¨¡å¼ï¼ˆâ€“modeï¼‰è¯¦è§£ æ¨¡å¼åç§° è¯´æ˜ ä½¿ç”¨åœºæ™¯ç¤ºä¾‹ replicated é»˜è®¤æ¨¡å¼ã€‚ç”¨æˆ·æŒ‡å®šéœ€è¦è¿è¡Œå¤šå°‘ä¸ªå‰¯æœ¬ï¼ŒSwarm åœ¨åˆé€‚çš„èŠ‚ç‚¹ä¸Šè°ƒåº¦è¿™äº›å‰¯æœ¬ã€‚ å…¸å‹çš„ Web æœåŠ¡ï¼Œå¦‚ nginxã€Node.jsã€Java åº”ç”¨ç­‰ global æ¯ä¸ªå¯ç”¨èŠ‚ç‚¹åªéƒ¨ç½²ä¸€ä¸ªä»»åŠ¡å®ä¾‹ï¼Œä¸éœ€è¦ç”¨æˆ·æŒ‡å®šå‰¯æœ¬æ•°ã€‚ ç³»ç»Ÿçº§æœåŠ¡ï¼Œå¦‚æ—¥å¿—æ”¶é›†å™¨ï¼ˆFluentdï¼‰ã€ç›‘æ§ä»£ç†ï¼ˆPrometheus node exporterï¼‰ replicated-job åœ¨å¤šä¸ªèŠ‚ç‚¹ä¸ŠæŒ‰å‰¯æœ¬æ•°è¿è¡Œä¸€æ¬¡æ€§ä»»åŠ¡ï¼Œä»»åŠ¡å®Œæˆåå³é€€å‡ºã€‚ æ•°æ®å¤„ç†ã€æ‰¹å¤„ç†ä»»åŠ¡ï¼Œå¦‚è½¬æ¢æ–‡ä»¶æˆ–è·‘ ETL global-job åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸Šå„è¿è¡Œä¸€æ¬¡çš„çŸ­æš‚ä»»åŠ¡ï¼Œæ‰§è¡Œå®Œæ¯•å³é€€å‡ºã€‚ åˆå§‹åŒ–è„šæœ¬ã€æ¯å°æœºå™¨ä¸Šè¿è¡Œä¸€æ¬¡çš„æ•°æ®æ¸…æ´—ã€åˆå§‹åŒ–ç¯å¢ƒä»»åŠ¡ç­‰ job æ¨¡å¼é€šå¸¸é…åˆé•œåƒä¸­è®¾å®šçš„å…¥å£å‘½ä»¤ä½¿ç”¨ï¼Œä¸é€‚ç”¨äºé•¿æœŸè¿è¡Œçš„æœåŠ¡ã€‚ replicated å’Œ global æ¨¡å¼é€‚ç”¨äºæŒç»­è¿è¡Œçš„æœåŠ¡ï¼ŒSwarm ä¼šè‡ªåŠ¨é‡å¯å¤±è´¥çš„ä»»åŠ¡ã€‚ æœåŠ¡é‡å¯ç­–ç•¥ï¼ˆâ€“restart-conditionï¼‰è¯¦è§£ å€¼ å«ä¹‰è¯´æ˜ none ä¸é‡å¯ä»»åŠ¡ã€‚å³ä½¿ä»»åŠ¡å¤±è´¥ï¼Œä¹Ÿä¸ä¼šå°è¯•æ¢å¤ã€‚é€‚ç”¨äºçŸ­ç”Ÿå‘½å‘¨æœŸçš„ä»»åŠ¡æˆ–æµ‹è¯•æœåŠ¡ã€‚ on-failure ä»…åœ¨ä»»åŠ¡å¼‚å¸¸å¤±è´¥æ—¶ï¼ˆexit code é 0ï¼‰è‡ªåŠ¨é‡å¯ã€‚å¸¸ç”¨äºå¯èƒ½å¶å‘å¤±è´¥çš„æœåŠ¡ã€‚ anyï¼ˆé»˜è®¤ï¼‰ æ— è®ºä»»åŠ¡å¦‚ä½•é€€å‡ºï¼ˆåŒ…æ‹¬æ­£å¸¸é€€å‡ºæˆ–å¤±è´¥ï¼‰ï¼Œéƒ½ä¼šå°è¯•é‡å¯ã€‚é€‚ç”¨äºæŒç»­è¿è¡ŒæœåŠ¡ã€‚ æƒ…æ™¯æ€»ç»“ æƒ…æ™¯ none on-failure any æœåŠ¡è¿è¡Œæ—¶å´©æºƒï¼ˆexit code â‰  0ï¼‰ âŒ ä¸é‡å¯ âœ… è‡ªåŠ¨é‡å¯ âœ… è‡ªåŠ¨é‡å¯ æœåŠ¡æ­£å¸¸ç»“æŸï¼ˆexit code = 0ï¼‰ âŒ ä¸é‡å¯ âŒ ä¸é‡å¯ âœ… è‡ªåŠ¨é‡å¯ æŒç»­è¿è¡Œå‹æœåŠ¡ï¼ˆå¦‚ nginxï¼‰ âŒ ä¸æ¨è å¯ç”¨ âœ… æ¨è ä¸€æ¬¡æ€§ä»»åŠ¡ï¼ˆå¦‚æ‰¹å¤„ç†ã€æ•°æ®åˆå§‹åŒ–ï¼‰ âœ… æ¨è å¯ç”¨ âŒ ä¸æ¨è docker service create ä½¿ç”¨ç¤ºä¾‹ åˆ›å»ºä¸€ä¸ªåä¸º my-nginx çš„æœåŠ¡ï¼Œå¹¶æŒ‡å®š 3 ä¸ªå‰¯æœ¬ï¼Œå°† 80 ç«¯å£æ˜ å°„åˆ°ä¸»æœºçš„ 80 ç«¯å£ï¼Œå¹¶ä½¿ç”¨ nginx é•œåƒ 123456# æ­¤æ—¶åœ¨æµè§ˆå™¨ä¸­è¾“å…¥Swarmä¸­ä»»æ„èŠ‚ç‚¹çš„IPåœ°å€ï¼Œå³å¯è®¿é—®åˆ°NginxæœåŠ¡ï¼Œå³ä½¿ä»»åŠ¡æ²¡æœ‰è¢«åˆ†é…åˆ°è¿™ä¸ªèŠ‚ç‚¹ï¼Œä¹Ÿèƒ½è®¿é—®åˆ°NginxæœåŠ¡ï¼Œè¿™å°±æ˜¯Swarmçš„è´Ÿè½½å‡è¡¡åŠŸèƒ½docker service create \\ --name my-nginx \\ --replicas 3 \\ --publish 80:80 \\ nginx åˆ›å»ºä¸€ä¸ªåä¸º log-agent çš„å…¨å±€æœåŠ¡ï¼Œå¹¶ä½¿ç”¨ fluentd é•œåƒï¼Œå³æ¯ä¸ªèŠ‚ç‚¹éƒ½ä¼šè¿è¡Œä¸€ä¸ª fluentd å®¹å™¨ 12# globaldocker service create --name log-agent --mode global fluentd åˆ›å»ºä¸€ä¸ªåç§°ä¸º web-app çš„æœåŠ¡ï¼Œå¹¶è®¾ç½®ç¯å¢ƒå˜é‡ NODE_ENV=production ï¼ŒæŒ‚è½½ /data ç›®å½•åˆ°å®¹å™¨çš„ /app/data ç›®å½•ï¼Œå¹¶è®¾ç½® 2 ä¸ªå‰¯æœ¬ï¼Œå¹¶ä¸”æŒ‡å®šå¯åŠ¨å®¹å™¨çš„å‘½ä»¤ä¸º node server.js 123456docker service create \\ --name web-app \\ --env NODE_ENV=production \\ --mount type=bind,src=/data,target=/app/data \\ --replicas 2 \\ node:18 node server.js åˆ›å»ºä¸€ä¸ªåç§°ä¸º db çš„æœåŠ¡ï¼Œå¹¶æŒ‡å®šè¿è¡Œåœ¨å…·æœ‰ role=db æ ‡ç­¾çš„èŠ‚ç‚¹ä¸Šï¼Œå¹¶ä¸”ä½¿ç”¨åä¸º db-data çš„å·æŒ‚è½½æ•°æ® 12345678# åˆ›å»ºæ•°æ®å·docker volume create db-data# åˆ›å»ºæœåŠ¡docker service create \\ --name db \\ --constraint &#x27;node.labels.role == db&#x27; \\ --mount type=volume,source=db-data,target=/var/lib/mysql \\ mysql:8 ä½¿ç”¨ on-failure ç­–ç•¥ï¼Œä»…åœ¨å¤±è´¥æ—¶è‡ªåŠ¨é‡å¯ 1234docker service create \\ --name unstable-worker \\ --restart-condition on-failure \\ my-worker-image æŒ‡å®šç½‘ç»œï¼Œç½‘ç»œé©±åŠ¨ç±»å‹ä¸º overlay 1234567891011# å…ˆåœ¨managerèŠ‚ç‚¹ä¸Šåˆ›å»ºä¸€ä¸ª overlay ç½‘ç»œï¼ˆé€‚ç”¨äº Swarm æ¨¡å¼ï¼‰docker network create --driver overlay my-overlay-net# åˆ›å»ºé©±åŠ¨ç±»å‹ä¸º overlay çš„ç½‘ç»œï¼Œä¼šç«‹å³åŒæ­¥æ‰€æœ‰ manager èŠ‚ç‚¹ï¼Œä½†ä¸ä¼šåŒæ­¥åˆ° worker èŠ‚ç‚¹ï¼Œåªæœ‰å½“ä»»åŠ¡è¢«åˆ†é…åˆ° worker èŠ‚ç‚¹æ—¶ï¼Œè¯¥ç½‘ç»œæ‰ä¼šåŒæ­¥åˆ° worker èŠ‚ç‚¹# åˆ›å»ºæœåŠ¡å¹¶åŠ å…¥è¯¥ç½‘ç»œdocker service create \\ --name web-service \\ --network my-overlay-net \\ --replicas 5 \\ nginx # --network: æŒ‡å®šæœåŠ¡è¿è¡Œæ—¶è¿æ¥åˆ°è¯¥ç½‘ç»œï¼Œè¿™æ ·åœ¨åŒä¸€ä¸ªç½‘ç»œä¸­çš„æœåŠ¡ä¹‹é—´å¯ä»¥ä½¿ç”¨ æœåŠ¡åäº’ç›¸è®¿é—®ï¼Œå®ç°æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡ã€‚ å°è´´å£« 1234567docker network lsNETWORK ID NAME DRIVER SCOPE6b7aadbbd180 bridge bridge local5ddadf5d0608 docker_gwbridge bridge local21c6f5b1bedd host host localidx465x3jg68 ingress overlay swarma770c5ad4b13 none null local åˆå§‹åŒ–Swarmé›†ç¾¤åï¼Œä¼šåˆ›å»ºä¸€ä¸ªé»˜è®¤çš„ overlay ç½‘ç»œ: ingressï¼Œå¦‚æœæˆ‘ä»¬åˆ›å»ºæœåŠ¡æ—¶æ²¡æœ‰æŒ‡å®šç½‘ç»œï¼Œé‚£ä¹ˆæœåŠ¡å°±ä¼šåŠ å…¥ ingress ç½‘ç»œã€‚ ä½†æ˜¯è¿™ä¸ªé»˜è®¤çš„ ingress ç½‘ç»œå¹¶ä¸èƒ½ç”¨äºæœåŠ¡ä¹‹é—´é€šè¿‡æœåŠ¡åç§°äº’ç›¸è®¿é—®ï¼Œä½†å¯ä»¥é€šè¿‡IPæˆ–Hostnameè®¿é—®æœåŠ¡ã€‚ é»˜è®¤çš„ ingress ç½‘ç»œä»…ç”¨äº ingress è´Ÿè½½å‡è¡¡ï¼ˆå³ -p ç«¯å£æ˜ å°„ï¼‰ï¼Œä¸æ”¯æŒæœåŠ¡å†…éƒ¨é€šä¿¡æˆ– DNS æœåŠ¡å‘ç°ã€‚ å¦å¤–ï¼Œåˆå§‹åŒ–Swarmé›†ç¾¤åï¼Œè¿˜ä¼šåˆ›å»ºä¸€ä¸ªé»˜è®¤çš„ bridge ç½‘ç»œ: docker_gwbridgeï¼Œè´Ÿè´£è¿æ¥ Swarm é›†ç¾¤çš„ Overlay ç½‘ç»œä¸å®¿ä¸»æœºç½‘ç»œï¼Œè´Ÿè´£è·¨èŠ‚ç‚¹çš„æµé‡è½¬å‘ å½“ä¸€ä¸ªå®¹å™¨åœ¨ Overlay ç½‘ç»œé‡Œè®¿é—®å¤–éƒ¨ IPï¼Œæ¯”å¦‚è®¿é—®å…¬ç½‘ï¼Œæµé‡æœ€ç»ˆé€šè¿‡ docker_gwbridge ç½‘ç»œå‡ºå£å‡ºå»ã€‚ èŠ‚ç‚¹é—´ VXLAN éš§é“çš„æµé‡ä¹Ÿä¼šå€ŸåŠ©æ­¤ç½‘ç»œæ¡¥æ¥åˆ°å®¿ä¸»æœºçš„ç‰©ç†ç½‘ç»œæ¥å£ã€‚ docker service ls: åˆ—å‡ºæ‰€æœ‰æœåŠ¡ 123docker service lsID NAME MODE REPLICAS IMAGE PORTSdmnztimv3pb8 my-nginx replicated 2/2 nginx:latest *:80-&gt;80/tcp docker service inspect: æŸ¥çœ‹æœåŠ¡è¯¦æƒ… 1docker service inspect my-nginx docker service log: æŸ¥çœ‹æœåŠ¡æ—¥å¿— 123456# æŸ¥çœ‹æŒ‡å®šæœåŠ¡ä¸‹æ‰€æœ‰ä»»åŠ¡çš„æ—¥å¿—docker service logs my-nginx# æŸ¥çœ‹æŒ‡å®šä»»åŠ¡çš„æ—¥å¿—ï¼ŒæŒ‡å®šä»»åŠ¡IDï¼Œä¸æ”¯æŒä»»åŠ¡åç§°docker service logs p4tats0f9npk# æ»šåŠ¨æŸ¥çœ‹æ—¥å¿—docker service logs -f my-nginx docker service ps: åˆ—å‡ºæœåŠ¡ä»»åŠ¡ 1234docker service ps my-nginxID NAME IMAGE NODE DESIRED STATE CURRENT STATE ERROR PORTSp4tats0f9npk my-nginx.1 nginx:latest manager1 Running Running 13 minutes agov7z383xy7dso my-nginx.2 nginx:latest manager2 Running Running 15 minutes ago docker service scale: æ‰©å®¹/ç¼©å®¹æœåŠ¡ 12345678910111213141516171819202122232425262728293031323334353637# å¯åŠ¨ä¸€ä¸ªæœåŠ¡docker service create \\ --name my-nginx \\ --replicas 3 \\ --publish 80:80 \\ nginx# æŸ¥çœ‹æœåŠ¡ä»»åŠ¡docker service ps my-nginx## è¾“å‡ºID NAME IMAGE NODE DESIRED STATE CURRENT STATE ERROR PORTSp4tats0f9npk my-nginx.1 nginx:latest manager1 Running Running 14 seconds agov7z383xy7dso my-nginx.2 nginx:latest manager2 Running Running 2 minutes agow0sm5ixvi6eb my-nginx.3 nginx:latest worker2 Running Running 4 seconds ago# æ‰©å®¹åˆ°5ä¸ªä»»åŠ¡docker service scale my-nginx=5# æŸ¥çœ‹æœåŠ¡ä»»åŠ¡docker service ps my-nginx## è¾“å‡ºID NAME IMAGE NODE DESIRED STATE CURRENT STATE ERROR PORTSp4tats0f9npk my-nginx.1 nginx:latest manager1 Running Running about a minute agov7z383xy7dso my-nginx.2 nginx:latest manager2 Running Running 3 minutes agow0sm5ixvi6eb my-nginx.3 nginx:latest worker2 Running Running about a minute agoksbeflwg3mcj my-nginx.4 nginx:latest worker1 Running Running less than a second agoiw4zlm56n1x8 my-nginx.5 nginx:latest manager3 Running Running less than a second ago# ç¼©å®¹åˆ°2ä¸ªäººä»»åŠ¡docker service scale my-nginx=2# æŸ¥çœ‹æœåŠ¡ä»»åŠ¡docker service ps my-nginxID NAME IMAGE NODE DESIRED STATE CURRENT STATE ERROR PORTSp4tats0f9npk my-nginx.1 nginx:latest manager1 Running Running 2 minutes agov7z383xy7dso my-nginx.2 nginx:latest manager2 Running Running 4 minutes ago# è¿˜å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤è¿›è¡Œæ‰©ç¼©å®¹docker service update --replicas=5 my-nginx docker service update: æ›´æ–°æœåŠ¡ æ”¯æŒçš„å‚æ•° å‚æ•° è¯´æ˜ ç¤ºä¾‹ --image æ›´æ–°æœåŠ¡ä½¿ç”¨çš„é•œåƒ --image nginx:1.25 --replicas è®¾ç½®æœåŠ¡çš„å‰¯æœ¬æ•°é‡ï¼ˆä»…é€‚ç”¨äº replicated æ¨¡å¼ï¼‰ --replicas 5 --env-add æ·»åŠ ç¯å¢ƒå˜é‡ --env-add DEBUG=true --env-rm ç§»é™¤ç¯å¢ƒå˜é‡ --env-rm OLD_VAR --publish-add æ·»åŠ ç«¯å£æ˜ å°„ --publish-add published=8080,target=80 --publish-rm ç§»é™¤ç«¯å£æ˜ å°„ --publish-rm 80 --mount-add æ·»åŠ æŒ‚è½½ --mount-add type=bind,src=/data,dst=/data --mount-rm ç§»é™¤æŒ‚è½½ --mount-rm /data --constraint-add æ·»åŠ éƒ¨ç½²çº¦æŸ --constraint-add 'node.labels.zone==east' --constraint-rm ç§»é™¤éƒ¨ç½²çº¦æŸ --constraint-rm 'node.labels.zone==east' --limit-cpu è®¾ç½® CPU é™åˆ¶ --limit-cpu 0.5 --limit-memory è®¾ç½®å†…å­˜é™åˆ¶ --limit-memory 256M --restart-condition è®¾ç½®é‡å¯ç­–ç•¥ï¼ˆnoneã€on-failureã€anyï¼‰ --restart-condition on-failure --update-delay è®¾ç½®ä»»åŠ¡æ›´æ–°ä¹‹é—´çš„å»¶è¿Ÿ --update-delay 10s --update-parallelism è®¾ç½®å¹¶å‘æ›´æ–°ä»»åŠ¡çš„æ•°é‡ --update-parallelism 2 --update-order è®¾ç½®æ›´æ–°é¡ºåºï¼ˆstart-first æˆ– stop-firstï¼‰ --update-order start-first --update-failure-action æ›´æ–°å¤±è´¥åçš„åŠ¨ä½œï¼ˆpauseã€continueã€rollbackï¼‰ --update-failure-action rollback --rollback å›æ»šåˆ°ä¸Šä¸€æ¬¡æˆåŠŸé…ç½® --rollback ç¤ºä¾‹ 12345678910docker service update \\ --image nginx:1.25 \\ --replicas 4 \\ --env-add ENV=prod \\ --limit-memory 512M \\ --limit-cpu 1.0 \\ --update-delay 10s \\ --update-parallelism 2 \\ --update-failure-action rollback \\ my-nginx docker service rollback: å›æ»šæœåŠ¡ ä¼šå°†æœåŠ¡å›æ»šåˆ°ä¸Šä¸€æ¬¡æˆåŠŸéƒ¨ç½²çš„ç‰ˆæœ¬ï¼ŒåŒ…æ‹¬é•œåƒã€ç¯å¢ƒå˜é‡ã€éƒ¨ç½²çº¦æŸç­‰ã€‚ 12# docker service rollback &lt;service_name&gt;docker service rollback my-nginx docker service rm: åˆ é™¤æœåŠ¡ åˆ é™¤æœåŠ¡ä¼šåœæ­¢æœåŠ¡å¹¶åˆ é™¤æœåŠ¡ã€‚ 12# docker service rm &lt;service_name&gt;docker service rm my-nginx ç»éªŒæŠ€å·§ å¦‚ä½•è®©ä»»åŠ¡è¿è¡Œåœ¨æŒ‡å®šçš„èŠ‚ç‚¹ä¸Šï¼Ÿ åˆ›å»ºæœåŠ¡æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ --constraint å‚æ•°æŒ‡å®šèŠ‚ç‚¹çš„æ ‡ç­¾ï¼Œä½¿å…¶è¿è¡Œåœ¨å…·æœ‰æŒ‡å®šæ ‡ç­¾çš„èŠ‚ç‚¹ä¸Šã€‚ 1234567891011# ç»™ç»“ç‚¹åŠ æ ‡ç­¾docker node update --label-add env=prod worker1# node.labels æ˜¯Swarmå†…ç½®å±æ€§ï¼Œè¡¨ç¤ºèŠ‚ç‚¹çš„æ ‡ç­¾ï¼Œè¿™é‡ŒæŒ‡å®šèŠ‚ç‚¹æ ‡ç­¾ä¸º env=proddocker service create \\--name my-nginx \\--replicas 2 \\--constraint &#x27;node.labels.env == prod&#x27; \\nginx:latest# è¿™é‡Œè¦æ³¨æ„ï¼Œè¿è¡Œä»»åŠ¡åå¦‚æœä¿®æ”¹äº†nodeçš„æ ‡ç­¾ï¼Œé‚£ä¹ˆä»»åŠ¡å°±ä¼šé‡æ–°åˆ†é…ï¼Œåˆ†é…æ˜¯å¦‚æœæ‰¾ä¸åˆ°ç¬¦åˆæ ‡ç­¾çš„èŠ‚ç‚¹ï¼Œå°±ä¼šè¿è¡Œå¤±è´¥ã€‚ åªèƒ½è¿è¡Œåœ¨ç®¡ç†èŠ‚ç‚¹ä¸Š 12345# node.role æ˜¯ Swarm çš„å†…ç½®å±æ€§ï¼Œè¡¨ç¤ºèŠ‚ç‚¹çš„ç±»å‹ï¼Œå€¼ä¸º manager æˆ– workerã€‚docker service create \\ --name manager-only-service \\ --constraint &#x27;node.role == manager&#x27; \\ nginx Swarm å†…ç½®å±æ€§ å±æ€§å ç¤ºä¾‹å€¼ è¯´æ˜ node.id node.id == abcd1234 èŠ‚ç‚¹çš„å”¯ä¸€ IDï¼ˆå¯ç”¨ docker node ls æŸ¥çœ‹ï¼‰ node.hostname node.hostname == manager-1 èŠ‚ç‚¹ä¸»æœºå node.role node.role == manager æˆ– node.role == worker èŠ‚ç‚¹åœ¨ Swarm ä¸­çš„è§’è‰²ï¼ˆç®¡ç†/å·¥ä½œï¼‰ engine.labels.* engine.labels.disk == ssd Docker å¼•æ“çº§åˆ«çš„æ ‡ç­¾ï¼ˆéœ€æ‰‹åŠ¨è®¾ç½®ï¼‰ node.platform.os node.platform.os == linux èŠ‚ç‚¹æ“ä½œç³»ç»Ÿç±»å‹ node.platform.arch node.platform.arch == x86_64 èŠ‚ç‚¹æ¶æ„ç±»å‹ï¼ˆå¦‚ arm64, x86_64ï¼‰ å¦‚ä½•è®¿é—®ServiceæœåŠ¡ï¼Ÿ 1234567891011121314151617# å¯åŠ¨ä¸€ä¸ªserviceï¼Œ3ä¸ªå‰¯æœ¬ï¼Œé•œåƒä¸º whoamiï¼Œè¿™ä¸ªé•œåƒä¼šè¿”å›å½“å‰è®¿é—®çš„å®¹å™¨çš„IDï¼Œå³è¿”å›çš„Hostnamedocker service create --name whoami \\ --replicas 3 \\ -p 80:80 \\ traefik/whoami# æŸ¥çœ‹serviceæœåŠ¡è¿è¡Œåœ¨å“ªäº›èŠ‚ç‚¹ä¸Šï¼Œçœ‹åˆ°è¿™é‡Œåªæœ‰ manager1\\manager2\\worker2 èŠ‚ç‚¹ä¸Šè¿è¡Œï¼Œæ³¨æ„è¿™é‡Œçœ‹åˆ°çš„IDæ˜¯Task IDï¼Œå¹¶éå®¹å™¨IDdocker service ps whoamiID NAME IMAGE NODE DESIRED STATE CURRENT STATE ERROR PORTSu1elzp22hyvm whoami.1 traefik/whoami:latest manager2 Running Running 2 minutes ago4cent1kfgghb whoami.2 traefik/whoami:latest worker2 Running Running 17 seconds agolu6u6j8ji0uq whoami.3 traefik/whoami:latest manager1 Running Running 40 seconds ago# å¦‚æœå¸Œæœ›æŸ¥è¯¢æŸä¸ªServiceçš„æ‰€æœ‰å®¹å™¨çš„IDï¼Œå¯ä»¥æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤docker service ps whoami -q | xargs docker inspect --format &#x27;&#123;&#123;.Status.ContainerStatus.ContainerID&#125;&#125;&#x27; | cut -c 1-12a3fb63bde8e7a14e30a02987549610f3a1e9 æ­¤æ—¶æˆ‘ä»¬é€šè¿‡curlè®¿é—® Swarm é›†ç¾¤ä¸­çš„ä»»æ„ä¸€ä¸ªèŠ‚ç‚¹çš„IPï¼Œéƒ½å¯ä»¥è®¿é—®åˆ°è¿™ä¸ªæœåŠ¡ï¼Œæ¯”å¦‚ curl 10.211.55.12ï¼Œè¿™æ˜¯ manager3 èŠ‚ç‚¹çš„ IP åœ°å€ï¼Œè™½ç„¶è¿™ä¸ªæœåŠ¡å¹¶æ²¡æœ‰åœ¨ manager3 èŠ‚ç‚¹ä¸Šè¿è¡Œï¼Œä½†æ˜¯æˆ‘ä»¬ä¾æ—§å¯ä»¥è®¿é—®åˆ°è¿™ä¸ªæœåŠ¡ï¼Œä¸ä»…å¦‚æ­¤ï¼Œæ¯æ¬¡è¿è¡Œå‘½ä»¤è¿”å›çš„Hostname(å°±æ˜¯å®¹å™¨ID)éƒ½ä¼šå‘ç”Ÿå˜åŒ–ï¼Œå…¶æ•ˆæœå°±æ˜¯åœ¨å„ä¸ªè¿è¡Œçš„å®¹å™¨é—´è½®è¯¢ï¼Œè¿™å°±æ˜¯ Swarm é›†ç¾¤çš„è´Ÿè½½å‡è¡¡æ•ˆæœã€‚ 123456789101112curl http://10.211.55.12## è¾“å‡ºHostname: a3fb63bde8e7 # å®¹å™¨IDIP: 127.0.0.1IP: ::1IP: 10.0.0.36 # å®¹å™¨IPï¼Œå¯¹æ¥ br0IP: 172.18.0.4 # å®¹å™¨IPï¼Œå¯¹æ¥ docker_gwbridgeRemoteAddr: 10.0.0.6:52964GET / HTTP/1.1Host: 10.211.55.12User-Agent: curl/7.61.1Accept: */* åœ¨é›†ç¾¤å†…éƒ¨è®¿é—®æœåŠ¡ï¼Œå»ºè®®å°†æ‰€æœ‰æœåŠ¡è¿è¡Œåœ¨ç›¸åŒçš„networkä¸­ï¼Œè¿™æ ·å¯ä»¥ä¸åŒçš„serviceä¹‹é—´å¯ä»¥é€šè¿‡æœåŠ¡åç§°è®¿é—®æœåŠ¡ï¼Œåœ¨é›†ç¾¤å¤–éƒ¨ï¼Œå¯ä»¥é€šè¿‡nginxç­‰ä»£ç†è®¿é—®æœåŠ¡ã€‚ å¯ä»¥ç¼–å†™ä¸€ä¸ªè„šæœ¬æ–¹ä¾¿æŸ¥çœ‹serviceä¸containerçš„è¿è¡Œå…³ç³»ï¼Œæ¯”å¦‚ï¼šdocker_service_container 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758#!/bin/bash# filename: docker_service_container# ç”¨æ³•æç¤ºif [ -z &quot;$1&quot; ]; then echo &quot;ç”¨æ³•: $0 &lt;SERVICE_NAME&gt;&quot; exit 1fi# serviceåç§°SERVCIE_NAME=$1# æ‰€å±network,é»˜è®¤ ingressï¼Œè¿™é‡Œè¦æ³¨æ„ä¸€ä¸‹ï¼Œå¦‚æœæ˜¯è‡ªå®šä¹‰çš„overlayç½‘ç»œï¼Œåªèƒ½è·å–åˆ°å½“å‰ä¸»æœºä¸Šçš„å®¹å™¨IPNETWORK=$2if [ -z &quot;$2&quot; ]; then NETWORK=$(docker service inspect $SERVCIE_NAME --format &#x27;&#123;&#123;json .Endpoint.VirtualIPs&#125;&#125;&#x27; | jq &#x27;.[0].NetworkID&#x27; | sed &#x27;s/&quot;//g&#x27;)fi# NETWORK=$&#123;2:-ingress&#125;d1=$(echo -e &quot;SERVICE-ID TASK-ID CONTAINER-ID NODE-ID&quot; | awk &#x27;&#123;printf &quot;%-12s %-12s %-12s %-12s\\n&quot;, substr($1,1,12), substr($2,1,12), substr($3,1,12), substr($4,1,12)&#125;&#x27; ;\\docker service ps $SERVCIE_NAME --filter &quot;desired-state=running&quot; -q | xargs docker inspect --format &#x27;&#123;&#123;.ServiceID&#125;&#125; &#123;&#123;.ID&#125;&#125; &#123;&#123;.Status.ContainerStatus.ContainerID&#125;&#125; &#123;&#123;.NodeID&#125;&#125;&#x27; \\| awk &#x27;&#123;printf &quot;%-12s %-12s %-12s %-12s\\n&quot;, substr($1,1,12), substr($2,1,12), substr($3,1,12), substr($4,1,12)&#125;&#x27;)#echo &quot;$d1&quot;d2=$(docker service ps $SERVCIE_NAME --filter &quot;desired-state=running&quot;)#echo &quot;$d2&quot;nn1=$(awk &#x27;NR==FNR &amp;&amp; FNR &gt; 1 &#123; id = $1 name = $2 node = $4 desired = $5 # æ‹¼æ¥ CURRENT STATEï¼ˆä»ç¬¬6åˆ—å¼€å§‹çš„æ‰€æœ‰å­—æ®µï¼‰ current = &quot;&quot; for (i=6; i&lt;=NF; i++) &#123; current = current $i &quot; &quot; &#125; gsub(/ /, &quot;-&quot;, current) current = substr(current, 1, length(current)-1) # å»æ‰æœ€åç©ºæ ¼ info[id] = name &quot;\\t&quot; node &quot;\\t&quot; desired &quot;\\t&quot; current next&#125;FNR==1 &#123; print $0 &quot;\\tTASK-NAME\\tNODE\\tDESIRED_STATE\\tCURRENT_STATE&quot; next&#125;&#123; print $0 &quot;\\t&quot; info[$2]&#125;&#x27; &lt;(echo &quot;$d2&quot;) &lt;(echo &quot;$d1&quot;) | tail -n +2 | column -t)nn2=$(echo &quot;CONTAINER-ID IP&quot;;docker network inspect $&#123;NETWORK&#125; -f &#x27;&#123;&#123;range $id, $container := .Containers&#125;&#125;&#123;&#123;slice $id 0 12&#125;&#125; &#123;&#123;$container.Name&#125;&#125; &#123;&#123;$container.IPv4Address&#125;&#125;&#123;&#123;println&#125;&#125;&#123;&#123;end&#125;&#125;&#x27; | grep $SERVCIE_NAME | awk -F &quot; &quot; &#x27;&#123;print $1&quot; &quot;$3&#125;&#x27;)awk &#x27;NR==FNR &#123; ip[$1]=$2; next &#125;&#123; print $0, ip[$3] &#125;&#x27; &lt;(echo &quot;$nn2&quot;) &lt;(echo &quot;$nn1&quot;) | column -t è¿è¡Œ 12345678chmod +x /usr/local/bin/docker-swarm-service# æ‰§è¡Œè„šæœ¬docker-swarm-service whoami## è¾“å‡ºSERVICE-ID TASK-ID CONTAINER-ID NODE-ID TASK-NAME NODE DESIRED_STATE CURRENT_STATE IPsnuhv0g2dm1q czisrjrp8k2t 9e4ce349971c kp2zerd28xgz whoami.1 manager1 Running Running-about-an-hour-ago 10.0.0.35/24snuhv0g2dm1q tvbkwmnafedw 0d586021260d kp2zerd28xgz whoami.2 manager1 Running Running-about-an-hour-ago 10.0.0.36/24snuhv0g2dm1q 815qp859a1f4 449d5e1a231d kp2zerd28xgz whoami.3 manager1 Running Running-about-an-hour-ago 10.0.0.15/24","summary":"æ‘˜è¦ æœ¬æ–‡ä»‹ç» Docker Swarm çš„ æœåŠ¡ç®¡ç† Dockerå®˜æ–¹æ–‡æ¡£ Docker Swarm å®˜æ–¹æ–‡æ¡£","date_published":"2025-06-10T13:30:05.000Z","tags":["æŠ€æœ¯","docker","docker"]},{"id":"https://blog.hanqunfeng.com/2025/06/09/docker-swarm-node/","url":"https://blog.hanqunfeng.com/2025/06/09/docker-swarm-node/","title":"Docker Swarm ä¹‹ èŠ‚ç‚¹(Node)","content_html":"<!--\n **åŠ ç²—**\n *æ–œä½“*\n ***åŠ ç²—å¹¶æ–œä½“***\n ~~åˆ é™¤çº¿~~\n ==çªå‡ºæ˜¾ç¤º==\n `çªå‡ºæ˜¾ç¤º(æ¨è)`\n ++ä¸‹åˆ’çº¿++\n ~ä¸‹æ ‡~\n ^ä¸Šæ ‡^\n è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference.\n å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)\n\n +++ **ç‚¹å‡»æŠ˜å **\n è¿™æ˜¯è¢«éšè—çš„å†…å®¹\n +++\n\n::: tips success warning danger\nè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹\n:::\n\n% note info % success warning danger\nè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹\n% endnote %\n\nå¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{}\n å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ\n -->\n<h2 id=\"æ‘˜è¦\">æ‘˜è¦</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æœ¬æ–‡ä»‹ç» Docker Swarm çš„ èŠ‚ç‚¹ç®¡ç†</p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://docs.docker.com\">Dockerå®˜æ–¹æ–‡æ¡£</a></p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://docs.docker.com/engine/swarm/\">Docker Swarm å®˜æ–¹æ–‡æ¡£</a></p>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"Docker-Swarm-ç®€ä»‹\">Docker Swarm ç®€ä»‹</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Docker Swarm æ˜¯ Docker å®˜æ–¹æä¾›çš„ä¸€ä¸ªé›†ç¾¤ç®¡ç†å·¥å…·ï¼ŒåŸºäº Docker Swarm å¯ä»¥å¿«é€Ÿå®ç° Docker é›†ç¾¤çš„ç®¡ç†ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>ä» Docker v1.12 ç‰ˆæœ¬å¼€å§‹ï¼ŒDocker Swarm å·²ç»åŒ…å«åœ¨ Docker Engine ä¸­ï¼Œä¸éœ€è¦å•ç‹¬å®‰è£…ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>Docker Swarm å…·æœ‰æœåŠ¡ç¼–æ’ã€æœåŠ¡è´Ÿè½½å‡è¡¡ã€æœåŠ¡å‡çº§å’ŒæœåŠ¡å¤±è´¥è¿ç§»ç­‰åŠŸèƒ½ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>Docker Swarm é›†ç¾¤ä¸­çš„èŠ‚ç‚¹åˆ†ä¸ºä¸¤ç§ç±»å‹ï¼šç®¡ç†èŠ‚ç‚¹(Manager Node)å’Œå·¥ä½œèŠ‚ç‚¹(Worker Node)ï¼Œç®¡ç†èŠ‚ç‚¹è´Ÿè´£é›†ç¾¤çš„ç®¡ç†ï¼Œå·¥ä½œèŠ‚ç‚¹è´Ÿè´£è¿è¡Œå®¹å™¨ã€‚<br>\n<img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/KwTed9.png\" alt=\"\"></p>\n</li>\n<li class=\"lvl-2\">\n<p>ä»¥ä¸‹æ˜¯ Docker Swarm ä¸­ ç®¡ç†èŠ‚ç‚¹ï¼ˆManager Nodeï¼‰ å’Œ å·¥ä½œèŠ‚ç‚¹ï¼ˆWorker Nodeï¼‰ çš„å¯¹æ¯”</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>ç‰¹æ€§/åŠŸèƒ½</th>\n<th>ç®¡ç†èŠ‚ç‚¹ï¼ˆManager Nodeï¼‰</th>\n<th>å·¥ä½œèŠ‚ç‚¹ï¼ˆWorker Nodeï¼‰</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>è§’è‰²</td>\n<td>è´Ÿè´£é›†ç¾¤ç®¡ç†å’Œå†³ç­–</td>\n<td>æ‰§è¡Œåˆ†é…çš„æœåŠ¡ä»»åŠ¡</td>\n</tr>\n<tr>\n<td>æ˜¯å¦å‚ä¸æœåŠ¡è¿è¡Œ</td>\n<td>å¯ä»¥è¿è¡ŒæœåŠ¡ä»»åŠ¡ï¼Œä¹Ÿå¯ä»¥åªåšç®¡ç†ï¼ˆå¯é…ç½®ï¼‰</td>\n<td>ä»…è¿è¡ŒæœåŠ¡ä»»åŠ¡ï¼Œä¸å‚ä¸ç®¡ç†å†³ç­–</td>\n</tr>\n<tr>\n<td>é›†ç¾¤çŠ¶æ€ç»´æŠ¤</td>\n<td>ç»´æŠ¤æ•´ä¸ª Swarm çš„çŠ¶æ€ï¼ˆä½¿ç”¨ Raft åè®®ï¼‰</td>\n<td>ä¸ç»´æŠ¤é›†ç¾¤çŠ¶æ€</td>\n</tr>\n<tr>\n<td>è°ƒåº¦ä»»åŠ¡</td>\n<td>å†³å®šå°†æœåŠ¡ä»»åŠ¡åˆ†é…ç»™å“ªä¸ªèŠ‚ç‚¹</td>\n<td>ä¸è´Ÿè´£è°ƒåº¦ï¼Œåªæ‰§è¡Œæ¥æ”¶åˆ°çš„ä»»åŠ¡</td>\n</tr>\n<tr>\n<td>ç®¡ç†å‘½ä»¤å¤„ç†</td>\n<td>æ¥æ”¶å¹¶å¤„ç† Swarm ç®¡ç†å‘½ä»¤ï¼ˆå¦‚åˆ›å»ºæœåŠ¡ã€æ‰©ç¼©å®¹ç­‰ï¼‰</td>\n<td>ä¸å¤„ç†ç®¡ç†å‘½ä»¤</td>\n</tr>\n<tr>\n<td>æ•°æ®ä¸€è‡´æ€§</td>\n<td>éœ€è¦ä¿æŒä¸€è‡´æ€§ï¼ˆè‡³å°‘ 3 ä¸ªç®¡ç†èŠ‚ç‚¹å½¢æˆé«˜å¯ç”¨ï¼‰</td>\n<td>ä¸æ¶‰åŠä¸€è‡´æ€§</td>\n</tr>\n<tr>\n<td>èµ„æºè¦æ±‚</td>\n<td>ç›¸å¯¹è¾ƒé«˜ï¼Œéœ€è¦æ‰¿æ‹…ç®¡ç†å’Œåè°ƒå¼€é”€</td>\n<td>ç›¸å¯¹è¾ƒä½ï¼Œä¸“æ³¨äºè¿è¡Œå®¹å™¨</td>\n</tr>\n<tr>\n<td>å¯ç”¨æ€§è¦æ±‚</td>\n<td>é€šå¸¸é…ç½®å¥‡æ•°ä¸ªï¼ˆ3ã€5ã€7â€¦ï¼‰ä»¥ä¿éšœé«˜å¯ç”¨</td>\n<td>å¯æ ¹æ®éœ€è¦è‡ªç”±æ‰©å±•æˆ–ç¼©å‡</td>\n</tr>\n<tr>\n<td>èŠ‚ç‚¹åŠ å…¥æ–¹å¼</td>\n<td>é€šè¿‡ manager token åŠ å…¥ Swarm</td>\n<td>é€šè¿‡ worker token åŠ å…¥ Swarm</td>\n</tr>\n<tr>\n<td>æ•…éšœå½±å“</td>\n<td>å¤šä¸ªç®¡ç†èŠ‚ç‚¹æ•…éšœå¯èƒ½å½±å“æ•´ä¸ª Swarm çš„æ§åˆ¶èƒ½åŠ›</td>\n<td>éƒ¨åˆ†å·¥ä½œèŠ‚ç‚¹æ•…éšœé€šå¸¸ä¸ä¼šå½±å“ Swarm çš„ç®¡ç†èƒ½åŠ›</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>manager èŠ‚ç‚¹é€šå¸¸é…ç½®ä¸ºå¥‡æ•°ä¸ªï¼Œé»˜è®¤åˆ›å»ºé›†ç¾¤çš„èŠ‚ç‚¹å°±æ˜¯ manager èŠ‚ç‚¹ï¼Œå¹¶ä¸”æ˜¯ manager èŠ‚ç‚¹ä¸­çš„çš„ Leader èŠ‚ç‚¹ã€‚Leader èŠ‚ç‚¹è´Ÿè´£ç®¡ç†é›†ç¾¤ï¼ŒLeader èŠ‚ç‚¹åœ¨é›†ç¾¤ä¸­åªèƒ½æœ‰ä¸€ä¸ªã€‚å½“ Leader èŠ‚ç‚¹æ•…éšœæ—¶ï¼ŒSwarm ä¼šè‡ªåŠ¨ä»å…¶å®ƒ manager èŠ‚ç‚¹ä¸­é€‰ä¸¾å‡ºä¸€ä¸ªæ–°çš„ Leader èŠ‚ç‚¹ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>worker èŠ‚ç‚¹æ˜¯è¿è¡Œå®¹å™¨çš„èŠ‚ç‚¹ï¼Œä¸å‚ä¸æœºå™¨çš„ç®¡ç†å’Œè°ƒåº¦ï¼Œä¸æ”¯æŒæ‰§è¡Œä»»ä½•å’Œé›†ç¾¤ç®¡ç†ç›¸å…³çš„æ“ä½œã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œmanager èŠ‚ç‚¹ä¹Ÿä¼šå‚ä¸æ¥æ”¶è¿è¡Œå®¹å™¨çš„ä»»åŠ¡ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡è®¾ç½®æ¥æŒ‡å®š manager èŠ‚ç‚¹ä¸å‚ä¸æ¥æ”¶ä»»åŠ¡ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>manager èŠ‚ç‚¹å’Œ worker èŠ‚ç‚¹å¯ä»¥é€šè¿‡â€œå‡çº§â€å’Œâ€œé™çº§â€ç›¸äº’è½¬æ¢ã€‚</p>\n</li>\n</ul>\n<h2 id=\"æ­å»ºSwarmé›†ç¾¤\">æ­å»ºSwarmé›†ç¾¤</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æœ¬æ•™ç¨‹éœ€è¦äº”å°å®‰è£…äº†Dockerä¸”èƒ½å¤Ÿé€šè¿‡ç½‘ç»œé€šä¿¡çš„ Linux ä¸»æœºï¼Œè¿™äº›ä¸»æœºå¯ä»¥æ˜¯ç‰©ç†æœºã€è™šæ‹Ÿæœºã€Amazon EC2 å®ä¾‹ï¼Œä¹Ÿå¯ä»¥ä»¥å…¶ä»–æ–¹å¼æ‰˜ç®¡ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>å…¶ä¸­ä¸‰å°æœºå™¨æ˜¯ç®¡ç†èŠ‚ç‚¹ï¼ˆç§°ä¸ºmanager1,manager2,manager3ï¼‰ï¼Œå¦å¤–ä¸¤å°æ˜¯å·¥ä½œèŠ‚ç‚¹ï¼ˆworker1å’Œworker2ï¼‰ã€‚</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>IP åœ°å€</th>\n<th>HostName</th>\n<th>è§’è‰²ç±»å‹</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>10.211.55.10</td>\n<td>manager1</td>\n<td>ç®¡ç†èŠ‚ç‚¹</td>\n</tr>\n<tr>\n<td>10.211.55.11</td>\n<td>manager2</td>\n<td>ç®¡ç†èŠ‚ç‚¹</td>\n</tr>\n<tr>\n<td>10.211.55.12</td>\n<td>manager3</td>\n<td>ç®¡ç†èŠ‚ç‚¹</td>\n</tr>\n<tr>\n<td>10.211.55.13</td>\n<td>worker1</td>\n<td>å·¥ä½œèŠ‚ç‚¹</td>\n</tr>\n<tr>\n<td>10.211.55.14</td>\n<td>worker2</td>\n<td>å·¥ä½œèŠ‚ç‚¹</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æ‰€æœ‰ä¸»æœºä¸Šå¿…é¡»å¼€å¯å¦‚ä¸‹ç«¯å£ï¼Œä»¥ç¡®ä¿Docker Swarm é›†ç¾¤æ­£å¸¸é€šä¿¡ï¼š</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>ç«¯å£å·</th>\n<th>åè®®</th>\n<th>ç”¨é€”è¯´æ˜</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>2377</td>\n<td>TCP</td>\n<td>ç®¡ç†å™¨èŠ‚ç‚¹ä¹‹é—´é€šä¿¡ï¼ˆç®¡ç†æŒ‡ä»¤å’ŒåŠ å…¥é›†ç¾¤ï¼‰</td>\n</tr>\n<tr>\n<td>7946</td>\n<td>TCP/UDP</td>\n<td>èŠ‚ç‚¹å‘ç°å’Œé€šä¿¡ï¼ˆé›†ç¾¤å†…éƒ¨å‘ç°æœºåˆ¶ï¼‰</td>\n</tr>\n<tr>\n<td>4789</td>\n<td>UDP</td>\n<td>è¦†ç›–ç½‘ç»œæµé‡ï¼ˆVXLANï¼Œç”¨äºå®¹å™¨é—´ç½‘ç»œï¼‰</td>\n</tr>\n</tbody>\n</table>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># å¼€æ”¾ Swarm ç®¡ç†èŠ‚ç‚¹é€šä¿¡ç«¯å£</span></span><br><span class=\"line\"><span class=\"built_in\">sudo</span> firewall-cmd --permanent --add-port=2377/tcp</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># èŠ‚ç‚¹å‘ç°ï¼ˆcluster communicationï¼‰</span></span><br><span class=\"line\"><span class=\"built_in\">sudo</span> firewall-cmd --permanent --add-port=7946/tcp</span><br><span class=\"line\"><span class=\"built_in\">sudo</span> firewall-cmd --permanent --add-port=7946/udp</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># overlay ç½‘ç»œæµé‡ï¼ˆå®¹å™¨é—´é€šä¿¡ï¼‰</span></span><br><span class=\"line\"><span class=\"built_in\">sudo</span> firewall-cmd --permanent --add-port=4789/udp</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># åº”ç”¨æ›´æ”¹</span></span><br><span class=\"line\"><span class=\"built_in\">sudo</span> firewall-cmd --reload</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹é˜²ç«å¢™çŠ¶æ€</span></span><br><span class=\"line\"><span class=\"built_in\">sudo</span> firewall-cmd --list-all</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æ‰€æœ‰ä¸»æœºå¿…é¡»æ—¶é—´ä¸€è‡´</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># åŒæ­¥ç³»ç»Ÿæ—¶é—´</span></span><br><span class=\"line\"><span class=\"built_in\">sudo</span> systemctl restart chronyd</span><br><span class=\"line\">chronyc tracking</span><br><span class=\"line\"><span class=\"comment\"># åŒæ­¥åç³»ç»Ÿæ—¶é—´æ˜¾ç¤ºä¸º UTCï¼Œè€Œä¸æ˜¯ä¸­å›½æ—¶åŒºï¼ˆCST/Asia/Shanghaiï¼‰</span></span><br><span class=\"line\"><span class=\"comment\"># è®¾ç½®æ—¶åŒºä¸ºä¸­å›½ä¸Šæµ·æ—¶é—´ï¼ˆCSTï¼‰</span></span><br><span class=\"line\"><span class=\"built_in\">sudo</span> timedatectl set-timezone Asia/Shanghai</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹æ—¶é—´å’Œæ—¶åŒº</span></span><br><span class=\"line\">timedatectl</span><br></pre></td></tr></table></figure>\n<h3 id=\"åˆ›å»ºé›†ç¾¤\">åˆ›å»ºé›†ç¾¤</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åœ¨ manager1 èŠ‚ç‚¹ä¸Šæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„swarmé›†ç¾¤</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹å½“å‰dockerçš„swarmæ¨¡å¼æ˜¯å¦å¼€å¯</span></span><br><span class=\"line\">docker info | grep <span class=\"string\">&quot;Swarm&quot;</span></span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡ºï¼Œ inactive è¡¨ç¤ºæ²¡æœ‰å¼€å¯swarmé›†ç¾¤</span></span><br><span class=\"line\"> Swarm: inactive</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># é›†ç¾¤åˆå§‹åŒ–</span></span><br><span class=\"line\"><span class=\"comment\"># docker swarm init --advertise-addr &lt;MANAGER-IP&gt;</span></span><br><span class=\"line\">docker swarm init --advertise-addr 10.211.55.10</span><br><span class=\"line\"><span class=\"comment\">## å‚æ•°è¯´æ˜</span></span><br><span class=\"line\"><span class=\"comment\"># --advertise-addrï¼šæŒ‡å®šå½“å‰èŠ‚ç‚¹çš„IPåœ°å€ï¼Œç”¨äºé›†ç¾¤ä¸­å…¶ä»–èŠ‚ç‚¹å‘ç°å½“å‰èŠ‚ç‚¹ï¼Œç«¯å£é»˜è®¤2377</span></span><br><span class=\"line\"><span class=\"comment\"># è¿™ä¸ªå‚æ•°æ˜¯å¯é€‰çš„ï¼Œå¦‚æœèŠ‚ç‚¹ä¸Šå­˜åœ¨å¤šä¸ªç½‘å¡ï¼Œåˆ™éœ€è¦æŒ‡å®šå½“å‰èŠ‚ç‚¹çš„IPåœ°å€</span></span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡º</span></span><br><span class=\"line\"><span class=\"comment\"># swarm åˆå§‹åŒ–æˆåŠŸï¼Œå½“å‰èŠ‚ç‚¹æˆä¸º manager nodeï¼Œå¹¶è‡ªåŠ¨æˆä¸ºé›†ç¾¤çš„leader</span></span><br><span class=\"line\">Swarm initialized: current node (kp2zerd28xgz5mmglnje0jp22) is now a manager.</span><br><span class=\"line\"><span class=\"comment\"># å°†ä¸€ä¸ªworker nodeåŠ å…¥é›†ç¾¤è¯·è¿è¡Œä¸‹é¢çš„å‘½ä»¤</span></span><br><span class=\"line\">To add a worker to this swarm, run the following <span class=\"built_in\">command</span>:</span><br><span class=\"line\">    <span class=\"comment\"># è¿™ä¸ªtokenä¸éœ€è¦è®°ä½ï¼Œå¯ä»¥é€šè¿‡å‘½ä»¤ `docker swarm join-token worker` è·å–</span></span><br><span class=\"line\">    docker swarm <span class=\"built_in\">join</span> --token SWMTKN-1-256y3fmlkr5u76a5lor7jsboox2eztl954djhnuoj4p2x7dem4-0izbgc1xv73qulz31szmxnk3y 10.211.55.10:2377</span><br><span class=\"line\"><span class=\"comment\"># æ·»åŠ ä¸€ä¸ªmanager nodeéœ€è¦æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤è·å– manager token</span></span><br><span class=\"line\">To add a manager to this swarm, run <span class=\"string\">&#x27;docker swarm join-token manager&#x27;</span> and follow the instructions.</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># å†æ¬¡æŸ¥çœ‹å½“å‰dockerçš„swarmæ¨¡å¼æ˜¯å¦å¼€å¯</span></span><br><span class=\"line\">docker info | grep Swarm</span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡º</span></span><br><span class=\"line\"> Swarm: active</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># è‹¥è¦æŸ¥çœ‹æ›´ä¸ºè¯¦ç»†çš„ä¿¡æ¯ï¼Œå¯ä»¥ç›´æ¥æŸ¥çœ‹ Swarm ä¸­çš„ä¿¡æ¯ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹ä¸»è¦ä¿¡æ¯ï¼Œæ­¤æ—¶é›†ç¾¤ä¸­åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¹¶ä¸”æ˜¯managerèŠ‚ç‚¹</span></span><br><span class=\"line\">docker info --format <span class=\"string\">&#x27;&#123;&#123;json .Swarm&#125;&#125;&#x27;</span> | jq <span class=\"string\">&#x27;&#123;LocalNodeState,NodeID,NodeAddr,RemoteManagers,Nodes,Nodes,Managers,ControlAvailable&#125;&#x27;</span> | yq -P</span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡º</span></span><br><span class=\"line\">LocalNodeState: active         <span class=\"comment\"># èŠ‚ç‚¹çŠ¶æ€</span></span><br><span class=\"line\">NodeID: kp2zerd28xgz5mmglnje0jp22 <span class=\"comment\"># èŠ‚ç‚¹ID</span></span><br><span class=\"line\">NodeAddr: 10.211.55.10           <span class=\"comment\"># èŠ‚ç‚¹IP</span></span><br><span class=\"line\">RemoteManagers: [                <span class=\"comment\"># èŠ‚ç‚¹ç®¡ç†èŠ‚ç‚¹ä¿¡æ¯</span></span><br><span class=\"line\">  - NodeID: kp2zerd28xgz5mmglnje0jp22 <span class=\"comment\"># èŠ‚ç‚¹ç®¡ç†èŠ‚ç‚¹ID</span></span><br><span class=\"line\">    Addr: 10.211.55.10:2377       <span class=\"comment\"># èŠ‚ç‚¹ç®¡ç†èŠ‚ç‚¹åœ°å€</span></span><br><span class=\"line\">Nodes: 1                          <span class=\"comment\"># èŠ‚ç‚¹æ•°é‡</span></span><br><span class=\"line\">Managers: 1                       <span class=\"comment\"># ç®¡ç†èŠ‚ç‚¹æ•°é‡</span></span><br><span class=\"line\">ControlAvailable: <span class=\"literal\">true</span>            <span class=\"comment\"># æ˜¯å¦æœ‰æ§åˆ¶èŠ‚ç‚¹</span></span><br></pre></td></tr></table></figure>\n<div class=\"tips\">\n<p><em><strong>å®‰è£… yq å·¥å…·</strong></em></p>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">yq æ˜¯ yaml çš„å‘½ä»¤è¡Œå¤„ç†å·¥å…·ï¼Œå…·ä½“å‚è€ƒ<a href=\"https://github.com/mikefarah/yq\">yq</a></li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ä¸‹è½½ yq æœ€æ–°ç‰ˆæœ¬</span></span><br><span class=\"line\">VERSION=v4.45.4</span><br><span class=\"line\">ARCH=amd64</span><br><span class=\"line\">wget https://github.com/mikefarah/yq/releases/download/<span class=\"variable\">$&#123;VERSION&#125;</span>/yq_linux_<span class=\"variable\">$&#123;ARCH&#125;</span> -O /usr/local/bin/yq</span><br><span class=\"line\"><span class=\"comment\"># æ·»åŠ æ‰§è¡Œæƒé™</span></span><br><span class=\"line\"><span class=\"built_in\">chmod</span> +x /usr/local/bin/yq</span><br><span class=\"line\"><span class=\"comment\"># éªŒè¯å®‰è£…</span></span><br><span class=\"line\">yq --version</span><br></pre></td></tr></table></figure>\n</div>\n<h3 id=\"æ·»åŠ -manager-èŠ‚ç‚¹\">æ·»åŠ  manager èŠ‚ç‚¹</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>è·å– manager èŠ‚ç‚¹çš„ token</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># åœ¨ manager1 ä¸Šè¿è¡Œ</span></span><br><span class=\"line\">docker swarm join-token manager</span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡ºç»“æœ</span></span><br><span class=\"line\">To add a manager to this swarm, run the following <span class=\"built_in\">command</span>:</span><br><span class=\"line\"></span><br><span class=\"line\">    docker swarm <span class=\"built_in\">join</span> --token SWMTKN-1-256y3fmlkr5u76a5lor7jsboox2eztl954djhnuoj4p2x7dem4-byc8ygc6hdoyzna0in1btp9yu 10.211.55.10:2377</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å°† manager2 å’Œ manager3 åŠ å…¥ swarm é›†ç¾¤</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># åˆ†åˆ«åœ¨ manager2 å’Œ manager3 ä¸Šè¿è¡Œå¦‚ä¸‹å‘½ä»¤ï¼Œ</span></span><br><span class=\"line\">docker swarm <span class=\"built_in\">join</span> \\</span><br><span class=\"line\">--token SWMTKN-1-256y3fmlkr5u76a5lor7jsboox2eztl954djhnuoj4p2x7dem4-byc8ygc6hdoyzna0in1btp9yu \\</span><br><span class=\"line\">10.211.55.10:2377</span><br><span class=\"line\"><span class=\"comment\">## å¦‚æœæœºå™¨ä¸Šæœ‰å¤šå—ç½‘å¡ä¹Ÿéœ€è¦æŒ‡å®šip: å¦‚ --advertise-addr 10.211.55.11</span></span><br><span class=\"line\"><span class=\"comment\">## è¿è¡Œç»“æœ</span></span><br><span class=\"line\">This node joined a swarm as a manager.</span><br></pre></td></tr></table></figure>\n<h3 id=\"æ·»åŠ -worker-èŠ‚ç‚¹\">æ·»åŠ  worker èŠ‚ç‚¹</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>è·å– worker èŠ‚ç‚¹çš„ token</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># åœ¨ manager1 ä¸Šè¿è¡Œ</span></span><br><span class=\"line\">docker swarm join-token worker</span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡ºç»“æœ</span></span><br><span class=\"line\">To add a worker to this swarm, run the following <span class=\"built_in\">command</span>:</span><br><span class=\"line\"></span><br><span class=\"line\">    docker swarm <span class=\"built_in\">join</span> --token SWMTKN-1-256y3fmlkr5u76a5lor7jsboox2eztl954djhnuoj4p2x7dem4-0izbgc1xv73qulz31szmxnk3y 10.211.55.10:2377</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å°† worker1 å’Œ worker2 åŠ å…¥ swarm é›†ç¾¤</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># åˆ†åˆ«åœ¨ worker1 å’Œ worker2 ä¸Šè¿è¡Œå¦‚ä¸‹å‘½ä»¤ï¼Œ</span></span><br><span class=\"line\">docker swarm <span class=\"built_in\">join</span> \\</span><br><span class=\"line\">--token SWMTKN-1-256y3fmlkr5u76a5lor7jsboox2eztl954djhnuoj4p2x7dem4-0izbgc1xv73qulz31szmxnk3y \\</span><br><span class=\"line\">10.211.55.10:2377</span><br><span class=\"line\"><span class=\"comment\">## å¦‚æœæœºå™¨ä¸Šæœ‰å¤šå—ç½‘å¡ä¹Ÿéœ€è¦æŒ‡å®šip: å¦‚ --advertise-addr 10.211.55.13</span></span><br><span class=\"line\"><span class=\"comment\">## è¿è¡Œç»“æœ</span></span><br><span class=\"line\">This node joined a swarm as a worker.</span><br></pre></td></tr></table></figure>\n<h3 id=\"æŸ¥çœ‹é›†ç¾¤çŠ¶æ€\">æŸ¥çœ‹é›†ç¾¤çŠ¶æ€</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åœ¨ manager1 ä¸Šæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker info --format <span class=\"string\">&#x27;&#123;&#123;json .Swarm&#125;&#125;&#x27;</span> | jq <span class=\"string\">&#x27;&#123;LocalNodeState,NodeID,NodeAddr,RemoteManagers,Nodes,Nodes,Managers,ControlAvailable&#125;&#x27;</span> | yq -P</span><br><span class=\"line\"><span class=\"comment\">## ç»“æœ</span></span><br><span class=\"line\">LocalNodeState: active</span><br><span class=\"line\">NodeID: kp2zerd28xgz5mmglnje0jp22</span><br><span class=\"line\">NodeAddr: 10.211.55.10</span><br><span class=\"line\">RemoteManagers:</span><br><span class=\"line\">  - NodeID: oymi74epagdqeprah7s81tsa2</span><br><span class=\"line\">    Addr: 10.211.55.11:2377</span><br><span class=\"line\">  - NodeID: r7388xl84nczjtnf53pwh7hla</span><br><span class=\"line\">    Addr: 10.211.55.12:2377</span><br><span class=\"line\">  - NodeID: kp2zerd28xgz5mmglnje0jp22</span><br><span class=\"line\">    Addr: 10.211.55.10:2377</span><br><span class=\"line\">Nodes: 5</span><br><span class=\"line\">Managers: 3</span><br><span class=\"line\">ControlAvailable: <span class=\"literal\">true</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"æŸ¥çœ‹é›†ç¾¤å†…èŠ‚ç‚¹ä¿¡æ¯\">æŸ¥çœ‹é›†ç¾¤å†…èŠ‚ç‚¹ä¿¡æ¯</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åœ¨ ä»»æ„ manager èŠ‚ç‚¹ä¸Šè¿è¡Œå¦‚ä¸‹å‘½ä»¤</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># åœ¨ manager1 ä¸Šè¿è¡Œï¼Œåˆ—å‡ºæ‰€æœ‰èŠ‚ç‚¹ä¿¡æ¯ï¼Œåªæœ‰ manager èŠ‚ç‚¹æ”¯æŒ node ç›¸å…³å‘½ä»¤</span></span><br><span class=\"line\">docker node <span class=\"built_in\">ls</span></span><br><span class=\"line\"><span class=\"comment\">## è¿è¡Œç»“æœ</span></span><br><span class=\"line\">ID                            HOSTNAME   STATUS    AVAILABILITY   MANAGER STATUS   ENGINE VERSION</span><br><span class=\"line\">kp2zerd28xgz5mmglnje0jp22 *   manager1   Ready     Active         Leader           26.1.3</span><br><span class=\"line\">oymi74epagdqeprah7s81tsa2     manager2   Ready     Active         Reachable        26.1.3</span><br><span class=\"line\">r7388xl84nczjtnf53pwh7hla     manager3   Ready     Active         Reachable        26.1.3</span><br><span class=\"line\">v31visfparkcsr9hswkb6v09u     worker1    Ready     Active                          26.1.3</span><br><span class=\"line\">lsxj50x8ftqw8etvz5y37xc5q     worker2    Ready     Active                          26.1.3</span><br></pre></td></tr></table></figure>\n<table>\n<thead>\n<tr>\n<th>å­—æ®µå</th>\n<th>ç¤ºä¾‹å€¼</th>\n<th>ä¸­æ–‡å«ä¹‰</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>ID</strong></td>\n<td><code>kp2zerd28xgz5mmglnje0jp22</code></td>\n<td>èŠ‚ç‚¹çš„å”¯ä¸€ IDï¼ˆåœ¨ swarm é›†ç¾¤ä¸­è‡ªåŠ¨ç”Ÿæˆçš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼‰</td>\n</tr>\n<tr>\n<td><strong>HOSTNAME</strong></td>\n<td><code>manager1</code></td>\n<td>èŠ‚ç‚¹çš„ä¸»æœºåï¼ˆå³åŠ å…¥ swarm é›†ç¾¤æ—¶è¯¥èŠ‚ç‚¹çš„ <code>hostname</code>ï¼‰</td>\n</tr>\n<tr>\n<td><strong>STATUS</strong></td>\n<td><code>Ready</code></td>\n<td>èŠ‚ç‚¹çš„çŠ¶æ€ï¼š<br>â€¢ <code>Ready</code>ï¼šèŠ‚ç‚¹æ­£å¸¸è¿è¡Œä¸­<br>â€¢ <code>Down</code>ï¼šèŠ‚ç‚¹ç¦»çº¿æˆ–æ— æ³•é€šä¿¡<br>â€¢ <code>Paused</code>ï¼šæš‚åœ<br>â€¢ <code>Drain</code>ï¼šæ’ç©ºï¼Œæ­£åœ¨è¿ç§»ä»»åŠ¡</td>\n</tr>\n<tr>\n<td><strong>AVAILABILITY</strong></td>\n<td><code>Active</code></td>\n<td>èŠ‚ç‚¹çš„å¯ç”¨æ€§è®¾ç½®ï¼š<br>â€¢ <code>Active</code>ï¼šèŠ‚ç‚¹å¯ä»¥è°ƒåº¦ä»»åŠ¡ï¼ˆé»˜è®¤ï¼‰<br>â€¢ <code>Pause</code>ï¼šæš‚åœè°ƒåº¦æ–°ä»»åŠ¡<br>â€¢ <code>Drain</code>ï¼šè¿ç§»ä»»åŠ¡å¹¶ä¸å†è°ƒåº¦</td>\n</tr>\n<tr>\n<td><strong>MANAGER STATUS</strong></td>\n<td><code>Leader</code> / <code>Reachable</code> / ç©º</td>\n<td>ä»…é€‚ç”¨äºç®¡ç†èŠ‚ç‚¹ï¼š<br>â€¢ <code>Leader</code>ï¼šå½“å‰ swarm çš„ä¸»èŠ‚ç‚¹ï¼ˆè´Ÿè´£åè°ƒï¼‰<br>â€¢ <code>Reachable</code>ï¼šé›†ç¾¤ä¸­å¯é€šä¿¡çš„ç®¡ç†èŠ‚ç‚¹<br>â€¢ ç©ºï¼šè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªå·¥ä½œèŠ‚ç‚¹ï¼ˆéç®¡ç†èŠ‚ç‚¹ï¼‰</td>\n</tr>\n<tr>\n<td><strong>ENGINE VERSION</strong></td>\n<td><code>26.1.3</code></td>\n<td>Docker å¼•æ“çš„ç‰ˆæœ¬å·ï¼ˆå³è¯¥èŠ‚ç‚¹ä¸Šè¿è¡Œçš„ Docker ç‰ˆæœ¬ï¼‰</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"docker-swarmé›†ç¾¤ç®¡ç†\"><code>docker swarm</code>é›†ç¾¤ç®¡ç†</h2>\n<table>\n<thead>\n<tr>\n<th>å‘½ä»¤</th>\n<th>ä¸­æ–‡å«ä¹‰</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>ca</code></td>\n<td>æ˜¾ç¤ºå’Œè½®æ¢ Swarm çš„æ ¹è¯ä¹¦ï¼ˆCAï¼‰</td>\n</tr>\n<tr>\n<td><code>init</code></td>\n<td>åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„ Swarm é›†ç¾¤</td>\n</tr>\n<tr>\n<td><code>join</code></td>\n<td>å°†å½“å‰èŠ‚ç‚¹åŠ å…¥åˆ° Swarm ä¸­ï¼Œä½œä¸ºå·¥ä½œèŠ‚ç‚¹æˆ–ç®¡ç†èŠ‚ç‚¹</td>\n</tr>\n<tr>\n<td><code>join-token</code></td>\n<td>ç®¡ç†ç”¨äºåŠ å…¥ Swarm çš„ä»¤ç‰Œï¼ˆæŸ¥çœ‹æˆ–é‡æ–°ç”Ÿæˆï¼‰</td>\n</tr>\n<tr>\n<td><code>leave</code></td>\n<td>å½“å‰èŠ‚ç‚¹ç¦»å¼€ Swarm é›†ç¾¤</td>\n</tr>\n<tr>\n<td><code>unlock</code></td>\n<td>è§£é”è¢«åŠ å¯†çš„ Swarmï¼ˆç”¨äºæ¢å¤ Manager èŠ‚ç‚¹ï¼‰</td>\n</tr>\n<tr>\n<td><code>unlock-key</code></td>\n<td>ç®¡ç† Swarm çš„è§£é”å¯†é’¥ï¼ˆæŸ¥çœ‹ã€å¤‡ä»½ç­‰ï¼‰</td>\n</tr>\n<tr>\n<td><code>update</code></td>\n<td>æ›´æ–° Swarm é›†ç¾¤çš„å…¨å±€é…ç½®ï¼ˆå¦‚åŠ å¯†ã€æ—¥å¿—ç­‰ï¼‰</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>docker swarm init</code>: åˆå§‹åŒ– Swarm é›†ç¾¤ï¼ˆåªåœ¨é¦–æ¬¡åˆ›å»ºæ—¶ä½¿ç”¨ï¼‰</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker swarm init --advertise-addr 10.211.55.10</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>docker swarm join-token</code>:  ç”ŸæˆåŠ å…¥é›†ç¾¤çš„ä»¤ç‰Œ</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ç”Ÿæˆ worker èŠ‚ç‚¹çš„ä»¤ç‰Œ</span></span><br><span class=\"line\">docker swarm join-token worker</span><br><span class=\"line\"><span class=\"comment\"># ç”Ÿæˆ manager èŠ‚ç‚¹çš„ä»¤ç‰Œ</span></span><br><span class=\"line\">docker swarm join-token manager</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>docker swarm join</code>: åŠ å…¥ Swarm é›†ç¾¤ï¼ˆåœ¨å·²æœ‰ Swarm é›†ç¾¤ä¸­åŠ å…¥èŠ‚ç‚¹æ—¶ä½¿ç”¨ï¼‰</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker swarm <span class=\"built_in\">join</span> --token &lt;token&gt; 10.211.55.10:2377</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>docker swarm leave</code>: ä½¿å½“å‰èŠ‚ç‚¹ç¦»å¼€ Swarm é›†ç¾¤ï¼ˆä» Swarm é›†ç¾¤ä¸­ç§»é™¤èŠ‚ç‚¹æ—¶ä½¿ç”¨ï¼‰</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># worker èŠ‚ç‚¹ç¦»å¼€é›†ç¾¤</span></span><br><span class=\"line\">docker swarm leave</span><br><span class=\"line\"><span class=\"comment\"># manager èŠ‚ç‚¹å¿…é¡»å…ˆé™çº§ä¸º workerèŠ‚ç‚¹ï¼Œæˆ–è€…åŠ ä¸Š --force å¼ºåˆ¶ç¦»å¼€</span></span><br><span class=\"line\">docker swarm leave --force</span><br><span class=\"line\"><span class=\"comment\"># å¦‚æœLeaderèŠ‚ç‚¹ç¦»å¼€é›†ç¾¤ï¼Œé‚£ä¹ˆé›†ç¾¤ä¸­çš„å…¶å®ƒManagerèŠ‚ç‚¹ï¼Œä¼šé‡æ–°é€‰ä¸¾ä¸€ä¸ªæ–°çš„LeaderèŠ‚ç‚¹</span></span><br><span class=\"line\"><span class=\"comment\"># é›†ç¾¤ä¸­è‡³å°‘éœ€è¦ä¸€ä¸ªManagerèŠ‚ç‚¹ï¼Œå¦åˆ™æ— æ³•è¿è¡ŒæœåŠ¡</span></span><br><span class=\"line\"><span class=\"comment\"># èŠ‚ç‚¹ç¦»å¼€swarmé›†ç¾¤åï¼Œåœ¨ docker node lsä¸­ä»ç„¶å¯ä»¥çœ‹åˆ°ï¼Œæ¯”å¦‚å°† worker2 èŠ‚ç‚¹ä»é›†ç¾¤ä¸­ç§»é™¤ï¼Œå…¶çŠ¶æ€å˜ä¸º down</span></span><br><span class=\"line\">docker node <span class=\"built_in\">ls</span></span><br><span class=\"line\">ID                            HOSTNAME   STATUS    AVAILABILITY   MANAGER STATUS   ENGINE VERSION</span><br><span class=\"line\">kp2zerd28xgz5mmglnje0jp22 *   manager1   Ready     Active         Leader           26.1.3</span><br><span class=\"line\">oymi74epagdqeprah7s81tsa2     manager2   Ready     Active         Reachable        26.1.3</span><br><span class=\"line\">r7388xl84nczjtnf53pwh7hla     manager3   Ready     Active         Reachable        26.1.3</span><br><span class=\"line\">v31visfparkcsr9hswkb6v09u     worker1    Ready     Active                          26.1.3</span><br><span class=\"line\">lsxj50x8ftqw8etvz5y37xc5q     worker2    Down      Active                          26.1.3</span><br><span class=\"line\"><span class=\"comment\"># å¦‚éœ€å½»åº•åˆ é™¤éœ€è¦è¿è¡Œ</span></span><br><span class=\"line\">docker node <span class=\"built_in\">rm</span> worker2</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>docker swarm update</code>: æ›´æ–° Swarm é›†ç¾¤é…ç½®</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># å¼€å¯Swarmé›†ç¾¤é”å®šï¼Œåªé’ˆå¯¹managerèŠ‚ç‚¹ï¼ŒmanagerèŠ‚ç‚¹é‡å¯åéœ€è¦è§£é”æ‰èƒ½æ¢å¤ï¼Œä¸‹é¢çš„å¯†é’¥ä¸éœ€è¦è®°ä½ï¼Œé€šè¿‡`docker swarm unlock-key`å‘½ä»¤æŸ¥çœ‹</span></span><br><span class=\"line\">docker swarm update --autolock=<span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡º</span></span><br><span class=\"line\">Swarm updated.</span><br><span class=\"line\">To unlock a swarm manager after it restarts, run the `docker swarm unlock`</span><br><span class=\"line\"><span class=\"built_in\">command</span> and provide the following key:</span><br><span class=\"line\"></span><br><span class=\"line\">    SWMKEY-1-X74/FGf+SkUkJEWtYok6ZFgCDAdwt3CQpOvLPT5lra4</span><br><span class=\"line\"></span><br><span class=\"line\">Please remember to store this key <span class=\"keyword\">in</span> a password manager, since without it you</span><br><span class=\"line\">will not be able to restart the manager.</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># å…³é—­Swarmé›†ç¾¤é”å®š</span></span><br><span class=\"line\">docker swarm update --autolock=<span class=\"literal\">false</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>docker swarm unlock-key</code>: è·å–Swarmé›†ç¾¤çš„è§£é”å¯†é’¥ï¼Œè¯¥å‘½ä»¤å¯ä»¥åˆ¤æ–­Swarmé›†ç¾¤æ˜¯å¦è¢«é”å®š</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># è·å–Swarmé›†ç¾¤çš„è§£é”å¯†é’¥</span></span><br><span class=\"line\">docker swarm unlock-key</span><br><span class=\"line\"><span class=\"comment\"># è½®æ¢Swarmé›†ç¾¤çš„è§£é”å¯†é’¥</span></span><br><span class=\"line\">docker swarm unlock-key --rotate</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>docker swarm unlock</code>: æ‰‹åŠ¨è§£é”å½“å‰ manager èŠ‚ç‚¹ï¼Œä½¿å…¶åœ¨å¯ç”¨ autolock æ—¶æ¢å¤åŠŸèƒ½</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># å¦‚æœSwarmé›†ç¾¤è®¾ç½®ä¸ºé”å®šï¼Œåˆ™é‡å¯manager2ä¸Šçš„dockeræœåŠ¡åå°†æ— æ³•è¿è¡Œnodeç®¡ç†å‘½ä»¤</span></span><br><span class=\"line\">systemctl restart docker</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹èŠ‚ç‚¹åˆ—è¡¨</span></span><br><span class=\"line\">docker node <span class=\"built_in\">ls</span></span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡º</span></span><br><span class=\"line\">Error response from daemon: Swarm is encrypted and needs to be unlocked before it can be used. Please use <span class=\"string\">&quot;docker swarm unlock&quot;</span> to unlock it.</span><br><span class=\"line\"><span class=\"comment\"># éœ€è¦å…ˆè§£é”æ‰å¯ä»¥è¿è¡ŒèŠ‚ç‚¹ç®¡ç†å‘½ä»¤</span></span><br><span class=\"line\">docker swarm unlock</span><br><span class=\"line\"><span class=\"comment\">## ä¼šæç¤ºè¾“å…¥è§£é”å¯†é’¥ï¼Œè§£é”åå°±æ¢å¤æ­£å¸¸äº†</span></span><br><span class=\"line\">Please enter unlock key:</span><br></pre></td></tr></table></figure>\n<h2 id=\"docker-nodeèŠ‚ç‚¹ç®¡ç†\"><code>docker node</code>èŠ‚ç‚¹ç®¡ç†</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>èŠ‚ç‚¹ç®¡ç†ç›¸å…³å‘½ä»¤ï¼Œåªèƒ½åœ¨ ç®¡ç†èŠ‚ç‚¹ ä¸Šæ‰§è¡Œ</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>å‘½ä»¤</th>\n<th>ä¸­æ–‡å«ä¹‰</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>demote</code></td>\n<td>å°†ä¸€ä¸ªæˆ–å¤šä¸ªç®¡ç†èŠ‚ç‚¹é™çº§ä¸ºå·¥ä½œèŠ‚ç‚¹</td>\n</tr>\n<tr>\n<td><code>inspect</code></td>\n<td>æ˜¾ç¤ºä¸€ä¸ªæˆ–å¤šä¸ªèŠ‚ç‚¹çš„è¯¦ç»†ä¿¡æ¯</td>\n</tr>\n<tr>\n<td><code>ls</code></td>\n<td>åˆ—å‡º swarm é›†ç¾¤ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹</td>\n</tr>\n<tr>\n<td><code>promote</code></td>\n<td>å°†ä¸€ä¸ªæˆ–å¤šä¸ªå·¥ä½œèŠ‚ç‚¹æå‡ä¸ºç®¡ç†èŠ‚ç‚¹</td>\n</tr>\n<tr>\n<td><code>ps</code></td>\n<td>æŸ¥çœ‹ä¸€ä¸ªæˆ–å¤šä¸ªèŠ‚ç‚¹ä¸Šæ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ï¼ˆé»˜è®¤å½“å‰èŠ‚ç‚¹ï¼‰</td>\n</tr>\n<tr>\n<td><code>rm</code></td>\n<td>ä» swarm é›†ç¾¤ä¸­ç§»é™¤ä¸€ä¸ªæˆ–å¤šä¸ªèŠ‚ç‚¹</td>\n</tr>\n<tr>\n<td><code>update</code></td>\n<td>æ›´æ–°èŠ‚ç‚¹çš„å…ƒæ•°æ®ï¼ˆå¦‚æ ‡ç­¾ã€å¯ç”¨æ€§ç­‰ï¼‰</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>docker node ls</code>: åˆ—å‡º swarm é›†ç¾¤ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker node <span class=\"built_in\">ls</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>docker node inspect &lt;node_id&gt;/&lt;hostname&gt;</code>: æŸ¥çœ‹æŒ‡å®šèŠ‚ç‚¹çš„è¯¦ç»†ä¿¡æ¯</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker node inspect --pretty manager1</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>docker node update &lt;options&gt; &lt;node_id&gt;/&lt;hostname&gt;</code>: æ›´æ–°èŠ‚ç‚¹çš„å…ƒæ•°æ®</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># è®¾ç½®èŠ‚ç‚¹ä¸ºä¸å¯ç”¨</span></span><br><span class=\"line\">docker node update --availability drain manager1</span><br><span class=\"line\"><span class=\"comment\"># æ·»åŠ æ ‡ç­¾</span></span><br><span class=\"line\">docker node update --label-add foo=bar manager1</span><br><span class=\"line\"><span class=\"comment\"># åˆ é™¤æ ‡ç­¾</span></span><br><span class=\"line\">docker node update --label-rm foo manager1</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>docker node demote &lt;node_id&gt;/&lt;hostname&gt;</code>: å°†ç®¡ç†èŠ‚ç‚¹é™çº§ä¸ºå·¥ä½œèŠ‚ç‚¹</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker node demote manager1</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>docker note promote &lt;node_id&gt;/&lt;hostname&gt;</code>: å°†å·¥ä½œèŠ‚ç‚¹å‡çº§ä¸ºç®¡ç†èŠ‚ç‚¹</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker node promote worker1</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>docker node rm &lt;node_id&gt;/&lt;hostname&gt;</code>: ä» swarm é›†ç¾¤ä¸­ç§»é™¤ä¸€ä¸ªèŠ‚ç‚¹</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker node <span class=\"built_in\">rm</span> manager1</span><br></pre></td></tr></table></figure>\n<h2 id=\"èŠ‚ç‚¹ç®¡ç†å¸¸è§æƒ…å†µ\">èŠ‚ç‚¹ç®¡ç†å¸¸è§æƒ…å†µ</h2>\n<h3 id=\"å¦‚ä½•æ­£ç¡®çš„åˆ é™¤ä¸€ä¸ªèŠ‚ç‚¹\">å¦‚ä½•æ­£ç¡®çš„åˆ é™¤ä¸€ä¸ªèŠ‚ç‚¹</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>1.å¦‚æœæ˜¯ manager èŠ‚ç‚¹ï¼Œå…ˆå°† manager èŠ‚ç‚¹é™çº§ä¸º worker èŠ‚ç‚¹</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker node demote manager1</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>2.é€€å‡ºé›†ç¾¤</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># åœ¨è¦é€€å‡ºé›†ç¾¤çš„èŠ‚ç‚¹ä¸Šæ‰§è¡Œ</span></span><br><span class=\"line\">docker swarm leave</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>3.åˆ é™¤èŠ‚ç‚¹</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker node <span class=\"built_in\">rm</span> manager1</span><br></pre></td></tr></table></figure>\n<h3 id=\"èŠ‚ç‚¹è¢«é€€ç¾¤æˆ–åˆ é™¤åï¼Œå…¶ä¸Šè¿è¡Œçš„serviceä¼šæ€æ ·ï¼Ÿ\">èŠ‚ç‚¹è¢«é€€ç¾¤æˆ–åˆ é™¤åï¼Œå…¶ä¸Šè¿è¡Œçš„serviceä¼šæ€æ ·ï¼Ÿ</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ç”¨ä¸€ä¸ªç¤ºä¾‹æ¥è¯´æ˜ï¼Œå…ˆåœ¨ manager1 èŠ‚ç‚¹ä¸Šåˆ›å»ºä¸€ä¸ª service</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># --replicas 10 è¡¨ç¤ºå¯åŠ¨ 10 ä¸ª nginx å®¹å™¨ï¼Œswarmé›†ç¾¤æœ‰5ä¸ªèŠ‚ç‚¹ï¼Œæ‰€ä»¥å¯åŠ¨10ä¸ªnginxå®¹å™¨ï¼Œæ¯ä¸ªèŠ‚ç‚¹ä¼šå¯åŠ¨2ä¸ªnginxå®¹å™¨</span></span><br><span class=\"line\">docker service create \\</span><br><span class=\"line\">  --name my-nginx \\</span><br><span class=\"line\">  --publish 8080:80 \\</span><br><span class=\"line\">  --replicas 10 \\</span><br><span class=\"line\">  nginx:latest</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æŸ¥çœ‹serviceçŠ¶æ€</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker service ps my-nginx</span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡ºç»“æœï¼Œå¯ä»¥çœ‹åˆ°æ¯ä¸ªèŠ‚ç‚¹ä¸Šéƒ½å¯åŠ¨äº†2ä¸ªnginxå®¹å™¨</span></span><br><span class=\"line\">ID             NAME          IMAGE          NODE       DESIRED STATE   CURRENT STATE                ERROR     PORTS</span><br><span class=\"line\">fciheo523fb3   my-nginx.1    nginx:latest   manager2   Running         Running about a minute ago</span><br><span class=\"line\">t9agioefr316   my-nginx.2    nginx:latest   manager2   Running         Running about a minute ago</span><br><span class=\"line\">moitlj50nunh   my-nginx.3    nginx:latest   manager3   Running         Running 2 minutes ago</span><br><span class=\"line\">x07voc2qth5q   my-nginx.4    nginx:latest   manager1   Running         Running about a minute ago</span><br><span class=\"line\">p8khdhngz0xm   my-nginx.5    nginx:latest   manager3   Running         Running 2 minutes ago</span><br><span class=\"line\">i6mieuodbrtg   my-nginx.6    nginx:latest   worker2    Running         Running about a minute ago</span><br><span class=\"line\">2yohffzzsrrl   my-nginx.7    nginx:latest   worker1    Running         Running 2 minutes ago</span><br><span class=\"line\">f3lusxoflqn2   my-nginx.8    nginx:latest   worker2    Running         Running about a minute ago</span><br><span class=\"line\">xovzfmzsjlet   my-nginx.9    nginx:latest   worker1    Running         Running 2 minutes ago</span><br><span class=\"line\">ndrz827kpu2k   my-nginx.10   nginx:latest   manager1   Running         Running about a minute ago</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>è¿™æ—¶å°† worker2 ä»é›†ç¾¤ä¸­é€€ç¾¤</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># åœ¨worker2èŠ‚ç‚¹æ‰§è¡Œ</span></span><br><span class=\"line\">docker swarm leave</span><br><span class=\"line\"><span class=\"comment\"># åœ¨managerèŠ‚ç‚¹æŸ¥çœ‹é›†ç¾¤èŠ‚ç‚¹</span></span><br><span class=\"line\">docker node <span class=\"built_in\">ls</span></span><br><span class=\"line\">ID                            HOSTNAME   STATUS    AVAILABILITY   MANAGER STATUS   ENGINE VERSION</span><br><span class=\"line\">kp2zerd28xgz5mmglnje0jp22 *   manager1   Ready     Active         Leader           26.1.3</span><br><span class=\"line\">oymi74epagdqeprah7s81tsa2     manager2   Ready     Active         Reachable        26.1.3</span><br><span class=\"line\">r7388xl84nczjtnf53pwh7hla     manager3   Ready     Active         Reachable        26.1.3</span><br><span class=\"line\">v31visfparkcsr9hswkb6v09u     worker1    Ready     Active                          26.1.3</span><br><span class=\"line\">x87lfn4pzorahpr9zehv9ag3f     worker2    Down      Active                          26.1.3</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å†æ¬¡æŸ¥çœ‹serviceçŠ¶æ€</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker service ps my-nginx</span><br><span class=\"line\"><span class=\"comment\"># è¾“å‡ºï¼Œå¯ä»¥çœ‹åˆ°worker2èŠ‚ç‚¹ä¸Šçš„å®¹å™¨å·²ç»è¢«å…³é—­ï¼Œæ–°çš„å®¹å™¨åœ¨å…¶å®ƒèŠ‚ç‚¹ä¸Šå¯åŠ¨äº†ï¼Œä¿è¯äº†serviceä¸­çš„å®¹å™¨æ•°é‡</span></span><br><span class=\"line\">ID             NAME             IMAGE          NODE       DESIRED STATE   CURRENT STATE            ERROR     PORTS</span><br><span class=\"line\">fciheo523fb3   my-nginx.1       nginx:latest   manager2   Running         Running 6 minutes ago</span><br><span class=\"line\">t9agioefr316   my-nginx.2       nginx:latest   manager2   Running         Running 6 minutes ago</span><br><span class=\"line\">moitlj50nunh   my-nginx.3       nginx:latest   manager3   Running         Running 6 minutes ago</span><br><span class=\"line\">x07voc2qth5q   my-nginx.4       nginx:latest   manager1   Running         Running 6 minutes ago</span><br><span class=\"line\">p8khdhngz0xm   my-nginx.5       nginx:latest   manager3   Running         Running 6 minutes ago</span><br><span class=\"line\">uz7wam5ul4aa   my-nginx.6       nginx:latest   manager2   Running         Running 43 seconds ago</span><br><span class=\"line\">i6mieuodbrtg    \\_ my-nginx.6   nginx:latest   worker2    Shutdown        Running 6 minutes ago</span><br><span class=\"line\">2yohffzzsrrl   my-nginx.7       nginx:latest   worker1    Running         Running 6 minutes ago</span><br><span class=\"line\">34km8mzg3xat   my-nginx.8       nginx:latest   manager3   Running         Running 43 seconds ago</span><br><span class=\"line\">f3lusxoflqn2    \\_ my-nginx.8   nginx:latest   worker2    Shutdown        Running 6 minutes ago</span><br><span class=\"line\">xovzfmzsjlet   my-nginx.9       nginx:latest   worker1    Running         Running 6 minutes ago</span><br><span class=\"line\">ndrz827kpu2k   my-nginx.10      nginx:latest   manager1   Running         Running 6 minutes ago</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å¦‚æœä¸é€€ç¾¤ç›´æ¥åˆ é™¤èŠ‚ç‚¹å‘¢ï¼Ÿè¿™æ¬¡æˆ‘ä»¬ç›´æ¥åˆ é™¤ worker1 èŠ‚ç‚¹</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># åˆ é™¤ worker1 èŠ‚ç‚¹</span></span><br><span class=\"line\">docker node <span class=\"built_in\">rm</span> worker1</span><br><span class=\"line\"><span class=\"comment\"># è¾“å‡ºï¼Œæç¤º worker1 èŠ‚ç‚¹ä¸æ˜¯ down çŠ¶æ€ï¼Œä¸èƒ½åˆ é™¤</span></span><br><span class=\"line\"><span class=\"comment\"># Error response from daemon: rpc error: code = FailedPrecondition desc = node v31visfparkcsr9hswkb6v09u is not down and can&#x27;t be removed</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æ¥ç€æˆ‘ä»¬å¼ºåˆ¶åˆ é™¤</span></span><br><span class=\"line\">docker node <span class=\"built_in\">rm</span> -f worker1</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹èŠ‚ç‚¹åˆ—è¡¨</span></span><br><span class=\"line\">docker node <span class=\"built_in\">ls</span></span><br><span class=\"line\"><span class=\"comment\"># è¾“å‡ºï¼Œå¯ä»¥çœ‹åˆ°worker1èŠ‚ç‚¹å·²ç»åˆ é™¤äº†</span></span><br><span class=\"line\">ID                            HOSTNAME   STATUS    AVAILABILITY   MANAGER STATUS   ENGINE VERSION</span><br><span class=\"line\">kp2zerd28xgz5mmglnje0jp22 *   manager1   Ready     Active         Leader           26.1.3</span><br><span class=\"line\">oymi74epagdqeprah7s81tsa2     manager2   Ready     Active         Reachable        26.1.3</span><br><span class=\"line\">r7388xl84nczjtnf53pwh7hla     manager3   Ready     Active         Reachable        26.1.3</span><br><span class=\"line\">x87lfn4pzorahpr9zehv9ag3f     worker2    Down      Active                          26.1.3</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># å†æ¬¡æŸ¥çœ‹serviceçŠ¶æ€</span></span><br><span class=\"line\">docker service ps my-nginx</span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡ºï¼Œå¯ä»¥çœ‹åˆ°worker1(å› ä¸ºworker1èŠ‚ç‚¹å·²ç»è¢«åˆ é™¤ï¼Œæ‰€ä»¥è¿™é‡Œåªä¼šæ˜¾ç¤ºèŠ‚ç‚¹ID:v31visfparkcsr9hswkb6v09u)èŠ‚ç‚¹ä¸Šçš„å®¹å™¨å·²ç»è¢«å…³é—­ï¼Œæ–°çš„å®¹å™¨åœ¨å…¶å®ƒèŠ‚ç‚¹ä¸Šå¯åŠ¨äº†ï¼Œä¿è¯äº†serviceä¸­çš„å®¹å™¨æ•°é‡</span></span><br><span class=\"line\">docker service ps my-nginx</span><br><span class=\"line\">ID             NAME             IMAGE          NODE                        DESIRED STATE   CURRENT STATE                 ERROR     PORTS</span><br><span class=\"line\">fciheo523fb3   my-nginx.1       nginx:latest   manager2                    Running         Running 12 minutes ago</span><br><span class=\"line\">t9agioefr316   my-nginx.2       nginx:latest   manager2                    Running         Running 12 minutes ago</span><br><span class=\"line\">moitlj50nunh   my-nginx.3       nginx:latest   manager3                    Running         Running 12 minutes ago</span><br><span class=\"line\">x07voc2qth5q   my-nginx.4       nginx:latest   manager1                    Running         Running 12 minutes ago</span><br><span class=\"line\">p8khdhngz0xm   my-nginx.5       nginx:latest   manager3                    Running         Running 12 minutes ago</span><br><span class=\"line\">uz7wam5ul4aa   my-nginx.6       nginx:latest   manager2                    Running         Running 6 minutes ago</span><br><span class=\"line\">i6mieuodbrtg    \\_ my-nginx.6   nginx:latest   worker2                     Shutdown        Running 12 minutes ago</span><br><span class=\"line\">3t4qvpvrzpg3   my-nginx.7       nginx:latest   manager1                    Running         Running about a minute ago</span><br><span class=\"line\">2yohffzzsrrl    \\_ my-nginx.7   nginx:latest   v31visfparkcsr9hswkb6v09u   Shutdown        Orphaned about a minute ago</span><br><span class=\"line\">34km8mzg3xat   my-nginx.8       nginx:latest   manager3                    Running         Running 6 minutes ago</span><br><span class=\"line\">f3lusxoflqn2    \\_ my-nginx.8   nginx:latest   worker2                     Shutdown        Running 12 minutes ago</span><br><span class=\"line\">4w5zfpfye3t8   my-nginx.9       nginx:latest   manager1                    Running         Running about a minute ago</span><br><span class=\"line\">xovzfmzsjlet    \\_ my-nginx.9   nginx:latest   v31visfparkcsr9hswkb6v09u   Shutdown        Orphaned about a minute ago</span><br><span class=\"line\">ndrz827kpu2k   my-nginx.10      nginx:latest   manager1                    Running         Running 12 minutes ago</span><br></pre></td></tr></table></figure>\n<h3 id=\"èŠ‚ç‚¹è¢«é€€ç¾¤æˆ–åˆ é™¤åæ˜¯å¦å¯ä»¥é‡æ–°åŠ å…¥é›†ç¾¤\">èŠ‚ç‚¹è¢«é€€ç¾¤æˆ–åˆ é™¤åæ˜¯å¦å¯ä»¥é‡æ–°åŠ å…¥é›†ç¾¤</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>èŠ‚ç‚¹è¢«é€€ç¾¤æˆ–åˆ é™¤åï¼Œå¯ä»¥é€šè¿‡ <code>docker swarm join</code> å‘½ä»¤é‡æ–°åŠ å…¥é›†ç¾¤</p>\n</li>\n<li class=\"lvl-2\">\n<p>è‹¥èŠ‚ç‚¹æ˜¯è¢«å¼ºåˆ¶åˆ é™¤ï¼Œè€Œæ²¡æœ‰é€€ç¾¤ï¼Œåˆ™é‡æ–°åŠ å…¥é›†ç¾¤æ—¶éœ€è¦å…ˆé€šè¿‡ <code>docker swarm leave</code> å‘½ä»¤é€€ç¾¤åå†åŠ å…¥é›†ç¾¤</p>\n</li>\n</ul>\n<h3 id=\"å¦‚æœSwarmé›†ç¾¤è®¾ç½®ä¸ºé”å®šï¼Œåˆ™é‡å¯managerèŠ‚ç‚¹åæ— æ³•æä¾›é›†ç¾¤æœåŠ¡çš„è§£å†³æ–¹æ³•\">å¦‚æœSwarmé›†ç¾¤è®¾ç½®ä¸ºé”å®šï¼Œåˆ™é‡å¯managerèŠ‚ç‚¹åæ— æ³•æä¾›é›†ç¾¤æœåŠ¡çš„è§£å†³æ–¹æ³•</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># è¿™é‡Œé‡å¯ä¸€ä¸ªmanagerèŠ‚ç‚¹çš„dockeræœåŠ¡</span></span><br><span class=\"line\">systemctl restart docker</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹èŠ‚ç‚¹åˆ—è¡¨</span></span><br><span class=\"line\">docker node <span class=\"built_in\">ls</span></span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡º</span></span><br><span class=\"line\">Error response from daemon: Swarm is encrypted and needs to be unlocked before it can be used. Please use <span class=\"string\">&quot;docker swarm unlock&quot;</span> to unlock it.</span><br><span class=\"line\"><span class=\"comment\"># éœ€è¦å…ˆè§£é”æ‰å¯ä»¥è¿è¡ŒèŠ‚ç‚¹ç®¡ç†å‘½ä»¤</span></span><br><span class=\"line\">docker swarm unlock</span><br><span class=\"line\"><span class=\"comment\">## ä¼šæç¤ºè¾“å…¥è§£é”å¯†é’¥ï¼Œè§£é”åå°±æ¢å¤æ­£å¸¸äº†</span></span><br><span class=\"line\">Please enter unlock key:</span><br><span class=\"line\"><span class=\"comment\">## å¦‚æœå¿˜è®°äº†å¯†é’¥ï¼Œå¯ä»¥åœ¨å…¶å®ƒmanagerèŠ‚ç‚¹é€šè¿‡å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹</span></span><br><span class=\"line\">docker swarm unlock-key</span><br><span class=\"line\"><span class=\"comment\"># å¦‚æœæ‰€æœ‰managerèŠ‚ç‚¹éƒ½é‡å¯äº†ï¼Œä½ åˆæ²¡æœ‰è®°å½•è§£é”å¯†é’¥ï¼Œé‚£ä¹ˆæ­å–œä½ ï¼Œåªèƒ½é‡æ–°åˆ›å»ºswarmé›†ç¾¤äº†</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"Swarm-é›†ç¾¤é”å®šåŠŸèƒ½çš„ä½œç”¨åŠä½¿ç”¨åœºæ™¯\">Swarm é›†ç¾¤é”å®šåŠŸèƒ½çš„ä½œç”¨åŠä½¿ç”¨åœºæ™¯</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ä½œç”¨</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>âœ… ä½œç”¨</th>\n<th>ğŸ“‹ è¯´æ˜</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>åŠ å¯†ä¿æŠ¤ç®¡ç†å¯†é’¥</td>\n<td>ç®¡ç†å™¨èŠ‚ç‚¹ä¹‹é—´çš„æ•°æ®ï¼ˆå¦‚ Raft æ—¥å¿—ï¼‰è™½ç„¶é»˜è®¤åŠ å¯†ï¼Œä½†å¯†é’¥ä¿å­˜åœ¨å†…å­˜ä¸­ã€‚å¯ç”¨é”å®šåŠŸèƒ½åï¼Œå¯†é’¥åœ¨èŠ‚ç‚¹é‡å¯æ—¶ä¸ä¼šè‡ªåŠ¨åŠ è½½ï¼Œå¿…é¡»æ‰‹åŠ¨æä¾›è§£é”å¯†é’¥æ‰èƒ½æ¢å¤ã€‚</td>\n</tr>\n<tr>\n<td>é˜²æ­¢èŠ‚ç‚¹è¢«éæ³•é‡å¯ååŠ å…¥é›†ç¾¤</td>\n<td>å¦‚æœæ”»å‡»è€…è·å¾—äº†ç®¡ç†èŠ‚ç‚¹çš„ç‰©ç†è®¿é—®æƒé™ï¼ˆå¦‚é‡å¯ã€ç£ç›˜å…‹éš†ç­‰ï¼‰ï¼Œé”å®šåŠŸèƒ½å¯ä»¥é˜²æ­¢å…¶è‡ªåŠ¨æ§åˆ¶æˆ–é‡æ–°åŠ å…¥ Swarm é›†ç¾¤ã€‚</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åœºæ™¯</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>åœºæ™¯ç±»å‹</th>\n<th>å…·ä½“æè¿°</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>âœ… é€‚åˆåœºæ™¯</td>\n<td>å¯¹å®‰å…¨æ€§è¦æ±‚é«˜çš„ç”Ÿäº§ç¯å¢ƒ</td>\n</tr>\n<tr>\n<td></td>\n<td>éƒ¨ç½²åœ¨ä¸å¯ä¿¡æˆ–å…±äº«ç‰©ç†ç¯å¢ƒä¸­</td>\n</tr>\n<tr>\n<td></td>\n<td>äº‘æœåŠ¡å™¨ã€æ•°æ®ä¸­å¿ƒæœ‰ä¸“äººè¿ç»´ç®¡ç†è§£é”è¿‡ç¨‹</td>\n</tr>\n<tr>\n<td></td>\n<td>å¸Œæœ›é˜²æ­¢ç‰©ç†/è¿œç¨‹å…¥ä¾µè€…æ¢å¤ç®¡ç†å™¨è§’è‰²çš„å…¬å¸</td>\n</tr>\n<tr>\n<td>âŒ ä¸é€‚åˆåœºæ™¯</td>\n<td>éœ€è¦è‡ªåŠ¨åŒ–éƒ¨ç½²æˆ–é‡å¯çš„ CI/CD ç³»ç»Ÿ</td>\n</tr>\n<tr>\n<td></td>\n<td>æµ‹è¯•ç¯å¢ƒæˆ–å¼€å‘é›†ç¾¤</td>\n</tr>\n<tr>\n<td></td>\n<td>æ— äººå€¼å®ˆã€è¦æ±‚é«˜å¯ç”¨è‡ªåŠ¨æ¢å¤çš„éƒ¨ç½²ç³»ç»Ÿ</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æ€»ç»“</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>é¡¹ç›®</th>\n<th>æ˜¯å¦æ¨è</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>å®‰å…¨æ€§</td>\n<td>âœ… å¼ºçƒˆæ¨èå¯ç”¨ï¼ˆå°¤å…¶åœ¨ç”Ÿäº§ç¯å¢ƒï¼‰</td>\n</tr>\n<tr>\n<td>è‡ªåŠ¨åŒ–</td>\n<td>âŒ ä¸æ¨èï¼ˆå¢åŠ äººå·¥å¹²é¢„æ­¥éª¤ï¼‰</td>\n</tr>\n<tr>\n<td>è§£é”æ–¹å¼</td>\n<td>è§£é”å‘½ä»¤ + unlock key</td>\n</tr>\n<tr>\n<td>unlock key ä¸¢å¤±åæœ</td>\n<td>å¯èƒ½éœ€è¦é‡å»º Swarmï¼ˆé™¤éæå‰å¤‡ä»½ï¼‰</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"docker-swarm-ca-æ˜¯åšä»€ä¹ˆç”¨çš„ï¼Ÿ\"><code>docker swarm ca</code> æ˜¯åšä»€ä¹ˆç”¨çš„ï¼Ÿ</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>docker swarm ca</code> å‘½ä»¤æ˜¯ç”¨æ¥ <strong>ç®¡ç† Swarm é›†ç¾¤ä¸­çš„æ ¹è¯ä¹¦é¢å‘æœºæ„ï¼ˆCAï¼‰</strong> çš„å·¥å…·ã€‚å…·ä½“åŠŸèƒ½åŒ…æ‹¬ï¼š</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>å­å‘½ä»¤/å‚æ•°</th>\n<th>è¯´æ˜</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>docker swarm ca</code></td>\n<td>æŸ¥çœ‹å½“å‰ Swarm çš„æ ¹ CA å…¬é’¥ï¼ˆPEM æ ¼å¼ï¼‰</td>\n</tr>\n<tr>\n<td><code>docker swarm ca --rotate</code></td>\n<td>è½®æ¢æ ¹ CAï¼Œç”¨äºå®‰å…¨æ›´æ–°</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Swarm ä¸­çš„è¯ä¹¦æ˜¯å¹²ä»€ä¹ˆç”¨çš„ï¼Ÿ</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>ç”¨é€”</th>\n<th>è¯´æ˜</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>âœ… èŠ‚ç‚¹èº«ä»½éªŒè¯</td>\n<td>æ¯ä¸ªèŠ‚ç‚¹åŠ å…¥é›†ç¾¤æ—¶ï¼Œéƒ½ä¼šæ”¶åˆ°ä¸€ä¸ªç”±æ ¹ CA ç­¾å‘çš„ TLS è¯ä¹¦ï¼Œç”¨äºè¯æ˜å®ƒçš„èº«ä»½ã€‚</td>\n</tr>\n<tr>\n<td>ğŸ” é€šä¿¡åŠ å¯†</td>\n<td>èŠ‚ç‚¹ä¹‹é—´ï¼ˆManager â†” Workerï¼‰çš„é€šä¿¡é€šè¿‡ TLS è¿›è¡ŒåŠ å¯†ã€‚</td>\n</tr>\n<tr>\n<td>ğŸ”„ è‡ªåŠ¨è½®æ¢</td>\n<td>Docker ä¼šè‡ªåŠ¨ä¸ºæ¯ä¸ªèŠ‚ç‚¹ç­¾å‘çŸ­æœŸè¯ä¹¦ï¼ˆé»˜è®¤æœ‰æ•ˆæœŸ 90 å¤©ï¼‰å¹¶å®šæœŸè‡ªåŠ¨è½®æ¢ã€‚</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Swarm åœ¨åå°è‡ªåŠ¨ç®¡ç†è¯ä¹¦ï¼Œæ‰€ä»¥ä½ ä¸éœ€è¦æ‰‹åŠ¨å¤„ç†å®ƒä»¬ã€‚ä¸è¿‡ï¼Œä½ å¯ä»¥åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šæ‰¾åˆ°å®ƒä»¬çš„ä½ç½®ï¼š</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> /var/lib/docker/swarm/certificates</span><br><span class=\"line\">tree</span><br><span class=\"line\">.</span><br><span class=\"line\">â”œâ”€â”€ swarm-node.crt      <span class=\"comment\"># èŠ‚ç‚¹è¯ä¹¦</span></span><br><span class=\"line\">â”œâ”€â”€ swarm-node.key      <span class=\"comment\"># èŠ‚ç‚¹å¯†é’¥</span></span><br><span class=\"line\">â””â”€â”€ swarm-root-ca.crt   <span class=\"comment\"># æ ¹CAè¯ä¹¦</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"åªè®©-Manager-åšç®¡ç†ï¼Œä¸è¿è¡ŒæœåŠ¡\">åªè®© Manager åšç®¡ç†ï¼Œä¸è¿è¡ŒæœåŠ¡</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>èŠ‚ç‚¹çš„<code>AVAILABILITY</code>æœ‰ä¸‰ç§ï¼š<code>active</code>ã€<code>pause</code>ã€<code>drain</code>ã€‚</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>çŠ¶æ€</th>\n<th>è¯´æ˜</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>active</code></td>\n<td>å¯è°ƒåº¦ï¼ŒSwarm å¯ä»¥åœ¨æ­¤èŠ‚ç‚¹ä¸Šè¿è¡ŒæœåŠ¡ä»»åŠ¡ï¼ˆé»˜è®¤ï¼‰</td>\n</tr>\n<tr>\n<td><code>pause</code></td>\n<td>æš‚åœè°ƒåº¦ï¼Œä¸ä¼šåˆ†é…æ–°ä»»åŠ¡ï¼Œä½†ä¿ç•™å·²æœ‰ä»»åŠ¡</td>\n</tr>\n<tr>\n<td><code>drain</code></td>\n<td>æ’ç©ºæ¨¡å¼ï¼Œä¸å¯è°ƒåº¦ï¼ŒSwarm ä¼šå°†è¯¥èŠ‚ç‚¹ä¸Šçš„ä»»åŠ¡è¿ç§»åˆ°å…¶ä»–èŠ‚ç‚¹ï¼Œæ–°çš„ä»»åŠ¡å°†ä¸ä¼šåˆ†é…åˆ°æ­¤èŠ‚ç‚¹</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å¦‚æœä½ å¸Œæœ› Swarm Manager èŠ‚ç‚¹ä»…å‚ä¸ç®¡ç†å·¥ä½œï¼Œè€Œä¸è¿è¡ŒæœåŠ¡ä»»åŠ¡ï¼ˆtaskï¼‰ï¼Œä½ å¯ä»¥é€šè¿‡ è®¾ç½®èŠ‚ç‚¹çš„å¯è°ƒåº¦çŠ¶æ€ä¸ºâ€œä¸å¯è°ƒåº¦â€ æ¥å®ç°è¿™ä¸€ç›®æ ‡ã€‚</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># è®¾ç½® manager1 èŠ‚ç‚¹ä¸ºâ€œä¸å¯è°ƒåº¦â€ï¼Œå³ æ’ç©ºæ¨¡å¼</span></span><br><span class=\"line\">docker node update --availability drain manager1</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€</span></span><br><span class=\"line\">docker node <span class=\"built_in\">ls</span></span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡ºï¼Œmanager1 èŠ‚ç‚¹çŠ¶æ€å˜ä¸º æ’ç©º</span></span><br><span class=\"line\">ID                            HOSTNAME   STATUS    AVAILABILITY   MANAGER STATUS   ENGINE VERSION</span><br><span class=\"line\">kp2zerd28xgz5mmglnje0jp22 *   manager1   Ready     Drain          Reachable        26.1.3</span><br><span class=\"line\">oymi74epagdqeprah7s81tsa2     manager2   Ready     Active         Reachable        26.1.3</span><br><span class=\"line\">r7388xl84nczjtnf53pwh7hla     manager3   Ready     Active         Leader           26.1.3</span><br><span class=\"line\">xkww4853bbdgv7bv8771xibob     worker1    Ready     Active                          26.1.3</span><br><span class=\"line\">hvzkh3ip5ef8gx973z1ywahbu     worker2    Ready     Active                          26.1.3</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹æœåŠ¡çŠ¶æ€</span></span><br><span class=\"line\">docker service ps my-nginx</span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡ºï¼Œå¯ä»¥çœ‹åˆ° manager1 èŠ‚ç‚¹ä¸Šçš„ä»»åŠ¡å·²ç»å…³é—­ï¼Œå¹¶ä¸”åœ¨å…¶å®ƒèŠ‚ç‚¹ä¸Šè¿è¡Œäº†ä»»åŠ¡ã€‚</span></span><br><span class=\"line\">ID             NAME             IMAGE          NODE       DESIRED STATE   CURRENT STATE                    ERROR     PORTS</span><br><span class=\"line\">23m03nj54mzo   my-nginx.1       nginx:latest   worker2    Running         Running 35 seconds ago</span><br><span class=\"line\">9xi83bnh4fus   my-nginx.2       nginx:latest   worker2    Running         Running 35 seconds ago</span><br><span class=\"line\">wos8tbk449lk   my-nginx.3       nginx:latest   manager2   Running         Running 28 seconds ago</span><br><span class=\"line\">uosmuh6bvwm0    \\_ my-nginx.3   nginx:latest   manager1   Shutdown        Shutdown 7 seconds ago</span><br><span class=\"line\">yeqhqc3f735y   my-nginx.4       nginx:latest   manager2   Running         Running about a minute ago</span><br><span class=\"line\">g8rduix7s74v   my-nginx.5       nginx:latest   worker2    Running         Running less than a second ago</span><br><span class=\"line\">wuxilgpv9f50    \\_ my-nginx.5   nginx:latest   manager1   Shutdown        Shutdown 7 seconds ago</span><br><span class=\"line\">3bxtn9boit28   my-nginx.6       nginx:latest   manager3   Running         Running 28 seconds ago</span><br><span class=\"line\">57kdggaf8sag   my-nginx.7       nginx:latest   manager2   Running         Running about a minute ago</span><br><span class=\"line\">uugi506p74s8   my-nginx.8       nginx:latest   worker1    Running         Running 28 seconds ago</span><br><span class=\"line\">yifwpqjnts9l   my-nginx.9       nginx:latest   worker1    Running         Running 28 seconds ago</span><br><span class=\"line\">yv4p6su7aom5   my-nginx.10      nginx:latest   manager3   Running         Running 28 seconds ago</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æ¢å¤è¿è¡Œä»»åŠ¡èƒ½åŠ›</span></span><br><span class=\"line\">docker node update --availability active manager1</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># åœæ­¢æ¥æ”¶æ–°çš„ä»»åŠ¡ä½†ä¿ç•™è¿è¡Œä¸­çš„ä»»åŠ¡</span></span><br><span class=\"line\">docker node update --availability pause manager1</span><br></pre></td></tr></table></figure>\n","content_text":"æ‘˜è¦ æœ¬æ–‡ä»‹ç» Docker Swarm çš„ èŠ‚ç‚¹ç®¡ç† Dockerå®˜æ–¹æ–‡æ¡£ Docker Swarm å®˜æ–¹æ–‡æ¡£ Docker Swarm ç®€ä»‹ Docker Swarm æ˜¯ Docker å®˜æ–¹æä¾›çš„ä¸€ä¸ªé›†ç¾¤ç®¡ç†å·¥å…·ï¼ŒåŸºäº Docker Swarm å¯ä»¥å¿«é€Ÿå®ç° Docker é›†ç¾¤çš„ç®¡ç†ã€‚ ä» Docker v1.12 ç‰ˆæœ¬å¼€å§‹ï¼ŒDocker Swarm å·²ç»åŒ…å«åœ¨ Docker Engine ä¸­ï¼Œä¸éœ€è¦å•ç‹¬å®‰è£…ã€‚ Docker Swarm å…·æœ‰æœåŠ¡ç¼–æ’ã€æœåŠ¡è´Ÿè½½å‡è¡¡ã€æœåŠ¡å‡çº§å’ŒæœåŠ¡å¤±è´¥è¿ç§»ç­‰åŠŸèƒ½ã€‚ Docker Swarm é›†ç¾¤ä¸­çš„èŠ‚ç‚¹åˆ†ä¸ºä¸¤ç§ç±»å‹ï¼šç®¡ç†èŠ‚ç‚¹(Manager Node)å’Œå·¥ä½œèŠ‚ç‚¹(Worker Node)ï¼Œç®¡ç†èŠ‚ç‚¹è´Ÿè´£é›†ç¾¤çš„ç®¡ç†ï¼Œå·¥ä½œèŠ‚ç‚¹è´Ÿè´£è¿è¡Œå®¹å™¨ã€‚ ä»¥ä¸‹æ˜¯ Docker Swarm ä¸­ ç®¡ç†èŠ‚ç‚¹ï¼ˆManager Nodeï¼‰ å’Œ å·¥ä½œèŠ‚ç‚¹ï¼ˆWorker Nodeï¼‰ çš„å¯¹æ¯” ç‰¹æ€§/åŠŸèƒ½ ç®¡ç†èŠ‚ç‚¹ï¼ˆManager Nodeï¼‰ å·¥ä½œèŠ‚ç‚¹ï¼ˆWorker Nodeï¼‰ è§’è‰² è´Ÿè´£é›†ç¾¤ç®¡ç†å’Œå†³ç­– æ‰§è¡Œåˆ†é…çš„æœåŠ¡ä»»åŠ¡ æ˜¯å¦å‚ä¸æœåŠ¡è¿è¡Œ å¯ä»¥è¿è¡ŒæœåŠ¡ä»»åŠ¡ï¼Œä¹Ÿå¯ä»¥åªåšç®¡ç†ï¼ˆå¯é…ç½®ï¼‰ ä»…è¿è¡ŒæœåŠ¡ä»»åŠ¡ï¼Œä¸å‚ä¸ç®¡ç†å†³ç­– é›†ç¾¤çŠ¶æ€ç»´æŠ¤ ç»´æŠ¤æ•´ä¸ª Swarm çš„çŠ¶æ€ï¼ˆä½¿ç”¨ Raft åè®®ï¼‰ ä¸ç»´æŠ¤é›†ç¾¤çŠ¶æ€ è°ƒåº¦ä»»åŠ¡ å†³å®šå°†æœåŠ¡ä»»åŠ¡åˆ†é…ç»™å“ªä¸ªèŠ‚ç‚¹ ä¸è´Ÿè´£è°ƒåº¦ï¼Œåªæ‰§è¡Œæ¥æ”¶åˆ°çš„ä»»åŠ¡ ç®¡ç†å‘½ä»¤å¤„ç† æ¥æ”¶å¹¶å¤„ç† Swarm ç®¡ç†å‘½ä»¤ï¼ˆå¦‚åˆ›å»ºæœåŠ¡ã€æ‰©ç¼©å®¹ç­‰ï¼‰ ä¸å¤„ç†ç®¡ç†å‘½ä»¤ æ•°æ®ä¸€è‡´æ€§ éœ€è¦ä¿æŒä¸€è‡´æ€§ï¼ˆè‡³å°‘ 3 ä¸ªç®¡ç†èŠ‚ç‚¹å½¢æˆé«˜å¯ç”¨ï¼‰ ä¸æ¶‰åŠä¸€è‡´æ€§ èµ„æºè¦æ±‚ ç›¸å¯¹è¾ƒé«˜ï¼Œéœ€è¦æ‰¿æ‹…ç®¡ç†å’Œåè°ƒå¼€é”€ ç›¸å¯¹è¾ƒä½ï¼Œä¸“æ³¨äºè¿è¡Œå®¹å™¨ å¯ç”¨æ€§è¦æ±‚ é€šå¸¸é…ç½®å¥‡æ•°ä¸ªï¼ˆ3ã€5ã€7â€¦ï¼‰ä»¥ä¿éšœé«˜å¯ç”¨ å¯æ ¹æ®éœ€è¦è‡ªç”±æ‰©å±•æˆ–ç¼©å‡ èŠ‚ç‚¹åŠ å…¥æ–¹å¼ é€šè¿‡ manager token åŠ å…¥ Swarm é€šè¿‡ worker token åŠ å…¥ Swarm æ•…éšœå½±å“ å¤šä¸ªç®¡ç†èŠ‚ç‚¹æ•…éšœå¯èƒ½å½±å“æ•´ä¸ª Swarm çš„æ§åˆ¶èƒ½åŠ› éƒ¨åˆ†å·¥ä½œèŠ‚ç‚¹æ•…éšœé€šå¸¸ä¸ä¼šå½±å“ Swarm çš„ç®¡ç†èƒ½åŠ› manager èŠ‚ç‚¹é€šå¸¸é…ç½®ä¸ºå¥‡æ•°ä¸ªï¼Œé»˜è®¤åˆ›å»ºé›†ç¾¤çš„èŠ‚ç‚¹å°±æ˜¯ manager èŠ‚ç‚¹ï¼Œå¹¶ä¸”æ˜¯ manager èŠ‚ç‚¹ä¸­çš„çš„ Leader èŠ‚ç‚¹ã€‚Leader èŠ‚ç‚¹è´Ÿè´£ç®¡ç†é›†ç¾¤ï¼ŒLeader èŠ‚ç‚¹åœ¨é›†ç¾¤ä¸­åªèƒ½æœ‰ä¸€ä¸ªã€‚å½“ Leader èŠ‚ç‚¹æ•…éšœæ—¶ï¼ŒSwarm ä¼šè‡ªåŠ¨ä»å…¶å®ƒ manager èŠ‚ç‚¹ä¸­é€‰ä¸¾å‡ºä¸€ä¸ªæ–°çš„ Leader èŠ‚ç‚¹ã€‚ worker èŠ‚ç‚¹æ˜¯è¿è¡Œå®¹å™¨çš„èŠ‚ç‚¹ï¼Œä¸å‚ä¸æœºå™¨çš„ç®¡ç†å’Œè°ƒåº¦ï¼Œä¸æ”¯æŒæ‰§è¡Œä»»ä½•å’Œé›†ç¾¤ç®¡ç†ç›¸å…³çš„æ“ä½œã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼Œmanager èŠ‚ç‚¹ä¹Ÿä¼šå‚ä¸æ¥æ”¶è¿è¡Œå®¹å™¨çš„ä»»åŠ¡ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡è®¾ç½®æ¥æŒ‡å®š manager èŠ‚ç‚¹ä¸å‚ä¸æ¥æ”¶ä»»åŠ¡ã€‚ manager èŠ‚ç‚¹å’Œ worker èŠ‚ç‚¹å¯ä»¥é€šè¿‡â€œå‡çº§â€å’Œâ€œé™çº§â€ç›¸äº’è½¬æ¢ã€‚ æ­å»ºSwarmé›†ç¾¤ æœ¬æ•™ç¨‹éœ€è¦äº”å°å®‰è£…äº†Dockerä¸”èƒ½å¤Ÿé€šè¿‡ç½‘ç»œé€šä¿¡çš„ Linux ä¸»æœºï¼Œè¿™äº›ä¸»æœºå¯ä»¥æ˜¯ç‰©ç†æœºã€è™šæ‹Ÿæœºã€Amazon EC2 å®ä¾‹ï¼Œä¹Ÿå¯ä»¥ä»¥å…¶ä»–æ–¹å¼æ‰˜ç®¡ã€‚ å…¶ä¸­ä¸‰å°æœºå™¨æ˜¯ç®¡ç†èŠ‚ç‚¹ï¼ˆç§°ä¸ºmanager1,manager2,manager3ï¼‰ï¼Œå¦å¤–ä¸¤å°æ˜¯å·¥ä½œèŠ‚ç‚¹ï¼ˆworker1å’Œworker2ï¼‰ã€‚ IP åœ°å€ HostName è§’è‰²ç±»å‹ 10.211.55.10 manager1 ç®¡ç†èŠ‚ç‚¹ 10.211.55.11 manager2 ç®¡ç†èŠ‚ç‚¹ 10.211.55.12 manager3 ç®¡ç†èŠ‚ç‚¹ 10.211.55.13 worker1 å·¥ä½œèŠ‚ç‚¹ 10.211.55.14 worker2 å·¥ä½œèŠ‚ç‚¹ æ‰€æœ‰ä¸»æœºä¸Šå¿…é¡»å¼€å¯å¦‚ä¸‹ç«¯å£ï¼Œä»¥ç¡®ä¿Docker Swarm é›†ç¾¤æ­£å¸¸é€šä¿¡ï¼š ç«¯å£å· åè®® ç”¨é€”è¯´æ˜ 2377 TCP ç®¡ç†å™¨èŠ‚ç‚¹ä¹‹é—´é€šä¿¡ï¼ˆç®¡ç†æŒ‡ä»¤å’ŒåŠ å…¥é›†ç¾¤ï¼‰ 7946 TCP/UDP èŠ‚ç‚¹å‘ç°å’Œé€šä¿¡ï¼ˆé›†ç¾¤å†…éƒ¨å‘ç°æœºåˆ¶ï¼‰ 4789 UDP è¦†ç›–ç½‘ç»œæµé‡ï¼ˆVXLANï¼Œç”¨äºå®¹å™¨é—´ç½‘ç»œï¼‰ 123456789101112131415# å¼€æ”¾ Swarm ç®¡ç†èŠ‚ç‚¹é€šä¿¡ç«¯å£sudo firewall-cmd --permanent --add-port=2377/tcp# èŠ‚ç‚¹å‘ç°ï¼ˆcluster communicationï¼‰sudo firewall-cmd --permanent --add-port=7946/tcpsudo firewall-cmd --permanent --add-port=7946/udp# overlay ç½‘ç»œæµé‡ï¼ˆå®¹å™¨é—´é€šä¿¡ï¼‰sudo firewall-cmd --permanent --add-port=4789/udp# åº”ç”¨æ›´æ”¹sudo firewall-cmd --reload# æŸ¥çœ‹é˜²ç«å¢™çŠ¶æ€sudo firewall-cmd --list-all æ‰€æœ‰ä¸»æœºå¿…é¡»æ—¶é—´ä¸€è‡´ 12345678# åŒæ­¥ç³»ç»Ÿæ—¶é—´sudo systemctl restart chronydchronyc tracking# åŒæ­¥åç³»ç»Ÿæ—¶é—´æ˜¾ç¤ºä¸º UTCï¼Œè€Œä¸æ˜¯ä¸­å›½æ—¶åŒºï¼ˆCST/Asia/Shanghaiï¼‰# è®¾ç½®æ—¶åŒºä¸ºä¸­å›½ä¸Šæµ·æ—¶é—´ï¼ˆCSTï¼‰sudo timedatectl set-timezone Asia/Shanghai# æŸ¥çœ‹æ—¶é—´å’Œæ—¶åŒºtimedatectl åˆ›å»ºé›†ç¾¤ åœ¨ manager1 èŠ‚ç‚¹ä¸Šæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„swarmé›†ç¾¤ 1234567891011121314151617181920212223242526272829303132333435363738# æŸ¥çœ‹å½“å‰dockerçš„swarmæ¨¡å¼æ˜¯å¦å¼€å¯docker info | grep &quot;Swarm&quot;## è¾“å‡ºï¼Œ inactive è¡¨ç¤ºæ²¡æœ‰å¼€å¯swarmé›†ç¾¤ Swarm: inactive# é›†ç¾¤åˆå§‹åŒ–# docker swarm init --advertise-addr &lt;MANAGER-IP&gt;docker swarm init --advertise-addr 10.211.55.10## å‚æ•°è¯´æ˜# --advertise-addrï¼šæŒ‡å®šå½“å‰èŠ‚ç‚¹çš„IPåœ°å€ï¼Œç”¨äºé›†ç¾¤ä¸­å…¶ä»–èŠ‚ç‚¹å‘ç°å½“å‰èŠ‚ç‚¹ï¼Œç«¯å£é»˜è®¤2377# è¿™ä¸ªå‚æ•°æ˜¯å¯é€‰çš„ï¼Œå¦‚æœèŠ‚ç‚¹ä¸Šå­˜åœ¨å¤šä¸ªç½‘å¡ï¼Œåˆ™éœ€è¦æŒ‡å®šå½“å‰èŠ‚ç‚¹çš„IPåœ°å€## è¾“å‡º# swarm åˆå§‹åŒ–æˆåŠŸï¼Œå½“å‰èŠ‚ç‚¹æˆä¸º manager nodeï¼Œå¹¶è‡ªåŠ¨æˆä¸ºé›†ç¾¤çš„leaderSwarm initialized: current node (kp2zerd28xgz5mmglnje0jp22) is now a manager.# å°†ä¸€ä¸ªworker nodeåŠ å…¥é›†ç¾¤è¯·è¿è¡Œä¸‹é¢çš„å‘½ä»¤To add a worker to this swarm, run the following command: # è¿™ä¸ªtokenä¸éœ€è¦è®°ä½ï¼Œå¯ä»¥é€šè¿‡å‘½ä»¤ `docker swarm join-token worker` è·å– docker swarm join --token SWMTKN-1-256y3fmlkr5u76a5lor7jsboox2eztl954djhnuoj4p2x7dem4-0izbgc1xv73qulz31szmxnk3y 10.211.55.10:2377# æ·»åŠ ä¸€ä¸ªmanager nodeéœ€è¦æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤è·å– manager tokenTo add a manager to this swarm, run &#x27;docker swarm join-token manager&#x27; and follow the instructions.# å†æ¬¡æŸ¥çœ‹å½“å‰dockerçš„swarmæ¨¡å¼æ˜¯å¦å¼€å¯docker info | grep Swarm## è¾“å‡º Swarm: active# è‹¥è¦æŸ¥çœ‹æ›´ä¸ºè¯¦ç»†çš„ä¿¡æ¯ï¼Œå¯ä»¥ç›´æ¥æŸ¥çœ‹ Swarm ä¸­çš„ä¿¡æ¯ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹ä¸»è¦ä¿¡æ¯ï¼Œæ­¤æ—¶é›†ç¾¤ä¸­åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¹¶ä¸”æ˜¯managerèŠ‚ç‚¹docker info --format &#x27;&#123;&#123;json .Swarm&#125;&#125;&#x27; | jq &#x27;&#123;LocalNodeState,NodeID,NodeAddr,RemoteManagers,Nodes,Nodes,Managers,ControlAvailable&#125;&#x27; | yq -P## è¾“å‡ºLocalNodeState: active # èŠ‚ç‚¹çŠ¶æ€NodeID: kp2zerd28xgz5mmglnje0jp22 # èŠ‚ç‚¹IDNodeAddr: 10.211.55.10 # èŠ‚ç‚¹IPRemoteManagers: [ # èŠ‚ç‚¹ç®¡ç†èŠ‚ç‚¹ä¿¡æ¯ - NodeID: kp2zerd28xgz5mmglnje0jp22 # èŠ‚ç‚¹ç®¡ç†èŠ‚ç‚¹ID Addr: 10.211.55.10:2377 # èŠ‚ç‚¹ç®¡ç†èŠ‚ç‚¹åœ°å€Nodes: 1 # èŠ‚ç‚¹æ•°é‡Managers: 1 # ç®¡ç†èŠ‚ç‚¹æ•°é‡ControlAvailable: true # æ˜¯å¦æœ‰æ§åˆ¶èŠ‚ç‚¹ å®‰è£… yq å·¥å…· yq æ˜¯ yaml çš„å‘½ä»¤è¡Œå¤„ç†å·¥å…·ï¼Œå…·ä½“å‚è€ƒyq 12345678# ä¸‹è½½ yq æœ€æ–°ç‰ˆæœ¬VERSION=v4.45.4ARCH=amd64wget https://github.com/mikefarah/yq/releases/download/$&#123;VERSION&#125;/yq_linux_$&#123;ARCH&#125; -O /usr/local/bin/yq# æ·»åŠ æ‰§è¡Œæƒé™chmod +x /usr/local/bin/yq# éªŒè¯å®‰è£…yq --version æ·»åŠ  manager èŠ‚ç‚¹ è·å– manager èŠ‚ç‚¹çš„ token 123456# åœ¨ manager1 ä¸Šè¿è¡Œdocker swarm join-token manager## è¾“å‡ºç»“æœTo add a manager to this swarm, run the following command: docker swarm join --token SWMTKN-1-256y3fmlkr5u76a5lor7jsboox2eztl954djhnuoj4p2x7dem4-byc8ygc6hdoyzna0in1btp9yu 10.211.55.10:2377 å°† manager2 å’Œ manager3 åŠ å…¥ swarm é›†ç¾¤ 1234567# åˆ†åˆ«åœ¨ manager2 å’Œ manager3 ä¸Šè¿è¡Œå¦‚ä¸‹å‘½ä»¤ï¼Œdocker swarm join \\--token SWMTKN-1-256y3fmlkr5u76a5lor7jsboox2eztl954djhnuoj4p2x7dem4-byc8ygc6hdoyzna0in1btp9yu \\10.211.55.10:2377## å¦‚æœæœºå™¨ä¸Šæœ‰å¤šå—ç½‘å¡ä¹Ÿéœ€è¦æŒ‡å®šip: å¦‚ --advertise-addr 10.211.55.11## è¿è¡Œç»“æœThis node joined a swarm as a manager. æ·»åŠ  worker èŠ‚ç‚¹ è·å– worker èŠ‚ç‚¹çš„ token 123456# åœ¨ manager1 ä¸Šè¿è¡Œdocker swarm join-token worker## è¾“å‡ºç»“æœTo add a worker to this swarm, run the following command: docker swarm join --token SWMTKN-1-256y3fmlkr5u76a5lor7jsboox2eztl954djhnuoj4p2x7dem4-0izbgc1xv73qulz31szmxnk3y 10.211.55.10:2377 å°† worker1 å’Œ worker2 åŠ å…¥ swarm é›†ç¾¤ 1234567# åˆ†åˆ«åœ¨ worker1 å’Œ worker2 ä¸Šè¿è¡Œå¦‚ä¸‹å‘½ä»¤ï¼Œdocker swarm join \\--token SWMTKN-1-256y3fmlkr5u76a5lor7jsboox2eztl954djhnuoj4p2x7dem4-0izbgc1xv73qulz31szmxnk3y \\10.211.55.10:2377## å¦‚æœæœºå™¨ä¸Šæœ‰å¤šå—ç½‘å¡ä¹Ÿéœ€è¦æŒ‡å®šip: å¦‚ --advertise-addr 10.211.55.13## è¿è¡Œç»“æœThis node joined a swarm as a worker. æŸ¥çœ‹é›†ç¾¤çŠ¶æ€ åœ¨ manager1 ä¸Šæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ 123456789101112131415docker info --format &#x27;&#123;&#123;json .Swarm&#125;&#125;&#x27; | jq &#x27;&#123;LocalNodeState,NodeID,NodeAddr,RemoteManagers,Nodes,Nodes,Managers,ControlAvailable&#125;&#x27; | yq -P## ç»“æœLocalNodeState: activeNodeID: kp2zerd28xgz5mmglnje0jp22NodeAddr: 10.211.55.10RemoteManagers: - NodeID: oymi74epagdqeprah7s81tsa2 Addr: 10.211.55.11:2377 - NodeID: r7388xl84nczjtnf53pwh7hla Addr: 10.211.55.12:2377 - NodeID: kp2zerd28xgz5mmglnje0jp22 Addr: 10.211.55.10:2377Nodes: 5Managers: 3ControlAvailable: true æŸ¥çœ‹é›†ç¾¤å†…èŠ‚ç‚¹ä¿¡æ¯ åœ¨ ä»»æ„ manager èŠ‚ç‚¹ä¸Šè¿è¡Œå¦‚ä¸‹å‘½ä»¤ 123456789# åœ¨ manager1 ä¸Šè¿è¡Œï¼Œåˆ—å‡ºæ‰€æœ‰èŠ‚ç‚¹ä¿¡æ¯ï¼Œåªæœ‰ manager èŠ‚ç‚¹æ”¯æŒ node ç›¸å…³å‘½ä»¤docker node ls## è¿è¡Œç»“æœID HOSTNAME STATUS AVAILABILITY MANAGER STATUS ENGINE VERSIONkp2zerd28xgz5mmglnje0jp22 * manager1 Ready Active Leader 26.1.3oymi74epagdqeprah7s81tsa2 manager2 Ready Active Reachable 26.1.3r7388xl84nczjtnf53pwh7hla manager3 Ready Active Reachable 26.1.3v31visfparkcsr9hswkb6v09u worker1 Ready Active 26.1.3lsxj50x8ftqw8etvz5y37xc5q worker2 Ready Active 26.1.3 å­—æ®µå ç¤ºä¾‹å€¼ ä¸­æ–‡å«ä¹‰ ID kp2zerd28xgz5mmglnje0jp22 èŠ‚ç‚¹çš„å”¯ä¸€ IDï¼ˆåœ¨ swarm é›†ç¾¤ä¸­è‡ªåŠ¨ç”Ÿæˆçš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼‰ HOSTNAME manager1 èŠ‚ç‚¹çš„ä¸»æœºåï¼ˆå³åŠ å…¥ swarm é›†ç¾¤æ—¶è¯¥èŠ‚ç‚¹çš„ hostnameï¼‰ STATUS Ready èŠ‚ç‚¹çš„çŠ¶æ€ï¼šâ€¢ Readyï¼šèŠ‚ç‚¹æ­£å¸¸è¿è¡Œä¸­â€¢ Downï¼šèŠ‚ç‚¹ç¦»çº¿æˆ–æ— æ³•é€šä¿¡â€¢ Pausedï¼šæš‚åœâ€¢ Drainï¼šæ’ç©ºï¼Œæ­£åœ¨è¿ç§»ä»»åŠ¡ AVAILABILITY Active èŠ‚ç‚¹çš„å¯ç”¨æ€§è®¾ç½®ï¼šâ€¢ Activeï¼šèŠ‚ç‚¹å¯ä»¥è°ƒåº¦ä»»åŠ¡ï¼ˆé»˜è®¤ï¼‰â€¢ Pauseï¼šæš‚åœè°ƒåº¦æ–°ä»»åŠ¡â€¢ Drainï¼šè¿ç§»ä»»åŠ¡å¹¶ä¸å†è°ƒåº¦ MANAGER STATUS Leader / Reachable / ç©º ä»…é€‚ç”¨äºç®¡ç†èŠ‚ç‚¹ï¼šâ€¢ Leaderï¼šå½“å‰ swarm çš„ä¸»èŠ‚ç‚¹ï¼ˆè´Ÿè´£åè°ƒï¼‰â€¢ Reachableï¼šé›†ç¾¤ä¸­å¯é€šä¿¡çš„ç®¡ç†èŠ‚ç‚¹â€¢ ç©ºï¼šè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªå·¥ä½œèŠ‚ç‚¹ï¼ˆéç®¡ç†èŠ‚ç‚¹ï¼‰ ENGINE VERSION 26.1.3 Docker å¼•æ“çš„ç‰ˆæœ¬å·ï¼ˆå³è¯¥èŠ‚ç‚¹ä¸Šè¿è¡Œçš„ Docker ç‰ˆæœ¬ï¼‰ docker swarmé›†ç¾¤ç®¡ç† å‘½ä»¤ ä¸­æ–‡å«ä¹‰ ca æ˜¾ç¤ºå’Œè½®æ¢ Swarm çš„æ ¹è¯ä¹¦ï¼ˆCAï¼‰ init åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„ Swarm é›†ç¾¤ join å°†å½“å‰èŠ‚ç‚¹åŠ å…¥åˆ° Swarm ä¸­ï¼Œä½œä¸ºå·¥ä½œèŠ‚ç‚¹æˆ–ç®¡ç†èŠ‚ç‚¹ join-token ç®¡ç†ç”¨äºåŠ å…¥ Swarm çš„ä»¤ç‰Œï¼ˆæŸ¥çœ‹æˆ–é‡æ–°ç”Ÿæˆï¼‰ leave å½“å‰èŠ‚ç‚¹ç¦»å¼€ Swarm é›†ç¾¤ unlock è§£é”è¢«åŠ å¯†çš„ Swarmï¼ˆç”¨äºæ¢å¤ Manager èŠ‚ç‚¹ï¼‰ unlock-key ç®¡ç† Swarm çš„è§£é”å¯†é’¥ï¼ˆæŸ¥çœ‹ã€å¤‡ä»½ç­‰ï¼‰ update æ›´æ–° Swarm é›†ç¾¤çš„å…¨å±€é…ç½®ï¼ˆå¦‚åŠ å¯†ã€æ—¥å¿—ç­‰ï¼‰ docker swarm init: åˆå§‹åŒ– Swarm é›†ç¾¤ï¼ˆåªåœ¨é¦–æ¬¡åˆ›å»ºæ—¶ä½¿ç”¨ï¼‰ 1docker swarm init --advertise-addr 10.211.55.10 docker swarm join-token: ç”ŸæˆåŠ å…¥é›†ç¾¤çš„ä»¤ç‰Œ 1234# ç”Ÿæˆ worker èŠ‚ç‚¹çš„ä»¤ç‰Œdocker swarm join-token worker# ç”Ÿæˆ manager èŠ‚ç‚¹çš„ä»¤ç‰Œdocker swarm join-token manager docker swarm join: åŠ å…¥ Swarm é›†ç¾¤ï¼ˆåœ¨å·²æœ‰ Swarm é›†ç¾¤ä¸­åŠ å…¥èŠ‚ç‚¹æ—¶ä½¿ç”¨ï¼‰ 1docker swarm join --token &lt;token&gt; 10.211.55.10:2377 docker swarm leave: ä½¿å½“å‰èŠ‚ç‚¹ç¦»å¼€ Swarm é›†ç¾¤ï¼ˆä» Swarm é›†ç¾¤ä¸­ç§»é™¤èŠ‚ç‚¹æ—¶ä½¿ç”¨ï¼‰ 12345678910111213141516# worker èŠ‚ç‚¹ç¦»å¼€é›†ç¾¤docker swarm leave# manager èŠ‚ç‚¹å¿…é¡»å…ˆé™çº§ä¸º workerèŠ‚ç‚¹ï¼Œæˆ–è€…åŠ ä¸Š --force å¼ºåˆ¶ç¦»å¼€docker swarm leave --force# å¦‚æœLeaderèŠ‚ç‚¹ç¦»å¼€é›†ç¾¤ï¼Œé‚£ä¹ˆé›†ç¾¤ä¸­çš„å…¶å®ƒManagerèŠ‚ç‚¹ï¼Œä¼šé‡æ–°é€‰ä¸¾ä¸€ä¸ªæ–°çš„LeaderèŠ‚ç‚¹# é›†ç¾¤ä¸­è‡³å°‘éœ€è¦ä¸€ä¸ªManagerèŠ‚ç‚¹ï¼Œå¦åˆ™æ— æ³•è¿è¡ŒæœåŠ¡# èŠ‚ç‚¹ç¦»å¼€swarmé›†ç¾¤åï¼Œåœ¨ docker node lsä¸­ä»ç„¶å¯ä»¥çœ‹åˆ°ï¼Œæ¯”å¦‚å°† worker2 èŠ‚ç‚¹ä»é›†ç¾¤ä¸­ç§»é™¤ï¼Œå…¶çŠ¶æ€å˜ä¸º downdocker node lsID HOSTNAME STATUS AVAILABILITY MANAGER STATUS ENGINE VERSIONkp2zerd28xgz5mmglnje0jp22 * manager1 Ready Active Leader 26.1.3oymi74epagdqeprah7s81tsa2 manager2 Ready Active Reachable 26.1.3r7388xl84nczjtnf53pwh7hla manager3 Ready Active Reachable 26.1.3v31visfparkcsr9hswkb6v09u worker1 Ready Active 26.1.3lsxj50x8ftqw8etvz5y37xc5q worker2 Down Active 26.1.3# å¦‚éœ€å½»åº•åˆ é™¤éœ€è¦è¿è¡Œdocker node rm worker2 docker swarm update: æ›´æ–° Swarm é›†ç¾¤é…ç½® 1234567891011121314# å¼€å¯Swarmé›†ç¾¤é”å®šï¼Œåªé’ˆå¯¹managerèŠ‚ç‚¹ï¼ŒmanagerèŠ‚ç‚¹é‡å¯åéœ€è¦è§£é”æ‰èƒ½æ¢å¤ï¼Œä¸‹é¢çš„å¯†é’¥ä¸éœ€è¦è®°ä½ï¼Œé€šè¿‡`docker swarm unlock-key`å‘½ä»¤æŸ¥çœ‹docker swarm update --autolock=true## è¾“å‡ºSwarm updated.To unlock a swarm manager after it restarts, run the `docker swarm unlock`command and provide the following key: SWMKEY-1-X74/FGf+SkUkJEWtYok6ZFgCDAdwt3CQpOvLPT5lra4Please remember to store this key in a password manager, since without it youwill not be able to restart the manager.# å…³é—­Swarmé›†ç¾¤é”å®šdocker swarm update --autolock=false docker swarm unlock-key: è·å–Swarmé›†ç¾¤çš„è§£é”å¯†é’¥ï¼Œè¯¥å‘½ä»¤å¯ä»¥åˆ¤æ–­Swarmé›†ç¾¤æ˜¯å¦è¢«é”å®š 1234# è·å–Swarmé›†ç¾¤çš„è§£é”å¯†é’¥docker swarm unlock-key# è½®æ¢Swarmé›†ç¾¤çš„è§£é”å¯†é’¥docker swarm unlock-key --rotate docker swarm unlock: æ‰‹åŠ¨è§£é”å½“å‰ manager èŠ‚ç‚¹ï¼Œä½¿å…¶åœ¨å¯ç”¨ autolock æ—¶æ¢å¤åŠŸèƒ½ 12345678910# å¦‚æœSwarmé›†ç¾¤è®¾ç½®ä¸ºé”å®šï¼Œåˆ™é‡å¯manager2ä¸Šçš„dockeræœåŠ¡åå°†æ— æ³•è¿è¡Œnodeç®¡ç†å‘½ä»¤systemctl restart docker# æŸ¥çœ‹èŠ‚ç‚¹åˆ—è¡¨docker node ls## è¾“å‡ºError response from daemon: Swarm is encrypted and needs to be unlocked before it can be used. Please use &quot;docker swarm unlock&quot; to unlock it.# éœ€è¦å…ˆè§£é”æ‰å¯ä»¥è¿è¡ŒèŠ‚ç‚¹ç®¡ç†å‘½ä»¤docker swarm unlock## ä¼šæç¤ºè¾“å…¥è§£é”å¯†é’¥ï¼Œè§£é”åå°±æ¢å¤æ­£å¸¸äº†Please enter unlock key: docker nodeèŠ‚ç‚¹ç®¡ç† èŠ‚ç‚¹ç®¡ç†ç›¸å…³å‘½ä»¤ï¼Œåªèƒ½åœ¨ ç®¡ç†èŠ‚ç‚¹ ä¸Šæ‰§è¡Œ å‘½ä»¤ ä¸­æ–‡å«ä¹‰ demote å°†ä¸€ä¸ªæˆ–å¤šä¸ªç®¡ç†èŠ‚ç‚¹é™çº§ä¸ºå·¥ä½œèŠ‚ç‚¹ inspect æ˜¾ç¤ºä¸€ä¸ªæˆ–å¤šä¸ªèŠ‚ç‚¹çš„è¯¦ç»†ä¿¡æ¯ ls åˆ—å‡º swarm é›†ç¾¤ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹ promote å°†ä¸€ä¸ªæˆ–å¤šä¸ªå·¥ä½œèŠ‚ç‚¹æå‡ä¸ºç®¡ç†èŠ‚ç‚¹ ps æŸ¥çœ‹ä¸€ä¸ªæˆ–å¤šä¸ªèŠ‚ç‚¹ä¸Šæ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ï¼ˆé»˜è®¤å½“å‰èŠ‚ç‚¹ï¼‰ rm ä» swarm é›†ç¾¤ä¸­ç§»é™¤ä¸€ä¸ªæˆ–å¤šä¸ªèŠ‚ç‚¹ update æ›´æ–°èŠ‚ç‚¹çš„å…ƒæ•°æ®ï¼ˆå¦‚æ ‡ç­¾ã€å¯ç”¨æ€§ç­‰ï¼‰ docker node ls: åˆ—å‡º swarm é›†ç¾¤ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹ 1docker node ls docker node inspect &lt;node_id&gt;/&lt;hostname&gt;: æŸ¥çœ‹æŒ‡å®šèŠ‚ç‚¹çš„è¯¦ç»†ä¿¡æ¯ 1docker node inspect --pretty manager1 docker node update &lt;options&gt; &lt;node_id&gt;/&lt;hostname&gt;: æ›´æ–°èŠ‚ç‚¹çš„å…ƒæ•°æ® 123456# è®¾ç½®èŠ‚ç‚¹ä¸ºä¸å¯ç”¨docker node update --availability drain manager1# æ·»åŠ æ ‡ç­¾docker node update --label-add foo=bar manager1# åˆ é™¤æ ‡ç­¾docker node update --label-rm foo manager1 docker node demote &lt;node_id&gt;/&lt;hostname&gt;: å°†ç®¡ç†èŠ‚ç‚¹é™çº§ä¸ºå·¥ä½œèŠ‚ç‚¹ 1docker node demote manager1 docker note promote &lt;node_id&gt;/&lt;hostname&gt;: å°†å·¥ä½œèŠ‚ç‚¹å‡çº§ä¸ºç®¡ç†èŠ‚ç‚¹ 1docker node promote worker1 docker node rm &lt;node_id&gt;/&lt;hostname&gt;: ä» swarm é›†ç¾¤ä¸­ç§»é™¤ä¸€ä¸ªèŠ‚ç‚¹ 1docker node rm manager1 èŠ‚ç‚¹ç®¡ç†å¸¸è§æƒ…å†µ å¦‚ä½•æ­£ç¡®çš„åˆ é™¤ä¸€ä¸ªèŠ‚ç‚¹ 1.å¦‚æœæ˜¯ manager èŠ‚ç‚¹ï¼Œå…ˆå°† manager èŠ‚ç‚¹é™çº§ä¸º worker èŠ‚ç‚¹ 1docker node demote manager1 2.é€€å‡ºé›†ç¾¤ 12# åœ¨è¦é€€å‡ºé›†ç¾¤çš„èŠ‚ç‚¹ä¸Šæ‰§è¡Œdocker swarm leave 3.åˆ é™¤èŠ‚ç‚¹ 1docker node rm manager1 èŠ‚ç‚¹è¢«é€€ç¾¤æˆ–åˆ é™¤åï¼Œå…¶ä¸Šè¿è¡Œçš„serviceä¼šæ€æ ·ï¼Ÿ ç”¨ä¸€ä¸ªç¤ºä¾‹æ¥è¯´æ˜ï¼Œå…ˆåœ¨ manager1 èŠ‚ç‚¹ä¸Šåˆ›å»ºä¸€ä¸ª service 123456# --replicas 10 è¡¨ç¤ºå¯åŠ¨ 10 ä¸ª nginx å®¹å™¨ï¼Œswarmé›†ç¾¤æœ‰5ä¸ªèŠ‚ç‚¹ï¼Œæ‰€ä»¥å¯åŠ¨10ä¸ªnginxå®¹å™¨ï¼Œæ¯ä¸ªèŠ‚ç‚¹ä¼šå¯åŠ¨2ä¸ªnginxå®¹å™¨docker service create \\ --name my-nginx \\ --publish 8080:80 \\ --replicas 10 \\ nginx:latest æŸ¥çœ‹serviceçŠ¶æ€ 12345678910111213docker service ps my-nginx## è¾“å‡ºç»“æœï¼Œå¯ä»¥çœ‹åˆ°æ¯ä¸ªèŠ‚ç‚¹ä¸Šéƒ½å¯åŠ¨äº†2ä¸ªnginxå®¹å™¨ID NAME IMAGE NODE DESIRED STATE CURRENT STATE ERROR PORTSfciheo523fb3 my-nginx.1 nginx:latest manager2 Running Running about a minute agot9agioefr316 my-nginx.2 nginx:latest manager2 Running Running about a minute agomoitlj50nunh my-nginx.3 nginx:latest manager3 Running Running 2 minutes agox07voc2qth5q my-nginx.4 nginx:latest manager1 Running Running about a minute agop8khdhngz0xm my-nginx.5 nginx:latest manager3 Running Running 2 minutes agoi6mieuodbrtg my-nginx.6 nginx:latest worker2 Running Running about a minute ago2yohffzzsrrl my-nginx.7 nginx:latest worker1 Running Running 2 minutes agof3lusxoflqn2 my-nginx.8 nginx:latest worker2 Running Running about a minute agoxovzfmzsjlet my-nginx.9 nginx:latest worker1 Running Running 2 minutes agondrz827kpu2k my-nginx.10 nginx:latest manager1 Running Running about a minute ago è¿™æ—¶å°† worker2 ä»é›†ç¾¤ä¸­é€€ç¾¤ 12345678910# åœ¨worker2èŠ‚ç‚¹æ‰§è¡Œdocker swarm leave# åœ¨managerèŠ‚ç‚¹æŸ¥çœ‹é›†ç¾¤èŠ‚ç‚¹docker node lsID HOSTNAME STATUS AVAILABILITY MANAGER STATUS ENGINE VERSIONkp2zerd28xgz5mmglnje0jp22 * manager1 Ready Active Leader 26.1.3oymi74epagdqeprah7s81tsa2 manager2 Ready Active Reachable 26.1.3r7388xl84nczjtnf53pwh7hla manager3 Ready Active Reachable 26.1.3v31visfparkcsr9hswkb6v09u worker1 Ready Active 26.1.3x87lfn4pzorahpr9zehv9ag3f worker2 Down Active 26.1.3 å†æ¬¡æŸ¥çœ‹serviceçŠ¶æ€ 123456789101112131415docker service ps my-nginx# è¾“å‡ºï¼Œå¯ä»¥çœ‹åˆ°worker2èŠ‚ç‚¹ä¸Šçš„å®¹å™¨å·²ç»è¢«å…³é—­ï¼Œæ–°çš„å®¹å™¨åœ¨å…¶å®ƒèŠ‚ç‚¹ä¸Šå¯åŠ¨äº†ï¼Œä¿è¯äº†serviceä¸­çš„å®¹å™¨æ•°é‡ID NAME IMAGE NODE DESIRED STATE CURRENT STATE ERROR PORTSfciheo523fb3 my-nginx.1 nginx:latest manager2 Running Running 6 minutes agot9agioefr316 my-nginx.2 nginx:latest manager2 Running Running 6 minutes agomoitlj50nunh my-nginx.3 nginx:latest manager3 Running Running 6 minutes agox07voc2qth5q my-nginx.4 nginx:latest manager1 Running Running 6 minutes agop8khdhngz0xm my-nginx.5 nginx:latest manager3 Running Running 6 minutes agouz7wam5ul4aa my-nginx.6 nginx:latest manager2 Running Running 43 seconds agoi6mieuodbrtg \\_ my-nginx.6 nginx:latest worker2 Shutdown Running 6 minutes ago2yohffzzsrrl my-nginx.7 nginx:latest worker1 Running Running 6 minutes ago34km8mzg3xat my-nginx.8 nginx:latest manager3 Running Running 43 seconds agof3lusxoflqn2 \\_ my-nginx.8 nginx:latest worker2 Shutdown Running 6 minutes agoxovzfmzsjlet my-nginx.9 nginx:latest worker1 Running Running 6 minutes agondrz827kpu2k my-nginx.10 nginx:latest manager1 Running Running 6 minutes ago å¦‚æœä¸é€€ç¾¤ç›´æ¥åˆ é™¤èŠ‚ç‚¹å‘¢ï¼Ÿè¿™æ¬¡æˆ‘ä»¬ç›´æ¥åˆ é™¤ worker1 èŠ‚ç‚¹ 1234567891011121314151617181920212223242526272829303132333435# åˆ é™¤ worker1 èŠ‚ç‚¹docker node rm worker1# è¾“å‡ºï¼Œæç¤º worker1 èŠ‚ç‚¹ä¸æ˜¯ down çŠ¶æ€ï¼Œä¸èƒ½åˆ é™¤# Error response from daemon: rpc error: code = FailedPrecondition desc = node v31visfparkcsr9hswkb6v09u is not down and can&#x27;t be removed# æ¥ç€æˆ‘ä»¬å¼ºåˆ¶åˆ é™¤docker node rm -f worker1# æŸ¥çœ‹èŠ‚ç‚¹åˆ—è¡¨docker node ls# è¾“å‡ºï¼Œå¯ä»¥çœ‹åˆ°worker1èŠ‚ç‚¹å·²ç»åˆ é™¤äº†ID HOSTNAME STATUS AVAILABILITY MANAGER STATUS ENGINE VERSIONkp2zerd28xgz5mmglnje0jp22 * manager1 Ready Active Leader 26.1.3oymi74epagdqeprah7s81tsa2 manager2 Ready Active Reachable 26.1.3r7388xl84nczjtnf53pwh7hla manager3 Ready Active Reachable 26.1.3x87lfn4pzorahpr9zehv9ag3f worker2 Down Active 26.1.3# å†æ¬¡æŸ¥çœ‹serviceçŠ¶æ€docker service ps my-nginx## è¾“å‡ºï¼Œå¯ä»¥çœ‹åˆ°worker1(å› ä¸ºworker1èŠ‚ç‚¹å·²ç»è¢«åˆ é™¤ï¼Œæ‰€ä»¥è¿™é‡Œåªä¼šæ˜¾ç¤ºèŠ‚ç‚¹ID:v31visfparkcsr9hswkb6v09u)èŠ‚ç‚¹ä¸Šçš„å®¹å™¨å·²ç»è¢«å…³é—­ï¼Œæ–°çš„å®¹å™¨åœ¨å…¶å®ƒèŠ‚ç‚¹ä¸Šå¯åŠ¨äº†ï¼Œä¿è¯äº†serviceä¸­çš„å®¹å™¨æ•°é‡docker service ps my-nginxID NAME IMAGE NODE DESIRED STATE CURRENT STATE ERROR PORTSfciheo523fb3 my-nginx.1 nginx:latest manager2 Running Running 12 minutes agot9agioefr316 my-nginx.2 nginx:latest manager2 Running Running 12 minutes agomoitlj50nunh my-nginx.3 nginx:latest manager3 Running Running 12 minutes agox07voc2qth5q my-nginx.4 nginx:latest manager1 Running Running 12 minutes agop8khdhngz0xm my-nginx.5 nginx:latest manager3 Running Running 12 minutes agouz7wam5ul4aa my-nginx.6 nginx:latest manager2 Running Running 6 minutes agoi6mieuodbrtg \\_ my-nginx.6 nginx:latest worker2 Shutdown Running 12 minutes ago3t4qvpvrzpg3 my-nginx.7 nginx:latest manager1 Running Running about a minute ago2yohffzzsrrl \\_ my-nginx.7 nginx:latest v31visfparkcsr9hswkb6v09u Shutdown Orphaned about a minute ago34km8mzg3xat my-nginx.8 nginx:latest manager3 Running Running 6 minutes agof3lusxoflqn2 \\_ my-nginx.8 nginx:latest worker2 Shutdown Running 12 minutes ago4w5zfpfye3t8 my-nginx.9 nginx:latest manager1 Running Running about a minute agoxovzfmzsjlet \\_ my-nginx.9 nginx:latest v31visfparkcsr9hswkb6v09u Shutdown Orphaned about a minute agondrz827kpu2k my-nginx.10 nginx:latest manager1 Running Running 12 minutes ago èŠ‚ç‚¹è¢«é€€ç¾¤æˆ–åˆ é™¤åæ˜¯å¦å¯ä»¥é‡æ–°åŠ å…¥é›†ç¾¤ èŠ‚ç‚¹è¢«é€€ç¾¤æˆ–åˆ é™¤åï¼Œå¯ä»¥é€šè¿‡ docker swarm join å‘½ä»¤é‡æ–°åŠ å…¥é›†ç¾¤ è‹¥èŠ‚ç‚¹æ˜¯è¢«å¼ºåˆ¶åˆ é™¤ï¼Œè€Œæ²¡æœ‰é€€ç¾¤ï¼Œåˆ™é‡æ–°åŠ å…¥é›†ç¾¤æ—¶éœ€è¦å…ˆé€šè¿‡ docker swarm leave å‘½ä»¤é€€ç¾¤åå†åŠ å…¥é›†ç¾¤ å¦‚æœSwarmé›†ç¾¤è®¾ç½®ä¸ºé”å®šï¼Œåˆ™é‡å¯managerèŠ‚ç‚¹åæ— æ³•æä¾›é›†ç¾¤æœåŠ¡çš„è§£å†³æ–¹æ³• 12345678910111213# è¿™é‡Œé‡å¯ä¸€ä¸ªmanagerèŠ‚ç‚¹çš„dockeræœåŠ¡systemctl restart docker# æŸ¥çœ‹èŠ‚ç‚¹åˆ—è¡¨docker node ls## è¾“å‡ºError response from daemon: Swarm is encrypted and needs to be unlocked before it can be used. Please use &quot;docker swarm unlock&quot; to unlock it.# éœ€è¦å…ˆè§£é”æ‰å¯ä»¥è¿è¡ŒèŠ‚ç‚¹ç®¡ç†å‘½ä»¤docker swarm unlock## ä¼šæç¤ºè¾“å…¥è§£é”å¯†é’¥ï¼Œè§£é”åå°±æ¢å¤æ­£å¸¸äº†Please enter unlock key:## å¦‚æœå¿˜è®°äº†å¯†é’¥ï¼Œå¯ä»¥åœ¨å…¶å®ƒmanagerèŠ‚ç‚¹é€šè¿‡å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹docker swarm unlock-key# å¦‚æœæ‰€æœ‰managerèŠ‚ç‚¹éƒ½é‡å¯äº†ï¼Œä½ åˆæ²¡æœ‰è®°å½•è§£é”å¯†é’¥ï¼Œé‚£ä¹ˆæ­å–œä½ ï¼Œåªèƒ½é‡æ–°åˆ›å»ºswarmé›†ç¾¤äº† Swarm é›†ç¾¤é”å®šåŠŸèƒ½çš„ä½œç”¨åŠä½¿ç”¨åœºæ™¯ ä½œç”¨ âœ… ä½œç”¨ ğŸ“‹ è¯´æ˜ åŠ å¯†ä¿æŠ¤ç®¡ç†å¯†é’¥ ç®¡ç†å™¨èŠ‚ç‚¹ä¹‹é—´çš„æ•°æ®ï¼ˆå¦‚ Raft æ—¥å¿—ï¼‰è™½ç„¶é»˜è®¤åŠ å¯†ï¼Œä½†å¯†é’¥ä¿å­˜åœ¨å†…å­˜ä¸­ã€‚å¯ç”¨é”å®šåŠŸèƒ½åï¼Œå¯†é’¥åœ¨èŠ‚ç‚¹é‡å¯æ—¶ä¸ä¼šè‡ªåŠ¨åŠ è½½ï¼Œå¿…é¡»æ‰‹åŠ¨æä¾›è§£é”å¯†é’¥æ‰èƒ½æ¢å¤ã€‚ é˜²æ­¢èŠ‚ç‚¹è¢«éæ³•é‡å¯ååŠ å…¥é›†ç¾¤ å¦‚æœæ”»å‡»è€…è·å¾—äº†ç®¡ç†èŠ‚ç‚¹çš„ç‰©ç†è®¿é—®æƒé™ï¼ˆå¦‚é‡å¯ã€ç£ç›˜å…‹éš†ç­‰ï¼‰ï¼Œé”å®šåŠŸèƒ½å¯ä»¥é˜²æ­¢å…¶è‡ªåŠ¨æ§åˆ¶æˆ–é‡æ–°åŠ å…¥ Swarm é›†ç¾¤ã€‚ åœºæ™¯ åœºæ™¯ç±»å‹ å…·ä½“æè¿° âœ… é€‚åˆåœºæ™¯ å¯¹å®‰å…¨æ€§è¦æ±‚é«˜çš„ç”Ÿäº§ç¯å¢ƒ éƒ¨ç½²åœ¨ä¸å¯ä¿¡æˆ–å…±äº«ç‰©ç†ç¯å¢ƒä¸­ äº‘æœåŠ¡å™¨ã€æ•°æ®ä¸­å¿ƒæœ‰ä¸“äººè¿ç»´ç®¡ç†è§£é”è¿‡ç¨‹ å¸Œæœ›é˜²æ­¢ç‰©ç†/è¿œç¨‹å…¥ä¾µè€…æ¢å¤ç®¡ç†å™¨è§’è‰²çš„å…¬å¸ âŒ ä¸é€‚åˆåœºæ™¯ éœ€è¦è‡ªåŠ¨åŒ–éƒ¨ç½²æˆ–é‡å¯çš„ CI/CD ç³»ç»Ÿ æµ‹è¯•ç¯å¢ƒæˆ–å¼€å‘é›†ç¾¤ æ— äººå€¼å®ˆã€è¦æ±‚é«˜å¯ç”¨è‡ªåŠ¨æ¢å¤çš„éƒ¨ç½²ç³»ç»Ÿ æ€»ç»“ é¡¹ç›® æ˜¯å¦æ¨è å®‰å…¨æ€§ âœ… å¼ºçƒˆæ¨èå¯ç”¨ï¼ˆå°¤å…¶åœ¨ç”Ÿäº§ç¯å¢ƒï¼‰ è‡ªåŠ¨åŒ– âŒ ä¸æ¨èï¼ˆå¢åŠ äººå·¥å¹²é¢„æ­¥éª¤ï¼‰ è§£é”æ–¹å¼ è§£é”å‘½ä»¤ + unlock key unlock key ä¸¢å¤±åæœ å¯èƒ½éœ€è¦é‡å»º Swarmï¼ˆé™¤éæå‰å¤‡ä»½ï¼‰ docker swarm ca æ˜¯åšä»€ä¹ˆç”¨çš„ï¼Ÿ docker swarm ca å‘½ä»¤æ˜¯ç”¨æ¥ ç®¡ç† Swarm é›†ç¾¤ä¸­çš„æ ¹è¯ä¹¦é¢å‘æœºæ„ï¼ˆCAï¼‰ çš„å·¥å…·ã€‚å…·ä½“åŠŸèƒ½åŒ…æ‹¬ï¼š å­å‘½ä»¤/å‚æ•° è¯´æ˜ docker swarm ca æŸ¥çœ‹å½“å‰ Swarm çš„æ ¹ CA å…¬é’¥ï¼ˆPEM æ ¼å¼ï¼‰ docker swarm ca --rotate è½®æ¢æ ¹ CAï¼Œç”¨äºå®‰å…¨æ›´æ–° Swarm ä¸­çš„è¯ä¹¦æ˜¯å¹²ä»€ä¹ˆç”¨çš„ï¼Ÿ ç”¨é€” è¯´æ˜ âœ… èŠ‚ç‚¹èº«ä»½éªŒè¯ æ¯ä¸ªèŠ‚ç‚¹åŠ å…¥é›†ç¾¤æ—¶ï¼Œéƒ½ä¼šæ”¶åˆ°ä¸€ä¸ªç”±æ ¹ CA ç­¾å‘çš„ TLS è¯ä¹¦ï¼Œç”¨äºè¯æ˜å®ƒçš„èº«ä»½ã€‚ ğŸ” é€šä¿¡åŠ å¯† èŠ‚ç‚¹ä¹‹é—´ï¼ˆManager â†” Workerï¼‰çš„é€šä¿¡é€šè¿‡ TLS è¿›è¡ŒåŠ å¯†ã€‚ ğŸ”„ è‡ªåŠ¨è½®æ¢ Docker ä¼šè‡ªåŠ¨ä¸ºæ¯ä¸ªèŠ‚ç‚¹ç­¾å‘çŸ­æœŸè¯ä¹¦ï¼ˆé»˜è®¤æœ‰æ•ˆæœŸ 90 å¤©ï¼‰å¹¶å®šæœŸè‡ªåŠ¨è½®æ¢ã€‚ Swarm åœ¨åå°è‡ªåŠ¨ç®¡ç†è¯ä¹¦ï¼Œæ‰€ä»¥ä½ ä¸éœ€è¦æ‰‹åŠ¨å¤„ç†å®ƒä»¬ã€‚ä¸è¿‡ï¼Œä½ å¯ä»¥åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šæ‰¾åˆ°å®ƒä»¬çš„ä½ç½®ï¼š 123456cd /var/lib/docker/swarm/certificatestree.â”œâ”€â”€ swarm-node.crt # èŠ‚ç‚¹è¯ä¹¦â”œâ”€â”€ swarm-node.key # èŠ‚ç‚¹å¯†é’¥â””â”€â”€ swarm-root-ca.crt # æ ¹CAè¯ä¹¦ åªè®© Manager åšç®¡ç†ï¼Œä¸è¿è¡ŒæœåŠ¡ èŠ‚ç‚¹çš„AVAILABILITYæœ‰ä¸‰ç§ï¼šactiveã€pauseã€drainã€‚ çŠ¶æ€ è¯´æ˜ active å¯è°ƒåº¦ï¼ŒSwarm å¯ä»¥åœ¨æ­¤èŠ‚ç‚¹ä¸Šè¿è¡ŒæœåŠ¡ä»»åŠ¡ï¼ˆé»˜è®¤ï¼‰ pause æš‚åœè°ƒåº¦ï¼Œä¸ä¼šåˆ†é…æ–°ä»»åŠ¡ï¼Œä½†ä¿ç•™å·²æœ‰ä»»åŠ¡ drain æ’ç©ºæ¨¡å¼ï¼Œä¸å¯è°ƒåº¦ï¼ŒSwarm ä¼šå°†è¯¥èŠ‚ç‚¹ä¸Šçš„ä»»åŠ¡è¿ç§»åˆ°å…¶ä»–èŠ‚ç‚¹ï¼Œæ–°çš„ä»»åŠ¡å°†ä¸ä¼šåˆ†é…åˆ°æ­¤èŠ‚ç‚¹ å¦‚æœä½ å¸Œæœ› Swarm Manager èŠ‚ç‚¹ä»…å‚ä¸ç®¡ç†å·¥ä½œï¼Œè€Œä¸è¿è¡ŒæœåŠ¡ä»»åŠ¡ï¼ˆtaskï¼‰ï¼Œä½ å¯ä»¥é€šè¿‡ è®¾ç½®èŠ‚ç‚¹çš„å¯è°ƒåº¦çŠ¶æ€ä¸ºâ€œä¸å¯è°ƒåº¦â€ æ¥å®ç°è¿™ä¸€ç›®æ ‡ã€‚ 123456789101112131415161718192021222324252627282930313233# è®¾ç½® manager1 èŠ‚ç‚¹ä¸ºâ€œä¸å¯è°ƒåº¦â€ï¼Œå³ æ’ç©ºæ¨¡å¼docker node update --availability drain manager1# æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€docker node ls## è¾“å‡ºï¼Œmanager1 èŠ‚ç‚¹çŠ¶æ€å˜ä¸º æ’ç©ºID HOSTNAME STATUS AVAILABILITY MANAGER STATUS ENGINE VERSIONkp2zerd28xgz5mmglnje0jp22 * manager1 Ready Drain Reachable 26.1.3oymi74epagdqeprah7s81tsa2 manager2 Ready Active Reachable 26.1.3r7388xl84nczjtnf53pwh7hla manager3 Ready Active Leader 26.1.3xkww4853bbdgv7bv8771xibob worker1 Ready Active 26.1.3hvzkh3ip5ef8gx973z1ywahbu worker2 Ready Active 26.1.3# æŸ¥çœ‹æœåŠ¡çŠ¶æ€docker service ps my-nginx## è¾“å‡ºï¼Œå¯ä»¥çœ‹åˆ° manager1 èŠ‚ç‚¹ä¸Šçš„ä»»åŠ¡å·²ç»å…³é—­ï¼Œå¹¶ä¸”åœ¨å…¶å®ƒèŠ‚ç‚¹ä¸Šè¿è¡Œäº†ä»»åŠ¡ã€‚ID NAME IMAGE NODE DESIRED STATE CURRENT STATE ERROR PORTS23m03nj54mzo my-nginx.1 nginx:latest worker2 Running Running 35 seconds ago9xi83bnh4fus my-nginx.2 nginx:latest worker2 Running Running 35 seconds agowos8tbk449lk my-nginx.3 nginx:latest manager2 Running Running 28 seconds agouosmuh6bvwm0 \\_ my-nginx.3 nginx:latest manager1 Shutdown Shutdown 7 seconds agoyeqhqc3f735y my-nginx.4 nginx:latest manager2 Running Running about a minute agog8rduix7s74v my-nginx.5 nginx:latest worker2 Running Running less than a second agowuxilgpv9f50 \\_ my-nginx.5 nginx:latest manager1 Shutdown Shutdown 7 seconds ago3bxtn9boit28 my-nginx.6 nginx:latest manager3 Running Running 28 seconds ago57kdggaf8sag my-nginx.7 nginx:latest manager2 Running Running about a minute agouugi506p74s8 my-nginx.8 nginx:latest worker1 Running Running 28 seconds agoyifwpqjnts9l my-nginx.9 nginx:latest worker1 Running Running 28 seconds agoyv4p6su7aom5 my-nginx.10 nginx:latest manager3 Running Running 28 seconds ago# æ¢å¤è¿è¡Œä»»åŠ¡èƒ½åŠ›docker node update --availability active manager1# åœæ­¢æ¥æ”¶æ–°çš„ä»»åŠ¡ä½†ä¿ç•™è¿è¡Œä¸­çš„ä»»åŠ¡docker node update --availability pause manager1","summary":"æ‘˜è¦ æœ¬æ–‡ä»‹ç» Docker Swarm çš„ èŠ‚ç‚¹ç®¡ç† Dockerå®˜æ–¹æ–‡æ¡£ Docker Swarm å®˜æ–¹æ–‡æ¡£","date_published":"2025-06-09T13:30:05.000Z","tags":["æŠ€æœ¯","docker","docker"]},{"id":"https://blog.hanqunfeng.com/2025/06/06/docker-dockerfile-multi-platform/","url":"https://blog.hanqunfeng.com/2025/06/06/docker-dockerfile-multi-platform/","title":"Docker å‘½ä»¤ ä¹‹ Dockerfile å¤šå¹³å°æ„å»º","content_html":"<!--\n **åŠ ç²—**\n *æ–œä½“*\n ***åŠ ç²—å¹¶æ–œä½“***\n ~~åˆ é™¤çº¿~~\n ==çªå‡ºæ˜¾ç¤º==\n `çªå‡ºæ˜¾ç¤º(æ¨è)`\n ++ä¸‹åˆ’çº¿++\n ~ä¸‹æ ‡~\n ^ä¸Šæ ‡^\n è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference.\n å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)\n\n +++ **ç‚¹å‡»æŠ˜å **\n è¿™æ˜¯è¢«éšè—çš„å†…å®¹\n +++\n\n::: tips success warning danger\nè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹\n:::\n\n% note info % success warning danger\nè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹\n% endnote %\n\nå¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{}\n å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ\n -->\n<h2 id=\"æ‘˜è¦\">æ‘˜è¦</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æœ¬æ–‡ä»‹ç» Docker å‘½ä»¤ ä¸­ Dockerfile å¤šå¹³å°æ„å»ºçš„ä½¿ç”¨æ–¹æ³•</p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://docs.docker.com\">Dockerå®˜æ–¹æ–‡æ¡£</a></p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://docs.docker.com/engine/reference/builder/\">Dockerfileå®˜æ–¹æ–‡æ¡£</a></p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://docs.docker.com/build/building/multi-platform/\">Multi-platform builds</a></p>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"ä»€ä¹ˆæ˜¯Dockerfile-å¤šå¹³å°æ„å»ºï¼Ÿ\">ä»€ä¹ˆæ˜¯Dockerfile å¤šå¹³å°æ„å»ºï¼Ÿ</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Dockerfile å¤šå¹³å°æ„å»ºï¼Œå¯ä»¥æ„å»ºå¤šä¸ªå¹³å°é•œåƒï¼Œæ¯”å¦‚ arm64ã€amd64ã€armã€386 ç­‰ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>åœ¨æ²¡æœ‰å®‰è£… <code>docker-buildx-plugin</code> çš„æƒ…å†µä¸‹ï¼Œ<code>docker build</code> å‘½ä»¤æ˜¯ä¸æ”¯æŒä½¿ç”¨ <code>--platform</code> æ„å»ºå‡ºè·¨å¹³å°é•œåƒçš„ï¼Œå…¶ä»…èƒ½æ„å»ºä¸æœ¬æœºæ¶æ„å¹³å°ç›¸åŒçš„é•œåƒã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>è¦çœŸæ­£å®ç°è·¨å¹³å°æ„å»ºï¼ˆmulti-platform buildï¼‰ï¼Œæ¯”å¦‚åœ¨ amd64 ä¸Šæ„å»º arm64 çš„é•œåƒï¼Œéœ€è¦ä½¿ç”¨ BuildKit å’Œ buildx æ’ä»¶ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p><code>docker-buildx-plugin</code> æ˜¯åŸºäº BuildKit æ„å»ºçš„ï¼Œä½†å®ƒæœ¬èº«æ˜¯ Buildx çš„ä¸€ä¸ªå®ç°å½¢å¼ï¼Œå®ƒæ‰©å±•äº† <code>docker build</code> çš„èƒ½åŠ›ï¼Œæ”¯æŒå¤šå¹³å°æ„å»ºï¼ˆå¦‚åŒæ—¶æ„å»º Linux/amd64 å’Œ Linux/arm64ç­‰ï¼‰ã€‚</p>\n</li>\n</ul>\n<h2 id=\"å®‰è£…-docker-buildx-plugin\">å®‰è£… docker-buildx-plugin</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>éšdockeræœåŠ¡ä¸€èµ·å®‰è£…</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">sudo</span> dnf -y install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å•ç‹¬å®‰è£…</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">sudo</span> dnf -y install docker-buildx-plugin</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æŸ¥çœ‹ç‰ˆæœ¬</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker buildx version</span><br></pre></td></tr></table></figure>\n<h2 id=\"docker-buildx-åŸºæœ¬å‘½ä»¤\"><code>docker buildx</code> åŸºæœ¬å‘½ä»¤</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ä»¥ä¸‹å‘½ä»¤åœ¨åé¢çš„ç¤ºä¾‹ä¸­éƒ½æœ‰ä½¿ç”¨</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>å‘½ä»¤</th>\n<th>è¯´æ˜</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>docker buildx create</code></td>\n<td>åˆ›å»ºä¸€ä¸ªæ–°çš„æ„å»ºå™¨å®ä¾‹</td>\n</tr>\n<tr>\n<td><code>docker buildx use</code></td>\n<td>è®¾ç½®å½“å‰ä½¿ç”¨çš„æ„å»ºå™¨</td>\n</tr>\n<tr>\n<td><code>docker buildx inspect</code></td>\n<td>æŸ¥çœ‹æ„å»ºå™¨çŠ¶æ€å’Œæ”¯æŒçš„å¹³å°</td>\n</tr>\n<tr>\n<td><code>docker buildx build</code></td>\n<td>æ„å»ºé•œåƒï¼ˆå¢å¼ºç‰ˆï¼‰ï¼Œç­‰åŒäº <code>docker build</code></td>\n</tr>\n<tr>\n<td><code>docker buildx ls</code></td>\n<td>åˆ—å‡ºæ‰€æœ‰æ„å»ºå™¨</td>\n</tr>\n<tr>\n<td><code>docker buildx rm</code></td>\n<td>åˆ é™¤æ„å»ºå™¨</td>\n</tr>\n<tr>\n<td><code>docker buildx du</code></td>\n<td>æŸ¥çœ‹æ„å»ºå™¨ä½¿ç”¨çš„ç£ç›˜ç©ºé—´</td>\n</tr>\n<tr>\n<td><code>docker buildx prune</code></td>\n<td>åˆ é™¤æ„å»ºè¿‡ç¨‹ä¸­äº§ç”Ÿçš„ç¼“å­˜</td>\n</tr>\n<tr>\n<td><code>docker buildx version</code></td>\n<td>æŸ¥çœ‹ Docker Buildx çš„ç‰ˆæœ¬ä¿¡æ¯</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"è¦è®©Dockeræ”¯æŒå¤šå¹³å°æ„å»ºï¼Œéœ€è¦æ»¡è¶³ä»¥ä¸‹å‡ ä¸ªæ¡ä»¶ï¼š\">è¦è®©Dockeræ”¯æŒå¤šå¹³å°æ„å»ºï¼Œéœ€è¦æ»¡è¶³ä»¥ä¸‹å‡ ä¸ªæ¡ä»¶ï¼š</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Linuxå†…æ ¸å¼€å¯å¤šå¤„ç†å™¨æ¶æ„æ”¯æŒ</p>\n</li>\n<li class=\"lvl-2\">\n<p>æ„å»ºæ—¶ä½¿ç”¨åŸºäº<code>docker-container</code>é©±åŠ¨çš„Buildxå®ä¾‹</p>\n</li>\n<li class=\"lvl-2\">\n<p>ä½¿ç”¨<code>docker buildx build</code>å‘½ä»¤æ„å»ºé•œåƒï¼Œæ„å»ºå‘½ä»¤å¿…é¡»æŒ‡å®š<code>â€“platform</code>å‚æ•°</p>\n</li>\n</ul>\n<h2 id=\"Linuxå†…æ ¸å¼€å¯å¤šå¤„ç†å™¨æ¶æ„æ”¯æŒ\">Linuxå†…æ ¸å¼€å¯å¤šå¤„ç†å™¨æ¶æ„æ”¯æŒ</h2>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># åˆ—å‡ºæ‰€æœ‰æ„å»ºå™¨ï¼Œé»˜è®¤æƒ…å†µä¸‹åªæœ‰ä¸€ä¸ªåç§°ä¸º&quot;default&quot;çš„æ„å»ºå™¨</span></span><br><span class=\"line\">docker buildx <span class=\"built_in\">ls</span></span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡º</span></span><br><span class=\"line\">NAME/NODE        DRIVER/ENDPOINT                   STATUS    BUILDKIT   PLATFORMS</span><br><span class=\"line\">default          docker</span><br><span class=\"line\"> \\_ default       \\_ default                       running   v0.13.2    linux/amd64, linux/amd64/v2, linux/amd64/v3, linux/amd64/v4, linux/386</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># å¼€å¯å¤šå¤„ç†å™¨æ¶æ„æ”¯æŒ</span></span><br><span class=\"line\">docker run --privileged --<span class=\"built_in\">rm</span> tonistiigi/binfmt --install all</span><br><span class=\"line\"><span class=\"comment\"># è¿™ä¸ªé•œåƒç”¨å®Œå°±å¯ä»¥åˆ é™¤äº†</span></span><br><span class=\"line\">docker rmi tonistiigi/binfmt</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># å†æ¬¡åˆ—å‡ºæ‰€æœ‰æ„å»ºå™¨</span></span><br><span class=\"line\">docker buildx <span class=\"built_in\">ls</span></span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡ºï¼Œæ­¤æ—¶å¯ä»¥çœ‹åˆ°PLATFORMSä¸­æœ‰å¤šä¸ªå¹³å°</span></span><br><span class=\"line\">NAME/NODE        DRIVER/ENDPOINT                   STATUS    BUILDKIT   PLATFORMS</span><br><span class=\"line\">default*         docker</span><br><span class=\"line\"> \\_ default       \\_ default                       running   v0.13.2    linux/amd64, linux/amd64/v2, linux/amd64/v3, linux/amd64/v4, linux/386, linux/arm64, linux/riscv64, linux/ppc64le, linux/s390x, linux/mips64le, linux/mips64, linux/loong64, linux/arm/v7, linux/arm/v6</span><br></pre></td></tr></table></figure>\n<h2 id=\"æ„å»ºæ—¶ä½¿ç”¨åŸºäºdocker-containeré©±åŠ¨çš„Buildxå®ä¾‹\">æ„å»ºæ—¶ä½¿ç”¨åŸºäº<code>docker-container</code>é©±åŠ¨çš„Buildxå®ä¾‹</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Docker çš„é»˜è®¤æ„å»ºé©±åŠ¨æ˜¯ dockerï¼Œå®ƒæ˜¯è¿è¡Œåœ¨æœ¬åœ° Docker å®ˆæŠ¤è¿›ç¨‹ä¸Šçš„ï¼Œä¸èƒ½è¿›è¡ŒçœŸæ­£çš„å¤šå¹³å°æ„å»ºï¼ˆä»…èƒ½æ„å»ºå½“å‰å¹³å°ï¼‰ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>å¤šå¹³å°æ„å»ºéœ€è¦ä½¿ç”¨ BuildKit çš„ container é©±åŠ¨ï¼Œå®ƒä»¥å®¹å™¨çš„å½¢å¼è¿è¡Œæ„å»ºå™¨ï¼Œæ”¯æŒè™šæ‹ŸåŒ–å¹³å°å¹¶è¡Œæ„å»ºã€‚</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹å½“å‰é»˜è®¤çš„æ„å»ºå™¨default</span></span><br><span class=\"line\">docker buildx inspect default</span><br><span class=\"line\"><span class=\"comment\"># è¾“å‡º</span></span><br><span class=\"line\">Name:          default</span><br><span class=\"line\">Driver:        docker</span><br><span class=\"line\">Last Activity: 2025-06-06 07:42:42 +0000 UTC</span><br><span class=\"line\"></span><br><span class=\"line\">Nodes:</span><br><span class=\"line\">Name:             default</span><br><span class=\"line\">Endpoint:         default</span><br><span class=\"line\">Status:           running</span><br><span class=\"line\">BuildKit version: v0.13.2</span><br><span class=\"line\">Platforms:        linux/amd64, linux/amd64/v2, linux/amd64/v3, linux/amd64/v4, linux/386, linux/arm64, linux/riscv64, linux/ppc64le, linux/s390x, linux/mips64le, linux/mips64, linux/loong64, linux/arm/v7, linux/arm/v6</span><br><span class=\"line\">Labels:</span><br><span class=\"line\"> org.mobyproject.buildkit.worker.moby.host-gateway-ip: 172.17.0.1</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åˆ›å»ºåŸºäº <code>docker-container</code> é©±åŠ¨çš„Buildxå®ä¾‹</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># åˆ›å»ºå¹¶åˆ‡æ¢åˆ°åä¸ºmybuilderçš„æ„å»ºå™¨å®ä¾‹</span></span><br><span class=\"line\">docker buildx create --name mybuilder --use --driver docker-container</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹å½“å‰æ„å»ºå™¨ä¿¡æ¯ï¼Œ--bootstrapï¼šæŸ¥çœ‹å‰ç¡®ä¿æ„å»ºå™¨å·²å¯åŠ¨ ï¼Œæ­¤æ—¶çœ‹åˆ°å…¶Driverä¸ºdocker-containerï¼Œè¿™ä¸ªå‘½ä»¤ç¬¬ä¸€æ¬¡æ‰§è¡Œæ—¶å¯èƒ½ä¼šæç¤ºé”™è¯¯ï¼Œä¸è¿‡ä¸ç”¨ç®¡ï¼Œå†æ¬¡è¿è¡Œå°±æ­£å¸¸äº†</span></span><br><span class=\"line\">docker buildx inspect --bootstrap</span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡º</span></span><br><span class=\"line\">Name:          mybuilder</span><br><span class=\"line\">Driver:        docker-container</span><br><span class=\"line\">â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æ­¤æ—¶ä¼šå¯åŠ¨ä¸€ä¸ªåç§°ä¸º`buildx_buildkit_mybuilder0`çš„å®¹å™¨ï¼Œæ¯åˆ›å»ºä¸€ä¸ªæ„å»ºå™¨å®ä¾‹ï¼Œå°±ä¼šå¯åŠ¨ä¸€ä¸ªåç§°ä¸º`buildx_buildkit_xxx`çš„å®¹å™¨ï¼Œåˆ é™¤æ„å»ºå™¨æ—¶ï¼Œå…¶å¯¹åº”çš„å®¹å™¨ä¹Ÿä¼šè¢«åˆ é™¤</span></span><br><span class=\"line\">docker ps</span><br><span class=\"line\">CONTAINER ID   IMAGE                           COMMAND                   CREATED             STATUS                       PORTS                    NAMES</span><br><span class=\"line\">0ab9cab9ec9b   moby/buildkit:buildx-stable-1   <span class=\"string\">&quot;buildkitd --allow-iâ€¦&quot;</span>   About an hour ago   Up About an hour                                      buildx_buildkit_mybuilder0</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>buildx_buildkit_xxx</code>è¿™ä¸ªå®¹å™¨å°±æ˜¯ä¸€ä¸ª BuildKit å®ˆæŠ¤è¿›ç¨‹å®¹å™¨ï¼Œå®ƒæ˜¯æ‰§è¡Œ buildx æ„å»ºä»»åŠ¡çš„å®é™…å·¥ä½œå¼•æ“ã€‚å…¶å¯¹åº”çš„é•œåƒä¸º<code>moby/buildkit:buildx-stable-1</code>ï¼Œå®¹å™¨ä¼šåœ¨æ‰§è¡Œ<code>docker buildx build</code> æˆ– <code>docker buildx inspect --bootstrap</code> æ—¶å¯åŠ¨</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>åŠŸèƒ½</th>\n<th>è¯´æ˜</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>ğŸ‘· æ‰§è¡Œæ„å»ºä»»åŠ¡</td>\n<td>çœŸæ­£æ‰§è¡Œ <code>buildx build</code> æŒ‡ä»¤é‡Œçš„æ„å»ºè¿‡ç¨‹ï¼Œæ¯”å¦‚å¤šé˜¶æ®µæ„å»ºã€ç¼“å­˜å¤„ç†ã€è·¨å¹³å°ç¼–è¯‘ç­‰</td>\n</tr>\n<tr>\n<td>ğŸ“¦ æ‹‰å–é•œåƒ</td>\n<td>æ‹‰å– <code>Dockerfile</code> ä¸­çš„åŸºç¡€é•œåƒ</td>\n</tr>\n<tr>\n<td>ğŸ“¤ ä¸Šä¼ /å¯¼å‡ºé•œåƒ</td>\n<td>æ”¯æŒå¯¼å‡ºä¸º <code>docker image</code>, <code>tar</code>, æ¨é€åˆ°è¿œç¨‹ registry</td>\n</tr>\n<tr>\n<td>ğŸª£ ç®¡ç†ç¼“å­˜</td>\n<td>ç®¡ç†æ„å»ºç¼“å­˜ï¼ˆä¸­é—´é•œåƒã€å±‚ç­‰ï¼‰ä»¥åŠ é€Ÿåç»­æ„å»º</td>\n</tr>\n<tr>\n<td>ğŸŒ æ”¯æŒå¤šå¹³å°</td>\n<td>é€šè¿‡ QEMU æˆ–äº¤å‰ç¼–è¯‘å™¨æ”¯æŒè·¨å¹³å°ï¼ˆå¦‚æ„å»º <code>arm64</code> é•œåƒï¼‰</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åœ¨å›½å†…ç¯å¢ƒä½¿ç”¨æ—¶ï¼Œå¦‚æœä¸èƒ½ç§‘å­¦ä¸Šç½‘ï¼Œå½“æˆ‘ä»¬åœ¨æ„å»ºé•œåƒæ—¶ä¼šæç¤ºæ— æ³•æ‹‰å–åŸºç¡€é•œåƒï¼Œå³ä¾¿æˆ‘ä»¬å·²ç»åœ¨<code>/etc/docker/daemon.json</code>ä¸­é…ç½®äº†å›½å†…çš„é•œåƒæºä¹Ÿä¸è¡Œï¼Œè¿™æ˜¯å› ä¸º<code>docker buildx</code> ä½¿ç”¨çš„æ˜¯ BuildKitï¼Œå®ƒçš„è¡Œä¸ºä¸åŒäºä¼ ç»Ÿçš„ <code>docker build</code></p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>ç‰¹æ€§</th>\n<th><code>docker build</code>ï¼ˆä¼ ç»Ÿï¼‰</th>\n<th><code>docker buildx</code>ï¼ˆBuildKitï¼‰</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>æ˜¯å¦ä½¿ç”¨æœ¬åœ°é•œåƒç¼“å­˜</td>\n<td>âœ… æ˜¯</td>\n<td>âš ï¸ <strong>ä¸æ˜¯</strong></td>\n</tr>\n<tr>\n<td>æ˜¯å¦éœ€è¦è”ç½‘æ‹‰å–å…ƒæ•°æ®ï¼ˆå³ä½¿é•œåƒå·²å­˜åœ¨ï¼‰</td>\n<td>å¦</td>\n<td>æ˜¯</td>\n</tr>\n<tr>\n<td>æ„å»ºç½‘ç»œéš”ç¦»</td>\n<td>ä¸éš”ç¦»</td>\n<td>éš”ç¦»æ„å»ºï¼Œæ— æ³•ç›´æ¥è®¿é—®å®¿ä¸»é•œåƒç¼“å­˜</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>è§£å†³æ–¹æ³•ä¸ºæ„å»ºå™¨é…ç½®é•œåƒæº</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># åˆ›å»º BuildKit é…ç½®æ–‡ä»¶ buildkitd.toml</span></span><br><span class=\"line\"><span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; buildkitd.toml</span></span><br><span class=\"line\"><span class=\"string\">[registry.&quot;docker.io&quot;]</span></span><br><span class=\"line\"><span class=\"string\">  mirrors = [&quot;https://docker.1ms.run&quot;]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[worker.oci]</span></span><br><span class=\"line\"><span class=\"string\">  gc = true</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># åˆ›å»º BuildKit æ„å»ºå™¨ï¼Œå¹¶æŒ‡å®šé…ç½®æ–‡ä»¶</span></span><br><span class=\"line\">docker buildx create --name mybuilder --use --driver docker-container --config ./buildkitd.toml</span><br><span class=\"line\">docker buildx inspect --bootstrap</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># å¦‚æœå­˜åœ¨åŒåçš„æ„å»ºå™¨ï¼Œåˆ™åˆ é™¤å®ƒåå†åˆ›å»º</span></span><br><span class=\"line\">docker buildx <span class=\"built_in\">rm</span> mybuilder</span><br><span class=\"line\">docker buildx create --name mybuilder --use --driver docker-container --config ./buildkitd.toml</span><br><span class=\"line\">docker buildx inspect --bootstrap</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹æ„å»ºå™¨åˆ—è¡¨</span></span><br><span class=\"line\">docker buildx <span class=\"built_in\">ls</span></span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡º</span></span><br><span class=\"line\">NAME/NODE        DRIVER/ENDPOINT                   STATUS    BUILDKIT   PLATFORMS</span><br><span class=\"line\">mybuilder*       docker-container</span><br><span class=\"line\"> \\_ mybuilder0    \\_ unix:///var/run/docker.sock   running   v0.21.1    linux/amd64, linux/amd64/v2, linux/amd64/v3, linux/amd64/v4, linux/arm64, linux/riscv64, linux/ppc64le, linux/s390x, linux/386, linux/mips64le, linux/mips64, linux/loong64, linux/arm/v7, linux/arm/v6</span><br><span class=\"line\">default          docker</span><br><span class=\"line\"> \\_ default       \\_ default                       running   v0.13.2    linux/amd64, linux/amd64/v2, linux/amd64/v3, linux/amd64/v4, linux/386, linux/arm64, linux/riscv64, linux/ppc64le, linux/s390x, linux/mips64le, linux/mips64, linux/loong64, linux/arm/v7, linux/arm/v6</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># å¦‚æœè¦åˆ‡æ¢å›é»˜è®¤çš„æ„å»ºå™¨ï¼Œè¯·æ‰§è¡Œä»¥ä¸‹å‘½ä»¤</span></span><br><span class=\"line\">docker buildx use default</span><br></pre></td></tr></table></figure>\n<h2 id=\"ä½¿ç”¨docker-buildx-buildå‘½ä»¤æ„å»ºé•œåƒï¼Œæ„å»ºå‘½ä»¤å¿…é¡»æŒ‡å®š-platformå‚æ•°\">ä½¿ç”¨<code>docker buildx build</code>å‘½ä»¤æ„å»ºé•œåƒï¼Œæ„å»ºå‘½ä»¤å¿…é¡»æŒ‡å®š<code>--platform</code>å‚æ•°</h2>\n<h3 id=\"ç¤ºä¾‹ä¸€ï¼šå•é˜¶æ®µæ„å»º\">ç¤ºä¾‹ä¸€ï¼šå•é˜¶æ®µæ„å»º</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æˆ‘ä»¬ä¾æ—§ä»¥ä¸€ä¸ªspringbooté¡¹ç›®ä¸ºä¾‹ï¼Œå…¶Dockerfileå¦‚ä¸‹ï¼š</p>\n</li>\n</ul>\n<figure class=\"highlight dockerfile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨è½»é‡çº§ Alpine ç‰ˆæœ¬çš„ OpenJDK 17 å®˜æ–¹é•œåƒï¼Œé€‚åˆéƒ¨ç½² Spring Boot åº”ç”¨</span></span><br><span class=\"line\"><span class=\"keyword\">FROM</span> openjdk:<span class=\"number\">17</span>-alpine</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># è®¾ç½®æ„å»ºæ—¶å˜é‡ï¼Œé»˜è®¤ä½¿ç”¨æ„å»ºå¥½çš„ jar æ–‡ä»¶</span></span><br><span class=\"line\"><span class=\"keyword\">ARG</span> JAR_FILE=app.jar</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># è®¾ç½®è¿è¡Œæ—¶ç¯å¢ƒå˜é‡</span></span><br><span class=\"line\"><span class=\"keyword\">ENV</span> JAVA_OPTS=<span class=\"string\">&quot;-Xms1024M -Xmx1024M -XX:MetaspaceSize=128M -XX:MaxMetaspaceSize=128M&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">ENV</span> TZ=Asia/Shanghai</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># é•œåƒå…ƒä¿¡æ¯</span></span><br><span class=\"line\"><span class=\"keyword\">LABEL</span><span class=\"language-bash\"> maintainer=<span class=\"string\">&quot;yourname@example.com&quot;</span></span></span><br><span class=\"line\"><span class=\"keyword\">LABEL</span><span class=\"language-bash\"> version=<span class=\"string\">&quot;1.0.0&quot;</span></span></span><br><span class=\"line\"><span class=\"keyword\">LABEL</span><span class=\"language-bash\"> description=<span class=\"string\">&quot;ç”¨äºéƒ¨ç½² Spring Boot åº”ç”¨çš„ç”Ÿäº§çº§é•œåƒ&quot;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># è®¾ç½®å·¥ä½œç›®å½•</span></span><br><span class=\"line\"><span class=\"keyword\">WORKDIR</span><span class=\"language-bash\"> /app</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># å¤åˆ¶ Spring Boot æ„å»ºç”Ÿæˆçš„ jar åŒ…</span></span><br><span class=\"line\"><span class=\"keyword\">COPY</span><span class=\"language-bash\"> <span class=\"variable\">$&#123;JAR_FILE&#125;</span> app.jar</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># å£°æ˜æš´éœ²çš„åº”ç”¨ç«¯å£ï¼ˆSpring Boot é»˜è®¤æ˜¯ 8080ï¼‰</span></span><br><span class=\"line\"><span class=\"keyword\">EXPOSE</span> <span class=\"number\">8080</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># è®¾ç½®å®¹å™¨å¯åŠ¨æ—¶çš„ä¸»å‘½ä»¤ï¼ˆENTRYPOINT ä¸ä¼šè¢« docker run å‚æ•°è¦†ç›–ï¼‰</span></span><br><span class=\"line\"><span class=\"keyword\">ENTRYPOINT</span><span class=\"language-bash\"> [<span class=\"string\">&quot;sh&quot;</span>, <span class=\"string\">&quot;-c&quot;</span>, <span class=\"string\">&quot;java <span class=\"variable\">$JAVA_OPTS</span> -jar app.jar&quot;</span>]</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># CMD æä¾›é»˜è®¤çš„è¿è¡Œå‚æ•°ï¼Œå¯ä»¥è¢« docker run è¦†ç›–</span></span><br><span class=\"line\"><span class=\"comment\"># è¿™é‡Œé€šè¿‡ Spring Boot å‚æ•°è®¾ç½®å¯åŠ¨ç¯å¢ƒå’Œç«¯å£å·</span></span><br><span class=\"line\"><span class=\"keyword\">CMD</span><span class=\"language-bash\"> [<span class=\"string\">&quot;--spring.profiles.active=app&quot;</span>, <span class=\"string\">&quot;--server.port=8080&quot;</span>]</span></span><br><span class=\"line\"><span class=\"comment\"># è¿™é‡Œä½¿ç”¨çš„æ˜¯ ENTRYPOINT + CMD çš„æ··åˆæ¨¡å¼</span></span><br><span class=\"line\"><span class=\"comment\"># å®Œæ•´å‘½ä»¤ï¼š java $JAVA_OPTS -jar app.jar --spring.profiles.active=app --server.port=8080</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># å£°æ˜ä¸€ä¸ªå·æŒ‚è½½ç‚¹ï¼Œè¿è¡Œå®¹å™¨æ—¶å¯å°†è¯¥è·¯å¾„æ˜ å°„åˆ°å®¿ä¸»æœºï¼Œå®ç°æ•°æ®æŒä¹…åŒ–</span></span><br><span class=\"line\"><span class=\"keyword\">VOLUME</span><span class=\"language-bash\"> [<span class=\"string\">&quot;/app/logs&quot;</span>]</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å¼€å§‹æ„å»ºé•œåƒï¼Œ<code>docker buildx build == docker build</code>ï¼Œæ„å»ºå¤šå¹³å°æ¶æ„æ—¶éœ€è¦ä½¿ç”¨<code>--platform</code>æŒ‡å®šæ„å»ºå¹³å°</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># --platform inux/arm64 :æ„å»ºarm64é•œåƒ</span></span><br><span class=\"line\"><span class=\"comment\"># -t &quot;app.arm64&quot; :æ„å»ºåé•œåƒåç§°ï¼Œæ²¡æœ‰æŒ‡å®šç‰ˆæœ¬é»˜è®¤å°±æ˜¯ï¼šlatest</span></span><br><span class=\"line\"><span class=\"comment\"># --load :æ„å»ºååŠ è½½åˆ°æœ¬åœ°</span></span><br><span class=\"line\"><span class=\"comment\"># . :å½“å‰ç›®å½•æŸ¥æ‰¾Dockerfileæ–‡ä»¶</span></span><br><span class=\"line\"><span class=\"comment\"># -f :å¦‚æœåç§°ä¸ä¸ºDockerfileï¼Œåˆ™é€šè¿‡è¯¥å‚æ•°æŒ‡å®šDockerfileæ–‡ä»¶çš„åç§°</span></span><br><span class=\"line\">docker buildx build --platform linux/arm64 -t <span class=\"string\">&quot;app.arm64&quot;</span> --load .</span><br><span class=\"line\"><span class=\"comment\">## æ­¤æ—¶ä¼šé‡åˆ°å¦‚ä¸‹é”™è¯¯</span></span><br><span class=\"line\">ERROR: failed to solve: openjdk:17-alpine: failed to resolve <span class=\"built_in\">source</span> metadata <span class=\"keyword\">for</span> docker.io/library/openjdk:17-alpine: no match <span class=\"keyword\">for</span> platform <span class=\"keyword\">in</span> manifest: not found</span><br><span class=\"line\"><span class=\"comment\">## åŸå› ï¼šopenjdk:17-alpine è¿™ä¸ªé•œåƒä¸æ”¯æŒarm64å¹³å°ï¼Œæˆ‘ä»¬éœ€è¦æ›´æ¢ä¸€ä¸ªæ”¯æŒå¤šå¹³å°çš„é•œåƒ</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å¦‚ä½•æŸ¥çœ‹é•œåƒæ˜¯å¦æ”¯æŒå¤šå¹³å°å‘¢ï¼Ÿå¯ä»¥åœ¨docker hubä¸ŠæŸ¥çœ‹ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># æŸ¥è¯¢é•œåƒæ”¯æŒçš„å¹³å°ï¼Œä¸è¿‡å›½å†…ä¾æ—§æ˜¯ä¸æ”¯æŒ</span></span><br><span class=\"line\">docker buildx imagetools inspect nginx:latest |  grep Platform | <span class=\"built_in\">sort</span> | <span class=\"built_in\">uniq</span></span><br><span class=\"line\"><span class=\"comment\"># å¯ä»¥åœ¨é•œåƒåç§°å‰åŠ ä¸Šå›½å†…çš„é•œåƒä»“åº“åœ°å€è¿›è¡ŒæŸ¥è¯¢ï¼Œæ¯”å¦‚ï¼š</span></span><br><span class=\"line\">docker buildx imagetools inspect docker.1ms.run/nginx:latest |  grep Platform | <span class=\"built_in\">sort</span> | <span class=\"built_in\">uniq</span></span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡ºç»“æœ</span></span><br><span class=\"line\">  Platform:    linux/386</span><br><span class=\"line\">  Platform:    linux/amd64</span><br><span class=\"line\">  Platform:    linux/arm64/v8</span><br><span class=\"line\">  Platform:    linux/arm/v5</span><br><span class=\"line\">  Platform:    linux/arm/v7</span><br><span class=\"line\">  Platform:    linux/mips64le</span><br><span class=\"line\">  Platform:    linux/ppc64le</span><br><span class=\"line\">  Platform:    linux/s390x</span><br><span class=\"line\">  Platform:    unknown/unknown</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æ¥ç€æˆ‘ä»¬æŸ¥çœ‹openjdk:17-alpineè¿™ä¸ªé•œåƒ</span></span><br><span class=\"line\">docker buildx imagetools inspect docker.1ms.run/openjdk:17-alpine | grep Platform | <span class=\"built_in\">sort</span> | <span class=\"built_in\">uniq</span></span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡ºç»“æœï¼Œå…¶ç¡®å®ä¸æ”¯æŒ linux/arm64</span></span><br><span class=\"line\">  Platform:  linux/amd64</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æˆ‘ä»¬æ¢ä¸€ä¸ªopenjdké•œåƒè¯•è¯•</span></span><br><span class=\"line\">docker buildx imagetools inspect docker.1ms.run/openjdk:17-slim | grep Platform | <span class=\"built_in\">sort</span> | <span class=\"built_in\">uniq</span></span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡ºç»“æœï¼Œå¯ä»¥çœ‹åˆ°è¿™ä¸ªé•œåƒåŒæ—¶æ”¯æŒamd64å’Œarm64æ¶æ„</span></span><br><span class=\"line\">  Platform:  linux/amd64</span><br><span class=\"line\">  Platform:  linux/arm64/v8</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ä¹Ÿå¯ä»¥ä½¿ç”¨skopeoå®¹å™¨çš„æ–¹å¼è¿›è¡ŒæŸ¥è¯¢</span></span><br><span class=\"line\">docker run --<span class=\"built_in\">rm</span> quay.io/skopeo/stable:latest inspect --raw --override-os linux docker://docker.1ms.run/openjdk:17-slim | jq -r <span class=\"string\">&#x27;.manifests[].platform | &quot;\\(.os)/\\(.architecture)/\\(.variant)&quot;&#x27;</span> | <span class=\"built_in\">sort</span> | <span class=\"built_in\">uniq</span> | sed <span class=\"string\">&#x27;s/\\/null//&#x27;</span></span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡ºç»“æœ</span></span><br><span class=\"line\">linux/amd64</span><br><span class=\"line\">linux/arm64/v8</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æ›¿æ¢æ”¯æŒå¤šæ¶æ„çš„é•œåƒåé‡æ–°æ„å»ºé•œåƒå°±ä¼šæˆåŠŸ</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker buildx build --platform linux/arm64 -t <span class=\"string\">&quot;app.arm64&quot;</span> --load .</span><br><span class=\"line\">docker buildx build --platform linux/amd64 -t <span class=\"string\">&quot;app.amd64&quot;</span> --load .</span><br><span class=\"line\"><span class=\"comment\"># åˆ—å‡ºé•œåƒ</span></span><br><span class=\"line\">docker images</span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡ºç»“æœ</span></span><br><span class=\"line\">REPOSITORY              TAG                IMAGE ID       CREATED        SIZE</span><br><span class=\"line\">app.amd64               latest             859162438372   2 hours ago    431MB</span><br><span class=\"line\">app.arm64               latest             0058c70dd16e   2 hours ago    426MB</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹æ„å»ºåé•œåƒçš„æ¶æ„</span></span><br><span class=\"line\">docker inspect app.amd64 | jq <span class=\"string\">&#x27;.[0].Architecture&#x27;</span></span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡º</span></span><br><span class=\"line\"><span class=\"string\">&quot;amd64&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æˆ‘ä»¬ä¹Ÿå¯ä»¥å°†æ„å»ºåçš„é•œåƒè¾“å‡ºåˆ°æœ¬åœ°ç›®å½•</span></span><br><span class=\"line\">docker buildx build --platform linux/amd64 -t <span class=\"string\">&quot;app.amd64&quot;</span> --output <span class=\"built_in\">type</span>=docker,dest=./app.amd64.tar .</span><br><span class=\"line\"><span class=\"comment\"># ç„¶åå†å°†é•œåƒå¯¼å…¥åˆ°æœ¬åœ°é•œåƒä»“åº“ä¸­</span></span><br><span class=\"line\">docker load -i app.amd64.tar</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>--load</code>å’Œ <code>--output</code>éƒ½ä¸æ”¯æŒä¸€ä¸ªé•œåƒå¤šç§æ¶æ„ï¼Œè¦æ„å»ºåƒ<code>openjdk:17-slim</code>è¿™ç§æ”¯æŒå¤šæ¶æ„çš„é•œåƒå¯ä»¥ä½¿ç”¨<code>--push</code>ï¼Œä¸€æ­¥å°±æ¨é€åˆ°è¿œç¨‹ä»“åº“</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># æ„å»ºå¤šæ¶æ„é•œåƒï¼Œ--push å¯ä»¥ä¸€æ­¥åšåˆ°ï¼šå¤šå¹³å°æ„å»ºçš„é•œåƒä¸èƒ½åªä¿å­˜åˆ°æœ¬åœ°ï¼Œå¿…é¡»æ¨é€åˆ°è¿œç¨‹ registry æ‰èƒ½åˆå¹¶æ¶æ„ã€‚</span></span><br><span class=\"line\"><span class=\"comment\"># è¿™é‡Œä»¥æ¨é€åˆ° docker hub ä¸ºä¾‹</span></span><br><span class=\"line\"><span class=\"comment\"># ç™»å½• docker hup</span></span><br><span class=\"line\">docker login -u hanqunfeng</span><br><span class=\"line\"><span class=\"comment\"># æ„å»ºï¼Œæ³¨æ„è¿™é‡Œçš„é•œåƒåç§°è¦åŠ ä¸Šä½ çš„dockerhubçš„å‘½åç©ºé—´ï¼Œ--platform æŒ‡å®šæ„å»ºçš„æ¶æ„ï¼Œå¯ä»¥æŒ‡å®šå¤šä¸ªï¼Œéœ€è¦Dockerfileé…ç½®åŸºç¡€é•œåƒæ”¯æŒå¯¹åº”çš„æ¶æ„</span></span><br><span class=\"line\">docker buildx build --platform linux/amd64,linux/arm64 -t hanqunfeng/app:latest --push .</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/WdmJx0.png\" alt=\"\"></p>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>é•œåƒæ‹‰å–</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># æ‹‰å–æŒ‡å®šæ¶æ„é•œåƒï¼Œä¸æŒ‡å®š --platform å‚æ•°ï¼Œé»˜è®¤æ‹‰å–å½“å‰æ¶æ„çš„é•œåƒ</span></span><br><span class=\"line\">docker pull --platform=linux/arm64 hanqunfeng/app:latest</span><br></pre></td></tr></table></figure>\n<h3 id=\"ç¤ºä¾‹äºŒï¼šå¤šé˜¶æ®µæ„å»º\">ç¤ºä¾‹äºŒï¼šå¤šé˜¶æ®µæ„å»º</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>è¦æ±‚æ¯ä¸ªé˜¶æ®µä¸­çš„åŸºç¡€é•œåƒéƒ½è¦æ”¯æŒå¤šæ¶æ„</p>\n</li>\n</ul>\n<figure class=\"highlight dockerfile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ç¬¬ä¸€é˜¶æ®µï¼šè·å–ä»£ç </span></span><br><span class=\"line\"><span class=\"keyword\">FROM</span> alpine/git AS fetcher</span><br><span class=\"line\"><span class=\"keyword\">WORKDIR</span><span class=\"language-bash\"> /workspace/application</span></span><br><span class=\"line\"><span class=\"comment\"># å°†æ›¿æ¢ä¸ºå®é™…çš„Gitä»“åº“URLå’Œåˆ†æ”¯/æ ‡ç­¾</span></span><br><span class=\"line\"><span class=\"keyword\">ARG</span> GIT_REPOSITORY=https://gitee.com/hanqunfeng/springbootweb.git</span><br><span class=\"line\"><span class=\"keyword\">ARG</span> GIT_BRANCH=master</span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"language-bash\"> git <span class=\"built_in\">clone</span> -b <span class=\"variable\">$&#123;GIT_BRANCH&#125;</span> <span class=\"variable\">$&#123;GIT_REPOSITORY&#125;</span> .</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ç¬¬äºŒé˜¶æ®µï¼šä½¿ç”¨Mavenç¯å¢ƒè¿›è¡Œæ„å»º</span></span><br><span class=\"line\"><span class=\"keyword\">FROM</span> maven:<span class=\"number\">3.8</span>.<span class=\"number\">4</span>-openjdk-<span class=\"number\">17</span> AS builder</span><br><span class=\"line\"><span class=\"keyword\">WORKDIR</span><span class=\"language-bash\"> /workspace/application</span></span><br><span class=\"line\"><span class=\"comment\"># ä»ç¬¬ä¸€é˜¶æ®µå¤åˆ¶ä»£ç </span></span><br><span class=\"line\"><span class=\"keyword\">COPY</span><span class=\"language-bash\"> --from=fetcher /workspace/application .</span></span><br><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨Mavenæ¸…ç†å¹¶æ‰“åŒ…</span></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"language-bash\"> mvn clean package -DskipTests</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ç¬¬ä¸‰é˜¶æ®µï¼šåˆ›å»ºæœ€ç»ˆçš„è¿è¡Œç¯å¢ƒ</span></span><br><span class=\"line\"><span class=\"keyword\">FROM</span> openjdk:<span class=\"number\">17</span>-slim</span><br><span class=\"line\"><span class=\"keyword\">WORKDIR</span><span class=\"language-bash\"> /app</span></span><br><span class=\"line\"><span class=\"comment\"># è®¾ç½®è¿è¡Œæ—¶ç¯å¢ƒå˜é‡</span></span><br><span class=\"line\"><span class=\"keyword\">ENV</span> JAVA_OPTS=<span class=\"string\">&quot;-Xms1024M -Xmx1024M -XX:MetaspaceSize=128M -XX:MaxMetaspaceSize=128M&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># å°†ç¬¬äºŒé˜¶æ®µç”Ÿæˆçš„ç›®æ ‡æ–‡ä»¶å¤åˆ¶åˆ°è¿™é‡Œã€‚æ³¨æ„è¿™é‡Œå‡è®¾ä½ çš„spring bootå·¥ç¨‹æ‰“æˆçš„jaråæ˜¯target/app.jar</span></span><br><span class=\"line\"><span class=\"keyword\">COPY</span><span class=\"language-bash\"> --from=builder /workspace/application/target/app.jar app.jar</span></span><br><span class=\"line\"><span class=\"comment\"># æš´éœ²ç«¯å£ï¼ˆå¦‚æœéœ€è¦çš„è¯ï¼‰ã€‚è¯·æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹ç«¯å£å·</span></span><br><span class=\"line\"><span class=\"keyword\">EXPOSE</span> <span class=\"number\">8080</span></span><br><span class=\"line\"><span class=\"comment\"># å£°æ˜ä¸€ä¸ªå·æŒ‚è½½ç‚¹ï¼Œè¿è¡Œå®¹å™¨æ—¶å¯å°†è¯¥è·¯å¾„æ˜ å°„åˆ°å®¿ä¸»æœºï¼Œå®ç°æ•°æ®æŒä¹…åŒ–</span></span><br><span class=\"line\"><span class=\"keyword\">VOLUME</span><span class=\"language-bash\"> [<span class=\"string\">&quot;/app/logs&quot;</span>]</span></span><br><span class=\"line\"><span class=\"comment\"># è®¾ç½®å®¹å™¨å¯åŠ¨æ—¶çš„ä¸»å‘½ä»¤ï¼ˆENTRYPOINT ä¸ä¼šè¢« docker run å‚æ•°è¦†ç›–ï¼‰</span></span><br><span class=\"line\"><span class=\"keyword\">ENTRYPOINT</span><span class=\"language-bash\"> [<span class=\"string\">&quot;sh&quot;</span>, <span class=\"string\">&quot;-c&quot;</span>, <span class=\"string\">&quot;java <span class=\"variable\">$JAVA_OPTS</span> -jar app.jar&quot;</span>]</span></span><br><span class=\"line\"><span class=\"comment\"># CMD æä¾›é»˜è®¤çš„è¿è¡Œå‚æ•°ï¼Œå¯ä»¥è¢« docker run è¦†ç›–</span></span><br><span class=\"line\"><span class=\"comment\"># è¿™é‡Œé€šè¿‡ Spring Boot å‚æ•°è®¾ç½®å¯åŠ¨ç¯å¢ƒå’Œç«¯å£å·</span></span><br><span class=\"line\"><span class=\"keyword\">CMD</span><span class=\"language-bash\"> [<span class=\"string\">&quot;--spring.profiles.active=app&quot;</span>, <span class=\"string\">&quot;--server.port=8080&quot;</span>]</span></span><br><span class=\"line\"><span class=\"comment\"># è¿™é‡Œä½¿ç”¨çš„æ˜¯ ENTRYPOINT + CMD çš„æ··åˆæ¨¡å¼</span></span><br><span class=\"line\"><span class=\"comment\"># å®Œæ•´å‘½ä»¤ï¼š java $JAVA_OPTS -jar app.jar --spring.profiles.active=app --server.port=8080</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æ„å»ºé•œåƒ</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># æ„å»ºå¤šå¹³å°é•œåƒå¹¶å‘å¸ƒåˆ°dockerhub</span></span><br><span class=\"line\">docker buildx build --platform linux/amd64,linux/arm64 -t hanqunfeng/springboot:latest --push .</span><br></pre></td></tr></table></figure>\n<h2 id=\"å¦‚ä½•å°†æ„å»ºå¥½çš„å¤šä¸ªå•å¹³å°é•œåƒå‘å¸ƒä¸ºä¸€ä¸ªå¤šå¹³å°é•œåƒ\">å¦‚ä½•å°†æ„å»ºå¥½çš„å¤šä¸ªå•å¹³å°é•œåƒå‘å¸ƒä¸ºä¸€ä¸ªå¤šå¹³å°é•œåƒ</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å¦‚æœä½ å·²ç»åˆ†åˆ«æ„å»ºå¥½å•å¹³å°é•œåƒï¼Œä¹Ÿå¯ä»¥ç”¨ <code>docker buildx imagetools create</code> æ¥åˆå¹¶</p>\n</li>\n<li class=\"lvl-2\">\n<p>ä»¥ä¸Šé¢åˆ›å»ºçš„ä¸¤ä¸ªå•å¹³å°é•œåƒä¸ºä¾‹</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># åˆ—å‡ºé•œåƒ</span></span><br><span class=\"line\">docker images</span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡ºç»“æœ</span></span><br><span class=\"line\">REPOSITORY              TAG                IMAGE ID       CREATED        SIZE</span><br><span class=\"line\">app.amd64               latest             859162438372   2 hours ago    431MB</span><br><span class=\"line\">app.arm64               latest             0058c70dd16e   2 hours ago    426MB</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ä¸€å®šè¦æ¨é€å•å¹³å°é•œåƒåˆ°è¿œç¨‹ä»“åº“ï¼Œå¦åˆ™æ— æ³•å®Œæˆåˆå¹¶</span></span><br><span class=\"line\">docker tag app.amd64 hanqunfeng/app:amd64</span><br><span class=\"line\">docker push hanqunfeng/app:amd64</span><br><span class=\"line\"></span><br><span class=\"line\">docker tag app.arm64 hanqunfeng/app:arm64</span><br><span class=\"line\">docker push hanqunfeng/app:arm64</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># åˆå¹¶ï¼Œåˆ›å»ºå¤šå¹³å°é•œåƒæŒ‡å‘ï¼ˆmanifest listï¼‰</span></span><br><span class=\"line\">docker buildx imagetools create \\</span><br><span class=\"line\">  --tag hanqunfeng/app:latest \\</span><br><span class=\"line\">   hanqunfeng/app:amd64 \\</span><br><span class=\"line\">   hanqunfeng/app:arm64</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/5azhzj.png\" alt=\"\"></p>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å¦‚æœä¸éœ€è¦å•å¹³å°é•œåƒï¼Œå¯ä»¥åœ¨dockerhubä¸Šåˆ é™¤å³å¯ã€‚</p>\n</li>\n</ul>\n<h2 id=\"ç§»é™¤-BuildKitï¼ˆBuildxï¼‰æ„å»ºè¿‡ç¨‹ä¸­äº§ç”Ÿçš„ç¼“å­˜æ•°æ®\">ç§»é™¤ BuildKitï¼ˆBuildxï¼‰æ„å»ºè¿‡ç¨‹ä¸­äº§ç”Ÿçš„ç¼“å­˜æ•°æ®</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>BuildKitï¼ˆBuildxï¼‰æ„å»ºè¿‡ç¨‹ä¼šäº§ç”Ÿç¼“å­˜æ•°æ®ï¼ŒåŒ…æ‹¬æœªä½¿ç”¨çš„ä¸­é—´é•œåƒã€æ„å»ºå±‚ç­‰ã€‚å¯¹äºé¢‘ç¹ä½¿ç”¨ Docker æ„å»ºçš„å¼€å‘è€…æ¥è¯´ï¼Œè¿™äº›ç¼“å­˜ä¼šé€æ¸å ç”¨å¤§é‡ç£ç›˜ç©ºé—´ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>å¯ä»¥é€šè¿‡è¯¥å‘½ä»¤æŸ¥çœ‹ç¼“å­˜å ç”¨ç£ç›˜ç©ºé—´çš„å¤§å°</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker buildx <span class=\"built_in\">du</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>docker buildx prune</code> æ˜¯ä¸€ä¸ªç”¨äº æ¸…ç† Docker Buildx æ„å»ºç¼“å­˜ çš„å‘½ä»¤ï¼Œå¸¸ç”¨äºé‡Šæ”¾ç£ç›˜ç©ºé—´ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>å‘½ä»¤è¯­æ³•</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker buildx prune [OPTIONS]</span><br></pre></td></tr></table></figure>\n<table>\n<thead>\n<tr>\n<th>OPTIONS</th>\n<th>ä½œç”¨</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>-a</code>, <code>--all</code></td>\n<td><strong>åŒ…æ‹¬å†…éƒ¨/å‰ç«¯é•œåƒ</strong>ã€‚é»˜è®¤åªåˆ é™¤æ— ç”¨ç¼“å­˜ï¼ŒåŠ ä¸Šè¯¥å‚æ•°ä¼šæ¸…é™¤æ›´å¤šç¼“å­˜å†…å®¹ï¼ŒåŒ…æ‹¬å¯èƒ½ä»å¯ç”¨çš„å†…å®¹ï¼ˆæ›´å½»åº•ï¼‰ã€‚</td>\n</tr>\n<tr>\n<td><code>--builder string</code></td>\n<td>æŒ‡å®šä½¿ç”¨å“ªä¸ª builder å®ä¾‹ï¼ˆå¯é€šè¿‡ <code>docker buildx ls</code> æŸ¥çœ‹å½“å‰æœ‰å“ªäº› builderï¼‰ã€‚</td>\n</tr>\n<tr>\n<td><code>--filter filter</code></td>\n<td>è®¾å®šæ¸…ç†æ¡ä»¶ï¼Œä¾‹å¦‚ï¼š<code>until=24h</code> è¡¨ç¤ºåªåˆ é™¤ 24 å°æ—¶å‰çš„ç¼“å­˜ã€‚</td>\n</tr>\n<tr>\n<td><code>-f</code>, <code>--force</code></td>\n<td><strong>ä¸æç¤ºç¡®è®¤ï¼Œç›´æ¥æ‰§è¡Œæ¸…ç†æ“ä½œ</strong>ã€‚å¸¸ç”¨äºè„šæœ¬ä¸­ã€‚</td>\n</tr>\n<tr>\n<td><code>--keep-storage bytes</code></td>\n<td>ä¿ç•™æŒ‡å®šå¤§å°çš„ç¼“å­˜ç©ºé—´ï¼Œå…¶ä½™åˆ é™¤ï¼ˆå¦‚ï¼š<code>--keep-storage 5GB</code>ï¼‰ã€‚</td>\n</tr>\n<tr>\n<td><code>--verbose</code></td>\n<td>è¾“å‡ºæ›´è¯¦ç»†çš„æ¸…ç†ä¿¡æ¯ã€‚</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ç¤ºä¾‹</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># åˆ é™¤æ‰€æœ‰æœªä½¿ç”¨çš„ç¼“å­˜ï¼Œå¹¶è·³è¿‡ç¡®è®¤æç¤º</span></span><br><span class=\"line\">docker buildx prune -f</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># åªåˆ é™¤ 24 å°æ—¶å‰çš„ç¼“å­˜ï¼Œä¿ç•™ 10GB çš„ç¼“å­˜ç©ºé—´</span></span><br><span class=\"line\">docker buildx prune --filter <span class=\"string\">&quot;until=24h&quot;</span> --keep-storage 10GB</span><br></pre></td></tr></table></figure>","content_text":"æ‘˜è¦ æœ¬æ–‡ä»‹ç» Docker å‘½ä»¤ ä¸­ Dockerfile å¤šå¹³å°æ„å»ºçš„ä½¿ç”¨æ–¹æ³• Dockerå®˜æ–¹æ–‡æ¡£ Dockerfileå®˜æ–¹æ–‡æ¡£ Multi-platform builds ä»€ä¹ˆæ˜¯Dockerfile å¤šå¹³å°æ„å»ºï¼Ÿ Dockerfile å¤šå¹³å°æ„å»ºï¼Œå¯ä»¥æ„å»ºå¤šä¸ªå¹³å°é•œåƒï¼Œæ¯”å¦‚ arm64ã€amd64ã€armã€386 ç­‰ã€‚ åœ¨æ²¡æœ‰å®‰è£… docker-buildx-plugin çš„æƒ…å†µä¸‹ï¼Œdocker build å‘½ä»¤æ˜¯ä¸æ”¯æŒä½¿ç”¨ --platform æ„å»ºå‡ºè·¨å¹³å°é•œåƒçš„ï¼Œå…¶ä»…èƒ½æ„å»ºä¸æœ¬æœºæ¶æ„å¹³å°ç›¸åŒçš„é•œåƒã€‚ è¦çœŸæ­£å®ç°è·¨å¹³å°æ„å»ºï¼ˆmulti-platform buildï¼‰ï¼Œæ¯”å¦‚åœ¨ amd64 ä¸Šæ„å»º arm64 çš„é•œåƒï¼Œéœ€è¦ä½¿ç”¨ BuildKit å’Œ buildx æ’ä»¶ã€‚ docker-buildx-plugin æ˜¯åŸºäº BuildKit æ„å»ºçš„ï¼Œä½†å®ƒæœ¬èº«æ˜¯ Buildx çš„ä¸€ä¸ªå®ç°å½¢å¼ï¼Œå®ƒæ‰©å±•äº† docker build çš„èƒ½åŠ›ï¼Œæ”¯æŒå¤šå¹³å°æ„å»ºï¼ˆå¦‚åŒæ—¶æ„å»º Linux/amd64 å’Œ Linux/arm64ç­‰ï¼‰ã€‚ å®‰è£… docker-buildx-plugin éšdockeræœåŠ¡ä¸€èµ·å®‰è£… 1sudo dnf -y install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin å•ç‹¬å®‰è£… 1sudo dnf -y install docker-buildx-plugin æŸ¥çœ‹ç‰ˆæœ¬ 1docker buildx version docker buildx åŸºæœ¬å‘½ä»¤ ä»¥ä¸‹å‘½ä»¤åœ¨åé¢çš„ç¤ºä¾‹ä¸­éƒ½æœ‰ä½¿ç”¨ å‘½ä»¤ è¯´æ˜ docker buildx create åˆ›å»ºä¸€ä¸ªæ–°çš„æ„å»ºå™¨å®ä¾‹ docker buildx use è®¾ç½®å½“å‰ä½¿ç”¨çš„æ„å»ºå™¨ docker buildx inspect æŸ¥çœ‹æ„å»ºå™¨çŠ¶æ€å’Œæ”¯æŒçš„å¹³å° docker buildx build æ„å»ºé•œåƒï¼ˆå¢å¼ºç‰ˆï¼‰ï¼Œç­‰åŒäº docker build docker buildx ls åˆ—å‡ºæ‰€æœ‰æ„å»ºå™¨ docker buildx rm åˆ é™¤æ„å»ºå™¨ docker buildx du æŸ¥çœ‹æ„å»ºå™¨ä½¿ç”¨çš„ç£ç›˜ç©ºé—´ docker buildx prune åˆ é™¤æ„å»ºè¿‡ç¨‹ä¸­äº§ç”Ÿçš„ç¼“å­˜ docker buildx version æŸ¥çœ‹ Docker Buildx çš„ç‰ˆæœ¬ä¿¡æ¯ è¦è®©Dockeræ”¯æŒå¤šå¹³å°æ„å»ºï¼Œéœ€è¦æ»¡è¶³ä»¥ä¸‹å‡ ä¸ªæ¡ä»¶ï¼š Linuxå†…æ ¸å¼€å¯å¤šå¤„ç†å™¨æ¶æ„æ”¯æŒ æ„å»ºæ—¶ä½¿ç”¨åŸºäºdocker-containeré©±åŠ¨çš„Buildxå®ä¾‹ ä½¿ç”¨docker buildx buildå‘½ä»¤æ„å»ºé•œåƒï¼Œæ„å»ºå‘½ä»¤å¿…é¡»æŒ‡å®šâ€“platformå‚æ•° Linuxå†…æ ¸å¼€å¯å¤šå¤„ç†å™¨æ¶æ„æ”¯æŒ 123456789101112131415161718# åˆ—å‡ºæ‰€æœ‰æ„å»ºå™¨ï¼Œé»˜è®¤æƒ…å†µä¸‹åªæœ‰ä¸€ä¸ªåç§°ä¸º&quot;default&quot;çš„æ„å»ºå™¨docker buildx ls## è¾“å‡ºNAME/NODE DRIVER/ENDPOINT STATUS BUILDKIT PLATFORMSdefault docker \\_ default \\_ default running v0.13.2 linux/amd64, linux/amd64/v2, linux/amd64/v3, linux/amd64/v4, linux/386# å¼€å¯å¤šå¤„ç†å™¨æ¶æ„æ”¯æŒdocker run --privileged --rm tonistiigi/binfmt --install all# è¿™ä¸ªé•œåƒç”¨å®Œå°±å¯ä»¥åˆ é™¤äº†docker rmi tonistiigi/binfmt# å†æ¬¡åˆ—å‡ºæ‰€æœ‰æ„å»ºå™¨docker buildx ls## è¾“å‡ºï¼Œæ­¤æ—¶å¯ä»¥çœ‹åˆ°PLATFORMSä¸­æœ‰å¤šä¸ªå¹³å°NAME/NODE DRIVER/ENDPOINT STATUS BUILDKIT PLATFORMSdefault* docker \\_ default \\_ default running v0.13.2 linux/amd64, linux/amd64/v2, linux/amd64/v3, linux/amd64/v4, linux/386, linux/arm64, linux/riscv64, linux/ppc64le, linux/s390x, linux/mips64le, linux/mips64, linux/loong64, linux/arm/v7, linux/arm/v6 æ„å»ºæ—¶ä½¿ç”¨åŸºäºdocker-containeré©±åŠ¨çš„Buildxå®ä¾‹ Docker çš„é»˜è®¤æ„å»ºé©±åŠ¨æ˜¯ dockerï¼Œå®ƒæ˜¯è¿è¡Œåœ¨æœ¬åœ° Docker å®ˆæŠ¤è¿›ç¨‹ä¸Šçš„ï¼Œä¸èƒ½è¿›è¡ŒçœŸæ­£çš„å¤šå¹³å°æ„å»ºï¼ˆä»…èƒ½æ„å»ºå½“å‰å¹³å°ï¼‰ã€‚ å¤šå¹³å°æ„å»ºéœ€è¦ä½¿ç”¨ BuildKit çš„ container é©±åŠ¨ï¼Œå®ƒä»¥å®¹å™¨çš„å½¢å¼è¿è¡Œæ„å»ºå™¨ï¼Œæ”¯æŒè™šæ‹ŸåŒ–å¹³å°å¹¶è¡Œæ„å»ºã€‚ 123456789101112131415# æŸ¥çœ‹å½“å‰é»˜è®¤çš„æ„å»ºå™¨defaultdocker buildx inspect default# è¾“å‡ºName: defaultDriver: dockerLast Activity: 2025-06-06 07:42:42 +0000 UTCNodes:Name: defaultEndpoint: defaultStatus: runningBuildKit version: v0.13.2Platforms: linux/amd64, linux/amd64/v2, linux/amd64/v3, linux/amd64/v4, linux/386, linux/arm64, linux/riscv64, linux/ppc64le, linux/s390x, linux/mips64le, linux/mips64, linux/loong64, linux/arm/v7, linux/arm/v6Labels: org.mobyproject.buildkit.worker.moby.host-gateway-ip: 172.17.0.1 åˆ›å»ºåŸºäº docker-container é©±åŠ¨çš„Buildxå®ä¾‹ 12345678910111213# åˆ›å»ºå¹¶åˆ‡æ¢åˆ°åä¸ºmybuilderçš„æ„å»ºå™¨å®ä¾‹docker buildx create --name mybuilder --use --driver docker-container# æŸ¥çœ‹å½“å‰æ„å»ºå™¨ä¿¡æ¯ï¼Œ--bootstrapï¼šæŸ¥çœ‹å‰ç¡®ä¿æ„å»ºå™¨å·²å¯åŠ¨ ï¼Œæ­¤æ—¶çœ‹åˆ°å…¶Driverä¸ºdocker-containerï¼Œè¿™ä¸ªå‘½ä»¤ç¬¬ä¸€æ¬¡æ‰§è¡Œæ—¶å¯èƒ½ä¼šæç¤ºé”™è¯¯ï¼Œä¸è¿‡ä¸ç”¨ç®¡ï¼Œå†æ¬¡è¿è¡Œå°±æ­£å¸¸äº†docker buildx inspect --bootstrap## è¾“å‡ºName: mybuilderDriver: docker-containerâ€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦# æ­¤æ—¶ä¼šå¯åŠ¨ä¸€ä¸ªåç§°ä¸º`buildx_buildkit_mybuilder0`çš„å®¹å™¨ï¼Œæ¯åˆ›å»ºä¸€ä¸ªæ„å»ºå™¨å®ä¾‹ï¼Œå°±ä¼šå¯åŠ¨ä¸€ä¸ªåç§°ä¸º`buildx_buildkit_xxx`çš„å®¹å™¨ï¼Œåˆ é™¤æ„å»ºå™¨æ—¶ï¼Œå…¶å¯¹åº”çš„å®¹å™¨ä¹Ÿä¼šè¢«åˆ é™¤docker psCONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES0ab9cab9ec9b moby/buildkit:buildx-stable-1 &quot;buildkitd --allow-iâ€¦&quot; About an hour ago Up About an hour buildx_buildkit_mybuilder0 buildx_buildkit_xxxè¿™ä¸ªå®¹å™¨å°±æ˜¯ä¸€ä¸ª BuildKit å®ˆæŠ¤è¿›ç¨‹å®¹å™¨ï¼Œå®ƒæ˜¯æ‰§è¡Œ buildx æ„å»ºä»»åŠ¡çš„å®é™…å·¥ä½œå¼•æ“ã€‚å…¶å¯¹åº”çš„é•œåƒä¸ºmoby/buildkit:buildx-stable-1ï¼Œå®¹å™¨ä¼šåœ¨æ‰§è¡Œdocker buildx build æˆ– docker buildx inspect --bootstrap æ—¶å¯åŠ¨ åŠŸèƒ½ è¯´æ˜ ğŸ‘· æ‰§è¡Œæ„å»ºä»»åŠ¡ çœŸæ­£æ‰§è¡Œ buildx build æŒ‡ä»¤é‡Œçš„æ„å»ºè¿‡ç¨‹ï¼Œæ¯”å¦‚å¤šé˜¶æ®µæ„å»ºã€ç¼“å­˜å¤„ç†ã€è·¨å¹³å°ç¼–è¯‘ç­‰ ğŸ“¦ æ‹‰å–é•œåƒ æ‹‰å– Dockerfile ä¸­çš„åŸºç¡€é•œåƒ ğŸ“¤ ä¸Šä¼ /å¯¼å‡ºé•œåƒ æ”¯æŒå¯¼å‡ºä¸º docker image, tar, æ¨é€åˆ°è¿œç¨‹ registry ğŸª£ ç®¡ç†ç¼“å­˜ ç®¡ç†æ„å»ºç¼“å­˜ï¼ˆä¸­é—´é•œåƒã€å±‚ç­‰ï¼‰ä»¥åŠ é€Ÿåç»­æ„å»º ğŸŒ æ”¯æŒå¤šå¹³å° é€šè¿‡ QEMU æˆ–äº¤å‰ç¼–è¯‘å™¨æ”¯æŒè·¨å¹³å°ï¼ˆå¦‚æ„å»º arm64 é•œåƒï¼‰ åœ¨å›½å†…ç¯å¢ƒä½¿ç”¨æ—¶ï¼Œå¦‚æœä¸èƒ½ç§‘å­¦ä¸Šç½‘ï¼Œå½“æˆ‘ä»¬åœ¨æ„å»ºé•œåƒæ—¶ä¼šæç¤ºæ— æ³•æ‹‰å–åŸºç¡€é•œåƒï¼Œå³ä¾¿æˆ‘ä»¬å·²ç»åœ¨/etc/docker/daemon.jsonä¸­é…ç½®äº†å›½å†…çš„é•œåƒæºä¹Ÿä¸è¡Œï¼Œè¿™æ˜¯å› ä¸ºdocker buildx ä½¿ç”¨çš„æ˜¯ BuildKitï¼Œå®ƒçš„è¡Œä¸ºä¸åŒäºä¼ ç»Ÿçš„ docker build ç‰¹æ€§ docker buildï¼ˆä¼ ç»Ÿï¼‰ docker buildxï¼ˆBuildKitï¼‰ æ˜¯å¦ä½¿ç”¨æœ¬åœ°é•œåƒç¼“å­˜ âœ… æ˜¯ âš ï¸ ä¸æ˜¯ æ˜¯å¦éœ€è¦è”ç½‘æ‹‰å–å…ƒæ•°æ®ï¼ˆå³ä½¿é•œåƒå·²å­˜åœ¨ï¼‰ å¦ æ˜¯ æ„å»ºç½‘ç»œéš”ç¦» ä¸éš”ç¦» éš”ç¦»æ„å»ºï¼Œæ— æ³•ç›´æ¥è®¿é—®å®¿ä¸»é•œåƒç¼“å­˜ è§£å†³æ–¹æ³•ä¸ºæ„å»ºå™¨é…ç½®é•œåƒæº 1234567891011121314151617181920212223242526272829# åˆ›å»º BuildKit é…ç½®æ–‡ä»¶ buildkitd.tomlcat &lt;&lt;EOF &gt; buildkitd.toml[registry.&quot;docker.io&quot;] mirrors = [&quot;https://docker.1ms.run&quot;][worker.oci] gc = trueEOF# åˆ›å»º BuildKit æ„å»ºå™¨ï¼Œå¹¶æŒ‡å®šé…ç½®æ–‡ä»¶docker buildx create --name mybuilder --use --driver docker-container --config ./buildkitd.tomldocker buildx inspect --bootstrap# å¦‚æœå­˜åœ¨åŒåçš„æ„å»ºå™¨ï¼Œåˆ™åˆ é™¤å®ƒåå†åˆ›å»ºdocker buildx rm mybuilderdocker buildx create --name mybuilder --use --driver docker-container --config ./buildkitd.tomldocker buildx inspect --bootstrap# æŸ¥çœ‹æ„å»ºå™¨åˆ—è¡¨docker buildx ls## è¾“å‡ºNAME/NODE DRIVER/ENDPOINT STATUS BUILDKIT PLATFORMSmybuilder* docker-container \\_ mybuilder0 \\_ unix:///var/run/docker.sock running v0.21.1 linux/amd64, linux/amd64/v2, linux/amd64/v3, linux/amd64/v4, linux/arm64, linux/riscv64, linux/ppc64le, linux/s390x, linux/386, linux/mips64le, linux/mips64, linux/loong64, linux/arm/v7, linux/arm/v6default docker \\_ default \\_ default running v0.13.2 linux/amd64, linux/amd64/v2, linux/amd64/v3, linux/amd64/v4, linux/386, linux/arm64, linux/riscv64, linux/ppc64le, linux/s390x, linux/mips64le, linux/mips64, linux/loong64, linux/arm/v7, linux/arm/v6# å¦‚æœè¦åˆ‡æ¢å›é»˜è®¤çš„æ„å»ºå™¨ï¼Œè¯·æ‰§è¡Œä»¥ä¸‹å‘½ä»¤docker buildx use default ä½¿ç”¨docker buildx buildå‘½ä»¤æ„å»ºé•œåƒï¼Œæ„å»ºå‘½ä»¤å¿…é¡»æŒ‡å®š--platformå‚æ•° ç¤ºä¾‹ä¸€ï¼šå•é˜¶æ®µæ„å»º æˆ‘ä»¬ä¾æ—§ä»¥ä¸€ä¸ªspringbooté¡¹ç›®ä¸ºä¾‹ï¼Œå…¶Dockerfileå¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132333435# ä½¿ç”¨è½»é‡çº§ Alpine ç‰ˆæœ¬çš„ OpenJDK 17 å®˜æ–¹é•œåƒï¼Œé€‚åˆéƒ¨ç½² Spring Boot åº”ç”¨FROM openjdk:17-alpine# è®¾ç½®æ„å»ºæ—¶å˜é‡ï¼Œé»˜è®¤ä½¿ç”¨æ„å»ºå¥½çš„ jar æ–‡ä»¶ARG JAR_FILE=app.jar# è®¾ç½®è¿è¡Œæ—¶ç¯å¢ƒå˜é‡ENV JAVA_OPTS=&quot;-Xms1024M -Xmx1024M -XX:MetaspaceSize=128M -XX:MaxMetaspaceSize=128M&quot;ENV TZ=Asia/Shanghai# é•œåƒå…ƒä¿¡æ¯LABEL maintainer=&quot;yourname@example.com&quot;LABEL version=&quot;1.0.0&quot;LABEL description=&quot;ç”¨äºéƒ¨ç½² Spring Boot åº”ç”¨çš„ç”Ÿäº§çº§é•œåƒ&quot;# è®¾ç½®å·¥ä½œç›®å½•WORKDIR /app# å¤åˆ¶ Spring Boot æ„å»ºç”Ÿæˆçš„ jar åŒ…COPY $&#123;JAR_FILE&#125; app.jar# å£°æ˜æš´éœ²çš„åº”ç”¨ç«¯å£ï¼ˆSpring Boot é»˜è®¤æ˜¯ 8080ï¼‰EXPOSE 8080# è®¾ç½®å®¹å™¨å¯åŠ¨æ—¶çš„ä¸»å‘½ä»¤ï¼ˆENTRYPOINT ä¸ä¼šè¢« docker run å‚æ•°è¦†ç›–ï¼‰ENTRYPOINT [&quot;sh&quot;, &quot;-c&quot;, &quot;java $JAVA_OPTS -jar app.jar&quot;]# CMD æä¾›é»˜è®¤çš„è¿è¡Œå‚æ•°ï¼Œå¯ä»¥è¢« docker run è¦†ç›–# è¿™é‡Œé€šè¿‡ Spring Boot å‚æ•°è®¾ç½®å¯åŠ¨ç¯å¢ƒå’Œç«¯å£å·CMD [&quot;--spring.profiles.active=app&quot;, &quot;--server.port=8080&quot;]# è¿™é‡Œä½¿ç”¨çš„æ˜¯ ENTRYPOINT + CMD çš„æ··åˆæ¨¡å¼# å®Œæ•´å‘½ä»¤ï¼š java $JAVA_OPTS -jar app.jar --spring.profiles.active=app --server.port=8080# å£°æ˜ä¸€ä¸ªå·æŒ‚è½½ç‚¹ï¼Œè¿è¡Œå®¹å™¨æ—¶å¯å°†è¯¥è·¯å¾„æ˜ å°„åˆ°å®¿ä¸»æœºï¼Œå®ç°æ•°æ®æŒä¹…åŒ–VOLUME [&quot;/app/logs&quot;] å¼€å§‹æ„å»ºé•œåƒï¼Œdocker buildx build == docker buildï¼Œæ„å»ºå¤šå¹³å°æ¶æ„æ—¶éœ€è¦ä½¿ç”¨--platformæŒ‡å®šæ„å»ºå¹³å° 123456789# --platform inux/arm64 :æ„å»ºarm64é•œåƒ# -t &quot;app.arm64&quot; :æ„å»ºåé•œåƒåç§°ï¼Œæ²¡æœ‰æŒ‡å®šç‰ˆæœ¬é»˜è®¤å°±æ˜¯ï¼šlatest# --load :æ„å»ºååŠ è½½åˆ°æœ¬åœ°# . :å½“å‰ç›®å½•æŸ¥æ‰¾Dockerfileæ–‡ä»¶# -f :å¦‚æœåç§°ä¸ä¸ºDockerfileï¼Œåˆ™é€šè¿‡è¯¥å‚æ•°æŒ‡å®šDockerfileæ–‡ä»¶çš„åç§°docker buildx build --platform linux/arm64 -t &quot;app.arm64&quot; --load .## æ­¤æ—¶ä¼šé‡åˆ°å¦‚ä¸‹é”™è¯¯ERROR: failed to solve: openjdk:17-alpine: failed to resolve source metadata for docker.io/library/openjdk:17-alpine: no match for platform in manifest: not found## åŸå› ï¼šopenjdk:17-alpine è¿™ä¸ªé•œåƒä¸æ”¯æŒarm64å¹³å°ï¼Œæˆ‘ä»¬éœ€è¦æ›´æ¢ä¸€ä¸ªæ”¯æŒå¤šå¹³å°çš„é•œåƒ å¦‚ä½•æŸ¥çœ‹é•œåƒæ˜¯å¦æ”¯æŒå¤šå¹³å°å‘¢ï¼Ÿå¯ä»¥åœ¨docker hubä¸ŠæŸ¥çœ‹ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ 1234567891011121314151617181920212223242526272829303132# æŸ¥è¯¢é•œåƒæ”¯æŒçš„å¹³å°ï¼Œä¸è¿‡å›½å†…ä¾æ—§æ˜¯ä¸æ”¯æŒdocker buildx imagetools inspect nginx:latest | grep Platform | sort | uniq# å¯ä»¥åœ¨é•œåƒåç§°å‰åŠ ä¸Šå›½å†…çš„é•œåƒä»“åº“åœ°å€è¿›è¡ŒæŸ¥è¯¢ï¼Œæ¯”å¦‚ï¼šdocker buildx imagetools inspect docker.1ms.run/nginx:latest | grep Platform | sort | uniq## è¾“å‡ºç»“æœ Platform: linux/386 Platform: linux/amd64 Platform: linux/arm64/v8 Platform: linux/arm/v5 Platform: linux/arm/v7 Platform: linux/mips64le Platform: linux/ppc64le Platform: linux/s390x Platform: unknown/unknown# æ¥ç€æˆ‘ä»¬æŸ¥çœ‹openjdk:17-alpineè¿™ä¸ªé•œåƒdocker buildx imagetools inspect docker.1ms.run/openjdk:17-alpine | grep Platform | sort | uniq## è¾“å‡ºç»“æœï¼Œå…¶ç¡®å®ä¸æ”¯æŒ linux/arm64 Platform: linux/amd64# æˆ‘ä»¬æ¢ä¸€ä¸ªopenjdké•œåƒè¯•è¯•docker buildx imagetools inspect docker.1ms.run/openjdk:17-slim | grep Platform | sort | uniq## è¾“å‡ºç»“æœï¼Œå¯ä»¥çœ‹åˆ°è¿™ä¸ªé•œåƒåŒæ—¶æ”¯æŒamd64å’Œarm64æ¶æ„ Platform: linux/amd64 Platform: linux/arm64/v8# ä¹Ÿå¯ä»¥ä½¿ç”¨skopeoå®¹å™¨çš„æ–¹å¼è¿›è¡ŒæŸ¥è¯¢docker run --rm quay.io/skopeo/stable:latest inspect --raw --override-os linux docker://docker.1ms.run/openjdk:17-slim | jq -r &#x27;.manifests[].platform | &quot;\\(.os)/\\(.architecture)/\\(.variant)&quot;&#x27; | sort | uniq | sed &#x27;s/\\/null//&#x27;## è¾“å‡ºç»“æœlinux/amd64linux/arm64/v8 æ›¿æ¢æ”¯æŒå¤šæ¶æ„çš„é•œåƒåé‡æ–°æ„å»ºé•œåƒå°±ä¼šæˆåŠŸ 123456789101112131415161718docker buildx build --platform linux/arm64 -t &quot;app.arm64&quot; --load .docker buildx build --platform linux/amd64 -t &quot;app.amd64&quot; --load .# åˆ—å‡ºé•œåƒdocker images## è¾“å‡ºç»“æœREPOSITORY TAG IMAGE ID CREATED SIZEapp.amd64 latest 859162438372 2 hours ago 431MBapp.arm64 latest 0058c70dd16e 2 hours ago 426MB# æŸ¥çœ‹æ„å»ºåé•œåƒçš„æ¶æ„docker inspect app.amd64 | jq &#x27;.[0].Architecture&#x27;## è¾“å‡º&quot;amd64&quot;# æˆ‘ä»¬ä¹Ÿå¯ä»¥å°†æ„å»ºåçš„é•œåƒè¾“å‡ºåˆ°æœ¬åœ°ç›®å½•docker buildx build --platform linux/amd64 -t &quot;app.amd64&quot; --output type=docker,dest=./app.amd64.tar .# ç„¶åå†å°†é•œåƒå¯¼å…¥åˆ°æœ¬åœ°é•œåƒä»“åº“ä¸­docker load -i app.amd64.tar --loadå’Œ --outputéƒ½ä¸æ”¯æŒä¸€ä¸ªé•œåƒå¤šç§æ¶æ„ï¼Œè¦æ„å»ºåƒopenjdk:17-slimè¿™ç§æ”¯æŒå¤šæ¶æ„çš„é•œåƒå¯ä»¥ä½¿ç”¨--pushï¼Œä¸€æ­¥å°±æ¨é€åˆ°è¿œç¨‹ä»“åº“ 123456# æ„å»ºå¤šæ¶æ„é•œåƒï¼Œ--push å¯ä»¥ä¸€æ­¥åšåˆ°ï¼šå¤šå¹³å°æ„å»ºçš„é•œåƒä¸èƒ½åªä¿å­˜åˆ°æœ¬åœ°ï¼Œå¿…é¡»æ¨é€åˆ°è¿œç¨‹ registry æ‰èƒ½åˆå¹¶æ¶æ„ã€‚# è¿™é‡Œä»¥æ¨é€åˆ° docker hub ä¸ºä¾‹# ç™»å½• docker hupdocker login -u hanqunfeng# æ„å»ºï¼Œæ³¨æ„è¿™é‡Œçš„é•œåƒåç§°è¦åŠ ä¸Šä½ çš„dockerhubçš„å‘½åç©ºé—´ï¼Œ--platform æŒ‡å®šæ„å»ºçš„æ¶æ„ï¼Œå¯ä»¥æŒ‡å®šå¤šä¸ªï¼Œéœ€è¦Dockerfileé…ç½®åŸºç¡€é•œåƒæ”¯æŒå¯¹åº”çš„æ¶æ„docker buildx build --platform linux/amd64,linux/arm64 -t hanqunfeng/app:latest --push . é•œåƒæ‹‰å– 12# æ‹‰å–æŒ‡å®šæ¶æ„é•œåƒï¼Œä¸æŒ‡å®š --platform å‚æ•°ï¼Œé»˜è®¤æ‹‰å–å½“å‰æ¶æ„çš„é•œåƒdocker pull --platform=linux/arm64 hanqunfeng/app:latest ç¤ºä¾‹äºŒï¼šå¤šé˜¶æ®µæ„å»º è¦æ±‚æ¯ä¸ªé˜¶æ®µä¸­çš„åŸºç¡€é•œåƒéƒ½è¦æ”¯æŒå¤šæ¶æ„ 12345678910111213141516171819202122232425262728293031323334# ç¬¬ä¸€é˜¶æ®µï¼šè·å–ä»£ç FROM alpine/git AS fetcherWORKDIR /workspace/application# å°†æ›¿æ¢ä¸ºå®é™…çš„Gitä»“åº“URLå’Œåˆ†æ”¯/æ ‡ç­¾ARG GIT_REPOSITORY=https://gitee.com/hanqunfeng/springbootweb.gitARG GIT_BRANCH=masterRUN git clone -b $&#123;GIT_BRANCH&#125; $&#123;GIT_REPOSITORY&#125; .# ç¬¬äºŒé˜¶æ®µï¼šä½¿ç”¨Mavenç¯å¢ƒè¿›è¡Œæ„å»ºFROM maven:3.8.4-openjdk-17 AS builderWORKDIR /workspace/application# ä»ç¬¬ä¸€é˜¶æ®µå¤åˆ¶ä»£ç COPY --from=fetcher /workspace/application .# ä½¿ç”¨Mavenæ¸…ç†å¹¶æ‰“åŒ…RUN mvn clean package -DskipTests# ç¬¬ä¸‰é˜¶æ®µï¼šåˆ›å»ºæœ€ç»ˆçš„è¿è¡Œç¯å¢ƒFROM openjdk:17-slimWORKDIR /app# è®¾ç½®è¿è¡Œæ—¶ç¯å¢ƒå˜é‡ENV JAVA_OPTS=&quot;-Xms1024M -Xmx1024M -XX:MetaspaceSize=128M -XX:MaxMetaspaceSize=128M&quot;# å°†ç¬¬äºŒé˜¶æ®µç”Ÿæˆçš„ç›®æ ‡æ–‡ä»¶å¤åˆ¶åˆ°è¿™é‡Œã€‚æ³¨æ„è¿™é‡Œå‡è®¾ä½ çš„spring bootå·¥ç¨‹æ‰“æˆçš„jaråæ˜¯target/app.jarCOPY --from=builder /workspace/application/target/app.jar app.jar# æš´éœ²ç«¯å£ï¼ˆå¦‚æœéœ€è¦çš„è¯ï¼‰ã€‚è¯·æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹ç«¯å£å·EXPOSE 8080# å£°æ˜ä¸€ä¸ªå·æŒ‚è½½ç‚¹ï¼Œè¿è¡Œå®¹å™¨æ—¶å¯å°†è¯¥è·¯å¾„æ˜ å°„åˆ°å®¿ä¸»æœºï¼Œå®ç°æ•°æ®æŒä¹…åŒ–VOLUME [&quot;/app/logs&quot;]# è®¾ç½®å®¹å™¨å¯åŠ¨æ—¶çš„ä¸»å‘½ä»¤ï¼ˆENTRYPOINT ä¸ä¼šè¢« docker run å‚æ•°è¦†ç›–ï¼‰ENTRYPOINT [&quot;sh&quot;, &quot;-c&quot;, &quot;java $JAVA_OPTS -jar app.jar&quot;]# CMD æä¾›é»˜è®¤çš„è¿è¡Œå‚æ•°ï¼Œå¯ä»¥è¢« docker run è¦†ç›–# è¿™é‡Œé€šè¿‡ Spring Boot å‚æ•°è®¾ç½®å¯åŠ¨ç¯å¢ƒå’Œç«¯å£å·CMD [&quot;--spring.profiles.active=app&quot;, &quot;--server.port=8080&quot;]# è¿™é‡Œä½¿ç”¨çš„æ˜¯ ENTRYPOINT + CMD çš„æ··åˆæ¨¡å¼# å®Œæ•´å‘½ä»¤ï¼š java $JAVA_OPTS -jar app.jar --spring.profiles.active=app --server.port=8080 æ„å»ºé•œåƒ 12# æ„å»ºå¤šå¹³å°é•œåƒå¹¶å‘å¸ƒåˆ°dockerhubdocker buildx build --platform linux/amd64,linux/arm64 -t hanqunfeng/springboot:latest --push . å¦‚ä½•å°†æ„å»ºå¥½çš„å¤šä¸ªå•å¹³å°é•œåƒå‘å¸ƒä¸ºä¸€ä¸ªå¤šå¹³å°é•œåƒ å¦‚æœä½ å·²ç»åˆ†åˆ«æ„å»ºå¥½å•å¹³å°é•œåƒï¼Œä¹Ÿå¯ä»¥ç”¨ docker buildx imagetools create æ¥åˆå¹¶ ä»¥ä¸Šé¢åˆ›å»ºçš„ä¸¤ä¸ªå•å¹³å°é•œåƒä¸ºä¾‹ 12345678910111213141516171819# åˆ—å‡ºé•œåƒdocker images## è¾“å‡ºç»“æœREPOSITORY TAG IMAGE ID CREATED SIZEapp.amd64 latest 859162438372 2 hours ago 431MBapp.arm64 latest 0058c70dd16e 2 hours ago 426MB# ä¸€å®šè¦æ¨é€å•å¹³å°é•œåƒåˆ°è¿œç¨‹ä»“åº“ï¼Œå¦åˆ™æ— æ³•å®Œæˆåˆå¹¶docker tag app.amd64 hanqunfeng/app:amd64docker push hanqunfeng/app:amd64docker tag app.arm64 hanqunfeng/app:arm64docker push hanqunfeng/app:arm64# åˆå¹¶ï¼Œåˆ›å»ºå¤šå¹³å°é•œåƒæŒ‡å‘ï¼ˆmanifest listï¼‰docker buildx imagetools create \\ --tag hanqunfeng/app:latest \\ hanqunfeng/app:amd64 \\ hanqunfeng/app:arm64 å¦‚æœä¸éœ€è¦å•å¹³å°é•œåƒï¼Œå¯ä»¥åœ¨dockerhubä¸Šåˆ é™¤å³å¯ã€‚ ç§»é™¤ BuildKitï¼ˆBuildxï¼‰æ„å»ºè¿‡ç¨‹ä¸­äº§ç”Ÿçš„ç¼“å­˜æ•°æ® BuildKitï¼ˆBuildxï¼‰æ„å»ºè¿‡ç¨‹ä¼šäº§ç”Ÿç¼“å­˜æ•°æ®ï¼ŒåŒ…æ‹¬æœªä½¿ç”¨çš„ä¸­é—´é•œåƒã€æ„å»ºå±‚ç­‰ã€‚å¯¹äºé¢‘ç¹ä½¿ç”¨ Docker æ„å»ºçš„å¼€å‘è€…æ¥è¯´ï¼Œè¿™äº›ç¼“å­˜ä¼šé€æ¸å ç”¨å¤§é‡ç£ç›˜ç©ºé—´ã€‚ å¯ä»¥é€šè¿‡è¯¥å‘½ä»¤æŸ¥çœ‹ç¼“å­˜å ç”¨ç£ç›˜ç©ºé—´çš„å¤§å° 1docker buildx du docker buildx prune æ˜¯ä¸€ä¸ªç”¨äº æ¸…ç† Docker Buildx æ„å»ºç¼“å­˜ çš„å‘½ä»¤ï¼Œå¸¸ç”¨äºé‡Šæ”¾ç£ç›˜ç©ºé—´ã€‚ å‘½ä»¤è¯­æ³• 1docker buildx prune [OPTIONS] OPTIONS ä½œç”¨ -a, --all åŒ…æ‹¬å†…éƒ¨/å‰ç«¯é•œåƒã€‚é»˜è®¤åªåˆ é™¤æ— ç”¨ç¼“å­˜ï¼ŒåŠ ä¸Šè¯¥å‚æ•°ä¼šæ¸…é™¤æ›´å¤šç¼“å­˜å†…å®¹ï¼ŒåŒ…æ‹¬å¯èƒ½ä»å¯ç”¨çš„å†…å®¹ï¼ˆæ›´å½»åº•ï¼‰ã€‚ --builder string æŒ‡å®šä½¿ç”¨å“ªä¸ª builder å®ä¾‹ï¼ˆå¯é€šè¿‡ docker buildx ls æŸ¥çœ‹å½“å‰æœ‰å“ªäº› builderï¼‰ã€‚ --filter filter è®¾å®šæ¸…ç†æ¡ä»¶ï¼Œä¾‹å¦‚ï¼šuntil=24h è¡¨ç¤ºåªåˆ é™¤ 24 å°æ—¶å‰çš„ç¼“å­˜ã€‚ -f, --force ä¸æç¤ºç¡®è®¤ï¼Œç›´æ¥æ‰§è¡Œæ¸…ç†æ“ä½œã€‚å¸¸ç”¨äºè„šæœ¬ä¸­ã€‚ --keep-storage bytes ä¿ç•™æŒ‡å®šå¤§å°çš„ç¼“å­˜ç©ºé—´ï¼Œå…¶ä½™åˆ é™¤ï¼ˆå¦‚ï¼š--keep-storage 5GBï¼‰ã€‚ --verbose è¾“å‡ºæ›´è¯¦ç»†çš„æ¸…ç†ä¿¡æ¯ã€‚ ç¤ºä¾‹ 12345# åˆ é™¤æ‰€æœ‰æœªä½¿ç”¨çš„ç¼“å­˜ï¼Œå¹¶è·³è¿‡ç¡®è®¤æç¤ºdocker buildx prune -f# åªåˆ é™¤ 24 å°æ—¶å‰çš„ç¼“å­˜ï¼Œä¿ç•™ 10GB çš„ç¼“å­˜ç©ºé—´docker buildx prune --filter &quot;until=24h&quot; --keep-storage 10GB","summary":"æ‘˜è¦ æœ¬æ–‡ä»‹ç» Docker å‘½ä»¤ ä¸­ Dockerfile å¤šå¹³å°æ„å»ºçš„ä½¿ç”¨æ–¹æ³• Dockerå®˜æ–¹æ–‡æ¡£ Dockerfileå®˜æ–¹æ–‡æ¡£ Multi-platform builds","date_published":"2025-06-06T13:30:05.000Z","tags":["æŠ€æœ¯","docker","docker"]},{"id":"https://blog.hanqunfeng.com/2025/06/05/docker-remote-connection/","url":"https://blog.hanqunfeng.com/2025/06/05/docker-remote-connection/","title":"Docker ä¹‹ è¿œç¨‹è¿æ¥","content_html":"<!--\n **åŠ ç²—**\n *æ–œä½“*\n ***åŠ ç²—å¹¶æ–œä½“***\n ~~åˆ é™¤çº¿~~\n ==çªå‡ºæ˜¾ç¤º==\n `çªå‡ºæ˜¾ç¤º(æ¨è)`\n ++ä¸‹åˆ’çº¿++\n ~ä¸‹æ ‡~\n ^ä¸Šæ ‡^\n è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference.\n å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)\n\n +++ **ç‚¹å‡»æŠ˜å **\n è¿™æ˜¯è¢«éšè—çš„å†…å®¹\n +++\n\n::: tips success warning danger\nè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹\n:::\n\n% note info % success warning danger\nè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹\n% endnote %\n\nå¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{}\n å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ\n -->\n<h2 id=\"æ‘˜è¦\">æ‘˜è¦</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æœ¬æ–‡ä»‹ç»å¦‚ä½•è¿œç¨‹è¿æ¥Docker</p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://docs.docker.com\">Dockerå®˜æ–¹æ–‡æ¡£</a></p>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"è¿œç¨‹è¿æ¥Dockeræœ‰å¦‚ä¸‹ä¸‰ç§æ–¹å¼\">è¿œç¨‹è¿æ¥Dockeræœ‰å¦‚ä¸‹ä¸‰ç§æ–¹å¼</h2>\n<h3 id=\"æ–¹å¼ä¸€ï¼šå¼€å¯-TCPï¼ˆä¸å¸¦-TLSï¼Œä»…ç”¨äºå†…ç½‘è°ƒè¯•ï¼‰\">æ–¹å¼ä¸€ï¼šå¼€å¯ TCPï¼ˆä¸å¸¦ TLSï¼Œä»…ç”¨äºå†…ç½‘è°ƒè¯•ï¼‰</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åœ¨dockeræœåŠ¡ç«¯ç¼–è¾‘ <code>/etc/docker/daemon.json</code>ï¼ŒåŠ ä¸Šï¼š</p>\n</li>\n</ul>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;hosts&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span><span class=\"string\">&quot;unix:///var/run/docker.sock&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;tcp://0.0.0.0:2375&quot;</span><span class=\"punctuation\">]</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æ­¤æ—¶é€šè¿‡<code>sudo systemctl restart docker</code>é‡å¯ Dockerä¼šå¯åŠ¨å¤±è´¥ï¼ŒåŸå› æ˜¯systemdä¼šåœ¨dockerå¯åŠ¨å‘½ä»¤ä¸­æ·»åŠ  <code>-H fd://</code>ï¼Œå…¶å«ä¹‰æ˜¯ä» systemd ä¼ é€’è¿›æ¥çš„ socket æ–‡ä»¶æè¿°ç¬¦ç›‘å¬ API è¯·æ±‚ï¼Œå½“ Docker è¢« systemd å¯åŠ¨å¹¶å¯ç”¨ socket activationï¼ˆå¥—æ¥å­—æ¿€æ´»ï¼‰æ—¶ï¼Œsystemd ä¼šé¢„å…ˆåˆ›å»º socketï¼ˆæ¯”å¦‚ /var/run/docker.sockï¼‰ï¼Œç„¶åå†å¯åŠ¨ dockerdï¼Œå¹¶é€šè¿‡æ–‡ä»¶æè¿°ç¬¦ï¼ˆfdï¼‰æŠŠè¿™ä¸ª socket ä¼ é€’ç»™ dockerdã€‚æ­¤æ—¶ä½ åœ¨ dockerd ä¸­çœ‹åˆ°çš„ <code>-H fd://</code> æ„æ€æ˜¯ï¼šâ€œä¸ç”¨è‡ªå·±æ‰“å¼€ socketï¼Œå» systemd é‚£é‡Œæ‹¿å§ã€‚â€</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># é€šè¿‡è¯¥å‘½ä»¤å¯ä»¥è·å– docker çš„å¯åŠ¨å‘½ä»¤æ–‡ä»¶æ˜¯ /usr/lib/systemd/system/docker.service</span></span><br><span class=\"line\"><span class=\"built_in\">sudo</span> systemctl status docker</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹ /usr/lib/systemd/system/docker.serviceï¼Œå¯ä»¥çœ‹åˆ° dockerçš„å¯åŠ¨å‘½ä»¤å¦‚ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°  -H fd://</span></span><br><span class=\"line\">ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock</span><br><span class=\"line\"><span class=\"comment\"># å¦å¤–å¯ä»¥åœ¨ä¸ docker.service åŒç›®å½•ä¸‹æ‰¾åˆ°  docker.socket æ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹å†…å®¹</span></span><br><span class=\"line\">ListenStream=/run/docker.sock <span class=\"comment\"># /run ç›®å½•æ˜¯è¢«è½¯è¿æ¥åˆ° /var/run/</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æ€»ç»“ï¼šé€šè¿‡systemd å¯åŠ¨ dockeræ—¶ï¼Œå¦‚æœé…ç½®äº† -H fd://ï¼Œåˆ™ docker ä¼šç›‘å¬ /run/docker.sock æ–‡ä»¶ï¼Œå®é™…ä¸Šä¹Ÿå°±æ˜¯ /var/run/docker.sock</span></span><br><span class=\"line\"><span class=\"comment\"># è€Œæˆ‘ä»¬åœ¨/etc/docker/daemon.jsonä¸­åŠ ä¸Šçš„&quot;unix:///var/run/docker.sock&quot;, &quot;tcp://0.0.0.0:2375&quot;å®é™…ä¸Šå°±æ˜¯æ”¹å†™dockerçš„å¯åŠ¨å‚æ•°ï¼Œè¿™å°±ä¸ systemd å¯åŠ¨ docker çš„ `-H fd://` å‚æ•°å†²çªäº†</span></span><br><span class=\"line\"><span class=\"comment\"># æ­¤æ—¶æˆ‘ä»¬å¯ä»¥ä¸ä½¿ç”¨systemd å¯åŠ¨ dockerï¼Œè€Œæ˜¯ä½¿ç”¨ docker daemon å¯åŠ¨ docker</span></span><br><span class=\"line\"><span class=\"built_in\">sudo</span> dockerd --containerd=/run/containerd/containerd.sock</span><br><span class=\"line\"><span class=\"comment\"># ä½†è¿™æ ·ä¸åˆ©äº docker çš„ç®¡ç†ï¼Œå› æ­¤æœ€å¥½çš„æ–¹å¼æ˜¯ç¦ç”¨ `-H fd://`</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ç¦ç”¨ <code>-H fd://</code>ï¼ˆsystemd ä¸ daemon.json å†²çªçš„æ ¹æºï¼‰</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># æ–¹å¼ä¸€: å»æ‰ `-H fd://` å‚æ•°</span></span><br><span class=\"line\"><span class=\"built_in\">sudo</span> vi /usr/lib/systemd/system/docker.service</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æ–¹å¼äºŒ(æ¨è): åˆ›å»º override.conf æ–‡ä»¶ï¼Œå…¶ä½œç”¨æ˜¯ è¦†ç›– systemd é»˜è®¤é…ç½®æ–‡ä»¶ï¼Œåªä¼šè¦†ç›–æŒ‡å®šçš„å‚æ•°</span></span><br><span class=\"line\"><span class=\"built_in\">sudo</span> <span class=\"built_in\">mkdir</span> -p /etc/systemd/system/docker.service.d</span><br><span class=\"line\"><span class=\"built_in\">sudo</span> vi /etc/systemd/system/docker.service.d/override.conf</span><br><span class=\"line\"><span class=\"comment\"># å¡«å…¥</span></span><br><span class=\"line\">[Service]</span><br><span class=\"line\">ExecStart=</span><br><span class=\"line\">ExecStart=/usr/bin/dockerd --containerd=/run/containerd/containerd.sock</span><br><span class=\"line\"><span class=\"comment\"># è¿™é‡Œé¡ºä¾¿è¯´ä¸€ä¸‹ï¼Œ`--containerd=/run/containerd/containerd.sock` æ˜¯ docker é»˜è®¤å‚æ•°ï¼Œ</span></span><br><span class=\"line\"><span class=\"comment\"># å‘Šè¯‰ Docker å®ˆæŠ¤è¿›ç¨‹å»è¿æ¥å·²æœ‰çš„ containerd å®ä¾‹ï¼Œè€Œä¸æ˜¯è‡ªå·±å¯åŠ¨ä¸€ä¸ªæ–°çš„ã€‚</span></span><br><span class=\"line\"><span class=\"comment\"># Docker é»˜è®¤å†…éƒ¨ä½¿ç”¨ containerd æ¥ç®¡ç†å®¹å™¨è¿è¡Œæ—¶ï¼Œæ‰€ä»¥è¿™æ¡å‚æ•°æ˜¯æ˜ç¡®æŒ‡å®šè¦ä½¿ç”¨å“ªä¸ª containerd æœåŠ¡ã€‚</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>é‡å¯ docker daemon</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">sudo</span> systemctl daemon-reload</span><br><span class=\"line\"><span class=\"built_in\">sudo</span> systemctl restart docker</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åœ¨å®¢æˆ·ç«¯æµ‹è¯•è¿æ¥</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker -H tcp://è¿œç¨‹IP:2375 ps</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åœ¨å®¢æˆ·ç«¯åŠ å…¥ç¯å¢ƒå˜é‡åå°±ä¸éœ€è¦æ¯æ¬¡éƒ½åŠ ä¸Š -H å‚æ•°äº†</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># zsh å°±æ¢æˆ ~/.zshrc</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;export DOCKER_HOST=tcp://è¿œç¨‹IP:2375&quot;</span>  &gt;&gt; ~/.bashrc</span><br><span class=\"line\"><span class=\"built_in\">source</span> ~/.bashrc</span><br><span class=\"line\"><span class=\"comment\"># æµ‹è¯•</span></span><br><span class=\"line\">docker ps</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>â—ä¸è¦å¼€å¯æ— è®¤è¯çš„ <code>tcp://0.0.0.0:2375</code> åœ¨å…¬ç½‘ï¼Œè¿™æ˜¯è£¸å¥”çš„å®‰å…¨é£é™©ï¼Œä»»ä½•äººéƒ½èƒ½æ§åˆ¶ä½ çš„ Dockerã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>âœ… æ¨èæ–¹å¼æ˜¯ï¼š</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">ä½¿ç”¨ <code>tcp://0.0.0.0:2376 + --tlsverify</code></li>\n<li class=\"lvl-6\">æˆ–é€šè¿‡ <code>ssh:// éš§é“</code> è®¿é—® Docker</li>\n</ul>\n</li>\n</ul>\n<div class=\"tips\">\n<p><em><strong>å°è´´å£«</strong></em></p>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">é€šè¿‡ä¸Šé¢çš„ä»‹ç»ä½ åº”è¯¥ææ˜ç™½ä¸€ä»¶äº‹ï¼Œå°±æ˜¯æˆ‘ä»¬å¯ä»¥ä¸ç”¨åœ¨ <code>/etc/docker/daemon.json</code> ä¸­é…ç½®è¿œç¨‹è¿æ¥ï¼Œè€Œæ˜¯é€šè¿‡ systemd æ¥é…ç½®ï¼Œå³åœ¨ <code>/usr/lib/systemd/system/docker.service</code> æˆ–è€… <code>/etc/systemd/system/docker.service.d/override.conf</code>ä¸­é…ç½®ã€‚</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ExecStart=/usr/bin/dockerd -H unix:///var/run/docker.sock -H tcp://0.0.0.0:2375 --containerd=/run/containerd/containerd.sock</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼šæ—¢ç„¶ systemd å°±èƒ½æå®šä¸€åˆ‡ï¼Œé‚£è¿˜è¦ <code>/etc/docker/daemon.json</code> æœ‰ä»€ä¹ˆç”¨ï¼Ÿç­”æ¡ˆæ˜¯ï¼šå¯è¯»æ€§ã€å¯ç»´æŠ¤æ€§ã€å·¥å…·å…¼å®¹æ€§æ›´å¼ºã€‚</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>é¡¹ç›®</th>\n<th><code>daemon.json</code></th>\n<th><code>systemd ExecStart</code></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>è¯­æ³•</td>\n<td>JSON</td>\n<td>Shell å‘½ä»¤è¡Œ</td>\n</tr>\n<tr>\n<td>é€‚åˆè®¾ç½®</td>\n<td>Hostsã€æ—¥å¿—ã€registryã€é•œåƒé©±åŠ¨ç­‰</td>\n<td>å¯åŠ¨å‘½ä»¤ã€èµ„æºé™åˆ¶ç­‰</td>\n</tr>\n<tr>\n<td>å¯è¯»æ€§</td>\n<td>ğŸ‘ ç»“æ„åŒ–</td>\n<td>ğŸ‘ è¾ƒé•¿ã€å®¹æ˜“å‡ºé”™</td>\n</tr>\n<tr>\n<td>è‡ªåŠ¨åŒ–æ”¯æŒ</td>\n<td>ğŸ‘ å·¥å…·å‹å¥½</td>\n<td>ğŸ‘ éœ€è¦ patch systemd</td>\n</tr>\n</tbody>\n</table>\n</div>\n<h3 id=\"æ–¹å¼äºŒï¼šå¼€å¯-TCP-TLS-å®‰å…¨è®¿é—®ï¼ˆæ¨èç”¨äºå…¬ç½‘ï¼‰\">æ–¹å¼äºŒï¼šå¼€å¯ TCP + TLS å®‰å…¨è®¿é—®ï¼ˆæ¨èç”¨äºå…¬ç½‘ï¼‰</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åˆ›å»º TLS è¯ä¹¦ï¼Œé€šè¿‡ä¸€ä¸ªè„šæœ¬å®ç°ï¼Œè„šæœ¬åç§° <code>generate-docker-certs.sh</code></p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">set</span> -e</span><br><span class=\"line\"></span><br><span class=\"line\">SERVER_IP=166.189.9.114  <span class=\"comment\"># ğŸš¨ ä¿®æ”¹ä¸ºä½ çš„ Docker æœåŠ¡å™¨ IP æˆ–åŸŸå</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;[+] åˆ›å»º CA...&quot;</span></span><br><span class=\"line\">openssl genrsa -out ca-key.pem 4096</span><br><span class=\"line\">openssl req -new -x509 -days 365 \\</span><br><span class=\"line\">  -key ca-key.pem -subj <span class=\"string\">&quot;/CN=docker-ca&quot;</span> -out ca.pem</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;[+] åˆ›å»ºæœåŠ¡å™¨ç§é’¥...&quot;</span></span><br><span class=\"line\">openssl genrsa -out server-key.pem 4096</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;[+] åˆ›å»º OpenSSL é…ç½®æ–‡ä»¶...&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">cat</span> &gt; extfile.cnf &lt;&lt;<span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">[req]</span></span><br><span class=\"line\"><span class=\"string\">distinguished_name = req_distinguished_name</span></span><br><span class=\"line\"><span class=\"string\">x509_extensions = v3_req</span></span><br><span class=\"line\"><span class=\"string\">prompt = no</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[req_distinguished_name]</span></span><br><span class=\"line\"><span class=\"string\">CN = $&#123;SERVER_IP&#125;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[v3_req]</span></span><br><span class=\"line\"><span class=\"string\">keyUsage = keyEncipherment, dataEncipherment</span></span><br><span class=\"line\"><span class=\"string\">extendedKeyUsage = serverAuth</span></span><br><span class=\"line\"><span class=\"string\">subjectAltName = @alt_names</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[alt_names]</span></span><br><span class=\"line\"><span class=\"string\">IP.1 = $&#123;SERVER_IP&#125;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;[+] åˆ›å»ºæœåŠ¡å™¨è¯ä¹¦ç­¾åè¯·æ±‚ (CSR)...&quot;</span></span><br><span class=\"line\">openssl req -new -key server-key.pem \\</span><br><span class=\"line\">  -out server.csr -config extfile.cnf</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;[+] ç­¾å‘æœåŠ¡å™¨è¯ä¹¦...&quot;</span></span><br><span class=\"line\">openssl x509 -req -days 365 -<span class=\"keyword\">in</span> server.csr \\</span><br><span class=\"line\">  -CA ca.pem -CAkey ca-key.pem -CAcreateserial \\</span><br><span class=\"line\">  -out server-cert.pem -extensions v3_req -extfile extfile.cnf</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;[+] åˆ›å»ºå®¢æˆ·ç«¯ç§é’¥...&quot;</span></span><br><span class=\"line\">openssl genrsa -out key.pem 4096</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;[+] åˆ›å»ºå®¢æˆ·ç«¯ CSR...&quot;</span></span><br><span class=\"line\">openssl req -new -key key.pem -subj <span class=\"string\">&quot;/CN=client&quot;</span> -out client.csr</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;[+] ç­¾å‘å®¢æˆ·ç«¯è¯ä¹¦...&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">cat</span> &gt; client-ext.cnf &lt;&lt;<span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">extendedKeyUsage = clientAuth</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\">openssl x509 -req -days 365 -<span class=\"keyword\">in</span> client.csr \\</span><br><span class=\"line\">  -CA ca.pem -CAkey ca-key.pem -CAcreateserial \\</span><br><span class=\"line\">  -out cert.pem -extfile client-ext.cnf</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;[âœ“] æ‰€æœ‰è¯ä¹¦ç”Ÿæˆå®Œæˆï¼&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot; æœåŠ¡å™¨è¯ä¹¦: server-cert.pem, server-key.pem&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot; å®¢æˆ·ç«¯è¯ä¹¦: cert.pem, key.pem&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot; CAæ ¹è¯ä¹¦:   ca.pem&quot;</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æ‰§è¡Œè„šæœ¬</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">chmod</span> +x generate-docker-certs.sh</span><br><span class=\"line\">./generate-docker-certs.sh</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å°†ä»¥ä¸‹è¯ä¹¦æ–‡ä»¶éƒ¨ç½²åˆ°dockeræœåŠ¡ç«¯</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># æœåŠ¡ç«¯ï¼šserver-cert.pem, server-key.pem, ca.pem</span></span><br><span class=\"line\"><span class=\"built_in\">cp</span> server-cert.pem /etc/docker/server-cert.pem</span><br><span class=\"line\"><span class=\"built_in\">cp</span> server-key.pem /etc/docker/server-key.pem</span><br><span class=\"line\"><span class=\"built_in\">cp</span> ca.pem /etc/docker/ca.pem</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å°†ä»¥ä¸‹è¯ä¹¦æ–‡ä»¶éƒ¨ç½²åˆ°dockerå®¢æˆ·ç«¯</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cert.pem, key.pem, ca.pem</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åœ¨dockeræœåŠ¡ç«¯ç¼–è¾‘ <code>/etc/docker/daemon.json</code></p>\n</li>\n</ul>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;hosts&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span><span class=\"string\">&quot;unix:///var/run/docker.sock&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;tcp://0.0.0.0:2376&quot;</span><span class=\"punctuation\">]</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;tlsverify&quot;</span><span class=\"punctuation\">:</span> <span class=\"literal\"><span class=\"keyword\">true</span></span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;tlscacert&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;/etc/docker/ca.pem&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;tlscert&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;/etc/docker/server-cert.pem&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;tlskey&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;/etc/docker/server-key.pem&quot;</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ç¦ç”¨ <code>-H fd://</code>ï¼ˆsystemd ä¸ daemon.json å†²çªçš„æ ¹æºï¼‰</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">sudo</span> <span class=\"built_in\">mkdir</span> -p /etc/systemd/system/docker.service.d</span><br><span class=\"line\"><span class=\"built_in\">sudo</span> vi /etc/systemd/system/docker.service.d/override.conf</span><br><span class=\"line\"><span class=\"comment\"># å¡«å…¥</span></span><br><span class=\"line\">[Service]</span><br><span class=\"line\">ExecStart=</span><br><span class=\"line\">ExecStart=/usr/bin/dockerd --containerd=/run/containerd/containerd.sock</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>é‡å¯ docker daemon</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">sudo</span> systemctl daemon-reload</span><br><span class=\"line\"><span class=\"built_in\">sudo</span> systemctl restart docker</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åœ¨å®¢æˆ·ç«¯æµ‹è¯•è¿æ¥</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker \\</span><br><span class=\"line\">  --tlsverify \\</span><br><span class=\"line\">  --tlscacert=ca.pem \\</span><br><span class=\"line\">  --tlscert=cert.pem \\</span><br><span class=\"line\">  --tlskey=key.pem \\</span><br><span class=\"line\">  -H tcp://166.189.9.114:2376 \\</span><br><span class=\"line\">  ps</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åœ¨å®¢æˆ·ç«¯åŠ å…¥ç¯å¢ƒå˜é‡åå°±ä¸éœ€è¦æ¯æ¬¡éƒ½åŠ ä¸Š -H å‚æ•° å’Œè¯ä¹¦å‚æ•°äº†</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOT &gt;&gt; ~/.bashrc</span></span><br><span class=\"line\"><span class=\"string\"># è¿œç¨‹Docker IPå’Œç«¯å£</span></span><br><span class=\"line\"><span class=\"string\">export DOCKER_HOST=tcp://166.189.9.114:2376</span></span><br><span class=\"line\"><span class=\"string\"># ç”¨äºé€šè¿‡ TLSï¼ˆSSLï¼‰å®‰å…¨è¿æ¥è¿œç¨‹ Docker å®ˆæŠ¤è¿›ç¨‹ï¼Œç±»ä¼¼äº docker --tlsverify</span></span><br><span class=\"line\"><span class=\"string\">export DOCKER_TLS_VERIFY=1</span></span><br><span class=\"line\"><span class=\"string\"># è¿™ä¸ªç›®å½•ä¸‹è¦æœ‰è¿™äº›è¯ä¹¦æ–‡ä»¶ï¼šca.pem, cert.pem, key.pem</span></span><br><span class=\"line\"><span class=\"string\">export DOCKER_CERT_PATH=/path/to/certs</span></span><br><span class=\"line\"><span class=\"string\">EOT</span></span><br><span class=\"line\"><span class=\"built_in\">source</span> ~/.bashrc</span><br><span class=\"line\"><span class=\"comment\"># æµ‹è¯•</span></span><br><span class=\"line\">docker ps</span><br></pre></td></tr></table></figure>\n<h3 id=\"æ–¹å¼ä¸‰ï¼šssh-éš§é“è®¿é—®\">æ–¹å¼ä¸‰ï¼šssh:// éš§é“è®¿é—®</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æœ€ç®€å•çš„æ–¹å¼å°±æ˜¯ä½¿ç”¨ ssh è¿œç¨‹æ‰§è¡Œå‘½ä»¤çš„æ–¹å¼ï¼Œè¿™ç§æ–¹å¼ä¸éœ€è¦ä»»ä½•é…ç½®ï¼Œæ”¯æŒå¯†ç å’Œè¯ä¹¦è®¤è¯ï¼Œä¹Ÿæ”¯æŒæŒ‡å®šç«¯å£ï¼Œä½†è¿™ä¸æ˜¯æ ‡å‡†çš„è¿œç¨‹è¿æ¥dockeræ–¹å¼ï¼Œé€‚ç”¨äºå¶å°”è®¿é—®çš„æƒ…å†µã€‚</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ssh -i ~/.ssh/lexing-test.pem -p22 centos@166.189.9.114 <span class=\"string\">&quot;docker ps&quot;</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åŸºäºå…å¯†è®¤è¯ï¼Œå¦‚ä½•é…ç½®å…å¯†ç™»å½•å¯ä»¥å‚è€ƒ <a href=\"/2023/02/28/linux-command02-ssh/\" title=\"Linuxå¸¸ç”¨å‘½ä»¤--sshã€scpä¸å…å¯†ç™»å½•\">Linuxå¸¸ç”¨å‘½ä»¤--sshã€scpä¸å…å¯†ç™»å½•</a></p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># docker -H è¿œç¨‹è®¿é—® ä¸æ”¯æŒåœ¨å‘½ä»¤è¡Œç›´æ¥è¾“å…¥å¯†ç æˆ–å¯†é’¥æ–‡ä»¶ï¼Œå¿…é¡»é…ç½®å…å¯†ç™»å½•æ‰å¯ä»¥ï¼Œè€Œä¸”æ­¤æ—¶ç«¯å£å¿…é¡»æ˜¯é»˜è®¤çš„22</span></span><br><span class=\"line\"><span class=\"comment\"># è¦æ±‚ç™»å½•ç”¨æˆ·å¿…é¡»æ‹¥æœ‰dockerçš„è¿è¡Œæƒé™ï¼ˆåŠ å…¥ docker groupï¼‰</span></span><br><span class=\"line\">docker -H ssh://centos@166.189.9.114 ps</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åŸºäº<code>config</code>é…ç½®(æ¨è)</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">è¿™ç§æ–¹å¼çš„ä¼˜ç‚¹æ˜¯å¯ä»¥é…ç½®è¯ä¹¦å’Œç«¯å£</li>\n<li class=\"lvl-6\">åœ¨ ~/.ssh/config ä¸­æŒ‡å®šå…·ä½“çš„å¯†é’¥æ–‡ä»¶å’Œç«¯å£ï¼Œç™»å½•ç”¨æˆ·å¿…é¡»æ‹¥æœ‰dockerçš„è¿è¡Œæƒé™ï¼ˆåŠ å…¥ docker groupï¼‰</li>\n</ul>\n  <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Host mydocker</span><br><span class=\"line\">HostName 166.189.9.114</span><br><span class=\"line\">User centos</span><br><span class=\"line\">Port 22</span><br><span class=\"line\">IdentityFile ~/.ssh/my_docker_key</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">æµ‹è¯•</li>\n</ul>\n  <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker -H ssh://mydocker ps</span><br></pre></td></tr></table></figure>\n</li>\n<li class=\"lvl-2\">\n<p>æ·»åŠ ç¯å¢ƒå˜é‡é¿å…æ¯æ¬¡éƒ½åŠ ä¸Š <code>-H</code> å‚æ•°</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">## åŸºäºå…å¯†è®¤è¯</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;export DOCKER_HOST=ssh://user@host&quot;</span> &gt;&gt; ~/.bashrc</span><br><span class=\"line\"><span class=\"comment\">## æˆ–è€…åŸºäºconfigçš„æ–¹å¼</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;export DOCKER_HOST=ssh://mydocker&quot;</span> &gt;&gt; ~/.bashrc</span><br><span class=\"line\"><span class=\"built_in\">source</span> ~/.bashrc</span><br><span class=\"line\">docker ps</span><br></pre></td></tr></table></figure>\n<h2 id=\"docker-context-åŒæ—¶è¿æ¥å¤šä¸ªè¿œç¨‹docker\"><code>docker context</code>: åŒæ—¶è¿æ¥å¤šä¸ªè¿œç¨‹docker</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ä¸Šé¢ä»‹ç»çš„ä¸‰ç§æ–¹å¼ï¼Œä¸ºäº†ç®€åŒ–è¿æ¥ï¼Œéƒ½åŠ ä¸Šäº†<code>DOCKER_HOST</code>ç¯å¢ƒå˜é‡ï¼Œä½†æ˜¯<code>DOCKER_HOST</code>åªèƒ½é…ç½®ä¸€ä¸ªï¼Œå¦‚æœæˆ‘ä»¬è¦åŒæ—¶è¿æ¥å¤šä¸ªè¿œç¨‹dockeræœåŠ¡å‘¢ï¼Œæ¯æ¬¡åˆ‡æ¢<code>DOCKER_HOST</code>ç¯å¢ƒå˜é‡å¤ªè¿‡ç¹çï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢çš„æ–¹å¼ä¸ºæ¯ä¸ªè¿œç¨‹dockeræœåŠ¡åˆ›å»ºä¸€ä¸ª <code>context</code></p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># TCP</span></span><br><span class=\"line\">docker context create remote-tcp \\</span><br><span class=\"line\">    --docker <span class=\"string\">&quot;host=tcp://166.189.9.114:2375&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># TCP + TLS</span></span><br><span class=\"line\">docker context create remote-tls \\</span><br><span class=\"line\">  --docker <span class=\"string\">&quot;host=tcp://166.189.9.114:2376,ca=/path/ca.pem,cert=/path/cert.pem,key=/path/key.pem&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># sshéš§é“</span></span><br><span class=\"line\">docker context create remote-ssh --docker <span class=\"string\">&quot;host=ssh://mydocker&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨</span></span><br><span class=\"line\">docker context <span class=\"built_in\">ls</span> <span class=\"comment\"># åˆ—å‡ºæ‰€æœ‰context</span></span><br><span class=\"line\">docker context use remote-ssh <span class=\"comment\"># åˆ‡æ¢åˆ°æŒ‡å®šçš„context</span></span><br><span class=\"line\">docker ps <span class=\"comment\"># æŸ¥çœ‹å®¹å™¨</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>docker context</code> æ˜¯ Docker CLI çš„ä¸€ä¸ªå¼ºå¤§åŠŸèƒ½ï¼Œå®ƒè®©ä½ å¯ä»¥è½»æ¾åœ°åœ¨ å¤šä¸ª Docker åç«¯ç¯å¢ƒä¹‹é—´åˆ‡æ¢ï¼Œæ¯”å¦‚ï¼š</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">æœ¬åœ° Dockerï¼ˆé»˜è®¤ï¼‰</li>\n<li class=\"lvl-6\">è¿œç¨‹ä¸»æœºçš„ Dockerï¼ˆé€šè¿‡ SSH æˆ– TCP/TLSï¼‰</li>\n<li class=\"lvl-6\">Docker Desktop</li>\n<li class=\"lvl-6\">Docker Swarm æˆ– Kubernetesï¼ˆéƒ¨åˆ†æ”¯æŒï¼‰</li>\n</ul>\n</li>\n<li class=\"lvl-2\">\n<p>å°±åƒä½ ç”¨ <code>kubectl config use-context</code> åˆ‡æ¢ Kubernetes é›†ç¾¤ï¼Œ<code>docker context</code> ä¹Ÿå…è®¸ä½ åœ¨å¤šä¸ª Docker åç«¯ä¹‹é—´åˆ‡æ¢ï¼Œè€Œæ— éœ€åå¤è®¾ç½® <code>DOCKER_HOST</code> ç¯å¢ƒå˜é‡æˆ–å†™ç¹ççš„ SSH éš§é“å‘½ä»¤ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>å¸¸ç”¨å‘½ä»¤ä¸€è§ˆ</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>å‘½ä»¤</th>\n<th>è¯´æ˜</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>docker context ls</code></td>\n<td>åˆ—å‡ºæ‰€æœ‰ä¸Šä¸‹æ–‡</td>\n</tr>\n<tr>\n<td><code>docker context use &lt;name&gt;</code></td>\n<td>åˆ‡æ¢åˆ°æŒ‡å®š context</td>\n</tr>\n<tr>\n<td><code>docker context create &lt;name&gt; --docker &quot;Docker endpoint config&quot;</code></td>\n<td>åˆ›å»ºä¸€ä¸ªæ–°çš„ context</td>\n</tr>\n<tr>\n<td><code>docker context rm &lt;name&gt;</code></td>\n<td>åˆ é™¤ context</td>\n</tr>\n<tr>\n<td><code>docker context inspect &lt;name&gt;</code></td>\n<td>æŸ¥çœ‹ context è¯¦æƒ…</td>\n</tr>\n<tr>\n<td><code>docker context update &lt;name&gt; --docker &quot;Docker endpoint config&quot;</code></td>\n<td>æ›´æ–° context å‚æ•°ï¼ˆDocker 24+ æ”¯æŒï¼‰</td>\n</tr>\n<tr>\n<td><code>docker context show</code></td>\n<td>æ˜¾ç¤ºå½“å‰ context</td>\n</tr>\n<tr>\n<td><code>docker context export &lt;name&gt; &lt;file.tar&gt;</code></td>\n<td>å¯¼å‡º context åˆ°taræ–‡ä»¶</td>\n</tr>\n<tr>\n<td><code>docker context import &lt;name&gt; &lt;file.tar&gt;</code></td>\n<td>å¯¼å…¥ context ä»taræ–‡ä»¶</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Docker endpoint config</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>å‚æ•°å</th>\n<th>ä¸­æ–‡æè¿°</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>from</code></td>\n<td>å¤åˆ¶æŒ‡å®š context åç§° çš„ Docker ç«¯ç‚¹é…ç½®</td>\n</tr>\n<tr>\n<td><code>host</code></td>\n<td>è¦è¿æ¥çš„ Docker ç«¯ç‚¹åœ°å€</td>\n</tr>\n<tr>\n<td><code>ca</code></td>\n<td>CA ç­¾åçš„è¯ä¹¦çš„è·¯å¾„</td>\n</tr>\n<tr>\n<td><code>cert</code></td>\n<td>TLS è¯ä¹¦æ–‡ä»¶çš„è·¯å¾„</td>\n</tr>\n<tr>\n<td><code>key</code></td>\n<td>TLS å¯†é’¥æ–‡ä»¶çš„è·¯å¾„</td>\n</tr>\n<tr>\n<td><code>skip-tls-verify</code></td>\n<td>è·³è¿‡ TLS è¯ä¹¦éªŒè¯ï¼ˆâš ï¸ ä¸å»ºè®®ç”¨äºç”Ÿäº§ç¯å¢ƒï¼‰</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"ä¸‰ç§è¿œç¨‹è¿æ¥-Docker-çš„æ–¹å¼åŠå…¶ä¼˜ç¼ºç‚¹æ€»ç»“\">ä¸‰ç§è¿œç¨‹è¿æ¥ Docker çš„æ–¹å¼åŠå…¶ä¼˜ç¼ºç‚¹æ€»ç»“</h2>\n<table>\n<thead>\n<tr>\n<th>è¿æ¥æ–¹å¼</th>\n<th>ä¼˜ç‚¹</th>\n<th>ç¼ºç‚¹</th>\n<th>é€‚ç”¨åœºæ™¯</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>1. SSH æ–¹å¼ (<code>ssh://</code>)</strong></td>\n<td>- é…ç½®ç®€å•ï¼Œæ— éœ€é¢å¤–å¼€å¯ Docker TCP ç«¯å£å’Œ TLS<br>- å®‰å…¨æ€§é«˜ï¼ŒåŸºäº SSH åŠ å¯†å’Œè®¤è¯<br>- ä¸ç”¨å¼€æ”¾é¢å¤–ç«¯å£ï¼Œé˜²ç«å¢™å‹å¥½<br>- æ˜“äºç”¨ SSH ä»£ç†å’Œå¯†é’¥ç®¡ç†</td>\n<td>- éœ€è¦è¿œç¨‹ç”¨æˆ·æœ‰ Docker æƒé™ï¼ˆå¦‚å±äº <code>docker</code> ç»„ï¼‰<br>- è¿æ¥é€Ÿåº¦å¯èƒ½å— SSH è¿æ¥å½±å“<br>- éœ€è¦åœ¨æœ¬åœ°å®‰è£…å¹¶é…ç½® SSH</td>\n<td>å¼€å‘ç¯å¢ƒã€å†…ç½‘ç®¡ç†ã€å°è§„æ¨¡è¿œç¨‹æ“ä½œ</td>\n</tr>\n<tr>\n<td><strong>2. TCP + TLS æ–¹å¼</strong></td>\n<td>- æ ‡å‡†çš„è¿œç¨‹ Docker API è®¿é—®<br>- æ”¯æŒè¯ä¹¦è®¤è¯ï¼Œå®‰å…¨æ€§é«˜<br>- å¯ä»¥é…ç½®å¤šä¸ªå®¢æˆ·ç«¯å’Œæƒé™æ§åˆ¶<br>- é€‚åˆè‡ªåŠ¨åŒ–è„šæœ¬ã€CI/CD è®¿é—®</td>\n<td>- é…ç½®è¾ƒå¤æ‚ï¼Œéœ€è¦ç”Ÿæˆå’Œç®¡ç† CAã€æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯è¯ä¹¦<br>- éœ€è¦å¼€æ”¾ TCP ç«¯å£ï¼ˆå¦‚ 2376ï¼‰ï¼Œå¢åŠ å®‰å…¨é£é™©<br>- è¯ä¹¦é…ç½®é”™è¯¯å®¹æ˜“å¯¼è‡´è¿æ¥å¤±è´¥</td>\n<td>ç”Ÿäº§ç¯å¢ƒã€è‡ªåŠ¨åŒ–é›†æˆã€éœ€è¦é«˜å®‰å…¨è®¤è¯</td>\n</tr>\n<tr>\n<td><strong>3. TCP æ˜æ–‡è®¿é—®ï¼ˆæ—  TLSï¼‰</strong></td>\n<td>- é…ç½®æœ€ç®€å•ï¼Œåªéœ€ç›‘å¬ TCP ç«¯å£<br>- æ–¹ä¾¿å¿«é€Ÿæµ‹è¯•å’Œè°ƒè¯•</td>\n<td>- æåº¦ä¸å®‰å…¨ï¼Œæ•°æ®æ˜æ–‡ä¼ è¾“<br>- ä»»ä½•äººéƒ½å¯è®¿é—® Docker APIï¼Œææ˜“è¢«æ”»å‡»<br>- ç”Ÿäº§ç¯å¢ƒä¸¥é‡ä¸å»ºè®®ä½¿ç”¨</td>\n<td>ä»…é™å±€åŸŸç½‘å†…æµ‹è¯•æˆ–æç®€ç¯å¢ƒ</td>\n</tr>\n</tbody>\n</table>\n","content_text":"æ‘˜è¦ æœ¬æ–‡ä»‹ç»å¦‚ä½•è¿œç¨‹è¿æ¥Docker Dockerå®˜æ–¹æ–‡æ¡£ è¿œç¨‹è¿æ¥Dockeræœ‰å¦‚ä¸‹ä¸‰ç§æ–¹å¼ æ–¹å¼ä¸€ï¼šå¼€å¯ TCPï¼ˆä¸å¸¦ TLSï¼Œä»…ç”¨äºå†…ç½‘è°ƒè¯•ï¼‰ åœ¨dockeræœåŠ¡ç«¯ç¼–è¾‘ /etc/docker/daemon.jsonï¼ŒåŠ ä¸Šï¼š 123&#123; &quot;hosts&quot;: [&quot;unix:///var/run/docker.sock&quot;, &quot;tcp://0.0.0.0:2375&quot;]&#125; æ­¤æ—¶é€šè¿‡sudo systemctl restart dockeré‡å¯ Dockerä¼šå¯åŠ¨å¤±è´¥ï¼ŒåŸå› æ˜¯systemdä¼šåœ¨dockerå¯åŠ¨å‘½ä»¤ä¸­æ·»åŠ  -H fd://ï¼Œå…¶å«ä¹‰æ˜¯ä» systemd ä¼ é€’è¿›æ¥çš„ socket æ–‡ä»¶æè¿°ç¬¦ç›‘å¬ API è¯·æ±‚ï¼Œå½“ Docker è¢« systemd å¯åŠ¨å¹¶å¯ç”¨ socket activationï¼ˆå¥—æ¥å­—æ¿€æ´»ï¼‰æ—¶ï¼Œsystemd ä¼šé¢„å…ˆåˆ›å»º socketï¼ˆæ¯”å¦‚ /var/run/docker.sockï¼‰ï¼Œç„¶åå†å¯åŠ¨ dockerdï¼Œå¹¶é€šè¿‡æ–‡ä»¶æè¿°ç¬¦ï¼ˆfdï¼‰æŠŠè¿™ä¸ª socket ä¼ é€’ç»™ dockerdã€‚æ­¤æ—¶ä½ åœ¨ dockerd ä¸­çœ‹åˆ°çš„ -H fd:// æ„æ€æ˜¯ï¼šâ€œä¸ç”¨è‡ªå·±æ‰“å¼€ socketï¼Œå» systemd é‚£é‡Œæ‹¿å§ã€‚â€ 123456789101112# é€šè¿‡è¯¥å‘½ä»¤å¯ä»¥è·å– docker çš„å¯åŠ¨å‘½ä»¤æ–‡ä»¶æ˜¯ /usr/lib/systemd/system/docker.servicesudo systemctl status docker# æŸ¥çœ‹ /usr/lib/systemd/system/docker.serviceï¼Œå¯ä»¥çœ‹åˆ° dockerçš„å¯åŠ¨å‘½ä»¤å¦‚ä¸‹ï¼Œå¯ä»¥çœ‹åˆ° -H fd://ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock# å¦å¤–å¯ä»¥åœ¨ä¸ docker.service åŒç›®å½•ä¸‹æ‰¾åˆ° docker.socket æ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹å†…å®¹ListenStream=/run/docker.sock # /run ç›®å½•æ˜¯è¢«è½¯è¿æ¥åˆ° /var/run/# æ€»ç»“ï¼šé€šè¿‡systemd å¯åŠ¨ dockeræ—¶ï¼Œå¦‚æœé…ç½®äº† -H fd://ï¼Œåˆ™ docker ä¼šç›‘å¬ /run/docker.sock æ–‡ä»¶ï¼Œå®é™…ä¸Šä¹Ÿå°±æ˜¯ /var/run/docker.sock# è€Œæˆ‘ä»¬åœ¨/etc/docker/daemon.jsonä¸­åŠ ä¸Šçš„&quot;unix:///var/run/docker.sock&quot;, &quot;tcp://0.0.0.0:2375&quot;å®é™…ä¸Šå°±æ˜¯æ”¹å†™dockerçš„å¯åŠ¨å‚æ•°ï¼Œè¿™å°±ä¸ systemd å¯åŠ¨ docker çš„ `-H fd://` å‚æ•°å†²çªäº†# æ­¤æ—¶æˆ‘ä»¬å¯ä»¥ä¸ä½¿ç”¨systemd å¯åŠ¨ dockerï¼Œè€Œæ˜¯ä½¿ç”¨ docker daemon å¯åŠ¨ dockersudo dockerd --containerd=/run/containerd/containerd.sock# ä½†è¿™æ ·ä¸åˆ©äº docker çš„ç®¡ç†ï¼Œå› æ­¤æœ€å¥½çš„æ–¹å¼æ˜¯ç¦ç”¨ `-H fd://` ç¦ç”¨ -H fd://ï¼ˆsystemd ä¸ daemon.json å†²çªçš„æ ¹æºï¼‰ 12345678910111213# æ–¹å¼ä¸€: å»æ‰ `-H fd://` å‚æ•°sudo vi /usr/lib/systemd/system/docker.service# æ–¹å¼äºŒ(æ¨è): åˆ›å»º override.conf æ–‡ä»¶ï¼Œå…¶ä½œç”¨æ˜¯ è¦†ç›– systemd é»˜è®¤é…ç½®æ–‡ä»¶ï¼Œåªä¼šè¦†ç›–æŒ‡å®šçš„å‚æ•°sudo mkdir -p /etc/systemd/system/docker.service.dsudo vi /etc/systemd/system/docker.service.d/override.conf# å¡«å…¥[Service]ExecStart=ExecStart=/usr/bin/dockerd --containerd=/run/containerd/containerd.sock# è¿™é‡Œé¡ºä¾¿è¯´ä¸€ä¸‹ï¼Œ`--containerd=/run/containerd/containerd.sock` æ˜¯ docker é»˜è®¤å‚æ•°ï¼Œ# å‘Šè¯‰ Docker å®ˆæŠ¤è¿›ç¨‹å»è¿æ¥å·²æœ‰çš„ containerd å®ä¾‹ï¼Œè€Œä¸æ˜¯è‡ªå·±å¯åŠ¨ä¸€ä¸ªæ–°çš„ã€‚# Docker é»˜è®¤å†…éƒ¨ä½¿ç”¨ containerd æ¥ç®¡ç†å®¹å™¨è¿è¡Œæ—¶ï¼Œæ‰€ä»¥è¿™æ¡å‚æ•°æ˜¯æ˜ç¡®æŒ‡å®šè¦ä½¿ç”¨å“ªä¸ª containerd æœåŠ¡ã€‚ é‡å¯ docker daemon 12sudo systemctl daemon-reloadsudo systemctl restart docker åœ¨å®¢æˆ·ç«¯æµ‹è¯•è¿æ¥ 1docker -H tcp://è¿œç¨‹IP:2375 ps åœ¨å®¢æˆ·ç«¯åŠ å…¥ç¯å¢ƒå˜é‡åå°±ä¸éœ€è¦æ¯æ¬¡éƒ½åŠ ä¸Š -H å‚æ•°äº† 12345# zsh å°±æ¢æˆ ~/.zshrcecho &quot;export DOCKER_HOST=tcp://è¿œç¨‹IP:2375&quot; &gt;&gt; ~/.bashrcsource ~/.bashrc# æµ‹è¯•docker ps â—ä¸è¦å¼€å¯æ— è®¤è¯çš„ tcp://0.0.0.0:2375 åœ¨å…¬ç½‘ï¼Œè¿™æ˜¯è£¸å¥”çš„å®‰å…¨é£é™©ï¼Œä»»ä½•äººéƒ½èƒ½æ§åˆ¶ä½ çš„ Dockerã€‚ âœ… æ¨èæ–¹å¼æ˜¯ï¼š ä½¿ç”¨ tcp://0.0.0.0:2376 + --tlsverify æˆ–é€šè¿‡ ssh:// éš§é“ è®¿é—® Docker å°è´´å£« é€šè¿‡ä¸Šé¢çš„ä»‹ç»ä½ åº”è¯¥ææ˜ç™½ä¸€ä»¶äº‹ï¼Œå°±æ˜¯æˆ‘ä»¬å¯ä»¥ä¸ç”¨åœ¨ /etc/docker/daemon.json ä¸­é…ç½®è¿œç¨‹è¿æ¥ï¼Œè€Œæ˜¯é€šè¿‡ systemd æ¥é…ç½®ï¼Œå³åœ¨ /usr/lib/systemd/system/docker.service æˆ–è€… /etc/systemd/system/docker.service.d/override.confä¸­é…ç½®ã€‚ 1ExecStart=/usr/bin/dockerd -H unix:///var/run/docker.sock -H tcp://0.0.0.0:2375 --containerd=/run/containerd/containerd.sock é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼šæ—¢ç„¶ systemd å°±èƒ½æå®šä¸€åˆ‡ï¼Œé‚£è¿˜è¦ /etc/docker/daemon.json æœ‰ä»€ä¹ˆç”¨ï¼Ÿç­”æ¡ˆæ˜¯ï¼šå¯è¯»æ€§ã€å¯ç»´æŠ¤æ€§ã€å·¥å…·å…¼å®¹æ€§æ›´å¼ºã€‚ é¡¹ç›® daemon.json systemd ExecStart è¯­æ³• JSON Shell å‘½ä»¤è¡Œ é€‚åˆè®¾ç½® Hostsã€æ—¥å¿—ã€registryã€é•œåƒé©±åŠ¨ç­‰ å¯åŠ¨å‘½ä»¤ã€èµ„æºé™åˆ¶ç­‰ å¯è¯»æ€§ ğŸ‘ ç»“æ„åŒ– ğŸ‘ è¾ƒé•¿ã€å®¹æ˜“å‡ºé”™ è‡ªåŠ¨åŒ–æ”¯æŒ ğŸ‘ å·¥å…·å‹å¥½ ğŸ‘ éœ€è¦ patch systemd æ–¹å¼äºŒï¼šå¼€å¯ TCP + TLS å®‰å…¨è®¿é—®ï¼ˆæ¨èç”¨äºå…¬ç½‘ï¼‰ åˆ›å»º TLS è¯ä¹¦ï¼Œé€šè¿‡ä¸€ä¸ªè„šæœ¬å®ç°ï¼Œè„šæœ¬åç§° generate-docker-certs.sh 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162#!/bin/bashset -eSERVER_IP=166.189.9.114 # ğŸš¨ ä¿®æ”¹ä¸ºä½ çš„ Docker æœåŠ¡å™¨ IP æˆ–åŸŸåecho &quot;[+] åˆ›å»º CA...&quot;openssl genrsa -out ca-key.pem 4096openssl req -new -x509 -days 365 \\ -key ca-key.pem -subj &quot;/CN=docker-ca&quot; -out ca.pemecho &quot;[+] åˆ›å»ºæœåŠ¡å™¨ç§é’¥...&quot;openssl genrsa -out server-key.pem 4096echo &quot;[+] åˆ›å»º OpenSSL é…ç½®æ–‡ä»¶...&quot;cat &gt; extfile.cnf &lt;&lt;EOF[req]distinguished_name = req_distinguished_namex509_extensions = v3_reqprompt = no[req_distinguished_name]CN = $&#123;SERVER_IP&#125;[v3_req]keyUsage = keyEncipherment, dataEnciphermentextendedKeyUsage = serverAuthsubjectAltName = @alt_names[alt_names]IP.1 = $&#123;SERVER_IP&#125;EOFecho &quot;[+] åˆ›å»ºæœåŠ¡å™¨è¯ä¹¦ç­¾åè¯·æ±‚ (CSR)...&quot;openssl req -new -key server-key.pem \\ -out server.csr -config extfile.cnfecho &quot;[+] ç­¾å‘æœåŠ¡å™¨è¯ä¹¦...&quot;openssl x509 -req -days 365 -in server.csr \\ -CA ca.pem -CAkey ca-key.pem -CAcreateserial \\ -out server-cert.pem -extensions v3_req -extfile extfile.cnfecho &quot;[+] åˆ›å»ºå®¢æˆ·ç«¯ç§é’¥...&quot;openssl genrsa -out key.pem 4096echo &quot;[+] åˆ›å»ºå®¢æˆ·ç«¯ CSR...&quot;openssl req -new -key key.pem -subj &quot;/CN=client&quot; -out client.csrecho &quot;[+] ç­¾å‘å®¢æˆ·ç«¯è¯ä¹¦...&quot;cat &gt; client-ext.cnf &lt;&lt;EOFextendedKeyUsage = clientAuthEOFopenssl x509 -req -days 365 -in client.csr \\ -CA ca.pem -CAkey ca-key.pem -CAcreateserial \\ -out cert.pem -extfile client-ext.cnfecho &quot;[âœ“] æ‰€æœ‰è¯ä¹¦ç”Ÿæˆå®Œæˆï¼&quot;echoecho &quot; æœåŠ¡å™¨è¯ä¹¦: server-cert.pem, server-key.pem&quot;echo &quot; å®¢æˆ·ç«¯è¯ä¹¦: cert.pem, key.pem&quot;echo &quot; CAæ ¹è¯ä¹¦: ca.pem&quot; æ‰§è¡Œè„šæœ¬ 12chmod +x generate-docker-certs.sh./generate-docker-certs.sh å°†ä»¥ä¸‹è¯ä¹¦æ–‡ä»¶éƒ¨ç½²åˆ°dockeræœåŠ¡ç«¯ 1234# æœåŠ¡ç«¯ï¼šserver-cert.pem, server-key.pem, ca.pemcp server-cert.pem /etc/docker/server-cert.pemcp server-key.pem /etc/docker/server-key.pemcp ca.pem /etc/docker/ca.pem å°†ä»¥ä¸‹è¯ä¹¦æ–‡ä»¶éƒ¨ç½²åˆ°dockerå®¢æˆ·ç«¯ 1cert.pem, key.pem, ca.pem åœ¨dockeræœåŠ¡ç«¯ç¼–è¾‘ /etc/docker/daemon.json 1234567&#123; &quot;hosts&quot;: [&quot;unix:///var/run/docker.sock&quot;, &quot;tcp://0.0.0.0:2376&quot;], &quot;tlsverify&quot;: true, &quot;tlscacert&quot;: &quot;/etc/docker/ca.pem&quot;, &quot;tlscert&quot;: &quot;/etc/docker/server-cert.pem&quot;, &quot;tlskey&quot;: &quot;/etc/docker/server-key.pem&quot;&#125; ç¦ç”¨ -H fd://ï¼ˆsystemd ä¸ daemon.json å†²çªçš„æ ¹æºï¼‰ 123456sudo mkdir -p /etc/systemd/system/docker.service.dsudo vi /etc/systemd/system/docker.service.d/override.conf# å¡«å…¥[Service]ExecStart=ExecStart=/usr/bin/dockerd --containerd=/run/containerd/containerd.sock é‡å¯ docker daemon 12sudo systemctl daemon-reloadsudo systemctl restart docker åœ¨å®¢æˆ·ç«¯æµ‹è¯•è¿æ¥ 1234567docker \\ --tlsverify \\ --tlscacert=ca.pem \\ --tlscert=cert.pem \\ --tlskey=key.pem \\ -H tcp://166.189.9.114:2376 \\ ps åœ¨å®¢æˆ·ç«¯åŠ å…¥ç¯å¢ƒå˜é‡åå°±ä¸éœ€è¦æ¯æ¬¡éƒ½åŠ ä¸Š -H å‚æ•° å’Œè¯ä¹¦å‚æ•°äº† 1234567891011cat &lt;&lt;EOT &gt;&gt; ~/.bashrc# è¿œç¨‹Docker IPå’Œç«¯å£export DOCKER_HOST=tcp://166.189.9.114:2376# ç”¨äºé€šè¿‡ TLSï¼ˆSSLï¼‰å®‰å…¨è¿æ¥è¿œç¨‹ Docker å®ˆæŠ¤è¿›ç¨‹ï¼Œç±»ä¼¼äº docker --tlsverifyexport DOCKER_TLS_VERIFY=1# è¿™ä¸ªç›®å½•ä¸‹è¦æœ‰è¿™äº›è¯ä¹¦æ–‡ä»¶ï¼šca.pem, cert.pem, key.pemexport DOCKER_CERT_PATH=/path/to/certsEOTsource ~/.bashrc# æµ‹è¯•docker ps æ–¹å¼ä¸‰ï¼šssh:// éš§é“è®¿é—® æœ€ç®€å•çš„æ–¹å¼å°±æ˜¯ä½¿ç”¨ ssh è¿œç¨‹æ‰§è¡Œå‘½ä»¤çš„æ–¹å¼ï¼Œè¿™ç§æ–¹å¼ä¸éœ€è¦ä»»ä½•é…ç½®ï¼Œæ”¯æŒå¯†ç å’Œè¯ä¹¦è®¤è¯ï¼Œä¹Ÿæ”¯æŒæŒ‡å®šç«¯å£ï¼Œä½†è¿™ä¸æ˜¯æ ‡å‡†çš„è¿œç¨‹è¿æ¥dockeræ–¹å¼ï¼Œé€‚ç”¨äºå¶å°”è®¿é—®çš„æƒ…å†µã€‚ 1ssh -i ~/.ssh/lexing-test.pem -p22 centos@166.189.9.114 &quot;docker ps&quot; åŸºäºå…å¯†è®¤è¯ï¼Œå¦‚ä½•é…ç½®å…å¯†ç™»å½•å¯ä»¥å‚è€ƒ Linuxå¸¸ç”¨å‘½ä»¤--sshã€scpä¸å…å¯†ç™»å½• 123# docker -H è¿œç¨‹è®¿é—® ä¸æ”¯æŒåœ¨å‘½ä»¤è¡Œç›´æ¥è¾“å…¥å¯†ç æˆ–å¯†é’¥æ–‡ä»¶ï¼Œå¿…é¡»é…ç½®å…å¯†ç™»å½•æ‰å¯ä»¥ï¼Œè€Œä¸”æ­¤æ—¶ç«¯å£å¿…é¡»æ˜¯é»˜è®¤çš„22# è¦æ±‚ç™»å½•ç”¨æˆ·å¿…é¡»æ‹¥æœ‰dockerçš„è¿è¡Œæƒé™ï¼ˆåŠ å…¥ docker groupï¼‰docker -H ssh://centos@166.189.9.114 ps åŸºäºconfigé…ç½®(æ¨è) è¿™ç§æ–¹å¼çš„ä¼˜ç‚¹æ˜¯å¯ä»¥é…ç½®è¯ä¹¦å’Œç«¯å£ åœ¨ ~/.ssh/config ä¸­æŒ‡å®šå…·ä½“çš„å¯†é’¥æ–‡ä»¶å’Œç«¯å£ï¼Œç™»å½•ç”¨æˆ·å¿…é¡»æ‹¥æœ‰dockerçš„è¿è¡Œæƒé™ï¼ˆåŠ å…¥ docker groupï¼‰ 12345Host mydockerHostName 166.189.9.114User centosPort 22IdentityFile ~/.ssh/my_docker_key æµ‹è¯• 1docker -H ssh://mydocker ps æ·»åŠ ç¯å¢ƒå˜é‡é¿å…æ¯æ¬¡éƒ½åŠ ä¸Š -H å‚æ•° 123456## åŸºäºå…å¯†è®¤è¯echo &quot;export DOCKER_HOST=ssh://user@host&quot; &gt;&gt; ~/.bashrc## æˆ–è€…åŸºäºconfigçš„æ–¹å¼echo &quot;export DOCKER_HOST=ssh://mydocker&quot; &gt;&gt; ~/.bashrcsource ~/.bashrcdocker ps docker context: åŒæ—¶è¿æ¥å¤šä¸ªè¿œç¨‹docker ä¸Šé¢ä»‹ç»çš„ä¸‰ç§æ–¹å¼ï¼Œä¸ºäº†ç®€åŒ–è¿æ¥ï¼Œéƒ½åŠ ä¸Šäº†DOCKER_HOSTç¯å¢ƒå˜é‡ï¼Œä½†æ˜¯DOCKER_HOSTåªèƒ½é…ç½®ä¸€ä¸ªï¼Œå¦‚æœæˆ‘ä»¬è¦åŒæ—¶è¿æ¥å¤šä¸ªè¿œç¨‹dockeræœåŠ¡å‘¢ï¼Œæ¯æ¬¡åˆ‡æ¢DOCKER_HOSTç¯å¢ƒå˜é‡å¤ªè¿‡ç¹çï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢çš„æ–¹å¼ä¸ºæ¯ä¸ªè¿œç¨‹dockeræœåŠ¡åˆ›å»ºä¸€ä¸ª context 123456789101112131415# TCPdocker context create remote-tcp \\ --docker &quot;host=tcp://166.189.9.114:2375&quot;# TCP + TLSdocker context create remote-tls \\ --docker &quot;host=tcp://166.189.9.114:2376,ca=/path/ca.pem,cert=/path/cert.pem,key=/path/key.pem&quot;# sshéš§é“docker context create remote-ssh --docker &quot;host=ssh://mydocker&quot;# ä½¿ç”¨docker context ls # åˆ—å‡ºæ‰€æœ‰contextdocker context use remote-ssh # åˆ‡æ¢åˆ°æŒ‡å®šçš„contextdocker ps # æŸ¥çœ‹å®¹å™¨ docker context æ˜¯ Docker CLI çš„ä¸€ä¸ªå¼ºå¤§åŠŸèƒ½ï¼Œå®ƒè®©ä½ å¯ä»¥è½»æ¾åœ°åœ¨ å¤šä¸ª Docker åç«¯ç¯å¢ƒä¹‹é—´åˆ‡æ¢ï¼Œæ¯”å¦‚ï¼š æœ¬åœ° Dockerï¼ˆé»˜è®¤ï¼‰ è¿œç¨‹ä¸»æœºçš„ Dockerï¼ˆé€šè¿‡ SSH æˆ– TCP/TLSï¼‰ Docker Desktop Docker Swarm æˆ– Kubernetesï¼ˆéƒ¨åˆ†æ”¯æŒï¼‰ å°±åƒä½ ç”¨ kubectl config use-context åˆ‡æ¢ Kubernetes é›†ç¾¤ï¼Œdocker context ä¹Ÿå…è®¸ä½ åœ¨å¤šä¸ª Docker åç«¯ä¹‹é—´åˆ‡æ¢ï¼Œè€Œæ— éœ€åå¤è®¾ç½® DOCKER_HOST ç¯å¢ƒå˜é‡æˆ–å†™ç¹ççš„ SSH éš§é“å‘½ä»¤ã€‚ å¸¸ç”¨å‘½ä»¤ä¸€è§ˆ å‘½ä»¤ è¯´æ˜ docker context ls åˆ—å‡ºæ‰€æœ‰ä¸Šä¸‹æ–‡ docker context use &lt;name&gt; åˆ‡æ¢åˆ°æŒ‡å®š context docker context create &lt;name&gt; --docker &quot;Docker endpoint config&quot; åˆ›å»ºä¸€ä¸ªæ–°çš„ context docker context rm &lt;name&gt; åˆ é™¤ context docker context inspect &lt;name&gt; æŸ¥çœ‹ context è¯¦æƒ… docker context update &lt;name&gt; --docker &quot;Docker endpoint config&quot; æ›´æ–° context å‚æ•°ï¼ˆDocker 24+ æ”¯æŒï¼‰ docker context show æ˜¾ç¤ºå½“å‰ context docker context export &lt;name&gt; &lt;file.tar&gt; å¯¼å‡º context åˆ°taræ–‡ä»¶ docker context import &lt;name&gt; &lt;file.tar&gt; å¯¼å…¥ context ä»taræ–‡ä»¶ Docker endpoint config å‚æ•°å ä¸­æ–‡æè¿° from å¤åˆ¶æŒ‡å®š context åç§° çš„ Docker ç«¯ç‚¹é…ç½® host è¦è¿æ¥çš„ Docker ç«¯ç‚¹åœ°å€ ca CA ç­¾åçš„è¯ä¹¦çš„è·¯å¾„ cert TLS è¯ä¹¦æ–‡ä»¶çš„è·¯å¾„ key TLS å¯†é’¥æ–‡ä»¶çš„è·¯å¾„ skip-tls-verify è·³è¿‡ TLS è¯ä¹¦éªŒè¯ï¼ˆâš ï¸ ä¸å»ºè®®ç”¨äºç”Ÿäº§ç¯å¢ƒï¼‰ ä¸‰ç§è¿œç¨‹è¿æ¥ Docker çš„æ–¹å¼åŠå…¶ä¼˜ç¼ºç‚¹æ€»ç»“ è¿æ¥æ–¹å¼ ä¼˜ç‚¹ ç¼ºç‚¹ é€‚ç”¨åœºæ™¯ 1. SSH æ–¹å¼ (ssh://) - é…ç½®ç®€å•ï¼Œæ— éœ€é¢å¤–å¼€å¯ Docker TCP ç«¯å£å’Œ TLS- å®‰å…¨æ€§é«˜ï¼ŒåŸºäº SSH åŠ å¯†å’Œè®¤è¯- ä¸ç”¨å¼€æ”¾é¢å¤–ç«¯å£ï¼Œé˜²ç«å¢™å‹å¥½- æ˜“äºç”¨ SSH ä»£ç†å’Œå¯†é’¥ç®¡ç† - éœ€è¦è¿œç¨‹ç”¨æˆ·æœ‰ Docker æƒé™ï¼ˆå¦‚å±äº docker ç»„ï¼‰- è¿æ¥é€Ÿåº¦å¯èƒ½å— SSH è¿æ¥å½±å“- éœ€è¦åœ¨æœ¬åœ°å®‰è£…å¹¶é…ç½® SSH å¼€å‘ç¯å¢ƒã€å†…ç½‘ç®¡ç†ã€å°è§„æ¨¡è¿œç¨‹æ“ä½œ 2. TCP + TLS æ–¹å¼ - æ ‡å‡†çš„è¿œç¨‹ Docker API è®¿é—®- æ”¯æŒè¯ä¹¦è®¤è¯ï¼Œå®‰å…¨æ€§é«˜- å¯ä»¥é…ç½®å¤šä¸ªå®¢æˆ·ç«¯å’Œæƒé™æ§åˆ¶- é€‚åˆè‡ªåŠ¨åŒ–è„šæœ¬ã€CI/CD è®¿é—® - é…ç½®è¾ƒå¤æ‚ï¼Œéœ€è¦ç”Ÿæˆå’Œç®¡ç† CAã€æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯è¯ä¹¦- éœ€è¦å¼€æ”¾ TCP ç«¯å£ï¼ˆå¦‚ 2376ï¼‰ï¼Œå¢åŠ å®‰å…¨é£é™©- è¯ä¹¦é…ç½®é”™è¯¯å®¹æ˜“å¯¼è‡´è¿æ¥å¤±è´¥ ç”Ÿäº§ç¯å¢ƒã€è‡ªåŠ¨åŒ–é›†æˆã€éœ€è¦é«˜å®‰å…¨è®¤è¯ 3. TCP æ˜æ–‡è®¿é—®ï¼ˆæ—  TLSï¼‰ - é…ç½®æœ€ç®€å•ï¼Œåªéœ€ç›‘å¬ TCP ç«¯å£- æ–¹ä¾¿å¿«é€Ÿæµ‹è¯•å’Œè°ƒè¯• - æåº¦ä¸å®‰å…¨ï¼Œæ•°æ®æ˜æ–‡ä¼ è¾“- ä»»ä½•äººéƒ½å¯è®¿é—® Docker APIï¼Œææ˜“è¢«æ”»å‡»- ç”Ÿäº§ç¯å¢ƒä¸¥é‡ä¸å»ºè®®ä½¿ç”¨ ä»…é™å±€åŸŸç½‘å†…æµ‹è¯•æˆ–æç®€ç¯å¢ƒ","summary":"æ‘˜è¦ æœ¬æ–‡ä»‹ç»å¦‚ä½•è¿œç¨‹è¿æ¥Docker Dockerå®˜æ–¹æ–‡æ¡£","date_published":"2025-06-05T13:30:05.000Z","tags":["æŠ€æœ¯","docker","docker"]},{"id":"https://blog.hanqunfeng.com/2025/06/04/docker-compose/","url":"https://blog.hanqunfeng.com/2025/06/04/docker-compose/","title":"Docker å‘½ä»¤ ä¹‹ docker compose","content_html":"<!--\n **åŠ ç²—**\n *æ–œä½“*\n ***åŠ ç²—å¹¶æ–œä½“***\n ~~åˆ é™¤çº¿~~\n ==çªå‡ºæ˜¾ç¤º==\n `çªå‡ºæ˜¾ç¤º(æ¨è)`\n ++ä¸‹åˆ’çº¿++\n ~ä¸‹æ ‡~\n ^ä¸Šæ ‡^\n è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference.\n å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)\n\n +++ **ç‚¹å‡»æŠ˜å **\n è¿™æ˜¯è¢«éšè—çš„å†…å®¹\n +++\n\n::: tips success warning danger\nè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹\n:::\n\n% note info % success warning danger\nè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹\n% endnote %\n\nå¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{}\n å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ\n -->\n<h2 id=\"æ‘˜è¦\">æ‘˜è¦</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æœ¬æ–‡ä»‹ç» Docker å‘½ä»¤ ä¸­ <code>docker compose</code> çš„ä½¿ç”¨æ–¹æ³•</p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://docs.docker.com\">Dockerå®˜æ–¹æ–‡æ¡£</a></p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://docs.docker.com/compose/\">docker compose</a></p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://docs.docker.com/reference/compose-file/\">Compose file reference</a></p>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"docker-compose-æ˜¯ä»€ä¹ˆï¼Ÿ\"><code>docker compose</code> æ˜¯ä»€ä¹ˆï¼Ÿ</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Docker Composeæ˜¯ä¸€ä¸ªç”¨äºå®šä¹‰å’Œè¿è¡Œå¤šå®¹å™¨åº”ç”¨ç¨‹åºçš„å·¥å…·ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>Composeç®€åŒ–äº†å¯¹æ•´ä¸ªåº”ç”¨ç¨‹åºå †æ ˆçš„æ§åˆ¶ï¼Œä¾¿äºåœ¨å•ä¸ªYAMLé…ç½®æ–‡ä»¶ä¸­ç®¡ç†æœåŠ¡ã€ç½‘ç»œå’Œå·ã€‚ç„¶åï¼Œé€šè¿‡ä¸€ä¸ªå‘½ä»¤ï¼Œæ‚¨ä»é…ç½®æ–‡ä»¶ä¸­åˆ›å»ºå¹¶å¯åŠ¨æ‰€æœ‰æœåŠ¡ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>Docker Compose çš„ä¼˜åŠ¿ï¼š</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>ä¼˜ç‚¹</th>\n<th>æè¿°</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>ç®€åŒ–æ§åˆ¶</td>\n<td>Docker Compose å…è®¸åœ¨å•ä¸ª YAML æ–‡ä»¶ä¸­å®šä¹‰å’Œç®¡ç†å¤šå®¹å™¨åº”ç”¨ç¨‹åºï¼Œç®€åŒ–äº†æœåŠ¡ç¼–æ’ä¸åè°ƒï¼Œä½¿ç¯å¢ƒç®¡ç†å’Œå¤åˆ¶æ›´å®¹æ˜“ã€‚</td>\n</tr>\n<tr>\n<td>é«˜æ•ˆçš„åä½œ</td>\n<td>é…ç½®æ–‡ä»¶æ˜“äºå…±äº«ï¼Œä¿ƒè¿›å¼€å‘äººå‘˜ã€è¿è¥å›¢é˜Ÿå’Œå…¶ä»–åˆ©ç›Šç›¸å…³è€…ä¹‹é—´çš„åä½œï¼Œä»è€Œæå‡å·¥ä½œæµç¨‹æ•ˆç‡å’Œé—®é¢˜è§£å†³é€Ÿåº¦ã€‚</td>\n</tr>\n<tr>\n<td>å¿«é€Ÿåº”ç”¨ç¨‹åºå¼€å‘</td>\n<td>Compose åˆ©ç”¨ç¼“å­˜é‡å¤ä½¿ç”¨æœªæ›´æ”¹æœåŠ¡çš„å®¹å™¨ï¼ŒåŠ å¿«ç¯å¢ƒå˜æ›´é€Ÿåº¦ï¼Œæé«˜å¼€å‘æ•ˆç‡ã€‚</td>\n</tr>\n<tr>\n<td>è·¨ç¯å¢ƒçš„å¯ç§»æ¤æ€§</td>\n<td>æ”¯æŒåœ¨ Compose æ–‡ä»¶ä¸­ä½¿ç”¨å˜é‡ï¼Œä½¿é…ç½®èƒ½æ ¹æ®ä¸åŒç¯å¢ƒæˆ–ç”¨æˆ·è¿›è¡Œè‡ªå®šä¹‰ï¼Œå¢å¼ºäº†å¯ç§»æ¤æ€§ã€‚</td>\n</tr>\n<tr>\n<td>å¹¿æ³›çš„ç¤¾åŒºå’Œæ”¯æŒ</td>\n<td>æ‹¥æœ‰æ´»è·ƒçš„ç¤¾åŒºï¼Œæä¾›ä¸°å¯Œçš„èµ„æºã€æ•™ç¨‹å’ŒæŠ€æœ¯æ”¯æŒï¼Œæœ‰åŠ©äºæŒç»­æ”¹è¿›ä¸é«˜æ•ˆæ’éšœã€‚</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"docker-compose-å®‰è£…\"><code>docker compose</code> å®‰è£…</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åŒdockerä¸€èµ·å®‰è£…</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># å®‰è£…dockeråŒæ—¶å®‰è£…docker composeï¼Œè¿™é‡Œ docker-compose-plugin å°±æ˜¯docker compose</span></span><br><span class=\"line\"><span class=\"built_in\">sudo</span> dnf install docker-ce-3:26.1.3-1.el8 docker-ce-cli-3:26.1.3-1.el8 containerd.io docker-buildx-plugin docker-compose-plugin -y</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å•ç‹¬å®‰è£…</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># è‹¥å®‰è£…dockeræ—¶æ²¡æœ‰å®‰è£… docker-compose-plugin ï¼Œåˆ™éœ€è¦å•ç‹¬å®‰è£…</span></span><br><span class=\"line\"><span class=\"built_in\">sudo</span> dnf install docker-compose-plugin -y</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æŸ¥çœ‹ç‰ˆæœ¬</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker compose version</span><br></pre></td></tr></table></figure>\n<div class=\"tips\">\n<p><em><strong>ç›´æ¥ä¸‹è½½docker-composeçš„å‘½ä»¤æ–‡ä»¶</strong></em></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Install Docker Composeï¼Œæ³¨æ„é€šè¿‡è¿™ç§æ–¹å¼å®‰è£…çš„composeçš„ä½¿ç”¨æ–¹å¼ä¸º `docker-compose`ï¼Œè€Œéæ ‡å‡†çš„ `docker compose`</span></span><br><span class=\"line\"><span class=\"built_in\">sudo</span> curl -L <span class=\"string\">&quot;https://github.com/docker/compose/releases/latest/download/docker-compose-<span class=\"subst\">$(uname -s)</span>-<span class=\"subst\">$(uname -m)</span>&quot;</span> -o /usr/local/bin/docker-compose</span><br><span class=\"line\"><span class=\"comment\"># Make the docker-compose command available</span></span><br><span class=\"line\"><span class=\"built_in\">sudo</span> <span class=\"built_in\">chmod</span> +x /usr/local/bin/docker-compose</span><br><span class=\"line\"><span class=\"comment\"># Check Docker Compose version</span></span><br><span class=\"line\">docker-compose version</span><br></pre></td></tr></table></figure>\n</div>\n<h2 id=\"docker-compose-å‘½ä»¤\"><code>docker compose</code> å‘½ä»¤</h2>\n<table>\n<thead>\n<tr>\n<th>å‘½ä»¤</th>\n<th>ä¸­æ–‡è¯´æ˜</th>\n<th>ç¤ºä¾‹</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>attach</td>\n<td>è¿æ¥åˆ°æœåŠ¡çš„è¿è¡Œä¸­å®¹å™¨çš„æ ‡å‡†è¾“å…¥ã€è¾“å‡ºå’Œé”™è¯¯æµ</td>\n<td><code>docker compose attach web</code></td>\n</tr>\n<tr>\n<td>build</td>\n<td>æ„å»ºæˆ–é‡æ–°æ„å»ºæœåŠ¡</td>\n<td><code>docker compose build</code></td>\n</tr>\n<tr>\n<td>config</td>\n<td>è§£æå¹¶æ ‡å‡†åŒ– Compose æ–‡ä»¶</td>\n<td><code>docker compose config</code></td>\n</tr>\n<tr>\n<td>cp</td>\n<td>åœ¨æœåŠ¡å®¹å™¨ä¸æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¹‹é—´å¤åˆ¶æ–‡ä»¶/æ–‡ä»¶å¤¹</td>\n<td><code>docker compose cp web:/app/file.txt ./file.txt</code></td>\n</tr>\n<tr>\n<td>create</td>\n<td>ä¸ºæœåŠ¡åˆ›å»ºå®¹å™¨ï¼Œä½†ä¸å¯åŠ¨</td>\n<td><code>docker compose create</code></td>\n</tr>\n<tr>\n<td>down</td>\n<td>åœæ­¢å¹¶ç§»é™¤å®¹å™¨ã€ç½‘ç»œç­‰èµ„æº</td>\n<td><code>docker compose down</code></td>\n</tr>\n<tr>\n<td>events</td>\n<td>å®æ—¶æ¥æ”¶å®¹å™¨äº‹ä»¶</td>\n<td><code>docker compose events</code></td>\n</tr>\n<tr>\n<td>exec</td>\n<td>åœ¨è¿è¡Œä¸­çš„å®¹å™¨ä¸­æ‰§è¡Œå‘½ä»¤</td>\n<td><code>docker compose exec web ls /app</code></td>\n</tr>\n<tr>\n<td>images</td>\n<td>åˆ—å‡ºå·²åˆ›å»ºå®¹å™¨æ‰€ä½¿ç”¨çš„é•œåƒ</td>\n<td><code>docker compose images</code></td>\n</tr>\n<tr>\n<td>kill</td>\n<td>å¼ºåˆ¶åœæ­¢æœåŠ¡å®¹å™¨</td>\n<td><code>docker compose kill</code></td>\n</tr>\n<tr>\n<td>logs</td>\n<td>æŸ¥çœ‹æœåŠ¡å®¹å™¨çš„æ—¥å¿—è¾“å‡º</td>\n<td><code>docker compose logs</code></td>\n</tr>\n<tr>\n<td>ls</td>\n<td>åˆ—å‡ºå½“å‰è¿è¡Œçš„ Compose é¡¹ç›®</td>\n<td><code>docker compose ls</code></td>\n</tr>\n<tr>\n<td>pause</td>\n<td>æš‚åœæœåŠ¡å®¹å™¨</td>\n<td><code>docker compose pause</code></td>\n</tr>\n<tr>\n<td>port</td>\n<td>æ˜¾ç¤ºæŸç«¯å£æ˜ å°„çš„å…¬ç½‘åœ°å€</td>\n<td><code>docker compose port web 80</code></td>\n</tr>\n<tr>\n<td>ps</td>\n<td>åˆ—å‡ºæœåŠ¡çš„å®¹å™¨</td>\n<td><code>docker compose ps</code></td>\n</tr>\n<tr>\n<td>pull</td>\n<td>æ‹‰å–æœåŠ¡ä½¿ç”¨çš„é•œåƒ</td>\n<td><code>docker compose pull</code></td>\n</tr>\n<tr>\n<td>push</td>\n<td>æ¨é€æœåŠ¡é•œåƒåˆ°ä»“åº“</td>\n<td><code>docker compose push</code></td>\n</tr>\n<tr>\n<td>restart</td>\n<td>é‡å¯æœåŠ¡å®¹å™¨</td>\n<td><code>docker compose restart</code></td>\n</tr>\n<tr>\n<td>rm</td>\n<td>ç§»é™¤å·²åœæ­¢çš„æœåŠ¡å®¹å™¨</td>\n<td><code>docker compose rm</code></td>\n</tr>\n<tr>\n<td>run</td>\n<td>åœ¨æœåŠ¡ä¸Šè¿è¡Œä¸€æ¬¡æ€§å‘½ä»¤</td>\n<td><code>docker compose run web echo Hello</code></td>\n</tr>\n<tr>\n<td>scale</td>\n<td>æ‰©å±•æœåŠ¡å®ä¾‹æ•°é‡</td>\n<td><code>docker compose up --scale web=3</code></td>\n</tr>\n<tr>\n<td>start</td>\n<td>å¯åŠ¨å·²å­˜åœ¨ä½†å·²åœæ­¢çš„æœåŠ¡å®¹å™¨</td>\n<td><code>docker compose start</code></td>\n</tr>\n<tr>\n<td>stats</td>\n<td>å®æ—¶æ˜¾ç¤ºå®¹å™¨èµ„æºä½¿ç”¨æƒ…å†µ</td>\n<td><code>docker compose stats</code></td>\n</tr>\n<tr>\n<td>stop</td>\n<td>åœæ­¢è¿è¡Œä¸­çš„æœåŠ¡å®¹å™¨</td>\n<td><code>docker compose stop</code></td>\n</tr>\n<tr>\n<td>top</td>\n<td>æ˜¾ç¤ºå®¹å™¨å†…çš„è¿è¡Œè¿›ç¨‹</td>\n<td><code>docker compose top</code></td>\n</tr>\n<tr>\n<td>unpause</td>\n<td>å–æ¶ˆæš‚åœæœåŠ¡å®¹å™¨</td>\n<td><code>docker compose unpause</code></td>\n</tr>\n<tr>\n<td>up</td>\n<td>åˆ›å»ºå¹¶å¯åŠ¨æœåŠ¡å®¹å™¨</td>\n<td><code>docker compose up</code></td>\n</tr>\n<tr>\n<td>version</td>\n<td>æ˜¾ç¤º Docker Compose ç‰ˆæœ¬ä¿¡æ¯</td>\n<td><code>docker compose version</code></td>\n</tr>\n<tr>\n<td>wait</td>\n<td>é˜»å¡ç›´åˆ°ç¬¬ä¸€ä¸ªæœåŠ¡å®¹å™¨åœæ­¢</td>\n<td><code>docker compose wait</code></td>\n</tr>\n<tr>\n<td>watch</td>\n<td>ç›‘å¬æœåŠ¡æ„å»ºä¸Šä¸‹æ–‡å˜æ›´å¹¶é‡æ–°æ„å»º/åˆ·æ–°å®¹å™¨</td>\n<td><code>docker compose watch</code></td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"docker-compose-å¸¸ç”¨å‘½ä»¤\"><code>docker compose</code> å¸¸ç”¨å‘½ä»¤</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å¯åŠ¨ä¸å…³é—­</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># å¯åŠ¨å¹¶è¿è¡Œï¼Œé»˜è®¤ä½¿ç”¨å½“å‰ç›®å½•çš„ docker-compose.yml æ–‡ä»¶</span></span><br><span class=\"line\">docker compose up</span><br><span class=\"line\"><span class=\"comment\"># åå°è¿è¡Œ</span></span><br><span class=\"line\">docker compose up -d</span><br><span class=\"line\"><span class=\"comment\"># æŒ‡å®šcomposeæ–‡ä»¶</span></span><br><span class=\"line\">docker compose -f docker-compose.yml up -d</span><br><span class=\"line\"><span class=\"comment\"># å¯åŠ¨æ—¶é‡å»ºæœåŠ¡ï¼Œå½“ä¿®æ”¹äº† compose æ–‡ä»¶æ—¶</span></span><br><span class=\"line\">docker compose up --build</span><br><span class=\"line\"><span class=\"comment\"># åœæ­¢service</span></span><br><span class=\"line\">docker compose stop</span><br><span class=\"line\"><span class=\"comment\"># å¼ºåˆ¶åœæ­¢serviceï¼Œå½“ stop å‘½ä»¤æ— æ³•åœæ­¢æ—¶</span></span><br><span class=\"line\">docker compose <span class=\"built_in\">kill</span></span><br><span class=\"line\"><span class=\"comment\"># é‡å¯service</span></span><br><span class=\"line\">docker compose restart</span><br><span class=\"line\"><span class=\"comment\"># åˆ é™¤serviceï¼Œ-s å‚æ•°è¡¨ç¤ºåˆ é™¤å‰å…ˆåœæ­¢å®¹å™¨</span></span><br><span class=\"line\">docker compose <span class=\"built_in\">rm</span> -s</span><br><span class=\"line\"><span class=\"comment\"># åœæ­¢å¹¶åˆ é™¤serviceï¼ŒåŒæ—¶åˆ é™¤ç½‘ç»œï¼Œä½†ä¸ä¼šåˆ é™¤å·</span></span><br><span class=\"line\">docker compose down</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ç›‘æ§</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># åˆ—å‡ºå½“å‰è¿è¡Œçš„ Compose é¡¹ç›®</span></span><br><span class=\"line\">docker compose <span class=\"built_in\">ls</span></span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹serviceçŠ¶æ€ï¼Œ-a æ˜¾ç¤ºæ‰€æœ‰service</span></span><br><span class=\"line\">docker compose ps -a</span><br><span class=\"line\"><span class=\"comment\"># è§£æå¹¶æ ‡å‡†åŒ– compose æ–‡ä»¶ï¼Œè¿™ä¸ªå‘½ä»¤å¯ä»¥æ£€æŸ¥ docker-compose.yml æ–‡ä»¶è¯­æ³•æ˜¯å¦æ­£ç¡®ï¼Œä½†ä¸ä¿è¯é€»è¾‘æ­£ç¡®</span></span><br><span class=\"line\">docker compose config</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹ä½¿ç”¨çš„é•œåƒ</span></span><br><span class=\"line\">docker compose images</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹è¿›ç¨‹</span></span><br><span class=\"line\">docker compose top</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹serviceèµ„æºä½¿ç”¨æƒ…å†µ</span></span><br><span class=\"line\">docker compose stats</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹serviceæ—¥å¿—ï¼Œ-f è¡¨ç¤ºæŒç»­è·Ÿè¸ª</span></span><br><span class=\"line\">docker compose logs -f</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹æŒ‡å®šserviceçš„æ—¥å¿—</span></span><br><span class=\"line\">docker compose logs -f service_name</span><br><span class=\"line\"><span class=\"comment\"># è¿›å…¥æŒ‡å®šçš„serviceå®¹å™¨</span></span><br><span class=\"line\">docker compose <span class=\"built_in\">exec</span> service_name bash</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å‡çº§é•œåƒ</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># å…ˆåœæ­¢æ‰€æœ‰service</span></span><br><span class=\"line\">docker compose down</span><br><span class=\"line\"><span class=\"comment\"># æ‹‰å–æœ€æ–°é•œåƒ</span></span><br><span class=\"line\">docker compose pull</span><br><span class=\"line\"><span class=\"comment\"># å¯åŠ¨service</span></span><br><span class=\"line\">docker compose up -d --build</span><br></pre></td></tr></table></figure>\n<h2 id=\"docker-compose-yml-çš„è¯­æ³•\"><code>docker-compose.yml</code> çš„è¯­æ³•</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å¸¸ç”¨æŒ‡ä»¤</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">version: <span class=\"string\">&quot;3.8&quot;</span> <span class=\"comment\"># å®šä¹‰ç‰ˆæœ¬ï¼Œè¡¨ç¤ºå½“å‰ä½¿ç”¨çš„ docker compose è¯­æ³•çš„ç‰ˆæœ¬ï¼Œå·²è¿‡æ—¶ ï¼Œæ–°ç‰ˆ Docker ä¼šä½¿ç”¨æœ€æ–°çš„ Compose Specification è‡ªåŠ¨è§£æ</span></span><br><span class=\"line\">name: <span class=\"string\">&quot;project_name&quot;</span> <span class=\"comment\">#  é¡¹ç›®åï¼Œé»˜è®¤ docker-compose.yml æ–‡ä»¶æ‰€åœ¨çš„ç›®å½•åï¼Œä¸æ¨èè®¾ç½®</span></span><br><span class=\"line\">services: <span class=\"comment\"># æœåŠ¡åˆ—è¡¨</span></span><br><span class=\"line\">  servicename: <span class=\"comment\"># æœåŠ¡åå­—ï¼Œåªèƒ½åŒ…å«å°å†™å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ã€ä¸­åˆ’çº¿ï¼Œå¿…é¡»ä»¥å­—æ¯æˆ–æ•°å­—å¼€å¤´</span></span><br><span class=\"line\">    build: <span class=\"comment\"># åŸºäºDockerfileæ„å»ºç›®å½•ï¼Œå¦‚æœåŒæ—¶è®¾ç½®äº† image é€‰é¡¹ï¼Œåˆ™imageæŒ‡å®šçš„å°±æ˜¯æ„å»ºåçš„é•œåƒåç§°</span></span><br><span class=\"line\">    image: <span class=\"comment\"># é•œåƒçš„åå­—ï¼Œé»˜è®¤ä»è¿œç¨‹ä»“åº“æ‹‰å–ï¼Œå¦‚æœé…ç½®äº† build é€‰é¡¹ï¼Œåˆ™imageæŒ‡å®šçš„å°±æ˜¯æ„å»ºåçš„é•œåƒåç§°</span></span><br><span class=\"line\">    <span class=\"built_in\">command</span>: <span class=\"comment\"># å¯é€‰ï¼Œå¦‚æœè®¾ç½®ï¼Œåˆ™ä¼šè¦†ç›–é»˜è®¤é•œåƒé‡Œçš„ CMD å‘½ä»¤</span></span><br><span class=\"line\">    environment: <span class=\"comment\"># å¯é€‰ï¼Œç­‰ä»·äº docker container run é‡Œçš„ --env é€‰é¡¹è®¾ç½®ç¯å¢ƒå˜é‡</span></span><br><span class=\"line\">    volumes: <span class=\"comment\"># å¯é€‰ï¼Œç­‰ä»·äº docker container run é‡Œçš„ -v é€‰é¡¹ ç»‘å®šæ•°æ®å·</span></span><br><span class=\"line\">    networks: <span class=\"comment\"># å¯é€‰ï¼Œç­‰ä»·äº docker container run é‡Œçš„ --network é€‰é¡¹æŒ‡å®šç½‘ç»œ</span></span><br><span class=\"line\">    ports: <span class=\"comment\"># å¯é€‰ï¼Œç­‰ä»·äº docker container run é‡Œçš„ -p é€‰é¡¹æŒ‡å®šç«¯å£æ˜ å°„</span></span><br><span class=\"line\">    expose: <span class=\"comment\"># å¯é€‰ï¼ŒæŒ‡å®šå®¹å™¨æš´éœ²çš„ç«¯å£</span></span><br><span class=\"line\">    depends_on: <span class=\"comment\"># æœåŠ¡ä¾èµ–çš„å…¶å®ƒæœåŠ¡</span></span><br><span class=\"line\">    env_file: <span class=\"comment\"># ç¯å¢ƒå˜é‡æ–‡ä»¶ï¼Œç”Ÿäº§ç¯å¢ƒæ›´æ¨èè¿™ç§æ–¹å¼</span></span><br><span class=\"line\">  servicename2:</span><br><span class=\"line\">    image:</span><br><span class=\"line\">    <span class=\"built_in\">command</span>:</span><br><span class=\"line\">    networks:</span><br><span class=\"line\">    ports:</span><br><span class=\"line\">  servicename3:</span><br><span class=\"line\">    <span class=\"comment\">#...</span></span><br><span class=\"line\"></span><br><span class=\"line\">volumes: <span class=\"comment\"># å¯é€‰ï¼Œç­‰ä»·äº docker volume create</span></span><br><span class=\"line\">networks: <span class=\"comment\"># å¯é€‰ï¼Œç­‰ä»·äº docker network create</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"volumes\">volumes</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å·æ˜¯ç”±å®¹å™¨å¼•æ“å®ç°çš„æŒä¹…æ•°æ®å­˜å‚¨ã€‚Compose ä¸ºæœåŠ¡æä¾›äº†ä¸€ç§ä¸­ç«‹çš„æŒ‚è½½å·çš„æ–¹å¼ï¼Œå¹¶é€šè¿‡é…ç½®å‚æ•°å°†å·åˆ†é…ç»™åŸºç¡€æ¶æ„ã€‚é¡¶çº§volumeså£°æ˜å…è®¸æ‚¨é…ç½®å¯åœ¨å¤šä¸ªæœåŠ¡ä¹‹é—´é‡å¤ä½¿ç”¨çš„å‘½åå·ã€‚</p>\n</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\">  <span class=\"attr\">backend:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">example/database</span></span><br><span class=\"line\">    <span class=\"attr\">volumes:</span> <span class=\"comment\"># æŒ‚è½½å·æ˜ å°„</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">db-data:/etc/data</span> <span class=\"comment\"># æŒ‚è½½åˆ°å®¹å™¨çš„/etc/dataç›®å½•</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"attr\">backup:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">backup-service</span></span><br><span class=\"line\">    <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">db-data:/var/lib/backup/data</span> <span class=\"comment\"># ä¸€ä¸ªå·å¯ä»¥è¢«å¤šä¸ªæœåŠ¡ä½¿ç”¨</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">volumes:</span> <span class=\"comment\"># å­˜å‚¨å·é…ç½®</span></span><br><span class=\"line\">  <span class=\"attr\">db-data:</span>  <span class=\"comment\"># åˆ›å»ºä¸€ä¸ªåä¸ºdb-dataçš„å·ï¼Œå®é™…çš„ç½‘ç»œåç§°æ˜¯ å®¹å™¨ç»„åç§°_è¿™é‡Œçš„åç§°</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"volumes-çš„å±æ€§\">volumes çš„å±æ€§</h4>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>driver: å·ç±»å‹ï¼Œé»˜è®¤ä¸ºlocalï¼ŒæŒ‡å®šåº”ä½¿ç”¨å“ªä¸ªå·é©±åŠ¨ç¨‹åºã€‚å¦‚æœè¯¥é©±åŠ¨ç¨‹åºä¸å¯ç”¨ï¼ŒCompose å°†è¿”å›é”™è¯¯å¹¶ä¸”ä¸ä¼šéƒ¨ç½²è¯¥åº”ç”¨ç¨‹åºã€‚</p>\n</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">volumes:</span></span><br><span class=\"line\">  <span class=\"attr\">db-data:</span> <span class=\"comment\"># å£°æ˜ä¸€ä¸ªåä¸ºdb-dataçš„å·</span></span><br><span class=\"line\">    <span class=\"attr\">driver:</span> <span class=\"string\">local</span> <span class=\"comment\"># æŒ‡å®šå·ç±»å‹ï¼Œè¿™ä¸ªæ˜¯é»˜è®¤å€¼ï¼Œå¯ä»¥ä¸é…ç½®</span></span><br><span class=\"line\">  <span class=\"attr\">db-data2:</span> <span class=\"comment\"># å£°æ˜ä¸€ä¸ªåä¸ºdb-data2çš„å·ï¼Œè¿™æ˜¯æœ€ç®€å•çš„ volumes é…ç½®</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>driver_opts: å·ç±»å‹å‚æ•°ï¼ŒæŒ‡å®šè¦ä¼ é€’ç»™æ­¤å·é©±åŠ¨ç¨‹åºçš„é€‰é¡¹åˆ—è¡¨ï¼ˆä»¥é”®å€¼å¯¹çš„å½¢å¼ï¼‰ã€‚è¿™äº›é€‰é¡¹ä¸é©±åŠ¨ç¨‹åºç›¸å…³ã€‚</p>\n</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">volumes:</span></span><br><span class=\"line\">  <span class=\"attr\">db-data:</span></span><br><span class=\"line\">    <span class=\"attr\">driver_opts:</span> <span class=\"comment\"># å·ç±»å‹å‚æ•°ï¼ŒæŒ‡å®šè¦ä¼ é€’ç»™æ­¤å·é©±åŠ¨ç¨‹åºçš„é€‰é¡¹åˆ—è¡¨ï¼ˆä»¥é”®å€¼å¯¹çš„å½¢å¼ï¼‰</span></span><br><span class=\"line\">      <span class=\"attr\">type:</span> <span class=\"string\">&quot;nfs&quot;</span> <span class=\"comment\"># å·ç±»å‹ï¼ŒæŒ‡å®šåº”ä½¿ç”¨å“ªä¸ªå·é©±åŠ¨ç¨‹åºï¼Œè¿™é‡Œæ˜¯nfs</span></span><br><span class=\"line\">      <span class=\"attr\">o:</span> <span class=\"string\">&quot;addr=10.40.0.199,nolock,soft,rw&quot;</span> <span class=\"comment\"># nfså‚æ•°ï¼Œaddrä¸ºnfsæœåŠ¡å™¨åœ°å€ï¼Œnolockä¸ºä¸é”å®šæ–‡ä»¶ï¼Œsoftä¸ºè½¯é“¾æ¥ï¼Œrwä¸ºè¯»å†™æƒé™</span></span><br><span class=\"line\">      <span class=\"attr\">device:</span> <span class=\"string\">&quot;:/docker/example&quot;</span> <span class=\"comment\"># nfsæŒ‚è½½è·¯å¾„</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>external: å·æ˜¯å¦ä¸ºå¤–éƒ¨å·ï¼Œé»˜è®¤ä¸ºfalse</p>\n</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">volumes:</span></span><br><span class=\"line\">  <span class=\"attr\">db-data:</span></span><br><span class=\"line\">    <span class=\"attr\">external:</span> <span class=\"literal\">true</span> <span class=\"comment\"># true è¡¨ç¤ºä¸ä¼šåˆ›å»ºï¼Œè€Œæ˜¯ä½¿ç”¨å·²å­˜åœ¨çš„ï¼Œå³ä¼šå»volumesä¸­æŸ¥æ‰¾(docker volume ls) å®¹å™¨ç»„åç§°_da-data ï¼Œé»˜è®¤ä¸ºfalse</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>name: å·çš„åç§°ï¼Œé»˜è®¤ä¸º å®¹å™¨ç»„åç§°_å£°æ˜çš„åç§°</p>\n</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">volumes:</span></span><br><span class=\"line\">  <span class=\"attr\">db-data:</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">db-data</span> <span class=\"comment\"># åˆ›å»ºä¸€ä¸ªåä¸ºdb-dataçš„å·ï¼Œå®é™…çš„å·åç§°å°±æ˜¯ db-dataï¼Œä¸ä¼šå†åŠ ä¸Šå®¹å™¨ç»„åç§°å‰ç¼€</span></span><br><span class=\"line\">    <span class=\"attr\">external:</span> <span class=\"literal\">true</span> <span class=\"comment\"># name å±æ€§ç»å¸¸ä¸  external: true ä¸€èµ·ä½¿ç”¨</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>labels: ç”¨äºå‘å·æ·»åŠ å…ƒæ•°æ®ï¼Œå¯ä»¥æ·»åŠ ä»»æ„çš„é”®å€¼å¯¹</p>\n</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">volumes:</span></span><br><span class=\"line\">  <span class=\"attr\">db-data:</span></span><br><span class=\"line\">    <span class=\"attr\">labels:</span></span><br><span class=\"line\">      <span class=\"attr\">com.example.description:</span> <span class=\"string\">&quot;Database volume&quot;</span></span><br><span class=\"line\">      <span class=\"attr\">com.example.department:</span> <span class=\"string\">&quot;IT/Ops&quot;</span></span><br><span class=\"line\">      <span class=\"attr\">com.example.label-with-empty-value:</span> <span class=\"string\">&quot;&quot;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"networks\">networks</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ç½‘ç»œä½¿æœåŠ¡èƒ½å¤Ÿç›¸äº’é€šä¿¡ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒCompose ä¼šä¸ºæ‚¨çš„åº”ç”¨è®¾ç½®å•ä¸ªç½‘ç»œã€‚æœåŠ¡çš„æ¯ä¸ªå®¹å™¨éƒ½ä¼šåŠ å…¥é»˜è®¤ç½‘ç»œï¼Œå¹¶ä¸”è¯¥ç½‘ç»œä¸Šçš„å…¶ä»–å®¹å™¨éƒ½å¯ä»¥è®¿é—®ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡æœåŠ¡åç§°å‘ç°ã€‚é¡¶çº§networkså…ƒç´ å…è®¸æ‚¨é…ç½®å¯åœ¨å¤šä¸ªæœåŠ¡ä¹‹é—´é‡å¤ä½¿ç”¨çš„å‘½åç½‘ç»œã€‚</p>\n</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\">  <span class=\"attr\">frontend:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">example/webapp</span></span><br><span class=\"line\">    <span class=\"attr\">networks:</span>  <span class=\"comment\">#  ç½‘ç»œæ˜ å°„</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">front-tier</span> <span class=\"comment\">#  åŠ å…¥front-tierç½‘ç»œ</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">back-tier</span></span><br><span class=\"line\">  <span class=\"attr\">db:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">postgres</span></span><br><span class=\"line\">    <span class=\"attr\">networks:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">backend</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">networks:</span>    <span class=\"comment\"># ç½‘ç»œé…ç½®</span></span><br><span class=\"line\">  <span class=\"attr\">front-tier:</span> <span class=\"comment\"># åˆ›å»ºä¸€ä¸ªåä¸ºfront-tierçš„ç½‘ç»œï¼Œå®é™…çš„ç½‘ç»œåç§°æ˜¯ å®¹å™¨ç»„åç§°_front-tier</span></span><br><span class=\"line\">  <span class=\"attr\">back-tier:</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å¦‚æœ Compose æ–‡ä»¶æœªæ˜¾å¼å£°æ˜ç½‘ç»œï¼ŒCompose å°†ä½¿ç”¨éšå¼defaultç½‘ç»œã€‚</p>\n</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\">  <span class=\"attr\">some-service:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">foo</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># è¿™ä¸ªä¾‹å­å®é™…ä¸Šç­‰åŒäºï¼š</span></span><br><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\">  <span class=\"attr\">some-service:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">foo</span></span><br><span class=\"line\">    <span class=\"attr\">networks:</span></span><br><span class=\"line\">      <span class=\"attr\">default:</span> &#123;&#125;</span><br><span class=\"line\"><span class=\"attr\">networks:</span></span><br><span class=\"line\">  <span class=\"attr\">default:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"networks-çš„å±æ€§\">networks çš„å±æ€§</h4>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>driver: ç½‘ç»œç±»å‹ï¼Œé»˜è®¤ä¸ºbridge</p>\n</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">networks:</span></span><br><span class=\"line\">  <span class=\"attr\">gitea:</span></span><br><span class=\"line\">    <span class=\"attr\">driver:</span> <span class=\"string\">bridge</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>driver_opts: ç½‘ç»œç±»å‹å‚æ•°ï¼ŒæŒ‡å®šè¦ä¼ é€’ç»™æ­¤ç½‘ç»œé©±åŠ¨ç¨‹åºçš„é€‰é¡¹åˆ—è¡¨ï¼ˆä»¥é”®å€¼å¯¹çš„å½¢å¼ï¼‰ã€‚è¿™äº›é€‰é¡¹ä¸é©±åŠ¨ç¨‹åºç›¸å…³ã€‚</p>\n</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">networks:</span></span><br><span class=\"line\">  <span class=\"attr\">frontend:</span></span><br><span class=\"line\">    <span class=\"attr\">driver:</span> <span class=\"string\">bridge</span></span><br><span class=\"line\">    <span class=\"attr\">driver_opts:</span></span><br><span class=\"line\">      <span class=\"attr\">com.docker.network.bridge.host_binding_ipv4:</span> <span class=\"string\">&quot;127.0.0.1&quot;</span> <span class=\"comment\"># è®¾ç½®å®¹å™¨ç«¯å£ç»‘å®šåˆ°ä¸»æœºçš„å“ªä¸ª IPï¼ˆå¦‚ &quot;127.0.0.1&quot;ï¼Œç»‘å®šåˆ°æœ¬åœ°ï¼‰</span></span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>driver_opts å¸¸è§é…ç½®é¡¹ï¼ˆé’ˆå¯¹ bridge ç½‘ç»œé©±åŠ¨ï¼‰</p>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th>é€‰é¡¹é”®åï¼ˆ<code>driver_opts</code>ï¼‰</th>\n<th>è¯´æ˜</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>com.docker.network.bridge.name</code></td>\n<td>æŒ‡å®šæ¡¥æ¥ç½‘ç»œçš„åç§°ï¼ˆé»˜è®¤æ˜¯éšæœºç”Ÿæˆï¼Œå¦‚ <code>br-xxxxx</code>ï¼‰</td>\n</tr>\n<tr>\n<td><code>com.docker.network.bridge.enable_icc</code></td>\n<td>æ˜¯å¦å…è®¸å®¹å™¨ä¹‹é—´çš„é€šä¿¡ï¼ˆ<code>true</code> æˆ– <code>false</code>ï¼‰</td>\n</tr>\n<tr>\n<td><code>com.docker.network.bridge.enable_ip_masquerade</code></td>\n<td>æ˜¯å¦å¯ç”¨ IP å‡å†’ï¼ˆNATï¼Œé€šå¸¸ç”¨äºå¤–ç½‘è®¿é—®ï¼‰</td>\n</tr>\n<tr>\n<td><code>com.docker.network.bridge.host_binding_ipv4</code></td>\n<td>è®¾ç½®å®¹å™¨ç«¯å£ç»‘å®šåˆ°ä¸»æœºçš„å“ªä¸ª IPï¼ˆå¦‚ <code>&quot;127.0.0.1&quot;</code>ï¼Œç»‘å®šåˆ°æœ¬åœ°ï¼‰</td>\n</tr>\n<tr>\n<td><code>com.docker.network.bridge.default_bridge</code></td>\n<td>æ˜¯å¦å°†è¯¥ç½‘ç»œè®¾ç½®ä¸ºé»˜è®¤ bridge ç½‘ç»œï¼ˆ<code>true</code> æˆ– <code>false</code>ï¼‰</td>\n</tr>\n<tr>\n<td><code>com.docker.network.driver.mtu</code></td>\n<td>è®¾ç½®ç½‘ç»œçš„æœ€å¤§ä¼ è¾“å•å…ƒï¼ˆMTUï¼Œä¾‹å¦‚ <code>&quot;1500&quot;</code>ï¼‰</td>\n</tr>\n<tr>\n<td><code>com.docker.network.bridge.allow_non_default_bridge</code></td>\n<td>æ˜¯å¦å…è®¸å®¹å™¨åŠ å…¥éé»˜è®¤çš„ bridge ç½‘ç»œï¼ˆè¾ƒå°‘ä½¿ç”¨ï¼‰</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>attachable: å¦‚æœä¸ºtrueï¼Œåˆ™å…è®¸å°†å…¶å®ƒç‹¬ç«‹å®¹å™¨ä¹ŸåŠ å…¥åˆ°æ­¤ç½‘ç»œã€‚é»˜è®¤å€¼ä¸ºfalseã€‚å¦‚æœç‹¬ç«‹å®¹å™¨è¿æ¥åˆ°æ­¤ç½‘ç»œï¼Œå®ƒå¯ä»¥ä¸åŒæ ·è¿æ¥åˆ°æ­¤ç½‘ç»œçš„æœåŠ¡å’Œå…¶ä»–ç‹¬ç«‹å®¹å™¨è¿›è¡Œé€šä¿¡ã€‚</p>\n</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">networks:</span></span><br><span class=\"line\">  <span class=\"attr\">gitea:</span></span><br><span class=\"line\">    <span class=\"attr\">attachable:</span> <span class=\"literal\">true</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>external: true è¡¨ç¤ºä¸ä¼šåˆ›å»ºæ–°çš„ç½‘ç»œï¼Œå›å»networksä¸­æŸ¥æ‰¾ï¼ˆdocker network lsï¼‰ï¼Œé»˜è®¤ä¸ºfalse</p>\n</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">networks:</span></span><br><span class=\"line\">  <span class=\"attr\">gitea:</span></span><br><span class=\"line\">    <span class=\"attr\">external:</span> <span class=\"literal\">true</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>name: ç½‘ç»œåç§°ï¼Œä¸ä¼šå†åŠ ä¸Šå®¹å™¨ç»„åç§°å‰ç¼€</p>\n</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">networks:</span></span><br><span class=\"line\">  <span class=\"attr\">gitea:</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">gitea</span></span><br><span class=\"line\">    <span class=\"attr\">external:</span> <span class=\"literal\">true</span> <span class=\"comment\"># name å±æ€§ç»å¸¸ä¸  external: true ä¸€èµ·ä½¿ç”¨</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>labels: ç”¨äºå‘ç½‘ç»œæ·»åŠ å…ƒæ•°æ®ï¼Œå¯ä»¥æ·»åŠ ä»»æ„çš„é”®å€¼å¯¹</p>\n</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">networks:</span></span><br><span class=\"line\">  <span class=\"attr\">mynet1:</span></span><br><span class=\"line\">    <span class=\"attr\">labels:</span></span><br><span class=\"line\">      <span class=\"attr\">com.example.description:</span> <span class=\"string\">&quot;Financial transaction network&quot;</span></span><br><span class=\"line\">      <span class=\"attr\">com.example.department:</span> <span class=\"string\">&quot;Finance&quot;</span></span><br><span class=\"line\">      <span class=\"attr\">com.example.label-with-empty-value:</span> <span class=\"string\">&quot;&quot;</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>internal: é»˜è®¤æƒ…å†µä¸‹ï¼ŒCompose æä¾›ç½‘ç»œçš„å¤–éƒ¨è¿æ¥ã€‚internalå½“è®¾ç½®ä¸º æ—¶trueï¼Œå¯è®©æ‚¨åˆ›å»ºä¸å¤–éƒ¨éš”ç¦»çš„ç½‘ç»œã€‚</p>\n</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">networks:</span></span><br><span class=\"line\">  <span class=\"attr\">gitea:</span></span><br><span class=\"line\">    <span class=\"attr\">internal:</span> <span class=\"literal\">true</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"services\">services</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æœåŠ¡æ˜¯åº”ç”¨ç¨‹åºä¸­è®¡ç®—èµ„æºçš„æŠ½è±¡å®šä¹‰ï¼Œå¯ä»¥ç‹¬ç«‹äºå…¶ä»–ç»„ä»¶è¿›è¡Œæ‰©å±•æˆ–æ›¿æ¢ã€‚æœåŠ¡ç”±ä¸€ç»„å®¹å™¨æ”¯æŒï¼Œç”±å¹³å°æ ¹æ®å¤åˆ¶è¦æ±‚å’Œå¸ƒå±€çº¦æŸè¿è¡Œã€‚ç”±äºæœåŠ¡ç”±å®¹å™¨æ”¯æŒï¼Œå› æ­¤å®ƒä»¬ç”± Docker é•œåƒå’Œä¸€ç»„è¿è¡Œæ—¶å‚æ•°å®šä¹‰ã€‚æœåŠ¡ä¸­çš„æ‰€æœ‰å®¹å™¨éƒ½ä½¿ç”¨è¿™äº›å‚æ•°ä»¥ç›¸åŒçš„æ–¹å¼åˆ›å»ºã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>service åŒ…å«çš„å±æ€§éå¸¸å¤šï¼Œå…·ä½“è¯·å‚è€ƒ<a href=\"https://docs.docker.com/reference/compose-file/services/\">servicesé¡¶çº§å…ƒç´ </a>ï¼Œè¿™é‡Œåªä»‹ç»æ¯”è¾ƒå¸¸ç”¨çš„å±æ€§ï¼Œ</p>\n</li>\n<li class=\"lvl-2\">\n<p>è¿™é‡Œä»¥<a href=\"https://docs.gitea.com/installation/install-with-docker\">Gitea</a>çš„<code>docker-compose.yml</code>ä¸ºä¾‹</p>\n</li>\n</ul>\n<blockquote>\n<p>Gitea æ˜¯ä¸€ç§è½»æ¾ã€è‡ªæ‰˜ç®¡çš„ä¸€ä½“åŒ–è½¯ä»¶å¼€å‘æœåŠ¡ã€‚å®ƒåŒ…æ‹¬ Git æ‰˜ç®¡ã€ä»£ç å®¡æŸ¥ã€å›¢é˜Ÿåä½œã€åŒ…æ³¨å†Œè¡¨å’Œ CI/CDã€‚å®ƒç±»ä¼¼äº GitHubã€Bitbucket å’Œ GitLabã€‚</p>\n</blockquote>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># version: &#x27;3.8&#x27; # é…ç½®æ–‡ä»¶ç‰ˆæœ¬ï¼Œå·²è¿‡æ—¶ï¼Œé…ç½®ä¸Šä¼šå‘Šè­¦ä½†ä¸ä¼šæŠ¥é”™</span></span><br><span class=\"line\"><span class=\"comment\"># name: gitea # å®¹å™¨ç»„åç§°ï¼Œé»˜è®¤ä½¿ç”¨æ‰€åœ¨ç›®å½•çš„åç§°ï¼Œä¸æ¨èä½¿ç”¨</span></span><br><span class=\"line\"><span class=\"attr\">networks:</span> <span class=\"comment\"># ç½‘ç»œé…ç½®</span></span><br><span class=\"line\">  <span class=\"attr\">gitea:</span> <span class=\"comment\"># åˆ›å»ºä¸€ä¸ªåä¸ºgiteaçš„ç½‘ç»œï¼Œå®é™…çš„ç½‘ç»œåç§°æ˜¯ gitea_giteaï¼Œå³ å®¹å™¨ç»„åç§°_è¿™é‡Œçš„åç§°</span></span><br><span class=\"line\">    <span class=\"attr\">external:</span> <span class=\"literal\">false</span> <span class=\"comment\"># å¦‚æœä¸ºtrueï¼Œåˆ™è¡¨ç¤ºæ­¤ç½‘ç»œä¸ä¼šç”±composeåˆ›å»ºï¼Œè€Œæ˜¯ä½¿ç”¨å·²æœ‰çš„ç½‘ç»œï¼Œé»˜è®¤ä¸ºfalse</span></span><br><span class=\"line\">    <span class=\"attr\">driver:</span> <span class=\"string\">bridge</span>  <span class=\"comment\"># ç½‘ç»œç±»å‹ï¼Œé»˜è®¤ä¸ºbridge</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">volumes:</span> <span class=\"comment\"># å­˜å‚¨å·é…ç½®</span></span><br><span class=\"line\">  <span class=\"attr\">gitea:</span> <span class=\"comment\"># åˆ›å»ºä¸€ä¸ªåä¸ºgiteaçš„å­˜å‚¨å·ï¼Œå®é™…çš„å·åç§°æ˜¯ gitea_giteaï¼Œå³ å®¹å™¨ç»„åç§°_è¿™é‡Œçš„åç§°</span></span><br><span class=\"line\">    <span class=\"attr\">driver:</span> <span class=\"string\">local</span> <span class=\"comment\"># å­˜å‚¨å·ç±»å‹ï¼Œé»˜è®¤ä¸ºlocal</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">services:</span> <span class=\"comment\"># æœåŠ¡é…ç½®ï¼Œè¿™é‡Œå¯ä»¥å®šä¹‰ä¸€ç»„å®¹å™¨</span></span><br><span class=\"line\">  <span class=\"attr\">server:</span> <span class=\"comment\"># å®šä¹‰ä¸€ä¸ªåä¸ºserverçš„æœåŠ¡ï¼Œæ³¨æ„è¿™ä¸ªä¸æ˜¯å®¹å™¨åç§°</span></span><br><span class=\"line\">    <span class=\"comment\"># build: . # æ„å»ºé•œåƒï¼Œä½¿ç”¨å½“å‰ç›®å½•ä¸‹çš„Dockerfile</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">gitea/gitea:latest</span> <span class=\"comment\"># é•œåƒåç§°</span></span><br><span class=\"line\">    <span class=\"comment\"># container_name: gitea #  å®¹å™¨åç§°ï¼Œé»˜è®¤ä¸º â€œå®¹å™¨ç»„åç§°-æœåŠ¡åç§°-ç´¢å¼•â€ï¼Œä¸æ¨èé…ç½®ï¼Œå› ä¸º æ°´å¹³æ‰©å±•(--scale) æ—¶,å®¹å™¨åç§°ä¸èƒ½é‡å¤</span></span><br><span class=\"line\">    <span class=\"attr\">environment:</span> <span class=\"comment\"># å®šä¹‰ç¯å¢ƒå˜é‡</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">USER_UID=1000</span> <span class=\"comment\"># key=value</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">USER_GID=1000</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">DB_TYPE=mysql</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">DB_HOST=db:3306</span> <span class=\"comment\"># è¿™é‡Œé…ç½®çš„ db å°±æ˜¯ ä¸‹é¢çš„æœåŠ¡åç§°ï¼Œç›¸åŒ network ä¸‹çš„æœåŠ¡åç§°ï¼Œdocker composeä¼šè‡ªåŠ¨è§£æä¸ºå®¹å™¨çš„ipåœ°å€</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">DB_NAME=gitea</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">DB_USER=gitea</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">DB_PASSWD=gitea</span></span><br><span class=\"line\">    <span class=\"comment\"># env_file: .gitea.env # ä» .gitea.env æ–‡ä»¶è¯»å–ç¯å¢ƒå˜é‡ï¼Œç”Ÿäº§ç¯å¢ƒæ›´æ¨è</span></span><br><span class=\"line\">    <span class=\"attr\">restart:</span> <span class=\"string\">always</span> <span class=\"comment\"># å®¹å™¨å¯åŠ¨æ—¶ï¼Œè‡ªåŠ¨é‡å¯</span></span><br><span class=\"line\">    <span class=\"attr\">networks:</span> <span class=\"comment\"># ç½‘ç»œå…³è”</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">gitea</span> <span class=\"comment\"># ç½‘ç»œåç§°ï¼Œå°±æ˜¯ä¸Šé¢åˆ›å»ºçš„giteaç½‘ç»œ</span></span><br><span class=\"line\">    <span class=\"attr\">volumes:</span> <span class=\"comment\">#  æ•°æ®å·å…³è”</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">gitea:/data</span> <span class=\"comment\"># volumeæ˜ å°„ï¼Œæ•°æ®å·åç§°:/å®¹å™¨è·¯å¾„</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">/etc/timezone:/etc/timezone:ro</span> <span class=\"comment\"># è·¯å¾„æ˜ å°„ï¼Œå®¿ä¸»æœºè·¯å¾„:/å®¹å™¨è·¯å¾„:è¯»å†™æƒé™</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">/etc/localtime:/etc/localtime:ro</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span> <span class=\"comment\"># ç«¯å£æ˜ å°„</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&quot;3000:3000&quot;</span> <span class=\"comment\"># å®¿ä¸»æœºç«¯å£:å®¹å™¨ç«¯å£</span></span><br><span class=\"line\">    <span class=\"attr\">depends_on:</span> <span class=\"comment\"># å¯åŠ¨ä¾èµ–ï¼Œå°±æ˜¯ä¾èµ–çš„æœåŠ¡å¯åŠ¨åæ‰èƒ½å¯åŠ¨æœ¬æœåŠ¡</span></span><br><span class=\"line\">      <span class=\"attr\">db:</span> <span class=\"comment\"># å¯åŠ¨dbæœåŠ¡</span></span><br><span class=\"line\">        <span class=\"attr\">condition:</span> <span class=\"string\">service_healthy</span> <span class=\"comment\"># æœåŠ¡é€šè¿‡å¥åº·æ£€æŸ¥ï¼Œä¹Ÿå¯ä»¥é…ç½®ä¸º service_startedï¼šæœåŠ¡å¯åŠ¨ï¼Œè¿™ä¸ªæ˜¯é»˜è®¤å€¼</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"attr\">db:</span> <span class=\"comment\"># æ•°æ®åº“æœåŠ¡</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">mysql:8</span> <span class=\"comment\"># é•œåƒ</span></span><br><span class=\"line\">    <span class=\"attr\">environment:</span> <span class=\"comment\"># ç¯å¢ƒå˜é‡</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">MYSQL_ROOT_PASSWORD=gitea</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">MYSQL_USER=gitea</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">MYSQL_PASSWORD=gitea</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">MYSQL_DATABASE=gitea</span></span><br><span class=\"line\">    <span class=\"attr\">restart:</span> <span class=\"string\">always</span> <span class=\"comment\"># å¯åŠ¨ç­–ç•¥</span></span><br><span class=\"line\">    <span class=\"attr\">networks:</span> <span class=\"comment\"># ç½‘ç»œæ˜ å°„</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">gitea</span> <span class=\"comment\"># æ˜ å°„åˆ°giteaç½‘ç»œ</span></span><br><span class=\"line\">    <span class=\"attr\">volumes:</span> <span class=\"comment\"># å·æ˜ å°„</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">./mysql:/var/lib/mysql</span> <span class=\"comment\"># å®¿ä¸»æœºè·¯å¾„:/å®¹å™¨è·¯å¾„ï¼Œè¿™é‡Œå®¿ä¸»æœºæ”¯æŒç›¸å¯¹è·¯å¾„</span></span><br><span class=\"line\">    <span class=\"attr\">healthcheck:</span> <span class=\"comment\"># å¥åº·æ£€æŸ¥</span></span><br><span class=\"line\">      <span class=\"attr\">test:</span> [<span class=\"string\">&quot;CMD-SHELL&quot;</span>, <span class=\"string\">&quot;mysql -u root -pgitea&quot;</span>, <span class=\"string\">&quot;-e &#x27;SELECT 1;&#x27;&quot;</span>] <span class=\"comment\"># æ‰§è¡Œå‘½ä»¤ï¼Œå¦‚æœè¿”å›0ï¼Œåˆ™å¥åº·æ£€æŸ¥é€šè¿‡ï¼Œè¿™é‡Œä¸æ”¯æŒä¸Šé¢çš„ç¯å¢ƒå˜é‡ï¼Œteståªæ”¯æŒ  CMD-SHELL å’Œ CMD</span></span><br><span class=\"line\">      <span class=\"attr\">interval:</span> <span class=\"string\">10s</span> <span class=\"comment\"># å¥åº·æ£€æŸ¥é—´éš”</span></span><br><span class=\"line\">      <span class=\"attr\">timeout:</span> <span class=\"string\">5s</span> <span class=\"comment\"># å¥åº·æ£€æŸ¥è¶…æ—¶æ—¶é—´</span></span><br><span class=\"line\">      <span class=\"attr\">retries:</span> <span class=\"number\">3</span> <span class=\"comment\"># å¥åº·æ£€æŸ¥é‡è¯•æ¬¡æ•°</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>build</code>: æ„å»ºé•œåƒ</p>\n</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\">  <span class=\"attr\">server:</span></span><br><span class=\"line\">    <span class=\"attr\">build:</span> <span class=\"string\">.</span> <span class=\"comment\"># Dockerfileçš„ç›®å½•ï¼Œâ€œ.â€ è¡¨ç¤ºä½¿ç”¨å½“å‰ç›®å½•ä¸‹çš„Dockerfile</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">example/webapp</span> <span class=\"comment\"># é•œåƒåç§°ï¼Œå¦‚æœæœ‰buildï¼Œåˆ™è¯¥åç§°å°±æ˜¯buildåçš„é•œåƒåç§°ï¼Œå¦‚æœæ²¡æœ‰buildï¼Œåˆ™å°±ä¼šä»è¿œç¨‹ä»“åº“æ‹‰å–</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\">  <span class=\"attr\">server:</span></span><br><span class=\"line\">    <span class=\"attr\">build:</span></span><br><span class=\"line\">      <span class=\"attr\">context:</span> <span class=\"string\">./webapp</span> <span class=\"comment\"># Dockerfileçš„ç›®å½•ï¼Œé»˜è®¤æ˜¯å½“å‰ç›®å½•</span></span><br><span class=\"line\">      <span class=\"attr\">dockerfile:</span> <span class=\"string\">Dockerfile</span> <span class=\"comment\"># æ„å»ºé•œåƒçš„Dockerfileåç§°ï¼Œé»˜è®¤æ˜¯Dockerfile</span></span><br><span class=\"line\">      <span class=\"attr\">platforms:</span> <span class=\"comment\"># æ„å»ºé•œåƒçš„æ¶æ„</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">linux/amd64</span> <span class=\"comment\"># æ„å»ºé•œåƒçš„æ¶æ„ï¼Œé»˜è®¤æ˜¯å½“å‰æ¶æ„</span></span><br><span class=\"line\">      <span class=\"attr\">args:</span> <span class=\"comment\"># æ„å»ºé•œåƒçš„å‚æ•°</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">FOO=bar</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span> <span class=\"comment\"># æ„å»ºé•œåƒçš„æ ‡ç­¾</span></span><br><span class=\"line\">        <span class=\"attr\">com.example.description:</span> <span class=\"string\">&quot;Accounting webapp&quot;</span></span><br><span class=\"line\">        <span class=\"attr\">com.example.department:</span> <span class=\"string\">&quot;Finance&quot;</span></span><br><span class=\"line\">        <span class=\"attr\">com.example.label-with-empty-value:</span> <span class=\"string\">&quot;&quot;</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>command</code>: è¦†ç›–å®¹å™¨æ˜ åƒå£°æ˜çš„é»˜è®¤å‘½ä»¤</p>\n</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\">  <span class=\"attr\">server:</span></span><br><span class=\"line\">    <span class=\"attr\">command:</span> [<span class=\"string\">&quot;python&quot;</span>, <span class=\"string\">&quot;app.py&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">example/webapp</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>entrypoint</code>: å£°æ˜æœåŠ¡å®¹å™¨çš„é»˜è®¤å…¥å£ç‚¹ï¼Œè¿™è¦†ç›–äº†æœåŠ¡Dockerfileä¸­çš„ENTRYPOINTæŒ‡ä»¤ã€‚</p>\n</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\">  <span class=\"attr\">server:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">example/webapp</span></span><br><span class=\"line\">    <span class=\"attr\">entrypoint:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">php</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">-d</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">zend_extension=/usr/local/lib/php/extensions/no-debug-non-zts-20100525/xdebug.so</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">-d</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">memory_limit=-1</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">vendor/bin/phpunit</span></span><br><span class=\"line\">      <span class=\"comment\"># å¦‚æœå€¼ä¸ºnullï¼Œåˆ™ä½¿ç”¨å›¾åƒçš„é»˜è®¤å…¥å£ç‚¹ã€‚ entrypoint: null</span></span><br><span class=\"line\">      <span class=\"comment\"># å¦‚æœå€¼æ˜¯ []ï¼ˆç©ºåˆ—è¡¨ï¼‰æˆ– &#x27;&#x27;ï¼ˆç©ºå­—ç¬¦ä¸²ï¼‰ï¼Œå›¾åƒå£°æ˜çš„é»˜è®¤å…¥å£ç‚¹è¢«å¿½ç•¥ï¼Œæˆ–è€…æ¢å¥è¯è¯´ï¼Œè¢«è¦†ç›–ä¸ºç©ºã€‚ entrypoint: []</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>depends_on</code>: æœåŠ¡å¯åŠ¨ä¾èµ–ï¼Œå°±æ˜¯ä¾èµ–çš„æœåŠ¡å¯åŠ¨åæ‰èƒ½å¯åŠ¨æœ¬æœåŠ¡</p>\n</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\">  <span class=\"attr\">web:</span></span><br><span class=\"line\">    <span class=\"attr\">build:</span> <span class=\"string\">.</span></span><br><span class=\"line\">    <span class=\"attr\">depends_on:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">db</span> <span class=\"comment\"># çŸ­è¯­æ³•</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">redis</span></span><br><span class=\"line\">  <span class=\"attr\">redis:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">redis</span></span><br><span class=\"line\">  <span class=\"attr\">db:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">postgres</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\">  <span class=\"attr\">web:</span></span><br><span class=\"line\">    <span class=\"attr\">build:</span> <span class=\"string\">.</span></span><br><span class=\"line\">    <span class=\"attr\">depends_on:</span></span><br><span class=\"line\">      <span class=\"attr\">db:</span>  <span class=\"comment\"># é•¿è¯­æ³•</span></span><br><span class=\"line\">        <span class=\"attr\">condition:</span> <span class=\"string\">service_healthy</span> <span class=\"comment\"># æ»¡è¶³çš„æ¡ä»¶</span></span><br><span class=\"line\">        <span class=\"attr\">restart:</span> <span class=\"literal\">true</span>      <span class=\"comment\"># å½“è®¾ç½®ä¸ºtrueï¼ŒComposeåœ¨æ›´æ–°ä¾èµ–æœåŠ¡åé‡æ–°å¯åŠ¨æ­¤æœåŠ¡ã€‚</span></span><br><span class=\"line\">      <span class=\"attr\">redis:</span></span><br><span class=\"line\">        <span class=\"attr\">condition:</span> <span class=\"string\">service_started</span></span><br><span class=\"line\">  <span class=\"attr\">redis:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">redis</span></span><br><span class=\"line\">  <span class=\"attr\">db:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">postgres</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## conditionï¼šè®¾ç½®ä¾èµ–æ€§è¢«è§†ä¸ºæ»¡è¶³çš„æ¡ä»¶</span></span><br><span class=\"line\"><span class=\"comment\">#   service_startedï¼šç›¸å½“äºä¹‹å‰æè¿°çš„ç®€çŸ­è¯­æ³•</span></span><br><span class=\"line\"><span class=\"comment\">#   service_healthyï¼šæŒ‡å®šåœ¨å¯åŠ¨ä¾èµ–æœåŠ¡ä¹‹å‰ï¼Œä¾èµ–é¢„æœŸä¸ºâ€œå¥åº·â€ï¼ˆå¦‚healthcheckæ‰€ç¤ºï¼‰ã€‚</span></span><br><span class=\"line\"><span class=\"comment\">#   service_completed_successfullyï¼šæŒ‡å®šåœ¨å¯åŠ¨ä¾èµ–æœåŠ¡ä¹‹å‰ï¼Œä¾èµ–é¡¹é¢„è®¡å°†è¿è¡Œåˆ°æˆåŠŸå®Œæˆã€‚</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>environment</code>: å®šä¹‰ç¯å¢ƒå˜é‡</p>\n</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\">  <span class=\"attr\">server:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">example/webapp</span></span><br><span class=\"line\">    <span class=\"attr\">environment:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">FOO=bar</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">BAZ=qux</span></span><br><span class=\"line\"><span class=\"comment\"># æˆ–è€…</span></span><br><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\">  <span class=\"attr\">server:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">example/webapp</span></span><br><span class=\"line\">    <span class=\"attr\">environment:</span></span><br><span class=\"line\">      <span class=\"attr\">FOO:</span> <span class=\"string\">bar</span></span><br><span class=\"line\">      <span class=\"attr\">BAZ:</span> <span class=\"string\">qux</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>env_file</code>: ç”¨äºæŒ‡å®šä¸€ä¸ªæˆ–å¤šä¸ªåŒ…å«è¦ä¼ é€’åˆ°å®¹å™¨çš„ç¯å¢ƒå˜é‡çš„æ–‡ä»¶ã€‚</p>\n</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\">  <span class=\"attr\">server:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">example/webapp</span></span><br><span class=\"line\">    <span class=\"attr\">env_file:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">./a.env</span> <span class=\"comment\"># åˆ—è¡¨ä¸­çš„æ–‡ä»¶æ˜¯ä»ä¸Šåˆ°ä¸‹å¤„ç†çš„ã€‚å¯¹äºä¸¤ä¸ªç¯å¢ƒæ–‡ä»¶ä¸­æŒ‡å®šçš„ç›¸åŒå˜é‡ï¼Œåˆ—è¡¨ä¸­æœ€åä¸€ä¸ªæ–‡ä»¶çš„å€¼æ˜¯æœ‰æ•ˆçš„ã€‚</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">./b.env</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\">  <span class=\"attr\">server:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">example/webapp</span></span><br><span class=\"line\">    <span class=\"attr\">env_file:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">path:</span> <span class=\"string\">./default.env</span></span><br><span class=\"line\">        <span class=\"attr\">required:</span> <span class=\"literal\">true</span> <span class=\"comment\"># default</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">path:</span> <span class=\"string\">./override.env</span></span><br><span class=\"line\">        <span class=\"attr\">required:</span> <span class=\"literal\">false</span> <span class=\"comment\"># å½“requiredè®¾ç½®ä¸ºfalseä¸”.envæ–‡ä»¶ç¼ºå¤±æ—¶ï¼ŒComposeä¼šå¿½ç•¥</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>restart</code>: å®šä¹‰å¹³å°åœ¨å®¹å™¨ç»ˆæ­¢æ—¶é€‚ç”¨çš„ç­–ç•¥</p>\n</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\">  <span class=\"attr\">server:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">example/webapp</span></span><br><span class=\"line\">    <span class=\"attr\">restart:</span> <span class=\"string\">&quot;no&quot;</span>            <span class=\"comment\"># é»˜è®¤é‡å¯ç­–ç•¥ã€‚åœ¨ä»»ä½•æƒ…å†µä¸‹ï¼Œå®ƒéƒ½ä¸ä¼šé‡æ–°å¯åŠ¨å®¹å™¨ã€‚</span></span><br><span class=\"line\">    <span class=\"comment\"># restart: always        # ç­–ç•¥æ€»æ˜¯é‡æ–°å¯åŠ¨å®¹å™¨ï¼Œç›´åˆ°å®ƒè¢«ç§»é™¤ã€‚</span></span><br><span class=\"line\">    <span class=\"comment\"># restart: on-failure    # å¦‚æœé€€å‡ºä»£ç è¡¨æ˜é”™è¯¯ï¼Œç­–ç•¥å°†é‡æ–°å¯åŠ¨å®¹å™¨ã€‚</span></span><br><span class=\"line\">    <span class=\"comment\"># restart: on-failure:3  # å¦‚æœé€€å‡ºä»£ç è¡¨æ˜é”™è¯¯ï¼Œç­–ç•¥å°†é‡æ–°å¯åŠ¨å®¹å™¨ã€‚ä½†ä»…å°è¯•é‡å¯3æ¬¡ã€‚</span></span><br><span class=\"line\">    <span class=\"comment\"># restart: unless-stopped # æ— è®ºé€€å‡ºä»£ç å¦‚ä½•ï¼Œç­–ç•¥éƒ½ä¼šé‡æ–°å¯åŠ¨å®¹å™¨ï¼Œä½†å½“æœåŠ¡åœæ­¢æˆ–åˆ é™¤æ—¶ï¼Œç­–ç•¥ä¼šåœæ­¢é‡æ–°å¯åŠ¨ã€‚</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>healthcheck</code>: å¥åº·æ£€æŸ¥ã€‚</p>\n</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\">  <span class=\"attr\">server:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">example/webapp</span></span><br><span class=\"line\">    <span class=\"attr\">healthcheck:</span>  <span class=\"comment\"># å¥åº·æ£€æŸ¥</span></span><br><span class=\"line\">      <span class=\"attr\">test:</span> [<span class=\"string\">&quot;CMD&quot;</span>, <span class=\"string\">&quot;curl&quot;</span>, <span class=\"string\">&quot;-f&quot;</span>, <span class=\"string\">&quot;http://localhost&quot;</span>] <span class=\"comment\"># ç›‘æ§æ£€æŸ¥æ—¶æ‰§è¡Œçš„å‘½ä»¤</span></span><br><span class=\"line\">      <span class=\"attr\">interval:</span> <span class=\"string\">1m30s</span> <span class=\"comment\"># å¥åº·æ£€æŸ¥çš„é—´éš”ï¼Œé»˜è®¤å€¼ä¸º 30s</span></span><br><span class=\"line\">      <span class=\"attr\">timeout:</span> <span class=\"string\">10s</span>    <span class=\"comment\">#  å¥åº·æ£€æŸ¥çš„è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤å€¼ä¸º 30s</span></span><br><span class=\"line\">      <span class=\"attr\">retries:</span> <span class=\"number\">3</span>      <span class=\"comment\"># å¥åº·æ£€æŸ¥çš„å°è¯•æ¬¡æ•°ï¼Œé»˜è®¤å€¼ä¸º 3</span></span><br><span class=\"line\">      <span class=\"attr\">start_period:</span> <span class=\"string\">40s</span> <span class=\"comment\"># å¯åŠ¨å®½é™æœŸï¼šåœ¨æ­¤æœŸé—´ï¼Œå¤±è´¥ä¸ä¼šè®¡å…¥é‡è¯•æ¬¡æ•°ï¼ˆä»…ç”¨äºåˆ¤æ–­æœåŠ¡æ˜¯å¦å¯åŠ¨å®Œæ¯•ï¼‰</span></span><br><span class=\"line\">      <span class=\"attr\">start_interval:</span> <span class=\"string\">5s</span> <span class=\"comment\"># å¯åŠ¨å®½é™æœŸå†…æ£€æŸ¥çš„é¢‘ç‡ï¼Œæœ¬ç¤ºä¾‹ä¸ºåœ¨å‰ 40 ç§’å†…æ¯ 5 ç§’æ£€æŸ¥ä¸€æ¬¡</span></span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>testå®šä¹‰Composeè¿è¡Œçš„å‘½ä»¤æ¥æ£€æŸ¥å®¹å™¨è¿è¡ŒçŠ¶å†µã€‚å®ƒå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯åˆ—è¡¨ã€‚å¦‚æœæ˜¯åˆ—è¡¨ï¼Œç¬¬ä¸€ä¸ªé¡¹ç›®å¿…é¡»æ˜¯NONEã€CMDæˆ–CMD-SHELLã€‚å¦‚æœå®ƒæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå®ƒç­‰åŒäºæŒ‡å®šCMD-SHELLåè·Ÿè¯¥å­—ç¬¦ä¸²ã€‚</p>\n</blockquote>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">test:</span> [<span class=\"string\">&quot;CMD&quot;</span>, <span class=\"string\">&quot;curl&quot;</span>, <span class=\"string\">&quot;-f&quot;</span>, <span class=\"string\">&quot;http://localhost&quot;</span>]</span><br><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨CMD-SHELLè¿è¡Œé…ç½®ä¸ºå­—ç¬¦ä¸²çš„å‘½ä»¤ï¼Œä½¿ç”¨å®¹å™¨çš„é»˜è®¤å¤–å£³ï¼ˆLinuxçš„/bin/shï¼‰ã€‚ä»¥ä¸‹ä¸¤ç§å½¢å¼æ˜¯ç­‰ä»·çš„</span></span><br><span class=\"line\"><span class=\"attr\">test:</span> [<span class=\"string\">&quot;CMD-SHELL&quot;</span>, <span class=\"string\">&quot;curl -f http://localhost || exit 1&quot;</span>]</span><br><span class=\"line\"><span class=\"attr\">test:</span> <span class=\"string\">curl</span> <span class=\"string\">-f</span> <span class=\"string\">https://localhost</span> <span class=\"string\">||</span> <span class=\"string\">exit</span> <span class=\"number\">1</span></span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>test ä¸­çš„ CMD å’Œ CMD-SHELL æ˜¯ä¸¤ç§ä¸åŒçš„æ‰§è¡Œæ–¹å¼ï¼Œå®ƒä»¬çš„ä¸»è¦åŒºåˆ«åœ¨äºï¼š</p>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th>é¡¹ç›®</th>\n<th><code>CMD</code></th>\n<th><code>CMD-SHELL</code></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>âœ… <strong>ç”¨é€”</strong></td>\n<td>ç›´æ¥æ‰§è¡Œå‘½ä»¤ï¼ˆä¸é€šè¿‡ shellï¼‰</td>\n<td>é€šè¿‡ shellï¼ˆå¦‚ <code>/bin/sh -c</code>ï¼‰æ‰§è¡Œå‘½ä»¤</td>\n</tr>\n<tr>\n<td>ğŸ§¾ <strong>å†™æ³•æ ¼å¼</strong></td>\n<td><code>[&quot;CMD&quot;, &quot;executable&quot;, &quot;arg1&quot;, &quot;arg2&quot;]</code></td>\n<td><code>[&quot;CMD-SHELL&quot;, &quot;command string&quot;]</code></td>\n</tr>\n<tr>\n<td>ğŸ”§ <strong>æ˜¯å¦ä½¿ç”¨ shell</strong></td>\n<td>å¦</td>\n<td>æ˜¯</td>\n</tr>\n<tr>\n<td>ğŸ§  <strong>æ˜¯å¦æ”¯æŒ shell è¯­æ³•</strong></td>\n<td>âŒ å¦<br>ï¼ˆä¸èƒ½ä½¿ç”¨ <code>&amp;&amp;</code>ã€ <code>||</code>ã€<code>\\$VAR</code> ç­‰ï¼‰</td>\n<td>âœ… æ˜¯<br>ï¼ˆæ”¯æŒç®¡é“ã€é‡å®šå‘ã€å˜é‡ã€å‘½ä»¤ç»„åˆï¼‰</td>\n</tr>\n<tr>\n<td>ğŸ›¡ï¸ <strong>å®‰å…¨æ€§/å¯ç§»æ¤æ€§</strong></td>\n<td>âœ… æ›´å®‰å…¨ï¼Œæ‰§è¡Œæ›´æ˜ç¡®</td>\n<td>âš  ä¾èµ–å®¹å™¨ä¸­å­˜åœ¨ shellï¼ˆå¦‚ <code>/bin/sh</code>ï¼‰</td>\n</tr>\n<tr>\n<td>âš™ï¸ <strong>æ‰§è¡Œæ•ˆç‡</strong></td>\n<td>âœ… ç¨å¿«ï¼Œå› æ— éœ€ shell è§£æ</td>\n<td>âš  ç¨æ…¢ï¼Œéœ€é€šè¿‡ shell å¯åŠ¨</td>\n</tr>\n<tr>\n<td>ğŸ“¦ <strong>æ¨èä½¿ç”¨åœºæ™¯</strong></td>\n<td>- ç®€å•å¥åº·æ£€æŸ¥å‘½ä»¤<br>- å®‰å…¨ç¯å¢ƒ<br>- ç²¾ç®€é•œåƒ</td>\n<td>- éœ€è¦ä½¿ç”¨é€»è¾‘æ§åˆ¶ï¼ˆ<code>||</code>, <code>&amp;&amp;</code>ï¼‰<br>- å¤æ‚æ£€æŸ¥é€»è¾‘</td>\n</tr>\n<tr>\n<td>ğŸ“Œ <strong>ç¤ºä¾‹</strong></td>\n<td><code>[&quot;CMD&quot;, &quot;curl&quot;, &quot;-f&quot;, &quot;http://localhost&quot;]</code></td>\n<td><code>[&quot;CMD-SHELL&quot;, &quot;curl -f http\\://localhost || exit 1&quot;]</code></td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>volumes</code>: æŒ‚è½½æ•°æ®å·ã€‚</p>\n</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># é•¿è¯­æ³•æ ¼å¼</span></span><br><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\">  <span class=\"attr\">backend:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">example/backend</span></span><br><span class=\"line\">    <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">type:</span> <span class=\"string\">volume</span>   <span class=\"comment\"># å®‰è£…ç±»å‹ã€‚å¯ä»¥æ˜¯æ˜¯volumeã€bindã€tmpfsã€imageã€npipeã€cluster</span></span><br><span class=\"line\">        <span class=\"attr\">source:</span> <span class=\"string\">db-data</span> <span class=\"comment\"># æŒ‚è½½çš„æºã€ç»‘å®šæŒ‚è½½çš„ä¸»æœºä¸Šçš„è·¯å¾„ã€æ˜ åƒæŒ‚è½½çš„Dockeræ˜ åƒå¼•ç”¨æˆ–é¡¶å±‚volumesé”®ä¸­å®šä¹‰çš„å·åç§°ã€‚ä¸é€‚ç”¨äºtmpfsæ”¯æ¶ã€‚</span></span><br><span class=\"line\">        <span class=\"attr\">target:</span> <span class=\"string\">/data</span> <span class=\"comment\"># å®¹å™¨ä¸­è£…è½½å·çš„è·¯å¾„ã€‚</span></span><br><span class=\"line\">        <span class=\"attr\">volume:</span>  <span class=\"comment\"># é…ç½®å…¶ä»–å·é€‰é¡¹</span></span><br><span class=\"line\">          <span class=\"attr\">nocopy:</span> <span class=\"literal\">true</span> <span class=\"comment\"># åœ¨åˆ›å»ºå·æ—¶ç¦ç”¨ä»å®¹å™¨å¤åˆ¶æ•°æ®çš„æ ‡å¿—ï¼Œé»˜è®¤å€¼ä¸ºfalseã€‚</span></span><br><span class=\"line\">          <span class=\"attr\">subpath:</span> <span class=\"string\">sub</span> <span class=\"comment\"># æŒ‚è½½å·çš„å­ç›®å½•ã€‚å³ db-data/sub</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">type:</span> <span class=\"string\">bind</span> <span class=\"comment\"># bind è¡¨ç¤ºæŒ‚è½½ä¸»æœºä¸Šçš„è·¯å¾„</span></span><br><span class=\"line\">        <span class=\"attr\">source:</span> <span class=\"string\">/var/run/postgres/postgres.sock</span></span><br><span class=\"line\">        <span class=\"attr\">target:</span> <span class=\"string\">/var/run/postgres/postgres.sock</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">volumes:</span> <span class=\"comment\"># å£°æ˜æ•°æ®å·</span></span><br><span class=\"line\">  <span class=\"attr\">db-data:</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">######################################################################################</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># çŸ­è¯­æ³•æ ¼å¼</span></span><br><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\">  <span class=\"attr\">backend:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">example/backend</span></span><br><span class=\"line\">    <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">db-data:/data</span> <span class=\"comment\"># è¿™ç§è¯­æ³•ä¸æ”¯æŒ subpath å’Œ nocopy</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">/var/run/postgres/postgres.sock:/var/run/postgres/postgres.sock</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">volumes:</span></span><br><span class=\"line\">  <span class=\"attr\">db-data:</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>networks</code>: é…ç½®ç½‘ç»œã€‚</p>\n</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\">  <span class=\"attr\">some-service:</span></span><br><span class=\"line\">    <span class=\"attr\">networks:</span>  <span class=\"comment\"># é…ç½®ç½‘ç»œ</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">some-network</span> <span class=\"comment\"># å…³è”ç½‘ç»œ</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">other-network</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">networks:</span> <span class=\"comment\"># å£°æ˜ç½‘ç»œ</span></span><br><span class=\"line\">  <span class=\"attr\">some-network:</span></span><br><span class=\"line\">  <span class=\"attr\">other-network:</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>cpu å’Œ å†…å­˜é™åˆ¶</p>\n</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\">  <span class=\"attr\">backend:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">myapp:latest</span></span><br><span class=\"line\">    <span class=\"attr\">mem_limit:</span> <span class=\"string\">1g</span>           <span class=\"comment\"># é™åˆ¶æœ€å¤šä½¿ç”¨1GBå†…å­˜</span></span><br><span class=\"line\">    <span class=\"attr\">mem_reservation:</span> <span class=\"string\">512m</span>   <span class=\"comment\"># å»ºè®®é¢„ç•™512MBå†…å­˜</span></span><br><span class=\"line\">    <span class=\"attr\">cpus:</span> <span class=\"number\">2.0</span>               <span class=\"comment\"># é™åˆ¶æœ€å¤šä½¿ç”¨2ä¸ªCPUæ ¸</span></span><br><span class=\"line\">    <span class=\"attr\">cpu_shares:</span> <span class=\"number\">1024</span>        <span class=\"comment\"># é»˜è®¤å€¼ï¼Œè¡¨ç¤ºæ ‡å‡†ä¼˜å…ˆçº§</span></span><br><span class=\"line\">    <span class=\"attr\">cpu_quota:</span> <span class=\"number\">100000</span>       <span class=\"comment\"># æ¯ 100ms å®¹å™¨æœ€å¤šå¯è¿è¡Œ 100msï¼ˆ=1æ ¸ï¼‰, ä¸ cpus ä¸èƒ½åŒæ—¶è®¾ç½®</span></span><br><span class=\"line\">    <span class=\"attr\">cpu_period:</span> <span class=\"number\">100000</span>      <span class=\"comment\"># è°ƒåº¦å‘¨æœŸä¸º100ms, ä¸ cpus ä¸èƒ½åŒæ—¶è®¾ç½®</span></span><br></pre></td></tr></table></figure>\n<table>\n<thead>\n<tr>\n<th>å­—æ®µå</th>\n<th>ç±»å‹</th>\n<th>è¯´æ˜</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>cpus</code></td>\n<td>float</td>\n<td>é™åˆ¶å®¹å™¨æœ€å¤šä½¿ç”¨å¤šå°‘ CPUï¼ˆé€»è¾‘æ ¸æ•°ï¼‰ï¼›ä¾‹å¦‚ <code>0.5</code> = ä¸€åŠ CPU</td>\n</tr>\n<tr>\n<td><code>mem_limit</code></td>\n<td>string</td>\n<td>å®¹å™¨æœ€å¤§å†…å­˜é™åˆ¶ï¼Œæ”¯æŒå•ä½ï¼š<code>b</code>ã€<code>k</code>ã€<code>m</code>ã€<code>g</code>ï¼ˆå¦‚ <code>256m</code>, <code>1g</code>ï¼‰</td>\n</tr>\n<tr>\n<td><code>mem_reservation</code></td>\n<td>string</td>\n<td>å®¹å™¨å¯åŠ¨æ—¶é¢„ç•™çš„å†…å­˜ï¼Œè¶…è¿‡è¿™ä¸ªå€¼ä¸è¢«é™åˆ¶ï¼ˆä»…æç¤ºè°ƒåº¦å™¨ï¼‰</td>\n</tr>\n<tr>\n<td><code>cpu_shares</code></td>\n<td>int</td>\n<td>CPU æƒé‡ï¼ˆé»˜è®¤ 1024ï¼‰ï¼Œç”¨äºå¤šä¸ªå®¹å™¨æŠ¢å  CPU çš„ä¼˜å…ˆçº§ï¼ˆä»…åœ¨ç«äº‰æ—¶ç”Ÿæ•ˆï¼‰</td>\n</tr>\n<tr>\n<td><code>cpu_quota</code></td>\n<td>int</td>\n<td>æ¯ä¸ªå‘¨æœŸå†…å…è®¸ä½¿ç”¨çš„ CPU æ—¶é—´ï¼ˆå•ä½ï¼šå¾®ç§’ï¼‰, ä¸ cpus ä¸èƒ½åŒæ—¶è®¾ç½®</td>\n</tr>\n<tr>\n<td><code>cpu_period</code></td>\n<td>int</td>\n<td>CPU è°ƒåº¦å‘¨æœŸï¼ˆå•ä½ï¼šå¾®ç§’ï¼Œé»˜è®¤ <code>100000</code>ï¼‰, ä¸ cpus ä¸èƒ½åŒæ—¶è®¾ç½®</td>\n</tr>\n</tbody>\n</table>\n<blockquote>\n<p>æŸ¥çœ‹å®¹å™¨çš„ cpu å’Œ å†…å­˜é…ç½®æƒ…å†µ</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># è·å–å®¹å™¨çš„ cpu_quota å’Œ cpu_period</span></span><br><span class=\"line\">docker inspect --format=<span class=\"string\">&#x27;&#123;&#123;json .HostConfig.CpuQuota&#125;&#125; &#123;&#123;json .HostConfig.CpuPeriod&#125;&#125;&#x27;</span> &lt;container_id&gt;</span><br><span class=\"line\"><span class=\"comment\"># è·å–å®¹å™¨çš„ memory_limit</span></span><br><span class=\"line\">docker inspect --format=<span class=\"string\">&#x27;&#123;&#123;json .HostConfig.Memory&#125;&#125;&#x27;</span> &lt;container_id&gt;</span><br><span class=\"line\"><span class=\"comment\"># è·å–å®¹å™¨çš„ cpu_shares</span></span><br><span class=\"line\">docker inspect --format=<span class=\"string\">&#x27;&#123;&#123;json .HostConfig.CpuShares&#125;&#125;&#x27;</span> &lt;container_id&gt;</span><br><span class=\"line\"><span class=\"comment\"># è·å–å®¹å™¨çš„ cpus</span></span><br><span class=\"line\">docker inspect --format=<span class=\"string\">&#x27;&#123;&#123;json .HostConfig.NanoCpus&#125;&#125;&#x27;</span> &lt;container_id&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ç»„åˆä¸ºä¸€ä¸ªjsonè¾“å‡º</span></span><br><span class=\"line\">docker inspect &lt;container_id&gt; | jq <span class=\"string\">&#x27;.[0].HostConfig | &#123;</span></span><br><span class=\"line\"><span class=\"string\">  cpus: (.NanoCpus / 1000000000),</span></span><br><span class=\"line\"><span class=\"string\">  cpu_shares: .CpuShares,</span></span><br><span class=\"line\"><span class=\"string\">  mem_limit: (.Memory / 1024 / 1024 | tostring + &quot; MB&quot;),</span></span><br><span class=\"line\"><span class=\"string\">  mem_reservation: (.MemoryReservation / 1024 / 1024 | tostring + &quot; MB&quot;),</span></span><br><span class=\"line\"><span class=\"string\">  cpu_quota: .CpuQuota,</span></span><br><span class=\"line\"><span class=\"string\">  cpu_period: .CpuPeriod</span></span><br><span class=\"line\"><span class=\"string\">&#125;&#x27;</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"docker-run-è½¬-docker-compose\"><code>docker run</code> è½¬ <code>docker compose</code></h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åœ¨çº¿å·¥å…·ï¼š<a href=\"https://www.composerize.com/\">composerize</a></p>\n</li>\n<li class=\"lvl-2\">\n<p>æœ¬åœ°å®‰è£…ï¼š<a href=\"https://github.com/composerize/composerize\">composerize</a></p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># å®‰è£…å‘½ä»¤ï¼Œnpmå®‰è£…ï¼šhttps://nodejs.org/zh-cn/download</span></span><br><span class=\"line\">npm install composerize -g</span><br><span class=\"line\"><span class=\"comment\"># è¿è¡Œå‘½ä»¤</span></span><br><span class=\"line\">composerize docker run -p 80:80 -v /var/run/docker.sock:/tmp/docker.sock:ro --restart always --log-opt max-size=1g nginx</span><br><span class=\"line\"><span class=\"comment\">##  è½¬æ¢ç»“æœ</span></span><br><span class=\"line\">name: &lt;your project name&gt;</span><br><span class=\"line\">services:</span><br><span class=\"line\">  nginx:</span><br><span class=\"line\">    ports:</span><br><span class=\"line\">      - 80:80</span><br><span class=\"line\">    volumes:</span><br><span class=\"line\">      - /var/run/docker.sock:/tmp/docker.sock:ro</span><br><span class=\"line\">    restart: always</span><br><span class=\"line\">    logging:</span><br><span class=\"line\">      options:</span><br><span class=\"line\">        max-size: 1g</span><br><span class=\"line\">    image: nginx</span><br></pre></td></tr></table></figure>\n<h2 id=\"docker-compose-ç¼–æ’ç®¡ç†å·¥å…·-Dockge\"><code>docker compose</code> ç¼–æ’ç®¡ç†å·¥å…· <code>Dockge</code></h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><a href=\"https://dockge.kuma.pet\">Dockge</a> æ˜¯ä¸€ä¸ªå¼€æºè½»é‡çº§ã€ŒDocker Compose ç®¡ç†å™¨ã€ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªæ¼‚äº®ã€å“åº”è¿…é€Ÿçš„ Web ç•Œé¢ï¼Œä¸“é—¨é¢å‘ä½¿ç”¨ <code>docker compose</code> çš„ç”¨æˆ·ã€‚</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>åŠŸèƒ½æ¨¡å—</th>\n<th>ä¸»è¦æè¿°</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>Compose å †æ ˆå…¨ç”Ÿå‘½å‘¨æœŸç®¡ç†</strong></td>\n<td>å¯ä»¥åˆ›å»ºã€ç¼–è¾‘ã€å¯åŠ¨ã€åœæ­¢ã€é‡å¯ã€åˆ é™¤åŸºäº <code>compose.yaml</code> æ–‡ä»¶çš„ Docker å †æ ˆ</td>\n</tr>\n<tr>\n<td><strong>äº¤äº’å¼ Compose ç¼–è¾‘å™¨ + Web ç»ˆç«¯</strong></td>\n<td>å®æ—¶ç¼–è¾‘ YAML å¹¶æŸ¥çœ‹è¾“å‡ºï¼Œè¿˜å¯ä»¥ç›´æ¥åœ¨æµè§ˆå™¨ä¸­æ“ä½œç»ˆç«¯</td>\n</tr>\n<tr>\n<td><strong>å°† <code>docker run â€¦</code> å‘½ä»¤è½¬æ¢ä¸º Compose æ–‡ä»¶</strong></td>\n<td>å¿«é€Ÿç”Ÿæˆ <code>compose.yaml</code>ï¼Œä¾¿äºç‰ˆæœ¬æ§åˆ¶å’Œç»“æ„ç®¡ç†</td>\n</tr>\n<tr>\n<td><strong>å®æ—¶æ“ä½œåé¦ˆ</strong></td>\n<td>é•œåƒæ‹‰å–ã€å †æ ˆå¯åŠ¨/åœæ­¢ç­‰æ“ä½œå‡å¯å®æ—¶æŸ¥çœ‹è¿›åº¦</td>\n</tr>\n<tr>\n<td><strong>å¤šä¸»æœºä»£ç†æ”¯æŒï¼ˆâ‰¥1.4.0ï¼‰</strong></td>\n<td>èƒ½åœ¨å•ä¸€ UI ä¸­ç®¡ç†å¤šä¸ª Docker ä¸»æœº</td>\n</tr>\n<tr>\n<td><strong>é«˜å…¼å®¹æ€§ &amp; å®‰å…¨è®¾è®¡</strong></td>\n<td>Compose æ–‡ä»¶ä¿å­˜åœ¨æœ¬åœ°ï¼Œä¸ä¼šè¢«ç³»ç»Ÿæ‰˜ç®¡ï¼Œä¾¿äºä½¿ç”¨ CLI æˆ–å…¶ä»–å·¥å…·ç®¡ç†</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å®‰è£…</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Create directories that store your stacks and store Dockge&#x27;s stack</span></span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> -p /opt/stacks /opt/dockge</span><br><span class=\"line\"><span class=\"built_in\">cd</span> /opt/dockge</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Download your compose.yaml</span></span><br><span class=\"line\">curl <span class=\"string\">&quot;https://dockge.kuma.pet/compose.yaml?port=5001&amp;stacksPath=%2Fopt%2Fstacks&quot;</span> --output compose.yaml</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Start the Server</span></span><br><span class=\"line\">docker compose up -d</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æµè§ˆå™¨è®¿é—® http://localhost:5001</span></span><br></pre></td></tr></table></figure>","content_text":"æ‘˜è¦ æœ¬æ–‡ä»‹ç» Docker å‘½ä»¤ ä¸­ docker compose çš„ä½¿ç”¨æ–¹æ³• Dockerå®˜æ–¹æ–‡æ¡£ docker compose Compose file reference docker compose æ˜¯ä»€ä¹ˆï¼Ÿ Docker Composeæ˜¯ä¸€ä¸ªç”¨äºå®šä¹‰å’Œè¿è¡Œå¤šå®¹å™¨åº”ç”¨ç¨‹åºçš„å·¥å…·ã€‚ Composeç®€åŒ–äº†å¯¹æ•´ä¸ªåº”ç”¨ç¨‹åºå †æ ˆçš„æ§åˆ¶ï¼Œä¾¿äºåœ¨å•ä¸ªYAMLé…ç½®æ–‡ä»¶ä¸­ç®¡ç†æœåŠ¡ã€ç½‘ç»œå’Œå·ã€‚ç„¶åï¼Œé€šè¿‡ä¸€ä¸ªå‘½ä»¤ï¼Œæ‚¨ä»é…ç½®æ–‡ä»¶ä¸­åˆ›å»ºå¹¶å¯åŠ¨æ‰€æœ‰æœåŠ¡ã€‚ Docker Compose çš„ä¼˜åŠ¿ï¼š ä¼˜ç‚¹ æè¿° ç®€åŒ–æ§åˆ¶ Docker Compose å…è®¸åœ¨å•ä¸ª YAML æ–‡ä»¶ä¸­å®šä¹‰å’Œç®¡ç†å¤šå®¹å™¨åº”ç”¨ç¨‹åºï¼Œç®€åŒ–äº†æœåŠ¡ç¼–æ’ä¸åè°ƒï¼Œä½¿ç¯å¢ƒç®¡ç†å’Œå¤åˆ¶æ›´å®¹æ˜“ã€‚ é«˜æ•ˆçš„åä½œ é…ç½®æ–‡ä»¶æ˜“äºå…±äº«ï¼Œä¿ƒè¿›å¼€å‘äººå‘˜ã€è¿è¥å›¢é˜Ÿå’Œå…¶ä»–åˆ©ç›Šç›¸å…³è€…ä¹‹é—´çš„åä½œï¼Œä»è€Œæå‡å·¥ä½œæµç¨‹æ•ˆç‡å’Œé—®é¢˜è§£å†³é€Ÿåº¦ã€‚ å¿«é€Ÿåº”ç”¨ç¨‹åºå¼€å‘ Compose åˆ©ç”¨ç¼“å­˜é‡å¤ä½¿ç”¨æœªæ›´æ”¹æœåŠ¡çš„å®¹å™¨ï¼ŒåŠ å¿«ç¯å¢ƒå˜æ›´é€Ÿåº¦ï¼Œæé«˜å¼€å‘æ•ˆç‡ã€‚ è·¨ç¯å¢ƒçš„å¯ç§»æ¤æ€§ æ”¯æŒåœ¨ Compose æ–‡ä»¶ä¸­ä½¿ç”¨å˜é‡ï¼Œä½¿é…ç½®èƒ½æ ¹æ®ä¸åŒç¯å¢ƒæˆ–ç”¨æˆ·è¿›è¡Œè‡ªå®šä¹‰ï¼Œå¢å¼ºäº†å¯ç§»æ¤æ€§ã€‚ å¹¿æ³›çš„ç¤¾åŒºå’Œæ”¯æŒ æ‹¥æœ‰æ´»è·ƒçš„ç¤¾åŒºï¼Œæä¾›ä¸°å¯Œçš„èµ„æºã€æ•™ç¨‹å’ŒæŠ€æœ¯æ”¯æŒï¼Œæœ‰åŠ©äºæŒç»­æ”¹è¿›ä¸é«˜æ•ˆæ’éšœã€‚ docker compose å®‰è£… åŒdockerä¸€èµ·å®‰è£… 12# å®‰è£…dockeråŒæ—¶å®‰è£…docker composeï¼Œè¿™é‡Œ docker-compose-plugin å°±æ˜¯docker composesudo dnf install docker-ce-3:26.1.3-1.el8 docker-ce-cli-3:26.1.3-1.el8 containerd.io docker-buildx-plugin docker-compose-plugin -y å•ç‹¬å®‰è£… 12# è‹¥å®‰è£…dockeræ—¶æ²¡æœ‰å®‰è£… docker-compose-plugin ï¼Œåˆ™éœ€è¦å•ç‹¬å®‰è£…sudo dnf install docker-compose-plugin -y æŸ¥çœ‹ç‰ˆæœ¬ 1docker compose version ç›´æ¥ä¸‹è½½docker-composeçš„å‘½ä»¤æ–‡ä»¶ 123456# Install Docker Composeï¼Œæ³¨æ„é€šè¿‡è¿™ç§æ–¹å¼å®‰è£…çš„composeçš„ä½¿ç”¨æ–¹å¼ä¸º `docker-compose`ï¼Œè€Œéæ ‡å‡†çš„ `docker compose`sudo curl -L &quot;https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)&quot; -o /usr/local/bin/docker-compose# Make the docker-compose command availablesudo chmod +x /usr/local/bin/docker-compose# Check Docker Compose versiondocker-compose version docker compose å‘½ä»¤ å‘½ä»¤ ä¸­æ–‡è¯´æ˜ ç¤ºä¾‹ attach è¿æ¥åˆ°æœåŠ¡çš„è¿è¡Œä¸­å®¹å™¨çš„æ ‡å‡†è¾“å…¥ã€è¾“å‡ºå’Œé”™è¯¯æµ docker compose attach web build æ„å»ºæˆ–é‡æ–°æ„å»ºæœåŠ¡ docker compose build config è§£æå¹¶æ ‡å‡†åŒ– Compose æ–‡ä»¶ docker compose config cp åœ¨æœåŠ¡å®¹å™¨ä¸æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¹‹é—´å¤åˆ¶æ–‡ä»¶/æ–‡ä»¶å¤¹ docker compose cp web:/app/file.txt ./file.txt create ä¸ºæœåŠ¡åˆ›å»ºå®¹å™¨ï¼Œä½†ä¸å¯åŠ¨ docker compose create down åœæ­¢å¹¶ç§»é™¤å®¹å™¨ã€ç½‘ç»œç­‰èµ„æº docker compose down events å®æ—¶æ¥æ”¶å®¹å™¨äº‹ä»¶ docker compose events exec åœ¨è¿è¡Œä¸­çš„å®¹å™¨ä¸­æ‰§è¡Œå‘½ä»¤ docker compose exec web ls /app images åˆ—å‡ºå·²åˆ›å»ºå®¹å™¨æ‰€ä½¿ç”¨çš„é•œåƒ docker compose images kill å¼ºåˆ¶åœæ­¢æœåŠ¡å®¹å™¨ docker compose kill logs æŸ¥çœ‹æœåŠ¡å®¹å™¨çš„æ—¥å¿—è¾“å‡º docker compose logs ls åˆ—å‡ºå½“å‰è¿è¡Œçš„ Compose é¡¹ç›® docker compose ls pause æš‚åœæœåŠ¡å®¹å™¨ docker compose pause port æ˜¾ç¤ºæŸç«¯å£æ˜ å°„çš„å…¬ç½‘åœ°å€ docker compose port web 80 ps åˆ—å‡ºæœåŠ¡çš„å®¹å™¨ docker compose ps pull æ‹‰å–æœåŠ¡ä½¿ç”¨çš„é•œåƒ docker compose pull push æ¨é€æœåŠ¡é•œåƒåˆ°ä»“åº“ docker compose push restart é‡å¯æœåŠ¡å®¹å™¨ docker compose restart rm ç§»é™¤å·²åœæ­¢çš„æœåŠ¡å®¹å™¨ docker compose rm run åœ¨æœåŠ¡ä¸Šè¿è¡Œä¸€æ¬¡æ€§å‘½ä»¤ docker compose run web echo Hello scale æ‰©å±•æœåŠ¡å®ä¾‹æ•°é‡ docker compose up --scale web=3 start å¯åŠ¨å·²å­˜åœ¨ä½†å·²åœæ­¢çš„æœåŠ¡å®¹å™¨ docker compose start stats å®æ—¶æ˜¾ç¤ºå®¹å™¨èµ„æºä½¿ç”¨æƒ…å†µ docker compose stats stop åœæ­¢è¿è¡Œä¸­çš„æœåŠ¡å®¹å™¨ docker compose stop top æ˜¾ç¤ºå®¹å™¨å†…çš„è¿è¡Œè¿›ç¨‹ docker compose top unpause å–æ¶ˆæš‚åœæœåŠ¡å®¹å™¨ docker compose unpause up åˆ›å»ºå¹¶å¯åŠ¨æœåŠ¡å®¹å™¨ docker compose up version æ˜¾ç¤º Docker Compose ç‰ˆæœ¬ä¿¡æ¯ docker compose version wait é˜»å¡ç›´åˆ°ç¬¬ä¸€ä¸ªæœåŠ¡å®¹å™¨åœæ­¢ docker compose wait watch ç›‘å¬æœåŠ¡æ„å»ºä¸Šä¸‹æ–‡å˜æ›´å¹¶é‡æ–°æ„å»º/åˆ·æ–°å®¹å™¨ docker compose watch docker compose å¸¸ç”¨å‘½ä»¤ å¯åŠ¨ä¸å…³é—­ 123456789101112131415161718# å¯åŠ¨å¹¶è¿è¡Œï¼Œé»˜è®¤ä½¿ç”¨å½“å‰ç›®å½•çš„ docker-compose.yml æ–‡ä»¶docker compose up# åå°è¿è¡Œdocker compose up -d# æŒ‡å®šcomposeæ–‡ä»¶docker compose -f docker-compose.yml up -d# å¯åŠ¨æ—¶é‡å»ºæœåŠ¡ï¼Œå½“ä¿®æ”¹äº† compose æ–‡ä»¶æ—¶docker compose up --build# åœæ­¢servicedocker compose stop# å¼ºåˆ¶åœæ­¢serviceï¼Œå½“ stop å‘½ä»¤æ— æ³•åœæ­¢æ—¶docker compose kill# é‡å¯servicedocker compose restart# åˆ é™¤serviceï¼Œ-s å‚æ•°è¡¨ç¤ºåˆ é™¤å‰å…ˆåœæ­¢å®¹å™¨docker compose rm -s# åœæ­¢å¹¶åˆ é™¤serviceï¼ŒåŒæ—¶åˆ é™¤ç½‘ç»œï¼Œä½†ä¸ä¼šåˆ é™¤å·docker compose down ç›‘æ§ 123456789101112131415161718# åˆ—å‡ºå½“å‰è¿è¡Œçš„ Compose é¡¹ç›®docker compose ls# æŸ¥çœ‹serviceçŠ¶æ€ï¼Œ-a æ˜¾ç¤ºæ‰€æœ‰servicedocker compose ps -a# è§£æå¹¶æ ‡å‡†åŒ– compose æ–‡ä»¶ï¼Œè¿™ä¸ªå‘½ä»¤å¯ä»¥æ£€æŸ¥ docker-compose.yml æ–‡ä»¶è¯­æ³•æ˜¯å¦æ­£ç¡®ï¼Œä½†ä¸ä¿è¯é€»è¾‘æ­£ç¡®docker compose config# æŸ¥çœ‹ä½¿ç”¨çš„é•œåƒdocker compose images# æŸ¥çœ‹è¿›ç¨‹docker compose top# æŸ¥çœ‹serviceèµ„æºä½¿ç”¨æƒ…å†µdocker compose stats# æŸ¥çœ‹serviceæ—¥å¿—ï¼Œ-f è¡¨ç¤ºæŒç»­è·Ÿè¸ªdocker compose logs -f# æŸ¥çœ‹æŒ‡å®šserviceçš„æ—¥å¿—docker compose logs -f service_name# è¿›å…¥æŒ‡å®šçš„serviceå®¹å™¨docker compose exec service_name bash å‡çº§é•œåƒ 123456# å…ˆåœæ­¢æ‰€æœ‰servicedocker compose down# æ‹‰å–æœ€æ–°é•œåƒdocker compose pull# å¯åŠ¨servicedocker compose up -d --build docker-compose.yml çš„è¯­æ³• å¸¸ç”¨æŒ‡ä»¤ 123456789101112131415161718192021222324version: &quot;3.8&quot; # å®šä¹‰ç‰ˆæœ¬ï¼Œè¡¨ç¤ºå½“å‰ä½¿ç”¨çš„ docker compose è¯­æ³•çš„ç‰ˆæœ¬ï¼Œå·²è¿‡æ—¶ ï¼Œæ–°ç‰ˆ Docker ä¼šä½¿ç”¨æœ€æ–°çš„ Compose Specification è‡ªåŠ¨è§£æname: &quot;project_name&quot; # é¡¹ç›®åï¼Œé»˜è®¤ docker-compose.yml æ–‡ä»¶æ‰€åœ¨çš„ç›®å½•åï¼Œä¸æ¨èè®¾ç½®services: # æœåŠ¡åˆ—è¡¨ servicename: # æœåŠ¡åå­—ï¼Œåªèƒ½åŒ…å«å°å†™å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ã€ä¸­åˆ’çº¿ï¼Œå¿…é¡»ä»¥å­—æ¯æˆ–æ•°å­—å¼€å¤´ build: # åŸºäºDockerfileæ„å»ºç›®å½•ï¼Œå¦‚æœåŒæ—¶è®¾ç½®äº† image é€‰é¡¹ï¼Œåˆ™imageæŒ‡å®šçš„å°±æ˜¯æ„å»ºåçš„é•œåƒåç§° image: # é•œåƒçš„åå­—ï¼Œé»˜è®¤ä»è¿œç¨‹ä»“åº“æ‹‰å–ï¼Œå¦‚æœé…ç½®äº† build é€‰é¡¹ï¼Œåˆ™imageæŒ‡å®šçš„å°±æ˜¯æ„å»ºåçš„é•œåƒåç§° command: # å¯é€‰ï¼Œå¦‚æœè®¾ç½®ï¼Œåˆ™ä¼šè¦†ç›–é»˜è®¤é•œåƒé‡Œçš„ CMD å‘½ä»¤ environment: # å¯é€‰ï¼Œç­‰ä»·äº docker container run é‡Œçš„ --env é€‰é¡¹è®¾ç½®ç¯å¢ƒå˜é‡ volumes: # å¯é€‰ï¼Œç­‰ä»·äº docker container run é‡Œçš„ -v é€‰é¡¹ ç»‘å®šæ•°æ®å· networks: # å¯é€‰ï¼Œç­‰ä»·äº docker container run é‡Œçš„ --network é€‰é¡¹æŒ‡å®šç½‘ç»œ ports: # å¯é€‰ï¼Œç­‰ä»·äº docker container run é‡Œçš„ -p é€‰é¡¹æŒ‡å®šç«¯å£æ˜ å°„ expose: # å¯é€‰ï¼ŒæŒ‡å®šå®¹å™¨æš´éœ²çš„ç«¯å£ depends_on: # æœåŠ¡ä¾èµ–çš„å…¶å®ƒæœåŠ¡ env_file: # ç¯å¢ƒå˜é‡æ–‡ä»¶ï¼Œç”Ÿäº§ç¯å¢ƒæ›´æ¨èè¿™ç§æ–¹å¼ servicename2: image: command: networks: ports: servicename3: #...volumes: # å¯é€‰ï¼Œç­‰ä»·äº docker volume createnetworks: # å¯é€‰ï¼Œç­‰ä»·äº docker network create volumes å·æ˜¯ç”±å®¹å™¨å¼•æ“å®ç°çš„æŒä¹…æ•°æ®å­˜å‚¨ã€‚Compose ä¸ºæœåŠ¡æä¾›äº†ä¸€ç§ä¸­ç«‹çš„æŒ‚è½½å·çš„æ–¹å¼ï¼Œå¹¶é€šè¿‡é…ç½®å‚æ•°å°†å·åˆ†é…ç»™åŸºç¡€æ¶æ„ã€‚é¡¶çº§volumeså£°æ˜å…è®¸æ‚¨é…ç½®å¯åœ¨å¤šä¸ªæœåŠ¡ä¹‹é—´é‡å¤ä½¿ç”¨çš„å‘½åå·ã€‚ 12345678910111213services: backend: image: example/database volumes: # æŒ‚è½½å·æ˜ å°„ - db-data:/etc/data # æŒ‚è½½åˆ°å®¹å™¨çš„/etc/dataç›®å½• backup: image: backup-service volumes: - db-data:/var/lib/backup/data # ä¸€ä¸ªå·å¯ä»¥è¢«å¤šä¸ªæœåŠ¡ä½¿ç”¨volumes: # å­˜å‚¨å·é…ç½® db-data: # åˆ›å»ºä¸€ä¸ªåä¸ºdb-dataçš„å·ï¼Œå®é™…çš„ç½‘ç»œåç§°æ˜¯ å®¹å™¨ç»„åç§°_è¿™é‡Œçš„åç§° volumes çš„å±æ€§ driver: å·ç±»å‹ï¼Œé»˜è®¤ä¸ºlocalï¼ŒæŒ‡å®šåº”ä½¿ç”¨å“ªä¸ªå·é©±åŠ¨ç¨‹åºã€‚å¦‚æœè¯¥é©±åŠ¨ç¨‹åºä¸å¯ç”¨ï¼ŒCompose å°†è¿”å›é”™è¯¯å¹¶ä¸”ä¸ä¼šéƒ¨ç½²è¯¥åº”ç”¨ç¨‹åºã€‚ 1234volumes: db-data: # å£°æ˜ä¸€ä¸ªåä¸ºdb-dataçš„å· driver: local # æŒ‡å®šå·ç±»å‹ï¼Œè¿™ä¸ªæ˜¯é»˜è®¤å€¼ï¼Œå¯ä»¥ä¸é…ç½® db-data2: # å£°æ˜ä¸€ä¸ªåä¸ºdb-data2çš„å·ï¼Œè¿™æ˜¯æœ€ç®€å•çš„ volumes é…ç½® driver_opts: å·ç±»å‹å‚æ•°ï¼ŒæŒ‡å®šè¦ä¼ é€’ç»™æ­¤å·é©±åŠ¨ç¨‹åºçš„é€‰é¡¹åˆ—è¡¨ï¼ˆä»¥é”®å€¼å¯¹çš„å½¢å¼ï¼‰ã€‚è¿™äº›é€‰é¡¹ä¸é©±åŠ¨ç¨‹åºç›¸å…³ã€‚ 123456volumes: db-data: driver_opts: # å·ç±»å‹å‚æ•°ï¼ŒæŒ‡å®šè¦ä¼ é€’ç»™æ­¤å·é©±åŠ¨ç¨‹åºçš„é€‰é¡¹åˆ—è¡¨ï¼ˆä»¥é”®å€¼å¯¹çš„å½¢å¼ï¼‰ type: &quot;nfs&quot; # å·ç±»å‹ï¼ŒæŒ‡å®šåº”ä½¿ç”¨å“ªä¸ªå·é©±åŠ¨ç¨‹åºï¼Œè¿™é‡Œæ˜¯nfs o: &quot;addr=10.40.0.199,nolock,soft,rw&quot; # nfså‚æ•°ï¼Œaddrä¸ºnfsæœåŠ¡å™¨åœ°å€ï¼Œnolockä¸ºä¸é”å®šæ–‡ä»¶ï¼Œsoftä¸ºè½¯é“¾æ¥ï¼Œrwä¸ºè¯»å†™æƒé™ device: &quot;:/docker/example&quot; # nfsæŒ‚è½½è·¯å¾„ external: å·æ˜¯å¦ä¸ºå¤–éƒ¨å·ï¼Œé»˜è®¤ä¸ºfalse 123volumes: db-data: external: true # true è¡¨ç¤ºä¸ä¼šåˆ›å»ºï¼Œè€Œæ˜¯ä½¿ç”¨å·²å­˜åœ¨çš„ï¼Œå³ä¼šå»volumesä¸­æŸ¥æ‰¾(docker volume ls) å®¹å™¨ç»„åç§°_da-data ï¼Œé»˜è®¤ä¸ºfalse name: å·çš„åç§°ï¼Œé»˜è®¤ä¸º å®¹å™¨ç»„åç§°_å£°æ˜çš„åç§° 1234volumes: db-data: name: db-data # åˆ›å»ºä¸€ä¸ªåä¸ºdb-dataçš„å·ï¼Œå®é™…çš„å·åç§°å°±æ˜¯ db-dataï¼Œä¸ä¼šå†åŠ ä¸Šå®¹å™¨ç»„åç§°å‰ç¼€ external: true # name å±æ€§ç»å¸¸ä¸ external: true ä¸€èµ·ä½¿ç”¨ labels: ç”¨äºå‘å·æ·»åŠ å…ƒæ•°æ®ï¼Œå¯ä»¥æ·»åŠ ä»»æ„çš„é”®å€¼å¯¹ 123456volumes: db-data: labels: com.example.description: &quot;Database volume&quot; com.example.department: &quot;IT/Ops&quot; com.example.label-with-empty-value: &quot;&quot; networks ç½‘ç»œä½¿æœåŠ¡èƒ½å¤Ÿç›¸äº’é€šä¿¡ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒCompose ä¼šä¸ºæ‚¨çš„åº”ç”¨è®¾ç½®å•ä¸ªç½‘ç»œã€‚æœåŠ¡çš„æ¯ä¸ªå®¹å™¨éƒ½ä¼šåŠ å…¥é»˜è®¤ç½‘ç»œï¼Œå¹¶ä¸”è¯¥ç½‘ç»œä¸Šçš„å…¶ä»–å®¹å™¨éƒ½å¯ä»¥è®¿é—®ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡æœåŠ¡åç§°å‘ç°ã€‚é¡¶çº§networkså…ƒç´ å…è®¸æ‚¨é…ç½®å¯åœ¨å¤šä¸ªæœåŠ¡ä¹‹é—´é‡å¤ä½¿ç”¨çš„å‘½åç½‘ç»œã€‚ 1234567891011121314services: frontend: image: example/webapp networks: # ç½‘ç»œæ˜ å°„ - front-tier # åŠ å…¥front-tierç½‘ç»œ - back-tier db: image: postgres networks: - backendnetworks: # ç½‘ç»œé…ç½® front-tier: # åˆ›å»ºä¸€ä¸ªåä¸ºfront-tierçš„ç½‘ç»œï¼Œå®é™…çš„ç½‘ç»œåç§°æ˜¯ å®¹å™¨ç»„åç§°_front-tier back-tier: å¦‚æœ Compose æ–‡ä»¶æœªæ˜¾å¼å£°æ˜ç½‘ç»œï¼ŒCompose å°†ä½¿ç”¨éšå¼defaultç½‘ç»œã€‚ 123456789101112services: some-service: image: foo# è¿™ä¸ªä¾‹å­å®é™…ä¸Šç­‰åŒäºï¼šservices: some-service: image: foo networks: default: &#123;&#125;networks: default: &#123;&#125; networks çš„å±æ€§ driver: ç½‘ç»œç±»å‹ï¼Œé»˜è®¤ä¸ºbridge 123networks: gitea: driver: bridge driver_opts: ç½‘ç»œç±»å‹å‚æ•°ï¼ŒæŒ‡å®šè¦ä¼ é€’ç»™æ­¤ç½‘ç»œé©±åŠ¨ç¨‹åºçš„é€‰é¡¹åˆ—è¡¨ï¼ˆä»¥é”®å€¼å¯¹çš„å½¢å¼ï¼‰ã€‚è¿™äº›é€‰é¡¹ä¸é©±åŠ¨ç¨‹åºç›¸å…³ã€‚ 12345networks: frontend: driver: bridge driver_opts: com.docker.network.bridge.host_binding_ipv4: &quot;127.0.0.1&quot; # è®¾ç½®å®¹å™¨ç«¯å£ç»‘å®šåˆ°ä¸»æœºçš„å“ªä¸ª IPï¼ˆå¦‚ &quot;127.0.0.1&quot;ï¼Œç»‘å®šåˆ°æœ¬åœ°ï¼‰ driver_opts å¸¸è§é…ç½®é¡¹ï¼ˆé’ˆå¯¹ bridge ç½‘ç»œé©±åŠ¨ï¼‰ é€‰é¡¹é”®åï¼ˆdriver_optsï¼‰ è¯´æ˜ com.docker.network.bridge.name æŒ‡å®šæ¡¥æ¥ç½‘ç»œçš„åç§°ï¼ˆé»˜è®¤æ˜¯éšæœºç”Ÿæˆï¼Œå¦‚ br-xxxxxï¼‰ com.docker.network.bridge.enable_icc æ˜¯å¦å…è®¸å®¹å™¨ä¹‹é—´çš„é€šä¿¡ï¼ˆtrue æˆ– falseï¼‰ com.docker.network.bridge.enable_ip_masquerade æ˜¯å¦å¯ç”¨ IP å‡å†’ï¼ˆNATï¼Œé€šå¸¸ç”¨äºå¤–ç½‘è®¿é—®ï¼‰ com.docker.network.bridge.host_binding_ipv4 è®¾ç½®å®¹å™¨ç«¯å£ç»‘å®šåˆ°ä¸»æœºçš„å“ªä¸ª IPï¼ˆå¦‚ &quot;127.0.0.1&quot;ï¼Œç»‘å®šåˆ°æœ¬åœ°ï¼‰ com.docker.network.bridge.default_bridge æ˜¯å¦å°†è¯¥ç½‘ç»œè®¾ç½®ä¸ºé»˜è®¤ bridge ç½‘ç»œï¼ˆtrue æˆ– falseï¼‰ com.docker.network.driver.mtu è®¾ç½®ç½‘ç»œçš„æœ€å¤§ä¼ è¾“å•å…ƒï¼ˆMTUï¼Œä¾‹å¦‚ &quot;1500&quot;ï¼‰ com.docker.network.bridge.allow_non_default_bridge æ˜¯å¦å…è®¸å®¹å™¨åŠ å…¥éé»˜è®¤çš„ bridge ç½‘ç»œï¼ˆè¾ƒå°‘ä½¿ç”¨ï¼‰ attachable: å¦‚æœä¸ºtrueï¼Œåˆ™å…è®¸å°†å…¶å®ƒç‹¬ç«‹å®¹å™¨ä¹ŸåŠ å…¥åˆ°æ­¤ç½‘ç»œã€‚é»˜è®¤å€¼ä¸ºfalseã€‚å¦‚æœç‹¬ç«‹å®¹å™¨è¿æ¥åˆ°æ­¤ç½‘ç»œï¼Œå®ƒå¯ä»¥ä¸åŒæ ·è¿æ¥åˆ°æ­¤ç½‘ç»œçš„æœåŠ¡å’Œå…¶ä»–ç‹¬ç«‹å®¹å™¨è¿›è¡Œé€šä¿¡ã€‚ 123networks: gitea: attachable: true external: true è¡¨ç¤ºä¸ä¼šåˆ›å»ºæ–°çš„ç½‘ç»œï¼Œå›å»networksä¸­æŸ¥æ‰¾ï¼ˆdocker network lsï¼‰ï¼Œé»˜è®¤ä¸ºfalse 123networks: gitea: external: true name: ç½‘ç»œåç§°ï¼Œä¸ä¼šå†åŠ ä¸Šå®¹å™¨ç»„åç§°å‰ç¼€ 1234networks: gitea: name: gitea external: true # name å±æ€§ç»å¸¸ä¸ external: true ä¸€èµ·ä½¿ç”¨ labels: ç”¨äºå‘ç½‘ç»œæ·»åŠ å…ƒæ•°æ®ï¼Œå¯ä»¥æ·»åŠ ä»»æ„çš„é”®å€¼å¯¹ 123456networks: mynet1: labels: com.example.description: &quot;Financial transaction network&quot; com.example.department: &quot;Finance&quot; com.example.label-with-empty-value: &quot;&quot; internal: é»˜è®¤æƒ…å†µä¸‹ï¼ŒCompose æä¾›ç½‘ç»œçš„å¤–éƒ¨è¿æ¥ã€‚internalå½“è®¾ç½®ä¸º æ—¶trueï¼Œå¯è®©æ‚¨åˆ›å»ºä¸å¤–éƒ¨éš”ç¦»çš„ç½‘ç»œã€‚ 123networks: gitea: internal: true services æœåŠ¡æ˜¯åº”ç”¨ç¨‹åºä¸­è®¡ç®—èµ„æºçš„æŠ½è±¡å®šä¹‰ï¼Œå¯ä»¥ç‹¬ç«‹äºå…¶ä»–ç»„ä»¶è¿›è¡Œæ‰©å±•æˆ–æ›¿æ¢ã€‚æœåŠ¡ç”±ä¸€ç»„å®¹å™¨æ”¯æŒï¼Œç”±å¹³å°æ ¹æ®å¤åˆ¶è¦æ±‚å’Œå¸ƒå±€çº¦æŸè¿è¡Œã€‚ç”±äºæœåŠ¡ç”±å®¹å™¨æ”¯æŒï¼Œå› æ­¤å®ƒä»¬ç”± Docker é•œåƒå’Œä¸€ç»„è¿è¡Œæ—¶å‚æ•°å®šä¹‰ã€‚æœåŠ¡ä¸­çš„æ‰€æœ‰å®¹å™¨éƒ½ä½¿ç”¨è¿™äº›å‚æ•°ä»¥ç›¸åŒçš„æ–¹å¼åˆ›å»ºã€‚ service åŒ…å«çš„å±æ€§éå¸¸å¤šï¼Œå…·ä½“è¯·å‚è€ƒservicesé¡¶çº§å…ƒç´ ï¼Œè¿™é‡Œåªä»‹ç»æ¯”è¾ƒå¸¸ç”¨çš„å±æ€§ï¼Œ è¿™é‡Œä»¥Giteaçš„docker-compose.ymlä¸ºä¾‹ Gitea æ˜¯ä¸€ç§è½»æ¾ã€è‡ªæ‰˜ç®¡çš„ä¸€ä½“åŒ–è½¯ä»¶å¼€å‘æœåŠ¡ã€‚å®ƒåŒ…æ‹¬ Git æ‰˜ç®¡ã€ä»£ç å®¡æŸ¥ã€å›¢é˜Ÿåä½œã€åŒ…æ³¨å†Œè¡¨å’Œ CI/CDã€‚å®ƒç±»ä¼¼äº GitHubã€Bitbucket å’Œ GitLabã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455# version: &#x27;3.8&#x27; # é…ç½®æ–‡ä»¶ç‰ˆæœ¬ï¼Œå·²è¿‡æ—¶ï¼Œé…ç½®ä¸Šä¼šå‘Šè­¦ä½†ä¸ä¼šæŠ¥é”™# name: gitea # å®¹å™¨ç»„åç§°ï¼Œé»˜è®¤ä½¿ç”¨æ‰€åœ¨ç›®å½•çš„åç§°ï¼Œä¸æ¨èä½¿ç”¨networks: # ç½‘ç»œé…ç½® gitea: # åˆ›å»ºä¸€ä¸ªåä¸ºgiteaçš„ç½‘ç»œï¼Œå®é™…çš„ç½‘ç»œåç§°æ˜¯ gitea_giteaï¼Œå³ å®¹å™¨ç»„åç§°_è¿™é‡Œçš„åç§° external: false # å¦‚æœä¸ºtrueï¼Œåˆ™è¡¨ç¤ºæ­¤ç½‘ç»œä¸ä¼šç”±composeåˆ›å»ºï¼Œè€Œæ˜¯ä½¿ç”¨å·²æœ‰çš„ç½‘ç»œï¼Œé»˜è®¤ä¸ºfalse driver: bridge # ç½‘ç»œç±»å‹ï¼Œé»˜è®¤ä¸ºbridgevolumes: # å­˜å‚¨å·é…ç½® gitea: # åˆ›å»ºä¸€ä¸ªåä¸ºgiteaçš„å­˜å‚¨å·ï¼Œå®é™…çš„å·åç§°æ˜¯ gitea_giteaï¼Œå³ å®¹å™¨ç»„åç§°_è¿™é‡Œçš„åç§° driver: local # å­˜å‚¨å·ç±»å‹ï¼Œé»˜è®¤ä¸ºlocalservices: # æœåŠ¡é…ç½®ï¼Œè¿™é‡Œå¯ä»¥å®šä¹‰ä¸€ç»„å®¹å™¨ server: # å®šä¹‰ä¸€ä¸ªåä¸ºserverçš„æœåŠ¡ï¼Œæ³¨æ„è¿™ä¸ªä¸æ˜¯å®¹å™¨åç§° # build: . # æ„å»ºé•œåƒï¼Œä½¿ç”¨å½“å‰ç›®å½•ä¸‹çš„Dockerfile image: gitea/gitea:latest # é•œåƒåç§° # container_name: gitea # å®¹å™¨åç§°ï¼Œé»˜è®¤ä¸º â€œå®¹å™¨ç»„åç§°-æœåŠ¡åç§°-ç´¢å¼•â€ï¼Œä¸æ¨èé…ç½®ï¼Œå› ä¸º æ°´å¹³æ‰©å±•(--scale) æ—¶,å®¹å™¨åç§°ä¸èƒ½é‡å¤ environment: # å®šä¹‰ç¯å¢ƒå˜é‡ - USER_UID=1000 # key=value - USER_GID=1000 - DB_TYPE=mysql - DB_HOST=db:3306 # è¿™é‡Œé…ç½®çš„ db å°±æ˜¯ ä¸‹é¢çš„æœåŠ¡åç§°ï¼Œç›¸åŒ network ä¸‹çš„æœåŠ¡åç§°ï¼Œdocker composeä¼šè‡ªåŠ¨è§£æä¸ºå®¹å™¨çš„ipåœ°å€ - DB_NAME=gitea - DB_USER=gitea - DB_PASSWD=gitea # env_file: .gitea.env # ä» .gitea.env æ–‡ä»¶è¯»å–ç¯å¢ƒå˜é‡ï¼Œç”Ÿäº§ç¯å¢ƒæ›´æ¨è restart: always # å®¹å™¨å¯åŠ¨æ—¶ï¼Œè‡ªåŠ¨é‡å¯ networks: # ç½‘ç»œå…³è” - gitea # ç½‘ç»œåç§°ï¼Œå°±æ˜¯ä¸Šé¢åˆ›å»ºçš„giteaç½‘ç»œ volumes: # æ•°æ®å·å…³è” - gitea:/data # volumeæ˜ å°„ï¼Œæ•°æ®å·åç§°:/å®¹å™¨è·¯å¾„ - /etc/timezone:/etc/timezone:ro # è·¯å¾„æ˜ å°„ï¼Œå®¿ä¸»æœºè·¯å¾„:/å®¹å™¨è·¯å¾„:è¯»å†™æƒé™ - /etc/localtime:/etc/localtime:ro ports: # ç«¯å£æ˜ å°„ - &quot;3000:3000&quot; # å®¿ä¸»æœºç«¯å£:å®¹å™¨ç«¯å£ depends_on: # å¯åŠ¨ä¾èµ–ï¼Œå°±æ˜¯ä¾èµ–çš„æœåŠ¡å¯åŠ¨åæ‰èƒ½å¯åŠ¨æœ¬æœåŠ¡ db: # å¯åŠ¨dbæœåŠ¡ condition: service_healthy # æœåŠ¡é€šè¿‡å¥åº·æ£€æŸ¥ï¼Œä¹Ÿå¯ä»¥é…ç½®ä¸º service_startedï¼šæœåŠ¡å¯åŠ¨ï¼Œè¿™ä¸ªæ˜¯é»˜è®¤å€¼ db: # æ•°æ®åº“æœåŠ¡ image: mysql:8 # é•œåƒ environment: # ç¯å¢ƒå˜é‡ - MYSQL_ROOT_PASSWORD=gitea - MYSQL_USER=gitea - MYSQL_PASSWORD=gitea - MYSQL_DATABASE=gitea restart: always # å¯åŠ¨ç­–ç•¥ networks: # ç½‘ç»œæ˜ å°„ - gitea # æ˜ å°„åˆ°giteaç½‘ç»œ volumes: # å·æ˜ å°„ - ./mysql:/var/lib/mysql # å®¿ä¸»æœºè·¯å¾„:/å®¹å™¨è·¯å¾„ï¼Œè¿™é‡Œå®¿ä¸»æœºæ”¯æŒç›¸å¯¹è·¯å¾„ healthcheck: # å¥åº·æ£€æŸ¥ test: [&quot;CMD-SHELL&quot;, &quot;mysql -u root -pgitea&quot;, &quot;-e &#x27;SELECT 1;&#x27;&quot;] # æ‰§è¡Œå‘½ä»¤ï¼Œå¦‚æœè¿”å›0ï¼Œåˆ™å¥åº·æ£€æŸ¥é€šè¿‡ï¼Œè¿™é‡Œä¸æ”¯æŒä¸Šé¢çš„ç¯å¢ƒå˜é‡ï¼Œteståªæ”¯æŒ CMD-SHELL å’Œ CMD interval: 10s # å¥åº·æ£€æŸ¥é—´éš” timeout: 5s # å¥åº·æ£€æŸ¥è¶…æ—¶æ—¶é—´ retries: 3 # å¥åº·æ£€æŸ¥é‡è¯•æ¬¡æ•° build: æ„å»ºé•œåƒ 1234services: server: build: . # Dockerfileçš„ç›®å½•ï¼Œâ€œ.â€ è¡¨ç¤ºä½¿ç”¨å½“å‰ç›®å½•ä¸‹çš„Dockerfile image: example/webapp # é•œåƒåç§°ï¼Œå¦‚æœæœ‰buildï¼Œåˆ™è¯¥åç§°å°±æ˜¯buildåçš„é•œåƒåç§°ï¼Œå¦‚æœæ²¡æœ‰buildï¼Œåˆ™å°±ä¼šä»è¿œç¨‹ä»“åº“æ‹‰å– 12345678910111213services: server: build: context: ./webapp # Dockerfileçš„ç›®å½•ï¼Œé»˜è®¤æ˜¯å½“å‰ç›®å½• dockerfile: Dockerfile # æ„å»ºé•œåƒçš„Dockerfileåç§°ï¼Œé»˜è®¤æ˜¯Dockerfile platforms: # æ„å»ºé•œåƒçš„æ¶æ„ - linux/amd64 # æ„å»ºé•œåƒçš„æ¶æ„ï¼Œé»˜è®¤æ˜¯å½“å‰æ¶æ„ args: # æ„å»ºé•œåƒçš„å‚æ•° - FOO=bar labels: # æ„å»ºé•œåƒçš„æ ‡ç­¾ com.example.description: &quot;Accounting webapp&quot; com.example.department: &quot;Finance&quot; com.example.label-with-empty-value: &quot;&quot; command: è¦†ç›–å®¹å™¨æ˜ åƒå£°æ˜çš„é»˜è®¤å‘½ä»¤ 1234services: server: command: [&quot;python&quot;, &quot;app.py&quot;] image: example/webapp entrypoint: å£°æ˜æœåŠ¡å®¹å™¨çš„é»˜è®¤å…¥å£ç‚¹ï¼Œè¿™è¦†ç›–äº†æœåŠ¡Dockerfileä¸­çš„ENTRYPOINTæŒ‡ä»¤ã€‚ 123456789101112services: server: image: example/webapp entrypoint: - php - -d - zend_extension=/usr/local/lib/php/extensions/no-debug-non-zts-20100525/xdebug.so - -d - memory_limit=-1 - vendor/bin/phpunit # å¦‚æœå€¼ä¸ºnullï¼Œåˆ™ä½¿ç”¨å›¾åƒçš„é»˜è®¤å…¥å£ç‚¹ã€‚ entrypoint: null # å¦‚æœå€¼æ˜¯ []ï¼ˆç©ºåˆ—è¡¨ï¼‰æˆ– &#x27;&#x27;ï¼ˆç©ºå­—ç¬¦ä¸²ï¼‰ï¼Œå›¾åƒå£°æ˜çš„é»˜è®¤å…¥å£ç‚¹è¢«å¿½ç•¥ï¼Œæˆ–è€…æ¢å¥è¯è¯´ï¼Œè¢«è¦†ç›–ä¸ºç©ºã€‚ entrypoint: [] depends_on: æœåŠ¡å¯åŠ¨ä¾èµ–ï¼Œå°±æ˜¯ä¾èµ–çš„æœåŠ¡å¯åŠ¨åæ‰èƒ½å¯åŠ¨æœ¬æœåŠ¡ 12345678910services: web: build: . depends_on: - db # çŸ­è¯­æ³• - redis redis: image: redis db: image: postgres 12345678910111213141516171819services: web: build: . depends_on: db: # é•¿è¯­æ³• condition: service_healthy # æ»¡è¶³çš„æ¡ä»¶ restart: true # å½“è®¾ç½®ä¸ºtrueï¼ŒComposeåœ¨æ›´æ–°ä¾èµ–æœåŠ¡åé‡æ–°å¯åŠ¨æ­¤æœåŠ¡ã€‚ redis: condition: service_started redis: image: redis db: image: postgres## conditionï¼šè®¾ç½®ä¾èµ–æ€§è¢«è§†ä¸ºæ»¡è¶³çš„æ¡ä»¶# service_startedï¼šç›¸å½“äºä¹‹å‰æè¿°çš„ç®€çŸ­è¯­æ³•# service_healthyï¼šæŒ‡å®šåœ¨å¯åŠ¨ä¾èµ–æœåŠ¡ä¹‹å‰ï¼Œä¾èµ–é¢„æœŸä¸ºâ€œå¥åº·â€ï¼ˆå¦‚healthcheckæ‰€ç¤ºï¼‰ã€‚# service_completed_successfullyï¼šæŒ‡å®šåœ¨å¯åŠ¨ä¾èµ–æœåŠ¡ä¹‹å‰ï¼Œä¾èµ–é¡¹é¢„è®¡å°†è¿è¡Œåˆ°æˆåŠŸå®Œæˆã€‚ environment: å®šä¹‰ç¯å¢ƒå˜é‡ 12345678910111213services: server: image: example/webapp environment: - FOO=bar - BAZ=qux# æˆ–è€…services: server: image: example/webapp environment: FOO: bar BAZ: qux env_file: ç”¨äºæŒ‡å®šä¸€ä¸ªæˆ–å¤šä¸ªåŒ…å«è¦ä¼ é€’åˆ°å®¹å™¨çš„ç¯å¢ƒå˜é‡çš„æ–‡ä»¶ã€‚ 123456services: server: image: example/webapp env_file: - ./a.env # åˆ—è¡¨ä¸­çš„æ–‡ä»¶æ˜¯ä»ä¸Šåˆ°ä¸‹å¤„ç†çš„ã€‚å¯¹äºä¸¤ä¸ªç¯å¢ƒæ–‡ä»¶ä¸­æŒ‡å®šçš„ç›¸åŒå˜é‡ï¼Œåˆ—è¡¨ä¸­æœ€åä¸€ä¸ªæ–‡ä»¶çš„å€¼æ˜¯æœ‰æ•ˆçš„ã€‚ - ./b.env 12345678services: server: image: example/webapp env_file: - path: ./default.env required: true # default - path: ./override.env required: false # å½“requiredè®¾ç½®ä¸ºfalseä¸”.envæ–‡ä»¶ç¼ºå¤±æ—¶ï¼ŒComposeä¼šå¿½ç•¥ restart: å®šä¹‰å¹³å°åœ¨å®¹å™¨ç»ˆæ­¢æ—¶é€‚ç”¨çš„ç­–ç•¥ 12345678services: server: image: example/webapp restart: &quot;no&quot; # é»˜è®¤é‡å¯ç­–ç•¥ã€‚åœ¨ä»»ä½•æƒ…å†µä¸‹ï¼Œå®ƒéƒ½ä¸ä¼šé‡æ–°å¯åŠ¨å®¹å™¨ã€‚ # restart: always # ç­–ç•¥æ€»æ˜¯é‡æ–°å¯åŠ¨å®¹å™¨ï¼Œç›´åˆ°å®ƒè¢«ç§»é™¤ã€‚ # restart: on-failure # å¦‚æœé€€å‡ºä»£ç è¡¨æ˜é”™è¯¯ï¼Œç­–ç•¥å°†é‡æ–°å¯åŠ¨å®¹å™¨ã€‚ # restart: on-failure:3 # å¦‚æœé€€å‡ºä»£ç è¡¨æ˜é”™è¯¯ï¼Œç­–ç•¥å°†é‡æ–°å¯åŠ¨å®¹å™¨ã€‚ä½†ä»…å°è¯•é‡å¯3æ¬¡ã€‚ # restart: unless-stopped # æ— è®ºé€€å‡ºä»£ç å¦‚ä½•ï¼Œç­–ç•¥éƒ½ä¼šé‡æ–°å¯åŠ¨å®¹å™¨ï¼Œä½†å½“æœåŠ¡åœæ­¢æˆ–åˆ é™¤æ—¶ï¼Œç­–ç•¥ä¼šåœæ­¢é‡æ–°å¯åŠ¨ã€‚ healthcheck: å¥åº·æ£€æŸ¥ã€‚ 12345678910services: server: image: example/webapp healthcheck: # å¥åº·æ£€æŸ¥ test: [&quot;CMD&quot;, &quot;curl&quot;, &quot;-f&quot;, &quot;http://localhost&quot;] # ç›‘æ§æ£€æŸ¥æ—¶æ‰§è¡Œçš„å‘½ä»¤ interval: 1m30s # å¥åº·æ£€æŸ¥çš„é—´éš”ï¼Œé»˜è®¤å€¼ä¸º 30s timeout: 10s # å¥åº·æ£€æŸ¥çš„è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤å€¼ä¸º 30s retries: 3 # å¥åº·æ£€æŸ¥çš„å°è¯•æ¬¡æ•°ï¼Œé»˜è®¤å€¼ä¸º 3 start_period: 40s # å¯åŠ¨å®½é™æœŸï¼šåœ¨æ­¤æœŸé—´ï¼Œå¤±è´¥ä¸ä¼šè®¡å…¥é‡è¯•æ¬¡æ•°ï¼ˆä»…ç”¨äºåˆ¤æ–­æœåŠ¡æ˜¯å¦å¯åŠ¨å®Œæ¯•ï¼‰ start_interval: 5s # å¯åŠ¨å®½é™æœŸå†…æ£€æŸ¥çš„é¢‘ç‡ï¼Œæœ¬ç¤ºä¾‹ä¸ºåœ¨å‰ 40 ç§’å†…æ¯ 5 ç§’æ£€æŸ¥ä¸€æ¬¡ testå®šä¹‰Composeè¿è¡Œçš„å‘½ä»¤æ¥æ£€æŸ¥å®¹å™¨è¿è¡ŒçŠ¶å†µã€‚å®ƒå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯åˆ—è¡¨ã€‚å¦‚æœæ˜¯åˆ—è¡¨ï¼Œç¬¬ä¸€ä¸ªé¡¹ç›®å¿…é¡»æ˜¯NONEã€CMDæˆ–CMD-SHELLã€‚å¦‚æœå®ƒæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå®ƒç­‰åŒäºæŒ‡å®šCMD-SHELLåè·Ÿè¯¥å­—ç¬¦ä¸²ã€‚ 1234test: [&quot;CMD&quot;, &quot;curl&quot;, &quot;-f&quot;, &quot;http://localhost&quot;]# ä½¿ç”¨CMD-SHELLè¿è¡Œé…ç½®ä¸ºå­—ç¬¦ä¸²çš„å‘½ä»¤ï¼Œä½¿ç”¨å®¹å™¨çš„é»˜è®¤å¤–å£³ï¼ˆLinuxçš„/bin/shï¼‰ã€‚ä»¥ä¸‹ä¸¤ç§å½¢å¼æ˜¯ç­‰ä»·çš„test: [&quot;CMD-SHELL&quot;, &quot;curl -f http://localhost || exit 1&quot;]test: curl -f https://localhost || exit 1 test ä¸­çš„ CMD å’Œ CMD-SHELL æ˜¯ä¸¤ç§ä¸åŒçš„æ‰§è¡Œæ–¹å¼ï¼Œå®ƒä»¬çš„ä¸»è¦åŒºåˆ«åœ¨äºï¼š é¡¹ç›® CMD CMD-SHELL âœ… ç”¨é€” ç›´æ¥æ‰§è¡Œå‘½ä»¤ï¼ˆä¸é€šè¿‡ shellï¼‰ é€šè¿‡ shellï¼ˆå¦‚ /bin/sh -cï¼‰æ‰§è¡Œå‘½ä»¤ ğŸ§¾ å†™æ³•æ ¼å¼ [&quot;CMD&quot;, &quot;executable&quot;, &quot;arg1&quot;, &quot;arg2&quot;] [&quot;CMD-SHELL&quot;, &quot;command string&quot;] ğŸ”§ æ˜¯å¦ä½¿ç”¨ shell å¦ æ˜¯ ğŸ§  æ˜¯å¦æ”¯æŒ shell è¯­æ³• âŒ å¦ï¼ˆä¸èƒ½ä½¿ç”¨ &amp;&amp;ã€ ||ã€\\$VAR ç­‰ï¼‰ âœ… æ˜¯ï¼ˆæ”¯æŒç®¡é“ã€é‡å®šå‘ã€å˜é‡ã€å‘½ä»¤ç»„åˆï¼‰ ğŸ›¡ï¸ å®‰å…¨æ€§/å¯ç§»æ¤æ€§ âœ… æ›´å®‰å…¨ï¼Œæ‰§è¡Œæ›´æ˜ç¡® âš  ä¾èµ–å®¹å™¨ä¸­å­˜åœ¨ shellï¼ˆå¦‚ /bin/shï¼‰ âš™ï¸ æ‰§è¡Œæ•ˆç‡ âœ… ç¨å¿«ï¼Œå› æ— éœ€ shell è§£æ âš  ç¨æ…¢ï¼Œéœ€é€šè¿‡ shell å¯åŠ¨ ğŸ“¦ æ¨èä½¿ç”¨åœºæ™¯ - ç®€å•å¥åº·æ£€æŸ¥å‘½ä»¤- å®‰å…¨ç¯å¢ƒ- ç²¾ç®€é•œåƒ - éœ€è¦ä½¿ç”¨é€»è¾‘æ§åˆ¶ï¼ˆ||, &amp;&amp;ï¼‰- å¤æ‚æ£€æŸ¥é€»è¾‘ ğŸ“Œ ç¤ºä¾‹ [&quot;CMD&quot;, &quot;curl&quot;, &quot;-f&quot;, &quot;http://localhost&quot;] [&quot;CMD-SHELL&quot;, &quot;curl -f http\\://localhost || exit 1&quot;] volumes: æŒ‚è½½æ•°æ®å·ã€‚ 123456789101112131415161718192021222324252627282930# é•¿è¯­æ³•æ ¼å¼services: backend: image: example/backend volumes: - type: volume # å®‰è£…ç±»å‹ã€‚å¯ä»¥æ˜¯æ˜¯volumeã€bindã€tmpfsã€imageã€npipeã€cluster source: db-data # æŒ‚è½½çš„æºã€ç»‘å®šæŒ‚è½½çš„ä¸»æœºä¸Šçš„è·¯å¾„ã€æ˜ åƒæŒ‚è½½çš„Dockeræ˜ åƒå¼•ç”¨æˆ–é¡¶å±‚volumesé”®ä¸­å®šä¹‰çš„å·åç§°ã€‚ä¸é€‚ç”¨äºtmpfsæ”¯æ¶ã€‚ target: /data # å®¹å™¨ä¸­è£…è½½å·çš„è·¯å¾„ã€‚ volume: # é…ç½®å…¶ä»–å·é€‰é¡¹ nocopy: true # åœ¨åˆ›å»ºå·æ—¶ç¦ç”¨ä»å®¹å™¨å¤åˆ¶æ•°æ®çš„æ ‡å¿—ï¼Œé»˜è®¤å€¼ä¸ºfalseã€‚ subpath: sub # æŒ‚è½½å·çš„å­ç›®å½•ã€‚å³ db-data/sub - type: bind # bind è¡¨ç¤ºæŒ‚è½½ä¸»æœºä¸Šçš„è·¯å¾„ source: /var/run/postgres/postgres.sock target: /var/run/postgres/postgres.sockvolumes: # å£°æ˜æ•°æ®å· db-data:####################################################################################### çŸ­è¯­æ³•æ ¼å¼services: backend: image: example/backend volumes: - db-data:/data # è¿™ç§è¯­æ³•ä¸æ”¯æŒ subpath å’Œ nocopy - /var/run/postgres/postgres.sock:/var/run/postgres/postgres.sockvolumes: db-data: networks: é…ç½®ç½‘ç»œã€‚ 123456789services: some-service: networks: # é…ç½®ç½‘ç»œ - some-network # å…³è”ç½‘ç»œ - other-networknetworks: # å£°æ˜ç½‘ç»œ some-network: other-network: cpu å’Œ å†…å­˜é™åˆ¶ 123456789services: backend: image: myapp:latest mem_limit: 1g # é™åˆ¶æœ€å¤šä½¿ç”¨1GBå†…å­˜ mem_reservation: 512m # å»ºè®®é¢„ç•™512MBå†…å­˜ cpus: 2.0 # é™åˆ¶æœ€å¤šä½¿ç”¨2ä¸ªCPUæ ¸ cpu_shares: 1024 # é»˜è®¤å€¼ï¼Œè¡¨ç¤ºæ ‡å‡†ä¼˜å…ˆçº§ cpu_quota: 100000 # æ¯ 100ms å®¹å™¨æœ€å¤šå¯è¿è¡Œ 100msï¼ˆ=1æ ¸ï¼‰, ä¸ cpus ä¸èƒ½åŒæ—¶è®¾ç½® cpu_period: 100000 # è°ƒåº¦å‘¨æœŸä¸º100ms, ä¸ cpus ä¸èƒ½åŒæ—¶è®¾ç½® å­—æ®µå ç±»å‹ è¯´æ˜ cpus float é™åˆ¶å®¹å™¨æœ€å¤šä½¿ç”¨å¤šå°‘ CPUï¼ˆé€»è¾‘æ ¸æ•°ï¼‰ï¼›ä¾‹å¦‚ 0.5 = ä¸€åŠ CPU mem_limit string å®¹å™¨æœ€å¤§å†…å­˜é™åˆ¶ï¼Œæ”¯æŒå•ä½ï¼šbã€kã€mã€gï¼ˆå¦‚ 256m, 1gï¼‰ mem_reservation string å®¹å™¨å¯åŠ¨æ—¶é¢„ç•™çš„å†…å­˜ï¼Œè¶…è¿‡è¿™ä¸ªå€¼ä¸è¢«é™åˆ¶ï¼ˆä»…æç¤ºè°ƒåº¦å™¨ï¼‰ cpu_shares int CPU æƒé‡ï¼ˆé»˜è®¤ 1024ï¼‰ï¼Œç”¨äºå¤šä¸ªå®¹å™¨æŠ¢å  CPU çš„ä¼˜å…ˆçº§ï¼ˆä»…åœ¨ç«äº‰æ—¶ç”Ÿæ•ˆï¼‰ cpu_quota int æ¯ä¸ªå‘¨æœŸå†…å…è®¸ä½¿ç”¨çš„ CPU æ—¶é—´ï¼ˆå•ä½ï¼šå¾®ç§’ï¼‰, ä¸ cpus ä¸èƒ½åŒæ—¶è®¾ç½® cpu_period int CPU è°ƒåº¦å‘¨æœŸï¼ˆå•ä½ï¼šå¾®ç§’ï¼Œé»˜è®¤ 100000ï¼‰, ä¸ cpus ä¸èƒ½åŒæ—¶è®¾ç½® æŸ¥çœ‹å®¹å™¨çš„ cpu å’Œ å†…å­˜é…ç½®æƒ…å†µ 123456789101112131415161718# è·å–å®¹å™¨çš„ cpu_quota å’Œ cpu_perioddocker inspect --format=&#x27;&#123;&#123;json .HostConfig.CpuQuota&#125;&#125; &#123;&#123;json .HostConfig.CpuPeriod&#125;&#125;&#x27; &lt;container_id&gt;# è·å–å®¹å™¨çš„ memory_limitdocker inspect --format=&#x27;&#123;&#123;json .HostConfig.Memory&#125;&#125;&#x27; &lt;container_id&gt;# è·å–å®¹å™¨çš„ cpu_sharesdocker inspect --format=&#x27;&#123;&#123;json .HostConfig.CpuShares&#125;&#125;&#x27; &lt;container_id&gt;# è·å–å®¹å™¨çš„ cpusdocker inspect --format=&#x27;&#123;&#123;json .HostConfig.NanoCpus&#125;&#125;&#x27; &lt;container_id&gt;# ç»„åˆä¸ºä¸€ä¸ªjsonè¾“å‡ºdocker inspect &lt;container_id&gt; | jq &#x27;.[0].HostConfig | &#123; cpus: (.NanoCpus / 1000000000), cpu_shares: .CpuShares, mem_limit: (.Memory / 1024 / 1024 | tostring + &quot; MB&quot;), mem_reservation: (.MemoryReservation / 1024 / 1024 | tostring + &quot; MB&quot;), cpu_quota: .CpuQuota, cpu_period: .CpuPeriod&#125;&#x27; docker run è½¬ docker compose åœ¨çº¿å·¥å…·ï¼šcomposerize æœ¬åœ°å®‰è£…ï¼šcomposerize 1234567891011121314151617# å®‰è£…å‘½ä»¤ï¼Œnpmå®‰è£…ï¼šhttps://nodejs.org/zh-cn/downloadnpm install composerize -g# è¿è¡Œå‘½ä»¤composerize docker run -p 80:80 -v /var/run/docker.sock:/tmp/docker.sock:ro --restart always --log-opt max-size=1g nginx## è½¬æ¢ç»“æœname: &lt;your project name&gt;services: nginx: ports: - 80:80 volumes: - /var/run/docker.sock:/tmp/docker.sock:ro restart: always logging: options: max-size: 1g image: nginx docker compose ç¼–æ’ç®¡ç†å·¥å…· Dockge Dockge æ˜¯ä¸€ä¸ªå¼€æºè½»é‡çº§ã€ŒDocker Compose ç®¡ç†å™¨ã€ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªæ¼‚äº®ã€å“åº”è¿…é€Ÿçš„ Web ç•Œé¢ï¼Œä¸“é—¨é¢å‘ä½¿ç”¨ docker compose çš„ç”¨æˆ·ã€‚ åŠŸèƒ½æ¨¡å— ä¸»è¦æè¿° Compose å †æ ˆå…¨ç”Ÿå‘½å‘¨æœŸç®¡ç† å¯ä»¥åˆ›å»ºã€ç¼–è¾‘ã€å¯åŠ¨ã€åœæ­¢ã€é‡å¯ã€åˆ é™¤åŸºäº compose.yaml æ–‡ä»¶çš„ Docker å †æ ˆ äº¤äº’å¼ Compose ç¼–è¾‘å™¨ + Web ç»ˆç«¯ å®æ—¶ç¼–è¾‘ YAML å¹¶æŸ¥çœ‹è¾“å‡ºï¼Œè¿˜å¯ä»¥ç›´æ¥åœ¨æµè§ˆå™¨ä¸­æ“ä½œç»ˆç«¯ å°† docker run â€¦ å‘½ä»¤è½¬æ¢ä¸º Compose æ–‡ä»¶ å¿«é€Ÿç”Ÿæˆ compose.yamlï¼Œä¾¿äºç‰ˆæœ¬æ§åˆ¶å’Œç»“æ„ç®¡ç† å®æ—¶æ“ä½œåé¦ˆ é•œåƒæ‹‰å–ã€å †æ ˆå¯åŠ¨/åœæ­¢ç­‰æ“ä½œå‡å¯å®æ—¶æŸ¥çœ‹è¿›åº¦ å¤šä¸»æœºä»£ç†æ”¯æŒï¼ˆâ‰¥1.4.0ï¼‰ èƒ½åœ¨å•ä¸€ UI ä¸­ç®¡ç†å¤šä¸ª Docker ä¸»æœº é«˜å…¼å®¹æ€§ &amp; å®‰å…¨è®¾è®¡ Compose æ–‡ä»¶ä¿å­˜åœ¨æœ¬åœ°ï¼Œä¸ä¼šè¢«ç³»ç»Ÿæ‰˜ç®¡ï¼Œä¾¿äºä½¿ç”¨ CLI æˆ–å…¶ä»–å·¥å…·ç®¡ç† å®‰è£… 1234567891011# Create directories that store your stacks and store Dockge&#x27;s stackmkdir -p /opt/stacks /opt/dockgecd /opt/dockge# Download your compose.yamlcurl &quot;https://dockge.kuma.pet/compose.yaml?port=5001&amp;stacksPath=%2Fopt%2Fstacks&quot; --output compose.yaml# Start the Serverdocker compose up -d# æµè§ˆå™¨è®¿é—® http://localhost:5001","summary":"æ‘˜è¦ æœ¬æ–‡ä»‹ç» Docker å‘½ä»¤ ä¸­ docker compose çš„ä½¿ç”¨æ–¹æ³• Dockerå®˜æ–¹æ–‡æ¡£ docker compose Compose file reference","date_published":"2025-06-04T13:30:05.000Z","tags":["æŠ€æœ¯","docker","docker"]},{"id":"https://blog.hanqunfeng.com/2025/05/28/docker-command-network/","url":"https://blog.hanqunfeng.com/2025/05/28/docker-command-network/","title":"Docker å‘½ä»¤ ä¹‹ ç½‘ç»œ(Network)","content_html":"<!--\n **åŠ ç²—**\n *æ–œä½“*\n ***åŠ ç²—å¹¶æ–œä½“***\n ~~åˆ é™¤çº¿~~\n ==çªå‡ºæ˜¾ç¤º==\n `çªå‡ºæ˜¾ç¤º(æ¨è)`\n ++ä¸‹åˆ’çº¿++\n ~ä¸‹æ ‡~\n ^ä¸Šæ ‡^\n è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference.\n å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)\n\n +++ **ç‚¹å‡»æŠ˜å **\n è¿™æ˜¯è¢«éšè—çš„å†…å®¹\n +++\n\n::: tips success warning danger\nè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹\n:::\n\n% note info % success warning danger\nè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹\n% endnote %\n\nå¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{}\n å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ\n -->\n<h2 id=\"æ‘˜è¦\">æ‘˜è¦</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æœ¬æ–‡ä»‹ç» Docker å‘½ä»¤ ä¸­ ç½‘ç»œç®¡ç† ç›¸å…³å‘½ä»¤</p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://docs.docker.com\">Dockerå®˜æ–¹æ–‡æ¡£</a></p>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"ä»€ä¹ˆæ˜¯Network-ç½‘ç»œ\">ä»€ä¹ˆæ˜¯Network(ç½‘ç»œ)?</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åœ¨ Docker ä¸­ï¼Œ<strong>ç½‘ç»œï¼ˆNetworkï¼‰</strong> æ˜¯å®¹å™¨ä¹‹é—´é€šä¿¡ã€å®¹å™¨ä¸å¤–éƒ¨é€šä¿¡çš„é‡è¦æœºåˆ¶ã€‚Docker æä¾›äº†ä¸€å¥—çµæ´»çš„ç½‘ç»œæ¨¡å‹ï¼Œä½¿å¾—ä½ å¯ä»¥è‡ªç”±é…ç½®å®¹å™¨çš„ç½‘ç»œç¯å¢ƒä»¥é€‚é…ä¸åŒåœºæ™¯ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>å®‰è£…dockeræ—¶ï¼Œä¼šè‡ªåŠ¨åœ¨å®¿ä¸»æœºä¸Šå®‰è£…ä¸€ä¸ª <code>docker0</code> ç½‘ç»œè®¾å¤‡ï¼Œå®ƒæ˜¯ä¸€ä¸ªç½‘æ¡¥è®¾å¤‡ï¼Œç”¨äº Docker å„å®¹å™¨åŠå®¿ä¸»æœºçš„ç½‘ç»œé€šä¿¡ã€‚</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹å®¿ä¸»æœºç½‘å¡ä¿¡æ¯ï¼Œå¯ä»¥æ‰¾åˆ°docker0</span></span><br><span class=\"line\">$ ip addr</span><br><span class=\"line\"><span class=\"comment\"># è¾“å‡º</span></span><br><span class=\"line\">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class=\"line\">    <span class=\"built_in\">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class=\"line\">    inet 127.0.0.1/8 scope host lo</span><br><span class=\"line\">       valid_lft forever preferred_lft forever</span><br><span class=\"line\">    inet6 ::1/128 scope host</span><br><span class=\"line\">       valid_lft forever preferred_lft forever</span><br><span class=\"line\">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 9001 qdisc mq state UP group default qlen 1000</span><br><span class=\"line\">    <span class=\"built_in\">link</span>/ether 0a:6b:88:11:66:39 brd ff:ff:ff:ff:ff:ff</span><br><span class=\"line\">    inet 10.250.0.205/24 brd 10.250.0.255 scope global dynamic noprefixroute eth0</span><br><span class=\"line\">       valid_lft 3076sec preferred_lft 3076sec</span><br><span class=\"line\">    inet6 fe80::86b:88ff:fe11:6639/64 scope <span class=\"built_in\">link</span></span><br><span class=\"line\">       valid_lft forever preferred_lft forever</span><br><span class=\"line\">3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default</span><br><span class=\"line\">    <span class=\"built_in\">link</span>/ether 02:42:d6:d5:09:b1 brd ff:ff:ff:ff:ff:ff</span><br><span class=\"line\">    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0</span><br><span class=\"line\">       valid_lft forever preferred_lft forever</span><br><span class=\"line\">    inet6 fe80::42:d6ff:fed5:9b1/64 scope <span class=\"built_in\">link</span></span><br><span class=\"line\">       valid_lft forever preferred_lft forever</span><br><span class=\"line\"><span class=\"comment\">## è¯´æ˜</span></span><br><span class=\"line\">eth0 å®¿ä¸»æœºçš„ipåœ°å€æ˜¯ 10.250.0.205</span><br><span class=\"line\">docker0 æœ¬èº«çš„ipåœ°å€æ˜¯ 172.17.0.1</span><br><span class=\"line\">docker0 çš„å­ç½‘æ©ç æ˜¯ 255.255.0.0</span><br><span class=\"line\">docker0 çš„å¹¿æ’­åœ°å€æ˜¯ 172.17.255.255</span><br><span class=\"line\">docker0 å¯ä»¥ä¸ºå®¹å™¨åˆ†é…çš„ipåœ°å€èŒƒå›´æ˜¯ 172.17.0.2-172.17.255.254ï¼Œæ€»è®¡65534ä¸ªipåœ°å€</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æ—¢ç„¶docker0æ˜¯ä¸€ä¸ªç½‘æ¡¥è®¾å¤‡ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤æ¥æŸ¥çœ‹ç½‘æ¡¥çš„è¯¦ç»†ä¿¡æ¯ï¼š</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ brctl show</span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡ºç»“æœ</span></span><br><span class=\"line\">brctl show</span><br><span class=\"line\">bridge name\t    bridge <span class=\"built_in\">id</span>\t\t      STP enabled\t    interfaces</span><br><span class=\"line\">docker0\t\t    8000.0242d6d509b1\t        no</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å¯åŠ¨dockeræœåŠ¡åï¼Œdockerå°±ä¸ºæˆ‘ä»¬è‡ªåŠ¨åˆ›å»ºäº†ä¸‰ä¸ªç½‘ç»œï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ docker network <span class=\"built_in\">ls</span></span><br><span class=\"line\">NETWORK ID     NAME      DRIVER    SCOPE</span><br><span class=\"line\">4182e112bf34   bridge    bridge    <span class=\"built_in\">local</span></span><br><span class=\"line\">958daf8a8a0d   host      host      <span class=\"built_in\">local</span></span><br><span class=\"line\">4674a17c6617   none      null      <span class=\"built_in\">local</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>è¿™é‡Œ<code>NAME</code>ä¸º<code>bridge</code>çš„ç½‘ç»œå°±æ˜¯ä¸<code>docker0</code>è®¾å¤‡ç›¸å¯¹åº”çš„ç½‘ç»œï¼Œå…¶ä¹Ÿæ˜¯docker<code>é»˜è®¤</code>çš„ç½‘ç»œï¼Œå¦‚æœåˆ›å»ºçš„å®¹å™¨æ²¡æœ‰æŒ‡å®šç½‘ç»œï¼Œé‚£ä¹ˆå®¹å™¨å°±ä¼šåŠ å…¥è¿™ä¸ª <code>bridge</code> ç½‘ç»œã€‚</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#  å¯åŠ¨ä¸€ä¸ªå®¹å™¨ï¼Œæ²¡æœ‰æŒ‡å®šç½‘ç»œ</span></span><br><span class=\"line\">docker run -itd --name ap1 alpine</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æ­¤æ—¶åœ¨å®¿ä¸»æœºä¸ŠæŸ¥çœ‹ç½‘å¡ä¿¡æ¯ï¼Œä¼šçœ‹åˆ°å¤šå‡ºä¸€ä¸ªè®¾å¤‡</span></span><br><span class=\"line\">ip addr</span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡ºç»“æœ</span></span><br><span class=\"line\">10: vethc0e0cc3@if9: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker0 state UP group default</span><br><span class=\"line\">    <span class=\"built_in\">link</span>/ether c6:0d:02:c8:<span class=\"built_in\">df</span>:a4 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br><span class=\"line\">    inet6 fe80::c40d:2ff:fec8:dfa4/64 scope <span class=\"built_in\">link</span></span><br><span class=\"line\">       valid_lft forever preferred_lft forever</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹å®¹å™¨çš„ç½‘å¡ä¿¡æ¯</span></span><br><span class=\"line\">docker <span class=\"built_in\">exec</span> -it ap1 ip addr</span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡ºç»“æœ</span></span><br><span class=\"line\">9: eth0@if10: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue state UP</span><br><span class=\"line\">    <span class=\"built_in\">link</span>/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff</span><br><span class=\"line\">    inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0</span><br><span class=\"line\">       valid_lft forever preferred_lft forever</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## æ­¤æ—¶èªæ˜çš„ä½ å·²ç»å‘ç°äº†ï¼šå®¿ä¸»æœºçš„ç½‘å¡ä¸å®¹å™¨çš„ç½‘å¡æ˜¯æˆå¯¹å‡ºç°çš„ï¼Œå¹¶ä¸”åŸºäºåºå·è¿›è¡Œå…³è”</span></span><br><span class=\"line\">å®¿ä¸»æœº: 10 : veth c0e0cc3 @ <span class=\"keyword\">if</span> 9  <span class=\"comment\"># åºå· 10 ä¸ å®¹å™¨åç¼€çš„ 10 åŒ¹é…ï¼Œveth æ˜¯è™šæ‹Ÿç½‘å¡ï¼Œc0e0cc3 æ˜¯éšæœºå­—ç¬¦ä¸²ï¼Œif æ˜¯ interface</span></span><br><span class=\"line\">å®¹å™¨:    9 : eth0         @ <span class=\"keyword\">if</span> 10 <span class=\"comment\"># åºå· 9 ä¸å®¿ä¸»æœºçš„åç¼€ 9 åŒ¹é…ï¼Œeth0 æ˜¯å®¹å™¨çš„ç½‘å¡ï¼Œif æ˜¯ interface</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æ­¤æ—¶æŸ¥çœ‹å®¿ä¸»æœºçš„ç½‘æ¡¥ä¿¡æ¯</span></span><br><span class=\"line\">brctl show</span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡ºç»“æœï¼Œå¯ä»¥åœ¨ interfaces ä¸­çœ‹åˆ° vethc0e0cc3ï¼Œè¯´æ˜ vethc0e0cc3 å·²ç»åŠ å…¥åˆ°ç½‘æ¡¥ä¸­</span></span><br><span class=\"line\">bridge name\t  bridge <span class=\"built_in\">id</span>\t\t      STP enabled\t  interfaces</span><br><span class=\"line\">docker0\t\t   8000.0242d6d509b1\t      no\t\t  vethc0e0cc3</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹ç½‘ç»œä¸­çš„å®¹å™¨ä¿¡æ¯ï¼Œè¿™é‡Œ jq æ˜¯ json æ ¼å¼åŒ–ï¼Œå¯ä»¥é€šè¿‡ dnf install jq -y å®‰è£…</span></span><br><span class=\"line\">docker network inspect bridge --format <span class=\"string\">&#x27;&#123;&#123;json .Containers&#125;&#125;&#x27;</span> | jq</span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡ºç»“æœ</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;c2436a1d750cc3de3a6f8ab8a693af25b3371aa8f7f168d5561538dcd4a8ff2d&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;Name&quot;</span>: <span class=\"string\">&quot;ap1&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;EndpointID&quot;</span>: <span class=\"string\">&quot;75469fddbbdeb8b7a328c1a1c3cc7070bb1a3e102f5fb97cc332dcbc22829af5&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;MacAddress&quot;</span>: <span class=\"string\">&quot;02:42:ac:11:00:02&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;IPv4Address&quot;</span>: <span class=\"string\">&quot;172.17.0.2/16&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;IPv6Address&quot;</span>: <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># è·å–å®¹å™¨çš„ IP åœ°å€</span></span><br><span class=\"line\">docker <span class=\"built_in\">exec</span> ap1 hostname -i</span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡ºç»“æœ</span></span><br><span class=\"line\">172.17.0.2</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ç›¸åŒç½‘ç»œè®¾å¤‡ä¸‹çš„å®¹å™¨å¯ä»¥é€šè¿‡ IP åœ°å€é€šä¿¡</span></span><br><span class=\"line\"><span class=\"comment\"># æˆ‘ä»¬å†åˆ›å»ºä¸€ä¸ªå®¹å™¨ï¼Œå¹¶æŸ¥çœ‹èƒ½å¦æ­£å¸¸é€šä¿¡</span></span><br><span class=\"line\">docker run -itd --name ap2 alpine</span><br><span class=\"line\">docker <span class=\"built_in\">exec</span> -it ap2 ping 172.17.0.2</span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡ºç»“æœï¼Œè¯´æ˜å¯ä»¥é€šè¿‡IPåœ°å€é€šä¿¡</span></span><br><span class=\"line\">PING 172.17.0.2 (172.17.0.2): 56 data bytes</span><br><span class=\"line\">64 bytes from 172.17.0.2: <span class=\"built_in\">seq</span>=0 ttl=64 time=0.137 ms</span><br><span class=\"line\">64 bytes from 172.17.0.2: <span class=\"built_in\">seq</span>=1 ttl=64 time=0.084 ms</span><br><span class=\"line\">64 bytes from 172.17.0.2: <span class=\"built_in\">seq</span>=2 ttl=64 time=0.081 ms</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹ç½‘ç»œä¸­çš„å®¹å™¨</span></span><br><span class=\"line\">docker network inspect bridge --format <span class=\"string\">&#x27;&#123;&#123;json .Containers&#125;&#125;&#x27;</span> | jq</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;9d3ed5be1916b14ec9befe3649c08cc9de247c595de248600f8ef8d0fc16c5cb&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;Name&quot;</span>: <span class=\"string\">&quot;ap2&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;EndpointID&quot;</span>: <span class=\"string\">&quot;35615a7ec10842401ad8c40187c792555b5089551a8eca39ddff6734aeba549e&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;MacAddress&quot;</span>: <span class=\"string\">&quot;02:42:ac:11:00:03&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;IPv4Address&quot;</span>: <span class=\"string\">&quot;172.17.0.3/16&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;IPv6Address&quot;</span>: <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;c2436a1d750cc3de3a6f8ab8a693af25b3371aa8f7f168d5561538dcd4a8ff2d&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;Name&quot;</span>: <span class=\"string\">&quot;ap1&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;EndpointID&quot;</span>: <span class=\"string\">&quot;75469fddbbdeb8b7a328c1a1c3cc7070bb1a3e102f5fb97cc332dcbc22829af5&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;MacAddress&quot;</span>: <span class=\"string\">&quot;02:42:ac:11:00:02&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;IPv4Address&quot;</span>: <span class=\"string\">&quot;172.17.0.2/16&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;IPv6Address&quot;</span>: <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æµ‹è¯•æ˜¯å¦å¯ä»¥é€šè¿‡å®¹å™¨åç§°è®¿é—®</span></span><br><span class=\"line\">docker <span class=\"built_in\">exec</span> -it ap2 ping ap1</span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡ºï¼Œä¸å¯ä»¥é€šè¿‡å®¹å™¨åç§°è®¿é—®</span></span><br><span class=\"line\">ping: bad address <span class=\"string\">&#x27;ap1&#x27;</span></span><br><span class=\"line\"><span class=\"comment\">## å¦‚æœå¸Œæœ›é€šè¿‡å®¹å™¨åç§°è®¿é—®ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ docker network create åˆ›å»ºä¸€ä¸ªæ–°çš„ç½‘ç»œ</span></span><br></pre></td></tr></table></figure>\n<div class=\"tips\">\n<p><em><strong>å¦‚æœæ²¡æœ‰å®‰è£… brctlï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼å®‰è£…</strong></em></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># centos7:</span></span><br><span class=\"line\">yum install bridge-utils -y</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># centos8: ä¸æ”¯æŒyumæºå®‰è£…ï¼Œéœ€è¦æ‰‹åŠ¨ç¼–è¯‘å®‰è£…</span></span><br><span class=\"line\"><span class=\"comment\"># ä¸‹è½½æºç å®‰è£…ï¼Œç›®å‰æœ€æ–°ç‰ˆæœ¬ä¸º1.7.1</span></span><br><span class=\"line\">wget https://mirrors.edge.kernel.org/pub/linux/utils/net/bridge-utils/bridge-utils-1.7.1.tar.gz</span><br><span class=\"line\">tar -zxvf bridge-utils-1.7.1.tar.gz</span><br><span class=\"line\"><span class=\"built_in\">cd</span> bridge-utils-1.7.1</span><br><span class=\"line\"><span class=\"comment\"># éœ€è¦å…ˆå®‰è£…ç¼–è¯‘æ‰€éœ€çš„å·¥å…·å’Œä¾èµ–</span></span><br><span class=\"line\">dnf install autoconf automake libtool make -y</span><br><span class=\"line\"><span class=\"comment\"># å› ä¸ºæºç ç›®å½•ä¸­æ²¡æœ‰ configure æ–‡ä»¶ï¼ˆä½†æœ‰ configure.acï¼‰ï¼Œæ‰€ä»¥éœ€è¦å…ˆè¿è¡Œå¦‚ä¸‹å‘½ä»¤ç”Ÿæˆ configure æ–‡ä»¶</span></span><br><span class=\"line\">autoreconf -i</span><br><span class=\"line\"><span class=\"comment\"># é…ç½®</span></span><br><span class=\"line\">./configure</span><br><span class=\"line\"><span class=\"comment\"># ç¼–è¯‘ ä¸” å®‰è£…</span></span><br><span class=\"line\">make &amp;&amp; make install</span><br><span class=\"line\"><span class=\"comment\"># æ·»åŠ åˆ°ç¯å¢ƒå˜é‡</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;export PATH=<span class=\"variable\">$PATH</span>:/usr/local/sbin&quot;</span> &gt;&gt; ~/.bashrc</span><br><span class=\"line\"><span class=\"built_in\">source</span> ~/.bashrc</span><br><span class=\"line\">brctl --version</span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡ºç»“æœ</span></span><br><span class=\"line\">bridge-utils, 1.7</span><br></pre></td></tr></table></figure>\n</div>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Docker é»˜è®¤çš„ bridge ç½‘ç»œå’Œ Linux å†…æ ¸ä¸­çš„ docker0 ç½‘æ¡¥æ˜¯ä¸€ä¸€å¯¹åº”çš„å…³ç³»ã€‚bridge æ˜¯ Docker å¯¹ç½‘ç»œçš„å‘½åï¼Œè€Œ docker0 æ˜¯å†…æ ¸ä¸­ç½‘æ¡¥çš„åå­—ã€‚<br>\n<img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/wjWiNA.png\" alt=\"\"></p>\n</li>\n<li class=\"lvl-2\">\n<p>docker0è´Ÿè´£ç»™è¿æ¥å…¶ä¸Šçš„å®¹å™¨åˆ†é…ipåœ°å€ï¼Œå¹¶ä¸”æ˜¯æ¯ä¸ªå®¹å™¨çš„é»˜è®¤ç½‘å…³ã€‚å½“å®¹å™¨éœ€è¦è®¿é—®å¤–ç½‘æ—¶ï¼Œä¼šé€šè¿‡docker0è½¬åˆ°å®¿ä¸»æœºçš„eth0ä¸Šï¼Œæ‰€ä»¥åªè¦å®¿ä¸»æœºå¯ä»¥è®¿é—®å¤–ç½‘ï¼Œé‚£ä¹ˆå®¹å™¨ä¹Ÿå¯ä»¥è®¿é—®å¤–ç½‘ã€‚</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹å®¿ä¸»æœºçš„è·¯ç”±è¡¨</span></span><br><span class=\"line\">$ route -n</span><br><span class=\"line\">Kernel IP routing table</span><br><span class=\"line\">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class=\"line\">0.0.0.0         10.250.0.1      0.0.0.0         UG    100    0        0 eth0</span><br><span class=\"line\">10.250.0.0      0.0.0.0         255.255.255.0   U     100    0        0 eth0</span><br><span class=\"line\">172.17.0.0      0.0.0.0         255.255.0.0     U     0      0        0 docker0</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹ap1å®¹å™¨çš„è·¯ç”±è¡¨</span></span><br><span class=\"line\">$ docker <span class=\"built_in\">exec</span> -it ap1 route -n</span><br><span class=\"line\">Kernel IP routing table</span><br><span class=\"line\">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class=\"line\">0.0.0.0         172.17.0.1      0.0.0.0         UG    0      0        0 eth0</span><br><span class=\"line\">172.17.0.0      0.0.0.0         255.255.0.0     U     0      0        0 eth0</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Docker Container çš„ bridge æ¡¥æ¥æ¨¡å¼å¯ä»¥å‚è€ƒä¸‹å›¾<br>\n<img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/32fupw.png\" alt=\"\"></p>\n</li>\n</ul>\n<h2 id=\"docker-network-ç›¸å…³å‘½ä»¤\"><code>docker network</code> ç›¸å…³å‘½ä»¤</h2>\n<table>\n<thead>\n<tr>\n<th>å‘½ä»¤</th>\n<th>åŠŸèƒ½è¯´æ˜</th>\n<th>ç¤ºä¾‹</th>\n<th>ç¤ºä¾‹è¾“å‡ºï¼ˆç®€ç•¥ï¼‰</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>docker network ls</code></td>\n<td>åˆ—å‡ºæ‰€æœ‰ Docker ç½‘ç»œ</td>\n<td><code>docker network ls</code></td>\n<td><code>bridge</code>, <code>host</code>, <code>none</code> ç­‰ç½‘ç»œåç§°</td>\n</tr>\n<tr>\n<td><code>docker network inspect &lt;ç½‘ç»œå&gt;</code></td>\n<td>æŸ¥çœ‹æŒ‡å®šç½‘ç»œçš„è¯¦ç»†ä¿¡æ¯ï¼ˆå¦‚ IP èŒƒå›´ã€è¿æ¥å®¹å™¨ç­‰ï¼‰</td>\n<td><code>docker network inspect bridge</code></td>\n<td>æ˜¾ç¤º JSONï¼Œå«å­ç½‘ã€ç½‘å…³ã€å®¹å™¨ç­‰ä¿¡æ¯</td>\n</tr>\n<tr>\n<td><code>docker network create &lt;ç½‘ç»œå&gt;</code></td>\n<td>åˆ›å»ºè‡ªå®šä¹‰ç½‘ç»œï¼ˆé»˜è®¤æ¡¥æ¥ï¼‰</td>\n<td><code>docker network create my-net</code></td>\n<td><code>my-net</code> ç½‘ç»œ ID</td>\n</tr>\n<tr>\n<td><code>docker network rm &lt;ç½‘ç»œå&gt;</code></td>\n<td>åˆ é™¤ç½‘ç»œï¼ˆä¸èƒ½æœ‰å®¹å™¨è¿æ¥ï¼‰</td>\n<td><code>docker network rm my-net</code></td>\n<td>æˆåŠŸåˆ é™¤æ— æç¤ºï¼Œå¤±è´¥ä¼šæœ‰é”™è¯¯ä¿¡æ¯</td>\n</tr>\n<tr>\n<td><code>docker network connect &lt;ç½‘ç»œå&gt; &lt;å®¹å™¨å&gt;</code></td>\n<td>å°†ä¸€ä¸ªå®¹å™¨è¿æ¥åˆ°æŒ‡å®šç½‘ç»œ</td>\n<td><code>docker network connect my-net my-container</code></td>\n<td>æ— è¾“å‡ºï¼Œå®¹å™¨è¿æ¥æˆåŠŸ</td>\n</tr>\n<tr>\n<td><code>docker network disconnect &lt;ç½‘ç»œå&gt; &lt;å®¹å™¨å&gt;</code></td>\n<td>å°†å®¹å™¨ä»ç½‘ç»œä¸­æ–­å¼€è¿æ¥</td>\n<td><code>docker network disconnect my-net my-container</code></td>\n<td>æ— è¾“å‡ºï¼Œæ–­å¼€æˆåŠŸ</td>\n</tr>\n<tr>\n<td><code>docker network prune</code></td>\n<td>åˆ é™¤æ‰€æœ‰æœªä½¿ç”¨çš„ç½‘ç»œï¼ˆæ…ç”¨ï¼‰</td>\n<td><code>docker network prune</code></td>\n<td>ä¼šæç¤ºæ˜¯å¦ç¡®è®¤ï¼Œæ¸…ç†æœªä½¿ç”¨ç½‘ç»œ</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"docker-network-create-åˆ›å»ºç½‘ç»œ\"><code>docker network create</code> : åˆ›å»ºç½‘ç»œ</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>è¯­æ³•</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker network create [OPTIONS] NETWORK_NAME</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å¸¸ç”¨å‚æ•°è¯´æ˜è¡¨</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>å‚æ•°</th>\n<th>è¯´æ˜</th>\n<th>ç¤ºä¾‹</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>--driver</code> æˆ– <code>-d</code></td>\n<td>æŒ‡å®šç½‘ç»œé©±åŠ¨ç±»å‹ï¼Œå¦‚ <code>bridge</code>, <code>overlay</code>, <code>macvlan</code>, <code>host</code>, <code>none</code></td>\n<td><code>--driver bridge</code></td>\n</tr>\n<tr>\n<td><code>--subnet</code></td>\n<td>æŒ‡å®šå­ç½‘åœ°å€èŒƒå›´ï¼ˆCIDRï¼‰</td>\n<td><code>--subnet 192.168.100.0/24</code></td>\n</tr>\n<tr>\n<td><code>--gateway</code></td>\n<td>æŒ‡å®šç½‘å…³ IP åœ°å€</td>\n<td><code>--gateway 192.168.100.1</code></td>\n</tr>\n<tr>\n<td><code>--ip-range</code></td>\n<td>æŒ‡å®šå¯åˆ†é…çš„ IP èŒƒå›´</td>\n<td><code>--ip-range 192.168.100.0/25</code></td>\n</tr>\n<tr>\n<td><code>--aux-address</code></td>\n<td>ä¿ç•™æŸäº› IP åœ°å€ä¸è¢«åˆ†é…</td>\n<td><code>--aux-address=&quot;reserved=192.168.100.254&quot;</code></td>\n</tr>\n<tr>\n<td><code>--internal</code></td>\n<td>åˆ›å»ºä¸€ä¸ªå†…éƒ¨ç½‘ç»œï¼ˆä¸èƒ½è®¿é—®å¤–éƒ¨ï¼‰</td>\n<td><code>--internal</code></td>\n</tr>\n<tr>\n<td><code>--attachable</code></td>\n<td>åˆ›å»ºå¯ä¾›å•ç‹¬å®¹å™¨è¿æ¥çš„ç½‘ç»œï¼ˆSwarm ä¸­ï¼‰</td>\n<td><code>--attachable</code></td>\n</tr>\n<tr>\n<td><code>--label</code></td>\n<td>æ·»åŠ æ ‡ç­¾</td>\n<td><code>--label env=dev</code></td>\n</tr>\n<tr>\n<td><code>--opt</code></td>\n<td>æä¾›è‡ªå®šä¹‰é©±åŠ¨é€‰é¡¹</td>\n<td><code>--opt encrypted=true</code></td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>--driver</code> æˆ– <code>-d</code> : å¸¸è§çš„ Docker ç½‘ç»œé©±åŠ¨ç±»å‹</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>ç±»å‹</th>\n<th>å«ä¹‰</th>\n<th>æ˜¯å¦æ”¯æŒç«¯å£æ˜ å°„</th>\n<th>ç‰¹ç‚¹ä¸åº”ç”¨åœºæ™¯</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>bridge</code>ï¼ˆé»˜è®¤ï¼‰</td>\n<td>é»˜è®¤çš„æ¡¥æ¥ç½‘ç»œï¼Œå®¹å™¨é€šè¿‡è™šæ‹Ÿç½‘æ¡¥è¿æ¥ï¼Œå…±äº«å®¿ä¸»æœºçš„ç½‘ç»œæ¥å£ã€‚</td>\n<td>âœ… æ˜¯</td>\n<td>é»˜è®¤æ¨¡å¼ï¼Œé€‚ç”¨äºå•ä¸»æœºéƒ¨ç½²ã€å¤šä¸ªå®¹å™¨éœ€è¦äº’é€šçš„åœºæ™¯ã€‚å¯æ˜ å°„ç«¯å£å¯¹å¤–è®¿é—®ã€‚</td>\n</tr>\n<tr>\n<td><code>host</code></td>\n<td>å®¹å™¨ä¸å®¿ä¸»æœºå…±ç”¨ç½‘ç»œå‘½åç©ºé—´ï¼Œå®¹å™¨ç›´æ¥ä½¿ç”¨å®¿ä¸»æœºçš„ IP å’Œç«¯å£ã€‚</td>\n<td>âŒ å¦</td>\n<td>æ— ç½‘ç»œéš”ç¦»ï¼Œæ€§èƒ½é«˜ï¼Œé€‚ç”¨äºé«˜æ€§èƒ½ã€ä½å»¶è¿Ÿåœºæ™¯ï¼ˆå¦‚æ¸¸æˆæœåŠ¡å™¨ï¼‰ã€‚</td>\n</tr>\n<tr>\n<td><code>none</code></td>\n<td>å®¹å™¨æ²¡æœ‰ç½‘ç»œæ¥å£ï¼Œå®Œå…¨éš”ç¦»ã€‚</td>\n<td>âŒ å¦</td>\n<td>ç”¨äºå®‰å…¨æ€§æˆ–æµ‹è¯•ç½‘ç»œä¸å¯è¾¾åœºæ™¯ã€‚</td>\n</tr>\n<tr>\n<td><code>macvlan</code></td>\n<td>ä¸ºå®¹å™¨åˆ†é…ç‹¬ç«‹ MAC å’Œ IPï¼Œå®¹å™¨åƒç‰©ç†ä¸»æœºä¸€æ ·å‡ºç°åœ¨å±€åŸŸç½‘ä¸­ã€‚</td>\n<td>âœ… æ˜¯ï¼ˆå°‘è§ï¼‰</td>\n<td>é€‚ç”¨äºå®¹å™¨å¿…é¡»ç›´æ¥æš´éœ²åœ¨ç‰©ç†ç½‘ç»œä¸­çš„åœºæ™¯ï¼ˆå¦‚ DHCP æœåŠ¡ã€ARP å¹¿æ’­ï¼‰ã€‚</td>\n</tr>\n<tr>\n<td><code>ipvlan</code>ï¼ˆé«˜çº§ï¼‰</td>\n<td>ç±»ä¼¼ macvlanï¼Œä½†ä¸ä½¿ç”¨è™šæ‹Ÿ MAC åœ°å€ã€‚</td>\n<td>âœ… æ˜¯ï¼ˆå°‘è§ï¼‰</td>\n<td>é«˜çº§ç½‘ç»œæ–¹æ¡ˆï¼Œé€‚ç”¨äºå¯¹ç½‘ç»œæ‹“æ‰‘ç²¾ç»†æ§åˆ¶çš„åœºæ™¯ã€‚</td>\n</tr>\n<tr>\n<td><code>overlay</code></td>\n<td>ç”¨äºå¤šä¸»æœºä¹‹é—´å®¹å™¨é€šä¿¡ï¼Œéœ€è¦ Docker Swarm æ”¯æŒã€‚</td>\n<td>âœ… æ˜¯ï¼ˆSwarmï¼‰</td>\n<td>è·¨ä¸»æœºéƒ¨ç½²æœåŠ¡çš„å¿…è¦æ‰‹æ®µï¼Œé€‚åˆå®¹å™¨ç¼–æ’å¹³å°ï¼ˆå¦‚ Swarmã€Kubernetesï¼‰ã€‚</td>\n</tr>\n</tbody>\n</table>\n<blockquote>\n<p>å‰é¢æˆ‘ä»¬è¯´è¿‡ï¼ŒDockerä¼šè‡ªåŠ¨åˆ›å»ºä¸‰ä¸ªç½‘ç»œï¼Œå³ï¼šbridgeã€hostã€noneã€‚å¯¹äºå•å°å®¿ä¸»æœºçš„åœºæ™¯ï¼Œç»å¤§å¤šæ•°æƒ…å†µä¸‹æˆ‘ä»¬éƒ½åªä¼šä½¿ç”¨bridgeç½‘ç»œã€‚</p>\n</blockquote>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ç¤ºä¾‹</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># åˆ›å»ºä¸€ä¸ªåä¸ºmy-networkçš„ç½‘ç»œ</span></span><br><span class=\"line\">$ docker network create my-network</span><br><span class=\"line\"><span class=\"comment\"># ç­‰åŒäºï¼Œå› ä¸ºé»˜è®¤çš„ç½‘ç»œé©±åŠ¨ä¸ºbridge</span></span><br><span class=\"line\">$ docker network create --driver bridge my-network</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹ç½‘ç»œï¼Œå¯ä»¥çœ‹åˆ°æ–°å»ºçš„ç½‘ç»œçš„é©±åŠ¨ä¸ºbridge</span></span><br><span class=\"line\">$ docker network <span class=\"built_in\">ls</span> -f name=my-network</span><br><span class=\"line\">NETWORK ID     NAME         DRIVER    SCOPE</span><br><span class=\"line\">c2dbe1686790   my-network   bridge    <span class=\"built_in\">local</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹å®¿ä¸»æœºçš„ç½‘æ¡¥ä¿¡æ¯</span></span><br><span class=\"line\">$ brctl show</span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡ºï¼Œå¯ä»¥çœ‹åˆ°æ­¤æ—¶æœ‰ä¸€ä¸ªç½‘æ¡¥è®¾å¤‡ br-c2dbe1686790ï¼Œbr: bridgeï¼Œc2dbe1686790ï¼šnetwork id</span></span><br><span class=\"line\">bridge name\t      bridge <span class=\"built_in\">id</span>\t\t          STP enabled\t    interfaces</span><br><span class=\"line\">br-c2dbe1686790\t      8000.02425be81fae\t          no</span><br><span class=\"line\">docker0\t\t      8000.0242d6d509b1\t          no\t\t    vethc0e0cc3</span><br><span class=\"line\">\t\t\t\t\t\t\t            vethf4b7577</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹å®¿ä¸»æœºçš„ç½‘å¡</span></span><br><span class=\"line\">$ ip addr</span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡ºï¼Œbr-c2dbe1686790 ç½‘å¡åç§°ï¼Œå…¶IPç½‘æ®µä¸º 172.18.0.1/16</span></span><br><span class=\"line\">13: br-c2dbe1686790: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default</span><br><span class=\"line\">    <span class=\"built_in\">link</span>/ether 02:42:5b:e8:1f:ae brd ff:ff:ff:ff:ff:ff</span><br><span class=\"line\">    inet 172.18.0.1/16 brd 172.18.255.255 scope global br-c2dbe1686790</span><br><span class=\"line\">       valid_lft forever preferred_lft forever</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># å¯åŠ¨ä¸¤ä¸ªå®¹å™¨å¹¶æ·»åŠ åˆ°my-networkç½‘ç»œä¸­</span></span><br><span class=\"line\">$ docker run -itd --network my-network --name a1 alpine</span><br><span class=\"line\">$ docker run -itd --network my-network --name a2 alpine</span><br><span class=\"line\"></span><br><span class=\"line\">$ ip addr</span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡º,å¯ä»¥çœ‹åˆ°ä¸¤ä¸ªå®¹å™¨éƒ½æ·»åŠ åˆ°äº†my-networkç½‘ç»œä¸­</span></span><br><span class=\"line\">bridge name\t      bridge <span class=\"built_in\">id</span>\t\t        STP enabled\t    interfaces</span><br><span class=\"line\">br-c2dbe1686790\t\t8000.02425be81fae\t    no\t\t    veth094946c</span><br><span class=\"line\">\t\t\t\t\t\t\t            vetha2ba68a</span><br><span class=\"line\">docker0\t\t        8000.0242d6d509b1\t    no\t\t    vethc0e0cc3</span><br><span class=\"line\">\t\t\t\t\t\t\t            vethf4b7577</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æµ‹è¯•è¿é€šæ€§ï¼Œå¯ä»¥çœ‹åˆ° a1å¯ä»¥pingé€š a2ï¼Œåè¿‡æ¥ a2ä¹Ÿå¯ä»¥pingé€š a1</span></span><br><span class=\"line\">$ docker <span class=\"built_in\">exec</span> -it a1 ping a2</span><br><span class=\"line\">PING a2 (172.18.0.4): 56 data bytes</span><br><span class=\"line\">64 bytes from 172.18.0.4: <span class=\"built_in\">seq</span>=0 ttl=64 time=2.127 ms</span><br><span class=\"line\">64 bytes from 172.18.0.4: <span class=\"built_in\">seq</span>=1 ttl=64 time=0.119 ms</span><br><span class=\"line\"></span><br><span class=\"line\">$ docker ps</span><br><span class=\"line\">CONTAINER ID   IMAGE     COMMAND     CREATED         STATUS         PORTS     NAMES</span><br><span class=\"line\">e0fb0614591e   alpine    <span class=\"string\">&quot;/bin/sh&quot;</span>   4 minutes ago   Up 4 minutes             a2</span><br><span class=\"line\">fc6e9477d2b7   alpine    <span class=\"string\">&quot;/bin/sh&quot;</span>   4 minutes ago   Up 4 minutes             a1</span><br><span class=\"line\">9d3ed5be1916   alpine    <span class=\"string\">&quot;/bin/sh&quot;</span>   4 hours ago     Up 4 hours               ap2</span><br><span class=\"line\">c2436a1d750c   alpine    <span class=\"string\">&quot;/bin/sh&quot;</span>   4 hours ago     Up 4 hours               ap1</span><br><span class=\"line\"><span class=\"comment\"># ä¸åŒç½‘ç»œä¸­çš„å®¹å™¨ä¹‹é—´ä¸èƒ½ç›¸äº’pingé€š</span></span><br><span class=\"line\"><span class=\"comment\">## é€šè¿‡å®¹å™¨åç§°æ— æ³•pingé€š</span></span><br><span class=\"line\">$ docker <span class=\"built_in\">exec</span> -it a1 ping ap1</span><br><span class=\"line\">ping: bad address <span class=\"string\">&#x27;ap1&#x27;</span></span><br><span class=\"line\"><span class=\"comment\">## é€šè¿‡ap1å®¹å™¨IPä¹Ÿæ— æ³•pingé€šï¼Œè¿™å°±å®ç°äº†ä¸åŒç½‘ç»œä¸­çš„ç½‘ç»œéš”ç¦»</span></span><br><span class=\"line\">$ docker <span class=\"built_in\">exec</span> -it a1 ping 172.17.0.2</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å¦‚æœåˆ›å»ºç½‘ç»œæ—¶æ²¡æœ‰æŒ‡å®šå­ç½‘ï¼Œåˆ™ä»<code>docker0</code>çš„<code>172.17.0.0/16</code>å¾€åæ’ï¼Œæ¯”å¦‚æˆ‘ä»¬ä¸Šé¢åˆ›å»ºçš„<code>my-network</code>ï¼Œå…¶å­ç½‘å°±æ˜¯<code>172.18.0.0/16</code>ï¼Œå¦‚ä¸‹å‘½ä»¤åˆ›å»ºä¸€ä¸ªbridgeç½‘ç»œï¼Œå¹¶æŒ‡å®šå­ç½‘ã€ç½‘å…³ç­‰ä¿¡æ¯</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ docker network create \\</span><br><span class=\"line\">  --driver bridge \\</span><br><span class=\"line\">  --subnet 192.168.50.0/24 \\</span><br><span class=\"line\">  --gateway 192.168.50.1 \\</span><br><span class=\"line\">  my-custom-net</span><br></pre></td></tr></table></figure>\n<h4 id=\"bridge-æ€»ç»“\"><code>bridge</code> æ€»ç»“</h4>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>é»˜è®¤åˆ›å»ºçš„ <code>docker0</code> ç½‘ç»œï¼Œæ˜¯ä¸€ä¸ªæ¡¥æ¥ç½‘ç»œï¼Œåœ¨ docker network ä¸­çš„åç§°ä¸º <code>bridge</code>ï¼Œè¯¥ç½‘ç»œä¸‹çš„å®¹å™¨å¯ä»¥é€šè¿‡IPåœ°å€ç›¸äº’è®¿é—®ï¼Œä½†ä¸èƒ½é€šè¿‡å®¹å™¨åç§°è®¿é—®</p>\n</li>\n<li class=\"lvl-2\">\n<p>é€šè¿‡<code>docker network create &lt;ç½‘ç»œåç§°&gt;</code>åˆ›å»ºçš„ç½‘ç»œä¹Ÿæ˜¯ä¸€ä¸ªæ¡¥æ¥ç½‘ç»œï¼Œåœ¨è¿™ä¸ªç½‘ç»œä¸‹ï¼Œå®¹å™¨å¯ä»¥é€šè¿‡IPåœ°å€ç›¸äº’è®¿é—®ï¼Œä¹Ÿèƒ½é€šè¿‡å®¹å™¨åç§°è®¿é—®ã€‚</p>\n</li>\n</ul>\n<h3 id=\"docker-network-ls-åˆ—å‡ºæ‰€æœ‰ç½‘ç»œ\"><code>docker network ls</code> : åˆ—å‡ºæ‰€æœ‰ç½‘ç»œ</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># åˆ—å‡ºæ‰€æœ‰ç½‘ç»œ</span></span><br><span class=\"line\">$ docker network <span class=\"built_in\">ls</span></span><br><span class=\"line\"><span class=\"comment\"># è¾“å‡ºæŒ‡å®šçš„ä¿¡æ¯</span></span><br><span class=\"line\">$ docker network <span class=\"built_in\">ls</span> --format <span class=\"string\">&quot;table &#123;&#123;.ID&#125;&#125;\\t&#123;&#123;.Name&#125;&#125;\\t&#123;&#123;.Scope&#125;&#125;&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># è¾“å‡ºjsonæ ¼å¼</span></span><br><span class=\"line\">$ docker network <span class=\"built_in\">ls</span> --format <span class=\"string\">&quot;json&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># è¿‡æ»¤</span></span><br><span class=\"line\">$ docker network <span class=\"built_in\">ls</span> -f <span class=\"string\">&quot;driver=bridge&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># ä¸æˆªæ–­è¾“å‡º</span></span><br><span class=\"line\">$ docker network <span class=\"built_in\">ls</span> --no-trunc</span><br><span class=\"line\"><span class=\"comment\"># åªæ˜¾ç¤ºnetwork id</span></span><br><span class=\"line\">$ docker network <span class=\"built_in\">ls</span> -q</span><br></pre></td></tr></table></figure>\n<h3 id=\"docker-network-inspect-æŸ¥çœ‹ç½‘ç»œè¯¦æƒ…\"><code>docker network inspect</code> : æŸ¥çœ‹ç½‘ç»œè¯¦æƒ…</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹åç§°ä¸ºbridgeç½‘ç»œè¯¦æƒ…</span></span><br><span class=\"line\">$ docker network inspect bridge</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹å½“å‰ç½‘ç»œä¸‹æœ‰å“ªäº›å®¹å™¨</span></span><br><span class=\"line\">$ docker network inspect bridge --format <span class=\"string\">&quot;&#123;&#123;.Containers&#125;&#125;&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># è¾“å‡ºjsonæ ¼å¼</span></span><br><span class=\"line\">$ docker network inspect bridge --format <span class=\"string\">&quot;json&quot;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"docker-network-prune-æ¸…ç†æ²¡ç”¨çš„ç½‘ç»œ\"><code>docker network prune</code> : æ¸…ç†æ²¡ç”¨çš„ç½‘ç»œ</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># åˆ é™¤æ‰€æœ‰æœªä½¿ç”¨çš„ç½‘ç»œ</span></span><br><span class=\"line\">$ docker network prune</span><br><span class=\"line\"><span class=\"comment\"># åˆ é™¤æ‰€æœ‰æœªä½¿ç”¨çš„ç½‘ç»œï¼Œæ— éœ€ç¡®è®¤</span></span><br><span class=\"line\">$ docker network prune -f</span><br><span class=\"line\"><span class=\"comment\"># æ¸…ç†24å°æ—¶å†…æœªä½¿ç”¨çš„ç½‘ç»œ</span></span><br><span class=\"line\">$ docker network prune --filter <span class=\"string\">&quot;until=24h&quot;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"docker-network-rm-åˆ é™¤ç½‘ç»œ\"><code>docker network rm</code> : åˆ é™¤ç½‘ç»œ</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># åˆ é™¤æŒ‡å®šçš„ç½‘ç»œ</span></span><br><span class=\"line\">$ docker network <span class=\"built_in\">rm</span> &lt;network-name&gt;</span><br><span class=\"line\"><span class=\"comment\"># åˆ é™¤æ‰€æœ‰ç½‘ç»œ</span></span><br><span class=\"line\">$ docker network <span class=\"built_in\">rm</span> $(docker network <span class=\"built_in\">ls</span> -q)</span><br><span class=\"line\"><span class=\"comment\"># åˆ é™¤æ‰€æœ‰bridgeç½‘ç»œï¼Œè¿™é‡Œè¦æ³¨æ„ï¼Œdockeré»˜è®¤åˆ›å»ºçš„3ä¸ªç½‘ç»œæ˜¯åˆ é™¤ä¸æ‰çš„</span></span><br><span class=\"line\">$ docker network <span class=\"built_in\">rm</span> $(docker network <span class=\"built_in\">ls</span> -q -f driver=bridge)</span><br></pre></td></tr></table></figure>\n<h3 id=\"docker-network-connect-å°†å®¹å™¨è¿æ¥åˆ°ç½‘ç»œ\"><code>docker network connect</code> : å°†å®¹å™¨è¿æ¥åˆ°ç½‘ç»œ</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># å°†å®¹å™¨è¿æ¥åˆ°ç½‘ç»œï¼Œå¦‚æœå®¹å™¨å¯åŠ¨æ—¶å¿˜è®°è¿æ¥ç½‘ç»œï¼Œè¿™é‡Œå¯ä»¥æ‰‹åŠ¨æ·»åŠ </span></span><br><span class=\"line\">$ docker network connect &lt;network-name&gt; &lt;container-name&gt;</span><br></pre></td></tr></table></figure>\n<h3 id=\"docker-network-disconnect-å°†å®¹å™¨ä»ç½‘ç»œæ–­å¼€\"><code>docker network disconnect</code> : å°†å®¹å™¨ä»ç½‘ç»œæ–­å¼€</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ docker network disconnect &lt;network-name&gt; &lt;container-name&gt;</span><br></pre></td></tr></table></figure>\n<h2 id=\"æœ¬æ–‡æ€»ç»“\">æœ¬æ–‡æ€»ç»“</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å®¹å™¨ä¸ç½‘ç»œæ˜¯å¤šå¯¹å¤šçš„å…³ç³»ï¼Œå³ä¸€ä¸ªç½‘ç»œå¯ä»¥æœ‰å¤šä¸ªå®¹å™¨ï¼Œä¸€ä¸ªå®¹å™¨ä¹Ÿå¯ä»¥è¿æ¥åˆ°å¤šä¸ªç½‘ç»œã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>docker0 æ˜¯ docker é»˜è®¤åˆ›å»ºçš„ç½‘ç»œï¼Œä¸æŒ‡å®šç½‘ç»œçš„æƒ…å†µä¸‹æ‰€æœ‰å®¹å™¨éƒ½è¿æ¥åˆ° docker0 ç½‘ç»œã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>docker0 æ˜¯ bridge ç½‘ç»œï¼Œè¯¥ç½‘ç»œä¸­çš„å®¹å™¨ä¹‹é—´å¯ä»¥é€šè¿‡ IP äº’ç›¸è®¿é—®ï¼Œä½†ä¸èƒ½é€šè¿‡å®¹å™¨åç§°è®¿é—®ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>è‡ªå»ºçš„ bridge ç½‘ç»œä¸­çš„å®¹å™¨å¯ä»¥é€šè¿‡å®¹å™¨åç§°ï¼ˆæˆ–å®¹å™¨IDï¼Œä½†ä¸å¸¸ç”¨ï¼‰è®¿é—®ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>ä¸åŒçš„ bridge ç½‘ç»œä¸­çš„å®¹å™¨ä¸èƒ½äº’ç›¸è®¿é—®ã€‚</p>\n</li>\n</ul>\n<h2 id=\"link-vs-network\"><code>--link</code> vs <code>--network</code></h2>\n<table>\n<thead>\n<tr>\n<th>é¡¹ç›®</th>\n<th><code>--link</code></th>\n<th><code>--network</code></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>åŠŸèƒ½</td>\n<td>å°†ä¸€ä¸ªå®¹å™¨é“¾æ¥åˆ°å¦ä¸€ä¸ªå®¹å™¨ï¼Œå¹¶è®¾ç½®ç¯å¢ƒå˜é‡å’Œä¸»æœºåæ˜ å°„</td>\n<td>å°†å®¹å™¨åŠ å…¥åˆ°ä¸€ä¸ªè‡ªå®šä¹‰ç½‘ç»œä¸­ï¼Œå®ç°çµæ´»ã€éš”ç¦»çš„ç½‘ç»œé€šä¿¡</td>\n</tr>\n<tr>\n<td>æ˜¯å¦æ¨è</td>\n<td>âŒ ä¸æ¨èï¼ˆå·²åºŸå¼ƒï¼‰</td>\n<td>âœ… æ¨èä½¿ç”¨</td>\n</tr>\n<tr>\n<td>ç½‘ç»œéš”ç¦»</td>\n<td>åŸºäºé»˜è®¤ <code>bridge</code> ç½‘ç»œï¼Œéš”ç¦»æ€§å·®</td>\n<td>å¯ä»¥åˆ›å»ºè‡ªå®šä¹‰ç½‘ç»œï¼ˆbridgeã€overlay ç­‰ï¼‰ï¼Œéš”ç¦»æ€§å¼º</td>\n</tr>\n<tr>\n<td>å¯æ‰©å±•æ€§</td>\n<td>åªé€‚ç”¨äºå·²è¿è¡Œçš„å®¹å™¨ï¼Œè¿æ¥å›ºå®š</td>\n<td>æ”¯æŒå¤šä¸ªå®¹å™¨ï¼Œçµæ´»ç»„åˆå’ŒåŠ¨æ€æ‰©å±•</td>\n</tr>\n<tr>\n<td>DNS æ”¯æŒ</td>\n<td>ä»…è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œä¸æ”¯æŒè‡ªåŠ¨ DNS</td>\n<td>è‡ªå®šä¹‰ç½‘ç»œä¸­æ”¯æŒå®¹å™¨åç§°ä½œä¸º DNS åç§°</td>\n</tr>\n<tr>\n<td>ç”Ÿå‘½å‘¨æœŸ</td>\n<td>ä¸€æ–¹å®¹å™¨å…³é—­ï¼Œå¦ä¸€æ–¹ä»ä¿å­˜è¿‡æ—¶é“¾æ¥</td>\n<td>ç½‘ç»œå­˜åœ¨å³å¯ï¼Œå®¹å™¨ç”Ÿå‘½å‘¨æœŸä¸äº’ç›¸å½±å“</td>\n</tr>\n<tr>\n<td>å®‰å…¨æ€§</td>\n<td>æ‰€æœ‰å®¹å™¨å…±äº« bridgeï¼Œå®¹æ˜“ç›¸äº’è®¿é—®</td>\n<td>è‡ªå®šä¹‰ç½‘ç»œé—´é»˜è®¤éš”ç¦»ï¼Œå®‰å…¨æ€§æ›´å¥½</td>\n</tr>\n</tbody>\n</table>\n","content_text":"æ‘˜è¦ æœ¬æ–‡ä»‹ç» Docker å‘½ä»¤ ä¸­ ç½‘ç»œç®¡ç† ç›¸å…³å‘½ä»¤ Dockerå®˜æ–¹æ–‡æ¡£ ä»€ä¹ˆæ˜¯Network(ç½‘ç»œ)? åœ¨ Docker ä¸­ï¼Œç½‘ç»œï¼ˆNetworkï¼‰ æ˜¯å®¹å™¨ä¹‹é—´é€šä¿¡ã€å®¹å™¨ä¸å¤–éƒ¨é€šä¿¡çš„é‡è¦æœºåˆ¶ã€‚Docker æä¾›äº†ä¸€å¥—çµæ´»çš„ç½‘ç»œæ¨¡å‹ï¼Œä½¿å¾—ä½ å¯ä»¥è‡ªç”±é…ç½®å®¹å™¨çš„ç½‘ç»œç¯å¢ƒä»¥é€‚é…ä¸åŒåœºæ™¯ã€‚ å®‰è£…dockeræ—¶ï¼Œä¼šè‡ªåŠ¨åœ¨å®¿ä¸»æœºä¸Šå®‰è£…ä¸€ä¸ª docker0 ç½‘ç»œè®¾å¤‡ï¼Œå®ƒæ˜¯ä¸€ä¸ªç½‘æ¡¥è®¾å¤‡ï¼Œç”¨äº Docker å„å®¹å™¨åŠå®¿ä¸»æœºçš„ç½‘ç»œé€šä¿¡ã€‚ 123456789101112131415161718192021222324252627# æŸ¥çœ‹å®¿ä¸»æœºç½‘å¡ä¿¡æ¯ï¼Œå¯ä»¥æ‰¾åˆ°docker0$ ip addr# è¾“å‡º1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 inet 127.0.0.1/8 scope host lo valid_lft forever preferred_lft forever inet6 ::1/128 scope host valid_lft forever preferred_lft forever2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 9001 qdisc mq state UP group default qlen 1000 link/ether 0a:6b:88:11:66:39 brd ff:ff:ff:ff:ff:ff inet 10.250.0.205/24 brd 10.250.0.255 scope global dynamic noprefixroute eth0 valid_lft 3076sec preferred_lft 3076sec inet6 fe80::86b:88ff:fe11:6639/64 scope link valid_lft forever preferred_lft forever3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default link/ether 02:42:d6:d5:09:b1 brd ff:ff:ff:ff:ff:ff inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0 valid_lft forever preferred_lft forever inet6 fe80::42:d6ff:fed5:9b1/64 scope link valid_lft forever preferred_lft forever## è¯´æ˜eth0 å®¿ä¸»æœºçš„ipåœ°å€æ˜¯ 10.250.0.205docker0 æœ¬èº«çš„ipåœ°å€æ˜¯ 172.17.0.1docker0 çš„å­ç½‘æ©ç æ˜¯ 255.255.0.0docker0 çš„å¹¿æ’­åœ°å€æ˜¯ 172.17.255.255docker0 å¯ä»¥ä¸ºå®¹å™¨åˆ†é…çš„ipåœ°å€èŒƒå›´æ˜¯ 172.17.0.2-172.17.255.254ï¼Œæ€»è®¡65534ä¸ªipåœ°å€ æ—¢ç„¶docker0æ˜¯ä¸€ä¸ªç½‘æ¡¥è®¾å¤‡ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤æ¥æŸ¥çœ‹ç½‘æ¡¥çš„è¯¦ç»†ä¿¡æ¯ï¼š 12345$ brctl show## è¾“å‡ºç»“æœbrctl showbridge name bridge id STP enabled interfacesdocker0 8000.0242d6d509b1 no å¯åŠ¨dockeræœåŠ¡åï¼Œdockerå°±ä¸ºæˆ‘ä»¬è‡ªåŠ¨åˆ›å»ºäº†ä¸‰ä¸ªç½‘ç»œï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹ 12345$ docker network lsNETWORK ID NAME DRIVER SCOPE4182e112bf34 bridge bridge local958daf8a8a0d host host local4674a17c6617 none null local è¿™é‡ŒNAMEä¸ºbridgeçš„ç½‘ç»œå°±æ˜¯ä¸docker0è®¾å¤‡ç›¸å¯¹åº”çš„ç½‘ç»œï¼Œå…¶ä¹Ÿæ˜¯dockeré»˜è®¤çš„ç½‘ç»œï¼Œå¦‚æœåˆ›å»ºçš„å®¹å™¨æ²¡æœ‰æŒ‡å®šç½‘ç»œï¼Œé‚£ä¹ˆå®¹å™¨å°±ä¼šåŠ å…¥è¿™ä¸ª bridge ç½‘ç»œã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081# å¯åŠ¨ä¸€ä¸ªå®¹å™¨ï¼Œæ²¡æœ‰æŒ‡å®šç½‘ç»œdocker run -itd --name ap1 alpine# æ­¤æ—¶åœ¨å®¿ä¸»æœºä¸ŠæŸ¥çœ‹ç½‘å¡ä¿¡æ¯ï¼Œä¼šçœ‹åˆ°å¤šå‡ºä¸€ä¸ªè®¾å¤‡ip addr## è¾“å‡ºç»“æœ10: vethc0e0cc3@if9: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker0 state UP group default link/ether c6:0d:02:c8:df:a4 brd ff:ff:ff:ff:ff:ff link-netnsid 0 inet6 fe80::c40d:2ff:fec8:dfa4/64 scope link valid_lft forever preferred_lft forever# æŸ¥çœ‹å®¹å™¨çš„ç½‘å¡ä¿¡æ¯docker exec -it ap1 ip addr## è¾“å‡ºç»“æœ9: eth0@if10: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue state UP link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0 valid_lft forever preferred_lft forever## æ­¤æ—¶èªæ˜çš„ä½ å·²ç»å‘ç°äº†ï¼šå®¿ä¸»æœºçš„ç½‘å¡ä¸å®¹å™¨çš„ç½‘å¡æ˜¯æˆå¯¹å‡ºç°çš„ï¼Œå¹¶ä¸”åŸºäºåºå·è¿›è¡Œå…³è”å®¿ä¸»æœº: 10 : veth c0e0cc3 @ if 9 # åºå· 10 ä¸ å®¹å™¨åç¼€çš„ 10 åŒ¹é…ï¼Œveth æ˜¯è™šæ‹Ÿç½‘å¡ï¼Œc0e0cc3 æ˜¯éšæœºå­—ç¬¦ä¸²ï¼Œif æ˜¯ interfaceå®¹å™¨: 9 : eth0 @ if 10 # åºå· 9 ä¸å®¿ä¸»æœºçš„åç¼€ 9 åŒ¹é…ï¼Œeth0 æ˜¯å®¹å™¨çš„ç½‘å¡ï¼Œif æ˜¯ interface# æ­¤æ—¶æŸ¥çœ‹å®¿ä¸»æœºçš„ç½‘æ¡¥ä¿¡æ¯brctl show## è¾“å‡ºç»“æœï¼Œå¯ä»¥åœ¨ interfaces ä¸­çœ‹åˆ° vethc0e0cc3ï¼Œè¯´æ˜ vethc0e0cc3 å·²ç»åŠ å…¥åˆ°ç½‘æ¡¥ä¸­bridge name bridge id STP enabled interfacesdocker0 8000.0242d6d509b1 no vethc0e0cc3# æŸ¥çœ‹ç½‘ç»œä¸­çš„å®¹å™¨ä¿¡æ¯ï¼Œè¿™é‡Œ jq æ˜¯ json æ ¼å¼åŒ–ï¼Œå¯ä»¥é€šè¿‡ dnf install jq -y å®‰è£…docker network inspect bridge --format &#x27;&#123;&#123;json .Containers&#125;&#125;&#x27; | jq## è¾“å‡ºç»“æœ&#123; &quot;c2436a1d750cc3de3a6f8ab8a693af25b3371aa8f7f168d5561538dcd4a8ff2d&quot;: &#123; &quot;Name&quot;: &quot;ap1&quot;, &quot;EndpointID&quot;: &quot;75469fddbbdeb8b7a328c1a1c3cc7070bb1a3e102f5fb97cc332dcbc22829af5&quot;, &quot;MacAddress&quot;: &quot;02:42:ac:11:00:02&quot;, &quot;IPv4Address&quot;: &quot;172.17.0.2/16&quot;, &quot;IPv6Address&quot;: &quot;&quot; &#125;&#125;# è·å–å®¹å™¨çš„ IP åœ°å€docker exec ap1 hostname -i## è¾“å‡ºç»“æœ172.17.0.2# ç›¸åŒç½‘ç»œè®¾å¤‡ä¸‹çš„å®¹å™¨å¯ä»¥é€šè¿‡ IP åœ°å€é€šä¿¡# æˆ‘ä»¬å†åˆ›å»ºä¸€ä¸ªå®¹å™¨ï¼Œå¹¶æŸ¥çœ‹èƒ½å¦æ­£å¸¸é€šä¿¡docker run -itd --name ap2 alpinedocker exec -it ap2 ping 172.17.0.2## è¾“å‡ºç»“æœï¼Œè¯´æ˜å¯ä»¥é€šè¿‡IPåœ°å€é€šä¿¡PING 172.17.0.2 (172.17.0.2): 56 data bytes64 bytes from 172.17.0.2: seq=0 ttl=64 time=0.137 ms64 bytes from 172.17.0.2: seq=1 ttl=64 time=0.084 ms64 bytes from 172.17.0.2: seq=2 ttl=64 time=0.081 ms# æŸ¥çœ‹ç½‘ç»œä¸­çš„å®¹å™¨docker network inspect bridge --format &#x27;&#123;&#123;json .Containers&#125;&#125;&#x27; | jq&#123; &quot;9d3ed5be1916b14ec9befe3649c08cc9de247c595de248600f8ef8d0fc16c5cb&quot;: &#123; &quot;Name&quot;: &quot;ap2&quot;, &quot;EndpointID&quot;: &quot;35615a7ec10842401ad8c40187c792555b5089551a8eca39ddff6734aeba549e&quot;, &quot;MacAddress&quot;: &quot;02:42:ac:11:00:03&quot;, &quot;IPv4Address&quot;: &quot;172.17.0.3/16&quot;, &quot;IPv6Address&quot;: &quot;&quot; &#125;, &quot;c2436a1d750cc3de3a6f8ab8a693af25b3371aa8f7f168d5561538dcd4a8ff2d&quot;: &#123; &quot;Name&quot;: &quot;ap1&quot;, &quot;EndpointID&quot;: &quot;75469fddbbdeb8b7a328c1a1c3cc7070bb1a3e102f5fb97cc332dcbc22829af5&quot;, &quot;MacAddress&quot;: &quot;02:42:ac:11:00:02&quot;, &quot;IPv4Address&quot;: &quot;172.17.0.2/16&quot;, &quot;IPv6Address&quot;: &quot;&quot; &#125;&#125;# æµ‹è¯•æ˜¯å¦å¯ä»¥é€šè¿‡å®¹å™¨åç§°è®¿é—®docker exec -it ap2 ping ap1## è¾“å‡ºï¼Œä¸å¯ä»¥é€šè¿‡å®¹å™¨åç§°è®¿é—®ping: bad address &#x27;ap1&#x27;## å¦‚æœå¸Œæœ›é€šè¿‡å®¹å™¨åç§°è®¿é—®ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ docker network create åˆ›å»ºä¸€ä¸ªæ–°çš„ç½‘ç»œ å¦‚æœæ²¡æœ‰å®‰è£… brctlï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼å®‰è£… 12345678910111213141516171819202122# centos7:yum install bridge-utils -y# centos8: ä¸æ”¯æŒyumæºå®‰è£…ï¼Œéœ€è¦æ‰‹åŠ¨ç¼–è¯‘å®‰è£…# ä¸‹è½½æºç å®‰è£…ï¼Œç›®å‰æœ€æ–°ç‰ˆæœ¬ä¸º1.7.1wget https://mirrors.edge.kernel.org/pub/linux/utils/net/bridge-utils/bridge-utils-1.7.1.tar.gztar -zxvf bridge-utils-1.7.1.tar.gzcd bridge-utils-1.7.1# éœ€è¦å…ˆå®‰è£…ç¼–è¯‘æ‰€éœ€çš„å·¥å…·å’Œä¾èµ–dnf install autoconf automake libtool make -y# å› ä¸ºæºç ç›®å½•ä¸­æ²¡æœ‰ configure æ–‡ä»¶ï¼ˆä½†æœ‰ configure.acï¼‰ï¼Œæ‰€ä»¥éœ€è¦å…ˆè¿è¡Œå¦‚ä¸‹å‘½ä»¤ç”Ÿæˆ configure æ–‡ä»¶autoreconf -i# é…ç½®./configure# ç¼–è¯‘ ä¸” å®‰è£…make &amp;&amp; make install# æ·»åŠ åˆ°ç¯å¢ƒå˜é‡echo &quot;export PATH=$PATH:/usr/local/sbin&quot; &gt;&gt; ~/.bashrcsource ~/.bashrcbrctl --version## è¾“å‡ºç»“æœbridge-utils, 1.7 Docker é»˜è®¤çš„ bridge ç½‘ç»œå’Œ Linux å†…æ ¸ä¸­çš„ docker0 ç½‘æ¡¥æ˜¯ä¸€ä¸€å¯¹åº”çš„å…³ç³»ã€‚bridge æ˜¯ Docker å¯¹ç½‘ç»œçš„å‘½åï¼Œè€Œ docker0 æ˜¯å†…æ ¸ä¸­ç½‘æ¡¥çš„åå­—ã€‚ docker0è´Ÿè´£ç»™è¿æ¥å…¶ä¸Šçš„å®¹å™¨åˆ†é…ipåœ°å€ï¼Œå¹¶ä¸”æ˜¯æ¯ä¸ªå®¹å™¨çš„é»˜è®¤ç½‘å…³ã€‚å½“å®¹å™¨éœ€è¦è®¿é—®å¤–ç½‘æ—¶ï¼Œä¼šé€šè¿‡docker0è½¬åˆ°å®¿ä¸»æœºçš„eth0ä¸Šï¼Œæ‰€ä»¥åªè¦å®¿ä¸»æœºå¯ä»¥è®¿é—®å¤–ç½‘ï¼Œé‚£ä¹ˆå®¹å™¨ä¹Ÿå¯ä»¥è®¿é—®å¤–ç½‘ã€‚ 1234567891011121314# æŸ¥çœ‹å®¿ä¸»æœºçš„è·¯ç”±è¡¨$ route -nKernel IP routing tableDestination Gateway Genmask Flags Metric Ref Use Iface0.0.0.0 10.250.0.1 0.0.0.0 UG 100 0 0 eth010.250.0.0 0.0.0.0 255.255.255.0 U 100 0 0 eth0172.17.0.0 0.0.0.0 255.255.0.0 U 0 0 0 docker0# æŸ¥çœ‹ap1å®¹å™¨çš„è·¯ç”±è¡¨$ docker exec -it ap1 route -nKernel IP routing tableDestination Gateway Genmask Flags Metric Ref Use Iface0.0.0.0 172.17.0.1 0.0.0.0 UG 0 0 0 eth0172.17.0.0 0.0.0.0 255.255.0.0 U 0 0 0 eth0 Docker Container çš„ bridge æ¡¥æ¥æ¨¡å¼å¯ä»¥å‚è€ƒä¸‹å›¾ docker network ç›¸å…³å‘½ä»¤ å‘½ä»¤ åŠŸèƒ½è¯´æ˜ ç¤ºä¾‹ ç¤ºä¾‹è¾“å‡ºï¼ˆç®€ç•¥ï¼‰ docker network ls åˆ—å‡ºæ‰€æœ‰ Docker ç½‘ç»œ docker network ls bridge, host, none ç­‰ç½‘ç»œåç§° docker network inspect &lt;ç½‘ç»œå&gt; æŸ¥çœ‹æŒ‡å®šç½‘ç»œçš„è¯¦ç»†ä¿¡æ¯ï¼ˆå¦‚ IP èŒƒå›´ã€è¿æ¥å®¹å™¨ç­‰ï¼‰ docker network inspect bridge æ˜¾ç¤º JSONï¼Œå«å­ç½‘ã€ç½‘å…³ã€å®¹å™¨ç­‰ä¿¡æ¯ docker network create &lt;ç½‘ç»œå&gt; åˆ›å»ºè‡ªå®šä¹‰ç½‘ç»œï¼ˆé»˜è®¤æ¡¥æ¥ï¼‰ docker network create my-net my-net ç½‘ç»œ ID docker network rm &lt;ç½‘ç»œå&gt; åˆ é™¤ç½‘ç»œï¼ˆä¸èƒ½æœ‰å®¹å™¨è¿æ¥ï¼‰ docker network rm my-net æˆåŠŸåˆ é™¤æ— æç¤ºï¼Œå¤±è´¥ä¼šæœ‰é”™è¯¯ä¿¡æ¯ docker network connect &lt;ç½‘ç»œå&gt; &lt;å®¹å™¨å&gt; å°†ä¸€ä¸ªå®¹å™¨è¿æ¥åˆ°æŒ‡å®šç½‘ç»œ docker network connect my-net my-container æ— è¾“å‡ºï¼Œå®¹å™¨è¿æ¥æˆåŠŸ docker network disconnect &lt;ç½‘ç»œå&gt; &lt;å®¹å™¨å&gt; å°†å®¹å™¨ä»ç½‘ç»œä¸­æ–­å¼€è¿æ¥ docker network disconnect my-net my-container æ— è¾“å‡ºï¼Œæ–­å¼€æˆåŠŸ docker network prune åˆ é™¤æ‰€æœ‰æœªä½¿ç”¨çš„ç½‘ç»œï¼ˆæ…ç”¨ï¼‰ docker network prune ä¼šæç¤ºæ˜¯å¦ç¡®è®¤ï¼Œæ¸…ç†æœªä½¿ç”¨ç½‘ç»œ docker network create : åˆ›å»ºç½‘ç»œ è¯­æ³• 1docker network create [OPTIONS] NETWORK_NAME å¸¸ç”¨å‚æ•°è¯´æ˜è¡¨ å‚æ•° è¯´æ˜ ç¤ºä¾‹ --driver æˆ– -d æŒ‡å®šç½‘ç»œé©±åŠ¨ç±»å‹ï¼Œå¦‚ bridge, overlay, macvlan, host, none --driver bridge --subnet æŒ‡å®šå­ç½‘åœ°å€èŒƒå›´ï¼ˆCIDRï¼‰ --subnet 192.168.100.0/24 --gateway æŒ‡å®šç½‘å…³ IP åœ°å€ --gateway 192.168.100.1 --ip-range æŒ‡å®šå¯åˆ†é…çš„ IP èŒƒå›´ --ip-range 192.168.100.0/25 --aux-address ä¿ç•™æŸäº› IP åœ°å€ä¸è¢«åˆ†é… --aux-address=&quot;reserved=192.168.100.254&quot; --internal åˆ›å»ºä¸€ä¸ªå†…éƒ¨ç½‘ç»œï¼ˆä¸èƒ½è®¿é—®å¤–éƒ¨ï¼‰ --internal --attachable åˆ›å»ºå¯ä¾›å•ç‹¬å®¹å™¨è¿æ¥çš„ç½‘ç»œï¼ˆSwarm ä¸­ï¼‰ --attachable --label æ·»åŠ æ ‡ç­¾ --label env=dev --opt æä¾›è‡ªå®šä¹‰é©±åŠ¨é€‰é¡¹ --opt encrypted=true --driver æˆ– -d : å¸¸è§çš„ Docker ç½‘ç»œé©±åŠ¨ç±»å‹ ç±»å‹ å«ä¹‰ æ˜¯å¦æ”¯æŒç«¯å£æ˜ å°„ ç‰¹ç‚¹ä¸åº”ç”¨åœºæ™¯ bridgeï¼ˆé»˜è®¤ï¼‰ é»˜è®¤çš„æ¡¥æ¥ç½‘ç»œï¼Œå®¹å™¨é€šè¿‡è™šæ‹Ÿç½‘æ¡¥è¿æ¥ï¼Œå…±äº«å®¿ä¸»æœºçš„ç½‘ç»œæ¥å£ã€‚ âœ… æ˜¯ é»˜è®¤æ¨¡å¼ï¼Œé€‚ç”¨äºå•ä¸»æœºéƒ¨ç½²ã€å¤šä¸ªå®¹å™¨éœ€è¦äº’é€šçš„åœºæ™¯ã€‚å¯æ˜ å°„ç«¯å£å¯¹å¤–è®¿é—®ã€‚ host å®¹å™¨ä¸å®¿ä¸»æœºå…±ç”¨ç½‘ç»œå‘½åç©ºé—´ï¼Œå®¹å™¨ç›´æ¥ä½¿ç”¨å®¿ä¸»æœºçš„ IP å’Œç«¯å£ã€‚ âŒ å¦ æ— ç½‘ç»œéš”ç¦»ï¼Œæ€§èƒ½é«˜ï¼Œé€‚ç”¨äºé«˜æ€§èƒ½ã€ä½å»¶è¿Ÿåœºæ™¯ï¼ˆå¦‚æ¸¸æˆæœåŠ¡å™¨ï¼‰ã€‚ none å®¹å™¨æ²¡æœ‰ç½‘ç»œæ¥å£ï¼Œå®Œå…¨éš”ç¦»ã€‚ âŒ å¦ ç”¨äºå®‰å…¨æ€§æˆ–æµ‹è¯•ç½‘ç»œä¸å¯è¾¾åœºæ™¯ã€‚ macvlan ä¸ºå®¹å™¨åˆ†é…ç‹¬ç«‹ MAC å’Œ IPï¼Œå®¹å™¨åƒç‰©ç†ä¸»æœºä¸€æ ·å‡ºç°åœ¨å±€åŸŸç½‘ä¸­ã€‚ âœ… æ˜¯ï¼ˆå°‘è§ï¼‰ é€‚ç”¨äºå®¹å™¨å¿…é¡»ç›´æ¥æš´éœ²åœ¨ç‰©ç†ç½‘ç»œä¸­çš„åœºæ™¯ï¼ˆå¦‚ DHCP æœåŠ¡ã€ARP å¹¿æ’­ï¼‰ã€‚ ipvlanï¼ˆé«˜çº§ï¼‰ ç±»ä¼¼ macvlanï¼Œä½†ä¸ä½¿ç”¨è™šæ‹Ÿ MAC åœ°å€ã€‚ âœ… æ˜¯ï¼ˆå°‘è§ï¼‰ é«˜çº§ç½‘ç»œæ–¹æ¡ˆï¼Œé€‚ç”¨äºå¯¹ç½‘ç»œæ‹“æ‰‘ç²¾ç»†æ§åˆ¶çš„åœºæ™¯ã€‚ overlay ç”¨äºå¤šä¸»æœºä¹‹é—´å®¹å™¨é€šä¿¡ï¼Œéœ€è¦ Docker Swarm æ”¯æŒã€‚ âœ… æ˜¯ï¼ˆSwarmï¼‰ è·¨ä¸»æœºéƒ¨ç½²æœåŠ¡çš„å¿…è¦æ‰‹æ®µï¼Œé€‚åˆå®¹å™¨ç¼–æ’å¹³å°ï¼ˆå¦‚ Swarmã€Kubernetesï¼‰ã€‚ å‰é¢æˆ‘ä»¬è¯´è¿‡ï¼ŒDockerä¼šè‡ªåŠ¨åˆ›å»ºä¸‰ä¸ªç½‘ç»œï¼Œå³ï¼šbridgeã€hostã€noneã€‚å¯¹äºå•å°å®¿ä¸»æœºçš„åœºæ™¯ï¼Œç»å¤§å¤šæ•°æƒ…å†µä¸‹æˆ‘ä»¬éƒ½åªä¼šä½¿ç”¨bridgeç½‘ç»œã€‚ ç¤ºä¾‹ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657# åˆ›å»ºä¸€ä¸ªåä¸ºmy-networkçš„ç½‘ç»œ$ docker network create my-network# ç­‰åŒäºï¼Œå› ä¸ºé»˜è®¤çš„ç½‘ç»œé©±åŠ¨ä¸ºbridge$ docker network create --driver bridge my-network# æŸ¥çœ‹ç½‘ç»œï¼Œå¯ä»¥çœ‹åˆ°æ–°å»ºçš„ç½‘ç»œçš„é©±åŠ¨ä¸ºbridge$ docker network ls -f name=my-networkNETWORK ID NAME DRIVER SCOPEc2dbe1686790 my-network bridge local# æŸ¥çœ‹å®¿ä¸»æœºçš„ç½‘æ¡¥ä¿¡æ¯$ brctl show## è¾“å‡ºï¼Œå¯ä»¥çœ‹åˆ°æ­¤æ—¶æœ‰ä¸€ä¸ªç½‘æ¡¥è®¾å¤‡ br-c2dbe1686790ï¼Œbr: bridgeï¼Œc2dbe1686790ï¼šnetwork idbridge name bridge id STP enabled interfacesbr-c2dbe1686790 8000.02425be81fae nodocker0 8000.0242d6d509b1 no vethc0e0cc3 vethf4b7577# æŸ¥çœ‹å®¿ä¸»æœºçš„ç½‘å¡$ ip addr## è¾“å‡ºï¼Œbr-c2dbe1686790 ç½‘å¡åç§°ï¼Œå…¶IPç½‘æ®µä¸º 172.18.0.1/1613: br-c2dbe1686790: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default link/ether 02:42:5b:e8:1f:ae brd ff:ff:ff:ff:ff:ff inet 172.18.0.1/16 brd 172.18.255.255 scope global br-c2dbe1686790 valid_lft forever preferred_lft forever# å¯åŠ¨ä¸¤ä¸ªå®¹å™¨å¹¶æ·»åŠ åˆ°my-networkç½‘ç»œä¸­$ docker run -itd --network my-network --name a1 alpine$ docker run -itd --network my-network --name a2 alpine$ ip addr## è¾“å‡º,å¯ä»¥çœ‹åˆ°ä¸¤ä¸ªå®¹å™¨éƒ½æ·»åŠ åˆ°äº†my-networkç½‘ç»œä¸­bridge name bridge id STP enabled interfacesbr-c2dbe1686790 8000.02425be81fae no veth094946c vetha2ba68adocker0 8000.0242d6d509b1 no vethc0e0cc3 vethf4b7577# æµ‹è¯•è¿é€šæ€§ï¼Œå¯ä»¥çœ‹åˆ° a1å¯ä»¥pingé€š a2ï¼Œåè¿‡æ¥ a2ä¹Ÿå¯ä»¥pingé€š a1$ docker exec -it a1 ping a2PING a2 (172.18.0.4): 56 data bytes64 bytes from 172.18.0.4: seq=0 ttl=64 time=2.127 ms64 bytes from 172.18.0.4: seq=1 ttl=64 time=0.119 ms$ docker psCONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMESe0fb0614591e alpine &quot;/bin/sh&quot; 4 minutes ago Up 4 minutes a2fc6e9477d2b7 alpine &quot;/bin/sh&quot; 4 minutes ago Up 4 minutes a19d3ed5be1916 alpine &quot;/bin/sh&quot; 4 hours ago Up 4 hours ap2c2436a1d750c alpine &quot;/bin/sh&quot; 4 hours ago Up 4 hours ap1# ä¸åŒç½‘ç»œä¸­çš„å®¹å™¨ä¹‹é—´ä¸èƒ½ç›¸äº’pingé€š## é€šè¿‡å®¹å™¨åç§°æ— æ³•pingé€š$ docker exec -it a1 ping ap1ping: bad address &#x27;ap1&#x27;## é€šè¿‡ap1å®¹å™¨IPä¹Ÿæ— æ³•pingé€šï¼Œè¿™å°±å®ç°äº†ä¸åŒç½‘ç»œä¸­çš„ç½‘ç»œéš”ç¦»$ docker exec -it a1 ping 172.17.0.2 å¦‚æœåˆ›å»ºç½‘ç»œæ—¶æ²¡æœ‰æŒ‡å®šå­ç½‘ï¼Œåˆ™ä»docker0çš„172.17.0.0/16å¾€åæ’ï¼Œæ¯”å¦‚æˆ‘ä»¬ä¸Šé¢åˆ›å»ºçš„my-networkï¼Œå…¶å­ç½‘å°±æ˜¯172.18.0.0/16ï¼Œå¦‚ä¸‹å‘½ä»¤åˆ›å»ºä¸€ä¸ªbridgeç½‘ç»œï¼Œå¹¶æŒ‡å®šå­ç½‘ã€ç½‘å…³ç­‰ä¿¡æ¯ 12345$ docker network create \\ --driver bridge \\ --subnet 192.168.50.0/24 \\ --gateway 192.168.50.1 \\ my-custom-net bridge æ€»ç»“ é»˜è®¤åˆ›å»ºçš„ docker0 ç½‘ç»œï¼Œæ˜¯ä¸€ä¸ªæ¡¥æ¥ç½‘ç»œï¼Œåœ¨ docker network ä¸­çš„åç§°ä¸º bridgeï¼Œè¯¥ç½‘ç»œä¸‹çš„å®¹å™¨å¯ä»¥é€šè¿‡IPåœ°å€ç›¸äº’è®¿é—®ï¼Œä½†ä¸èƒ½é€šè¿‡å®¹å™¨åç§°è®¿é—® é€šè¿‡docker network create &lt;ç½‘ç»œåç§°&gt;åˆ›å»ºçš„ç½‘ç»œä¹Ÿæ˜¯ä¸€ä¸ªæ¡¥æ¥ç½‘ç»œï¼Œåœ¨è¿™ä¸ªç½‘ç»œä¸‹ï¼Œå®¹å™¨å¯ä»¥é€šè¿‡IPåœ°å€ç›¸äº’è®¿é—®ï¼Œä¹Ÿèƒ½é€šè¿‡å®¹å™¨åç§°è®¿é—®ã€‚ docker network ls : åˆ—å‡ºæ‰€æœ‰ç½‘ç»œ 123456789101112# åˆ—å‡ºæ‰€æœ‰ç½‘ç»œ$ docker network ls# è¾“å‡ºæŒ‡å®šçš„ä¿¡æ¯$ docker network ls --format &quot;table &#123;&#123;.ID&#125;&#125;\\t&#123;&#123;.Name&#125;&#125;\\t&#123;&#123;.Scope&#125;&#125;&quot;# è¾“å‡ºjsonæ ¼å¼$ docker network ls --format &quot;json&quot;# è¿‡æ»¤$ docker network ls -f &quot;driver=bridge&quot;# ä¸æˆªæ–­è¾“å‡º$ docker network ls --no-trunc# åªæ˜¾ç¤ºnetwork id$ docker network ls -q docker network inspect : æŸ¥çœ‹ç½‘ç»œè¯¦æƒ… 123456# æŸ¥çœ‹åç§°ä¸ºbridgeç½‘ç»œè¯¦æƒ…$ docker network inspect bridge# æŸ¥çœ‹å½“å‰ç½‘ç»œä¸‹æœ‰å“ªäº›å®¹å™¨$ docker network inspect bridge --format &quot;&#123;&#123;.Containers&#125;&#125;&quot;# è¾“å‡ºjsonæ ¼å¼$ docker network inspect bridge --format &quot;json&quot; docker network prune : æ¸…ç†æ²¡ç”¨çš„ç½‘ç»œ 123456# åˆ é™¤æ‰€æœ‰æœªä½¿ç”¨çš„ç½‘ç»œ$ docker network prune# åˆ é™¤æ‰€æœ‰æœªä½¿ç”¨çš„ç½‘ç»œï¼Œæ— éœ€ç¡®è®¤$ docker network prune -f# æ¸…ç†24å°æ—¶å†…æœªä½¿ç”¨çš„ç½‘ç»œ$ docker network prune --filter &quot;until=24h&quot; docker network rm : åˆ é™¤ç½‘ç»œ 123456# åˆ é™¤æŒ‡å®šçš„ç½‘ç»œ$ docker network rm &lt;network-name&gt;# åˆ é™¤æ‰€æœ‰ç½‘ç»œ$ docker network rm $(docker network ls -q)# åˆ é™¤æ‰€æœ‰bridgeç½‘ç»œï¼Œè¿™é‡Œè¦æ³¨æ„ï¼Œdockeré»˜è®¤åˆ›å»ºçš„3ä¸ªç½‘ç»œæ˜¯åˆ é™¤ä¸æ‰çš„$ docker network rm $(docker network ls -q -f driver=bridge) docker network connect : å°†å®¹å™¨è¿æ¥åˆ°ç½‘ç»œ 12# å°†å®¹å™¨è¿æ¥åˆ°ç½‘ç»œï¼Œå¦‚æœå®¹å™¨å¯åŠ¨æ—¶å¿˜è®°è¿æ¥ç½‘ç»œï¼Œè¿™é‡Œå¯ä»¥æ‰‹åŠ¨æ·»åŠ $ docker network connect &lt;network-name&gt; &lt;container-name&gt; docker network disconnect : å°†å®¹å™¨ä»ç½‘ç»œæ–­å¼€ 1$ docker network disconnect &lt;network-name&gt; &lt;container-name&gt; æœ¬æ–‡æ€»ç»“ å®¹å™¨ä¸ç½‘ç»œæ˜¯å¤šå¯¹å¤šçš„å…³ç³»ï¼Œå³ä¸€ä¸ªç½‘ç»œå¯ä»¥æœ‰å¤šä¸ªå®¹å™¨ï¼Œä¸€ä¸ªå®¹å™¨ä¹Ÿå¯ä»¥è¿æ¥åˆ°å¤šä¸ªç½‘ç»œã€‚ docker0 æ˜¯ docker é»˜è®¤åˆ›å»ºçš„ç½‘ç»œï¼Œä¸æŒ‡å®šç½‘ç»œçš„æƒ…å†µä¸‹æ‰€æœ‰å®¹å™¨éƒ½è¿æ¥åˆ° docker0 ç½‘ç»œã€‚ docker0 æ˜¯ bridge ç½‘ç»œï¼Œè¯¥ç½‘ç»œä¸­çš„å®¹å™¨ä¹‹é—´å¯ä»¥é€šè¿‡ IP äº’ç›¸è®¿é—®ï¼Œä½†ä¸èƒ½é€šè¿‡å®¹å™¨åç§°è®¿é—®ã€‚ è‡ªå»ºçš„ bridge ç½‘ç»œä¸­çš„å®¹å™¨å¯ä»¥é€šè¿‡å®¹å™¨åç§°ï¼ˆæˆ–å®¹å™¨IDï¼Œä½†ä¸å¸¸ç”¨ï¼‰è®¿é—®ã€‚ ä¸åŒçš„ bridge ç½‘ç»œä¸­çš„å®¹å™¨ä¸èƒ½äº’ç›¸è®¿é—®ã€‚ --link vs --network é¡¹ç›® --link --network åŠŸèƒ½ å°†ä¸€ä¸ªå®¹å™¨é“¾æ¥åˆ°å¦ä¸€ä¸ªå®¹å™¨ï¼Œå¹¶è®¾ç½®ç¯å¢ƒå˜é‡å’Œä¸»æœºåæ˜ å°„ å°†å®¹å™¨åŠ å…¥åˆ°ä¸€ä¸ªè‡ªå®šä¹‰ç½‘ç»œä¸­ï¼Œå®ç°çµæ´»ã€éš”ç¦»çš„ç½‘ç»œé€šä¿¡ æ˜¯å¦æ¨è âŒ ä¸æ¨èï¼ˆå·²åºŸå¼ƒï¼‰ âœ… æ¨èä½¿ç”¨ ç½‘ç»œéš”ç¦» åŸºäºé»˜è®¤ bridge ç½‘ç»œï¼Œéš”ç¦»æ€§å·® å¯ä»¥åˆ›å»ºè‡ªå®šä¹‰ç½‘ç»œï¼ˆbridgeã€overlay ç­‰ï¼‰ï¼Œéš”ç¦»æ€§å¼º å¯æ‰©å±•æ€§ åªé€‚ç”¨äºå·²è¿è¡Œçš„å®¹å™¨ï¼Œè¿æ¥å›ºå®š æ”¯æŒå¤šä¸ªå®¹å™¨ï¼Œçµæ´»ç»„åˆå’ŒåŠ¨æ€æ‰©å±• DNS æ”¯æŒ ä»…è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œä¸æ”¯æŒè‡ªåŠ¨ DNS è‡ªå®šä¹‰ç½‘ç»œä¸­æ”¯æŒå®¹å™¨åç§°ä½œä¸º DNS åç§° ç”Ÿå‘½å‘¨æœŸ ä¸€æ–¹å®¹å™¨å…³é—­ï¼Œå¦ä¸€æ–¹ä»ä¿å­˜è¿‡æ—¶é“¾æ¥ ç½‘ç»œå­˜åœ¨å³å¯ï¼Œå®¹å™¨ç”Ÿå‘½å‘¨æœŸä¸äº’ç›¸å½±å“ å®‰å…¨æ€§ æ‰€æœ‰å®¹å™¨å…±äº« bridgeï¼Œå®¹æ˜“ç›¸äº’è®¿é—® è‡ªå®šä¹‰ç½‘ç»œé—´é»˜è®¤éš”ç¦»ï¼Œå®‰å…¨æ€§æ›´å¥½","summary":"æ‘˜è¦ æœ¬æ–‡ä»‹ç» Docker å‘½ä»¤ ä¸­ ç½‘ç»œç®¡ç† ç›¸å…³å‘½ä»¤ Dockerå®˜æ–¹æ–‡æ¡£","date_published":"2025-05-28T13:40:05.000Z","tags":["æŠ€æœ¯","docker","docker"]},{"id":"https://blog.hanqunfeng.com/2025/05/28/docker-command-volume/","url":"https://blog.hanqunfeng.com/2025/05/28/docker-command-volume/","title":"Docker å‘½ä»¤ ä¹‹ æ•°æ®å·(Volume)","content_html":"<!--\n **åŠ ç²—**\n *æ–œä½“*\n ***åŠ ç²—å¹¶æ–œä½“***\n ~~åˆ é™¤çº¿~~\n ==çªå‡ºæ˜¾ç¤º==\n `çªå‡ºæ˜¾ç¤º(æ¨è)`\n ++ä¸‹åˆ’çº¿++\n ~ä¸‹æ ‡~\n ^ä¸Šæ ‡^\n è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference.\n å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)\n\n +++ **ç‚¹å‡»æŠ˜å **\n è¿™æ˜¯è¢«éšè—çš„å†…å®¹\n +++\n\n::: tips success warning danger\nè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹\n:::\n\n% note info % success warning danger\nè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹\n% endnote %\n\nå¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{}\n å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ\n -->\n<h2 id=\"æ‘˜è¦\">æ‘˜è¦</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æœ¬æ–‡ä»‹ç» Docker å‘½ä»¤ ä¸­ æ•°æ®å·ç®¡ç† ç›¸å…³å‘½ä»¤</p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://docs.docker.com\">Dockerå®˜æ–¹æ–‡æ¡£</a></p>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"ä»€ä¹ˆæ˜¯Volume-æ•°æ®å·\">ä»€ä¹ˆæ˜¯Volume(æ•°æ®å·)?</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Volume æ˜¯ç”± Docker ç®¡ç†çš„ç‰¹æ®Šç›®å½•ï¼Œä½äºå®¿ä¸»æœºæ–‡ä»¶ç³»ç»Ÿä¸­(<code>/var/lib/docker/volumes/</code>)ï¼Œç”¨äºå­˜å‚¨å’Œå…±äº«å®¹å™¨çš„æ•°æ®ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>å½“å®¹å™¨è¢«åˆ é™¤åï¼Œå®¹å™¨å†…çš„æ–‡ä»¶ç³»ç»Ÿä¹Ÿä¼šä¸€èµ·åˆ é™¤ï¼Œä½†æŒ‚è½½åœ¨ Volume ä¸­çš„æ•°æ®ä¸ä¼šä¸¢å¤±ï¼Œå¯ä¾›å¤šä¸ªå®¹å™¨å…±äº«ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>Volume çš„ç‰¹ç‚¹</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>ç‰¹æ€§</th>\n<th>è¯´æ˜</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>æ•°æ®æŒä¹…åŒ–</td>\n<td>å³ä½¿å®¹å™¨åˆ é™¤ï¼Œæ•°æ®ä»ä¿ç•™åœ¨å·ä¸­</td>\n</tr>\n<tr>\n<td>å¤šå®¹å™¨å…±äº«è®¿é—®</td>\n<td>å¤šä¸ªå®¹å™¨å¯ä»¥æŒ‚è½½åŒä¸€ä¸ªå·ï¼Œå®ç°æ•°æ®å…±äº«</td>\n</tr>\n<tr>\n<td>ä¸ä¾èµ–å®¹å™¨è·¯å¾„</td>\n<td>å·ä¸å®¹å™¨ç”Ÿå‘½å‘¨æœŸè§£è€¦ï¼Œæ”¯æŒçµæ´»çš„å®¹å™¨é‡å»ºå’Œå‡çº§</td>\n</tr>\n<tr>\n<td>ç®¡ç†ç®€ä¾¿</td>\n<td>å¯ç”¨ <code>docker volume</code> å‘½ä»¤è¿›è¡ŒæŸ¥çœ‹ã€åˆ›å»ºã€åˆ é™¤ç­‰æ“ä½œ</td>\n</tr>\n<tr>\n<td>å®‰å…¨éš”ç¦»</td>\n<td>Docker ç®¡ç†çš„è·¯å¾„æ¯”ç»‘å®šæŒ‚è½½æ›´å®‰å…¨</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"docker-volume-ç›¸å…³å‘½ä»¤\"><code>docker volume</code> ç›¸å…³å‘½ä»¤</h2>\n<table>\n<thead>\n<tr>\n<th>å‘½ä»¤</th>\n<th>ä½œç”¨è¯´æ˜</th>\n<th>ç¤ºä¾‹</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>docker volume create</code></td>\n<td>åˆ›å»ºä¸€ä¸ªæ–°çš„å·ï¼Œåç§°å¯é€‰ï¼ˆä¸æŒ‡å®šä¼šè‡ªåŠ¨ç”Ÿæˆï¼‰</td>\n<td><code>docker volume create myvolume</code></td>\n</tr>\n<tr>\n<td><code>docker volume ls</code></td>\n<td>åˆ—å‡ºæ‰€æœ‰å·²å­˜åœ¨çš„å·</td>\n<td><code>docker volume ls</code></td>\n</tr>\n<tr>\n<td><code>docker volume inspect &lt;name&gt;</code></td>\n<td>æŸ¥çœ‹æŒ‡å®šå·çš„è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬æŒ‚è½½ç‚¹ã€é©±åŠ¨ç­‰</td>\n<td><code>docker volume inspect myvolume</code></td>\n</tr>\n<tr>\n<td><code>docker volume rm &lt;name&gt;</code></td>\n<td>åˆ é™¤ä¸€ä¸ªå·ï¼ˆå‰ææ˜¯æ²¡æœ‰å®¹å™¨æ­£åœ¨ä½¿ç”¨è¯¥å·ï¼‰</td>\n<td><code>docker volume rm myvolume</code></td>\n</tr>\n<tr>\n<td><code>docker volume prune</code></td>\n<td>åˆ é™¤æ‰€æœ‰æœªè¢«ä½¿ç”¨çš„å·ï¼ˆä¼šæœ‰ç¡®è®¤æç¤ºï¼‰</td>\n<td><code>docker volume prune</code></td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"docker-volume-create-åˆ›å»ºä¸€ä¸ªæ–°çš„å·\"><code>docker volume create</code> : åˆ›å»ºä¸€ä¸ªæ–°çš„å·</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>è¯­æ³•</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker volume create [OPTIONS] [VOLUME]</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å‚æ•°è¯¦è§£</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>é€‰é¡¹</th>\n<th>è¯´æ˜</th>\n<th>ç¤ºä¾‹</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>-d, --driver string</code></td>\n<td>æŒ‡å®šå·é©±åŠ¨ç¨‹åºï¼Œé»˜è®¤æ˜¯ <code>local</code>ï¼ˆæœ¬åœ°å­˜å‚¨ï¼‰</td>\n<td><code>-d local</code> æˆ– ç¬¬ä¸‰æ–¹é©±åŠ¨åç§°(éœ€è¦å®‰è£…ç¬¬ä¸‰æ–¹æ’ä»¶)</td>\n</tr>\n<tr>\n<td><code>--label list</code></td>\n<td>ç»™å·æ·»åŠ æ ‡ç­¾ï¼ˆå…ƒæ•°æ®ï¼‰ï¼Œå¯ç”¨äºåˆ†ç±»ã€è¿‡æ»¤</td>\n<td><code>--label env=prod</code></td>\n</tr>\n<tr>\n<td><code>-o, --opt map</code></td>\n<td>è®¾ç½®é©±åŠ¨çš„ç‰¹å®šé€‰é¡¹ï¼Œæ ¼å¼ä¸º <code>key=value</code>ï¼Œå¤šä¸ªé€‰é¡¹å¯é‡å¤ä½¿ç”¨</td>\n<td><code>-o type=tmpfs -o device=tmpfs</code></td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ç¤ºä¾‹</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># åˆ›å»ºä¸€ä¸ªé»˜è®¤å·ï¼ˆlocal é©±åŠ¨ï¼‰</span></span><br><span class=\"line\">docker volume create myvolume</span><br><span class=\"line\"><span class=\"comment\"># ä¹Ÿå¯ä»¥åœ¨å¯åŠ¨å®¹å™¨çš„æ—¶å€™åˆ›å»ºé»˜è®¤æ•°æ®å·ï¼Œå¦‚ä¸‹å‘½ä»¤ï¼Œè‹¥ myvolume å·ä¸å­˜åœ¨ï¼Œåˆ™ä¼šè‡ªåŠ¨åˆ›å»º</span></span><br><span class=\"line\">docker run -d -v myvolume:/data nginx</span><br><span class=\"line\">docker run -d --mount <span class=\"built_in\">type</span>=volume,<span class=\"built_in\">source</span>=myvolume,target=/data nginx</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># åˆ›å»ºä¸€ä¸ªå¸¦æœ‰æ ‡ç­¾çš„å·</span></span><br><span class=\"line\">docker volume create --label <span class=\"built_in\">env</span>=dev --label team=backend myvolume</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># åˆ›å»ºåŒ¿åå·ï¼ˆä¸æŒ‡å®šåç§°ï¼‰</span></span><br><span class=\"line\">docker volume create</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨ tmpfs ç±»å‹å·ï¼ˆåªå­˜äºå†…å­˜ä¸­ï¼Œä¸è½ç›˜ï¼‰,é€‚ç”¨äºé«˜é€Ÿè¯»å†™ä½†ä¸éœ€è¦æŒä¹…åŒ–çš„æ•°æ®</span></span><br><span class=\"line\">docker volume create \\</span><br><span class=\"line\">  -d <span class=\"built_in\">local</span> \\            <span class=\"comment\"># æŒ‡å®šé©±åŠ¨ç¨‹åºä¸º local</span></span><br><span class=\"line\">  -o <span class=\"built_in\">type</span>=tmpfs \\       <span class=\"comment\"># æŒ‡å®šåº•å±‚æ–‡ä»¶ç³»ç»Ÿç±»å‹ä¸º tmpfsï¼ˆå†…å­˜æ–‡ä»¶ç³»ç»Ÿï¼‰</span></span><br><span class=\"line\">  -o device=tmpfs \\     <span class=\"comment\"># è®¾ç½®æŒ‚è½½è®¾å¤‡ä¸º tmpfsï¼Œç”¨äºä¸ type=tmpfs é…åˆ</span></span><br><span class=\"line\">  -o o=size=100m \\      <span class=\"comment\"># è®¾ç½® tmpfs çš„æœ€å¤§å®¹é‡ä¸º 100MB</span></span><br><span class=\"line\">  mytmpfs               <span class=\"comment\"># å·çš„åç§°ï¼Œå¯é€šè¿‡ docker volume ls æŸ¥çœ‹</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰é©±åŠ¨çš„å·ï¼ˆå¦‚ nfsï¼‰</span></span><br><span class=\"line\">docker volume create \\</span><br><span class=\"line\">  -d <span class=\"built_in\">local</span> \\                    <span class=\"comment\"># é»˜è®¤é©±åŠ¨ç¨‹åºä¸º local</span></span><br><span class=\"line\">  -o <span class=\"built_in\">type</span>=nfs \\                 <span class=\"comment\"># åº•å±‚æ–‡ä»¶ç³»ç»Ÿç±»å‹ä¸º nfs</span></span><br><span class=\"line\">  -o o=addr=192.168.1.100,rw \\  <span class=\"comment\"># è®¾ç½® nfs çš„åœ°å€å’Œè¯»å†™æƒé™ï¼Œè‹¥åªè¯»ä¸º ro</span></span><br><span class=\"line\">  -o device=:/path/to/share \\   <span class=\"comment\"># æŒ‚è½½è®¾å¤‡ä¸º nfsï¼Œæ ¼å¼ä¸ºï¼šnfs://192.168.1.100:/path/to/share</span></span><br><span class=\"line\">  mynfs                         <span class=\"comment\"># å·çš„åç§°ï¼Œå¯é€šè¿‡ docker volume ls æŸ¥çœ‹</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åˆ›å»ºçš„æ•°æ®å·ä¼šä¿å­˜åœ¨ <code>/var/lib/docker/volumes/</code> ç›®å½•ä¸‹ï¼Œæ¯”å¦‚æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªå· myvolumeï¼Œé‚£ä¹ˆè¯¥å·ä¼šä¿å­˜åœ¨ <code>/var/lib/docker/volumes/myvolume/_data</code> ç›®å½•ä¸‹</p>\n</li>\n</ul>\n<h3 id=\"docker-volume-ls-åˆ—å‡ºæ‰€æœ‰å·²å­˜åœ¨çš„å·\"><code>docker volume ls</code> : åˆ—å‡ºæ‰€æœ‰å·²å­˜åœ¨çš„å·</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># åˆ—å‡ºæ‰€æœ‰å·</span></span><br><span class=\"line\">docker volume <span class=\"built_in\">ls</span></span><br><span class=\"line\"><span class=\"comment\"># åˆ—å‡ºæ‰€æœ‰å·çš„ID</span></span><br><span class=\"line\">docker volume <span class=\"built_in\">ls</span> -q</span><br><span class=\"line\"><span class=\"comment\"># åˆ—å‡ºæŒ‡å®šé©±åŠ¨çš„å·</span></span><br><span class=\"line\">docker volume <span class=\"built_in\">ls</span> -f driver=<span class=\"built_in\">local</span></span><br><span class=\"line\"><span class=\"comment\"># åˆ—å‡ºæŒ‡å®šæ ‡ç­¾çš„å·</span></span><br><span class=\"line\">docker volume <span class=\"built_in\">ls</span> -f label=<span class=\"built_in\">env</span>=dev</span><br><span class=\"line\"><span class=\"comment\"># åˆ—å‡ºæ‰€æœ‰æœªä½¿ç”¨çš„å·ï¼ŒåŒ…æ‹¬åŒ¿åå·å’Œå‘½åå·</span></span><br><span class=\"line\">docker volume <span class=\"built_in\">ls</span> -f dangling=<span class=\"literal\">true</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"docker-volume-inspect-name-æŸ¥çœ‹æŒ‡å®šå·çš„è¯¦ç»†ä¿¡æ¯\"><code>docker volume inspect &lt;name&gt;</code> : æŸ¥çœ‹æŒ‡å®šå·çš„è¯¦ç»†ä¿¡æ¯</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># åˆ—å‡ºæŒ‡å®šå·çš„è¯¦ç»†ä¿¡æ¯</span></span><br><span class=\"line\">docker volume inspect myvolume</span><br><span class=\"line\"><span class=\"comment\"># åˆ—å‡ºæŒ‡å®šå·çš„è¯¦ç»†ä¿¡æ¯ï¼Œå¹¶ä½¿ç”¨jsonæ ¼å¼è¾“å‡º</span></span><br><span class=\"line\">docker volume inspect -f json myvolume</span><br><span class=\"line\"><span class=\"comment\"># åˆ—å‡ºæŒ‡å®šå·çš„æŒ‚è½½ç‚¹</span></span><br><span class=\"line\">docker volume inspect myvolume --format <span class=\"string\">&quot;&#123;&#123;.Mountpoint&#125;&#125;&quot;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"docker-volume-prune-åˆ é™¤æ‰€æœ‰æœªè¢«å®¹å™¨ä½¿ç”¨çš„å·\"><code>docker volume prune</code> : åˆ é™¤æ‰€æœ‰æœªè¢«å®¹å™¨ä½¿ç”¨çš„å·</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># åˆ é™¤æ‰€æœ‰æœªè¢«ä½¿ç”¨çš„åŒ¿åæ•°æ®å·ï¼Œä¼šæç¤ºç¡®è®¤</span></span><br><span class=\"line\">docker volume prune</span><br><span class=\"line\"><span class=\"comment\"># åˆ é™¤æ‰€æœ‰æœªè¢«ä½¿ç”¨çš„æ•°æ®å·ï¼Œä¼šæç¤ºç¡®è®¤</span></span><br><span class=\"line\">docker volume prune -a</span><br><span class=\"line\"><span class=\"comment\"># åˆ é™¤æ‰€æœ‰æœªè¢«ä½¿ç”¨çš„å·ï¼Œæ— éœ€ç¡®è®¤ç«‹åˆ»åˆ é™¤</span></span><br><span class=\"line\">docker volume prune -a -f</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åŒ¿åå· vs å‘½åå·</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-4\">åŒ¿åå·ï¼šæ²¡æœ‰åç§°ï¼Œåªåœ¨ <code>docker run -v /container/path</code> æ—¶è‡ªåŠ¨åˆ›å»ºï¼›</li>\n<li class=\"lvl-4\">å‘½åå·ï¼šæœ‰åç§°ï¼Œä¾‹å¦‚ <code>docker run -v mydata:/container/path</code>ï¼›</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"docker-volume-rm-name-åˆ é™¤æ•°æ®å·\"><code>docker volume rm &lt;name&gt;</code> : åˆ é™¤æ•°æ®å·</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># åˆ é™¤æŒ‡å®šæ•°æ®å·</span></span><br><span class=\"line\">docker volume <span class=\"built_in\">rm</span> myvolume</span><br><span class=\"line\"><span class=\"comment\"># åˆ é™¤æ‰€æœ‰æ•°æ®å·</span></span><br><span class=\"line\">docker volume <span class=\"built_in\">rm</span> $(docker volume <span class=\"built_in\">ls</span> -q)</span><br><span class=\"line\"><span class=\"comment\"># åˆ é™¤æ‰€æœ‰æœªä½¿ç”¨çš„æ•°æ®å·</span></span><br><span class=\"line\">docker volume <span class=\"built_in\">rm</span> $(docker volume <span class=\"built_in\">ls</span> -qf dangling=<span class=\"literal\">true</span>)</span><br><span class=\"line\"><span class=\"comment\"># åˆ é™¤æ‰€æœ‰æœªä½¿ç”¨çš„æ•°æ®å·ï¼Œæ— éœ€ç¡®è®¤</span></span><br><span class=\"line\">docker volume <span class=\"built_in\">rm</span> $(docker volume <span class=\"built_in\">ls</span> -qf dangling=<span class=\"literal\">true</span>) -f</span><br></pre></td></tr></table></figure>","content_text":"æ‘˜è¦ æœ¬æ–‡ä»‹ç» Docker å‘½ä»¤ ä¸­ æ•°æ®å·ç®¡ç† ç›¸å…³å‘½ä»¤ Dockerå®˜æ–¹æ–‡æ¡£ ä»€ä¹ˆæ˜¯Volume(æ•°æ®å·)? Volume æ˜¯ç”± Docker ç®¡ç†çš„ç‰¹æ®Šç›®å½•ï¼Œä½äºå®¿ä¸»æœºæ–‡ä»¶ç³»ç»Ÿä¸­(/var/lib/docker/volumes/)ï¼Œç”¨äºå­˜å‚¨å’Œå…±äº«å®¹å™¨çš„æ•°æ®ã€‚ å½“å®¹å™¨è¢«åˆ é™¤åï¼Œå®¹å™¨å†…çš„æ–‡ä»¶ç³»ç»Ÿä¹Ÿä¼šä¸€èµ·åˆ é™¤ï¼Œä½†æŒ‚è½½åœ¨ Volume ä¸­çš„æ•°æ®ä¸ä¼šä¸¢å¤±ï¼Œå¯ä¾›å¤šä¸ªå®¹å™¨å…±äº«ã€‚ Volume çš„ç‰¹ç‚¹ ç‰¹æ€§ è¯´æ˜ æ•°æ®æŒä¹…åŒ– å³ä½¿å®¹å™¨åˆ é™¤ï¼Œæ•°æ®ä»ä¿ç•™åœ¨å·ä¸­ å¤šå®¹å™¨å…±äº«è®¿é—® å¤šä¸ªå®¹å™¨å¯ä»¥æŒ‚è½½åŒä¸€ä¸ªå·ï¼Œå®ç°æ•°æ®å…±äº« ä¸ä¾èµ–å®¹å™¨è·¯å¾„ å·ä¸å®¹å™¨ç”Ÿå‘½å‘¨æœŸè§£è€¦ï¼Œæ”¯æŒçµæ´»çš„å®¹å™¨é‡å»ºå’Œå‡çº§ ç®¡ç†ç®€ä¾¿ å¯ç”¨ docker volume å‘½ä»¤è¿›è¡ŒæŸ¥çœ‹ã€åˆ›å»ºã€åˆ é™¤ç­‰æ“ä½œ å®‰å…¨éš”ç¦» Docker ç®¡ç†çš„è·¯å¾„æ¯”ç»‘å®šæŒ‚è½½æ›´å®‰å…¨ docker volume ç›¸å…³å‘½ä»¤ å‘½ä»¤ ä½œç”¨è¯´æ˜ ç¤ºä¾‹ docker volume create åˆ›å»ºä¸€ä¸ªæ–°çš„å·ï¼Œåç§°å¯é€‰ï¼ˆä¸æŒ‡å®šä¼šè‡ªåŠ¨ç”Ÿæˆï¼‰ docker volume create myvolume docker volume ls åˆ—å‡ºæ‰€æœ‰å·²å­˜åœ¨çš„å· docker volume ls docker volume inspect &lt;name&gt; æŸ¥çœ‹æŒ‡å®šå·çš„è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬æŒ‚è½½ç‚¹ã€é©±åŠ¨ç­‰ docker volume inspect myvolume docker volume rm &lt;name&gt; åˆ é™¤ä¸€ä¸ªå·ï¼ˆå‰ææ˜¯æ²¡æœ‰å®¹å™¨æ­£åœ¨ä½¿ç”¨è¯¥å·ï¼‰ docker volume rm myvolume docker volume prune åˆ é™¤æ‰€æœ‰æœªè¢«ä½¿ç”¨çš„å·ï¼ˆä¼šæœ‰ç¡®è®¤æç¤ºï¼‰ docker volume prune docker volume create : åˆ›å»ºä¸€ä¸ªæ–°çš„å· è¯­æ³• 1docker volume create [OPTIONS] [VOLUME] å‚æ•°è¯¦è§£ é€‰é¡¹ è¯´æ˜ ç¤ºä¾‹ -d, --driver string æŒ‡å®šå·é©±åŠ¨ç¨‹åºï¼Œé»˜è®¤æ˜¯ localï¼ˆæœ¬åœ°å­˜å‚¨ï¼‰ -d local æˆ– ç¬¬ä¸‰æ–¹é©±åŠ¨åç§°(éœ€è¦å®‰è£…ç¬¬ä¸‰æ–¹æ’ä»¶) --label list ç»™å·æ·»åŠ æ ‡ç­¾ï¼ˆå…ƒæ•°æ®ï¼‰ï¼Œå¯ç”¨äºåˆ†ç±»ã€è¿‡æ»¤ --label env=prod -o, --opt map è®¾ç½®é©±åŠ¨çš„ç‰¹å®šé€‰é¡¹ï¼Œæ ¼å¼ä¸º key=valueï¼Œå¤šä¸ªé€‰é¡¹å¯é‡å¤ä½¿ç”¨ -o type=tmpfs -o device=tmpfs ç¤ºä¾‹ 12345678910111213141516171819202122232425262728# åˆ›å»ºä¸€ä¸ªé»˜è®¤å·ï¼ˆlocal é©±åŠ¨ï¼‰docker volume create myvolume# ä¹Ÿå¯ä»¥åœ¨å¯åŠ¨å®¹å™¨çš„æ—¶å€™åˆ›å»ºé»˜è®¤æ•°æ®å·ï¼Œå¦‚ä¸‹å‘½ä»¤ï¼Œè‹¥ myvolume å·ä¸å­˜åœ¨ï¼Œåˆ™ä¼šè‡ªåŠ¨åˆ›å»ºdocker run -d -v myvolume:/data nginxdocker run -d --mount type=volume,source=myvolume,target=/data nginx# åˆ›å»ºä¸€ä¸ªå¸¦æœ‰æ ‡ç­¾çš„å·docker volume create --label env=dev --label team=backend myvolume# åˆ›å»ºåŒ¿åå·ï¼ˆä¸æŒ‡å®šåç§°ï¼‰docker volume create# ä½¿ç”¨ tmpfs ç±»å‹å·ï¼ˆåªå­˜äºå†…å­˜ä¸­ï¼Œä¸è½ç›˜ï¼‰,é€‚ç”¨äºé«˜é€Ÿè¯»å†™ä½†ä¸éœ€è¦æŒä¹…åŒ–çš„æ•°æ®docker volume create \\ -d local \\ # æŒ‡å®šé©±åŠ¨ç¨‹åºä¸º local -o type=tmpfs \\ # æŒ‡å®šåº•å±‚æ–‡ä»¶ç³»ç»Ÿç±»å‹ä¸º tmpfsï¼ˆå†…å­˜æ–‡ä»¶ç³»ç»Ÿï¼‰ -o device=tmpfs \\ # è®¾ç½®æŒ‚è½½è®¾å¤‡ä¸º tmpfsï¼Œç”¨äºä¸ type=tmpfs é…åˆ -o o=size=100m \\ # è®¾ç½® tmpfs çš„æœ€å¤§å®¹é‡ä¸º 100MB mytmpfs # å·çš„åç§°ï¼Œå¯é€šè¿‡ docker volume ls æŸ¥çœ‹# åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰é©±åŠ¨çš„å·ï¼ˆå¦‚ nfsï¼‰docker volume create \\ -d local \\ # é»˜è®¤é©±åŠ¨ç¨‹åºä¸º local -o type=nfs \\ # åº•å±‚æ–‡ä»¶ç³»ç»Ÿç±»å‹ä¸º nfs -o o=addr=192.168.1.100,rw \\ # è®¾ç½® nfs çš„åœ°å€å’Œè¯»å†™æƒé™ï¼Œè‹¥åªè¯»ä¸º ro -o device=:/path/to/share \\ # æŒ‚è½½è®¾å¤‡ä¸º nfsï¼Œæ ¼å¼ä¸ºï¼šnfs://192.168.1.100:/path/to/share mynfs # å·çš„åç§°ï¼Œå¯é€šè¿‡ docker volume ls æŸ¥çœ‹ åˆ›å»ºçš„æ•°æ®å·ä¼šä¿å­˜åœ¨ /var/lib/docker/volumes/ ç›®å½•ä¸‹ï¼Œæ¯”å¦‚æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªå· myvolumeï¼Œé‚£ä¹ˆè¯¥å·ä¼šä¿å­˜åœ¨ /var/lib/docker/volumes/myvolume/_data ç›®å½•ä¸‹ docker volume ls : åˆ—å‡ºæ‰€æœ‰å·²å­˜åœ¨çš„å· 12345678910# åˆ—å‡ºæ‰€æœ‰å·docker volume ls# åˆ—å‡ºæ‰€æœ‰å·çš„IDdocker volume ls -q# åˆ—å‡ºæŒ‡å®šé©±åŠ¨çš„å·docker volume ls -f driver=local# åˆ—å‡ºæŒ‡å®šæ ‡ç­¾çš„å·docker volume ls -f label=env=dev# åˆ—å‡ºæ‰€æœ‰æœªä½¿ç”¨çš„å·ï¼ŒåŒ…æ‹¬åŒ¿åå·å’Œå‘½åå·docker volume ls -f dangling=true docker volume inspect &lt;name&gt; : æŸ¥çœ‹æŒ‡å®šå·çš„è¯¦ç»†ä¿¡æ¯ 123456# åˆ—å‡ºæŒ‡å®šå·çš„è¯¦ç»†ä¿¡æ¯docker volume inspect myvolume# åˆ—å‡ºæŒ‡å®šå·çš„è¯¦ç»†ä¿¡æ¯ï¼Œå¹¶ä½¿ç”¨jsonæ ¼å¼è¾“å‡ºdocker volume inspect -f json myvolume# åˆ—å‡ºæŒ‡å®šå·çš„æŒ‚è½½ç‚¹docker volume inspect myvolume --format &quot;&#123;&#123;.Mountpoint&#125;&#125;&quot; docker volume prune : åˆ é™¤æ‰€æœ‰æœªè¢«å®¹å™¨ä½¿ç”¨çš„å· 123456# åˆ é™¤æ‰€æœ‰æœªè¢«ä½¿ç”¨çš„åŒ¿åæ•°æ®å·ï¼Œä¼šæç¤ºç¡®è®¤docker volume prune# åˆ é™¤æ‰€æœ‰æœªè¢«ä½¿ç”¨çš„æ•°æ®å·ï¼Œä¼šæç¤ºç¡®è®¤docker volume prune -a# åˆ é™¤æ‰€æœ‰æœªè¢«ä½¿ç”¨çš„å·ï¼Œæ— éœ€ç¡®è®¤ç«‹åˆ»åˆ é™¤docker volume prune -a -f åŒ¿åå· vs å‘½åå· åŒ¿åå·ï¼šæ²¡æœ‰åç§°ï¼Œåªåœ¨ docker run -v /container/path æ—¶è‡ªåŠ¨åˆ›å»ºï¼› å‘½åå·ï¼šæœ‰åç§°ï¼Œä¾‹å¦‚ docker run -v mydata:/container/pathï¼› docker volume rm &lt;name&gt; : åˆ é™¤æ•°æ®å· 12345678# åˆ é™¤æŒ‡å®šæ•°æ®å·docker volume rm myvolume# åˆ é™¤æ‰€æœ‰æ•°æ®å·docker volume rm $(docker volume ls -q)# åˆ é™¤æ‰€æœ‰æœªä½¿ç”¨çš„æ•°æ®å·docker volume rm $(docker volume ls -qf dangling=true)# åˆ é™¤æ‰€æœ‰æœªä½¿ç”¨çš„æ•°æ®å·ï¼Œæ— éœ€ç¡®è®¤docker volume rm $(docker volume ls -qf dangling=true) -f","summary":"æ‘˜è¦ æœ¬æ–‡ä»‹ç» Docker å‘½ä»¤ ä¸­ æ•°æ®å·ç®¡ç† ç›¸å…³å‘½ä»¤ Dockerå®˜æ–¹æ–‡æ¡£","date_published":"2025-05-28T13:30:05.000Z","tags":["æŠ€æœ¯","docker","docker"]},{"id":"https://blog.hanqunfeng.com/2025/05/27/docker-command-container/","url":"https://blog.hanqunfeng.com/2025/05/27/docker-command-container/","title":"Docker å‘½ä»¤ ä¹‹ å®¹å™¨(Container)","content_html":"<!--\n **åŠ ç²—**\n *æ–œä½“*\n ***åŠ ç²—å¹¶æ–œä½“***\n ~~åˆ é™¤çº¿~~\n ==çªå‡ºæ˜¾ç¤º==\n `çªå‡ºæ˜¾ç¤º(æ¨è)`\n ++ä¸‹åˆ’çº¿++\n ~ä¸‹æ ‡~\n ^ä¸Šæ ‡^\n è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference.\n å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)\n\n +++ **ç‚¹å‡»æŠ˜å **\n è¿™æ˜¯è¢«éšè—çš„å†…å®¹\n +++\n\n::: tips success warning danger\nè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹\n:::\n\n% note info % success warning danger\nè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹\n% endnote %\n\nå¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{}\n å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ\n -->\n<h2 id=\"æ‘˜è¦\">æ‘˜è¦</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æœ¬æ–‡ä»‹ç» Docker å‘½ä»¤ ä¸­ å®¹å™¨ç®¡ç† ç›¸å…³å‘½ä»¤</p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://docs.docker.com\">Dockerå®˜æ–¹æ–‡æ¡£</a></p>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸ\">å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸ</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å®¹å™¨å¯èƒ½å¤„äºä»¥ä¸‹å‡ ç§çŠ¶æ€ï¼š</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-5\">åˆå»ºï¼ˆcreatedï¼‰</li>\n<li class=\"lvl-5\">è¿è¡Œï¼ˆrunningï¼‰</li>\n<li class=\"lvl-5\">æš‚åœï¼ˆpausedï¼‰</li>\n<li class=\"lvl-5\">åœæ­¢ï¼ˆstoppedï¼‰</li>\n<li class=\"lvl-5\">åˆ é™¤ï¼ˆdeletedï¼‰</li>\n</ul>\n</li>\n<li class=\"lvl-2\">\n<p>å„ç”Ÿå‘½å‘¨æœŸä¹‹é—´çš„è½¬æ¢å…³ç³»å¦‚å›¾æ‰€ç¤ºï¼š<br>\n<img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/19n9NJ.png\" alt=\"\"></p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>å‘½ä»¤/æƒ…å†µ</th>\n<th>è¯´æ˜</th>\n<th>å®¹å™¨çŠ¶æ€å˜æ›´</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>docker create</code></td>\n<td>åˆ›å»ºå®¹å™¨åï¼Œä¸ç«‹å³å¯åŠ¨è¿è¡Œï¼Œå®¹å™¨è¿›å…¥åˆå»ºçŠ¶æ€</td>\n<td>åˆå»ºçŠ¶æ€</td>\n</tr>\n<tr>\n<td><code>docker run</code></td>\n<td>åˆ›å»ºå®¹å™¨ï¼Œå¹¶ç«‹å³å¯åŠ¨è¿è¡Œï¼Œè¿›å…¥è¿è¡ŒçŠ¶æ€</td>\n<td>åˆå»º â†’ è¿è¡Œ</td>\n</tr>\n<tr>\n<td><code>docker start</code></td>\n<td>å¯åŠ¨å·²åˆ›å»ºçš„å®¹å™¨ï¼Œå®¹å™¨è½¬ä¸ºè¿è¡ŒçŠ¶æ€</td>\n<td>åœæ­¢ â†’ è¿è¡Œ</td>\n</tr>\n<tr>\n<td><code>docker stop</code></td>\n<td>åœæ­¢æ­£åœ¨è¿è¡Œçš„å®¹å™¨ï¼Œå®¹å™¨è½¬å…¥åœæ­¢çŠ¶æ€</td>\n<td>è¿è¡Œ â†’ åœæ­¢</td>\n</tr>\n<tr>\n<td><code>docker kill</code></td>\n<td>å¼ºåˆ¶ç»ˆæ­¢å®¹å™¨ï¼Œç›¸å½“äºâ€œæ–­ç”µâ€ï¼Œå®¹æ˜“ä¸¢å¤±æ•°æ®ï¼Œä¸å»ºè®®è½»æ˜“ä½¿ç”¨</td>\n<td>è¿è¡Œ â†’ åœæ­¢ï¼ˆéæ­£å¸¸ï¼‰</td>\n</tr>\n<tr>\n<td><code>docker restart</code></td>\n<td>é‡å¯å®¹å™¨ï¼Œå®¹å™¨é‡æ–°è¿›å…¥è¿è¡ŒçŠ¶æ€</td>\n<td>è¿è¡Œ â†’ åœæ­¢ â†’ è¿è¡Œ</td>\n</tr>\n<tr>\n<td><code>docker pause</code></td>\n<td>æš‚åœå®¹å™¨å†…æ‰€æœ‰è¿›ç¨‹ï¼Œå®¹å™¨è¿›å…¥æš‚åœçŠ¶æ€</td>\n<td>è¿è¡Œ â†’ æš‚åœ</td>\n</tr>\n<tr>\n<td><code>docker unpause</code></td>\n<td>å–æ¶ˆæš‚åœçŠ¶æ€ï¼Œå®¹å™¨æ¢å¤è¿è¡Œ</td>\n<td>æš‚åœ â†’ è¿è¡Œ</td>\n</tr>\n<tr>\n<td><code>docker rm</code></td>\n<td>åˆ é™¤å®¹å™¨ï¼Œå®¹å™¨è½¬å…¥åˆ é™¤çŠ¶æ€</td>\n<td>ä»»æ„ â†’ åˆ é™¤</td>\n</tr>\n<tr>\n<td>Killed by out-of-memory (OOM)</td>\n<td>å®¿ä¸»æœºå†…å­˜è€—å°½ï¼Œå®¹å™¨è¢«ç³»ç»Ÿç»ˆæ­¢ï¼Œæ­¤ä¸ºéè®¡åˆ’ç»ˆæ­¢ï¼›å»ºè®®æ€æ­»å†…å­˜å ç”¨æœ€é«˜çš„å®¹å™¨</td>\n<td>è¿è¡Œ â†’ åœæ­¢ï¼ˆå¼‚å¸¸ï¼‰</td>\n</tr>\n<tr>\n<td>Container process exited</td>\n<td>å®¹å™¨è¿›ç¨‹å¼‚å¸¸ç»ˆæ­¢åï¼Œè¿›å…¥â€œæ˜¯å¦é‡å¯â€åˆ¤æ–­æµç¨‹ï¼šæ˜¯åˆ™æ‰§è¡Œ <code>start</code> è¿›å…¥è¿è¡Œï¼›å¦åˆ™ä¿æŒåœæ­¢çŠ¶æ€</td>\n<td>å¼‚å¸¸ â†’ åœæ­¢æˆ–è¿è¡Œ</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"docker-container-å®¹å™¨ç®¡ç†\"><code>docker container</code> : å®¹å™¨ç®¡ç†</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>docker container --help</code></p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>å‘½ä»¤</th>\n<th>è¯´æ˜</th>\n<th>åˆ«å</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>attach</td>\n<td>å°†æœ¬åœ°çš„æ ‡å‡†è¾“å…¥ã€è¾“å‡ºå’Œé”™è¯¯æµé™„åŠ åˆ°ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„å®¹å™¨ä¸Š</td>\n<td>docker attach</td>\n</tr>\n<tr>\n<td>commit</td>\n<td>æ ¹æ®å®¹å™¨çš„æ›´æ”¹åˆ›å»ºä¸€ä¸ªæ–°çš„é•œåƒ</td>\n<td>docker commit</td>\n</tr>\n<tr>\n<td>cp</td>\n<td>åœ¨å®¹å™¨å’Œæœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¹‹é—´å¤åˆ¶æ–‡ä»¶/æ–‡ä»¶å¤¹</td>\n<td>docker cp</td>\n</tr>\n<tr>\n<td>create</td>\n<td>åˆ›å»ºä¸€ä¸ªæ–°çš„å®¹å™¨</td>\n<td>docker create</td>\n</tr>\n<tr>\n<td>diff</td>\n<td>æ£€æŸ¥å®¹å™¨æ–‡ä»¶ç³»ç»Ÿä¸Šçš„æ–‡ä»¶æˆ–ç›®å½•çš„æ›´æ”¹</td>\n<td>docker diff</td>\n</tr>\n<tr>\n<td>exec</td>\n<td>åœ¨æ­£åœ¨è¿è¡Œçš„å®¹å™¨ä¸­æ‰§è¡Œå‘½ä»¤</td>\n<td>docker exec</td>\n</tr>\n<tr>\n<td>export</td>\n<td>å°†å®¹å™¨çš„æ–‡ä»¶ç³»ç»Ÿå¯¼å‡ºä¸º tar å½’æ¡£æ–‡ä»¶</td>\n<td>docker export</td>\n</tr>\n<tr>\n<td>inspect</td>\n<td>æ˜¾ç¤ºä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨çš„è¯¦ç»†ä¿¡æ¯</td>\n<td>å¯ä»¥ä½¿ç”¨ <code>docker inspect</code></td>\n</tr>\n<tr>\n<td>kill</td>\n<td>ç»ˆæ­¢ä¸€ä¸ªæˆ–å¤šä¸ªæ­£åœ¨è¿è¡Œçš„å®¹å™¨</td>\n<td>docker kill</td>\n</tr>\n<tr>\n<td>logs</td>\n<td>è·å–å®¹å™¨çš„æ—¥å¿—</td>\n<td>docker logs</td>\n</tr>\n<tr>\n<td>ls</td>\n<td>åˆ—å‡ºå®¹å™¨</td>\n<td>docker ps</td>\n</tr>\n<tr>\n<td>pause</td>\n<td>æš‚åœä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨å†…çš„æ‰€æœ‰è¿›ç¨‹</td>\n<td>docker pause</td>\n</tr>\n<tr>\n<td>port</td>\n<td>åˆ—å‡ºå®¹å™¨çš„ç«¯å£æ˜ å°„æˆ–ç‰¹å®šçš„ç«¯å£æ˜ å°„</td>\n<td>docker port</td>\n</tr>\n<tr>\n<td>prune</td>\n<td>åˆ é™¤æ‰€æœ‰å·²åœæ­¢çš„å®¹å™¨</td>\n<td></td>\n</tr>\n<tr>\n<td>rename</td>\n<td>é‡å‘½åä¸€ä¸ªå®¹å™¨</td>\n<td>docker rename</td>\n</tr>\n<tr>\n<td>restart</td>\n<td>é‡å¯ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨</td>\n<td>docker restart</td>\n</tr>\n<tr>\n<td>rm</td>\n<td>åˆ é™¤ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨</td>\n<td>docker rm</td>\n</tr>\n<tr>\n<td>run</td>\n<td>æ ¹æ®é•œåƒåˆ›å»ºå¹¶è¿è¡Œä¸€ä¸ªæ–°å®¹å™¨</td>\n<td>docker run</td>\n</tr>\n<tr>\n<td>start</td>\n<td>å¯åŠ¨ä¸€ä¸ªæˆ–å¤šä¸ªå·²åœæ­¢çš„å®¹å™¨</td>\n<td>docker start</td>\n</tr>\n<tr>\n<td>stats</td>\n<td>å®æ—¶æ˜¾ç¤ºå®¹å™¨èµ„æºä½¿ç”¨ç»Ÿè®¡ä¿¡æ¯</td>\n<td>docker stats</td>\n</tr>\n<tr>\n<td>stop</td>\n<td>åœæ­¢ä¸€ä¸ªæˆ–å¤šä¸ªæ­£åœ¨è¿è¡Œçš„å®¹å™¨</td>\n<td>docker stop</td>\n</tr>\n<tr>\n<td>top</td>\n<td>æ˜¾ç¤ºå®¹å™¨ä¸­è¿è¡Œçš„è¿›ç¨‹</td>\n<td>docker top</td>\n</tr>\n<tr>\n<td>unpause</td>\n<td>å–æ¶ˆæš‚åœä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨å†…çš„æ‰€æœ‰è¿›ç¨‹</td>\n<td>docker unpause</td>\n</tr>\n<tr>\n<td>update</td>\n<td>æ›´æ–°ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨çš„é…ç½®</td>\n<td>docker update</td>\n</tr>\n<tr>\n<td>wait</td>\n<td>é˜»å¡ç›´åˆ°ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨åœæ­¢ï¼Œç„¶åæ‰“å°å…¶é€€å‡ºä»£ç </td>\n<td>docker wait</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>è¿è¡Œ <code>docker container COMMAND --help</code> å¯è·å–æŸä¸ªå‘½ä»¤çš„æ›´å¤šä¿¡æ¯ã€‚</p>\n</li>\n</ul>\n<h3 id=\"docker-create-åˆ›å»ºå®¹å™¨ï¼Œä½†ä¸å¯åŠ¨\"><code>docker create</code> : åˆ›å»ºå®¹å™¨ï¼Œä½†ä¸å¯åŠ¨</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ docker create \\</span><br><span class=\"line\">    --name my-container \\ <span class=\"comment\"># å®¹å™¨å</span></span><br><span class=\"line\">    -e MY_ENV_VAR=my-value \\ <span class=\"comment\"># è®¾ç½®ç¯å¢ƒå˜é‡</span></span><br><span class=\"line\">    -p 80:80 \\ <span class=\"comment\"># æ˜ å°„ç«¯å£ï¼Œæ ¼å¼ï¼šå®¿ä¸»æœºç«¯å£:å®¹å™¨ç«¯å£</span></span><br><span class=\"line\">    -v /path/to/my/dir:/path/in/container \\ <span class=\"comment\"># æ˜ å°„ç›®å½•ï¼Œæ ¼å¼ï¼šå®¿ä¸»æœºç›®å½•:å®¹å™¨ç›®å½•ï¼Œéƒ½å¿…é¡»æ˜¯ç»å¯¹è·¯å¾„</span></span><br><span class=\"line\">    --restart always \\ <span class=\"comment\"># è®¾ç½®é‡å¯ç­–ç•¥</span></span><br><span class=\"line\">    nginx:latest \\ <span class=\"comment\"># é•œåƒåï¼Œé•œåƒä¸å­˜åœ¨æ—¶ä¼šè‡ªåŠ¨ä¸‹è½½</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>docker create</code> ä¸ <code>docker run</code> çš„å‚æ•°åŸºæœ¬ä¸€è‡´ï¼Œå…·ä½“æŸ¥çœ‹ä¸‹é¢ <code>docker run</code> ä¸­çš„ä»‹ç»ã€‚</p>\n</li>\n</ul>\n<h3 id=\"docker-start-å¯åŠ¨ä¸€ä¸ªå®¹å™¨\"><code>docker start</code> : å¯åŠ¨ä¸€ä¸ªå®¹å™¨</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å¯åŠ¨ä¸€ä¸ªå®¹å™¨ï¼Œå®¹å™¨å¿…é¡»å·²ç»åˆ›å»ºï¼Œå¹¶ä¸”å¤„äºåœæ­¢çŠ¶æ€ã€‚</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># è¯­æ³•ï¼šdocker start &lt;container_id|container_name&gt;</span></span><br><span class=\"line\">$ docker start my-container</span><br></pre></td></tr></table></figure>\n<h3 id=\"docker-run-åˆ›å»ºå¹¶å¯åŠ¨ä¸€ä¸ªå®¹å™¨\"><code>docker run</code> : åˆ›å»ºå¹¶å¯åŠ¨ä¸€ä¸ªå®¹å™¨</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ç›¸å½“äº<code>docker create</code> + <code>docker start</code></p>\n</li>\n<li class=\"lvl-2\">\n<p>å¸¸ç”¨å‚æ•°è¯´æ˜</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>å‚æ•°</th>\n<th>è¯´æ˜</th>\n<th>ç¤ºä¾‹</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>-d</code>, <code>--detach</code></td>\n<td>åå°è¿è¡Œå®¹å™¨ï¼ˆå³â€œå®ˆæŠ¤æ€â€ï¼‰ï¼Œ<code>run</code>ç‹¬æœ‰</td>\n<td><code>docker run -d nginx</code></td>\n</tr>\n<tr>\n<td><code>-it</code></td>\n<td>äº¤äº’å¼è¿è¡Œå®¹å™¨å¹¶åˆ†é…ç»ˆç«¯ï¼ˆå¸¸ç”¨äºè°ƒè¯•ï¼‰</td>\n<td><code>docker run -it ubuntu bash</code></td>\n</tr>\n<tr>\n<td><code>--name</code></td>\n<td>æŒ‡å®šå®¹å™¨åç§°</td>\n<td><code>docker run --name my-nginx nginx</code></td>\n</tr>\n<tr>\n<td><code>--rm</code></td>\n<td>å®¹å™¨é€€å‡ºæ—¶è‡ªåŠ¨åˆ é™¤</td>\n<td><code>docker run --rm ubuntu</code></td>\n</tr>\n<tr>\n<td><code>-p</code>, <code>--publish</code></td>\n<td>ç«¯å£æ˜ å°„ï¼ˆå®¿ä¸»æœº:å®¹å™¨ï¼‰</td>\n<td><code>docker run -p 8080:80 nginx</code></td>\n</tr>\n<tr>\n<td><code>-P</code>, <code>--publish-all</code></td>\n<td>è‡ªåŠ¨éšæœºæ˜ å°„å®¹å™¨å†…éƒ¨æ‰€æœ‰æš´éœ²ç«¯å£åˆ°å®¿ä¸»æœºç«¯å£</td>\n<td><code>docker run -P nginx</code></td>\n</tr>\n<tr>\n<td><code>-v</code>, <code>--volume</code></td>\n<td>æŒ‚è½½å·ï¼ˆå®¿ä¸»æœºç›®å½•:å®¹å™¨ç›®å½•ï¼‰</td>\n<td><code>docker run -v /data:/app/data myapp</code></td>\n</tr>\n<tr>\n<td><code>--mount</code></td>\n<td>æ›´çµæ´»çš„æŒ‚è½½æ–¹å¼ï¼ˆæ¨èæ–°é¡¹ç›®ä½¿ç”¨ï¼‰</td>\n<td><code>docker run --mount type=bind,source=/host,target=/container nginx</code></td>\n</tr>\n<tr>\n<td><code>--env</code>, <code>-e</code></td>\n<td>è®¾ç½®ç¯å¢ƒå˜é‡</td>\n<td><code>docker run -e ENV=prod myapp</code></td>\n</tr>\n<tr>\n<td><code>--env-file</code></td>\n<td>ä»æ–‡ä»¶ä¸­åŠ è½½å¤šä¸ªç¯å¢ƒå˜é‡</td>\n<td><code>docker run --env-file .env myapp</code></td>\n</tr>\n<tr>\n<td><code>--network</code></td>\n<td>è®¾ç½®å®¹å™¨ä½¿ç”¨çš„ç½‘ç»œæ¨¡å¼</td>\n<td><code>docker run --network host myapp</code></td>\n</tr>\n<tr>\n<td><code>--restart</code></td>\n<td>è®¾ç½®å®¹å™¨çš„è‡ªåŠ¨é‡å¯ç­–ç•¥</td>\n<td><code>docker run --restart=always myapp</code></td>\n</tr>\n<tr>\n<td><code>--privileged</code></td>\n<td>ç»™äºˆå®¹å™¨æ›´å¤šçš„æƒé™ï¼ˆå¦‚è®¿é—® host è®¾å¤‡ï¼‰</td>\n<td><code>docker run --privileged myapp</code></td>\n</tr>\n<tr>\n<td><code>--entrypoint</code></td>\n<td>è¦†ç›–é•œåƒé»˜è®¤çš„ ENTRYPOINT</td>\n<td><code>docker run --entrypoint /bin/bash myapp</code></td>\n</tr>\n<tr>\n<td><code>-u</code>, <code>--user</code></td>\n<td>æŒ‡å®šå®¹å™¨å†…è¿è¡Œçš„ç”¨æˆ·ï¼ˆæ ¼å¼ï¼šUID æˆ– UID:GIDï¼‰</td>\n<td><code>docker run --user 1000:1000 myapp</code></td>\n</tr>\n<tr>\n<td><code>-c</code>, <code>--cpu-shares</code></td>\n<td>è®¾ç½® CPU æƒé‡ï¼ˆç›¸å¯¹å€¼ï¼‰</td>\n<td><code>docker run --cpu-shares=512 myapp</code></td>\n</tr>\n<tr>\n<td><code>-m</code>, <code>--memory</code></td>\n<td>é™åˆ¶å®¹å™¨æœ€å¤§å†…å­˜ï¼ˆå¦‚ <code>512m</code>, <code>1g</code>ï¼‰</td>\n<td><code>docker run --memory=512m myapp</code></td>\n</tr>\n<tr>\n<td><code>-h</code>,<code> --hostname</code></td>\n<td>è®¾ç½®å®¹å™¨ä¸»æœºå</td>\n<td><code>docker run -h myhost myapp</code></td>\n</tr>\n<tr>\n<td><code>--link</code>(æ›´æ¨èä½¿ç”¨ <code>--network</code>)</td>\n<td>åˆ›å»ºé“¾æ¥åˆ°å…¶ä»–å®¹å™¨</td>\n<td><code>docker run --link myapp:app myapp2</code></td>\n</tr>\n<tr>\n<td><code>--cpus</code></td>\n<td>é™åˆ¶å®¹å™¨ä½¿ç”¨çš„CPUæ ¸æ•°</td>\n<td><code>docker run --cpus=&quot;1.5&quot;</code></td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>-p</code>, <code>--publish</code> ç«¯å£æ˜ å°„</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run -p [ä¸»æœºIP:]ä¸»æœºç«¯å£:å®¹å™¨ç«¯å£[/åè®®]</span><br></pre></td></tr></table></figure>\n<table>\n<thead>\n<tr>\n<th>ç¤ºä¾‹</th>\n<th>å«ä¹‰è¯´æ˜</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>-p 8080:80</code></td>\n<td>å°†ä¸»æœºçš„ 8080 ç«¯å£æ˜ å°„åˆ°å®¹å™¨çš„ 80 ç«¯å£ï¼ˆé»˜è®¤ TCPï¼‰</td>\n</tr>\n<tr>\n<td><code>-p 127.0.0.1:8080:80</code></td>\n<td>ä»…å°†ä¸»æœºæœ¬åœ° IPï¼ˆ127.0.0.1ï¼‰çš„ 8080 æ˜ å°„åˆ°å®¹å™¨çš„ 80 ç«¯å£ï¼ˆå¤–éƒ¨æ— æ³•è®¿é—®ï¼‰</td>\n</tr>\n<tr>\n<td><code>-p 8080:80/tcp</code></td>\n<td>æ˜¾å¼æŒ‡å®šåè®®ä¸º TCPï¼ˆç­‰åŒäºä¸åŠ  <code>/tcp</code>ï¼‰</td>\n</tr>\n<tr>\n<td><code>-p 8080:80/udp</code></td>\n<td>æ˜ å°„ UDP åè®®ç«¯å£ï¼ˆå¦‚ DNS æœåŠ¡ç­‰ï¼‰</td>\n</tr>\n<tr>\n<td><code>-p 8080</code></td>\n<td>å®¿ä¸»æœºéšæœºç«¯å£æ˜ å°„åˆ°å®¹å™¨çš„8080ç«¯å£</td>\n</tr>\n<tr>\n<td><code>-p 3000-3006:4000-4006</code></td>\n<td><strong>èŒƒå›´æ˜ å°„</strong>ï¼Œä¸èƒ½æ˜ å°„éå¯¹ç§°èŒƒå›´ï¼ˆå¦‚ 3000-3006:4000-4006ï¼‰ï¼Œåªèƒ½ä¸€ä¸€å¯¹åº”</td>\n</tr>\n<tr>\n<td>å¤šä¸ª <code>-p</code></td>\n<td>å¯ä»¥å¤šæ¬¡ä½¿ç”¨ <code>-p</code>ï¼Œæ˜ å°„å¤šä¸ªç«¯å£ã€‚ä¾‹å¦‚ï¼š<code>-p 80:80 -p 443:443</code></td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>-v, --volume</code> æ•°æ®å·æ˜ å°„</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run -v &lt;æœ¬åœ°è·¯å¾„&gt;:&lt;å®¹å™¨è·¯å¾„&gt;[:æƒé™]</span><br><span class=\"line\">  <span class=\"comment\"># &lt;æœ¬åœ°è·¯å¾„&gt;\tä¸»æœºä¸Šçš„è·¯å¾„ï¼ˆç»å¯¹è·¯å¾„ï¼Œæˆ–å‘½åå·ï¼‰ï¼Œç›®å½•ä¸å­˜åœ¨ä¼šè‡ªåŠ¨åˆ›å»º</span></span><br><span class=\"line\">  <span class=\"comment\"># &lt;å®¹å™¨è·¯å¾„&gt;\tå®¹å™¨å†…çš„è·¯å¾„ï¼Œç›®å½•ä¸å­˜åœ¨ä¼šè‡ªåŠ¨åˆ›å»º</span></span><br><span class=\"line\">  <span class=\"comment\"># [:æƒé™]\tå¯é€‰ï¼šroï¼ˆåªè¯»ï¼‰ æˆ– rwï¼ˆè¯»å†™ï¼Œé»˜è®¤ï¼‰</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ç¤ºä¾‹</span></span><br><span class=\"line\"><span class=\"comment\"># æŒ‚è½½æœ¬åœ°ç›®å½•åˆ°å®¹å™¨</span></span><br><span class=\"line\">docker run -v /data:/app/data myapp</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æŒ‚è½½ä¸ºåªè¯»</span></span><br><span class=\"line\">docker run -v /data:/app/data:ro myapp</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æŒ‚è½½å¤šä¸ªæ•°æ®å·</span></span><br><span class=\"line\">docker run -v /data1:/app/data1 -v /data2:/app/data2 myapp</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨å‘½åå·</span></span><br><span class=\"line\">docker volume create mydata</span><br><span class=\"line\">docker run -v mydata:/app/data myapp</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>--mount</code> æŒ‚è½½å·</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># --mount æ˜¯ Docker æ¨èä½¿ç”¨çš„ ç°ä»£æŒ‚è½½æ–¹å¼ï¼ŒåŠŸèƒ½å’Œ -vï¼ˆæˆ– --volumeï¼‰ç±»ä¼¼ï¼Œä½†è¯­æ³•æ›´æ¸…æ™°ã€ç»“æ„æ›´è§„èŒƒï¼Œé€‚ç”¨äºå·ï¼ˆvolumeï¼‰ã€ç»‘å®šæŒ‚è½½ï¼ˆbindï¼‰å’Œä¸´æ—¶æŒ‚è½½ï¼ˆtmpfsï¼‰ã€‚</span></span><br><span class=\"line\">docker run --mount <span class=\"built_in\">type</span>=&lt;ç±»å‹&gt;,<span class=\"built_in\">source</span>=&lt;ä¸»æœºè·¯å¾„æˆ–å·å&gt;,target=&lt;å®¹å™¨è·¯å¾„&gt;[,<span class=\"built_in\">readonly</span>]</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>ä¸‰ç§æŒ‚è½½ç±»å‹å¯¹æ¯”</p>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th>ç±»å‹ (<code>type</code>)</th>\n<th>ç”¨é€”</th>\n<th>ç¤ºä¾‹ <code>source</code></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>volume</code></td>\n<td>ä½¿ç”¨ Docker ç®¡ç†çš„å·</td>\n<td>å·åï¼Œå¦‚ <code>mydata</code></td>\n</tr>\n<tr>\n<td><code>bind</code></td>\n<td>æŒ‚è½½å®¿ä¸»æœºçš„å®é™…è·¯å¾„</td>\n<td>ç»å¯¹è·¯å¾„ï¼Œå¦‚ <code>/home/user/app/config</code></td>\n</tr>\n<tr>\n<td><code>tmpfs</code></td>\n<td>æŒ‚è½½å†…å­˜ä¸­çš„ä¸´æ—¶æ–‡ä»¶ç³»ç»Ÿ</td>\n<td>æ— éœ€æŒ‡å®š <code>source</code></td>\n</tr>\n</tbody>\n</table>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨å‘½åå·æŒ‚è½½ï¼ˆæ¨èæ–¹å¼ï¼‰,è¿™é‡Œ --target æŒ‡å®šå®¹å™¨å†…çš„æŒ‚è½½ç‚¹ï¼Œä¹Ÿå¯ä»¥æ›¿æ¢ä¸º --destination</span></span><br><span class=\"line\">docker run --mount <span class=\"built_in\">type</span>=volume,<span class=\"built_in\">source</span>=mydata,target=/app/data myapp</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨æœ¬åœ°è·¯å¾„æŒ‚è½½ï¼ˆç»‘å®šæŒ‚è½½ï¼‰,sourceæŒ‡å®šçš„æœ¬åœ°è·¯å¾„å¿…é¡»å­˜åœ¨</span></span><br><span class=\"line\">docker run --mount <span class=\"built_in\">type</span>=<span class=\"built_in\">bind</span>,<span class=\"built_in\">source</span>=/home/user/app/config,target=/app/config myapp</span><br><span class=\"line\"><span class=\"comment\"># åªè¯»æŒ‚è½½ï¼Œreadonly å¯ä»¥ç®€å†™ä¸º ro</span></span><br><span class=\"line\">docker run --mount <span class=\"built_in\">type</span>=<span class=\"built_in\">bind</span>,<span class=\"built_in\">source</span>=/home/user/app/config,target=/app/config,<span class=\"built_in\">readonly</span> myapp</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨å†…å­˜ä¸­çš„ä¸´æ—¶æ–‡ä»¶ç³»ç»ŸæŒ‚è½½ï¼Œæ•°æ®ä¸ä¼šæŒä¹…åŒ–ï¼Œåªå­˜å‚¨åœ¨å®¹å™¨è¿è¡Œæ—¶çš„å†…å­˜ä¸­</span></span><br><span class=\"line\">docker run --mount <span class=\"built_in\">type</span>=tmpfs,target=/app/tmpfs myapp</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>--link</code> å®¹å™¨é—´é“¾æ¥</p>\n</li>\n</ul>\n<blockquote>\n<p>ç”¨äºåœ¨å®¹å™¨ä¹‹é—´å»ºç«‹è¿æ¥ï¼Œä½¿ä¸€ä¸ªå®¹å™¨å¯ä»¥é€šè¿‡å¦ä¸€ä¸ªå®¹å™¨çš„åç§°è®¿é—®å…¶ç½‘ç»œä¿¡æ¯ï¼ˆå¦‚ IPã€ç¯å¢ƒå˜é‡ç­‰ï¼‰ã€‚<br>\næ³¨æ„ï¼š<code>--link</code> å·²è¢«å¼ƒç”¨ï¼Œå»ºè®®ä½¿ç”¨ <code>--network</code> æ¥å®ç°å®¹å™¨é—´é“¾æ¥ã€‚</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run --<span class=\"built_in\">link</span> &lt;ç›®æ ‡å®¹å™¨å&gt;:&lt;åˆ«å&gt; &lt;å…¶ä»–å‚æ•°&gt; &lt;é•œåƒå&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## ç¤ºä¾‹</span></span><br><span class=\"line\"><span class=\"comment\"># åœºæ™¯ï¼šä¸€ä¸ª web å®¹å™¨æƒ³è¦è¿æ¥å¦ä¸€ä¸ªè¿è¡Œä¸­çš„ db å®¹å™¨</span></span><br><span class=\"line\"><span class=\"comment\"># å…ˆå¯åŠ¨æ•°æ®åº“å®¹å™¨</span></span><br><span class=\"line\">docker run -d --name db mysql</span><br><span class=\"line\"><span class=\"comment\"># å¯åŠ¨ web å®¹å™¨å¹¶è¿æ¥åˆ° db å®¹å™¨</span></span><br><span class=\"line\">docker run -it --<span class=\"built_in\">rm</span> --name web --<span class=\"built_in\">link</span> db:mydb ubuntu bash</span><br><span class=\"line\"><span class=\"comment\"># åœ¨ web å®¹å™¨ä¸­ï¼Œç°åœ¨ä½ å¯ä»¥ç”¨ mydb æ¥è®¿é—® db å®¹å™¨ï¼Œä½†åè¿‡æ¥ db å®¹å™¨æ— æ³•è®¿é—® web å®¹å™¨</span></span><br><span class=\"line\">docker <span class=\"built_in\">exec</span> web ping mydb</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## æ”¹ç”¨ --network å®ç°</span></span><br><span class=\"line\">docker network create mynet</span><br><span class=\"line\">docker run -d --name db --network mynet mysql</span><br><span class=\"line\">docker run -it --<span class=\"built_in\">rm</span> --name web --network mynet ubuntu bash</span><br><span class=\"line\">docker <span class=\"built_in\">exec</span> web ping db</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>--network</code> ç½‘ç»œæ¨¡å¼ç±»å‹</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>ç±»å‹</th>\n<th>å«ä¹‰</th>\n<th>ç‰¹ç‚¹/é€‚ç”¨åœºæ™¯</th>\n<th>æ˜¯å¦å…è®¸ç«¯å£æ˜ å°„</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>bridge</code></td>\n<td>é»˜è®¤ç½‘ç»œç±»å‹ï¼ˆç”¨æˆ·è‡ªå®šä¹‰æˆ– Docker é»˜è®¤æ¡¥æ¥ç½‘ç»œï¼‰</td>\n<td>å®¹å™¨é€šè¿‡è™šæ‹Ÿç½‘æ¡¥è¿æ¥ï¼Œå¯ç›¸äº’é€šä¿¡ï¼›é€‚ç”¨äºå•ä¸»æœºéƒ¨ç½²</td>\n<td>âœ… æ˜¯</td>\n</tr>\n<tr>\n<td><code>host</code></td>\n<td>å®¹å™¨ä¸å®¿ä¸»æœºå…±äº«ç½‘ç»œæ ˆ</td>\n<td>æ²¡æœ‰ç½‘ç»œéš”ç¦»ï¼Œå®¹å™¨ä½¿ç”¨å®¿ä¸»æœºçš„ IP å’Œç«¯å£ï¼Œæ€§èƒ½é«˜ï¼Œé€‚åˆå¯¹ç½‘ç»œè¦æ±‚é«˜çš„æœåŠ¡</td>\n<td>âŒ å¦</td>\n</tr>\n<tr>\n<td><code>none</code></td>\n<td>å®¹å™¨æ²¡æœ‰ç½‘ç»œæ¥å£</td>\n<td>å®Œå…¨éš”ç¦»ï¼›é€‚ç”¨äºéœ€è¦å®Œå…¨æ§åˆ¶ç½‘ç»œçš„åœºæ™¯æˆ–æµ‹è¯•ç½‘ç»œä¸å¯è¾¾æ€§</td>\n<td>âŒ å¦</td>\n</tr>\n<tr>\n<td><code>&lt;user-defined&gt;</code></td>\n<td>ç”¨æˆ·è‡ªå®šä¹‰çš„ç½‘ç»œåç§°ï¼Œé€šè¿‡ <code>docker network create</code> åˆ›å»º</td>\n<td>æ”¯æŒå®¹å™¨åç§°äº’è§£æï¼ˆDNSï¼‰ï¼Œé€‚åˆå¤šå®¹å™¨é€šä¿¡åœºæ™¯ï¼Œå¦‚ Docker Compose</td>\n<td>âœ… æ˜¯</td>\n</tr>\n<tr>\n<td><code>container:&lt;name|id&gt;</code></td>\n<td>ä¸å¦ä¸€ä¸ªå®¹å™¨å…±äº«ç½‘ç»œå‘½åç©ºé—´</td>\n<td>ä¸¤ä¸ªå®¹å™¨å…±äº« IP å’Œç«¯å£ï¼Œé€‚ç”¨äºä¸»-è¾…å®¹å™¨æ¨¡å¼ï¼Œå¦‚ sidecar å®¹å™¨å…±äº«ä¸»å®¹å™¨ç½‘ç»œ</td>\n<td>âŒ å¦</td>\n</tr>\n</tbody>\n</table>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨é»˜è®¤ bridge ç½‘ç»œ</span></span><br><span class=\"line\">docker run -p 8080:80 --network bridge --name my-nginx nginx</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ä¸å®¿ä¸»æœºå…±äº«ç½‘ç»œï¼Œä¸èƒ½ä½¿ç”¨-p</span></span><br><span class=\"line\">docker run --network host nginx</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ä¸ä½¿ç”¨ä»»ä½•ç½‘ç»œï¼Œä¸èƒ½ä½¿ç”¨-p</span></span><br><span class=\"line\">docker run --network none nginx</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨å·²åˆ›å»ºçš„è‡ªå®šä¹‰ç½‘ç»œï¼Œç›¸åŒç½‘ç»œå‘½åç©ºé—´ä¸‹çš„å®¹å™¨ï¼Œå¯ä»¥é€šè¿‡å®¹å™¨ åç§°æˆ–ID äº’ç›¸è®¿é—®</span></span><br><span class=\"line\">docker network create nginx_net</span><br><span class=\"line\">docker run -p 8080:80 --network nginx_net nginx</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ä¸å¦ä¸€ä¸ªå®¹å™¨å…±äº«ç½‘ç»œå‘½åç©ºé—´ï¼Œä¸èƒ½ä½¿ç”¨-pï¼Œå¹¶ä¸”æ­¤æ—¶æ–°å¯åŠ¨çš„å®¹å™¨å ç”¨çš„ç«¯å£ä¸èƒ½ä¸è¦è¿æ¥çš„å®¹å™¨ç«¯å£ä¸€è‡´ï¼Œå¦åˆ™å°†å¯åŠ¨å¤±è´¥</span></span><br><span class=\"line\">docker run --network container:my-nginx busybox</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>--restart</code> é‡å¯ç­–ç•¥</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>ç­–ç•¥</th>\n<th>å«ä¹‰</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>no</code>ï¼ˆé»˜è®¤ï¼‰</td>\n<td>å®¹å™¨é€€å‡ºåä¸ä¼šè‡ªåŠ¨é‡å¯</td>\n</tr>\n<tr>\n<td><code>always</code></td>\n<td>æ— è®ºé€€å‡ºçŠ¶æ€ç å¦‚ä½•ï¼Œå®¹å™¨æ€»æ˜¯è‡ªåŠ¨é‡å¯</td>\n</tr>\n<tr>\n<td><code>unless-stopped</code></td>\n<td>å®¹å™¨æ€»æ˜¯è‡ªåŠ¨é‡å¯ï¼Œé™¤éç”¨æˆ·æ‰‹åŠ¨åœæ­¢å®ƒ</td>\n</tr>\n<tr>\n<td><code>on-failure[:N]</code></td>\n<td>ä»…åœ¨å®¹å™¨é 0 çŠ¶æ€ç é€€å‡ºæ—¶è‡ªåŠ¨é‡å¯ï¼ˆå¯é€‰è®¾ç½®æœ€å¤§é‡å¯æ¬¡æ•° Nï¼‰</td>\n</tr>\n</tbody>\n</table>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># å®¹å™¨éæ­£å¸¸é€€å‡ºæ—¶è‡ªåŠ¨é‡å¯</span></span><br><span class=\"line\">docker run --restart on-failure my-app</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æœ€å¤šé‡å¯ 5 æ¬¡</span></span><br><span class=\"line\">docker run --restart on-failure:5 my-app</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æ€»æ˜¯é‡å¯ï¼ˆå³ä½¿ä½ é‡å¯ Docker æœåŠ¡åï¼‰</span></span><br><span class=\"line\">docker run --restart always my-app</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># é™¤éæ‰‹åŠ¨åœæ­¢ï¼Œå¦åˆ™ä¸€ç›´é‡å¯</span></span><br><span class=\"line\">docker run --restart unless-stopped my-app</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>--cpu-shares</code> : è®¾ç½®å®¹å™¨çš„ CPU ç›¸å¯¹æƒé‡ï¼Œå³åœ¨ CPU èµ„æºç«äº‰æ—¶çš„ç›¸å¯¹ä¼˜å…ˆçº§ï¼Œé»˜è®¤å€¼ä¸º 1024ã€‚</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># å®¹å™¨1ï¼Œæƒé‡ 1024ï¼ˆé»˜è®¤ï¼‰</span></span><br><span class=\"line\">docker run -d --name c1 --cpu-shares 1024 nginx</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># å®¹å™¨2ï¼Œæƒé‡ 512ï¼ˆä¼˜å…ˆçº§ä½ï¼‰</span></span><br><span class=\"line\">docker run -d --name c2 --cpu-shares 512 nginx</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## è¯´æ˜ï¼š</span></span><br><span class=\"line\">  <span class=\"comment\"># c1çš„æƒé‡1024ï¼Œc2çš„æƒé‡512,ä¸æ˜¯ç»å¯¹é™åˆ¶ï¼Œè€Œæ˜¯åˆ†é…æ¯”ä¾‹</span></span><br><span class=\"line\">  <span class=\"comment\"># è¯¥æƒé‡è¡¨ç¤ºå®¹å™¨åœ¨ CPU ç«äº‰ä¸‹ï¼Œæƒé‡è¶Šé«˜åˆ™ä¼˜å…ˆçº§è¶Šé«˜ï¼Œä¼šå°½å¯èƒ½ä½¿ç”¨ CPU èµ„æºã€‚</span></span><br><span class=\"line\">  <span class=\"comment\"># å¦‚æœè¿™ä¸¤ä¸ªå®¹å™¨éƒ½è¿è¡Œåœ¨ CPU å¿™ç¢Œçš„ç¯å¢ƒä¸‹(åªæœ‰åœ¨ å¤šå®¹å™¨å…±äº« CPU ä¸”ç«äº‰èµ„æº çš„æƒ…å†µä¸‹æ‰ç”Ÿæ•ˆ)ï¼š</span></span><br><span class=\"line\">    <span class=\"comment\"># c1 å°†è·å¾—å¤§çº¦ 2/3 çš„ CPU æ—¶é—´</span></span><br><span class=\"line\">    <span class=\"comment\"># c2 å°†è·å¾—å¤§çº¦ 1/3 çš„ CPU æ—¶é—´</span></span><br><span class=\"line\">  <span class=\"comment\"># å¦‚æœç³»ç»Ÿ CPU ç©ºé—²ï¼Œæ‰€æœ‰å®¹å™¨éƒ½å¯ä»¥ä½¿ç”¨ 100% çš„ CPUã€‚</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>docker run</code> ç¤ºä¾‹</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># å¯åŠ¨ä¸€ä¸ªnginx å®¹å™¨</span></span><br><span class=\"line\">docker run -d -p 80:80 --name nginx nginx</span><br><span class=\"line\"><span class=\"comment\"># æ›¿æ¢nginxé•œåƒé»˜è®¤çš„å¯åŠ¨å‘½ä»¤ï¼Œnginx é•œåƒé»˜è®¤å¯åŠ¨ nginx æœåŠ¡ï¼Œæ­¤å‘½ä»¤ä¼šæ”¹ä¸ºæ‰§è¡Œ nginx -v æ˜¾ç¤ºç‰ˆæœ¬å·</span></span><br><span class=\"line\">docker run --name test_nginx --entrypoint <span class=\"string\">&quot;&quot;</span> nginx nginx -v</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æ‰§è¡Œè„šæœ¬æˆ–å‘½ä»¤ï¼Œè¿™é‡Œæ·»åŠ  --rm å‚æ•°ï¼Œè¡¨ç¤ºè¿è¡Œç»“æŸåè‡ªåŠ¨åˆ é™¤å®¹å™¨ï¼Œè¿™é‡Œæ˜¯å®‰è£… ping å‘½ä»¤</span></span><br><span class=\"line\">docker run --<span class=\"built_in\">rm</span> ubuntu bash -c <span class=\"string\">&quot;apt update &amp;&amp; apt install -y iputils-ping&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># äº¤äº’å¼æ‰§è¡Œ shell å‘½ä»¤ï¼Œæ‰§è¡Œå‘½ä»¤åä¼šè¿›å…¥å®¹å™¨çš„shell</span></span><br><span class=\"line\">docker run --<span class=\"built_in\">rm</span> -it ubuntu /bin/bash</span><br><span class=\"line\"><span class=\"comment\"># è¿™æ ·ä¹Ÿå¯ä»¥ï¼Œå› ä¸º ubuntu çš„é»˜è®¤å¯åŠ¨å‘½ä»¤æ˜¯ /bin/bash</span></span><br><span class=\"line\">docker run --<span class=\"built_in\">rm</span> -it ubuntu</span><br><span class=\"line\"><span class=\"comment\"># è½¬åˆ°åå°è¿è¡Œ</span></span><br><span class=\"line\">docker run --<span class=\"built_in\">rm</span> -itd ubuntu</span><br></pre></td></tr></table></figure>\n<h3 id=\"docker-stop-åœæ­¢å®¹å™¨ï¼Œå®¹å™¨ä¼˜é›…é€€å‡º\"><code>docker stop</code> : åœæ­¢å®¹å™¨ï¼Œå®¹å™¨ä¼˜é›…é€€å‡º</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># åœæ­¢å®¹å™¨ï¼Œé€šè¿‡å®¹å™¨åç§°</span></span><br><span class=\"line\">docker stop test_nginx</span><br><span class=\"line\"><span class=\"comment\"># åœæ­¢å®¹å™¨ï¼Œé€šè¿‡å®¹å™¨ID</span></span><br><span class=\"line\">docker stop 5d7c0c5d5c0c</span><br><span class=\"line\"><span class=\"comment\"># åœæ­¢æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„å®¹å™¨</span></span><br><span class=\"line\">docker stop $(docker ps -q)</span><br><span class=\"line\"><span class=\"comment\"># ç­‰å¾…5ç§’åå¼ºåˆ¶å…³é—­</span></span><br><span class=\"line\">docker stop -t 5 test_nginx</span><br></pre></td></tr></table></figure>\n<h3 id=\"docker-kill-å¼ºåˆ¶åœæ­¢å®¹å™¨\"><code>docker kill</code> : å¼ºåˆ¶åœæ­¢å®¹å™¨</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å½“å®¹å™¨å®Œå…¨å¡æ­»ã€æŒ‚èµ·ã€ä¸å“åº” <code>stop</code> å‘½ä»¤æ—¶ä½¿ç”¨</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker <span class=\"built_in\">kill</span> test_nginx</span><br><span class=\"line\">docker <span class=\"built_in\">kill</span> 5d7c0c5d5c0c</span><br><span class=\"line\">docker <span class=\"built_in\">kill</span> $(docker ps -q)</span><br></pre></td></tr></table></figure>\n<h3 id=\"docker-restart-é‡å¯å®¹å™¨\"><code>docker restart</code> : é‡å¯å®¹å™¨</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker restart test_nginx</span><br><span class=\"line\">docker restart 5d7c0c5d5c0c</span><br><span class=\"line\">docker restart $(docker ps -q)</span><br></pre></td></tr></table></figure>\n<h3 id=\"docker-pause-æš‚åœå®¹å™¨\"><code>docker pause</code> : æš‚åœå®¹å™¨</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æš‚åœåå®¿ä¸»æœºå°†ä¸å†ä¸ºå®¹å™¨åˆ†é…CPUæ—¶é—´ç‰‡ï¼Œä½†å†…å­˜ä¾ç„¶æœ‰æ•ˆï¼Œä½ å¯ä»¥ç†è§£ä¸ºæ­¤æ—¶ä¸ºå®¹å™¨ä¿å­˜äº†å¿«ç…§</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker pause test_nginx</span><br><span class=\"line\">docker pause 5d7c0c5d5c0c</span><br><span class=\"line\">docker pause $(docker ps -q)</span><br></pre></td></tr></table></figure>\n<h3 id=\"docker-unpause-æ¢å¤å®¹å™¨\"><code>docker unpause</code> : æ¢å¤å®¹å™¨</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker unpause test_nginx</span><br><span class=\"line\">docker unpause 5d7c0c5d5c0c</span><br><span class=\"line\">docker unpause $(docker ps -q)</span><br></pre></td></tr></table></figure>\n<h3 id=\"docker-ps-æŸ¥çœ‹å®¹å™¨åˆ—è¡¨\"><code>docker ps</code> : æŸ¥çœ‹å®¹å™¨åˆ—è¡¨</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># æ˜¾ç¤ºæ‰€æœ‰æ­£åœ¨è¿è¡Œçš„å®¹å™¨</span></span><br><span class=\"line\">docker ps</span><br><span class=\"line\"><span class=\"comment\"># æ˜¾ç¤ºæ‰€æœ‰å®¹å™¨</span></span><br><span class=\"line\">docker ps -a</span><br><span class=\"line\"><span class=\"comment\"># æ˜¾ç¤ºæ‰€æœ‰æ­£åœ¨è¿è¡Œçš„å®¹å™¨çš„ID</span></span><br><span class=\"line\">docker ps -q</span><br><span class=\"line\"><span class=\"comment\"># ä¸æˆªæ–­è¾“å‡ºï¼Œæ­¤æ—¶ COMMAND åˆ—ä¼šæ˜¾ç¤ºå®Œæ•´çš„å‘½ä»¤</span></span><br><span class=\"line\">docker ps -notrunc</span><br><span class=\"line\"><span class=\"comment\"># æ˜¾ç¤ºæœ€è¿‘åˆ›å»ºçš„5æ¡å®¹å™¨</span></span><br><span class=\"line\">docker ps -n 5</span><br><span class=\"line\"><span class=\"comment\"># è¿‡æ»¤å™¨ï¼Œæ˜¾ç¤ºçŠ¶æ€ä¸ºexitedçš„å®¹å™¨</span></span><br><span class=\"line\">docker ps -a --filter <span class=\"string\">&quot;status=exited&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># æŒ‡å®šæ¨¡æ¿ï¼Œåªæ˜¾ç¤º ID å’Œ Names</span></span><br><span class=\"line\">docker ps --format <span class=\"string\">&quot;&#123;&#123;.ID&#125;&#125;: &#123;&#123;.Names&#125;&#125;&quot;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"docker-inspect-æŸ¥çœ‹å®¹å™¨ä¿¡æ¯\"><code>docker inspect</code> : æŸ¥çœ‹å®¹å™¨ä¿¡æ¯</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹å®¹å™¨ä¿¡æ¯</span></span><br><span class=\"line\">docker inspect &lt;container_id&gt;</span><br><span class=\"line\"><span class=\"comment\"># è·å–å®¹å™¨åç§°</span></span><br><span class=\"line\">docker inspect --format=<span class=\"string\">&#x27;&#123;&#123;.Name&#125;&#125;&#x27;</span> &lt;container_id | container_name&gt;</span><br><span class=\"line\"><span class=\"comment\"># è·å–å®¹å™¨é•œåƒ</span></span><br><span class=\"line\">docker inspect --format=<span class=\"string\">&#x27;&#123;&#123;.Config.Image&#125;&#125;&#x27;</span> &lt;container_id | container_name&gt;</span><br><span class=\"line\"><span class=\"comment\"># è·å–å®¹å™¨ç¯å¢ƒå˜é‡</span></span><br><span class=\"line\">docker inspect --format=<span class=\"string\">&#x27;&#123;&#123;.Config.Env&#125;&#125;&#x27;</span> &lt;container_id | container_name&gt;</span><br><span class=\"line\"><span class=\"comment\"># è·å–å®¹å™¨çŠ¶æ€ï¼Œå‰é¢çš„ json è¡¨ç¤ºè¾“å‡ºä¸º json æ ¼å¼</span></span><br><span class=\"line\">docker inspect --format=<span class=\"string\">&#x27;&#123;&#123;json .State&#125;&#125;&#x27;</span> &lt;container_id | container_name&gt;</span><br><span class=\"line\"><span class=\"comment\"># è·å–å®¹å™¨å†…å­˜é™åˆ¶</span></span><br><span class=\"line\">docker inspect --format=<span class=\"string\">&#x27;&#123;&#123;.HostConfig.Memory&#125;&#125;&#x27;</span> &lt;container_id | container_name&gt;</span><br><span class=\"line\"><span class=\"comment\"># è·å–å®¹å™¨label</span></span><br><span class=\"line\">docker inspect --format=<span class=\"string\">&#x27;&#123;&#123;json .Config.Labels&#125;&#125;&#x27;</span> &lt;container_id | container_name&gt;</span><br><span class=\"line\"><span class=\"comment\"># è·å–å®¹å™¨çš„ç½‘ç»œä¿¡æ¯</span></span><br><span class=\"line\">docker inspect --format=<span class=\"string\">&#x27;&#123;&#123;json .NetworkSettings&#125;&#125;&#x27;</span> &lt;container_id | container_name&gt;</span><br></pre></td></tr></table></figure>\n<h3 id=\"docker-logs-è·å–å®¹å™¨æ—¥å¿—\"><code>docker logs</code> : è·å–å®¹å™¨æ—¥å¿—</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># è·å–å®¹å™¨æ—¥å¿—</span></span><br><span class=\"line\">docker logs &lt;container_id | container_name&gt;</span><br><span class=\"line\"><span class=\"comment\"># è·å–å®¹å™¨å®æ—¶æ—¥å¿—</span></span><br><span class=\"line\">docker logs -f &lt;container_id | container_name&gt;</span><br><span class=\"line\"><span class=\"comment\"># è·å–å®¹å™¨æœ€æ–°çš„ 10 è¡Œæ—¥å¿—</span></span><br><span class=\"line\">docker logs -n 10 &lt;container_id | container_name&gt;</span><br><span class=\"line\"><span class=\"comment\"># è·å–å®¹å™¨çš„å¸¦æ—¶é—´æˆ³çš„æ—¥å¿—</span></span><br><span class=\"line\">docker logs -t &lt;container_id | container_name&gt;</span><br><span class=\"line\"><span class=\"comment\"># è·å–å®¹å™¨çš„æ—¥å¿—ï¼Œä» 1 å°æ—¶å‰å¼€å§‹</span></span><br><span class=\"line\">docker logs --since 1h &lt;container_id | container_name&gt;</span><br><span class=\"line\"><span class=\"comment\"># è·å–å®¹å™¨çš„æ—¥å¿—ï¼Œç›´åˆ° 1 å°æ—¶å‰</span></span><br><span class=\"line\">docker logs --<span class=\"keyword\">until</span> 1h &lt;container_id | container_name&gt;</span><br><span class=\"line\"><span class=\"comment\"># è·å–å®¹å™¨çš„è¯¦ç»†æ—¥å¿—</span></span><br><span class=\"line\">docker logs --details &lt;container_id | container_name&gt;</span><br><span class=\"line\"><span class=\"comment\"># è·å–å®¹å™¨çš„æ—¥å¿—ï¼Œä» 2 å°æ—¶å‰å¼€å§‹ï¼Œç›´åˆ° 1 å°æ—¶å‰</span></span><br><span class=\"line\">docker logs --since 2h --<span class=\"keyword\">until</span> 1h &lt;container_id | container_name&gt;</span><br></pre></td></tr></table></figure>\n<h3 id=\"docker-exec-åœ¨å·²ç»è¿è¡Œçš„å®¹å™¨ä¸­æ‰§è¡Œå‘½ä»¤\"><code>docker exec</code> : åœ¨å·²ç»è¿è¡Œçš„å®¹å™¨ä¸­æ‰§è¡Œå‘½ä»¤</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># åœ¨å·²ç»è¿è¡Œçš„å®¹å™¨ä¸­æ‰§è¡Œå‘½ä»¤</span></span><br><span class=\"line\">docker <span class=\"built_in\">exec</span> &lt;container_id | container_name&gt; &lt;<span class=\"built_in\">command</span>&gt;</span><br><span class=\"line\"><span class=\"comment\"># è¿›å…¥å®¹å™¨shell</span></span><br><span class=\"line\">docker <span class=\"built_in\">exec</span> -it &lt;container_id | container_name&gt; bash</span><br></pre></td></tr></table></figure>\n<h3 id=\"docker-rename-é‡å‘½åå®¹å™¨\"><code>docker rename</code> : é‡å‘½åå®¹å™¨</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker rename &lt;old_container_name&gt; &lt;new_container_name&gt;</span><br></pre></td></tr></table></figure>\n<h3 id=\"docker-cp-å®¹å™¨ä¸å®¿ä¸»æœºé—´å¤åˆ¶æ–‡ä»¶\"><code>docker cp</code> : å®¹å™¨ä¸å®¿ä¸»æœºé—´å¤åˆ¶æ–‡ä»¶</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># å®¿ä¸»æœº -&gt; å®¹å™¨</span></span><br><span class=\"line\"><span class=\"comment\"># docker cp &lt;host_path&gt; &lt;container_id | container_name&gt;:&lt;container_path&gt;</span></span><br><span class=\"line\">docker <span class=\"built_in\">cp</span> ./docker-command-container.md nginx:/tmp</span><br><span class=\"line\"><span class=\"comment\"># å®¹å™¨ -&gt; å®¿ä¸»æœº</span></span><br><span class=\"line\"><span class=\"comment\"># docker cp &lt;container_id | container_name&gt;:&lt;container_path&gt; &lt;host_path&gt;</span></span><br><span class=\"line\">docker <span class=\"built_in\">cp</span> nginx:/tmp/docker-command-container.md ./</span><br></pre></td></tr></table></figure>\n<h3 id=\"docker-rm-åˆ é™¤å®¹å™¨\"><code>docker rm</code> : åˆ é™¤å®¹å™¨</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># åˆ é™¤æŒ‡å®šå®¹å™¨</span></span><br><span class=\"line\">docker <span class=\"built_in\">rm</span> &lt;container_id | container_name&gt;</span><br><span class=\"line\"><span class=\"comment\"># åˆ é™¤æ‰€æœ‰å®¹å™¨</span></span><br><span class=\"line\">docker <span class=\"built_in\">rm</span> $(docker ps -aq)</span><br></pre></td></tr></table></figure>\n<h3 id=\"docker-container-prune-åˆ é™¤æ‰€æœ‰åœæ­¢çš„å®¹å™¨\"><code>docker container prune</code> : åˆ é™¤æ‰€æœ‰åœæ­¢çš„å®¹å™¨</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker container prune</span><br></pre></td></tr></table></figure>\n<h3 id=\"docker-update-æ›´æ–°å®¹å™¨é…ç½®\"><code>docker update</code> : æ›´æ–°å®¹å™¨é…ç½®</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># æ›´æ–°æŒ‡å®šå®¹å™¨çš„CPUæ ¸æ•°å’Œå†…å­˜å¤§å°</span></span><br><span class=\"line\">docker update --cpus=2 --memory=2g &lt;container_id | container_name&gt;</span><br><span class=\"line\"><span class=\"comment\"># æ›´æ–°æŒ‡å®šå®¹å™¨è‡ªåŠ¨é‡å¯</span></span><br><span class=\"line\">docker update --restart=always &lt;container_id | container_name&gt;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å¹¶ä¸æ˜¯æ‰€æœ‰çš„é…ç½®éƒ½æ”¯æŒæ›´æ–°ï¼Œupdate å‘½ä»¤åªæ”¯æŒå¦‚ä¸‹é…ç½®ï¼ŒåŸºæœ¬ä¸Šä¹Ÿå°±åªèƒ½è°ƒä¸€ä¸‹cpuå’Œå†…å­˜ï¼Œä»¥åŠè‡ªåŠ¨é‡å¯ç­–ç•¥ï¼Œæ‰€ä»¥åˆ¶ä½œå®¹å™¨æ—¶ä¸€å®šè¦åšå¥½è§„åˆ’ã€‚</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>å‚æ•°å</th>\n<th>è¯´æ˜</th>\n<th>ç¤ºä¾‹å€¼</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>--blkio-weight</code></td>\n<td>è®¾ç½® Block IO çš„ç›¸å¯¹æƒé‡ï¼ŒèŒƒå›´æ˜¯ 10 åˆ° 1000ï¼Œè®¾ç½®ä¸º 0 è¡¨ç¤ºç¦ç”¨ï¼ˆé»˜è®¤å€¼ä¸º 0ï¼‰</td>\n<td><code>--blkio-weight=500</code></td>\n</tr>\n<tr>\n<td><code>--cpu-period</code></td>\n<td>è®¾ç½® CPU CFSï¼ˆå®Œå…¨å…¬å¹³è°ƒåº¦å™¨ï¼‰çš„å‘¨æœŸé™åˆ¶ï¼ˆå•ä½ï¼šå¾®ç§’ï¼‰</td>\n<td><code>--cpu-period=100000</code></td>\n</tr>\n<tr>\n<td><code>--cpu-quota</code></td>\n<td>è®¾ç½® CPU CFS çš„é…é¢é™åˆ¶ï¼ˆå•ä½ï¼šå¾®ç§’ï¼‰</td>\n<td><code>--cpu-quota=50000</code></td>\n</tr>\n<tr>\n<td><code>--cpu-rt-period</code></td>\n<td>è®¾ç½®å®æ—¶ CPU çš„è°ƒåº¦å‘¨æœŸï¼ˆå•ä½ï¼šå¾®ç§’ï¼‰</td>\n<td><code>--cpu-rt-period=1000000</code></td>\n</tr>\n<tr>\n<td><code>--cpu-rt-runtime</code></td>\n<td>è®¾ç½®å®æ—¶ CPU çš„è¿è¡Œæ—¶é—´é™åˆ¶ï¼ˆå•ä½ï¼šå¾®ç§’ï¼‰</td>\n<td><code>--cpu-rt-runtime=950000</code></td>\n</tr>\n<tr>\n<td><code>-c</code>, <code>--cpu-shares</code></td>\n<td>è®¾ç½® CPU å…±äº«æƒé‡ï¼Œé»˜è®¤å€¼ä¸º 1024</td>\n<td><code>--cpu-shares=512</code></td>\n</tr>\n<tr>\n<td><code>--cpus</code></td>\n<td>é™åˆ¶å®¹å™¨ä½¿ç”¨çš„ CPU æ•°é‡ï¼ˆæ”¯æŒå°æ•°ï¼‰</td>\n<td><code>--cpus=1.5</code></td>\n</tr>\n<tr>\n<td><code>--cpuset-cpus</code></td>\n<td>æŒ‡å®šå®¹å™¨å¯ä»¥åœ¨å“ªäº› CPU ä¸Šè¿è¡Œï¼ˆå¦‚ 0-3ã€0,1ï¼‰</td>\n<td><code>--cpuset-cpus=&quot;0,1&quot;</code></td>\n</tr>\n<tr>\n<td><code>--cpuset-mems</code></td>\n<td>æŒ‡å®šå®¹å™¨å¯ä»¥ä½¿ç”¨å“ªäº›å†…å­˜èŠ‚ç‚¹ï¼ˆå¦‚ 0-3ã€0,1ï¼‰ï¼Œé€‚ç”¨äº NUMA ç³»ç»Ÿ</td>\n<td><code>--cpuset-mems=&quot;0&quot;</code></td>\n</tr>\n<tr>\n<td><code>-m</code>, <code>--memory</code></td>\n<td>è®¾ç½®å†…å­˜é™åˆ¶ï¼ˆä¾‹å¦‚ 512mã€2gï¼‰</td>\n<td><code>--memory=1g</code></td>\n</tr>\n<tr>\n<td><code>--memory-reservation</code></td>\n<td>è®¾ç½®å†…å­˜è½¯é™åˆ¶ï¼ˆä½äº <code>--memory</code> çš„å€¼æ—¶ï¼Œå…è®¸ç³»ç»Ÿåœ¨å‹åŠ›è¾ƒå°æ—¶å›æ”¶ï¼‰</td>\n<td><code>--memory-reservation=512m</code></td>\n</tr>\n<tr>\n<td><code>--memory-swap</code></td>\n<td>è®¾ç½® swap é™åˆ¶ï¼ˆå†…å­˜ + swap æ€»å’Œï¼‰ï¼Œè®¾ä¸º -1 è¡¨ç¤ºæ— é™åˆ¶</td>\n<td><code>--memory-swap=2g</code></td>\n</tr>\n<tr>\n<td><code>--pids-limit</code></td>\n<td>è®¾ç½®å®¹å™¨çš„æœ€å¤§è¿›ç¨‹æ•°é‡ï¼Œè®¾ä¸º -1 è¡¨ç¤ºæ— é™åˆ¶</td>\n<td><code>--pids-limit=100</code></td>\n</tr>\n<tr>\n<td><code>--restart</code></td>\n<td>è®¾ç½®å®¹å™¨é€€å‡ºåçš„é‡å¯ç­–ç•¥</td>\n<td><code>--restart=always</code></td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"docker-stats-æ˜¾ç¤ºå®¹å™¨çš„å®æ—¶èµ„æºä½¿ç”¨æƒ…å†µ\"><code>docker stats</code> : æ˜¾ç¤ºå®¹å™¨çš„å®æ—¶èµ„æºä½¿ç”¨æƒ…å†µ</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># æ˜¾ç¤ºæ‰€æœ‰å®¹å™¨çš„å®æ—¶èµ„æºä½¿ç”¨æƒ…å†µ</span></span><br><span class=\"line\">docker stats</span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡º</span></span><br><span class=\"line\">CONTAINER ID   NAME         CPU %     MEM USAGE / LIMIT     MEM %     NET I/O           BLOCK I/O     PIDS</span><br><span class=\"line\">15caf520e3a5   nginx        0.00%     10.22MiB / 7.752GiB   0.13%     6.38kB / 2.61kB   0B / 28.7kB   13</span><br><span class=\"line\">b680087420b8   dockge       0.01%     199.5MiB / 7.752GiB   2.51%     6.44kB / 1.48kB   94.8MB / 0B   24</span><br><span class=\"line\">861dd9c1475f   remote-api   0.00%     4.188MiB / 7.752GiB   0.05%     2.77kB / 126B     3.31MB / 0B   1</span><br><span class=\"line\"><span class=\"comment\">### CONTAINER ID ä¸ NAMEï¼šå®¹å™¨ ID ä¸åç§°ã€‚</span></span><br><span class=\"line\"><span class=\"comment\">### CPU % ä¸ MEM %ï¼šå®¹å™¨ä½¿ç”¨çš„ CPU å’Œå†…å­˜çš„ç™¾åˆ†æ¯”ã€‚</span></span><br><span class=\"line\"><span class=\"comment\">### MEM USAGE / LIMITï¼šå®¹å™¨æ­£åœ¨ä½¿ç”¨çš„æ€»å†…å­˜ï¼Œä»¥åŠå…è®¸ä½¿ç”¨çš„å†…å­˜æ€»é‡ã€‚</span></span><br><span class=\"line\"><span class=\"comment\">### NET I/Oï¼šå®¹å™¨é€šè¿‡å…¶ç½‘ç»œæ¥å£å‘é€å’Œæ¥æ”¶çš„æ•°æ®é‡ã€‚</span></span><br><span class=\"line\"><span class=\"comment\">### BLOCK I/Oï¼šå®¹å™¨ä»ä¸»æœºä¸Šçš„å—è®¾å¤‡è¯»å–å’Œå†™å…¥çš„æ•°æ®é‡ã€‚</span></span><br><span class=\"line\"><span class=\"comment\">### PIDsï¼šå®¹å™¨åˆ›å»ºçš„è¿›ç¨‹æˆ–çº¿ç¨‹æ•°ã€‚</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># åˆ—å‡ºæ‰€æœ‰å®¹å™¨çš„èµ„æºä½¿ç”¨æƒ…å†µï¼ŒåŒ…æ‹¬è¿è¡Œå’Œåœæ­¢çš„</span></span><br><span class=\"line\">docker stats -a</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># å±•ç¤ºå½“å‰çŠ¶æ€å°±ç›´æ¥é€€å‡ºäº†ï¼Œä¸å†å®æ—¶æ›´æ–°ã€‚</span></span><br><span class=\"line\">docker stats --no-stream</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æŒ‡å®šè¾“å‡ºæ¨¡æ¿ï¼Œè¿™é‡ŒåŠ ä¸åŠ  table éƒ½å¯ä»¥</span></span><br><span class=\"line\">docker stats --no-stream --format <span class=\"string\">&quot;table &#123;&#123;.Name&#125;&#125;\\t&#123;&#123;.CPUPerc&#125;&#125;\\t&#123;&#123;.MemUsage&#125;&#125;&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># è¾“å‡ºjsonæ ¼å¼</span></span><br><span class=\"line\">docker stats --no-stream --format json</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æŒ‡å®šå®¹å™¨</span></span><br><span class=\"line\">docker stats &lt;container_id | container_name&gt;</span><br></pre></td></tr></table></figure>\n<h3 id=\"docker-top-æŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹\"><code>docker top</code> :  æŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># docker top &lt;container_id | container_name&gt; [ps options]</span></span><br><span class=\"line\">docker top nginx</span><br></pre></td></tr></table></figure>\n<h3 id=\"docker-port-åˆ—å‡ºæŒ‡å®šçš„å®¹å™¨çš„ç«¯å£æ˜ å°„\"><code>docker port</code> : åˆ—å‡ºæŒ‡å®šçš„å®¹å™¨çš„ç«¯å£æ˜ å°„</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># docker port &lt;container_id | container_name&gt;</span></span><br><span class=\"line\">$ docker port nginx</span><br><span class=\"line\">80/tcp -&gt; 0.0.0.0:8081</span><br></pre></td></tr></table></figure>\n<h3 id=\"docker-diff-åˆ—å‡ºå®¹å™¨è¿è¡Œæ—¶å¯¹æ–‡ä»¶ç³»ç»Ÿçš„ä¿®æ”¹\"><code>docker diff</code> : åˆ—å‡ºå®¹å™¨è¿è¡Œæ—¶å¯¹æ–‡ä»¶ç³»ç»Ÿçš„ä¿®æ”¹</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># docker diff &lt;container_id | container_name&gt;</span></span><br><span class=\"line\">$ docker diff nginx</span><br><span class=\"line\">C /root</span><br><span class=\"line\">A /root/.bash_history</span><br><span class=\"line\">C /run</span><br><span class=\"line\">A /run/nginx.pid</span><br><span class=\"line\">C /tmp</span><br><span class=\"line\">A /tmp/demo.py</span><br><span class=\"line\">C /var</span><br><span class=\"line\">C /var/cache</span><br><span class=\"line\">C /var/cache/nginx</span><br><span class=\"line\">A /var/cache/nginx/client_temp</span><br><span class=\"line\">A /var/cache/nginx/fastcgi_temp</span><br><span class=\"line\">A /var/cache/nginx/proxy_temp</span><br><span class=\"line\">A /var/cache/nginx/scgi_temp</span><br><span class=\"line\">A /var/cache/nginx/uwsgi_temp</span><br><span class=\"line\">C /etc</span><br><span class=\"line\">C /etc/nginx</span><br><span class=\"line\">C /etc/nginx/conf.d</span><br><span class=\"line\">C /etc/nginx/conf.d/default.conf</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å‰ç¼€å«ä¹‰è¯´æ˜ï¼š</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>æ ‡å¿—</th>\n<th>å«ä¹‰</th>\n<th>è¯´æ˜</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>A</code></td>\n<td><strong>Addedï¼ˆæ–°å¢ï¼‰</strong></td>\n<td>æ–‡ä»¶æˆ–ç›®å½•æ˜¯å®¹å™¨è¿è¡Œåæ–°å¢çš„</td>\n</tr>\n<tr>\n<td><code>C</code></td>\n<td><strong>Changedï¼ˆä¿®æ”¹ï¼‰</strong></td>\n<td>æ–‡ä»¶æˆ–ç›®å½•æ˜¯å·²æœ‰çš„ï¼Œä½†å†…å®¹æˆ–å…ƒæ•°æ®ï¼ˆå¦‚æƒé™ã€æ—¶é—´æˆ³ç­‰ï¼‰è¢«ä¿®æ”¹äº†</td>\n</tr>\n<tr>\n<td><code>D</code></td>\n<td><strong>Deletedï¼ˆåˆ é™¤ï¼‰</strong></td>\n<td>æ–‡ä»¶æˆ–ç›®å½•æ˜¯å­˜åœ¨äºåŸé•œåƒä¸­çš„ï¼Œä½†åœ¨å®¹å™¨ä¸­è¢«åˆ é™¤</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"docker-commit-ä»å®¹å™¨åˆ›å»ºä¸€ä¸ªæ–°çš„é•œåƒ\"><code>docker commit</code> : ä»å®¹å™¨åˆ›å»ºä¸€ä¸ªæ–°çš„é•œåƒ</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># docker commit &lt;container_id | container_name&gt; [image_name[:tag]]</span></span><br><span class=\"line\">docker commit nginx nginx:v1.0</span><br></pre></td></tr></table></figure>\n<h3 id=\"docker-export-å¯¼å‡ºå®¹å™¨å†…å®¹ä¸º-tar-æ–‡ä»¶\"><code>docker export</code> : å¯¼å‡ºå®¹å™¨å†…å®¹ä¸º tar æ–‡ä»¶</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker <span class=\"built_in\">export</span> nginx &gt; nginx.tar</span><br><span class=\"line\">dcoker <span class=\"built_in\">export</span> -o nginx.tar nginx</span><br><span class=\"line\">docker <span class=\"built_in\">export</span> nginx | gzip &gt; nginx.tar.gz</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Docker Export / Save / Commit å‘½ä»¤å¯¹æ¯”ä¸å¯¼å…¥æ–¹å¼ä¸€è§ˆè¡¨</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>å‘½ä»¤</th>\n<th>æ“ä½œå¯¹è±¡</th>\n<th>è¾“å‡ºå†…å®¹</th>\n<th>æ˜¯å¦åŒ…å«å†å²å±‚ï¼ˆé•œåƒå±‚ï¼‰</th>\n<th>æ˜¯å¦ä¿ç•™å…ƒæ•°æ®ï¼ˆæ ‡ç­¾ã€å‘½ä»¤ç­‰ï¼‰</th>\n<th>å…¸å‹ç”¨é€”</th>\n<th>å¯¼å…¥å‘½ä»¤</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>docker export</code></td>\n<td><strong>å®¹å™¨</strong></td>\n<td>å®¹å™¨çš„æ–‡ä»¶ç³»ç»Ÿï¼ˆtar å½’æ¡£ï¼‰</td>\n<td>âŒ å¦</td>\n<td>âŒ å¦</td>\n<td>å¤‡ä»½å®¹å™¨æ–‡ä»¶ç³»ç»Ÿæˆ–è¿ç§»å®¹å™¨çŠ¶æ€</td>\n<td><code>docker import &lt;tar&gt; &lt;image:tag&gt;</code></td>\n</tr>\n<tr>\n<td><code>docker save</code></td>\n<td><strong>é•œåƒ</strong></td>\n<td>é•œåƒçš„å®Œæ•´å†…å®¹ï¼ˆå«æ‰€æœ‰å±‚çš„ tarï¼‰</td>\n<td>âœ… æ˜¯</td>\n<td>âœ… æ˜¯</td>\n<td>åˆ†å‘æˆ–å¤‡ä»½é•œåƒ</td>\n<td><code>docker load &lt; &lt;tar&gt;</code></td>\n</tr>\n<tr>\n<td><code>docker commit</code></td>\n<td><strong>å®¹å™¨</strong></td>\n<td>åˆ›å»ºä¸€ä¸ªæ–°çš„é•œåƒ</td>\n<td>âœ… æ˜¯ï¼ˆä½†åªä¸€å±‚ï¼‰</td>\n<td>âœ… æ˜¯</td>\n<td>å°†å½“å‰å®¹å™¨çŠ¶æ€æ‰“åŒ…æˆæ–°é•œåƒ</td>\n<td>ä¸é€‚ç”¨ï¼ˆç›´æ¥ç”Ÿæˆé•œåƒï¼‰</td>\n</tr>\n</tbody>\n</table>\n","content_text":"æ‘˜è¦ æœ¬æ–‡ä»‹ç» Docker å‘½ä»¤ ä¸­ å®¹å™¨ç®¡ç† ç›¸å…³å‘½ä»¤ Dockerå®˜æ–¹æ–‡æ¡£ å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸ å®¹å™¨å¯èƒ½å¤„äºä»¥ä¸‹å‡ ç§çŠ¶æ€ï¼š åˆå»ºï¼ˆcreatedï¼‰ è¿è¡Œï¼ˆrunningï¼‰ æš‚åœï¼ˆpausedï¼‰ åœæ­¢ï¼ˆstoppedï¼‰ åˆ é™¤ï¼ˆdeletedï¼‰ å„ç”Ÿå‘½å‘¨æœŸä¹‹é—´çš„è½¬æ¢å…³ç³»å¦‚å›¾æ‰€ç¤ºï¼š å‘½ä»¤/æƒ…å†µ è¯´æ˜ å®¹å™¨çŠ¶æ€å˜æ›´ docker create åˆ›å»ºå®¹å™¨åï¼Œä¸ç«‹å³å¯åŠ¨è¿è¡Œï¼Œå®¹å™¨è¿›å…¥åˆå»ºçŠ¶æ€ åˆå»ºçŠ¶æ€ docker run åˆ›å»ºå®¹å™¨ï¼Œå¹¶ç«‹å³å¯åŠ¨è¿è¡Œï¼Œè¿›å…¥è¿è¡ŒçŠ¶æ€ åˆå»º â†’ è¿è¡Œ docker start å¯åŠ¨å·²åˆ›å»ºçš„å®¹å™¨ï¼Œå®¹å™¨è½¬ä¸ºè¿è¡ŒçŠ¶æ€ åœæ­¢ â†’ è¿è¡Œ docker stop åœæ­¢æ­£åœ¨è¿è¡Œçš„å®¹å™¨ï¼Œå®¹å™¨è½¬å…¥åœæ­¢çŠ¶æ€ è¿è¡Œ â†’ åœæ­¢ docker kill å¼ºåˆ¶ç»ˆæ­¢å®¹å™¨ï¼Œç›¸å½“äºâ€œæ–­ç”µâ€ï¼Œå®¹æ˜“ä¸¢å¤±æ•°æ®ï¼Œä¸å»ºè®®è½»æ˜“ä½¿ç”¨ è¿è¡Œ â†’ åœæ­¢ï¼ˆéæ­£å¸¸ï¼‰ docker restart é‡å¯å®¹å™¨ï¼Œå®¹å™¨é‡æ–°è¿›å…¥è¿è¡ŒçŠ¶æ€ è¿è¡Œ â†’ åœæ­¢ â†’ è¿è¡Œ docker pause æš‚åœå®¹å™¨å†…æ‰€æœ‰è¿›ç¨‹ï¼Œå®¹å™¨è¿›å…¥æš‚åœçŠ¶æ€ è¿è¡Œ â†’ æš‚åœ docker unpause å–æ¶ˆæš‚åœçŠ¶æ€ï¼Œå®¹å™¨æ¢å¤è¿è¡Œ æš‚åœ â†’ è¿è¡Œ docker rm åˆ é™¤å®¹å™¨ï¼Œå®¹å™¨è½¬å…¥åˆ é™¤çŠ¶æ€ ä»»æ„ â†’ åˆ é™¤ Killed by out-of-memory (OOM) å®¿ä¸»æœºå†…å­˜è€—å°½ï¼Œå®¹å™¨è¢«ç³»ç»Ÿç»ˆæ­¢ï¼Œæ­¤ä¸ºéè®¡åˆ’ç»ˆæ­¢ï¼›å»ºè®®æ€æ­»å†…å­˜å ç”¨æœ€é«˜çš„å®¹å™¨ è¿è¡Œ â†’ åœæ­¢ï¼ˆå¼‚å¸¸ï¼‰ Container process exited å®¹å™¨è¿›ç¨‹å¼‚å¸¸ç»ˆæ­¢åï¼Œè¿›å…¥â€œæ˜¯å¦é‡å¯â€åˆ¤æ–­æµç¨‹ï¼šæ˜¯åˆ™æ‰§è¡Œ start è¿›å…¥è¿è¡Œï¼›å¦åˆ™ä¿æŒåœæ­¢çŠ¶æ€ å¼‚å¸¸ â†’ åœæ­¢æˆ–è¿è¡Œ docker container : å®¹å™¨ç®¡ç† docker container --help å‘½ä»¤ è¯´æ˜ åˆ«å attach å°†æœ¬åœ°çš„æ ‡å‡†è¾“å…¥ã€è¾“å‡ºå’Œé”™è¯¯æµé™„åŠ åˆ°ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„å®¹å™¨ä¸Š docker attach commit æ ¹æ®å®¹å™¨çš„æ›´æ”¹åˆ›å»ºä¸€ä¸ªæ–°çš„é•œåƒ docker commit cp åœ¨å®¹å™¨å’Œæœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¹‹é—´å¤åˆ¶æ–‡ä»¶/æ–‡ä»¶å¤¹ docker cp create åˆ›å»ºä¸€ä¸ªæ–°çš„å®¹å™¨ docker create diff æ£€æŸ¥å®¹å™¨æ–‡ä»¶ç³»ç»Ÿä¸Šçš„æ–‡ä»¶æˆ–ç›®å½•çš„æ›´æ”¹ docker diff exec åœ¨æ­£åœ¨è¿è¡Œçš„å®¹å™¨ä¸­æ‰§è¡Œå‘½ä»¤ docker exec export å°†å®¹å™¨çš„æ–‡ä»¶ç³»ç»Ÿå¯¼å‡ºä¸º tar å½’æ¡£æ–‡ä»¶ docker export inspect æ˜¾ç¤ºä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨çš„è¯¦ç»†ä¿¡æ¯ å¯ä»¥ä½¿ç”¨ docker inspect kill ç»ˆæ­¢ä¸€ä¸ªæˆ–å¤šä¸ªæ­£åœ¨è¿è¡Œçš„å®¹å™¨ docker kill logs è·å–å®¹å™¨çš„æ—¥å¿— docker logs ls åˆ—å‡ºå®¹å™¨ docker ps pause æš‚åœä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨å†…çš„æ‰€æœ‰è¿›ç¨‹ docker pause port åˆ—å‡ºå®¹å™¨çš„ç«¯å£æ˜ å°„æˆ–ç‰¹å®šçš„ç«¯å£æ˜ å°„ docker port prune åˆ é™¤æ‰€æœ‰å·²åœæ­¢çš„å®¹å™¨ rename é‡å‘½åä¸€ä¸ªå®¹å™¨ docker rename restart é‡å¯ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨ docker restart rm åˆ é™¤ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨ docker rm run æ ¹æ®é•œåƒåˆ›å»ºå¹¶è¿è¡Œä¸€ä¸ªæ–°å®¹å™¨ docker run start å¯åŠ¨ä¸€ä¸ªæˆ–å¤šä¸ªå·²åœæ­¢çš„å®¹å™¨ docker start stats å®æ—¶æ˜¾ç¤ºå®¹å™¨èµ„æºä½¿ç”¨ç»Ÿè®¡ä¿¡æ¯ docker stats stop åœæ­¢ä¸€ä¸ªæˆ–å¤šä¸ªæ­£åœ¨è¿è¡Œçš„å®¹å™¨ docker stop top æ˜¾ç¤ºå®¹å™¨ä¸­è¿è¡Œçš„è¿›ç¨‹ docker top unpause å–æ¶ˆæš‚åœä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨å†…çš„æ‰€æœ‰è¿›ç¨‹ docker unpause update æ›´æ–°ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨çš„é…ç½® docker update wait é˜»å¡ç›´åˆ°ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨åœæ­¢ï¼Œç„¶åæ‰“å°å…¶é€€å‡ºä»£ç  docker wait è¿è¡Œ docker container COMMAND --help å¯è·å–æŸä¸ªå‘½ä»¤çš„æ›´å¤šä¿¡æ¯ã€‚ docker create : åˆ›å»ºå®¹å™¨ï¼Œä½†ä¸å¯åŠ¨ 1234567$ docker create \\ --name my-container \\ # å®¹å™¨å -e MY_ENV_VAR=my-value \\ # è®¾ç½®ç¯å¢ƒå˜é‡ -p 80:80 \\ # æ˜ å°„ç«¯å£ï¼Œæ ¼å¼ï¼šå®¿ä¸»æœºç«¯å£:å®¹å™¨ç«¯å£ -v /path/to/my/dir:/path/in/container \\ # æ˜ å°„ç›®å½•ï¼Œæ ¼å¼ï¼šå®¿ä¸»æœºç›®å½•:å®¹å™¨ç›®å½•ï¼Œéƒ½å¿…é¡»æ˜¯ç»å¯¹è·¯å¾„ --restart always \\ # è®¾ç½®é‡å¯ç­–ç•¥ nginx:latest \\ # é•œåƒåï¼Œé•œåƒä¸å­˜åœ¨æ—¶ä¼šè‡ªåŠ¨ä¸‹è½½ docker create ä¸ docker run çš„å‚æ•°åŸºæœ¬ä¸€è‡´ï¼Œå…·ä½“æŸ¥çœ‹ä¸‹é¢ docker run ä¸­çš„ä»‹ç»ã€‚ docker start : å¯åŠ¨ä¸€ä¸ªå®¹å™¨ å¯åŠ¨ä¸€ä¸ªå®¹å™¨ï¼Œå®¹å™¨å¿…é¡»å·²ç»åˆ›å»ºï¼Œå¹¶ä¸”å¤„äºåœæ­¢çŠ¶æ€ã€‚ 12# è¯­æ³•ï¼šdocker start &lt;container_id|container_name&gt;$ docker start my-container docker run : åˆ›å»ºå¹¶å¯åŠ¨ä¸€ä¸ªå®¹å™¨ ç›¸å½“äºdocker create + docker start å¸¸ç”¨å‚æ•°è¯´æ˜ å‚æ•° è¯´æ˜ ç¤ºä¾‹ -d, --detach åå°è¿è¡Œå®¹å™¨ï¼ˆå³â€œå®ˆæŠ¤æ€â€ï¼‰ï¼Œrunç‹¬æœ‰ docker run -d nginx -it äº¤äº’å¼è¿è¡Œå®¹å™¨å¹¶åˆ†é…ç»ˆç«¯ï¼ˆå¸¸ç”¨äºè°ƒè¯•ï¼‰ docker run -it ubuntu bash --name æŒ‡å®šå®¹å™¨åç§° docker run --name my-nginx nginx --rm å®¹å™¨é€€å‡ºæ—¶è‡ªåŠ¨åˆ é™¤ docker run --rm ubuntu -p, --publish ç«¯å£æ˜ å°„ï¼ˆå®¿ä¸»æœº:å®¹å™¨ï¼‰ docker run -p 8080:80 nginx -P, --publish-all è‡ªåŠ¨éšæœºæ˜ å°„å®¹å™¨å†…éƒ¨æ‰€æœ‰æš´éœ²ç«¯å£åˆ°å®¿ä¸»æœºç«¯å£ docker run -P nginx -v, --volume æŒ‚è½½å·ï¼ˆå®¿ä¸»æœºç›®å½•:å®¹å™¨ç›®å½•ï¼‰ docker run -v /data:/app/data myapp --mount æ›´çµæ´»çš„æŒ‚è½½æ–¹å¼ï¼ˆæ¨èæ–°é¡¹ç›®ä½¿ç”¨ï¼‰ docker run --mount type=bind,source=/host,target=/container nginx --env, -e è®¾ç½®ç¯å¢ƒå˜é‡ docker run -e ENV=prod myapp --env-file ä»æ–‡ä»¶ä¸­åŠ è½½å¤šä¸ªç¯å¢ƒå˜é‡ docker run --env-file .env myapp --network è®¾ç½®å®¹å™¨ä½¿ç”¨çš„ç½‘ç»œæ¨¡å¼ docker run --network host myapp --restart è®¾ç½®å®¹å™¨çš„è‡ªåŠ¨é‡å¯ç­–ç•¥ docker run --restart=always myapp --privileged ç»™äºˆå®¹å™¨æ›´å¤šçš„æƒé™ï¼ˆå¦‚è®¿é—® host è®¾å¤‡ï¼‰ docker run --privileged myapp --entrypoint è¦†ç›–é•œåƒé»˜è®¤çš„ ENTRYPOINT docker run --entrypoint /bin/bash myapp -u, --user æŒ‡å®šå®¹å™¨å†…è¿è¡Œçš„ç”¨æˆ·ï¼ˆæ ¼å¼ï¼šUID æˆ– UID:GIDï¼‰ docker run --user 1000:1000 myapp -c, --cpu-shares è®¾ç½® CPU æƒé‡ï¼ˆç›¸å¯¹å€¼ï¼‰ docker run --cpu-shares=512 myapp -m, --memory é™åˆ¶å®¹å™¨æœ€å¤§å†…å­˜ï¼ˆå¦‚ 512m, 1gï¼‰ docker run --memory=512m myapp -h, --hostname è®¾ç½®å®¹å™¨ä¸»æœºå docker run -h myhost myapp --link(æ›´æ¨èä½¿ç”¨ --network) åˆ›å»ºé“¾æ¥åˆ°å…¶ä»–å®¹å™¨ docker run --link myapp:app myapp2 --cpus é™åˆ¶å®¹å™¨ä½¿ç”¨çš„CPUæ ¸æ•° docker run --cpus=&quot;1.5&quot; -p, --publish ç«¯å£æ˜ å°„ 1docker run -p [ä¸»æœºIP:]ä¸»æœºç«¯å£:å®¹å™¨ç«¯å£[/åè®®] ç¤ºä¾‹ å«ä¹‰è¯´æ˜ -p 8080:80 å°†ä¸»æœºçš„ 8080 ç«¯å£æ˜ å°„åˆ°å®¹å™¨çš„ 80 ç«¯å£ï¼ˆé»˜è®¤ TCPï¼‰ -p 127.0.0.1:8080:80 ä»…å°†ä¸»æœºæœ¬åœ° IPï¼ˆ127.0.0.1ï¼‰çš„ 8080 æ˜ å°„åˆ°å®¹å™¨çš„ 80 ç«¯å£ï¼ˆå¤–éƒ¨æ— æ³•è®¿é—®ï¼‰ -p 8080:80/tcp æ˜¾å¼æŒ‡å®šåè®®ä¸º TCPï¼ˆç­‰åŒäºä¸åŠ  /tcpï¼‰ -p 8080:80/udp æ˜ å°„ UDP åè®®ç«¯å£ï¼ˆå¦‚ DNS æœåŠ¡ç­‰ï¼‰ -p 8080 å®¿ä¸»æœºéšæœºç«¯å£æ˜ å°„åˆ°å®¹å™¨çš„8080ç«¯å£ -p 3000-3006:4000-4006 èŒƒå›´æ˜ å°„ï¼Œä¸èƒ½æ˜ å°„éå¯¹ç§°èŒƒå›´ï¼ˆå¦‚ 3000-3006:4000-4006ï¼‰ï¼Œåªèƒ½ä¸€ä¸€å¯¹åº” å¤šä¸ª -p å¯ä»¥å¤šæ¬¡ä½¿ç”¨ -pï¼Œæ˜ å°„å¤šä¸ªç«¯å£ã€‚ä¾‹å¦‚ï¼š-p 80:80 -p 443:443 -v, --volume æ•°æ®å·æ˜ å°„ 123456789101112131415161718docker run -v &lt;æœ¬åœ°è·¯å¾„&gt;:&lt;å®¹å™¨è·¯å¾„&gt;[:æƒé™] # &lt;æœ¬åœ°è·¯å¾„&gt; ä¸»æœºä¸Šçš„è·¯å¾„ï¼ˆç»å¯¹è·¯å¾„ï¼Œæˆ–å‘½åå·ï¼‰ï¼Œç›®å½•ä¸å­˜åœ¨ä¼šè‡ªåŠ¨åˆ›å»º # &lt;å®¹å™¨è·¯å¾„&gt; å®¹å™¨å†…çš„è·¯å¾„ï¼Œç›®å½•ä¸å­˜åœ¨ä¼šè‡ªåŠ¨åˆ›å»º # [:æƒé™] å¯é€‰ï¼šroï¼ˆåªè¯»ï¼‰ æˆ– rwï¼ˆè¯»å†™ï¼Œé»˜è®¤ï¼‰# ç¤ºä¾‹# æŒ‚è½½æœ¬åœ°ç›®å½•åˆ°å®¹å™¨docker run -v /data:/app/data myapp# æŒ‚è½½ä¸ºåªè¯»docker run -v /data:/app/data:ro myapp# æŒ‚è½½å¤šä¸ªæ•°æ®å·docker run -v /data1:/app/data1 -v /data2:/app/data2 myapp# ä½¿ç”¨å‘½åå·docker volume create mydatadocker run -v mydata:/app/data myapp --mount æŒ‚è½½å· 12# --mount æ˜¯ Docker æ¨èä½¿ç”¨çš„ ç°ä»£æŒ‚è½½æ–¹å¼ï¼ŒåŠŸèƒ½å’Œ -vï¼ˆæˆ– --volumeï¼‰ç±»ä¼¼ï¼Œä½†è¯­æ³•æ›´æ¸…æ™°ã€ç»“æ„æ›´è§„èŒƒï¼Œé€‚ç”¨äºå·ï¼ˆvolumeï¼‰ã€ç»‘å®šæŒ‚è½½ï¼ˆbindï¼‰å’Œä¸´æ—¶æŒ‚è½½ï¼ˆtmpfsï¼‰ã€‚docker run --mount type=&lt;ç±»å‹&gt;,source=&lt;ä¸»æœºè·¯å¾„æˆ–å·å&gt;,target=&lt;å®¹å™¨è·¯å¾„&gt;[,readonly] ä¸‰ç§æŒ‚è½½ç±»å‹å¯¹æ¯” ç±»å‹ (type) ç”¨é€” ç¤ºä¾‹ source volume ä½¿ç”¨ Docker ç®¡ç†çš„å· å·åï¼Œå¦‚ mydata bind æŒ‚è½½å®¿ä¸»æœºçš„å®é™…è·¯å¾„ ç»å¯¹è·¯å¾„ï¼Œå¦‚ /home/user/app/config tmpfs æŒ‚è½½å†…å­˜ä¸­çš„ä¸´æ—¶æ–‡ä»¶ç³»ç»Ÿ æ— éœ€æŒ‡å®š source 12345678910# ä½¿ç”¨å‘½åå·æŒ‚è½½ï¼ˆæ¨èæ–¹å¼ï¼‰,è¿™é‡Œ --target æŒ‡å®šå®¹å™¨å†…çš„æŒ‚è½½ç‚¹ï¼Œä¹Ÿå¯ä»¥æ›¿æ¢ä¸º --destinationdocker run --mount type=volume,source=mydata,target=/app/data myapp# ä½¿ç”¨æœ¬åœ°è·¯å¾„æŒ‚è½½ï¼ˆç»‘å®šæŒ‚è½½ï¼‰,sourceæŒ‡å®šçš„æœ¬åœ°è·¯å¾„å¿…é¡»å­˜åœ¨docker run --mount type=bind,source=/home/user/app/config,target=/app/config myapp# åªè¯»æŒ‚è½½ï¼Œreadonly å¯ä»¥ç®€å†™ä¸º rodocker run --mount type=bind,source=/home/user/app/config,target=/app/config,readonly myapp# ä½¿ç”¨å†…å­˜ä¸­çš„ä¸´æ—¶æ–‡ä»¶ç³»ç»ŸæŒ‚è½½ï¼Œæ•°æ®ä¸ä¼šæŒä¹…åŒ–ï¼Œåªå­˜å‚¨åœ¨å®¹å™¨è¿è¡Œæ—¶çš„å†…å­˜ä¸­docker run --mount type=tmpfs,target=/app/tmpfs myapp --link å®¹å™¨é—´é“¾æ¥ ç”¨äºåœ¨å®¹å™¨ä¹‹é—´å»ºç«‹è¿æ¥ï¼Œä½¿ä¸€ä¸ªå®¹å™¨å¯ä»¥é€šè¿‡å¦ä¸€ä¸ªå®¹å™¨çš„åç§°è®¿é—®å…¶ç½‘ç»œä¿¡æ¯ï¼ˆå¦‚ IPã€ç¯å¢ƒå˜é‡ç­‰ï¼‰ã€‚ æ³¨æ„ï¼š--link å·²è¢«å¼ƒç”¨ï¼Œå»ºè®®ä½¿ç”¨ --network æ¥å®ç°å®¹å™¨é—´é“¾æ¥ã€‚ 12345678910111213141516docker run --link &lt;ç›®æ ‡å®¹å™¨å&gt;:&lt;åˆ«å&gt; &lt;å…¶ä»–å‚æ•°&gt; &lt;é•œåƒå&gt;## ç¤ºä¾‹# åœºæ™¯ï¼šä¸€ä¸ª web å®¹å™¨æƒ³è¦è¿æ¥å¦ä¸€ä¸ªè¿è¡Œä¸­çš„ db å®¹å™¨# å…ˆå¯åŠ¨æ•°æ®åº“å®¹å™¨docker run -d --name db mysql# å¯åŠ¨ web å®¹å™¨å¹¶è¿æ¥åˆ° db å®¹å™¨docker run -it --rm --name web --link db:mydb ubuntu bash# åœ¨ web å®¹å™¨ä¸­ï¼Œç°åœ¨ä½ å¯ä»¥ç”¨ mydb æ¥è®¿é—® db å®¹å™¨ï¼Œä½†åè¿‡æ¥ db å®¹å™¨æ— æ³•è®¿é—® web å®¹å™¨docker exec web ping mydb## æ”¹ç”¨ --network å®ç°docker network create mynetdocker run -d --name db --network mynet mysqldocker run -it --rm --name web --network mynet ubuntu bashdocker exec web ping db --network ç½‘ç»œæ¨¡å¼ç±»å‹ ç±»å‹ å«ä¹‰ ç‰¹ç‚¹/é€‚ç”¨åœºæ™¯ æ˜¯å¦å…è®¸ç«¯å£æ˜ å°„ bridge é»˜è®¤ç½‘ç»œç±»å‹ï¼ˆç”¨æˆ·è‡ªå®šä¹‰æˆ– Docker é»˜è®¤æ¡¥æ¥ç½‘ç»œï¼‰ å®¹å™¨é€šè¿‡è™šæ‹Ÿç½‘æ¡¥è¿æ¥ï¼Œå¯ç›¸äº’é€šä¿¡ï¼›é€‚ç”¨äºå•ä¸»æœºéƒ¨ç½² âœ… æ˜¯ host å®¹å™¨ä¸å®¿ä¸»æœºå…±äº«ç½‘ç»œæ ˆ æ²¡æœ‰ç½‘ç»œéš”ç¦»ï¼Œå®¹å™¨ä½¿ç”¨å®¿ä¸»æœºçš„ IP å’Œç«¯å£ï¼Œæ€§èƒ½é«˜ï¼Œé€‚åˆå¯¹ç½‘ç»œè¦æ±‚é«˜çš„æœåŠ¡ âŒ å¦ none å®¹å™¨æ²¡æœ‰ç½‘ç»œæ¥å£ å®Œå…¨éš”ç¦»ï¼›é€‚ç”¨äºéœ€è¦å®Œå…¨æ§åˆ¶ç½‘ç»œçš„åœºæ™¯æˆ–æµ‹è¯•ç½‘ç»œä¸å¯è¾¾æ€§ âŒ å¦ &lt;user-defined&gt; ç”¨æˆ·è‡ªå®šä¹‰çš„ç½‘ç»œåç§°ï¼Œé€šè¿‡ docker network create åˆ›å»º æ”¯æŒå®¹å™¨åç§°äº’è§£æï¼ˆDNSï¼‰ï¼Œé€‚åˆå¤šå®¹å™¨é€šä¿¡åœºæ™¯ï¼Œå¦‚ Docker Compose âœ… æ˜¯ container:&lt;name|id&gt; ä¸å¦ä¸€ä¸ªå®¹å™¨å…±äº«ç½‘ç»œå‘½åç©ºé—´ ä¸¤ä¸ªå®¹å™¨å…±äº« IP å’Œç«¯å£ï¼Œé€‚ç”¨äºä¸»-è¾…å®¹å™¨æ¨¡å¼ï¼Œå¦‚ sidecar å®¹å™¨å…±äº«ä¸»å®¹å™¨ç½‘ç»œ âŒ å¦ 123456789101112131415# ä½¿ç”¨é»˜è®¤ bridge ç½‘ç»œdocker run -p 8080:80 --network bridge --name my-nginx nginx# ä¸å®¿ä¸»æœºå…±äº«ç½‘ç»œï¼Œä¸èƒ½ä½¿ç”¨-pdocker run --network host nginx# ä¸ä½¿ç”¨ä»»ä½•ç½‘ç»œï¼Œä¸èƒ½ä½¿ç”¨-pdocker run --network none nginx# ä½¿ç”¨å·²åˆ›å»ºçš„è‡ªå®šä¹‰ç½‘ç»œï¼Œç›¸åŒç½‘ç»œå‘½åç©ºé—´ä¸‹çš„å®¹å™¨ï¼Œå¯ä»¥é€šè¿‡å®¹å™¨ åç§°æˆ–ID äº’ç›¸è®¿é—®docker network create nginx_netdocker run -p 8080:80 --network nginx_net nginx# ä¸å¦ä¸€ä¸ªå®¹å™¨å…±äº«ç½‘ç»œå‘½åç©ºé—´ï¼Œä¸èƒ½ä½¿ç”¨-pï¼Œå¹¶ä¸”æ­¤æ—¶æ–°å¯åŠ¨çš„å®¹å™¨å ç”¨çš„ç«¯å£ä¸èƒ½ä¸è¦è¿æ¥çš„å®¹å™¨ç«¯å£ä¸€è‡´ï¼Œå¦åˆ™å°†å¯åŠ¨å¤±è´¥docker run --network container:my-nginx busybox --restart é‡å¯ç­–ç•¥ ç­–ç•¥ å«ä¹‰ noï¼ˆé»˜è®¤ï¼‰ å®¹å™¨é€€å‡ºåä¸ä¼šè‡ªåŠ¨é‡å¯ always æ— è®ºé€€å‡ºçŠ¶æ€ç å¦‚ä½•ï¼Œå®¹å™¨æ€»æ˜¯è‡ªåŠ¨é‡å¯ unless-stopped å®¹å™¨æ€»æ˜¯è‡ªåŠ¨é‡å¯ï¼Œé™¤éç”¨æˆ·æ‰‹åŠ¨åœæ­¢å®ƒ on-failure[:N] ä»…åœ¨å®¹å™¨é 0 çŠ¶æ€ç é€€å‡ºæ—¶è‡ªåŠ¨é‡å¯ï¼ˆå¯é€‰è®¾ç½®æœ€å¤§é‡å¯æ¬¡æ•° Nï¼‰ 1234567891011# å®¹å™¨éæ­£å¸¸é€€å‡ºæ—¶è‡ªåŠ¨é‡å¯docker run --restart on-failure my-app# æœ€å¤šé‡å¯ 5 æ¬¡docker run --restart on-failure:5 my-app# æ€»æ˜¯é‡å¯ï¼ˆå³ä½¿ä½ é‡å¯ Docker æœåŠ¡åï¼‰docker run --restart always my-app# é™¤éæ‰‹åŠ¨åœæ­¢ï¼Œå¦åˆ™ä¸€ç›´é‡å¯docker run --restart unless-stopped my-app --cpu-shares : è®¾ç½®å®¹å™¨çš„ CPU ç›¸å¯¹æƒé‡ï¼Œå³åœ¨ CPU èµ„æºç«äº‰æ—¶çš„ç›¸å¯¹ä¼˜å…ˆçº§ï¼Œé»˜è®¤å€¼ä¸º 1024ã€‚ 12345678910111213# å®¹å™¨1ï¼Œæƒé‡ 1024ï¼ˆé»˜è®¤ï¼‰docker run -d --name c1 --cpu-shares 1024 nginx# å®¹å™¨2ï¼Œæƒé‡ 512ï¼ˆä¼˜å…ˆçº§ä½ï¼‰docker run -d --name c2 --cpu-shares 512 nginx## è¯´æ˜ï¼š # c1çš„æƒé‡1024ï¼Œc2çš„æƒé‡512,ä¸æ˜¯ç»å¯¹é™åˆ¶ï¼Œè€Œæ˜¯åˆ†é…æ¯”ä¾‹ # è¯¥æƒé‡è¡¨ç¤ºå®¹å™¨åœ¨ CPU ç«äº‰ä¸‹ï¼Œæƒé‡è¶Šé«˜åˆ™ä¼˜å…ˆçº§è¶Šé«˜ï¼Œä¼šå°½å¯èƒ½ä½¿ç”¨ CPU èµ„æºã€‚ # å¦‚æœè¿™ä¸¤ä¸ªå®¹å™¨éƒ½è¿è¡Œåœ¨ CPU å¿™ç¢Œçš„ç¯å¢ƒä¸‹(åªæœ‰åœ¨ å¤šå®¹å™¨å…±äº« CPU ä¸”ç«äº‰èµ„æº çš„æƒ…å†µä¸‹æ‰ç”Ÿæ•ˆ)ï¼š # c1 å°†è·å¾—å¤§çº¦ 2/3 çš„ CPU æ—¶é—´ # c2 å°†è·å¾—å¤§çº¦ 1/3 çš„ CPU æ—¶é—´ # å¦‚æœç³»ç»Ÿ CPU ç©ºé—²ï¼Œæ‰€æœ‰å®¹å™¨éƒ½å¯ä»¥ä½¿ç”¨ 100% çš„ CPUã€‚ docker run ç¤ºä¾‹ 12345678910111213# å¯åŠ¨ä¸€ä¸ªnginx å®¹å™¨docker run -d -p 80:80 --name nginx nginx# æ›¿æ¢nginxé•œåƒé»˜è®¤çš„å¯åŠ¨å‘½ä»¤ï¼Œnginx é•œåƒé»˜è®¤å¯åŠ¨ nginx æœåŠ¡ï¼Œæ­¤å‘½ä»¤ä¼šæ”¹ä¸ºæ‰§è¡Œ nginx -v æ˜¾ç¤ºç‰ˆæœ¬å·docker run --name test_nginx --entrypoint &quot;&quot; nginx nginx -v# æ‰§è¡Œè„šæœ¬æˆ–å‘½ä»¤ï¼Œè¿™é‡Œæ·»åŠ  --rm å‚æ•°ï¼Œè¡¨ç¤ºè¿è¡Œç»“æŸåè‡ªåŠ¨åˆ é™¤å®¹å™¨ï¼Œè¿™é‡Œæ˜¯å®‰è£… ping å‘½ä»¤docker run --rm ubuntu bash -c &quot;apt update &amp;&amp; apt install -y iputils-ping&quot;# äº¤äº’å¼æ‰§è¡Œ shell å‘½ä»¤ï¼Œæ‰§è¡Œå‘½ä»¤åä¼šè¿›å…¥å®¹å™¨çš„shelldocker run --rm -it ubuntu /bin/bash# è¿™æ ·ä¹Ÿå¯ä»¥ï¼Œå› ä¸º ubuntu çš„é»˜è®¤å¯åŠ¨å‘½ä»¤æ˜¯ /bin/bashdocker run --rm -it ubuntu# è½¬åˆ°åå°è¿è¡Œdocker run --rm -itd ubuntu docker stop : åœæ­¢å®¹å™¨ï¼Œå®¹å™¨ä¼˜é›…é€€å‡º 12345678# åœæ­¢å®¹å™¨ï¼Œé€šè¿‡å®¹å™¨åç§°docker stop test_nginx# åœæ­¢å®¹å™¨ï¼Œé€šè¿‡å®¹å™¨IDdocker stop 5d7c0c5d5c0c# åœæ­¢æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„å®¹å™¨docker stop $(docker ps -q)# ç­‰å¾…5ç§’åå¼ºåˆ¶å…³é—­docker stop -t 5 test_nginx docker kill : å¼ºåˆ¶åœæ­¢å®¹å™¨ å½“å®¹å™¨å®Œå…¨å¡æ­»ã€æŒ‚èµ·ã€ä¸å“åº” stop å‘½ä»¤æ—¶ä½¿ç”¨ 123docker kill test_nginxdocker kill 5d7c0c5d5c0cdocker kill $(docker ps -q) docker restart : é‡å¯å®¹å™¨ 123docker restart test_nginxdocker restart 5d7c0c5d5c0cdocker restart $(docker ps -q) docker pause : æš‚åœå®¹å™¨ æš‚åœåå®¿ä¸»æœºå°†ä¸å†ä¸ºå®¹å™¨åˆ†é…CPUæ—¶é—´ç‰‡ï¼Œä½†å†…å­˜ä¾ç„¶æœ‰æ•ˆï¼Œä½ å¯ä»¥ç†è§£ä¸ºæ­¤æ—¶ä¸ºå®¹å™¨ä¿å­˜äº†å¿«ç…§ 123docker pause test_nginxdocker pause 5d7c0c5d5c0cdocker pause $(docker ps -q) docker unpause : æ¢å¤å®¹å™¨ 123docker unpause test_nginxdocker unpause 5d7c0c5d5c0cdocker unpause $(docker ps -q) docker ps : æŸ¥çœ‹å®¹å™¨åˆ—è¡¨ 1234567891011121314# æ˜¾ç¤ºæ‰€æœ‰æ­£åœ¨è¿è¡Œçš„å®¹å™¨docker ps# æ˜¾ç¤ºæ‰€æœ‰å®¹å™¨docker ps -a# æ˜¾ç¤ºæ‰€æœ‰æ­£åœ¨è¿è¡Œçš„å®¹å™¨çš„IDdocker ps -q# ä¸æˆªæ–­è¾“å‡ºï¼Œæ­¤æ—¶ COMMAND åˆ—ä¼šæ˜¾ç¤ºå®Œæ•´çš„å‘½ä»¤docker ps -notrunc# æ˜¾ç¤ºæœ€è¿‘åˆ›å»ºçš„5æ¡å®¹å™¨docker ps -n 5# è¿‡æ»¤å™¨ï¼Œæ˜¾ç¤ºçŠ¶æ€ä¸ºexitedçš„å®¹å™¨docker ps -a --filter &quot;status=exited&quot;# æŒ‡å®šæ¨¡æ¿ï¼Œåªæ˜¾ç¤º ID å’Œ Namesdocker ps --format &quot;&#123;&#123;.ID&#125;&#125;: &#123;&#123;.Names&#125;&#125;&quot; docker inspect : æŸ¥çœ‹å®¹å™¨ä¿¡æ¯ 12345678910111213141516# æŸ¥çœ‹å®¹å™¨ä¿¡æ¯docker inspect &lt;container_id&gt;# è·å–å®¹å™¨åç§°docker inspect --format=&#x27;&#123;&#123;.Name&#125;&#125;&#x27; &lt;container_id | container_name&gt;# è·å–å®¹å™¨é•œåƒdocker inspect --format=&#x27;&#123;&#123;.Config.Image&#125;&#125;&#x27; &lt;container_id | container_name&gt;# è·å–å®¹å™¨ç¯å¢ƒå˜é‡docker inspect --format=&#x27;&#123;&#123;.Config.Env&#125;&#125;&#x27; &lt;container_id | container_name&gt;# è·å–å®¹å™¨çŠ¶æ€ï¼Œå‰é¢çš„ json è¡¨ç¤ºè¾“å‡ºä¸º json æ ¼å¼docker inspect --format=&#x27;&#123;&#123;json .State&#125;&#125;&#x27; &lt;container_id | container_name&gt;# è·å–å®¹å™¨å†…å­˜é™åˆ¶docker inspect --format=&#x27;&#123;&#123;.HostConfig.Memory&#125;&#125;&#x27; &lt;container_id | container_name&gt;# è·å–å®¹å™¨labeldocker inspect --format=&#x27;&#123;&#123;json .Config.Labels&#125;&#125;&#x27; &lt;container_id | container_name&gt;# è·å–å®¹å™¨çš„ç½‘ç»œä¿¡æ¯docker inspect --format=&#x27;&#123;&#123;json .NetworkSettings&#125;&#125;&#x27; &lt;container_id | container_name&gt; docker logs : è·å–å®¹å™¨æ—¥å¿— 12345678910111213141516# è·å–å®¹å™¨æ—¥å¿—docker logs &lt;container_id | container_name&gt;# è·å–å®¹å™¨å®æ—¶æ—¥å¿—docker logs -f &lt;container_id | container_name&gt;# è·å–å®¹å™¨æœ€æ–°çš„ 10 è¡Œæ—¥å¿—docker logs -n 10 &lt;container_id | container_name&gt;# è·å–å®¹å™¨çš„å¸¦æ—¶é—´æˆ³çš„æ—¥å¿—docker logs -t &lt;container_id | container_name&gt;# è·å–å®¹å™¨çš„æ—¥å¿—ï¼Œä» 1 å°æ—¶å‰å¼€å§‹docker logs --since 1h &lt;container_id | container_name&gt;# è·å–å®¹å™¨çš„æ—¥å¿—ï¼Œç›´åˆ° 1 å°æ—¶å‰docker logs --until 1h &lt;container_id | container_name&gt;# è·å–å®¹å™¨çš„è¯¦ç»†æ—¥å¿—docker logs --details &lt;container_id | container_name&gt;# è·å–å®¹å™¨çš„æ—¥å¿—ï¼Œä» 2 å°æ—¶å‰å¼€å§‹ï¼Œç›´åˆ° 1 å°æ—¶å‰docker logs --since 2h --until 1h &lt;container_id | container_name&gt; docker exec : åœ¨å·²ç»è¿è¡Œçš„å®¹å™¨ä¸­æ‰§è¡Œå‘½ä»¤ 1234# åœ¨å·²ç»è¿è¡Œçš„å®¹å™¨ä¸­æ‰§è¡Œå‘½ä»¤docker exec &lt;container_id | container_name&gt; &lt;command&gt;# è¿›å…¥å®¹å™¨shelldocker exec -it &lt;container_id | container_name&gt; bash docker rename : é‡å‘½åå®¹å™¨ 1docker rename &lt;old_container_name&gt; &lt;new_container_name&gt; docker cp : å®¹å™¨ä¸å®¿ä¸»æœºé—´å¤åˆ¶æ–‡ä»¶ 123456# å®¿ä¸»æœº -&gt; å®¹å™¨# docker cp &lt;host_path&gt; &lt;container_id | container_name&gt;:&lt;container_path&gt;docker cp ./docker-command-container.md nginx:/tmp# å®¹å™¨ -&gt; å®¿ä¸»æœº# docker cp &lt;container_id | container_name&gt;:&lt;container_path&gt; &lt;host_path&gt;docker cp nginx:/tmp/docker-command-container.md ./ docker rm : åˆ é™¤å®¹å™¨ 1234# åˆ é™¤æŒ‡å®šå®¹å™¨docker rm &lt;container_id | container_name&gt;# åˆ é™¤æ‰€æœ‰å®¹å™¨docker rm $(docker ps -aq) docker container prune : åˆ é™¤æ‰€æœ‰åœæ­¢çš„å®¹å™¨ 1docker container prune docker update : æ›´æ–°å®¹å™¨é…ç½® 1234# æ›´æ–°æŒ‡å®šå®¹å™¨çš„CPUæ ¸æ•°å’Œå†…å­˜å¤§å°docker update --cpus=2 --memory=2g &lt;container_id | container_name&gt;# æ›´æ–°æŒ‡å®šå®¹å™¨è‡ªåŠ¨é‡å¯docker update --restart=always &lt;container_id | container_name&gt; å¹¶ä¸æ˜¯æ‰€æœ‰çš„é…ç½®éƒ½æ”¯æŒæ›´æ–°ï¼Œupdate å‘½ä»¤åªæ”¯æŒå¦‚ä¸‹é…ç½®ï¼ŒåŸºæœ¬ä¸Šä¹Ÿå°±åªèƒ½è°ƒä¸€ä¸‹cpuå’Œå†…å­˜ï¼Œä»¥åŠè‡ªåŠ¨é‡å¯ç­–ç•¥ï¼Œæ‰€ä»¥åˆ¶ä½œå®¹å™¨æ—¶ä¸€å®šè¦åšå¥½è§„åˆ’ã€‚ å‚æ•°å è¯´æ˜ ç¤ºä¾‹å€¼ --blkio-weight è®¾ç½® Block IO çš„ç›¸å¯¹æƒé‡ï¼ŒèŒƒå›´æ˜¯ 10 åˆ° 1000ï¼Œè®¾ç½®ä¸º 0 è¡¨ç¤ºç¦ç”¨ï¼ˆé»˜è®¤å€¼ä¸º 0ï¼‰ --blkio-weight=500 --cpu-period è®¾ç½® CPU CFSï¼ˆå®Œå…¨å…¬å¹³è°ƒåº¦å™¨ï¼‰çš„å‘¨æœŸé™åˆ¶ï¼ˆå•ä½ï¼šå¾®ç§’ï¼‰ --cpu-period=100000 --cpu-quota è®¾ç½® CPU CFS çš„é…é¢é™åˆ¶ï¼ˆå•ä½ï¼šå¾®ç§’ï¼‰ --cpu-quota=50000 --cpu-rt-period è®¾ç½®å®æ—¶ CPU çš„è°ƒåº¦å‘¨æœŸï¼ˆå•ä½ï¼šå¾®ç§’ï¼‰ --cpu-rt-period=1000000 --cpu-rt-runtime è®¾ç½®å®æ—¶ CPU çš„è¿è¡Œæ—¶é—´é™åˆ¶ï¼ˆå•ä½ï¼šå¾®ç§’ï¼‰ --cpu-rt-runtime=950000 -c, --cpu-shares è®¾ç½® CPU å…±äº«æƒé‡ï¼Œé»˜è®¤å€¼ä¸º 1024 --cpu-shares=512 --cpus é™åˆ¶å®¹å™¨ä½¿ç”¨çš„ CPU æ•°é‡ï¼ˆæ”¯æŒå°æ•°ï¼‰ --cpus=1.5 --cpuset-cpus æŒ‡å®šå®¹å™¨å¯ä»¥åœ¨å“ªäº› CPU ä¸Šè¿è¡Œï¼ˆå¦‚ 0-3ã€0,1ï¼‰ --cpuset-cpus=&quot;0,1&quot; --cpuset-mems æŒ‡å®šå®¹å™¨å¯ä»¥ä½¿ç”¨å“ªäº›å†…å­˜èŠ‚ç‚¹ï¼ˆå¦‚ 0-3ã€0,1ï¼‰ï¼Œé€‚ç”¨äº NUMA ç³»ç»Ÿ --cpuset-mems=&quot;0&quot; -m, --memory è®¾ç½®å†…å­˜é™åˆ¶ï¼ˆä¾‹å¦‚ 512mã€2gï¼‰ --memory=1g --memory-reservation è®¾ç½®å†…å­˜è½¯é™åˆ¶ï¼ˆä½äº --memory çš„å€¼æ—¶ï¼Œå…è®¸ç³»ç»Ÿåœ¨å‹åŠ›è¾ƒå°æ—¶å›æ”¶ï¼‰ --memory-reservation=512m --memory-swap è®¾ç½® swap é™åˆ¶ï¼ˆå†…å­˜ + swap æ€»å’Œï¼‰ï¼Œè®¾ä¸º -1 è¡¨ç¤ºæ— é™åˆ¶ --memory-swap=2g --pids-limit è®¾ç½®å®¹å™¨çš„æœ€å¤§è¿›ç¨‹æ•°é‡ï¼Œè®¾ä¸º -1 è¡¨ç¤ºæ— é™åˆ¶ --pids-limit=100 --restart è®¾ç½®å®¹å™¨é€€å‡ºåçš„é‡å¯ç­–ç•¥ --restart=always docker stats : æ˜¾ç¤ºå®¹å™¨çš„å®æ—¶èµ„æºä½¿ç”¨æƒ…å†µ 12345678910111213141516171819202122232425262728# æ˜¾ç¤ºæ‰€æœ‰å®¹å™¨çš„å®æ—¶èµ„æºä½¿ç”¨æƒ…å†µdocker stats## è¾“å‡ºCONTAINER ID NAME CPU % MEM USAGE / LIMIT MEM % NET I/O BLOCK I/O PIDS15caf520e3a5 nginx 0.00% 10.22MiB / 7.752GiB 0.13% 6.38kB / 2.61kB 0B / 28.7kB 13b680087420b8 dockge 0.01% 199.5MiB / 7.752GiB 2.51% 6.44kB / 1.48kB 94.8MB / 0B 24861dd9c1475f remote-api 0.00% 4.188MiB / 7.752GiB 0.05% 2.77kB / 126B 3.31MB / 0B 1### CONTAINER ID ä¸ NAMEï¼šå®¹å™¨ ID ä¸åç§°ã€‚### CPU % ä¸ MEM %ï¼šå®¹å™¨ä½¿ç”¨çš„ CPU å’Œå†…å­˜çš„ç™¾åˆ†æ¯”ã€‚### MEM USAGE / LIMITï¼šå®¹å™¨æ­£åœ¨ä½¿ç”¨çš„æ€»å†…å­˜ï¼Œä»¥åŠå…è®¸ä½¿ç”¨çš„å†…å­˜æ€»é‡ã€‚### NET I/Oï¼šå®¹å™¨é€šè¿‡å…¶ç½‘ç»œæ¥å£å‘é€å’Œæ¥æ”¶çš„æ•°æ®é‡ã€‚### BLOCK I/Oï¼šå®¹å™¨ä»ä¸»æœºä¸Šçš„å—è®¾å¤‡è¯»å–å’Œå†™å…¥çš„æ•°æ®é‡ã€‚### PIDsï¼šå®¹å™¨åˆ›å»ºçš„è¿›ç¨‹æˆ–çº¿ç¨‹æ•°ã€‚# åˆ—å‡ºæ‰€æœ‰å®¹å™¨çš„èµ„æºä½¿ç”¨æƒ…å†µï¼ŒåŒ…æ‹¬è¿è¡Œå’Œåœæ­¢çš„docker stats -a# å±•ç¤ºå½“å‰çŠ¶æ€å°±ç›´æ¥é€€å‡ºäº†ï¼Œä¸å†å®æ—¶æ›´æ–°ã€‚docker stats --no-stream# æŒ‡å®šè¾“å‡ºæ¨¡æ¿ï¼Œè¿™é‡ŒåŠ ä¸åŠ  table éƒ½å¯ä»¥docker stats --no-stream --format &quot;table &#123;&#123;.Name&#125;&#125;\\t&#123;&#123;.CPUPerc&#125;&#125;\\t&#123;&#123;.MemUsage&#125;&#125;&quot;# è¾“å‡ºjsonæ ¼å¼docker stats --no-stream --format json# æŒ‡å®šå®¹å™¨docker stats &lt;container_id | container_name&gt; docker top : æŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹ 12# docker top &lt;container_id | container_name&gt; [ps options]docker top nginx docker port : åˆ—å‡ºæŒ‡å®šçš„å®¹å™¨çš„ç«¯å£æ˜ å°„ 123# docker port &lt;container_id | container_name&gt;$ docker port nginx80/tcp -&gt; 0.0.0.0:8081 docker diff : åˆ—å‡ºå®¹å™¨è¿è¡Œæ—¶å¯¹æ–‡ä»¶ç³»ç»Ÿçš„ä¿®æ”¹ 1234567891011121314151617181920# docker diff &lt;container_id | container_name&gt;$ docker diff nginxC /rootA /root/.bash_historyC /runA /run/nginx.pidC /tmpA /tmp/demo.pyC /varC /var/cacheC /var/cache/nginxA /var/cache/nginx/client_tempA /var/cache/nginx/fastcgi_tempA /var/cache/nginx/proxy_tempA /var/cache/nginx/scgi_tempA /var/cache/nginx/uwsgi_tempC /etcC /etc/nginxC /etc/nginx/conf.dC /etc/nginx/conf.d/default.conf å‰ç¼€å«ä¹‰è¯´æ˜ï¼š æ ‡å¿— å«ä¹‰ è¯´æ˜ A Addedï¼ˆæ–°å¢ï¼‰ æ–‡ä»¶æˆ–ç›®å½•æ˜¯å®¹å™¨è¿è¡Œåæ–°å¢çš„ C Changedï¼ˆä¿®æ”¹ï¼‰ æ–‡ä»¶æˆ–ç›®å½•æ˜¯å·²æœ‰çš„ï¼Œä½†å†…å®¹æˆ–å…ƒæ•°æ®ï¼ˆå¦‚æƒé™ã€æ—¶é—´æˆ³ç­‰ï¼‰è¢«ä¿®æ”¹äº† D Deletedï¼ˆåˆ é™¤ï¼‰ æ–‡ä»¶æˆ–ç›®å½•æ˜¯å­˜åœ¨äºåŸé•œåƒä¸­çš„ï¼Œä½†åœ¨å®¹å™¨ä¸­è¢«åˆ é™¤ docker commit : ä»å®¹å™¨åˆ›å»ºä¸€ä¸ªæ–°çš„é•œåƒ 12# docker commit &lt;container_id | container_name&gt; [image_name[:tag]]docker commit nginx nginx:v1.0 docker export : å¯¼å‡ºå®¹å™¨å†…å®¹ä¸º tar æ–‡ä»¶ 123docker export nginx &gt; nginx.tardcoker export -o nginx.tar nginxdocker export nginx | gzip &gt; nginx.tar.gz Docker Export / Save / Commit å‘½ä»¤å¯¹æ¯”ä¸å¯¼å…¥æ–¹å¼ä¸€è§ˆè¡¨ å‘½ä»¤ æ“ä½œå¯¹è±¡ è¾“å‡ºå†…å®¹ æ˜¯å¦åŒ…å«å†å²å±‚ï¼ˆé•œåƒå±‚ï¼‰ æ˜¯å¦ä¿ç•™å…ƒæ•°æ®ï¼ˆæ ‡ç­¾ã€å‘½ä»¤ç­‰ï¼‰ å…¸å‹ç”¨é€” å¯¼å…¥å‘½ä»¤ docker export å®¹å™¨ å®¹å™¨çš„æ–‡ä»¶ç³»ç»Ÿï¼ˆtar å½’æ¡£ï¼‰ âŒ å¦ âŒ å¦ å¤‡ä»½å®¹å™¨æ–‡ä»¶ç³»ç»Ÿæˆ–è¿ç§»å®¹å™¨çŠ¶æ€ docker import &lt;tar&gt; &lt;image:tag&gt; docker save é•œåƒ é•œåƒçš„å®Œæ•´å†…å®¹ï¼ˆå«æ‰€æœ‰å±‚çš„ tarï¼‰ âœ… æ˜¯ âœ… æ˜¯ åˆ†å‘æˆ–å¤‡ä»½é•œåƒ docker load &lt; &lt;tar&gt; docker commit å®¹å™¨ åˆ›å»ºä¸€ä¸ªæ–°çš„é•œåƒ âœ… æ˜¯ï¼ˆä½†åªä¸€å±‚ï¼‰ âœ… æ˜¯ å°†å½“å‰å®¹å™¨çŠ¶æ€æ‰“åŒ…æˆæ–°é•œåƒ ä¸é€‚ç”¨ï¼ˆç›´æ¥ç”Ÿæˆé•œåƒï¼‰","summary":"æ‘˜è¦ æœ¬æ–‡ä»‹ç» Docker å‘½ä»¤ ä¸­ å®¹å™¨ç®¡ç† ç›¸å…³å‘½ä»¤ Dockerå®˜æ–¹æ–‡æ¡£","date_published":"2025-05-27T13:30:05.000Z","tags":["æŠ€æœ¯","docker","docker"]},{"id":"https://blog.hanqunfeng.com/2025/05/26/docker-dockerfile/","url":"https://blog.hanqunfeng.com/2025/05/26/docker-dockerfile/","title":"Docker å‘½ä»¤ ä¹‹ Dockerfile","content_html":"<!--\n **åŠ ç²—**\n *æ–œä½“*\n ***åŠ ç²—å¹¶æ–œä½“***\n ~~åˆ é™¤çº¿~~\n ==çªå‡ºæ˜¾ç¤º==\n `çªå‡ºæ˜¾ç¤º(æ¨è)`\n ++ä¸‹åˆ’çº¿++\n ~ä¸‹æ ‡~\n ^ä¸Šæ ‡^\n è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference.\n å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)\n\n +++ **ç‚¹å‡»æŠ˜å **\n è¿™æ˜¯è¢«éšè—çš„å†…å®¹\n +++\n\n::: tips success warning danger\nè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹\n:::\n\n% note info % success warning danger\nè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹\n% endnote %\n\nå¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{}\n å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ\n -->\n<h2 id=\"æ‘˜è¦\">æ‘˜è¦</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æœ¬æ–‡ä»‹ç» Docker å‘½ä»¤ ä¸­ Dockerfile çš„ä½¿ç”¨æ–¹æ³•</p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://docs.docker.com\">Dockerå®˜æ–¹æ–‡æ¡£</a></p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://docs.docker.com/engine/reference/builder/\">Dockerfileå®˜æ–¹æ–‡æ¡£</a></p>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"Dockerfile-æ˜¯ä»€ä¹ˆï¼Ÿ\">Dockerfile æ˜¯ä»€ä¹ˆï¼Ÿ</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Dockerå¯ä»¥é€šè¿‡è¯»å– <code>Dockerfile</code> ä¸­çš„æŒ‡ä»¤æ¥è‡ªåŠ¨æ„å»ºé•œåƒã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p><code>Dockerfile</code> æ˜¯ä¸€ä¸ªæ–‡æœ¬æ–‡æ¡£ï¼Œå…¶ä¸­åŒ…å«ç”¨æˆ·å¯ä»¥åœ¨å‘½ä»¤è¡Œä¸Šè°ƒç”¨ä»¥ç»„è£…é•œåƒçš„æ‰€æœ‰æŒ‡ä»¤ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>å¯ä»¥åœ¨Dockerfileä¸­ä½¿ç”¨çš„æŒ‡ä»¤ï¼š</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>æŒ‡ä»¤</th>\n<th>ä¸­æ–‡æè¿°</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>ADD</strong></td>\n<td>å°†æœ¬åœ°æˆ–è¿œç¨‹çš„æ–‡ä»¶/ç›®å½•æ·»åŠ åˆ°é•œåƒä¸­ï¼Œæ”¯æŒè‡ªåŠ¨è§£å‹ <code>.tar</code> æ–‡ä»¶å’Œä½¿ç”¨ URL ä¸‹è½½è¿œç¨‹èµ„æºã€‚é€šå¸¸æ¨èä½¿ç”¨ <code>COPY</code>ï¼Œé™¤ééœ€è¦è¿™äº›é«˜çº§åŠŸèƒ½ã€‚</td>\n</tr>\n<tr>\n<td><strong>ARG</strong></td>\n<td>å®šä¹‰æ„å»ºé˜¶æ®µä½¿ç”¨çš„å˜é‡ï¼Œå¯åœ¨ <code>docker build</code> å‘½ä»¤ä¸­é€šè¿‡ <code>--build-arg</code> ä¼ å…¥ï¼Œå˜é‡ä»…åœ¨æ„å»ºæ—¶æœ‰æ•ˆï¼Œä¸ä¼šä¿ç•™åœ¨æœ€ç»ˆé•œåƒä¸­ã€‚</td>\n</tr>\n<tr>\n<td><strong>CMD</strong></td>\n<td>æŒ‡å®šå®¹å™¨é»˜è®¤æ‰§è¡Œçš„å‘½ä»¤å’Œå‚æ•°ï¼Œå®¹å™¨è¿è¡Œæ—¶è‹¥æœªæŒ‡å®šå‘½ä»¤ï¼Œåˆ™ä½¿ç”¨è¯¥æŒ‡ä»¤è®¾ç½®çš„å‘½ä»¤ã€‚å¦‚æœé…ç½®äº†å¤šä¸ª<code>CMD</code>ï¼Œåˆ™åªæœ‰æœ€åä¸€ä¸ªç”Ÿæ•ˆã€‚å’Œ<code>ENTRYPOINT</code>å…±åŒä½¿ç”¨æ—¶ï¼Œä½œä¸ºä¼ é€’ç»™<code>ENTRYPOINT</code>çš„å‚æ•°ã€‚å¯è¢« <code>docker run</code> æä¾›çš„å‘½ä»¤è¦†ç›–ã€‚</td>\n</tr>\n<tr>\n<td><strong>COPY</strong></td>\n<td>å°†æ„å»ºä¸Šä¸‹æ–‡ä¸­çš„æ–‡ä»¶æˆ–ç›®å½•å¤åˆ¶åˆ°é•œåƒä¸­ã€‚ç›¸æ¯” <code>ADD</code> æ›´ç®€å•ã€å®‰å…¨ï¼Œæ¨èä¼˜å…ˆä½¿ç”¨ã€‚</td>\n</tr>\n<tr>\n<td><strong>ENTRYPOINT</strong></td>\n<td>æŒ‡å®šå®¹å™¨å¯åŠ¨æ—¶çš„ä¸»å‘½ä»¤ï¼Œä¸å®¹æ˜“è¢« <code>docker run</code> ä¸­çš„å‘½ä»¤è¦†ç›–ã€‚å¯ä¸ <code>CMD</code> é…åˆä½¿ç”¨ï¼Œç”¨äºæä¾›é»˜è®¤å‚æ•°ã€‚</td>\n</tr>\n<tr>\n<td><strong>ENV</strong></td>\n<td>è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œå˜é‡å°†åœ¨æ„å»ºå’Œå®¹å™¨è¿è¡Œæ—¶å‡å¯ä½¿ç”¨ã€‚ä¾‹å¦‚ï¼šé…ç½®åº”ç”¨å‚æ•°æˆ–ç³»ç»Ÿè·¯å¾„ç­‰ã€‚</td>\n</tr>\n<tr>\n<td><strong>EXPOSE</strong></td>\n<td>å£°æ˜å®¹å™¨è¿è¡Œæ—¶å°†å¼€æ”¾çš„ç«¯å£ï¼Œä»…ç”¨äºæ–‡æ¡£è¯´æ˜æˆ–ä¸å®¹å™¨ç¼–æ’å·¥å…·é…åˆï¼Œä¸ä¼šè‡ªåŠ¨è¿›è¡Œç«¯å£æ˜ å°„ã€‚</td>\n</tr>\n<tr>\n<td><strong>FROM</strong></td>\n<td>æŒ‡å®šåŸºç¡€é•œåƒï¼Œæ˜¯ Dockerfile çš„èµ·ç‚¹ã€‚ä¹Ÿå¯ä»¥ç”¨äºå¤šé˜¶æ®µæ„å»ºï¼Œé€šè¿‡å¤šæ¬¡ä½¿ç”¨ <code>FROM</code> æŒ‡ä»¤åˆ›å»ºå¤šä¸ªæ„å»ºé˜¶æ®µã€‚</td>\n</tr>\n<tr>\n<td><strong>HEALTHCHECK</strong></td>\n<td>å®šä¹‰å®¹å™¨å¥åº·æ£€æŸ¥å‘½ä»¤ï¼Œç”¨äºå®šæœŸæ£€æµ‹å®¹å™¨å†…éƒ¨æœåŠ¡çš„å¥åº·çŠ¶æ€ï¼Œå¯ç»“åˆå®¹å™¨ç¼–æ’ç³»ç»Ÿå®ç°æ•…éšœè‡ªåŠ¨æ¢å¤ã€‚</td>\n</tr>\n<tr>\n<td><strong>LABEL</strong></td>\n<td>ä¸ºé•œåƒæ·»åŠ é”®å€¼å¯¹å½¢å¼çš„å…ƒæ•°æ®ï¼Œä¾‹å¦‚ç‰ˆæœ¬ã€ç»´æŠ¤è€…ã€ç”¨é€”è¯´æ˜ç­‰ï¼Œæ–¹ä¾¿é•œåƒç®¡ç†ä¸è‡ªåŠ¨åŒ–å¤„ç†ã€‚</td>\n</tr>\n<tr>\n<td><strong>MAINTAINER</strong></td>\n<td>ï¼ˆå·²å¼ƒç”¨ï¼‰ç”¨äºæŒ‡å®šé•œåƒç»´æŠ¤è€…ä¿¡æ¯ï¼Œæ¨èæ”¹ç”¨ <code>LABEL</code> æ¥è®¾ç½®ä½œè€…ä¿¡æ¯ã€‚</td>\n</tr>\n<tr>\n<td><strong>ONBUILD</strong></td>\n<td>å®šä¹‰ä¸€ä¸ªè§¦å‘æŒ‡ä»¤ï¼Œå½“å½“å‰é•œåƒä½œä¸ºåŸºç¡€é•œåƒè¢«å…¶ä»– Dockerfile ä½¿ç”¨æ—¶è‡ªåŠ¨æ‰§è¡Œã€‚å¸¸ç”¨äºåŸºç¡€é•œåƒçš„é¢„è®¾è¡Œä¸ºã€‚</td>\n</tr>\n<tr>\n<td><strong>RUN</strong></td>\n<td>æ‰§è¡Œä¸€æ¡å‘½ä»¤å¹¶æäº¤ç»“æœä½œä¸ºæ–°é•œåƒå±‚ï¼Œå¸¸ç”¨äºå®‰è£…è½¯ä»¶åŒ…ã€å¤åˆ¶æ–‡ä»¶ã€è®¾ç½®æƒé™ç­‰æ„å»ºæ“ä½œã€‚</td>\n</tr>\n<tr>\n<td><strong>SHELL</strong></td>\n<td>æ›´æ”¹ Dockerfile ä¸­åç»­ <code>RUN</code>ã€<code>CMD</code>ã€<code>ENTRYPOINT</code> ç­‰æŒ‡ä»¤çš„é»˜è®¤ shellï¼ˆå¦‚ä½¿ç”¨ <code>sh</code> æˆ– <code>powershell</code>ï¼‰ã€‚</td>\n</tr>\n<tr>\n<td><strong>STOPSIGNAL</strong></td>\n<td>è®¾ç½®å®¹å™¨ç»ˆæ­¢æ—¶å‘é€çš„ç³»ç»Ÿä¿¡å·ï¼ˆå¦‚ <code>SIGTERM</code>ï¼‰ï¼Œç”¨äºä¼˜é›…å…³é—­åº”ç”¨ã€‚</td>\n</tr>\n<tr>\n<td><strong>USER</strong></td>\n<td>è®¾ç½®æ‰§è¡Œåç»­å‘½ä»¤æ—¶æ‰€ä½¿ç”¨çš„ç”¨æˆ·å’Œç”¨æˆ·ç»„ï¼Œå¢å¼ºå®¹å™¨çš„å®‰å…¨æ€§ï¼Œé¿å…ä½¿ç”¨ root æƒé™ã€‚</td>\n</tr>\n<tr>\n<td><strong>VOLUME</strong></td>\n<td>å®šä¹‰å®¹å™¨å†…çš„æŒ‚è½½ç‚¹ï¼Œç”¨äºæŒä¹…åŒ–æ•°æ®æˆ–ä¸å®¿ä¸»æœº/å…¶ä»–å®¹å™¨å…±äº«æ•°æ®ã€‚è¿è¡Œå®¹å™¨æ—¶å¯æŒ‡å®šæŒ‚è½½è·¯å¾„ã€‚</td>\n</tr>\n<tr>\n<td><strong>WORKDIR</strong></td>\n<td>è®¾ç½®å·¥ä½œç›®å½•ï¼Œç›¸å½“äºæ‰§è¡Œ <code>cd</code>ï¼Œç”¨äºç®€åŒ–åç»­å‘½ä»¤ä¸­çš„è·¯å¾„ã€‚è‹¥ç›®å½•ä¸å­˜åœ¨åˆ™è‡ªåŠ¨åˆ›å»ºã€‚</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æ„å»ºé˜¶æ®µæŒ‡ä»¤ï¼šFROM, ARG, ENV, COPY, ADD, RUN, WORKDIR, LABEL, USER, SHELL, ONBUILD</p>\n</li>\n<li class=\"lvl-2\">\n<p>å¯åŠ¨é…ç½®æŒ‡ä»¤ï¼šCMD, ENTRYPOINT, HEALTHCHECK, EXPOSE, VOLUME, STOPSIGNAL</p>\n</li>\n</ul>\n<h2 id=\"Dockerfile-æŒ‡ä»¤ä»‹ç»\">Dockerfile æŒ‡ä»¤ä»‹ç»</h2>\n<h3 id=\"FROM\">FROM</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>FROM æŒ‡ä»¤ç”¨äºæŒ‡å®šåŸºç¡€é•œåƒï¼ˆbase imageï¼‰ï¼Œæ˜¯æ¯ä¸€ä¸ª Dockerfile ä¸­å¿…é¡»çš„ç¬¬ä¸€æ¡æŒ‡ä»¤ã€‚æ‰€æœ‰åç»­æŒ‡ä»¤éƒ½æ˜¯åŸºäºè¿™ä¸ªåŸºç¡€é•œåƒæ„å»ºçš„ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>è¯­æ³•</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">FROM &lt;image&gt;[:&lt;tag&gt;] [AS &lt;stage-name&gt;]</span><br><span class=\"line\"><span class=\"comment\"># è¯´æ˜ï¼š</span></span><br><span class=\"line\"><span class=\"comment\">#   &lt;image&gt;ï¼šé•œåƒåç§°ï¼ˆå¯ä»¥æ˜¯æœ¬åœ°å·²æœ‰çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯ä» Docker Hub æˆ–å…¶ä»–é•œåƒä»“åº“æ‹‰å–çš„ï¼‰</span></span><br><span class=\"line\"><span class=\"comment\">#   [:&lt;tag&gt;]ï¼šé•œåƒæ ‡ç­¾ï¼ˆå¯é€‰ï¼Œé»˜è®¤æ˜¯ latestï¼‰</span></span><br><span class=\"line\"><span class=\"comment\">#   [AS &lt;stage-name&gt;]ï¼šä¸ºè¯¥æ„å»ºé˜¶æ®µæŒ‡å®šåç§°ï¼Œç”¨äºå¤šé˜¶æ®µæ„å»º</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ç¤ºä¾‹</p>\n</li>\n</ul>\n<figure class=\"highlight dockerfile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„é•œåƒï¼ˆé»˜è®¤æ ‡ç­¾æ˜¯ latestï¼‰</span></span><br><span class=\"line\"><span class=\"keyword\">FROM</span> node</span><br><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨æŒ‡å®šçš„æ ‡ç­¾</span></span><br><span class=\"line\"><span class=\"keyword\">FROM</span> node:<span class=\"number\">16.13</span>.<span class=\"number\">2</span>-alpine</span><br><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨ç§æœ‰é•œåƒä»“åº“</span></span><br><span class=\"line\"><span class=\"keyword\">FROM</span> private.registry.com/my-image:latest</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨å¤šé˜¶æ®µæ„å»º</span></span><br><span class=\"line\"><span class=\"keyword\">FROM</span> golang:<span class=\"number\">1.20</span> AS builder</span><br><span class=\"line\"><span class=\"keyword\">WORKDIR</span><span class=\"language-bash\"> /app</span></span><br><span class=\"line\"><span class=\"keyword\">COPY</span><span class=\"language-bash\"> . .</span></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"language-bash\"> go build -o myapp</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">FROM</span> alpine:latest</span><br><span class=\"line\"><span class=\"keyword\">COPY</span><span class=\"language-bash\"> --from=builder /app/myapp /usr/local/bin/myapp</span></span><br><span class=\"line\"><span class=\"keyword\">ENTRYPOINT</span><span class=\"language-bash\"> [<span class=\"string\">&quot;myapp&quot;</span>]</span></span><br><span class=\"line\"><span class=\"comment\">## è¿™é‡Œç”¨äº†ä¸¤ä¸ªé˜¶æ®µï¼š</span></span><br><span class=\"line\"><span class=\"comment\">###   builder é˜¶æ®µç”¨æ¥ç¼–è¯‘åº”ç”¨ï¼›</span></span><br><span class=\"line\"><span class=\"comment\">###   alpine é˜¶æ®µç”¨æ¥æ‰“åŒ…æœ€ç»ˆé•œåƒï¼ŒåªåŒ…å«ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå‡å°‘ä½“ç§¯ã€‚</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"WORKDIR\">WORKDIR</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>WORKDIR æŒ‡å®šäº†å·¥ä½œç›®å½•ï¼Œå³åç»­æ‰€æœ‰æŒ‡ä»¤ï¼ˆå¦‚ RUNã€CMDã€ENTRYPOINTã€COPYã€ADD ç­‰ï¼‰æ‰€è¿è¡Œçš„å½“å‰è·¯å¾„ï¼ˆworking directoryï¼‰ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>å¦‚æœç›®å½•ä¸å­˜åœ¨ï¼ŒDocker ä¼šè‡ªåŠ¨åˆ›å»ºå®ƒã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>æ¯ä¸ª WORKDIR éƒ½ä¼šåˆ›å»ºä¸€å±‚é•œåƒï¼ˆlayerï¼‰ï¼Œæ‰€ä»¥ä¸è¦é‡å¤è®¾ç½®æ— æ„ä¹‰çš„è·¯å¾„ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>è¯­æ³•</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">WORKDIR &lt;path&gt;</span><br><span class=\"line\"><span class=\"comment\"># è¯´æ˜ï¼š</span></span><br><span class=\"line\"><span class=\"comment\">#   &lt;path&gt;ï¼šè¦åˆ‡æ¢çš„å·¥ä½œç›®å½•ï¼Œå¯ä»¥æ˜¯ç»å¯¹è·¯å¾„æˆ–ç›¸å¯¹è·¯å¾„ã€‚</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ç¤ºä¾‹</p>\n</li>\n</ul>\n<figure class=\"highlight dockerfile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># è®¾ç½®ç»å¯¹è·¯å¾„</span></span><br><span class=\"line\"><span class=\"keyword\">WORKDIR</span><span class=\"language-bash\"> /app</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># è¿ç»­è®¾ç½®å¤šä¸ªå·¥ä½œç›®å½•ï¼ˆé€å±‚åµŒå¥—ï¼‰</span></span><br><span class=\"line\"><span class=\"keyword\">WORKDIR</span><span class=\"language-bash\"> /var</span></span><br><span class=\"line\"><span class=\"keyword\">WORKDIR</span><span class=\"language-bash\"> www</span></span><br><span class=\"line\"><span class=\"keyword\">WORKDIR</span><span class=\"language-bash\"> html</span></span><br><span class=\"line\"><span class=\"comment\"># ç­‰åŒäº:</span></span><br><span class=\"line\"><span class=\"keyword\">WORKDIR</span><span class=\"language-bash\"> /var/www/html</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># é¿å…åœ¨ RUN cd some_dir åç»§ç»­æ‰§è¡Œä¾èµ–è·¯å¾„çš„å‘½ä»¤ï¼Œå› ä¸º Docker æ¯ä¸€æ¡æŒ‡ä»¤éƒ½æ˜¯æ–°çš„ shell å®ä¾‹ï¼Œcd ä¸ä¼šè·¨æŒ‡ä»¤ä¿ç•™ï¼Œåº”è¯¥æ”¹ç”¨ WORKDIRã€‚</span></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"language-bash\"> <span class=\"built_in\">cd</span> some_dir  <span class=\"comment\"># é”™è¯¯</span></span></span><br><span class=\"line\"><span class=\"keyword\">WORKDIR</span><span class=\"language-bash\"> some_dir <span class=\"comment\"># æ­£ç¡®</span></span></span><br></pre></td></tr></table></figure>\n<h3 id=\"ARG\">ARG</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ARG ç”¨äºåœ¨ æ„å»ºé•œåƒæ—¶ï¼ˆbuild-timeï¼‰ä¼ å…¥å‚æ•°ã€‚è¿™äº›å‚æ•°åªåœ¨ æ„å»ºé˜¶æ®µæœ‰æ•ˆï¼Œä¸ä¼šå‡ºç°åœ¨æœ€ç»ˆé•œåƒä¸­ï¼Œä¹Ÿä¸ä¼šåœ¨å®¹å™¨è¿è¡Œæ—¶è¢«ä¿ç•™ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>è¯­æ³•</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ARG &lt;name&gt;[=&lt;default_value&gt;]</span><br><span class=\"line\"><span class=\"comment\"># è¯´æ˜ï¼š</span></span><br><span class=\"line\"><span class=\"comment\">#   &lt;name&gt;ï¼šå‚æ•°åç§°</span></span><br><span class=\"line\"><span class=\"comment\">#   [=&lt;default_value&gt;]ï¼šå‚æ•°çš„é»˜è®¤å€¼ï¼Œå¦‚æœæœªä¼ å…¥å‚æ•°ï¼Œåˆ™ä½¿ç”¨é»˜è®¤å€¼ï¼Œå¦‚æœä¸ºè®¾ç½®default_valueï¼Œåˆ™æ„å»ºé•œåƒæ—¶å¿…é¡»ä¼ é€’å‚æ•°ï¼Œ--build-arg</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ç¤ºä¾‹</p>\n</li>\n</ul>\n<figure class=\"highlight dockerfile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># å®šä¹‰ä¸€ä¸ªå‚æ•°ï¼Œåœ¨æ„å»ºé•œåƒæ—¶å¿…é¡»ä¼ å…¥å‚æ•°ï¼Œ--build-arg APP_ENV=development</span></span><br><span class=\"line\"><span class=\"keyword\">ARG</span> APP_ENV</span><br><span class=\"line\"><span class=\"comment\"># å¸¦é»˜è®¤å€¼çš„ ARG</span></span><br><span class=\"line\"><span class=\"keyword\">ARG</span> APP_ENV=development</span><br><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨å‚æ•°</span></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"language-bash\"> <span class=\"built_in\">echo</span> <span class=\"string\">&quot;å½“å‰ç¯å¢ƒï¼š<span class=\"variable\">$&#123;APP_ENV&#125;</span>&quot;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ä¸ FROM ä¸€èµ·ç”¨ï¼ˆä» Docker 17.05 èµ·ï¼‰</span></span><br><span class=\"line\"><span class=\"keyword\">ARG</span> BASE=ubuntu</span><br><span class=\"line\"><span class=\"keyword\">FROM</span> $&#123;BASE&#125;:<span class=\"number\">22.04</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"ENV\">ENV</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ENV æŒ‡ä»¤ç”¨äºåœ¨é•œåƒæ„å»ºè¿‡ç¨‹ä¸­å®šä¹‰ç¯å¢ƒå˜é‡ï¼ˆEnvironment Variablesï¼‰ã€‚è¿™äº›å˜é‡å¯ä»¥åœ¨ä¹‹åçš„æ„å»ºæ­¥éª¤ï¼ˆæ¯”å¦‚ RUNã€CMD ç­‰ï¼‰ä¸­ä½¿ç”¨ï¼Œä¹Ÿä¼šåœ¨å®¹å™¨è¿è¡Œæ—¶ç”Ÿæ•ˆã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>è¯­æ³•</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ä¸¤ç§è¯­æ³•</span></span><br><span class=\"line\">ENV &lt;key&gt; &lt;value&gt;</span><br><span class=\"line\">ENV &lt;key&gt;=&lt;value&gt; ...</span><br><span class=\"line\"><span class=\"comment\"># è¯´æ˜ï¼š</span></span><br><span class=\"line\"><span class=\"comment\">#   &lt;key&gt;ï¼šç¯å¢ƒå˜é‡çš„åç§°</span></span><br><span class=\"line\"><span class=\"comment\">#   &lt;value&gt;ï¼šç¯å¢ƒå˜é‡çš„å€¼</span></span><br><span class=\"line\"><span class=\"comment\"># å¦‚æœå®šä¹‰å¤šä¸ªå˜é‡ï¼Œæ¨èä½¿ç”¨ key=value çš„å½¢å¼ã€‚</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ç¤ºä¾‹</p>\n</li>\n</ul>\n<figure class=\"highlight dockerfile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># å®šä¹‰ä¸€ä¸ªç¯å¢ƒå˜é‡</span></span><br><span class=\"line\"><span class=\"keyword\">ENV</span> APP_ENV=production</span><br><span class=\"line\"><span class=\"comment\"># å®šä¹‰å¤šä¸ªå˜é‡</span></span><br><span class=\"line\"><span class=\"keyword\">ENV</span> APP_PORT=<span class=\"number\">8080</span> NODE_ENV=production</span><br><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨å¤šè¡Œæ ¼å¼ï¼ˆæé«˜å¯è¯»æ€§ï¼‰</span></span><br><span class=\"line\"><span class=\"keyword\">ENV</span> PATH=<span class=\"string\">&quot;/usr/local/bin:$&#123;PATH&#125;&quot;</span> \\</span><br><span class=\"line\">    LANG=<span class=\"string\">&quot;en_US.UTF-8&quot;</span> \\</span><br><span class=\"line\">    TZ=<span class=\"string\">&quot;Asia/Shanghai&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># ä¹Ÿå¯ä»¥åˆ†å¼€å®šä¹‰</span></span><br><span class=\"line\"><span class=\"keyword\">ENV</span> PATH=<span class=\"string\">&quot;/usr/local/bin:$PATH&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">ENV</span> LANG=<span class=\"string\">&quot;en_US.UTF-8&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">ENV</span> TZ=<span class=\"string\">&quot;Asia/Shanghai&quot;</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æ³¨æ„ï¼šENV æŒ‡ä»¤å®šä¹‰çš„ç¯å¢ƒå˜é‡åœ¨æ„å»ºé˜¶æ®µå’Œè¿è¡Œé˜¶æ®µéƒ½ä¼šç”Ÿæ•ˆï¼Œä½†è¿è¡Œé˜¶æ®µä¼šè¦†ç›–æ„å»ºé˜¶æ®µå®šä¹‰çš„å˜é‡ã€‚</p>\n</li>\n</ul>\n<h3 id=\"LABEL\">LABEL</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>LABEL ç”¨äºä¸ºé•œåƒæ·»åŠ å…ƒæ•°æ®æ ‡ç­¾ï¼Œä»¥ <code>key=value</code> çš„å½¢å¼å­˜åœ¨ã€‚è¿™äº›æ ‡ç­¾å¯ä»¥æ˜¯ä½œè€…ä¿¡æ¯ã€ç‰ˆæœ¬æè¿°ã€ç”¨é€”è¯´æ˜ã€æ„å»ºæ—¶é—´ç­‰ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>æ—§çš„ <code>MAINTAINER</code> æŒ‡ä»¤ç°åœ¨å·²è¢«åºŸå¼ƒï¼Œæ¨èä½¿ç”¨ <code>LABEL</code> æ¥ä»£æ›¿ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>æ¯ä¸ª LABEL éƒ½ä¼šåˆ›å»ºä¸€å±‚é•œåƒï¼ˆlayerï¼‰ï¼Œæ¨èä¸€æ¬¡è®¾ç½®å¤šä¸ªã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>è¯­æ³•</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">LABEL &lt;key&gt;=&lt;value&gt; [&lt;key&gt;=&lt;value&gt;...]</span><br><span class=\"line\"><span class=\"comment\"># è¯´æ˜ï¼š</span></span><br><span class=\"line\"><span class=\"comment\">#   &lt;key&gt;ï¼šæ ‡ç­¾çš„é”®</span></span><br><span class=\"line\"><span class=\"comment\">#   &lt;value&gt;ï¼šæ ‡ç­¾çš„å€¼</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ç¤ºä¾‹</p>\n</li>\n</ul>\n<figure class=\"highlight dockerfile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># æ·»åŠ ä¸€ä¸ªæ ‡ç­¾</span></span><br><span class=\"line\"><span class=\"keyword\">LABEL</span><span class=\"language-bash\"> maintainer=<span class=\"string\">&quot;yourname@example.com&quot;</span></span></span><br><span class=\"line\"><span class=\"comment\"># æ¢è¡Œæ ¼å¼ï¼ˆæ¨èï¼‰,ä»¥ä¸‹æ ‡ç­¾ç¬¦åˆ OCIï¼ˆOpen Container Initiativeï¼‰ é•œåƒè§„èŒƒ</span></span><br><span class=\"line\"><span class=\"keyword\">LABEL</span><span class=\"language-bash\"> \\</span></span><br><span class=\"line\"><span class=\"language-bash\">    org.opencontainers.image.title=<span class=\"string\">&quot;MyApp&quot;</span> \\</span></span><br><span class=\"line\"><span class=\"language-bash\">    org.opencontainers.image.description=<span class=\"string\">&quot;æ¼”ç¤ºé¡¹ç›®&quot;</span> \\</span></span><br><span class=\"line\"><span class=\"language-bash\">    org.opencontainers.image.version=<span class=\"string\">&quot;1.0.0&quot;</span> \\</span></span><br><span class=\"line\"><span class=\"language-bash\">    org.opencontainers.image.authors=<span class=\"string\">&quot;zhangsan@example.com&quot;</span></span></span><br></pre></td></tr></table></figure>\n<h3 id=\"USER\">USER</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>USER æŒ‡ä»¤ç”¨äºæŒ‡å®šåç»­æŒ‡ä»¤ï¼ˆå¦‚ RUNã€CMDã€ENTRYPOINTã€COPY ç­‰ï¼‰ä»¥å“ªä¸ªç”¨æˆ·èº«ä»½æ¥æ‰§è¡Œã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒDocker å®¹å™¨ä¸­çš„å‘½ä»¤ä»¥ root ç”¨æˆ·è¿è¡Œï¼Œè¿™è™½ç„¶çµæ´»ä½†ä¸å®‰å…¨ã€‚ä½¿ç”¨ USER å¯ä»¥è®©æˆ‘ä»¬åˆ‡æ¢åˆ°æ™®é€šç”¨æˆ·ï¼Œä»è€Œæå‡å®¹å™¨çš„å®‰å…¨æ€§ï¼Œé˜²æ­¢æ½œåœ¨çš„æƒé™æ»¥ç”¨ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>è¯­æ³•</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">USER &lt;user&gt;[:&lt;group&gt;]</span><br><span class=\"line\"><span class=\"comment\"># è¯´æ˜ï¼š</span></span><br><span class=\"line\"><span class=\"comment\">#   &lt;user&gt;ï¼šç”¨æˆ·åæˆ– UID</span></span><br><span class=\"line\"><span class=\"comment\">#   [:&lt;group&gt;]ï¼šå¯é€‰ï¼Œç”¨æˆ·ç»„åæˆ– GID</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ç¤ºä¾‹</p>\n</li>\n</ul>\n<figure class=\"highlight dockerfile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># è®¾ç½®ç”¨æˆ·</span></span><br><span class=\"line\"><span class=\"keyword\">USER</span> appuser</span><br><span class=\"line\"><span class=\"comment\"># è®¾ç½®ç”¨æˆ·ç»„</span></span><br><span class=\"line\"><span class=\"keyword\">USER</span> appuser:appgroup</span><br><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨ UID å’Œ GID</span></span><br><span class=\"line\"><span class=\"keyword\">USER</span> <span class=\"number\">1000</span>:<span class=\"number\">1000</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å¦‚æœåŸºç¡€é•œåƒä¸­æ²¡æœ‰ä½ æƒ³è¦çš„ç”¨æˆ·ï¼Œéœ€è¦åœ¨ Dockerfile ä¸­æ‰‹åŠ¨åˆ›å»º</p>\n</li>\n</ul>\n<figure class=\"highlight dockerfile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># åˆ›å»ºç”¨æˆ·å’Œç»„</span></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"language-bash\"> groupadd -r appgroup &amp;&amp; useradd -r -g appgroup appuser</span></span><br><span class=\"line\"><span class=\"comment\"># åˆ‡æ¢ç”¨æˆ·</span></span><br><span class=\"line\"><span class=\"keyword\">USER</span> appuser</span><br></pre></td></tr></table></figure>\n<h3 id=\"ADD\">ADD</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ADD ç”¨äºå°†æœ¬åœ°æ–‡ä»¶æˆ–ç›®å½•ã€è¿œç¨‹æ–‡ä»¶ï¼ˆURLï¼‰ æˆ– å‹ç¼©åŒ… å¤åˆ¶åˆ°é•œåƒä¸­çš„æŒ‡å®šä½ç½®ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>å®ƒçš„åŠŸèƒ½ç±»ä¼¼äº COPYï¼Œä½†æ¯” COPY å¤šå‡ ä¸ªåŠŸèƒ½ï¼ˆè§£å‹ã€æ‹‰å–è¿œç¨‹æ–‡ä»¶ç­‰ï¼‰ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>è¯­æ³•</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ADD &lt;src&gt;... &lt;dest&gt;</span><br><span class=\"line\"><span class=\"comment\"># è¯´æ˜ï¼š</span></span><br><span class=\"line\"><span class=\"comment\">#   &lt;src&gt;ï¼šè¦å¤åˆ¶çš„æ–‡ä»¶æˆ–ç›®å½•ï¼Œå¯ä»¥æ˜¯æœ¬åœ°æ–‡ä»¶ã€è¿œç¨‹ URLã€å‹ç¼©åŒ…ç­‰</span></span><br><span class=\"line\"><span class=\"comment\">#   &lt;dest&gt;ï¼šç›®æ ‡è·¯å¾„</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ç¤ºä¾‹</p>\n</li>\n</ul>\n<figure class=\"highlight dockerfile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ä»æœ¬åœ°æ–‡ä»¶å¤åˆ¶</span></span><br><span class=\"line\"><span class=\"keyword\">ADD</span><span class=\"language-bash\"> app.jar /app.jar</span></span><br><span class=\"line\"><span class=\"comment\"># å¤åˆ¶å¤šä¸ª</span></span><br><span class=\"line\"><span class=\"keyword\">ADD</span><span class=\"language-bash\"> app1.jar app2.jar /app/</span></span><br><span class=\"line\"><span class=\"comment\"># é€šé…ç¬¦</span></span><br><span class=\"line\"><span class=\"keyword\">ADD</span><span class=\"language-bash\"> static-assets/*.html /app/public/</span></span><br><span class=\"line\"><span class=\"comment\"># ä»è¿œç¨‹ URL å¤åˆ¶</span></span><br><span class=\"line\"><span class=\"keyword\">ADD</span><span class=\"language-bash\"> https://example.com/app.jar /app.jar</span></span><br><span class=\"line\"><span class=\"comment\"># ä»å‹ç¼©åŒ…ä¸­å¤åˆ¶</span></span><br><span class=\"line\"><span class=\"keyword\">ADD</span><span class=\"language-bash\"> static-assets.tar.gz /app/public/</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æœ€ä½³å®è·µæ˜¯ä¼˜å…ˆä½¿ç”¨ COPYï¼Œåªæœ‰åœ¨éœ€è¦ ADD çš„é¢å¤–åŠŸèƒ½æ—¶æ‰ä½¿ç”¨å®ƒã€‚</p>\n</li>\n</ul>\n<h3 id=\"COPY\">COPY</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>COPY æŒ‡ä»¤ç”¨äºå°†ä¸»æœºä¸Šçš„æ–‡ä»¶æˆ–ç›®å½•å¤åˆ¶åˆ°é•œåƒçš„æ–‡ä»¶ç³»ç»Ÿä¸­ã€‚å®ƒæ˜¯æ„å»ºé•œåƒè¿‡ç¨‹ä¸­æœ€å¸¸ç”¨çš„æ•°æ®å¼•å…¥æ–¹å¼ä¹‹ä¸€ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>ä¸ ADD ç±»ä¼¼ï¼Œä½†åŠŸèƒ½æ›´ç®€å•ã€æ˜ç¡®ã€å®‰å…¨</p>\n</li>\n<li class=\"lvl-2\">\n<p>æ¨èä¼˜å…ˆä½¿ç”¨ COPYï¼Œé™¤éä½ ç¡®å®éœ€è¦ ADD æä¾›çš„è‡ªåŠ¨è§£å‹æˆ–è¿œç¨‹ä¸‹è½½åŠŸèƒ½ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>è¯­æ³•</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">COPY &lt;src&gt;... &lt;dest&gt;</span><br><span class=\"line\"><span class=\"comment\"># è¯´æ˜ï¼š</span></span><br><span class=\"line\"><span class=\"comment\">#   &lt;src&gt;ï¼šè¦å¤åˆ¶çš„æ–‡ä»¶æˆ–ç›®å½•</span></span><br><span class=\"line\"><span class=\"comment\">#   &lt;dest&gt;ï¼šç›®æ ‡è·¯å¾„</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ç¤ºä¾‹</p>\n</li>\n</ul>\n<figure class=\"highlight dockerfile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># å¤åˆ¶å•ä¸ªæ–‡ä»¶</span></span><br><span class=\"line\"><span class=\"keyword\">COPY</span><span class=\"language-bash\"> app.jar /app.jar</span></span><br><span class=\"line\"><span class=\"comment\"># å¤åˆ¶å¤šä¸ªæ–‡ä»¶</span></span><br><span class=\"line\"><span class=\"keyword\">COPY</span><span class=\"language-bash\"> app1.jar app2.jar /app/</span></span><br><span class=\"line\"><span class=\"comment\"># å¤åˆ¶ç›®å½•</span></span><br><span class=\"line\"><span class=\"keyword\">COPY</span><span class=\"language-bash\"> static-assets/ /app/public/</span></span><br><span class=\"line\"><span class=\"comment\"># é€šé…ç¬¦</span></span><br><span class=\"line\"><span class=\"keyword\">COPY</span><span class=\"language-bash\"> static-assets/*.html /app/public/</span></span><br><span class=\"line\"><span class=\"comment\"># è®¾ç½®ç›®æ ‡æ–‡ä»¶å±ä¸»å±ç»„</span></span><br><span class=\"line\"><span class=\"keyword\">COPY</span><span class=\"language-bash\"> --<span class=\"built_in\">chown</span>=appuser:appgroup app.jar /app.jar</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"RUN\">RUN</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>RUN æŒ‡ä»¤ç”¨äºåœ¨é•œåƒæ„å»ºé˜¶æ®µæ‰§è¡Œå‘½ä»¤ï¼Œç»“æœä¼šè¢«æ‰“åŒ…è¿›é•œåƒå±‚ä¸­ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>å®ƒå¯ä»¥ç”¨äºå®‰è£…ä¾èµ–ã€ç¼–è¯‘ä»£ç ã€è¿è¡Œå‘½ä»¤ç­‰ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>æ¯ä¸€æ¡ RUN æŒ‡ä»¤ä¼šåˆ›å»ºä¸€å±‚é•œåƒï¼ˆlayerï¼‰,åˆå¹¶å¤šä¸ªå‘½ä»¤æˆä¸€æ¡ RUNï¼Œå¯ä»¥å‡å°‘é•œåƒå±‚æ•°ï¼ˆä¾‹å¦‚ä½¿ç”¨ &amp;&amp; ä¸²è”ï¼‰ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>è¯­æ³•</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ç¬¬ä¸€ç§æ ¼å¼ï¼šå®é™…è¿è¡Œçš„æ˜¯ï¼š/bin/sh -c &quot;&lt;å‘½ä»¤å­—ç¬¦ä¸²&gt;&quot;</span></span><br><span class=\"line\">RUN &lt;å‘½ä»¤å­—ç¬¦ä¸²&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ç¬¬äºŒç§æ ¼å¼</span></span><br><span class=\"line\">RUN [<span class=\"string\">&quot;å¯æ‰§è¡Œæ–‡ä»¶&quot;</span>, <span class=\"string\">&quot;å‚æ•°1&quot;</span>, <span class=\"string\">&quot;å‚æ•°2&quot;</span>, ...]</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ç¤ºä¾‹</p>\n</li>\n</ul>\n<figure class=\"highlight dockerfile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># å‘½ä»¤å­—ç¬¦ä¸²</span></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"language-bash\"> apt-get update &amp;&amp; apt-get install -y curl</span></span><br><span class=\"line\"><span class=\"comment\"># æ„å»ºå¤šä¸ªå‘½ä»¤(ç”¨ &amp;&amp; ä¸²è”)</span></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"language-bash\"> apt-get update &amp;&amp; \\</span></span><br><span class=\"line\"><span class=\"language-bash\">    apt-get install -y python3 &amp;&amp; \\</span></span><br><span class=\"line\"><span class=\"language-bash\">    <span class=\"built_in\">rm</span> -rf /var/lib/apt/lists/*</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># å¯æ‰§è¡Œæ–‡ä»¶å‚æ•°</span></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"language-bash\"> [<span class=\"string\">&quot;/bin/sh&quot;</span>, <span class=\"string\">&quot;-c&quot;</span>, <span class=\"string\">&quot;curl https://example.com/app.jar &gt; app.jar&quot;</span>]</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"CMD\">CMD</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>CMD ç”¨äºæŒ‡å®šå®¹å™¨å¯åŠ¨æ—¶é»˜è®¤æ‰§è¡Œçš„å‘½ä»¤åŠå…¶å‚æ•°ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>å¦‚æœç”¨æˆ·åœ¨è¿è¡Œå®¹å™¨æ—¶æ²¡æœ‰æ‰‹åŠ¨æŒ‡å®šå…¶ä»–å‘½ä»¤ï¼ŒDocker å°±ä¼šä½¿ç”¨ CMD æä¾›çš„å†…å®¹ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>å®ƒå¯ä»¥å®šä¹‰å¤šä¸ªï¼Œä½†åªæœ‰æœ€åä¸€ä¸ªä¼šè¢«ä½¿ç”¨ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>è¯­æ³•</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Shell å½¢å¼ï¼ˆå­—ç¬¦ä¸²ï¼‰</span></span><br><span class=\"line\">CMD <span class=\"built_in\">command</span> param1 param2</span><br><span class=\"line\"><span class=\"comment\"># ç­‰ä»·äº /bin/sh -c &quot;command param1 param2&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Exec å½¢å¼ï¼ˆæ•°ç»„ï¼‰</span></span><br><span class=\"line\">CMD [<span class=\"string\">&quot;executable&quot;</span>, <span class=\"string\">&quot;param1&quot;</span>, <span class=\"string\">&quot;param2&quot;</span>, ...]</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ç¤ºä¾‹</p>\n</li>\n</ul>\n<figure class=\"highlight dockerfile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ç®€å• shell å‘½ä»¤</span></span><br><span class=\"line\"><span class=\"keyword\">CMD</span><span class=\"language-bash\"> <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Hello from container&quot;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Exec å½¢å¼</span></span><br><span class=\"line\"><span class=\"keyword\">CMD</span><span class=\"language-bash\"> [<span class=\"string\">&quot;npm&quot;</span>, <span class=\"string\">&quot;start&quot;</span>]</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ä½œä¸º ENTRYPOINT çš„å‚æ•°</span></span><br><span class=\"line\"><span class=\"keyword\">ENTRYPOINT</span><span class=\"language-bash\"> [<span class=\"string\">&quot;python3&quot;</span>, <span class=\"string\">&quot;app.py&quot;</span>]</span></span><br><span class=\"line\"><span class=\"keyword\">CMD</span><span class=\"language-bash\"> [<span class=\"string\">&quot;--host=0.0.0.0&quot;</span>, <span class=\"string\">&quot;--port=8080&quot;</span>]</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ç”¨æˆ·å¯ä»¥è¦†ç›– CMDï¼š</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run &lt;myapp&gt; npm run <span class=\"built_in\">test</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"ENTRYPOINT\">ENTRYPOINT</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ENTRYPOINT å®šä¹‰å®¹å™¨å¯åŠ¨æ—¶æ‰§è¡Œçš„ä¸»å‘½ä»¤ï¼Œç›¸æ¯” CMDï¼Œå®ƒä¸å®¹æ˜“è¢«è¦†ç›–ï¼Œæ›´é€‚åˆåˆ¶ä½œâ€œä¸“ç”¨å‹â€å®¹å™¨ï¼ˆå¦‚ nginxã€python è„šæœ¬ç­‰ï¼‰ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>ä½ å¯ä»¥æŠŠ ENTRYPOINT ç†è§£ä¸ºå®¹å™¨çš„â€œä¸»ç¨‹åºâ€ï¼Œè€Œ CMD æ˜¯ä¸ºå®ƒæä¾›çš„é»˜è®¤â€œå‘½ä»¤è¡Œå‚æ•°â€ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>è¯­æ³•</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Shell å½¢å¼ï¼ˆå­—ç¬¦ä¸²ï¼‰</span></span><br><span class=\"line\">ENTRYPOINT <span class=\"built_in\">command</span> param1 param2</span><br><span class=\"line\"><span class=\"comment\">#  ç­‰ä»·äº /bin/sh -c &quot;command param1 param2&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Exec å½¢å¼ï¼ˆæ•°ç»„ï¼‰</span></span><br><span class=\"line\">ENTRYPOINT [<span class=\"string\">&quot;executable&quot;</span>, <span class=\"string\">&quot;param1&quot;</span>, <span class=\"string\">&quot;param2&quot;</span>, ...]</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ç¤ºä¾‹</p>\n</li>\n</ul>\n<figure class=\"highlight dockerfile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ç®€å• shell å‘½ä»¤</span></span><br><span class=\"line\"><span class=\"keyword\">ENTRYPOINT</span><span class=\"language-bash\"> <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Hello from container&quot;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Exec å½¢å¼</span></span><br><span class=\"line\"><span class=\"keyword\">ENTRYPOINT</span><span class=\"language-bash\"> [<span class=\"string\">&quot;npm&quot;</span>, <span class=\"string\">&quot;start&quot;</span>]</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ç»“åˆ CMD ä½¿ç”¨</span></span><br><span class=\"line\"><span class=\"keyword\">ENTRYPOINT</span><span class=\"language-bash\"> [<span class=\"string\">&quot;python3&quot;</span>, <span class=\"string\">&quot;app.py&quot;</span>]</span></span><br><span class=\"line\"><span class=\"keyword\">CMD</span><span class=\"language-bash\"> [<span class=\"string\">&quot;--host=0.0.0.0&quot;</span>, <span class=\"string\">&quot;--port=8080&quot;</span>]</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"EXPOSE\">EXPOSE</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>EXPOSE ç”¨äºå£°æ˜å®¹å™¨å°†ä¼šç›‘å¬çš„ç«¯å£ï¼Œè®©ä½¿ç”¨è¯¥é•œåƒçš„äººçŸ¥é“åº”è¯¥å¯¹å¤–å¼€æ”¾å“ªäº›ç«¯å£ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>âš ï¸ æ³¨æ„ï¼šEXPOSE å¹¶ä¸ä¼šçœŸçš„å¼€æ”¾ç«¯å£ï¼Œåªæ˜¯â€œå£°æ˜â€è¿™ä¸ªå®¹å™¨ç›‘å¬äº†è¿™äº›ç«¯å£ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>è¦è®©ç«¯å£çœŸæ­£æš´éœ²å‡ºæ¥ï¼Œè¿˜éœ€è¦åœ¨è¿è¡Œå®¹å™¨æ—¶åŠ ä¸Š <code>-p</code> æˆ– <code>--publish</code> å‚æ•°ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>è¯­æ³•</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">EXPOSE &lt;port&gt; [&lt;port&gt;/&lt;protocol&gt;...]</span><br><span class=\"line\"><span class=\"comment\"># è¯´æ˜ï¼š</span></span><br><span class=\"line\"><span class=\"comment\">#   &lt;port&gt;ï¼šç«¯å£å·ï¼Œå¯ä»¥æ˜¯å•ä¸ªç«¯å£å·ï¼Œä¹Ÿå¯ä»¥æ˜¯èŒƒå›´ï¼ˆå¦‚ 8080-8085ï¼‰</span></span><br><span class=\"line\"><span class=\"comment\">#   &lt;protocol&gt;ï¼šåè®®ï¼Œå¯ä»¥æ˜¯ tcp æˆ– udpï¼Œé»˜è®¤ä¸º tcp</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ç¤ºä¾‹</p>\n</li>\n</ul>\n<figure class=\"highlight dockerfile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">EXPOSE</span> <span class=\"number\">8080</span></span><br><span class=\"line\"><span class=\"keyword\">EXPOSE</span> <span class=\"number\">8080</span>/udp</span><br><span class=\"line\"><span class=\"keyword\">EXPOSE</span> <span class=\"number\">8080</span>-<span class=\"number\">8085</span></span><br><span class=\"line\"><span class=\"keyword\">EXPOSE</span> <span class=\"number\">8080</span> <span class=\"number\">8081</span> <span class=\"number\">8082</span> <span class=\"number\">8083</span> <span class=\"number\">8084</span> <span class=\"number\">8085</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"VOLUME\">VOLUME</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>VOLUME æŒ‡ä»¤ç”¨äºå£°æ˜ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨ä¸­çš„æŒ‚è½½ç‚¹ï¼ˆmount pointï¼‰ï¼Œç”¨äºæŒä¹…åŒ–æ•°æ®æˆ–ä¸å®¿ä¸»æœº/å…¶ä»–å®¹å™¨å…±äº«æ•°æ®ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>è¯­æ³•ï¼š</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">VOLUME [<span class=\"string\">&quot;/path/in/container&quot;</span>, ...]</span><br><span class=\"line\"><span class=\"comment\"># è·¯å¾„å¿…é¡»æ˜¯å®¹å™¨å†…éƒ¨çš„ç»å¯¹è·¯å¾„</span></span><br><span class=\"line\"><span class=\"comment\"># å¯ä»¥ä¸€æ¬¡å£°æ˜ä¸€ä¸ªï¼Œä¹Ÿå¯ä»¥æ˜¯å¤šä¸ªã€‚</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ç¤ºä¾‹</p>\n</li>\n</ul>\n<figure class=\"highlight dockerfile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># å£°æ˜ä¸€ä¸ªæŒ‚è½½ç‚¹</span></span><br><span class=\"line\"><span class=\"keyword\">VOLUME</span><span class=\"language-bash\"> /app/public</span></span><br><span class=\"line\"><span class=\"comment\"># å£°æ˜å¤šä¸ªæŒ‚è½½ç‚¹</span></span><br><span class=\"line\"><span class=\"keyword\">VOLUME</span><span class=\"language-bash\"> [<span class=\"string\">&quot;/app/public&quot;</span>, <span class=\"string\">&quot;/app/logs&quot;</span>]</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å½“å®¹å™¨è¿è¡Œæ—¶ï¼Œå¯ä»¥å°†é•œåƒä¸­å£°æ˜çš„æŒ‚è½½ç‚¹æ˜ å°„åˆ°å®¿ä¸»æœºä¸Šï¼Œä»è€Œå®ç°æŒä¹…åŒ–æ•°æ®ã€‚</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run -v /host/path:/app/public myimage</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å¦‚æœä½ æ²¡æœ‰æ‰‹åŠ¨ç»‘å®šæŒ‚è½½ï¼ŒDocker ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªåŒ¿åå·ï¼Œå·çš„å†…å®¹é»˜è®¤ä¿å­˜åœ¨å®¿ä¸»æœºçš„ <code>/var/lib/docker/volumes</code> ä¸‹ã€‚</p>\n</li>\n</ul>\n<h3 id=\"HEALTHCHECK\">HEALTHCHECK</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>HEALTHCHECK ç”¨æ¥å®šä¹‰å®¹å™¨è¿è¡Œæ—¶çš„å¥åº·æ£€æŸ¥å‘½ä»¤ï¼Œå®šæœŸæ£€æµ‹å®¹å™¨å†…æœåŠ¡çš„çŠ¶æ€ï¼Œå¸®åŠ©ç¼–æ’å·¥å…·ï¼ˆDocker Swarmã€Kubernetes ç­‰ï¼‰åˆ¤æ–­å®¹å™¨æ˜¯å¦å¥åº·ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>å¦‚æœå¥åº·æ£€æŸ¥å¤±è´¥ï¼ŒDocker ä¼šå°†å®¹å™¨æ ‡è®°ä¸º unhealthyï¼Œä¾¿äºè‡ªåŠ¨é‡å¯æˆ–æ›¿æ¢ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>è¯­æ³•</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">HEALTHCHECK &lt;options&gt; CMD &lt;<span class=\"built_in\">command</span>&gt;</span><br><span class=\"line\"><span class=\"comment\"># è¯´æ˜ï¼š</span></span><br><span class=\"line\"><span class=\"comment\"># &lt;options&gt;ï¼šå¯é€‰é¡¹ï¼Œç”¨äºè®¾ç½®å¥åº·æ£€æŸ¥çš„é€‰é¡¹ï¼Œå¦‚è¶…æ—¶æ—¶é—´ã€é‡è¯•æ¬¡æ•°ç­‰ã€‚</span></span><br><span class=\"line\"><span class=\"comment\"># &lt;command&gt;ï¼šå¥åº·æ£€æŸ¥å‘½ä»¤ï¼Œå¯ä»¥æ˜¯ä»»ä½•æœ‰æ•ˆçš„ shell å‘½ä»¤ã€‚</span></span><br><span class=\"line\">            <span class=\"comment\"># å¿…é¡»è¿”å›é€€å‡ºç :</span></span><br><span class=\"line\">              <span class=\"comment\"># 0 è¡¨ç¤ºå¥åº·</span></span><br><span class=\"line\">              <span class=\"comment\"># 1 è¡¨ç¤ºä¸å¥åº·</span></span><br><span class=\"line\">              <span class=\"comment\"># 2 è¡¨ç¤ºæœªçŸ¥</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å¯é€‰å‚æ•°ï¼ˆOPTIONSï¼‰</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>å‚æ•°</th>\n<th>è¯´æ˜</th>\n<th>é»˜è®¤å€¼</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>--interval=DURATION</code></td>\n<td>ä¸¤æ¬¡å¥åº·æ£€æŸ¥ä¹‹é—´çš„æ—¶é—´é—´éš”</td>\n<td>30s</td>\n</tr>\n<tr>\n<td><code>--timeout=DURATION</code></td>\n<td>å•æ¬¡æ£€æµ‹å‘½ä»¤çš„è¶…æ—¶æ—¶é—´</td>\n<td>30s</td>\n</tr>\n<tr>\n<td><code>--start-period=DURATION</code></td>\n<td>å®¹å™¨å¯åŠ¨åï¼Œå¼€å§‹å¥åº·æ£€æŸ¥å‰çš„ç­‰å¾…æ—¶é—´</td>\n<td>0s</td>\n</tr>\n<tr>\n<td><code>--retries=N</code></td>\n<td>è¿ç»­å¤±è´¥å‡ æ¬¡ååˆ¤å®šå®¹å™¨ä¸å¥åº·</td>\n<td>3</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ç¤ºä¾‹</p>\n</li>\n</ul>\n<figure class=\"highlight dockerfile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨ curl æ£€æµ‹ Web æœåŠ¡æ˜¯å¦å“åº”</span></span><br><span class=\"line\"><span class=\"keyword\">HEALTHCHECK</span><span class=\"language-bash\"> --interval=5s --<span class=\"built_in\">timeout</span>=3s --retries=3 CMD curl -f http://localhost:8080/health || <span class=\"built_in\">exit</span> 1</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>è¿è¡Œå®¹å™¨åï¼Œå¯ä»¥ç”¨å‘½ä»¤æŸ¥çœ‹å¥åº·çŠ¶æ€</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># å¦‚æœé•œåƒä¸­æœ‰å¥åº·æ£€æŸ¥ï¼Œå¯ä»¥æŸ¥çœ‹å®¹å™¨çŠ¶æ€ï¼ˆSTATUSï¼‰</span></span><br><span class=\"line\">docker ps</span><br><span class=\"line\">  <span class=\"comment\"># STATUS åˆ—ä¼šæ˜¾ç¤ºï¼š</span></span><br><span class=\"line\">  <span class=\"comment\">#   healthy</span></span><br><span class=\"line\">  <span class=\"comment\">#   unhealthy</span></span><br><span class=\"line\">  <span class=\"comment\">#   startingï¼ˆå¯åŠ¨ä¸­ï¼‰</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹æ›´è¯¦ç»†çš„ä¿¡æ¯</span></span><br><span class=\"line\">docker inspect --format=<span class=\"string\">&#x27;&#123;&#123;json .State.Health&#125;&#125;&#x27;</span> &lt;container-id&gt;</span><br></pre></td></tr></table></figure>\n<h3 id=\"SHELL\">SHELL</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>SHELL æŒ‡ä»¤ç”¨æ¥è‡ªå®šä¹‰åç»­ RUNã€CMD å’Œ ENTRYPOINT æŒ‡ä»¤æ‰€ä½¿ç”¨çš„é»˜è®¤ shell ç¨‹åºå’Œå‚æ•°ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>é»˜è®¤æƒ…å†µä¸‹ï¼š</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-4\">åœ¨ Linux é•œåƒä¸­ï¼ŒDocker ä½¿ç”¨ /bin/sh -c</li>\n<li class=\"lvl-4\">åœ¨ Windows é•œåƒä¸­ï¼Œä½¿ç”¨ cmd /S /C</li>\n</ul>\n</li>\n<li class=\"lvl-2\">\n<p>ä½¿ç”¨ SHELLï¼Œä½ å¯ä»¥æ›¿æ¢ä¸ºå…¶ä»– shellï¼Œå¦‚ Bashã€PowerShellã€zsh ç­‰ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>è¯­æ³•</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">SHELL [<span class=\"string\">&quot;executable&quot;</span>, <span class=\"string\">&quot;param1&quot;</span>, <span class=\"string\">&quot;param2&quot;</span>, ...]</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ç¤ºä¾‹</p>\n</li>\n</ul>\n<figure class=\"highlight dockerfile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># åˆ‡æ¢åˆ° bash</span></span><br><span class=\"line\"><span class=\"keyword\">SHELL</span><span class=\"language-bash\"> [<span class=\"string\">&quot;bash&quot;</span>, <span class=\"string\">&quot;-c&quot;</span>]</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># å¤šæ¬¡åˆ‡æ¢</span></span><br><span class=\"line\"><span class=\"keyword\">SHELL</span><span class=\"language-bash\"> [<span class=\"string\">&quot;/bin/bash&quot;</span>, <span class=\"string\">&quot;-c&quot;</span>]</span></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"language-bash\"> <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Hello from Bash&quot;</span> <span class=\"comment\"># åœ¨ Bash ä¸­æ‰§è¡Œ</span></span></span><br><span class=\"line\"><span class=\"keyword\">SHELL</span><span class=\"language-bash\"> [<span class=\"string\">&quot;/bin/sh&quot;</span>, <span class=\"string\">&quot;-c&quot;</span>]</span></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"language-bash\"> <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Now back to sh&quot;</span> <span class=\"comment\">#  åœ¨ sh ä¸­æ‰§è¡Œ</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Windows</span></span><br><span class=\"line\"><span class=\"keyword\">SHELL</span><span class=\"language-bash\"> [<span class=\"string\">&quot;powershell&quot;</span>, <span class=\"string\">&quot;-Command&quot;</span>]</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"STOPSIGNAL\">STOPSIGNAL</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>STOPSIGNAL æŒ‡å®šå½“å®¹å™¨æ”¶åˆ° <code>docker stop</code> å‘½ä»¤æ—¶ï¼Œå‘é€ç»™å®¹å™¨ä¸»è¿›ç¨‹çš„ä¿¡å·ç±»å‹ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒDocker ä¼šå‘å®¹å™¨çš„ä¸»è¿›ç¨‹å‘é€ <code>SIGTERM</code> ä¿¡å·ï¼Œè®©å®ƒæœ‰æœºä¼šä¼˜é›…åœ°é€€å‡ºï¼ˆåœ¨è¶…æ—¶æ—¶æœªé€€å‡ºåˆ™å‘ <code>SIGKILL</code> å¼ºåˆ¶ç»ˆæ­¢ï¼‰ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>é»˜è®¤æƒ…å†µï¼Œå¤§å¤šæ•°ç¨‹åºï¼ˆå¦‚ nginxï¼‰ï¼Œä¸éœ€è¦è®¾ç½®ï¼ˆé»˜è®¤ SIGTERMï¼‰</p>\n</li>\n<li class=\"lvl-2\">\n<p>ä½†æœ‰äº›ç¨‹åºå¯èƒ½éœ€è¦ä½¿ç”¨ä¸åŒçš„ä¿¡å·ï¼Œæ¯”å¦‚ SIGINTã€SIGHUPï¼Œè¿™æ—¶ä½ å¯ä»¥é€šè¿‡ STOPSIGNAL æ¥ä¿®æ”¹ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>è¯­æ³•</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">STOPSIGNAL &lt;signal&gt;</span><br><span class=\"line\"><span class=\"comment\"># è¯´æ˜ï¼š</span></span><br><span class=\"line\"><span class=\"comment\"># å…¶ä¸­ &lt;signal&gt; å¯ä»¥æ˜¯ï¼š</span></span><br><span class=\"line\"><span class=\"comment\">#   ä¿¡å·åç§°ï¼Œä¾‹å¦‚ï¼šSIGTERMã€SIGKILLã€SIGINTã€SIGHUP</span></span><br><span class=\"line\"><span class=\"comment\">#   æˆ–ä¿¡å·ç¼–å·ï¼Œä¾‹å¦‚ï¼š15ï¼ˆç­‰ä»·äº SIGTERMï¼‰</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ç¤ºä¾‹</p>\n</li>\n</ul>\n<figure class=\"highlight dockerfile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># è¿™æ˜¯é»˜è®¤è¡Œä¸ºï¼Œä¸å†™ä¹Ÿä¸€æ ·ã€‚</span></span><br><span class=\"line\"><span class=\"keyword\">STOPSIGNAL</span> SIGTERM</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ä¿®æ”¹ä¸º SIGINT</span></span><br><span class=\"line\"><span class=\"keyword\">STOPSIGNAL</span> SIGINT</span><br></pre></td></tr></table></figure>\n<h3 id=\"ONBUILD\">ONBUILD</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ONBUILD ç”¨äºå®šä¹‰å»¶è¿Ÿæ‰§è¡Œçš„æ„å»ºæŒ‡ä»¤ï¼Œå³è¿™äº›å‘½ä»¤ä¸ä¼šåœ¨å½“å‰ Dockerfile æ„å»ºæ—¶æ‰§è¡Œï¼Œè€Œæ˜¯åœ¨ ä»¥å½“å‰é•œåƒä¸ºåŸºç¡€çš„å­é•œåƒä¸­æ„å»ºæ—¶è§¦å‘æ‰§è¡Œã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>å®ƒçš„å…¸å‹ç”¨é€”æ˜¯ï¼šæ„å»ºä¸€ä¸ªâ€œé€šç”¨åŸºç¡€é•œåƒâ€ï¼Œè®©ä½¿ç”¨è€…åœ¨è‡ªå·±çš„ Dockerfile ä¸­ FROM å®ƒæ—¶è‡ªåŠ¨ç»§æ‰¿ä¸€äº›æ“ä½œï¼ˆæ¯”å¦‚ COPYã€RUN ç­‰ï¼‰ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>ONBUILD æ˜¯ä¸€ç§è®¾è®¡æ¨¡å¼ï¼Œæ–¹ä¾¿åŸºç¡€é•œåƒä½œè€…é¢„å…ˆå®šä¹‰â€œæœªæ¥å­é•œåƒæ„å»ºæ—¶ä¸€å®šè¦æ‰§è¡Œçš„æ­¥éª¤â€ï¼Œè€Œä¸æ˜¯åœ¨åŸºç¡€é•œåƒä¸­â€œç¡¬ç¼–ç â€é‚£äº›æ­¥éª¤ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>è¯­æ³•</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ONBUILD &lt;INSTRUCTION&gt;</span><br><span class=\"line\"><span class=\"comment\"># è¯´æ˜ï¼š</span></span><br><span class=\"line\"><span class=\"comment\"># &lt;INSTRUCTION&gt;ï¼šå¿…é¡»æ˜¯ä¸€ä¸ªåˆæ³•çš„ Dockerfile æŒ‡ä»¤ï¼Œå¦‚ RUNã€COPYã€ADDã€CMD ç­‰ï¼ˆä½†ä¸èƒ½æ˜¯ FROM, ONBUILD, HEALTHCHECK ç­‰ï¼‰ã€‚</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ç¤ºä¾‹</p>\n</li>\n</ul>\n<figure class=\"highlight dockerfile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># åŸºç¡€é•œåƒä¸­ä½¿ç”¨ ONBUILD</span></span><br><span class=\"line\"><span class=\"comment\"># æ–‡ä»¶ï¼šDockerfile.base</span></span><br><span class=\"line\"><span class=\"keyword\">FROM</span> node:<span class=\"number\">18</span></span><br><span class=\"line\"><span class=\"keyword\">WORKDIR</span><span class=\"language-bash\"> /app</span></span><br><span class=\"line\"><span class=\"keyword\">ONBUILD</span> <span class=\"keyword\">COPY</span><span class=\"language-bash\"> . /app</span></span><br><span class=\"line\"><span class=\"keyword\">ONBUILD</span> <span class=\"keyword\">RUN</span><span class=\"language-bash\"> npm install</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æ„å»ºåŸºç¡€é•œåƒ</span></span><br><span class=\"line\">docker build -t my-node-base -f Dockerfile.base .</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨åŸºç¡€é•œåƒæ„å»ºå­é•œåƒ</span></span><br><span class=\"line\"><span class=\"comment\"># æ–‡ä»¶ï¼šDockerfileï¼ˆå­é•œåƒï¼‰</span></span><br><span class=\"line\"><span class=\"keyword\">FROM</span> my-node-base</span><br><span class=\"line\"><span class=\"keyword\">CMD</span><span class=\"language-bash\"> [<span class=\"string\">&quot;node&quot;</span>, <span class=\"string\">&quot;index.js&quot;</span>]</span></span><br><span class=\"line\"><span class=\"comment\"># æ„å»ºå­é•œåƒæ—¶ï¼Œç­‰äºè‡ªåŠ¨æ’å…¥äº†ï¼š</span></span><br><span class=\"line\"><span class=\"keyword\">COPY</span><span class=\"language-bash\"> . /app</span></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"language-bash\"> npm install</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ONBUILD æ˜¯ä¸€ç§â€œæ„å»ºé’©å­â€æœºåˆ¶</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-4\">ONBUILD å¯ä»¥ç†è§£æˆâ€œé’©å­â€æˆ–â€œè§¦å‘å™¨â€ï¼š\n<ul class=\"lvl-4\">\n<li class=\"lvl-6\">åœ¨åŸºç¡€é•œåƒæ„å»ºæ—¶ä¸æ‰§è¡Œ</li>\n<li class=\"lvl-6\">ä½†å½“æŸäººä»¥è¿™ä¸ªåŸºç¡€é•œåƒä¸ºèµ·ç‚¹å†™è‡ªå·±çš„ Dockerfileï¼Œå¹¶æ„å»ºæ—¶ï¼Œè¿™äº› ONBUILD é‡Œçš„æŒ‡ä»¤è‡ªåŠ¨æ’å…¥æ‰§è¡Œ</li>\n</ul>\n</li>\n<li class=\"lvl-4\">è¿™æ ·ï¼š\n<ul class=\"lvl-4\">\n<li class=\"lvl-6\">åŸºç¡€é•œåƒåªè´Ÿè´£å®šä¹‰ç¯å¢ƒï¼ˆnodeã€npmç‰ˆæœ¬ã€ç³»ç»Ÿä¾èµ–ç­‰ï¼‰ï¼Œä¿æŒè½»é‡</li>\n<li class=\"lvl-6\">ä¸‹æ¸¸é¡¹ç›®å¯ä»¥ä¸ç”¨å†™é‡å¤çš„ä»£ç å¤åˆ¶å’Œå®‰è£…æŒ‡ä»¤ï¼Œè‡ªåŠ¨ç»§æ‰¿åŸºç¡€é•œåƒé¢„å®šä¹‰çš„æ„å»ºæ­¥éª¤</li>\n<li class=\"lvl-6\">ä»£ç å¤åˆ¶å’Œä¾èµ–å®‰è£…åœ¨ä¸‹æ¸¸é•œåƒæ„å»ºæ—¶æ‰§è¡Œï¼Œä½¿ç”¨è‡ªå·±çš„ä¸Šä¸‹æ–‡ï¼ˆä¹Ÿå°±æ˜¯é¡¹ç›®ä»£ç ï¼‰</li>\n</ul>\n</li>\n</ul>\n</li>\n<li class=\"lvl-2\">\n<p><code>ONBUILD</code> æ€»ç»“</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>ç‰¹æ€§</th>\n<th>è¯´æ˜</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>â± å»¶è¿Ÿæ‰§è¡Œ</td>\n<td>æ„å»ºåŸºç¡€é•œåƒæ—¶ä¸ä¼šæ‰§è¡Œï¼Œåœ¨å­é•œåƒæ„å»ºæ—¶è§¦å‘</td>\n</tr>\n<tr>\n<td>âœ… æ”¯æŒæŒ‡ä»¤</td>\n<td>ä¾‹å¦‚ <code>RUN</code>, <code>COPY</code>, <code>ADD</code>, <code>CMD</code>, <code>WORKDIR</code>, <code>ENV</code> ç­‰</td>\n</tr>\n<tr>\n<td>âŒ ä¸æ”¯æŒ</td>\n<td><code>FROM</code>, <code>ONBUILD</code>, <code>HEALTHCHECK</code>, <code>SHELL</code>, <code>STOPSIGNAL</code></td>\n</tr>\n<tr>\n<td>ğŸ‘ ä¸æ¨èæ»¥ç”¨</td>\n<td>ä¼šéšè—æ„å»ºè¡Œä¸ºï¼Œé™ä½å¯ç»´æŠ¤æ€§</td>\n</tr>\n<tr>\n<td>âœ… æ¨èåœºæ™¯</td>\n<td>å›¢é˜Ÿå…±äº«æ¨¡æ¿ã€æ„å»ºâ€œæ ‡å‡†å¼€å‘é•œåƒâ€</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"Dockerfile-å“ªäº›-æŒ‡ä»¤-ä¼šåˆ›å»ºæ–°çš„å±‚\">Dockerfile å“ªäº› æŒ‡ä»¤ ä¼šåˆ›å»ºæ–°çš„å±‚</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å½“ Dockerfile ä¸­åˆ›å»ºæ–°å±‚çš„æŒ‡ä»¤å†…å®¹å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä½¿ç”¨ <code>--no-cache</code> é€‰é¡¹å¯ä»¥ç¡®ä¿è¿™äº›å˜æ›´è¢«æ­£ç¡®åº”ç”¨ã€‚</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>æŒ‡ä»¤</th>\n<th>æè¿°</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>ADD</td>\n<td>ä» <src> å¤åˆ¶æ–‡ä»¶å¹¶è‡ªåŠ¨è§£å‹ï¼ˆå¦‚æœæ˜¯ä¸€ä¸ª tar æ–‡ä»¶ï¼‰åˆ°å®¹å™¨çš„ <dest> è·¯å¾„ã€‚</td>\n</tr>\n<tr>\n<td>COPY</td>\n<td>ä» <src> å¤åˆ¶æ–‡ä»¶åˆ°å®¹å™¨çš„ <dest> è·¯å¾„ï¼Œä¸ä¼šè‡ªåŠ¨è§£å‹ã€‚</td>\n</tr>\n<tr>\n<td>RUN</td>\n<td>æ‰§è¡Œä»»æ„å‘½ä»¤å¹¶åœ¨å®¹å™¨ä¸­åšå‡ºæ›´æ”¹ã€‚æ¯æ¡ RUN æŒ‡ä»¤éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å±‚ã€‚</td>\n</tr>\n<tr>\n<td>ENV</td>\n<td>è®¾ç½®ç¯å¢ƒå˜é‡ã€‚æ¯ä¸€è¡Œ ENV æŒ‡ä»¤éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å±‚ã€‚</td>\n</tr>\n<tr>\n<td>WORKDIR</td>\n<td>è®¾ç½®å·¥ä½œç›®å½•ã€‚æ¯ä¸€è¡Œ WORKDIR æŒ‡ä»¤éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å±‚ã€‚</td>\n</tr>\n<tr>\n<td>VOLUME</td>\n<td>åˆ›å»ºä¸€ä¸ªæŒ‚è½½ç‚¹ã€‚æ¯ä¸€è¡Œ VOLUME æŒ‡ä»¤éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å±‚ã€‚</td>\n</tr>\n<tr>\n<td>LABEL</td>\n<td>æ·»åŠ å…ƒæ•°æ®æ ‡ç­¾ã€‚æ¯ä¸€è¡Œ LABEL æŒ‡ä»¤éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å±‚ã€‚</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"Dockerfile-ç¤ºä¾‹-Spring-Boot-åº”ç”¨\">Dockerfile ç¤ºä¾‹: Spring Boot åº”ç”¨</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ç›®å½•ç»“æ„</p>\n</li>\n</ul>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">springbootweb/</span><br><span class=\"line\">â”œâ”€â”€ Dockerfile</span><br><span class=\"line\">â”œâ”€â”€ target/</span><br><span class=\"line\">â”‚   â””â”€â”€ app.jar</span><br><span class=\"line\">â”œâ”€â”€ <span class=\"type\">static</span>-assets.tar.gz</span><br><span class=\"line\">â””â”€â”€ ...</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Dockerfile: æ³¨æ„ Dockerfile ä¸­æ‰€æœ‰å…³é”®å­—éƒ½è¦æ±‚å¤§å†™</p>\n</li>\n</ul>\n<figure class=\"highlight dockerfile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨è½»é‡çº§ Alpine ç‰ˆæœ¬çš„ OpenJDK 17 å®˜æ–¹é•œåƒï¼Œé€‚åˆéƒ¨ç½² Spring Boot åº”ç”¨</span></span><br><span class=\"line\"><span class=\"keyword\">FROM</span> openjdk:<span class=\"number\">17</span>-alpine</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># è®¾ç½®æ„å»ºæ—¶å˜é‡ï¼Œé»˜è®¤ä½¿ç”¨æ„å»ºå¥½çš„ jar æ–‡ä»¶</span></span><br><span class=\"line\"><span class=\"keyword\">ARG</span> JAR_FILE=target/app.jar</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># è®¾ç½®è¿è¡Œæ—¶ç¯å¢ƒå˜é‡</span></span><br><span class=\"line\"><span class=\"keyword\">ENV</span> JAVA_OPTS=<span class=\"string\">&quot;-Xms1024M -Xmx1024M -XX:MetaspaceSize=128M -XX:MaxMetaspaceSize=128M&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">ENV</span> TZ=Asia/Shanghai</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># é•œåƒå…ƒä¿¡æ¯</span></span><br><span class=\"line\"><span class=\"keyword\">LABEL</span><span class=\"language-bash\"> maintainer=<span class=\"string\">&quot;yourname@example.com&quot;</span></span></span><br><span class=\"line\"><span class=\"keyword\">LABEL</span><span class=\"language-bash\"> version=<span class=\"string\">&quot;1.0.0&quot;</span></span></span><br><span class=\"line\"><span class=\"keyword\">LABEL</span><span class=\"language-bash\"> description=<span class=\"string\">&quot;ç”¨äºéƒ¨ç½² Spring Boot åº”ç”¨çš„ç”Ÿäº§çº§é•œåƒ&quot;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># è®¾ç½®å·¥ä½œç›®å½•</span></span><br><span class=\"line\"><span class=\"keyword\">WORKDIR</span><span class=\"language-bash\"> /app</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ç¤ºä¾‹ RUNï¼šå®‰è£… curlï¼ˆç”¨äºå®¹å™¨å¥åº·æ£€æŸ¥æˆ–è°ƒè¯•ï¼‰</span></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"language-bash\"> apk add --no-cache curl</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># å¤åˆ¶ Spring Boot æ„å»ºç”Ÿæˆçš„ jar åŒ…</span></span><br><span class=\"line\"><span class=\"keyword\">COPY</span><span class=\"language-bash\"> <span class=\"variable\">$&#123;JAR_FILE&#125;</span> app.jar</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># è§£å‹é™æ€èµ„æºåˆ°å®¹å™¨ä¸­ï¼ˆADD å¯ä»¥è‡ªåŠ¨è§£å‹ tar.gzï¼‰</span></span><br><span class=\"line\"><span class=\"keyword\">ADD</span><span class=\"language-bash\"> static-assets.tar.gz /app/public/</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># å£°æ˜æš´éœ²çš„åº”ç”¨ç«¯å£ï¼ˆSpring Boot é»˜è®¤æ˜¯ 8080ï¼‰</span></span><br><span class=\"line\"><span class=\"keyword\">EXPOSE</span> <span class=\"number\">8080</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># å®¹å™¨å¥åº·æ£€æŸ¥ï¼šè®¿é—® actuator å¥åº·ç«¯ç‚¹</span></span><br><span class=\"line\"><span class=\"keyword\">HEALTHCHECK</span><span class=\"language-bash\"> --interval=30s --<span class=\"built_in\">timeout</span>=5s --retries=3 \\</span></span><br><span class=\"line\"><span class=\"language-bash\">  CMD curl -f http://localhost:8080/app/actuator/health || <span class=\"built_in\">exit</span> 1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># å®¹å™¨ç»ˆæ­¢æ—¶ä¼˜é›…å…³é—­ï¼ˆJava æ¨è SIGTERMï¼‰</span></span><br><span class=\"line\"><span class=\"keyword\">STOPSIGNAL</span> SIGTERM</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># è®¾ç½®å®¹å™¨å¯åŠ¨æ—¶çš„ä¸»å‘½ä»¤ï¼ˆENTRYPOINT ä¸ä¼šè¢« docker run å‚æ•°è¦†ç›–ï¼‰</span></span><br><span class=\"line\"><span class=\"keyword\">ENTRYPOINT</span><span class=\"language-bash\"> [<span class=\"string\">&quot;sh&quot;</span>, <span class=\"string\">&quot;-c&quot;</span>, <span class=\"string\">&quot;java <span class=\"variable\">$JAVA_OPTS</span> -jar app.jar&quot;</span>]</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># CMD æä¾›é»˜è®¤çš„è¿è¡Œå‚æ•°ï¼Œå¯ä»¥è¢« docker run è¦†ç›–</span></span><br><span class=\"line\"><span class=\"comment\"># è¿™é‡Œé€šè¿‡ Spring Boot å‚æ•°è®¾ç½®å¯åŠ¨ç¯å¢ƒå’Œç«¯å£å·</span></span><br><span class=\"line\"><span class=\"keyword\">CMD</span><span class=\"language-bash\"> [<span class=\"string\">&quot;--spring.profiles.active=app&quot;</span>, <span class=\"string\">&quot;--server.port=8080&quot;</span>]</span></span><br><span class=\"line\"><span class=\"comment\"># è¿™é‡Œä½¿ç”¨çš„æ˜¯ ENTRYPOINT + CMD çš„æ··åˆæ¨¡å¼</span></span><br><span class=\"line\"><span class=\"comment\"># å®Œæ•´å‘½ä»¤ï¼š java $JAVA_OPTS -jar app.jar --spring.profiles.active=app --server.port=8080</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># å£°æ˜ä¸€ä¸ªå·æŒ‚è½½ç‚¹ï¼Œè¿è¡Œå®¹å™¨æ—¶å¯å°†è¯¥è·¯å¾„æ˜ å°„åˆ°å®¿ä¸»æœºï¼Œå®ç°æ•°æ®æŒä¹…åŒ–</span></span><br><span class=\"line\"><span class=\"keyword\">VOLUME</span><span class=\"language-bash\"> [<span class=\"string\">&quot;/app/logs&quot;</span>]</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æ„å»ºé•œåƒ</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># æ„å»ºé•œåƒæ—¶ç”¨ --build-arg æŒ‡å®šæ„å»ºå‚æ•°ï¼Œå¦‚æœéœ€è¦å¤šä¸ªï¼Œå°±é…ç½®å¤šä¸ª --build-arg</span></span><br><span class=\"line\">docker build --build-arg JAR_FILE=target/app.jar -t springbootweb:latest .</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>è¿è¡Œå®¹å™¨</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run -d --name springbootweb \\</span><br><span class=\"line\">  -p 8080:8080 \\</span><br><span class=\"line\">  -e JAVA_OPTS=<span class=\"string\">&quot;-Xms512m -Xmx1024m&quot;</span> \\</span><br><span class=\"line\">  -v /home/centos/logs/app/:/app/logs \\</span><br><span class=\"line\">  springbootweb:latest</span><br></pre></td></tr></table></figure>\n<h2 id=\"Dockerfile-ç¤ºä¾‹-å¤šé˜¶æ®µæ„å»º\">Dockerfile ç¤ºä¾‹: å¤šé˜¶æ®µæ„å»º</h2>\n<figure class=\"highlight dockerfile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ç¬¬ä¸€é˜¶æ®µï¼šè·å–ä»£ç </span></span><br><span class=\"line\"><span class=\"keyword\">FROM</span> alpine/git AS fetcher</span><br><span class=\"line\"><span class=\"keyword\">WORKDIR</span><span class=\"language-bash\"> /workspace/application</span></span><br><span class=\"line\"><span class=\"comment\"># å°†æ›¿æ¢ä¸ºå®é™…çš„Gitä»“åº“URLå’Œåˆ†æ”¯/æ ‡ç­¾</span></span><br><span class=\"line\"><span class=\"keyword\">ARG</span> GIT_REPOSITORY=https://gitee.com/hanqunfeng/springbootweb.git</span><br><span class=\"line\"><span class=\"keyword\">ARG</span> GIT_BRANCH=master</span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"language-bash\"> git <span class=\"built_in\">clone</span> -b <span class=\"variable\">$&#123;GIT_BRANCH&#125;</span> <span class=\"variable\">$&#123;GIT_REPOSITORY&#125;</span> .</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ç¬¬äºŒé˜¶æ®µï¼šä½¿ç”¨Mavenç¯å¢ƒè¿›è¡Œæ„å»º</span></span><br><span class=\"line\"><span class=\"keyword\">FROM</span> maven:<span class=\"number\">3.8</span>.<span class=\"number\">4</span>-openjdk-<span class=\"number\">17</span> AS builder</span><br><span class=\"line\"><span class=\"keyword\">WORKDIR</span><span class=\"language-bash\"> /workspace/application</span></span><br><span class=\"line\"><span class=\"comment\"># ä»ç¬¬ä¸€é˜¶æ®µå¤åˆ¶ä»£ç </span></span><br><span class=\"line\"><span class=\"keyword\">COPY</span><span class=\"language-bash\"> --from=fetcher /workspace/application .</span></span><br><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨Mavenæ¸…ç†å¹¶æ‰“åŒ…</span></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"language-bash\"> mvn clean package -DskipTests</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ç¬¬ä¸‰é˜¶æ®µï¼šåˆ›å»ºæœ€ç»ˆçš„è¿è¡Œç¯å¢ƒ</span></span><br><span class=\"line\"><span class=\"keyword\">FROM</span> openjdk:<span class=\"number\">17</span>-alpine</span><br><span class=\"line\"><span class=\"keyword\">WORKDIR</span><span class=\"language-bash\"> /app</span></span><br><span class=\"line\"><span class=\"comment\"># è®¾ç½®è¿è¡Œæ—¶ç¯å¢ƒå˜é‡</span></span><br><span class=\"line\"><span class=\"keyword\">ENV</span> JAVA_OPTS=<span class=\"string\">&quot;-Xms1024M -Xmx1024M -XX:MetaspaceSize=128M -XX:MaxMetaspaceSize=128M&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># å°†ç¬¬äºŒé˜¶æ®µç”Ÿæˆçš„ç›®æ ‡æ–‡ä»¶å¤åˆ¶åˆ°è¿™é‡Œã€‚æ³¨æ„è¿™é‡Œå‡è®¾ä½ çš„spring bootå·¥ç¨‹æ‰“æˆçš„jaråæ˜¯target/app.jar</span></span><br><span class=\"line\"><span class=\"keyword\">COPY</span><span class=\"language-bash\"> --from=builder /workspace/application/target/app.jar app.jar</span></span><br><span class=\"line\"><span class=\"comment\"># æš´éœ²ç«¯å£ï¼ˆå¦‚æœéœ€è¦çš„è¯ï¼‰ã€‚è¯·æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹ç«¯å£å·</span></span><br><span class=\"line\"><span class=\"keyword\">EXPOSE</span> <span class=\"number\">8080</span></span><br><span class=\"line\"><span class=\"comment\"># å£°æ˜ä¸€ä¸ªå·æŒ‚è½½ç‚¹ï¼Œè¿è¡Œå®¹å™¨æ—¶å¯å°†è¯¥è·¯å¾„æ˜ å°„åˆ°å®¿ä¸»æœºï¼Œå®ç°æ•°æ®æŒä¹…åŒ–</span></span><br><span class=\"line\"><span class=\"keyword\">VOLUME</span><span class=\"language-bash\"> [<span class=\"string\">&quot;/app/logs&quot;</span>]</span></span><br><span class=\"line\"><span class=\"comment\"># è®¾ç½®å®¹å™¨å¯åŠ¨æ—¶çš„ä¸»å‘½ä»¤ï¼ˆENTRYPOINT ä¸ä¼šè¢« docker run å‚æ•°è¦†ç›–ï¼‰</span></span><br><span class=\"line\"><span class=\"keyword\">ENTRYPOINT</span><span class=\"language-bash\"> [<span class=\"string\">&quot;sh&quot;</span>, <span class=\"string\">&quot;-c&quot;</span>, <span class=\"string\">&quot;java <span class=\"variable\">$JAVA_OPTS</span> -jar app.jar&quot;</span>]</span></span><br><span class=\"line\"><span class=\"comment\"># CMD æä¾›é»˜è®¤çš„è¿è¡Œå‚æ•°ï¼Œå¯ä»¥è¢« docker run è¦†ç›–</span></span><br><span class=\"line\"><span class=\"comment\"># è¿™é‡Œé€šè¿‡ Spring Boot å‚æ•°è®¾ç½®å¯åŠ¨ç¯å¢ƒå’Œç«¯å£å·</span></span><br><span class=\"line\"><span class=\"keyword\">CMD</span><span class=\"language-bash\"> [<span class=\"string\">&quot;--spring.profiles.active=app&quot;</span>, <span class=\"string\">&quot;--server.port=8080&quot;</span>]</span></span><br><span class=\"line\"><span class=\"comment\"># è¿™é‡Œä½¿ç”¨çš„æ˜¯ ENTRYPOINT + CMD çš„æ··åˆæ¨¡å¼</span></span><br><span class=\"line\"><span class=\"comment\"># å®Œæ•´å‘½ä»¤ï¼š java $JAVA_OPTS -jar app.jar --spring.profiles.active=app --server.port=8080</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æ„å»ºé•œåƒ</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># æ„å»ºé•œåƒï¼Œ--no-cache è¡¨ç¤ºä¸ä½¿ç”¨ç¼“å­˜ï¼Œæ¯æ¬¡æ„å»ºéƒ½ä¼šé‡æ–°æ„å»º</span></span><br><span class=\"line\">docker build --no-cache -t app:latest .</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>è¿è¡Œå®¹å™¨</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run -d --name app \\</span><br><span class=\"line\">  -p 8080:8080 \\</span><br><span class=\"line\">  -e JAVA_OPTS=<span class=\"string\">&quot;-Xms512m -Xmx1024m&quot;</span> \\</span><br><span class=\"line\">  -v /home/centos/logs/app/:/app/logs \\</span><br><span class=\"line\">  app:latest</span><br></pre></td></tr></table></figure>\n<h2 id=\"Dockerfile-è¯­æ³•æ£€æµ‹\">Dockerfile è¯­æ³•æ£€æµ‹</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åœ¨çº¿æ£€æŸ¥ï¼š<a href=\"https://hadolint.github.io/hadolint/\">Dockerfile Linter</a></p>\n</li>\n<li class=\"lvl-2\">\n<p>æœ¬åœ°æ£€æŸ¥ï¼š<a href=\"https://github.com/hadolint/hadolint\">Haskell Dockerfile Linter</a>ï¼Œå¯ä»¥å®‰è£…å‘½ä»¤ï¼Œä¹Ÿå¯ä»¥é€šè¿‡dockerè¿è¡Œ</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># å®‰è£…å‘½ä»¤</span></span><br><span class=\"line\">wget -O /usr/local/bin/hadolint https://github.com/hadolint/hadolint/releases/latest/download/hadolint-Linux-x86_64</span><br><span class=\"line\"><span class=\"built_in\">chmod</span> +x /usr/local/bin/hadolint</span><br><span class=\"line\">hadolint --version</span><br><span class=\"line\"><span class=\"comment\"># æ£€æŸ¥</span></span><br><span class=\"line\">hadolint Dockerfile</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># docker è¿è¡Œ</span></span><br><span class=\"line\">docker run --<span class=\"built_in\">rm</span> -i hadolint/hadolint &lt; Dockerfile</span><br></pre></td></tr></table></figure>","content_text":"æ‘˜è¦ æœ¬æ–‡ä»‹ç» Docker å‘½ä»¤ ä¸­ Dockerfile çš„ä½¿ç”¨æ–¹æ³• Dockerå®˜æ–¹æ–‡æ¡£ Dockerfileå®˜æ–¹æ–‡æ¡£ Dockerfile æ˜¯ä»€ä¹ˆï¼Ÿ Dockerå¯ä»¥é€šè¿‡è¯»å– Dockerfile ä¸­çš„æŒ‡ä»¤æ¥è‡ªåŠ¨æ„å»ºé•œåƒã€‚ Dockerfile æ˜¯ä¸€ä¸ªæ–‡æœ¬æ–‡æ¡£ï¼Œå…¶ä¸­åŒ…å«ç”¨æˆ·å¯ä»¥åœ¨å‘½ä»¤è¡Œä¸Šè°ƒç”¨ä»¥ç»„è£…é•œåƒçš„æ‰€æœ‰æŒ‡ä»¤ã€‚ å¯ä»¥åœ¨Dockerfileä¸­ä½¿ç”¨çš„æŒ‡ä»¤ï¼š æŒ‡ä»¤ ä¸­æ–‡æè¿° ADD å°†æœ¬åœ°æˆ–è¿œç¨‹çš„æ–‡ä»¶/ç›®å½•æ·»åŠ åˆ°é•œåƒä¸­ï¼Œæ”¯æŒè‡ªåŠ¨è§£å‹ .tar æ–‡ä»¶å’Œä½¿ç”¨ URL ä¸‹è½½è¿œç¨‹èµ„æºã€‚é€šå¸¸æ¨èä½¿ç”¨ COPYï¼Œé™¤ééœ€è¦è¿™äº›é«˜çº§åŠŸèƒ½ã€‚ ARG å®šä¹‰æ„å»ºé˜¶æ®µä½¿ç”¨çš„å˜é‡ï¼Œå¯åœ¨ docker build å‘½ä»¤ä¸­é€šè¿‡ --build-arg ä¼ å…¥ï¼Œå˜é‡ä»…åœ¨æ„å»ºæ—¶æœ‰æ•ˆï¼Œä¸ä¼šä¿ç•™åœ¨æœ€ç»ˆé•œåƒä¸­ã€‚ CMD æŒ‡å®šå®¹å™¨é»˜è®¤æ‰§è¡Œçš„å‘½ä»¤å’Œå‚æ•°ï¼Œå®¹å™¨è¿è¡Œæ—¶è‹¥æœªæŒ‡å®šå‘½ä»¤ï¼Œåˆ™ä½¿ç”¨è¯¥æŒ‡ä»¤è®¾ç½®çš„å‘½ä»¤ã€‚å¦‚æœé…ç½®äº†å¤šä¸ªCMDï¼Œåˆ™åªæœ‰æœ€åä¸€ä¸ªç”Ÿæ•ˆã€‚å’ŒENTRYPOINTå…±åŒä½¿ç”¨æ—¶ï¼Œä½œä¸ºä¼ é€’ç»™ENTRYPOINTçš„å‚æ•°ã€‚å¯è¢« docker run æä¾›çš„å‘½ä»¤è¦†ç›–ã€‚ COPY å°†æ„å»ºä¸Šä¸‹æ–‡ä¸­çš„æ–‡ä»¶æˆ–ç›®å½•å¤åˆ¶åˆ°é•œåƒä¸­ã€‚ç›¸æ¯” ADD æ›´ç®€å•ã€å®‰å…¨ï¼Œæ¨èä¼˜å…ˆä½¿ç”¨ã€‚ ENTRYPOINT æŒ‡å®šå®¹å™¨å¯åŠ¨æ—¶çš„ä¸»å‘½ä»¤ï¼Œä¸å®¹æ˜“è¢« docker run ä¸­çš„å‘½ä»¤è¦†ç›–ã€‚å¯ä¸ CMD é…åˆä½¿ç”¨ï¼Œç”¨äºæä¾›é»˜è®¤å‚æ•°ã€‚ ENV è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œå˜é‡å°†åœ¨æ„å»ºå’Œå®¹å™¨è¿è¡Œæ—¶å‡å¯ä½¿ç”¨ã€‚ä¾‹å¦‚ï¼šé…ç½®åº”ç”¨å‚æ•°æˆ–ç³»ç»Ÿè·¯å¾„ç­‰ã€‚ EXPOSE å£°æ˜å®¹å™¨è¿è¡Œæ—¶å°†å¼€æ”¾çš„ç«¯å£ï¼Œä»…ç”¨äºæ–‡æ¡£è¯´æ˜æˆ–ä¸å®¹å™¨ç¼–æ’å·¥å…·é…åˆï¼Œä¸ä¼šè‡ªåŠ¨è¿›è¡Œç«¯å£æ˜ å°„ã€‚ FROM æŒ‡å®šåŸºç¡€é•œåƒï¼Œæ˜¯ Dockerfile çš„èµ·ç‚¹ã€‚ä¹Ÿå¯ä»¥ç”¨äºå¤šé˜¶æ®µæ„å»ºï¼Œé€šè¿‡å¤šæ¬¡ä½¿ç”¨ FROM æŒ‡ä»¤åˆ›å»ºå¤šä¸ªæ„å»ºé˜¶æ®µã€‚ HEALTHCHECK å®šä¹‰å®¹å™¨å¥åº·æ£€æŸ¥å‘½ä»¤ï¼Œç”¨äºå®šæœŸæ£€æµ‹å®¹å™¨å†…éƒ¨æœåŠ¡çš„å¥åº·çŠ¶æ€ï¼Œå¯ç»“åˆå®¹å™¨ç¼–æ’ç³»ç»Ÿå®ç°æ•…éšœè‡ªåŠ¨æ¢å¤ã€‚ LABEL ä¸ºé•œåƒæ·»åŠ é”®å€¼å¯¹å½¢å¼çš„å…ƒæ•°æ®ï¼Œä¾‹å¦‚ç‰ˆæœ¬ã€ç»´æŠ¤è€…ã€ç”¨é€”è¯´æ˜ç­‰ï¼Œæ–¹ä¾¿é•œåƒç®¡ç†ä¸è‡ªåŠ¨åŒ–å¤„ç†ã€‚ MAINTAINER ï¼ˆå·²å¼ƒç”¨ï¼‰ç”¨äºæŒ‡å®šé•œåƒç»´æŠ¤è€…ä¿¡æ¯ï¼Œæ¨èæ”¹ç”¨ LABEL æ¥è®¾ç½®ä½œè€…ä¿¡æ¯ã€‚ ONBUILD å®šä¹‰ä¸€ä¸ªè§¦å‘æŒ‡ä»¤ï¼Œå½“å½“å‰é•œåƒä½œä¸ºåŸºç¡€é•œåƒè¢«å…¶ä»– Dockerfile ä½¿ç”¨æ—¶è‡ªåŠ¨æ‰§è¡Œã€‚å¸¸ç”¨äºåŸºç¡€é•œåƒçš„é¢„è®¾è¡Œä¸ºã€‚ RUN æ‰§è¡Œä¸€æ¡å‘½ä»¤å¹¶æäº¤ç»“æœä½œä¸ºæ–°é•œåƒå±‚ï¼Œå¸¸ç”¨äºå®‰è£…è½¯ä»¶åŒ…ã€å¤åˆ¶æ–‡ä»¶ã€è®¾ç½®æƒé™ç­‰æ„å»ºæ“ä½œã€‚ SHELL æ›´æ”¹ Dockerfile ä¸­åç»­ RUNã€CMDã€ENTRYPOINT ç­‰æŒ‡ä»¤çš„é»˜è®¤ shellï¼ˆå¦‚ä½¿ç”¨ sh æˆ– powershellï¼‰ã€‚ STOPSIGNAL è®¾ç½®å®¹å™¨ç»ˆæ­¢æ—¶å‘é€çš„ç³»ç»Ÿä¿¡å·ï¼ˆå¦‚ SIGTERMï¼‰ï¼Œç”¨äºä¼˜é›…å…³é—­åº”ç”¨ã€‚ USER è®¾ç½®æ‰§è¡Œåç»­å‘½ä»¤æ—¶æ‰€ä½¿ç”¨çš„ç”¨æˆ·å’Œç”¨æˆ·ç»„ï¼Œå¢å¼ºå®¹å™¨çš„å®‰å…¨æ€§ï¼Œé¿å…ä½¿ç”¨ root æƒé™ã€‚ VOLUME å®šä¹‰å®¹å™¨å†…çš„æŒ‚è½½ç‚¹ï¼Œç”¨äºæŒä¹…åŒ–æ•°æ®æˆ–ä¸å®¿ä¸»æœº/å…¶ä»–å®¹å™¨å…±äº«æ•°æ®ã€‚è¿è¡Œå®¹å™¨æ—¶å¯æŒ‡å®šæŒ‚è½½è·¯å¾„ã€‚ WORKDIR è®¾ç½®å·¥ä½œç›®å½•ï¼Œç›¸å½“äºæ‰§è¡Œ cdï¼Œç”¨äºç®€åŒ–åç»­å‘½ä»¤ä¸­çš„è·¯å¾„ã€‚è‹¥ç›®å½•ä¸å­˜åœ¨åˆ™è‡ªåŠ¨åˆ›å»ºã€‚ æ„å»ºé˜¶æ®µæŒ‡ä»¤ï¼šFROM, ARG, ENV, COPY, ADD, RUN, WORKDIR, LABEL, USER, SHELL, ONBUILD å¯åŠ¨é…ç½®æŒ‡ä»¤ï¼šCMD, ENTRYPOINT, HEALTHCHECK, EXPOSE, VOLUME, STOPSIGNAL Dockerfile æŒ‡ä»¤ä»‹ç» FROM FROM æŒ‡ä»¤ç”¨äºæŒ‡å®šåŸºç¡€é•œåƒï¼ˆbase imageï¼‰ï¼Œæ˜¯æ¯ä¸€ä¸ª Dockerfile ä¸­å¿…é¡»çš„ç¬¬ä¸€æ¡æŒ‡ä»¤ã€‚æ‰€æœ‰åç»­æŒ‡ä»¤éƒ½æ˜¯åŸºäºè¿™ä¸ªåŸºç¡€é•œåƒæ„å»ºçš„ã€‚ è¯­æ³• 12345FROM &lt;image&gt;[:&lt;tag&gt;] [AS &lt;stage-name&gt;]# è¯´æ˜ï¼š# &lt;image&gt;ï¼šé•œåƒåç§°ï¼ˆå¯ä»¥æ˜¯æœ¬åœ°å·²æœ‰çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯ä» Docker Hub æˆ–å…¶ä»–é•œåƒä»“åº“æ‹‰å–çš„ï¼‰# [:&lt;tag&gt;]ï¼šé•œåƒæ ‡ç­¾ï¼ˆå¯é€‰ï¼Œé»˜è®¤æ˜¯ latestï¼‰# [AS &lt;stage-name&gt;]ï¼šä¸ºè¯¥æ„å»ºé˜¶æ®µæŒ‡å®šåç§°ï¼Œç”¨äºå¤šé˜¶æ®µæ„å»º ç¤ºä¾‹ 12345678910111213141516171819# ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„é•œåƒï¼ˆé»˜è®¤æ ‡ç­¾æ˜¯ latestï¼‰FROM node# ä½¿ç”¨æŒ‡å®šçš„æ ‡ç­¾FROM node:16.13.2-alpine# ä½¿ç”¨ç§æœ‰é•œåƒä»“åº“FROM private.registry.com/my-image:latest# ä½¿ç”¨å¤šé˜¶æ®µæ„å»ºFROM golang:1.20 AS builderWORKDIR /appCOPY . .RUN go build -o myappFROM alpine:latestCOPY --from=builder /app/myapp /usr/local/bin/myappENTRYPOINT [&quot;myapp&quot;]## è¿™é‡Œç”¨äº†ä¸¤ä¸ªé˜¶æ®µï¼š### builder é˜¶æ®µç”¨æ¥ç¼–è¯‘åº”ç”¨ï¼›### alpine é˜¶æ®µç”¨æ¥æ‰“åŒ…æœ€ç»ˆé•œåƒï¼ŒåªåŒ…å«ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå‡å°‘ä½“ç§¯ã€‚ WORKDIR WORKDIR æŒ‡å®šäº†å·¥ä½œç›®å½•ï¼Œå³åç»­æ‰€æœ‰æŒ‡ä»¤ï¼ˆå¦‚ RUNã€CMDã€ENTRYPOINTã€COPYã€ADD ç­‰ï¼‰æ‰€è¿è¡Œçš„å½“å‰è·¯å¾„ï¼ˆworking directoryï¼‰ã€‚ å¦‚æœç›®å½•ä¸å­˜åœ¨ï¼ŒDocker ä¼šè‡ªåŠ¨åˆ›å»ºå®ƒã€‚ æ¯ä¸ª WORKDIR éƒ½ä¼šåˆ›å»ºä¸€å±‚é•œåƒï¼ˆlayerï¼‰ï¼Œæ‰€ä»¥ä¸è¦é‡å¤è®¾ç½®æ— æ„ä¹‰çš„è·¯å¾„ã€‚ è¯­æ³• 123WORKDIR &lt;path&gt;# è¯´æ˜ï¼š# &lt;path&gt;ï¼šè¦åˆ‡æ¢çš„å·¥ä½œç›®å½•ï¼Œå¯ä»¥æ˜¯ç»å¯¹è·¯å¾„æˆ–ç›¸å¯¹è·¯å¾„ã€‚ ç¤ºä¾‹ 12345678910111213# è®¾ç½®ç»å¯¹è·¯å¾„WORKDIR /app# è¿ç»­è®¾ç½®å¤šä¸ªå·¥ä½œç›®å½•ï¼ˆé€å±‚åµŒå¥—ï¼‰WORKDIR /varWORKDIR wwwWORKDIR html# ç­‰åŒäº:WORKDIR /var/www/html# é¿å…åœ¨ RUN cd some_dir åç»§ç»­æ‰§è¡Œä¾èµ–è·¯å¾„çš„å‘½ä»¤ï¼Œå› ä¸º Docker æ¯ä¸€æ¡æŒ‡ä»¤éƒ½æ˜¯æ–°çš„ shell å®ä¾‹ï¼Œcd ä¸ä¼šè·¨æŒ‡ä»¤ä¿ç•™ï¼Œåº”è¯¥æ”¹ç”¨ WORKDIRã€‚RUN cd some_dir # é”™è¯¯WORKDIR some_dir # æ­£ç¡® ARG ARG ç”¨äºåœ¨ æ„å»ºé•œåƒæ—¶ï¼ˆbuild-timeï¼‰ä¼ å…¥å‚æ•°ã€‚è¿™äº›å‚æ•°åªåœ¨ æ„å»ºé˜¶æ®µæœ‰æ•ˆï¼Œä¸ä¼šå‡ºç°åœ¨æœ€ç»ˆé•œåƒä¸­ï¼Œä¹Ÿä¸ä¼šåœ¨å®¹å™¨è¿è¡Œæ—¶è¢«ä¿ç•™ã€‚ è¯­æ³• 1234ARG &lt;name&gt;[=&lt;default_value&gt;]# è¯´æ˜ï¼š# &lt;name&gt;ï¼šå‚æ•°åç§°# [=&lt;default_value&gt;]ï¼šå‚æ•°çš„é»˜è®¤å€¼ï¼Œå¦‚æœæœªä¼ å…¥å‚æ•°ï¼Œåˆ™ä½¿ç”¨é»˜è®¤å€¼ï¼Œå¦‚æœä¸ºè®¾ç½®default_valueï¼Œåˆ™æ„å»ºé•œåƒæ—¶å¿…é¡»ä¼ é€’å‚æ•°ï¼Œ--build-arg ç¤ºä¾‹ 12345678910# å®šä¹‰ä¸€ä¸ªå‚æ•°ï¼Œåœ¨æ„å»ºé•œåƒæ—¶å¿…é¡»ä¼ å…¥å‚æ•°ï¼Œ--build-arg APP_ENV=developmentARG APP_ENV# å¸¦é»˜è®¤å€¼çš„ ARGARG APP_ENV=development# ä½¿ç”¨å‚æ•°RUN echo &quot;å½“å‰ç¯å¢ƒï¼š$&#123;APP_ENV&#125;&quot;# ä¸ FROM ä¸€èµ·ç”¨ï¼ˆä» Docker 17.05 èµ·ï¼‰ARG BASE=ubuntuFROM $&#123;BASE&#125;:22.04 ENV ENV æŒ‡ä»¤ç”¨äºåœ¨é•œåƒæ„å»ºè¿‡ç¨‹ä¸­å®šä¹‰ç¯å¢ƒå˜é‡ï¼ˆEnvironment Variablesï¼‰ã€‚è¿™äº›å˜é‡å¯ä»¥åœ¨ä¹‹åçš„æ„å»ºæ­¥éª¤ï¼ˆæ¯”å¦‚ RUNã€CMD ç­‰ï¼‰ä¸­ä½¿ç”¨ï¼Œä¹Ÿä¼šåœ¨å®¹å™¨è¿è¡Œæ—¶ç”Ÿæ•ˆã€‚ è¯­æ³• 1234567# ä¸¤ç§è¯­æ³•ENV &lt;key&gt; &lt;value&gt;ENV &lt;key&gt;=&lt;value&gt; ...# è¯´æ˜ï¼š# &lt;key&gt;ï¼šç¯å¢ƒå˜é‡çš„åç§°# &lt;value&gt;ï¼šç¯å¢ƒå˜é‡çš„å€¼# å¦‚æœå®šä¹‰å¤šä¸ªå˜é‡ï¼Œæ¨èä½¿ç”¨ key=value çš„å½¢å¼ã€‚ ç¤ºä¾‹ 123456789101112# å®šä¹‰ä¸€ä¸ªç¯å¢ƒå˜é‡ENV APP_ENV=production# å®šä¹‰å¤šä¸ªå˜é‡ENV APP_PORT=8080 NODE_ENV=production# ä½¿ç”¨å¤šè¡Œæ ¼å¼ï¼ˆæé«˜å¯è¯»æ€§ï¼‰ENV PATH=&quot;/usr/local/bin:$&#123;PATH&#125;&quot; \\ LANG=&quot;en_US.UTF-8&quot; \\ TZ=&quot;Asia/Shanghai&quot;# ä¹Ÿå¯ä»¥åˆ†å¼€å®šä¹‰ENV PATH=&quot;/usr/local/bin:$PATH&quot;ENV LANG=&quot;en_US.UTF-8&quot;ENV TZ=&quot;Asia/Shanghai&quot; æ³¨æ„ï¼šENV æŒ‡ä»¤å®šä¹‰çš„ç¯å¢ƒå˜é‡åœ¨æ„å»ºé˜¶æ®µå’Œè¿è¡Œé˜¶æ®µéƒ½ä¼šç”Ÿæ•ˆï¼Œä½†è¿è¡Œé˜¶æ®µä¼šè¦†ç›–æ„å»ºé˜¶æ®µå®šä¹‰çš„å˜é‡ã€‚ LABEL LABEL ç”¨äºä¸ºé•œåƒæ·»åŠ å…ƒæ•°æ®æ ‡ç­¾ï¼Œä»¥ key=value çš„å½¢å¼å­˜åœ¨ã€‚è¿™äº›æ ‡ç­¾å¯ä»¥æ˜¯ä½œè€…ä¿¡æ¯ã€ç‰ˆæœ¬æè¿°ã€ç”¨é€”è¯´æ˜ã€æ„å»ºæ—¶é—´ç­‰ã€‚ æ—§çš„ MAINTAINER æŒ‡ä»¤ç°åœ¨å·²è¢«åºŸå¼ƒï¼Œæ¨èä½¿ç”¨ LABEL æ¥ä»£æ›¿ã€‚ æ¯ä¸ª LABEL éƒ½ä¼šåˆ›å»ºä¸€å±‚é•œåƒï¼ˆlayerï¼‰ï¼Œæ¨èä¸€æ¬¡è®¾ç½®å¤šä¸ªã€‚ è¯­æ³• 1234LABEL &lt;key&gt;=&lt;value&gt; [&lt;key&gt;=&lt;value&gt;...]# è¯´æ˜ï¼š# &lt;key&gt;ï¼šæ ‡ç­¾çš„é”®# &lt;value&gt;ï¼šæ ‡ç­¾çš„å€¼ ç¤ºä¾‹ 12345678# æ·»åŠ ä¸€ä¸ªæ ‡ç­¾LABEL maintainer=&quot;yourname@example.com&quot;# æ¢è¡Œæ ¼å¼ï¼ˆæ¨èï¼‰,ä»¥ä¸‹æ ‡ç­¾ç¬¦åˆ OCIï¼ˆOpen Container Initiativeï¼‰ é•œåƒè§„èŒƒLABEL \\ org.opencontainers.image.title=&quot;MyApp&quot; \\ org.opencontainers.image.description=&quot;æ¼”ç¤ºé¡¹ç›®&quot; \\ org.opencontainers.image.version=&quot;1.0.0&quot; \\ org.opencontainers.image.authors=&quot;zhangsan@example.com&quot; USER USER æŒ‡ä»¤ç”¨äºæŒ‡å®šåç»­æŒ‡ä»¤ï¼ˆå¦‚ RUNã€CMDã€ENTRYPOINTã€COPY ç­‰ï¼‰ä»¥å“ªä¸ªç”¨æˆ·èº«ä»½æ¥æ‰§è¡Œã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼ŒDocker å®¹å™¨ä¸­çš„å‘½ä»¤ä»¥ root ç”¨æˆ·è¿è¡Œï¼Œè¿™è™½ç„¶çµæ´»ä½†ä¸å®‰å…¨ã€‚ä½¿ç”¨ USER å¯ä»¥è®©æˆ‘ä»¬åˆ‡æ¢åˆ°æ™®é€šç”¨æˆ·ï¼Œä»è€Œæå‡å®¹å™¨çš„å®‰å…¨æ€§ï¼Œé˜²æ­¢æ½œåœ¨çš„æƒé™æ»¥ç”¨ã€‚ è¯­æ³• 1234USER &lt;user&gt;[:&lt;group&gt;]# è¯´æ˜ï¼š# &lt;user&gt;ï¼šç”¨æˆ·åæˆ– UID# [:&lt;group&gt;]ï¼šå¯é€‰ï¼Œç”¨æˆ·ç»„åæˆ– GID ç¤ºä¾‹ 123456# è®¾ç½®ç”¨æˆ·USER appuser# è®¾ç½®ç”¨æˆ·ç»„USER appuser:appgroup# ä½¿ç”¨ UID å’Œ GIDUSER 1000:1000 å¦‚æœåŸºç¡€é•œåƒä¸­æ²¡æœ‰ä½ æƒ³è¦çš„ç”¨æˆ·ï¼Œéœ€è¦åœ¨ Dockerfile ä¸­æ‰‹åŠ¨åˆ›å»º 1234# åˆ›å»ºç”¨æˆ·å’Œç»„RUN groupadd -r appgroup &amp;&amp; useradd -r -g appgroup appuser# åˆ‡æ¢ç”¨æˆ·USER appuser ADD ADD ç”¨äºå°†æœ¬åœ°æ–‡ä»¶æˆ–ç›®å½•ã€è¿œç¨‹æ–‡ä»¶ï¼ˆURLï¼‰ æˆ– å‹ç¼©åŒ… å¤åˆ¶åˆ°é•œåƒä¸­çš„æŒ‡å®šä½ç½®ã€‚ å®ƒçš„åŠŸèƒ½ç±»ä¼¼äº COPYï¼Œä½†æ¯” COPY å¤šå‡ ä¸ªåŠŸèƒ½ï¼ˆè§£å‹ã€æ‹‰å–è¿œç¨‹æ–‡ä»¶ç­‰ï¼‰ã€‚ è¯­æ³• 1234ADD &lt;src&gt;... &lt;dest&gt;# è¯´æ˜ï¼š# &lt;src&gt;ï¼šè¦å¤åˆ¶çš„æ–‡ä»¶æˆ–ç›®å½•ï¼Œå¯ä»¥æ˜¯æœ¬åœ°æ–‡ä»¶ã€è¿œç¨‹ URLã€å‹ç¼©åŒ…ç­‰# &lt;dest&gt;ï¼šç›®æ ‡è·¯å¾„ ç¤ºä¾‹ 12345678910# ä»æœ¬åœ°æ–‡ä»¶å¤åˆ¶ADD app.jar /app.jar# å¤åˆ¶å¤šä¸ªADD app1.jar app2.jar /app/# é€šé…ç¬¦ADD static-assets/*.html /app/public/# ä»è¿œç¨‹ URL å¤åˆ¶ADD https://example.com/app.jar /app.jar# ä»å‹ç¼©åŒ…ä¸­å¤åˆ¶ADD static-assets.tar.gz /app/public/ æœ€ä½³å®è·µæ˜¯ä¼˜å…ˆä½¿ç”¨ COPYï¼Œåªæœ‰åœ¨éœ€è¦ ADD çš„é¢å¤–åŠŸèƒ½æ—¶æ‰ä½¿ç”¨å®ƒã€‚ COPY COPY æŒ‡ä»¤ç”¨äºå°†ä¸»æœºä¸Šçš„æ–‡ä»¶æˆ–ç›®å½•å¤åˆ¶åˆ°é•œåƒçš„æ–‡ä»¶ç³»ç»Ÿä¸­ã€‚å®ƒæ˜¯æ„å»ºé•œåƒè¿‡ç¨‹ä¸­æœ€å¸¸ç”¨çš„æ•°æ®å¼•å…¥æ–¹å¼ä¹‹ä¸€ã€‚ ä¸ ADD ç±»ä¼¼ï¼Œä½†åŠŸèƒ½æ›´ç®€å•ã€æ˜ç¡®ã€å®‰å…¨ æ¨èä¼˜å…ˆä½¿ç”¨ COPYï¼Œé™¤éä½ ç¡®å®éœ€è¦ ADD æä¾›çš„è‡ªåŠ¨è§£å‹æˆ–è¿œç¨‹ä¸‹è½½åŠŸèƒ½ã€‚ è¯­æ³• 1234COPY &lt;src&gt;... &lt;dest&gt;# è¯´æ˜ï¼š# &lt;src&gt;ï¼šè¦å¤åˆ¶çš„æ–‡ä»¶æˆ–ç›®å½•# &lt;dest&gt;ï¼šç›®æ ‡è·¯å¾„ ç¤ºä¾‹ 12345678910# å¤åˆ¶å•ä¸ªæ–‡ä»¶COPY app.jar /app.jar# å¤åˆ¶å¤šä¸ªæ–‡ä»¶COPY app1.jar app2.jar /app/# å¤åˆ¶ç›®å½•COPY static-assets/ /app/public/# é€šé…ç¬¦COPY static-assets/*.html /app/public/# è®¾ç½®ç›®æ ‡æ–‡ä»¶å±ä¸»å±ç»„COPY --chown=appuser:appgroup app.jar /app.jar RUN RUN æŒ‡ä»¤ç”¨äºåœ¨é•œåƒæ„å»ºé˜¶æ®µæ‰§è¡Œå‘½ä»¤ï¼Œç»“æœä¼šè¢«æ‰“åŒ…è¿›é•œåƒå±‚ä¸­ã€‚ å®ƒå¯ä»¥ç”¨äºå®‰è£…ä¾èµ–ã€ç¼–è¯‘ä»£ç ã€è¿è¡Œå‘½ä»¤ç­‰ã€‚ æ¯ä¸€æ¡ RUN æŒ‡ä»¤ä¼šåˆ›å»ºä¸€å±‚é•œåƒï¼ˆlayerï¼‰,åˆå¹¶å¤šä¸ªå‘½ä»¤æˆä¸€æ¡ RUNï¼Œå¯ä»¥å‡å°‘é•œåƒå±‚æ•°ï¼ˆä¾‹å¦‚ä½¿ç”¨ &amp;&amp; ä¸²è”ï¼‰ã€‚ è¯­æ³• 12345# ç¬¬ä¸€ç§æ ¼å¼ï¼šå®é™…è¿è¡Œçš„æ˜¯ï¼š/bin/sh -c &quot;&lt;å‘½ä»¤å­—ç¬¦ä¸²&gt;&quot;RUN &lt;å‘½ä»¤å­—ç¬¦ä¸²&gt;# ç¬¬äºŒç§æ ¼å¼RUN [&quot;å¯æ‰§è¡Œæ–‡ä»¶&quot;, &quot;å‚æ•°1&quot;, &quot;å‚æ•°2&quot;, ...] ç¤ºä¾‹ 12345678910# å‘½ä»¤å­—ç¬¦ä¸²RUN apt-get update &amp;&amp; apt-get install -y curl# æ„å»ºå¤šä¸ªå‘½ä»¤(ç”¨ &amp;&amp; ä¸²è”)RUN apt-get update &amp;&amp; \\ apt-get install -y python3 &amp;&amp; \\ rm -rf /var/lib/apt/lists/*# å¯æ‰§è¡Œæ–‡ä»¶å‚æ•°RUN [&quot;/bin/sh&quot;, &quot;-c&quot;, &quot;curl https://example.com/app.jar &gt; app.jar&quot;] CMD CMD ç”¨äºæŒ‡å®šå®¹å™¨å¯åŠ¨æ—¶é»˜è®¤æ‰§è¡Œçš„å‘½ä»¤åŠå…¶å‚æ•°ã€‚ å¦‚æœç”¨æˆ·åœ¨è¿è¡Œå®¹å™¨æ—¶æ²¡æœ‰æ‰‹åŠ¨æŒ‡å®šå…¶ä»–å‘½ä»¤ï¼ŒDocker å°±ä¼šä½¿ç”¨ CMD æä¾›çš„å†…å®¹ã€‚ å®ƒå¯ä»¥å®šä¹‰å¤šä¸ªï¼Œä½†åªæœ‰æœ€åä¸€ä¸ªä¼šè¢«ä½¿ç”¨ã€‚ è¯­æ³• 1234567# Shell å½¢å¼ï¼ˆå­—ç¬¦ä¸²ï¼‰CMD command param1 param2# ç­‰ä»·äº /bin/sh -c &quot;command param1 param2&quot;# Exec å½¢å¼ï¼ˆæ•°ç»„ï¼‰CMD [&quot;executable&quot;, &quot;param1&quot;, &quot;param2&quot;, ...] ç¤ºä¾‹ 123456789# ç®€å• shell å‘½ä»¤CMD echo &quot;Hello from container&quot;# Exec å½¢å¼CMD [&quot;npm&quot;, &quot;start&quot;]# ä½œä¸º ENTRYPOINT çš„å‚æ•°ENTRYPOINT [&quot;python3&quot;, &quot;app.py&quot;]CMD [&quot;--host=0.0.0.0&quot;, &quot;--port=8080&quot;] ç”¨æˆ·å¯ä»¥è¦†ç›– CMDï¼š 1docker run &lt;myapp&gt; npm run test ENTRYPOINT ENTRYPOINT å®šä¹‰å®¹å™¨å¯åŠ¨æ—¶æ‰§è¡Œçš„ä¸»å‘½ä»¤ï¼Œç›¸æ¯” CMDï¼Œå®ƒä¸å®¹æ˜“è¢«è¦†ç›–ï¼Œæ›´é€‚åˆåˆ¶ä½œâ€œä¸“ç”¨å‹â€å®¹å™¨ï¼ˆå¦‚ nginxã€python è„šæœ¬ç­‰ï¼‰ã€‚ ä½ å¯ä»¥æŠŠ ENTRYPOINT ç†è§£ä¸ºå®¹å™¨çš„â€œä¸»ç¨‹åºâ€ï¼Œè€Œ CMD æ˜¯ä¸ºå®ƒæä¾›çš„é»˜è®¤â€œå‘½ä»¤è¡Œå‚æ•°â€ã€‚ è¯­æ³• 123456# Shell å½¢å¼ï¼ˆå­—ç¬¦ä¸²ï¼‰ENTRYPOINT command param1 param2# ç­‰ä»·äº /bin/sh -c &quot;command param1 param2&quot;# Exec å½¢å¼ï¼ˆæ•°ç»„ï¼‰ENTRYPOINT [&quot;executable&quot;, &quot;param1&quot;, &quot;param2&quot;, ...] ç¤ºä¾‹ 123456789# ç®€å• shell å‘½ä»¤ENTRYPOINT echo &quot;Hello from container&quot;# Exec å½¢å¼ENTRYPOINT [&quot;npm&quot;, &quot;start&quot;]# ç»“åˆ CMD ä½¿ç”¨ENTRYPOINT [&quot;python3&quot;, &quot;app.py&quot;]CMD [&quot;--host=0.0.0.0&quot;, &quot;--port=8080&quot;] EXPOSE EXPOSE ç”¨äºå£°æ˜å®¹å™¨å°†ä¼šç›‘å¬çš„ç«¯å£ï¼Œè®©ä½¿ç”¨è¯¥é•œåƒçš„äººçŸ¥é“åº”è¯¥å¯¹å¤–å¼€æ”¾å“ªäº›ç«¯å£ã€‚ âš ï¸ æ³¨æ„ï¼šEXPOSE å¹¶ä¸ä¼šçœŸçš„å¼€æ”¾ç«¯å£ï¼Œåªæ˜¯â€œå£°æ˜â€è¿™ä¸ªå®¹å™¨ç›‘å¬äº†è¿™äº›ç«¯å£ã€‚ è¦è®©ç«¯å£çœŸæ­£æš´éœ²å‡ºæ¥ï¼Œè¿˜éœ€è¦åœ¨è¿è¡Œå®¹å™¨æ—¶åŠ ä¸Š -p æˆ– --publish å‚æ•°ã€‚ è¯­æ³• 1234EXPOSE &lt;port&gt; [&lt;port&gt;/&lt;protocol&gt;...]# è¯´æ˜ï¼š# &lt;port&gt;ï¼šç«¯å£å·ï¼Œå¯ä»¥æ˜¯å•ä¸ªç«¯å£å·ï¼Œä¹Ÿå¯ä»¥æ˜¯èŒƒå›´ï¼ˆå¦‚ 8080-8085ï¼‰# &lt;protocol&gt;ï¼šåè®®ï¼Œå¯ä»¥æ˜¯ tcp æˆ– udpï¼Œé»˜è®¤ä¸º tcp ç¤ºä¾‹ 1234EXPOSE 8080EXPOSE 8080/udpEXPOSE 8080-8085EXPOSE 8080 8081 8082 8083 8084 8085 VOLUME VOLUME æŒ‡ä»¤ç”¨äºå£°æ˜ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨ä¸­çš„æŒ‚è½½ç‚¹ï¼ˆmount pointï¼‰ï¼Œç”¨äºæŒä¹…åŒ–æ•°æ®æˆ–ä¸å®¿ä¸»æœº/å…¶ä»–å®¹å™¨å…±äº«æ•°æ®ã€‚ è¯­æ³•ï¼š 123VOLUME [&quot;/path/in/container&quot;, ...]# è·¯å¾„å¿…é¡»æ˜¯å®¹å™¨å†…éƒ¨çš„ç»å¯¹è·¯å¾„# å¯ä»¥ä¸€æ¬¡å£°æ˜ä¸€ä¸ªï¼Œä¹Ÿå¯ä»¥æ˜¯å¤šä¸ªã€‚ ç¤ºä¾‹ 1234# å£°æ˜ä¸€ä¸ªæŒ‚è½½ç‚¹VOLUME /app/public# å£°æ˜å¤šä¸ªæŒ‚è½½ç‚¹VOLUME [&quot;/app/public&quot;, &quot;/app/logs&quot;] å½“å®¹å™¨è¿è¡Œæ—¶ï¼Œå¯ä»¥å°†é•œåƒä¸­å£°æ˜çš„æŒ‚è½½ç‚¹æ˜ å°„åˆ°å®¿ä¸»æœºä¸Šï¼Œä»è€Œå®ç°æŒä¹…åŒ–æ•°æ®ã€‚ 1docker run -v /host/path:/app/public myimage å¦‚æœä½ æ²¡æœ‰æ‰‹åŠ¨ç»‘å®šæŒ‚è½½ï¼ŒDocker ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªåŒ¿åå·ï¼Œå·çš„å†…å®¹é»˜è®¤ä¿å­˜åœ¨å®¿ä¸»æœºçš„ /var/lib/docker/volumes ä¸‹ã€‚ HEALTHCHECK HEALTHCHECK ç”¨æ¥å®šä¹‰å®¹å™¨è¿è¡Œæ—¶çš„å¥åº·æ£€æŸ¥å‘½ä»¤ï¼Œå®šæœŸæ£€æµ‹å®¹å™¨å†…æœåŠ¡çš„çŠ¶æ€ï¼Œå¸®åŠ©ç¼–æ’å·¥å…·ï¼ˆDocker Swarmã€Kubernetes ç­‰ï¼‰åˆ¤æ–­å®¹å™¨æ˜¯å¦å¥åº·ã€‚ å¦‚æœå¥åº·æ£€æŸ¥å¤±è´¥ï¼ŒDocker ä¼šå°†å®¹å™¨æ ‡è®°ä¸º unhealthyï¼Œä¾¿äºè‡ªåŠ¨é‡å¯æˆ–æ›¿æ¢ã€‚ è¯­æ³• 12345678HEALTHCHECK &lt;options&gt; CMD &lt;command&gt;# è¯´æ˜ï¼š# &lt;options&gt;ï¼šå¯é€‰é¡¹ï¼Œç”¨äºè®¾ç½®å¥åº·æ£€æŸ¥çš„é€‰é¡¹ï¼Œå¦‚è¶…æ—¶æ—¶é—´ã€é‡è¯•æ¬¡æ•°ç­‰ã€‚# &lt;command&gt;ï¼šå¥åº·æ£€æŸ¥å‘½ä»¤ï¼Œå¯ä»¥æ˜¯ä»»ä½•æœ‰æ•ˆçš„ shell å‘½ä»¤ã€‚ # å¿…é¡»è¿”å›é€€å‡ºç : # 0 è¡¨ç¤ºå¥åº· # 1 è¡¨ç¤ºä¸å¥åº· # 2 è¡¨ç¤ºæœªçŸ¥ å¯é€‰å‚æ•°ï¼ˆOPTIONSï¼‰ å‚æ•° è¯´æ˜ é»˜è®¤å€¼ --interval=DURATION ä¸¤æ¬¡å¥åº·æ£€æŸ¥ä¹‹é—´çš„æ—¶é—´é—´éš” 30s --timeout=DURATION å•æ¬¡æ£€æµ‹å‘½ä»¤çš„è¶…æ—¶æ—¶é—´ 30s --start-period=DURATION å®¹å™¨å¯åŠ¨åï¼Œå¼€å§‹å¥åº·æ£€æŸ¥å‰çš„ç­‰å¾…æ—¶é—´ 0s --retries=N è¿ç»­å¤±è´¥å‡ æ¬¡ååˆ¤å®šå®¹å™¨ä¸å¥åº· 3 ç¤ºä¾‹ 12# ä½¿ç”¨ curl æ£€æµ‹ Web æœåŠ¡æ˜¯å¦å“åº”HEALTHCHECK --interval=5s --timeout=3s --retries=3 CMD curl -f http://localhost:8080/health || exit 1 è¿è¡Œå®¹å™¨åï¼Œå¯ä»¥ç”¨å‘½ä»¤æŸ¥çœ‹å¥åº·çŠ¶æ€ 123456789# å¦‚æœé•œåƒä¸­æœ‰å¥åº·æ£€æŸ¥ï¼Œå¯ä»¥æŸ¥çœ‹å®¹å™¨çŠ¶æ€ï¼ˆSTATUSï¼‰docker ps # STATUS åˆ—ä¼šæ˜¾ç¤ºï¼š # healthy # unhealthy # startingï¼ˆå¯åŠ¨ä¸­ï¼‰# æŸ¥çœ‹æ›´è¯¦ç»†çš„ä¿¡æ¯docker inspect --format=&#x27;&#123;&#123;json .State.Health&#125;&#125;&#x27; &lt;container-id&gt; SHELL SHELL æŒ‡ä»¤ç”¨æ¥è‡ªå®šä¹‰åç»­ RUNã€CMD å’Œ ENTRYPOINT æŒ‡ä»¤æ‰€ä½¿ç”¨çš„é»˜è®¤ shell ç¨‹åºå’Œå‚æ•°ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼š åœ¨ Linux é•œåƒä¸­ï¼ŒDocker ä½¿ç”¨ /bin/sh -c åœ¨ Windows é•œåƒä¸­ï¼Œä½¿ç”¨ cmd /S /C ä½¿ç”¨ SHELLï¼Œä½ å¯ä»¥æ›¿æ¢ä¸ºå…¶ä»– shellï¼Œå¦‚ Bashã€PowerShellã€zsh ç­‰ã€‚ è¯­æ³• 1SHELL [&quot;executable&quot;, &quot;param1&quot;, &quot;param2&quot;, ...] ç¤ºä¾‹ 123456789101112# åˆ‡æ¢åˆ° bashSHELL [&quot;bash&quot;, &quot;-c&quot;]# å¤šæ¬¡åˆ‡æ¢SHELL [&quot;/bin/bash&quot;, &quot;-c&quot;]RUN echo &quot;Hello from Bash&quot; # åœ¨ Bash ä¸­æ‰§è¡ŒSHELL [&quot;/bin/sh&quot;, &quot;-c&quot;]RUN echo &quot;Now back to sh&quot; # åœ¨ sh ä¸­æ‰§è¡Œ# WindowsSHELL [&quot;powershell&quot;, &quot;-Command&quot;] STOPSIGNAL STOPSIGNAL æŒ‡å®šå½“å®¹å™¨æ”¶åˆ° docker stop å‘½ä»¤æ—¶ï¼Œå‘é€ç»™å®¹å™¨ä¸»è¿›ç¨‹çš„ä¿¡å·ç±»å‹ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼ŒDocker ä¼šå‘å®¹å™¨çš„ä¸»è¿›ç¨‹å‘é€ SIGTERM ä¿¡å·ï¼Œè®©å®ƒæœ‰æœºä¼šä¼˜é›…åœ°é€€å‡ºï¼ˆåœ¨è¶…æ—¶æ—¶æœªé€€å‡ºåˆ™å‘ SIGKILL å¼ºåˆ¶ç»ˆæ­¢ï¼‰ã€‚ é»˜è®¤æƒ…å†µï¼Œå¤§å¤šæ•°ç¨‹åºï¼ˆå¦‚ nginxï¼‰ï¼Œä¸éœ€è¦è®¾ç½®ï¼ˆé»˜è®¤ SIGTERMï¼‰ ä½†æœ‰äº›ç¨‹åºå¯èƒ½éœ€è¦ä½¿ç”¨ä¸åŒçš„ä¿¡å·ï¼Œæ¯”å¦‚ SIGINTã€SIGHUPï¼Œè¿™æ—¶ä½ å¯ä»¥é€šè¿‡ STOPSIGNAL æ¥ä¿®æ”¹ã€‚ è¯­æ³• 12345STOPSIGNAL &lt;signal&gt;# è¯´æ˜ï¼š# å…¶ä¸­ &lt;signal&gt; å¯ä»¥æ˜¯ï¼š# ä¿¡å·åç§°ï¼Œä¾‹å¦‚ï¼šSIGTERMã€SIGKILLã€SIGINTã€SIGHUP# æˆ–ä¿¡å·ç¼–å·ï¼Œä¾‹å¦‚ï¼š15ï¼ˆç­‰ä»·äº SIGTERMï¼‰ ç¤ºä¾‹ 12345# è¿™æ˜¯é»˜è®¤è¡Œä¸ºï¼Œä¸å†™ä¹Ÿä¸€æ ·ã€‚STOPSIGNAL SIGTERM# ä¿®æ”¹ä¸º SIGINTSTOPSIGNAL SIGINT ONBUILD ONBUILD ç”¨äºå®šä¹‰å»¶è¿Ÿæ‰§è¡Œçš„æ„å»ºæŒ‡ä»¤ï¼Œå³è¿™äº›å‘½ä»¤ä¸ä¼šåœ¨å½“å‰ Dockerfile æ„å»ºæ—¶æ‰§è¡Œï¼Œè€Œæ˜¯åœ¨ ä»¥å½“å‰é•œåƒä¸ºåŸºç¡€çš„å­é•œåƒä¸­æ„å»ºæ—¶è§¦å‘æ‰§è¡Œã€‚ å®ƒçš„å…¸å‹ç”¨é€”æ˜¯ï¼šæ„å»ºä¸€ä¸ªâ€œé€šç”¨åŸºç¡€é•œåƒâ€ï¼Œè®©ä½¿ç”¨è€…åœ¨è‡ªå·±çš„ Dockerfile ä¸­ FROM å®ƒæ—¶è‡ªåŠ¨ç»§æ‰¿ä¸€äº›æ“ä½œï¼ˆæ¯”å¦‚ COPYã€RUN ç­‰ï¼‰ã€‚ ONBUILD æ˜¯ä¸€ç§è®¾è®¡æ¨¡å¼ï¼Œæ–¹ä¾¿åŸºç¡€é•œåƒä½œè€…é¢„å…ˆå®šä¹‰â€œæœªæ¥å­é•œåƒæ„å»ºæ—¶ä¸€å®šè¦æ‰§è¡Œçš„æ­¥éª¤â€ï¼Œè€Œä¸æ˜¯åœ¨åŸºç¡€é•œåƒä¸­â€œç¡¬ç¼–ç â€é‚£äº›æ­¥éª¤ã€‚ è¯­æ³• 123ONBUILD &lt;INSTRUCTION&gt;# è¯´æ˜ï¼š# &lt;INSTRUCTION&gt;ï¼šå¿…é¡»æ˜¯ä¸€ä¸ªåˆæ³•çš„ Dockerfile æŒ‡ä»¤ï¼Œå¦‚ RUNã€COPYã€ADDã€CMD ç­‰ï¼ˆä½†ä¸èƒ½æ˜¯ FROM, ONBUILD, HEALTHCHECK ç­‰ï¼‰ã€‚ ç¤ºä¾‹ 1234567891011121314151617# åŸºç¡€é•œåƒä¸­ä½¿ç”¨ ONBUILD# æ–‡ä»¶ï¼šDockerfile.baseFROM node:18WORKDIR /appONBUILD COPY . /appONBUILD RUN npm install# æ„å»ºåŸºç¡€é•œåƒdocker build -t my-node-base -f Dockerfile.base .# ä½¿ç”¨åŸºç¡€é•œåƒæ„å»ºå­é•œåƒ# æ–‡ä»¶ï¼šDockerfileï¼ˆå­é•œåƒï¼‰FROM my-node-baseCMD [&quot;node&quot;, &quot;index.js&quot;]# æ„å»ºå­é•œåƒæ—¶ï¼Œç­‰äºè‡ªåŠ¨æ’å…¥äº†ï¼šCOPY . /appRUN npm install ONBUILD æ˜¯ä¸€ç§â€œæ„å»ºé’©å­â€æœºåˆ¶ ONBUILD å¯ä»¥ç†è§£æˆâ€œé’©å­â€æˆ–â€œè§¦å‘å™¨â€ï¼š åœ¨åŸºç¡€é•œåƒæ„å»ºæ—¶ä¸æ‰§è¡Œ ä½†å½“æŸäººä»¥è¿™ä¸ªåŸºç¡€é•œåƒä¸ºèµ·ç‚¹å†™è‡ªå·±çš„ Dockerfileï¼Œå¹¶æ„å»ºæ—¶ï¼Œè¿™äº› ONBUILD é‡Œçš„æŒ‡ä»¤è‡ªåŠ¨æ’å…¥æ‰§è¡Œ è¿™æ ·ï¼š åŸºç¡€é•œåƒåªè´Ÿè´£å®šä¹‰ç¯å¢ƒï¼ˆnodeã€npmç‰ˆæœ¬ã€ç³»ç»Ÿä¾èµ–ç­‰ï¼‰ï¼Œä¿æŒè½»é‡ ä¸‹æ¸¸é¡¹ç›®å¯ä»¥ä¸ç”¨å†™é‡å¤çš„ä»£ç å¤åˆ¶å’Œå®‰è£…æŒ‡ä»¤ï¼Œè‡ªåŠ¨ç»§æ‰¿åŸºç¡€é•œåƒé¢„å®šä¹‰çš„æ„å»ºæ­¥éª¤ ä»£ç å¤åˆ¶å’Œä¾èµ–å®‰è£…åœ¨ä¸‹æ¸¸é•œåƒæ„å»ºæ—¶æ‰§è¡Œï¼Œä½¿ç”¨è‡ªå·±çš„ä¸Šä¸‹æ–‡ï¼ˆä¹Ÿå°±æ˜¯é¡¹ç›®ä»£ç ï¼‰ ONBUILD æ€»ç»“ ç‰¹æ€§ è¯´æ˜ â± å»¶è¿Ÿæ‰§è¡Œ æ„å»ºåŸºç¡€é•œåƒæ—¶ä¸ä¼šæ‰§è¡Œï¼Œåœ¨å­é•œåƒæ„å»ºæ—¶è§¦å‘ âœ… æ”¯æŒæŒ‡ä»¤ ä¾‹å¦‚ RUN, COPY, ADD, CMD, WORKDIR, ENV ç­‰ âŒ ä¸æ”¯æŒ FROM, ONBUILD, HEALTHCHECK, SHELL, STOPSIGNAL ğŸ‘ ä¸æ¨èæ»¥ç”¨ ä¼šéšè—æ„å»ºè¡Œä¸ºï¼Œé™ä½å¯ç»´æŠ¤æ€§ âœ… æ¨èåœºæ™¯ å›¢é˜Ÿå…±äº«æ¨¡æ¿ã€æ„å»ºâ€œæ ‡å‡†å¼€å‘é•œåƒâ€ Dockerfile å“ªäº› æŒ‡ä»¤ ä¼šåˆ›å»ºæ–°çš„å±‚ å½“ Dockerfile ä¸­åˆ›å»ºæ–°å±‚çš„æŒ‡ä»¤å†…å®¹å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä½¿ç”¨ --no-cache é€‰é¡¹å¯ä»¥ç¡®ä¿è¿™äº›å˜æ›´è¢«æ­£ç¡®åº”ç”¨ã€‚ æŒ‡ä»¤ æè¿° ADD ä» å¤åˆ¶æ–‡ä»¶å¹¶è‡ªåŠ¨è§£å‹ï¼ˆå¦‚æœæ˜¯ä¸€ä¸ª tar æ–‡ä»¶ï¼‰åˆ°å®¹å™¨çš„ è·¯å¾„ã€‚ COPY ä» å¤åˆ¶æ–‡ä»¶åˆ°å®¹å™¨çš„ è·¯å¾„ï¼Œä¸ä¼šè‡ªåŠ¨è§£å‹ã€‚ RUN æ‰§è¡Œä»»æ„å‘½ä»¤å¹¶åœ¨å®¹å™¨ä¸­åšå‡ºæ›´æ”¹ã€‚æ¯æ¡ RUN æŒ‡ä»¤éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å±‚ã€‚ ENV è®¾ç½®ç¯å¢ƒå˜é‡ã€‚æ¯ä¸€è¡Œ ENV æŒ‡ä»¤éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å±‚ã€‚ WORKDIR è®¾ç½®å·¥ä½œç›®å½•ã€‚æ¯ä¸€è¡Œ WORKDIR æŒ‡ä»¤éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å±‚ã€‚ VOLUME åˆ›å»ºä¸€ä¸ªæŒ‚è½½ç‚¹ã€‚æ¯ä¸€è¡Œ VOLUME æŒ‡ä»¤éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å±‚ã€‚ LABEL æ·»åŠ å…ƒæ•°æ®æ ‡ç­¾ã€‚æ¯ä¸€è¡Œ LABEL æŒ‡ä»¤éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å±‚ã€‚ Dockerfile ç¤ºä¾‹: Spring Boot åº”ç”¨ ç›®å½•ç»“æ„ 1234567springbootweb/â”œâ”€â”€ Dockerfileâ”œâ”€â”€ target/â”‚ â””â”€â”€ app.jarâ”œâ”€â”€ static-assets.tar.gzâ””â”€â”€ ... Dockerfile: æ³¨æ„ Dockerfile ä¸­æ‰€æœ‰å…³é”®å­—éƒ½è¦æ±‚å¤§å†™ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748# ä½¿ç”¨è½»é‡çº§ Alpine ç‰ˆæœ¬çš„ OpenJDK 17 å®˜æ–¹é•œåƒï¼Œé€‚åˆéƒ¨ç½² Spring Boot åº”ç”¨FROM openjdk:17-alpine# è®¾ç½®æ„å»ºæ—¶å˜é‡ï¼Œé»˜è®¤ä½¿ç”¨æ„å»ºå¥½çš„ jar æ–‡ä»¶ARG JAR_FILE=target/app.jar# è®¾ç½®è¿è¡Œæ—¶ç¯å¢ƒå˜é‡ENV JAVA_OPTS=&quot;-Xms1024M -Xmx1024M -XX:MetaspaceSize=128M -XX:MaxMetaspaceSize=128M&quot;ENV TZ=Asia/Shanghai# é•œåƒå…ƒä¿¡æ¯LABEL maintainer=&quot;yourname@example.com&quot;LABEL version=&quot;1.0.0&quot;LABEL description=&quot;ç”¨äºéƒ¨ç½² Spring Boot åº”ç”¨çš„ç”Ÿäº§çº§é•œåƒ&quot;# è®¾ç½®å·¥ä½œç›®å½•WORKDIR /app# ç¤ºä¾‹ RUNï¼šå®‰è£… curlï¼ˆç”¨äºå®¹å™¨å¥åº·æ£€æŸ¥æˆ–è°ƒè¯•ï¼‰RUN apk add --no-cache curl# å¤åˆ¶ Spring Boot æ„å»ºç”Ÿæˆçš„ jar åŒ…COPY $&#123;JAR_FILE&#125; app.jar# è§£å‹é™æ€èµ„æºåˆ°å®¹å™¨ä¸­ï¼ˆADD å¯ä»¥è‡ªåŠ¨è§£å‹ tar.gzï¼‰ADD static-assets.tar.gz /app/public/# å£°æ˜æš´éœ²çš„åº”ç”¨ç«¯å£ï¼ˆSpring Boot é»˜è®¤æ˜¯ 8080ï¼‰EXPOSE 8080# å®¹å™¨å¥åº·æ£€æŸ¥ï¼šè®¿é—® actuator å¥åº·ç«¯ç‚¹HEALTHCHECK --interval=30s --timeout=5s --retries=3 \\ CMD curl -f http://localhost:8080/app/actuator/health || exit 1# å®¹å™¨ç»ˆæ­¢æ—¶ä¼˜é›…å…³é—­ï¼ˆJava æ¨è SIGTERMï¼‰STOPSIGNAL SIGTERM# è®¾ç½®å®¹å™¨å¯åŠ¨æ—¶çš„ä¸»å‘½ä»¤ï¼ˆENTRYPOINT ä¸ä¼šè¢« docker run å‚æ•°è¦†ç›–ï¼‰ENTRYPOINT [&quot;sh&quot;, &quot;-c&quot;, &quot;java $JAVA_OPTS -jar app.jar&quot;]# CMD æä¾›é»˜è®¤çš„è¿è¡Œå‚æ•°ï¼Œå¯ä»¥è¢« docker run è¦†ç›–# è¿™é‡Œé€šè¿‡ Spring Boot å‚æ•°è®¾ç½®å¯åŠ¨ç¯å¢ƒå’Œç«¯å£å·CMD [&quot;--spring.profiles.active=app&quot;, &quot;--server.port=8080&quot;]# è¿™é‡Œä½¿ç”¨çš„æ˜¯ ENTRYPOINT + CMD çš„æ··åˆæ¨¡å¼# å®Œæ•´å‘½ä»¤ï¼š java $JAVA_OPTS -jar app.jar --spring.profiles.active=app --server.port=8080# å£°æ˜ä¸€ä¸ªå·æŒ‚è½½ç‚¹ï¼Œè¿è¡Œå®¹å™¨æ—¶å¯å°†è¯¥è·¯å¾„æ˜ å°„åˆ°å®¿ä¸»æœºï¼Œå®ç°æ•°æ®æŒä¹…åŒ–VOLUME [&quot;/app/logs&quot;] æ„å»ºé•œåƒ 12# æ„å»ºé•œåƒæ—¶ç”¨ --build-arg æŒ‡å®šæ„å»ºå‚æ•°ï¼Œå¦‚æœéœ€è¦å¤šä¸ªï¼Œå°±é…ç½®å¤šä¸ª --build-argdocker build --build-arg JAR_FILE=target/app.jar -t springbootweb:latest . è¿è¡Œå®¹å™¨ 12345docker run -d --name springbootweb \\ -p 8080:8080 \\ -e JAVA_OPTS=&quot;-Xms512m -Xmx1024m&quot; \\ -v /home/centos/logs/app/:/app/logs \\ springbootweb:latest Dockerfile ç¤ºä¾‹: å¤šé˜¶æ®µæ„å»º 12345678910111213141516171819202122232425262728293031323334# ç¬¬ä¸€é˜¶æ®µï¼šè·å–ä»£ç FROM alpine/git AS fetcherWORKDIR /workspace/application# å°†æ›¿æ¢ä¸ºå®é™…çš„Gitä»“åº“URLå’Œåˆ†æ”¯/æ ‡ç­¾ARG GIT_REPOSITORY=https://gitee.com/hanqunfeng/springbootweb.gitARG GIT_BRANCH=masterRUN git clone -b $&#123;GIT_BRANCH&#125; $&#123;GIT_REPOSITORY&#125; .# ç¬¬äºŒé˜¶æ®µï¼šä½¿ç”¨Mavenç¯å¢ƒè¿›è¡Œæ„å»ºFROM maven:3.8.4-openjdk-17 AS builderWORKDIR /workspace/application# ä»ç¬¬ä¸€é˜¶æ®µå¤åˆ¶ä»£ç COPY --from=fetcher /workspace/application .# ä½¿ç”¨Mavenæ¸…ç†å¹¶æ‰“åŒ…RUN mvn clean package -DskipTests# ç¬¬ä¸‰é˜¶æ®µï¼šåˆ›å»ºæœ€ç»ˆçš„è¿è¡Œç¯å¢ƒFROM openjdk:17-alpineWORKDIR /app# è®¾ç½®è¿è¡Œæ—¶ç¯å¢ƒå˜é‡ENV JAVA_OPTS=&quot;-Xms1024M -Xmx1024M -XX:MetaspaceSize=128M -XX:MaxMetaspaceSize=128M&quot;# å°†ç¬¬äºŒé˜¶æ®µç”Ÿæˆçš„ç›®æ ‡æ–‡ä»¶å¤åˆ¶åˆ°è¿™é‡Œã€‚æ³¨æ„è¿™é‡Œå‡è®¾ä½ çš„spring bootå·¥ç¨‹æ‰“æˆçš„jaråæ˜¯target/app.jarCOPY --from=builder /workspace/application/target/app.jar app.jar# æš´éœ²ç«¯å£ï¼ˆå¦‚æœéœ€è¦çš„è¯ï¼‰ã€‚è¯·æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹ç«¯å£å·EXPOSE 8080# å£°æ˜ä¸€ä¸ªå·æŒ‚è½½ç‚¹ï¼Œè¿è¡Œå®¹å™¨æ—¶å¯å°†è¯¥è·¯å¾„æ˜ å°„åˆ°å®¿ä¸»æœºï¼Œå®ç°æ•°æ®æŒä¹…åŒ–VOLUME [&quot;/app/logs&quot;]# è®¾ç½®å®¹å™¨å¯åŠ¨æ—¶çš„ä¸»å‘½ä»¤ï¼ˆENTRYPOINT ä¸ä¼šè¢« docker run å‚æ•°è¦†ç›–ï¼‰ENTRYPOINT [&quot;sh&quot;, &quot;-c&quot;, &quot;java $JAVA_OPTS -jar app.jar&quot;]# CMD æä¾›é»˜è®¤çš„è¿è¡Œå‚æ•°ï¼Œå¯ä»¥è¢« docker run è¦†ç›–# è¿™é‡Œé€šè¿‡ Spring Boot å‚æ•°è®¾ç½®å¯åŠ¨ç¯å¢ƒå’Œç«¯å£å·CMD [&quot;--spring.profiles.active=app&quot;, &quot;--server.port=8080&quot;]# è¿™é‡Œä½¿ç”¨çš„æ˜¯ ENTRYPOINT + CMD çš„æ··åˆæ¨¡å¼# å®Œæ•´å‘½ä»¤ï¼š java $JAVA_OPTS -jar app.jar --spring.profiles.active=app --server.port=8080 æ„å»ºé•œåƒ 12# æ„å»ºé•œåƒï¼Œ--no-cache è¡¨ç¤ºä¸ä½¿ç”¨ç¼“å­˜ï¼Œæ¯æ¬¡æ„å»ºéƒ½ä¼šé‡æ–°æ„å»ºdocker build --no-cache -t app:latest . è¿è¡Œå®¹å™¨ 12345docker run -d --name app \\ -p 8080:8080 \\ -e JAVA_OPTS=&quot;-Xms512m -Xmx1024m&quot; \\ -v /home/centos/logs/app/:/app/logs \\ app:latest Dockerfile è¯­æ³•æ£€æµ‹ åœ¨çº¿æ£€æŸ¥ï¼šDockerfile Linter æœ¬åœ°æ£€æŸ¥ï¼šHaskell Dockerfile Linterï¼Œå¯ä»¥å®‰è£…å‘½ä»¤ï¼Œä¹Ÿå¯ä»¥é€šè¿‡dockerè¿è¡Œ 123456789# å®‰è£…å‘½ä»¤wget -O /usr/local/bin/hadolint https://github.com/hadolint/hadolint/releases/latest/download/hadolint-Linux-x86_64chmod +x /usr/local/bin/hadolinthadolint --version# æ£€æŸ¥hadolint Dockerfile# docker è¿è¡Œdocker run --rm -i hadolint/hadolint &lt; Dockerfile","summary":"æ‘˜è¦ æœ¬æ–‡ä»‹ç» Docker å‘½ä»¤ ä¸­ Dockerfile çš„ä½¿ç”¨æ–¹æ³• Dockerå®˜æ–¹æ–‡æ¡£ Dockerfileå®˜æ–¹æ–‡æ¡£","date_published":"2025-05-26T13:30:05.000Z","tags":["æŠ€æœ¯","docker","docker"]},{"id":"https://blog.hanqunfeng.com/2025/05/22/docker-command-image/","url":"https://blog.hanqunfeng.com/2025/05/22/docker-command-image/","title":"Docker å‘½ä»¤ ä¹‹ é•œåƒ(Image)","content_html":"<!--\n **åŠ ç²—**\n *æ–œä½“*\n ***åŠ ç²—å¹¶æ–œä½“***\n ~~åˆ é™¤çº¿~~\n ==çªå‡ºæ˜¾ç¤º==\n `çªå‡ºæ˜¾ç¤º(æ¨è)`\n ++ä¸‹åˆ’çº¿++\n ~ä¸‹æ ‡~\n ^ä¸Šæ ‡^\n è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference.\n å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)\n\n +++ **ç‚¹å‡»æŠ˜å **\n è¿™æ˜¯è¢«éšè—çš„å†…å®¹\n +++\n\n::: tips success warning danger\nè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹\n:::\n\n% note info % success warning danger\nè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹\n% endnote %\n\nå¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{}\n å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ\n -->\n<h2 id=\"æ‘˜è¦\">æ‘˜è¦</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æœ¬æ–‡ä»‹ç» Docker å‘½ä»¤ ä¸­ é•œåƒç®¡ç† ç›¸å…³å‘½ä»¤</p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://docs.docker.com\">Dockerå®˜æ–¹æ–‡æ¡£</a></p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://docs.docker.com/reference/#application-programming-interfaces-apis\">Application programming interfaces (APIs)</a></p>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"docker-search-æœç´¢é•œåƒ\"><code>docker search</code> : æœç´¢é•œåƒ</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æ¨èåœ¨<a href=\"https://hub.docker.com/\">dockerhub</a>ä¸Šæœç´¢é•œåƒï¼Œä»¥è·å–æ›´è¯¦ç»†çš„é•œåƒä¿¡æ¯ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>å›½å†…ä¹Ÿå¯ä»¥é€šè¿‡<a href=\"https://1ms.run/\">æ¯«ç§’é•œåƒ</a>,<a href=\"https://dockers.xuanyuan.me\">è½©è¾• Docker é•œåƒæœç´¢</a>æ¥æœç´¢é•œåƒã€‚</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ docker search --<span class=\"built_in\">help</span></span><br><span class=\"line\">ç”¨æ³•:  docker search [OPTIONS] TERM</span><br><span class=\"line\"></span><br><span class=\"line\">åœ¨ Docker Hub ä¸­æœç´¢é•œåƒ</span><br><span class=\"line\"></span><br><span class=\"line\">é€‰é¡¹:</span><br><span class=\"line\">  -f, --filter filter   æ ¹æ®æä¾›çš„æ¡ä»¶è¿‡æ»¤è¾“å‡ºï¼Œå¸¸è§çš„è¿‡æ»¤æ¡ä»¶åŒ…æ‹¬ï¼šstarsï¼ˆæ˜Ÿçº§ï¼‰ã€is-officialï¼ˆæ˜¯å¦ä¸ºå®˜æ–¹é•œåƒï¼‰</span><br><span class=\"line\">      --format string   ä½¿ç”¨ Go æ¨¡æ¿ç¾åŒ–è¾“å‡ºï¼Œä¸å¤ªå¸¸ç”¨</span><br><span class=\"line\">      --<span class=\"built_in\">limit</span> int       æœç´¢ç»“æœçš„æœ€å¤§æ•°é‡</span><br><span class=\"line\">      --no-trunc        ä¸æˆªæ–­è¾“å‡ºå†…å®¹ï¼Œæ˜¾ç¤ºå®Œæ•´ä¿¡æ¯ï¼ˆé»˜è®¤è¾“å‡ºä¸­æŸäº›å­—æ®µå¦‚æè¿°å¯èƒ½è¢«æˆªæ–­ï¼‰</span><br></pre></td></tr></table></figure>\n<h3 id=\"ç¤ºä¾‹\">ç¤ºä¾‹</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># æœç´¢åç§°ä¸­åŒ…å« nginx çš„é•œåƒ</span></span><br><span class=\"line\">$ docker search nginx</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æœç´¢åç§°ä¸­åŒ…å« nginx ä¸”æ˜Ÿçº§ä¸å°‘äº 100 çš„é•œåƒã€‚</span></span><br><span class=\"line\">$ docker search -f stars=100 nginx</span><br><span class=\"line\"><span class=\"comment\"># æœç´¢å®˜æ–¹é•œåƒ</span></span><br><span class=\"line\">$ docker search -f is-official=<span class=\"literal\">true</span> nginx</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æœç´¢ nginxï¼ŒæŒ‰ç…§æŒ‡å®šæ¨¡æ¿æ ¼å¼åŒ–è¾“å‡º</span></span><br><span class=\"line\">$ docker search nginx --format <span class=\"string\">&quot;&#123;&#123;.Name&#125;&#125;: &#123;&#123;.StarCount&#125;&#125; stars:  &#123;&#123;.Description&#125;&#125;&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æœç´¢nginxé•œåƒï¼Œå¹¶é™åˆ¶5ä¸ªç»“æœ</span></span><br><span class=\"line\">$ docker search nginx --<span class=\"built_in\">limit</span> 5</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ç»„åˆä½¿ç”¨å¤šä¸ªé€‰é¡¹</span></span><br><span class=\"line\">$ docker search -f stars=100 --<span class=\"built_in\">limit</span> 5 --no-trunc nginx</span><br></pre></td></tr></table></figure>\n<div class=\"tips\">\n<p><em><strong><code>docker search</code> å‘½ä»¤æŠ¥é”™çš„è§£å†³æ–¹æ³•</strong></em></p>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">ç›®å‰å›½å†…ä½¿ç”¨<code>docker search</code>æ—¶ä¼šå‡ºç°<code>Error response from daemon: Get &quot;https://index.docker.io/v1/search?q=nginx&amp;n=25&quot;: dial tcp 210.56.51.193:443: i/o timeout</code>çš„é”™è¯¯ï¼Œå³ä¾¿æˆ‘ä»¬é…ç½®äº†å›½å†…çš„é•œåƒæºï¼Œè¿™ä¸ªé”™è¯¯è¿˜æ˜¯ä¼šå­˜åœ¨ã€‚</li>\n<li class=\"lvl-2\">å³ä¾¿ä¸ºå®¿ä¸»æœºå’Œdockeréƒ½é…ç½®ä¸ŠDNSä¹Ÿä¾ç„¶ä¼šæŠ¥é”™ã€‚</li>\n<li class=\"lvl-2\">ä¸è¿‡å¯ä»¥é€šè¿‡ç¬¬ä¸‰æ–¹é•œåƒä»“åº“è¿›è¡ŒæŸ¥è¯¢ï¼Œæ¯”å¦‚åœ¨æŸ¥è¯¢çš„é•œåƒåç§°å‰åŠ ä¸Š <code>docker.1ms.run/</code>ï¼Œæ¯”å¦‚æŸ¥è¯¢<code>nginx</code>é•œåƒï¼Œåˆ™è¾“å…¥<code>docker search docker.1ms.run/nginx</code>ï¼Œè¿™é‡Œè¦æ³¨æ„å¹¶ä¸æ˜¯æ‰€æœ‰çš„ç¬¬ä¸‰æ–¹é•œåƒä»“åº“éƒ½æ”¯æŒæŸ¥è¯¢ã€‚</li>\n<li class=\"lvl-2\">å¯ä»¥ç¼–å†™ä¸€ä¸ªè„šæœ¬<code>docker_search</code>ï¼ŒæŸ¥è¯¢é•œåƒå¹¶è¾“å‡ºç»“æœï¼Œå¦‚ä¸‹ï¼š</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cat</span> &lt;&lt; <span class=\"string\">&#x27;EOF&#x27;</span> &gt; docker_search</span><br><span class=\"line\"><span class=\"comment\">#!/bin/bash</span></span><br><span class=\"line\">QUERY=<span class=\"variable\">$&#123;1&#125;</span>     <span class=\"comment\"># æŸ¥è¯¢å…³é”®è¯ï¼Œè¿™é‡Œè¦æ³¨æ„ï¼Œç¬¬ä¸€ä¸ªå‚æ•°å¿…é¡»æ˜¯æŸ¥è¯¢å…³é”®è¯</span></span><br><span class=\"line\"><span class=\"comment\"># è·å–é™¤ç¬¬ä¸€ä¸ªå‚æ•°å¤–çš„æ‰€æœ‰å‚æ•°</span></span><br><span class=\"line\">ARGS=<span class=\"variable\">$&#123;@:2&#125;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;æŸ¥è¯¢é•œåƒï¼šdocker search docker.1ms.run/<span class=\"variable\">$QUERY</span> <span class=\"variable\">$ARGS</span>&quot;</span></span><br><span class=\"line\">docker search docker.1ms.run/<span class=\"variable\">$QUERY</span> <span class=\"variable\">$ARGS</span></span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># è®¾ç½®æ‰§è¡Œæƒé™</span></span><br><span class=\"line\"><span class=\"built_in\">chmod</span> +x docker_search</span><br><span class=\"line\"><span class=\"comment\"># å°†å…¶ç§»åŠ¨åˆ° /usr/local/bin/</span></span><br><span class=\"line\"><span class=\"built_in\">mv</span> docker_search /usr/local/bin/docker_search</span><br><span class=\"line\"><span class=\"comment\"># å¦‚æœ/usr/local/bin/æ²¡æœ‰åœ¨PATHä¸­ï¼Œè¯·æ·»åŠ åˆ°ç¯å¢ƒå˜é‡</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;export PATH=<span class=\"variable\">$PATH</span>:/usr/local/sbin&quot;</span> &gt;&gt; ~/.bashrc</span><br><span class=\"line\"><span class=\"built_in\">source</span> ~/.bashrc</span><br><span class=\"line\"><span class=\"comment\"># æµ‹è¯•</span></span><br><span class=\"line\">docker_search redis -f stars=100 --<span class=\"built_in\">limit</span> 5 --no-trunc</span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡º</span></span><br><span class=\"line\">NAME                DESCRIPTION                                                                                       STARS     OFFICIAL</span><br><span class=\"line\">redis               Redis is the worldâ€™s fastest data platform <span class=\"keyword\">for</span> caching, vector search, and NoSQL databases.      13315     [OK]</span><br><span class=\"line\">redis/redis-stack   redis-stack installs a Redis server with additional database capabilities and the RedisInsight.   149</span><br><span class=\"line\">bitnami/redis       Bitnami container image <span class=\"keyword\">for</span> Redis</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">åŸºäºurlæœç´¢ï¼Œæ”¯æŒåˆ†é¡µï¼Œä½†ä¸èƒ½æ”¯æŒå…¶å®ƒsearchå‚æ•°</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cat</span> &lt;&lt; <span class=\"string\">&#x27;EOF&#x27;</span> &gt; docker_search_by_url</span><br><span class=\"line\"><span class=\"comment\">#!/bin/bash</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># å‚æ•°å¤„ç†</span></span><br><span class=\"line\">QUERY=<span class=\"variable\">$&#123;1:-nginx&#125;</span>     <span class=\"comment\"># é»˜è®¤æŸ¥è¯¢å…³é”®è¯</span></span><br><span class=\"line\">N=<span class=\"variable\">$&#123;2:-25&#125;</span>            <span class=\"comment\"># é»˜è®¤æ¯é¡µæ¡æ•°</span></span><br><span class=\"line\">PAGE=<span class=\"variable\">$&#123;3:-1&#125;</span>          <span class=\"comment\"># é»˜è®¤é¡µç </span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># é•œåƒæºåˆ—è¡¨ï¼šä¾æ¬¡å°è¯•è®¿é—®è¿™äº›åŸŸåï¼Œè¿™é‡Œè¦æ³¨æ„ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„é•œåƒæºéƒ½æ”¯æŒæœç´¢åŠŸèƒ½</span></span><br><span class=\"line\">REGISTRIES=(</span><br><span class=\"line\">  <span class=\"string\">&quot;docker.1ms.run&quot;</span></span><br><span class=\"line\">  <span class=\"string\">&quot;register.librax.org&quot;</span></span><br><span class=\"line\">  <span class=\"comment\"># ä½ å¯ä»¥ç»§ç»­æ·»åŠ å¤‡ç”¨åŸŸå</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># åˆå§‹åŒ–æˆåŠŸæ ‡å¿—</span></span><br><span class=\"line\">WORKING_URL=<span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># éå†åŸŸåï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªå¯è®¿é—®çš„</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> REG <span class=\"keyword\">in</span> <span class=\"string\">&quot;<span class=\"variable\">$&#123;REGISTRIES[@]&#125;</span>&quot;</span>; <span class=\"keyword\">do</span></span><br><span class=\"line\">  TEST_URL=<span class=\"string\">&quot;https://<span class=\"variable\">$&#123;REG&#125;</span>/v1/search?q=test&amp;n=1&quot;</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> curl -s --connect-timeout 2 <span class=\"string\">&quot;<span class=\"variable\">$TEST_URL</span>&quot;</span> | grep -q <span class=\"string\">&#x27;&quot;results&quot;&#x27;</span>; <span class=\"keyword\">then</span></span><br><span class=\"line\">    WORKING_URL=<span class=\"string\">&quot;https://<span class=\"variable\">$&#123;REG&#125;</span>/v1/search?q=<span class=\"variable\">$&#123;QUERY&#125;</span>&amp;n=<span class=\"variable\">$&#123;N&#125;</span>&amp;page=<span class=\"variable\">$&#123;PAGE&#125;</span>&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">break</span></span><br><span class=\"line\">  <span class=\"keyword\">fi</span></span><br><span class=\"line\"><span class=\"keyword\">done</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># å¦‚æœéƒ½å¤±è´¥ï¼Œé€€å‡º</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> [ -z <span class=\"string\">&quot;<span class=\"variable\">$WORKING_URL</span>&quot;</span> ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">&quot;âŒ æ— æ³•è¿æ¥ä»»ä½•é•œåƒæºï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–å¤‡ç”¨åŸŸåè®¾ç½®ã€‚&quot;</span></span><br><span class=\"line\">  <span class=\"built_in\">exit</span> 1</span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># è¯·æ±‚æ•°æ®å¹¶æ ¼å¼åŒ–è¾“å‡º</span></span><br><span class=\"line\">curl -s <span class=\"string\">&quot;<span class=\"variable\">$WORKING_URL</span>&quot;</span> \\</span><br><span class=\"line\">| jq -r <span class=\"string\">&#x27;[&quot;NAME&quot;,&quot;STARS&quot;,&quot;OFFICIAL&quot;,&quot;DESCRIPTION&quot;],</span></span><br><span class=\"line\"><span class=\"string\">         (.results[] |</span></span><br><span class=\"line\"><span class=\"string\">         [.name,</span></span><br><span class=\"line\"><span class=\"string\">          (.star_count|tostring),</span></span><br><span class=\"line\"><span class=\"string\">          (if .is_official then &quot;[OK]&quot; else &quot;&quot; end),</span></span><br><span class=\"line\"><span class=\"string\">          .description])</span></span><br><span class=\"line\"><span class=\"string\">         | @tsv&#x27;</span> \\</span><br><span class=\"line\">| column -t -s $<span class=\"string\">&#x27;\\t&#x27;</span></span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n</div>\n<h2 id=\"docker-image-é•œåƒç®¡ç†\"><code>docker image</code> : é•œåƒç®¡ç†</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>docker image --help</code></p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>å‘½ä»¤</th>\n<th>è¯´æ˜</th>\n<th>åˆ«å(ç®€å†™)</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>build</td>\n<td>ä» Dockerfile æ„å»ºä¸€ä¸ªé•œåƒ</td>\n<td>docker build</td>\n</tr>\n<tr>\n<td>history</td>\n<td>æ˜¾ç¤ºé•œåƒçš„å†å²è®°å½•</td>\n<td>docker history</td>\n</tr>\n<tr>\n<td>import</td>\n<td>ä» tar åŒ…å¯¼å…¥å†…å®¹ä»¥åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿé•œåƒ</td>\n<td>docker import</td>\n</tr>\n<tr>\n<td>inspect</td>\n<td>æ˜¾ç¤ºä¸€ä¸ªæˆ–å¤šä¸ªé•œåƒçš„è¯¦ç»†ä¿¡æ¯</td>\n<td>å¯ä»¥ä½¿ç”¨ <code>docker inspect</code></td>\n</tr>\n<tr>\n<td>load</td>\n<td>ä» tar å½’æ¡£æˆ–æ ‡å‡†è¾“å…¥ä¸­åŠ è½½é•œåƒ</td>\n<td>docker load</td>\n</tr>\n<tr>\n<td>ls</td>\n<td>åˆ—å‡ºé•œåƒ</td>\n<td>docker images</td>\n</tr>\n<tr>\n<td>prune</td>\n<td>ç§»é™¤æœªä½¿ç”¨çš„é•œåƒ</td>\n<td></td>\n</tr>\n<tr>\n<td>pull</td>\n<td>ä»é•œåƒä»“åº“ä¸‹è½½é•œåƒ</td>\n<td>docker pull</td>\n</tr>\n<tr>\n<td>push</td>\n<td>ä¸Šä¼ é•œåƒåˆ°é•œåƒä»“åº“</td>\n<td>docker push</td>\n</tr>\n<tr>\n<td>rm</td>\n<td>ç§»é™¤ä¸€ä¸ªæˆ–å¤šä¸ªé•œåƒ</td>\n<td>docker rmi</td>\n</tr>\n<tr>\n<td>save</td>\n<td>å°†ä¸€ä¸ªæˆ–å¤šä¸ªé•œåƒä¿å­˜ä¸º tar å½’æ¡£ï¼ˆé»˜è®¤è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºï¼‰</td>\n<td>docker save</td>\n</tr>\n<tr>\n<td>tag</td>\n<td>åˆ›å»ºä¸€ä¸ªæ ‡ç­¾ TARGET_IMAGE æŒ‡å‘ SOURCE_IMAGE</td>\n<td>docker tag</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>è¿è¡Œ <code>docker image COMMAND --help</code> å¯è·å–æŸä¸ªå‘½ä»¤çš„æ›´å¤šä¿¡æ¯ã€‚</p>\n</li>\n</ul>\n<h3 id=\"docker-pull-æ‹‰å–é•œåƒ\"><code>docker pull</code> : æ‹‰å–é•œåƒ</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>docker image pull</code> == <code>docker pull</code></p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># å‘½ä»¤æ ¼å¼ï¼Œä¸åŠ tagé»˜è®¤æ‹‰å– :latest</span></span><br><span class=\"line\">$ docker pull &lt;image_name&gt;[:&lt;tag&gt;]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æ‹‰å–nginxé•œåƒï¼Œé»˜è®¤æ‹‰å–æœ€æ–°ç‰ˆæœ¬ï¼šlatestï¼Œnginxæ˜¯å®˜æ–¹é•œåƒï¼Œå®Œæ•´åç§°å®é™…ä¸Šæ˜¯ library/nginx</span></span><br><span class=\"line\">$ docker pull nginx  ==  docker pull library/nginx  ==  docker pull nginx:latest</span><br><span class=\"line\"><span class=\"comment\"># æ‹‰å–æŒ‡å®štagçš„é•œåƒ</span></span><br><span class=\"line\">$ docker pull nginx:1.28.0</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æ‹‰å–éå®˜æ–¹é•œåƒï¼Œç”¨æˆ·ä¸Šä¼ çš„</span></span><br><span class=\"line\">$ docker pull hanqunfeng/alpine-jre8-slim:1.0.0</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æ‹‰å–æŒ‡å®šå¹³å°çš„é•œåƒï¼Œå¦‚æœä¸æŒ‡å®š --platform å‚æ•°ï¼Œé»˜è®¤ä¼šæ‹‰å–ä¸ä½ å½“å‰ Docker å®¢æˆ·ç«¯è¿è¡Œå¹³å°åŒ¹é…çš„é•œåƒï¼Œé€šè¿‡ docker version æŸ¥çœ‹</span></span><br><span class=\"line\">$ docker pull --platform=linux/amd64 nginx:latest</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åœ¨ <a href=\"/2025/05/20/docker-install/\" title=\"Linux å®‰è£… Docker\">Linux å®‰è£… Docker</a> ä¸­ä»‹ç»äº†å¦‚é…ç½®å›½å†…çš„é•œåƒåŠ é€Ÿæºæ¥åŠ å¿«é•œåƒçš„æ‹‰å–ï¼Œä½†æ˜¯å›½å†…é•œåƒæºä¸ç¨³å®šï¼Œéšæ—¶éƒ½æœ‰å¯èƒ½ä¸å¯ç”¨ï¼Œè€Œä¸”æ¯æ¬¡é‡æ–°é…ç½®é•œåƒæºè¿˜éœ€è¦é‡å¯Dockerï¼Œå¯ä»¥ç¼–å†™ä¸€ä¸ªè„šæœ¬æ¥å®Œæˆ<code>pull</code>ï¼Œè¿™æ ·æ¯æ¬¡æ›´æ–°é•œåƒæºæ—¶åªéœ€è¦ä¿®æ”¹è„šæœ¬ï¼Œè€Œä¸éœ€è¦é‡å¯Dockeräº†ã€‚</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># è„šæœ¬åç§°ï¼šdocker_pull</span></span><br><span class=\"line\"><span class=\"comment\">#!/bin/bash</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ç”¨æ³•æ£€æŸ¥</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> [[ -z <span class=\"string\">&quot;<span class=\"variable\">$1</span>&quot;</span> ]]; <span class=\"keyword\">then</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">&quot;ç”¨æ³•: <span class=\"variable\">$0</span> &lt;é•œåƒå&gt;ï¼Œä¾‹å¦‚ï¼šdocker_pull redis, docker_pull nginx --platform=linux/arm64&quot;</span></span><br><span class=\"line\">  <span class=\"built_in\">exit</span> 1</span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># åŸå§‹é•œåƒåç§°ï¼Œä¾‹å¦‚ nginx æˆ– someuser/imageï¼Œè¦æ±‚ç¬¬ä¸€ä¸ªå‚æ•°å¿…é¡»æ˜¯é•œåƒåç§°</span></span><br><span class=\"line\">ORIGINAL_IMAGE_NAME=<span class=\"string\">&quot;<span class=\"variable\">$1</span>&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># è·å–é™¤ç¬¬ä¸€ä¸ªå‚æ•°å¤–çš„æ‰€æœ‰å‚æ•°</span></span><br><span class=\"line\">ARGS=<span class=\"variable\">$&#123;@:2&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># é•œåƒæºåˆ—è¡¨ï¼Œä¿®æ”¹é•œåƒæºæ—¶åªéœ€è¦ä¿®æ”¹è¯¥åˆ—è¡¨å³å¯</span></span><br><span class=\"line\">MIRROR_LIST=(</span><br><span class=\"line\">  <span class=\"string\">&quot;docker.1ms.run&quot;</span></span><br><span class=\"line\">  <span class=\"string\">&quot;docker.xuanyuan.me&quot;</span></span><br><span class=\"line\">  <span class=\"string\">&quot;docker.m.daocloud.io&quot;</span></span><br><span class=\"line\">  <span class=\"string\">&quot;docker.1panel.live&quot;</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># å¦‚æœé•œåƒåä¸­ä¸åŒ…å« &quot;/&quot;ï¼ŒåŠ ä¸Š &quot;library/&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> [[ <span class=\"string\">&quot;<span class=\"variable\">$ORIGINAL_IMAGE_NAME</span>&quot;</span> != *<span class=\"string\">&quot;/&quot;</span>* ]]; <span class=\"keyword\">then</span></span><br><span class=\"line\">  IMAGE_NAME=<span class=\"string\">&quot;library/<span class=\"variable\">$ORIGINAL_IMAGE_NAME</span>&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">else</span></span><br><span class=\"line\">  IMAGE_NAME=<span class=\"string\">&quot;<span class=\"variable\">$ORIGINAL_IMAGE_NAME</span>&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># éå†é•œåƒæº</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> MIRROR <span class=\"keyword\">in</span> <span class=\"string\">&quot;<span class=\"variable\">$&#123;MIRROR_LIST[@]&#125;</span>&quot;</span>; <span class=\"keyword\">do</span></span><br><span class=\"line\">  FULL_IMAGE=<span class=\"string\">&quot;<span class=\"variable\">$MIRROR</span>/<span class=\"variable\">$IMAGE_NAME</span>&quot;</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">&quot;å°è¯•ä» <span class=\"variable\">$FULL_IMAGE</span> <span class=\"variable\">$ARGS</span> æ‹‰å–é•œåƒ...&quot;</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">&quot;docker pull <span class=\"variable\">$&#123;FULL_IMAGE&#125;</span> <span class=\"variable\">$&#123;ARGS&#125;</span>&quot;</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> docker pull <span class=\"variable\">$&#123;FULL_IMAGE&#125;</span> <span class=\"variable\">$&#123;ARGS&#125;</span>; <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;æˆåŠŸæ‹‰å–é•œåƒï¼š<span class=\"variable\">$FULL_IMAGE</span> <span class=\"variable\">$ARGS</span>&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># å°†é•œåƒé‡å‘½åä¸ºå»é™¤é•œåƒæºå‰ç¼€çš„ç‰ˆæœ¬</span></span><br><span class=\"line\">    docker tag <span class=\"string\">&quot;<span class=\"variable\">$FULL_IMAGE</span>&quot;</span> <span class=\"string\">&quot;<span class=\"variable\">$ORIGINAL_IMAGE_NAME</span>&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;é•œåƒé‡å‘½åä¸ºï¼š<span class=\"variable\">$ORIGINAL_IMAGE_NAME</span>&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># å¯é€‰ï¼šåˆ é™¤å¸¦é•œåƒæºå‰ç¼€çš„é•œåƒ</span></span><br><span class=\"line\">    docker rmi <span class=\"string\">&quot;<span class=\"variable\">$FULL_IMAGE</span>&quot;</span> &gt;/dev/null 2&gt;&amp;1</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">exit</span> 0</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;ä» <span class=\"variable\">$MIRROR</span> æ‹‰å–å¤±è´¥ï¼Œå°è¯•ä¸‹ä¸€ä¸ªé•œåƒæº...&quot;</span></span><br><span class=\"line\">  <span class=\"keyword\">fi</span></span><br><span class=\"line\"><span class=\"keyword\">done</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;æ‰€æœ‰é•œåƒæºå°è¯•å¤±è´¥ï¼Œæ— æ³•æ‹‰å–é•œåƒï¼š<span class=\"variable\">$ORIGINAL_IMAGE_NAME</span> <span class=\"variable\">$ARGS</span>&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">exit</span> 1</span><br></pre></td></tr></table></figure>\n<div class=\"tips\">\n<p><em><strong>å¦‚ä½•è·å–é•œåƒtag</strong></em></p>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">docker å‘½ä»¤ä¸­æ²¡æœ‰æä¾›ç›´æ¥è·å–é•œåƒtagçš„å‘½ä»¤ï¼Œå¦‚æœä¸æƒ³åˆ°<code>dockerhub</code>ä¸ŠæŸ¥çœ‹ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼è·å–</li>\n<li class=\"lvl-2\">é€šè¿‡dockerhubçš„apiæ¥å£è·å–(éœ€è¦ç§‘å­¦ä¸Šç½‘)</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># åªæ˜¾ç¤ºtagåç§°ï¼Œå®˜æ–¹é•œåƒæ›¿æ¢ nginxï¼Œéå®˜æ–¹é•œåƒæ›¿æ¢ libryary/nginxï¼Œpage_size=5è¡¨ç¤ºæ¯é¡µ5æ¡æ•°æ®ï¼Œpage=1è¡¨ç¤ºç¬¬ä¸€é¡µï¼ˆé»˜è®¤ä¸º1ï¼‰</span></span><br><span class=\"line\">curl -s <span class=\"string\">&quot;https://registry.hub.docker.com/v2/repositories/library/nginx/tags?page_size=5&amp;page=1&quot;</span> | jq <span class=\"string\">&#x27;.results[].name&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## ä¹Ÿå¯ä»¥ä½¿ç”¨å¦‚ä¸‹urlï¼Œä¸¤è€…æ•ˆæœç›¸åŒ</span></span><br><span class=\"line\"><span class=\"comment\">## https://hub.docker.com/v2/namespaces/&#123;namespace&#125;/repositories/&#123;repository&#125;/tags?page_size=5&amp;page=1</span></span><br><span class=\"line\"><span class=\"comment\">## ç¤ºä¾‹ï¼šhttps://hub.docker.com/v2/namespaces/library/repositories/nginx/tags?page_size=1&amp;page=1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># è¾“å‡ºjsonæ ¼å¼ï¼Œå¹¶æ˜¾ç¤ºæœ€åæ›´æ–°æ—¶é—´å’Œé•œåƒå¤§å°</span></span><br><span class=\"line\">curl -s <span class=\"string\">&quot;https://registry.hub.docker.com/v2/repositories/library/nginx/tags?page_size=5&amp;page=1&quot;</span> | jq <span class=\"string\">&#x27;.results[] | &#123;name,last_updated,full_size&#125;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># è¾“å‡ºè¡¨æ ¼æ ¼å¼ï¼Œå¹¶æ ¼å¼åŒ–è¾“å‡º</span></span><br><span class=\"line\">curl -s <span class=\"string\">&quot;https://registry.hub.docker.com/v2/repositories/library/nginx/tags?page_size=5&amp;page=1&quot;</span> \\</span><br><span class=\"line\">| jq -r <span class=\"string\">&#x27;.results[] |</span></span><br><span class=\"line\"><span class=\"string\">  &quot;\\(.name)\\t\\t\\(.last_updated | sub(&quot;T&quot;; &quot; &quot;) | sub(&quot;\\\\..*&quot;; &quot;&quot;))\\t\\t\\(((.full_size / 1024 / 1024 * 100 | round)/100) | tostring) MB&quot;&#x27;</span> \\</span><br><span class=\"line\">  | awk <span class=\"string\">&#x27;&#123;printf &quot;%-30s %-20s %8.2f MB\\n&quot;, $1, $2&quot; &quot;$3, $4&#125;&#x27;</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">é€šè¿‡<a href=\"https://github.com/containers/skopeo\">skopeo</a>å·¥å…·è·å–</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># è¿™é‡Œä½¿ç”¨å®¹å™¨çš„æ–¹å¼(éœ€è¦ç§‘å­¦ä¸Šç½‘)</span></span><br><span class=\"line\">docker run --<span class=\"built_in\">rm</span> quay.io/skopeo/stable:latest inspect --override-os linux  docker://docker.io/nginx | jq <span class=\"string\">&#x27;.RepoTags[]&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># å°†`docker.io`æ›¿æ¢ä¸ºé•œåƒæº`docker.1ms.run`ï¼Œä¸éœ€è¦ç§‘å­¦ä¸Šç½‘</span></span><br><span class=\"line\">docker run --<span class=\"built_in\">rm</span> quay.io/skopeo/stable:latest inspect --override-os linux  docker://docker.1ms.run/nginx | jq <span class=\"string\">&#x27;.RepoTags[]&#x27;</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">ä¸ºäº†æ–¹ä¾¿ä½¿ç”¨å¯ä»¥ç¼–å†™ä¸€ä¸ªè„šæœ¬</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cat</span> &lt;&lt; <span class=\"string\">EOF &gt; docker_tags</span></span><br><span class=\"line\"><span class=\"string\">#!/bin/bash</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"># ç”¨æ³•æç¤º</span></span><br><span class=\"line\"><span class=\"string\">if [ -z &quot;\\$1&quot; ]; then</span></span><br><span class=\"line\"><span class=\"string\">  echo &quot;ç”¨æ³•: \\$0 &lt;é•œåƒåç§°ï¼Œä¾‹å¦‚ nginx æˆ– library/nginx&gt;&quot;</span></span><br><span class=\"line\"><span class=\"string\">  exit 1</span></span><br><span class=\"line\"><span class=\"string\">fi</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">IMAGE_NAME=\\$1</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"># ä½¿ç”¨ skopeo è·å–é•œåƒä¿¡æ¯å¹¶è§£ææ ‡ç­¾åˆ—è¡¨</span></span><br><span class=\"line\"><span class=\"string\">docker run --rm quay.io/skopeo/stable:latest \\\\</span></span><br><span class=\"line\"><span class=\"string\">  inspect --override-os linux docker://docker.1ms.run/\\$IMAGE_NAME \\\\</span></span><br><span class=\"line\"><span class=\"string\">  | jq &#x27;.RepoTags[]&#x27;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"built_in\">chmod</span> +x docker_tags</span><br><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨</span></span><br><span class=\"line\">docker_tags nginx</span><br></pre></td></tr></table></figure>\n</div>\n<h3 id=\"docker-images-åˆ—å‡ºé•œåƒ\"><code>docker images</code> : åˆ—å‡ºé•œåƒ</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>docker image ls</code> == <code>docker images</code></p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># åˆ—å‡ºæ‰€æœ‰é•œåƒï¼Œä¸åŒ…æ‹¬æ‚¬ç©ºé•œåƒï¼Œï¼ˆdangling images:æ²¡æœ‰ tag çš„é•œåƒ,é€šå¸¸æ˜¯æ„å»ºä¸­é—´äº§ç‰©,ä¾‹å¦‚ï¼š&lt;none&gt;:&lt;none&gt; å½¢å¼ã€‚ï¼‰</span></span><br><span class=\"line\">$ docker images</span><br><span class=\"line\"><span class=\"comment\"># åˆ—å‡ºæ‰€æœ‰é•œåƒï¼ŒåŒ…æ‹¬æ‚¬ç©ºé•œåƒ</span></span><br><span class=\"line\">$ docker images -a</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># åˆ—å‡ºæ‰€æœ‰é•œåƒï¼Œå¹¶æ˜¾ç¤ºé•œåƒçš„æ‘˜è¦ä¿¡æ¯</span></span><br><span class=\"line\">$ docker images --digests</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># åˆ—å‡ºæ‰€æœ‰é•œåƒï¼Œå¹¶è¾“å‡ºä¸ºjsonæ ¼å¼</span></span><br><span class=\"line\">$ docker images --format json</span><br><span class=\"line\"><span class=\"comment\"># åªæ˜¾ç¤ºé•œåƒåç§°å’Œæ ‡ç­¾</span></span><br><span class=\"line\">$ docker images --format <span class=\"string\">&quot;&#123;&#123;.Repository&#125;&#125;:&#123;&#123;.Tag&#125;&#125;&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># åªæ˜¾ç¤ºé•œåƒID</span></span><br><span class=\"line\">$ docker images -q</span><br></pre></td></tr></table></figure>\n<h3 id=\"docker-inspect-æŸ¥çœ‹é•œåƒçš„è¯¦ç»†ä¿¡æ¯\"><code>docker inspect</code> : æŸ¥çœ‹é•œåƒçš„è¯¦ç»†ä¿¡æ¯</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>docker image inspect</code> == <code>docker inspect</code></p>\n</li>\n<li class=\"lvl-2\">\n<p>è¿™é‡Œè¦æ³¨æ„ï¼Œ<code>docker inspect</code>å¦‚æœåŸºäºåç§°æŸ¥æ‰¾ä¼šä¼˜å…ˆæŸ¥æ‰¾å®¹å™¨</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># å‘½ä»¤æ ¼å¼</span></span><br><span class=\"line\">$ docker inspect [OPTIONS] NAME|ID [NAME|ID...]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æ˜¾ç¤ºé•œåƒçš„è¯¦ç»†ä¿¡æ¯ï¼Œé•œåƒåç§°</span></span><br><span class=\"line\">$ docker inspect nginx</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æ˜¾ç¤ºé•œåƒçš„è¯¦ç»†ä¿¡æ¯ï¼Œé•œåƒID</span></span><br><span class=\"line\">$ docker inspect 9f0c0d0a0f0f</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æ˜¾ç¤ºé•œåƒçš„Labelsä¿¡æ¯ï¼Œè·å–jsonä¸­æŒ‡å®šçš„å­—æ®µ</span></span><br><span class=\"line\">$ docker image inspect --format=<span class=\"string\">&#x27;&#123;&#123;json .Config.Labels&#125;&#125;&#x27;</span> nginx</span><br></pre></td></tr></table></figure>\n<h3 id=\"docker-image-prune-åˆ é™¤æœªä½¿ç”¨çš„é•œåƒ\"><code>docker image prune</code> : åˆ é™¤æœªä½¿ç”¨çš„é•œåƒ</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># åˆ é™¤æ‚¬ç©ºé•œåƒï¼Œï¼ˆdangling images:æ²¡æœ‰ tag çš„é•œåƒ,é€šå¸¸æ˜¯æ„å»ºä¸­é—´äº§ç‰©,ä¾‹å¦‚ï¼š&lt;none&gt;:&lt;none&gt; å½¢å¼ã€‚ï¼‰</span></span><br><span class=\"line\">$ docker image prune</span><br><span class=\"line\"><span class=\"comment\"># åˆ é™¤å…¨éƒ¨æœªä½¿ç”¨é•œåƒ(æœªè¢«ä»»ä½•ä¸€ä¸ªå®¹å™¨å¼•ç”¨)ï¼ŒåŒ…æ‹¬æ‚¬ç©ºé•œåƒ</span></span><br><span class=\"line\">$ docker image prune -a</span><br><span class=\"line\"><span class=\"comment\"># ä¸è¿›è¡Œç¡®è®¤æç¤ºï¼Œç›´æ¥æ‰§è¡Œ</span></span><br><span class=\"line\">$ docker image prune -f</span><br></pre></td></tr></table></figure>\n<h3 id=\"docker-rmi-åˆ é™¤é•œåƒ\"><code>docker rmi</code> : åˆ é™¤é•œåƒ</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>docker image rm</code> == <code>docker rmi</code></p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># å‘½ä»¤æ ¼å¼</span></span><br><span class=\"line\">$ docker rmi [OPTIONS] IMAGE [IMAGE...]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># åˆ é™¤é•œåƒï¼Œé•œåƒåç§°</span></span><br><span class=\"line\">$ docker rmi nginx</span><br><span class=\"line\"><span class=\"comment\"># åˆ é™¤å¤šä¸ªé•œåƒï¼Œç©ºæ ¼åˆ†éš”</span></span><br><span class=\"line\">$ docker rmi nginx mysql</span><br><span class=\"line\"><span class=\"comment\"># åˆ é™¤é•œåƒï¼Œé•œåƒID</span></span><br><span class=\"line\">$ docker rmi 9f0c0d0a0f0f</span><br><span class=\"line\"><span class=\"comment\"># å¼ºåˆ¶åˆ é™¤é•œåƒï¼Œå½“é•œåƒè¢«å®¹å™¨å¼•ç”¨æ—¶ï¼Œä¼šæŠ¥é”™ï¼Œéœ€è¦ä½¿ç”¨-få‚æ•°è¿›è¡Œå¼ºåˆ¶åˆ é™¤</span></span><br><span class=\"line\">$ docker rmi -f nginx</span><br><span class=\"line\"><span class=\"comment\"># åˆ é™¤å…¨éƒ¨é•œåƒ</span></span><br><span class=\"line\">$ docker rmi $(docker images -q)</span><br></pre></td></tr></table></figure>\n<h3 id=\"docker-history-æŸ¥çœ‹é•œåƒçš„æ„å»ºå†å²\"><code>docker history</code> : æŸ¥çœ‹é•œåƒçš„æ„å»ºå†å²</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>docker image history</code> == <code>docker history</code></p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># å‘½ä»¤æ ¼å¼</span></span><br><span class=\"line\">$ docker <span class=\"built_in\">history</span> [OPTIONS] IMAGE</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹é•œåƒçš„å†å²è®°å½•ï¼Œé•œåƒåç§°</span></span><br><span class=\"line\">$ docker <span class=\"built_in\">history</span> nginx</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹é•œåƒçš„å†å²è®°å½•ï¼Œé•œåƒID</span></span><br><span class=\"line\">$ docker <span class=\"built_in\">history</span> 9f0c0d0a0f0f</span><br><span class=\"line\"><span class=\"comment\"># æ˜¾ç¤ºå®Œæ•´çš„é•œåƒå†å²è®°å½•ï¼Œé»˜è®¤`CREATED BY`ä¸­çš„ä¿¡æ¯å¤ªé•¿ä¼šè¢«æˆªæ–­</span></span><br><span class=\"line\">$ docker <span class=\"built_in\">history</span> --no-trunc nginx</span><br><span class=\"line\"><span class=\"comment\"># æ˜¾ç¤ºä¸ºjsonæ ¼å¼</span></span><br><span class=\"line\">$ docker <span class=\"built_in\">history</span> --format=json nginx</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>docker history</code> æ˜¾ç¤ºçš„æ˜¯æ„å»ºå†å²ï¼Œä¼šå°†æ¯ä¸€ä¸ª Dockerfile æŒ‡ä»¤éƒ½ç®—ä¸€å±‚ï¼Œè€Œä¸æ˜¯ç‰©ç†é•œåƒå±‚ï¼ˆlayerï¼‰æ•°é‡ï¼Œè‹¥è¦æŸ¥çœ‹é•œåƒçš„ç‰©ç†å±‚æ•°ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ docker image inspect --format <span class=\"string\">&#x27;&#123;&#123; len .RootFS.Layers &#125;&#125;&#x27;</span> nginx</span><br></pre></td></tr></table></figure>\n<h3 id=\"docker-tag-åˆ›å»ºä¸€ä¸ªæ ‡ç­¾\"><code>docker tag</code> : åˆ›å»ºä¸€ä¸ªæ ‡ç­¾</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>docker image tag</code> == <code>docker tag</code></p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># å‘½ä»¤æ ¼å¼</span></span><br><span class=\"line\">$ docker tag SOURCE_IMAGE[:TAG] TARGET_IMAGE[:TAG]</span><br><span class=\"line\"><span class=\"comment\"># åˆ›å»ºä¸€ä¸ªæ ‡ç­¾</span></span><br><span class=\"line\">$ docker tag nginx:latest hanqunfeng/nginx:latest</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹é•œåƒï¼Œå¯ä»¥çœ‹åˆ°ä¸¤ä¸ªé•œåƒçš„ IMAGE ID ä¸€è‡´</span></span><br><span class=\"line\">$ docker images</span><br><span class=\"line\">REPOSITORY         TAG       IMAGE ID       CREATED       SIZE</span><br><span class=\"line\">hanqunfeng/nginx   latest    be69f2940aaf   5 weeks ago   192MB</span><br><span class=\"line\">nginx              latest    be69f2940aaf   5 weeks ago   192MB</span><br><span class=\"line\"><span class=\"comment\"># æ­¤æ—¶è‹¥é€šè¿‡ IMAGE ID åˆ é™¤é•œåƒï¼Œä¼šæŠ¥é”™ï¼Œæç¤ºè¢«å¤šä¸ª REPOSITORY å…³è”ï¼Œéœ€è¦ä½¿ç”¨ -f å‚æ•°è¿›è¡Œå¼ºåˆ¶åˆ é™¤</span></span><br><span class=\"line\">$ docker rmi be69f2940aaf</span><br><span class=\"line\">Error response from daemon: conflict: unable to delete be69f2940aaf (must be forced) - image is referenced <span class=\"keyword\">in</span> multiple repositories</span><br></pre></td></tr></table></figure>\n<h3 id=\"docker-save-å°†é•œåƒä¿å­˜ä¸º-tar-å½’æ¡£\"><code>docker save</code> : å°†é•œåƒä¿å­˜ä¸º tar å½’æ¡£</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>docker image save</code> == <code>docker save</code></p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># å‘½ä»¤æ ¼å¼</span></span><br><span class=\"line\">$ docker save [OPTIONS] IMAGE [IMAGE...]</span><br><span class=\"line\"><span class=\"comment\"># å°†é•œåƒä¿å­˜ä¸º tar å½’æ¡£ï¼Œ-o  æŒ‡å®šè¾“å‡ºæ–‡ä»¶ï¼Œæ–‡ä»¶åç§°ä»»æ„ï¼Œç”šè‡³éƒ½ä¸éœ€è¦ä»¥ .tar ç»“å°¾</span></span><br><span class=\"line\">$ docker save -o nginx.tar nginx</span><br><span class=\"line\"><span class=\"comment\"># æˆ–è€…</span></span><br><span class=\"line\">$ docker save nginx &gt; nginx.tar</span><br></pre></td></tr></table></figure>\n<h3 id=\"docker-load-ä»-tar-å½’æ¡£ä¸­åŠ è½½é•œåƒ\"><code>docker load</code> : ä» tar å½’æ¡£ä¸­åŠ è½½é•œåƒ</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>docker image load</code> == <code>docker load</code></p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># å‘½ä»¤æ ¼å¼</span></span><br><span class=\"line\">$ docker load [OPTIONS]</span><br><span class=\"line\"><span class=\"comment\"># ä» tar å½’æ¡£ä¸­åŠ è½½é•œåƒï¼Œå¯¼å‡ºtarå½’æ¡£æ—¶çš„é•œåƒåç§°å°±æ˜¯åŠ è½½åçš„é•œåƒåç§°</span></span><br><span class=\"line\">$ docker load -i nginx.tar</span><br><span class=\"line\"><span class=\"comment\"># -q å‚æ•°è¡¨ç¤ºä¸æ˜¾ç¤ºè¿›åº¦æ¡</span></span><br><span class=\"line\">$ docker load -q -i nginx.tar</span><br></pre></td></tr></table></figure>\n<h3 id=\"docker-import-ä»æ–‡ä»¶åˆ›å»ºé•œåƒ\"><code>docker import</code> : ä»æ–‡ä»¶åˆ›å»ºé•œåƒ</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>docker image import</code> == <code>docker import</code></p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># å‘½ä»¤æ ¼å¼</span></span><br><span class=\"line\">$ docker import [OPTIONS] FILE|URL|- [REPOSITORY[:TAG]]</span><br><span class=\"line\"><span class=\"comment\">## å‚æ•°è¯´æ˜</span></span><br><span class=\"line\">file\tæœ¬åœ° tar æ–‡ä»¶ï¼Œä¾‹å¦‚ rootfs.tar</span><br><span class=\"line\">URL\t    ç½‘ç»œåœ°å€ï¼ˆhttp/httpsï¼‰</span><br><span class=\"line\">-\t    ä»æ ‡å‡†è¾“å…¥è¯»å–ï¼ˆæ¯”å¦‚é€šè¿‡ç®¡é“ï¼‰</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># è¾“å‡ºé•œåƒåç§°ä¸æ ‡ç­¾</span></span><br><span class=\"line\">REPOSITORY[:TAG]\tå¯¼å…¥åé•œåƒçš„åç§°ä¸æ ‡ç­¾</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># OPTIONS</span></span><br><span class=\"line\">--change\tåœ¨å¯¼å…¥é•œåƒæ—¶è®¾ç½® Dockerfile æŒ‡ä»¤ï¼Œå¦‚ CMDã€ENVã€EXPOSE ç­‰</span><br><span class=\"line\">--message, -m\tæ·»åŠ å¯¼å…¥è¯´æ˜ï¼ˆcommit messageï¼‰</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>docker import</code> ä¸  <code>docker load</code> çš„åŒºåˆ«</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>å‘½ä»¤</th>\n<th>ç”¨é€”</th>\n<th>æ ¼å¼</th>\n<th>æ˜¯å¦ä¿ç•™å†å²</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>docker import</code></td>\n<td>å¯¼å…¥æ–‡ä»¶ç³»ç»Ÿï¼Œåˆ›å»ºé•œåƒ(ç”± <code>docker export</code> ç”Ÿæˆ)</td>\n<td>çº¯æ–‡ä»¶ç³»ç»Ÿ tar åŒ…</td>\n<td>âŒ ä¸ä¿ç•™å†å²ã€æ ‡ç­¾ç­‰å…ƒæ•°æ®</td>\n</tr>\n<tr>\n<td><code>docker load</code></td>\n<td>åŠ è½½é•œåƒï¼ˆé€šå¸¸ç”± <code>docker save</code> ç”Ÿæˆï¼‰</td>\n<td>Docker é•œåƒ tarï¼ˆå«å…ƒæ•°æ®ï¼‰</td>\n<td>âœ… ä¿ç•™ tagã€å±‚ã€å†å²ç­‰</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ç¤ºä¾‹: ä»å®¹å™¨å¯¼å‡ºå†å¯¼å…¥</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># å¯åŠ¨ä¸€ä¸ªå®¹å™¨</span></span><br><span class=\"line\">$ docker run -d -p 8080:80 --name nginx nginx</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># å¯¼å‡ºå®¹å™¨æ–‡ä»¶ç³»ç»Ÿï¼Œæ­¤æ—¶ nginx å®¹å™¨ä¸­çš„æ‰€æœ‰æ–‡ä»¶éƒ½ä¿å­˜åœ¨ my_nginx.tar æ–‡ä»¶ä¸­</span></span><br><span class=\"line\">$ docker <span class=\"built_in\">export</span> -o my_nginx.tar nginx</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># å¯¼å…¥æ–‡ä»¶ç³»ç»Ÿï¼Œå¯¼å…¥æ—¶æŒ‡å®š å¯åŠ¨å‘½ä»¤ï¼Œå› ä¸º my_nginx.tar åªæ˜¯æ–‡ä»¶ï¼Œå¹¶ä¸åŒ…å«ä»»ä½•å¯åŠ¨å‘½ä»¤</span></span><br><span class=\"line\">$ docker import --change=<span class=\"string\">&#x27;CMD [&quot;nginx&quot;, &quot;-g&quot;, &quot;daemon off;&quot;]&#x27;</span> my_nginx.tar nginx:my_tag</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹é•œåƒï¼Œé•œåƒIDä¸ä¸€è‡´</span></span><br><span class=\"line\">$ docker images</span><br><span class=\"line\">REPOSITORY         TAG       IMAGE ID       CREATED         SIZE</span><br><span class=\"line\">nginx              my_tag    4ab42de31bac   4 seconds ago   191MB</span><br><span class=\"line\">nginx              latest    be69f2940aaf   5 weeks ago     192MB</span><br></pre></td></tr></table></figure>\n<h3 id=\"docker-build-ä»æŒ‡å®šç›®å½•æˆ–URLä¸­çš„-Dockerfile-æ„å»º-Docker-é•œåƒ\"><code>docker build</code> : ä»æŒ‡å®šç›®å½•æˆ–URLä¸­çš„ Dockerfile æ„å»º Docker é•œåƒ</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>docker image build</code> == <code>docker build</code></p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># å‘½ä»¤æ ¼å¼</span></span><br><span class=\"line\">docker build [OPTIONS] PATH | URL | -</span><br><span class=\"line\"><span class=\"comment\"># å‚æ•°è¯´æ˜</span></span><br><span class=\"line\">PATH\t  Dockerfile æ‰€åœ¨çš„ç›®å½•</span><br><span class=\"line\">URL\t      Git ä»“åº“çš„ URL</span><br><span class=\"line\">-\t      ä»æ ‡å‡†è¾“å…¥è¯»å– Dockerfile</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æ„å»ºé•œåƒï¼Œ-t: æŒ‡å®šé•œåƒåç§°ï¼Œ.: è¡¨ç¤ºä»å½“å‰ç›®å½•æŸ¥æ‰¾Dockerfileï¼Œé»˜è®¤æ–‡ä»¶åç§°ä¸º Dockerfile</span></span><br><span class=\"line\">docker build -t myimage:latest .</span><br><span class=\"line\"><span class=\"comment\"># æ„å»ºé•œåƒï¼Œ-f: æŒ‡å®š Dockerfile çš„ç›¸å¯¹è·¯å¾„ï¼Œ.: è¡¨ç¤ºåŸºäºå½“å‰ç›®å½•ï¼Œå®é™…çš„ Dockerfile è·¯å¾„å°±æ˜¯ ./path/MyDockerfile</span></span><br><span class=\"line\">docker build -t myimage:latest -f path/MyDockerfile .</span><br><span class=\"line\"><span class=\"comment\"># å®é™…çš„ Dockerfile è·¯å¾„å°±æ˜¯ /usr/local/path/MyDockerfile</span></span><br><span class=\"line\">docker build -t myimage:latest -f path/MyDockerfile /usr/local</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æ„å»ºé•œåƒï¼Œä» Git ä»“åº“ä¸­æ„å»ºï¼Œgit ä»“åº“çš„ Dockerfile å¿…é¡»åœ¨æ ¹ç›®å½•ä¸‹</span></span><br><span class=\"line\">docker build https://github.com/hanqunfeng/docker_test.git -t abc:1.0.0</span><br><span class=\"line\"><span class=\"comment\"># æ„å»ºé•œåƒï¼Œä» Git ä»“åº“ä¸­æ„å»ºï¼ŒæŒ‡å®š Dockerfile çš„ç›¸å¯¹è·¯å¾„</span></span><br><span class=\"line\">docker build -f docker/Dockerfile https://github.com/hanqunfeng/docker_test.git -t abc:1.0.1</span><br><span class=\"line\"><span class=\"comment\"># æ„å»ºé•œåƒï¼Œä» Git ä»“åº“ä¸­æ„å»ºï¼ŒæŒ‡å®šåˆ†æ”¯æˆ– tag</span></span><br><span class=\"line\">docker build -f docker/Dockerfile https://github.com/hanqunfeng/docker_test.git#release -t abc:1.0.2</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æ„å»ºé•œåƒï¼Œ--no-cache è¡¨ç¤ºä¸ä½¿ç”¨ç¼“å­˜ï¼Œæ¯æ¬¡æ„å»ºéƒ½ä¼šé‡æ–°æ„å»ºï¼Œä½†ä¼šéå¸¸æ…¢ï¼Œä¸€èˆ¬æ²¡æœ‰å¯¼è‡´æŸä¸€ä¸ªå±‚å‘ç”Ÿå˜åŒ–æ—¶ä¸éœ€è¦åŠ ä¸Šè¿™ä¸ªå‚æ•°</span></span><br><span class=\"line\">docker build --no-cache -t app:latest .</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>docker build</code>ä¸­è¿˜æœ‰ä¸€äº›é‡è¦çš„å‚æ•°ï¼Œä»¥åŠ<code>Dockerfile</code>æ–‡ä»¶è¯¥æ€ä¹ˆç¼–å†™ï¼Œè¯·å‚è€ƒ<a href=\"/2025/05/26/docker-dockerfile/\" title=\"Docker å‘½ä»¤ ä¹‹ Dockerfile\">Docker å‘½ä»¤ ä¹‹ Dockerfile</a></p>\n</li>\n</ul>\n<h3 id=\"docker-push-æ¨é€æœ¬åœ°é•œåƒåˆ°è¿œç¨‹ä»“åº“\"><code>docker push</code> : æ¨é€æœ¬åœ°é•œåƒåˆ°è¿œç¨‹ä»“åº“</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>docker image push</code> == <code>docker push</code></p>\n</li>\n<li class=\"lvl-2\">\n<p>è¿™é‡Œä»‹ç»å¦‚ä½•å°†é•œåƒæ¨é€åˆ°<code>docker hub</code>è¿œç¨‹ä»“åº“</p>\n</li>\n<li class=\"lvl-2\">\n<p>éœ€è¦å…ˆåœ¨<a href=\"https://hub.docker.com/\">docker hub</a>ç½‘ç«™ä¸Šåˆ›å»ºä¸€ä¸ªè´¦å·ï¼Œæ¯”å¦‚æˆ‘çš„ç”¨æˆ·åæ˜¯<code>hanqunfeng</code></p>\n</li>\n<li class=\"lvl-2\">\n<p>ç„¶åå°±å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤å°†æœ¬åœ°é•œåƒæ¨é€åˆ°è¿œç¨‹ä»“åº“äº†</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹æœ¬åœ°é•œåƒ</span></span><br><span class=\"line\">$ docker images</span><br><span class=\"line\">REPOSITORY         TAG       IMAGE ID       CREATED        SIZE</span><br><span class=\"line\">nginx              latest    e573c6323878   18 hours ago   191MB</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># å¯¹nginxé•œåƒæ‰“tag,å‰ç¼€å¿…é¡»ä¸ç”¨æˆ·åä¸€è‡´</span></span><br><span class=\"line\">$ docker tag nginx hanqunfeng/nginx:1.0.0</span><br><span class=\"line\">$ docker images</span><br><span class=\"line\">REPOSITORY         TAG       IMAGE ID       CREATED        SIZE</span><br><span class=\"line\">hanqunfeng/nginx   1.0.0     be69f2940aaf   5 weeks ago    192MB</span><br><span class=\"line\">nginx              latest    be69f2940aaf   5 weeks ago    192MB</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ç™»å½• docker hup</span></span><br><span class=\"line\">$ docker login -u hanqunfeng</span><br><span class=\"line\"></span><br><span class=\"line\">i Info â†’ A Personal Access Token (PAT) can be used instead.</span><br><span class=\"line\">          To create a PAT, visit https://app.docker.com/settings</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">Password: <span class=\"comment\"># è¾“å…¥å¯†ç </span></span><br><span class=\"line\">Login Succeeded</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ç™»å½•åŒæ—¶è¾“å…¥å¯†ç </span></span><br><span class=\"line\"><span class=\"comment\"># docker login -u hanqunfeng -p 12345678</span></span><br><span class=\"line\"><span class=\"comment\"># ç™»å½•å…¶å®ƒä»“åº“</span></span><br><span class=\"line\"><span class=\"comment\"># docker login -u username -p password registry.orther.com</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æ¨é€åˆ°docker hubï¼Œæ­¤åå°±å¯ä»¥é€šè¿‡ docker pull hanqunfeng/nginx:1.0.0 è·å–äº†</span></span><br><span class=\"line\">$ docker push hanqunfeng/nginx:1.0.0</span><br></pre></td></tr></table></figure>\n<div class=\"tips\">\n<p><em><strong>å°è´´å£«</strong></em></p>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">æœªç™»å½•Docker Hubçš„æƒ…å†µä¸‹ï¼Œè¿è¡Œ<code>docker pull</code>ä¼šæœ‰æ‹‰å–é€Ÿç‡å’Œæ•°é‡ä¸Šçš„é™åˆ¶ï¼Œå…·ä½“å¯ä»¥å‚çœ‹<a href=\"https://docs.docker.com/docker-hub/usage/\">Docker Hubçš„ä½¿ç”¨å’Œé™åˆ¶</a></li>\n</ul>\n</div>\n","content_text":"æ‘˜è¦ æœ¬æ–‡ä»‹ç» Docker å‘½ä»¤ ä¸­ é•œåƒç®¡ç† ç›¸å…³å‘½ä»¤ Dockerå®˜æ–¹æ–‡æ¡£ Application programming interfaces (APIs) docker search : æœç´¢é•œåƒ æ¨èåœ¨dockerhubä¸Šæœç´¢é•œåƒï¼Œä»¥è·å–æ›´è¯¦ç»†çš„é•œåƒä¿¡æ¯ã€‚ å›½å†…ä¹Ÿå¯ä»¥é€šè¿‡æ¯«ç§’é•œåƒ,è½©è¾• Docker é•œåƒæœç´¢æ¥æœç´¢é•œåƒã€‚ 12345678910$ docker search --helpç”¨æ³•: docker search [OPTIONS] TERMåœ¨ Docker Hub ä¸­æœç´¢é•œåƒé€‰é¡¹: -f, --filter filter æ ¹æ®æä¾›çš„æ¡ä»¶è¿‡æ»¤è¾“å‡ºï¼Œå¸¸è§çš„è¿‡æ»¤æ¡ä»¶åŒ…æ‹¬ï¼šstarsï¼ˆæ˜Ÿçº§ï¼‰ã€is-officialï¼ˆæ˜¯å¦ä¸ºå®˜æ–¹é•œåƒï¼‰ --format string ä½¿ç”¨ Go æ¨¡æ¿ç¾åŒ–è¾“å‡ºï¼Œä¸å¤ªå¸¸ç”¨ --limit int æœç´¢ç»“æœçš„æœ€å¤§æ•°é‡ --no-trunc ä¸æˆªæ–­è¾“å‡ºå†…å®¹ï¼Œæ˜¾ç¤ºå®Œæ•´ä¿¡æ¯ï¼ˆé»˜è®¤è¾“å‡ºä¸­æŸäº›å­—æ®µå¦‚æè¿°å¯èƒ½è¢«æˆªæ–­ï¼‰ ç¤ºä¾‹ 12345678910111213141516# æœç´¢åç§°ä¸­åŒ…å« nginx çš„é•œåƒ$ docker search nginx# æœç´¢åç§°ä¸­åŒ…å« nginx ä¸”æ˜Ÿçº§ä¸å°‘äº 100 çš„é•œåƒã€‚$ docker search -f stars=100 nginx# æœç´¢å®˜æ–¹é•œåƒ$ docker search -f is-official=true nginx# æœç´¢ nginxï¼ŒæŒ‰ç…§æŒ‡å®šæ¨¡æ¿æ ¼å¼åŒ–è¾“å‡º$ docker search nginx --format &quot;&#123;&#123;.Name&#125;&#125;: &#123;&#123;.StarCount&#125;&#125; stars: &#123;&#123;.Description&#125;&#125;&quot;# æœç´¢nginxé•œåƒï¼Œå¹¶é™åˆ¶5ä¸ªç»“æœ$ docker search nginx --limit 5# ç»„åˆä½¿ç”¨å¤šä¸ªé€‰é¡¹$ docker search -f stars=100 --limit 5 --no-trunc nginx docker search å‘½ä»¤æŠ¥é”™çš„è§£å†³æ–¹æ³• ç›®å‰å›½å†…ä½¿ç”¨docker searchæ—¶ä¼šå‡ºç°Error response from daemon: Get &quot;https://index.docker.io/v1/search?q=nginx&amp;n=25&quot;: dial tcp 210.56.51.193:443: i/o timeoutçš„é”™è¯¯ï¼Œå³ä¾¿æˆ‘ä»¬é…ç½®äº†å›½å†…çš„é•œåƒæºï¼Œè¿™ä¸ªé”™è¯¯è¿˜æ˜¯ä¼šå­˜åœ¨ã€‚ å³ä¾¿ä¸ºå®¿ä¸»æœºå’Œdockeréƒ½é…ç½®ä¸ŠDNSä¹Ÿä¾ç„¶ä¼šæŠ¥é”™ã€‚ ä¸è¿‡å¯ä»¥é€šè¿‡ç¬¬ä¸‰æ–¹é•œåƒä»“åº“è¿›è¡ŒæŸ¥è¯¢ï¼Œæ¯”å¦‚åœ¨æŸ¥è¯¢çš„é•œåƒåç§°å‰åŠ ä¸Š docker.1ms.run/ï¼Œæ¯”å¦‚æŸ¥è¯¢nginxé•œåƒï¼Œåˆ™è¾“å…¥docker search docker.1ms.run/nginxï¼Œè¿™é‡Œè¦æ³¨æ„å¹¶ä¸æ˜¯æ‰€æœ‰çš„ç¬¬ä¸‰æ–¹é•œåƒä»“åº“éƒ½æ”¯æŒæŸ¥è¯¢ã€‚ å¯ä»¥ç¼–å†™ä¸€ä¸ªè„šæœ¬docker_searchï¼ŒæŸ¥è¯¢é•œåƒå¹¶è¾“å‡ºç»“æœï¼Œå¦‚ä¸‹ï¼š 1234567891011121314151617181920212223cat &lt;&lt; &#x27;EOF&#x27; &gt; docker_search#!/bin/bashQUERY=$&#123;1&#125; # æŸ¥è¯¢å…³é”®è¯ï¼Œè¿™é‡Œè¦æ³¨æ„ï¼Œç¬¬ä¸€ä¸ªå‚æ•°å¿…é¡»æ˜¯æŸ¥è¯¢å…³é”®è¯# è·å–é™¤ç¬¬ä¸€ä¸ªå‚æ•°å¤–çš„æ‰€æœ‰å‚æ•°ARGS=$&#123;@:2&#125;echo &quot;æŸ¥è¯¢é•œåƒï¼šdocker search docker.1ms.run/$QUERY $ARGS&quot;docker search docker.1ms.run/$QUERY $ARGSEOF# è®¾ç½®æ‰§è¡Œæƒé™chmod +x docker_search# å°†å…¶ç§»åŠ¨åˆ° /usr/local/bin/mv docker_search /usr/local/bin/docker_search# å¦‚æœ/usr/local/bin/æ²¡æœ‰åœ¨PATHä¸­ï¼Œè¯·æ·»åŠ åˆ°ç¯å¢ƒå˜é‡echo &quot;export PATH=$PATH:/usr/local/sbin&quot; &gt;&gt; ~/.bashrcsource ~/.bashrc# æµ‹è¯•docker_search redis -f stars=100 --limit 5 --no-trunc## è¾“å‡ºNAME DESCRIPTION STARS OFFICIALredis Redis is the worldâ€™s fastest data platform for caching, vector search, and NoSQL databases. 13315 [OK]redis/redis-stack redis-stack installs a Redis server with additional database capabilities and the RedisInsight. 149bitnami/redis Bitnami container image for Redis åŸºäºurlæœç´¢ï¼Œæ”¯æŒåˆ†é¡µï¼Œä½†ä¸èƒ½æ”¯æŒå…¶å®ƒsearchå‚æ•° 1234567891011121314151617181920212223242526272829303132333435363738394041424344cat &lt;&lt; &#x27;EOF&#x27; &gt; docker_search_by_url#!/bin/bash# å‚æ•°å¤„ç†QUERY=$&#123;1:-nginx&#125; # é»˜è®¤æŸ¥è¯¢å…³é”®è¯N=$&#123;2:-25&#125; # é»˜è®¤æ¯é¡µæ¡æ•°PAGE=$&#123;3:-1&#125; # é»˜è®¤é¡µç # é•œåƒæºåˆ—è¡¨ï¼šä¾æ¬¡å°è¯•è®¿é—®è¿™äº›åŸŸåï¼Œè¿™é‡Œè¦æ³¨æ„ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„é•œåƒæºéƒ½æ”¯æŒæœç´¢åŠŸèƒ½REGISTRIES=( &quot;docker.1ms.run&quot; &quot;register.librax.org&quot; # ä½ å¯ä»¥ç»§ç»­æ·»åŠ å¤‡ç”¨åŸŸå)# åˆå§‹åŒ–æˆåŠŸæ ‡å¿—WORKING_URL=&quot;&quot;# éå†åŸŸåï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªå¯è®¿é—®çš„for REG in &quot;$&#123;REGISTRIES[@]&#125;&quot;; do TEST_URL=&quot;https://$&#123;REG&#125;/v1/search?q=test&amp;n=1&quot; if curl -s --connect-timeout 2 &quot;$TEST_URL&quot; | grep -q &#x27;&quot;results&quot;&#x27;; then WORKING_URL=&quot;https://$&#123;REG&#125;/v1/search?q=$&#123;QUERY&#125;&amp;n=$&#123;N&#125;&amp;page=$&#123;PAGE&#125;&quot; break fidone# å¦‚æœéƒ½å¤±è´¥ï¼Œé€€å‡ºif [ -z &quot;$WORKING_URL&quot; ]; then echo &quot;âŒ æ— æ³•è¿æ¥ä»»ä½•é•œåƒæºï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–å¤‡ç”¨åŸŸåè®¾ç½®ã€‚&quot; exit 1fi# è¯·æ±‚æ•°æ®å¹¶æ ¼å¼åŒ–è¾“å‡ºcurl -s &quot;$WORKING_URL&quot; \\| jq -r &#x27;[&quot;NAME&quot;,&quot;STARS&quot;,&quot;OFFICIAL&quot;,&quot;DESCRIPTION&quot;], (.results[] | [.name, (.star_count|tostring), (if .is_official then &quot;[OK]&quot; else &quot;&quot; end), .description]) | @tsv&#x27; \\| column -t -s $&#x27;\\t&#x27;EOF docker image : é•œåƒç®¡ç† docker image --help å‘½ä»¤ è¯´æ˜ åˆ«å(ç®€å†™) build ä» Dockerfile æ„å»ºä¸€ä¸ªé•œåƒ docker build history æ˜¾ç¤ºé•œåƒçš„å†å²è®°å½• docker history import ä» tar åŒ…å¯¼å…¥å†…å®¹ä»¥åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿé•œåƒ docker import inspect æ˜¾ç¤ºä¸€ä¸ªæˆ–å¤šä¸ªé•œåƒçš„è¯¦ç»†ä¿¡æ¯ å¯ä»¥ä½¿ç”¨ docker inspect load ä» tar å½’æ¡£æˆ–æ ‡å‡†è¾“å…¥ä¸­åŠ è½½é•œåƒ docker load ls åˆ—å‡ºé•œåƒ docker images prune ç§»é™¤æœªä½¿ç”¨çš„é•œåƒ pull ä»é•œåƒä»“åº“ä¸‹è½½é•œåƒ docker pull push ä¸Šä¼ é•œåƒåˆ°é•œåƒä»“åº“ docker push rm ç§»é™¤ä¸€ä¸ªæˆ–å¤šä¸ªé•œåƒ docker rmi save å°†ä¸€ä¸ªæˆ–å¤šä¸ªé•œåƒä¿å­˜ä¸º tar å½’æ¡£ï¼ˆé»˜è®¤è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºï¼‰ docker save tag åˆ›å»ºä¸€ä¸ªæ ‡ç­¾ TARGET_IMAGE æŒ‡å‘ SOURCE_IMAGE docker tag è¿è¡Œ docker image COMMAND --help å¯è·å–æŸä¸ªå‘½ä»¤çš„æ›´å¤šä¿¡æ¯ã€‚ docker pull : æ‹‰å–é•œåƒ docker image pull == docker pull 12345678910111213# å‘½ä»¤æ ¼å¼ï¼Œä¸åŠ tagé»˜è®¤æ‹‰å– :latest$ docker pull &lt;image_name&gt;[:&lt;tag&gt;]# æ‹‰å–nginxé•œåƒï¼Œé»˜è®¤æ‹‰å–æœ€æ–°ç‰ˆæœ¬ï¼šlatestï¼Œnginxæ˜¯å®˜æ–¹é•œåƒï¼Œå®Œæ•´åç§°å®é™…ä¸Šæ˜¯ library/nginx$ docker pull nginx == docker pull library/nginx == docker pull nginx:latest# æ‹‰å–æŒ‡å®štagçš„é•œåƒ$ docker pull nginx:1.28.0# æ‹‰å–éå®˜æ–¹é•œåƒï¼Œç”¨æˆ·ä¸Šä¼ çš„$ docker pull hanqunfeng/alpine-jre8-slim:1.0.0# æ‹‰å–æŒ‡å®šå¹³å°çš„é•œåƒï¼Œå¦‚æœä¸æŒ‡å®š --platform å‚æ•°ï¼Œé»˜è®¤ä¼šæ‹‰å–ä¸ä½ å½“å‰ Docker å®¢æˆ·ç«¯è¿è¡Œå¹³å°åŒ¹é…çš„é•œåƒï¼Œé€šè¿‡ docker version æŸ¥çœ‹$ docker pull --platform=linux/amd64 nginx:latest åœ¨ Linux å®‰è£… Docker ä¸­ä»‹ç»äº†å¦‚é…ç½®å›½å†…çš„é•œåƒåŠ é€Ÿæºæ¥åŠ å¿«é•œåƒçš„æ‹‰å–ï¼Œä½†æ˜¯å›½å†…é•œåƒæºä¸ç¨³å®šï¼Œéšæ—¶éƒ½æœ‰å¯èƒ½ä¸å¯ç”¨ï¼Œè€Œä¸”æ¯æ¬¡é‡æ–°é…ç½®é•œåƒæºè¿˜éœ€è¦é‡å¯Dockerï¼Œå¯ä»¥ç¼–å†™ä¸€ä¸ªè„šæœ¬æ¥å®Œæˆpullï¼Œè¿™æ ·æ¯æ¬¡æ›´æ–°é•œåƒæºæ—¶åªéœ€è¦ä¿®æ”¹è„šæœ¬ï¼Œè€Œä¸éœ€è¦é‡å¯Dockeräº†ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253# è„šæœ¬åç§°ï¼šdocker_pull#!/bin/bash# ç”¨æ³•æ£€æŸ¥if [[ -z &quot;$1&quot; ]]; then echo &quot;ç”¨æ³•: $0 &lt;é•œåƒå&gt;ï¼Œä¾‹å¦‚ï¼šdocker_pull redis, docker_pull nginx --platform=linux/arm64&quot; exit 1fi# åŸå§‹é•œåƒåç§°ï¼Œä¾‹å¦‚ nginx æˆ– someuser/imageï¼Œè¦æ±‚ç¬¬ä¸€ä¸ªå‚æ•°å¿…é¡»æ˜¯é•œåƒåç§°ORIGINAL_IMAGE_NAME=&quot;$1&quot;# è·å–é™¤ç¬¬ä¸€ä¸ªå‚æ•°å¤–çš„æ‰€æœ‰å‚æ•°ARGS=$&#123;@:2&#125;# é•œåƒæºåˆ—è¡¨ï¼Œä¿®æ”¹é•œåƒæºæ—¶åªéœ€è¦ä¿®æ”¹è¯¥åˆ—è¡¨å³å¯MIRROR_LIST=( &quot;docker.1ms.run&quot; &quot;docker.xuanyuan.me&quot; &quot;docker.m.daocloud.io&quot; &quot;docker.1panel.live&quot;)# å¦‚æœé•œåƒåä¸­ä¸åŒ…å« &quot;/&quot;ï¼ŒåŠ ä¸Š &quot;library/&quot;if [[ &quot;$ORIGINAL_IMAGE_NAME&quot; != *&quot;/&quot;* ]]; then IMAGE_NAME=&quot;library/$ORIGINAL_IMAGE_NAME&quot;else IMAGE_NAME=&quot;$ORIGINAL_IMAGE_NAME&quot;fi# éå†é•œåƒæºfor MIRROR in &quot;$&#123;MIRROR_LIST[@]&#125;&quot;; do FULL_IMAGE=&quot;$MIRROR/$IMAGE_NAME&quot; echo &quot;å°è¯•ä» $FULL_IMAGE $ARGS æ‹‰å–é•œåƒ...&quot; echo &quot;docker pull $&#123;FULL_IMAGE&#125; $&#123;ARGS&#125;&quot; if docker pull $&#123;FULL_IMAGE&#125; $&#123;ARGS&#125;; then echo &quot;æˆåŠŸæ‹‰å–é•œåƒï¼š$FULL_IMAGE $ARGS&quot; # å°†é•œåƒé‡å‘½åä¸ºå»é™¤é•œåƒæºå‰ç¼€çš„ç‰ˆæœ¬ docker tag &quot;$FULL_IMAGE&quot; &quot;$ORIGINAL_IMAGE_NAME&quot; echo &quot;é•œåƒé‡å‘½åä¸ºï¼š$ORIGINAL_IMAGE_NAME&quot; # å¯é€‰ï¼šåˆ é™¤å¸¦é•œåƒæºå‰ç¼€çš„é•œåƒ docker rmi &quot;$FULL_IMAGE&quot; &gt;/dev/null 2&gt;&amp;1 exit 0 else echo &quot;ä» $MIRROR æ‹‰å–å¤±è´¥ï¼Œå°è¯•ä¸‹ä¸€ä¸ªé•œåƒæº...&quot; fidoneecho &quot;æ‰€æœ‰é•œåƒæºå°è¯•å¤±è´¥ï¼Œæ— æ³•æ‹‰å–é•œåƒï¼š$ORIGINAL_IMAGE_NAME $ARGS&quot;exit 1 å¦‚ä½•è·å–é•œåƒtag docker å‘½ä»¤ä¸­æ²¡æœ‰æä¾›ç›´æ¥è·å–é•œåƒtagçš„å‘½ä»¤ï¼Œå¦‚æœä¸æƒ³åˆ°dockerhubä¸ŠæŸ¥çœ‹ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼è·å– é€šè¿‡dockerhubçš„apiæ¥å£è·å–(éœ€è¦ç§‘å­¦ä¸Šç½‘) 123456789101112131415# åªæ˜¾ç¤ºtagåç§°ï¼Œå®˜æ–¹é•œåƒæ›¿æ¢ nginxï¼Œéå®˜æ–¹é•œåƒæ›¿æ¢ libryary/nginxï¼Œpage_size=5è¡¨ç¤ºæ¯é¡µ5æ¡æ•°æ®ï¼Œpage=1è¡¨ç¤ºç¬¬ä¸€é¡µï¼ˆé»˜è®¤ä¸º1ï¼‰curl -s &quot;https://registry.hub.docker.com/v2/repositories/library/nginx/tags?page_size=5&amp;page=1&quot; | jq &#x27;.results[].name&#x27;## ä¹Ÿå¯ä»¥ä½¿ç”¨å¦‚ä¸‹urlï¼Œä¸¤è€…æ•ˆæœç›¸åŒ## https://hub.docker.com/v2/namespaces/&#123;namespace&#125;/repositories/&#123;repository&#125;/tags?page_size=5&amp;page=1## ç¤ºä¾‹ï¼šhttps://hub.docker.com/v2/namespaces/library/repositories/nginx/tags?page_size=1&amp;page=1# è¾“å‡ºjsonæ ¼å¼ï¼Œå¹¶æ˜¾ç¤ºæœ€åæ›´æ–°æ—¶é—´å’Œé•œåƒå¤§å°curl -s &quot;https://registry.hub.docker.com/v2/repositories/library/nginx/tags?page_size=5&amp;page=1&quot; | jq &#x27;.results[] | &#123;name,last_updated,full_size&#125;&#x27;# è¾“å‡ºè¡¨æ ¼æ ¼å¼ï¼Œå¹¶æ ¼å¼åŒ–è¾“å‡ºcurl -s &quot;https://registry.hub.docker.com/v2/repositories/library/nginx/tags?page_size=5&amp;page=1&quot; \\| jq -r &#x27;.results[] | &quot;\\(.name)\\t\\t\\(.last_updated | sub(&quot;T&quot;; &quot; &quot;) | sub(&quot;\\\\..*&quot;; &quot;&quot;))\\t\\t\\(((.full_size / 1024 / 1024 * 100 | round)/100) | tostring) MB&quot;&#x27; \\ | awk &#x27;&#123;printf &quot;%-30s %-20s %8.2f MB\\n&quot;, $1, $2&quot; &quot;$3, $4&#125;&#x27; é€šè¿‡skopeoå·¥å…·è·å– 1234# è¿™é‡Œä½¿ç”¨å®¹å™¨çš„æ–¹å¼(éœ€è¦ç§‘å­¦ä¸Šç½‘)docker run --rm quay.io/skopeo/stable:latest inspect --override-os linux docker://docker.io/nginx | jq &#x27;.RepoTags[]&#x27;# å°†`docker.io`æ›¿æ¢ä¸ºé•œåƒæº`docker.1ms.run`ï¼Œä¸éœ€è¦ç§‘å­¦ä¸Šç½‘docker run --rm quay.io/skopeo/stable:latest inspect --override-os linux docker://docker.1ms.run/nginx | jq &#x27;.RepoTags[]&#x27; ä¸ºäº†æ–¹ä¾¿ä½¿ç”¨å¯ä»¥ç¼–å†™ä¸€ä¸ªè„šæœ¬ 12345678910111213141516171819cat &lt;&lt; EOF &gt; docker_tags#!/bin/bash# ç”¨æ³•æç¤ºif [ -z &quot;\\$1&quot; ]; then echo &quot;ç”¨æ³•: \\$0 &lt;é•œåƒåç§°ï¼Œä¾‹å¦‚ nginx æˆ– library/nginx&gt;&quot; exit 1fiIMAGE_NAME=\\$1# ä½¿ç”¨ skopeo è·å–é•œåƒä¿¡æ¯å¹¶è§£ææ ‡ç­¾åˆ—è¡¨docker run --rm quay.io/skopeo/stable:latest \\\\ inspect --override-os linux docker://docker.1ms.run/\\$IMAGE_NAME \\\\ | jq &#x27;.RepoTags[]&#x27;EOFchmod +x docker_tags# ä½¿ç”¨docker_tags nginx docker images : åˆ—å‡ºé•œåƒ docker image ls == docker images 123456789101112131415# åˆ—å‡ºæ‰€æœ‰é•œåƒï¼Œä¸åŒ…æ‹¬æ‚¬ç©ºé•œåƒï¼Œï¼ˆdangling images:æ²¡æœ‰ tag çš„é•œåƒ,é€šå¸¸æ˜¯æ„å»ºä¸­é—´äº§ç‰©,ä¾‹å¦‚ï¼š&lt;none&gt;:&lt;none&gt; å½¢å¼ã€‚ï¼‰$ docker images# åˆ—å‡ºæ‰€æœ‰é•œåƒï¼ŒåŒ…æ‹¬æ‚¬ç©ºé•œåƒ$ docker images -a# åˆ—å‡ºæ‰€æœ‰é•œåƒï¼Œå¹¶æ˜¾ç¤ºé•œåƒçš„æ‘˜è¦ä¿¡æ¯$ docker images --digests# åˆ—å‡ºæ‰€æœ‰é•œåƒï¼Œå¹¶è¾“å‡ºä¸ºjsonæ ¼å¼$ docker images --format json# åªæ˜¾ç¤ºé•œåƒåç§°å’Œæ ‡ç­¾$ docker images --format &quot;&#123;&#123;.Repository&#125;&#125;:&#123;&#123;.Tag&#125;&#125;&quot;# åªæ˜¾ç¤ºé•œåƒID$ docker images -q docker inspect : æŸ¥çœ‹é•œåƒçš„è¯¦ç»†ä¿¡æ¯ docker image inspect == docker inspect è¿™é‡Œè¦æ³¨æ„ï¼Œdocker inspectå¦‚æœåŸºäºåç§°æŸ¥æ‰¾ä¼šä¼˜å…ˆæŸ¥æ‰¾å®¹å™¨ 1234567891011# å‘½ä»¤æ ¼å¼$ docker inspect [OPTIONS] NAME|ID [NAME|ID...]# æ˜¾ç¤ºé•œåƒçš„è¯¦ç»†ä¿¡æ¯ï¼Œé•œåƒåç§°$ docker inspect nginx# æ˜¾ç¤ºé•œåƒçš„è¯¦ç»†ä¿¡æ¯ï¼Œé•œåƒID$ docker inspect 9f0c0d0a0f0f# æ˜¾ç¤ºé•œåƒçš„Labelsä¿¡æ¯ï¼Œè·å–jsonä¸­æŒ‡å®šçš„å­—æ®µ$ docker image inspect --format=&#x27;&#123;&#123;json .Config.Labels&#125;&#125;&#x27; nginx docker image prune : åˆ é™¤æœªä½¿ç”¨çš„é•œåƒ 123456# åˆ é™¤æ‚¬ç©ºé•œåƒï¼Œï¼ˆdangling images:æ²¡æœ‰ tag çš„é•œåƒ,é€šå¸¸æ˜¯æ„å»ºä¸­é—´äº§ç‰©,ä¾‹å¦‚ï¼š&lt;none&gt;:&lt;none&gt; å½¢å¼ã€‚ï¼‰$ docker image prune# åˆ é™¤å…¨éƒ¨æœªä½¿ç”¨é•œåƒ(æœªè¢«ä»»ä½•ä¸€ä¸ªå®¹å™¨å¼•ç”¨)ï¼ŒåŒ…æ‹¬æ‚¬ç©ºé•œåƒ$ docker image prune -a# ä¸è¿›è¡Œç¡®è®¤æç¤ºï¼Œç›´æ¥æ‰§è¡Œ$ docker image prune -f docker rmi : åˆ é™¤é•œåƒ docker image rm == docker rmi 12345678910111213# å‘½ä»¤æ ¼å¼$ docker rmi [OPTIONS] IMAGE [IMAGE...]# åˆ é™¤é•œåƒï¼Œé•œåƒåç§°$ docker rmi nginx# åˆ é™¤å¤šä¸ªé•œåƒï¼Œç©ºæ ¼åˆ†éš”$ docker rmi nginx mysql# åˆ é™¤é•œåƒï¼Œé•œåƒID$ docker rmi 9f0c0d0a0f0f# å¼ºåˆ¶åˆ é™¤é•œåƒï¼Œå½“é•œåƒè¢«å®¹å™¨å¼•ç”¨æ—¶ï¼Œä¼šæŠ¥é”™ï¼Œéœ€è¦ä½¿ç”¨-få‚æ•°è¿›è¡Œå¼ºåˆ¶åˆ é™¤$ docker rmi -f nginx# åˆ é™¤å…¨éƒ¨é•œåƒ$ docker rmi $(docker images -q) docker history : æŸ¥çœ‹é•œåƒçš„æ„å»ºå†å² docker image history == docker history 12345678910# å‘½ä»¤æ ¼å¼$ docker history [OPTIONS] IMAGE# æŸ¥çœ‹é•œåƒçš„å†å²è®°å½•ï¼Œé•œåƒåç§°$ docker history nginx# æŸ¥çœ‹é•œåƒçš„å†å²è®°å½•ï¼Œé•œåƒID$ docker history 9f0c0d0a0f0f# æ˜¾ç¤ºå®Œæ•´çš„é•œåƒå†å²è®°å½•ï¼Œé»˜è®¤`CREATED BY`ä¸­çš„ä¿¡æ¯å¤ªé•¿ä¼šè¢«æˆªæ–­$ docker history --no-trunc nginx# æ˜¾ç¤ºä¸ºjsonæ ¼å¼$ docker history --format=json nginx docker history æ˜¾ç¤ºçš„æ˜¯æ„å»ºå†å²ï¼Œä¼šå°†æ¯ä¸€ä¸ª Dockerfile æŒ‡ä»¤éƒ½ç®—ä¸€å±‚ï¼Œè€Œä¸æ˜¯ç‰©ç†é•œåƒå±‚ï¼ˆlayerï¼‰æ•°é‡ï¼Œè‹¥è¦æŸ¥çœ‹é•œåƒçš„ç‰©ç†å±‚æ•°ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹ 1$ docker image inspect --format &#x27;&#123;&#123; len .RootFS.Layers &#125;&#125;&#x27; nginx docker tag : åˆ›å»ºä¸€ä¸ªæ ‡ç­¾ docker image tag == docker tag 123456789101112# å‘½ä»¤æ ¼å¼$ docker tag SOURCE_IMAGE[:TAG] TARGET_IMAGE[:TAG]# åˆ›å»ºä¸€ä¸ªæ ‡ç­¾$ docker tag nginx:latest hanqunfeng/nginx:latest# æŸ¥çœ‹é•œåƒï¼Œå¯ä»¥çœ‹åˆ°ä¸¤ä¸ªé•œåƒçš„ IMAGE ID ä¸€è‡´$ docker imagesREPOSITORY TAG IMAGE ID CREATED SIZEhanqunfeng/nginx latest be69f2940aaf 5 weeks ago 192MBnginx latest be69f2940aaf 5 weeks ago 192MB# æ­¤æ—¶è‹¥é€šè¿‡ IMAGE ID åˆ é™¤é•œåƒï¼Œä¼šæŠ¥é”™ï¼Œæç¤ºè¢«å¤šä¸ª REPOSITORY å…³è”ï¼Œéœ€è¦ä½¿ç”¨ -f å‚æ•°è¿›è¡Œå¼ºåˆ¶åˆ é™¤$ docker rmi be69f2940aafError response from daemon: conflict: unable to delete be69f2940aaf (must be forced) - image is referenced in multiple repositories docker save : å°†é•œåƒä¿å­˜ä¸º tar å½’æ¡£ docker image save == docker save 123456# å‘½ä»¤æ ¼å¼$ docker save [OPTIONS] IMAGE [IMAGE...]# å°†é•œåƒä¿å­˜ä¸º tar å½’æ¡£ï¼Œ-o æŒ‡å®šè¾“å‡ºæ–‡ä»¶ï¼Œæ–‡ä»¶åç§°ä»»æ„ï¼Œç”šè‡³éƒ½ä¸éœ€è¦ä»¥ .tar ç»“å°¾$ docker save -o nginx.tar nginx# æˆ–è€…$ docker save nginx &gt; nginx.tar docker load : ä» tar å½’æ¡£ä¸­åŠ è½½é•œåƒ docker image load == docker load 123456# å‘½ä»¤æ ¼å¼$ docker load [OPTIONS]# ä» tar å½’æ¡£ä¸­åŠ è½½é•œåƒï¼Œå¯¼å‡ºtarå½’æ¡£æ—¶çš„é•œåƒåç§°å°±æ˜¯åŠ è½½åçš„é•œåƒåç§°$ docker load -i nginx.tar# -q å‚æ•°è¡¨ç¤ºä¸æ˜¾ç¤ºè¿›åº¦æ¡$ docker load -q -i nginx.tar docker import : ä»æ–‡ä»¶åˆ›å»ºé•œåƒ docker image import == docker import 12345678910111213# å‘½ä»¤æ ¼å¼$ docker import [OPTIONS] FILE|URL|- [REPOSITORY[:TAG]]## å‚æ•°è¯´æ˜file æœ¬åœ° tar æ–‡ä»¶ï¼Œä¾‹å¦‚ rootfs.tarURL ç½‘ç»œåœ°å€ï¼ˆhttp/httpsï¼‰- ä»æ ‡å‡†è¾“å…¥è¯»å–ï¼ˆæ¯”å¦‚é€šè¿‡ç®¡é“ï¼‰# è¾“å‡ºé•œåƒåç§°ä¸æ ‡ç­¾REPOSITORY[:TAG] å¯¼å…¥åé•œåƒçš„åç§°ä¸æ ‡ç­¾# OPTIONS--change åœ¨å¯¼å…¥é•œåƒæ—¶è®¾ç½® Dockerfile æŒ‡ä»¤ï¼Œå¦‚ CMDã€ENVã€EXPOSE ç­‰--message, -m æ·»åŠ å¯¼å…¥è¯´æ˜ï¼ˆcommit messageï¼‰ docker import ä¸ docker load çš„åŒºåˆ« å‘½ä»¤ ç”¨é€” æ ¼å¼ æ˜¯å¦ä¿ç•™å†å² docker import å¯¼å…¥æ–‡ä»¶ç³»ç»Ÿï¼Œåˆ›å»ºé•œåƒ(ç”± docker export ç”Ÿæˆ) çº¯æ–‡ä»¶ç³»ç»Ÿ tar åŒ… âŒ ä¸ä¿ç•™å†å²ã€æ ‡ç­¾ç­‰å…ƒæ•°æ® docker load åŠ è½½é•œåƒï¼ˆé€šå¸¸ç”± docker save ç”Ÿæˆï¼‰ Docker é•œåƒ tarï¼ˆå«å…ƒæ•°æ®ï¼‰ âœ… ä¿ç•™ tagã€å±‚ã€å†å²ç­‰ ç¤ºä¾‹: ä»å®¹å™¨å¯¼å‡ºå†å¯¼å…¥ 1234567891011121314# å¯åŠ¨ä¸€ä¸ªå®¹å™¨$ docker run -d -p 8080:80 --name nginx nginx# å¯¼å‡ºå®¹å™¨æ–‡ä»¶ç³»ç»Ÿï¼Œæ­¤æ—¶ nginx å®¹å™¨ä¸­çš„æ‰€æœ‰æ–‡ä»¶éƒ½ä¿å­˜åœ¨ my_nginx.tar æ–‡ä»¶ä¸­$ docker export -o my_nginx.tar nginx# å¯¼å…¥æ–‡ä»¶ç³»ç»Ÿï¼Œå¯¼å…¥æ—¶æŒ‡å®š å¯åŠ¨å‘½ä»¤ï¼Œå› ä¸º my_nginx.tar åªæ˜¯æ–‡ä»¶ï¼Œå¹¶ä¸åŒ…å«ä»»ä½•å¯åŠ¨å‘½ä»¤$ docker import --change=&#x27;CMD [&quot;nginx&quot;, &quot;-g&quot;, &quot;daemon off;&quot;]&#x27; my_nginx.tar nginx:my_tag# æŸ¥çœ‹é•œåƒï¼Œé•œåƒIDä¸ä¸€è‡´$ docker imagesREPOSITORY TAG IMAGE ID CREATED SIZEnginx my_tag 4ab42de31bac 4 seconds ago 191MBnginx latest be69f2940aaf 5 weeks ago 192MB docker build : ä»æŒ‡å®šç›®å½•æˆ–URLä¸­çš„ Dockerfile æ„å»º Docker é•œåƒ docker image build == docker build 123456789101112131415161718192021222324# å‘½ä»¤æ ¼å¼docker build [OPTIONS] PATH | URL | -# å‚æ•°è¯´æ˜PATH Dockerfile æ‰€åœ¨çš„ç›®å½•URL Git ä»“åº“çš„ URL- ä»æ ‡å‡†è¾“å…¥è¯»å– Dockerfile# æ„å»ºé•œåƒï¼Œ-t: æŒ‡å®šé•œåƒåç§°ï¼Œ.: è¡¨ç¤ºä»å½“å‰ç›®å½•æŸ¥æ‰¾Dockerfileï¼Œé»˜è®¤æ–‡ä»¶åç§°ä¸º Dockerfiledocker build -t myimage:latest .# æ„å»ºé•œåƒï¼Œ-f: æŒ‡å®š Dockerfile çš„ç›¸å¯¹è·¯å¾„ï¼Œ.: è¡¨ç¤ºåŸºäºå½“å‰ç›®å½•ï¼Œå®é™…çš„ Dockerfile è·¯å¾„å°±æ˜¯ ./path/MyDockerfiledocker build -t myimage:latest -f path/MyDockerfile .# å®é™…çš„ Dockerfile è·¯å¾„å°±æ˜¯ /usr/local/path/MyDockerfiledocker build -t myimage:latest -f path/MyDockerfile /usr/local# æ„å»ºé•œåƒï¼Œä» Git ä»“åº“ä¸­æ„å»ºï¼Œgit ä»“åº“çš„ Dockerfile å¿…é¡»åœ¨æ ¹ç›®å½•ä¸‹docker build https://github.com/hanqunfeng/docker_test.git -t abc:1.0.0# æ„å»ºé•œåƒï¼Œä» Git ä»“åº“ä¸­æ„å»ºï¼ŒæŒ‡å®š Dockerfile çš„ç›¸å¯¹è·¯å¾„docker build -f docker/Dockerfile https://github.com/hanqunfeng/docker_test.git -t abc:1.0.1# æ„å»ºé•œåƒï¼Œä» Git ä»“åº“ä¸­æ„å»ºï¼ŒæŒ‡å®šåˆ†æ”¯æˆ– tagdocker build -f docker/Dockerfile https://github.com/hanqunfeng/docker_test.git#release -t abc:1.0.2# æ„å»ºé•œåƒï¼Œ--no-cache è¡¨ç¤ºä¸ä½¿ç”¨ç¼“å­˜ï¼Œæ¯æ¬¡æ„å»ºéƒ½ä¼šé‡æ–°æ„å»ºï¼Œä½†ä¼šéå¸¸æ…¢ï¼Œä¸€èˆ¬æ²¡æœ‰å¯¼è‡´æŸä¸€ä¸ªå±‚å‘ç”Ÿå˜åŒ–æ—¶ä¸éœ€è¦åŠ ä¸Šè¿™ä¸ªå‚æ•°docker build --no-cache -t app:latest . docker buildä¸­è¿˜æœ‰ä¸€äº›é‡è¦çš„å‚æ•°ï¼Œä»¥åŠDockerfileæ–‡ä»¶è¯¥æ€ä¹ˆç¼–å†™ï¼Œè¯·å‚è€ƒDocker å‘½ä»¤ ä¹‹ Dockerfile docker push : æ¨é€æœ¬åœ°é•œåƒåˆ°è¿œç¨‹ä»“åº“ docker image push == docker push è¿™é‡Œä»‹ç»å¦‚ä½•å°†é•œåƒæ¨é€åˆ°docker hubè¿œç¨‹ä»“åº“ éœ€è¦å…ˆåœ¨docker hubç½‘ç«™ä¸Šåˆ›å»ºä¸€ä¸ªè´¦å·ï¼Œæ¯”å¦‚æˆ‘çš„ç”¨æˆ·åæ˜¯hanqunfeng ç„¶åå°±å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤å°†æœ¬åœ°é•œåƒæ¨é€åˆ°è¿œç¨‹ä»“åº“äº† 1234567891011121314151617181920212223242526272829# æŸ¥çœ‹æœ¬åœ°é•œåƒ$ docker imagesREPOSITORY TAG IMAGE ID CREATED SIZEnginx latest e573c6323878 18 hours ago 191MB# å¯¹nginxé•œåƒæ‰“tag,å‰ç¼€å¿…é¡»ä¸ç”¨æˆ·åä¸€è‡´$ docker tag nginx hanqunfeng/nginx:1.0.0$ docker imagesREPOSITORY TAG IMAGE ID CREATED SIZEhanqunfeng/nginx 1.0.0 be69f2940aaf 5 weeks ago 192MBnginx latest be69f2940aaf 5 weeks ago 192MB# ç™»å½• docker hup$ docker login -u hanqunfengi Info â†’ A Personal Access Token (PAT) can be used instead. To create a PAT, visit https://app.docker.com/settingsPassword: # è¾“å…¥å¯†ç Login Succeeded# ç™»å½•åŒæ—¶è¾“å…¥å¯†ç # docker login -u hanqunfeng -p 12345678# ç™»å½•å…¶å®ƒä»“åº“# docker login -u username -p password registry.orther.com# æ¨é€åˆ°docker hubï¼Œæ­¤åå°±å¯ä»¥é€šè¿‡ docker pull hanqunfeng/nginx:1.0.0 è·å–äº†$ docker push hanqunfeng/nginx:1.0.0 å°è´´å£« æœªç™»å½•Docker Hubçš„æƒ…å†µä¸‹ï¼Œè¿è¡Œdocker pullä¼šæœ‰æ‹‰å–é€Ÿç‡å’Œæ•°é‡ä¸Šçš„é™åˆ¶ï¼Œå…·ä½“å¯ä»¥å‚çœ‹Docker Hubçš„ä½¿ç”¨å’Œé™åˆ¶","summary":"æ‘˜è¦ æœ¬æ–‡ä»‹ç» Docker å‘½ä»¤ ä¸­ é•œåƒç®¡ç† ç›¸å…³å‘½ä»¤ Dockerå®˜æ–¹æ–‡æ¡£ Application programming interfaces (APIs)","date_published":"2025-05-22T13:30:05.000Z","tags":["æŠ€æœ¯","docker","docker"]},{"id":"https://blog.hanqunfeng.com/2025/05/20/docker-install/","url":"https://blog.hanqunfeng.com/2025/05/20/docker-install/","title":"Linux å®‰è£… Docker","content_html":"<!--\n **åŠ ç²—**\n *æ–œä½“*\n ***åŠ ç²—å¹¶æ–œä½“***\n ~~åˆ é™¤çº¿~~\n ==çªå‡ºæ˜¾ç¤º==\n `çªå‡ºæ˜¾ç¤º(æ¨è)`\n ++ä¸‹åˆ’çº¿++\n ~ä¸‹æ ‡~\n ^ä¸Šæ ‡^\n è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference.\n å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)\n\n +++ **ç‚¹å‡»æŠ˜å **\n è¿™æ˜¯è¢«éšè—çš„å†…å®¹\n +++\n\n::: tips success warning danger\nè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹\n:::\n\n% note info % success warning danger\nè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹\n% endnote %\n\nå¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{}\n å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ\n -->\n<h2 id=\"æ‘˜è¦\">æ‘˜è¦</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æœ¬æ–‡ä»‹ç» Linux ä¸‹çš„ Docker å®‰è£…æ–¹æ³•ï¼Œæœ¬æ–‡ä»¥ CentOS 8 ä¸ºä¾‹ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>windowsã€macosã€ubuntuç­‰æ¡Œé¢ç³»ç»Ÿè¯·å®‰è£… <a href=\"https://www.docker.com/products/docker-desktop/\">Docker Desktop</a>ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>é˜¿é‡Œäº‘ä¸“æœ‰æœåŠ¡å™¨å‚è€ƒï¼š<a href=\"https://help.aliyun.com/zh/ecs/use-cases/install-and-use-docker\">é˜¿é‡Œäº‘ä¸“æœ‰æœåŠ¡å™¨å¦‚ä½•å®‰è£…Docker</a></p>\n</li>\n<li class=\"lvl-2\">\n<p>è…¾è®¯äº‘ä¸“æœ‰æœåŠ¡å™¨å‚è€ƒï¼š<a href=\"https://cloud.tencent.com/document/product/1207/45596\">è…¾è®¯äº‘ä¸“æœ‰æœåŠ¡å™¨å¦‚ä½•å®‰è£…Docker</a></p>\n</li>\n<li class=\"lvl-2\">\n<p>AWSä¸“æœ‰æœåŠ¡å™¨å‚è€ƒï¼š<a href=\"/2025/05/19/docker-install-aws/\" title=\"AWSä¸“æœ‰æœåŠ¡å™¨å¦‚ä½•å®‰è£…Docker\">AWSä¸“æœ‰æœåŠ¡å™¨å¦‚ä½•å®‰è£…Docker</a></p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://docs.docker.com\">Dockerå®˜æ–¹æ–‡æ¡£</a></p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://docs.docker.com/engine/install/\">å®‰è£…Docker Engine</a></p>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"Docker-ç®€ä»‹\">Docker ç®€ä»‹</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Docker æ˜¯ä¸€ä¸ªå¼€æºçš„å®¹å™¨åŒ–å¹³å°ï¼Œç”¨äºæ‰“åŒ…ã€åˆ†å‘å’Œè¿è¡Œåº”ç”¨ç¨‹åºã€‚å®ƒé€šè¿‡å°†åº”ç”¨ç¨‹åºåŠå…¶ä¾èµ–æ‰“åŒ…åˆ°ä¸€ä¸ªâ€œå®¹å™¨â€ä¸­ï¼Œç¡®ä¿åº”ç”¨åœ¨ä¸åŒç¯å¢ƒä¸­å§‹ç»ˆèƒ½å¤Ÿä¸€è‡´è¿è¡Œã€‚ä¸ä¼ ç»Ÿçš„è™šæ‹Ÿæœºç›¸æ¯”ï¼ŒDocker å®¹å™¨æ›´è½»é‡ã€å¯åŠ¨æ›´å¿«ã€èµ„æºå ç”¨æ›´å°‘ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>Docker é‡‡ç”¨<code>å®¢æˆ·ç«¯-æœåŠ¡å™¨</code>æ¶æ„ï¼Œæ ¸å¿ƒç»„ä»¶åŒ…æ‹¬ <code>Docker Engine</code>ï¼ˆè´Ÿè´£æ„å»ºå’Œè¿è¡Œå®¹å™¨ï¼‰ã€<code>Dockerfile</code>ï¼ˆå®šä¹‰æ„å»ºé•œåƒçš„æŒ‡ä»¤ï¼‰ã€<code>é•œåƒ</code>ï¼ˆåº”ç”¨å’Œä¾èµ–çš„åªè¯»æ¨¡æ¿ï¼‰å’Œ<code>å®¹å™¨</code>ï¼ˆåŸºäºé•œåƒè¿è¡Œçš„å®ä¾‹ï¼‰ã€‚å¼€å‘è€…å¯ä»¥é€šè¿‡ Docker Hub å…±äº«æˆ–ä¸‹è½½é•œåƒï¼Œæå¤§ç®€åŒ–äº†éƒ¨ç½²æµç¨‹ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>æ€»ç»“æ¥è¯´ï¼ŒDocker æé«˜äº†å¼€å‘æ•ˆç‡ï¼Œæ”¯æŒæŒç»­é›†æˆä¸éƒ¨ç½²ï¼ˆCI/CDï¼‰ï¼Œåœ¨å¾®æœåŠ¡æ¶æ„ä¸­å°¤ä¸ºå¸¸ç”¨ï¼Œæ˜¯ç°ä»£ DevOps æµç¨‹çš„é‡è¦å·¥å…·ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://docs.docker.com/get-started/docker-overview/\">Dockeræ˜¯ä»€ä¹ˆï¼Ÿ</a><br>\n<img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/nIdftv.png\" alt=\"\"></p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>åç§°</th>\n<th>æè¿°</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Docker ä»“åº“ï¼ˆRegistryï¼‰</td>\n<td>Dockerä»“åº“ç”¨äºå­˜å‚¨Dockeré•œåƒã€‚Docker Hubæ˜¯ä¸€ä¸ªä»»ä½•äººéƒ½å¯ä»¥ä½¿ç”¨çš„å…¬å…±ä»“åº“ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒDockeråœ¨Docker Hubä¸ŠæŸ¥æ‰¾å›¾åƒã€‚ä½ ä¹Ÿå¯ä»¥é…ç½®è‡ªå·±çš„ç§äººä»“åº“ã€‚<br>å½“æ‚¨ä½¿ç”¨docker pullæˆ–docker runå‘½ä»¤æ—¶ï¼ŒDockerä¼šä»æ‚¨é…ç½®çš„ä»“åº“ä¸­æå–æ‰€éœ€çš„é•œåƒã€‚å½“æ‚¨ä½¿ç”¨docker pushå‘½ä»¤æ—¶ï¼ŒDockerä¼šå°†æ‚¨çš„é•œåƒæ¨é€åˆ°å·²é…ç½®çš„ä»“åº“ä¸­ã€‚</td>\n</tr>\n<tr>\n<td>Docker å®ˆæŠ¤è¿›ç¨‹ï¼ˆDaemonï¼‰</td>\n<td>ç›‘å¬Docker APIè¯·æ±‚ï¼Œå¹¶ç®¡ç†Dockerå¯¹è±¡ï¼Œå¦‚é•œåƒã€å®¹å™¨ã€ç½‘ç»œå’Œå·ã€‚å®ˆæŠ¤ç¨‹åºè¿˜å¯ä»¥ä¸å…¶ä»–å®ˆæŠ¤ç¨‹åºé€šä¿¡æ¥ç®¡ç†DockeræœåŠ¡ã€‚</td>\n</tr>\n<tr>\n<td>Docker å®¢æˆ·ç«¯ï¼ˆClientï¼‰</td>\n<td>Docker å®¢æˆ·ç«¯ï¼ˆdockerï¼‰æ˜¯è®¸å¤šç”¨æˆ·ä¸ Docker äº¤äº’çš„ä¸»è¦æ–¹å¼ã€‚å½“ä½ ä½¿ç”¨å¦‚ docker run è¿™æ ·çš„å‘½ä»¤æ—¶ï¼Œå®¢æˆ·ç«¯ä¼šå°†è¿™äº›å‘½ä»¤å‘é€ç»™ dockerdï¼ˆDocker å®ˆæŠ¤è¿›ç¨‹ï¼‰ï¼Œç”±å®ƒæ¥æ‰§è¡Œè¿™äº›æ“ä½œã€‚<br>docker å‘½ä»¤æ˜¯é€šè¿‡ Docker API è¿›è¡Œé€šä¿¡çš„ã€‚Docker å®¢æˆ·ç«¯å¯ä»¥ä¸å¤šä¸ªå®ˆæŠ¤è¿›ç¨‹è¿›è¡Œé€šä¿¡ã€‚</td>\n</tr>\n<tr>\n<td>Docker ä¸»æœºï¼ˆHostï¼‰</td>\n<td>è¿è¡Œ Docker å®ˆæŠ¤è¿›ç¨‹å’Œå®¹å™¨çš„ç‰©ç†æˆ–è™šæ‹Ÿæœºå™¨ã€‚</td>\n</tr>\n<tr>\n<td>Docker é•œåƒï¼ˆImagesï¼‰</td>\n<td>åˆ›å»ºå®¹å™¨çš„åªè¯»æ¨¡æ¿ï¼ŒåŒ…å«è¿è¡Œåº”ç”¨æ‰€éœ€çš„æ‰€æœ‰æ–‡ä»¶å’Œé…ç½®ã€‚</td>\n</tr>\n<tr>\n<td>Docker å®¹å™¨ï¼ˆContainerï¼‰</td>\n<td>åŸºäºé•œåƒè¿è¡Œçš„å®ä¾‹ï¼Œæ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªåº”ç”¨çš„ç‹¬ç«‹è¿è¡Œç¯å¢ƒã€‚</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"Docker-å®‰è£…\">Docker å®‰è£…</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å…¨æ–°å®‰è£…å‰éœ€è¦å…ˆå¸è½½æ—§ç‰ˆæœ¬ï¼Œå¸è½½<code>docker</code>ä¹Ÿå¯ä»¥æŒ‰ç…§å¦‚ä¸‹æ–¹å¼æ“ä½œ</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># åˆ é™¤Dockerç›¸å…³æº</span></span><br><span class=\"line\"><span class=\"built_in\">sudo</span> <span class=\"built_in\">rm</span> -f /etc/yum.repos.d/docker*.repo</span><br><span class=\"line\"><span class=\"comment\"># åˆ é™¤Dockerç›¸å…³è½¯ä»¶åŒ…ï¼Œdnfå¯èƒ½ä¼šæŠ¥å‘Šæ‚¨æ²¡æœ‰å®‰è£…è¿™äº›è½¯ä»¶åŒ…ã€‚</span></span><br><span class=\"line\"><span class=\"comment\"># å¸è½½dockeræ—§ç‰ˆæœ¬</span></span><br><span class=\"line\"><span class=\"built_in\">sudo</span> dnf -y remove \\</span><br><span class=\"line\">               docker \\</span><br><span class=\"line\">               docker-client \\</span><br><span class=\"line\">               docker-client-latest \\</span><br><span class=\"line\">               docker-common \\</span><br><span class=\"line\">               docker-latest \\</span><br><span class=\"line\">               docker-latest-logrotate \\</span><br><span class=\"line\">               docker-logrotate \\</span><br><span class=\"line\">               docker-engine</span><br><span class=\"line\"><span class=\"comment\"># å¸è½½dockeræ–°ç‰ˆæœ¬</span></span><br><span class=\"line\"><span class=\"built_in\">sudo</span> dnf -y remove \\</span><br><span class=\"line\">            docker-ce \\</span><br><span class=\"line\">            containerd.io \\</span><br><span class=\"line\">            docker-ce-rootless-extras \\</span><br><span class=\"line\">            docker-buildx-plugin \\</span><br><span class=\"line\">            docker-ce-cli \\</span><br><span class=\"line\">            docker-compose-plugin</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># åˆ é™¤Dockeræ•°æ®,é•œåƒã€å®¹å™¨ã€å·å’Œç½‘ç»œ</span></span><br><span class=\"line\"><span class=\"built_in\">sudo</span> <span class=\"built_in\">rm</span> -rf /var/lib/docker</span><br><span class=\"line\"><span class=\"built_in\">sudo</span> <span class=\"built_in\">rm</span> -rf /var/lib/containerd</span><br><span class=\"line\"><span class=\"comment\"># Dockeræ‰§è¡ŒçŠ¶æ€æ–‡ä»¶çš„å­˜å‚¨è·¯å¾„</span></span><br><span class=\"line\"><span class=\"built_in\">sudo</span> <span class=\"built_in\">rm</span> -rf /var/run/docker</span><br><span class=\"line\"><span class=\"comment\"># åˆ é™¤Dockeré…ç½®</span></span><br><span class=\"line\"><span class=\"built_in\">sudo</span> <span class=\"built_in\">rm</span> -rf /etc/docker/</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>è®¾ç½®dockerå­˜å‚¨åº“</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">sudo</span> dnf -y install dnf-plugins-core</span><br><span class=\"line\"><span class=\"comment\"># æµ·å¤–ï¼Œæ·»åŠ Dockerçš„å®˜æ–¹å­˜å‚¨åº“</span></span><br><span class=\"line\"><span class=\"built_in\">sudo</span> dnf config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo</span><br><span class=\"line\"><span class=\"comment\"># å›½å†…ï¼Œæ·»åŠ é˜¿é‡Œäº‘çš„å­˜å‚¨åº“</span></span><br><span class=\"line\"><span class=\"built_in\">sudo</span> dnf config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å®‰è£… Docker</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># å®‰è£…æœ€æ–°ç‰ˆæœ¬ï¼Œå‡çº§ docker æ—¶ä¹Ÿæ˜¯æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤</span></span><br><span class=\"line\"><span class=\"built_in\">sudo</span> dnf -y install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># å®‰è£…æŒ‡å®šç‰ˆæœ¬</span></span><br><span class=\"line\"><span class=\"comment\"># å…ˆæŸ¥çœ‹æ‰€æœ‰ç‰ˆæœ¬</span></span><br><span class=\"line\"><span class=\"built_in\">sudo</span> dnf list docker-ce --showduplicates | <span class=\"built_in\">sort</span> -r</span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡º</span></span><br><span class=\"line\">docker-ce.x86_64               3:26.1.3-1.el8                  docker-ce-stable</span><br><span class=\"line\">docker-ce.x86_64               3:26.1.3-1.el8                  @docker-ce-stable</span><br><span class=\"line\">docker-ce.x86_64               3:26.1.2-1.el8                  docker-ce-stable</span><br><span class=\"line\">docker-ce.x86_64               3:26.1.1-1.el8                  docker-ce-stable</span><br><span class=\"line\">docker-ce.x86_64               3:26.1.0-1.el8                  docker-ce-stable</span><br><span class=\"line\">â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># å®‰è£…æŒ‡å®šç‰ˆæœ¬ï¼Œè¿™é‡Œ VERSION_STRING ä¸ºç‰ˆæœ¬å·ï¼Œä¾‹å¦‚ 3:26.1.3-1.el8</span></span><br><span class=\"line\"><span class=\"built_in\">sudo</span> dnf install docker-ce-&lt;VERSION_STRING&gt; docker-ce-cli-&lt;VERSION_STRING&gt; containerd.io docker-buildx-plugin docker-compose-plugin -y</span><br><span class=\"line\"><span class=\"comment\">## æ¯”å¦‚</span></span><br><span class=\"line\"><span class=\"built_in\">sudo</span> dnf install docker-ce-3:26.1.3-1.el8 docker-ce-cli-3:26.1.3-1.el8 containerd.io docker-buildx-plugin docker-compose-plugin -y</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## å¦‚æœåªå®‰è£…å®¢æˆ·ç«¯ç”¨äºè¿æ¥è¿œç¨‹ Docker ä¸»æœº</span></span><br><span class=\"line\"><span class=\"built_in\">sudo</span> dnf install docker-ce-cli docker-buildx-plugin docker-compose-plugin -y</span><br></pre></td></tr></table></figure>\n<table>\n<thead>\n<tr>\n<th>ç»„ä»¶åç§°</th>\n<th>æ˜¯å¦å¿…éœ€ï¼ˆæœ¬åœ°è¿è¡Œ Dockerï¼‰</th>\n<th>åŠŸèƒ½ç®€ä»‹</th>\n<th>å¤‡æ³¨</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>docker-ce</code></td>\n<td>âœ… æ˜¯</td>\n<td>Docker Engine çš„æ ¸å¿ƒï¼ŒåŒ…æ‹¬ <code>dockerd</code>ï¼ˆå®ˆæŠ¤è¿›ç¨‹ï¼‰å’Œ <code>docker</code>ï¼ˆCLIï¼‰</td>\n<td>å®Œæ•´å®‰è£… Docker æ—¶åŒ…å«æ­¤ç»„ä»¶</td>\n</tr>\n<tr>\n<td><code>docker-ce-cli</code></td>\n<td>âœ… æ˜¯ï¼ˆæˆ–å•ç‹¬ç”¨äºè¿œç¨‹æ§åˆ¶ï¼‰</td>\n<td>Docker å‘½ä»¤è¡Œå·¥å…·ï¼Œå¦‚ <code>docker run</code>, <code>docker ps</code>, <code>docker build</code> ç­‰</td>\n<td>å¯ä»¥ç‹¬ç«‹å®‰è£…ï¼Œåªç”¨äºæ§åˆ¶è¿œç¨‹ Docker ä¸»æœº</td>\n</tr>\n<tr>\n<td><code>containerd.io</code></td>\n<td>âœ… æ˜¯ï¼ˆæœ¬åœ°è¿è¡Œå®¹å™¨ï¼‰</td>\n<td>å®¹å™¨è¿è¡Œæ—¶ï¼ŒDocker åç«¯ç”¨äºçœŸæ­£å¯åŠ¨/ç®¡ç†å®¹å™¨</td>\n<td>å¦‚æœä½ åªä½¿ç”¨ Docker CLIï¼Œä¸è¿è¡Œæœ¬åœ°å®¹å™¨åˆ™ä¸éœ€è¦</td>\n</tr>\n<tr>\n<td><code>docker-buildx-plugin</code></td>\n<td>âŒ å¦</td>\n<td>æä¾› <code>docker buildx</code> å‘½ä»¤ï¼Œæ”¯æŒé«˜çº§æ„å»ºç‰¹æ€§ï¼ˆå¦‚è·¨å¹³å°ã€å¤šé˜¶æ®µæ„å»ºï¼‰</td>\n<td>å¯é€‰ï¼Œé€‚åˆé«˜çº§æ„å»ºéœ€æ±‚</td>\n</tr>\n<tr>\n<td><code>docker-compose-plugin</code></td>\n<td>âŒ å¦</td>\n<td>æä¾› <code>docker compose</code> å‘½ä»¤ï¼Œç”¨äºç¼–æ’å¤šä¸ªæœåŠ¡</td>\n<td>å¦‚æœä½¿ç”¨ Composeï¼Œåˆ™å»ºè®®å®‰è£…æ­¤æ’ä»¶</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å¯åŠ¨ Docker</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># è®¾ç½®Dockerå®ˆæŠ¤è¿›ç¨‹åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶è‡ªåŠ¨å¯åŠ¨</span></span><br><span class=\"line\"><span class=\"built_in\">sudo</span> systemctl <span class=\"built_in\">enable</span> docker</span><br><span class=\"line\"><span class=\"comment\"># å¯åŠ¨Docker</span></span><br><span class=\"line\"><span class=\"built_in\">sudo</span> systemctl start docker</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹ docker daemon æ—¥å¿—ï¼Œ-f: æŒç»­è·Ÿè¸ª</span></span><br><span class=\"line\"><span class=\"built_in\">sudo</span> journalctl -u docker -f</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æ·»åŠ å½“å‰ç”¨æˆ·åˆ°dockerç»„</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># æ·»åŠ å½“å‰ç”¨æˆ·åˆ°dockerç»„ï¼Œè¿™æ ·å½“å‰ç”¨æˆ·å°±å¯ä»¥ä¸éœ€è¦ä½¿ç”¨sudoå°±èƒ½ä½¿ç”¨dockerå‘½ä»¤</span></span><br><span class=\"line\"><span class=\"comment\"># å½“å‰ç”¨æˆ·æ˜¯centos</span></span><br><span class=\"line\"><span class=\"built_in\">sudo</span> usermod -aG docker centos</span><br><span class=\"line\"><span class=\"comment\"># è®©ç»„æƒé™ç«‹å³ç”Ÿæ•ˆæœ€ç¨³å¦¥çš„åšæ³•æ˜¯ï¼šæ³¨é”€å¹¶é‡æ–°ç™»å½•è¿œç¨‹ä¸»æœºï¼Œä½†ä¹Ÿå¯ä»¥å°è¯•ç”¨ä¸‹é¢å‘½ä»¤ç«‹å³åŠ è½½æ–°ç»„</span></span><br><span class=\"line\">newgrp docker</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>éªŒè¯ Docker å®‰è£…</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker version <span class=\"comment\"># æŸ¥çœ‹ Docker version</span></span><br><span class=\"line\"><span class=\"comment\"># æ˜¾ç¤º Docker åŸºæœ¬ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç‰ˆæœ¬ä¿¡æ¯ï¼Œæ’ä»¶ä¿¡æ¯ï¼Œé•œåƒåŠ é€Ÿä¿¡æ¯ç­‰ç­‰ã€‚</span></span><br><span class=\"line\">docker info</span><br><span class=\"line\"><span class=\"comment\"># æ‹‰å–hello-worldé•œåƒï¼Œæ­¤æ—¶å›½å†…ä¼šæç¤ºè®¿é—®å¤±è´¥ï¼Œéœ€è¦æ·»åŠ å›½å†…é•œåƒæº</span></span><br><span class=\"line\">docker pull hello-world</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æ·»åŠ å›½å†…é•œåƒæº</p>\n</li>\n</ul>\n<blockquote>\n<p>ç›®å‰å›½å†…å¤§éƒ¨åˆ†çš„Dockeré•œåƒæºéƒ½å…³é—­äº†ï¼Œå¦å¤–é˜¿é‡Œäº‘çš„Dockeré•œåƒæºåªå…è®¸åœ¨é˜¿é‡Œäº‘çš„æœºå™¨ä¸Šä½¿ç”¨ã€‚<br>\nå‚è€ƒï¼š<a href=\"https://blog.xuanyuan.me/archives/1154\">Docker/DockerHub å›½å†…é•œåƒæº/åŠ é€Ÿåˆ—è¡¨</a>,<a href=\"https://status.1panel.top/status/docker\">å›½å†… Docker æœåŠ¡çŠ¶æ€ &amp; é•œåƒåŠ é€Ÿç›‘æ§</a><br>\næ³¨æ„ï¼šå›½å†…é•œåƒæºçš„æ›´æ–°ä¼šæ¯”å®˜ç½‘æ»åï¼Œä½†åªè¦ä¸æ˜¯è·å–æœ€æ–°ç‰ˆæœ¬åŸºæœ¬ä¸Šæ˜¯å¤Ÿç”¨çš„ã€‚</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">sudo</span> <span class=\"built_in\">tee</span> /etc/docker/daemon.json &lt;&lt;<span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">&#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;registry-mirrors&quot;: [</span></span><br><span class=\"line\"><span class=\"string\">        &quot;https://docker.1ms.run&quot;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;https://docker.xuanyuan.me&quot;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;https://docker.m.daocloud.io&quot;</span></span><br><span class=\"line\"><span class=\"string\">    ]</span></span><br><span class=\"line\"><span class=\"string\">&#125;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># é‡å¯Docker</span></span><br><span class=\"line\"><span class=\"built_in\">sudo</span> systemctl daemon-reload</span><br><span class=\"line\"><span class=\"built_in\">sudo</span> systemctl restart docker</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹æ˜¯å¦é…ç½®ç”Ÿæ•ˆï¼ŒæŸ¥çœ‹ Registry Mirrors ä¸­çš„é…ç½®</span></span><br><span class=\"line\">docker info</span><br><span class=\"line\"><span class=\"comment\"># éªŒè¯å›½å†…é•œåƒæº</span></span><br><span class=\"line\">docker pull hello-world</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Dockerå‘½ä»¤è‡ªåŠ¨è¡¥å…¨ï¼Œå‚è€ƒï¼š<a href=\"https://docs.docker.com/engine/cli/completion/\">å®˜æ–¹æ–‡æ¡£</a></p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨çš„bash</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># å®‰è£…bash-completion</span></span><br><span class=\"line\"><span class=\"built_in\">sudo</span> dnf install bash-completion -y</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æ·»åŠ è‡ªåŠ¨è¡¥å…¨åˆ°å½“å‰ç™»å½•ç”¨æˆ·</span></span><br><span class=\"line\"><span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOT &gt;&gt; ~/.bashrc</span></span><br><span class=\"line\"><span class=\"string\">if [ -f /etc/bash_completion ]; then</span></span><br><span class=\"line\"><span class=\"string\">    . /etc/bash_completion</span></span><br><span class=\"line\"><span class=\"string\">fi</span></span><br><span class=\"line\"><span class=\"string\">EOT</span></span><br><span class=\"line\"><span class=\"comment\"># åˆ·æ–°bash</span></span><br><span class=\"line\"><span class=\"built_in\">source</span> ~/.bashrc</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># åˆ›å»ºè‡ªåŠ¨è¡¥å…¨æ–‡ä»¶</span></span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> -p ~/.local/share/bash-completion/completions</span><br><span class=\"line\">docker completion bash &gt; ~/.local/share/bash-completion/completions/docker</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># å¯åŠ¨ä¸€ä¸ªæ–°çš„bash</span></span><br><span class=\"line\"><span class=\"built_in\">exec</span> bash</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>/var/lib/docker</code> ç”¨äºå­˜å‚¨ Docker è¿è¡Œæ—¶ç”Ÿæˆçš„æ•°æ®ï¼Œå¦‚é•œåƒã€å®¹å™¨ã€ç½‘ç»œã€å·ã€é…ç½®æ–‡ä»¶ã€æ—¥å¿—ç­‰ï¼Œå…¶ç›®å½•ç»“æ„è¯´æ˜å¦‚ä¸‹ï¼š</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>ç›®å½•å</th>\n<th>ä½œç”¨è¯´æ˜</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>buildkit/</code></td>\n<td>å­˜æ”¾ Docker BuildKit æ„å»ºç¼“å­˜å’ŒçŠ¶æ€ä¿¡æ¯ï¼›æ„å»ºé•œåƒæ—¶çš„ä¸­é—´æ–‡ä»¶å’Œä¸Šä¸‹æ–‡ä¼šå­˜äºæ­¤ï¼Œç©ºé—´å ç”¨å¯èƒ½è¾ƒå¤§ã€‚</td>\n</tr>\n<tr>\n<td><code>containers/</code></td>\n<td>æ¯ä¸ªå®¹å™¨ä¸€ä¸ªå­ç›®å½•ï¼ŒåŒ…å«é…ç½®æ–‡ä»¶å’Œè¿è¡Œæ—¥å¿—ï¼ˆå¦‚ <code>container.log</code>ï¼‰ï¼Œç”¨äºå®¹å™¨çš„è¿è¡ŒçŠ¶æ€è®°å½•å’Œç®¡ç†ã€‚</td>\n</tr>\n<tr>\n<td><code>engine-id</code></td>\n<td>å­˜å‚¨ Docker å¼•æ“çš„å”¯ä¸€ IDï¼ŒDocker å®‰è£…æ—¶ç”Ÿæˆï¼Œå¸¸ç”¨äº swarm èŠ‚ç‚¹è¯†åˆ«ã€‚</td>\n</tr>\n<tr>\n<td><code>image/</code></td>\n<td>é•œåƒçš„å…ƒæ•°æ®ï¼ˆä¸å«å®é™… layer æ•°æ®ï¼‰ï¼Œç»„ç»‡é•œåƒçš„ç»“æ„ã€æ ‡ç­¾ã€é©±åŠ¨ç­‰ä¿¡æ¯ã€‚</td>\n</tr>\n<tr>\n<td><code>network/</code></td>\n<td>ç½‘ç»œé…ç½®åŠçŠ¶æ€ä¿¡æ¯ï¼Œå¦‚é»˜è®¤ <code>bridge</code> ç½‘ç»œã€è‡ªå®šä¹‰ç½‘ç»œé…ç½®ç­‰ã€‚</td>\n</tr>\n<tr>\n<td><code>overlay2/</code></td>\n<td>é•œåƒå’Œå®¹å™¨å®é™…çš„æ•°æ®å±‚ï¼ˆoverlay2 æ˜¯å­˜å‚¨é©±åŠ¨ï¼‰ï¼ŒåŒ…å«æ‰€æœ‰è”åˆæ–‡ä»¶ç³»ç»Ÿå±‚ï¼Œæ˜¯ Docker ä¸­æœ€å¤§çš„ç©ºé—´ä½¿ç”¨è€…ã€‚</td>\n</tr>\n<tr>\n<td><code>plugins/</code></td>\n<td>å­˜æ”¾ Docker æ’ä»¶ï¼ˆå¦‚ç½‘ç»œã€å·æ’ä»¶ï¼‰çš„é…ç½®å’Œæ•°æ®ï¼Œä¸€èˆ¬ä¸ºç©ºï¼Œé™¤éä½¿ç”¨äº†æ‰©å±•æ’ä»¶ã€‚</td>\n</tr>\n<tr>\n<td><code>runtimes/</code></td>\n<td>æ”¯æŒçš„ OCI runtime é…ç½®ç›®å½•ï¼Œå¦‚é»˜è®¤çš„ <code>runc</code>ï¼Œä¹Ÿå¯èƒ½åŒ…å«å…¶ä»– runtimeï¼ˆå¦‚ <code>kata</code>, <code>gvisor</code>ï¼‰ã€‚</td>\n</tr>\n<tr>\n<td><code>swarm/</code></td>\n<td>Docker swarm æ¨¡å¼ä¸‹çš„é›†ç¾¤å…ƒæ•°æ®ä¸èŠ‚ç‚¹çŠ¶æ€ï¼Œä»…åœ¨åˆå§‹åŒ– swarm åå­˜åœ¨å®é™…æ•°æ®ã€‚</td>\n</tr>\n<tr>\n<td><code>tmp/</code></td>\n<td>Docker çš„ä¸´æ—¶æ–‡ä»¶ç›®å½•ï¼Œå¦‚é•œåƒä¸‹è½½ç¼“å­˜ã€æŒ‚è½½æ“ä½œä¸­çš„ä¸´æ—¶æ–‡ä»¶ï¼Œé€šå¸¸å¯ä»¥æ¸…ç†ä½†éœ€å°å¿ƒã€‚</td>\n</tr>\n<tr>\n<td><code>volumes/</code></td>\n<td>Docker å·çš„æ•°æ®ç›®å½•ï¼Œæ¯ä¸ªå·ä¸€ä¸ªå­ç›®å½•ï¼Œå·ä¸­çš„æŒä¹…åŒ–æ•°æ®å®é™…å­˜æ”¾äºæ­¤ã€‚</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>/var/lib/containerd</code> æ˜¯ Containerd å®ˆæŠ¤è¿›ç¨‹çš„é»˜è®¤æ•°æ®å­˜å‚¨ç›®å½•ã€‚Containerd æ˜¯ Docker å’Œå…¶ä»–å®¹å™¨å¹³å°ï¼ˆå¦‚ Kubernetesï¼‰åº•å±‚çš„ å®¹å™¨è¿è¡Œæ—¶ï¼ˆContainer Runtimeï¼‰ï¼Œè´Ÿè´£æ‹‰å–é•œåƒã€ç®¡ç†å®¹å™¨ç”Ÿå‘½å‘¨æœŸã€æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿç­‰æ“ä½œã€‚å…¶ç›®å½•ç»“æ„è¯´æ˜å¦‚ä¸‹ï¼š</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>ç›®å½•å</th>\n<th>ä½œç”¨è¯´æ˜</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>io.containerd.content.v1.content/</code></td>\n<td>å­˜å‚¨é•œåƒ layer çš„å®é™…äºŒè¿›åˆ¶å†…å®¹ï¼ˆblobï¼‰ï¼Œéµå¾ª OCI é•œåƒè§„èŒƒï¼Œæ˜¯é•œåƒå’Œå®¹å™¨æ–‡ä»¶ç³»ç»Ÿçš„æ•°æ®æ¥æºã€‚</td>\n</tr>\n<tr>\n<td><code>io.containerd.metadata.v1.bolt/</code></td>\n<td>ä½¿ç”¨ BoltDB å­˜å‚¨ containerd çš„å…ƒæ•°æ®ï¼ˆå¦‚é•œåƒä¿¡æ¯ã€å®¹å™¨çŠ¶æ€ã€å¿«ç…§å¼•ç”¨ç­‰ï¼‰ï¼Œæ˜¯ containerd çš„æ ¸å¿ƒå…ƒæ•°æ®æ•°æ®åº“ã€‚</td>\n</tr>\n<tr>\n<td><code>io.containerd.runtime.v1.linux/</code></td>\n<td>å­˜å‚¨æ—§ç‰ˆï¼ˆv1 APIï¼‰è¿è¡Œæ—¶å®¹å™¨ä¿¡æ¯ï¼Œç›®å‰å·²é€æ­¥è¢« <code>v2</code> æ¥å£å–ä»£ï¼Œä»…åœ¨å‘åå…¼å®¹åœºæ™¯ä¸­å­˜åœ¨ã€‚</td>\n</tr>\n<tr>\n<td><code>io.containerd.runtime.v2.task/</code></td>\n<td>å­˜å‚¨ v2 è¿è¡Œæ—¶æ¥å£ä¸‹å®¹å™¨çš„è¿è¡Œæ—¶çŠ¶æ€ï¼Œå¦‚å®¹å™¨è¿›ç¨‹çš„ shimã€PIDã€æ—¥å¿—è·¯å¾„ç­‰ï¼Œæ˜¯å®¹å™¨å®é™…è¿è¡Œæ—¶æ‰€ä¾èµ–çš„ã€‚</td>\n</tr>\n<tr>\n<td><code>io.containerd.snapshotter.v1.native/</code></td>\n<td>ä½¿ç”¨ native æ¨¡å¼å­˜å‚¨çš„å®¹å™¨å¿«ç…§ï¼ˆæ–‡ä»¶ç³»ç»Ÿå±‚ï¼‰ï¼Œç›´æ¥å¤åˆ¶åº•å±‚æ–‡ä»¶ï¼›æ€§èƒ½è¾ƒå·®ï¼Œå ç”¨ç©ºé—´è¾ƒå¤§ï¼Œä¸»è¦ç”¨äºæµ‹è¯•æˆ–ç‰¹å®šç”¨é€”ã€‚</td>\n</tr>\n<tr>\n<td><code>io.containerd.snapshotter.v1.overlayfs/</code></td>\n<td>ä½¿ç”¨ overlayfs æ¨¡å¼å­˜å‚¨å®¹å™¨çš„æ–‡ä»¶ç³»ç»Ÿå¿«ç…§ï¼ˆé•œåƒå±‚å’Œå®¹å™¨å±‚ï¼‰ï¼›è¿™æ˜¯ç”Ÿäº§ç¯å¢ƒé»˜è®¤çš„é«˜æ•ˆå­˜å‚¨é©±åŠ¨ã€‚</td>\n</tr>\n<tr>\n<td><code>tmpmounts/</code></td>\n<td>ä¸´æ—¶æŒ‚è½½ç‚¹ç›®å½•ï¼Œcontainerd ç”¨äºé•œåƒè§£åŒ…ã€ä¸­é—´æ„å»ºè¿‡ç¨‹ä¸­çš„æŒ‚è½½æ“ä½œï¼Œé€šå¸¸æ˜¯æ„å»ºæˆ–è¿è¡Œè¿‡ç¨‹çš„ä¸´æ—¶æ•°æ®ã€‚</td>\n</tr>\n</tbody>\n</table>\n<div class=\"tips\">\n<p><em><strong>MacOS/Windowsä¸‹æ— æ³•æŸ¥çœ‹<code>/var/lib/docker</code>çš„è§£å†³æ–¹æ³•</strong></em></p>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">åœ¨ MacOS/Windows ä¸Šä½¿ç”¨Dockeræ—¶ï¼Œæ˜¯å¯åŠ¨äº†ä¸€ä¸ªè™šæ‹Ÿæœºæ¥è¿è¡Œdockerçš„ï¼Œç”±äºå…¶è¿è¡Œåœ¨è™šæ‹Ÿæœºå†…éƒ¨ï¼Œç›´æ¥æŸ¥æ‰¾<code>/var/lib/docker</code>è·¯å¾„æ˜¯æ— æ•ˆçš„ã€‚</li>\n<li class=\"lvl-2\">è§£å†³æ–¹æ³•å¦‚ä¸‹ï¼š</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># å¯åŠ¨ä¸€ä¸ªä¸´æ—¶å®¹å™¨ï¼Œå¹¶è¿›å…¥å…¶å†…éƒ¨</span></span><br><span class=\"line\">docker run --<span class=\"built_in\">rm</span> -it --privileged --pid=host debian nsenter -t 1 -m -u -n -i sh</span><br><span class=\"line\"><span class=\"comment\">## è¯´æ˜</span></span><br><span class=\"line\">--it</span><br><span class=\"line\">    äº¤äº’å¼åœ°è¿è¡Œå®¹å™¨,å¹¶åˆ†é…ä¸€ä¸ªä¼ªç»ˆç«¯</span><br><span class=\"line\"></span><br><span class=\"line\">--<span class=\"built_in\">rm</span></span><br><span class=\"line\">    é€€å‡ºå®¹å™¨æ—¶ï¼Œè‡ªåŠ¨åˆ é™¤å®¹å™¨</span><br><span class=\"line\"></span><br><span class=\"line\">--privileged</span><br><span class=\"line\">    ç»™å®¹å™¨ç‰¹æƒæƒé™ï¼Œè¿™æ„å‘³ç€å®¹å™¨å‡ ä¹æ‹¥æœ‰å®¿ä¸»æœºçš„æ‰€æœ‰èƒ½åŠ›ï¼Œèƒ½è®¿é—® /devã€ä¿®æ”¹å†…æ ¸å‚æ•°ç­‰ã€‚éå¸¸å¼ºå¤§ä½†ä¹Ÿå¾ˆå±é™©ã€‚</span><br><span class=\"line\"></span><br><span class=\"line\">--pid=host</span><br><span class=\"line\">    å®¹å™¨å…±äº«å®¿ä¸»æœºçš„è¿›ç¨‹å‘½åç©ºé—´ï¼ˆPID Namespaceï¼‰ã€‚</span><br><span class=\"line\">    è¿™ä½¿å¾—å®¹å™¨å¯ä»¥çœ‹åˆ°å¹¶è®¿é—®å®¿ä¸»æœºçš„æ‰€æœ‰è¿›ç¨‹ï¼ˆåŒ…æ‹¬ PID 1ï¼Œå³ç³»ç»Ÿ init è¿›ç¨‹ï¼‰ã€‚</span><br><span class=\"line\"></span><br><span class=\"line\">debian</span><br><span class=\"line\">    ä½¿ç”¨çš„åŸºç¡€é•œåƒæ˜¯ Debianï¼Œå®¹å™¨é‡Œè¿è¡Œçš„æ˜¯è¿™ä¸ªç³»ç»Ÿã€‚</span><br><span class=\"line\"></span><br><span class=\"line\">nsenter -t 1 -m -u -n -i sh</span><br><span class=\"line\">    è¿™æ˜¯å®¹å™¨å†…éƒ¨è¿è¡Œçš„å‘½ä»¤ï¼Œç”¨æ¥è¿›å…¥å®¿ä¸»æœºçš„å‘½åç©ºé—´ï¼š</span><br><span class=\"line\">        nsenterï¼šLinux å·¥å…·ï¼Œç”¨äºè¿›å…¥å…¶ä»–è¿›ç¨‹çš„å‘½åç©ºé—´ã€‚</span><br><span class=\"line\">        -t 1ï¼šæŒ‡å®šç›®æ ‡è¿›ç¨‹çš„ PID æ˜¯ 1ï¼ˆå®¿ä¸»æœºçš„ init æˆ– systemdï¼‰ã€‚</span><br><span class=\"line\">        -mï¼šè¿›å…¥ç›®æ ‡è¿›ç¨‹çš„ Mount Namespaceï¼ˆæ–‡ä»¶ç³»ç»ŸæŒ‚è½½ï¼‰ã€‚</span><br><span class=\"line\">        -uï¼šè¿›å…¥ç›®æ ‡çš„ UTS Namespaceï¼ˆä¸»æœºåç­‰ï¼‰ã€‚</span><br><span class=\"line\">        -nï¼šè¿›å…¥ç›®æ ‡çš„ Network Namespaceï¼ˆç½‘ç»œï¼‰ã€‚</span><br><span class=\"line\">        -iï¼šè¿›å…¥ç›®æ ‡çš„ IPC Namespaceï¼ˆè¿›ç¨‹é—´é€šä¿¡ï¼‰ã€‚</span><br><span class=\"line\">        shï¼šåœ¨è¿™äº›å‘½åç©ºé—´ä¸­æ‰§è¡Œä¸€ä¸ª shellã€‚</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">è¿™ä¸ªå‘½ä»¤å¯åŠ¨ä¸€ä¸ªåŸºäº Debian çš„å®¹å™¨ï¼Œç»™å®ƒæ‰€æœ‰ç‰¹æƒï¼Œè®©å®ƒèƒ½çœ‹åˆ°å®¿ä¸»æœºçš„è¿›ç¨‹ï¼Œç„¶åä½¿ç”¨ nsenter è¿›å…¥ PID ä¸º 1 çš„æ‰€æœ‰å‘½åç©ºé—´ï¼ˆç›¸å½“äºè¿›å…¥å®¿ä¸»æœºçš„è§†è§’ï¼‰ï¼Œæœ€åå¯åŠ¨ä¸€ä¸ª shï¼Œä½ å°±åœ¨å®¹å™¨é‡Œ â€œå˜æˆäº†å®¿ä¸»æœºâ€ã€‚</li>\n<li class=\"lvl-2\">è¿™æ ·ï¼Œä½ å°±å¯ä»¥åœ¨è¿™ä¸ªå®¹å™¨ä¸­æŸ¥çœ‹<code>/var/lib/docker</code>ç›®å½•äº†ã€‚</li>\n</ul>\n</div>\n<h2 id=\"Docker-çš„-etc-docker-daemon-json-èƒ½é…ç½®å“ªäº›ä¼˜åŒ–é¡¹\">Docker çš„ <code>/etc/docker/daemon.json</code> èƒ½é…ç½®å“ªäº›ä¼˜åŒ–é¡¹</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>é•œåƒåŠ é€Ÿï¼ˆå›½å†…å¸¸ç”¨ï¼‰</p>\n</li>\n</ul>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;registry-mirrors&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">    <span class=\"string\">&quot;https://ä½ çš„åŠ é€Ÿåœ°å€&quot;</span></span><br><span class=\"line\">  <span class=\"punctuation\">]</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æ§åˆ¶æ—¥å¿—æ–‡ä»¶å¤§å°ä¸æ•°é‡ï¼Œé¿å…æ—¥å¿—æ— é™åˆ¶å¢é•¿å¯¼è‡´ç£ç›˜æ‰“æ»¡ã€‚</p>\n</li>\n</ul>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;log-level&quot;</span><span class=\"punctuation\">:</span>  <span class=\"string\">&quot;info&quot;</span><span class=\"punctuation\">,</span> # log-level é…ç½®ä¸º debugã€infoã€warnã€errorã€fatalï¼Œé»˜è®¤ä¸º info</span><br><span class=\"line\">  <span class=\"attr\">&quot;log-driver&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;json-file&quot;</span><span class=\"punctuation\">,</span> # log-driver ä¹Ÿå¯ä»¥é…ç½®ä¸º journaldã€syslogã€none ç­‰ã€‚é»˜è®¤ä¸º json-file</span><br><span class=\"line\">  <span class=\"attr\">&quot;log-opts&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;max-size&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;100m&quot;</span><span class=\"punctuation\">,</span>     #  æ—¥å¿—æ–‡ä»¶å¤§å°</span><br><span class=\"line\">    <span class=\"attr\">&quot;max-file&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;5&quot;</span>         #  æ—¥å¿—æ–‡ä»¶æ•°é‡</span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>é»˜è®¤ç½‘æ¡¥ç½‘æ®µé…ç½®ï¼ˆé¿å…å’Œå®¿ä¸»æœºç½‘æ®µå†²çªï¼‰</p>\n</li>\n</ul>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;bridge&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;docker0&quot;</span><span class=\"punctuation\">,</span>       # è®¾ç½®é»˜è®¤ç½‘æ¡¥åç§°ï¼Œé»˜è®¤docker0</span><br><span class=\"line\">  <span class=\"attr\">&quot;bip&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;192.168.100.1/24&quot;</span><span class=\"punctuation\">,</span>  #  é»˜è®¤<span class=\"number\">172.17</span><span class=\"number\">.0</span><span class=\"number\">.1</span>/<span class=\"number\">16</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;fixed-cidr&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;192.168.100.0/24&quot;</span> # è®¾ç½®å®¹å™¨IPåœ°å€æ®µ</span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>é»˜è®¤ ulimit é™åˆ¶æå‡</p>\n</li>\n</ul>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;default-ulimits&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span>   # é»˜è®¤ulimité™åˆ¶</span><br><span class=\"line\">    <span class=\"attr\">&quot;nofile&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;Name&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;nofile&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;Hard&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">65535</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;Soft&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">65535</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å¹¶å‘è¿æ¥ä¼˜åŒ–</p>\n</li>\n</ul>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;max-concurrent-downloads&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">10</span><span class=\"punctuation\">,</span> # å¹¶å‘ä¸‹è½½æ•°é‡</span><br><span class=\"line\">  <span class=\"attr\">&quot;max-concurrent-uploads&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">5</span>     # å¹¶å‘ä¸Šä¼ æ•°é‡</span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>DNSé…ç½®ï¼ˆæœ‰äº›å…¬å¸å†…ç½‘éœ€è¦ï¼‰</p>\n</li>\n</ul>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;dns&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span><span class=\"string\">&quot;8.8.8.8&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;114.114.114.114&quot;</span><span class=\"punctuation\">]</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ç§æœ‰ä»“åº“å…è®¤è¯é…ç½® (ä¸å»ºè®®ç”Ÿäº§ç”¨)</p>\n</li>\n</ul>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;insecure-registries&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span><span class=\"string\">&quot;registry.example.com:5000&quot;</span><span class=\"punctuation\">]</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>é‡å¯Dockeråæ¢å¤å®¹å™¨ï¼Œå»ºè®®è¿˜æ˜¯ä½¿ç”¨å®¹å™¨çš„<code>restart</code>å‚æ•°</p>\n</li>\n</ul>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;live-restore&quot;</span><span class=\"punctuation\">:</span> <span class=\"literal\"><span class=\"keyword\">true</span></span>  # å½“è®¾ç½®ä¸º<span class=\"literal\"><span class=\"keyword\">true</span></span>æ—¶ï¼ŒDockerä¼šåœ¨å®ˆæŠ¤è¿›ç¨‹å¯åŠ¨æ—¶å°è¯•é‡å¯æ‰€æœ‰ä¹‹å‰è¿è¡Œä¸­çš„å®¹å™¨ï¼Œé»˜è®¤ä¸º<span class=\"literal\"><span class=\"keyword\">false</span></span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>","content_text":"æ‘˜è¦ æœ¬æ–‡ä»‹ç» Linux ä¸‹çš„ Docker å®‰è£…æ–¹æ³•ï¼Œæœ¬æ–‡ä»¥ CentOS 8 ä¸ºä¾‹ã€‚ windowsã€macosã€ubuntuç­‰æ¡Œé¢ç³»ç»Ÿè¯·å®‰è£… Docker Desktopã€‚ é˜¿é‡Œäº‘ä¸“æœ‰æœåŠ¡å™¨å‚è€ƒï¼šé˜¿é‡Œäº‘ä¸“æœ‰æœåŠ¡å™¨å¦‚ä½•å®‰è£…Docker è…¾è®¯äº‘ä¸“æœ‰æœåŠ¡å™¨å‚è€ƒï¼šè…¾è®¯äº‘ä¸“æœ‰æœåŠ¡å™¨å¦‚ä½•å®‰è£…Docker AWSä¸“æœ‰æœåŠ¡å™¨å‚è€ƒï¼šAWSä¸“æœ‰æœåŠ¡å™¨å¦‚ä½•å®‰è£…Docker Dockerå®˜æ–¹æ–‡æ¡£ å®‰è£…Docker Engine Docker ç®€ä»‹ Docker æ˜¯ä¸€ä¸ªå¼€æºçš„å®¹å™¨åŒ–å¹³å°ï¼Œç”¨äºæ‰“åŒ…ã€åˆ†å‘å’Œè¿è¡Œåº”ç”¨ç¨‹åºã€‚å®ƒé€šè¿‡å°†åº”ç”¨ç¨‹åºåŠå…¶ä¾èµ–æ‰“åŒ…åˆ°ä¸€ä¸ªâ€œå®¹å™¨â€ä¸­ï¼Œç¡®ä¿åº”ç”¨åœ¨ä¸åŒç¯å¢ƒä¸­å§‹ç»ˆèƒ½å¤Ÿä¸€è‡´è¿è¡Œã€‚ä¸ä¼ ç»Ÿçš„è™šæ‹Ÿæœºç›¸æ¯”ï¼ŒDocker å®¹å™¨æ›´è½»é‡ã€å¯åŠ¨æ›´å¿«ã€èµ„æºå ç”¨æ›´å°‘ã€‚ Docker é‡‡ç”¨å®¢æˆ·ç«¯-æœåŠ¡å™¨æ¶æ„ï¼Œæ ¸å¿ƒç»„ä»¶åŒ…æ‹¬ Docker Engineï¼ˆè´Ÿè´£æ„å»ºå’Œè¿è¡Œå®¹å™¨ï¼‰ã€Dockerfileï¼ˆå®šä¹‰æ„å»ºé•œåƒçš„æŒ‡ä»¤ï¼‰ã€é•œåƒï¼ˆåº”ç”¨å’Œä¾èµ–çš„åªè¯»æ¨¡æ¿ï¼‰å’Œå®¹å™¨ï¼ˆåŸºäºé•œåƒè¿è¡Œçš„å®ä¾‹ï¼‰ã€‚å¼€å‘è€…å¯ä»¥é€šè¿‡ Docker Hub å…±äº«æˆ–ä¸‹è½½é•œåƒï¼Œæå¤§ç®€åŒ–äº†éƒ¨ç½²æµç¨‹ã€‚ æ€»ç»“æ¥è¯´ï¼ŒDocker æé«˜äº†å¼€å‘æ•ˆç‡ï¼Œæ”¯æŒæŒç»­é›†æˆä¸éƒ¨ç½²ï¼ˆCI/CDï¼‰ï¼Œåœ¨å¾®æœåŠ¡æ¶æ„ä¸­å°¤ä¸ºå¸¸ç”¨ï¼Œæ˜¯ç°ä»£ DevOps æµç¨‹çš„é‡è¦å·¥å…·ã€‚ Dockeræ˜¯ä»€ä¹ˆï¼Ÿ åç§° æè¿° Docker ä»“åº“ï¼ˆRegistryï¼‰ Dockerä»“åº“ç”¨äºå­˜å‚¨Dockeré•œåƒã€‚Docker Hubæ˜¯ä¸€ä¸ªä»»ä½•äººéƒ½å¯ä»¥ä½¿ç”¨çš„å…¬å…±ä»“åº“ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒDockeråœ¨Docker Hubä¸ŠæŸ¥æ‰¾å›¾åƒã€‚ä½ ä¹Ÿå¯ä»¥é…ç½®è‡ªå·±çš„ç§äººä»“åº“ã€‚å½“æ‚¨ä½¿ç”¨docker pullæˆ–docker runå‘½ä»¤æ—¶ï¼ŒDockerä¼šä»æ‚¨é…ç½®çš„ä»“åº“ä¸­æå–æ‰€éœ€çš„é•œåƒã€‚å½“æ‚¨ä½¿ç”¨docker pushå‘½ä»¤æ—¶ï¼ŒDockerä¼šå°†æ‚¨çš„é•œåƒæ¨é€åˆ°å·²é…ç½®çš„ä»“åº“ä¸­ã€‚ Docker å®ˆæŠ¤è¿›ç¨‹ï¼ˆDaemonï¼‰ ç›‘å¬Docker APIè¯·æ±‚ï¼Œå¹¶ç®¡ç†Dockerå¯¹è±¡ï¼Œå¦‚é•œåƒã€å®¹å™¨ã€ç½‘ç»œå’Œå·ã€‚å®ˆæŠ¤ç¨‹åºè¿˜å¯ä»¥ä¸å…¶ä»–å®ˆæŠ¤ç¨‹åºé€šä¿¡æ¥ç®¡ç†DockeræœåŠ¡ã€‚ Docker å®¢æˆ·ç«¯ï¼ˆClientï¼‰ Docker å®¢æˆ·ç«¯ï¼ˆdockerï¼‰æ˜¯è®¸å¤šç”¨æˆ·ä¸ Docker äº¤äº’çš„ä¸»è¦æ–¹å¼ã€‚å½“ä½ ä½¿ç”¨å¦‚ docker run è¿™æ ·çš„å‘½ä»¤æ—¶ï¼Œå®¢æˆ·ç«¯ä¼šå°†è¿™äº›å‘½ä»¤å‘é€ç»™ dockerdï¼ˆDocker å®ˆæŠ¤è¿›ç¨‹ï¼‰ï¼Œç”±å®ƒæ¥æ‰§è¡Œè¿™äº›æ“ä½œã€‚docker å‘½ä»¤æ˜¯é€šè¿‡ Docker API è¿›è¡Œé€šä¿¡çš„ã€‚Docker å®¢æˆ·ç«¯å¯ä»¥ä¸å¤šä¸ªå®ˆæŠ¤è¿›ç¨‹è¿›è¡Œé€šä¿¡ã€‚ Docker ä¸»æœºï¼ˆHostï¼‰ è¿è¡Œ Docker å®ˆæŠ¤è¿›ç¨‹å’Œå®¹å™¨çš„ç‰©ç†æˆ–è™šæ‹Ÿæœºå™¨ã€‚ Docker é•œåƒï¼ˆImagesï¼‰ åˆ›å»ºå®¹å™¨çš„åªè¯»æ¨¡æ¿ï¼ŒåŒ…å«è¿è¡Œåº”ç”¨æ‰€éœ€çš„æ‰€æœ‰æ–‡ä»¶å’Œé…ç½®ã€‚ Docker å®¹å™¨ï¼ˆContainerï¼‰ åŸºäºé•œåƒè¿è¡Œçš„å®ä¾‹ï¼Œæ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªåº”ç”¨çš„ç‹¬ç«‹è¿è¡Œç¯å¢ƒã€‚ Docker å®‰è£… å…¨æ–°å®‰è£…å‰éœ€è¦å…ˆå¸è½½æ—§ç‰ˆæœ¬ï¼Œå¸è½½dockerä¹Ÿå¯ä»¥æŒ‰ç…§å¦‚ä¸‹æ–¹å¼æ“ä½œ 1234567891011121314151617181920212223242526272829# åˆ é™¤Dockerç›¸å…³æºsudo rm -f /etc/yum.repos.d/docker*.repo# åˆ é™¤Dockerç›¸å…³è½¯ä»¶åŒ…ï¼Œdnfå¯èƒ½ä¼šæŠ¥å‘Šæ‚¨æ²¡æœ‰å®‰è£…è¿™äº›è½¯ä»¶åŒ…ã€‚# å¸è½½dockeræ—§ç‰ˆæœ¬sudo dnf -y remove \\ docker \\ docker-client \\ docker-client-latest \\ docker-common \\ docker-latest \\ docker-latest-logrotate \\ docker-logrotate \\ docker-engine# å¸è½½dockeræ–°ç‰ˆæœ¬sudo dnf -y remove \\ docker-ce \\ containerd.io \\ docker-ce-rootless-extras \\ docker-buildx-plugin \\ docker-ce-cli \\ docker-compose-plugin# åˆ é™¤Dockeræ•°æ®,é•œåƒã€å®¹å™¨ã€å·å’Œç½‘ç»œsudo rm -rf /var/lib/dockersudo rm -rf /var/lib/containerd# Dockeræ‰§è¡ŒçŠ¶æ€æ–‡ä»¶çš„å­˜å‚¨è·¯å¾„sudo rm -rf /var/run/docker# åˆ é™¤Dockeré…ç½®sudo rm -rf /etc/docker/ è®¾ç½®dockerå­˜å‚¨åº“ 12345sudo dnf -y install dnf-plugins-core# æµ·å¤–ï¼Œæ·»åŠ Dockerçš„å®˜æ–¹å­˜å‚¨åº“sudo dnf config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo# å›½å†…ï¼Œæ·»åŠ é˜¿é‡Œäº‘çš„å­˜å‚¨åº“sudo dnf config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo å®‰è£… Docker 123456789101112131415161718192021# å®‰è£…æœ€æ–°ç‰ˆæœ¬ï¼Œå‡çº§ docker æ—¶ä¹Ÿæ˜¯æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤sudo dnf -y install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin# å®‰è£…æŒ‡å®šç‰ˆæœ¬# å…ˆæŸ¥çœ‹æ‰€æœ‰ç‰ˆæœ¬sudo dnf list docker-ce --showduplicates | sort -r## è¾“å‡ºdocker-ce.x86_64 3:26.1.3-1.el8 docker-ce-stabledocker-ce.x86_64 3:26.1.3-1.el8 @docker-ce-stabledocker-ce.x86_64 3:26.1.2-1.el8 docker-ce-stabledocker-ce.x86_64 3:26.1.1-1.el8 docker-ce-stabledocker-ce.x86_64 3:26.1.0-1.el8 docker-ce-stableâ€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦# å®‰è£…æŒ‡å®šç‰ˆæœ¬ï¼Œè¿™é‡Œ VERSION_STRING ä¸ºç‰ˆæœ¬å·ï¼Œä¾‹å¦‚ 3:26.1.3-1.el8sudo dnf install docker-ce-&lt;VERSION_STRING&gt; docker-ce-cli-&lt;VERSION_STRING&gt; containerd.io docker-buildx-plugin docker-compose-plugin -y## æ¯”å¦‚sudo dnf install docker-ce-3:26.1.3-1.el8 docker-ce-cli-3:26.1.3-1.el8 containerd.io docker-buildx-plugin docker-compose-plugin -y## å¦‚æœåªå®‰è£…å®¢æˆ·ç«¯ç”¨äºè¿æ¥è¿œç¨‹ Docker ä¸»æœºsudo dnf install docker-ce-cli docker-buildx-plugin docker-compose-plugin -y ç»„ä»¶åç§° æ˜¯å¦å¿…éœ€ï¼ˆæœ¬åœ°è¿è¡Œ Dockerï¼‰ åŠŸèƒ½ç®€ä»‹ å¤‡æ³¨ docker-ce âœ… æ˜¯ Docker Engine çš„æ ¸å¿ƒï¼ŒåŒ…æ‹¬ dockerdï¼ˆå®ˆæŠ¤è¿›ç¨‹ï¼‰å’Œ dockerï¼ˆCLIï¼‰ å®Œæ•´å®‰è£… Docker æ—¶åŒ…å«æ­¤ç»„ä»¶ docker-ce-cli âœ… æ˜¯ï¼ˆæˆ–å•ç‹¬ç”¨äºè¿œç¨‹æ§åˆ¶ï¼‰ Docker å‘½ä»¤è¡Œå·¥å…·ï¼Œå¦‚ docker run, docker ps, docker build ç­‰ å¯ä»¥ç‹¬ç«‹å®‰è£…ï¼Œåªç”¨äºæ§åˆ¶è¿œç¨‹ Docker ä¸»æœº containerd.io âœ… æ˜¯ï¼ˆæœ¬åœ°è¿è¡Œå®¹å™¨ï¼‰ å®¹å™¨è¿è¡Œæ—¶ï¼ŒDocker åç«¯ç”¨äºçœŸæ­£å¯åŠ¨/ç®¡ç†å®¹å™¨ å¦‚æœä½ åªä½¿ç”¨ Docker CLIï¼Œä¸è¿è¡Œæœ¬åœ°å®¹å™¨åˆ™ä¸éœ€è¦ docker-buildx-plugin âŒ å¦ æä¾› docker buildx å‘½ä»¤ï¼Œæ”¯æŒé«˜çº§æ„å»ºç‰¹æ€§ï¼ˆå¦‚è·¨å¹³å°ã€å¤šé˜¶æ®µæ„å»ºï¼‰ å¯é€‰ï¼Œé€‚åˆé«˜çº§æ„å»ºéœ€æ±‚ docker-compose-plugin âŒ å¦ æä¾› docker compose å‘½ä»¤ï¼Œç”¨äºç¼–æ’å¤šä¸ªæœåŠ¡ å¦‚æœä½¿ç”¨ Composeï¼Œåˆ™å»ºè®®å®‰è£…æ­¤æ’ä»¶ å¯åŠ¨ Docker 123456# è®¾ç½®Dockerå®ˆæŠ¤è¿›ç¨‹åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶è‡ªåŠ¨å¯åŠ¨sudo systemctl enable docker# å¯åŠ¨Dockersudo systemctl start docker# æŸ¥çœ‹ docker daemon æ—¥å¿—ï¼Œ-f: æŒç»­è·Ÿè¸ªsudo journalctl -u docker -f æ·»åŠ å½“å‰ç”¨æˆ·åˆ°dockerç»„ 12345# æ·»åŠ å½“å‰ç”¨æˆ·åˆ°dockerç»„ï¼Œè¿™æ ·å½“å‰ç”¨æˆ·å°±å¯ä»¥ä¸éœ€è¦ä½¿ç”¨sudoå°±èƒ½ä½¿ç”¨dockerå‘½ä»¤# å½“å‰ç”¨æˆ·æ˜¯centossudo usermod -aG docker centos# è®©ç»„æƒé™ç«‹å³ç”Ÿæ•ˆæœ€ç¨³å¦¥çš„åšæ³•æ˜¯ï¼šæ³¨é”€å¹¶é‡æ–°ç™»å½•è¿œç¨‹ä¸»æœºï¼Œä½†ä¹Ÿå¯ä»¥å°è¯•ç”¨ä¸‹é¢å‘½ä»¤ç«‹å³åŠ è½½æ–°ç»„newgrp docker éªŒè¯ Docker å®‰è£… 12345docker version # æŸ¥çœ‹ Docker version# æ˜¾ç¤º Docker åŸºæœ¬ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç‰ˆæœ¬ä¿¡æ¯ï¼Œæ’ä»¶ä¿¡æ¯ï¼Œé•œåƒåŠ é€Ÿä¿¡æ¯ç­‰ç­‰ã€‚docker info# æ‹‰å–hello-worldé•œåƒï¼Œæ­¤æ—¶å›½å†…ä¼šæç¤ºè®¿é—®å¤±è´¥ï¼Œéœ€è¦æ·»åŠ å›½å†…é•œåƒæºdocker pull hello-world æ·»åŠ å›½å†…é•œåƒæº ç›®å‰å›½å†…å¤§éƒ¨åˆ†çš„Dockeré•œåƒæºéƒ½å…³é—­äº†ï¼Œå¦å¤–é˜¿é‡Œäº‘çš„Dockeré•œåƒæºåªå…è®¸åœ¨é˜¿é‡Œäº‘çš„æœºå™¨ä¸Šä½¿ç”¨ã€‚ å‚è€ƒï¼šDocker/DockerHub å›½å†…é•œåƒæº/åŠ é€Ÿåˆ—è¡¨,å›½å†… Docker æœåŠ¡çŠ¶æ€ &amp; é•œåƒåŠ é€Ÿç›‘æ§ æ³¨æ„ï¼šå›½å†…é•œåƒæºçš„æ›´æ–°ä¼šæ¯”å®˜ç½‘æ»åï¼Œä½†åªè¦ä¸æ˜¯è·å–æœ€æ–°ç‰ˆæœ¬åŸºæœ¬ä¸Šæ˜¯å¤Ÿç”¨çš„ã€‚ 123456789101112131415161718sudo tee /etc/docker/daemon.json &lt;&lt;EOF&#123; &quot;registry-mirrors&quot;: [ &quot;https://docker.1ms.run&quot;, &quot;https://docker.xuanyuan.me&quot;, &quot;https://docker.m.daocloud.io&quot; ]&#125;EOF# é‡å¯Dockersudo systemctl daemon-reloadsudo systemctl restart docker# å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹æ˜¯å¦é…ç½®ç”Ÿæ•ˆï¼ŒæŸ¥çœ‹ Registry Mirrors ä¸­çš„é…ç½®docker info# éªŒè¯å›½å†…é•œåƒæºdocker pull hello-world Dockerå‘½ä»¤è‡ªåŠ¨è¡¥å…¨ï¼Œå‚è€ƒï¼šå®˜æ–¹æ–‡æ¡£ 1234567891011121314151617181920# ä½¿ç”¨çš„bash# å®‰è£…bash-completionsudo dnf install bash-completion -y# æ·»åŠ è‡ªåŠ¨è¡¥å…¨åˆ°å½“å‰ç™»å½•ç”¨æˆ·cat &lt;&lt;EOT &gt;&gt; ~/.bashrcif [ -f /etc/bash_completion ]; then . /etc/bash_completionfiEOT# åˆ·æ–°bashsource ~/.bashrc# åˆ›å»ºè‡ªåŠ¨è¡¥å…¨æ–‡ä»¶mkdir -p ~/.local/share/bash-completion/completionsdocker completion bash &gt; ~/.local/share/bash-completion/completions/docker# å¯åŠ¨ä¸€ä¸ªæ–°çš„bashexec bash /var/lib/docker ç”¨äºå­˜å‚¨ Docker è¿è¡Œæ—¶ç”Ÿæˆçš„æ•°æ®ï¼Œå¦‚é•œåƒã€å®¹å™¨ã€ç½‘ç»œã€å·ã€é…ç½®æ–‡ä»¶ã€æ—¥å¿—ç­‰ï¼Œå…¶ç›®å½•ç»“æ„è¯´æ˜å¦‚ä¸‹ï¼š ç›®å½•å ä½œç”¨è¯´æ˜ buildkit/ å­˜æ”¾ Docker BuildKit æ„å»ºç¼“å­˜å’ŒçŠ¶æ€ä¿¡æ¯ï¼›æ„å»ºé•œåƒæ—¶çš„ä¸­é—´æ–‡ä»¶å’Œä¸Šä¸‹æ–‡ä¼šå­˜äºæ­¤ï¼Œç©ºé—´å ç”¨å¯èƒ½è¾ƒå¤§ã€‚ containers/ æ¯ä¸ªå®¹å™¨ä¸€ä¸ªå­ç›®å½•ï¼ŒåŒ…å«é…ç½®æ–‡ä»¶å’Œè¿è¡Œæ—¥å¿—ï¼ˆå¦‚ container.logï¼‰ï¼Œç”¨äºå®¹å™¨çš„è¿è¡ŒçŠ¶æ€è®°å½•å’Œç®¡ç†ã€‚ engine-id å­˜å‚¨ Docker å¼•æ“çš„å”¯ä¸€ IDï¼ŒDocker å®‰è£…æ—¶ç”Ÿæˆï¼Œå¸¸ç”¨äº swarm èŠ‚ç‚¹è¯†åˆ«ã€‚ image/ é•œåƒçš„å…ƒæ•°æ®ï¼ˆä¸å«å®é™… layer æ•°æ®ï¼‰ï¼Œç»„ç»‡é•œåƒçš„ç»“æ„ã€æ ‡ç­¾ã€é©±åŠ¨ç­‰ä¿¡æ¯ã€‚ network/ ç½‘ç»œé…ç½®åŠçŠ¶æ€ä¿¡æ¯ï¼Œå¦‚é»˜è®¤ bridge ç½‘ç»œã€è‡ªå®šä¹‰ç½‘ç»œé…ç½®ç­‰ã€‚ overlay2/ é•œåƒå’Œå®¹å™¨å®é™…çš„æ•°æ®å±‚ï¼ˆoverlay2 æ˜¯å­˜å‚¨é©±åŠ¨ï¼‰ï¼ŒåŒ…å«æ‰€æœ‰è”åˆæ–‡ä»¶ç³»ç»Ÿå±‚ï¼Œæ˜¯ Docker ä¸­æœ€å¤§çš„ç©ºé—´ä½¿ç”¨è€…ã€‚ plugins/ å­˜æ”¾ Docker æ’ä»¶ï¼ˆå¦‚ç½‘ç»œã€å·æ’ä»¶ï¼‰çš„é…ç½®å’Œæ•°æ®ï¼Œä¸€èˆ¬ä¸ºç©ºï¼Œé™¤éä½¿ç”¨äº†æ‰©å±•æ’ä»¶ã€‚ runtimes/ æ”¯æŒçš„ OCI runtime é…ç½®ç›®å½•ï¼Œå¦‚é»˜è®¤çš„ runcï¼Œä¹Ÿå¯èƒ½åŒ…å«å…¶ä»– runtimeï¼ˆå¦‚ kata, gvisorï¼‰ã€‚ swarm/ Docker swarm æ¨¡å¼ä¸‹çš„é›†ç¾¤å…ƒæ•°æ®ä¸èŠ‚ç‚¹çŠ¶æ€ï¼Œä»…åœ¨åˆå§‹åŒ– swarm åå­˜åœ¨å®é™…æ•°æ®ã€‚ tmp/ Docker çš„ä¸´æ—¶æ–‡ä»¶ç›®å½•ï¼Œå¦‚é•œåƒä¸‹è½½ç¼“å­˜ã€æŒ‚è½½æ“ä½œä¸­çš„ä¸´æ—¶æ–‡ä»¶ï¼Œé€šå¸¸å¯ä»¥æ¸…ç†ä½†éœ€å°å¿ƒã€‚ volumes/ Docker å·çš„æ•°æ®ç›®å½•ï¼Œæ¯ä¸ªå·ä¸€ä¸ªå­ç›®å½•ï¼Œå·ä¸­çš„æŒä¹…åŒ–æ•°æ®å®é™…å­˜æ”¾äºæ­¤ã€‚ /var/lib/containerd æ˜¯ Containerd å®ˆæŠ¤è¿›ç¨‹çš„é»˜è®¤æ•°æ®å­˜å‚¨ç›®å½•ã€‚Containerd æ˜¯ Docker å’Œå…¶ä»–å®¹å™¨å¹³å°ï¼ˆå¦‚ Kubernetesï¼‰åº•å±‚çš„ å®¹å™¨è¿è¡Œæ—¶ï¼ˆContainer Runtimeï¼‰ï¼Œè´Ÿè´£æ‹‰å–é•œåƒã€ç®¡ç†å®¹å™¨ç”Ÿå‘½å‘¨æœŸã€æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿç­‰æ“ä½œã€‚å…¶ç›®å½•ç»“æ„è¯´æ˜å¦‚ä¸‹ï¼š ç›®å½•å ä½œç”¨è¯´æ˜ io.containerd.content.v1.content/ å­˜å‚¨é•œåƒ layer çš„å®é™…äºŒè¿›åˆ¶å†…å®¹ï¼ˆblobï¼‰ï¼Œéµå¾ª OCI é•œåƒè§„èŒƒï¼Œæ˜¯é•œåƒå’Œå®¹å™¨æ–‡ä»¶ç³»ç»Ÿçš„æ•°æ®æ¥æºã€‚ io.containerd.metadata.v1.bolt/ ä½¿ç”¨ BoltDB å­˜å‚¨ containerd çš„å…ƒæ•°æ®ï¼ˆå¦‚é•œåƒä¿¡æ¯ã€å®¹å™¨çŠ¶æ€ã€å¿«ç…§å¼•ç”¨ç­‰ï¼‰ï¼Œæ˜¯ containerd çš„æ ¸å¿ƒå…ƒæ•°æ®æ•°æ®åº“ã€‚ io.containerd.runtime.v1.linux/ å­˜å‚¨æ—§ç‰ˆï¼ˆv1 APIï¼‰è¿è¡Œæ—¶å®¹å™¨ä¿¡æ¯ï¼Œç›®å‰å·²é€æ­¥è¢« v2 æ¥å£å–ä»£ï¼Œä»…åœ¨å‘åå…¼å®¹åœºæ™¯ä¸­å­˜åœ¨ã€‚ io.containerd.runtime.v2.task/ å­˜å‚¨ v2 è¿è¡Œæ—¶æ¥å£ä¸‹å®¹å™¨çš„è¿è¡Œæ—¶çŠ¶æ€ï¼Œå¦‚å®¹å™¨è¿›ç¨‹çš„ shimã€PIDã€æ—¥å¿—è·¯å¾„ç­‰ï¼Œæ˜¯å®¹å™¨å®é™…è¿è¡Œæ—¶æ‰€ä¾èµ–çš„ã€‚ io.containerd.snapshotter.v1.native/ ä½¿ç”¨ native æ¨¡å¼å­˜å‚¨çš„å®¹å™¨å¿«ç…§ï¼ˆæ–‡ä»¶ç³»ç»Ÿå±‚ï¼‰ï¼Œç›´æ¥å¤åˆ¶åº•å±‚æ–‡ä»¶ï¼›æ€§èƒ½è¾ƒå·®ï¼Œå ç”¨ç©ºé—´è¾ƒå¤§ï¼Œä¸»è¦ç”¨äºæµ‹è¯•æˆ–ç‰¹å®šç”¨é€”ã€‚ io.containerd.snapshotter.v1.overlayfs/ ä½¿ç”¨ overlayfs æ¨¡å¼å­˜å‚¨å®¹å™¨çš„æ–‡ä»¶ç³»ç»Ÿå¿«ç…§ï¼ˆé•œåƒå±‚å’Œå®¹å™¨å±‚ï¼‰ï¼›è¿™æ˜¯ç”Ÿäº§ç¯å¢ƒé»˜è®¤çš„é«˜æ•ˆå­˜å‚¨é©±åŠ¨ã€‚ tmpmounts/ ä¸´æ—¶æŒ‚è½½ç‚¹ç›®å½•ï¼Œcontainerd ç”¨äºé•œåƒè§£åŒ…ã€ä¸­é—´æ„å»ºè¿‡ç¨‹ä¸­çš„æŒ‚è½½æ“ä½œï¼Œé€šå¸¸æ˜¯æ„å»ºæˆ–è¿è¡Œè¿‡ç¨‹çš„ä¸´æ—¶æ•°æ®ã€‚ MacOS/Windowsä¸‹æ— æ³•æŸ¥çœ‹/var/lib/dockerçš„è§£å†³æ–¹æ³• åœ¨ MacOS/Windows ä¸Šä½¿ç”¨Dockeræ—¶ï¼Œæ˜¯å¯åŠ¨äº†ä¸€ä¸ªè™šæ‹Ÿæœºæ¥è¿è¡Œdockerçš„ï¼Œç”±äºå…¶è¿è¡Œåœ¨è™šæ‹Ÿæœºå†…éƒ¨ï¼Œç›´æ¥æŸ¥æ‰¾/var/lib/dockerè·¯å¾„æ˜¯æ— æ•ˆçš„ã€‚ è§£å†³æ–¹æ³•å¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425262728# å¯åŠ¨ä¸€ä¸ªä¸´æ—¶å®¹å™¨ï¼Œå¹¶è¿›å…¥å…¶å†…éƒ¨docker run --rm -it --privileged --pid=host debian nsenter -t 1 -m -u -n -i sh## è¯´æ˜--it äº¤äº’å¼åœ°è¿è¡Œå®¹å™¨,å¹¶åˆ†é…ä¸€ä¸ªä¼ªç»ˆç«¯--rm é€€å‡ºå®¹å™¨æ—¶ï¼Œè‡ªåŠ¨åˆ é™¤å®¹å™¨--privileged ç»™å®¹å™¨ç‰¹æƒæƒé™ï¼Œè¿™æ„å‘³ç€å®¹å™¨å‡ ä¹æ‹¥æœ‰å®¿ä¸»æœºçš„æ‰€æœ‰èƒ½åŠ›ï¼Œèƒ½è®¿é—® /devã€ä¿®æ”¹å†…æ ¸å‚æ•°ç­‰ã€‚éå¸¸å¼ºå¤§ä½†ä¹Ÿå¾ˆå±é™©ã€‚--pid=host å®¹å™¨å…±äº«å®¿ä¸»æœºçš„è¿›ç¨‹å‘½åç©ºé—´ï¼ˆPID Namespaceï¼‰ã€‚ è¿™ä½¿å¾—å®¹å™¨å¯ä»¥çœ‹åˆ°å¹¶è®¿é—®å®¿ä¸»æœºçš„æ‰€æœ‰è¿›ç¨‹ï¼ˆåŒ…æ‹¬ PID 1ï¼Œå³ç³»ç»Ÿ init è¿›ç¨‹ï¼‰ã€‚debian ä½¿ç”¨çš„åŸºç¡€é•œåƒæ˜¯ Debianï¼Œå®¹å™¨é‡Œè¿è¡Œçš„æ˜¯è¿™ä¸ªç³»ç»Ÿã€‚nsenter -t 1 -m -u -n -i sh è¿™æ˜¯å®¹å™¨å†…éƒ¨è¿è¡Œçš„å‘½ä»¤ï¼Œç”¨æ¥è¿›å…¥å®¿ä¸»æœºçš„å‘½åç©ºé—´ï¼š nsenterï¼šLinux å·¥å…·ï¼Œç”¨äºè¿›å…¥å…¶ä»–è¿›ç¨‹çš„å‘½åç©ºé—´ã€‚ -t 1ï¼šæŒ‡å®šç›®æ ‡è¿›ç¨‹çš„ PID æ˜¯ 1ï¼ˆå®¿ä¸»æœºçš„ init æˆ– systemdï¼‰ã€‚ -mï¼šè¿›å…¥ç›®æ ‡è¿›ç¨‹çš„ Mount Namespaceï¼ˆæ–‡ä»¶ç³»ç»ŸæŒ‚è½½ï¼‰ã€‚ -uï¼šè¿›å…¥ç›®æ ‡çš„ UTS Namespaceï¼ˆä¸»æœºåç­‰ï¼‰ã€‚ -nï¼šè¿›å…¥ç›®æ ‡çš„ Network Namespaceï¼ˆç½‘ç»œï¼‰ã€‚ -iï¼šè¿›å…¥ç›®æ ‡çš„ IPC Namespaceï¼ˆè¿›ç¨‹é—´é€šä¿¡ï¼‰ã€‚ shï¼šåœ¨è¿™äº›å‘½åç©ºé—´ä¸­æ‰§è¡Œä¸€ä¸ª shellã€‚ è¿™ä¸ªå‘½ä»¤å¯åŠ¨ä¸€ä¸ªåŸºäº Debian çš„å®¹å™¨ï¼Œç»™å®ƒæ‰€æœ‰ç‰¹æƒï¼Œè®©å®ƒèƒ½çœ‹åˆ°å®¿ä¸»æœºçš„è¿›ç¨‹ï¼Œç„¶åä½¿ç”¨ nsenter è¿›å…¥ PID ä¸º 1 çš„æ‰€æœ‰å‘½åç©ºé—´ï¼ˆç›¸å½“äºè¿›å…¥å®¿ä¸»æœºçš„è§†è§’ï¼‰ï¼Œæœ€åå¯åŠ¨ä¸€ä¸ª shï¼Œä½ å°±åœ¨å®¹å™¨é‡Œ â€œå˜æˆäº†å®¿ä¸»æœºâ€ã€‚ è¿™æ ·ï¼Œä½ å°±å¯ä»¥åœ¨è¿™ä¸ªå®¹å™¨ä¸­æŸ¥çœ‹/var/lib/dockerç›®å½•äº†ã€‚ Docker çš„ /etc/docker/daemon.json èƒ½é…ç½®å“ªäº›ä¼˜åŒ–é¡¹ é•œåƒåŠ é€Ÿï¼ˆå›½å†…å¸¸ç”¨ï¼‰ 12345&#123; &quot;registry-mirrors&quot;: [ &quot;https://ä½ çš„åŠ é€Ÿåœ°å€&quot; ]&#125; æ§åˆ¶æ—¥å¿—æ–‡ä»¶å¤§å°ä¸æ•°é‡ï¼Œé¿å…æ—¥å¿—æ— é™åˆ¶å¢é•¿å¯¼è‡´ç£ç›˜æ‰“æ»¡ã€‚ 12345678&#123; &quot;log-level&quot;: &quot;info&quot;, # log-level é…ç½®ä¸º debugã€infoã€warnã€errorã€fatalï¼Œé»˜è®¤ä¸º info &quot;log-driver&quot;: &quot;json-file&quot;, # log-driver ä¹Ÿå¯ä»¥é…ç½®ä¸º journaldã€syslogã€none ç­‰ã€‚é»˜è®¤ä¸º json-file &quot;log-opts&quot;: &#123; &quot;max-size&quot;: &quot;100m&quot;, # æ—¥å¿—æ–‡ä»¶å¤§å° &quot;max-file&quot;: &quot;5&quot; # æ—¥å¿—æ–‡ä»¶æ•°é‡ &#125;&#125; é»˜è®¤ç½‘æ¡¥ç½‘æ®µé…ç½®ï¼ˆé¿å…å’Œå®¿ä¸»æœºç½‘æ®µå†²çªï¼‰ 12345&#123; &quot;bridge&quot;: &quot;docker0&quot;, # è®¾ç½®é»˜è®¤ç½‘æ¡¥åç§°ï¼Œé»˜è®¤docker0 &quot;bip&quot;: &quot;192.168.100.1/24&quot;, # é»˜è®¤172.17.0.1/16 &quot;fixed-cidr&quot;: &quot;192.168.100.0/24&quot; # è®¾ç½®å®¹å™¨IPåœ°å€æ®µ&#125; é»˜è®¤ ulimit é™åˆ¶æå‡ 123456789&#123; &quot;default-ulimits&quot;: &#123; # é»˜è®¤ulimité™åˆ¶ &quot;nofile&quot;: &#123; &quot;Name&quot;: &quot;nofile&quot;, &quot;Hard&quot;: 65535, &quot;Soft&quot;: 65535 &#125; &#125;&#125; å¹¶å‘è¿æ¥ä¼˜åŒ– 1234&#123; &quot;max-concurrent-downloads&quot;: 10, # å¹¶å‘ä¸‹è½½æ•°é‡ &quot;max-concurrent-uploads&quot;: 5 # å¹¶å‘ä¸Šä¼ æ•°é‡&#125; DNSé…ç½®ï¼ˆæœ‰äº›å…¬å¸å†…ç½‘éœ€è¦ï¼‰ 123&#123; &quot;dns&quot;: [&quot;8.8.8.8&quot;, &quot;114.114.114.114&quot;]&#125; ç§æœ‰ä»“åº“å…è®¤è¯é…ç½® (ä¸å»ºè®®ç”Ÿäº§ç”¨) 123&#123; &quot;insecure-registries&quot;: [&quot;registry.example.com:5000&quot;]&#125; é‡å¯Dockeråæ¢å¤å®¹å™¨ï¼Œå»ºè®®è¿˜æ˜¯ä½¿ç”¨å®¹å™¨çš„restartå‚æ•° 123&#123; &quot;live-restore&quot;: true # å½“è®¾ç½®ä¸ºtrueæ—¶ï¼ŒDockerä¼šåœ¨å®ˆæŠ¤è¿›ç¨‹å¯åŠ¨æ—¶å°è¯•é‡å¯æ‰€æœ‰ä¹‹å‰è¿è¡Œä¸­çš„å®¹å™¨ï¼Œé»˜è®¤ä¸ºfalse&#125;","summary":"æ‘˜è¦ æœ¬æ–‡ä»‹ç» Linux ä¸‹çš„ Docker å®‰è£…æ–¹æ³•ï¼Œæœ¬æ–‡ä»¥ CentOS 8 ä¸ºä¾‹ã€‚ windowsã€macosã€ubuntuç­‰æ¡Œé¢ç³»ç»Ÿè¯·å®‰è£… Docker Desktopã€‚ é˜¿é‡Œäº‘ä¸“æœ‰æœåŠ¡å™¨å‚è€ƒï¼šé˜¿é‡Œäº‘ä¸“æœ‰æœåŠ¡å™¨å¦‚ä½•å®‰è£…Docker è…¾è®¯äº‘ä¸“æœ‰æœåŠ¡å™¨å‚è€ƒï¼šè…¾è®¯äº‘ä¸“æœ‰æœåŠ¡å™¨å¦‚ä½•å®‰è£…Docker AWSä¸“æœ‰æœåŠ¡å™¨å‚è€ƒï¼šAWSä¸“æœ‰æœåŠ¡å™¨å¦‚ä½•å®‰è£…Docker Dockerå®˜æ–¹æ–‡æ¡£ å®‰è£…Docker Engine","date_published":"2025-05-20T13:30:05.000Z","tags":["æŠ€æœ¯","docker","docker"]},{"id":"https://blog.hanqunfeng.com/2025/05/19/docker-install-aws/","url":"https://blog.hanqunfeng.com/2025/05/19/docker-install-aws/","title":"AWSä¸“æœ‰æœåŠ¡å™¨å¦‚ä½•å®‰è£…Docker","content_html":"<!--\n **åŠ ç²—**\n *æ–œä½“*\n ***åŠ ç²—å¹¶æ–œä½“***\n ~~åˆ é™¤çº¿~~\n ==çªå‡ºæ˜¾ç¤º==\n `çªå‡ºæ˜¾ç¤º(æ¨è)`\n ++ä¸‹åˆ’çº¿++\n ~ä¸‹æ ‡~\n ^ä¸Šæ ‡^\n è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference.\n å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)\n\n +++ **ç‚¹å‡»æŠ˜å **\n è¿™æ˜¯è¢«éšè—çš„å†…å®¹\n +++\n\n::: tips success warning danger\nè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹\n:::\n\n% note info % success warning danger\nè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹\n% endnote %\n\nå¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{}\n å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ\n -->\n<h2 id=\"æ‘˜è¦\">æ‘˜è¦</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æœ¬æ–‡ä»‹ç»å¦‚ä½•åœ¨ AWS ä¸“æœ‰æœåŠ¡å™¨ä¸Šå®‰è£… Docker</p>\n</li>\n</ul>\n<span id=\"more\"></span>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Update and install Docker</span></span><br><span class=\"line\"><span class=\"built_in\">sudo</span> yum update -y</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Amazon Linux 2</span></span><br><span class=\"line\"><span class=\"built_in\">sudo</span> amazon-linux-extras install docker -y</span><br><span class=\"line\"><span class=\"comment\"># Amazon Linux 2023</span></span><br><span class=\"line\"><span class=\"built_in\">sudo</span> yum install docker -y</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Install Docker Composeï¼Œæ³¨æ„é€šè¿‡è¿™ç§æ–¹å¼å®‰è£…çš„composeçš„ä½¿ç”¨æ–¹å¼ä¸º `docker-compose`ï¼Œè€Œéæ ‡å‡†çš„ `docker compose`</span></span><br><span class=\"line\"><span class=\"built_in\">sudo</span> curl -L <span class=\"string\">&quot;https://github.com/docker/compose/releases/latest/download/docker-compose-<span class=\"subst\">$(uname -s)</span>-<span class=\"subst\">$(uname -m)</span>&quot;</span> -o /usr/local/bin/docker-compose</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Make the docker-compose command available</span></span><br><span class=\"line\"><span class=\"built_in\">sudo</span> <span class=\"built_in\">chmod</span> +x /usr/local/bin/docker-compose</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Enable Docker service</span></span><br><span class=\"line\"><span class=\"built_in\">sudo</span> systemctl <span class=\"built_in\">enable</span> docker</span><br><span class=\"line\"><span class=\"comment\"># Start the service</span></span><br><span class=\"line\"><span class=\"built_in\">sudo</span> systemctl start docker</span><br><span class=\"line\"><span class=\"comment\"># Add the current user to the docker group</span></span><br><span class=\"line\"><span class=\"built_in\">sudo</span> usermod -aG docker ec2-user</span><br><span class=\"line\"><span class=\"comment\"># è®©ç»„æƒé™ç«‹å³ç”Ÿæ•ˆæœ€ç¨³å¦¥çš„åšæ³•æ˜¯ï¼šæ³¨é”€å¹¶é‡æ–°ç™»å½•è¿œç¨‹ä¸»æœºï¼Œä½†ä¹Ÿå¯ä»¥å°è¯•ç”¨ä¸‹é¢å‘½ä»¤ç«‹å³åŠ è½½æ–°ç»„</span></span><br><span class=\"line\">newgrp docker</span><br><span class=\"line\"><span class=\"comment\"># Check Docker version</span></span><br><span class=\"line\">docker version</span><br><span class=\"line\"><span class=\"comment\"># Test Docker</span></span><br><span class=\"line\">docker run hello-world</span><br></pre></td></tr></table></figure>","content_text":"æ‘˜è¦ æœ¬æ–‡ä»‹ç»å¦‚ä½•åœ¨ AWS ä¸“æœ‰æœåŠ¡å™¨ä¸Šå®‰è£… Docker 12345678910111213141516171819202122232425262728# Update and install Dockersudo yum update -y# Amazon Linux 2sudo amazon-linux-extras install docker -y# Amazon Linux 2023sudo yum install docker -y# Install Docker Composeï¼Œæ³¨æ„é€šè¿‡è¿™ç§æ–¹å¼å®‰è£…çš„composeçš„ä½¿ç”¨æ–¹å¼ä¸º `docker-compose`ï¼Œè€Œéæ ‡å‡†çš„ `docker compose`sudo curl -L &quot;https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)&quot; -o /usr/local/bin/docker-compose# Make the docker-compose command availablesudo chmod +x /usr/local/bin/docker-compose# Enable Docker servicesudo systemctl enable docker# Start the servicesudo systemctl start docker# Add the current user to the docker groupsudo usermod -aG docker ec2-user# è®©ç»„æƒé™ç«‹å³ç”Ÿæ•ˆæœ€ç¨³å¦¥çš„åšæ³•æ˜¯ï¼šæ³¨é”€å¹¶é‡æ–°ç™»å½•è¿œç¨‹ä¸»æœºï¼Œä½†ä¹Ÿå¯ä»¥å°è¯•ç”¨ä¸‹é¢å‘½ä»¤ç«‹å³åŠ è½½æ–°ç»„newgrp docker# Check Docker versiondocker version# Test Dockerdocker run hello-world","summary":"æ‘˜è¦ æœ¬æ–‡ä»‹ç»å¦‚ä½•åœ¨ AWS ä¸“æœ‰æœåŠ¡å™¨ä¸Šå®‰è£… Docker","date_published":"2025-05-19T13:30:05.000Z","tags":["æŠ€æœ¯","docker","docker"]},{"id":"https://blog.hanqunfeng.com/2025/05/13/jvm-tools-01/","url":"https://blog.hanqunfeng.com/2025/05/13/jvm-tools-01/","title":"JVM ä¹‹ å‘½ä»¤è¡Œå·¥å…·","content_html":"<!--\n **åŠ ç²—**\n *æ–œä½“*\n ***åŠ ç²—å¹¶æ–œä½“***\n ~~åˆ é™¤çº¿~~\n ==çªå‡ºæ˜¾ç¤º==\n `çªå‡ºæ˜¾ç¤º(æ¨è)`\n ++ä¸‹åˆ’çº¿++\n ~ä¸‹æ ‡~\n ^ä¸Šæ ‡^\n è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference.\n å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)\n\n +++ **ç‚¹å‡»æŠ˜å **\n è¿™æ˜¯è¢«éšè—çš„å†…å®¹\n +++\n\n::: tips success warning danger\nè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹\n:::\n\n% note info % success warning danger\nè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹\n% endnote %\n\nå¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{}\n å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ\n -->\n<h2 id=\"æ‘˜è¦\">æ‘˜è¦</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æœ¬æ–‡ä»‹ç»JVMçš„å‘½ä»¤è¡Œå·¥å…·</p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://docs.oracle.com/javase/specs/jvms/se8/html/index.html\">JDK8 The JavaÂ® Virtual Machine Specification</a></p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://docs.oracle.com/javase/8/docs/technotes/tools/unix/java.html\">JDK8çš„javaæŒ‡ä»¤çš„å®˜â½…â½‚æ¡£</a></p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://docs.oracle.com/en/java/javase/17/docs/specs/man/index.html\">JDKâ¼¯å…·å®˜â½¹â½‚æ¡£</a></p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://docs.oracle.com/en/java/javase/17/docs/specs/man/java.html\">JDK17çš„javaæŒ‡ä»¤çš„å®˜â½…â½‚æ¡£</a></p>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"JVM-çš„å‚æ•°-ä¸‰ç±»\">JVM çš„å‚æ•°(ä¸‰ç±»)</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æ ‡å‡†å‚æ•°: ä»¥<code>-</code>å¼€å¤´ï¼Œæ‰€æœ‰ HotSpot éƒ½â½€æŒã€‚ä¾‹å¦‚<code>java -version</code>ã€‚è¿™ç±»å‚æ•°å¯ä»¥ä½¿â½¤<code>java -help</code> æˆ–è€…<code>java -?</code>å…¨éƒ¨æ‰“å°å‡ºæ¥</p>\n</li>\n<li class=\"lvl-2\">\n<p>â¾®æ ‡å‡†å‚æ•°: ä»¥<code>-X</code>å¼€å¤´ï¼Œæ˜¯ç‰¹å®š HotSpotç‰ˆæœ¬â½€æŒçš„æŒ‡ä»¤ã€‚ä¾‹å¦‚<code>java -Xms200M -Xmx200M</code>ã€‚è¿™ç±»æŒ‡ä»¤å¯ä»¥â½¤<code>java -X</code> å…¨éƒ¨æ‰“å°å‡ºæ¥ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>ä¸ç¨³å®šå‚æ•°: è¿™ä¹Ÿæ˜¯ JVMè°ƒä¼˜çš„å™©æ¢¦ã€‚ä»¥<code>-XX</code> å¼€å¤´ï¼Œè¿™äº›å‚æ•°æ˜¯è·Ÿç‰¹å®šHotSpotç‰ˆæœ¬å¯¹åº”çš„ï¼Œå¾ˆæœ‰å¯èƒ½æ¢ä¸ªç‰ˆæœ¬å°±æ²¡æœ‰äº†ã€‚è¯¦ç»†çš„â½‚æ¡£èµ„æ–™ä¹Ÿç‰¹åˆ«å°‘ã€‚JDK8 ä¸­çš„ä»¥ä¸‹â¼ä¸ªæŒ‡ä»¤å¯ä»¥å¸®åŠ©å¼€å‘è€…äº†è§£ JDK8 ä¸­çš„è¿™â¼€ç±»ä¸ç¨³å®šå‚æ•°ã€‚</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">java -XX:+PrintFlagsInitial -version   <span class=\"comment\"># æ‰€æœ‰å‚æ•°çš„é»˜è®¤å€¼</span></span><br><span class=\"line\">java -XX:+PrintFlagsFinal -version      <span class=\"comment\"># æ‰€æœ‰å‚æ•°æœ€ç»ˆâ½£æ•ˆçš„å€¼ã€‚</span></span><br><span class=\"line\">java -XX:+UnlockExperimentalVMOptions -XX:+PrintFlagsFinal -version      <span class=\"comment\"># æ‰€æœ‰å‚æ•°æœ€ç»ˆâ½£æ•ˆçš„å€¼ï¼ŒåŒ…å«å®éªŒæ€§å‚æ•°ã€‚</span></span><br><span class=\"line\">java -XX:+PrintCommandLineFlags -version <span class=\"comment\"># å½“å‰å‘½ä»¤ç”Ÿæ•ˆçš„å€¼ï¼Œå¯ä»¥çœ‹åˆ°æ˜¯â½¤çš„å“ªç§GCã€‚ JDK1.8é»˜è®¤â½¤çš„ParallelGC</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"è¿è¡Œ-java-XX-UnlockExperimentalVMOptions-XX-PrintFlagsFinal-version-è¿”å›å€¼è¯´æ˜\">è¿è¡Œ <code>java -XX:+UnlockExperimentalVMOptions -XX:+PrintFlagsFinal -version</code> è¿”å›å€¼è¯´æ˜</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[Global flags]</span><br><span class=\"line\">     intx ActiveProcessorCount                      = -1                                  &#123;product&#125;</span><br><span class=\"line\">    uintx AdaptiveSizeDecrementScaleFactor          = 4                                   &#123;product&#125;</span><br><span class=\"line\">    uintx AdaptiveSizeMajorGCDecayTimeScale         = 10                                  &#123;product&#125;</span><br><span class=\"line\">    uintx AdaptiveSizePausePolicy                   = 0                                   &#123;product&#125;</span><br><span class=\"line\">    uintx AdaptiveSizePolicyCollectionCostMargin    = 50                                  &#123;product&#125;</span><br><span class=\"line\">    uintx AdaptiveSizePolicyInitializingSteps       = 20                                  &#123;product&#125;</span><br><span class=\"line\">    uintx AdaptiveSizePolicyOutputInterval          = 0                                   &#123;product&#125;</span><br><span class=\"line\">    uintx AdaptiveSizePolicyWeight                  = 10                                  &#123;product&#125;</span><br><span class=\"line\">    uintx AdaptiveSizeThroughPutPolicy              = 0                                   &#123;product&#125;</span><br><span class=\"line\">    uintx AdaptiveTimeWeight                        = 25                                  &#123;product&#125;</span><br><span class=\"line\">     bool AdjustConcurrency                         = <span class=\"literal\">false</span>                               &#123;product&#125;</span><br><span class=\"line\">     bool AggressiveHeap                            = <span class=\"literal\">false</span>                               &#123;product&#125;</span><br><span class=\"line\">     bool AggressiveOpts                            = <span class=\"literal\">false</span>                               &#123;product&#125;</span><br><span class=\"line\">     intx AliasLevel                                = 3                                   &#123;C2 product&#125;</span><br><span class=\"line\">     â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦</span><br><span class=\"line\"><span class=\"comment\"># æ ¼å¼ï¼šflagç±»å‹ï¼Œflagåç§°ï¼Œflagå€¼ï¼Œflagæ¥æºä¸ä½œç”¨åŸŸä¿®é¥°ç¬¦</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>flagç±»å‹:</p>\n</li>\n</ul>\n<blockquote>\n<p>jdk8</p>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th>æ ‡è¯†ç¬¦</th>\n<th>å«ä¹‰</th>\n<th>æè¿°è¯´æ˜</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>intx</code></td>\n<td>æœ‰ç¬¦å·æ•´æ•°ï¼ˆint extendedï¼‰</td>\n<td>ç”¨äºè¡¨ç¤ºå¸¦ç¬¦å·æ•´æ•°å‹å‚æ•°</td>\n</tr>\n<tr>\n<td><code>uintx</code></td>\n<td>æ— ç¬¦å·æ•´æ•°ï¼ˆunsigned int extendedï¼‰</td>\n<td>è¡¨ç¤ºéè´Ÿæ•´æ•°å‹å‚æ•°</td>\n</tr>\n<tr>\n<td><code>uint64_t</code></td>\n<td>æ— ç¬¦å· 64 ä½æ•´æ•°</td>\n<td>é€‚ç”¨äºéœ€è¦æ›´å¤§æ•´æ•°å€¼çš„å‚æ•°ï¼Œæ¯”å¦‚å†…å­˜å¤§å°ã€çº³ç§’æ—¶é—´æˆ³ç­‰</td>\n</tr>\n<tr>\n<td><code>bool</code></td>\n<td>å¸ƒå°”å‹</td>\n<td><code>true</code> æˆ– <code>false</code>ï¼Œè¡¨ç¤ºå¼€å…³å‹å‚æ•°ã€‚<code>+</code>è¡¨ç¤ºå¼€å¯ï¼Œ<code>-</code>è¡¨ç¤ºå…³é—­ã€‚ å¦‚ <code>-XX:+UseG1GC</code>ï¼Œè¡¨ç¤ºå¼€å¯ G1 å›æ”¶å™¨åŠŸèƒ½ã€‚</td>\n</tr>\n<tr>\n<td><code>double</code></td>\n<td>åŒç²¾åº¦æµ®ç‚¹å‹</td>\n<td>ç”¨äºè¡¨ç¤ºæµ®ç‚¹æ•°å€¼ç±»å‹çš„ JVM å‚æ•°</td>\n</tr>\n<tr>\n<td><code>ccstr</code></td>\n<td>å¸¸é‡ C å­—ç¬¦ä¸²æŒ‡é’ˆ</td>\n<td>è¡¨ç¤ºå­—ç¬¦ä¸²å‚æ•°ï¼ˆä¸å¯å˜ï¼‰</td>\n</tr>\n<tr>\n<td><code>ccstrlist</code></td>\n<td>C å­—ç¬¦ä¸²åˆ—è¡¨</td>\n<td>è¡¨ç¤ºä»¥é€—å·åˆ†éš”çš„å­—ç¬¦ä¸²åˆ—è¡¨</td>\n</tr>\n</tbody>\n</table>\n<blockquote>\n<p>jdk11åå‡ºç°æ›´å¤šçš„ç±»å‹</p>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th>æ ‡è¯†ç¬¦</th>\n<th>å«ä¹‰</th>\n<th>æè¿°è¯´æ˜</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>int</code></td>\n<td>æœ‰ç¬¦å·æ•´æ•°,é€šå¸¸æ˜¯ 32 ä½</td>\n<td>JVM å†…éƒ¨ä½¿ç”¨çš„æ™®é€š int å‚æ•°</td>\n</tr>\n<tr>\n<td><code>uint</code></td>\n<td>æ— ç¬¦å·æ•´æ•°,é€šå¸¸æ˜¯ 32 ä½</td>\n<td>å°‘é‡ç”¨äºç‰¹æ®Šåœºæ™¯çš„å‚æ•°</td>\n</tr>\n<tr>\n<td><code>size_t</code></td>\n<td>å†…å­˜å¤§å°</td>\n<td>è¡¨ç¤ºå†…å­˜å¤§å°å‚æ•°ï¼ˆå•ä½ä¸€èˆ¬ä¸ºå­—èŠ‚ï¼‰,jdk11åå‡ºç°ï¼ŒåŸæ¥æ˜¯ <code>uintx</code></td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>flagæ¥æºä¸ä½œç”¨åŸŸä¿®é¥°ç¬¦</p>\n</li>\n</ul>\n<blockquote>\n<p>jdk8</p>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th>æ ‡è®°</th>\n<th>å«ä¹‰</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>&#123;product&#125;</code></td>\n<td>æ­£å¼äº§å“å‚æ•°ï¼ˆç”¨æˆ·å¯ç”¨ï¼Œå¯é€šè¿‡ <code>-XX:</code> è¿›è¡Œè®¾ç½®ï¼‰</td>\n</tr>\n<tr>\n<td><code>&#123;pd product&#125;</code></td>\n<td>å¹³å°ç›¸å…³çš„æ­£å¼å‚æ•°ï¼ˆplatform-dependentï¼‰ï¼Œåœ¨æŸäº›æ“ä½œç³»ç»Ÿ/CPU ä¸Šå¯ç”¨</td>\n</tr>\n<tr>\n<td><code>&#123;C1 product&#125;</code></td>\n<td>ä»…åœ¨ä½¿ç”¨ <strong>C1 ç¼–è¯‘å™¨ï¼ˆä¼˜åŒ–ç¼–è¯‘å™¨ï¼‰</strong> æ—¶æœ‰æ•ˆçš„å‚æ•°</td>\n</tr>\n<tr>\n<td><code>&#123;C2 product&#125;</code></td>\n<td>ä»…åœ¨ä½¿ç”¨ <strong>C2 ç¼–è¯‘å™¨ï¼ˆä¼˜åŒ–ç¼–è¯‘å™¨ï¼‰</strong> æ—¶æœ‰æ•ˆçš„å‚æ•°</td>\n</tr>\n<tr>\n<td><code>&#123;manageable&#125;</code></td>\n<td>å¯é€šè¿‡ JMX åŠ¨æ€ç®¡ç†çš„å‚æ•°ï¼ˆè¿è¡Œæ—¶å¯è°ƒæ•´ï¼‰</td>\n</tr>\n<tr>\n<td><code>&#123;ARCH product&#125;</code></td>\n<td>ä¸ CPU æ¶æ„ç›¸å…³çš„äº§å“å‚æ•°ï¼ˆå¦‚ x86ã€ARM ç­‰ï¼‰</td>\n</tr>\n<tr>\n<td><code>&#123;lp64_product&#125;</code></td>\n<td>ä»…åœ¨ 64 ä½ JVM ä¸Šæ‰æœ‰æ•ˆçš„äº§å“å‚æ•°</td>\n</tr>\n<tr>\n<td><code>&#123;experimental&#125;</code></td>\n<td>å®éªŒæ€§çš„ å‚æ•°ï¼Œå¯èƒ½åœ¨å°†æ¥çš„ç‰ˆæœ¬ä¸­åˆ é™¤æˆ–æ›´æ”¹ã€‚éœ€è¦å¼€å¯ -XX:+UnlockExperimentalVMOptions</td>\n</tr>\n</tbody>\n</table>\n<blockquote>\n<p>jdk11åå‡ºç°æ›´å¤šçš„ç±»å‹</p>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th>æ ‡è®°</th>\n<th>å«ä¹‰</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>&#123;C1 pd product&#125;</code></td>\n<td>å¹³å°ç›¸å…³çš„æ­£å¼å‚æ•°,ä»…åœ¨ä½¿ç”¨ <strong>C1 ç¼–è¯‘å™¨ï¼ˆä¼˜åŒ–ç¼–è¯‘å™¨ï¼‰</strong> æ—¶æœ‰æ•ˆçš„å‚æ•°</td>\n</tr>\n<tr>\n<td><code>&#123;C2 pd product&#125;</code></td>\n<td>å¹³å°ç›¸å…³çš„æ­£å¼å‚æ•°,ä»…åœ¨ä½¿ç”¨ <strong>C2 ç¼–è¯‘å™¨ï¼ˆä¼˜åŒ–ç¼–è¯‘å™¨ï¼‰</strong> æ—¶æœ‰æ•ˆçš„å‚æ•°</td>\n</tr>\n<tr>\n<td><code>&#123;JVMCI product&#125;</code></td>\n<td>æ­¤å‚æ•°é€‚ç”¨äº JVMCI æˆ– Graal ç¼–è¯‘å™¨ç›¸å…³åŠŸèƒ½ï¼Œjdk21æ·»åŠ </td>\n</tr>\n</tbody>\n</table>\n<blockquote>\n<p>å¦å¤–ï¼Œjdk11+ ä¸­ï¼Œæœ€åè¿˜ä¼šå¤šå‡ºä¸€åˆ—ï¼Œå…¶ä½œç”¨æ˜¯è¯´æ˜è¯¥å‚æ•°çš„è®¾ç½®æ¥æº</p>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th>æ¥æºæ ‡è¯†</th>\n<th>å«ä¹‰è¯´æ˜</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>&#123;default&#125;</code></td>\n<td>ä½¿ç”¨çš„æ˜¯è¯¥å‚æ•°çš„é»˜è®¤å€¼ï¼ˆæ²¡æœ‰è¢«ç”¨æˆ·æˆ–ç³»ç»Ÿè®¾ç½®ï¼‰</td>\n</tr>\n<tr>\n<td><code>&#123;command line&#125;</code></td>\n<td>ç”¨æˆ·é€šè¿‡å‘½ä»¤è¡Œæ˜¾å¼è®¾ç½®çš„å‚æ•°ï¼ˆå¦‚ <code>-XX:+UseG1GC</code>ï¼‰</td>\n</tr>\n<tr>\n<td><code>&#123;ergonomic&#125;</code></td>\n<td>JVM æ ¹æ®ç³»ç»Ÿç¯å¢ƒè‡ªåŠ¨é€‰æ‹©çš„å€¼ï¼ˆè‡ªé€‚åº”è®¾ç½®ï¼‰</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"jps-æŸ¥çœ‹å½“å‰jvmä¸­çš„è¿›ç¨‹\">jps: æŸ¥çœ‹å½“å‰jvmä¸­çš„è¿›ç¨‹</h2>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹javaè¿›ç¨‹ID</span></span><br><span class=\"line\">jps</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹javaè¿›ç¨‹ä¿¡æ¯ï¼ŒåŒ…æ‹¬IDå’Œå¯åŠ¨ç±»æˆ–jarçš„åç§°</span></span><br><span class=\"line\">jps -l</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹å¯åŠ¨javaè¿›ç¨‹æ—¶ä¼ é€’ç»™jvmçš„å‚æ•°è®¾ç½®</span></span><br><span class=\"line\">jps -v</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹javaè¿›ç¨‹ä¿¡æ¯ï¼ŒåŒæ—¶æ˜¾ç¤ºå¯åŠ¨javaè¿›ç¨‹æ—¶ä¼ é€’ç»™jvmçš„å‚æ•°è®¾ç½®</span></span><br><span class=\"line\">jps -lv</span><br></pre></td></tr></table></figure>\n<h2 id=\"jinfo-æŸ¥çœ‹JVMå‚æ•°\">jinfo: æŸ¥çœ‹JVMå‚æ•°</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>jinfo æ˜¯ JDK è‡ªå¸¦çš„å‘½ä»¤è¡Œå·¥å…·ä¹‹ä¸€ï¼Œç”¨äº æŸ¥çœ‹å’Œä¿®æ”¹æ­£åœ¨è¿è¡Œä¸­çš„ Java è¿›ç¨‹çš„é…ç½®ä¿¡æ¯ï¼Œä¸»è¦åŒ…æ‹¬ JVM å‚æ•°ã€ç³»ç»Ÿå±æ€§ç­‰ä¿¡æ¯ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>åœ¨ Java 9+ ä¹‹åè¢«æ ‡è®°ä¸º deprecatedï¼Œå»ºè®®æ”¹ç”¨ jcmd æ›¿ä»£</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„ JVM å‚æ•°</span></span><br><span class=\"line\">jinfo &lt;PID&gt;</span><br><span class=\"line\"><span class=\"comment\"># jcmd å‘½ä»¤ï¼Œåˆ†æˆä¸‰ä¸ª</span></span><br><span class=\"line\">jcmd &lt;pid&gt; VM.flags <span class=\"comment\"># VM Flags</span></span><br><span class=\"line\">jcmd &lt;pid&gt; VM.system_properties <span class=\"comment\"># System Properties</span></span><br><span class=\"line\">jcmd &lt;pid&gt; VM.command_line <span class=\"comment\"># Command Line</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹æŒ‡å®šè¿›ç¨‹çš„ç³»ç»Ÿå±æ€§ï¼ˆ-syspropsï¼‰</span></span><br><span class=\"line\">jinfo -sysprops &lt;PID&gt;</span><br><span class=\"line\"><span class=\"comment\"># jcmd å‘½ä»¤</span></span><br><span class=\"line\">jcmd &lt;pid&gt; VM.system_properties</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># åŠ¨æ€ä¿®æ”¹ JVM å‚æ•°ï¼ˆä»…æ”¯æŒéƒ¨åˆ†å‚æ•°ï¼‰</span></span><br><span class=\"line\">jinfo -flag [+|-]&lt;flagname&gt; &lt;pid&gt;</span><br><span class=\"line\"><span class=\"comment\">## ä¾‹ï¼šæ‰“å¼€ GC æ—¥å¿—</span></span><br><span class=\"line\">jinfo -flag +PrintGC &lt;pid&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æ£€æŸ¥æ˜¯å¦å¼€å¯äº†æŸä¸ª JVM ç‰¹æ€§ï¼ˆå¦‚ UseG1GCï¼‰</span></span><br><span class=\"line\">jinfo -flag UseG1GC &lt;pid&gt;</span><br></pre></td></tr></table></figure>\n<h2 id=\"jstat-æŸ¥çœ‹æŒ‡å®šJAVAè¿›ç¨‹çš„è¿è¡ŒçŠ¶æ€\">jstat: æŸ¥çœ‹æŒ‡å®šJAVAè¿›ç¨‹çš„è¿è¡ŒçŠ¶æ€</h2>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹è¿è¡ŒçŠ¶æ€</span></span><br><span class=\"line\">jstat -gc &lt;PID&gt;</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹è¿è¡ŒçŠ¶æ€ï¼Œæ¯éš”5000æ¯«ç§’è¾“å‡ºä¸€æ¬¡ï¼Œå…±è¾“å‡º20æ¬¡</span></span><br><span class=\"line\">jstat -gc &lt;PID&gt; 5000 20</span><br><span class=\"line\"><span class=\"comment\"># è¾“å‡º</span></span><br><span class=\"line\"> S0C    S1C    S0U    S1U      EC       EU        OC         OU       MC     MU    CCSC   CCSU   YGC     YGCT    FGC    FGCT     GCT</span><br><span class=\"line\">512.0  512.0   0.0   224.0  29696.0  27138.2   105984.0   96531.8   122368.0 114450.4 15360.0 14018.9    733    5.099   4      0.833    5.931</span><br><span class=\"line\">512.0  512.0   0.0   224.0  29696.0  27203.9   105984.0   96531.8   122368.0 114450.4 15360.0 14018.9    733    5.099   4      0.833    5.931</span><br><span class=\"line\">512.0  512.0   0.0   224.0  29696.0  27220.4   105984.0   96531.8   122368.0 114450.4 15360.0 14018.9    733    5.099   4      0.833    5.931</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å†…å­˜åŒºç»Ÿè®¡ï¼ˆå•ä½ï¼šKBï¼‰</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>åˆ—å</th>\n<th>å«ä¹‰è¯´æ˜</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>S0C</strong></td>\n<td>Survivor 0 åŒºçš„å®¹é‡ï¼ˆKBï¼‰</td>\n</tr>\n<tr>\n<td><strong>S1C</strong></td>\n<td>Survivor 1 åŒºçš„å®¹é‡ï¼ˆKBï¼‰</td>\n</tr>\n<tr>\n<td><strong>S0U</strong></td>\n<td>Survivor 0 åŒºå·²ä½¿ç”¨å†…å­˜ï¼ˆKBï¼‰</td>\n</tr>\n<tr>\n<td><strong>S1U</strong></td>\n<td>Survivor 1 åŒºå·²ä½¿ç”¨å†…å­˜ï¼ˆKBï¼‰</td>\n</tr>\n<tr>\n<td><strong>EC</strong></td>\n<td>Eden åŒºçš„å®¹é‡ï¼ˆKBï¼‰</td>\n</tr>\n<tr>\n<td><strong>EU</strong></td>\n<td>Eden åŒºå·²ä½¿ç”¨å†…å­˜ï¼ˆKBï¼‰</td>\n</tr>\n<tr>\n<td><strong>OC</strong></td>\n<td>Old Generationï¼ˆè€å¹´ä»£ï¼‰çš„å®¹é‡ï¼ˆKBï¼‰</td>\n</tr>\n<tr>\n<td><strong>OU</strong></td>\n<td>Old Generation å·²ä½¿ç”¨å†…å­˜ï¼ˆKBï¼‰</td>\n</tr>\n<tr>\n<td><strong>MC</strong></td>\n<td>Metaspaceï¼ˆå…ƒç©ºé—´ï¼‰çš„å®¹é‡ï¼ˆKBï¼‰</td>\n</tr>\n<tr>\n<td><strong>MU</strong></td>\n<td>Metaspace å·²ä½¿ç”¨å†…å­˜ï¼ˆKBï¼‰</td>\n</tr>\n<tr>\n<td><strong>CCSC</strong></td>\n<td>Compressed Class Space çš„å®¹é‡ï¼ˆKBï¼‰</td>\n</tr>\n<tr>\n<td><strong>CCSU</strong></td>\n<td>Compressed Class Space å·²ä½¿ç”¨å†…å­˜ï¼ˆKBï¼‰</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>GC æ¬¡æ•°ä¸è€—æ—¶(ä»åº”ç”¨ç¨‹åºå¯åŠ¨åˆ°é‡‡æ ·æ—¶)</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>åˆ—å</th>\n<th>å«ä¹‰è¯´æ˜</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>YGC</strong></td>\n<td>Young GCï¼ˆMinor GCï¼‰ çš„ç´¯è®¡æ¬¡æ•°</td>\n</tr>\n<tr>\n<td><strong>YGCT</strong></td>\n<td>Young GC ç´¯è®¡è€—æ—¶ï¼ˆå•ä½ï¼šç§’ï¼‰</td>\n</tr>\n<tr>\n<td><strong>FGC</strong></td>\n<td>Full GC çš„ç´¯è®¡æ¬¡æ•°</td>\n</tr>\n<tr>\n<td><strong>FGCT</strong></td>\n<td>Full GC ç´¯è®¡è€—æ—¶ï¼ˆå•ä½ï¼šç§’ï¼‰</td>\n</tr>\n<tr>\n<td><strong>GCT</strong></td>\n<td>GC æ€»è€—æ—¶ï¼ˆYGCT + FGCTï¼Œæ€»å’Œï¼‰</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"jstack-æŸ¥çœ‹æŒ‡å®šJAVAè¿›ç¨‹ä¸­å„çº¿ç¨‹çš„è°ƒç”¨å †æ ˆ\">jstack: æŸ¥çœ‹æŒ‡å®šJAVAè¿›ç¨‹ä¸­å„çº¿ç¨‹çš„è°ƒç”¨å †æ ˆ</h2>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># æ‰“å°çº¿ç¨‹çš„æ ‡å‡†æ ˆä¿¡æ¯ï¼ˆæ ˆå¸§ + çº¿ç¨‹çŠ¶æ€ï¼‰</span></span><br><span class=\"line\">jstack &lt;PID&gt;</span><br><span class=\"line\"><span class=\"comment\"># åœ¨æ ‡å‡†è¾“å‡ºåŸºç¡€ä¸Šï¼Œé¢å¤–æ‰“å°çº¿ç¨‹æ‹¥æœ‰çš„é”ï¼ˆmonitorï¼‰å’Œ waited on é”å¯¹è±¡ä¿¡æ¯</span></span><br><span class=\"line\">jstack -l &lt;PID&gt;</span><br><span class=\"line\"><span class=\"comment\"># è¾“å‡ºåˆ°æ–‡ä»¶</span></span><br><span class=\"line\">jstack -l &lt;PID&gt; &gt; jstack.tdump <span class=\"comment\"># è¿™ä¸ªæ–‡ä»¶ååç¼€åªæ˜¯ä¸ºäº†æ–¹ä¾¿ jvisualvm æŸ¥çœ‹</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># è¾“å‡º</span></span><br><span class=\"line\"><span class=\"string\">&quot;idle-connection-reaper&quot;</span> <span class=\"comment\">#68 daemon prio=5 os_prio=0 tid=0x00007f38b6ae2800 nid=0x62e9 waiting on condition [0x00007f385b0f5000]</span></span><br><span class=\"line\">   java.lang.Thread.State: TIMED_WAITING (sleeping)</span><br><span class=\"line\">\tat java.lang.Thread.<span class=\"built_in\">sleep</span>(Native Method)</span><br><span class=\"line\">\tat software.amazon.awssdk.http.apache.internal.conn.IdleConnectionReaper<span class=\"variable\">$ReaperTask</span>.run(IdleConnectionReaper.java:151)</span><br><span class=\"line\">\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)</span><br><span class=\"line\">\tat java.util.concurrent.ThreadPoolExecutor<span class=\"variable\">$Worker</span>.run(ThreadPoolExecutor.java:624)</span><br><span class=\"line\">\tat java.lang.Thread.run(Thread.java:750)</span><br><span class=\"line\"></span><br><span class=\"line\">   Locked ownable synchronizers:</span><br><span class=\"line\">\t- &lt;0x00000000c561cfd8&gt; (a java.util.concurrent.ThreadPoolExecutor<span class=\"variable\">$Worker</span>)</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>jstackè¾“å‡ºå†…å®¹å«ä¹‰</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>å­—æ®µ</th>\n<th>å«ä¹‰</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>&quot;idle-connection-reaper&quot;</code></td>\n<td>çº¿ç¨‹åç§°ã€‚è¿™ä¸ªçº¿ç¨‹æ˜¯ AWS SDK ä¸­ç”¨äºæ¸…ç†ç©ºé—²è¿æ¥çš„åå°çº¿ç¨‹ã€‚</td>\n</tr>\n<tr>\n<td><code>#68</code></td>\n<td>çº¿ç¨‹ IDï¼ˆJava å±‚åˆ†é…çš„ç¼–å·ï¼‰ã€‚</td>\n</tr>\n<tr>\n<td><code>daemon</code></td>\n<td>è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ª <strong>å®ˆæŠ¤çº¿ç¨‹</strong>ã€‚JVM é€€å‡ºæ—¶ä¸ä¼šç­‰å¾…å®ˆæŠ¤çº¿ç¨‹è¿è¡Œç»“æŸã€‚</td>\n</tr>\n<tr>\n<td><code>prio=5</code></td>\n<td>Java å±‚çš„çº¿ç¨‹ä¼˜å…ˆçº§ï¼ˆé»˜è®¤ 1â€“10ï¼Œ5 æ˜¯é»˜è®¤ï¼‰ã€‚</td>\n</tr>\n<tr>\n<td><code>os_prio=0</code></td>\n<td>æ“ä½œç³»ç»Ÿå±‚çº¿ç¨‹ä¼˜å…ˆçº§ï¼ˆå–å†³äºæ“ä½œç³»ç»Ÿå’Œ JVM çš„å®ç°ï¼‰ã€‚</td>\n</tr>\n<tr>\n<td><code>tid=0x00007f38b6ae2800</code></td>\n<td>çº¿ç¨‹ IDï¼ˆJava å±‚ä½¿ç”¨çš„åœ°å€æ ‡è¯†ï¼‰ã€‚</td>\n</tr>\n<tr>\n<td><code>nid=0x62e9</code></td>\n<td>Native IDï¼Œæ“ä½œç³»ç»Ÿåˆ†é…çš„çº¿ç¨‹ IDï¼ˆåå…­è¿›åˆ¶è¡¨ç¤ºï¼‰ï¼Œå¯ä»¥é€šè¿‡å‘½ä»¤<code>printf &quot;%d\\n&quot; 0x62e9</code>è½¬æ¢ä¸º10è¿›åˆ¶ã€‚<br>  <code>ps -Lp &lt;PID&gt;</code> å’Œ <code>top -Hp &lt;PID&gt;</code> å±•ç¤ºçš„çº¿ç¨‹idæ˜¯10è¿›åˆ¶</td>\n</tr>\n<tr>\n<td><code>waiting on condition</code></td>\n<td>çº¿ç¨‹çŠ¶æ€è¯´æ˜ï¼šæ­£åœ¨ç­‰å¾…æŸç§æ¡ä»¶ï¼Œä¸€èˆ¬æŒ‡ <code>sleep()</code> æˆ– <code>wait()</code> ç­‰ã€‚</td>\n</tr>\n<tr>\n<td><code>[0x00007f385b0f5000]</code></td>\n<td>æ ˆå¸§çš„å†…å­˜åœ°å€ã€‚</td>\n</tr>\n<tr>\n<td><code>java.lang.Thread.State: TIMED_WAITING (sleeping)</code></td>\n<td>çº¿ç¨‹çŠ¶æ€ã€‚</td>\n</tr>\n<tr>\n<td><code>at java.lang.Thread.sleep(Native Method)</code> <br> â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦</td>\n<td>çº¿ç¨‹è°ƒç”¨æ ˆä¿¡æ¯ï¼ŒåŒ…æ‹¬è°ƒç”¨æ–¹æ³•ã€è°ƒç”¨å‚æ•°ã€è°ƒç”¨æ ˆå¸§ã€‚</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å¦å¤–è¿˜æœ‰å¦‚ä¸‹ä¿¡æ¯ï¼Œè¡¨ç¤ºæ­¤çº¿ç¨‹æŒæœ‰çš„å¯æ‹¥æœ‰åŒæ­¥å™¨ï¼ˆä¾‹å¦‚ ReentrantLockï¼‰ï¼Œå…·ä½“å†…å®¹å¦‚ä¸‹ï¼š</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Locked ownable synchronizers:</span><br><span class=\"line\">\t- &lt;0x00000000c561cfd8&gt; (a java.util.concurrent.ThreadPoolExecutor<span class=\"variable\">$Worker</span>)</span><br></pre></td></tr></table></figure>\n<table>\n<thead>\n<tr>\n<th>å†…å®¹</th>\n<th>å«ä¹‰</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>&lt;0x00000000c561cfd8&gt;</code></td>\n<td>æŒæœ‰é”çš„å¯¹è±¡åœ°å€ã€‚å¯ä»¥åœ¨å…¶ä»–çº¿ç¨‹ä¸­æŸ¥æ‰¾è¿™ä¸ªåœ°å€ï¼Œä»¥åˆ¤æ–­æ­»é”ç­‰é—®é¢˜ã€‚</td>\n</tr>\n<tr>\n<td><code>(a ThreadPoolExecutor$Worker)</code></td>\n<td>è¡¨ç¤ºè¯¥é”å±äº <code>ThreadPoolExecutor</code> çš„æŸä¸ª <code>Worker</code> çº¿ç¨‹ï¼ˆè¿™æ˜¯çº¿ç¨‹æ± çš„å·¥ä½œçº¿ç¨‹ï¼‰ã€‚</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>çº¿ç¨‹çŠ¶æ€</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>çŠ¶æ€</th>\n<th>å«ä¹‰</th>\n<th>å¸¸è§åŸå›  / ç¤ºä¾‹æ–¹æ³•</th>\n<th>ç¤ºä¾‹ jstack è¾“å‡º</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>RUNNABLE</code></td>\n<td>çº¿ç¨‹æ­£åœ¨è¿è¡Œæˆ–å‡†å¤‡è¿è¡Œï¼Œç­‰å¾… CPU æ—¶é—´ç‰‡ã€‚</td>\n<td>çº¿ç¨‹æ´»è·ƒè¿è¡Œä¸­</td>\n<td><code>&quot;Thread-0&quot; #1 prio=5 os_prio=0 tid=0x00007f8d9c001000 nid=0x1a runnable [0x00007f8dbf7fe000]</code></td>\n</tr>\n<tr>\n<td><code>BLOCKED (on object monitor)</code></td>\n<td>ç­‰å¾…è·å–å¯¹è±¡çš„ç›‘è§†å™¨é”ï¼ˆåŒæ­¥é”ï¼‰ï¼Œå³ç­‰å¾…è¿›å…¥åŒæ­¥å—æˆ–æ–¹æ³•ã€‚</td>\n<td><code>synchronized</code> åŒæ­¥å—æˆ–æ–¹æ³•</td>\n<td><code>&quot;Thread-1&quot; #2 prio=5 os_prio=0 tid=0x00007f8d9c002000 nid=0x1b waiting for monitor entry [0x00007f8dbeaff000]</code></td>\n</tr>\n<tr>\n<td><code>WAITING (on object monitor)</code></td>\n<td>æ— é™æœŸç­‰å¾…å…¶ä»–çº¿ç¨‹æ‰§è¡ŒæŸæ“ä½œã€‚</td>\n<td><code>Object.wait()</code><br><code>Thread.join()</code><br><code>LockSupport.park()</code><br><code>Condition.await()</code></td>\n<td><code>&quot;Thread-2&quot; #3 prio=5 os_prio=0 tid=0x00007f8d9c003000 nid=0x1c waiting on condition [0x00007f8dbebff000]</code></td>\n</tr>\n<tr>\n<td><code>TIMED_WAITING (on object monitor)</code></td>\n<td>ç­‰å¾…å›ºå®šæ—¶é—´ï¼Œç›´åˆ°æ¡ä»¶æ»¡è¶³æˆ–è¶…æ—¶ã€‚</td>\n<td><code>Object.wait(long)</code><br><code>Thread.sleep(long)</code><br><code>Condition.awaitNanos(long)</code><br><code>DelayQueue.take()</code></td>\n<td><code>&quot;Thread-3&quot; #4 prio=5 os_prio=0 tid=0x00007f8d9c004000 nid=0x1d timed_waiting [0x00007f8dbebff000]</code></td>\n</tr>\n<tr>\n<td><code>TERMINATED</code></td>\n<td>çº¿ç¨‹å·²è¿è¡Œå®Œæ¯•å¹¶é€€å‡ºï¼ˆé€šå¸¸ä¸åœ¨ jstack ä¸­æ˜¾ç¤ºï¼‰ã€‚</td>\n<td>-</td>\n<td>-</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"ä½¿ç”¨jstackæ£€æŸ¥æ­»é”\">ä½¿ç”¨jstackæ£€æŸ¥æ­»é”</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æ­»é”æ˜¯æŒ‡å¤šä¸ªçº¿ç¨‹äº’ç›¸ç­‰å¾…å¯¹æ–¹é‡Šæ”¾é”ï¼Œå¯¼è‡´æ— æ³•ç»§ç»­è¿è¡Œçš„æƒ…å†µã€‚</p>\n</li>\n</ul>\n<h4 id=\"ç›´æ¥æŸ¥æ‰¾-Found-one-Java-level-deadlock-æç¤º\">ç›´æ¥æŸ¥æ‰¾ <code>Found one Java-level deadlock</code> æç¤º</h4>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Found one Java-level deadlock:</span><br><span class=\"line\">=============================</span><br><span class=\"line\"><span class=\"string\">&quot;Thread-1&quot;</span>:</span><br><span class=\"line\">  waiting to lock monitor 0x0000000005c0a098 (object 0x00000000d5c10a70, a java.lang.Object),</span><br><span class=\"line\">  <span class=\"built_in\">which</span> is held by <span class=\"string\">&quot;Thread-2&quot;</span></span><br><span class=\"line\"><span class=\"string\">&quot;Thread-2&quot;</span>:</span><br><span class=\"line\">  waiting to lock monitor 0x0000000005c0a128 (object 0x00000000d5c10aa0, a java.lang.Object),</span><br><span class=\"line\">  <span class=\"built_in\">which</span> is held by <span class=\"string\">&quot;Thread-1&quot;</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>è¡¨ç¤ºä¸¤ä¸ªçº¿ç¨‹äº’ç›¸ç­‰å¾…å¯¹æ–¹é‡Šæ”¾é”ï¼Œé€ æˆæ­»é”ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>ç›®å‰åªæ”¯æŒæ‰¾å‡º <code>synchronized</code> å…³é”®å­—é˜»å¡ä½çš„çº¿ç¨‹ï¼Œå¦‚æœæ˜¯ <code>java.util.concurrent.Lock</code> ç›®å‰è¿˜ä¸æ”¯æŒã€‚</p>\n</li>\n</ul>\n<h4 id=\"æ‰‹åŠ¨åˆ¤æ–­æ­»é”çš„ç‰¹å¾ï¼ˆå¦‚æœæ²¡æœ‰ä¸Šé¢çš„æç¤ºï¼‰\">æ‰‹åŠ¨åˆ¤æ–­æ­»é”çš„ç‰¹å¾ï¼ˆå¦‚æœæ²¡æœ‰ä¸Šé¢çš„æç¤ºï¼‰</h4>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å¦‚æœ JVM æ²¡æœ‰æ˜¾å¼æç¤ºï¼Œä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹æ­»é”ç‰¹å¾è¿›è¡Œæ‰‹åŠ¨è¯†åˆ«ï¼š</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>ç‰¹å¾</th>\n<th>æè¿°</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>çº¿ç¨‹å¤„äº <code>BLOCKED</code> çŠ¶æ€</td>\n<td>çº¿ç¨‹è¢«é”é˜»å¡åœ¨ <code>monitor</code> ä¸Šã€‚</td>\n</tr>\n<tr>\n<td><code>waiting to lock</code> å’Œ <code>locked</code> å‡ºç°äº¤å‰</td>\n<td>ä¸€ä¸ªçº¿ç¨‹æ­£åœ¨ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹æŒæœ‰çš„é”ï¼Œè€Œå¦ä¸€ä¸ªçº¿ç¨‹ä¹Ÿåœ¨ç­‰å¾…å½“å‰çº¿ç¨‹çš„é”ã€‚</td>\n</tr>\n<tr>\n<td>æ²¡æœ‰èƒ½ç»§ç»­æ‰§è¡Œçš„çº¿ç¨‹</td>\n<td>å¤šä¸ªçº¿ç¨‹éƒ½å¤„äº <code>BLOCKED</code> çŠ¶æ€ï¼Œä¸”ç›¸äº’ä¾èµ–ã€‚</td>\n</tr>\n</tbody>\n</table>\n<div class=\"tips\">\n<p><em><strong>åœ¨ Java 8 ä¹‹åæ”¯æŒè·å– JVM å†…éƒ¨çº¿ç¨‹</strong></em></p>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">VM å†…éƒ¨çº¿ç¨‹åŒ…æ‹¬ä¸‹é¢å‡ ç§ï¼š</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>çº¿ç¨‹ç±»å‹</th>\n<th>ç¤ºä¾‹åç§°</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>JITï¼ˆJust-In-Timeï¼‰ç¼–è¯‘çº¿ç¨‹</td>\n<td>C1 CompilerThread0, C2 CompilerThread0</td>\n</tr>\n<tr>\n<td>GC çº¿ç¨‹</td>\n<td>GC Thread0, G1 Young RemSet Sampling</td>\n</tr>\n<tr>\n<td>å…¶å®ƒå†…éƒ¨çº¿ç¨‹</td>\n<td>VM Periodic Task Thread, VM Thread, Service Thread</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">\n<p>è‡ª JDK 7 åŠä»¥ä¸Šç‰ˆæœ¬å¼€å§‹ï¼ŒHotSpot JVM é»˜è®¤å¯ç”¨äº†ï¼šåˆ†å±‚ç¼–è¯‘ï¼ˆTiered Compilationï¼‰ï¼Œå³åŒæ—¶ä½¿ç”¨ C1 å’Œ C2 ç¼–è¯‘å™¨ã€‚</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>ç¼–è¯‘å™¨</th>\n<th>ç‰¹æ€§</th>\n<th>ç”¨é€”</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>C1ï¼ˆClient Compilerï¼‰</strong></td>\n<td>ç¼–è¯‘é€Ÿåº¦å¿«ï¼Œä¼˜åŒ–å°‘</td>\n<td>ç¨‹åºå¯åŠ¨æ—¶ä½¿ç”¨ï¼Œæå‡å¯åŠ¨é€Ÿåº¦</td>\n</tr>\n<tr>\n<td><strong>C2ï¼ˆServer Compilerï¼‰</strong></td>\n<td>ç¼–è¯‘é€Ÿåº¦æ…¢ï¼Œä¼˜åŒ–å¼º</td>\n<td>çƒ­ç‚¹ä»£ç è¾¾åˆ°ä¸€å®šé—¨æ§›åä½¿ç”¨ï¼Œæå‡é•¿æœŸè¿è¡Œæ€§èƒ½</td>\n</tr>\n</tbody>\n</table>\n<blockquote>\n<p>JVM å¯åŠ¨åï¼Œå…ˆè§£é‡Šæ‰§è¡Œå­—èŠ‚ç ï¼›çƒ­ç‚¹ä»£ç é¦–å…ˆç”± C1 ç¼–è¯‘å™¨å¤„ç†ï¼›å¦‚æœè¿›ä¸€æ­¥å˜çƒ­ï¼Œäº¤ç”± C2 ç¼–è¯‘å™¨ä¼˜åŒ–ï¼›æ•´ä¸ªè¿‡ç¨‹ç”± JVM è‡ªåŠ¨ç®¡ç†ï¼Œä¸éœ€è¦æ‰‹åŠ¨å¹²é¢„ã€‚</p>\n</blockquote>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">\n<p>æ˜¯å¦å¯ä»¥æŒ‡å®šåªç”¨æŸä¸ªç¼–è¯‘å™¨ï¼Ÿæ˜¯çš„ï¼Œä½ å¯ä»¥ç”¨ JVM å‚æ•°æ§åˆ¶ï¼Œä½†çœŸæ²¡å¿…è¦ã€‚</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>å‚æ•°</th>\n<th>å«ä¹‰</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>-client</code></td>\n<td>ä½¿ç”¨ C1 ç¼–è¯‘å™¨ï¼ˆé€‚åˆå¯åŠ¨å¿«ï¼‰</td>\n</tr>\n<tr>\n<td><code>-server</code></td>\n<td>ä½¿ç”¨ C2 ç¼–è¯‘å™¨ï¼ˆé€‚åˆé•¿æ—¶é—´è¿è¡Œçš„æœåŠ¡ï¼‰</td>\n</tr>\n<tr>\n<td><code>-XX:-TieredCompilation</code></td>\n<td>ç¦ç”¨åˆ†å±‚ç¼–è¯‘ï¼Œä»…ä½¿ç”¨ <code>-client</code> æˆ– <code>-server</code> æŒ‡å®šçš„ç¼–è¯‘å™¨</td>\n</tr>\n</tbody>\n</table>\n</div>\n<h2 id=\"jmap-åˆ†æè¿è¡Œä¸­-Java-è¿›ç¨‹çš„å†…å­˜ä½¿ç”¨æƒ…å†µ\">jmap: åˆ†æè¿è¡Œä¸­ Java è¿›ç¨‹çš„å†…å­˜ä½¿ç”¨æƒ…å†µ</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>jmap æ¯”è¾ƒæ¶ˆè€—å†…å­˜ï¼Œæ‰€ä»¥ä¸æ¨èç”Ÿäº§ç¯å¢ƒä½¿ç”¨ã€‚</p>\n</li>\n</ul>\n<h3 id=\"jmap-histo-pid-æŸ¥çœ‹ç±»å®ä¾‹æ•°é‡åŠå ç”¨å†…å­˜\"><code>jmap -histo &lt;pid&gt;</code>: æŸ¥çœ‹ç±»å®ä¾‹æ•°é‡åŠå ç”¨å†…å­˜</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ jmap -histo 25238</span><br><span class=\"line\">25238:</span><br><span class=\"line\"></span><br><span class=\"line\"> num     <span class=\"comment\">#instances         #bytes  class name</span></span><br><span class=\"line\">----------------------------------------------</span><br><span class=\"line\">   1:        106175       10838440  [C</span><br><span class=\"line\">   2:         94344        3019008  java.util.concurrent.ConcurrentHashMap<span class=\"variable\">$Node</span></span><br><span class=\"line\">   3:        105529        2532696  java.lang.String</span><br><span class=\"line\">   4:         11203        2496608  [B</span><br><span class=\"line\">   5:         20178        2430136  [Ljava.lang.Object;</span><br><span class=\"line\">   6:         21642        2399904  java.lang.Class</span><br><span class=\"line\">â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦</span><br><span class=\"line\">Total        857252       51328200</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># num: åºå·</span></span><br><span class=\"line\"><span class=\"comment\"># instances: å®ä¾‹æ•°é‡</span></span><br><span class=\"line\"><span class=\"comment\"># bytes: å®ä¾‹å­—èŠ‚æ•°</span></span><br><span class=\"line\"><span class=\"comment\"># class name: ç±»å, [C is a char[]ï¼Œ[S is a short[]ï¼Œ[I is a int[]ï¼Œ[B is a byte[]ï¼Œ[L is a List</span></span><br><span class=\"line\"><span class=\"comment\"># Total: æ€»æ•°</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"jmap-heap-pid-æŸ¥çœ‹å †ä½¿ç”¨æƒ…å†µ\"><code>jmap -heap &lt;pid&gt;</code>: æŸ¥çœ‹å †ä½¿ç”¨æƒ…å†µ</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ jmap -heap 25238</span><br><span class=\"line\">Attaching to process ID 25238, please <span class=\"built_in\">wait</span>...</span><br><span class=\"line\">Debugger attached successfully.</span><br><span class=\"line\">Server compiler detected.</span><br><span class=\"line\">JVM version is 25.371-b11</span><br><span class=\"line\"></span><br><span class=\"line\">using thread-local object allocation.</span><br><span class=\"line\">Parallel GC with 2 thread(s)</span><br><span class=\"line\"></span><br><span class=\"line\">Heap Configuration:    <span class=\"comment\"># å †é…ç½®</span></span><br><span class=\"line\">   MinHeapFreeRatio         = 0                     <span class=\"comment\"># æœ€å°ç©ºé—²ç™¾åˆ†æ¯”</span></span><br><span class=\"line\">   MaxHeapFreeRatio         = 100                     <span class=\"comment\"># æœ€å¤§ç©ºé—²ç™¾åˆ†æ¯”</span></span><br><span class=\"line\">   MaxHeapSize              = 1010827264 (964.0MB)    <span class=\"comment\"># æœ€å¤§å †å¤§å°</span></span><br><span class=\"line\">   NewSize                  = 21495808 (20.5MB)       <span class=\"comment\"># æ–°ç”Ÿä»£å¤§å°</span></span><br><span class=\"line\">   MaxNewSize               = 336592896 (321.0MB)     <span class=\"comment\"># æ–°ç”Ÿä»£æœ€å¤§å¤§å°</span></span><br><span class=\"line\">   OldSize                  = 43515904 (41.5MB)       <span class=\"comment\"># è€å¹´ä»£å¤§å°</span></span><br><span class=\"line\">   NewRatio                 = 2                       <span class=\"comment\"># æ–°ç”Ÿä»£ä¸è€å¹´ä»£æ¯”ä¾‹</span></span><br><span class=\"line\">   SurvivorRatio            = 8                       <span class=\"comment\"># å¹¸å­˜è€…æ¯”ä¾‹</span></span><br><span class=\"line\">   MetaspaceSize            = 21807104 (20.796875MB)   <span class=\"comment\"># å…ƒç©ºé—´å¤§å°</span></span><br><span class=\"line\">   CompressedClassSpaceSize = 1073741824 (1024.0MB)   <span class=\"comment\"># å‹ç¼©ç±»ç©ºé—´å¤§å°ï¼Œç”¨äºå­˜å‚¨æ‰€æœ‰ ç±»æŒ‡é’ˆï¼ˆKlass pointerï¼‰</span></span><br><span class=\"line\">   MaxMetaspaceSize         = 17592186044415 MB       <span class=\"comment\"># å…ƒç©ºé—´æœ€å¤§å¤§å°</span></span><br><span class=\"line\">   G1HeapRegionSize         = 0 (0.0MB)               <span class=\"comment\"># G1å †å¤§å°</span></span><br><span class=\"line\"></span><br><span class=\"line\">Heap Usage:       <span class=\"comment\"># å †ä½¿ç”¨æƒ…å†µ</span></span><br><span class=\"line\">PS Young Generation <span class=\"comment\"># å¹´è½»ç”Ÿä»£</span></span><br><span class=\"line\">Eden Space:         <span class=\"comment\"># Eden åŒº</span></span><br><span class=\"line\">   capacity = 30932992 (29.5MB)    <span class=\"comment\">#  Eden åŒºå¤§å°</span></span><br><span class=\"line\">   used     = 16705104 (15.931228637695312MB) <span class=\"comment\">#  Eden åŒºä½¿ç”¨æƒ…å†µ</span></span><br><span class=\"line\">   free     = 14227888 (13.568771362304688MB) <span class=\"comment\">#  Eden åŒºå‰©ä½™æƒ…å†µ</span></span><br><span class=\"line\">   54.00416487354343% used                    <span class=\"comment\">#  Eden åŒºä½¿ç”¨ç™¾åˆ†æ¯”</span></span><br><span class=\"line\">From Space:                      <span class=\"comment\"># å¹¸å­˜è€…åŒº survivor0</span></span><br><span class=\"line\">   capacity = 524288 (0.5MB)</span><br><span class=\"line\">   used     = 0 (0.0MB)</span><br><span class=\"line\">   free     = 524288 (0.5MB)</span><br><span class=\"line\">   0.0% used</span><br><span class=\"line\">To Space:                       <span class=\"comment\"># å¹¸å­˜è€…åŒº survivor1</span></span><br><span class=\"line\">   capacity = 524288 (0.5MB)</span><br><span class=\"line\">   used     = 0 (0.0MB)</span><br><span class=\"line\">   free     = 524288 (0.5MB)</span><br><span class=\"line\">   0.0% used</span><br><span class=\"line\">PS Old Generation                <span class=\"comment\"># è€å¹´ä»£</span></span><br><span class=\"line\">   capacity = 193462272 (184.5MB)</span><br><span class=\"line\">   used     = 43292112 (41.28657531738281MB)</span><br><span class=\"line\">   free     = 150170160 (143.2134246826172MB)</span><br><span class=\"line\">   22.377547597497458% used</span><br><span class=\"line\"></span><br><span class=\"line\">38722 interned Strings occupying 4184168 bytes. <span class=\"comment\"># å †ä¸­å­—ç¬¦ä¸²æ•°é‡åŠå ç”¨å†…å­˜</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"jmap-dump-live-format-b-file-file-pid-åˆ›å»ºä¸€ä¸ªå¿«ç…§ï¼Œå¹¶ä¿å­˜åˆ°æ–‡ä»¶ä¸­\"><code>jmap -dump:live,format=b,file=&lt;file&gt; &lt;pid&gt;</code>: åˆ›å»ºä¸€ä¸ªå¿«ç…§ï¼Œå¹¶ä¿å­˜åˆ°æ–‡ä»¶ä¸­</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># åˆ›å»ºä¸€ä¸ªå¿«ç…§ï¼Œå¹¶ä¿å­˜åˆ°å½“å‰ç›®å½•ä¸‹</span></span><br><span class=\"line\">$ jmap -dump:live,format=b,file=test.hprof 25238</span><br><span class=\"line\">Dumping heap to /tmp/test.hprof ...</span><br><span class=\"line\">Heap dump file created</span><br></pre></td></tr></table></figure>\n<h2 id=\"jcmd-å¯ä»¥æ›¿ä»£jmapå‘½ä»¤ï¼Œjdk1-8-æ¨èä½¿ç”¨\">jcmd: å¯ä»¥æ›¿ä»£<code>jmap</code>å‘½ä»¤ï¼Œ<code>jdk1.8+</code>æ¨èä½¿ç”¨</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>jcmd</code> æ˜¯ <code>JDK</code> çš„ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼Œç”¨äºç®¡ç† <code>JVM</code>ï¼Œ<code>jcmd</code> å¯ä»¥æŸ¥çœ‹ <code>JVM</code> çš„è¿è¡ŒçŠ¶æ€ã€æŸ¥çœ‹å †å†…å­˜ä¿¡æ¯ã€è§¦å‘ GCã€æŸ¥çœ‹çº¿ç¨‹ä¿¡æ¯ã€æŸ¥çœ‹ç±»ä¿¡æ¯ç­‰ç­‰ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>ç”Ÿäº§ç¯å¢ƒä¸å»ºè®®ä½¿ç”¨<code>jmap</code>ï¼Œå› å…¶ä¼šå ç”¨å¤§é‡å†…å­˜ï¼Œæ¨èä½¿ç”¨ <code>jcmd</code>ã€‚</p>\n</li>\n</ul>\n<h3 id=\"jcmd-pid-GC-heap-info-æŸ¥çœ‹å †ä½¿ç”¨æƒ…å†µ\"><code>jcmd &lt;pid&gt; GC.heap_info</code>: æŸ¥çœ‹å †ä½¿ç”¨æƒ…å†µ</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ç±»ä¼¼ <code>jmap -heap &lt;pid&gt;</code></p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ jcmd 25238 GC.heap_info</span><br><span class=\"line\">25238:</span><br><span class=\"line\"> PSYoungGen      total 30208K, used 23593K [0x00000000ebf00000, 0x00000000edd80000, 0x0000000100000000)</span><br><span class=\"line\">  eden space 29696K, 78% used [0x00000000ebf00000,0x00000000ed5d2560,0x00000000edc00000)</span><br><span class=\"line\">  from space 512K, 43% used [0x00000000edd00000,0x00000000edd38000,0x00000000edd80000)</span><br><span class=\"line\">  to   space 512K, 0% used [0x00000000edc80000,0x00000000edc80000,0x00000000edd00000)</span><br><span class=\"line\"> ParOldGen       total 105984K, used 96547K [0x00000000c3c00000, 0x00000000ca380000, 0x00000000ebf00000)</span><br><span class=\"line\">  object space 105984K, 91% used [0x00000000c3c00000,0x00000000c9a48f10,0x00000000ca380000)</span><br><span class=\"line\"> Metaspace       used 114450K, capacity 122262K, committed 122368K, reserved 1157120K</span><br><span class=\"line\">  class space    used 14018K, capacity 15294K, committed 15360K, reserved 1048576K</span><br></pre></td></tr></table></figure>\n<h3 id=\"jcmd-pid-GC-class-histogram-æŸ¥çœ‹ç±»åŠ è½½æƒ…å†µ\"><code>jcmd &lt;pid&gt; GC.class_histogram</code>: æŸ¥çœ‹ç±»åŠ è½½æƒ…å†µ</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ç±»ä¼¼ <code>jmap -histo &lt;pid&gt;</code></p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ jcmd 25238 GC.class_histogram</span><br><span class=\"line\">25238:</span><br><span class=\"line\"></span><br><span class=\"line\"> num     <span class=\"comment\">#instances         #bytes  class name</span></span><br><span class=\"line\">----------------------------------------------</span><br><span class=\"line\">   1:        106175       10838440  [C</span><br><span class=\"line\">   2:         94344        3019008  java.util.concurrent.ConcurrentHashMap<span class=\"variable\">$Node</span></span><br><span class=\"line\">   3:        105529        2532696  java.lang.String</span><br><span class=\"line\">   4:         11203        2496608  [B</span><br><span class=\"line\">   5:         20178        2430136  [Ljava.lang.Object;</span><br><span class=\"line\">   6:         21642        2399904  java.lang.Class</span><br><span class=\"line\">â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦</span><br><span class=\"line\">Total        857252       51328200</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># num: åºå·</span></span><br><span class=\"line\"><span class=\"comment\"># instances: å®ä¾‹æ•°é‡</span></span><br><span class=\"line\"><span class=\"comment\"># bytes: å®ä¾‹å­—èŠ‚æ•°</span></span><br><span class=\"line\"><span class=\"comment\"># class name: ç±»å, [C is a char[]ï¼Œ[S is a short[]ï¼Œ[I is a int[]ï¼Œ[B is a byte[]ï¼Œ[L is a List</span></span><br><span class=\"line\"><span class=\"comment\"># Total: æ€»æ•°</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"jcmd-pid-GC-heap-dump-path-to-heap-hprof-å¯¼å‡º-heap-dump\"><code>jcmd &lt;pid&gt; GC.heap_dump /path/to/heap.hprof</code>: å¯¼å‡º heap dump</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æ›¿ä»£ <code>jmap -dump:format=b,file=heap.hprof &lt;pid&gt;</code>ï¼Œä½†ä»ä¼šæœ‰åœé¡¿ï¼ˆè§¦å‘FullGCï¼‰ï¼Œdump è¿‡ç¨‹æ…¢ï¼Œç”Ÿäº§ç¯å¢ƒæ…é‡ä½¿ç”¨</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ jcmd 25238 GC.heap_dump ./heap.hprof</span><br><span class=\"line\">25238:</span><br><span class=\"line\">Heap dump file created</span><br><span class=\"line\"><span class=\"comment\"># æ³¨æ„è¿™é‡Œä½¿ç”¨çš„æ˜¯ç›¸å¯¹ç›®å½•ï¼Œ./heap.hprofï¼Œä½†æ­¤æ—¶ &quot;./&quot; å¹¶ä¸æ˜¯è¿è¡Œå‘½ä»¤æ—¶æ‰€åœ¨çš„ç›®å½•ï¼Œè€Œæ˜¯æŒ‡ Java è¿›ç¨‹çš„å·¥ä½œç›®å½•ï¼Œå¦‚æœä½ ä¸çŸ¥é“å·¥ä½œç›®å½•ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹</span></span><br><span class=\"line\">jcmd &lt;pid&gt; VM.system_properties | grep <span class=\"string\">&quot;user.dir&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># linuxä¸‹ä¹Ÿå¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹</span></span><br><span class=\"line\"><span class=\"built_in\">ls</span> -l /proc/&lt;pid&gt;/cwd</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å› ä¸ºç”Ÿäº§ç¯å¢ƒä¸æ¨èä½¿ç”¨ <code>jmap</code> æˆ– <code>jcmd</code> å¯¼å‡º heap dumpï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨ç”Ÿäº§ç¯å¢ƒä¸­é…ç½®å¦‚ä¸‹jvmå‚æ•°</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-XX:+HeadDumpOnOutOfMemoryError <span class=\"comment\"># å†…å­˜æº¢å‡ºï¼ˆOOMï¼‰æ—¶ä¼šè‡ªåŠ¨ä¿å­˜å †å†…å­˜å¿«ç…§æ–‡ä»¶</span></span><br><span class=\"line\">-XX:HeapDumpPath=/path/to/dump.hprof <span class=\"comment\"># æŒ‡å®šå †å†…å­˜å¿«ç…§æ–‡ä»¶ä¿å­˜è·¯å¾„ï¼Œå¦‚æœä¸é…ç½®ï¼Œåˆ™é»˜è®¤ä¿å­˜åœ¨ Java è¿›ç¨‹çš„å·¥ä½œç›®å½•ä¸‹ï¼Œæ–‡ä»¶åç§°é»˜è®¤ä¸º java_&lt;pid&gt;.hprof</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"jhat-åˆ†æ-Java-Heap-Dump-æ–‡ä»¶ï¼ˆ-hprofï¼‰çš„å·¥å…·\">jhat: åˆ†æ Java Heap Dump æ–‡ä»¶ï¼ˆ.hprofï¼‰çš„å·¥å…·</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>jhatï¼ˆJava Heap Analysis Toolï¼‰æ˜¯ JDK é™„å¸¦çš„ä¸€ä¸ªç”¨äº**åˆ†æ Java Heap Dump æ–‡ä»¶ï¼ˆ.hprofï¼‰**çš„å·¥å…·ã€‚å®ƒå¯ä»¥å°†å †å¿«ç…§ä½œä¸º HTTP æœåŠ¡åŠ è½½ï¼Œå¹¶å…è®¸ä½ é€šè¿‡æµè§ˆå™¨äº¤äº’å¼åœ°æŸ¥çœ‹å’ŒæŸ¥è¯¢å¯¹è±¡ä¿¡æ¯ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼š<br>\nğŸ”º ä» JDK 9 èµ·ï¼Œjhat å·²è¢«å®˜æ–¹åºŸå¼ƒï¼Œæ¨èä½¿ç”¨æ›´å¼ºå¤§çš„å·¥å…·å¦‚ <code>VisualVM</code>ã€<code>Eclipse MAT</code> æˆ– <code>jcmd + å¤–éƒ¨å·¥å…·</code>ã€‚</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># é»˜è®¤ç«¯å£7000</span></span><br><span class=\"line\">jhat &lt;heap dump file&gt;</span><br><span class=\"line\"><span class=\"comment\"># æŒ‡å®šç«¯å£</span></span><br><span class=\"line\">jhat -port 8000 &lt;heap dump file&gt;</span><br></pre></td></tr></table></figure>\n<h2 id=\"jvisualvm-å›¾å½¢åŒ–çš„-JVM-ç›‘æ§ä¸åˆ†æå·¥å…·\">jvisualvm: å›¾å½¢åŒ–çš„ JVM ç›‘æ§ä¸åˆ†æå·¥å…·</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>jvisualvmï¼ˆå…¨ç§°ï¼šJava VisualVMï¼‰æ˜¯ Java å®˜æ–¹æä¾›çš„ä¸€æ¬¾ å›¾å½¢åŒ–çš„ JVM ç›‘æ§ä¸åˆ†æå·¥å…·ï¼Œç”¨äºè§‚å¯Ÿã€åˆ†æå’Œè°ƒè¯•æ­£åœ¨è¿è¡Œçš„ Java ç¨‹åºã€‚å®ƒéå¸¸é€‚åˆå¼€å‘å’Œæµ‹è¯•ç¯å¢ƒä¸­è¿›è¡Œå†…å­˜åˆ†æã€çº¿ç¨‹åˆ†æã€GC è¡Œä¸ºè§‚å¯Ÿç­‰ä»»åŠ¡ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>åŠŸèƒ½æ¦‚è§ˆ</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>åŠŸèƒ½</th>\n<th>æè¿°</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>è¿›ç¨‹ç›‘æ§</strong></td>\n<td>æŸ¥çœ‹æœ¬åœ°æˆ–è¿œç¨‹ JVM è¿›ç¨‹çš„å†…å­˜ã€CPUã€çº¿ç¨‹ç­‰è¿è¡ŒçŠ¶æ€</td>\n</tr>\n<tr>\n<td><strong>å†…å­˜ä½¿ç”¨åˆ†æ</strong></td>\n<td>æŸ¥çœ‹å †å†…å­˜ä½¿ç”¨æƒ…å†µã€GC æ¬¡æ•°å’Œæ—¶é—´ã€ç±»å®ä¾‹åˆ†å¸ƒç­‰</td>\n</tr>\n<tr>\n<td><strong>çº¿ç¨‹åˆ†æ</strong></td>\n<td>æŸ¥çœ‹çº¿ç¨‹çŠ¶æ€ã€çº¿ç¨‹æ ˆã€æ˜¯å¦å­˜åœ¨æ­»é”</td>\n</tr>\n<tr>\n<td><strong>GC åˆ†æ</strong></td>\n<td>å›¾å½¢åŒ–å±•ç¤º GC æ´»åŠ¨ã€é¢‘ç‡ä¸è€—æ—¶</td>\n</tr>\n<tr>\n<td><strong>å †è½¬å‚¨åˆ†æ</strong></td>\n<td>å¯¼å…¥ <code>.hprof</code> æ–‡ä»¶è¿›è¡Œå¯¹è±¡å®ä¾‹ã€ç±»ã€å¼•ç”¨å…³ç³»åˆ†æ</td>\n</tr>\n<tr>\n<td><strong>CPU åˆ†æ</strong></td>\n<td>åˆ†ææ–¹æ³•è°ƒç”¨è·¯å¾„ã€è€—æ—¶ã€çƒ­ç‚¹ä»£ç ï¼ˆéœ€æ‰‹åŠ¨å¯ç”¨ CPU profilerï¼‰</td>\n</tr>\n<tr>\n<td><strong>æ’ä»¶æ”¯æŒ</strong></td>\n<td>å¯ä»¥é€šè¿‡æ’ä»¶å®‰è£…æ›´å¤šåŠŸèƒ½ï¼ˆå¦‚ Visual GCï¼‰</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å¯åŠ¨ jvisualvm</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ï¼Œå¦‚æœæ˜¯åˆ†ææœåŠ¡ç«¯ .hprof æ–‡ä»¶ï¼Œå¯ä»¥å¯¼å‡ºåˆ°æœ¬åœ°ååœ¨æœ¬åœ°å¯åŠ¨</span></span><br><span class=\"line\">$ jvisualvm</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åœ¨ jvisualvm ä¸­å¯¼å…¥ .hprof æ–‡ä»¶</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ jvisualvm --openfile &lt;heap dump file&gt;</span><br><span class=\"line\"><span class=\"comment\"># æˆ–è€… å…ˆæ‰“å¼€ jvisualvm åï¼Œç‚¹å‡» File -&gt; Open File -&gt; é€‰æ‹© .hprof æ–‡ä»¶</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>âš ï¸ æ³¨æ„äº‹é¡¹</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>æ³¨æ„ç‚¹</th>\n<th>è¯´æ˜</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>ä¸é€‚ç”¨äºå¤§è§„æ¨¡ç”Ÿäº§ç¯å¢ƒç›‘æ§</td>\n<td>å› ä¸ºå…¶åˆ†æè¿‡ç¨‹å¯èƒ½ä¼šå¯¹ JVM æœ‰è½»å¾®å½±å“</td>\n</tr>\n<tr>\n<td><code>.hprof</code> æ–‡ä»¶è¿‡å¤§æ—¶åŠ è½½ç¼“æ…¢</td>\n<td>å¯é…åˆ Eclipse MAT ä½¿ç”¨</td>\n</tr>\n<tr>\n<td>CPU/Memory Profiler ä¼šå¢åŠ ç³»ç»Ÿè´Ÿæ‹…</td>\n<td>ä½¿ç”¨æ—¶è°¨æ…ï¼Œå»ºè®®åªåœ¨æµ‹è¯•ç¯å¢ƒå¯ç”¨</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"Eclipse-MAT-Java-Heap-Dump-åˆ†æå·¥å…·\">Eclipse MAT: Java Heap Dump åˆ†æå·¥å…·</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><a href=\"https://eclipse.dev/mat\">Eclipse MAT</a>ï¼ˆEclipse Memory Analyzer Toolï¼‰æ˜¯ä¸€ä¸ªç”¨äºåˆ†æ Java å †å¿«ç…§çš„å·¥å…·ï¼Œå®ƒæä¾›äº†è®¸å¤šåŠŸèƒ½æ¥å¸®åŠ©å¼€å‘äººå‘˜ç†è§£ Java åº”ç”¨ç¨‹åºä¸­çš„å†…å­˜é—®é¢˜ã€‚</p>\n</li>\n</ul>\n<div class=\"tips\">\n<p><em><strong>MaxOSç³»ç»Ÿå®‰è£…Eclipse MATåï¼Œå¯åŠ¨æŠ¥é”™ï¼ŒæŠ¥é”™ä¿¡æ¯ä¸ºï¼šThe JVM shared library â€œ/Library/Internet Plug-Ins/JavaAppletPlugin.plugin/Contents/Home/bin/â€¦/lib/server/libjvm.dylibâ€ does not contain the JNI_CreateJavaVM symbol.</strong></em></p>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">è§£å†³æ–¹æ³•ï¼š<br>\n1.åœ¨åº”ç”¨åˆ—è¡¨ï¼Œæ‰¾åˆ°<code>MemoryAnalyzer.app</code>ï¼Œç„¶åå³é”®å•å‡»åï¼Œé€‰æ‹©<code>æ˜¾ç¤ºåŒ…å†…å®¹</code>,è¿›å…¥Contentsç›®å½•ï¼Œæ‰¾åˆ°<code>Info.plist</code>æ–‡ä»¶<br>\n2.æ‰“å¼€<code>Info.plist</code>æ–‡ä»¶åï¼Œå¯ä»¥çœ‹åˆ°æ³¨é‡Š<code>&lt;string&gt;-vm&lt;/string&gt;</code>é…ç½®é¡¹ï¼Œæˆ‘ä»¬éœ€è¦åšçš„å°±æ˜¯æ‰“å¼€è¿™ä¸ªé…ç½®é¡¹ï¼Œå¹¶ä¸”å°†å…¶è®¾ç½®ä¸ºæˆ‘ä»¬ç³»ç»Ÿçš„Javaè·¯å¾„ï¼Œæœ€æ–°ç‰ˆéœ€è¦<code>jdk17+</code></li>\n</ul>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">string</span>&gt;</span>-vm<span class=\"tag\">&lt;/<span class=\"name\">string</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">string</span>&gt;</span>/Users/hanqf/develop_soft/jdk17/bin/java<span class=\"tag\">&lt;/<span class=\"name\">string</span>&gt;</span></span><br></pre></td></tr></table></figure>\n</div>\n<h2 id=\"Arthas-æ¨è\">Arthas : æ¨è</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><a href=\"https://arthas.aliyun.com\">Arthas</a> æ˜¯é˜¿é‡Œå·´å·´å¼€æºçš„ä¸€æ¬¾ Java è¯Šæ–­å·¥å…·ï¼Œä¸“ä¸ºçº¿ä¸Šè¯Šæ–­è€Œè®¾è®¡ã€‚å®ƒå¯ä»¥å¸®åŠ©å¼€å‘è€…åœ¨ä¸é‡å¯ã€ä¸ä¿®æ”¹ä»£ç çš„æƒ…å†µä¸‹ï¼Œæ’æŸ¥ç”Ÿäº§ç¯å¢ƒä¸­ Java åº”ç”¨çš„é—®é¢˜ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>Arthas æ”¯æŒ JDK 6+ï¼Œæ”¯æŒ Linux/Mac/Windowsï¼Œé‡‡ç”¨å‘½ä»¤è¡Œäº¤äº’æ¨¡å¼ï¼ŒåŒæ—¶æä¾›ä¸°å¯Œçš„ Tab è‡ªåŠ¨è¡¥å…¨åŠŸèƒ½ï¼Œè¿›ä¸€æ­¥æ–¹ä¾¿è¿›è¡Œé—®é¢˜çš„å®šä½å’Œè¯Šæ–­ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>è¿™é‡Œè¦æ³¨æ„ä¸€ç‚¹ï¼Œå°±æ˜¯Arthasä»<code>4.x</code>ç‰ˆæœ¬å¼€å§‹ï¼Œéœ€è¦ä¾èµ–<code>JDK8+</code>ï¼Œå¦‚æœæ˜¯<code>JDK6/7</code>ï¼Œå¯ä»¥ä¸‹è½½æœ€åä¸€ä¸ª3.xç‰ˆæœ¬ <a href=\"https://github.com/alibaba/arthas/releases/tag/arthas-all-3.7.2\">3.7.2</a>ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>ä¸ºäº†æ–¹ä¾¿æˆ‘ä»¬å­¦ä¹ ï¼ŒArthasè¿˜ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªç»ƒä¹ åœºï¼Œ<a href=\"https://killercoda.com/arthas/course/arthas-tutorials-cn\">Arthas Playground</a>ã€‚</p>\n</li>\n</ul>\n<h3 id=\"Arthas-æ ¸å¿ƒç‰¹ç‚¹\">Arthas æ ¸å¿ƒç‰¹ç‚¹</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æ— éœ€é‡å¯ã€ä¾µå…¥æ€§ä½<br>\nArthas å¯ä»¥ attach åˆ°æ­£åœ¨è¿è¡Œçš„ JVM ä¸Šï¼Œä¸éœ€è¦é‡å¯æœåŠ¡æˆ–ä¿®æ”¹æºä»£ç ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>å‘½ä»¤å¼äº¤äº’ä½“éªŒ<br>\nç±»ä¼¼ Linux shell çš„æ“ä½œæ–¹å¼ï¼Œæ”¯æŒ tab è¡¥å…¨ã€ä¸Šä¸‹é”®å†å²å‘½ä»¤ç­‰ï¼Œéå¸¸ç›´è§‚ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>å®æ—¶æŸ¥çœ‹å’Œç›‘æ§<br>\nå¯æŸ¥çœ‹æ–¹æ³•å‚æ•°ã€è¿”å›å€¼ã€è°ƒç”¨æ ˆã€æ‰§è¡Œè€—æ—¶ã€JVM çº¿ç¨‹ã€å†…å­˜ç­‰å®æ—¶æ•°æ®ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>å¤šç§è¿æ¥æ–¹å¼<br>\næ”¯æŒå‘½ä»¤è¡Œç»ˆç«¯ã€æœ¬åœ° shellã€Web é¡µé¢ã€telnet ç­‰å¤šç§è¿æ¥æ–¹å¼ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>æ”¯æŒå¤šç§ JVM ç‰ˆæœ¬<br>\næ”¯æŒ Java 6+ï¼ŒåŒ…æ‹¬ OpenJDKã€Oracle JDKã€Alibaba Dragonwell ç­‰ã€‚</p>\n</li>\n</ul>\n<h3 id=\"Arthas-å¸¸ç”¨å‘½ä»¤\">Arthas å¸¸ç”¨å‘½ä»¤</h3>\n<h4 id=\"å¯åŠ¨\">å¯åŠ¨</h4>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">java -jar arthas-boot.jar</span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡º</span></span><br><span class=\"line\">java -jar arthas-boot.jar --target-ip 0.0.0.0</span><br><span class=\"line\">[INFO] JAVA_HOME: /Library/Java/JavaVirtualMachines/jdk1.8.0_271.jdk/Contents/Home/jre</span><br><span class=\"line\">[INFO] arthas-boot version: 4.0.5</span><br><span class=\"line\">[INFO] Process 43959 already using port 3658</span><br><span class=\"line\">[INFO] Process 43959 already using port 8563</span><br><span class=\"line\">[INFO] Found existing java process, please choose one and input the serial number of the process, eg : 1. Then hit ENTER.</span><br><span class=\"line\">* [1]: 43959 demo-arthas-spring-boot.jar</span><br><span class=\"line\">  [2]: 50851 org.jetbrains.idea.maven.server.RemoteMavenServer36</span><br><span class=\"line\">  [3]: 50813 org.sonarsource.sonarlint.core.backend.cli.SonarLintServerCli</span><br><span class=\"line\">  [4]: 50655 com.intellij.idea.Main</span><br><span class=\"line\"><span class=\"comment\"># å¯åŠ¨åï¼Œä¼šè‡ªåŠ¨è¿›å…¥äº¤äº’æ¨¡å¼ï¼Œæ­¤æ—¶è¾“å…¥è¦ç›‘æ§çš„è¿›ç¨‹åºå·</span></span><br><span class=\"line\">1 <span class=\"comment\"># æ¯”å¦‚è¿™é‡Œè¾“å…¥ 1 å›è½¦</span></span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡º</span></span><br><span class=\"line\">[INFO] arthas home: /Users/hanqf/.arthas/lib/4.0.5/arthas</span><br><span class=\"line\">[INFO] The target process already listen port 3658, skip attach.</span><br><span class=\"line\">[INFO] arthas-client connect 0.0.0.0 3658</span><br><span class=\"line\">  ,---.  ,------. ,--------.,--.  ,--.  ,---.   ,---.</span><br><span class=\"line\"> /  O  \\ |  .--. <span class=\"string\">&#x27;&#x27;</span>--.  .--<span class=\"string\">&#x27;|  &#x27;</span>--<span class=\"string\">&#x27;  | /  O  \\ &#x27;</span>   .-<span class=\"string\">&#x27;</span></span><br><span class=\"line\"><span class=\"string\">|  .-.  ||  &#x27;</span>--<span class=\"string\">&#x27;.&#x27;</span>   |  |   |  .--.  ||  .-.  |`.  `-.</span><br><span class=\"line\">|  | |  ||  |\\  \\    |  |   |  |  |  ||  | |  |.-<span class=\"string\">&#x27;    |</span></span><br><span class=\"line\"><span class=\"string\">`--&#x27;</span> `--<span class=\"string\">&#x27;`--&#x27;</span> <span class=\"string\">&#x27;--&#x27;</span>   `--<span class=\"string\">&#x27;   `--&#x27;</span>  `--<span class=\"string\">&#x27;`--&#x27;</span> `--<span class=\"string\">&#x27;`-----&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">wiki        https://arthas.aliyun.com/doc</span><br><span class=\"line\">tutorials   https://arthas.aliyun.com/doc/arthas-tutorials.html</span><br><span class=\"line\">version     4.0.5</span><br><span class=\"line\">main_class  demo-arthas-spring-boot.jar</span><br><span class=\"line\">pid         43959</span><br><span class=\"line\">start_time  2025-05-14 14:57:18.031</span><br><span class=\"line\">currnt_time 2025-05-14 14:59:22.004</span><br><span class=\"line\"></span><br><span class=\"line\">[arthas@43959]$ <span class=\"comment\"># æ­¤æ—¶è¿›å…¥ arthas å‘½ä»¤è¡Œäº¤äº’çŠ¶æ€</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># é€€å‡º arthas</span></span><br><span class=\"line\">[arthas@43959]$ stop <span class=\"comment\"># é€€å‡º arthas</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>arthas å‘½ä»¤æœ‰å¾ˆå¤šï¼Œå½“å¸¸ç”¨çš„ä¹Ÿå°±å‡ ä¸ªï¼Œå¦å¤–å¦‚æœè®°ä¸ä½æŸä¸ªå‘½ä»¤æ€ä¹ˆç”¨äº†å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤æŸ¥è¯¢</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;<span class=\"built_in\">command</span>&gt; -h æˆ–è€… <span class=\"built_in\">help</span> &lt;<span class=\"built_in\">command</span>&gt;</span><br></pre></td></tr></table></figure>\n<h4 id=\"dashboard-å®æ—¶æŸ¥çœ‹-JVM-è¿è¡ŒçŠ¶æ€\">dashboard :  å®æ—¶æŸ¥çœ‹ JVM è¿è¡ŒçŠ¶æ€</h4>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹ JVM è¿è¡ŒçŠ¶æ€ï¼Œ é»˜è®¤æ¯éš” 5 ç§’åˆ·æ–° CPUã€å†…å­˜ã€çº¿ç¨‹ã€GC ç­‰ä¿¡æ¯</span></span><br><span class=\"line\"><span class=\"comment\"># é»˜è®¤ä¼šä¸€ç›´åˆ·æ–°çŠ¶æ€ï¼ŒæŒ‰ `q` æˆ–  `Ctrl+C` é€€å‡º</span></span><br><span class=\"line\">dashboard</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æ¯éš” 2 ç§’åˆ·æ–°ä¸€æ¬¡</span></span><br><span class=\"line\">dashboard -i 2000</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># åˆ·æ–° 10 æ¬¡ååœæ­¢</span></span><br><span class=\"line\">dashboard -n 10</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æ¯éš” 2 ç§’åˆ·æ–°ä¸€æ¬¡ï¼Œåˆ·æ–° 10 æ¬¡ååœæ­¢</span></span><br><span class=\"line\">dashboard -i 2000 -n 10</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/2L73Hi.png\" alt=\"\" width=\"1400\" height=\"900\"></p>\n<h4 id=\"thread-æŸ¥çœ‹å½“å‰-JVM-çº¿ç¨‹ä¿¡æ¯\">thread : æŸ¥çœ‹å½“å‰ JVM çº¿ç¨‹ä¿¡æ¯</h4>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹å½“å‰ JVM çº¿ç¨‹ä¿¡æ¯ï¼ŒæŒ‰ CPU ä½¿ç”¨ç‡å€’åº</span></span><br><span class=\"line\">thread</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹æ‰€æœ‰çº¿ç¨‹ä¿¡æ¯</span></span><br><span class=\"line\">thread --all</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹æŒ‡å®šçº¿ç¨‹çš„å †æ ˆä¿¡æ¯</span></span><br><span class=\"line\">thread 18</span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡º</span></span><br><span class=\"line\"><span class=\"string\">&quot;http-nio-80-exec-1&quot;</span> Id=18 WAITING on java.util.concurrent.locks.AbstractQueuedSynchronizer<span class=\"variable\">$ConditionObject</span>@51866c16</span><br><span class=\"line\">    at sun.misc.Unsafe.park(Native Method)</span><br><span class=\"line\">    -  waiting on java.util.concurrent.locks.AbstractQueuedSynchronizer<span class=\"variable\">$ConditionObject</span>@51866c16</span><br><span class=\"line\">    at java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)</span><br><span class=\"line\">    at java.util.concurrent.locks.AbstractQueuedSynchronizer<span class=\"variable\">$ConditionObject</span>.await(AbstractQueuedSynchronizer.java:2039)</span><br><span class=\"line\">    at java.util.concurrent.LinkedBlockingQueue.take(LinkedBlockingQueue.java:442)</span><br><span class=\"line\">    at org.apache.tomcat.util.threads.TaskQueue.take(TaskQueue.java:103)</span><br><span class=\"line\">    at org.apache.tomcat.util.threads.TaskQueue.take(TaskQueue.java:31)</span><br><span class=\"line\">    at java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1074)</span><br><span class=\"line\">    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1134)</span><br><span class=\"line\">    at java.util.concurrent.ThreadPoolExecutor<span class=\"variable\">$Worker</span>.run(ThreadPoolExecutor.java:624)</span><br><span class=\"line\">    at org.apache.tomcat.util.threads.TaskThread<span class=\"variable\">$WrappingRunnable</span>.run(TaskThread.java:61)</span><br><span class=\"line\">    at java.lang.Thread.run(Thread.java:748)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹æœ€å¿™çš„å‰5ä¸ªçº¿ç¨‹çš„å †æ ˆä¿¡æ¯</span></span><br><span class=\"line\">thread -n 5</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹å…¨éƒ¨çº¿ç¨‹çš„å †æ ˆä¿¡æ¯</span></span><br><span class=\"line\">thread -n -1</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æŒ‡å®š cpu ä½¿ç”¨ç‡ç»Ÿè®¡çš„é‡‡æ ·é—´éš”ï¼Œå•ä½ä¸ºæ¯«ç§’ï¼Œé»˜è®¤å€¼ä¸º 200</span></span><br><span class=\"line\">thread -i 500</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æ‰¾å‡ºå½“å‰é˜»å¡å…¶ä»–çº¿ç¨‹çš„çº¿ç¨‹</span></span><br><span class=\"line\">thread -b</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹æŒ‡å®šçŠ¶æ€çš„çº¿ç¨‹</span></span><br><span class=\"line\">thread --state WAITING</span><br></pre></td></tr></table></figure>\n<h4 id=\"sc-æŸ¥çœ‹-JVM-å·²åŠ è½½çš„ç±»ä¿¡æ¯\">sc : æŸ¥çœ‹ JVM å·²åŠ è½½çš„ç±»ä¿¡æ¯</h4>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>Search-Class</code> çš„ç®€å†™ï¼Œè¿™ä¸ªå‘½ä»¤èƒ½æœç´¢å‡ºæ‰€æœ‰å·²ç»åŠ è½½åˆ° JVM ä¸­çš„ Class ä¿¡æ¯</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># é€šé…ç¬¦åŒ¹é…ï¼Œæ‰“å°æœç´¢åˆ°çš„ç±»å…¨å</span></span><br><span class=\"line\">sc *.demo.*</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æ‰“å°ç±»çš„è¯¦ç»†ä¿¡æ¯</span></span><br><span class=\"line\">sc -d com.example.demo.arthas.AdminFilterConfig</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æ‰“å°å‡ºç±»çš„ Field ä¿¡æ¯</span></span><br><span class=\"line\">sc -d -f com.example.demo.arthas.AdminFilterConfig</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># é€šé…ç¬¦æŸ¥è¯¢å¹¶è·å–classLoaderHash</span></span><br><span class=\"line\">sc -d *AdminFilterConfig | grep classLoaderHash</span><br></pre></td></tr></table></figure>\n<h4 id=\"sm-æŸ¥çœ‹å·²åŠ è½½ç±»çš„æ–¹æ³•ä¿¡æ¯\">sm  : æŸ¥çœ‹å·²åŠ è½½ç±»çš„æ–¹æ³•ä¿¡æ¯</h4>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>Search-Method</code> çš„ç®€å†™ï¼Œè¿™ä¸ªå‘½ä»¤èƒ½æœç´¢å‡ºæ‰€æœ‰å·²ç»åŠ è½½åˆ° JVM ä¸­çš„ Method ä¿¡æ¯</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># æ‰“å°æŒ‡å®šç±»ä¸­çš„æ–¹æ³•</span></span><br><span class=\"line\">sm java.lang.String</span><br><span class=\"line\"><span class=\"comment\"># å±•ç¤ºæ–¹æ³•çš„è¯¦ç»†ä¿¡æ¯</span></span><br><span class=\"line\">sm -d java.lang.String</span><br><span class=\"line\"><span class=\"comment\"># å±•ç¤ºæŒ‡å®šæ–¹æ³•çš„è¯¦ç»†ä¿¡æ¯</span></span><br><span class=\"line\">sm -d java.lang.String substring</span><br><span class=\"line\"><span class=\"comment\"># æ¨¡ç³ŠåŒ¹é…</span></span><br><span class=\"line\">sm -d java.lang.String eq*</span><br></pre></td></tr></table></figure>\n<h4 id=\"jad-Javaæºç åç¼–è¯‘å·¥å…·\">jad : Javaæºç åç¼–è¯‘å·¥å…·</h4>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>éªŒè¯ç”Ÿäº§ç¯å¢ƒä¸‹çš„ä»£ç æ˜¯å¦ä¸æäº¤çš„ä»£ç ä¸€è‡´</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># æ‰“å°å‡ºç±»çš„æºç ï¼Œç±»å</span></span><br><span class=\"line\">jad com.example.demo.arthas.user.UserController</span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡º</span></span><br><span class=\"line\">jad com.example.demo.arthas.user.UserController</span><br><span class=\"line\"></span><br><span class=\"line\">ClassLoader:</span><br><span class=\"line\">+-org.springframework.boot.loader.LaunchedURLClassLoader@5b2133b1</span><br><span class=\"line\">  +-sun.misc.Launcher<span class=\"variable\">$AppClassLoader</span>@5c647e05</span><br><span class=\"line\">    +-sun.misc.Launcher<span class=\"variable\">$ExtClassLoader</span>@452b3a41</span><br><span class=\"line\"></span><br><span class=\"line\">Location:</span><br><span class=\"line\">file:/Users/hanqf/Desktop/arhtas_dir/demo-arthas-spring-boot.jar!/BOOT-INF/classes!/</span><br><span class=\"line\"></span><br><span class=\"line\">       /*</span><br><span class=\"line\">        * Decompiled with CFR.</span><br><span class=\"line\">        *</span><br><span class=\"line\">        * Could not load the following classes:</span><br><span class=\"line\">        *  com.example.demo.arthas.user.User</span><br><span class=\"line\">        *  org.slf4j.Logger</span><br><span class=\"line\">        *  org.slf4j.LoggerFactory</span><br><span class=\"line\">        *  org.springframework.web.bind.annotation.GetMapping</span><br><span class=\"line\">        *  org.springframework.web.bind.annotation.PathVariable</span><br><span class=\"line\">        *  org.springframework.web.bind.annotation.RestController</span><br><span class=\"line\">        */</span><br><span class=\"line\">       package com.example.demo.arthas.user;</span><br><span class=\"line\"></span><br><span class=\"line\">       import com.example.demo.arthas.user.User;</span><br><span class=\"line\">       import org.slf4j.Logger;</span><br><span class=\"line\">       import org.slf4j.LoggerFactory;</span><br><span class=\"line\">       import org.springframework.web.bind.annotation.GetMapping;</span><br><span class=\"line\">       import org.springframework.web.bind.annotation.PathVariable;</span><br><span class=\"line\">       import org.springframework.web.bind.annotation.RestController;</span><br><span class=\"line\"></span><br><span class=\"line\">       @RestController</span><br><span class=\"line\">       public class UserController &#123;</span><br><span class=\"line\">           private static final Logger logger = LoggerFactory.getLogger(UserController.class);</span><br><span class=\"line\"></span><br><span class=\"line\">           @GetMapping(value=&#123;<span class=\"string\">&quot;/user/&#123;id&#125;&quot;</span>&#125;)</span><br><span class=\"line\">           public User findUserById(@PathVariable Integer <span class=\"built_in\">id</span>) &#123;</span><br><span class=\"line\">/*15*/         logger.info(<span class=\"string\">&quot;id: &#123;&#125;&quot;</span>, (Object)<span class=\"built_in\">id</span>);</span><br><span class=\"line\">/*17*/         <span class=\"keyword\">if</span> (<span class=\"built_in\">id</span> != null &amp;&amp; <span class=\"built_in\">id</span> &lt; 1) &#123;</span><br><span class=\"line\">                   throw new IllegalArgumentException(<span class=\"string\">&quot;id &lt; 1&quot;</span>);</span><br><span class=\"line\">               &#125;</span><br><span class=\"line\">               <span class=\"built_in\">return</span> new User(id.intValue(), <span class=\"string\">&quot;name&quot;</span> + <span class=\"built_in\">id</span>);</span><br><span class=\"line\">           &#125;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">Affect(row-cnt:1) cost <span class=\"keyword\">in</span> 411 ms.</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># åç¼–è¯‘åçš„æºç ä¼šæœ‰ç±»åŠ è½½å™¨çš„ä¿¡æ¯ï¼Œå¦‚æœåªå¸Œæœ›æ‰“å°æºç ï¼Œå¯ä»¥åŠ ä¸Š --source-only</span></span><br><span class=\"line\">jad --source-only com.example.demo.arthas.user.UserController</span><br><span class=\"line\"><span class=\"comment\"># ä¸æ˜¾ç¤ºè¡Œå·</span></span><br><span class=\"line\">jad --source-only com.example.demo.arthas.user.UserController --lineNumber <span class=\"literal\">false</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># è¾“å‡ºåˆ°æ–‡ä»¶</span></span><br><span class=\"line\">jad --source-only com.example.demo.arthas.user.UserController &gt; /tmp/UserController.java</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æ‰“å°å‡ºç±»ä¸­æŸä¸ªæ–¹æ³•çš„æºç ï¼Œç±»å + æ–¹æ³•å</span></span><br><span class=\"line\">jad com.example.demo.arthas.user.UserController findUserById</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># åç¼–è¯‘æ—¶æŒ‡å®šdump classæ–‡ä»¶ç›®å½•</span></span><br><span class=\"line\">jad --source-only com.example.demo.arthas.user.UserController --lineNumber <span class=\"literal\">false</span> -d /tmp/jad</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å½“æœ‰å¤šä¸ª ClassLoader éƒ½åŠ è½½äº†è¿™ä¸ªç±»æ—¶ï¼Œjad å‘½ä»¤ä¼šè¾“å‡ºå¯¹åº” ClassLoader å®ä¾‹çš„ hashcodeï¼Œç„¶åä½ åªéœ€è¦é‡æ–°æ‰§è¡Œ jad å‘½ä»¤ï¼Œå¹¶ä½¿ç”¨å‚æ•° -c <hashcode> å°±å¯ä»¥åç¼–è¯‘æŒ‡å®š ClassLoader åŠ è½½çš„é‚£ä¸ªç±»äº†ï¼›</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ jad org.apache.log4j.Logger</span><br><span class=\"line\"></span><br><span class=\"line\">Found more than one class <span class=\"keyword\">for</span>: org.apache.log4j.Logger, Please use jad -c hashcode org.apache.log4j.Logger</span><br><span class=\"line\">HASHCODE  CLASSLOADER</span><br><span class=\"line\">69dcaba4  +-monitor<span class=\"string\">&#x27;s ModuleClassLoader</span></span><br><span class=\"line\"><span class=\"string\">6e51ad67  +-java.net.URLClassLoader@6e51ad67</span></span><br><span class=\"line\"><span class=\"string\">            +-sun.misc.Launcher$AppClassLoader@6951a712</span></span><br><span class=\"line\"><span class=\"string\">            +-sun.misc.Launcher$ExtClassLoader@6fafc4c2</span></span><br><span class=\"line\"><span class=\"string\">2bdd9114  +-pandora-qos-service&#x27;</span>s ModuleClassLoader</span><br><span class=\"line\">4c0df5f8  +-pandora-framework<span class=\"string\">&#x27;s ModuleClassLoader</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">Affect(row-cnt:0) cost in 38 ms.</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"># æŒ‡å®šç±»åŠ è½½å™¨</span></span><br><span class=\"line\"><span class=\"string\">$ jad org.apache.log4j.Logger -c 69dcaba4</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"mc-Memory-Compiler-å†…å­˜ç¼–è¯‘å™¨ï¼Œç¼–è¯‘-javaæ–‡ä»¶ç”Ÿæˆ-class\">mc : Memory Compiler/å†…å­˜ç¼–è¯‘å™¨ï¼Œç¼–è¯‘<code>.java</code>æ–‡ä»¶ç”Ÿæˆ<code>.class</code></h4>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ç¼–è¯‘ï¼Œè¿™é‡Œä¸€å®šè¦æŒ‡å®šç±»åŠ è½½å™¨ï¼Œå¦åˆ™ä¼šæŠ¥é”™ï¼Œå› ä¸ºä½ ç¼–è¯‘çš„ç±»ä¸­å¯èƒ½importå…¶å®ƒç±»ï¼Œä¸æŒ‡å®šå°±ä¼šæç¤ºæ‰¾ä¸åˆ°å¯¹åº”çš„ç±»ã€‚</span></span><br><span class=\"line\"><span class=\"comment\"># ç±»åŠ è½½å™¨å¯ä»¥é€šè¿‡ jad å‘½ä»¤è·å–</span></span><br><span class=\"line\">mc --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader /tmp/UserController.java</span><br><span class=\"line\"><span class=\"comment\"># æŒ‡å®šç±»åŠ è½½å™¨çš„ç¼–å·</span></span><br><span class=\"line\">mc -c 5b2133b1 /tmp/UserController.java</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># å°† UserController.class æ–‡ä»¶è¾“å‡ºåˆ°æŒ‡å®šç›®å½•ï¼Œ -d æŒ‡å®šè¾“å‡ºç›®å½•</span></span><br><span class=\"line\">mc --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader /tmp/UserController.java -d /tmp</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>mc å‘½ä»¤æœ‰å¯èƒ½å¤±è´¥ã€‚å¦‚æœç¼–è¯‘å¤±è´¥å¯ä»¥åœ¨æœ¬åœ°ç¼–è¯‘å¥½.classæ–‡ä»¶ï¼Œå†ä¸Šä¼ åˆ°æœåŠ¡å™¨ã€‚</p>\n</li>\n</ul>\n<h4 id=\"retransform-é‡æ–°åŠ è½½ç±»-çƒ­ä¿®æ”¹ä»£ç \">retransform : é‡æ–°åŠ è½½ç±»(çƒ­ä¿®æ”¹ä»£ç )</h4>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">retransform /tmp/com/example/demo/arthas/user/UserController.class</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹ é€šè¿‡ retransform é‡æ–°åŠ è½½çš„ class</span></span><br><span class=\"line\">retransform -l</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># åˆ é™¤é€šè¿‡ retransform é‡æ–°åŠ è½½çš„ classï¼Œé€šè¿‡ id åˆ é™¤</span></span><br><span class=\"line\">retransform -d 1</span><br><span class=\"line\"><span class=\"comment\"># åˆ é™¤æ‰€æœ‰</span></span><br><span class=\"line\">retransform --deleteAll</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># åˆ é™¤åè¦é‡æ–°è§¦å‘ retransformï¼Œå¦åˆ™å†…å­˜ä¸­ä¾æ—§ä½¿ç”¨çš„æ˜¯åˆ é™¤å‰çš„ class</span></span><br><span class=\"line\">retransform --classPattern com.example.demo.arthas.user.UserController</span><br></pre></td></tr></table></figure>\n<h4 id=\"sysprop-æŸ¥çœ‹å½“å‰-JVM-çš„ç³»ç»Ÿå±æ€§\">sysprop : æŸ¥çœ‹å½“å‰ JVM çš„ç³»ç»Ÿå±æ€§</h4>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># æ‰“å°ç³»ç»Ÿå±æ€§</span></span><br><span class=\"line\">sysprop</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æŒ‡å®šå•ä¸ª keyï¼Œkeyæ”¯æŒè‡ªåŠ¨è¡¥å…¨</span></span><br><span class=\"line\">sysprop java.version</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># é€šè¿‡grepè¿‡æ»¤</span></span><br><span class=\"line\">sysprop | grep user</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># è®¾ç½® æˆ– ä¿®æ”¹ ç³»ç»Ÿå±æ€§</span></span><br><span class=\"line\">sysprop testKey testValue</span><br></pre></td></tr></table></figure>\n<h4 id=\"sysenv-æŸ¥çœ‹å½“å‰-JVM-çš„ç¯å¢ƒå˜é‡\">sysenv : æŸ¥çœ‹å½“å‰ JVM çš„ç¯å¢ƒå˜é‡</h4>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># åˆ—å‡ºæ‰€æœ‰ç¯å¢ƒå˜é‡</span></span><br><span class=\"line\">sysenv</span><br><span class=\"line\"><span class=\"comment\"># æŒ‡å®šå•ä¸ª keyï¼Œkeyæ”¯æŒè‡ªåŠ¨è¡¥å…¨</span></span><br><span class=\"line\">sysenv PATH</span><br><span class=\"line\"><span class=\"comment\"># é€šè¿‡grepè¿‡æ»¤</span></span><br><span class=\"line\">sysenv | grep PATH</span><br></pre></td></tr></table></figure>\n<h4 id=\"jvm-æŸ¥çœ‹å½“å‰-JVM-çš„ä¿¡æ¯ï¼ŒåŒ…å«å¾ˆå¤šé‡è¦çš„ä¿¡æ¯\">jvm : æŸ¥çœ‹å½“å‰ JVM çš„ä¿¡æ¯ï¼ŒåŒ…å«å¾ˆå¤šé‡è¦çš„ä¿¡æ¯</h4>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">jvm</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>GARBAGE-COLLECTORS </code> GC ç›¸å…³</p>\n</li>\n<li class=\"lvl-2\">\n<p><code>THREAD</code> ç›¸å…³</p>\n</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">COUNT: JVM å½“å‰æ´»è·ƒçš„çº¿ç¨‹æ•°</span><br><span class=\"line\">DAEMON-COUNT: JVM å½“å‰æ´»è·ƒçš„å®ˆæŠ¤çº¿ç¨‹æ•°</span><br><span class=\"line\">PEAK-COUNT: ä» JVM å¯åŠ¨å¼€å§‹æ›¾ç»æ´»ç€çš„æœ€å¤§çº¿ç¨‹æ•°</span><br><span class=\"line\">STARTED-COUNT: ä» JVM å¯åŠ¨å¼€å§‹æ€»å…±å¯åŠ¨è¿‡çš„çº¿ç¨‹æ¬¡æ•°</span><br><span class=\"line\">DEADLOCK-COUNT: JVM å½“å‰æ­»é”çš„çº¿ç¨‹æ•°</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>FILE-DESCRIPTOR</code> æ–‡ä»¶æè¿°ç¬¦ç›¸å…³</p>\n</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">MAX-FILE-DESCRIPTOR-COUNTï¼šJVM è¿›ç¨‹æœ€å¤§å¯ä»¥æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦æ•°</span><br><span class=\"line\">OPEN-FILE-DESCRIPTOR-COUNTï¼šJVM å½“å‰æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦æ•°</span><br></pre></td></tr></table></figure>\n<h4 id=\"watch-å‡½æ•°æ‰§è¡Œæ•°æ®è§‚æµ‹\">watch : å‡½æ•°æ‰§è¡Œæ•°æ®è§‚æµ‹</h4>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>è®©ä½ èƒ½æ–¹ä¾¿çš„è§‚å¯Ÿåˆ°æŒ‡å®šå‡½æ•°çš„è°ƒç”¨æƒ…å†µã€‚èƒ½è§‚å¯Ÿåˆ°çš„èŒƒå›´ä¸ºï¼šè¿”å›å€¼ã€æŠ›å‡ºå¼‚å¸¸ã€å…¥å‚ï¼Œé€šè¿‡ç¼–å†™ OGNL è¡¨è¾¾å¼è¿›è¡Œå¯¹åº”å˜é‡çš„æŸ¥çœ‹ã€‚</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># è§‚å¯ŸæŒ‡å®šç±»ä¸­æŸä¸ªæ–¹æ³•çš„è°ƒç”¨æƒ…å†µï¼ŒclassName +  methodName + è¿”å›å€¼è¡¨è¾¾å¼</span></span><br><span class=\"line\"><span class=\"comment\"># å¼€å¯åï¼Œå½“æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œä¼šæŒ‰ç…§æŒ‡å®šçš„ `è¿”å›å€¼è¡¨è¾¾å¼` è¾“å‡ºç»“æœï¼Œè¿”å›å€¼è¡¨è¾¾å¼ å¯ä»¥ä¸æŒ‡å®šï¼Œé»˜è®¤ä¸º &#123;params, target, returnObj&#125;</span></span><br><span class=\"line\">watch com.example.demo.arthas.user.UserController findUserById <span class=\"string\">&#x27;&#123;params, throwExp&#125;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># è§‚å¯Ÿå…¨éƒ¨æ–¹æ³•ï¼Œé€šé…ç¬¦åŒ¹é…</span></span><br><span class=\"line\">watch com.example.demo.arthas.user.UserController <span class=\"string\">&#x27;*&#x27;</span> <span class=\"string\">&#x27;&#123;params, throwExp&#125;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># é»˜è®¤è¾“å‡ºç»“æœæ²¡æœ‰å±•å¼€ï¼Œå¯ä»¥åŠ ä¸Š -x æŒ‡å®šè¾“å‡ºç»“æœçš„å±æ€§éå†æ·±åº¦ï¼Œé»˜è®¤ä¸º 1ï¼Œæœ€å¤§å€¼æ˜¯ 4</span></span><br><span class=\"line\">watch com.example.demo.arthas.user.UserController <span class=\"string\">&#x27;*&#x27;</span> <span class=\"string\">&#x27;&#123;params, throwExp&#125;&#x27;</span> -x 2</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ä»…å½“æŠ›å‡ºå¼‚å¸¸æ—¶æ‰æ‰“å°ï¼Œ-e åœ¨å‡½æ•°å¼‚å¸¸ä¹‹åè§‚å¯Ÿ</span></span><br><span class=\"line\">watch com.example.demo.arthas.user.UserController <span class=\"string\">&#x27;*&#x27;</span> <span class=\"string\">&#x27;&#123;params, throwExp&#125;&#x27;</span> -x 2 -e</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># å‚æ•°æ¡ä»¶è¿‡æ»¤ï¼Œparams[0] &gt; 100 è¡¨ç¤ºæ–¹æ³•å…¥å‚ä¸­ç¬¬ä¸€ä¸ªå‚æ•°çš„å€¼å¤§äº 100 æ—¶æ‰è§¦å‘æ‰“å°</span></span><br><span class=\"line\">watch com.example.demo.arthas.user.UserController * returnObj <span class=\"string\">&#x27;params[0] &gt; 100&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æŒ‰è¯·æ±‚è€—æ—¶è¿›è¡Œè¿‡æ»¤ï¼Œ#cost&gt;200 è¡¨ç¤ºè€—æ—¶å¤§äº200ms</span></span><br><span class=\"line\">watch com.example.demo.arthas.user.UserController * <span class=\"string\">&#x27;&#123;params, returnObj&#125;&#x27;</span> <span class=\"string\">&#x27;#cost&gt;200&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># é€€å‡ºwatch</span></span><br><span class=\"line\">q</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>watch å‘½ä»¤è¡¨è¾¾å¼æ”¯æŒå˜é‡è¯´æ˜è¡¨</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>åç§°</th>\n<th>ç±»å‹/è¯´æ˜</th>\n<th>ä½œç”¨/å«ä¹‰</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>loader</code></td>\n<td><code>ClassLoader</code></td>\n<td>æ–¹æ³•æ‰€åœ¨ç±»çš„ç±»åŠ è½½å™¨å¯¹è±¡</td>\n</tr>\n<tr>\n<td><code>clazz</code></td>\n<td><code>Class&lt;?&gt;</code></td>\n<td>æ–¹æ³•æ‰€å±çš„ç±»ï¼ˆ<code>Class</code> å¯¹è±¡ï¼‰</td>\n</tr>\n<tr>\n<td><code>method</code></td>\n<td><code>java.lang.reflect.Method</code></td>\n<td>è¢«è°ƒç”¨çš„æ–¹æ³•çš„åå°„å¯¹è±¡</td>\n</tr>\n<tr>\n<td><code>target</code></td>\n<td><code>Object</code></td>\n<td>æ–¹æ³•çš„è°ƒç”¨ç›®æ ‡å¯¹è±¡ï¼ˆå³ <code>this</code> å¯¹è±¡ï¼‰ï¼Œé™æ€æ–¹æ³•ä¸­ä¸º <code>null</code></td>\n</tr>\n<tr>\n<td><code>params</code></td>\n<td><code>Object[]</code></td>\n<td>æ–¹æ³•çš„å…¥å‚æ•°ç»„</td>\n</tr>\n<tr>\n<td><code>returnObj</code></td>\n<td><code>Object</code></td>\n<td>æ–¹æ³•çš„è¿”å›å€¼</td>\n</tr>\n<tr>\n<td><code>throwExp</code></td>\n<td><code>Throwable</code></td>\n<td>æ–¹æ³•æŠ›å‡ºçš„å¼‚å¸¸</td>\n</tr>\n<tr>\n<td><code>isBefore</code></td>\n<td><code>boolean</code></td>\n<td>å½“å‰æ‰§è¡Œä½ç½®æ˜¯å¦æ˜¯æ–¹æ³•è°ƒç”¨<strong>ä¹‹å‰</strong>ï¼ˆ<code>BEFORE</code> é˜¶æ®µï¼‰</td>\n</tr>\n<tr>\n<td><code>isThrow</code></td>\n<td><code>boolean</code></td>\n<td>å½“å‰æ–¹æ³•æ˜¯å¦ä»¥å¼‚å¸¸ç»“æŸï¼ˆ<code>THROWS</code> é˜¶æ®µï¼‰</td>\n</tr>\n<tr>\n<td><code>isReturn</code></td>\n<td><code>boolean</code></td>\n<td>å½“å‰æ–¹æ³•æ˜¯å¦æ­£å¸¸è¿”å›ï¼ˆ<code>RETURN</code> é˜¶æ®µï¼‰</td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"jobs-æŸ¥çœ‹è¿è¡Œä¸­çš„ä»»åŠ¡\">jobs : æŸ¥çœ‹è¿è¡Œä¸­çš„ä»»åŠ¡</h4>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># å¦‚ä¸‹å‘½ä»¤ä¼šè½¬åˆ°åå°è¿è¡Œ ï¼Œä¸linuxå‘½ä»¤ç±»ä¼¼ï¼Œå‘½ä»¤æœ€ååŠ ä¸Š `&amp;` å³å¯</span></span><br><span class=\"line\">watch com.example.demo.arthas.user.UserController * <span class=\"string\">&#x27;&#123;params, throwExp&#125;&#x27;</span> <span class=\"string\">&#x27;throwExp != null&#x27;</span> &gt;&gt; a.log &amp;</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹åå°ä»»åŠ¡</span></span><br><span class=\"line\"><span class=\"built_in\">jobs</span></span><br><span class=\"line\"><span class=\"comment\">## è¾“å‡º</span></span><br><span class=\"line\">[1]*</span><br><span class=\"line\">       Running           watch com.example.demo.arthas.user.UserController * <span class=\"string\">&#x27;&#123;params, throwExp&#125;&#x27;</span> <span class=\"string\">&#x27;throwExp != null&#x27;</span> &gt;&gt; a.log &amp;</span><br><span class=\"line\">       execution count : 0</span><br><span class=\"line\">       start time      : Thu May 15 15:10:04 CST 2025</span><br><span class=\"line\">       <span class=\"built_in\">timeout</span> <span class=\"built_in\">date</span>    : Fri May 16 15:10:04 CST 2025</span><br><span class=\"line\">       session         : ded56dfd-5683-4427-ac08-792f8fb75e5e (current)</span><br><span class=\"line\"><span class=\"comment\"># ç»“æŸä»»åŠ¡</span></span><br><span class=\"line\"><span class=\"built_in\">kill</span> 1 <span class=\"comment\"># 1ä¸ºåå°ä»»åŠ¡id</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># å°†åå°ä»»åŠ¡è½¬åˆ°å‰å°</span></span><br><span class=\"line\"><span class=\"built_in\">fg</span> 1 <span class=\"comment\"># 1ä¸ºåå°ä»»åŠ¡id</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æš‚åœä»»åŠ¡ï¼Œä½†æ­¤æ—¶ä¼šå°†arthasè¿›ç¨‹éƒ½æŒ‚èµ·ï¼Œæ‰€ä»¥å¹¶ä¸å¥½ç”¨</span></span><br><span class=\"line\">ctrl+z</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># å°†å‰å°ä»»åŠ¡è½¬åˆ°åå°ç»§ç»­æ‰§è¡Œ</span></span><br><span class=\"line\"><span class=\"built_in\">bg</span> 1 <span class=\"comment\"># 1ä¸ºå‰å°ä»»åŠ¡id</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"logger-æŸ¥çœ‹-logger-ä¿¡æ¯ï¼Œæ›´æ–°-logger-level\">logger : æŸ¥çœ‹ logger ä¿¡æ¯ï¼Œæ›´æ–° logger level</h4>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹ logger ä¿¡æ¯</span></span><br><span class=\"line\">logger</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹æŒ‡å®šåå­—çš„loggerä¿¡æ¯</span></span><br><span class=\"line\">logger -n ROOT</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹æ²¡æœ‰ appender çš„ logger çš„ä¿¡æ¯ï¼Œä¸åŠ è¿™ä¸ªå‚æ•°åªä¼šæ‰“å°æœ‰ appender çš„ logger çš„ä¿¡æ¯</span></span><br><span class=\"line\">logger --include-no-appender</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æ›´æ–° logger levelï¼Œ-c classLoader çš„ hashcode</span></span><br><span class=\"line\">logger --name ROOT --level debug -c 5b2133b1</span><br><span class=\"line\">logger --name ROOT --level error --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader</span><br></pre></td></tr></table></figure>\n<h4 id=\"classloader-æŸ¥çœ‹-classloader-çš„ç»§æ‰¿æ ‘ï¼Œurlsï¼Œç±»åŠ è½½ä¿¡æ¯\">classloader : æŸ¥çœ‹ classloader çš„ç»§æ‰¿æ ‘ï¼Œurlsï¼Œç±»åŠ è½½ä¿¡æ¯</h4>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹ classloader çš„ä¿¡æ¯ï¼ŒåŠ è½½classçš„æ•°é‡ï¼Œhashcodeï¼Œclassloader çš„ parent</span></span><br><span class=\"line\">classloader -l</span><br><span class=\"line\"><span class=\"comment\"># æ ‘å½¢å±•ç¤º</span></span><br><span class=\"line\">classloader -t</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æŸ¥æ‰¾èµ„æºï¼Œæ¯”å¦‚æŸ¥æ‰¾æŒ‡å®šåç§°çš„æ–‡ä»¶</span></span><br><span class=\"line\">classloader -c 5b2133b1 -r application.properties</span><br><span class=\"line\">classloader --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader -r logback-spring.xml</span><br></pre></td></tr></table></figure>\n<h4 id=\"ognl-æ‰§è¡Œ-ognl-è¡¨è¾¾å¼\">ognl : æ‰§è¡Œ ognl è¡¨è¾¾å¼</h4>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># è°ƒç”¨é™æ€å‡½æ•°</span></span><br><span class=\"line\">ognl <span class=\"string\">&#x27;@java.lang.System@out.println(&quot;hello&quot;)&#x27;</span></span><br><span class=\"line\">ognl <span class=\"string\">&#x27;@java.lang.Math@sqrt(9.0)&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># è·å–é™æ€ç±»çš„é™æ€å­—æ®µ</span></span><br><span class=\"line\">ognl <span class=\"string\">&#x27;@java.io.File@separator&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># éœ€è¦æŒ‡å®šclassLoaderClass</span></span><br><span class=\"line\">ognl --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader @com.example.demo.arthas.user.UserController@logger</span><br><span class=\"line\"><span class=\"comment\"># è·å–classLoaderHash</span></span><br><span class=\"line\">sc -d *UserController | grep classLoaderHash</span><br><span class=\"line\">ognl -c 5b2133b1 @com.example.demo.arthas.user.UserController@logger</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># è¿”å›å€¼å±•å¼€åŸºå±‚ -x</span></span><br><span class=\"line\">ognl -c 5b2133b1 @com.example.demo.arthas.user.UserController@logger -x 3</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æ‰§è¡Œå¤šè¡Œè¡¨è¾¾å¼ï¼Œèµ‹å€¼ç»™ä¸´æ—¶å˜é‡ï¼Œè¿”å›ä¸€ä¸ª List</span></span><br><span class=\"line\">ognl <span class=\"string\">&#x27;#value1=@System@getProperty(&quot;java.home&quot;), #value2=@System@getProperty(&quot;java.runtime.name&quot;), &#123;#value1, #value2&#125;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ç´¢å¼•</span></span><br><span class=\"line\"><span class=\"comment\"># è·å–æ•°ç»„ä¸­çš„ç¬¬ä¸€ä¸ªå…ƒç´ </span></span><br><span class=\"line\">ognl <span class=\"string\">&quot;&#123;1,2,3,4&#125;[0]&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># å˜é‡å¼•ç”¨ï¼Œä½¿ç”¨ # åœ¨ OGNL ä¸­å®šä¹‰ä¸´æ—¶å˜é‡ï¼Œä»–ä»¬å…¨å±€å¯è§ï¼Œæ­¤å¤–è¡¨è¾¾å¼è®¡ç®—çš„æ¯ä¸€æ­¥ç»“æœéƒ½ä¿å­˜åœ¨å˜é‡ this ä¸­</span></span><br><span class=\"line\"><span class=\"comment\"># ä¸‹é¢å‘½ä»¤é€šè¿‡è·å–åˆ—è¡¨çš„ç¬¬ä¸€ä¸ªå…ƒç´ è¿›è¡Œåˆ¤æ–­å¦‚æœå¤§äº 5 åˆ™ä¹˜ä»¥ 2 åä¹‹åˆ™åŠ  10</span></span><br><span class=\"line\">ognl <span class=\"string\">&quot;&#123;10,20,30&#125;[0].(#this &gt; 5 ? #this*2 : #this+10)&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># æ¯ä¸ªå…ƒç´ ä¹˜ä»¥ 2 åè¿”å›</span></span><br><span class=\"line\">ognl <span class=\"string\">&quot;&#123;1, 2, 3&#125;.&#123;#this*2&#125;&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æ–¹æ³•è°ƒç”¨</span></span><br><span class=\"line\"><span class=\"comment\"># é€šè¿‡ä¸‹é¢å‘½ä»¤å¯ä»¥è°ƒç”¨ ArrayList çš„ size() æ–¹æ³•è·å–åˆ° ArrayList çš„å¤§å°</span></span><br><span class=\"line\">ognl <span class=\"string\">&quot;&#123;1,2,3,4&#125;.size()&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># å¤æ‚é“¾å¼è¡¨è¾¾å¼</span></span><br><span class=\"line\">ognl <span class=\"string\">&quot;@java.lang.System@out.(print(&#x27;Hello &#x27;), print(&#x27;world\\n&#x27;))&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æ–°å»ºåŸç”Ÿæ•°ç»„</span></span><br><span class=\"line\">ognl <span class=\"string\">&quot;new int[] &#123;1, 2, 3&#125;&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æ–°å»ºæ™®é€š Map</span></span><br><span class=\"line\">ognl <span class=\"string\">&quot;#&#123; &#x27;foo&#x27;: &#x27;foo value&#x27;, &#x27;bar&#x27;: &#x27;bar value&#x27; &#125;&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æ–°å»ºç‰¹å®šç±»å‹ Map</span></span><br><span class=\"line\">ognl <span class=\"string\">&quot;#@java.util.HashMap@&#123; &#x27;foo&#x27;: &#x27;foo value&#x27;, &#x27;bar&#x27;: &#x27;bar value&#x27; &#125;&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æŸ¥æ‰¾æ‰€æœ‰åŒ¹é…çš„å…ƒç´ </span></span><br><span class=\"line\">ognl <span class=\"string\">&quot;&#123;1024, &#x27;Hello world!&#x27;, true, 2048&#125;.&#123;? #this instanceof Number&#125;&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æŸ¥æ‰¾ç¬¬ä¸€ä¸ªåŒ¹é…çš„å…ƒç´ </span></span><br><span class=\"line\">ognl <span class=\"string\">&quot;&#123;1024, &#x27;Hello world!&#x27;, true, 2048&#125;.&#123;^ #this instanceof Number&#125;&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æŸ¥æ‰¾æœ€åä¸€ä¸ªåŒ¹é…çš„å…ƒç´ </span></span><br><span class=\"line\">ognl <span class=\"string\">&quot;&#123;1024, &#x27;Hello world!&#x27;, true, 2048&#125;.&#123;$ #this instanceof Number&#125;&quot;</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"vmoption-æŸ¥çœ‹ï¼Œæ›´æ–°-VM-è¯Šæ–­ç›¸å…³çš„å‚æ•°\">vmoption : æŸ¥çœ‹ï¼Œæ›´æ–° VM è¯Šæ–­ç›¸å…³çš„å‚æ•°</h4>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹æ‰€æœ‰çš„ option</span></span><br><span class=\"line\">vmoption</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹æŒ‡å®šçš„ option</span></span><br><span class=\"line\">vmoption PrintGC</span><br><span class=\"line\"><span class=\"comment\"># æ›´æ–°æŒ‡å®šçš„ option</span></span><br><span class=\"line\">vmoption PrintGC <span class=\"literal\">true</span></span><br><span class=\"line\">vmoption PrintGCDetails <span class=\"literal\">true</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"vmtool-å®ç°æŸ¥è¯¢å†…å­˜å¯¹è±¡ï¼Œå¼ºåˆ¶-GC-ç­‰åŠŸèƒ½\">vmtool : å®ç°æŸ¥è¯¢å†…å­˜å¯¹è±¡ï¼Œå¼ºåˆ¶ GC ç­‰åŠŸèƒ½</h4>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># è·å–å¯¹è±¡ï¼Œ--action getInstances: è·å–å¯¹è±¡å®ä¾‹ï¼Œ--className: æŒ‡å®šç±»åï¼Œ--limit: æŒ‡å®šè·å–æ•°é‡</span></span><br><span class=\"line\">vmtool --action getInstances --className java.lang.String --<span class=\"built_in\">limit</span> 10</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æŒ‡å®š classloader nameï¼Œè¿™é‡Œè·å– springçš„ ApplicationContext å¯¹è±¡ï¼Œ-x: å±•å¼€å¤šå°‘å±‚</span></span><br><span class=\"line\">vmtool --action getInstances --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader --className org.springframework.context.ApplicationContext -x 3</span><br><span class=\"line\"><span class=\"comment\"># æŒ‡å®š classloader hash</span></span><br><span class=\"line\">sc -d org.springframework.context.ApplicationContext | grep classLoaderHash</span><br><span class=\"line\">vmtool --action getInstances -c 19469ea2 --className org.springframework.context.ApplicationContext</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æ‰§è¡Œè¡¨è¾¾å¼ï¼Œ--express: æ‰§è¡Œçš„è¡¨è¾¾å¼ï¼Œè¿™é‡Œæ˜¯è°ƒç”¨å¯¹è±¡çš„æ–¹æ³•</span></span><br><span class=\"line\">vmtool --action getInstances --className com.example.demo.arthas.aop.HelloWorldService --express <span class=\"string\">&#x27;instances[0].getHelloMessage()&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># å¼ºåˆ¶ GCï¼Œå¯ä»¥ç»“åˆ vmoption å‘½ä»¤åŠ¨æ€æ‰“å¼€PrintGCå¼€å…³</span></span><br><span class=\"line\">vmtool --action forceGc</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ä¸­æ–­çº¿ç¨‹ï¼Œ -t çº¿ç¨‹ID,å¯ä»¥ä½¿ç”¨ threadå‘½ä»¤è·å–</span></span><br><span class=\"line\">vmtool --action interruptThread -t 1</span><br></pre></td></tr></table></figure>\n","content_text":"æ‘˜è¦ æœ¬æ–‡ä»‹ç»JVMçš„å‘½ä»¤è¡Œå·¥å…· JDK8 The JavaÂ® Virtual Machine Specification JDK8çš„javaæŒ‡ä»¤çš„å®˜â½…â½‚æ¡£ JDKâ¼¯å…·å®˜â½¹â½‚æ¡£ JDK17çš„javaæŒ‡ä»¤çš„å®˜â½…â½‚æ¡£ JVM çš„å‚æ•°(ä¸‰ç±») æ ‡å‡†å‚æ•°: ä»¥-å¼€å¤´ï¼Œæ‰€æœ‰ HotSpot éƒ½â½€æŒã€‚ä¾‹å¦‚java -versionã€‚è¿™ç±»å‚æ•°å¯ä»¥ä½¿â½¤java -help æˆ–è€…java -?å…¨éƒ¨æ‰“å°å‡ºæ¥ â¾®æ ‡å‡†å‚æ•°: ä»¥-Xå¼€å¤´ï¼Œæ˜¯ç‰¹å®š HotSpotç‰ˆæœ¬â½€æŒçš„æŒ‡ä»¤ã€‚ä¾‹å¦‚java -Xms200M -Xmx200Mã€‚è¿™ç±»æŒ‡ä»¤å¯ä»¥â½¤java -X å…¨éƒ¨æ‰“å°å‡ºæ¥ã€‚ ä¸ç¨³å®šå‚æ•°: è¿™ä¹Ÿæ˜¯ JVMè°ƒä¼˜çš„å™©æ¢¦ã€‚ä»¥-XX å¼€å¤´ï¼Œè¿™äº›å‚æ•°æ˜¯è·Ÿç‰¹å®šHotSpotç‰ˆæœ¬å¯¹åº”çš„ï¼Œå¾ˆæœ‰å¯èƒ½æ¢ä¸ªç‰ˆæœ¬å°±æ²¡æœ‰äº†ã€‚è¯¦ç»†çš„â½‚æ¡£èµ„æ–™ä¹Ÿç‰¹åˆ«å°‘ã€‚JDK8 ä¸­çš„ä»¥ä¸‹â¼ä¸ªæŒ‡ä»¤å¯ä»¥å¸®åŠ©å¼€å‘è€…äº†è§£ JDK8 ä¸­çš„è¿™â¼€ç±»ä¸ç¨³å®šå‚æ•°ã€‚ 1234java -XX:+PrintFlagsInitial -version # æ‰€æœ‰å‚æ•°çš„é»˜è®¤å€¼java -XX:+PrintFlagsFinal -version # æ‰€æœ‰å‚æ•°æœ€ç»ˆâ½£æ•ˆçš„å€¼ã€‚java -XX:+UnlockExperimentalVMOptions -XX:+PrintFlagsFinal -version # æ‰€æœ‰å‚æ•°æœ€ç»ˆâ½£æ•ˆçš„å€¼ï¼ŒåŒ…å«å®éªŒæ€§å‚æ•°ã€‚java -XX:+PrintCommandLineFlags -version # å½“å‰å‘½ä»¤ç”Ÿæ•ˆçš„å€¼ï¼Œå¯ä»¥çœ‹åˆ°æ˜¯â½¤çš„å“ªç§GCã€‚ JDK1.8é»˜è®¤â½¤çš„ParallelGC è¿è¡Œ java -XX:+UnlockExperimentalVMOptions -XX:+PrintFlagsFinal -version è¿”å›å€¼è¯´æ˜ 1234567891011121314151617[Global flags] intx ActiveProcessorCount = -1 &#123;product&#125; uintx AdaptiveSizeDecrementScaleFactor = 4 &#123;product&#125; uintx AdaptiveSizeMajorGCDecayTimeScale = 10 &#123;product&#125; uintx AdaptiveSizePausePolicy = 0 &#123;product&#125; uintx AdaptiveSizePolicyCollectionCostMargin = 50 &#123;product&#125; uintx AdaptiveSizePolicyInitializingSteps = 20 &#123;product&#125; uintx AdaptiveSizePolicyOutputInterval = 0 &#123;product&#125; uintx AdaptiveSizePolicyWeight = 10 &#123;product&#125; uintx AdaptiveSizeThroughPutPolicy = 0 &#123;product&#125; uintx AdaptiveTimeWeight = 25 &#123;product&#125; bool AdjustConcurrency = false &#123;product&#125; bool AggressiveHeap = false &#123;product&#125; bool AggressiveOpts = false &#123;product&#125; intx AliasLevel = 3 &#123;C2 product&#125; â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦# æ ¼å¼ï¼šflagç±»å‹ï¼Œflagåç§°ï¼Œflagå€¼ï¼Œflagæ¥æºä¸ä½œç”¨åŸŸä¿®é¥°ç¬¦ flagç±»å‹: jdk8 æ ‡è¯†ç¬¦ å«ä¹‰ æè¿°è¯´æ˜ intx æœ‰ç¬¦å·æ•´æ•°ï¼ˆint extendedï¼‰ ç”¨äºè¡¨ç¤ºå¸¦ç¬¦å·æ•´æ•°å‹å‚æ•° uintx æ— ç¬¦å·æ•´æ•°ï¼ˆunsigned int extendedï¼‰ è¡¨ç¤ºéè´Ÿæ•´æ•°å‹å‚æ•° uint64_t æ— ç¬¦å· 64 ä½æ•´æ•° é€‚ç”¨äºéœ€è¦æ›´å¤§æ•´æ•°å€¼çš„å‚æ•°ï¼Œæ¯”å¦‚å†…å­˜å¤§å°ã€çº³ç§’æ—¶é—´æˆ³ç­‰ bool å¸ƒå°”å‹ true æˆ– falseï¼Œè¡¨ç¤ºå¼€å…³å‹å‚æ•°ã€‚+è¡¨ç¤ºå¼€å¯ï¼Œ-è¡¨ç¤ºå…³é—­ã€‚ å¦‚ -XX:+UseG1GCï¼Œè¡¨ç¤ºå¼€å¯ G1 å›æ”¶å™¨åŠŸèƒ½ã€‚ double åŒç²¾åº¦æµ®ç‚¹å‹ ç”¨äºè¡¨ç¤ºæµ®ç‚¹æ•°å€¼ç±»å‹çš„ JVM å‚æ•° ccstr å¸¸é‡ C å­—ç¬¦ä¸²æŒ‡é’ˆ è¡¨ç¤ºå­—ç¬¦ä¸²å‚æ•°ï¼ˆä¸å¯å˜ï¼‰ ccstrlist C å­—ç¬¦ä¸²åˆ—è¡¨ è¡¨ç¤ºä»¥é€—å·åˆ†éš”çš„å­—ç¬¦ä¸²åˆ—è¡¨ jdk11åå‡ºç°æ›´å¤šçš„ç±»å‹ æ ‡è¯†ç¬¦ å«ä¹‰ æè¿°è¯´æ˜ int æœ‰ç¬¦å·æ•´æ•°,é€šå¸¸æ˜¯ 32 ä½ JVM å†…éƒ¨ä½¿ç”¨çš„æ™®é€š int å‚æ•° uint æ— ç¬¦å·æ•´æ•°,é€šå¸¸æ˜¯ 32 ä½ å°‘é‡ç”¨äºç‰¹æ®Šåœºæ™¯çš„å‚æ•° size_t å†…å­˜å¤§å° è¡¨ç¤ºå†…å­˜å¤§å°å‚æ•°ï¼ˆå•ä½ä¸€èˆ¬ä¸ºå­—èŠ‚ï¼‰,jdk11åå‡ºç°ï¼ŒåŸæ¥æ˜¯ uintx flagæ¥æºä¸ä½œç”¨åŸŸä¿®é¥°ç¬¦ jdk8 æ ‡è®° å«ä¹‰ &#123;product&#125; æ­£å¼äº§å“å‚æ•°ï¼ˆç”¨æˆ·å¯ç”¨ï¼Œå¯é€šè¿‡ -XX: è¿›è¡Œè®¾ç½®ï¼‰ &#123;pd product&#125; å¹³å°ç›¸å…³çš„æ­£å¼å‚æ•°ï¼ˆplatform-dependentï¼‰ï¼Œåœ¨æŸäº›æ“ä½œç³»ç»Ÿ/CPU ä¸Šå¯ç”¨ &#123;C1 product&#125; ä»…åœ¨ä½¿ç”¨ C1 ç¼–è¯‘å™¨ï¼ˆä¼˜åŒ–ç¼–è¯‘å™¨ï¼‰ æ—¶æœ‰æ•ˆçš„å‚æ•° &#123;C2 product&#125; ä»…åœ¨ä½¿ç”¨ C2 ç¼–è¯‘å™¨ï¼ˆä¼˜åŒ–ç¼–è¯‘å™¨ï¼‰ æ—¶æœ‰æ•ˆçš„å‚æ•° &#123;manageable&#125; å¯é€šè¿‡ JMX åŠ¨æ€ç®¡ç†çš„å‚æ•°ï¼ˆè¿è¡Œæ—¶å¯è°ƒæ•´ï¼‰ &#123;ARCH product&#125; ä¸ CPU æ¶æ„ç›¸å…³çš„äº§å“å‚æ•°ï¼ˆå¦‚ x86ã€ARM ç­‰ï¼‰ &#123;lp64_product&#125; ä»…åœ¨ 64 ä½ JVM ä¸Šæ‰æœ‰æ•ˆçš„äº§å“å‚æ•° &#123;experimental&#125; å®éªŒæ€§çš„ å‚æ•°ï¼Œå¯èƒ½åœ¨å°†æ¥çš„ç‰ˆæœ¬ä¸­åˆ é™¤æˆ–æ›´æ”¹ã€‚éœ€è¦å¼€å¯ -XX:+UnlockExperimentalVMOptions jdk11åå‡ºç°æ›´å¤šçš„ç±»å‹ æ ‡è®° å«ä¹‰ &#123;C1 pd product&#125; å¹³å°ç›¸å…³çš„æ­£å¼å‚æ•°,ä»…åœ¨ä½¿ç”¨ C1 ç¼–è¯‘å™¨ï¼ˆä¼˜åŒ–ç¼–è¯‘å™¨ï¼‰ æ—¶æœ‰æ•ˆçš„å‚æ•° &#123;C2 pd product&#125; å¹³å°ç›¸å…³çš„æ­£å¼å‚æ•°,ä»…åœ¨ä½¿ç”¨ C2 ç¼–è¯‘å™¨ï¼ˆä¼˜åŒ–ç¼–è¯‘å™¨ï¼‰ æ—¶æœ‰æ•ˆçš„å‚æ•° &#123;JVMCI product&#125; æ­¤å‚æ•°é€‚ç”¨äº JVMCI æˆ– Graal ç¼–è¯‘å™¨ç›¸å…³åŠŸèƒ½ï¼Œjdk21æ·»åŠ  å¦å¤–ï¼Œjdk11+ ä¸­ï¼Œæœ€åè¿˜ä¼šå¤šå‡ºä¸€åˆ—ï¼Œå…¶ä½œç”¨æ˜¯è¯´æ˜è¯¥å‚æ•°çš„è®¾ç½®æ¥æº æ¥æºæ ‡è¯† å«ä¹‰è¯´æ˜ &#123;default&#125; ä½¿ç”¨çš„æ˜¯è¯¥å‚æ•°çš„é»˜è®¤å€¼ï¼ˆæ²¡æœ‰è¢«ç”¨æˆ·æˆ–ç³»ç»Ÿè®¾ç½®ï¼‰ &#123;command line&#125; ç”¨æˆ·é€šè¿‡å‘½ä»¤è¡Œæ˜¾å¼è®¾ç½®çš„å‚æ•°ï¼ˆå¦‚ -XX:+UseG1GCï¼‰ &#123;ergonomic&#125; JVM æ ¹æ®ç³»ç»Ÿç¯å¢ƒè‡ªåŠ¨é€‰æ‹©çš„å€¼ï¼ˆè‡ªé€‚åº”è®¾ç½®ï¼‰ jps: æŸ¥çœ‹å½“å‰jvmä¸­çš„è¿›ç¨‹ 12345678# æŸ¥çœ‹javaè¿›ç¨‹IDjps# æŸ¥çœ‹javaè¿›ç¨‹ä¿¡æ¯ï¼ŒåŒ…æ‹¬IDå’Œå¯åŠ¨ç±»æˆ–jarçš„åç§°jps -l# æŸ¥çœ‹å¯åŠ¨javaè¿›ç¨‹æ—¶ä¼ é€’ç»™jvmçš„å‚æ•°è®¾ç½®jps -v# æŸ¥çœ‹javaè¿›ç¨‹ä¿¡æ¯ï¼ŒåŒæ—¶æ˜¾ç¤ºå¯åŠ¨javaè¿›ç¨‹æ—¶ä¼ é€’ç»™jvmçš„å‚æ•°è®¾ç½®jps -lv jinfo: æŸ¥çœ‹JVMå‚æ•° jinfo æ˜¯ JDK è‡ªå¸¦çš„å‘½ä»¤è¡Œå·¥å…·ä¹‹ä¸€ï¼Œç”¨äº æŸ¥çœ‹å’Œä¿®æ”¹æ­£åœ¨è¿è¡Œä¸­çš„ Java è¿›ç¨‹çš„é…ç½®ä¿¡æ¯ï¼Œä¸»è¦åŒ…æ‹¬ JVM å‚æ•°ã€ç³»ç»Ÿå±æ€§ç­‰ä¿¡æ¯ã€‚ åœ¨ Java 9+ ä¹‹åè¢«æ ‡è®°ä¸º deprecatedï¼Œå»ºè®®æ”¹ç”¨ jcmd æ›¿ä»£ 12345678910111213141516171819# æŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„ JVM å‚æ•°jinfo &lt;PID&gt;# jcmd å‘½ä»¤ï¼Œåˆ†æˆä¸‰ä¸ªjcmd &lt;pid&gt; VM.flags # VM Flagsjcmd &lt;pid&gt; VM.system_properties # System Propertiesjcmd &lt;pid&gt; VM.command_line # Command Line# æŸ¥çœ‹æŒ‡å®šè¿›ç¨‹çš„ç³»ç»Ÿå±æ€§ï¼ˆ-syspropsï¼‰jinfo -sysprops &lt;PID&gt;# jcmd å‘½ä»¤jcmd &lt;pid&gt; VM.system_properties# åŠ¨æ€ä¿®æ”¹ JVM å‚æ•°ï¼ˆä»…æ”¯æŒéƒ¨åˆ†å‚æ•°ï¼‰jinfo -flag [+|-]&lt;flagname&gt; &lt;pid&gt;## ä¾‹ï¼šæ‰“å¼€ GC æ—¥å¿—jinfo -flag +PrintGC &lt;pid&gt;# æ£€æŸ¥æ˜¯å¦å¼€å¯äº†æŸä¸ª JVM ç‰¹æ€§ï¼ˆå¦‚ UseG1GCï¼‰jinfo -flag UseG1GC &lt;pid&gt; jstat: æŸ¥çœ‹æŒ‡å®šJAVAè¿›ç¨‹çš„è¿è¡ŒçŠ¶æ€ 123456789# æŸ¥çœ‹è¿è¡ŒçŠ¶æ€jstat -gc &lt;PID&gt;# æŸ¥çœ‹è¿è¡ŒçŠ¶æ€ï¼Œæ¯éš”5000æ¯«ç§’è¾“å‡ºä¸€æ¬¡ï¼Œå…±è¾“å‡º20æ¬¡jstat -gc &lt;PID&gt; 5000 20# è¾“å‡º S0C S1C S0U S1U EC EU OC OU MC MU CCSC CCSU YGC YGCT FGC FGCT GCT512.0 512.0 0.0 224.0 29696.0 27138.2 105984.0 96531.8 122368.0 114450.4 15360.0 14018.9 733 5.099 4 0.833 5.931512.0 512.0 0.0 224.0 29696.0 27203.9 105984.0 96531.8 122368.0 114450.4 15360.0 14018.9 733 5.099 4 0.833 5.931512.0 512.0 0.0 224.0 29696.0 27220.4 105984.0 96531.8 122368.0 114450.4 15360.0 14018.9 733 5.099 4 0.833 5.931 å†…å­˜åŒºç»Ÿè®¡ï¼ˆå•ä½ï¼šKBï¼‰ åˆ—å å«ä¹‰è¯´æ˜ S0C Survivor 0 åŒºçš„å®¹é‡ï¼ˆKBï¼‰ S1C Survivor 1 åŒºçš„å®¹é‡ï¼ˆKBï¼‰ S0U Survivor 0 åŒºå·²ä½¿ç”¨å†…å­˜ï¼ˆKBï¼‰ S1U Survivor 1 åŒºå·²ä½¿ç”¨å†…å­˜ï¼ˆKBï¼‰ EC Eden åŒºçš„å®¹é‡ï¼ˆKBï¼‰ EU Eden åŒºå·²ä½¿ç”¨å†…å­˜ï¼ˆKBï¼‰ OC Old Generationï¼ˆè€å¹´ä»£ï¼‰çš„å®¹é‡ï¼ˆKBï¼‰ OU Old Generation å·²ä½¿ç”¨å†…å­˜ï¼ˆKBï¼‰ MC Metaspaceï¼ˆå…ƒç©ºé—´ï¼‰çš„å®¹é‡ï¼ˆKBï¼‰ MU Metaspace å·²ä½¿ç”¨å†…å­˜ï¼ˆKBï¼‰ CCSC Compressed Class Space çš„å®¹é‡ï¼ˆKBï¼‰ CCSU Compressed Class Space å·²ä½¿ç”¨å†…å­˜ï¼ˆKBï¼‰ GC æ¬¡æ•°ä¸è€—æ—¶(ä»åº”ç”¨ç¨‹åºå¯åŠ¨åˆ°é‡‡æ ·æ—¶) åˆ—å å«ä¹‰è¯´æ˜ YGC Young GCï¼ˆMinor GCï¼‰ çš„ç´¯è®¡æ¬¡æ•° YGCT Young GC ç´¯è®¡è€—æ—¶ï¼ˆå•ä½ï¼šç§’ï¼‰ FGC Full GC çš„ç´¯è®¡æ¬¡æ•° FGCT Full GC ç´¯è®¡è€—æ—¶ï¼ˆå•ä½ï¼šç§’ï¼‰ GCT GC æ€»è€—æ—¶ï¼ˆYGCT + FGCTï¼Œæ€»å’Œï¼‰ jstack: æŸ¥çœ‹æŒ‡å®šJAVAè¿›ç¨‹ä¸­å„çº¿ç¨‹çš„è°ƒç”¨å †æ ˆ 123456789101112131415161718# æ‰“å°çº¿ç¨‹çš„æ ‡å‡†æ ˆä¿¡æ¯ï¼ˆæ ˆå¸§ + çº¿ç¨‹çŠ¶æ€ï¼‰jstack &lt;PID&gt;# åœ¨æ ‡å‡†è¾“å‡ºåŸºç¡€ä¸Šï¼Œé¢å¤–æ‰“å°çº¿ç¨‹æ‹¥æœ‰çš„é”ï¼ˆmonitorï¼‰å’Œ waited on é”å¯¹è±¡ä¿¡æ¯jstack -l &lt;PID&gt;# è¾“å‡ºåˆ°æ–‡ä»¶jstack -l &lt;PID&gt; &gt; jstack.tdump # è¿™ä¸ªæ–‡ä»¶ååç¼€åªæ˜¯ä¸ºäº†æ–¹ä¾¿ jvisualvm æŸ¥çœ‹# è¾“å‡º&quot;idle-connection-reaper&quot; #68 daemon prio=5 os_prio=0 tid=0x00007f38b6ae2800 nid=0x62e9 waiting on condition [0x00007f385b0f5000] java.lang.Thread.State: TIMED_WAITING (sleeping) at java.lang.Thread.sleep(Native Method) at software.amazon.awssdk.http.apache.internal.conn.IdleConnectionReaper$ReaperTask.run(IdleConnectionReaper.java:151) at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) at java.lang.Thread.run(Thread.java:750) Locked ownable synchronizers: - &lt;0x00000000c561cfd8&gt; (a java.util.concurrent.ThreadPoolExecutor$Worker) jstackè¾“å‡ºå†…å®¹å«ä¹‰ å­—æ®µ å«ä¹‰ &quot;idle-connection-reaper&quot; çº¿ç¨‹åç§°ã€‚è¿™ä¸ªçº¿ç¨‹æ˜¯ AWS SDK ä¸­ç”¨äºæ¸…ç†ç©ºé—²è¿æ¥çš„åå°çº¿ç¨‹ã€‚ #68 çº¿ç¨‹ IDï¼ˆJava å±‚åˆ†é…çš„ç¼–å·ï¼‰ã€‚ daemon è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ª å®ˆæŠ¤çº¿ç¨‹ã€‚JVM é€€å‡ºæ—¶ä¸ä¼šç­‰å¾…å®ˆæŠ¤çº¿ç¨‹è¿è¡Œç»“æŸã€‚ prio=5 Java å±‚çš„çº¿ç¨‹ä¼˜å…ˆçº§ï¼ˆé»˜è®¤ 1â€“10ï¼Œ5 æ˜¯é»˜è®¤ï¼‰ã€‚ os_prio=0 æ“ä½œç³»ç»Ÿå±‚çº¿ç¨‹ä¼˜å…ˆçº§ï¼ˆå–å†³äºæ“ä½œç³»ç»Ÿå’Œ JVM çš„å®ç°ï¼‰ã€‚ tid=0x00007f38b6ae2800 çº¿ç¨‹ IDï¼ˆJava å±‚ä½¿ç”¨çš„åœ°å€æ ‡è¯†ï¼‰ã€‚ nid=0x62e9 Native IDï¼Œæ“ä½œç³»ç»Ÿåˆ†é…çš„çº¿ç¨‹ IDï¼ˆåå…­è¿›åˆ¶è¡¨ç¤ºï¼‰ï¼Œå¯ä»¥é€šè¿‡å‘½ä»¤printf &quot;%d\\n&quot; 0x62e9è½¬æ¢ä¸º10è¿›åˆ¶ã€‚ ps -Lp &lt;PID&gt; å’Œ top -Hp &lt;PID&gt; å±•ç¤ºçš„çº¿ç¨‹idæ˜¯10è¿›åˆ¶ waiting on condition çº¿ç¨‹çŠ¶æ€è¯´æ˜ï¼šæ­£åœ¨ç­‰å¾…æŸç§æ¡ä»¶ï¼Œä¸€èˆ¬æŒ‡ sleep() æˆ– wait() ç­‰ã€‚ [0x00007f385b0f5000] æ ˆå¸§çš„å†…å­˜åœ°å€ã€‚ java.lang.Thread.State: TIMED_WAITING (sleeping) çº¿ç¨‹çŠ¶æ€ã€‚ at java.lang.Thread.sleep(Native Method) â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦ çº¿ç¨‹è°ƒç”¨æ ˆä¿¡æ¯ï¼ŒåŒ…æ‹¬è°ƒç”¨æ–¹æ³•ã€è°ƒç”¨å‚æ•°ã€è°ƒç”¨æ ˆå¸§ã€‚ å¦å¤–è¿˜æœ‰å¦‚ä¸‹ä¿¡æ¯ï¼Œè¡¨ç¤ºæ­¤çº¿ç¨‹æŒæœ‰çš„å¯æ‹¥æœ‰åŒæ­¥å™¨ï¼ˆä¾‹å¦‚ ReentrantLockï¼‰ï¼Œå…·ä½“å†…å®¹å¦‚ä¸‹ï¼š 12Locked ownable synchronizers: - &lt;0x00000000c561cfd8&gt; (a java.util.concurrent.ThreadPoolExecutor$Worker) å†…å®¹ å«ä¹‰ &lt;0x00000000c561cfd8&gt; æŒæœ‰é”çš„å¯¹è±¡åœ°å€ã€‚å¯ä»¥åœ¨å…¶ä»–çº¿ç¨‹ä¸­æŸ¥æ‰¾è¿™ä¸ªåœ°å€ï¼Œä»¥åˆ¤æ–­æ­»é”ç­‰é—®é¢˜ã€‚ (a ThreadPoolExecutor$Worker) è¡¨ç¤ºè¯¥é”å±äº ThreadPoolExecutor çš„æŸä¸ª Worker çº¿ç¨‹ï¼ˆè¿™æ˜¯çº¿ç¨‹æ± çš„å·¥ä½œçº¿ç¨‹ï¼‰ã€‚ çº¿ç¨‹çŠ¶æ€ çŠ¶æ€ å«ä¹‰ å¸¸è§åŸå›  / ç¤ºä¾‹æ–¹æ³• ç¤ºä¾‹ jstack è¾“å‡º RUNNABLE çº¿ç¨‹æ­£åœ¨è¿è¡Œæˆ–å‡†å¤‡è¿è¡Œï¼Œç­‰å¾… CPU æ—¶é—´ç‰‡ã€‚ çº¿ç¨‹æ´»è·ƒè¿è¡Œä¸­ &quot;Thread-0&quot; #1 prio=5 os_prio=0 tid=0x00007f8d9c001000 nid=0x1a runnable [0x00007f8dbf7fe000] BLOCKED (on object monitor) ç­‰å¾…è·å–å¯¹è±¡çš„ç›‘è§†å™¨é”ï¼ˆåŒæ­¥é”ï¼‰ï¼Œå³ç­‰å¾…è¿›å…¥åŒæ­¥å—æˆ–æ–¹æ³•ã€‚ synchronized åŒæ­¥å—æˆ–æ–¹æ³• &quot;Thread-1&quot; #2 prio=5 os_prio=0 tid=0x00007f8d9c002000 nid=0x1b waiting for monitor entry [0x00007f8dbeaff000] WAITING (on object monitor) æ— é™æœŸç­‰å¾…å…¶ä»–çº¿ç¨‹æ‰§è¡ŒæŸæ“ä½œã€‚ Object.wait()Thread.join()LockSupport.park()Condition.await() &quot;Thread-2&quot; #3 prio=5 os_prio=0 tid=0x00007f8d9c003000 nid=0x1c waiting on condition [0x00007f8dbebff000] TIMED_WAITING (on object monitor) ç­‰å¾…å›ºå®šæ—¶é—´ï¼Œç›´åˆ°æ¡ä»¶æ»¡è¶³æˆ–è¶…æ—¶ã€‚ Object.wait(long)Thread.sleep(long)Condition.awaitNanos(long)DelayQueue.take() &quot;Thread-3&quot; #4 prio=5 os_prio=0 tid=0x00007f8d9c004000 nid=0x1d timed_waiting [0x00007f8dbebff000] TERMINATED çº¿ç¨‹å·²è¿è¡Œå®Œæ¯•å¹¶é€€å‡ºï¼ˆé€šå¸¸ä¸åœ¨ jstack ä¸­æ˜¾ç¤ºï¼‰ã€‚ - - ä½¿ç”¨jstackæ£€æŸ¥æ­»é” æ­»é”æ˜¯æŒ‡å¤šä¸ªçº¿ç¨‹äº’ç›¸ç­‰å¾…å¯¹æ–¹é‡Šæ”¾é”ï¼Œå¯¼è‡´æ— æ³•ç»§ç»­è¿è¡Œçš„æƒ…å†µã€‚ ç›´æ¥æŸ¥æ‰¾ Found one Java-level deadlock æç¤º 12345678Found one Java-level deadlock:=============================&quot;Thread-1&quot;: waiting to lock monitor 0x0000000005c0a098 (object 0x00000000d5c10a70, a java.lang.Object), which is held by &quot;Thread-2&quot;&quot;Thread-2&quot;: waiting to lock monitor 0x0000000005c0a128 (object 0x00000000d5c10aa0, a java.lang.Object), which is held by &quot;Thread-1&quot; è¡¨ç¤ºä¸¤ä¸ªçº¿ç¨‹äº’ç›¸ç­‰å¾…å¯¹æ–¹é‡Šæ”¾é”ï¼Œé€ æˆæ­»é”ã€‚ ç›®å‰åªæ”¯æŒæ‰¾å‡º synchronized å…³é”®å­—é˜»å¡ä½çš„çº¿ç¨‹ï¼Œå¦‚æœæ˜¯ java.util.concurrent.Lock ç›®å‰è¿˜ä¸æ”¯æŒã€‚ æ‰‹åŠ¨åˆ¤æ–­æ­»é”çš„ç‰¹å¾ï¼ˆå¦‚æœæ²¡æœ‰ä¸Šé¢çš„æç¤ºï¼‰ å¦‚æœ JVM æ²¡æœ‰æ˜¾å¼æç¤ºï¼Œä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹æ­»é”ç‰¹å¾è¿›è¡Œæ‰‹åŠ¨è¯†åˆ«ï¼š ç‰¹å¾ æè¿° çº¿ç¨‹å¤„äº BLOCKED çŠ¶æ€ çº¿ç¨‹è¢«é”é˜»å¡åœ¨ monitor ä¸Šã€‚ waiting to lock å’Œ locked å‡ºç°äº¤å‰ ä¸€ä¸ªçº¿ç¨‹æ­£åœ¨ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹æŒæœ‰çš„é”ï¼Œè€Œå¦ä¸€ä¸ªçº¿ç¨‹ä¹Ÿåœ¨ç­‰å¾…å½“å‰çº¿ç¨‹çš„é”ã€‚ æ²¡æœ‰èƒ½ç»§ç»­æ‰§è¡Œçš„çº¿ç¨‹ å¤šä¸ªçº¿ç¨‹éƒ½å¤„äº BLOCKED çŠ¶æ€ï¼Œä¸”ç›¸äº’ä¾èµ–ã€‚ åœ¨ Java 8 ä¹‹åæ”¯æŒè·å– JVM å†…éƒ¨çº¿ç¨‹ VM å†…éƒ¨çº¿ç¨‹åŒ…æ‹¬ä¸‹é¢å‡ ç§ï¼š çº¿ç¨‹ç±»å‹ ç¤ºä¾‹åç§° JITï¼ˆJust-In-Timeï¼‰ç¼–è¯‘çº¿ç¨‹ C1 CompilerThread0, C2 CompilerThread0 GC çº¿ç¨‹ GC Thread0, G1 Young RemSet Sampling å…¶å®ƒå†…éƒ¨çº¿ç¨‹ VM Periodic Task Thread, VM Thread, Service Thread è‡ª JDK 7 åŠä»¥ä¸Šç‰ˆæœ¬å¼€å§‹ï¼ŒHotSpot JVM é»˜è®¤å¯ç”¨äº†ï¼šåˆ†å±‚ç¼–è¯‘ï¼ˆTiered Compilationï¼‰ï¼Œå³åŒæ—¶ä½¿ç”¨ C1 å’Œ C2 ç¼–è¯‘å™¨ã€‚ ç¼–è¯‘å™¨ ç‰¹æ€§ ç”¨é€” C1ï¼ˆClient Compilerï¼‰ ç¼–è¯‘é€Ÿåº¦å¿«ï¼Œä¼˜åŒ–å°‘ ç¨‹åºå¯åŠ¨æ—¶ä½¿ç”¨ï¼Œæå‡å¯åŠ¨é€Ÿåº¦ C2ï¼ˆServer Compilerï¼‰ ç¼–è¯‘é€Ÿåº¦æ…¢ï¼Œä¼˜åŒ–å¼º çƒ­ç‚¹ä»£ç è¾¾åˆ°ä¸€å®šé—¨æ§›åä½¿ç”¨ï¼Œæå‡é•¿æœŸè¿è¡Œæ€§èƒ½ JVM å¯åŠ¨åï¼Œå…ˆè§£é‡Šæ‰§è¡Œå­—èŠ‚ç ï¼›çƒ­ç‚¹ä»£ç é¦–å…ˆç”± C1 ç¼–è¯‘å™¨å¤„ç†ï¼›å¦‚æœè¿›ä¸€æ­¥å˜çƒ­ï¼Œäº¤ç”± C2 ç¼–è¯‘å™¨ä¼˜åŒ–ï¼›æ•´ä¸ªè¿‡ç¨‹ç”± JVM è‡ªåŠ¨ç®¡ç†ï¼Œä¸éœ€è¦æ‰‹åŠ¨å¹²é¢„ã€‚ æ˜¯å¦å¯ä»¥æŒ‡å®šåªç”¨æŸä¸ªç¼–è¯‘å™¨ï¼Ÿæ˜¯çš„ï¼Œä½ å¯ä»¥ç”¨ JVM å‚æ•°æ§åˆ¶ï¼Œä½†çœŸæ²¡å¿…è¦ã€‚ å‚æ•° å«ä¹‰ -client ä½¿ç”¨ C1 ç¼–è¯‘å™¨ï¼ˆé€‚åˆå¯åŠ¨å¿«ï¼‰ -server ä½¿ç”¨ C2 ç¼–è¯‘å™¨ï¼ˆé€‚åˆé•¿æ—¶é—´è¿è¡Œçš„æœåŠ¡ï¼‰ -XX:-TieredCompilation ç¦ç”¨åˆ†å±‚ç¼–è¯‘ï¼Œä»…ä½¿ç”¨ -client æˆ– -server æŒ‡å®šçš„ç¼–è¯‘å™¨ jmap: åˆ†æè¿è¡Œä¸­ Java è¿›ç¨‹çš„å†…å­˜ä½¿ç”¨æƒ…å†µ jmap æ¯”è¾ƒæ¶ˆè€—å†…å­˜ï¼Œæ‰€ä»¥ä¸æ¨èç”Ÿäº§ç¯å¢ƒä½¿ç”¨ã€‚ jmap -histo &lt;pid&gt;: æŸ¥çœ‹ç±»å®ä¾‹æ•°é‡åŠå ç”¨å†…å­˜ 12345678910111213141516171819$ jmap -histo 2523825238: num #instances #bytes class name---------------------------------------------- 1: 106175 10838440 [C 2: 94344 3019008 java.util.concurrent.ConcurrentHashMap$Node 3: 105529 2532696 java.lang.String 4: 11203 2496608 [B 5: 20178 2430136 [Ljava.lang.Object; 6: 21642 2399904 java.lang.Classâ€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦Total 857252 51328200# num: åºå·# instances: å®ä¾‹æ•°é‡# bytes: å®ä¾‹å­—èŠ‚æ•°# class name: ç±»å, [C is a char[]ï¼Œ[S is a short[]ï¼Œ[I is a int[]ï¼Œ[B is a byte[]ï¼Œ[L is a List# Total: æ€»æ•° jmap -heap &lt;pid&gt;: æŸ¥çœ‹å †ä½¿ç”¨æƒ…å†µ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647$ jmap -heap 25238Attaching to process ID 25238, please wait...Debugger attached successfully.Server compiler detected.JVM version is 25.371-b11using thread-local object allocation.Parallel GC with 2 thread(s)Heap Configuration: # å †é…ç½® MinHeapFreeRatio = 0 # æœ€å°ç©ºé—²ç™¾åˆ†æ¯” MaxHeapFreeRatio = 100 # æœ€å¤§ç©ºé—²ç™¾åˆ†æ¯” MaxHeapSize = 1010827264 (964.0MB) # æœ€å¤§å †å¤§å° NewSize = 21495808 (20.5MB) # æ–°ç”Ÿä»£å¤§å° MaxNewSize = 336592896 (321.0MB) # æ–°ç”Ÿä»£æœ€å¤§å¤§å° OldSize = 43515904 (41.5MB) # è€å¹´ä»£å¤§å° NewRatio = 2 # æ–°ç”Ÿä»£ä¸è€å¹´ä»£æ¯”ä¾‹ SurvivorRatio = 8 # å¹¸å­˜è€…æ¯”ä¾‹ MetaspaceSize = 21807104 (20.796875MB) # å…ƒç©ºé—´å¤§å° CompressedClassSpaceSize = 1073741824 (1024.0MB) # å‹ç¼©ç±»ç©ºé—´å¤§å°ï¼Œç”¨äºå­˜å‚¨æ‰€æœ‰ ç±»æŒ‡é’ˆï¼ˆKlass pointerï¼‰ MaxMetaspaceSize = 17592186044415 MB # å…ƒç©ºé—´æœ€å¤§å¤§å° G1HeapRegionSize = 0 (0.0MB) # G1å †å¤§å°Heap Usage: # å †ä½¿ç”¨æƒ…å†µPS Young Generation # å¹´è½»ç”Ÿä»£Eden Space: # Eden åŒº capacity = 30932992 (29.5MB) # Eden åŒºå¤§å° used = 16705104 (15.931228637695312MB) # Eden åŒºä½¿ç”¨æƒ…å†µ free = 14227888 (13.568771362304688MB) # Eden åŒºå‰©ä½™æƒ…å†µ 54.00416487354343% used # Eden åŒºä½¿ç”¨ç™¾åˆ†æ¯”From Space: # å¹¸å­˜è€…åŒº survivor0 capacity = 524288 (0.5MB) used = 0 (0.0MB) free = 524288 (0.5MB) 0.0% usedTo Space: # å¹¸å­˜è€…åŒº survivor1 capacity = 524288 (0.5MB) used = 0 (0.0MB) free = 524288 (0.5MB) 0.0% usedPS Old Generation # è€å¹´ä»£ capacity = 193462272 (184.5MB) used = 43292112 (41.28657531738281MB) free = 150170160 (143.2134246826172MB) 22.377547597497458% used38722 interned Strings occupying 4184168 bytes. # å †ä¸­å­—ç¬¦ä¸²æ•°é‡åŠå ç”¨å†…å­˜ jmap -dump:live,format=b,file=&lt;file&gt; &lt;pid&gt;: åˆ›å»ºä¸€ä¸ªå¿«ç…§ï¼Œå¹¶ä¿å­˜åˆ°æ–‡ä»¶ä¸­ 1234# åˆ›å»ºä¸€ä¸ªå¿«ç…§ï¼Œå¹¶ä¿å­˜åˆ°å½“å‰ç›®å½•ä¸‹$ jmap -dump:live,format=b,file=test.hprof 25238Dumping heap to /tmp/test.hprof ...Heap dump file created jcmd: å¯ä»¥æ›¿ä»£jmapå‘½ä»¤ï¼Œjdk1.8+æ¨èä½¿ç”¨ jcmd æ˜¯ JDK çš„ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼Œç”¨äºç®¡ç† JVMï¼Œjcmd å¯ä»¥æŸ¥çœ‹ JVM çš„è¿è¡ŒçŠ¶æ€ã€æŸ¥çœ‹å †å†…å­˜ä¿¡æ¯ã€è§¦å‘ GCã€æŸ¥çœ‹çº¿ç¨‹ä¿¡æ¯ã€æŸ¥çœ‹ç±»ä¿¡æ¯ç­‰ç­‰ã€‚ ç”Ÿäº§ç¯å¢ƒä¸å»ºè®®ä½¿ç”¨jmapï¼Œå› å…¶ä¼šå ç”¨å¤§é‡å†…å­˜ï¼Œæ¨èä½¿ç”¨ jcmdã€‚ jcmd &lt;pid&gt; GC.heap_info: æŸ¥çœ‹å †ä½¿ç”¨æƒ…å†µ ç±»ä¼¼ jmap -heap &lt;pid&gt; 12345678910$ jcmd 25238 GC.heap_info25238: PSYoungGen total 30208K, used 23593K [0x00000000ebf00000, 0x00000000edd80000, 0x0000000100000000) eden space 29696K, 78% used [0x00000000ebf00000,0x00000000ed5d2560,0x00000000edc00000) from space 512K, 43% used [0x00000000edd00000,0x00000000edd38000,0x00000000edd80000) to space 512K, 0% used [0x00000000edc80000,0x00000000edc80000,0x00000000edd00000) ParOldGen total 105984K, used 96547K [0x00000000c3c00000, 0x00000000ca380000, 0x00000000ebf00000) object space 105984K, 91% used [0x00000000c3c00000,0x00000000c9a48f10,0x00000000ca380000) Metaspace used 114450K, capacity 122262K, committed 122368K, reserved 1157120K class space used 14018K, capacity 15294K, committed 15360K, reserved 1048576K jcmd &lt;pid&gt; GC.class_histogram: æŸ¥çœ‹ç±»åŠ è½½æƒ…å†µ ç±»ä¼¼ jmap -histo &lt;pid&gt; 12345678910111213141516171819$ jcmd 25238 GC.class_histogram25238: num #instances #bytes class name---------------------------------------------- 1: 106175 10838440 [C 2: 94344 3019008 java.util.concurrent.ConcurrentHashMap$Node 3: 105529 2532696 java.lang.String 4: 11203 2496608 [B 5: 20178 2430136 [Ljava.lang.Object; 6: 21642 2399904 java.lang.Classâ€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦Total 857252 51328200# num: åºå·# instances: å®ä¾‹æ•°é‡# bytes: å®ä¾‹å­—èŠ‚æ•°# class name: ç±»å, [C is a char[]ï¼Œ[S is a short[]ï¼Œ[I is a int[]ï¼Œ[B is a byte[]ï¼Œ[L is a List# Total: æ€»æ•° jcmd &lt;pid&gt; GC.heap_dump /path/to/heap.hprof: å¯¼å‡º heap dump æ›¿ä»£ jmap -dump:format=b,file=heap.hprof &lt;pid&gt;ï¼Œä½†ä»ä¼šæœ‰åœé¡¿ï¼ˆè§¦å‘FullGCï¼‰ï¼Œdump è¿‡ç¨‹æ…¢ï¼Œç”Ÿäº§ç¯å¢ƒæ…é‡ä½¿ç”¨ 1234567$ jcmd 25238 GC.heap_dump ./heap.hprof25238:Heap dump file created# æ³¨æ„è¿™é‡Œä½¿ç”¨çš„æ˜¯ç›¸å¯¹ç›®å½•ï¼Œ./heap.hprofï¼Œä½†æ­¤æ—¶ &quot;./&quot; å¹¶ä¸æ˜¯è¿è¡Œå‘½ä»¤æ—¶æ‰€åœ¨çš„ç›®å½•ï¼Œè€Œæ˜¯æŒ‡ Java è¿›ç¨‹çš„å·¥ä½œç›®å½•ï¼Œå¦‚æœä½ ä¸çŸ¥é“å·¥ä½œç›®å½•ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹jcmd &lt;pid&gt; VM.system_properties | grep &quot;user.dir&quot;# linuxä¸‹ä¹Ÿå¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹ls -l /proc/&lt;pid&gt;/cwd å› ä¸ºç”Ÿäº§ç¯å¢ƒä¸æ¨èä½¿ç”¨ jmap æˆ– jcmd å¯¼å‡º heap dumpï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨ç”Ÿäº§ç¯å¢ƒä¸­é…ç½®å¦‚ä¸‹jvmå‚æ•° 12-XX:+HeadDumpOnOutOfMemoryError # å†…å­˜æº¢å‡ºï¼ˆOOMï¼‰æ—¶ä¼šè‡ªåŠ¨ä¿å­˜å †å†…å­˜å¿«ç…§æ–‡ä»¶-XX:HeapDumpPath=/path/to/dump.hprof # æŒ‡å®šå †å†…å­˜å¿«ç…§æ–‡ä»¶ä¿å­˜è·¯å¾„ï¼Œå¦‚æœä¸é…ç½®ï¼Œåˆ™é»˜è®¤ä¿å­˜åœ¨ Java è¿›ç¨‹çš„å·¥ä½œç›®å½•ä¸‹ï¼Œæ–‡ä»¶åç§°é»˜è®¤ä¸º java_&lt;pid&gt;.hprof jhat: åˆ†æ Java Heap Dump æ–‡ä»¶ï¼ˆ.hprofï¼‰çš„å·¥å…· jhatï¼ˆJava Heap Analysis Toolï¼‰æ˜¯ JDK é™„å¸¦çš„ä¸€ä¸ªç”¨äº**åˆ†æ Java Heap Dump æ–‡ä»¶ï¼ˆ.hprofï¼‰**çš„å·¥å…·ã€‚å®ƒå¯ä»¥å°†å †å¿«ç…§ä½œä¸º HTTP æœåŠ¡åŠ è½½ï¼Œå¹¶å…è®¸ä½ é€šè¿‡æµè§ˆå™¨äº¤äº’å¼åœ°æŸ¥çœ‹å’ŒæŸ¥è¯¢å¯¹è±¡ä¿¡æ¯ã€‚ ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼š ğŸ”º ä» JDK 9 èµ·ï¼Œjhat å·²è¢«å®˜æ–¹åºŸå¼ƒï¼Œæ¨èä½¿ç”¨æ›´å¼ºå¤§çš„å·¥å…·å¦‚ VisualVMã€Eclipse MAT æˆ– jcmd + å¤–éƒ¨å·¥å…·ã€‚ 1234# é»˜è®¤ç«¯å£7000jhat &lt;heap dump file&gt;# æŒ‡å®šç«¯å£jhat -port 8000 &lt;heap dump file&gt; jvisualvm: å›¾å½¢åŒ–çš„ JVM ç›‘æ§ä¸åˆ†æå·¥å…· jvisualvmï¼ˆå…¨ç§°ï¼šJava VisualVMï¼‰æ˜¯ Java å®˜æ–¹æä¾›çš„ä¸€æ¬¾ å›¾å½¢åŒ–çš„ JVM ç›‘æ§ä¸åˆ†æå·¥å…·ï¼Œç”¨äºè§‚å¯Ÿã€åˆ†æå’Œè°ƒè¯•æ­£åœ¨è¿è¡Œçš„ Java ç¨‹åºã€‚å®ƒéå¸¸é€‚åˆå¼€å‘å’Œæµ‹è¯•ç¯å¢ƒä¸­è¿›è¡Œå†…å­˜åˆ†æã€çº¿ç¨‹åˆ†æã€GC è¡Œä¸ºè§‚å¯Ÿç­‰ä»»åŠ¡ã€‚ åŠŸèƒ½æ¦‚è§ˆ åŠŸèƒ½ æè¿° è¿›ç¨‹ç›‘æ§ æŸ¥çœ‹æœ¬åœ°æˆ–è¿œç¨‹ JVM è¿›ç¨‹çš„å†…å­˜ã€CPUã€çº¿ç¨‹ç­‰è¿è¡ŒçŠ¶æ€ å†…å­˜ä½¿ç”¨åˆ†æ æŸ¥çœ‹å †å†…å­˜ä½¿ç”¨æƒ…å†µã€GC æ¬¡æ•°å’Œæ—¶é—´ã€ç±»å®ä¾‹åˆ†å¸ƒç­‰ çº¿ç¨‹åˆ†æ æŸ¥çœ‹çº¿ç¨‹çŠ¶æ€ã€çº¿ç¨‹æ ˆã€æ˜¯å¦å­˜åœ¨æ­»é” GC åˆ†æ å›¾å½¢åŒ–å±•ç¤º GC æ´»åŠ¨ã€é¢‘ç‡ä¸è€—æ—¶ å †è½¬å‚¨åˆ†æ å¯¼å…¥ .hprof æ–‡ä»¶è¿›è¡Œå¯¹è±¡å®ä¾‹ã€ç±»ã€å¼•ç”¨å…³ç³»åˆ†æ CPU åˆ†æ åˆ†ææ–¹æ³•è°ƒç”¨è·¯å¾„ã€è€—æ—¶ã€çƒ­ç‚¹ä»£ç ï¼ˆéœ€æ‰‹åŠ¨å¯ç”¨ CPU profilerï¼‰ æ’ä»¶æ”¯æŒ å¯ä»¥é€šè¿‡æ’ä»¶å®‰è£…æ›´å¤šåŠŸèƒ½ï¼ˆå¦‚ Visual GCï¼‰ å¯åŠ¨ jvisualvm 12# ä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ï¼Œå¦‚æœæ˜¯åˆ†ææœåŠ¡ç«¯ .hprof æ–‡ä»¶ï¼Œå¯ä»¥å¯¼å‡ºåˆ°æœ¬åœ°ååœ¨æœ¬åœ°å¯åŠ¨$ jvisualvm åœ¨ jvisualvm ä¸­å¯¼å…¥ .hprof æ–‡ä»¶ 12$ jvisualvm --openfile &lt;heap dump file&gt;# æˆ–è€… å…ˆæ‰“å¼€ jvisualvm åï¼Œç‚¹å‡» File -&gt; Open File -&gt; é€‰æ‹© .hprof æ–‡ä»¶ âš ï¸ æ³¨æ„äº‹é¡¹ æ³¨æ„ç‚¹ è¯´æ˜ ä¸é€‚ç”¨äºå¤§è§„æ¨¡ç”Ÿäº§ç¯å¢ƒç›‘æ§ å› ä¸ºå…¶åˆ†æè¿‡ç¨‹å¯èƒ½ä¼šå¯¹ JVM æœ‰è½»å¾®å½±å“ .hprof æ–‡ä»¶è¿‡å¤§æ—¶åŠ è½½ç¼“æ…¢ å¯é…åˆ Eclipse MAT ä½¿ç”¨ CPU/Memory Profiler ä¼šå¢åŠ ç³»ç»Ÿè´Ÿæ‹… ä½¿ç”¨æ—¶è°¨æ…ï¼Œå»ºè®®åªåœ¨æµ‹è¯•ç¯å¢ƒå¯ç”¨ Eclipse MAT: Java Heap Dump åˆ†æå·¥å…· Eclipse MATï¼ˆEclipse Memory Analyzer Toolï¼‰æ˜¯ä¸€ä¸ªç”¨äºåˆ†æ Java å †å¿«ç…§çš„å·¥å…·ï¼Œå®ƒæä¾›äº†è®¸å¤šåŠŸèƒ½æ¥å¸®åŠ©å¼€å‘äººå‘˜ç†è§£ Java åº”ç”¨ç¨‹åºä¸­çš„å†…å­˜é—®é¢˜ã€‚ MaxOSç³»ç»Ÿå®‰è£…Eclipse MATåï¼Œå¯åŠ¨æŠ¥é”™ï¼ŒæŠ¥é”™ä¿¡æ¯ä¸ºï¼šThe JVM shared library â€œ/Library/Internet Plug-Ins/JavaAppletPlugin.plugin/Contents/Home/bin/â€¦/lib/server/libjvm.dylibâ€ does not contain the JNI_CreateJavaVM symbol. è§£å†³æ–¹æ³•ï¼š 1.åœ¨åº”ç”¨åˆ—è¡¨ï¼Œæ‰¾åˆ°MemoryAnalyzer.appï¼Œç„¶åå³é”®å•å‡»åï¼Œé€‰æ‹©æ˜¾ç¤ºåŒ…å†…å®¹,è¿›å…¥Contentsç›®å½•ï¼Œæ‰¾åˆ°Info.plistæ–‡ä»¶ 2.æ‰“å¼€Info.plistæ–‡ä»¶åï¼Œå¯ä»¥çœ‹åˆ°æ³¨é‡Š&lt;string&gt;-vm&lt;/string&gt;é…ç½®é¡¹ï¼Œæˆ‘ä»¬éœ€è¦åšçš„å°±æ˜¯æ‰“å¼€è¿™ä¸ªé…ç½®é¡¹ï¼Œå¹¶ä¸”å°†å…¶è®¾ç½®ä¸ºæˆ‘ä»¬ç³»ç»Ÿçš„Javaè·¯å¾„ï¼Œæœ€æ–°ç‰ˆéœ€è¦jdk17+ 12&lt;string&gt;-vm&lt;/string&gt;&lt;string&gt;/Users/hanqf/develop_soft/jdk17/bin/java&lt;/string&gt; Arthas : æ¨è Arthas æ˜¯é˜¿é‡Œå·´å·´å¼€æºçš„ä¸€æ¬¾ Java è¯Šæ–­å·¥å…·ï¼Œä¸“ä¸ºçº¿ä¸Šè¯Šæ–­è€Œè®¾è®¡ã€‚å®ƒå¯ä»¥å¸®åŠ©å¼€å‘è€…åœ¨ä¸é‡å¯ã€ä¸ä¿®æ”¹ä»£ç çš„æƒ…å†µä¸‹ï¼Œæ’æŸ¥ç”Ÿäº§ç¯å¢ƒä¸­ Java åº”ç”¨çš„é—®é¢˜ã€‚ Arthas æ”¯æŒ JDK 6+ï¼Œæ”¯æŒ Linux/Mac/Windowsï¼Œé‡‡ç”¨å‘½ä»¤è¡Œäº¤äº’æ¨¡å¼ï¼ŒåŒæ—¶æä¾›ä¸°å¯Œçš„ Tab è‡ªåŠ¨è¡¥å…¨åŠŸèƒ½ï¼Œè¿›ä¸€æ­¥æ–¹ä¾¿è¿›è¡Œé—®é¢˜çš„å®šä½å’Œè¯Šæ–­ã€‚ è¿™é‡Œè¦æ³¨æ„ä¸€ç‚¹ï¼Œå°±æ˜¯Arthasä»4.xç‰ˆæœ¬å¼€å§‹ï¼Œéœ€è¦ä¾èµ–JDK8+ï¼Œå¦‚æœæ˜¯JDK6/7ï¼Œå¯ä»¥ä¸‹è½½æœ€åä¸€ä¸ª3.xç‰ˆæœ¬ 3.7.2ã€‚ ä¸ºäº†æ–¹ä¾¿æˆ‘ä»¬å­¦ä¹ ï¼ŒArthasè¿˜ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªç»ƒä¹ åœºï¼ŒArthas Playgroundã€‚ Arthas æ ¸å¿ƒç‰¹ç‚¹ æ— éœ€é‡å¯ã€ä¾µå…¥æ€§ä½ Arthas å¯ä»¥ attach åˆ°æ­£åœ¨è¿è¡Œçš„ JVM ä¸Šï¼Œä¸éœ€è¦é‡å¯æœåŠ¡æˆ–ä¿®æ”¹æºä»£ç ã€‚ å‘½ä»¤å¼äº¤äº’ä½“éªŒ ç±»ä¼¼ Linux shell çš„æ“ä½œæ–¹å¼ï¼Œæ”¯æŒ tab è¡¥å…¨ã€ä¸Šä¸‹é”®å†å²å‘½ä»¤ç­‰ï¼Œéå¸¸ç›´è§‚ã€‚ å®æ—¶æŸ¥çœ‹å’Œç›‘æ§ å¯æŸ¥çœ‹æ–¹æ³•å‚æ•°ã€è¿”å›å€¼ã€è°ƒç”¨æ ˆã€æ‰§è¡Œè€—æ—¶ã€JVM çº¿ç¨‹ã€å†…å­˜ç­‰å®æ—¶æ•°æ®ã€‚ å¤šç§è¿æ¥æ–¹å¼ æ”¯æŒå‘½ä»¤è¡Œç»ˆç«¯ã€æœ¬åœ° shellã€Web é¡µé¢ã€telnet ç­‰å¤šç§è¿æ¥æ–¹å¼ã€‚ æ”¯æŒå¤šç§ JVM ç‰ˆæœ¬ æ”¯æŒ Java 6+ï¼ŒåŒ…æ‹¬ OpenJDKã€Oracle JDKã€Alibaba Dragonwell ç­‰ã€‚ Arthas å¸¸ç”¨å‘½ä»¤ å¯åŠ¨ 123456789101112131415161718192021222324252627282930313233343536java -jar arthas-boot.jar## è¾“å‡ºjava -jar arthas-boot.jar --target-ip 0.0.0.0[INFO] JAVA_HOME: /Library/Java/JavaVirtualMachines/jdk1.8.0_271.jdk/Contents/Home/jre[INFO] arthas-boot version: 4.0.5[INFO] Process 43959 already using port 3658[INFO] Process 43959 already using port 8563[INFO] Found existing java process, please choose one and input the serial number of the process, eg : 1. Then hit ENTER.* [1]: 43959 demo-arthas-spring-boot.jar [2]: 50851 org.jetbrains.idea.maven.server.RemoteMavenServer36 [3]: 50813 org.sonarsource.sonarlint.core.backend.cli.SonarLintServerCli [4]: 50655 com.intellij.idea.Main# å¯åŠ¨åï¼Œä¼šè‡ªåŠ¨è¿›å…¥äº¤äº’æ¨¡å¼ï¼Œæ­¤æ—¶è¾“å…¥è¦ç›‘æ§çš„è¿›ç¨‹åºå·1 # æ¯”å¦‚è¿™é‡Œè¾“å…¥ 1 å›è½¦## è¾“å‡º[INFO] arthas home: /Users/hanqf/.arthas/lib/4.0.5/arthas[INFO] The target process already listen port 3658, skip attach.[INFO] arthas-client connect 0.0.0.0 3658 ,---. ,------. ,--------.,--. ,--. ,---. ,---. / O \\ | .--. &#x27;&#x27;--. .--&#x27;| &#x27;--&#x27; | / O \\ &#x27; .-&#x27;| .-. || &#x27;--&#x27;.&#x27; | | | .--. || .-. |`. `-.| | | || |\\ \\ | | | | | || | | |.-&#x27; |`--&#x27; `--&#x27;`--&#x27; &#x27;--&#x27; `--&#x27; `--&#x27; `--&#x27;`--&#x27; `--&#x27;`-----&#x27;wiki https://arthas.aliyun.com/doctutorials https://arthas.aliyun.com/doc/arthas-tutorials.htmlversion 4.0.5main_class demo-arthas-spring-boot.jarpid 43959start_time 2025-05-14 14:57:18.031currnt_time 2025-05-14 14:59:22.004[arthas@43959]$ # æ­¤æ—¶è¿›å…¥ arthas å‘½ä»¤è¡Œäº¤äº’çŠ¶æ€# é€€å‡º arthas[arthas@43959]$ stop # é€€å‡º arthas arthas å‘½ä»¤æœ‰å¾ˆå¤šï¼Œå½“å¸¸ç”¨çš„ä¹Ÿå°±å‡ ä¸ªï¼Œå¦å¤–å¦‚æœè®°ä¸ä½æŸä¸ªå‘½ä»¤æ€ä¹ˆç”¨äº†å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤æŸ¥è¯¢ 1&lt;command&gt; -h æˆ–è€… help &lt;command&gt; dashboard : å®æ—¶æŸ¥çœ‹ JVM è¿è¡ŒçŠ¶æ€ 123456789101112# æŸ¥çœ‹ JVM è¿è¡ŒçŠ¶æ€ï¼Œ é»˜è®¤æ¯éš” 5 ç§’åˆ·æ–° CPUã€å†…å­˜ã€çº¿ç¨‹ã€GC ç­‰ä¿¡æ¯# é»˜è®¤ä¼šä¸€ç›´åˆ·æ–°çŠ¶æ€ï¼ŒæŒ‰ `q` æˆ– `Ctrl+C` é€€å‡ºdashboard# æ¯éš” 2 ç§’åˆ·æ–°ä¸€æ¬¡dashboard -i 2000# åˆ·æ–° 10 æ¬¡ååœæ­¢dashboard -n 10# æ¯éš” 2 ç§’åˆ·æ–°ä¸€æ¬¡ï¼Œåˆ·æ–° 10 æ¬¡ååœæ­¢dashboard -i 2000 -n 10 thread : æŸ¥çœ‹å½“å‰ JVM çº¿ç¨‹ä¿¡æ¯ 1234567891011121314151617181920212223242526272829303132333435# æŸ¥çœ‹å½“å‰ JVM çº¿ç¨‹ä¿¡æ¯ï¼ŒæŒ‰ CPU ä½¿ç”¨ç‡å€’åºthread# æŸ¥çœ‹æ‰€æœ‰çº¿ç¨‹ä¿¡æ¯thread --all# æŸ¥çœ‹æŒ‡å®šçº¿ç¨‹çš„å †æ ˆä¿¡æ¯thread 18## è¾“å‡º&quot;http-nio-80-exec-1&quot; Id=18 WAITING on java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject@51866c16 at sun.misc.Unsafe.park(Native Method) - waiting on java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject@51866c16 at java.util.concurrent.locks.LockSupport.park(LockSupport.java:175) at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:2039) at java.util.concurrent.LinkedBlockingQueue.take(LinkedBlockingQueue.java:442) at org.apache.tomcat.util.threads.TaskQueue.take(TaskQueue.java:103) at org.apache.tomcat.util.threads.TaskQueue.take(TaskQueue.java:31) at java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1074) at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1134) at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61) at java.lang.Thread.run(Thread.java:748)# æŸ¥çœ‹æœ€å¿™çš„å‰5ä¸ªçº¿ç¨‹çš„å †æ ˆä¿¡æ¯thread -n 5# æŸ¥çœ‹å…¨éƒ¨çº¿ç¨‹çš„å †æ ˆä¿¡æ¯thread -n -1# æŒ‡å®š cpu ä½¿ç”¨ç‡ç»Ÿè®¡çš„é‡‡æ ·é—´éš”ï¼Œå•ä½ä¸ºæ¯«ç§’ï¼Œé»˜è®¤å€¼ä¸º 200thread -i 500# æ‰¾å‡ºå½“å‰é˜»å¡å…¶ä»–çº¿ç¨‹çš„çº¿ç¨‹thread -b# æŸ¥çœ‹æŒ‡å®šçŠ¶æ€çš„çº¿ç¨‹thread --state WAITING sc : æŸ¥çœ‹ JVM å·²åŠ è½½çš„ç±»ä¿¡æ¯ Search-Class çš„ç®€å†™ï¼Œè¿™ä¸ªå‘½ä»¤èƒ½æœç´¢å‡ºæ‰€æœ‰å·²ç»åŠ è½½åˆ° JVM ä¸­çš„ Class ä¿¡æ¯ 1234567891011# é€šé…ç¬¦åŒ¹é…ï¼Œæ‰“å°æœç´¢åˆ°çš„ç±»å…¨åsc *.demo.*# æ‰“å°ç±»çš„è¯¦ç»†ä¿¡æ¯sc -d com.example.demo.arthas.AdminFilterConfig# æ‰“å°å‡ºç±»çš„ Field ä¿¡æ¯sc -d -f com.example.demo.arthas.AdminFilterConfig# é€šé…ç¬¦æŸ¥è¯¢å¹¶è·å–classLoaderHashsc -d *AdminFilterConfig | grep classLoaderHash sm : æŸ¥çœ‹å·²åŠ è½½ç±»çš„æ–¹æ³•ä¿¡æ¯ Search-Method çš„ç®€å†™ï¼Œè¿™ä¸ªå‘½ä»¤èƒ½æœç´¢å‡ºæ‰€æœ‰å·²ç»åŠ è½½åˆ° JVM ä¸­çš„ Method ä¿¡æ¯ 12345678# æ‰“å°æŒ‡å®šç±»ä¸­çš„æ–¹æ³•sm java.lang.String# å±•ç¤ºæ–¹æ³•çš„è¯¦ç»†ä¿¡æ¯sm -d java.lang.String# å±•ç¤ºæŒ‡å®šæ–¹æ³•çš„è¯¦ç»†ä¿¡æ¯sm -d java.lang.String substring# æ¨¡ç³ŠåŒ¹é…sm -d java.lang.String eq* jad : Javaæºç åç¼–è¯‘å·¥å…· éªŒè¯ç”Ÿäº§ç¯å¢ƒä¸‹çš„ä»£ç æ˜¯å¦ä¸æäº¤çš„ä»£ç ä¸€è‡´ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748# æ‰“å°å‡ºç±»çš„æºç ï¼Œç±»åjad com.example.demo.arthas.user.UserController## è¾“å‡ºjad com.example.demo.arthas.user.UserControllerClassLoader:+-org.springframework.boot.loader.LaunchedURLClassLoader@5b2133b1 +-sun.misc.Launcher$AppClassLoader@5c647e05 +-sun.misc.Launcher$ExtClassLoader@452b3a41Location:file:/Users/hanqf/Desktop/arhtas_dir/demo-arthas-spring-boot.jar!/BOOT-INF/classes!/ /* * Decompiled with CFR. * * Could not load the following classes: * com.example.demo.arthas.user.User * org.slf4j.Logger * org.slf4j.LoggerFactory * org.springframework.web.bind.annotation.GetMapping * org.springframework.web.bind.annotation.PathVariable * org.springframework.web.bind.annotation.RestController */ package com.example.demo.arthas.user; import com.example.demo.arthas.user.User; import org.slf4j.Logger; import org.slf4j.LoggerFactory; import org.springframework.web.bind.annotation.GetMapping; import org.springframework.web.bind.annotation.PathVariable; import org.springframework.web.bind.annotation.RestController; @RestController public class UserController &#123; private static final Logger logger = LoggerFactory.getLogger(UserController.class); @GetMapping(value=&#123;&quot;/user/&#123;id&#125;&quot;&#125;) public User findUserById(@PathVariable Integer id) &#123;/*15*/ logger.info(&quot;id: &#123;&#125;&quot;, (Object)id);/*17*/ if (id != null &amp;&amp; id &lt; 1) &#123; throw new IllegalArgumentException(&quot;id &lt; 1&quot;); &#125; return new User(id.intValue(), &quot;name&quot; + id); &#125; &#125;Affect(row-cnt:1) cost in 411 ms. 12345678910111213# åç¼–è¯‘åçš„æºç ä¼šæœ‰ç±»åŠ è½½å™¨çš„ä¿¡æ¯ï¼Œå¦‚æœåªå¸Œæœ›æ‰“å°æºç ï¼Œå¯ä»¥åŠ ä¸Š --source-onlyjad --source-only com.example.demo.arthas.user.UserController# ä¸æ˜¾ç¤ºè¡Œå·jad --source-only com.example.demo.arthas.user.UserController --lineNumber false# è¾“å‡ºåˆ°æ–‡ä»¶jad --source-only com.example.demo.arthas.user.UserController &gt; /tmp/UserController.java# æ‰“å°å‡ºç±»ä¸­æŸä¸ªæ–¹æ³•çš„æºç ï¼Œç±»å + æ–¹æ³•åjad com.example.demo.arthas.user.UserController findUserById# åç¼–è¯‘æ—¶æŒ‡å®šdump classæ–‡ä»¶ç›®å½•jad --source-only com.example.demo.arthas.user.UserController --lineNumber false -d /tmp/jad å½“æœ‰å¤šä¸ª ClassLoader éƒ½åŠ è½½äº†è¿™ä¸ªç±»æ—¶ï¼Œjad å‘½ä»¤ä¼šè¾“å‡ºå¯¹åº” ClassLoader å®ä¾‹çš„ hashcodeï¼Œç„¶åä½ åªéœ€è¦é‡æ–°æ‰§è¡Œ jad å‘½ä»¤ï¼Œå¹¶ä½¿ç”¨å‚æ•° -c å°±å¯ä»¥åç¼–è¯‘æŒ‡å®š ClassLoader åŠ è½½çš„é‚£ä¸ªç±»äº†ï¼› 123456789101112131415$ jad org.apache.log4j.LoggerFound more than one class for: org.apache.log4j.Logger, Please use jad -c hashcode org.apache.log4j.LoggerHASHCODE CLASSLOADER69dcaba4 +-monitor&#x27;s ModuleClassLoader6e51ad67 +-java.net.URLClassLoader@6e51ad67 +-sun.misc.Launcher$AppClassLoader@6951a712 +-sun.misc.Launcher$ExtClassLoader@6fafc4c22bdd9114 +-pandora-qos-service&#x27;s ModuleClassLoader4c0df5f8 +-pandora-framework&#x27;s ModuleClassLoaderAffect(row-cnt:0) cost in 38 ms.# æŒ‡å®šç±»åŠ è½½å™¨$ jad org.apache.log4j.Logger -c 69dcaba4 mc : Memory Compiler/å†…å­˜ç¼–è¯‘å™¨ï¼Œç¼–è¯‘.javaæ–‡ä»¶ç”Ÿæˆ.class 12345678# ç¼–è¯‘ï¼Œè¿™é‡Œä¸€å®šè¦æŒ‡å®šç±»åŠ è½½å™¨ï¼Œå¦åˆ™ä¼šæŠ¥é”™ï¼Œå› ä¸ºä½ ç¼–è¯‘çš„ç±»ä¸­å¯èƒ½importå…¶å®ƒç±»ï¼Œä¸æŒ‡å®šå°±ä¼šæç¤ºæ‰¾ä¸åˆ°å¯¹åº”çš„ç±»ã€‚# ç±»åŠ è½½å™¨å¯ä»¥é€šè¿‡ jad å‘½ä»¤è·å–mc --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader /tmp/UserController.java# æŒ‡å®šç±»åŠ è½½å™¨çš„ç¼–å·mc -c 5b2133b1 /tmp/UserController.java# å°† UserController.class æ–‡ä»¶è¾“å‡ºåˆ°æŒ‡å®šç›®å½•ï¼Œ -d æŒ‡å®šè¾“å‡ºç›®å½•mc --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader /tmp/UserController.java -d /tmp mc å‘½ä»¤æœ‰å¯èƒ½å¤±è´¥ã€‚å¦‚æœç¼–è¯‘å¤±è´¥å¯ä»¥åœ¨æœ¬åœ°ç¼–è¯‘å¥½.classæ–‡ä»¶ï¼Œå†ä¸Šä¼ åˆ°æœåŠ¡å™¨ã€‚ retransform : é‡æ–°åŠ è½½ç±»(çƒ­ä¿®æ”¹ä»£ç ) 123456789101112retransform /tmp/com/example/demo/arthas/user/UserController.class# æŸ¥çœ‹ é€šè¿‡ retransform é‡æ–°åŠ è½½çš„ classretransform -l# åˆ é™¤é€šè¿‡ retransform é‡æ–°åŠ è½½çš„ classï¼Œé€šè¿‡ id åˆ é™¤retransform -d 1# åˆ é™¤æ‰€æœ‰retransform --deleteAll# åˆ é™¤åè¦é‡æ–°è§¦å‘ retransformï¼Œå¦åˆ™å†…å­˜ä¸­ä¾æ—§ä½¿ç”¨çš„æ˜¯åˆ é™¤å‰çš„ classretransform --classPattern com.example.demo.arthas.user.UserController sysprop : æŸ¥çœ‹å½“å‰ JVM çš„ç³»ç»Ÿå±æ€§ 1234567891011# æ‰“å°ç³»ç»Ÿå±æ€§sysprop# æŒ‡å®šå•ä¸ª keyï¼Œkeyæ”¯æŒè‡ªåŠ¨è¡¥å…¨sysprop java.version# é€šè¿‡grepè¿‡æ»¤sysprop | grep user# è®¾ç½® æˆ– ä¿®æ”¹ ç³»ç»Ÿå±æ€§sysprop testKey testValue sysenv : æŸ¥çœ‹å½“å‰ JVM çš„ç¯å¢ƒå˜é‡ 123456# åˆ—å‡ºæ‰€æœ‰ç¯å¢ƒå˜é‡sysenv# æŒ‡å®šå•ä¸ª keyï¼Œkeyæ”¯æŒè‡ªåŠ¨è¡¥å…¨sysenv PATH# é€šè¿‡grepè¿‡æ»¤sysenv | grep PATH jvm : æŸ¥çœ‹å½“å‰ JVM çš„ä¿¡æ¯ï¼ŒåŒ…å«å¾ˆå¤šé‡è¦çš„ä¿¡æ¯ 1jvm GARBAGE-COLLECTORS GC ç›¸å…³ THREAD ç›¸å…³ 12345COUNT: JVM å½“å‰æ´»è·ƒçš„çº¿ç¨‹æ•°DAEMON-COUNT: JVM å½“å‰æ´»è·ƒçš„å®ˆæŠ¤çº¿ç¨‹æ•°PEAK-COUNT: ä» JVM å¯åŠ¨å¼€å§‹æ›¾ç»æ´»ç€çš„æœ€å¤§çº¿ç¨‹æ•°STARTED-COUNT: ä» JVM å¯åŠ¨å¼€å§‹æ€»å…±å¯åŠ¨è¿‡çš„çº¿ç¨‹æ¬¡æ•°DEADLOCK-COUNT: JVM å½“å‰æ­»é”çš„çº¿ç¨‹æ•° FILE-DESCRIPTOR æ–‡ä»¶æè¿°ç¬¦ç›¸å…³ 12MAX-FILE-DESCRIPTOR-COUNTï¼šJVM è¿›ç¨‹æœ€å¤§å¯ä»¥æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦æ•°OPEN-FILE-DESCRIPTOR-COUNTï¼šJVM å½“å‰æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦æ•° watch : å‡½æ•°æ‰§è¡Œæ•°æ®è§‚æµ‹ è®©ä½ èƒ½æ–¹ä¾¿çš„è§‚å¯Ÿåˆ°æŒ‡å®šå‡½æ•°çš„è°ƒç”¨æƒ…å†µã€‚èƒ½è§‚å¯Ÿåˆ°çš„èŒƒå›´ä¸ºï¼šè¿”å›å€¼ã€æŠ›å‡ºå¼‚å¸¸ã€å…¥å‚ï¼Œé€šè¿‡ç¼–å†™ OGNL è¡¨è¾¾å¼è¿›è¡Œå¯¹åº”å˜é‡çš„æŸ¥çœ‹ã€‚ 123456789101112131415161718192021# è§‚å¯ŸæŒ‡å®šç±»ä¸­æŸä¸ªæ–¹æ³•çš„è°ƒç”¨æƒ…å†µï¼ŒclassName + methodName + è¿”å›å€¼è¡¨è¾¾å¼# å¼€å¯åï¼Œå½“æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œä¼šæŒ‰ç…§æŒ‡å®šçš„ `è¿”å›å€¼è¡¨è¾¾å¼` è¾“å‡ºç»“æœï¼Œè¿”å›å€¼è¡¨è¾¾å¼ å¯ä»¥ä¸æŒ‡å®šï¼Œé»˜è®¤ä¸º &#123;params, target, returnObj&#125;watch com.example.demo.arthas.user.UserController findUserById &#x27;&#123;params, throwExp&#125;&#x27;# è§‚å¯Ÿå…¨éƒ¨æ–¹æ³•ï¼Œé€šé…ç¬¦åŒ¹é…watch com.example.demo.arthas.user.UserController &#x27;*&#x27; &#x27;&#123;params, throwExp&#125;&#x27;# é»˜è®¤è¾“å‡ºç»“æœæ²¡æœ‰å±•å¼€ï¼Œå¯ä»¥åŠ ä¸Š -x æŒ‡å®šè¾“å‡ºç»“æœçš„å±æ€§éå†æ·±åº¦ï¼Œé»˜è®¤ä¸º 1ï¼Œæœ€å¤§å€¼æ˜¯ 4watch com.example.demo.arthas.user.UserController &#x27;*&#x27; &#x27;&#123;params, throwExp&#125;&#x27; -x 2# ä»…å½“æŠ›å‡ºå¼‚å¸¸æ—¶æ‰æ‰“å°ï¼Œ-e åœ¨å‡½æ•°å¼‚å¸¸ä¹‹åè§‚å¯Ÿwatch com.example.demo.arthas.user.UserController &#x27;*&#x27; &#x27;&#123;params, throwExp&#125;&#x27; -x 2 -e# å‚æ•°æ¡ä»¶è¿‡æ»¤ï¼Œparams[0] &gt; 100 è¡¨ç¤ºæ–¹æ³•å…¥å‚ä¸­ç¬¬ä¸€ä¸ªå‚æ•°çš„å€¼å¤§äº 100 æ—¶æ‰è§¦å‘æ‰“å°watch com.example.demo.arthas.user.UserController * returnObj &#x27;params[0] &gt; 100&#x27;# æŒ‰è¯·æ±‚è€—æ—¶è¿›è¡Œè¿‡æ»¤ï¼Œ#cost&gt;200 è¡¨ç¤ºè€—æ—¶å¤§äº200mswatch com.example.demo.arthas.user.UserController * &#x27;&#123;params, returnObj&#125;&#x27; &#x27;#cost&gt;200&#x27;# é€€å‡ºwatchq watch å‘½ä»¤è¡¨è¾¾å¼æ”¯æŒå˜é‡è¯´æ˜è¡¨ åç§° ç±»å‹/è¯´æ˜ ä½œç”¨/å«ä¹‰ loader ClassLoader æ–¹æ³•æ‰€åœ¨ç±»çš„ç±»åŠ è½½å™¨å¯¹è±¡ clazz Class&lt;?&gt; æ–¹æ³•æ‰€å±çš„ç±»ï¼ˆClass å¯¹è±¡ï¼‰ method java.lang.reflect.Method è¢«è°ƒç”¨çš„æ–¹æ³•çš„åå°„å¯¹è±¡ target Object æ–¹æ³•çš„è°ƒç”¨ç›®æ ‡å¯¹è±¡ï¼ˆå³ this å¯¹è±¡ï¼‰ï¼Œé™æ€æ–¹æ³•ä¸­ä¸º null params Object[] æ–¹æ³•çš„å…¥å‚æ•°ç»„ returnObj Object æ–¹æ³•çš„è¿”å›å€¼ throwExp Throwable æ–¹æ³•æŠ›å‡ºçš„å¼‚å¸¸ isBefore boolean å½“å‰æ‰§è¡Œä½ç½®æ˜¯å¦æ˜¯æ–¹æ³•è°ƒç”¨ä¹‹å‰ï¼ˆBEFORE é˜¶æ®µï¼‰ isThrow boolean å½“å‰æ–¹æ³•æ˜¯å¦ä»¥å¼‚å¸¸ç»“æŸï¼ˆTHROWS é˜¶æ®µï¼‰ isReturn boolean å½“å‰æ–¹æ³•æ˜¯å¦æ­£å¸¸è¿”å›ï¼ˆRETURN é˜¶æ®µï¼‰ jobs : æŸ¥çœ‹è¿è¡Œä¸­çš„ä»»åŠ¡ 12345678910111213141516171819202122# å¦‚ä¸‹å‘½ä»¤ä¼šè½¬åˆ°åå°è¿è¡Œ ï¼Œä¸linuxå‘½ä»¤ç±»ä¼¼ï¼Œå‘½ä»¤æœ€ååŠ ä¸Š `&amp;` å³å¯watch com.example.demo.arthas.user.UserController * &#x27;&#123;params, throwExp&#125;&#x27; &#x27;throwExp != null&#x27; &gt;&gt; a.log &amp;# æŸ¥çœ‹åå°ä»»åŠ¡jobs## è¾“å‡º[1]* Running watch com.example.demo.arthas.user.UserController * &#x27;&#123;params, throwExp&#125;&#x27; &#x27;throwExp != null&#x27; &gt;&gt; a.log &amp; execution count : 0 start time : Thu May 15 15:10:04 CST 2025 timeout date : Fri May 16 15:10:04 CST 2025 session : ded56dfd-5683-4427-ac08-792f8fb75e5e (current)# ç»“æŸä»»åŠ¡kill 1 # 1ä¸ºåå°ä»»åŠ¡id# å°†åå°ä»»åŠ¡è½¬åˆ°å‰å°fg 1 # 1ä¸ºåå°ä»»åŠ¡id# æš‚åœä»»åŠ¡ï¼Œä½†æ­¤æ—¶ä¼šå°†arthasè¿›ç¨‹éƒ½æŒ‚èµ·ï¼Œæ‰€ä»¥å¹¶ä¸å¥½ç”¨ctrl+z# å°†å‰å°ä»»åŠ¡è½¬åˆ°åå°ç»§ç»­æ‰§è¡Œbg 1 # 1ä¸ºå‰å°ä»»åŠ¡id logger : æŸ¥çœ‹ logger ä¿¡æ¯ï¼Œæ›´æ–° logger level 1234567891011# æŸ¥çœ‹ logger ä¿¡æ¯logger# æŸ¥çœ‹æŒ‡å®šåå­—çš„loggerä¿¡æ¯logger -n ROOT# æŸ¥çœ‹æ²¡æœ‰ appender çš„ logger çš„ä¿¡æ¯ï¼Œä¸åŠ è¿™ä¸ªå‚æ•°åªä¼šæ‰“å°æœ‰ appender çš„ logger çš„ä¿¡æ¯logger --include-no-appender# æ›´æ–° logger levelï¼Œ-c classLoader çš„ hashcodelogger --name ROOT --level debug -c 5b2133b1logger --name ROOT --level error --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader classloader : æŸ¥çœ‹ classloader çš„ç»§æ‰¿æ ‘ï¼Œurlsï¼Œç±»åŠ è½½ä¿¡æ¯ 12345678# æŸ¥çœ‹ classloader çš„ä¿¡æ¯ï¼ŒåŠ è½½classçš„æ•°é‡ï¼Œhashcodeï¼Œclassloader çš„ parentclassloader -l# æ ‘å½¢å±•ç¤ºclassloader -t# æŸ¥æ‰¾èµ„æºï¼Œæ¯”å¦‚æŸ¥æ‰¾æŒ‡å®šåç§°çš„æ–‡ä»¶classloader -c 5b2133b1 -r application.propertiesclassloader --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader -r logback-spring.xml ognl : æ‰§è¡Œ ognl è¡¨è¾¾å¼ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152# è°ƒç”¨é™æ€å‡½æ•°ognl &#x27;@java.lang.System@out.println(&quot;hello&quot;)&#x27;ognl &#x27;@java.lang.Math@sqrt(9.0)&#x27;# è·å–é™æ€ç±»çš„é™æ€å­—æ®µognl &#x27;@java.io.File@separator&#x27;# éœ€è¦æŒ‡å®šclassLoaderClassognl --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader @com.example.demo.arthas.user.UserController@logger# è·å–classLoaderHashsc -d *UserController | grep classLoaderHashognl -c 5b2133b1 @com.example.demo.arthas.user.UserController@logger# è¿”å›å€¼å±•å¼€åŸºå±‚ -xognl -c 5b2133b1 @com.example.demo.arthas.user.UserController@logger -x 3# æ‰§è¡Œå¤šè¡Œè¡¨è¾¾å¼ï¼Œèµ‹å€¼ç»™ä¸´æ—¶å˜é‡ï¼Œè¿”å›ä¸€ä¸ª Listognl &#x27;#value1=@System@getProperty(&quot;java.home&quot;), #value2=@System@getProperty(&quot;java.runtime.name&quot;), &#123;#value1, #value2&#125;&#x27;# ç´¢å¼•# è·å–æ•°ç»„ä¸­çš„ç¬¬ä¸€ä¸ªå…ƒç´ ognl &quot;&#123;1,2,3,4&#125;[0]&quot;# å˜é‡å¼•ç”¨ï¼Œä½¿ç”¨ # åœ¨ OGNL ä¸­å®šä¹‰ä¸´æ—¶å˜é‡ï¼Œä»–ä»¬å…¨å±€å¯è§ï¼Œæ­¤å¤–è¡¨è¾¾å¼è®¡ç®—çš„æ¯ä¸€æ­¥ç»“æœéƒ½ä¿å­˜åœ¨å˜é‡ this ä¸­# ä¸‹é¢å‘½ä»¤é€šè¿‡è·å–åˆ—è¡¨çš„ç¬¬ä¸€ä¸ªå…ƒç´ è¿›è¡Œåˆ¤æ–­å¦‚æœå¤§äº 5 åˆ™ä¹˜ä»¥ 2 åä¹‹åˆ™åŠ  10ognl &quot;&#123;10,20,30&#125;[0].(#this &gt; 5 ? #this*2 : #this+10)&quot;# æ¯ä¸ªå…ƒç´ ä¹˜ä»¥ 2 åè¿”å›ognl &quot;&#123;1, 2, 3&#125;.&#123;#this*2&#125;&quot;# æ–¹æ³•è°ƒç”¨# é€šè¿‡ä¸‹é¢å‘½ä»¤å¯ä»¥è°ƒç”¨ ArrayList çš„ size() æ–¹æ³•è·å–åˆ° ArrayList çš„å¤§å°ognl &quot;&#123;1,2,3,4&#125;.size()&quot;# å¤æ‚é“¾å¼è¡¨è¾¾å¼ognl &quot;@java.lang.System@out.(print(&#x27;Hello &#x27;), print(&#x27;world\\n&#x27;))&quot;# æ–°å»ºåŸç”Ÿæ•°ç»„ognl &quot;new int[] &#123;1, 2, 3&#125;&quot;# æ–°å»ºæ™®é€š Mapognl &quot;#&#123; &#x27;foo&#x27;: &#x27;foo value&#x27;, &#x27;bar&#x27;: &#x27;bar value&#x27; &#125;&quot;# æ–°å»ºç‰¹å®šç±»å‹ Mapognl &quot;#@java.util.HashMap@&#123; &#x27;foo&#x27;: &#x27;foo value&#x27;, &#x27;bar&#x27;: &#x27;bar value&#x27; &#125;&quot;# æŸ¥æ‰¾æ‰€æœ‰åŒ¹é…çš„å…ƒç´ ognl &quot;&#123;1024, &#x27;Hello world!&#x27;, true, 2048&#125;.&#123;? #this instanceof Number&#125;&quot;# æŸ¥æ‰¾ç¬¬ä¸€ä¸ªåŒ¹é…çš„å…ƒç´ ognl &quot;&#123;1024, &#x27;Hello world!&#x27;, true, 2048&#125;.&#123;^ #this instanceof Number&#125;&quot;# æŸ¥æ‰¾æœ€åä¸€ä¸ªåŒ¹é…çš„å…ƒç´ ognl &quot;&#123;1024, &#x27;Hello world!&#x27;, true, 2048&#125;.&#123;$ #this instanceof Number&#125;&quot; vmoption : æŸ¥çœ‹ï¼Œæ›´æ–° VM è¯Šæ–­ç›¸å…³çš„å‚æ•° 1234567# æŸ¥çœ‹æ‰€æœ‰çš„ optionvmoption# æŸ¥çœ‹æŒ‡å®šçš„ optionvmoption PrintGC# æ›´æ–°æŒ‡å®šçš„ optionvmoption PrintGC truevmoption PrintGCDetails true vmtool : å®ç°æŸ¥è¯¢å†…å­˜å¯¹è±¡ï¼Œå¼ºåˆ¶ GC ç­‰åŠŸèƒ½ 1234567891011121314151617# è·å–å¯¹è±¡ï¼Œ--action getInstances: è·å–å¯¹è±¡å®ä¾‹ï¼Œ--className: æŒ‡å®šç±»åï¼Œ--limit: æŒ‡å®šè·å–æ•°é‡vmtool --action getInstances --className java.lang.String --limit 10# æŒ‡å®š classloader nameï¼Œè¿™é‡Œè·å– springçš„ ApplicationContext å¯¹è±¡ï¼Œ-x: å±•å¼€å¤šå°‘å±‚vmtool --action getInstances --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader --className org.springframework.context.ApplicationContext -x 3# æŒ‡å®š classloader hashsc -d org.springframework.context.ApplicationContext | grep classLoaderHashvmtool --action getInstances -c 19469ea2 --className org.springframework.context.ApplicationContext# æ‰§è¡Œè¡¨è¾¾å¼ï¼Œ--express: æ‰§è¡Œçš„è¡¨è¾¾å¼ï¼Œè¿™é‡Œæ˜¯è°ƒç”¨å¯¹è±¡çš„æ–¹æ³•vmtool --action getInstances --className com.example.demo.arthas.aop.HelloWorldService --express &#x27;instances[0].getHelloMessage()&#x27;# å¼ºåˆ¶ GCï¼Œå¯ä»¥ç»“åˆ vmoption å‘½ä»¤åŠ¨æ€æ‰“å¼€PrintGCå¼€å…³vmtool --action forceGc# ä¸­æ–­çº¿ç¨‹ï¼Œ -t çº¿ç¨‹ID,å¯ä»¥ä½¿ç”¨ threadå‘½ä»¤è·å–vmtool --action interruptThread -t 1","summary":"æ‘˜è¦ æœ¬æ–‡ä»‹ç»JVMçš„å‘½ä»¤è¡Œå·¥å…· JDK8 The JavaÂ® Virtual Machine Specification JDK8çš„javaæŒ‡ä»¤çš„å®˜â½…â½‚æ¡£ JDKâ¼¯å…·å®˜â½¹â½‚æ¡£ JDK17çš„javaæŒ‡ä»¤çš„å®˜â½…â½‚æ¡£","date_published":"2025-05-13T13:30:05.000Z","tags":["æŠ€æœ¯","jvm","jvm"]},{"id":"https://blog.hanqunfeng.com/2025/05/12/jvm-gc-01/","url":"https://blog.hanqunfeng.com/2025/05/12/jvm-gc-01/","title":"JVM ä¹‹ å†…å­˜æ¨¡å‹ä¸åƒåœ¾å›æ”¶æœºåˆ¶(GC)","content_html":"<!--\n **åŠ ç²—**\n *æ–œä½“*\n ***åŠ ç²—å¹¶æ–œä½“***\n ~~åˆ é™¤çº¿~~\n ==çªå‡ºæ˜¾ç¤º==\n `çªå‡ºæ˜¾ç¤º(æ¨è)`\n ++ä¸‹åˆ’çº¿++\n ~ä¸‹æ ‡~\n ^ä¸Šæ ‡^\n è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference.\n å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)\n\n +++ **ç‚¹å‡»æŠ˜å **\n è¿™æ˜¯è¢«éšè—çš„å†…å®¹\n +++\n\n::: tips success warning danger\nè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹\n:::\n\n% note info % success warning danger\nè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹\n% endnote %\n\nå¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{}\n å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ\n -->\n<h2 id=\"æ‘˜è¦\">æ‘˜è¦</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æœ¬æ–‡ä»‹ç»JVMçš„å†…å­˜æ¨¡å‹ä¸åƒåœ¾å›æ”¶æœºåˆ¶</p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://docs.oracle.com/javase/specs/jvms/se8/html/index.html\">JDK8 The JavaÂ® Virtual Machine Specification</a></p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://docs.oracle.com/javase/8/docs/technotes/tools/unix/java.html\">JDK8çš„javaæŒ‡ä»¤çš„å®˜â½…â½‚æ¡£</a></p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://docs.oracle.com/en/java/javase/17/docs/specs/man/index.html\">JDKâ¼¯å…·å®˜â½¹â½‚æ¡£</a></p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://docs.oracle.com/en/java/javase/17/docs/specs/man/java.html\">JDK17çš„javaæŒ‡ä»¤çš„å®˜â½…â½‚æ¡£</a></p>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"JVMè™šæ‹Ÿæœºç»“æ„-HotSpot\">JVMè™šæ‹Ÿæœºç»“æ„(HotSpot)</h2>\n<p><img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/cGMyEe.png\" alt=\"\"></p>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>è®¾ç½®å†…å­˜åˆ†é…ç¤ºä¾‹</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># jdk1.8+</span></span><br><span class=\"line\">java â€Xms2048M â€Xmx2048M â€Xmn1024M â€Xss512K â€XX:MetaspaceSize=128M â€XX:MaxMetaspaceSize=256M â€jar server.jar</span><br><span class=\"line\"><span class=\"comment\"># jdk1.6/1.7</span></span><br><span class=\"line\">java â€Xms2048M â€Xmx2048M â€Xmn1024M â€Xss512K â€XX:PermSize=128M â€XX:MaxPermSize=256M â€jar server.jar</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å„å‚æ•°å«ä¹‰ä¸é»˜è®¤å€¼ï¼ˆé’ˆå¯¹ JDK 1.8ï¼‰</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>å‚æ•°</th>\n<th>å«ä¹‰è¯´æ˜</th>\n<th>é»˜è®¤å€¼ï¼ˆJDK 1.8ï¼‰</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>-Xms2048M</code></td>\n<td><strong>åˆå§‹å †å¤§å°</strong>ï¼Œå³ JVM å¯åŠ¨æ—¶åˆ†é…çš„å †å†…å­˜å¤§å°ï¼ˆè¿™é‡Œæ˜¯ 2GBï¼‰</td>\n<td>ç‰©ç†å†…å­˜çš„ 1/64ï¼ˆæœ€å° 1MBï¼‰ï¼Œæ¨èé…ç½®ä¸ºä¸ -Xmx ä¸€è‡´</td>\n</tr>\n<tr>\n<td><code>-Xmx2048M</code></td>\n<td><strong>æœ€å¤§å †å†…å­˜å¤§å°</strong>ï¼ŒJVM å…è®¸åˆ†é…çš„æœ€å¤§å †å†…å­˜</td>\n<td>ç‰©ç†å†…å­˜çš„ 1/4ï¼ˆå—é™äº 32ä½/64ä½ï¼‰</td>\n</tr>\n<tr>\n<td><code>-Xmn1024M</code></td>\n<td><strong>æ–°ç”Ÿä»£å¤§å°</strong>ï¼ˆEden + Survivorï¼‰ä¸º 1GB</td>\n<td>æœªæ˜¾å¼æŒ‡å®šæ—¶ï¼Œé€šå¸¸å å †çš„ 1/3 å·¦å³</td>\n</tr>\n<tr>\n<td><code>-Xss512K</code></td>\n<td><strong>æ¯ä¸ªçº¿ç¨‹çš„æ ˆå¤§å°</strong>ï¼ˆThread Stack Sizeï¼‰ï¼Œè¿™é‡Œè®¾ç½®ä¸º 512KB</td>\n<td>1MBï¼ˆ64ä½ç³»ç»Ÿï¼‰æˆ– 512KBï¼ˆ32ä½ç³»ç»Ÿï¼‰</td>\n</tr>\n<tr>\n<td><code>-XX:MetaspaceSize=256M</code></td>\n<td><strong>å…ƒç©ºé—´åˆå§‹å¤§å°</strong>ï¼ˆç”¨äºåŠ è½½ç±»çš„å…ƒæ•°æ®ï¼Œä¸å†ä½¿ç”¨ PermGenï¼‰ï¼Œè¾¾åˆ°è¯¥å€¼åï¼ŒJVM ä¼šè§¦å‘ä¸€æ¬¡ GCï¼Œç©ºé—´ä¸å¤Ÿæ—¶ä¼šè¿›è¡Œæ‰©å®¹ï¼Œæœ€å¤§åˆ°  <code>MaxMetaspaceSize</code></td>\n<td>é»˜è®¤ 21MBï¼ˆå®¢æˆ·ç«¯ï¼‰æˆ– 16MBï¼ˆæœåŠ¡å™¨ç«¯ï¼‰ï¼Œä¸ºé¿å…é¢‘ç¹æ‰©å®¹å¯¼è‡´çš„GCï¼Œå¯ä»¥è®¾ç½®çš„ç¨å¾®å¤§ä¸€äº›ï¼Œæ¯”å¦‚<code>MaxMetaspaceSize</code>çš„ä¸€åŠï¼Œæˆ–å¹²è„†ä¸<code>MaxMetaspaceSize</code>ä¸€æ ·å¤§</td>\n</tr>\n<tr>\n<td><code>-XX:MaxMetaspaceSize=256M</code></td>\n<td><strong>å…ƒç©ºé—´æœ€å¤§å¤§å°</strong>ï¼Œæ¥è¿‘è®¾ç½®å€¼æ—¶ä¼šè§¦å‘ Full GC</td>\n<td>æ— é™åˆ¶ï¼ˆé»˜è®¤åªå—ç‰©ç†å†…å­˜çº¦æŸï¼‰ ï¼Œæ¨èé…ç½®ä¸€ä¸ªåˆé€‚çš„æ•°å€¼ï¼Œæ¯”å¦‚8Gçš„å†…å­˜å¯ä»¥é…ç½®ä¸º256M</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"ç±»è£…è½½å­ç³»ç»Ÿï¼ˆClass-Loading-Subsystemï¼‰\">ç±»è£…è½½å­ç³»ç»Ÿï¼ˆClass Loading Subsystemï¼‰</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ç±»è£…è½½å­ç³»ç»Ÿè´Ÿè´£å°† <code>.class</code> æ–‡ä»¶åŠ è½½åˆ° JVM ä¸­ï¼Œå¹¶è¿›è¡Œè§£æã€éªŒè¯ã€åˆå§‹åŒ–ç­‰è¿‡ç¨‹ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>åŠ è½½è¿‡ç¨‹çš„å‡ ä¸ªé˜¶æ®µï¼š</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>é˜¶æ®µ</th>\n<th>è¯´æ˜</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>åŠ è½½ï¼ˆLoadingï¼‰</strong></td>\n<td>å°† <code>.class</code> æ–‡ä»¶è¯»å–ä¸ºäºŒè¿›åˆ¶æ•°æ®ï¼Œæ„é€  <code>Class</code> å¯¹è±¡</td>\n</tr>\n<tr>\n<td><strong>éªŒè¯ï¼ˆVerificationï¼‰</strong></td>\n<td>ç¡®ä¿å­—èŠ‚ç æ–‡ä»¶æ ¼å¼æ­£ç¡®ã€å®‰å…¨åˆæ³•ï¼ˆé˜²æ­¢æ¶æ„ä»£ç ï¼‰</td>\n</tr>\n<tr>\n<td><strong>å‡†å¤‡ï¼ˆPreparationï¼‰</strong></td>\n<td>ä¸ºç±»çš„é™æ€å˜é‡åˆ†é…å†…å­˜ï¼Œå¹¶è®¾ç½®é»˜è®¤åˆå§‹å€¼</td>\n</tr>\n<tr>\n<td><strong>è§£æï¼ˆResolutionï¼‰</strong></td>\n<td>å°†å¸¸é‡æ± ä¸­çš„ç¬¦å·å¼•ç”¨æ›¿æ¢ä¸ºç›´æ¥å¼•ç”¨ï¼ˆæ–¹æ³•ã€å­—æ®µç­‰ï¼‰</td>\n</tr>\n<tr>\n<td><strong>åˆå§‹åŒ–ï¼ˆInitializationï¼‰</strong></td>\n<td>æ‰§è¡Œ <code>&lt;clinit&gt;</code> é™æ€åˆå§‹åŒ–æ–¹æ³•ï¼Œå¯¹é™æ€å˜é‡èµ‹åˆå§‹å€¼</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ç±»åŠ è½½å™¨ï¼ˆClassLoaderï¼‰ä½“ç³»ç»“æ„ï¼šè¯¦ç»†å‚è€ƒ <a href=\"/2025/05/08/jvm-classloader-01/\" title=\"JVM ä¹‹ ç±»åŠ è½½å™¨\">JVM ä¹‹ ç±»åŠ è½½å™¨</a></p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>ç±»åŠ è½½å™¨åç§°</th>\n<th>åŠ è½½å†…å®¹</th>\n<th>è¯´æ˜</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>å¼•å¯¼ç±»åŠ è½½å™¨ï¼ˆBootstrap ClassLoaderï¼‰</strong></td>\n<td>Java æ ¸å¿ƒç±»åº“ï¼ˆå¦‚ <code>java.lang.*</code>ï¼‰</td>\n<td>ç”± JVM è‡ªèº«å®ç°ï¼Œç”¨æœ¬åœ°ä»£ç å®ç°ï¼Œæ— æ³•ç›´æ¥è®¿é—®</td>\n</tr>\n<tr>\n<td><strong>æ‰©å±•ç±»åŠ è½½å™¨ï¼ˆExtension ClassLoaderï¼‰</strong></td>\n<td><code>JAVA_HOME/jre/lib/ext</code> ç›®å½•ä¸‹çš„ç±»</td>\n<td>åŠ è½½æ ‡å‡†æ‰©å±•ç±»åº“</td>\n</tr>\n<tr>\n<td><strong>åº”ç”¨ç±»åŠ è½½å™¨ï¼ˆApplication ClassLoaderï¼‰</strong></td>\n<td>ç”¨æˆ·åº”ç”¨ç±»è·¯å¾„ï¼ˆCLASSPATH æŒ‡å®šçš„ç›®å½•ï¼‰</td>\n<td>æœ€å¸¸ç”¨ï¼ŒåŠ è½½å¤§å¤šæ•°åº”ç”¨ä»£ç </td>\n</tr>\n<tr>\n<td><strong>è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼ˆCustom ClassLoaderï¼‰</strong></td>\n<td>ç”¨æˆ·æ‰‹åŠ¨å®ç°çš„ç±»åŠ è½½å™¨</td>\n<td>å¯ä»¥æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶ï¼Œå®ç°çƒ­åŠ è½½ã€åŠ å¯†ç±»åŠ è½½ç­‰</td>\n</tr>\n</tbody>\n</table>\n<blockquote>\n<p>ç±»åŠ è½½é‡‡ç”¨ åŒäº²å§”æ´¾æ¨¡å‹ï¼šè¯·æ±‚ä¼šå…ˆå‘çˆ¶åŠ è½½å™¨å§”æ‰˜ï¼Œåªæœ‰åœ¨çˆ¶åŠ è½½å™¨åŠ è½½å¤±è´¥æ—¶æ‰å°è¯•è‡ªèº«åŠ è½½ã€‚</p>\n</blockquote>\n<h3 id=\"å­—èŠ‚ç æ‰§è¡Œå¼•æ“ï¼ˆExecution-Engineï¼‰\">å­—èŠ‚ç æ‰§è¡Œå¼•æ“ï¼ˆExecution Engineï¼‰</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å­—èŠ‚ç æ‰§è¡Œå¼•æ“è´Ÿè´£å°† Java å­—èŠ‚ç è§£é‡Šæˆ–ç¼–è¯‘ä¸ºæœºå™¨ä»£ç ï¼Œå¹¶åœ¨åº•å±‚å¹³å°ä¸Šæ‰§è¡Œã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>æ‰§è¡Œå¼•æ“çš„æ ¸å¿ƒæ¨¡å—</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>ç»„ä»¶åç§°</th>\n<th>ä½œç”¨è¯´æ˜</th>\n<th>å…³é”®ç‰¹æ€§</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>è§£é‡Šå™¨ï¼ˆInterpreterï¼‰</strong></td>\n<td>å°†å­—èŠ‚ç é€æ¡è§£é‡Šæ‰§è¡Œ</td>\n<td>å¯åŠ¨å¿«ï¼Œé€‚åˆå†·ä»£ç ï¼ˆéçƒ­ç‚¹ä»£ç ï¼‰ï¼Œæ‰§è¡Œæ•ˆç‡ç›¸å¯¹è¾ƒä½</td>\n</tr>\n<tr>\n<td><strong>å³æ—¶ç¼–è¯‘å™¨ï¼ˆJIT Compilerï¼‰</strong></td>\n<td>å°†çƒ­ç‚¹ä»£ç ç¼–è¯‘ä¸ºæœ¬åœ°æœºå™¨ç ï¼Œæé«˜æ‰§è¡Œæ•ˆç‡</td>\n<td>åŒ…å« C1ï¼ˆClientï¼‰å’Œ C2ï¼ˆServerï¼‰ä¸¤ç§ï¼Œæ”¯æŒä¼˜åŒ–å¦‚ï¼šæ–¹æ³•å†…è”ã€é€ƒé€¸åˆ†æã€å¾ªç¯å±•å¼€ç­‰</td>\n</tr>\n<tr>\n<td><strong>åƒåœ¾æ”¶é›†å™¨ï¼ˆGarbage Collector, GCï¼‰</strong></td>\n<td>è‡ªåŠ¨å†…å­˜ç®¡ç†ï¼Œè´Ÿè´£å¯¹è±¡ç”Ÿå‘½å‘¨æœŸçš„å›æ”¶</td>\n<td>å¸¸è§ç®—æ³•åŒ…æ‹¬ï¼šSerialã€Parallelã€CMSã€G1ã€ZGCï¼ˆä½å»¶è¿Ÿï¼‰ç­‰ï¼Œæ ¹æ®ä¸åŒåœºæ™¯é€‰æ‹©</td>\n</tr>\n<tr>\n<td><strong>æœ¬åœ°æ¥å£ï¼ˆNative Interfaceï¼‰</strong></td>\n<td>æ”¯æŒ Java ä¸æœ¬åœ°è¯­è¨€ï¼ˆå¦‚ C/C++ï¼‰çš„äº’æ“ä½œ</td>\n<td>é€šè¿‡ JNIï¼ˆJava Native Interfaceï¼‰å®ç°ï¼Œè°ƒç”¨åº•å±‚æ“ä½œç³»ç»Ÿæˆ–ç¬¬ä¸‰æ–¹åº“åŠŸèƒ½</td>\n</tr>\n</tbody>\n</table>\n<div class=\"tips\">\n<p><em><strong>å³æ—¶ç¼–è¯‘å™¨ï¼ˆJIT Compilerï¼‰</strong></em></p>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">JVM çš„ HotSpot ç¼–è¯‘å™¨æœ‰ä¸¤ä¸ªä¸»è¦ç»„ä»¶ï¼š<br>\nC1 ç¼–è¯‘å™¨ï¼ˆClient ç¼–è¯‘å™¨ï¼‰ï¼šè½»é‡ã€å¿«é€Ÿç¼–è¯‘ï¼Œä¼˜åŒ–å°‘ã€‚<br>\nC2 ç¼–è¯‘å™¨ï¼ˆServer ç¼–è¯‘å™¨ï¼‰ï¼šä¼˜åŒ–é«˜çº§ï¼Œè€—æ—¶é•¿ï¼Œé€‚åˆé•¿æ—¶é—´è¿è¡Œçš„çƒ­ç‚¹ä»£ç ã€‚</li>\n<li class=\"lvl-2\">åœ¨ 64 ä½ JDK ä¸­ï¼Œé»˜è®¤å°±æ˜¯ -server æ¨¡å¼ <code>(C2 ç¼–è¯‘å™¨)</code> ï¼Œä¸å†æ”¯æŒ -client <code>(C1 ç¼–è¯‘å™¨)</code>ã€‚</li>\n<li class=\"lvl-2\">åœ¨ 32 ä½ JDK ä¸­ï¼Œæ ¹æ®å¹³å°å’Œå¯åŠ¨æ–¹å¼ï¼Œå¯èƒ½ä¼šè‡ªåŠ¨é€‰æ‹© -client æˆ– -serverï¼Œä¹Ÿå¯ä»¥æ‰‹åŠ¨æŒ‡å®šã€‚</li>\n<li class=\"lvl-2\">åˆ†å±‚ç¼–è¯‘ï¼ˆTiered Compilationï¼‰ å…è®¸ JVM åœ¨ä¸€å¼€å§‹ç”¨ C1 ç¼–è¯‘å™¨å¿«é€Ÿç¼–è¯‘å­—èŠ‚ç ï¼Œåç»­çƒ­ç‚¹ä»£ç å†äº¤ç»™ C2 ç¼–è¯‘å™¨è¿›è¡Œæ›´é«˜çº§ä¼˜åŒ–ã€‚è¿™æ ·ç»“åˆäº† -clientï¼ˆå¿«å¯åŠ¨ï¼‰å’Œ -serverï¼ˆé«˜æ€§èƒ½ï¼‰çš„ä¼˜ç‚¹ã€‚<code>TieredCompilation</code>å‚æ•°æ§åˆ¶æ˜¯å¦å¼€å¯åˆ†å±‚ç¼–è¯‘ï¼Œé»˜è®¤å¼€å¯ã€‚</li>\n<li class=\"lvl-2\"><code>-XX:TieredStopAtLeve=&lt;level&gt;</code> å‚æ•°æ§åˆ¶ ç¼–è¯‘å™¨æœ€å¤šä½¿ç”¨å“ªä¸€å±‚ä¼˜åŒ–çº§åˆ«ã€‚å®ƒçš„å–å€¼å¦‚ä¸‹ï¼Œå€¼è¶Šä½å¯åŠ¨è¶Šå¿«ï¼Œä½†ä¼˜åŒ–è¶Šå°‘ã€‚</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>å€¼</th>\n<th>å«ä¹‰</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>0</td>\n<td>ä»…è§£é‡Šæ‰§è¡Œï¼ˆä¸å¼€å¯ç¼–è¯‘å™¨ï¼‰</td>\n</tr>\n<tr>\n<td>1</td>\n<td>åªä½¿ç”¨ C1 ç¼–è¯‘å™¨çš„ç¬¬ä¸€çº§ï¼ˆæœ€å°‘ä¼˜åŒ–ï¼‰</td>\n</tr>\n<tr>\n<td>2</td>\n<td>C1 ç¬¬äºŒçº§ï¼Œç•¥å¤šä¼˜åŒ–</td>\n</tr>\n<tr>\n<td>3</td>\n<td>C1 ç¬¬ä¸‰çº§ï¼Œæ›´ä¼˜åŒ–</td>\n</tr>\n<tr>\n<td>4</td>\n<td>å¯ç”¨ C2 ç¼–è¯‘å™¨ï¼ˆå®Œå…¨ä¼˜åŒ–ï¼Œé»˜è®¤å€¼ï¼‰</td>\n</tr>\n</tbody>\n</table>\n</div>\n<h3 id=\"JVM-å†…å­˜æ¨¡å‹ï¼ˆJava-Memory-Modelï¼ŒJMMï¼‰\">JVM å†…å­˜æ¨¡å‹ï¼ˆJava Memory Modelï¼ŒJMMï¼‰</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>JMM æ˜¯ Java è™šæ‹Ÿæœºè§„èŒƒä¸­å®šä¹‰çš„ä¸€ç§ æŠ½è±¡å†…å­˜æ¨¡å‹ï¼Œå®ƒå†³å®šäº†å¤šçº¿ç¨‹ç¨‹åºä¸­å˜é‡çš„è¯»å†™å¯è§æ€§ã€æœ‰åºæ€§å’ŒåŸå­æ€§ã€‚åŒæ—¶ï¼ŒJVM åœ¨ç‰©ç†å±‚ä¹Ÿæœ‰ä¸€ä¸ªå®é™…çš„å†…å­˜ç»“æ„ï¼Œç§°ä¸ºè¿è¡Œæ—¶æ•°æ®åŒºåŸŸï¼ˆRuntime Data Areasï¼‰ï¼Œè¿™ä¸¤ä¸ªå¯ä»¥ç»“åˆç†è§£ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>JMM çš„ä¸»è¦ç›®æ ‡</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">ä¿è¯å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„æ•°æ®ä¸€è‡´æ€§</li>\n<li class=\"lvl-6\">æŒ‡å¯¼ JVM å’Œ CPU çš„å†…å­˜äº¤äº’è¡Œä¸ºï¼ˆå¦‚é‡æ’åºã€ç¼“å­˜ï¼‰</li>\n</ul>\n</li>\n<li class=\"lvl-2\">\n<p>å®é™…è¿è¡Œæ—¶å†…å­˜ç»“æ„å¦‚ä¸‹ï¼š</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>å†…å­˜åŒºåŸŸ</th>\n<th>è¯´æ˜</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>ğŸ“Œ <strong>ç¨‹åºè®¡æ•°å™¨ï¼ˆPCï¼‰</strong></td>\n<td>æ¯ä¸ªçº¿ç¨‹ç§æœ‰ï¼Œè®°å½•å½“å‰æ‰§è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤åœ°å€</td>\n</tr>\n<tr>\n<td>ğŸ“Œ <strong>Java çº¿ç¨‹æ ˆ</strong></td>\n<td>æ¯ä¸ªçº¿ç¨‹ç§æœ‰ï¼Œæ–¹æ³•è°ƒç”¨æ—¶ç”¨äºå­˜å‚¨å±€éƒ¨å˜é‡ã€æ“ä½œæ•°æ ˆç­‰</td>\n</tr>\n<tr>\n<td>ğŸ“Œ <strong>æœ¬åœ°æ–¹æ³•æ ˆ</strong></td>\n<td>ä¸è™šæ‹Ÿæœºæ ˆç±»ä¼¼ï¼Œç”¨äº native æ–¹æ³•</td>\n</tr>\n<tr>\n<td>ğŸ“Œ <strong>å †ï¼ˆHeapï¼‰</strong></td>\n<td>æ‰€æœ‰çº¿ç¨‹å…±äº«ï¼Œå­˜å‚¨å¯¹è±¡å®ä¾‹ã€æ•°ç»„ç­‰ï¼ŒGC çš„ä¸»è¦åŒºåŸŸ</td>\n</tr>\n<tr>\n<td>ğŸ“Œ <strong>æ–¹æ³•åŒºï¼ˆæˆ–å…ƒç©ºé—´ï¼‰</strong></td>\n<td>æ‰€æœ‰çº¿ç¨‹å…±äº«ï¼Œå­˜å‚¨ç±»ä¿¡æ¯ã€é™æ€å˜é‡ã€å¸¸é‡æ± ç­‰ï¼ˆJDK8 åç§°ä¸º Metaspaceï¼‰</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"åƒåœ¾å›æ”¶å™¨\">åƒåœ¾å›æ”¶å™¨</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åƒåœ¾å›æ”¶å™¨è´Ÿè´£è‡ªåŠ¨ç®¡ç†å†…å­˜ï¼Œå›æ”¶ä¸å†ä½¿ç”¨çš„å¯¹è±¡ï¼Œé¿å…å†…å­˜æ³„æ¼å’Œæº¢å‡ºã€‚</p>\n</li>\n</ul>\n<h3 id=\"ä»€ä¹ˆæ˜¯åƒåœ¾\">ä»€ä¹ˆæ˜¯åƒåœ¾</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å†…å­˜ä¸­æ²¡æœ‰è¢«ï¼ˆçº¿ç¨‹æ ˆå˜é‡ï¼Œé™æ€å˜é‡ï¼Œå¸¸é‡æ± ï¼ŒJNIæŒ‡é’ˆï¼‰å¼•ç”¨çš„åœ°å€å°±æ˜¯åƒåœ¾</p>\n</li>\n<li class=\"lvl-2\">\n<p>å¯è¾¾æ€§åˆ†æç®—æ³•ï¼šæ˜¯ç°ä»£ JVM åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡æ˜¯å¦â€œè¿˜æ´»ç€â€çš„ä¸»è¦ç®—æ³•ã€‚</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">åŸºæœ¬æ€æƒ³ï¼š</span><br><span class=\"line\">ä»ä¸€ç»„ç§°ä¸º â€œGC Rootsâ€ çš„å¯¹è±¡å‡ºå‘ï¼Œæ²¿ç€å¯¹è±¡ä¹‹é—´çš„å¼•ç”¨é“¾å‘ä¸‹æœç´¢ã€‚</span><br><span class=\"line\">å¦‚æœæŸä¸ªå¯¹è±¡ å¯ä»¥ä» GC Roots è¿½è¸ªåˆ°ï¼Œå°±è®¤ä¸ºå®ƒæ˜¯ â€œå¯è¾¾â€ çš„ï¼ˆAliveï¼‰ã€‚</span><br><span class=\"line\">å¦åˆ™å°±è®¤ä¸ºæ˜¯ â€œä¸å¯è¾¾â€ çš„ï¼ˆGarbageï¼‰ï¼Œå¯ä»¥è¢«å›æ”¶ã€‚</span><br></pre></td></tr></table></figure>\n<div class=\"tips\">\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">\n<p>åœ¨ JVM ä¸­ï¼Œ<code>GC Roots</code> æ˜¯ä¸€äº› å§‹ç»ˆå¯ç”¨çš„ã€ä¸ä¼šè¢«åƒåœ¾å›æ”¶çš„å¼•ç”¨èµ·ç‚¹ï¼Œä¸»è¦åŒ…æ‹¬ï¼š</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>GC Roots æ¥æº</th>\n<th>è¯´æ˜</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>å½“å‰çº¿ç¨‹æ ˆä¸­çš„å¼•ç”¨ï¼ˆå±€éƒ¨å˜é‡è¡¨ï¼‰</td>\n<td>å„ä¸ªçº¿ç¨‹æ­£åœ¨è°ƒç”¨çš„æ–¹æ³•ä¸­çš„å±€éƒ¨å˜é‡ã€å‚æ•°ç­‰</td>\n</tr>\n<tr>\n<td>é™æ€å­—æ®µå¼•ç”¨</td>\n<td>ç±»çš„é™æ€å­—æ®µå¼•ç”¨çš„å¯¹è±¡</td>\n</tr>\n<tr>\n<td>JNI å¼•ç”¨ï¼ˆNative æ–¹æ³•å¼•ç”¨ï¼‰</td>\n<td>Java æœ¬åœ°æ–¹æ³•ä¸­å¼•ç”¨çš„å¯¹è±¡</td>\n</tr>\n<tr>\n<td>å¸¸é‡å¼•ç”¨æ± ä¸­çš„å¯¹è±¡</td>\n<td>å­—ç¬¦ä¸²å¸¸é‡ç­‰å¯èƒ½æŒæœ‰å¯¹è±¡å¼•ç”¨</td>\n</tr>\n<tr>\n<td>æ´»åŠ¨çº¿ç¨‹å¯¹è±¡</td>\n<td>çº¿ç¨‹è‡ªèº«åœ¨ GC æ—¶ä¸ä¼šè¢«å›æ”¶</td>\n</tr>\n<tr>\n<td>JVM å†…éƒ¨ç»“æ„ï¼ˆå¦‚ç³»ç»Ÿç±»åŠ è½½å™¨ç­‰ï¼‰</td>\n<td>JVM å…³é”®ç³»ç»Ÿå¯¹è±¡</td>\n</tr>\n</tbody>\n</table>\n</div>\n<h3 id=\"åƒåœ¾å›æ”¶å™¨ç§ç±»ï¼š\">åƒåœ¾å›æ”¶å™¨ç§ç±»ï¼š</h3>\n<p><img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/TEILZ9.png\" alt=\"\"></p>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å·¦è¾¹6ç§å«åˆ†ä»£æ¨¡å‹ï¼Œå³è¾¹çš„4ç§å«åˆ†åŒºæ¨¡å‹</p>\n</li>\n</ul>\n<div class=\"tips\">\n<p><em><strong>åˆ†ä»£æ¨¡å‹ï¼ˆGenerational Modelï¼‰</strong></em><br>\nå †å†…å­˜åˆ’åˆ†ä¸ºï¼š<br>\nå¹´è½»ä»£ï¼ˆYoung Generationï¼‰ï¼šå­˜æ”¾æ–°åˆ›å»ºçš„å¯¹è±¡ï¼Œåˆ†ä¸º Eden å’Œ Survivor åŒºã€‚<br>\nè€å¹´ä»£ï¼ˆOld Generationï¼‰ï¼šå­˜æ”¾ç»è¿‡å¤šæ¬¡ GC åä»ç„¶å­˜æ´»çš„å¯¹è±¡ã€‚</p>\n<p><em><strong>åˆ†åŒºæ¨¡å‹ï¼ˆRegion-based Modelï¼‰</strong></em><br>\nåˆ†åŒºæ¨¡å‹ï¼ˆå¦‚ G1ã€ZGCã€Shenandoahï¼‰ä¸å†ä¸¥æ ¼æŒ‰ç…§ä»£åˆ’åˆ†å†…å­˜ï¼Œè€Œæ˜¯æŠŠå †åˆ’åˆ†ä¸ºå¤šä¸ª å¤§å°ç›¸åŒçš„ Regionã€‚æ¯ä¸ª Region å¯ä»¥åœ¨è¿è¡Œæ—¶è¢«åŠ¨æ€æ ‡è®°ä¸º Edenã€Survivor æˆ– Oldã€‚</p>\n</div>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åˆ†ä»£æ¨¡å‹ä¸­ï¼Œä¸Šé¢3ä¸ªæ˜¯æ–°ç”Ÿä»£åƒåœ¾å›æ”¶å™¨ï¼Œä¸‹é¢3ä¸ªæ˜¯è€å¹´ä»£åƒåœ¾å›æ”¶å™¨ï¼Œå¯ä»¥äº¤å‰é…å¯¹ï¼ˆè§ä¸Šå›¾è™šçº¿ï¼‰ï¼Œä½†æœ€å¸¸ç”¨æ˜¯ä¸Šä¸‹ä¸¤ä¸¤é…å¯¹ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>CMSå³å¯ä»¥ä½œä¸ºæ–°ç”Ÿä»£åƒåœ¾å›æ”¶å™¨ï¼Œä¹Ÿå¯ä»¥ä½œä¸ºè€å¹´ä»£åƒåœ¾å›æ”¶å™¨ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>EpsilonGCï¼Œæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„åƒåœ¾å›æ”¶å™¨ï¼Œå®ƒä¸å›æ”¶ä»»ä½•å¯¹è±¡ï¼Œåªè´Ÿè´£æœ€ç»ˆè®°å½•ï¼Œåšæµ‹è¯•ç”¨çš„ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>ç›®å‰æœ€å…ˆè¿›çš„æ¨¡å‹æ˜¯ <code>ZGC</code>ï¼Œjkd11å¼€å§‹æ”¯æŒï¼Œä½†ç›´åˆ°JDK16æ‰æ¯”è¾ƒå®Œå–„ï¼Œç›®å‰éé»˜è®¤é…ç½®ï¼Œéœ€è¦æ‰‹åŠ¨é…ç½®ã€‚å…¶ä¸Redhatå‡ºå“çš„ <code>Shenandoah</code> æ˜¯ç«äº‰å…³ç³»ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>å¸¸è§åƒåœ¾å›æ”¶å™¨åŠå…¶åˆ†ç±»ã€JDKç‰ˆæœ¬</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>åƒåœ¾å›æ”¶å™¨</th>\n<th>æ‰€å±æ¨¡å‹</th>\n<th>è¯´æ˜</th>\n<th>é¦–æ¬¡å‡ºç° JDK ç‰ˆæœ¬</th>\n<th>å¯ç”¨å‘½ä»¤ï¼ˆJVM å‚æ•°ï¼‰</th>\n<th>é€‚åˆçš„å †å†…å­˜å¤§å°</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>Serial</strong></td>\n<td>åˆ†ä»£æ¨¡å‹</td>\n<td>å•çº¿ç¨‹ï¼Œæ–°ç”Ÿä»£å’Œè€å¹´ä»£éƒ½ä½¿ç”¨ Serialï¼Œé€‚ç”¨äºå°å †å†…å­˜, <code>å·²å¼ƒç”¨</code></td>\n<td>JDK 1.2</td>\n<td><code>-XX:+UseSerialGC</code></td>\n<td>ğŸ’¾ å°äº 1GB</td>\n</tr>\n<tr>\n<td><strong>ParNew</strong></td>\n<td>åˆ†ä»£æ¨¡å‹</td>\n<td>Serial çš„å¤šçº¿ç¨‹ç‰ˆæœ¬ï¼Œ<strong>ä»…ç”¨äº CMS æ–°ç”Ÿä»£</strong>, <code>JDK11å·²å¼ƒç”¨</code></td>\n<td>JDK 1.4</td>\n<td><code>-XX:+UseParNewGC -XX:+UseConcMarkSweepGC</code></td>\n<td>ğŸ’¾ 1GB ~ 4GB</td>\n</tr>\n<tr>\n<td><strong>Parallelï¼ˆååé‡ GCï¼‰</strong></td>\n<td>åˆ†ä»£æ¨¡å‹</td>\n<td>å¤šçº¿ç¨‹ GCï¼Œé€‚åˆååé‡ä¼˜å…ˆçš„åº”ç”¨åœºæ™¯</td>\n<td>JDK 1.4</td>\n<td><code>-XX:+UseParallelGC</code>ï¼ˆæ–°ç”Ÿä»£ï¼‰<br><code>-XX:+UseParallelOldGC</code>ï¼ˆè€å¹´ä»£ï¼‰</td>\n<td>ğŸ’¾ 2GB ~ 8GB</td>\n</tr>\n<tr>\n<td><strong>CMSï¼ˆConcurrent Mark Sweepï¼‰</strong></td>\n<td>åˆ†ä»£æ¨¡å‹</td>\n<td>è€å¹´ä»£å¹¶å‘æ ‡è®°-æ¸…é™¤ï¼Œä½å»¶è¿Ÿï¼Œä½†å­˜åœ¨ç¢ç‰‡ï¼Œ<code>JDK14å·²å¼ƒç”¨</code></td>\n<td>JDK 1.4</td>\n<td><code>-XX:+UseConcMarkSweepGC</code></td>\n<td>ğŸ’¾ 2GB ~ 8GB</td>\n</tr>\n<tr>\n<td><strong>G1ï¼ˆGarbage Firstï¼‰</strong></td>\n<td>åˆ†åŒºæ¨¡å‹</td>\n<td>å°†å †åˆ’åˆ†ä¸º Regionï¼Œé€»è¾‘åˆ†ä»£ï¼Œæ”¯æŒå¹¶å‘å‹ç¼©ï¼Œå¹³è¡¡å»¶è¿Ÿä¸åå</td>\n<td>JDK 7u4ï¼ˆæ­£å¼ï¼‰</td>\n<td><code>-XX:+UseG1GC</code></td>\n<td>ğŸ’¾ 4GB ~ æ•°å GB</td>\n</tr>\n<tr>\n<td><strong>ZGCï¼ˆZ Garbage Collectorï¼‰</strong></td>\n<td>åˆ†åŒºæ¨¡å‹</td>\n<td>Region å¼¹æ€§å¤§å°ï¼Œæ”¯æŒè¶…å¤§å †ï¼Œä½å»¶è¿Ÿï¼ˆ&lt;10ms åœé¡¿ï¼‰</td>\n<td>JDK 11ï¼ˆå®éªŒï¼‰ï¼ŒJDK 15ï¼ˆæ­£å¼ï¼‰</td>\n<td><code>-XX:+UseZGC</code></td>\n<td>ğŸ’¾ 8GB ~ æ•° TBï¼ˆè¶…å¤§å †ï¼‰</td>\n</tr>\n<tr>\n<td><strong>Shenandoah</strong></td>\n<td>åˆ†åŒºæ¨¡å‹</td>\n<td>çº¢å¸½ä¸»å¯¼ï¼Œä½å»¶è¿Ÿï¼Œå¹¶å‘å›æ”¶ä¸å¹¶å‘å‹ç¼©</td>\n<td>JDK 12ï¼ˆå®éªŒï¼‰ï¼ŒJDK 15ï¼ˆæ­£å¼ï¼‰</td>\n<td><code>-XX:+UseShenandoahGC</code></td>\n<td>ğŸ’¾ 2GB ~ æ•°å GB</td>\n</tr>\n</tbody>\n</table>\n<blockquote>\n<p>å¯¹äº CMSï¼Œå¯ç”¨åä¼šè‡ªåŠ¨ä½¿ç”¨ ParNew ä½œä¸ºæ–°ç”Ÿä»£å›æ”¶å™¨ï¼ˆé™¤éæ˜¾å¼ç¦æ­¢ï¼‰ã€‚<br>\nå¯¹äº Parallel GC å¯ç”¨ <code>-XX:+UseParallelGC</code>ï¼ˆæ–°ç”Ÿä»£ï¼‰ä¼šè‡ªåŠ¨å¯ç”¨ <code>-XX:+UseParallelOldGC</code>ï¼ˆè€å¹´ä»£ï¼‰ã€‚<br>\nå¯¹äºZGCï¼Œjdk15ä»¥å‰æœ€å¤§æ”¯æŒ4Tå†…å­˜ï¼Œä¹‹åæœ€å¤§æ”¯æŒ16Tå†…å­˜ã€‚</p>\n</blockquote>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å„ç‰ˆæœ¬é»˜è®¤åƒåœ¾å›æ”¶å™¨åŠæ¨èé…ç½®ï¼ˆJDK 1.6 èµ·ï¼‰</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>JDK ç‰ˆæœ¬</th>\n<th>é»˜è®¤ GC</th>\n<th>å»ºè®®ä½¿ç”¨ GCï¼ˆæŒ‰åœºæ™¯åˆ†ç±»ï¼‰</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>JDK 1.6</strong></td>\n<td>Serial / Parallel</td>\n<td>- å°å‹åº”ç”¨ï¼ˆå¦‚æ¡Œé¢ç¨‹åºï¼‰ï¼š<code>-XX:+UseSerialGC</code>  <br> - ä¸­å¤§å‹åº”ç”¨ï¼ˆååé‡ä¼˜å…ˆï¼‰ï¼š<code>-XX:+UseParallelGC</code></td>\n</tr>\n<tr>\n<td><strong>JDK 1.7</strong></td>\n<td>åŒä¸Š</td>\n<td>åŒ JDK 1.6</td>\n</tr>\n<tr>\n<td><strong>JDK 1.8</strong></td>\n<td>Parallel</td>\n<td>- ååä¼˜å…ˆï¼šé»˜è®¤ <code>-XX:+UseParallelGC</code> <br> - å“åº”ä¼˜å…ˆï¼š<code>-XX:+UseConcMarkSweepGC</code>ï¼ˆCMSï¼‰<br> - å¤§å † + æœªæ¥å‡çº§è€ƒè™‘ï¼š<code>-XX:+UseG1GC</code>ï¼ˆæ¨èï¼‰</td>\n</tr>\n<tr>\n<td><strong>JDK 9-14</strong></td>\n<td>G1 GC</td>\n<td>- ä¸€èˆ¬é»˜è®¤å³å¯ï¼š<code>-XX:+UseG1GC</code>ï¼ˆå»¶è¿Ÿä¸ååå¹³è¡¡ï¼‰<br> - æç«¯ä½å»¶è¿Ÿè¦æ±‚ï¼šå‡çº§åˆ° JDK 11+ ä½¿ç”¨ ZGC/Shenandoah</td>\n</tr>\n<tr>\n<td><strong>JDK 15+</strong></td>\n<td>G1 GCï¼ˆé»˜è®¤ï¼‰ï¼ŒZGC / Shenandoah å¯é€‰</td>\n<td>- å»¶è¿Ÿæ•æ„Ÿï¼ˆåœ¨çº¿æœåŠ¡ã€RTç³»ç»Ÿï¼‰ï¼š<code>-XX:+UseZGC</code> æˆ– <code>-XX:+UseShenandoahGC</code><br> - ååä¸ºä¸»ï¼š<code>-XX:+UseParallelGC</code><br> - ç»¼åˆå¹³è¡¡ï¼š<code>-XX:+UseG1GC</code>ï¼ˆé»˜è®¤ï¼‰</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åˆ¤æ–­é»˜è®¤ GC çš„æ–¹å¼</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">java -XX:+PrintCommandLineFlags -version</span><br></pre></td></tr></table></figure>\n<h3 id=\"åƒåœ¾å›æ”¶ç®—æ³•\">åƒåœ¾å›æ”¶ç®—æ³•</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>JVM ä¸­å¸¸è§åƒåœ¾å›æ”¶ç®—æ³•æ±‡æ€»</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>ç®—æ³•åç§°</th>\n<th>æ ¸å¿ƒæ€æƒ³</th>\n<th>é€‚ç”¨é˜¶æ®µ/åŒºåŸŸ</th>\n<th>ä¼˜ç¼ºç‚¹ç®€è¿°</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>æ ‡è®°-æ¸…é™¤ï¼ˆMark-Sweepï¼‰</strong></td>\n<td>æ ‡è®°å‡ºå­˜æ´»å¯¹è±¡ï¼Œæ¸…é™¤æœªæ ‡è®°å¯¹è±¡</td>\n<td>è€å¹´ä»£</td>\n<td>ç®€å•é«˜æ•ˆï¼Œä½†ä¼šäº§ç”Ÿå¤§é‡ç¢ç‰‡ï¼Œä¸é€‚åˆè¿ç»­å†…å­˜åˆ†é…</td>\n</tr>\n<tr>\n<td><strong>æ ‡è®°-æ•´ç†ï¼ˆMark-Compactï¼‰</strong></td>\n<td>æ ‡è®°åç§»åŠ¨å­˜æ´»å¯¹è±¡ï¼Œæ•´ç†ç¢ç‰‡</td>\n<td>è€å¹´ä»£</td>\n<td>æ¶ˆé™¤ç¢ç‰‡ï¼Œä»£ä»·æ˜¯ç§»åŠ¨å¯¹è±¡ï¼Œé€‚ç”¨äºè€å¹´ä»£å‹ç¼©</td>\n</tr>\n<tr>\n<td><strong>å¤åˆ¶ç®—æ³•ï¼ˆCopyingï¼‰</strong></td>\n<td>å°†å¯¹è±¡å¤åˆ¶åˆ°å¦ä¸€å—å†…å­˜ï¼ˆå¦‚ Eden â†’ Survivorï¼‰</td>\n<td>æ–°ç”Ÿä»£</td>\n<td>é«˜æ•ˆç‡ï¼Œé€‚åˆå›æ”¶å¤§å¤šæ•°å¯¹è±¡çŸ­å‘½çš„æ–°ç”Ÿä»£ï¼Œä½†éœ€è¦é¢å¤–ç©ºé—´</td>\n</tr>\n<tr>\n<td><strong>åˆ†ä»£å›æ”¶ï¼ˆGenerationalï¼‰</strong></td>\n<td>å°†å¯¹è±¡æŒ‰ç”Ÿå‘½å‘¨æœŸåˆ’åˆ†ï¼ˆæ–°ç”Ÿä»£/è€å¹´ä»£ï¼‰</td>\n<td>æ•´ä¸ªå †ç»“æ„</td>\n<td>å®ç”¨æ€§å¼ºï¼Œç»“åˆä¸åŒç®—æ³•åº”ç”¨äºä¸åŒä»£ï¼Œç°ä»£ GC åŸºç¡€</td>\n</tr>\n<tr>\n<td><strong>åˆ†åŒºå›æ”¶ï¼ˆRegion-basedï¼‰</strong></td>\n<td>å°†å †åˆ’åˆ†ä¸ºè‹¥å¹²ç­‰å¤§å°çš„ Region åŠ¨æ€åˆ†é…</td>\n<td>æ•´ä¸ªå †ï¼ˆå¦‚ G1ã€ZGCï¼‰</td>\n<td>æ›´çµæ´»ï¼Œæ”¯æŒå¹¶å‘å¹¶è¡Œï¼Œå‡å°‘ STW åœé¡¿ï¼Œé€‚ç”¨äºå¤§å †ã€ä½å»¶è¿Ÿåœºæ™¯</td>\n</tr>\n<tr>\n<td><strong>å¢é‡å›æ”¶ï¼ˆIncrementalï¼‰</strong></td>\n<td>åˆ†é˜¶æ®µå°æ­¥æ‰§è¡Œ GC ä»¥å‡å°‘å•æ¬¡åœé¡¿</td>\n<td>æŸäº›å¹¶å‘/ä½å»¶è¿Ÿ GC</td>\n<td>å‡å°‘æš‚åœæ—¶é—´ï¼Œä½†æ•´ä½“æ•ˆç‡å¯èƒ½é™ä½</td>\n</tr>\n<tr>\n<td><strong>å¹¶å‘å›æ”¶ï¼ˆConcurrentï¼‰</strong></td>\n<td>æ ‡è®°ã€æ¸…ç†ç­‰æ­¥éª¤ä¸åº”ç”¨çº¿ç¨‹å¹¶å‘æ‰§è¡Œ</td>\n<td>CMSã€G1ã€ZGC ç­‰</td>\n<td>åœé¡¿æ—¶é—´çŸ­ï¼Œå¯¹å“åº”æ—¶é—´è¦æ±‚é«˜çš„ç³»ç»Ÿå‹å¥½</td>\n</tr>\n<tr>\n<td><strong>ä¸‰è‰²æ ‡è®°ï¼ˆTri-color Markingï¼‰</strong></td>\n<td>å¹¶å‘æ ‡è®°ç®—æ³•çš„ä¸€ç§å®ç°æ€æƒ³</td>\n<td>CMSã€G1ã€ZGC ç­‰</td>\n<td>ç™½ï¼ˆå¾…å›æ”¶ï¼‰ã€ç°ï¼ˆå·²æ ‡è®°æœªæ‰«æï¼‰ã€é»‘ï¼ˆå·²æ ‡è®°å·²æ‰«æï¼‰ï¼Œé¿å…â€œæ¼æ ‡â€é—®é¢˜</td>\n</tr>\n<tr>\n<td><strong>SATBï¼ˆSnapshot-At-The-Beginningï¼‰</strong></td>\n<td>å¹¶å‘æ ‡è®°çš„å¿«ç…§ç­–ç•¥</td>\n<td>G1ã€ZGC</td>\n<td>ä¿è¯åœ¨å¹¶å‘æ ‡è®°è¿‡ç¨‹ä¸­ä¸é—æ¼æ–°å¼•ç”¨ï¼Œé€‚åˆé«˜å¹¶å‘åœºæ™¯</td>\n</tr>\n<tr>\n<td><strong>Lazy Compactionï¼ˆå»¶è¿Ÿå‹ç¼©ï¼‰</strong></td>\n<td>ä¸æ¯æ¬¡ GC éƒ½å‹ç¼©ï¼Œè§†æƒ…å†µè€Œå®š</td>\n<td>G1 ç­‰</td>\n<td>é™ä½ä¸å¿…è¦çš„ç§»åŠ¨æˆæœ¬</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å¯¹åº”å…³ç³»ï¼šGC å›æ”¶å™¨å’Œåº•å±‚ç®—æ³•</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>å›æ”¶å™¨</th>\n<th>ä½¿ç”¨çš„ç®—æ³•ç»„åˆ</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>Serial</strong></td>\n<td>æ–°ç”Ÿä»£ï¼šå¤åˆ¶ç®—æ³•<br>è€å¹´ä»£ï¼šæ ‡è®°-æ•´ç†</td>\n</tr>\n<tr>\n<td><strong>ParNew</strong></td>\n<td>æ–°ç”Ÿä»£ï¼šå¤åˆ¶ç®—æ³•ï¼ˆå¤šçº¿ç¨‹ï¼‰</td>\n</tr>\n<tr>\n<td><strong>Parallel</strong></td>\n<td>æ–°ç”Ÿä»£ï¼šå¤åˆ¶ç®—æ³•<br>è€å¹´ä»£ï¼šæ ‡è®°-æ•´ç†</td>\n</tr>\n<tr>\n<td><strong>CMS</strong></td>\n<td>æ–°ç”Ÿä»£ï¼šParNewï¼ˆå¤åˆ¶ï¼‰<br>è€å¹´ä»£ï¼šæ ‡è®°-æ¸…é™¤ + ä¸‰è‰²æ ‡è®° + å¹¶å‘</td>\n</tr>\n<tr>\n<td><strong>G1</strong></td>\n<td>åˆ†åŒºå›æ”¶ + ä¸‰è‰²æ ‡è®° + SATB + Lazy Compaction</td>\n</tr>\n<tr>\n<td><strong>ZGC</strong></td>\n<td>åˆ†åŒºå›æ”¶ + å¹¶å‘æ ‡è®° + SATB + Region Remapping</td>\n</tr>\n<tr>\n<td><strong>Shenandoah</strong></td>\n<td>åˆ†åŒºå›æ”¶ + å¹¶å‘æ ‡è®° + å¹¶å‘å‹ç¼© + ä¸‰è‰²æ ‡è®°</td>\n</tr>\n</tbody>\n</table>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class=\"line\">       â”‚   å¸¸è§ GC ç®—æ³•åˆ†ç±»       â”‚</span><br><span class=\"line\">       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class=\"line\">                 â”‚</span><br><span class=\"line\">   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class=\"line\">   â”‚                            â”‚</span><br><span class=\"line\">åˆ†ä»£æ¨¡å‹                      åˆ†åŒºæ¨¡å‹</span><br><span class=\"line\">   â”‚                            â”‚</span><br><span class=\"line\"> â”Œâ”€â”´â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”€â”</span><br><span class=\"line\">å¤åˆ¶   æ ‡è®°-æ¸…é™¤         Region-based å¹¶å‘</span><br><span class=\"line\">      æ ‡è®°-æ•´ç†             SATB / ä¸‰è‰²æ ‡è®°</span><br></pre></td></tr></table></figure>\n<h4 id=\"ä»€ä¹ˆæ˜¯-STWï¼ˆStop-The-Worldï¼‰\">ä»€ä¹ˆæ˜¯ STWï¼ˆStop-The-Worldï¼‰</h4>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>STWï¼ˆStop-The-Worldï¼‰ æŒ‡çš„æ˜¯ï¼šåœ¨æŸäº›åƒåœ¾å›æ”¶é˜¶æ®µï¼ŒJVM ä¼šæš‚åœæ‰€æœ‰åº”ç”¨çº¿ç¨‹ï¼ˆä¹Ÿå«ç”¨æˆ·çº¿ç¨‹ï¼‰ï¼Œè®©åƒåœ¾å›æ”¶çº¿ç¨‹ç‹¬å  CPU æ‰§è¡Œ GC é€»è¾‘ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>ä½ å¯ä»¥è¿™æ ·ç†è§£ STW</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">JVM ä¼šâ€œæŒ‰ä¸‹æš‚åœé”®â€æš‚åœæ‰€æœ‰æ­£åœ¨è¿è¡Œçš„ Java ç¨‹åºä»£ç ï¼›</li>\n<li class=\"lvl-6\">ç„¶å ä¸“å¿ƒè¿›è¡Œ GC çš„æŸäº›é˜¶æ®µï¼ˆå¦‚æ ‡è®°ã€æ•´ç†ã€å¤åˆ¶ç­‰ï¼‰ï¼›</li>\n<li class=\"lvl-6\">GC å®Œæˆåï¼Œæ‰ä¼šâ€œæ¢å¤è¿è¡Œâ€åº”ç”¨çº¿ç¨‹ã€‚</li>\n</ul>\n</li>\n<li class=\"lvl-2\">\n<p>å„ GC ä¸­ STW çš„å­˜åœ¨æƒ…å†µ</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>å›æ”¶å™¨</th>\n<th>æ˜¯å¦å­˜åœ¨ STWï¼Ÿ</th>\n<th>è¯´æ˜</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Serial</td>\n<td>âœ… æ˜¯ï¼Œå…¨åœé¡¿ï¼Œå…¨é˜¶æ®µå•çº¿ç¨‹</td>\n<td>å †è¶Šå¤§ STW è¶Šé•¿</td>\n</tr>\n<tr>\n<td>Parallel</td>\n<td>âœ… æ˜¯ï¼Œå…¨åœé¡¿ï¼Œå¤šçº¿ç¨‹æ‰§è¡Œ GC</td>\n<td>æé«˜æ•ˆç‡ä½†ä»ä¼šæš‚åœ</td>\n</tr>\n<tr>\n<td>CMS</td>\n<td>âœ… æœ‰ï¼Œåˆå§‹æ ‡è®°å’Œæœ€ç»ˆé‡æ–°æ ‡è®°æ˜¯ STW</td>\n<td>å¤§éƒ¨åˆ†é˜¶æ®µå¹¶å‘æ‰§è¡Œ</td>\n</tr>\n<tr>\n<td>G1</td>\n<td>âœ… æœ‰ï¼Œä½†è®¾è®¡ä¸ºå°½å¯èƒ½ç¼©çŸ­ STW</td>\n<td>åˆ†é˜¶æ®µå¹¶å‘ + å¹¶è¡Œå¤„ç†</td>\n</tr>\n<tr>\n<td>ZGC</td>\n<td>âœ… æçŸ­ï¼ˆ&lt;10msï¼‰</td>\n<td>ä»…ä¸ªåˆ«é˜¶æ®µæ˜¯ STWï¼Œå‡ ä¹æ„ŸçŸ¥ä¸åˆ°</td>\n</tr>\n<tr>\n<td>Shenandoah</td>\n<td>âœ… æçŸ­</td>\n<td>é«˜åº¦å¹¶å‘ï¼ŒSTW æ—¶é—´ä¹ŸæçŸ­</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ä¸ºä»€ä¹ˆè¦å…³æ³¨ STWï¼Ÿ</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">åœ¨å“åº”æ—¶é—´æ•æ„Ÿå‹ç³»ç»Ÿï¼ˆå¦‚åœ¨çº¿äº¤æ˜“ç³»ç»Ÿã€æ¸¸æˆæœåŠ¡å™¨ã€API ç½‘å…³ï¼‰ä¸­ï¼Œé•¿æ—¶é—´çš„ STW ä¼šé€ æˆç”¨æˆ·è¯·æ±‚å¡é¡¿ã€è¶…æ—¶ã€‚</li>\n<li class=\"lvl-6\">å› æ­¤ï¼Œé€‰æ‹© ä½ STW çš„ GCï¼ˆå¦‚ G1ã€ZGCã€Shenandoahï¼‰ å¯¹è¿™ç±»ç³»ç»Ÿè‡³å…³é‡è¦ã€‚</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"å †å†…å­˜ç»“æ„\">å †å†…å­˜ç»“æ„</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ä¸åŒçš„åƒåœ¾å›æ”¶å™¨å†³å®šäº†å †å†…å­˜çš„ç»“æ„ä¸åŒï¼Œä½†æ€»ä½“ä¸Šåˆ†ä¸ºä¸¤ç§ç±»å‹ï¼šåˆ†ä»£æ¨¡å‹å’Œåˆ†åŒºæ¨¡å‹ã€‚</p>\n</li>\n</ul>\n<h3 id=\"åˆ†ä»£æ¨¡å‹\">åˆ†ä»£æ¨¡å‹</h3>\n<h4 id=\"Parallel-åƒåœ¾å›æ”¶å™¨\">Parallel åƒåœ¾å›æ”¶å™¨</h4>\n<p><img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/Apr5aY.png\" alt=\"\"></p>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å †ç»“æ„è¢«åˆ’åˆ†ä¸º <code>Old Generationï¼ˆè€å¹´ä»£ï¼‰</code> å’Œ <code>Young Generationï¼ˆæ–°ç”Ÿä»£ï¼‰</code> ä¸¤éƒ¨åˆ†ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p><code>Young Generation</code> ç”± <code>Eden</code> å’Œ ä¸¤ä¸ª <code>Survivor</code> ç»„æˆï¼Œå…¶ä¸­ <code>Eden</code> æ˜¯ä¸€ä¸ªè¿ç»­çš„å†…å­˜åŒºåŸŸï¼Œ<code>Survivor</code> æ˜¯ä¸€ä¸ªéè¿ç»­çš„å†…å­˜åŒºåŸŸã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œ<code>Young Generation</code>å å †å†…å­˜çš„ <code>1/3</code>,  <code>Old Generation</code> å å †å†…å­˜çš„ <code>2/3</code>ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œ<code>Eden:S0:S1 = 8:1:1</code> ,å¦‚æœå¸Œæœ›ä¸º 4:1:1ï¼Œä½¿ç”¨ <code>-XX:SurvivorRatio=4</code>ï¼Œä½†å®é™…ä¸Šè¿™ä¸ªæ¯”ä¾‹å¹¶ä¸æ˜¯å›ºå®šçš„ï¼Œè€Œæ˜¯ç”±jvmåŸºäºæƒ…å†µè‡ªåŠ¨å˜åŒ–çš„ï¼Œå› ä¸ºJVMé»˜è®¤å¼€å¯äº†è¿™ä¸ªå‚æ•°<code>-XX:+UseAdaptiveSizePolicy</code>ï¼Œå¦‚æœå¸Œæœ›å›ºå®šè¿™ä¸ªæ¯”ä¾‹ï¼Œå¯ä»¥è®¾ç½®ä¸º <code>-XX:-UseAdaptiveSizePolicy</code>æ¥å…³é—­è¿™ä¸ªé…ç½®ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œå¯¹è±¡æœ€å¤šç»å†<code>15æ¬¡</code>Minor GCåè¿›å…¥è€å¹´ä»£ï¼Œå¯ä»¥é€šè¿‡ <code>-XX:MaxTenuringThreshold=n</code> è®¾ç½®ã€‚</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>åŒºåŸŸ</th>\n<th>è¯´æ˜</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>Eden</strong></td>\n<td>å¯¹è±¡é¦–æ¬¡åˆ›å»ºçš„åŒºåŸŸï¼Œå¤§éƒ¨åˆ†å¯¹è±¡åœ¨è¿™é‡Œåˆ›å»ºå¹¶å¾ˆå¿«è¢«å›æ”¶</td>\n</tr>\n<tr>\n<td><strong>S0/S1</strong></td>\n<td>Survivor åŒºåŸŸï¼šä¸¤ä¸ªäº¤æ›¿ä½¿ç”¨çš„ç¼“å†²åŒºï¼ˆFrom å’Œ Toï¼‰ï¼Œç”¨äºæ‹·è´å­˜æ´»å¯¹è±¡</td>\n</tr>\n<tr>\n<td><strong>Old</strong></td>\n<td>è€å¹´ä»£ï¼šå­˜æ´»æ¬¡æ•°å¤šã€ç”Ÿå‘½å‘¨æœŸé•¿çš„å¯¹è±¡ä¼šä»æ–°ç”Ÿä»£æ™‹å‡åˆ°è€å¹´ä»£ï¼Œå›æ”¶é¢‘ç‡ä½</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å¯¹è±¡å†…å­˜åˆ†é…å›¾è§£(ç®€åŒ–)</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">åˆ›å»ºå¯¹è±¡</span><br><span class=\"line\">   â†“</span><br><span class=\"line\">è¿›å…¥ Eden åŒºï¼ˆæ–°ç”Ÿä»£ï¼‰</span><br><span class=\"line\">   â†“ Eden åŒºæ»¡</span><br><span class=\"line\">ç¬¬ä¸€æ¬¡ Minor GCï¼ˆå­˜æ´»å¯¹è±¡[Eden]å¤åˆ¶åˆ° S0ï¼‰</span><br><span class=\"line\">   â†“ Eden åŒºæ»¡ æˆ– S0 åŒºæ»¡</span><br><span class=\"line\">ç¬¬äºŒæ¬¡ Minor GCï¼ˆå­˜æ´»å¯¹è±¡[Edenå’ŒS0]å¤åˆ¶åˆ° S1ï¼Œå¹´é¾„ +1ï¼‰</span><br><span class=\"line\">   â†“ Eden åŒºæ»¡ æˆ– S1 åŒºæ»¡</span><br><span class=\"line\">ç¬¬ä¸‰æ¬¡ Minor GCï¼ˆå­˜æ´»å¯¹è±¡[Edenå’ŒS1]å¤åˆ¶åˆ° S0ï¼Œå¹´é¾„ +1ï¼‰</span><br><span class=\"line\">   â†“</span><br><span class=\"line\">â€¦â€¦  S0/S1 äº¤æ›¿ï¼Œå¹´é¾„è¾¾åˆ°é˜ˆå€¼ï¼ˆå¦‚ 15ï¼‰</span><br><span class=\"line\">   â†“ è¿˜æ²¡æœ‰è¢«å›æ”¶</span><br><span class=\"line\">æ™‹å‡åˆ° Old åŒºï¼ˆè€å¹´ä»£ï¼‰ï¼Œç­‰å¾…OldåŒºæ»¡ è§¦å‘ Full GC</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å¤§å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">å¤§å¯¹è±¡å°±æ˜¯éœ€è¦å¤§é‡è¿ç»­å†…å­˜ç©ºé—´çš„å¯¹è±¡ï¼ˆæ¯”å¦‚ï¼šå­—ç¬¦ä¸²ã€æ•°ç»„ï¼‰ï¼Œå¦‚æœå¯¹è±¡å¾ˆå¤§ï¼ˆå¦‚è¶…è¿‡ Eden åŒºå¤§å°ï¼Œæˆ–æ˜¯è¶…è¿‡ Survivor åŒºå¤§å°ï¼‰ï¼Œå¯èƒ½ç›´æ¥åˆ†é…åˆ°è€å¹´ä»£</li>\n<li class=\"lvl-6\">ä¹Ÿå¯ä»¥é€šè¿‡ <code>-XX:PretenureSizeThreshold=&lt;å¤§å°ï¼Œå•ä½å­—èŠ‚&gt;</code> æ§åˆ¶è¶…è¿‡ä¸€å®šå¤§å°çš„å¯¹è±¡æ˜¯å¦ç›´æ¥åˆ†é…åˆ°è€å¹´ä»£ï¼ˆOld Generationï¼‰ï¼Œè·³è¿‡æ–°ç”Ÿä»£ï¼ˆEdenï¼‰ï¼Œä»¥é¿å…å¤§å¯¹è±¡é¢‘ç¹åœ¨å¹´è½»ä»£é€ æˆ GC å‹åŠ›ã€‚è¿™ä¸ªå‚æ•°åªåœ¨ Serial å’ŒParNewä¸¤ä¸ªæ”¶é›†å™¨ä¸‹æœ‰æ•ˆã€‚</li>\n</ul>\n</li>\n<li class=\"lvl-2\">\n<p>å¯¹è±¡åŠ¨æ€å¹´é¾„åˆ¤æ–­</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">å¯¹è±¡åœ¨SurvivoråŒºæ¥å›ç§»åŠ¨æ—¶ï¼Œå¦‚æœè¿™æ‰¹å¯¹è±¡çš„æ€»å¤§å°å¤§äºè¿™å—SurvivoråŒºåŸŸå†…å­˜å¤§å°çš„50%(-XX:TargetSurvivorRatioå¯ä»¥æŒ‡å®š)ï¼Œé‚£ä¹ˆæ­¤æ—¶å¤§äºç­‰äºè¿™æ‰¹å¯¹è±¡å¹´é¾„æœ€å¤§å€¼çš„å¯¹è±¡ï¼Œå°±å¯ä»¥ç›´æ¥è¿›å…¥è€å¹´ä»£äº†ï¼Œ</li>\n<li class=\"lvl-6\">ä¾‹å¦‚SurvivoråŒºåŸŸé‡Œç°åœ¨æœ‰ä¸€æ‰¹å¯¹è±¡ï¼Œå¹´é¾„1+å¹´é¾„2+å¹´é¾„nçš„å¤šä¸ªå¹´é¾„å¯¹è±¡æ€»å’Œè¶…è¿‡äº†SurvivoråŒºåŸŸçš„50%ï¼Œæ­¤æ—¶å°±ä¼šæŠŠå¹´é¾„n(å«)ä»¥ä¸Šçš„å¯¹è±¡éƒ½æ”¾å…¥è€å¹´ä»£ã€‚è¿™ä¸ªè§„åˆ™å…¶å®æ˜¯å¸Œæœ›é‚£äº›å¯èƒ½æ˜¯é•¿æœŸå­˜æ´»çš„å¯¹è±¡ï¼Œå°½æ—©è¿›å…¥è€å¹´ä»£ã€‚</li>\n<li class=\"lvl-6\">å¯¹è±¡åŠ¨æ€å¹´é¾„åˆ¤æ–­æœºåˆ¶ä¸€èˆ¬æ˜¯åœ¨minor gcä¹‹åè§¦å‘çš„ã€‚</li>\n</ul>\n</li>\n</ul>\n<div class=\"tips\">\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">\n<p>å¯¹è±¡é€ƒé€¸åˆ†æ</p>\n<ul class=\"lvl-3\">\n<li class=\"lvl-6\">å¦‚æœå¯¹è±¡å¾ˆå°ï¼Œä¸”åªåœ¨æ–¹æ³•å†…éƒ¨ä½¿ç”¨ï¼Œå¹¶æ²¡æœ‰è¢«å¤–éƒ¨å¼•ç”¨ï¼Œåˆ™å…¶æœ‰å¯èƒ½ç›´æ¥åˆ†é…åˆ°æ ˆå†…å­˜ï¼Œè€Œä¸è¿›å…¥å †å†…å­˜</li>\n<li class=\"lvl-6\">JVMå¯¹äºè¿™ç§æƒ…å†µå¯ä»¥é€šè¿‡å¼€å¯é€ƒé€¸åˆ†æå‚æ•°(-XX:+DoEscapeAnalysis)æ¥ä¼˜åŒ–å¯¹è±¡å†…å­˜åˆ†é…ä½ç½®ï¼Œä½¿å…¶é€šè¿‡<code>æ ‡é‡æ›¿æ¢</code>ä¼˜å…ˆåˆ†é…åœ¨æ ˆä¸Š(æ ˆä¸Šåˆ†é…)ï¼ŒJDK7ä¹‹åé»˜è®¤å¼€å¯é€ƒé€¸åˆ†æï¼Œå¦‚æœè¦å…³é—­ä½¿ç”¨å‚æ•°(-XX:-DoEscapeAnalysis)</li>\n</ul>\n</li>\n<li class=\"lvl-2\">\n<p>æ ‡é‡æ›¿æ¢</p>\n<ul class=\"lvl-3\">\n<li class=\"lvl-6\">é€šè¿‡é€ƒé€¸åˆ†æç¡®å®šè¯¥å¯¹è±¡ä¸ä¼šè¢«å¤–éƒ¨è®¿é—®ï¼Œå¹¶ä¸”å¯¹è±¡å¯ä»¥è¢«è¿›ä¸€æ­¥åˆ†è§£æ—¶ï¼ŒJVMä¸ä¼šåˆ›å»ºè¯¥å¯¹è±¡ï¼Œè€Œæ˜¯å°†è¯¥å¯¹è±¡æˆå‘˜å˜é‡åˆ†è§£è‹¥å¹²ä¸ªè¢«è¿™ä¸ªæ–¹æ³•ä½¿ç”¨çš„æˆå‘˜å˜é‡æ‰€ä»£æ›¿ï¼Œè¿™äº›ä»£æ›¿çš„æˆå‘˜å˜é‡åœ¨æ ˆå¸§æˆ–å¯„å­˜å™¨ä¸Šåˆ†é…ç©ºé—´ï¼Œè¿™æ ·å°±ä¸ä¼šå› ä¸ºæ²¡æœ‰ä¸€å¤§å—è¿ç»­ç©ºé—´å¯¼è‡´å¯¹è±¡å†…å­˜ä¸å¤Ÿåˆ†é…ã€‚</li>\n<li class=\"lvl-6\">å¼€å¯æ ‡é‡æ›¿æ¢å‚æ•°(-XX:+EliminateAllocations)ï¼ŒJDK7ä¹‹åé»˜è®¤å¼€å¯ã€‚</li>\n</ul>\n</li>\n<li class=\"lvl-2\">\n<p>æ ‡é‡ä¸èšåˆé‡</p>\n<ul class=\"lvl-3\">\n<li class=\"lvl-6\">æ ‡é‡å³ä¸å¯è¢«è¿›ä¸€æ­¥åˆ†è§£çš„é‡ï¼Œè€ŒJAVAçš„åŸºæœ¬æ•°æ®ç±»å‹å°±æ˜¯æ ‡é‡ï¼ˆå¦‚ï¼šintï¼Œlongç­‰åŸºæœ¬æ•°æ®ç±»å‹ä»¥åŠreferenceç±»å‹ç­‰ï¼‰ï¼Œ</li>\n<li class=\"lvl-6\">æ ‡é‡çš„å¯¹ç«‹å°±æ˜¯å¯ä»¥è¢«è¿›ä¸€æ­¥åˆ†è§£çš„é‡ï¼Œè€Œè¿™ç§é‡ç§°ä¹‹ä¸ºèšåˆé‡ã€‚è€Œåœ¨JAVAä¸­å¯¹è±¡å°±æ˜¯å¯ä»¥è¢«è¿›ä¸€æ­¥åˆ†è§£çš„èšåˆé‡ã€‚</li>\n</ul>\n</li>\n</ul>\n</div>\n<h4 id=\"Parallel-åƒåœ¾å›æ”¶å™¨ï¼ˆParallel-GCï¼‰-çš„å·¥ä½œæ–¹å¼\">Parallel åƒåœ¾å›æ”¶å™¨ï¼ˆParallel GCï¼‰ çš„å·¥ä½œæ–¹å¼</h4>\n<p><img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/fo2Egs.png\" alt=\"\" width=\"1200\" height=\"600\"></p>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Parallel GC æ˜¯å¤šçº¿ç¨‹åƒåœ¾å›æ”¶å™¨ï¼Œå¯ä»¥é€šè¿‡ <code>-XX:ParallelGCThreads</code> æ¥è®¾ç½®GCçº¿ç¨‹æ•°é‡ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>å½“ Parallel GC è¢«è§¦å‘ï¼ˆä¾‹å¦‚ Minor GC æˆ– Full GCï¼‰æ—¶ï¼Œæ‰€æœ‰ç”¨æˆ·çº¿ç¨‹ è¢«å®Œå…¨æš‚åœï¼ˆStop-The-World, STWï¼‰</p>\n</li>\n</ul>\n<h4 id=\"Parallel-GC-å‚æ•°é…ç½®è¡¨ï¼ˆååé‡ä¼˜å…ˆ-GCï¼‰\">Parallel GC å‚æ•°é…ç½®è¡¨ï¼ˆååé‡ä¼˜å…ˆ GCï¼‰</h4>\n<table>\n<thead>\n<tr>\n<th>å‚æ•°å</th>\n<th>è¯´æ˜</th>\n<th>é»˜è®¤å€¼ï¼ˆå¦‚æœªç‰¹åˆ«è¯´æ˜ï¼‰</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>-XX:+UseParallelGC</code></td>\n<td>å¼€å¯ Parallel GCï¼Œç”¨äºæ–°ç”Ÿä»£æ”¶é›†</td>\n<td>-</td>\n</tr>\n<tr>\n<td><code>-XX:+UseParallelOldGC</code></td>\n<td>å¼€å¯è€å¹´ä»£å¹¶è¡Œæ”¶é›†ï¼ˆParallel Oldï¼‰</td>\n<td>-</td>\n</tr>\n<tr>\n<td><code>-XX:ParallelGCThreads</code></td>\n<td>åƒåœ¾å›æ”¶æ—¶çš„å¹¶è¡Œçº¿ç¨‹æ•°ï¼ˆä¸ CPU æ•°é‡ç›¸å…³ï¼‰</td>\n<td>æ ¹æ®ç¡¬ä»¶è‡ªåŠ¨é…ç½®</td>\n</tr>\n<tr>\n<td><code>-XX:MaxGCPauseMillis</code></td>\n<td>è®¾ç½® GC æœ€å¤§æš‚åœæ—¶é—´ç›®æ ‡ï¼ˆå½±å“å†…å­˜åˆ†é…ç­–ç•¥ï¼‰</td>\n<td>ä¸€ä¸ªéå¸¸å¤§çš„å€¼ï¼Œå¯ä»¥è®¤ä¸ºæ— é™åˆ¶ï¼ˆå»ºè®®æŒ‰éœ€è®¾ç½®ï¼‰</td>\n</tr>\n<tr>\n<td><code>-XX:GCTimeRatio</code></td>\n<td>è®¾ç½® GC æ—¶é—´ä¸åº”ç”¨è¿è¡Œæ—¶é—´çš„æ¯”å€¼ï¼ˆ0~100ï¼‰<br>å€¼è¶Šå°ï¼ŒGC è¶Šé¢‘ç¹ï¼Œå€¼è¶Šå¤§ GC è¶Šå°‘</td>\n<td>99ï¼ˆè¡¨ç¤º 1% ç”¨äº GCï¼Œ99% ç”¨äºåº”ç”¨ï¼‰</td>\n</tr>\n<tr>\n<td><code>-XX:+UseAdaptiveSizePolicy</code></td>\n<td>å¯ç”¨è‡ªé€‚åº” GC ç­–ç•¥ï¼ˆæ ¹æ®è¿è¡ŒçŠ¶å†µè‡ªåŠ¨è°ƒæ•´å„åŒºåŸŸå¤§å°ï¼‰</td>\n<td>é»˜è®¤å¼€å¯</td>\n</tr>\n<tr>\n<td><code>-XX:SurvivorRatio</code></td>\n<td>Eden ä¸ Survivor çš„å†…å­˜æ¯”ä¾‹ï¼ˆå¦‚ 8 è¡¨ç¤º Eden:S0:S1 = 8:1:1ï¼‰</td>\n<td>8</td>\n</tr>\n<tr>\n<td><code>-XX:InitialTenuringThreshold</code></td>\n<td>å¯¹è±¡æ™‹å‡åˆ°è€å¹´ä»£çš„åˆå§‹å¹´é¾„ï¼ˆä¼šéšè¿è¡ŒåŠ¨æ€è°ƒæ•´ï¼‰</td>\n<td>7</td>\n</tr>\n<tr>\n<td><code>-XX:MaxTenuringThreshold</code></td>\n<td>æ™‹å‡åˆ°è€å¹´ä»£çš„æœ€å¤§å¹´é¾„ï¼ˆå¯¹è±¡åœ¨ Survivor åŒºç»å†å‡ æ¬¡ GCï¼‰</td>\n<td>15</td>\n</tr>\n<tr>\n<td><code>-XX:PretenureSizeThreshold</code></td>\n<td>è®¾ç½®å¤§å¯¹è±¡é˜ˆå€¼ï¼Œè¶…è¿‡è¯¥å¤§å°çš„å¯¹è±¡ç›´æ¥åˆ†é…åˆ°è€å¹´ä»£</td>\n<td>0ï¼ˆå³ç¦ç”¨ï¼‰</td>\n</tr>\n<tr>\n<td><code>-XX:+ScavengeBeforeFullGC</code></td>\n<td>åœ¨ Full GC ä¹‹å‰æ˜¯å¦å…ˆæ‰§è¡Œä¸€æ¬¡ Minor GC</td>\n<td>trueå¯</td>\n</tr>\n<tr>\n<td><code>-XX:+UseFastAccessorMethods</code></td>\n<td>ä¼˜åŒ–åŸå§‹ç±»å‹çš„ get/set æ–¹æ³•æ€§èƒ½</td>\n<td>falseå¯</td>\n</tr>\n<tr>\n<td><code>-XX:+AlwaysPreTouch</code></td>\n<td>JVM å¯åŠ¨æ—¶ç«‹å³åˆ†é…å¹¶åˆå§‹åŒ–æ‰€æœ‰å†…å­˜é¡µï¼Œé¿å…è¿è¡Œæ—¶é¦–æ¬¡åˆ†é…å¸¦æ¥çš„åœé¡¿</td>\n<td>false</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"åˆ†åŒºæ¨¡å‹\">åˆ†åŒºæ¨¡å‹</h3>\n<h4 id=\"G1-åƒåœ¾å›æ”¶å™¨\">G1 åƒåœ¾å›æ”¶å™¨</h4>\n<p><img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/AaqBxm.png\" alt=\"\" width=\"900\" height=\"300\"></p>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>G1(Garbage-First) å±äº ç‰©ç†ä¸Šåˆ†åŒºï¼Œé€»è¾‘ä¸Šåˆ†ä»£ï¼ŒçœŸæ­£çš„åˆ†åŒºæ¨¡å‹æ˜¯ <code>ZGC</code>ï¼ˆjdk21åä¹Ÿæ”¯æŒåˆ†ä»£ï¼‰</p>\n</li>\n<li class=\"lvl-2\">\n<p>G1å°†Javaå †åˆ’åˆ†ä¸ºå¤šä¸ªå¤§å°ç›¸ç­‰çš„Regionï¼ŒRegionå¤§å°æ˜¯2çš„å¹‚ï¼ŒèŒƒå›´åœ¨1MBåˆ°32MBä¹‹é—´ã€‚JDK9ä¹‹å‰é»˜è®¤æœ€å¤šæ”¯æŒ2048ä¸ªRegionï¼Œè¿™å°±å¯¼è‡´G1æœ€å¤§æ”¯æŒ64G çš„å † (<code>2048 Regions Ã— 32MB = 64GB</code>)ï¼ŒJDK10ä¹‹åçš„ç‰ˆæœ¬å¯æ”¯æŒæ›´å¤šRegionæ•°é‡ï¼ŒJDK17è¿›ä¸€æ­¥ä¼˜åŒ–äº†Regionæ˜ å°„æœºåˆ¶ï¼Œæå‡äº†å¤§å †åœºæ™¯ä¸‹çš„æ€§èƒ½ï¼Œä½¿å…¶å¯ä»¥æ”¯æŒæ›´å¤§çš„å†…å­˜ï¼Œä½†å¯¹äºè¶…å¤§å †ï¼ˆ&gt;1Tï¼‰ï¼Œè€ƒè™‘åˆ°GCæš‚åœæ—¶é—´ï¼Œå»ºè®®ä½¿ç”¨ZGCæˆ–Shenandoah GCã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>Regionä¸€æ—¦è¢«å›æ”¶ï¼Œé‡æ–°åˆ†é…æ—¶å¯ä»¥æ˜¯ä»»æ„ç±»å‹ï¼Œæ¯”å¦‚åŸå…ˆæ˜¯<code>Eden</code>ï¼Œé‚£ä¹ˆé‡æ–°åˆ†é…æ—¶å¯ä»¥æ˜¯<code>Old</code>ï¼Œåä¹‹äº¦ç„¶ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>ä¸€èˆ¬Regionå¤§å°ç”±JVMè‡ªåŠ¨è®¡ç®—ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ç”¨å‚æ•°<code>-XX:G1HeapRegionSize</code>æ‰‹åŠ¨æŒ‡å®šRegionå¤§å°ï¼Œä½†æ˜¯æ¨èé»˜è®¤çš„è®¡ç®—æ–¹å¼ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>G1ä¿ç•™äº†å¹´è½»ä»£å’Œè€å¹´ä»£çš„æ¦‚å¿µï¼Œä½†ä¸å†æ˜¯ç‰©ç†éš”é˜‚äº†ï¼Œå®ƒä»¬éƒ½æ˜¯ï¼ˆå¯ä»¥ä¸è¿ç»­ï¼‰Regionçš„é›†åˆã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>åœ¨ G1 GC ä¸­ï¼Œä¸è¦ä½¿ç”¨ <code>-Xmn</code>ï¼ŒG1 ä¸­æ¨èä½¿ç”¨ä»¥ä¸‹æ›´ç»†ç²’åº¦çš„æ§åˆ¶æ–¹å¼ï¼š</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># è¿™æ˜¯å®éªŒæ€§å‚æ•°ï¼Œéœ€è¦å¼€å¯ `-XX:+UnlockExperimentalVMOptions`ï¼Œä½†ä¾æ—§æ¨èåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨</span></span><br><span class=\"line\">-XX:G1NewSizePercent=5</span><br><span class=\"line\">-XX:G1MaxNewSizePercent=60</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>é»˜è®¤å¹´è½»ä»£å¯¹å †å†…å­˜çš„å æ¯”æ˜¯<code>5%</code>ï¼Œå¦‚æœå †å¤§å°ä¸º4096Mï¼Œé‚£ä¹ˆå¹´è½»ä»£å æ®200MBå·¦å³çš„å†…å­˜ï¼Œå¯¹åº”å¤§æ¦‚æ˜¯100ä¸ªRegionï¼Œå¯ä»¥é€šè¿‡   <code>-XX:G1NewSizePercent</code>è®¾ç½®æ–°ç”Ÿä»£åˆå§‹å æ¯”ï¼Œè¿™æ˜¯å®éªŒæ€§å‚æ•°ï¼Œéœ€è¦å¼€å¯ <code>-XX:+UnlockExperimentalVMOptions</code>ï¼Œä½†ä¾æ—§æ¨èåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>åœ¨ç³»ç»Ÿè¿è¡Œä¸­ï¼ŒJVMä¼šä¸åœçš„ç»™å¹´è½»ä»£å¢åŠ æ›´å¤šçš„Regionï¼Œä½†æ˜¯æœ€å¤šæ–°ç”Ÿä»£çš„å æ¯”ä¸ä¼šè¶…è¿‡<code>60%</code>ï¼Œå¯ä»¥é€šè¿‡<code>-XX:G1MaxNewSizePercent</code>è°ƒæ•´ï¼Œè¿™æ˜¯å®éªŒæ€§å‚æ•°ï¼Œéœ€è¦å¼€å¯ <code>-XX:+UnlockExperimentalVMOptions</code>ï¼Œä½†ä¾æ—§æ¨èåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>å¹´è½»ä»£ä¸­çš„Edenå’ŒSurvivorå¯¹åº”çš„regionä¹Ÿè·Ÿä¹‹å‰ä¸€æ ·ï¼Œé»˜è®¤<code>8:1:1</code>ï¼Œå‡è®¾å¹´è½»ä»£ç°åœ¨æœ‰1000ä¸ªregionï¼ŒedenåŒºå¯¹åº”800ä¸ªï¼Œs0å¯¹åº”100ä¸ªï¼Œs1å¯¹åº”100ä¸ªã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>ä¸€ä¸ªRegionå¯èƒ½ä¹‹å‰æ˜¯å¹´è½»ä»£ï¼Œå¦‚æœRegionè¿›è¡Œäº†åƒåœ¾å›æ”¶ï¼Œä¹‹åå¯èƒ½åˆä¼šå˜æˆè€å¹´ä»£ï¼Œä¹Ÿå°±æ˜¯è¯´Regionçš„åŒºåŸŸåŠŸèƒ½å¯èƒ½ä¼šåŠ¨æ€å˜åŒ–ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>G1åƒåœ¾æ”¶é›†å™¨å¯¹äºå¯¹è±¡ä»€ä¹ˆæ—¶å€™ä¼šè½¬ç§»åˆ°è€å¹´ä»£è·Ÿä¹‹å‰è®²è¿‡çš„åŸåˆ™ä¸€æ ·ï¼Œå”¯ä¸€ä¸åŒçš„æ˜¯å¯¹å¤§å¯¹è±¡çš„å¤„ç†ï¼ŒG1æœ‰ä¸“é—¨åˆ†é…å¤§å¯¹è±¡çš„Regionå«<code>Humongous</code>åŒºï¼Œè€Œä¸æ˜¯è®©å¤§å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£çš„Regionä¸­ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>åœ¨G1ä¸­ï¼Œå¤§å¯¹è±¡çš„åˆ¤å®šè§„åˆ™å°±æ˜¯ä¸€ä¸ªå¤§å¯¹è±¡è¶…è¿‡äº†ä¸€ä¸ªRegionå¤§å°çš„<code>50%</code>ï¼Œæ¯”å¦‚æŒ‰ç…§ä¸Šé¢ç®—çš„ï¼Œæ¯ä¸ªRegionæ˜¯2Mï¼Œåªè¦ä¸€ä¸ªå¤§å¯¹è±¡è¶…è¿‡äº†1Mï¼Œå°±ä¼šè¢«æ”¾å…¥Humongousä¸­ï¼Œè€Œä¸”ä¸€ä¸ªå¤§å¯¹è±¡å¦‚æœå¤ªå¤§ï¼Œå¯èƒ½ä¼šæ¨ªè·¨å¤šä¸ªRegionæ¥å­˜æ”¾ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>HumongousåŒºä¸“é—¨å­˜æ”¾çŸ­æœŸå·¨å‹å¯¹è±¡ï¼Œä¸ç”¨ç›´æ¥è¿›è€å¹´ä»£ï¼Œå¯ä»¥èŠ‚çº¦è€å¹´ä»£çš„ç©ºé—´ï¼Œé¿å…å› ä¸ºè€å¹´ä»£ç©ºé—´ä¸å¤Ÿçš„GCå¼€é”€ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>Full GCçš„æ—¶å€™é™¤äº†æ”¶é›†å¹´è½»ä»£å’Œè€å¹´ä»£ä¹‹å¤–ï¼Œä¹Ÿä¼šå°†HumongousåŒºä¸€å¹¶å›æ”¶ã€‚</p>\n</li>\n</ul>\n<h5 id=\"G1åƒåœ¾æ”¶é›†åˆ†ç±»\">G1åƒåœ¾æ”¶é›†åˆ†ç±»</h5>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>YoungGC<br>\nYoungGCå¹¶ä¸æ˜¯è¯´ç°æœ‰çš„EdenåŒºæ”¾æ»¡äº†å°±ä¼šé©¬ä¸Šè§¦å‘ï¼ŒG1ä¼šè®¡ç®—ä¸‹ç°åœ¨EdenåŒºå›æ”¶å¤§æ¦‚è¦å¤šä¹…æ—¶é—´ï¼Œå¦‚æœå›æ”¶æ—¶é—´è¿œè¿œå°äºå‚æ•° <code>-XX:MaxGCPauseMills</code> è®¾å®šçš„å€¼ï¼Œé‚£ä¹ˆå¢åŠ å¹´è½»ä»£çš„regionï¼Œç»§ç»­ç»™æ–°å¯¹è±¡å­˜æ”¾ï¼Œä¸ä¼šé©¬ä¸ŠåšYoungGCï¼Œç›´åˆ°ä¸‹ä¸€æ¬¡EdenåŒºæ”¾æ»¡ï¼ŒG1è®¡ç®—å›æ”¶æ—¶é—´æ¥è¿‘å‚æ•° <code>-XX:MaxGCPauseMills</code> è®¾å®šçš„å€¼ï¼Œé‚£ä¹ˆå°±ä¼šè§¦å‘Young GC</p>\n</li>\n<li class=\"lvl-2\">\n<p>MixedGC<br>\nä¸æ˜¯FullGCï¼Œè€å¹´ä»£çš„å †å æœ‰ç‡è¾¾åˆ°å‚æ•° <code>-XX:InitiatingHeapOccupancyPercent</code> è®¾å®šçš„å€¼åˆ™è§¦å‘ï¼Œå›æ”¶æ‰€æœ‰çš„Youngå’Œéƒ¨åˆ†Old(æ ¹æ®æœŸæœ›çš„GCåœé¡¿æ—¶é—´ç¡®å®šoldåŒºåƒåœ¾æ”¶é›†çš„ä¼˜å…ˆé¡ºåº)ä»¥åŠå¤§å¯¹è±¡åŒºï¼Œæ­£å¸¸æƒ…å†µG1çš„åƒåœ¾æ”¶é›†æ˜¯å…ˆåšMixedGCï¼Œä¸»è¦ä½¿ç”¨å¤åˆ¶ç®—æ³•ï¼Œéœ€è¦æŠŠå„ä¸ªregionä¸­å­˜æ´»çš„å¯¹è±¡æ‹·è´åˆ°åˆ«çš„regioné‡Œå»ï¼Œæ‹·è´è¿‡ç¨‹ä¸­å¦‚æœå‘ç°æ²¡æœ‰è¶³å¤Ÿçš„ç©ºregionèƒ½å¤Ÿæ‰¿è½½æ‹·è´å¯¹è±¡å°±ä¼šè§¦å‘ä¸€æ¬¡Full GC</p>\n</li>\n<li class=\"lvl-2\">\n<p>Full GC<br>\nåœæ­¢ç³»ç»Ÿç¨‹åºï¼Œç„¶åé‡‡ç”¨å•çº¿ç¨‹è¿›è¡Œæ ‡è®°ã€æ¸…ç†å’Œå‹ç¼©æ•´ç†ï¼Œå¥½ç©ºé—²å‡ºæ¥ä¸€æ‰¹Regionæ¥ä¾›ä¸‹ä¸€æ¬¡MixedGCä½¿ç”¨ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯éå¸¸è€—æ—¶çš„ã€‚(Shenandoahä¼˜åŒ–æˆå¤šçº¿ç¨‹æ”¶é›†äº†)</p>\n</li>\n</ul>\n<h4 id=\"G1-æ”¶é›†å™¨çš„å·¥ä½œæ–¹å¼-MixedGC\">G1 æ”¶é›†å™¨çš„å·¥ä½œæ–¹å¼(MixedGC)</h4>\n<p><img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/XbkEoh.png\" alt=\"\" width=\"1200\" height=\"400\"></p>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å›¾ä¸­ä¸»è¦å±•ç¤ºäº†ä¸€ä¸ªå…¸å‹çš„ G1 GC çš„ å¹¶å‘æ ‡è®°å‘¨æœŸï¼ˆConcurrent Mark Cycleï¼‰ çš„è¿‡ç¨‹ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>å›¾ä¸­çš„æ°´å¹³ç®­å¤´è¡¨ç¤ºå„çº¿ç¨‹ï¼ˆç”¨æˆ·çº¿ç¨‹å’ŒGCçº¿ç¨‹ï¼‰çš„æ‰§è¡Œè·¯å¾„ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>ç«–ç›´çš„<code>Safepoint</code>çº¿è¡¨ç¤ºä¸€æ¬¡GCè¿‡ç¨‹ä¸­ä¼šæš‚åœæ‰€æœ‰ç”¨æˆ·çº¿ç¨‹çš„æ—¶åˆ»ï¼ˆStop-The-Worldï¼‰ã€‚</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1ï¸âƒ£ åˆå§‹æ ‡è®°ï¼ˆInitial Markï¼‰</span><br><span class=\"line\">    è¿›å…¥ Safepointï¼š æ‰€æœ‰ç”¨æˆ·çº¿ç¨‹åœ¨æ­¤åˆ»æš‚åœï¼ˆSTWï¼‰ã€‚</span><br><span class=\"line\">    æ ‡è®° GC Roots ç›´æ¥å¯è¾¾å¯¹è±¡ã€‚</span><br><span class=\"line\">    éå¸¸çŸ­æš‚ï¼Œä½†å±äº Stop-The-World é˜¶æ®µã€‚</span><br><span class=\"line\">    å›¾ä¸­æ˜¯â€œåˆå§‹æ ‡è®°â€ç®­å¤´åœ¨ Safepoint ä¹‹åç«‹åˆ»æ‰§è¡Œã€‚</span><br><span class=\"line\"></span><br><span class=\"line\">2ï¸âƒ£ å¹¶å‘æ ‡è®°ï¼ˆConcurrent Markï¼‰</span><br><span class=\"line\">    ç”¨æˆ·çº¿ç¨‹ æ¢å¤è¿è¡Œï¼ˆå›¾ä¸­ç”¨æˆ·çº¿ç¨‹ç»§ç»­å‘å³å»¶ä¼¸ï¼‰ã€‚</span><br><span class=\"line\">    GC çº¿ç¨‹ å¹¶å‘è¿›è¡Œæ ‡è®°å·¥ä½œï¼ˆå³åœ¨ç”¨æˆ·çº¿ç¨‹è¿è¡ŒæœŸé—´è¿›è¡Œæ ‡è®°ï¼‰ã€‚</span><br><span class=\"line\">    å›¾ä¸­è“è‰²çš„â€œå¹¶å‘æ ‡è®°â€ç®­å¤´ä¸ç”¨æˆ·çº¿ç¨‹ç®­å¤´å¹¶è¡Œæ˜¾ç¤ºï¼Œè¡¨ç¤ºå¹¶å‘æ‰§è¡Œã€‚</span><br><span class=\"line\"></span><br><span class=\"line\">3ï¸âƒ£ æœ€ç»ˆæ ‡è®°ï¼ˆRemark / Final Markï¼‰</span><br><span class=\"line\">    å†æ¬¡è¿›å…¥ Safepointã€‚</span><br><span class=\"line\">    é‡æ–°æš‚åœæ‰€æœ‰ç”¨æˆ·çº¿ç¨‹ã€‚</span><br><span class=\"line\">    å¤„ç†å¹¶å‘æ ‡è®°é˜¶æ®µä¸­é—æ¼çš„å¼•ç”¨æ›´æ–°ç­‰ä¿¡æ¯ï¼Œä¿è¯æ ‡è®°çš„å‡†ç¡®æ€§ã€‚</span><br><span class=\"line\"></span><br><span class=\"line\">4ï¸âƒ£ ç­›é€‰å›æ”¶ï¼ˆCleanup / Filtered Collectionï¼‰</span><br><span class=\"line\">    å¯¹å·²æ ‡è®°çš„å¯¹è±¡åšæ¸…ç†ï¼ˆå›æ”¶ä¸å¯è¾¾å¯¹è±¡ï¼‰ã€‚</span><br><span class=\"line\">    åˆ¤æ–­æ˜¯å¦éœ€è¦å›æ”¶æŸäº› Regionã€‚</span><br><span class=\"line\">    å›¾ä¸­è“è‰²ç®­å¤´æ ‡æ³¨ä¸ºâ€œç­›é€‰å›æ”¶â€ã€‚</span><br><span class=\"line\"></span><br><span class=\"line\">5ï¸âƒ£ æ¢å¤ç”¨æˆ·çº¿ç¨‹</span><br><span class=\"line\">    åœ¨æœ€åä¸€ä¸ª Safepoint ä¹‹åï¼Œæ‰€æœ‰ç”¨æˆ·çº¿ç¨‹é‡æ–°å¼€å§‹æ‰§è¡Œï¼ˆå›¾ä¸­é»„è‰²ç®­å¤´é‡æ–°å‘å³å»¶ä¼¸ï¼‰ã€‚</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>G1çš„GC è¿‡ç¨‹ä¼šç»å†å¤šæ¬¡<code>Safepoint</code>ï¼Œä½†åªæœ‰ <code>å¹¶å‘æ ‡è®°é˜¶æ®µ</code> æ˜¯æ•´ä¸ªå‘¨æœŸä¸­æœ€è€—æ—¶ä½†ä¸ä¼šæš‚åœç”¨æˆ·çº¿ç¨‹(STW)çš„éƒ¨åˆ†ã€‚</p>\n</li>\n</ul>\n<div class=\"tips\">\n<p><em><strong>Safepointï¼ˆå®‰å…¨ç‚¹ï¼‰</strong></em></p>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">åœ¨ JVMï¼ˆJava è™šæ‹Ÿæœºï¼‰ä¸­ï¼ŒSafepointï¼ˆå®‰å…¨ç‚¹ï¼‰ æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„æ¦‚å¿µï¼Œå®ƒä»£è¡¨ æ‰€æœ‰çº¿ç¨‹å¿…é¡»â€œå®‰å…¨åœ°â€æš‚åœçš„æŸä¸ªæ—¶é—´ç‚¹ï¼Œä»¥ä¾¿ JVM èƒ½å¤Ÿæ‰§è¡ŒæŸäº›å…¨å±€æ“ä½œï¼Œæ¯”å¦‚ï¼š<br>\nåƒåœ¾å›æ”¶ï¼ˆGCï¼‰<br>\næ ˆéå†ï¼ˆä¾‹å¦‚ç”Ÿæˆå †å¿«ç…§ã€åšé€ƒé€¸åˆ†æç­‰ï¼‰<br>\nç±»å¸è½½<br>\nJIT ç¼–è¯‘çš„ä¸€äº›é‡å†™æ“ä½œç­‰</li>\n<li class=\"lvl-2\">å¦‚æœçº¿ç¨‹æ­£åœ¨è¿è¡Œã€æ”¹å˜å †ä¸­å¯¹è±¡çš„æ•°æ®ï¼Œé‚£ä¹ˆ GC å°±æ— æ³•å‡†ç¡®æ ‡è®°å’Œå›æ”¶å¯¹è±¡ã€‚å› æ­¤ JVM éœ€è¦ è®©æ‰€æœ‰çº¿ç¨‹åœ¨ä¸€ä¸ªâ€œå¯æ§ã€å®‰å…¨çš„ä½ç½®â€ä¸Šæš‚åœï¼Œè¿™ä¸ªä½ç½®å°±å« Safepointã€‚</li>\n<li class=\"lvl-2\">Safepoint æ˜¯æ€ä¹ˆå·¥ä½œçš„ï¼Ÿ<br>\n1.JVM å‘å‡ºâ€œè¿›å…¥ Safepointâ€çš„ä¿¡å·ï¼ˆæ¯”å¦‚è¦å¼€å§‹ GCï¼‰<br>\n2.æ‰€æœ‰çº¿ç¨‹æ”¶åˆ°ä¿¡å·åï¼Œå¿…é¡»ç­‰åˆ°â€œæœ€è¿‘çš„ Safepointâ€å†åœä¸‹æ¥ï¼š<br>\nSafepoint ä¸æ˜¯ä»»æ„ä½ç½®éƒ½å¯ä»¥åœï¼Œå®ƒåªå‡ºç°åœ¨å­—èŠ‚ç ä¸­ä¸€äº›ç‰¹å®šçš„æŒ‡ä»¤ç‚¹ï¼ˆæ¯”å¦‚æ–¹æ³•è°ƒç”¨ã€å¾ªç¯è·³è½¬ç­‰ï¼‰<br>\n3.ç­‰æ‰€æœ‰çº¿ç¨‹éƒ½è¿›å…¥ Safepoint åï¼ŒJVM æ‰èƒ½å¼€å§‹æ‰§è¡Œ GC ç­‰å…¨å±€æ“ä½œã€‚</li>\n</ul>\n</div>\n<h5 id=\"G1-æ”¶é›†å™¨å‚æ•°é…ç½®è¡¨\">G1 æ”¶é›†å™¨å‚æ•°é…ç½®è¡¨</h5>\n<table>\n<thead>\n<tr>\n<th>å‚æ•°å</th>\n<th>è¯´æ˜</th>\n<th>é»˜è®¤å€¼</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>-XX:+UseG1GC</code></td>\n<td>ä½¿ç”¨ G1 åƒåœ¾æ”¶é›†å™¨</td>\n<td>-</td>\n</tr>\n<tr>\n<td><code>-XX:ParallelGCThreads</code></td>\n<td>æŒ‡å®š GC å·¥ä½œçš„çº¿ç¨‹æ•°é‡</td>\n<td>ä¸ CPU æ•°é‡ç›¸å…³</td>\n</tr>\n<tr>\n<td><code>-XX:G1HeapRegionSize</code></td>\n<td>è®¾ç½®å †åˆ†åŒºå¤§å°ï¼ˆ1MB~32MBï¼Œ2 çš„å¹‚ï¼‰ï¼Œå †é»˜è®¤åˆ’åˆ†ä¸º 2048 ä¸ª Region</td>\n<td>è‡ªåŠ¨è®¡ç®—</td>\n</tr>\n<tr>\n<td><code>-XX:MaxGCPauseMillis</code></td>\n<td>è®¾ç½® GC ç›®æ ‡æœ€å¤§æš‚åœæ—¶é—´</td>\n<td>200ms</td>\n</tr>\n<tr>\n<td><code>-XX:G1NewSizePercent</code></td>\n<td>æ–°ç”Ÿä»£åˆå§‹å æ¯”ï¼ˆå æ•´ä¸ªå †ï¼‰ï¼Œå®éªŒæ€§å‚æ•°ï¼Œ-XX:+UnlockExperimentalVMOptions</td>\n<td>5%</td>\n</tr>\n<tr>\n<td><code>-XX:G1MaxNewSizePercent</code></td>\n<td>æ–°ç”Ÿä»£æœ€å¤§å æ¯”ï¼ˆå æ•´ä¸ªå †ï¼‰ï¼Œå®éªŒæ€§å‚æ•°ï¼Œ-XX:+UnlockExperimentalVMOptions</td>\n<td>60%</td>\n</tr>\n<tr>\n<td><code>-XX:TargetSurvivorRatio</code></td>\n<td>Survivor åŒºå¡«å……ç›®æ ‡ï¼ˆè¶…è¿‡è¯¥æ¯”ä¾‹ï¼Œæ™‹å‡è€å¹´ä»£ï¼‰</td>\n<td>50%</td>\n</tr>\n<tr>\n<td><code>-XX:MaxTenuringThreshold</code></td>\n<td>æœ€å¤§å¯¹è±¡å¹´é¾„é˜ˆå€¼ï¼ˆå¹´é¾„è¶…è¿‡å°†è¿›å…¥è€å¹´ä»£ï¼‰</td>\n<td>15</td>\n</tr>\n<tr>\n<td><code>-XX:InitiatingHeapOccupancyPercent</code></td>\n<td>è€å¹´ä»£çš„ä½¿ç”¨ç‡è¶…è¿‡è¯¥å€¼è§¦å‘ Mixed GC</td>\n<td>45%</td>\n</tr>\n<tr>\n<td><code>-XX:G1MixedGCLiveThresholdPercent</code></td>\n<td>Mixed GC ä¸­ï¼šRegion å­˜æ´»å¯¹è±¡å æ¯”ä½äºè¯¥å€¼æ‰ä¼šè¢«å›æ”¶ï¼Œå®éªŒæ€§å‚æ•°ï¼Œ-XX:+UnlockExperimentalVMOptions</td>\n<td>85%</td>\n</tr>\n<tr>\n<td><code>-XX:G1HeapWastePercent</code></td>\n<td>Mixed GC å›æ”¶ç›®æ ‡ï¼šç©ºé—² Region è¾¾å †æ€»é‡è¯¥ç™¾åˆ†æ¯”å°±ç»“æŸæ··åˆå›æ”¶</td>\n<td>5%</td>\n</tr>\n<tr>\n<td><code>-XX:G1ReservePercent</code></td>\n<td>ä¸ºæ»¡è¶³åœé¡¿æ—¶é—´ç›®æ ‡ä¿ç•™çš„å †ç©ºé—´æ¯”ä¾‹ï¼Œæ˜¯ä¸€ç§ç©ºé—´æ¢æ—¶é—´çš„ç­–ç•¥ï¼Œåœ¨å†…å­˜ä¸è¶³æ—¶å¯èƒ½é€ æˆå†…å­˜æ›´åŠ ç´§å¼ </td>\n<td>10%</td>\n</tr>\n<tr>\n<td><code>-XX:G1UseAdaptiveIHOP</code></td>\n<td>æ˜¯å¦å¯ç”¨è‡ªé€‚åº”IHOPï¼Œå¯ç”¨åG1ä¼šåœ¨åˆå§‹é‡‡æ ·åè‡ªåŠ¨è°ƒæ•´IHOPå€¼</td>\n<td>true</td>\n</tr>\n<tr>\n<td><code>-XX:G1AdaptiveIHOPNumInitialSamples</code></td>\n<td>æŒ‡å®šå‰å‡ æ¬¡GCæ´»åŠ¨æŒ‰IHOPå‚æ•°è®¡ç®—</td>\n<td>3</td>\n</tr>\n<tr>\n<td><code>-XX:SoftRefLRUPolicyMSPerMB</code></td>\n<td>æ¯MBå †å†…å­˜ä¸­è½¯å¼•ç”¨çš„è¿‡æœŸæ—¶é—´(ms)</td>\n<td>1000</td>\n</tr>\n<tr>\n<td><code>-XX:G1OldCSetRegionThresholdPercent</code></td>\n<td>è®¾ç½®ä¸€æ¬¡æ··åˆGCä¸­éœ€è¦æ¸…ç†çš„OldåŒºçš„å†…å­˜æ¯”ä¾‹ï¼Œè°ƒå¤§å¯é™ä½G1é¢‘ç‡ä½†ä¼šå¢åŠ æ¯æ¬¡GCæ—¶é—´</td>\n<td>10%</td>\n</tr>\n<tr>\n<td><code>-XX:G1MixedGCCountTarget</code></td>\n<td>è®¾ç½®G1åƒåœ¾å›æ”¶å™¨çš„çº¿ç¨‹ä¸Šé™ï¼ŒHotSpotä¼šæ ¹æ®æ¸…ç†ç›®æ ‡è‡ªåŠ¨è®¡ç®—æ‰€éœ€çº¿ç¨‹æ•°ï¼Œä½†ä¸ä¼šè¶…è¿‡æ­¤ä¸Šé™</td>\n<td>8</td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"ZGC-åƒåœ¾å›æ”¶å™¨\">ZGC åƒåœ¾å›æ”¶å™¨</h4>\n<p><img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/bBUAYt.png\" alt=\"\" width=\"700\" height=\"500\"></p>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ZGC(Z Garbage Collector)æ˜¯ä¸€æ¬¾JDK 11ä¸­æ–°åŠ å…¥çš„å…·æœ‰å®éªŒæ€§è´¨çš„ä½å»¶è¿Ÿåƒåœ¾æ”¶é›†å™¨ï¼ŒZGCå¯ä»¥è¯´æºè‡ªäºæ˜¯Azul Systemå…¬å¸å¼€å‘çš„C4ï¼ˆConcurrent Continuously Compacting Collectorï¼‰ æ”¶é›†å™¨</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>Platform</th>\n<th>Supported</th>\n<th>Since</th>\n<th>Comment</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Linux/x64</td>\n<td>âœ…</td>\n<td>JDK 11</td>\n<td></td>\n</tr>\n<tr>\n<td>Linux/AArch64</td>\n<td>âœ…</td>\n<td>JDK 13</td>\n<td></td>\n</tr>\n<tr>\n<td>macOS</td>\n<td>âœ…</td>\n<td>JDK 14</td>\n<td></td>\n</tr>\n<tr>\n<td>Windows</td>\n<td>âœ…</td>\n<td>JDK 14</td>\n<td>Requires Windows version 1803 (Windows 10 or Windows Server 2019) or later.</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ZGCæ”¶é›†å™¨æ˜¯ä¸€æ¬¾åŸºäºRegionå†…å­˜å¸ƒå±€çš„ï¼Œæš‚æ—¶ä¸è®¾åˆ†ä»£çš„(jdk21åæ”¯æŒåˆ†ä»£)ï¼Œä½¿ç”¨äº†<code>è¯»å±éšœ</code>ã€<code>é¢œè‰²æŒ‡é’ˆ</code>ç­‰æŠ€æœ¯æ¥å®ç°å¯å¹¶å‘çš„æ ‡è®°-æ•´ç†ç®—æ³•çš„ï¼Œä»¥ä½å»¶è¿Ÿä¸ºé¦–è¦ç›®æ ‡çš„ä¸€æ¬¾åƒåœ¾æ”¶é›†å™¨ã€‚</p>\n</li>\n</ul>\n<div class=\"tips\">\n<p><em><strong>é¢œè‰²æŒ‡é’ˆ</strong></em></p>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">åœ¨ ZGCï¼ˆZ Garbage Collectorï¼‰ä¸­ï¼Œé¢œè‰²æŒ‡é’ˆï¼ˆColored Pointerï¼‰æ˜¯ä¸€ç§æ ¸å¿ƒæœºåˆ¶ï¼ŒæŠŠå¯¹è±¡çš„ GC çŠ¶æ€ä¿¡æ¯ç›´æ¥åµŒå…¥åˆ°å¯¹è±¡çš„å¼•ç”¨ï¼ˆåœ°å€ï¼‰ä¸­ï¼Œç”¨äºåœ¨ä¸å¢åŠ å¯¹è±¡é¢å¤–å…ƒæ•°æ®çš„å‰æä¸‹ï¼Œè·Ÿè¸ªå¯¹è±¡åœ¨åƒåœ¾å›æ”¶è¿‡ç¨‹ä¸­çš„çŠ¶æ€ã€‚</li>\n<li class=\"lvl-2\">åœ¨ä¼ ç»Ÿ GC ä¸­ï¼Œå¯¹è±¡çš„â€œé¢œè‰²â€ï¼ˆå¦‚ç™½è‰²ã€ç°è‰²ã€é»‘è‰²ï¼‰è¡¨ç¤ºå…¶åœ¨ GC ä¸åŒé˜¶æ®µçš„çŠ¶æ€ï¼Œè¿™äº›ä¿¡æ¯ä¸€èˆ¬å­˜å‚¨åœ¨é¢å¤–çš„æ•°æ®ç»“æ„ä¸­ï¼ˆå¦‚è®°å¿†é›†åˆã€ä½å›¾ç­‰ï¼‰ã€‚</li>\n<li class=\"lvl-2\">è€Œåœ¨ ZGC ä¸­ï¼ŒZGC å°†å¯¹è±¡çš„è¿™äº›çŠ¶æ€ä¿¡æ¯ç¼–ç è¿›æŒ‡é’ˆçš„é«˜ä½ä¸­ã€‚æ‰€ä»¥ä¸€ä¸ªå¯¹è±¡å¼•ç”¨ï¼ˆpointerï¼‰ä¸ä»…ä»…æ˜¯å†…å­˜åœ°å€ï¼Œè¿˜æºå¸¦äº†å¯¹è±¡åœ¨ GC è¿‡ç¨‹ä¸­çš„â€œé¢œè‰²â€ä¿¡æ¯ã€‚</li>\n<li class=\"lvl-2\">ZGC ä¸»è¦è¿è¡Œåœ¨ 64 ä½ç³»ç»Ÿä¸Šï¼Œä½†å½“å‰çš„æ“ä½œç³»ç»Ÿå’Œ CPU å®é™…ä¸Šåªä½¿ç”¨ 48ï½57 ä½è™šæ‹Ÿåœ°å€ã€‚ZGC åˆ©ç”¨æœªä½¿ç”¨çš„é«˜ä½è¿›è¡Œç¼–ç ã€‚<br>\n<img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/LD51Zb.png\" alt=\"\" width=\"900\" height=\"300\"></li>\n<li class=\"lvl-2\">æ¯ä¸ªå¯¹è±¡æœ‰ä¸€ä¸ª64ä½æŒ‡é’ˆï¼Œè¿™64ä½è¢«åˆ†ä¸ºï¼š</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>ä½æ•°</th>\n<th>åç§°</th>\n<th>å«ä¹‰</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>18 ä½</td>\n<td>é¢„ç•™</td>\n<td>ä¿ç•™ä½ï¼Œæœªæ¥å¯èƒ½ç”¨äºæ‰©å±•åŠŸèƒ½</td>\n</tr>\n<tr>\n<td>1 ä½</td>\n<td>Finalizable</td>\n<td>è¡¨ç¤ºå¯¹è±¡å¯ç»ˆç»“ï¼ˆå³å®ç°äº† <code>finalize()</code> æ–¹æ³•ï¼‰</td>\n</tr>\n<tr>\n<td>1 ä½</td>\n<td>Remapped</td>\n<td>æ ‡è¯†å¯¹è±¡æ˜¯å¦å·²è¢«è½¬ç§»(ç”¨äºæ ‡è¯†æŸä¸ªå¼•ç”¨æ˜¯å¦å·²ç»è¢«é‡å®šå‘ï¼ˆæ›´æ–°ä¸ºæ–°åœ°å€ï¼‰)ï¼›ä¸º 1 è¡¨ç¤ºè¯¥å¯¹è±¡æœªåœ¨é‡å®šä½é›†ï¼ˆRelocation Setï¼‰ä¸­ï¼Œå³æ–°åœ°å€ï¼Œä¸º0è¡¨ç¤ºæ—§åœ°å€</td>\n</tr>\n<tr>\n<td>1 ä½</td>\n<td>Marked1</td>\n<td>æ ‡è®°ä½ä¹‹ä¸€ï¼Œç”¨äº GC è¿‡ç¨‹ä¸­çš„å¯¹è±¡æ ‡è®°é˜¶æ®µ ,ç”±äº ZGC æ˜¯å¹¶å‘ GCï¼Œéœ€è¦ä¸¤ä½æ¥æ”¯æŒé¢œè‰²åˆ‡æ¢æœºåˆ¶ï¼ˆColor Flipï¼‰ï¼Œç¡®ä¿åœ¨ä¸åŒ GC å‘¨æœŸä¸­å¯ä»¥åŒºåˆ†æ–°æ—§æ ‡è®°ï¼Œéœ€è¦è§¦å‘ä¸€æ¬¡è¯»å–å±éšœï¼ˆload barrierï¼‰ï¼Œæ‰¾åˆ°å¯¹è±¡çš„æ–°ä½ç½®ï¼Œå¹¶æ›´æ–°è¿™ä¸ªå¼•ç”¨ã€‚</td>\n</tr>\n<tr>\n<td>1 ä½</td>\n<td>Marked0</td>\n<td>å¦ä¸€ä¸ªæ ‡è®°ä½ï¼Œä¸ Marked1 é…åˆç”¨äº GC æ ‡è®°é˜¶æ®µ</td>\n</tr>\n<tr>\n<td>42 ä½</td>\n<td>å¯¹è±¡åœ°å€éƒ¨åˆ†</td>\n<td>å®é™…çš„å†…å­˜åœ°å€éƒ¨åˆ†ï¼Œæœ€å¤šå¯è¡¨ç¤º 2^42 å­—èŠ‚ï¼ˆå³ 4 TBï¼‰,jdk15åå ç”¨ 44ä½ï¼Œæ”¯æŒ 16TB</td>\n</tr>\n</tbody>\n</table>\n<p><em><strong>è¯»å±éšœ</strong></em></p>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">\n<p>ZGCï¼ˆZ Garbage Collectorï¼‰ä¸­çš„**è¯»å±éšœï¼ˆRead Barrierï¼‰æ˜¯å…¶æ ¸å¿ƒæœºåˆ¶ä¹‹ä¸€ï¼Œå®ƒä¿è¯äº†å¹¶å‘å‹ç¼©ï¼ˆå¯¹è±¡ç§»åŠ¨ï¼‰**æ—¶ç¨‹åºçš„æ­£ç¡®æ€§ï¼Œæ˜¯å®ç°ä½å»¶è¿Ÿã€é«˜å¹¶å‘åƒåœ¾å›æ”¶çš„å…³é”®ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>åœ¨ä¼ ç»Ÿ GC ä¸­ï¼Œå¦‚æœå¯¹è±¡åœ¨ GC è¿‡ç¨‹ä¸­è¢«ç§»åŠ¨ï¼Œç¨‹åºè®¿é—®åˆ°çš„å¯¹è±¡åœ°å€å¯èƒ½å°±æ— æ•ˆäº†ã€‚å› æ­¤ï¼Œéœ€è¦**â€œåœä¸–ç•Œâ€**å°†æ‰€æœ‰å¼•ç”¨æ›´æ–°ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>è€Œ ZGC çš„è®¾è®¡ç›®æ ‡æ˜¯ &lt;10ms çš„ GC åœé¡¿æ—¶é—´ï¼Œæ‰€ä»¥å®ƒé‡‡ç”¨ <code>å¹¶å‘æ ‡è®° + å¹¶å‘ç§»åŠ¨ + å¹¶å‘å¼•ç”¨æ›´æ–°</code> çš„æ¨¡å¼ã€‚åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œå¯¹è±¡å¯ä»¥åœ¨ç¨‹åºè¿è¡Œæ—¶è¢«ç§»åŠ¨ï¼Œä½†ç¨‹åºè®¿é—®æ—¶å¿…é¡»â€œçŸ¥é“â€è¿™ä¸ªå¯¹è±¡æ˜¯å¦å·²ç»è¢«ç§»åŠ¨ï¼Œå¹¶è·å–å…¶æœ€æ–°åœ°å€ï¼Œè¿™å°±æ˜¯è¯»å±éšœçš„èŒè´£ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>è¯»å±éšœæ˜¯ä¸€ç§åœ¨è¯»å–å¯¹è±¡å¼•ç”¨æ—¶è‡ªåŠ¨æ’å…¥çš„é€»è¾‘ï¼Œç”¨äºæ£€æŸ¥å¼•ç”¨æ˜¯å¦æœ‰æ•ˆï¼Œå¹¶åœ¨å¿…è¦æ—¶è¿›è¡Œä¿®æ­£ï¼ˆå³åœ°å€é‡å®šå‘ï¼‰ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>ZGC æ˜¯ç›®å‰å”¯ä¸€åœ¨æ‰€æœ‰å¯¹è±¡è®¿é—®ä¸­éƒ½ä½¿ç”¨è¯»å±éšœçš„ GCï¼Œå®ƒåœ¨æ¯æ¬¡å¯¹è±¡æŒ‡é’ˆè§£å¼•ç”¨æ—¶éƒ½è¿›è¡Œå¦‚ä¸‹æ“ä½œï¼š</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>èŒè´£</th>\n<th>è¯´æ˜</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>æ£€æµ‹å¼•ç”¨æ˜¯å¦æ˜¯è€åœ°å€</strong></td>\n<td>åˆ©ç”¨æŒ‡é’ˆä¸­çš„å…ƒä¿¡æ¯ï¼ˆé¢œè‰²æŒ‡é’ˆï¼Œå¦‚ Remapped ä½ï¼‰åˆ¤æ–­å¼•ç”¨æ˜¯å¦å·²ç»è¢«æ›´æ–°</td>\n</tr>\n<tr>\n<td><strong>å¦‚æœæœªæ›´æ–°åˆ™é‡å®šå‘å¼•ç”¨</strong></td>\n<td>å¦‚æœå¼•ç”¨çš„æ˜¯æ—§åœ°å€ï¼Œå±éšœä¼šé€šè¿‡ forwarding table æ‰¾åˆ°æ–°åœ°å€å¹¶æ›´æ–°</td>\n</tr>\n<tr>\n<td><strong>ä¿è¯æœ€ç»ˆè®¿é—®å¯¹è±¡çš„åœ°å€æ­£ç¡®</strong></td>\n<td>å³ä½¿åœ¨å¯¹è±¡ç§»åŠ¨è¿‡ç¨‹ä¸­ï¼Œç¨‹åºä¹Ÿæ€»èƒ½è®¿é—®åˆ°æœ‰æ•ˆåœ°å€ï¼Œæ— éœ€åœé¡¿æ‰€æœ‰çº¿ç¨‹</td>\n</tr>\n</tbody>\n</table>\n<pre>\n<code class=\"mermaid\">\ngraph TD\nA[ç¨‹åºè®¿é—®å¯¹è±¡å¼•ç”¨&lt;br&#x2F;&gt;ä¾‹å¦‚ï¼šPerson p &#x3D; personField] --&gt; B[JVM æ’å…¥è¯»å±éšœé€»è¾‘]\nB --&gt; C[è¯»å±éšœæ£€æŸ¥é¢œè‰²æŒ‡é’ˆä¸­çš„ Remapped ä½]\nC --&gt; D{Remapped ä½ä¸º 0 å—ï¼Ÿ}\nD -- æ˜¯ --&gt; E[æ£€æŸ¥å¯¹è±¡æ˜¯å¦å·²è¢«ç§»åŠ¨]\nE --&gt; F[æ›´æ–°å¼•ç”¨åœ°å€ä¸ºæ–°åœ°å€]\nF --&gt; G[è®¾ç½® Remapped ä½ä¸º 1]\nG --&gt; H[ä½¿ç”¨æ›´æ–°åçš„å¼•ç”¨è®¿é—®å¯¹è±¡]\nD -- å¦ --&gt; I[ç›´æ¥ä½¿ç”¨å½“å‰å¼•ç”¨è®¿é—®å¯¹è±¡]\n</code>\n</pre>\n</div>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ZGCçš„Regionå¯ä»¥å…·æœ‰å¤§ã€ä¸­ã€å°ä¸‰ç±»å®¹é‡ï¼š</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">å°å‹Regionï¼ˆSmall Regionï¼‰ ï¼š å®¹é‡å›ºå®šä¸º2MBï¼Œç”¨äºæ”¾ç½®å°äº256KBçš„å°å¯¹è±¡ã€‚</li>\n<li class=\"lvl-6\">ä¸­å‹Regionï¼ˆMedium Regionï¼‰ ï¼š å®¹é‡å›ºå®šä¸º32MBï¼Œç”¨äºæ”¾ç½®å¤§äºç­‰äº256KBä½†å°äº4MBçš„å¯¹è±¡ã€‚</li>\n<li class=\"lvl-6\">å¤§å‹Regionï¼ˆLarge Regionï¼‰ ï¼š å®¹é‡ä¸å›ºå®šï¼Œå¯ä»¥åŠ¨æ€å˜åŒ–ï¼Œä½†å¿…é¡»ä¸º2MBçš„æ•´æ•°å€ï¼Œç”¨äºæ”¾ç½®4MBæˆ–ä»¥ä¸Šçš„å¤§å¯¹è±¡ã€‚</li>\n</ul>\n<blockquote>\n<p>æ¯ä¸ªå¤§å‹Regionä¸­åªä¼šå­˜æ”¾ä¸€ä¸ªå¤§å¯¹è±¡ï¼Œè¿™ä¹Ÿé¢„ç¤ºç€è™½ç„¶åå­—å«ä½œâ€œå¤§å‹Regionâ€ï¼Œä½†å®ƒçš„å®é™…å®¹é‡å®Œå…¨æœ‰å¯èƒ½å°äºä¸­å‹Regionï¼Œæœ€å°å®¹é‡å¯ä½è‡³4MBã€‚</p>\n</blockquote>\n</li>\n<li class=\"lvl-2\">\n<p>ZGC ç‰¹ç‚¹ï¼š</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">æ”¯æŒæå¤§å †ï¼ˆJDK 15 èµ·æ”¯æŒæœ€é«˜ 16TBï¼‰</li>\n<li class=\"lvl-6\">GC åœé¡¿æ—¶é—´é€šå¸¸ä½äº 1msï¼ˆä¸å †å¤§å°åŸºæœ¬æ— å…³ï¼‰</li>\n<li class=\"lvl-6\">é€‚åˆä½å»¶è¿Ÿã€é«˜ååã€é«˜å¯ç”¨çš„åº”ç”¨åœºæ™¯ï¼Œå¦‚äº¤æ˜“ç³»ç»Ÿã€å¹¿å‘Šæ¨èç­‰</li>\n</ul>\n</li>\n</ul>\n<h5 id=\"ZGC-æ”¶é›†å™¨çš„å·¥ä½œæ–¹å¼\">ZGC æ”¶é›†å™¨çš„å·¥ä½œæ–¹å¼</h5>\n<p><img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/94yKcU.png\" alt=\"\"></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1ï¸âƒ£ å¹¶å‘æ ‡è®°ï¼ˆConcurrent Markï¼‰ï¼š</span><br><span class=\"line\">   ä¸G1ä¸€æ ·ï¼Œå¹¶å‘æ ‡è®°æ˜¯éå†å¯¹è±¡å›¾åšå¯è¾¾æ€§åˆ†æçš„é˜¶æ®µï¼Œ</span><br><span class=\"line\">   å®ƒçš„åˆå§‹æ ‡è®°(Mark Start)å’Œæœ€ç»ˆæ ‡è®°(Mark End)ä¹Ÿä¼šå‡ºç°çŸ­æš‚çš„åœé¡¿ï¼Œ</span><br><span class=\"line\">   ä¸G1ä¸åŒçš„æ˜¯ï¼ŒZGCçš„æ ‡è®°æ˜¯åœ¨æŒ‡é’ˆä¸Šè€Œä¸æ˜¯åœ¨å¯¹è±¡ä¸Šè¿›è¡Œçš„ï¼Œ</span><br><span class=\"line\">   æ ‡è®°é˜¶æ®µä¼šæ›´æ–°æŸ“è‰²æŒ‡é’ˆä¸­çš„ Marked 0ã€ Marked 1 æ ‡å¿—ä½ã€‚</span><br><span class=\"line\"></span><br><span class=\"line\">2ï¸âƒ£ å¹¶å‘é¢„å¤‡é‡åˆ†é…ï¼ˆConcurrent Prepare <span class=\"keyword\">for</span> Relocateï¼‰ï¼š</span><br><span class=\"line\">   è¿™ä¸ªé˜¶æ®µéœ€è¦æ ¹æ®ç‰¹å®šçš„æŸ¥è¯¢æ¡ä»¶ç»Ÿè®¡å¾—å‡ºæœ¬æ¬¡æ”¶é›†è¿‡ç¨‹è¦æ¸…ç†å“ªäº›Regionï¼Œå°†è¿™äº›Regionç»„æˆé‡åˆ†é…é›†ï¼ˆRelocation Setï¼‰ã€‚</span><br><span class=\"line\">   ZGCæ¯æ¬¡å›æ”¶éƒ½ä¼šæ‰«ææ‰€æœ‰çš„Regionï¼Œç”¨èŒƒå›´æ›´å¤§çš„æ‰«ææˆæœ¬æ¢å–çœå»G1ä¸­è®°å¿†é›†çš„ç»´æŠ¤æˆæœ¬ã€‚</span><br><span class=\"line\"></span><br><span class=\"line\">3ï¸âƒ£ å¹¶å‘é‡åˆ†é…ï¼ˆConcurrent Relocateï¼‰ï¼š</span><br><span class=\"line\">   é‡åˆ†é…æ˜¯ZGCæ‰§è¡Œè¿‡ç¨‹ä¸­çš„æ ¸å¿ƒé˜¶æ®µï¼Œè¿™ä¸ªè¿‡ç¨‹è¦æŠŠé‡åˆ†é…é›†ä¸­çš„å­˜æ´»å¯¹è±¡å¤åˆ¶åˆ°æ–°çš„Regionä¸Šï¼Œ</span><br><span class=\"line\">   å¹¶ä¸ºé‡åˆ†é…é›†ä¸­çš„æ¯ä¸ªRegionç»´æŠ¤ä¸€ä¸ªè½¬å‘è¡¨ï¼ˆForward Tableï¼‰ï¼Œè®°å½•ä»æ—§å¯¹è±¡åˆ°æ–°å¯¹è±¡çš„è½¬å‘å…³ç³»ã€‚</span><br><span class=\"line\">   ZGCæ”¶é›†å™¨èƒ½ä»…ä»å¼•ç”¨ä¸Šå°±æ˜ç¡®å¾—çŸ¥ä¸€ä¸ªå¯¹è±¡æ˜¯å¦å¤„äºé‡åˆ†é…é›†ä¹‹ä¸­ï¼Œå¦‚æœç”¨æˆ·çº¿ç¨‹æ­¤æ—¶å¹¶å‘è®¿é—®äº†ä½äºé‡åˆ†é…é›†ä¸­çš„å¯¹è±¡ï¼Œ</span><br><span class=\"line\">   è¿™æ¬¡è®¿é—®å°†ä¼šè¢«é¢„ç½®çš„å†…å­˜å±éšœ(è¯»å±éšœ)æ‰€æˆªè·ï¼Œç„¶åç«‹å³æ ¹æ®Regionä¸Šçš„è½¬å‘è¡¨è®°å½•å°†è®¿é—®è½¬å‘åˆ°æ–°å¤åˆ¶çš„å¯¹è±¡ä¸Šï¼Œ</span><br><span class=\"line\">   å¹¶åŒæ—¶ä¿®æ­£æ›´æ–°è¯¥å¼•ç”¨çš„å€¼ï¼Œä½¿å…¶ç›´æ¥æŒ‡å‘æ–°å¯¹è±¡ï¼ŒZGCå°†è¿™ç§è¡Œä¸ºç§°ä¸ºæŒ‡é’ˆçš„â€œè‡ªæ„ˆâ€ï¼ˆSelf-Healingï¼‰èƒ½åŠ›ã€‚</span><br><span class=\"line\"></span><br><span class=\"line\">4ï¸âƒ£ å¹¶å‘é‡æ˜ å°„ï¼ˆConcurrent Remapï¼‰ï¼š</span><br><span class=\"line\">   é‡æ˜ å°„æ‰€åšçš„å°±æ˜¯ä¿®æ­£æ•´ä¸ªå †ä¸­æŒ‡å‘é‡åˆ†é…é›†ä¸­æ—§å¯¹è±¡çš„æ‰€æœ‰å¼•ç”¨ï¼Œä½†æ˜¯ZGCä¸­å¯¹è±¡å¼•ç”¨å­˜åœ¨â€œè‡ªæ„ˆâ€åŠŸèƒ½ï¼Œæ‰€ä»¥è¿™ä¸ªé‡æ˜ å°„æ“ä½œå¹¶ä¸æ˜¯å¾ˆè¿«åˆ‡ã€‚</span><br><span class=\"line\">   ZGCå¾ˆå·§å¦™åœ°æŠŠå¹¶å‘é‡æ˜ å°„é˜¶æ®µï¼ˆConcurrent Remapï¼‰è¦åšçš„å·¥ä½œï¼Œåˆå¹¶åˆ°äº†ä¸‹ä¸€æ¬¡åƒåœ¾æ”¶é›†å¾ªç¯ä¸­çš„å¹¶å‘æ ‡è®°é˜¶æ®µï¼ˆConcurrent Markï¼‰é‡Œå»å®Œæˆï¼Œ</span><br><span class=\"line\">   åæ­£å®ƒä»¬éƒ½æ˜¯è¦éå†æ‰€æœ‰å¯¹è±¡çš„ï¼Œè¿™æ ·åˆå¹¶å°±èŠ‚çœäº†ä¸€æ¬¡éå†å¯¹è±¡å›¾çš„å¼€é”€ã€‚</span><br><span class=\"line\">   ä¸€æ—¦æ‰€æœ‰æŒ‡é’ˆéƒ½è¢«ä¿®æ­£ä¹‹åï¼Œ åŸæ¥è®°å½•æ–°æ—§å¯¹è±¡å…³ç³»çš„è½¬å‘è¡¨å°±å¯ä»¥é‡Šæ”¾æ‰äº†ã€‚</span><br></pre></td></tr></table></figure>\n<h5 id=\"ZGCå­˜åœ¨çš„é—®é¢˜\">ZGCå­˜åœ¨çš„é—®é¢˜</h5>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ZGCæœ€å¤§çš„é—®é¢˜æ˜¯<code>æµ®åŠ¨åƒåœ¾</code>ã€‚ZGCçš„åœé¡¿æ—¶é—´æ˜¯åœ¨10msä»¥ä¸‹ï¼Œä½†æ˜¯ZGCçš„æ‰§è¡Œæ—¶é—´è¿˜æ˜¯è¿œè¿œå¤§äºè¿™ä¸ªæ—¶é—´çš„ã€‚å‡å¦‚ZGCå…¨è¿‡ç¨‹éœ€è¦æ‰§è¡Œ10åˆ†é’Ÿï¼Œåœ¨è¿™ä¸ªæœŸé—´ç”±äºå¯¹è±¡åˆ†é…é€Ÿç‡å¾ˆé«˜ï¼Œå°†åˆ›å»ºå¤§é‡çš„æ–°å¯¹è±¡ï¼Œè¿™äº›å¯¹è±¡å¾ˆéš¾è¿›å…¥å½“æ¬¡GCï¼Œæ‰€ä»¥åªèƒ½åœ¨ä¸‹æ¬¡GCçš„æ—¶å€™è¿›è¡Œå›æ”¶ï¼Œè¿™äº›åªèƒ½ç­‰åˆ°ä¸‹æ¬¡GCæ‰èƒ½å›æ”¶çš„å¯¹è±¡å°±æ˜¯æµ®åŠ¨åƒåœ¾ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>ZGCæ²¡æœ‰åˆ†ä»£æ¦‚å¿µï¼Œæ¯æ¬¡éƒ½éœ€è¦è¿›è¡Œå…¨å †æ‰«æï¼Œå¯¼è‡´ä¸€äº›â€œæœç”Ÿå¤•æ­»â€çš„å¯¹è±¡æ²¡èƒ½åŠæ—¶çš„è¢«å›æ”¶ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>ç›®å‰å”¯ä¸€çš„åŠæ³•æ˜¯å¢å¤§å †çš„å®¹é‡ï¼Œä½¿å¾—ç¨‹åºå¾—åˆ°æ›´å¤šçš„å–˜æ¯æ—¶é—´ï¼Œä½†æ˜¯è¿™ä¸ªä¹Ÿæ˜¯ä¸€ä¸ªæ²»æ ‡ä¸æ²»æœ¬çš„æ–¹æ¡ˆã€‚å¦‚æœéœ€è¦ä»æ ¹æœ¬ä¸Šè§£å†³è¿™ä¸ªé—®é¢˜ï¼Œè¿˜æ˜¯éœ€è¦å¼•å…¥åˆ†ä»£æ”¶é›†ï¼Œè®©æ–°ç”Ÿå¯¹è±¡éƒ½åœ¨ä¸€ä¸ªä¸“é—¨çš„åŒºåŸŸä¸­åˆ›å»ºï¼Œç„¶åä¸“é—¨é’ˆå¯¹è¿™ä¸ªåŒºåŸŸè¿›è¡Œæ›´é¢‘ç¹ã€æ›´å¿«çš„æ”¶é›†ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>JDK21æ­£å¼å¼•å…¥äº†åˆ†ä»£ï¼ˆjdk17æ˜¯é¢„è§ˆç‰ˆï¼‰ï¼Œå¯ä»¥åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ï¼Œéœ€è¦æ‰‹åŠ¨å¼€å¯ï¼š<code>-XX:+ZGenerational</code></p>\n</li>\n</ul>\n<h5 id=\"ZGC-æ”¶é›†å™¨å‚æ•°é…ç½®è¡¨\">ZGC æ”¶é›†å™¨å‚æ•°é…ç½®è¡¨</h5>\n<table>\n<thead>\n<tr>\n<th>å‚æ•°å</th>\n<th>è¯´æ˜</th>\n<th>é»˜è®¤å€¼ï¼ˆå¦‚æœªç‰¹æ®Šæ ‡æ³¨ï¼‰</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>-XX:+UseZGC</code></td>\n<td>å¯ç”¨ ZGC åƒåœ¾æ”¶é›†å™¨</td>\n<td>-</td>\n</tr>\n<tr>\n<td><code>-XX:+UnlockExperimentalVMOptions</code></td>\n<td>è§£é”å®éªŒæ€§å‚æ•°ï¼ˆJDK 11~14 ä½¿ç”¨ ZGC å¿…é¡»ï¼‰</td>\n<td>-</td>\n</tr>\n<tr>\n<td><code>-XX:+UseLargePages</code></td>\n<td>å¯ç”¨å¤§é¡µå†…å­˜ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰</td>\n<td>false</td>\n</tr>\n<tr>\n<td><code>-XX:+UseTransparentHugePages</code></td>\n<td>å¯ç”¨é€æ˜å¤§é¡µï¼ˆéƒ¨åˆ† Linux ä¸Šå¯ç»“åˆä½¿ç”¨ï¼‰</td>\n<td>false</td>\n</tr>\n<tr>\n<td><code>-Xmx</code> / <code>-Xms</code></td>\n<td>è®¾ç½®æœ€å¤§/åˆå§‹å †å¤§å°</td>\n<td>ç”¨æˆ·é…ç½®</td>\n</tr>\n<tr>\n<td><code>-XX:ZUncommitDelay=&lt;ç§’&gt;</code></td>\n<td>æœªä½¿ç”¨å†…å­˜é‡Šæ”¾å›æ“ä½œç³»ç»Ÿçš„å»¶è¿Ÿæ—¶é—´ï¼ˆZGC ä¼šè‡ªåŠ¨é‡Šæ”¾å†…å­˜ï¼‰</td>\n<td>300ï¼ˆ5åˆ†é’Ÿï¼‰</td>\n</tr>\n<tr>\n<td><code>-XX:SoftMaxHeapSize=&lt;å¤§å°&gt;</code></td>\n<td>è½¯æœ€å¤§å †ï¼ˆSoft Heap Limitï¼‰ï¼šZGC å°è¯•å°†ä½¿ç”¨çš„å †æ§åˆ¶åœ¨è¯¥å€¼ä»¥å†…</td>\n<td>é»˜è®¤ç­‰äº -Xmx</td>\n</tr>\n<tr>\n<td><code>-XX:MaxHeapFreeRatio</code></td>\n<td>æœ€å¤§å †ç©ºé—²æ¯”ä¾‹ï¼ˆè¶…è¿‡æ­¤æ¯”ä¾‹å¯èƒ½è§¦å‘å†…å­˜é‡Šæ”¾ï¼‰</td>\n<td>70</td>\n</tr>\n<tr>\n<td><code>-XX:MinHeapFreeRatio</code></td>\n<td>æœ€å°å †ç©ºé—²æ¯”ä¾‹ï¼ˆä½äºæ­¤æ¯”ä¾‹å¯èƒ½è§¦å‘æ‰©å®¹ï¼‰</td>\n<td>40</td>\n</tr>\n<tr>\n<td><code>-XX:+ZGenerational</code></td>\n<td>å¯ç”¨ ZGC åˆ†ä»£æ”¶é›†ï¼ˆä» JDK 21 èµ·æ”¯æŒï¼Œé»˜è®¤å…³é—­ï¼‰</td>\n<td>falseï¼ˆJDK 21+ï¼‰</td>\n</tr>\n<tr>\n<td><code>-XX:+PrintGC</code> / <code>-Xlog:gc*</code></td>\n<td>å¼€å¯ GC æ—¥å¿—è¾“å‡º</td>\n<td>-</td>\n</tr>\n<tr>\n<td><code>-XX:+ZProactive</code></td>\n<td>ä¸»åŠ¨å›æ”¶ç­–ç•¥ï¼ˆåœ¨ç³»ç»Ÿç©ºé—²æ—¶å°è¯•å›æ”¶ï¼‰</td>\n<td>true</td>\n</tr>\n<tr>\n<td><code>-XX:ZCollectionInterval=&lt;ç§’&gt;</code></td>\n<td>ä¸»åŠ¨å›æ”¶ä¹‹é—´çš„æœ€å°æ—¶é—´é—´éš”ï¼ˆé…åˆ ZProactiveï¼‰</td>\n<td>é»˜è®¤å€¼å› ç‰ˆæœ¬è€Œå¼‚</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"ZGC-vs-G1-GC-vs-Parallel-GC-å¯¹æ¯”è¡¨\">ZGC vs G1 GC vs Parallel GC å¯¹æ¯”è¡¨</h3>\n<table>\n<thead>\n<tr>\n<th>ç‰¹æ€§</th>\n<th><strong>ZGC</strong></th>\n<th><strong>G1 GC</strong></th>\n<th><strong>Parallel GC</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>è®¾è®¡ç›®æ ‡</strong></td>\n<td><strong>æä½å»¶è¿Ÿ</strong>ï¼Œ&lt;1ms åœé¡¿</td>\n<td>å¹³è¡¡ <strong>ä½å»¶è¿Ÿ</strong> ä¸ <strong>é«˜åå</strong></td>\n<td><strong>é«˜åå</strong>ï¼Œæœ€å¤§åŒ– CPU ä½¿ç”¨</td>\n</tr>\n<tr>\n<td><strong>GC åœé¡¿æ—¶é—´</strong></td>\n<td>&lt;1msï¼Œå †å¤§å°å¢åŠ ä¸å½±å“åœé¡¿æ—¶é—´</td>\n<td>å‡ ååˆ°å‡ ç™¾æ¯«ç§’ï¼Œå †è¶Šå¤§åœé¡¿è¶Šæ˜æ˜¾</td>\n<td>åœé¡¿æ—¶é—´å¯èƒ½è¾¾åˆ°ç§’çº§ï¼Œ<strong>å †è¶Šå¤§è¶Šæ˜æ˜¾</strong></td>\n</tr>\n<tr>\n<td><strong>å †å¤§å°æ”¯æŒ</strong></td>\n<td>æ”¯æŒé«˜è¾¾ <strong>16TB</strong>ï¼ˆJDK 15+ï¼‰</td>\n<td>æ”¯æŒ <strong>æœ€å¤š 4TB</strong></td>\n<td>æ”¯æŒå¤§å †ï¼Œä½†åœé¡¿æ˜æ˜¾</td>\n</tr>\n<tr>\n<td><strong>æ˜¯å¦åˆ†ä»£</strong></td>\n<td>é»˜è®¤ä¸åˆ†ä»£ï¼ˆJDK 21+ å¯å¼€å¯ <code>-XX:+ZGenerational</code>ï¼‰</td>\n<td>åˆ†ä»£ï¼ˆæ–°ç”Ÿä»£ + è€å¹´ä»£ï¼‰</td>\n<td>åˆ†ä»£ï¼ˆæ–°ç”Ÿä»£ + è€å¹´ä»£ï¼‰</td>\n</tr>\n<tr>\n<td><strong>å¹¶å‘å›æ”¶</strong></td>\n<td>æ˜¯ï¼Œ<strong>åŒ…æ‹¬æ ‡è®°ã€å‹ç¼©ã€å¼•ç”¨å¤„ç†éƒ½å¹¶å‘</strong></td>\n<td>éƒ¨åˆ†å¹¶å‘ï¼Œä»åŒ…å«æ˜æ˜¾ Stop-The-World é˜¶æ®µ</td>\n<td>å¦ï¼Œ<strong>å…¨éƒ¨ Stop-The-World</strong></td>\n</tr>\n<tr>\n<td><strong>ç§»åŠ¨å¯¹è±¡æ—¶æ˜¯å¦åœé¡¿</strong></td>\n<td>å¦ï¼Œä½¿ç”¨è¯»å±éšœå¹¶å‘è½¬ç§»å¯¹è±¡</td>\n<td>æ˜¯ï¼ˆé€šè¿‡å¤åˆ¶åŒºåŸŸï¼‰</td>\n<td>æ˜¯</td>\n</tr>\n<tr>\n<td><strong>å®ç°æœºåˆ¶</strong></td>\n<td>æ ‡è®°-é‡å®šä½ï¼ŒåŸºäºè¯»å±éšœ</td>\n<td>Region åˆ†åŒº + æ ‡è®°-å¤åˆ¶ + Mixed GC</td>\n<td>æ ‡è®°-å¤åˆ¶ï¼ˆæ–°ç”Ÿä»£ï¼‰ã€æ ‡è®°-æ•´ç†ï¼ˆè€å¹´ä»£ï¼‰</td>\n</tr>\n<tr>\n<td><strong>ååèƒ½åŠ›</strong></td>\n<td>ä¸­é«˜</td>\n<td>é«˜</td>\n<td><strong>æœ€é«˜</strong></td>\n</tr>\n<tr>\n<td><strong>é€‚ç”¨åœºæ™¯</strong></td>\n<td>ä½å»¶è¿Ÿç³»ç»Ÿï¼Œå¦‚é‡‘èã€äº¤æ˜“ã€æ¨èç­‰å®æ—¶åº”ç”¨</td>\n<td>é€šç”¨åå°ç³»ç»Ÿã€Web æœåŠ¡ç­‰</td>\n<td>æ‰¹å¤„ç†ã€æ•°æ®è®¡ç®—ã€æ—¥å¿—åˆ†æç­‰ä¸æ•æ„Ÿäºåœé¡¿çš„ç³»ç»Ÿ</td>\n</tr>\n<tr>\n<td><strong>é»˜è®¤å¯ç”¨</strong></td>\n<td>å¦ï¼Œéœ€æŒ‡å®š <code>-XX:+UseZGC</code></td>\n<td>JDK 9+ é»˜è®¤ GC</td>\n<td>JDK 8 åŠä»¥å‰é»˜è®¤ GC</td>\n</tr>\n<tr>\n<td><strong>è°ƒä¼˜å¤æ‚åº¦</strong></td>\n<td>ä½ï¼Œå¤§å¤šæ•°å‚æ•°å¯çœç•¥</td>\n<td>ä¸­ï¼Œéœ€è¦è®¾ç½®ç›®æ ‡åœé¡¿æ—¶é—´ç­‰</td>\n<td>é«˜ï¼Œéœ€è¦ç²¾ç»†é…ç½® Eden/Survivor ç­‰æ¯”ä¾‹</td>\n</tr>\n<tr>\n<td><strong>GC æ—¥å¿—é…ç½®æ–¹å¼</strong></td>\n<td>ç»Ÿä¸€æ—¥å¿—æ ¼å¼ï¼š<code>-Xlog:gc*</code>ï¼ˆJDK 9+ï¼‰</td>\n<td>æ”¯æŒä¼ ç»Ÿçš„ <code>-XX:+PrintGCDetails</code> å’Œ <code>-Xlog:gc*</code> æ—¥å¿—è¾“å‡º</td>\n<td>ä¸»è¦ä½¿ç”¨æ—§å‚æ•°ï¼š<code>-XX:+PrintGCDetails</code> ç­‰</td>\n</tr>\n</tbody>\n</table>\n<div class=\"tips\">\n<p><em><strong>ZGC ååèƒ½åŠ›è¾ƒå¼±çš„åŸå› </strong></em></p>\n<table>\n<thead>\n<tr>\n<th>åŸå› </th>\n<th>è§£é‡Š</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>1. å¹¶å‘é˜¶æ®µä»£ä»·è¾ƒé«˜</strong></td>\n<td>ZGC å‡ ä¹æ‰€æœ‰çš„ GC å·¥ä½œï¼ˆåŒ…æ‹¬æ ‡è®°ã€æ•´ç†ã€å¼•ç”¨å¤„ç†ã€è½¬ç§»å¯¹è±¡ï¼‰éƒ½åœ¨ä¸åº”ç”¨çº¿ç¨‹å¹¶å‘æ‰§è¡Œã€‚è™½ç„¶å‡å°‘äº†åœé¡¿ï¼Œä½†è¿™äº› GC çº¿ç¨‹ä¸ä¸šåŠ¡çº¿ç¨‹å…±äº« CPU èµ„æºï¼Œ<strong>å¢åŠ äº† CPU ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œç¼“å­˜ç«äº‰</strong>ï¼Œä»è€Œå½±å“ä¸šåŠ¡çº¿ç¨‹çš„æ‰§è¡Œæ•ˆç‡ã€‚</td>\n</tr>\n<tr>\n<td><strong>2. è¯»å±éšœå¼€é”€</strong></td>\n<td>ZGC ä¾èµ–<strong>ç€è‰²æŒ‡é’ˆå’Œè¯»å±éšœï¼ˆload barrierï¼‰æœºåˆ¶</strong>æ¥è·Ÿè¸ªå¯¹è±¡å¼•ç”¨çŠ¶æ€ï¼Œæ”¯æŒå¹¶å‘è½¬ç§»ã€‚è™½ç„¶éå¸¸é«˜æ•ˆï¼Œä½†ä»æ¯”ä¼ ç»Ÿ GC çš„æ™®é€šè¯»å†™è·¯å¾„æ…¢ä¸€äº›ï¼Œåœ¨é«˜é¢‘è®¿é—®å¯¹è±¡åœºæ™¯ä¸‹ä¼šå¸¦æ¥ä¸€å®š CPU å¼€é”€ã€‚</td>\n</tr>\n<tr>\n<td><strong>3. å¯¹ç¡¬ä»¶ä¾èµ–é«˜ï¼Œè°ƒåº¦ä¿å®ˆ</strong></td>\n<td>ä¸ºäº†å®ç°â€œ&lt;1ms åœé¡¿â€çš„ç›®æ ‡ï¼ŒZGC ä¼šé€‰æ‹©æ›´ä¿å®ˆçš„è°ƒåº¦ç­–ç•¥ï¼ˆå¦‚é¿å…å¹¶å‘çº¿ç¨‹ä½¿ç”¨è¿‡å¤š CPUï¼‰ï¼Œè€Œä¸ä¼šåƒ Parallel GC é‚£æ ·â€œæ¦¨å¹²â€æ‰€æœ‰æ ¸å¿ƒèµ„æºã€‚</td>\n</tr>\n<tr>\n<td><strong>4. å†…å­˜å¼€é”€æ›´é«˜</strong></td>\n<td>ä¸ºäº†æ”¯æŒå¹¶å‘å‹ç¼©å’Œè½¬ç§»ï¼ŒZGC é€šå¸¸éœ€è¦ä¸ºæ¯ä¸ªå¯¹è±¡ä¿ç•™å…ƒæ•°æ®å’Œæ›´å¤šçš„è½¬ç§»ç©ºé—´ï¼ˆå³â€œæµ®åŠ¨åƒåœ¾â€åŒºåŸŸï¼‰ï¼Œè¿™å¯èƒ½å¯¼è‡´<strong>é¢‘ç¹çš„ GC å‘¨æœŸ</strong>ï¼Œå½±å“ååã€‚</td>\n</tr>\n<tr>\n<td><strong>5. è®¾è®¡ç›®æ ‡éååä¼˜å…ˆ</strong></td>\n<td>ZGC çš„é¦–è¦ç›®æ ‡æ˜¯<strong>ä½å»¶è¿Ÿè€Œéæœ€å¤§åå</strong>ã€‚ä¸ Parallel GCï¼ˆä»¥ååä¸ºæ ¸å¿ƒï¼‰è®¾è®¡ç›®æ ‡ä¸åŒï¼ŒZGC æ›´é€‚åˆåœºæ™¯ä¸ºâ€œå¯¹å»¶è¿Ÿæ•æ„Ÿä½†ååå¯æ¥å—â€çš„ç³»ç»Ÿã€‚</td>\n</tr>\n</tbody>\n</table>\n<p>æœ€ç³Ÿç³•çš„æƒ…å†µä¸‹ååé‡ä¼šé™ä½15%ã€‚è¿™éƒ½ä¸æ˜¯äº‹ï¼Œåœé¡¿æ—¶é—´è¶³å¤Ÿä¼˜ç§€ã€‚è‡³äºååé‡ï¼Œé€šè¿‡æ‰©å®¹åˆ†åˆ†é’Ÿè§£å†³ã€‚<br>\nå¦å¤–ï¼ŒOracleå®˜æ–¹æåˆ°äº†å®ƒæœ€å¤§çš„ä¼˜ç‚¹æ˜¯ï¼šå®ƒçš„åœé¡¿æ—¶é—´ä¸ä¼šéšç€å †çš„å¢å¤§è€Œå¢é•¿ï¼<br>\nä¹Ÿå°±æ˜¯è¯´ï¼Œå‡ åGå †çš„åœé¡¿æ—¶é—´æ˜¯10msä»¥ä¸‹ï¼Œå‡ ç™¾Gç”šè‡³ä¸ŠTå †çš„åœé¡¿æ—¶é—´ä¹Ÿæ˜¯10msä»¥ä¸‹ã€‚</p>\n<p>ZGC ååå¼±ï¼Œä¸æ˜¯å› ä¸ºæŠ€æœ¯è½åï¼Œè€Œæ˜¯å› ä¸ºå®ƒä¸»åŠ¨é€‰æ‹©åœ¨ä½å»¶è¿Ÿå’Œé«˜ååä¹‹é—´åå‘äº†ä½å»¶è¿Ÿã€‚<br>\nåœ¨å¯¹å“åº”æ—¶é—´è¦æ±‚æé«˜çš„ç³»ç»Ÿä¸­ï¼Œå®ƒæ˜¯éå¸¸åˆé€‚çš„é€‰æ‹©ã€‚<br>\nä½†å¦‚æœä½ çš„ç›®æ ‡æ˜¯å‹æ¦¨æœºå™¨æ€§èƒ½è·‘æ‰¹å¤„ç†ã€æ—¥å¿—åˆ†æè¿™ç±»ååå¯¼å‘å‹ä»»åŠ¡ï¼ŒParallel GC æˆ– G1 ä¼šæ›´åˆé€‚ã€‚</p>\n</div>\n<h2 id=\"å†…å­˜æº¢å‡º-OutOfMemoryErrorï¼Œç®€ç§°-OOM\">å†…å­˜æº¢å‡º(OutOfMemoryErrorï¼Œç®€ç§° OOM)</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>JVM å¸¸è§å†…å­˜æº¢å‡ºç±»å‹æ±‡æ€»è¡¨</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>æº¢å‡ºç±»å‹</th>\n<th>å¼‚å¸¸ä¿¡æ¯</th>\n<th>è§¦å‘åŸå› /æè¿°</th>\n<th>ç›¸å…³å‚æ•°å’Œå»ºè®®é…ç½®</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>å †å†…å­˜æº¢å‡º</strong></td>\n<td><code>java.lang.OutOfMemoryError: Java heap space</code></td>\n<td>- åˆ›å»ºå¤§é‡å¯¹è±¡ï¼Œå †ç©ºé—´ä¸è¶³<br>- å†…å­˜æ³„æ¼ï¼šå¯¹è±¡ä¸å†ä½¿ç”¨å´æœ‰å¼ºå¼•ç”¨<br>- è€å¹´ä»£å¯¹è±¡å¤ªå¤šæ— æ³•æ™‹å‡</td>\n<td><code>-Xms</code> / <code>-Xmx</code> è®¾ç½®å †å¤§å°</td>\n</tr>\n<tr>\n<td><strong>æ ˆæº¢å‡ºï¼ˆé€’å½’ï¼‰</strong></td>\n<td><code>java.lang.StackOverflowError</code></td>\n<td>- æ–¹æ³•æ— é™é€’å½’æˆ–é€’å½’å±‚çº§å¤ªæ·±</td>\n<td><code>-Xss</code> è®¾ç½®çº¿ç¨‹æ ˆå¤§å°</td>\n</tr>\n<tr>\n<td><strong>æ— æ³•åˆ›å»ºæ–°çº¿ç¨‹</strong></td>\n<td><code>java.lang.OutOfMemoryError: unable to create new native thread</code></td>\n<td>- åˆ›å»ºçº¿ç¨‹è¿‡å¤šï¼ˆå¦‚çº¿ç¨‹æ± é…ç½®è¿‡å¤§ï¼‰<br>- ç³»ç»Ÿæˆ– JVM native çº¿ç¨‹èµ„æºè€—å°½</td>\n<td>æ§åˆ¶çº¿ç¨‹æ± å¤§å°ï¼Œé¿å…æ— é™æ–°å»ºçº¿ç¨‹</td>\n</tr>\n<tr>\n<td><strong>å…ƒç©ºé—´æº¢å‡º</strong></td>\n<td><code>java.lang.OutOfMemoryError: Metaspace</code></td>\n<td>- åŠ¨æ€åŠ è½½ç±»è¿‡å¤šï¼ˆå¦‚ä½¿ç”¨ CGLIBã€JSP åŠ¨æ€ç”Ÿæˆç±»ï¼‰<br>- ç±»æ— æ³•å¸è½½ï¼ˆå¦‚ ClassLoader æ³„æ¼ï¼‰</td>\n<td><code>-XX:MetaspaceSize</code> / <code>-XX:MaxMetaspaceSize</code></td>\n</tr>\n<tr>\n<td><strong>ç›´æ¥å†…å­˜æº¢å‡º</strong></td>\n<td><code>java.lang.OutOfMemoryError: Direct buffer memory</code></td>\n<td>- ä½¿ç”¨ <code>ByteBuffer.allocateDirect()</code> åˆ†é…å¤§é‡ç›´æ¥å†…å­˜<br>- Netty ç­‰æ¡†æ¶é»˜è®¤ä½¿ç”¨ç›´æ¥å†…å­˜</td>\n<td><code>-XX:MaxDirectMemorySize</code></td>\n</tr>\n<tr>\n<td><strong>GC å¼€é”€è¿‡é«˜</strong></td>\n<td><code>java.lang.OutOfMemoryError: GC overhead limit exceeded</code></td>\n<td>- JVM èŠ±è´¹ &gt;98% çš„æ—¶é—´ GC ä½†å›æ”¶ &lt;2% çš„å†…å­˜ï¼Œè®¤ä¸ºè¿›å…¥â€œGC æ­»å¾ªç¯â€</td>\n<td>åˆ†æ GC æ—¥å¿—ã€ä¼˜åŒ–å †è®¾ç½®</td>\n</tr>\n<tr>\n<td><strong>ç±»å¸è½½å¤±è´¥ï¼ˆå†…å­˜æ³„æ¼ï¼‰</strong></td>\n<td>ï¼ˆä¸ä¸€å®šæŠ¥é”™ï¼Œä½†å¯èƒ½å¯¼è‡´ Metaspace OOMï¼‰</td>\n<td>- Web å®¹å™¨é¢‘ç¹éƒ¨ç½²çƒ­æ›´æ–° WAR åŒ…æ—¶ï¼ŒClassLoader æ— æ³•å¸è½½ï¼Œå¯¼è‡´ç±»æ°¸ä¹…é©»ç•™</td>\n<td>ä¼˜åŒ– ClassLoader ç®¡ç†ï¼Œä½¿ç”¨å†…å­˜åˆ†æå·¥å…·</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å †å¿«ç…§(å †è½¬å‚¨)æ–‡ä»¶åˆ†æ</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>å‚æ•°</th>\n<th>è¯´æ˜</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>-XX:+HeapDumpOnOutOfMemoryError</code></td>\n<td>OOM æ—¶ç”Ÿæˆå †è½¬å‚¨æ–‡ä»¶ ,å»ºè®®ç”Ÿäº§ç¯å¢ƒå¼€å¯</td>\n</tr>\n<tr>\n<td><code>-XX:HeapDumpPath=xxx.hprof</code></td>\n<td>æŒ‡å®šå †è½¬å‚¨æ–‡ä»¶ä¿å­˜è·¯å¾„ <br> é»˜è®¤ä¿å­˜åœ¨å½“å‰ç›®å½•</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å¸¸ç”¨åˆ†æå·¥å…·ä¸å‘½ä»¤</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>å·¥å…·/å‘½ä»¤</th>\n<th>ç®€ä»‹ä¸åŠŸèƒ½</th>\n<th>ä½¿ç”¨è¯´æ˜</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>MATï¼ˆMemory Analyzer Toolï¼‰</strong></td>\n<td>Eclipse å‡ºå“çš„å¼ºå¤§å›¾å½¢å·¥å…·ï¼Œæ”¯æŒæ³„æ¼åˆ†æã€å¯¹è±¡å¼•ç”¨é“¾åˆ†æã€å†…å­˜å ç”¨ç»Ÿè®¡ç­‰</td>\n<td>ä¸‹è½½åœ°å€ï¼š<br><a href=\"https://www.eclipse.org/mat/\">https://www.eclipse.org/mat/</a><br>æ‰“å¼€åç›´æ¥å¯¼å…¥ <code>.hprof</code> æ–‡ä»¶å³å¯åˆ†æ</td>\n</tr>\n<tr>\n<td><strong>VisualVM</strong></td>\n<td>å®˜æ–¹å¯è§†åŒ– JVM ç›‘æ§å·¥å…·ï¼Œæ”¯æŒå®æ—¶åˆ†æã€GC æŸ¥çœ‹ã€çº¿ç¨‹çŠ¶æ€ä¸å †è½¬å‚¨æŸ¥çœ‹</td>\n<td>é™„å¸¦äº JDKï¼ˆæˆ–å•ç‹¬å®‰è£…ï¼‰ï¼Œæ‰“å¼€ <code>.hprof</code> æ–‡ä»¶è¿›è¡Œå¯è§†åŒ–åˆ†æ</td>\n</tr>\n<tr>\n<td><strong>JProfiler</strong></td>\n<td>å•†ä¸šçº§ Java æ€§èƒ½åˆ†æå·¥å…·ï¼Œæä¾›å †åˆ†æã€CPU åˆ†æã€çº¿ç¨‹åˆ†æç­‰å…¨å¥—åŠŸèƒ½</td>\n<td>æ”¯æŒæ‰“å¼€ <code>.hprof</code> æ–‡ä»¶ï¼Œä¹Ÿå¯åœ¨è¿è¡Œæ—¶é…åˆä½¿ç”¨ï¼ˆéœ€ä»˜è´¹æˆ–è¯•ç”¨ï¼‰</td>\n</tr>\n<tr>\n<td><strong>YourKit</strong></td>\n<td>å•†ä¸šæ€§èƒ½åˆ†æå·¥å…·ï¼Œç•Œé¢å‹å¥½ï¼Œæ”¯æŒä¸°å¯Œçš„åˆ†æåŠŸèƒ½</td>\n<td>æ”¯æŒå †åˆ†æï¼Œé€‚åˆå†…å­˜æ³„æ¼æ’æŸ¥</td>\n</tr>\n<tr>\n<td><strong>jhat</strong>ï¼ˆè¿‡æ—¶ï¼‰</td>\n<td>JDK é™„å¸¦çš„æ—§å·¥å…·ï¼Œç”¨äºåˆ†æ <code>.hprof</code> æ–‡ä»¶ï¼Œå¼€å¯ Web ç•Œé¢æŸ¥çœ‹ï¼ˆå·²åºŸå¼ƒï¼‰</td>\n<td>å‘½ä»¤ï¼š<code>jhat heapdump.hprof</code>ï¼Œæµè§ˆå™¨è®¿é—® <code>http://localhost:7000</code>ï¼ˆJDK 8 åŠä»¥ä¸‹ï¼‰</td>\n</tr>\n<tr>\n<td><strong>jmap</strong></td>\n<td>ç”¨äºç”Ÿæˆå †è½¬å‚¨æ–‡ä»¶æˆ–æŸ¥çœ‹å †å¯¹è±¡ç»Ÿè®¡ä¿¡æ¯ï¼ˆ<strong>ä¸æ˜¯åˆ†æå·¥å…·æœ¬èº«</strong>ï¼‰</td>\n<td>å‘½ä»¤ï¼š<code>jmap -dump:format=b,file=heap.hprof &lt;pid&gt;</code> ç”Ÿæˆè½¬å‚¨ï¼›é…åˆ MAT ä½¿ç”¨</td>\n</tr>\n<tr>\n<td><strong>jcmd</strong></td>\n<td>æ›´ç°ä»£çš„è¯Šæ–­å‘½ä»¤å·¥å…·ï¼Œå¯ç”Ÿæˆ heap dumpã€æ‰§è¡Œ GCã€æ‰“å° VM çŠ¶æ€ç­‰</td>\n<td>å‘½ä»¤ï¼š<code>jcmd &lt;pid&gt; GC.heap_dump heap.hprof</code></td>\n</tr>\n<tr>\n<td><strong><a href=\"http://GCEasy.io\">GCEasy.io</a></strong></td>\n<td>åœ¨çº¿åˆ†æå·¥å…·ï¼Œæ”¯æŒ <code>.hprof</code> æ–‡ä»¶å’Œ GC æ—¥å¿—ä¸Šä¼ åˆ†æ</td>\n<td>ç½‘ç«™ï¼š<a href=\"https://gceasy.io\">https://gceasy.io</a></td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>GCæ—¥å¿—ç›¸å…³å‚æ•°(JDK1.8åŠä»¥ä¸‹)</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>å‚æ•°</th>\n<th>è¯´æ˜</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>-XX:+PrintGC</code></td>\n<td>æ‰“å°åŸºæœ¬ GC ä¿¡æ¯ï¼ˆå»ºè®®é…åˆ <code>-XX:+PrintGCDetails</code> ä½¿ç”¨ï¼‰,ä¸<code>-verbose:gc</code>ç­‰ä»·</td>\n</tr>\n<tr>\n<td><code>-XX:+PrintGCDetails</code></td>\n<td>æ‰“å°è¯¦ç»†çš„ GC æ—¥å¿—ä¿¡æ¯ï¼ˆå¦‚å„åŒºåŸŸä½¿ç”¨æƒ…å†µã€å¯¹è±¡åˆ†é…ã€æ™‹å‡ç­‰ï¼‰</td>\n</tr>\n<tr>\n<td><code>-XX:+PrintGCDateStamps</code></td>\n<td>åœ¨ GC æ—¥å¿—ä¸­æ·»åŠ æ—¥æœŸæ—¶é—´æˆ³</td>\n</tr>\n<tr>\n<td><code>-XX:+PrintGCTimeStamps</code></td>\n<td>åœ¨ GC æ—¥å¿—ä¸­æ·»åŠ  JVM å¯åŠ¨ä»¥æ¥çš„æ—¶é—´æˆ³</td>\n</tr>\n<tr>\n<td><code>-Xloggc:/var/log/myapp/gc.log</code></td>\n<td>å°† GC æ—¥å¿—è¾“å‡ºåˆ°æŒ‡å®šæ–‡ä»¶</td>\n</tr>\n<tr>\n<td><code>-XX:+UseGCLogFileRotation</code></td>\n<td>å¯ç”¨ GC æ—¥å¿—æ–‡ä»¶è½®è½¬ï¼ˆé€‚ç”¨äºå¤§è§„æ¨¡ç³»ç»Ÿçš„ GC æ—¥å¿—ç®¡ç†ï¼‰</td>\n</tr>\n<tr>\n<td><code>-XX:NumberOfGCLogFiles=5</code></td>\n<td>æœ€å¤šä¿ç•™ 5 ä¸ª GC æ—¥å¿—å†å²æ–‡ä»¶</td>\n</tr>\n<tr>\n<td><code>-XX:GCLogFileSize=10M</code></td>\n<td>æ¯ä¸ª GC æ—¥å¿—æ–‡ä»¶æœ€å¤§ä¸º 10MB</td>\n</tr>\n<tr>\n<td><code>-XX:+PrintGCCause</code></td>\n<td>æ‰“å° GC çš„è§¦å‘åŸå› ï¼ˆå¦‚ Minor GCã€System.gc() ç­‰ï¼‰</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>GCæ—¥å¿—ç›¸å…³å‚æ•°(JDK9+)</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\"><code>-Xlog</code> æ˜¯ç”¨äºé…ç½® JVM æ—¥å¿—è®°å½•çš„å‚æ•°ï¼Œå®ƒæ˜¯ä» JDK 9 å¼€å§‹å¼•å…¥çš„ç»Ÿä¸€æ—¥å¿—æ¡†æ¶ï¼ˆUnified Loggingï¼‰çš„ä¸€éƒ¨åˆ†ã€‚</li>\n<li class=\"lvl-6\">é€šè¿‡ -Xlog é€‰é¡¹ï¼Œä½ å¯ä»¥æ§åˆ¶æ—¥å¿—çš„ æ ‡ç­¾ï¼ˆtagsï¼‰ã€è¾“å‡ºçº§åˆ«ï¼ˆlevelï¼‰ã€è¾“å‡ºä½ç½®ï¼ˆoutputï¼‰ ç­‰å†…å®¹ã€‚</li>\n<li class=\"lvl-6\">åŸºæœ¬æ ¼å¼</li>\n</ul>\n  <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-Xlog[:[tag1[,tag2...]][[:level][:[output][:[decorators][:rotation]]]]]</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">å¸¸è§ Tagsï¼ˆæ ‡ç­¾ï¼‰</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>ç±»åˆ«</th>\n<th>æ ‡ç­¾</th>\n<th>å«ä¹‰</th>\n<th>ç”¨é€”ç¤ºä¾‹</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>ç±»åŠ è½½</strong></td>\n<td><code>classload</code></td>\n<td>JVM ç±»åŠ è½½æ´»åŠ¨çš„æ€»ä½“ä¿¡æ¯</td>\n<td>è§‚å¯Ÿç±»åŠ è½½å¤±è´¥æˆ–é‡å¤åŠ è½½</td>\n</tr>\n<tr>\n<td></td>\n<td><code>class+load</code></td>\n<td>æ˜¾ç¤ºæ¯ä¸ªç±»åŠ è½½è¿‡ç¨‹ç»†èŠ‚</td>\n<td>å®šä½ç±»åŠ è½½å¼‚å¸¸ã€çƒ­åŠ è½½åˆ†æ</td>\n</tr>\n<tr>\n<td></td>\n<td><code>class+unload</code></td>\n<td>è®°å½•ç±»å¸è½½äº‹ä»¶</td>\n<td>åˆ†æç±»å¸è½½æ—¶æœºæˆ–å†…å­˜é‡Šæ”¾æƒ…å†µ</td>\n</tr>\n<tr>\n<td><strong>åƒåœ¾å›æ”¶</strong></td>\n<td><code>gc</code></td>\n<td>æ€»ä½“ GC æ´»åŠ¨ä¿¡æ¯</td>\n<td>GC è°ƒä¼˜å…¥é—¨ä½¿ç”¨</td>\n</tr>\n<tr>\n<td></td>\n<td><code>gc+start</code></td>\n<td>GC äº‹ä»¶å¼€å§‹æ—¶é—´ä¸ç±»å‹</td>\n<td>æŸ¥çœ‹ GC é¢‘ç‡ä¸è§¦å‘ç‚¹</td>\n</tr>\n<tr>\n<td></td>\n<td><code>gc+heap</code></td>\n<td>GC å‰åçš„å †ä½¿ç”¨æƒ…å†µ</td>\n<td>åˆ†æå †ä½¿ç”¨ä¸åˆ†åŒºå æ¯”</td>\n</tr>\n<tr>\n<td></td>\n<td><code>gc+phases</code></td>\n<td>GC å†…éƒ¨é˜¶æ®µç»†èŠ‚</td>\n<td>G1/ZGC ç­‰è°ƒè¯•ç”¨</td>\n</tr>\n<tr>\n<td></td>\n<td><code>gc+age</code></td>\n<td>å¹´é¾„åˆ†å¸ƒæƒ…å†µ</td>\n<td>åˆ¤æ–­å¯¹è±¡æ™‹å‡è·¯å¾„ã€è€å¹´ä»£å‹åŠ›</td>\n</tr>\n<tr>\n<td></td>\n<td><code>gc+ergo</code></td>\n<td>GC çš„è‡ªé€‚åº”è°ƒæ•´å†³ç­–</td>\n<td>æŸ¥çœ‹çº¿ç¨‹ã€å †å¤§å°è‡ªåŠ¨è°ƒæ•´é€»è¾‘</td>\n</tr>\n<tr>\n<td><strong>JIT ç¼–è¯‘</strong></td>\n<td><code>jit</code></td>\n<td>JIT ç¼–è¯‘æ—¥å¿—å…¥å£</td>\n<td>æ€§èƒ½çƒ­ç‚¹æ–¹æ³•åˆ†æ</td>\n</tr>\n<tr>\n<td></td>\n<td><code>compiler</code></td>\n<td>æ˜¾ç¤ºæ–¹æ³•ç¼–è¯‘ã€æ—¶é—´ç­‰</td>\n<td>åˆ¤æ–­æ˜¯å¦æœ‰æ–¹æ³•æœªè¢«ä¼˜åŒ–</td>\n</tr>\n<tr>\n<td></td>\n<td><code>codecache</code></td>\n<td>å·²ç¼–è¯‘ä»£ç å­˜å‚¨åŒºä½¿ç”¨æƒ…å†µ</td>\n<td>åˆ¤æ–­æ˜¯å¦è¾¾åˆ°ç¼“å­˜ä¸Šé™</td>\n</tr>\n<tr>\n<td></td>\n<td><code>nmethod</code></td>\n<td>JIT ç”Ÿæˆçš„ native æ–¹æ³•ç”Ÿå‘½å‘¨æœŸ</td>\n<td>è§‚å¯Ÿ native ä»£ç ç”Ÿæˆä¸å¸è½½</td>\n</tr>\n<tr>\n<td><strong>å†…å­˜</strong></td>\n<td><code>memory</code></td>\n<td>æ€»ä½“å†…å­˜ä½¿ç”¨æƒ…å†µ</td>\n<td>è¯Šæ–­å†…å­˜æ³„æ¼æˆ–æº¢å‡º</td>\n</tr>\n<tr>\n<td></td>\n<td><code>gc+heap</code></td>\n<td>å †ç»“æ„ä¸å ç”¨æƒ…å†µ</td>\n<td>ä¸ GC è”åˆåˆ†æä½¿ç”¨</td>\n</tr>\n<tr>\n<td></td>\n<td><code>os+memory</code></td>\n<td>JVM ä¸æ“ä½œç³»ç»Ÿé—´çš„å†…å­˜äº¤äº’</td>\n<td>åˆ¤æ–­æ˜¯å¦ç³»ç»Ÿå±‚å†…å­˜ç”³è¯·å¤±è´¥</td>\n</tr>\n<tr>\n<td><strong>çº¿ç¨‹</strong></td>\n<td><code>thread</code></td>\n<td>çº¿ç¨‹çš„åˆ›å»ºã€ç»ˆæ­¢ã€çŠ¶æ€å˜åŒ–</td>\n<td>çº¿ç¨‹æ³„æ¼æˆ–é¢‘ç¹åˆ›å»ºæ’æŸ¥</td>\n</tr>\n<tr>\n<td></td>\n<td><code>safepoint</code></td>\n<td>JVM è¿›å…¥/é€€å‡º safepoint çš„ä¿¡æ¯</td>\n<td>åˆ†æ STW åœé¡¿æ—¶é—´ä¸é¢‘ç‡</td>\n</tr>\n<tr>\n<td><strong>é”ä¸åŒæ­¥</strong></td>\n<td><code>synchronization</code></td>\n<td>é”ç«äº‰ã€è·å–å’Œé‡Šæ”¾ä¿¡æ¯</td>\n<td>åˆ†ææ€§èƒ½ç“¶é¢ˆä¸­çš„é”äº‰ç”¨</td>\n</tr>\n<tr>\n<td></td>\n<td><code>monitorinflation</code></td>\n<td>è½»é‡çº§é”å‡çº§ä¸ºé‡é‡çº§é”è¿‡ç¨‹</td>\n<td>æ’æŸ¥é”è†¨èƒ€å¯¼è‡´çš„å»¶è¿Ÿé—®é¢˜</td>\n</tr>\n<tr>\n<td><strong>æ“ä½œç³»ç»Ÿäº¤äº’</strong></td>\n<td><code>os</code></td>\n<td>JVM ä¸æ“ä½œç³»ç»Ÿäº¤äº’æ—¥å¿—</td>\n<td>å¸¸è§„ç³»ç»Ÿèµ„æºè¯·æ±‚ä¿¡æ¯</td>\n</tr>\n<tr>\n<td></td>\n<td><code>os+thread</code></td>\n<td>OS å±‚çº§çº¿ç¨‹ç®¡ç†ä¿¡æ¯</td>\n<td>é«˜å¹¶å‘æ—¶çº¿ç¨‹ç»‘å®šä¸è°ƒåº¦åˆ†æ</td>\n</tr>\n<tr>\n<td></td>\n<td><code>os+cpu</code></td>\n<td>CPU ä½¿ç”¨ä¸åˆ†å¸ƒæƒ…å†µ</td>\n<td>æ’æŸ¥é«˜ CPU ä½¿ç”¨çš„é—®é¢˜</td>\n</tr>\n<tr>\n<td><strong>ç±»å…ƒæ•°æ®</strong></td>\n<td><code>metaspace</code></td>\n<td>å…ƒç©ºé—´å†…å­˜ä½¿ç”¨ä¸å˜åŒ–</td>\n<td>æ’æŸ¥ Metaspace OOM</td>\n</tr>\n<tr>\n<td></td>\n<td><code>cds</code></td>\n<td>ç±»å…±äº«æ•°æ®ï¼ˆCDSï¼‰æ—¥å¿—</td>\n<td>åˆ†æç±»åŠ è½½åŠ é€Ÿæ˜¯å¦ç”Ÿæ•ˆ</td>\n</tr>\n<tr>\n<td><strong>å®‰å…¨</strong></td>\n<td><code>security</code></td>\n<td>å®‰å…¨ç›¸å…³æ“ä½œæ—¥å¿—</td>\n<td>æƒé™æ£€æŸ¥å¤±è´¥ã€å¯†é’¥åŠ è½½ç­‰è°ƒè¯•</td>\n</tr>\n<tr>\n<td></td>\n<td><code>module</code></td>\n<td>æ¨¡å—ç³»ç»Ÿï¼ˆJPMSï¼‰ç›¸å…³æ—¥å¿—</td>\n<td>æ¨¡å—è®¿é—®æ§åˆ¶å¤±è´¥åˆ†æ</td>\n</tr>\n<tr>\n<td><strong>å…¶ä»–</strong></td>\n<td><code>start</code></td>\n<td>JVM å¯åŠ¨æµç¨‹æ—¥å¿—</td>\n<td>å¯åŠ¨é˜¶æ®µæ…¢ã€å‡ºé”™æ—¶ä½¿ç”¨</td>\n</tr>\n<tr>\n<td></td>\n<td><code>init</code></td>\n<td>å„å­ç³»ç»Ÿåˆå§‹åŒ–è¿‡ç¨‹</td>\n<td>å®šä½å­ç³»ç»Ÿå¯åŠ¨é¡ºåºä¸å¼‚å¸¸</td>\n</tr>\n<tr>\n<td></td>\n<td><code>jni</code></td>\n<td>Java è°ƒç”¨ native æ–¹æ³•æ—¥å¿—</td>\n<td>JNI å´©æºƒã€æ€§èƒ½é—®é¢˜åˆ†æ</td>\n</tr>\n<tr>\n<td></td>\n<td><code>classpath</code></td>\n<td>ç±»è·¯å¾„åŠ è½½è¯¦æƒ…</td>\n<td>ç±»æ‰¾ä¸åˆ°ã€è·¯å¾„å†²çªç­‰é—®é¢˜æ’æŸ¥</td>\n</tr>\n<tr>\n<td></td>\n<td><code>exceptions</code></td>\n<td>å¼‚å¸¸ä¿¡æ¯åŠå †æ ˆæ‰“å°</td>\n<td>æ•è·æœªå¤„ç†å¼‚å¸¸ã€é¢‘ç¹æŠ›é”™åˆ†æ</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">\n<p>Levelï¼ˆçº§åˆ«ï¼‰</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>ç­‰çº§</th>\n<th>å«ä¹‰è¯´æ˜</th>\n<th>ç”¨é€”ç¤ºä¾‹</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>off</code></td>\n<td>å…³é—­æ—¥å¿—è®°å½•</td>\n<td>å®Œå…¨ç¦ç”¨æŒ‡å®šæ ‡ç­¾çš„æ—¥å¿—è¾“å‡º</td>\n</tr>\n<tr>\n<td><code>error</code></td>\n<td>ä¸¥é‡é”™è¯¯ï¼Œä»…è®°å½•å½±å“ç³»ç»Ÿè¿è¡Œçš„é”™è¯¯ä¿¡æ¯</td>\n<td>æ•è·å´©æºƒã€ä¸¥é‡æ•…éšœ</td>\n</tr>\n<tr>\n<td><code>warning</code></td>\n<td>æ½œåœ¨é—®é¢˜ï¼Œå¯èƒ½å½±å“ç¨³å®šæ€§</td>\n<td>è®°å½•å¯èƒ½çš„å†…å­˜ã€é…ç½®é—®é¢˜</td>\n</tr>\n<tr>\n<td><code>info</code></td>\n<td>å¸¸è§„ä¿¡æ¯ï¼ˆé»˜è®¤çº§åˆ«ï¼‰</td>\n<td>æ—¥å¸¸è¿è¡Œæ—¥å¿—ï¼Œå¦‚ GC æ¬¡æ•°</td>\n</tr>\n<tr>\n<td><code>debug</code></td>\n<td>æ›´è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯ï¼Œé€‚ç”¨äºé—®é¢˜è¯Šæ–­</td>\n<td>è·Ÿè¸ªè¡Œä¸ºå˜åŒ–æˆ–ä»£ç è·¯å¾„</td>\n</tr>\n<tr>\n<td><code>trace</code></td>\n<td>æœ€è¯¦ç»†çš„ä¿¡æ¯ï¼Œè®°å½•å‡ ä¹æ‰€æœ‰ç»†èŠ‚</td>\n<td>æ·±åº¦è°ƒè¯•ï¼Œå¦‚æ–¹æ³•çº§åˆ«è·Ÿè¸ª</td>\n</tr>\n<tr>\n<td><code>all</code></td>\n<td>æ‰“å°æ‰€æœ‰çº§åˆ«çš„æ—¥å¿—ï¼ˆåŒ…æ‹¬ trace åŠä»¥ä¸Šï¼‰</td>\n<td>å…¨é‡æ—¥å¿—è¾“å‡ºï¼Œç”¨äºå®Œå…¨ç›‘æ§</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">\n<p>Outputï¼ˆè¾“å‡ºä½ç½®ï¼‰</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>è¾“å‡ºä½ç½®</th>\n<th>å«ä¹‰è¯´æ˜</th>\n<th>ç¤ºä¾‹ç”¨æ³•</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>stdout</code></td>\n<td>æ ‡å‡†è¾“å‡ºï¼ˆé»˜è®¤ï¼‰</td>\n<td><code>-Xlog:gc=info:stdout</code></td>\n</tr>\n<tr>\n<td><code>stderr</code></td>\n<td>æ ‡å‡†é”™è¯¯è¾“å‡º</td>\n<td><code>-Xlog:gc=info:stderr</code></td>\n</tr>\n<tr>\n<td><code>file=è·¯å¾„</code></td>\n<td>è¾“å‡ºåˆ°æŒ‡å®šæ–‡ä»¶è·¯å¾„ï¼ˆè‡ªåŠ¨åˆ›å»ºæ–‡ä»¶ï¼‰</td>\n<td><code>-Xlog:gc:file=gc.log</code></td>\n</tr>\n<tr>\n<td>å¤šä¸ªè¾“å‡ºç”¨é€—å·åˆ†éš”</td>\n<td>å¯åŒæ—¶è¾“å‡ºåˆ°å¤šä¸ªä½ç½®</td>\n<td><code>-Xlog:gc:file=gc.log,stdout</code></td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">\n<p>Decoratorsï¼ˆè£…é¥°å™¨ï¼‰</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>è£…é¥°å™¨</th>\n<th>å«ä¹‰è¯´æ˜</th>\n<th>ç¤ºä¾‹è¾“å‡ºç‰‡æ®µï¼ˆå«è¯¥è£…é¥°å™¨æ—¶ï¼‰</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>time</code></td>\n<td>æ˜¾ç¤ºå½“å‰ç³»ç»Ÿæ—¶é—´ï¼ˆwall-clock timeï¼‰</td>\n<td><code>2025-05-16T10:45:12.123+0800</code></td>\n</tr>\n<tr>\n<td><code>uptime</code></td>\n<td>æ˜¾ç¤º JVM å¯åŠ¨ä»¥æ¥çš„è¿è¡Œæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰</td>\n<td><code>5.123s</code>ï¼ˆè¡¨ç¤ºå·²è¿è¡Œ 5.123 ç§’ï¼‰</td>\n</tr>\n<tr>\n<td><code>level</code></td>\n<td>æ˜¾ç¤ºæ—¥å¿—çº§åˆ«ï¼ˆå¦‚ info, warning ç­‰ï¼‰</td>\n<td><code>[info]</code>, <code>[debug]</code></td>\n</tr>\n<tr>\n<td><code>tags</code></td>\n<td>æ˜¾ç¤ºæ—¥å¿—æ ‡ç­¾</td>\n<td><code>[gc]</code>, <code>[class,load]</code></td>\n</tr>\n<tr>\n<td><code>tid</code></td>\n<td>æ˜¾ç¤ºçº¿ç¨‹ ID</td>\n<td><code>tid=0x00007fddc4012800</code></td>\n</tr>\n<tr>\n<td><code>hostname</code></td>\n<td>æ˜¾ç¤ºä¸»æœºå</td>\n<td><code>host=example.local</code></td>\n</tr>\n<tr>\n<td><code>pid</code></td>\n<td>æ˜¾ç¤ºå½“å‰ JVM è¿›ç¨‹ ID</td>\n<td><code>pid=12345</code></td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">\n<p>Rotation (æ—¥å¿—è½®è½¬è®¾ç½®)</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>è®¾ç½®å‚æ•°</th>\n<th>å«ä¹‰è¯´æ˜</th>\n<th>ç¤ºä¾‹å€¼</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>filecount=n</code></td>\n<td>ä¿ç•™çš„æ—¥å¿—æ–‡ä»¶æ•°é‡ï¼ˆæœ€å¤§æ–‡ä»¶è½®è½¬æ•°ï¼‰</td>\n<td><code>filecount=5</code></td>\n</tr>\n<tr>\n<td><code>filesize=n</code></td>\n<td>å•ä¸ªæ—¥å¿—æ–‡ä»¶çš„æœ€å¤§å¤§å°ï¼ˆæ”¯æŒå•ä½ï¼šk/m/gï¼‰</td>\n<td><code>filesize=10m</code></td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">\n<p>ç¤ºä¾‹ï¼š</p>\n</li>\n</ul>\n  <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-Xlog:gc*:file=/var/log/app/gc.log:time,<span class=\"built_in\">uptime</span>,level,tags:filecount=5,filesize=20M</span><br></pre></td></tr></table></figure>\n<table>\n<thead>\n<tr>\n<th>é¡¹</th>\n<th>å€¼</th>\n<th>å«ä¹‰</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>tag</code></td>\n<td><code>gc*</code></td>\n<td>åŒ¹é…æ‰€æœ‰ä»¥ <code>gc</code> å¼€å¤´çš„æ ‡ç­¾ï¼ˆå¦‚ <code>gc+heap</code> ç­‰ï¼‰</td>\n</tr>\n<tr>\n<td><code>level</code></td>\n<td><em>çœç•¥</em></td>\n<td>é»˜è®¤æ˜¯ <code>info</code></td>\n</tr>\n<tr>\n<td><code>output</code></td>\n<td><code>file=/var/log/app/gc.log</code></td>\n<td>æ—¥å¿—å†™å…¥è¯¥æ–‡ä»¶</td>\n</tr>\n<tr>\n<td><code>decorators</code></td>\n<td><code>time,uptime,level,tags</code></td>\n<td>æ—¥å¿—å‰ç¼€åŒ…å«æ—¶é—´ã€å¯åŠ¨æ—¶é—´ã€æ—¥å¿—çº§åˆ«ã€æ ‡ç­¾</td>\n</tr>\n<tr>\n<td><code>rotation</code></td>\n<td><code>filecount=5,filesize=20M</code></td>\n<td>æœ€å¤šä¿ç•™ 5 ä¸ªæ—¥å¿—æ–‡ä»¶ï¼Œå•ä¸ªæ–‡ä»¶æœ€å¤§ 20MB</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">\n<p>æ—¥å¿—æ–‡ä»¶ä¸­å¯ä»¥ä½¿ç”¨å˜é‡</p>\n</li>\n</ul>\n  <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-Xlog:gc*:file=gc_%p_%t.log</span><br></pre></td></tr></table></figure>\n<p><strong>å¸¸ç”¨å˜é‡è¡¨</strong></p>\n<table>\n<thead>\n<tr>\n<th>å˜é‡</th>\n<th>å«ä¹‰</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>%p</td>\n<td>è¿›ç¨‹IDï¼ˆProcess IDï¼‰</td>\n</tr>\n<tr>\n<td>%t</td>\n<td>æ—¶é—´æˆ³ï¼ˆä»£è¡¨æ—¥å¿—æ–‡ä»¶åˆ›å»ºæ—¶çš„æ—¶é—´æˆ³ï¼‰</td>\n</tr>\n<tr>\n<td>%h</td>\n<td>ä¸»æœºåï¼ˆHostnameï¼‰</td>\n</tr>\n<tr>\n<td>%n</td>\n<td>åºåˆ—å·ï¼Œä»0å¼€å§‹ï¼Œæ¯åˆ›å»ºæ–°æ–‡ä»¶åŠ 1</td>\n</tr>\n<tr>\n<td>%u</td>\n<td>å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œç”¨äºè§£å†³æ–‡ä»¶åå†²çª</td>\n</tr>\n<tr>\n<td>%i</td>\n<td>å½“å¤šä¸ªJVMè¿›ç¨‹ä½¿ç”¨ç›¸åŒçš„æ–‡ä»¶åæ¨¡å¼æ—¶çš„åŒºåˆ†è®¡æ•°å™¨</td>\n</tr>\n</tbody>\n</table>\n<p><strong>æ—¶é—´ç›¸å…³å˜é‡è¡¨</strong></p>\n<table>\n<thead>\n<tr>\n<th>å˜é‡</th>\n<th>å«ä¹‰</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>%Y</td>\n<td>å¹´ï¼ˆYearï¼‰</td>\n</tr>\n<tr>\n<td>%m</td>\n<td>æœˆï¼ˆMonthï¼‰</td>\n</tr>\n<tr>\n<td>%d</td>\n<td>æ—¥ï¼ˆDayï¼‰</td>\n</tr>\n<tr>\n<td>%H</td>\n<td>å°æ—¶ï¼ˆHourï¼‰</td>\n</tr>\n<tr>\n<td>%M</td>\n<td>åˆ†é’Ÿï¼ˆMinuteï¼‰</td>\n</tr>\n<tr>\n<td>%S</td>\n<td>ç§’ï¼ˆSecondï¼‰</td>\n</tr>\n</tbody>\n</table>\n  <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># åŸºç¡€é…ç½®</span></span><br><span class=\"line\">-Xlog:gc*:file=gc_%p_%Y%m%d_%H%M%S.<span class=\"built_in\">log</span>:time,<span class=\"built_in\">uptime</span>,level,tags:filecount=5,filesize=20M</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># è¯¦ç»†GCæ—¥å¿—é…ç½®</span></span><br><span class=\"line\">-Xlog:gc*=debug:file=gc_%p_%t.log:time,<span class=\"built_in\">uptime</span>,level,tags:filecount=10,filesize=50M</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># å¤šç›®æ ‡è¾“å‡º</span></span><br><span class=\"line\">-Xlog:gc*=info:file=gc.log::filecount=5,filesize=20M -Xlog:gc*=debug:file=gc_detailed.log</span><br></pre></td></tr></table></figure>\n</li>\n<li class=\"lvl-2\">\n<p>å¯¹äºGCæ—¥å¿—çš„åˆ†æ<br>\näººå·¥åˆ†æè¿˜æ˜¯å¤ªå¤æ‚äº†ï¼Œå¯ä»¥ä½¿ç”¨<a href=\"https://gceasy.io\">GCEasy.io</a>ï¼Œæ¯ä¸ªæœˆå…è´¹5æ¬¡ã€‚</p>\n</li>\n</ul>\n","content_text":"æ‘˜è¦ æœ¬æ–‡ä»‹ç»JVMçš„å†…å­˜æ¨¡å‹ä¸åƒåœ¾å›æ”¶æœºåˆ¶ JDK8 The JavaÂ® Virtual Machine Specification JDK8çš„javaæŒ‡ä»¤çš„å®˜â½…â½‚æ¡£ JDKâ¼¯å…·å®˜â½¹â½‚æ¡£ JDK17çš„javaæŒ‡ä»¤çš„å®˜â½…â½‚æ¡£ JVMè™šæ‹Ÿæœºç»“æ„(HotSpot) è®¾ç½®å†…å­˜åˆ†é…ç¤ºä¾‹ 1234# jdk1.8+java â€Xms2048M â€Xmx2048M â€Xmn1024M â€Xss512K â€XX:MetaspaceSize=128M â€XX:MaxMetaspaceSize=256M â€jar server.jar# jdk1.6/1.7java â€Xms2048M â€Xmx2048M â€Xmn1024M â€Xss512K â€XX:PermSize=128M â€XX:MaxPermSize=256M â€jar server.jar å„å‚æ•°å«ä¹‰ä¸é»˜è®¤å€¼ï¼ˆé’ˆå¯¹ JDK 1.8ï¼‰ å‚æ•° å«ä¹‰è¯´æ˜ é»˜è®¤å€¼ï¼ˆJDK 1.8ï¼‰ -Xms2048M åˆå§‹å †å¤§å°ï¼Œå³ JVM å¯åŠ¨æ—¶åˆ†é…çš„å †å†…å­˜å¤§å°ï¼ˆè¿™é‡Œæ˜¯ 2GBï¼‰ ç‰©ç†å†…å­˜çš„ 1/64ï¼ˆæœ€å° 1MBï¼‰ï¼Œæ¨èé…ç½®ä¸ºä¸ -Xmx ä¸€è‡´ -Xmx2048M æœ€å¤§å †å†…å­˜å¤§å°ï¼ŒJVM å…è®¸åˆ†é…çš„æœ€å¤§å †å†…å­˜ ç‰©ç†å†…å­˜çš„ 1/4ï¼ˆå—é™äº 32ä½/64ä½ï¼‰ -Xmn1024M æ–°ç”Ÿä»£å¤§å°ï¼ˆEden + Survivorï¼‰ä¸º 1GB æœªæ˜¾å¼æŒ‡å®šæ—¶ï¼Œé€šå¸¸å å †çš„ 1/3 å·¦å³ -Xss512K æ¯ä¸ªçº¿ç¨‹çš„æ ˆå¤§å°ï¼ˆThread Stack Sizeï¼‰ï¼Œè¿™é‡Œè®¾ç½®ä¸º 512KB 1MBï¼ˆ64ä½ç³»ç»Ÿï¼‰æˆ– 512KBï¼ˆ32ä½ç³»ç»Ÿï¼‰ -XX:MetaspaceSize=256M å…ƒç©ºé—´åˆå§‹å¤§å°ï¼ˆç”¨äºåŠ è½½ç±»çš„å…ƒæ•°æ®ï¼Œä¸å†ä½¿ç”¨ PermGenï¼‰ï¼Œè¾¾åˆ°è¯¥å€¼åï¼ŒJVM ä¼šè§¦å‘ä¸€æ¬¡ GCï¼Œç©ºé—´ä¸å¤Ÿæ—¶ä¼šè¿›è¡Œæ‰©å®¹ï¼Œæœ€å¤§åˆ° MaxMetaspaceSize é»˜è®¤ 21MBï¼ˆå®¢æˆ·ç«¯ï¼‰æˆ– 16MBï¼ˆæœåŠ¡å™¨ç«¯ï¼‰ï¼Œä¸ºé¿å…é¢‘ç¹æ‰©å®¹å¯¼è‡´çš„GCï¼Œå¯ä»¥è®¾ç½®çš„ç¨å¾®å¤§ä¸€äº›ï¼Œæ¯”å¦‚MaxMetaspaceSizeçš„ä¸€åŠï¼Œæˆ–å¹²è„†ä¸MaxMetaspaceSizeä¸€æ ·å¤§ -XX:MaxMetaspaceSize=256M å…ƒç©ºé—´æœ€å¤§å¤§å°ï¼Œæ¥è¿‘è®¾ç½®å€¼æ—¶ä¼šè§¦å‘ Full GC æ— é™åˆ¶ï¼ˆé»˜è®¤åªå—ç‰©ç†å†…å­˜çº¦æŸï¼‰ ï¼Œæ¨èé…ç½®ä¸€ä¸ªåˆé€‚çš„æ•°å€¼ï¼Œæ¯”å¦‚8Gçš„å†…å­˜å¯ä»¥é…ç½®ä¸º256M ç±»è£…è½½å­ç³»ç»Ÿï¼ˆClass Loading Subsystemï¼‰ ç±»è£…è½½å­ç³»ç»Ÿè´Ÿè´£å°† .class æ–‡ä»¶åŠ è½½åˆ° JVM ä¸­ï¼Œå¹¶è¿›è¡Œè§£æã€éªŒè¯ã€åˆå§‹åŒ–ç­‰è¿‡ç¨‹ã€‚ åŠ è½½è¿‡ç¨‹çš„å‡ ä¸ªé˜¶æ®µï¼š é˜¶æ®µ è¯´æ˜ åŠ è½½ï¼ˆLoadingï¼‰ å°† .class æ–‡ä»¶è¯»å–ä¸ºäºŒè¿›åˆ¶æ•°æ®ï¼Œæ„é€  Class å¯¹è±¡ éªŒè¯ï¼ˆVerificationï¼‰ ç¡®ä¿å­—èŠ‚ç æ–‡ä»¶æ ¼å¼æ­£ç¡®ã€å®‰å…¨åˆæ³•ï¼ˆé˜²æ­¢æ¶æ„ä»£ç ï¼‰ å‡†å¤‡ï¼ˆPreparationï¼‰ ä¸ºç±»çš„é™æ€å˜é‡åˆ†é…å†…å­˜ï¼Œå¹¶è®¾ç½®é»˜è®¤åˆå§‹å€¼ è§£æï¼ˆResolutionï¼‰ å°†å¸¸é‡æ± ä¸­çš„ç¬¦å·å¼•ç”¨æ›¿æ¢ä¸ºç›´æ¥å¼•ç”¨ï¼ˆæ–¹æ³•ã€å­—æ®µç­‰ï¼‰ åˆå§‹åŒ–ï¼ˆInitializationï¼‰ æ‰§è¡Œ &lt;clinit&gt; é™æ€åˆå§‹åŒ–æ–¹æ³•ï¼Œå¯¹é™æ€å˜é‡èµ‹åˆå§‹å€¼ ç±»åŠ è½½å™¨ï¼ˆClassLoaderï¼‰ä½“ç³»ç»“æ„ï¼šè¯¦ç»†å‚è€ƒ JVM ä¹‹ ç±»åŠ è½½å™¨ ç±»åŠ è½½å™¨åç§° åŠ è½½å†…å®¹ è¯´æ˜ å¼•å¯¼ç±»åŠ è½½å™¨ï¼ˆBootstrap ClassLoaderï¼‰ Java æ ¸å¿ƒç±»åº“ï¼ˆå¦‚ java.lang.*ï¼‰ ç”± JVM è‡ªèº«å®ç°ï¼Œç”¨æœ¬åœ°ä»£ç å®ç°ï¼Œæ— æ³•ç›´æ¥è®¿é—® æ‰©å±•ç±»åŠ è½½å™¨ï¼ˆExtension ClassLoaderï¼‰ JAVA_HOME/jre/lib/ext ç›®å½•ä¸‹çš„ç±» åŠ è½½æ ‡å‡†æ‰©å±•ç±»åº“ åº”ç”¨ç±»åŠ è½½å™¨ï¼ˆApplication ClassLoaderï¼‰ ç”¨æˆ·åº”ç”¨ç±»è·¯å¾„ï¼ˆCLASSPATH æŒ‡å®šçš„ç›®å½•ï¼‰ æœ€å¸¸ç”¨ï¼ŒåŠ è½½å¤§å¤šæ•°åº”ç”¨ä»£ç  è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼ˆCustom ClassLoaderï¼‰ ç”¨æˆ·æ‰‹åŠ¨å®ç°çš„ç±»åŠ è½½å™¨ å¯ä»¥æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶ï¼Œå®ç°çƒ­åŠ è½½ã€åŠ å¯†ç±»åŠ è½½ç­‰ ç±»åŠ è½½é‡‡ç”¨ åŒäº²å§”æ´¾æ¨¡å‹ï¼šè¯·æ±‚ä¼šå…ˆå‘çˆ¶åŠ è½½å™¨å§”æ‰˜ï¼Œåªæœ‰åœ¨çˆ¶åŠ è½½å™¨åŠ è½½å¤±è´¥æ—¶æ‰å°è¯•è‡ªèº«åŠ è½½ã€‚ å­—èŠ‚ç æ‰§è¡Œå¼•æ“ï¼ˆExecution Engineï¼‰ å­—èŠ‚ç æ‰§è¡Œå¼•æ“è´Ÿè´£å°† Java å­—èŠ‚ç è§£é‡Šæˆ–ç¼–è¯‘ä¸ºæœºå™¨ä»£ç ï¼Œå¹¶åœ¨åº•å±‚å¹³å°ä¸Šæ‰§è¡Œã€‚ æ‰§è¡Œå¼•æ“çš„æ ¸å¿ƒæ¨¡å— ç»„ä»¶åç§° ä½œç”¨è¯´æ˜ å…³é”®ç‰¹æ€§ è§£é‡Šå™¨ï¼ˆInterpreterï¼‰ å°†å­—èŠ‚ç é€æ¡è§£é‡Šæ‰§è¡Œ å¯åŠ¨å¿«ï¼Œé€‚åˆå†·ä»£ç ï¼ˆéçƒ­ç‚¹ä»£ç ï¼‰ï¼Œæ‰§è¡Œæ•ˆç‡ç›¸å¯¹è¾ƒä½ å³æ—¶ç¼–è¯‘å™¨ï¼ˆJIT Compilerï¼‰ å°†çƒ­ç‚¹ä»£ç ç¼–è¯‘ä¸ºæœ¬åœ°æœºå™¨ç ï¼Œæé«˜æ‰§è¡Œæ•ˆç‡ åŒ…å« C1ï¼ˆClientï¼‰å’Œ C2ï¼ˆServerï¼‰ä¸¤ç§ï¼Œæ”¯æŒä¼˜åŒ–å¦‚ï¼šæ–¹æ³•å†…è”ã€é€ƒé€¸åˆ†æã€å¾ªç¯å±•å¼€ç­‰ åƒåœ¾æ”¶é›†å™¨ï¼ˆGarbage Collector, GCï¼‰ è‡ªåŠ¨å†…å­˜ç®¡ç†ï¼Œè´Ÿè´£å¯¹è±¡ç”Ÿå‘½å‘¨æœŸçš„å›æ”¶ å¸¸è§ç®—æ³•åŒ…æ‹¬ï¼šSerialã€Parallelã€CMSã€G1ã€ZGCï¼ˆä½å»¶è¿Ÿï¼‰ç­‰ï¼Œæ ¹æ®ä¸åŒåœºæ™¯é€‰æ‹© æœ¬åœ°æ¥å£ï¼ˆNative Interfaceï¼‰ æ”¯æŒ Java ä¸æœ¬åœ°è¯­è¨€ï¼ˆå¦‚ C/C++ï¼‰çš„äº’æ“ä½œ é€šè¿‡ JNIï¼ˆJava Native Interfaceï¼‰å®ç°ï¼Œè°ƒç”¨åº•å±‚æ“ä½œç³»ç»Ÿæˆ–ç¬¬ä¸‰æ–¹åº“åŠŸèƒ½ å³æ—¶ç¼–è¯‘å™¨ï¼ˆJIT Compilerï¼‰ JVM çš„ HotSpot ç¼–è¯‘å™¨æœ‰ä¸¤ä¸ªä¸»è¦ç»„ä»¶ï¼š C1 ç¼–è¯‘å™¨ï¼ˆClient ç¼–è¯‘å™¨ï¼‰ï¼šè½»é‡ã€å¿«é€Ÿç¼–è¯‘ï¼Œä¼˜åŒ–å°‘ã€‚ C2 ç¼–è¯‘å™¨ï¼ˆServer ç¼–è¯‘å™¨ï¼‰ï¼šä¼˜åŒ–é«˜çº§ï¼Œè€—æ—¶é•¿ï¼Œé€‚åˆé•¿æ—¶é—´è¿è¡Œçš„çƒ­ç‚¹ä»£ç ã€‚ åœ¨ 64 ä½ JDK ä¸­ï¼Œé»˜è®¤å°±æ˜¯ -server æ¨¡å¼ (C2 ç¼–è¯‘å™¨) ï¼Œä¸å†æ”¯æŒ -client (C1 ç¼–è¯‘å™¨)ã€‚ åœ¨ 32 ä½ JDK ä¸­ï¼Œæ ¹æ®å¹³å°å’Œå¯åŠ¨æ–¹å¼ï¼Œå¯èƒ½ä¼šè‡ªåŠ¨é€‰æ‹© -client æˆ– -serverï¼Œä¹Ÿå¯ä»¥æ‰‹åŠ¨æŒ‡å®šã€‚ åˆ†å±‚ç¼–è¯‘ï¼ˆTiered Compilationï¼‰ å…è®¸ JVM åœ¨ä¸€å¼€å§‹ç”¨ C1 ç¼–è¯‘å™¨å¿«é€Ÿç¼–è¯‘å­—èŠ‚ç ï¼Œåç»­çƒ­ç‚¹ä»£ç å†äº¤ç»™ C2 ç¼–è¯‘å™¨è¿›è¡Œæ›´é«˜çº§ä¼˜åŒ–ã€‚è¿™æ ·ç»“åˆäº† -clientï¼ˆå¿«å¯åŠ¨ï¼‰å’Œ -serverï¼ˆé«˜æ€§èƒ½ï¼‰çš„ä¼˜ç‚¹ã€‚TieredCompilationå‚æ•°æ§åˆ¶æ˜¯å¦å¼€å¯åˆ†å±‚ç¼–è¯‘ï¼Œé»˜è®¤å¼€å¯ã€‚ -XX:TieredStopAtLeve=&lt;level&gt; å‚æ•°æ§åˆ¶ ç¼–è¯‘å™¨æœ€å¤šä½¿ç”¨å“ªä¸€å±‚ä¼˜åŒ–çº§åˆ«ã€‚å®ƒçš„å–å€¼å¦‚ä¸‹ï¼Œå€¼è¶Šä½å¯åŠ¨è¶Šå¿«ï¼Œä½†ä¼˜åŒ–è¶Šå°‘ã€‚ å€¼ å«ä¹‰ 0 ä»…è§£é‡Šæ‰§è¡Œï¼ˆä¸å¼€å¯ç¼–è¯‘å™¨ï¼‰ 1 åªä½¿ç”¨ C1 ç¼–è¯‘å™¨çš„ç¬¬ä¸€çº§ï¼ˆæœ€å°‘ä¼˜åŒ–ï¼‰ 2 C1 ç¬¬äºŒçº§ï¼Œç•¥å¤šä¼˜åŒ– 3 C1 ç¬¬ä¸‰çº§ï¼Œæ›´ä¼˜åŒ– 4 å¯ç”¨ C2 ç¼–è¯‘å™¨ï¼ˆå®Œå…¨ä¼˜åŒ–ï¼Œé»˜è®¤å€¼ï¼‰ JVM å†…å­˜æ¨¡å‹ï¼ˆJava Memory Modelï¼ŒJMMï¼‰ JMM æ˜¯ Java è™šæ‹Ÿæœºè§„èŒƒä¸­å®šä¹‰çš„ä¸€ç§ æŠ½è±¡å†…å­˜æ¨¡å‹ï¼Œå®ƒå†³å®šäº†å¤šçº¿ç¨‹ç¨‹åºä¸­å˜é‡çš„è¯»å†™å¯è§æ€§ã€æœ‰åºæ€§å’ŒåŸå­æ€§ã€‚åŒæ—¶ï¼ŒJVM åœ¨ç‰©ç†å±‚ä¹Ÿæœ‰ä¸€ä¸ªå®é™…çš„å†…å­˜ç»“æ„ï¼Œç§°ä¸ºè¿è¡Œæ—¶æ•°æ®åŒºåŸŸï¼ˆRuntime Data Areasï¼‰ï¼Œè¿™ä¸¤ä¸ªå¯ä»¥ç»“åˆç†è§£ã€‚ JMM çš„ä¸»è¦ç›®æ ‡ ä¿è¯å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„æ•°æ®ä¸€è‡´æ€§ æŒ‡å¯¼ JVM å’Œ CPU çš„å†…å­˜äº¤äº’è¡Œä¸ºï¼ˆå¦‚é‡æ’åºã€ç¼“å­˜ï¼‰ å®é™…è¿è¡Œæ—¶å†…å­˜ç»“æ„å¦‚ä¸‹ï¼š å†…å­˜åŒºåŸŸ è¯´æ˜ ğŸ“Œ ç¨‹åºè®¡æ•°å™¨ï¼ˆPCï¼‰ æ¯ä¸ªçº¿ç¨‹ç§æœ‰ï¼Œè®°å½•å½“å‰æ‰§è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤åœ°å€ ğŸ“Œ Java çº¿ç¨‹æ ˆ æ¯ä¸ªçº¿ç¨‹ç§æœ‰ï¼Œæ–¹æ³•è°ƒç”¨æ—¶ç”¨äºå­˜å‚¨å±€éƒ¨å˜é‡ã€æ“ä½œæ•°æ ˆç­‰ ğŸ“Œ æœ¬åœ°æ–¹æ³•æ ˆ ä¸è™šæ‹Ÿæœºæ ˆç±»ä¼¼ï¼Œç”¨äº native æ–¹æ³• ğŸ“Œ å †ï¼ˆHeapï¼‰ æ‰€æœ‰çº¿ç¨‹å…±äº«ï¼Œå­˜å‚¨å¯¹è±¡å®ä¾‹ã€æ•°ç»„ç­‰ï¼ŒGC çš„ä¸»è¦åŒºåŸŸ ğŸ“Œ æ–¹æ³•åŒºï¼ˆæˆ–å…ƒç©ºé—´ï¼‰ æ‰€æœ‰çº¿ç¨‹å…±äº«ï¼Œå­˜å‚¨ç±»ä¿¡æ¯ã€é™æ€å˜é‡ã€å¸¸é‡æ± ç­‰ï¼ˆJDK8 åç§°ä¸º Metaspaceï¼‰ åƒåœ¾å›æ”¶å™¨ åƒåœ¾å›æ”¶å™¨è´Ÿè´£è‡ªåŠ¨ç®¡ç†å†…å­˜ï¼Œå›æ”¶ä¸å†ä½¿ç”¨çš„å¯¹è±¡ï¼Œé¿å…å†…å­˜æ³„æ¼å’Œæº¢å‡ºã€‚ ä»€ä¹ˆæ˜¯åƒåœ¾ å†…å­˜ä¸­æ²¡æœ‰è¢«ï¼ˆçº¿ç¨‹æ ˆå˜é‡ï¼Œé™æ€å˜é‡ï¼Œå¸¸é‡æ± ï¼ŒJNIæŒ‡é’ˆï¼‰å¼•ç”¨çš„åœ°å€å°±æ˜¯åƒåœ¾ å¯è¾¾æ€§åˆ†æç®—æ³•ï¼šæ˜¯ç°ä»£ JVM åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡æ˜¯å¦â€œè¿˜æ´»ç€â€çš„ä¸»è¦ç®—æ³•ã€‚ 1234åŸºæœ¬æ€æƒ³ï¼šä»ä¸€ç»„ç§°ä¸º â€œGC Rootsâ€ çš„å¯¹è±¡å‡ºå‘ï¼Œæ²¿ç€å¯¹è±¡ä¹‹é—´çš„å¼•ç”¨é“¾å‘ä¸‹æœç´¢ã€‚å¦‚æœæŸä¸ªå¯¹è±¡ å¯ä»¥ä» GC Roots è¿½è¸ªåˆ°ï¼Œå°±è®¤ä¸ºå®ƒæ˜¯ â€œå¯è¾¾â€ çš„ï¼ˆAliveï¼‰ã€‚å¦åˆ™å°±è®¤ä¸ºæ˜¯ â€œä¸å¯è¾¾â€ çš„ï¼ˆGarbageï¼‰ï¼Œå¯ä»¥è¢«å›æ”¶ã€‚ åœ¨ JVM ä¸­ï¼ŒGC Roots æ˜¯ä¸€äº› å§‹ç»ˆå¯ç”¨çš„ã€ä¸ä¼šè¢«åƒåœ¾å›æ”¶çš„å¼•ç”¨èµ·ç‚¹ï¼Œä¸»è¦åŒ…æ‹¬ï¼š GC Roots æ¥æº è¯´æ˜ å½“å‰çº¿ç¨‹æ ˆä¸­çš„å¼•ç”¨ï¼ˆå±€éƒ¨å˜é‡è¡¨ï¼‰ å„ä¸ªçº¿ç¨‹æ­£åœ¨è°ƒç”¨çš„æ–¹æ³•ä¸­çš„å±€éƒ¨å˜é‡ã€å‚æ•°ç­‰ é™æ€å­—æ®µå¼•ç”¨ ç±»çš„é™æ€å­—æ®µå¼•ç”¨çš„å¯¹è±¡ JNI å¼•ç”¨ï¼ˆNative æ–¹æ³•å¼•ç”¨ï¼‰ Java æœ¬åœ°æ–¹æ³•ä¸­å¼•ç”¨çš„å¯¹è±¡ å¸¸é‡å¼•ç”¨æ± ä¸­çš„å¯¹è±¡ å­—ç¬¦ä¸²å¸¸é‡ç­‰å¯èƒ½æŒæœ‰å¯¹è±¡å¼•ç”¨ æ´»åŠ¨çº¿ç¨‹å¯¹è±¡ çº¿ç¨‹è‡ªèº«åœ¨ GC æ—¶ä¸ä¼šè¢«å›æ”¶ JVM å†…éƒ¨ç»“æ„ï¼ˆå¦‚ç³»ç»Ÿç±»åŠ è½½å™¨ç­‰ï¼‰ JVM å…³é”®ç³»ç»Ÿå¯¹è±¡ åƒåœ¾å›æ”¶å™¨ç§ç±»ï¼š å·¦è¾¹6ç§å«åˆ†ä»£æ¨¡å‹ï¼Œå³è¾¹çš„4ç§å«åˆ†åŒºæ¨¡å‹ åˆ†ä»£æ¨¡å‹ï¼ˆGenerational Modelï¼‰ å †å†…å­˜åˆ’åˆ†ä¸ºï¼š å¹´è½»ä»£ï¼ˆYoung Generationï¼‰ï¼šå­˜æ”¾æ–°åˆ›å»ºçš„å¯¹è±¡ï¼Œåˆ†ä¸º Eden å’Œ Survivor åŒºã€‚ è€å¹´ä»£ï¼ˆOld Generationï¼‰ï¼šå­˜æ”¾ç»è¿‡å¤šæ¬¡ GC åä»ç„¶å­˜æ´»çš„å¯¹è±¡ã€‚ åˆ†åŒºæ¨¡å‹ï¼ˆRegion-based Modelï¼‰ åˆ†åŒºæ¨¡å‹ï¼ˆå¦‚ G1ã€ZGCã€Shenandoahï¼‰ä¸å†ä¸¥æ ¼æŒ‰ç…§ä»£åˆ’åˆ†å†…å­˜ï¼Œè€Œæ˜¯æŠŠå †åˆ’åˆ†ä¸ºå¤šä¸ª å¤§å°ç›¸åŒçš„ Regionã€‚æ¯ä¸ª Region å¯ä»¥åœ¨è¿è¡Œæ—¶è¢«åŠ¨æ€æ ‡è®°ä¸º Edenã€Survivor æˆ– Oldã€‚ åˆ†ä»£æ¨¡å‹ä¸­ï¼Œä¸Šé¢3ä¸ªæ˜¯æ–°ç”Ÿä»£åƒåœ¾å›æ”¶å™¨ï¼Œä¸‹é¢3ä¸ªæ˜¯è€å¹´ä»£åƒåœ¾å›æ”¶å™¨ï¼Œå¯ä»¥äº¤å‰é…å¯¹ï¼ˆè§ä¸Šå›¾è™šçº¿ï¼‰ï¼Œä½†æœ€å¸¸ç”¨æ˜¯ä¸Šä¸‹ä¸¤ä¸¤é…å¯¹ã€‚ CMSå³å¯ä»¥ä½œä¸ºæ–°ç”Ÿä»£åƒåœ¾å›æ”¶å™¨ï¼Œä¹Ÿå¯ä»¥ä½œä¸ºè€å¹´ä»£åƒåœ¾å›æ”¶å™¨ã€‚ EpsilonGCï¼Œæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„åƒåœ¾å›æ”¶å™¨ï¼Œå®ƒä¸å›æ”¶ä»»ä½•å¯¹è±¡ï¼Œåªè´Ÿè´£æœ€ç»ˆè®°å½•ï¼Œåšæµ‹è¯•ç”¨çš„ã€‚ ç›®å‰æœ€å…ˆè¿›çš„æ¨¡å‹æ˜¯ ZGCï¼Œjkd11å¼€å§‹æ”¯æŒï¼Œä½†ç›´åˆ°JDK16æ‰æ¯”è¾ƒå®Œå–„ï¼Œç›®å‰éé»˜è®¤é…ç½®ï¼Œéœ€è¦æ‰‹åŠ¨é…ç½®ã€‚å…¶ä¸Redhatå‡ºå“çš„ Shenandoah æ˜¯ç«äº‰å…³ç³»ã€‚ å¸¸è§åƒåœ¾å›æ”¶å™¨åŠå…¶åˆ†ç±»ã€JDKç‰ˆæœ¬ åƒåœ¾å›æ”¶å™¨ æ‰€å±æ¨¡å‹ è¯´æ˜ é¦–æ¬¡å‡ºç° JDK ç‰ˆæœ¬ å¯ç”¨å‘½ä»¤ï¼ˆJVM å‚æ•°ï¼‰ é€‚åˆçš„å †å†…å­˜å¤§å° Serial åˆ†ä»£æ¨¡å‹ å•çº¿ç¨‹ï¼Œæ–°ç”Ÿä»£å’Œè€å¹´ä»£éƒ½ä½¿ç”¨ Serialï¼Œé€‚ç”¨äºå°å †å†…å­˜, å·²å¼ƒç”¨ JDK 1.2 -XX:+UseSerialGC ğŸ’¾ å°äº 1GB ParNew åˆ†ä»£æ¨¡å‹ Serial çš„å¤šçº¿ç¨‹ç‰ˆæœ¬ï¼Œä»…ç”¨äº CMS æ–°ç”Ÿä»£, JDK11å·²å¼ƒç”¨ JDK 1.4 -XX:+UseParNewGC -XX:+UseConcMarkSweepGC ğŸ’¾ 1GB ~ 4GB Parallelï¼ˆååé‡ GCï¼‰ åˆ†ä»£æ¨¡å‹ å¤šçº¿ç¨‹ GCï¼Œé€‚åˆååé‡ä¼˜å…ˆçš„åº”ç”¨åœºæ™¯ JDK 1.4 -XX:+UseParallelGCï¼ˆæ–°ç”Ÿä»£ï¼‰-XX:+UseParallelOldGCï¼ˆè€å¹´ä»£ï¼‰ ğŸ’¾ 2GB ~ 8GB CMSï¼ˆConcurrent Mark Sweepï¼‰ åˆ†ä»£æ¨¡å‹ è€å¹´ä»£å¹¶å‘æ ‡è®°-æ¸…é™¤ï¼Œä½å»¶è¿Ÿï¼Œä½†å­˜åœ¨ç¢ç‰‡ï¼ŒJDK14å·²å¼ƒç”¨ JDK 1.4 -XX:+UseConcMarkSweepGC ğŸ’¾ 2GB ~ 8GB G1ï¼ˆGarbage Firstï¼‰ åˆ†åŒºæ¨¡å‹ å°†å †åˆ’åˆ†ä¸º Regionï¼Œé€»è¾‘åˆ†ä»£ï¼Œæ”¯æŒå¹¶å‘å‹ç¼©ï¼Œå¹³è¡¡å»¶è¿Ÿä¸åå JDK 7u4ï¼ˆæ­£å¼ï¼‰ -XX:+UseG1GC ğŸ’¾ 4GB ~ æ•°å GB ZGCï¼ˆZ Garbage Collectorï¼‰ åˆ†åŒºæ¨¡å‹ Region å¼¹æ€§å¤§å°ï¼Œæ”¯æŒè¶…å¤§å †ï¼Œä½å»¶è¿Ÿï¼ˆ&lt;10ms åœé¡¿ï¼‰ JDK 11ï¼ˆå®éªŒï¼‰ï¼ŒJDK 15ï¼ˆæ­£å¼ï¼‰ -XX:+UseZGC ğŸ’¾ 8GB ~ æ•° TBï¼ˆè¶…å¤§å †ï¼‰ Shenandoah åˆ†åŒºæ¨¡å‹ çº¢å¸½ä¸»å¯¼ï¼Œä½å»¶è¿Ÿï¼Œå¹¶å‘å›æ”¶ä¸å¹¶å‘å‹ç¼© JDK 12ï¼ˆå®éªŒï¼‰ï¼ŒJDK 15ï¼ˆæ­£å¼ï¼‰ -XX:+UseShenandoahGC ğŸ’¾ 2GB ~ æ•°å GB å¯¹äº CMSï¼Œå¯ç”¨åä¼šè‡ªåŠ¨ä½¿ç”¨ ParNew ä½œä¸ºæ–°ç”Ÿä»£å›æ”¶å™¨ï¼ˆé™¤éæ˜¾å¼ç¦æ­¢ï¼‰ã€‚ å¯¹äº Parallel GC å¯ç”¨ -XX:+UseParallelGCï¼ˆæ–°ç”Ÿä»£ï¼‰ä¼šè‡ªåŠ¨å¯ç”¨ -XX:+UseParallelOldGCï¼ˆè€å¹´ä»£ï¼‰ã€‚ å¯¹äºZGCï¼Œjdk15ä»¥å‰æœ€å¤§æ”¯æŒ4Tå†…å­˜ï¼Œä¹‹åæœ€å¤§æ”¯æŒ16Tå†…å­˜ã€‚ å„ç‰ˆæœ¬é»˜è®¤åƒåœ¾å›æ”¶å™¨åŠæ¨èé…ç½®ï¼ˆJDK 1.6 èµ·ï¼‰ JDK ç‰ˆæœ¬ é»˜è®¤ GC å»ºè®®ä½¿ç”¨ GCï¼ˆæŒ‰åœºæ™¯åˆ†ç±»ï¼‰ JDK 1.6 Serial / Parallel - å°å‹åº”ç”¨ï¼ˆå¦‚æ¡Œé¢ç¨‹åºï¼‰ï¼š-XX:+UseSerialGC - ä¸­å¤§å‹åº”ç”¨ï¼ˆååé‡ä¼˜å…ˆï¼‰ï¼š-XX:+UseParallelGC JDK 1.7 åŒä¸Š åŒ JDK 1.6 JDK 1.8 Parallel - ååä¼˜å…ˆï¼šé»˜è®¤ -XX:+UseParallelGC - å“åº”ä¼˜å…ˆï¼š-XX:+UseConcMarkSweepGCï¼ˆCMSï¼‰ - å¤§å † + æœªæ¥å‡çº§è€ƒè™‘ï¼š-XX:+UseG1GCï¼ˆæ¨èï¼‰ JDK 9-14 G1 GC - ä¸€èˆ¬é»˜è®¤å³å¯ï¼š-XX:+UseG1GCï¼ˆå»¶è¿Ÿä¸ååå¹³è¡¡ï¼‰ - æç«¯ä½å»¶è¿Ÿè¦æ±‚ï¼šå‡çº§åˆ° JDK 11+ ä½¿ç”¨ ZGC/Shenandoah JDK 15+ G1 GCï¼ˆé»˜è®¤ï¼‰ï¼ŒZGC / Shenandoah å¯é€‰ - å»¶è¿Ÿæ•æ„Ÿï¼ˆåœ¨çº¿æœåŠ¡ã€RTç³»ç»Ÿï¼‰ï¼š-XX:+UseZGC æˆ– -XX:+UseShenandoahGC - ååä¸ºä¸»ï¼š-XX:+UseParallelGC - ç»¼åˆå¹³è¡¡ï¼š-XX:+UseG1GCï¼ˆé»˜è®¤ï¼‰ åˆ¤æ–­é»˜è®¤ GC çš„æ–¹å¼ 1java -XX:+PrintCommandLineFlags -version åƒåœ¾å›æ”¶ç®—æ³• JVM ä¸­å¸¸è§åƒåœ¾å›æ”¶ç®—æ³•æ±‡æ€» ç®—æ³•åç§° æ ¸å¿ƒæ€æƒ³ é€‚ç”¨é˜¶æ®µ/åŒºåŸŸ ä¼˜ç¼ºç‚¹ç®€è¿° æ ‡è®°-æ¸…é™¤ï¼ˆMark-Sweepï¼‰ æ ‡è®°å‡ºå­˜æ´»å¯¹è±¡ï¼Œæ¸…é™¤æœªæ ‡è®°å¯¹è±¡ è€å¹´ä»£ ç®€å•é«˜æ•ˆï¼Œä½†ä¼šäº§ç”Ÿå¤§é‡ç¢ç‰‡ï¼Œä¸é€‚åˆè¿ç»­å†…å­˜åˆ†é… æ ‡è®°-æ•´ç†ï¼ˆMark-Compactï¼‰ æ ‡è®°åç§»åŠ¨å­˜æ´»å¯¹è±¡ï¼Œæ•´ç†ç¢ç‰‡ è€å¹´ä»£ æ¶ˆé™¤ç¢ç‰‡ï¼Œä»£ä»·æ˜¯ç§»åŠ¨å¯¹è±¡ï¼Œé€‚ç”¨äºè€å¹´ä»£å‹ç¼© å¤åˆ¶ç®—æ³•ï¼ˆCopyingï¼‰ å°†å¯¹è±¡å¤åˆ¶åˆ°å¦ä¸€å—å†…å­˜ï¼ˆå¦‚ Eden â†’ Survivorï¼‰ æ–°ç”Ÿä»£ é«˜æ•ˆç‡ï¼Œé€‚åˆå›æ”¶å¤§å¤šæ•°å¯¹è±¡çŸ­å‘½çš„æ–°ç”Ÿä»£ï¼Œä½†éœ€è¦é¢å¤–ç©ºé—´ åˆ†ä»£å›æ”¶ï¼ˆGenerationalï¼‰ å°†å¯¹è±¡æŒ‰ç”Ÿå‘½å‘¨æœŸåˆ’åˆ†ï¼ˆæ–°ç”Ÿä»£/è€å¹´ä»£ï¼‰ æ•´ä¸ªå †ç»“æ„ å®ç”¨æ€§å¼ºï¼Œç»“åˆä¸åŒç®—æ³•åº”ç”¨äºä¸åŒä»£ï¼Œç°ä»£ GC åŸºç¡€ åˆ†åŒºå›æ”¶ï¼ˆRegion-basedï¼‰ å°†å †åˆ’åˆ†ä¸ºè‹¥å¹²ç­‰å¤§å°çš„ Region åŠ¨æ€åˆ†é… æ•´ä¸ªå †ï¼ˆå¦‚ G1ã€ZGCï¼‰ æ›´çµæ´»ï¼Œæ”¯æŒå¹¶å‘å¹¶è¡Œï¼Œå‡å°‘ STW åœé¡¿ï¼Œé€‚ç”¨äºå¤§å †ã€ä½å»¶è¿Ÿåœºæ™¯ å¢é‡å›æ”¶ï¼ˆIncrementalï¼‰ åˆ†é˜¶æ®µå°æ­¥æ‰§è¡Œ GC ä»¥å‡å°‘å•æ¬¡åœé¡¿ æŸäº›å¹¶å‘/ä½å»¶è¿Ÿ GC å‡å°‘æš‚åœæ—¶é—´ï¼Œä½†æ•´ä½“æ•ˆç‡å¯èƒ½é™ä½ å¹¶å‘å›æ”¶ï¼ˆConcurrentï¼‰ æ ‡è®°ã€æ¸…ç†ç­‰æ­¥éª¤ä¸åº”ç”¨çº¿ç¨‹å¹¶å‘æ‰§è¡Œ CMSã€G1ã€ZGC ç­‰ åœé¡¿æ—¶é—´çŸ­ï¼Œå¯¹å“åº”æ—¶é—´è¦æ±‚é«˜çš„ç³»ç»Ÿå‹å¥½ ä¸‰è‰²æ ‡è®°ï¼ˆTri-color Markingï¼‰ å¹¶å‘æ ‡è®°ç®—æ³•çš„ä¸€ç§å®ç°æ€æƒ³ CMSã€G1ã€ZGC ç­‰ ç™½ï¼ˆå¾…å›æ”¶ï¼‰ã€ç°ï¼ˆå·²æ ‡è®°æœªæ‰«æï¼‰ã€é»‘ï¼ˆå·²æ ‡è®°å·²æ‰«æï¼‰ï¼Œé¿å…â€œæ¼æ ‡â€é—®é¢˜ SATBï¼ˆSnapshot-At-The-Beginningï¼‰ å¹¶å‘æ ‡è®°çš„å¿«ç…§ç­–ç•¥ G1ã€ZGC ä¿è¯åœ¨å¹¶å‘æ ‡è®°è¿‡ç¨‹ä¸­ä¸é—æ¼æ–°å¼•ç”¨ï¼Œé€‚åˆé«˜å¹¶å‘åœºæ™¯ Lazy Compactionï¼ˆå»¶è¿Ÿå‹ç¼©ï¼‰ ä¸æ¯æ¬¡ GC éƒ½å‹ç¼©ï¼Œè§†æƒ…å†µè€Œå®š G1 ç­‰ é™ä½ä¸å¿…è¦çš„ç§»åŠ¨æˆæœ¬ å¯¹åº”å…³ç³»ï¼šGC å›æ”¶å™¨å’Œåº•å±‚ç®—æ³• å›æ”¶å™¨ ä½¿ç”¨çš„ç®—æ³•ç»„åˆ Serial æ–°ç”Ÿä»£ï¼šå¤åˆ¶ç®—æ³•è€å¹´ä»£ï¼šæ ‡è®°-æ•´ç† ParNew æ–°ç”Ÿä»£ï¼šå¤åˆ¶ç®—æ³•ï¼ˆå¤šçº¿ç¨‹ï¼‰ Parallel æ–°ç”Ÿä»£ï¼šå¤åˆ¶ç®—æ³•è€å¹´ä»£ï¼šæ ‡è®°-æ•´ç† CMS æ–°ç”Ÿä»£ï¼šParNewï¼ˆå¤åˆ¶ï¼‰è€å¹´ä»£ï¼šæ ‡è®°-æ¸…é™¤ + ä¸‰è‰²æ ‡è®° + å¹¶å‘ G1 åˆ†åŒºå›æ”¶ + ä¸‰è‰²æ ‡è®° + SATB + Lazy Compaction ZGC åˆ†åŒºå›æ”¶ + å¹¶å‘æ ‡è®° + SATB + Region Remapping Shenandoah åˆ†åŒºå›æ”¶ + å¹¶å‘æ ‡è®° + å¹¶å‘å‹ç¼© + ä¸‰è‰²æ ‡è®° 1234567891011 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ å¸¸è§ GC ç®—æ³•åˆ†ç±» â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚åˆ†ä»£æ¨¡å‹ åˆ†åŒºæ¨¡å‹ â”‚ â”‚ â”Œâ”€â”´â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”€â”å¤åˆ¶ æ ‡è®°-æ¸…é™¤ Region-based å¹¶å‘ æ ‡è®°-æ•´ç† SATB / ä¸‰è‰²æ ‡è®° ä»€ä¹ˆæ˜¯ STWï¼ˆStop-The-Worldï¼‰ STWï¼ˆStop-The-Worldï¼‰ æŒ‡çš„æ˜¯ï¼šåœ¨æŸäº›åƒåœ¾å›æ”¶é˜¶æ®µï¼ŒJVM ä¼šæš‚åœæ‰€æœ‰åº”ç”¨çº¿ç¨‹ï¼ˆä¹Ÿå«ç”¨æˆ·çº¿ç¨‹ï¼‰ï¼Œè®©åƒåœ¾å›æ”¶çº¿ç¨‹ç‹¬å  CPU æ‰§è¡Œ GC é€»è¾‘ã€‚ ä½ å¯ä»¥è¿™æ ·ç†è§£ STW JVM ä¼šâ€œæŒ‰ä¸‹æš‚åœé”®â€æš‚åœæ‰€æœ‰æ­£åœ¨è¿è¡Œçš„ Java ç¨‹åºä»£ç ï¼› ç„¶å ä¸“å¿ƒè¿›è¡Œ GC çš„æŸäº›é˜¶æ®µï¼ˆå¦‚æ ‡è®°ã€æ•´ç†ã€å¤åˆ¶ç­‰ï¼‰ï¼› GC å®Œæˆåï¼Œæ‰ä¼šâ€œæ¢å¤è¿è¡Œâ€åº”ç”¨çº¿ç¨‹ã€‚ å„ GC ä¸­ STW çš„å­˜åœ¨æƒ…å†µ å›æ”¶å™¨ æ˜¯å¦å­˜åœ¨ STWï¼Ÿ è¯´æ˜ Serial âœ… æ˜¯ï¼Œå…¨åœé¡¿ï¼Œå…¨é˜¶æ®µå•çº¿ç¨‹ å †è¶Šå¤§ STW è¶Šé•¿ Parallel âœ… æ˜¯ï¼Œå…¨åœé¡¿ï¼Œå¤šçº¿ç¨‹æ‰§è¡Œ GC æé«˜æ•ˆç‡ä½†ä»ä¼šæš‚åœ CMS âœ… æœ‰ï¼Œåˆå§‹æ ‡è®°å’Œæœ€ç»ˆé‡æ–°æ ‡è®°æ˜¯ STW å¤§éƒ¨åˆ†é˜¶æ®µå¹¶å‘æ‰§è¡Œ G1 âœ… æœ‰ï¼Œä½†è®¾è®¡ä¸ºå°½å¯èƒ½ç¼©çŸ­ STW åˆ†é˜¶æ®µå¹¶å‘ + å¹¶è¡Œå¤„ç† ZGC âœ… æçŸ­ï¼ˆ&lt;10msï¼‰ ä»…ä¸ªåˆ«é˜¶æ®µæ˜¯ STWï¼Œå‡ ä¹æ„ŸçŸ¥ä¸åˆ° Shenandoah âœ… æçŸ­ é«˜åº¦å¹¶å‘ï¼ŒSTW æ—¶é—´ä¹ŸæçŸ­ ä¸ºä»€ä¹ˆè¦å…³æ³¨ STWï¼Ÿ åœ¨å“åº”æ—¶é—´æ•æ„Ÿå‹ç³»ç»Ÿï¼ˆå¦‚åœ¨çº¿äº¤æ˜“ç³»ç»Ÿã€æ¸¸æˆæœåŠ¡å™¨ã€API ç½‘å…³ï¼‰ä¸­ï¼Œé•¿æ—¶é—´çš„ STW ä¼šé€ æˆç”¨æˆ·è¯·æ±‚å¡é¡¿ã€è¶…æ—¶ã€‚ å› æ­¤ï¼Œé€‰æ‹© ä½ STW çš„ GCï¼ˆå¦‚ G1ã€ZGCã€Shenandoahï¼‰ å¯¹è¿™ç±»ç³»ç»Ÿè‡³å…³é‡è¦ã€‚ å †å†…å­˜ç»“æ„ ä¸åŒçš„åƒåœ¾å›æ”¶å™¨å†³å®šäº†å †å†…å­˜çš„ç»“æ„ä¸åŒï¼Œä½†æ€»ä½“ä¸Šåˆ†ä¸ºä¸¤ç§ç±»å‹ï¼šåˆ†ä»£æ¨¡å‹å’Œåˆ†åŒºæ¨¡å‹ã€‚ åˆ†ä»£æ¨¡å‹ Parallel åƒåœ¾å›æ”¶å™¨ å †ç»“æ„è¢«åˆ’åˆ†ä¸º Old Generationï¼ˆè€å¹´ä»£ï¼‰ å’Œ Young Generationï¼ˆæ–°ç”Ÿä»£ï¼‰ ä¸¤éƒ¨åˆ†ã€‚ Young Generation ç”± Eden å’Œ ä¸¤ä¸ª Survivor ç»„æˆï¼Œå…¶ä¸­ Eden æ˜¯ä¸€ä¸ªè¿ç»­çš„å†…å­˜åŒºåŸŸï¼ŒSurvivor æ˜¯ä¸€ä¸ªéè¿ç»­çš„å†…å­˜åŒºåŸŸã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼ŒYoung Generationå å †å†…å­˜çš„ 1/3, Old Generation å å †å†…å­˜çš„ 2/3ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼ŒEden:S0:S1 = 8:1:1 ,å¦‚æœå¸Œæœ›ä¸º 4:1:1ï¼Œä½¿ç”¨ -XX:SurvivorRatio=4ï¼Œä½†å®é™…ä¸Šè¿™ä¸ªæ¯”ä¾‹å¹¶ä¸æ˜¯å›ºå®šçš„ï¼Œè€Œæ˜¯ç”±jvmåŸºäºæƒ…å†µè‡ªåŠ¨å˜åŒ–çš„ï¼Œå› ä¸ºJVMé»˜è®¤å¼€å¯äº†è¿™ä¸ªå‚æ•°-XX:+UseAdaptiveSizePolicyï¼Œå¦‚æœå¸Œæœ›å›ºå®šè¿™ä¸ªæ¯”ä¾‹ï¼Œå¯ä»¥è®¾ç½®ä¸º -XX:-UseAdaptiveSizePolicyæ¥å…³é—­è¿™ä¸ªé…ç½®ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼Œå¯¹è±¡æœ€å¤šç»å†15æ¬¡Minor GCåè¿›å…¥è€å¹´ä»£ï¼Œå¯ä»¥é€šè¿‡ -XX:MaxTenuringThreshold=n è®¾ç½®ã€‚ åŒºåŸŸ è¯´æ˜ Eden å¯¹è±¡é¦–æ¬¡åˆ›å»ºçš„åŒºåŸŸï¼Œå¤§éƒ¨åˆ†å¯¹è±¡åœ¨è¿™é‡Œåˆ›å»ºå¹¶å¾ˆå¿«è¢«å›æ”¶ S0/S1 Survivor åŒºåŸŸï¼šä¸¤ä¸ªäº¤æ›¿ä½¿ç”¨çš„ç¼“å†²åŒºï¼ˆFrom å’Œ Toï¼‰ï¼Œç”¨äºæ‹·è´å­˜æ´»å¯¹è±¡ Old è€å¹´ä»£ï¼šå­˜æ´»æ¬¡æ•°å¤šã€ç”Ÿå‘½å‘¨æœŸé•¿çš„å¯¹è±¡ä¼šä»æ–°ç”Ÿä»£æ™‹å‡åˆ°è€å¹´ä»£ï¼Œå›æ”¶é¢‘ç‡ä½ å¯¹è±¡å†…å­˜åˆ†é…å›¾è§£(ç®€åŒ–) 12345678910111213åˆ›å»ºå¯¹è±¡ â†“è¿›å…¥ Eden åŒºï¼ˆæ–°ç”Ÿä»£ï¼‰ â†“ Eden åŒºæ»¡ç¬¬ä¸€æ¬¡ Minor GCï¼ˆå­˜æ´»å¯¹è±¡[Eden]å¤åˆ¶åˆ° S0ï¼‰ â†“ Eden åŒºæ»¡ æˆ– S0 åŒºæ»¡ç¬¬äºŒæ¬¡ Minor GCï¼ˆå­˜æ´»å¯¹è±¡[Edenå’ŒS0]å¤åˆ¶åˆ° S1ï¼Œå¹´é¾„ +1ï¼‰ â†“ Eden åŒºæ»¡ æˆ– S1 åŒºæ»¡ç¬¬ä¸‰æ¬¡ Minor GCï¼ˆå­˜æ´»å¯¹è±¡[Edenå’ŒS1]å¤åˆ¶åˆ° S0ï¼Œå¹´é¾„ +1ï¼‰ â†“â€¦â€¦ S0/S1 äº¤æ›¿ï¼Œå¹´é¾„è¾¾åˆ°é˜ˆå€¼ï¼ˆå¦‚ 15ï¼‰ â†“ è¿˜æ²¡æœ‰è¢«å›æ”¶æ™‹å‡åˆ° Old åŒºï¼ˆè€å¹´ä»£ï¼‰ï¼Œç­‰å¾…OldåŒºæ»¡ è§¦å‘ Full GC å¤§å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£ å¤§å¯¹è±¡å°±æ˜¯éœ€è¦å¤§é‡è¿ç»­å†…å­˜ç©ºé—´çš„å¯¹è±¡ï¼ˆæ¯”å¦‚ï¼šå­—ç¬¦ä¸²ã€æ•°ç»„ï¼‰ï¼Œå¦‚æœå¯¹è±¡å¾ˆå¤§ï¼ˆå¦‚è¶…è¿‡ Eden åŒºå¤§å°ï¼Œæˆ–æ˜¯è¶…è¿‡ Survivor åŒºå¤§å°ï¼‰ï¼Œå¯èƒ½ç›´æ¥åˆ†é…åˆ°è€å¹´ä»£ ä¹Ÿå¯ä»¥é€šè¿‡ -XX:PretenureSizeThreshold=&lt;å¤§å°ï¼Œå•ä½å­—èŠ‚&gt; æ§åˆ¶è¶…è¿‡ä¸€å®šå¤§å°çš„å¯¹è±¡æ˜¯å¦ç›´æ¥åˆ†é…åˆ°è€å¹´ä»£ï¼ˆOld Generationï¼‰ï¼Œè·³è¿‡æ–°ç”Ÿä»£ï¼ˆEdenï¼‰ï¼Œä»¥é¿å…å¤§å¯¹è±¡é¢‘ç¹åœ¨å¹´è½»ä»£é€ æˆ GC å‹åŠ›ã€‚è¿™ä¸ªå‚æ•°åªåœ¨ Serial å’ŒParNewä¸¤ä¸ªæ”¶é›†å™¨ä¸‹æœ‰æ•ˆã€‚ å¯¹è±¡åŠ¨æ€å¹´é¾„åˆ¤æ–­ å¯¹è±¡åœ¨SurvivoråŒºæ¥å›ç§»åŠ¨æ—¶ï¼Œå¦‚æœè¿™æ‰¹å¯¹è±¡çš„æ€»å¤§å°å¤§äºè¿™å—SurvivoråŒºåŸŸå†…å­˜å¤§å°çš„50%(-XX:TargetSurvivorRatioå¯ä»¥æŒ‡å®š)ï¼Œé‚£ä¹ˆæ­¤æ—¶å¤§äºç­‰äºè¿™æ‰¹å¯¹è±¡å¹´é¾„æœ€å¤§å€¼çš„å¯¹è±¡ï¼Œå°±å¯ä»¥ç›´æ¥è¿›å…¥è€å¹´ä»£äº†ï¼Œ ä¾‹å¦‚SurvivoråŒºåŸŸé‡Œç°åœ¨æœ‰ä¸€æ‰¹å¯¹è±¡ï¼Œå¹´é¾„1+å¹´é¾„2+å¹´é¾„nçš„å¤šä¸ªå¹´é¾„å¯¹è±¡æ€»å’Œè¶…è¿‡äº†SurvivoråŒºåŸŸçš„50%ï¼Œæ­¤æ—¶å°±ä¼šæŠŠå¹´é¾„n(å«)ä»¥ä¸Šçš„å¯¹è±¡éƒ½æ”¾å…¥è€å¹´ä»£ã€‚è¿™ä¸ªè§„åˆ™å…¶å®æ˜¯å¸Œæœ›é‚£äº›å¯èƒ½æ˜¯é•¿æœŸå­˜æ´»çš„å¯¹è±¡ï¼Œå°½æ—©è¿›å…¥è€å¹´ä»£ã€‚ å¯¹è±¡åŠ¨æ€å¹´é¾„åˆ¤æ–­æœºåˆ¶ä¸€èˆ¬æ˜¯åœ¨minor gcä¹‹åè§¦å‘çš„ã€‚ å¯¹è±¡é€ƒé€¸åˆ†æ å¦‚æœå¯¹è±¡å¾ˆå°ï¼Œä¸”åªåœ¨æ–¹æ³•å†…éƒ¨ä½¿ç”¨ï¼Œå¹¶æ²¡æœ‰è¢«å¤–éƒ¨å¼•ç”¨ï¼Œåˆ™å…¶æœ‰å¯èƒ½ç›´æ¥åˆ†é…åˆ°æ ˆå†…å­˜ï¼Œè€Œä¸è¿›å…¥å †å†…å­˜ JVMå¯¹äºè¿™ç§æƒ…å†µå¯ä»¥é€šè¿‡å¼€å¯é€ƒé€¸åˆ†æå‚æ•°(-XX:+DoEscapeAnalysis)æ¥ä¼˜åŒ–å¯¹è±¡å†…å­˜åˆ†é…ä½ç½®ï¼Œä½¿å…¶é€šè¿‡æ ‡é‡æ›¿æ¢ä¼˜å…ˆåˆ†é…åœ¨æ ˆä¸Š(æ ˆä¸Šåˆ†é…)ï¼ŒJDK7ä¹‹åé»˜è®¤å¼€å¯é€ƒé€¸åˆ†æï¼Œå¦‚æœè¦å…³é—­ä½¿ç”¨å‚æ•°(-XX:-DoEscapeAnalysis) æ ‡é‡æ›¿æ¢ é€šè¿‡é€ƒé€¸åˆ†æç¡®å®šè¯¥å¯¹è±¡ä¸ä¼šè¢«å¤–éƒ¨è®¿é—®ï¼Œå¹¶ä¸”å¯¹è±¡å¯ä»¥è¢«è¿›ä¸€æ­¥åˆ†è§£æ—¶ï¼ŒJVMä¸ä¼šåˆ›å»ºè¯¥å¯¹è±¡ï¼Œè€Œæ˜¯å°†è¯¥å¯¹è±¡æˆå‘˜å˜é‡åˆ†è§£è‹¥å¹²ä¸ªè¢«è¿™ä¸ªæ–¹æ³•ä½¿ç”¨çš„æˆå‘˜å˜é‡æ‰€ä»£æ›¿ï¼Œè¿™äº›ä»£æ›¿çš„æˆå‘˜å˜é‡åœ¨æ ˆå¸§æˆ–å¯„å­˜å™¨ä¸Šåˆ†é…ç©ºé—´ï¼Œè¿™æ ·å°±ä¸ä¼šå› ä¸ºæ²¡æœ‰ä¸€å¤§å—è¿ç»­ç©ºé—´å¯¼è‡´å¯¹è±¡å†…å­˜ä¸å¤Ÿåˆ†é…ã€‚ å¼€å¯æ ‡é‡æ›¿æ¢å‚æ•°(-XX:+EliminateAllocations)ï¼ŒJDK7ä¹‹åé»˜è®¤å¼€å¯ã€‚ æ ‡é‡ä¸èšåˆé‡ æ ‡é‡å³ä¸å¯è¢«è¿›ä¸€æ­¥åˆ†è§£çš„é‡ï¼Œè€ŒJAVAçš„åŸºæœ¬æ•°æ®ç±»å‹å°±æ˜¯æ ‡é‡ï¼ˆå¦‚ï¼šintï¼Œlongç­‰åŸºæœ¬æ•°æ®ç±»å‹ä»¥åŠreferenceç±»å‹ç­‰ï¼‰ï¼Œ æ ‡é‡çš„å¯¹ç«‹å°±æ˜¯å¯ä»¥è¢«è¿›ä¸€æ­¥åˆ†è§£çš„é‡ï¼Œè€Œè¿™ç§é‡ç§°ä¹‹ä¸ºèšåˆé‡ã€‚è€Œåœ¨JAVAä¸­å¯¹è±¡å°±æ˜¯å¯ä»¥è¢«è¿›ä¸€æ­¥åˆ†è§£çš„èšåˆé‡ã€‚ Parallel åƒåœ¾å›æ”¶å™¨ï¼ˆParallel GCï¼‰ çš„å·¥ä½œæ–¹å¼ Parallel GC æ˜¯å¤šçº¿ç¨‹åƒåœ¾å›æ”¶å™¨ï¼Œå¯ä»¥é€šè¿‡ -XX:ParallelGCThreads æ¥è®¾ç½®GCçº¿ç¨‹æ•°é‡ã€‚ å½“ Parallel GC è¢«è§¦å‘ï¼ˆä¾‹å¦‚ Minor GC æˆ– Full GCï¼‰æ—¶ï¼Œæ‰€æœ‰ç”¨æˆ·çº¿ç¨‹ è¢«å®Œå…¨æš‚åœï¼ˆStop-The-World, STWï¼‰ Parallel GC å‚æ•°é…ç½®è¡¨ï¼ˆååé‡ä¼˜å…ˆ GCï¼‰ å‚æ•°å è¯´æ˜ é»˜è®¤å€¼ï¼ˆå¦‚æœªç‰¹åˆ«è¯´æ˜ï¼‰ -XX:+UseParallelGC å¼€å¯ Parallel GCï¼Œç”¨äºæ–°ç”Ÿä»£æ”¶é›† - -XX:+UseParallelOldGC å¼€å¯è€å¹´ä»£å¹¶è¡Œæ”¶é›†ï¼ˆParallel Oldï¼‰ - -XX:ParallelGCThreads åƒåœ¾å›æ”¶æ—¶çš„å¹¶è¡Œçº¿ç¨‹æ•°ï¼ˆä¸ CPU æ•°é‡ç›¸å…³ï¼‰ æ ¹æ®ç¡¬ä»¶è‡ªåŠ¨é…ç½® -XX:MaxGCPauseMillis è®¾ç½® GC æœ€å¤§æš‚åœæ—¶é—´ç›®æ ‡ï¼ˆå½±å“å†…å­˜åˆ†é…ç­–ç•¥ï¼‰ ä¸€ä¸ªéå¸¸å¤§çš„å€¼ï¼Œå¯ä»¥è®¤ä¸ºæ— é™åˆ¶ï¼ˆå»ºè®®æŒ‰éœ€è®¾ç½®ï¼‰ -XX:GCTimeRatio è®¾ç½® GC æ—¶é—´ä¸åº”ç”¨è¿è¡Œæ—¶é—´çš„æ¯”å€¼ï¼ˆ0~100ï¼‰å€¼è¶Šå°ï¼ŒGC è¶Šé¢‘ç¹ï¼Œå€¼è¶Šå¤§ GC è¶Šå°‘ 99ï¼ˆè¡¨ç¤º 1% ç”¨äº GCï¼Œ99% ç”¨äºåº”ç”¨ï¼‰ -XX:+UseAdaptiveSizePolicy å¯ç”¨è‡ªé€‚åº” GC ç­–ç•¥ï¼ˆæ ¹æ®è¿è¡ŒçŠ¶å†µè‡ªåŠ¨è°ƒæ•´å„åŒºåŸŸå¤§å°ï¼‰ é»˜è®¤å¼€å¯ -XX:SurvivorRatio Eden ä¸ Survivor çš„å†…å­˜æ¯”ä¾‹ï¼ˆå¦‚ 8 è¡¨ç¤º Eden:S0:S1 = 8:1:1ï¼‰ 8 -XX:InitialTenuringThreshold å¯¹è±¡æ™‹å‡åˆ°è€å¹´ä»£çš„åˆå§‹å¹´é¾„ï¼ˆä¼šéšè¿è¡ŒåŠ¨æ€è°ƒæ•´ï¼‰ 7 -XX:MaxTenuringThreshold æ™‹å‡åˆ°è€å¹´ä»£çš„æœ€å¤§å¹´é¾„ï¼ˆå¯¹è±¡åœ¨ Survivor åŒºç»å†å‡ æ¬¡ GCï¼‰ 15 -XX:PretenureSizeThreshold è®¾ç½®å¤§å¯¹è±¡é˜ˆå€¼ï¼Œè¶…è¿‡è¯¥å¤§å°çš„å¯¹è±¡ç›´æ¥åˆ†é…åˆ°è€å¹´ä»£ 0ï¼ˆå³ç¦ç”¨ï¼‰ -XX:+ScavengeBeforeFullGC åœ¨ Full GC ä¹‹å‰æ˜¯å¦å…ˆæ‰§è¡Œä¸€æ¬¡ Minor GC trueå¯ -XX:+UseFastAccessorMethods ä¼˜åŒ–åŸå§‹ç±»å‹çš„ get/set æ–¹æ³•æ€§èƒ½ falseå¯ -XX:+AlwaysPreTouch JVM å¯åŠ¨æ—¶ç«‹å³åˆ†é…å¹¶åˆå§‹åŒ–æ‰€æœ‰å†…å­˜é¡µï¼Œé¿å…è¿è¡Œæ—¶é¦–æ¬¡åˆ†é…å¸¦æ¥çš„åœé¡¿ false åˆ†åŒºæ¨¡å‹ G1 åƒåœ¾å›æ”¶å™¨ G1(Garbage-First) å±äº ç‰©ç†ä¸Šåˆ†åŒºï¼Œé€»è¾‘ä¸Šåˆ†ä»£ï¼ŒçœŸæ­£çš„åˆ†åŒºæ¨¡å‹æ˜¯ ZGCï¼ˆjdk21åä¹Ÿæ”¯æŒåˆ†ä»£ï¼‰ G1å°†Javaå †åˆ’åˆ†ä¸ºå¤šä¸ªå¤§å°ç›¸ç­‰çš„Regionï¼ŒRegionå¤§å°æ˜¯2çš„å¹‚ï¼ŒèŒƒå›´åœ¨1MBåˆ°32MBä¹‹é—´ã€‚JDK9ä¹‹å‰é»˜è®¤æœ€å¤šæ”¯æŒ2048ä¸ªRegionï¼Œè¿™å°±å¯¼è‡´G1æœ€å¤§æ”¯æŒ64G çš„å † (2048 Regions Ã— 32MB = 64GB)ï¼ŒJDK10ä¹‹åçš„ç‰ˆæœ¬å¯æ”¯æŒæ›´å¤šRegionæ•°é‡ï¼ŒJDK17è¿›ä¸€æ­¥ä¼˜åŒ–äº†Regionæ˜ å°„æœºåˆ¶ï¼Œæå‡äº†å¤§å †åœºæ™¯ä¸‹çš„æ€§èƒ½ï¼Œä½¿å…¶å¯ä»¥æ”¯æŒæ›´å¤§çš„å†…å­˜ï¼Œä½†å¯¹äºè¶…å¤§å †ï¼ˆ&gt;1Tï¼‰ï¼Œè€ƒè™‘åˆ°GCæš‚åœæ—¶é—´ï¼Œå»ºè®®ä½¿ç”¨ZGCæˆ–Shenandoah GCã€‚ Regionä¸€æ—¦è¢«å›æ”¶ï¼Œé‡æ–°åˆ†é…æ—¶å¯ä»¥æ˜¯ä»»æ„ç±»å‹ï¼Œæ¯”å¦‚åŸå…ˆæ˜¯Edenï¼Œé‚£ä¹ˆé‡æ–°åˆ†é…æ—¶å¯ä»¥æ˜¯Oldï¼Œåä¹‹äº¦ç„¶ã€‚ ä¸€èˆ¬Regionå¤§å°ç”±JVMè‡ªåŠ¨è®¡ç®—ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ç”¨å‚æ•°-XX:G1HeapRegionSizeæ‰‹åŠ¨æŒ‡å®šRegionå¤§å°ï¼Œä½†æ˜¯æ¨èé»˜è®¤çš„è®¡ç®—æ–¹å¼ã€‚ G1ä¿ç•™äº†å¹´è½»ä»£å’Œè€å¹´ä»£çš„æ¦‚å¿µï¼Œä½†ä¸å†æ˜¯ç‰©ç†éš”é˜‚äº†ï¼Œå®ƒä»¬éƒ½æ˜¯ï¼ˆå¯ä»¥ä¸è¿ç»­ï¼‰Regionçš„é›†åˆã€‚ åœ¨ G1 GC ä¸­ï¼Œä¸è¦ä½¿ç”¨ -Xmnï¼ŒG1 ä¸­æ¨èä½¿ç”¨ä»¥ä¸‹æ›´ç»†ç²’åº¦çš„æ§åˆ¶æ–¹å¼ï¼š 123# è¿™æ˜¯å®éªŒæ€§å‚æ•°ï¼Œéœ€è¦å¼€å¯ `-XX:+UnlockExperimentalVMOptions`ï¼Œä½†ä¾æ—§æ¨èåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨-XX:G1NewSizePercent=5-XX:G1MaxNewSizePercent=60 é»˜è®¤å¹´è½»ä»£å¯¹å †å†…å­˜çš„å æ¯”æ˜¯5%ï¼Œå¦‚æœå †å¤§å°ä¸º4096Mï¼Œé‚£ä¹ˆå¹´è½»ä»£å æ®200MBå·¦å³çš„å†…å­˜ï¼Œå¯¹åº”å¤§æ¦‚æ˜¯100ä¸ªRegionï¼Œå¯ä»¥é€šè¿‡ -XX:G1NewSizePercentè®¾ç½®æ–°ç”Ÿä»£åˆå§‹å æ¯”ï¼Œè¿™æ˜¯å®éªŒæ€§å‚æ•°ï¼Œéœ€è¦å¼€å¯ -XX:+UnlockExperimentalVMOptionsï¼Œä½†ä¾æ—§æ¨èåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ã€‚ åœ¨ç³»ç»Ÿè¿è¡Œä¸­ï¼ŒJVMä¼šä¸åœçš„ç»™å¹´è½»ä»£å¢åŠ æ›´å¤šçš„Regionï¼Œä½†æ˜¯æœ€å¤šæ–°ç”Ÿä»£çš„å æ¯”ä¸ä¼šè¶…è¿‡60%ï¼Œå¯ä»¥é€šè¿‡-XX:G1MaxNewSizePercentè°ƒæ•´ï¼Œè¿™æ˜¯å®éªŒæ€§å‚æ•°ï¼Œéœ€è¦å¼€å¯ -XX:+UnlockExperimentalVMOptionsï¼Œä½†ä¾æ—§æ¨èåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ã€‚ å¹´è½»ä»£ä¸­çš„Edenå’ŒSurvivorå¯¹åº”çš„regionä¹Ÿè·Ÿä¹‹å‰ä¸€æ ·ï¼Œé»˜è®¤8:1:1ï¼Œå‡è®¾å¹´è½»ä»£ç°åœ¨æœ‰1000ä¸ªregionï¼ŒedenåŒºå¯¹åº”800ä¸ªï¼Œs0å¯¹åº”100ä¸ªï¼Œs1å¯¹åº”100ä¸ªã€‚ ä¸€ä¸ªRegionå¯èƒ½ä¹‹å‰æ˜¯å¹´è½»ä»£ï¼Œå¦‚æœRegionè¿›è¡Œäº†åƒåœ¾å›æ”¶ï¼Œä¹‹åå¯èƒ½åˆä¼šå˜æˆè€å¹´ä»£ï¼Œä¹Ÿå°±æ˜¯è¯´Regionçš„åŒºåŸŸåŠŸèƒ½å¯èƒ½ä¼šåŠ¨æ€å˜åŒ–ã€‚ G1åƒåœ¾æ”¶é›†å™¨å¯¹äºå¯¹è±¡ä»€ä¹ˆæ—¶å€™ä¼šè½¬ç§»åˆ°è€å¹´ä»£è·Ÿä¹‹å‰è®²è¿‡çš„åŸåˆ™ä¸€æ ·ï¼Œå”¯ä¸€ä¸åŒçš„æ˜¯å¯¹å¤§å¯¹è±¡çš„å¤„ç†ï¼ŒG1æœ‰ä¸“é—¨åˆ†é…å¤§å¯¹è±¡çš„Regionå«HumongousåŒºï¼Œè€Œä¸æ˜¯è®©å¤§å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£çš„Regionä¸­ã€‚ åœ¨G1ä¸­ï¼Œå¤§å¯¹è±¡çš„åˆ¤å®šè§„åˆ™å°±æ˜¯ä¸€ä¸ªå¤§å¯¹è±¡è¶…è¿‡äº†ä¸€ä¸ªRegionå¤§å°çš„50%ï¼Œæ¯”å¦‚æŒ‰ç…§ä¸Šé¢ç®—çš„ï¼Œæ¯ä¸ªRegionæ˜¯2Mï¼Œåªè¦ä¸€ä¸ªå¤§å¯¹è±¡è¶…è¿‡äº†1Mï¼Œå°±ä¼šè¢«æ”¾å…¥Humongousä¸­ï¼Œè€Œä¸”ä¸€ä¸ªå¤§å¯¹è±¡å¦‚æœå¤ªå¤§ï¼Œå¯èƒ½ä¼šæ¨ªè·¨å¤šä¸ªRegionæ¥å­˜æ”¾ã€‚ HumongousåŒºä¸“é—¨å­˜æ”¾çŸ­æœŸå·¨å‹å¯¹è±¡ï¼Œä¸ç”¨ç›´æ¥è¿›è€å¹´ä»£ï¼Œå¯ä»¥èŠ‚çº¦è€å¹´ä»£çš„ç©ºé—´ï¼Œé¿å…å› ä¸ºè€å¹´ä»£ç©ºé—´ä¸å¤Ÿçš„GCå¼€é”€ã€‚ Full GCçš„æ—¶å€™é™¤äº†æ”¶é›†å¹´è½»ä»£å’Œè€å¹´ä»£ä¹‹å¤–ï¼Œä¹Ÿä¼šå°†HumongousåŒºä¸€å¹¶å›æ”¶ã€‚ G1åƒåœ¾æ”¶é›†åˆ†ç±» YoungGC YoungGCå¹¶ä¸æ˜¯è¯´ç°æœ‰çš„EdenåŒºæ”¾æ»¡äº†å°±ä¼šé©¬ä¸Šè§¦å‘ï¼ŒG1ä¼šè®¡ç®—ä¸‹ç°åœ¨EdenåŒºå›æ”¶å¤§æ¦‚è¦å¤šä¹…æ—¶é—´ï¼Œå¦‚æœå›æ”¶æ—¶é—´è¿œè¿œå°äºå‚æ•° -XX:MaxGCPauseMills è®¾å®šçš„å€¼ï¼Œé‚£ä¹ˆå¢åŠ å¹´è½»ä»£çš„regionï¼Œç»§ç»­ç»™æ–°å¯¹è±¡å­˜æ”¾ï¼Œä¸ä¼šé©¬ä¸ŠåšYoungGCï¼Œç›´åˆ°ä¸‹ä¸€æ¬¡EdenåŒºæ”¾æ»¡ï¼ŒG1è®¡ç®—å›æ”¶æ—¶é—´æ¥è¿‘å‚æ•° -XX:MaxGCPauseMills è®¾å®šçš„å€¼ï¼Œé‚£ä¹ˆå°±ä¼šè§¦å‘Young GC MixedGC ä¸æ˜¯FullGCï¼Œè€å¹´ä»£çš„å †å æœ‰ç‡è¾¾åˆ°å‚æ•° -XX:InitiatingHeapOccupancyPercent è®¾å®šçš„å€¼åˆ™è§¦å‘ï¼Œå›æ”¶æ‰€æœ‰çš„Youngå’Œéƒ¨åˆ†Old(æ ¹æ®æœŸæœ›çš„GCåœé¡¿æ—¶é—´ç¡®å®šoldåŒºåƒåœ¾æ”¶é›†çš„ä¼˜å…ˆé¡ºåº)ä»¥åŠå¤§å¯¹è±¡åŒºï¼Œæ­£å¸¸æƒ…å†µG1çš„åƒåœ¾æ”¶é›†æ˜¯å…ˆåšMixedGCï¼Œä¸»è¦ä½¿ç”¨å¤åˆ¶ç®—æ³•ï¼Œéœ€è¦æŠŠå„ä¸ªregionä¸­å­˜æ´»çš„å¯¹è±¡æ‹·è´åˆ°åˆ«çš„regioné‡Œå»ï¼Œæ‹·è´è¿‡ç¨‹ä¸­å¦‚æœå‘ç°æ²¡æœ‰è¶³å¤Ÿçš„ç©ºregionèƒ½å¤Ÿæ‰¿è½½æ‹·è´å¯¹è±¡å°±ä¼šè§¦å‘ä¸€æ¬¡Full GC Full GC åœæ­¢ç³»ç»Ÿç¨‹åºï¼Œç„¶åé‡‡ç”¨å•çº¿ç¨‹è¿›è¡Œæ ‡è®°ã€æ¸…ç†å’Œå‹ç¼©æ•´ç†ï¼Œå¥½ç©ºé—²å‡ºæ¥ä¸€æ‰¹Regionæ¥ä¾›ä¸‹ä¸€æ¬¡MixedGCä½¿ç”¨ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯éå¸¸è€—æ—¶çš„ã€‚(Shenandoahä¼˜åŒ–æˆå¤šçº¿ç¨‹æ”¶é›†äº†) G1 æ”¶é›†å™¨çš„å·¥ä½œæ–¹å¼(MixedGC) å›¾ä¸­ä¸»è¦å±•ç¤ºäº†ä¸€ä¸ªå…¸å‹çš„ G1 GC çš„ å¹¶å‘æ ‡è®°å‘¨æœŸï¼ˆConcurrent Mark Cycleï¼‰ çš„è¿‡ç¨‹ã€‚ å›¾ä¸­çš„æ°´å¹³ç®­å¤´è¡¨ç¤ºå„çº¿ç¨‹ï¼ˆç”¨æˆ·çº¿ç¨‹å’ŒGCçº¿ç¨‹ï¼‰çš„æ‰§è¡Œè·¯å¾„ã€‚ ç«–ç›´çš„Safepointçº¿è¡¨ç¤ºä¸€æ¬¡GCè¿‡ç¨‹ä¸­ä¼šæš‚åœæ‰€æœ‰ç”¨æˆ·çº¿ç¨‹çš„æ—¶åˆ»ï¼ˆStop-The-Worldï¼‰ã€‚ 12345678910111213141516171819202122231ï¸âƒ£ åˆå§‹æ ‡è®°ï¼ˆInitial Markï¼‰ è¿›å…¥ Safepointï¼š æ‰€æœ‰ç”¨æˆ·çº¿ç¨‹åœ¨æ­¤åˆ»æš‚åœï¼ˆSTWï¼‰ã€‚ æ ‡è®° GC Roots ç›´æ¥å¯è¾¾å¯¹è±¡ã€‚ éå¸¸çŸ­æš‚ï¼Œä½†å±äº Stop-The-World é˜¶æ®µã€‚ å›¾ä¸­æ˜¯â€œåˆå§‹æ ‡è®°â€ç®­å¤´åœ¨ Safepoint ä¹‹åç«‹åˆ»æ‰§è¡Œã€‚2ï¸âƒ£ å¹¶å‘æ ‡è®°ï¼ˆConcurrent Markï¼‰ ç”¨æˆ·çº¿ç¨‹ æ¢å¤è¿è¡Œï¼ˆå›¾ä¸­ç”¨æˆ·çº¿ç¨‹ç»§ç»­å‘å³å»¶ä¼¸ï¼‰ã€‚ GC çº¿ç¨‹ å¹¶å‘è¿›è¡Œæ ‡è®°å·¥ä½œï¼ˆå³åœ¨ç”¨æˆ·çº¿ç¨‹è¿è¡ŒæœŸé—´è¿›è¡Œæ ‡è®°ï¼‰ã€‚ å›¾ä¸­è“è‰²çš„â€œå¹¶å‘æ ‡è®°â€ç®­å¤´ä¸ç”¨æˆ·çº¿ç¨‹ç®­å¤´å¹¶è¡Œæ˜¾ç¤ºï¼Œè¡¨ç¤ºå¹¶å‘æ‰§è¡Œã€‚3ï¸âƒ£ æœ€ç»ˆæ ‡è®°ï¼ˆRemark / Final Markï¼‰ å†æ¬¡è¿›å…¥ Safepointã€‚ é‡æ–°æš‚åœæ‰€æœ‰ç”¨æˆ·çº¿ç¨‹ã€‚ å¤„ç†å¹¶å‘æ ‡è®°é˜¶æ®µä¸­é—æ¼çš„å¼•ç”¨æ›´æ–°ç­‰ä¿¡æ¯ï¼Œä¿è¯æ ‡è®°çš„å‡†ç¡®æ€§ã€‚4ï¸âƒ£ ç­›é€‰å›æ”¶ï¼ˆCleanup / Filtered Collectionï¼‰ å¯¹å·²æ ‡è®°çš„å¯¹è±¡åšæ¸…ç†ï¼ˆå›æ”¶ä¸å¯è¾¾å¯¹è±¡ï¼‰ã€‚ åˆ¤æ–­æ˜¯å¦éœ€è¦å›æ”¶æŸäº› Regionã€‚ å›¾ä¸­è“è‰²ç®­å¤´æ ‡æ³¨ä¸ºâ€œç­›é€‰å›æ”¶â€ã€‚5ï¸âƒ£ æ¢å¤ç”¨æˆ·çº¿ç¨‹ åœ¨æœ€åä¸€ä¸ª Safepoint ä¹‹åï¼Œæ‰€æœ‰ç”¨æˆ·çº¿ç¨‹é‡æ–°å¼€å§‹æ‰§è¡Œï¼ˆå›¾ä¸­é»„è‰²ç®­å¤´é‡æ–°å‘å³å»¶ä¼¸ï¼‰ã€‚ G1çš„GC è¿‡ç¨‹ä¼šç»å†å¤šæ¬¡Safepointï¼Œä½†åªæœ‰ å¹¶å‘æ ‡è®°é˜¶æ®µ æ˜¯æ•´ä¸ªå‘¨æœŸä¸­æœ€è€—æ—¶ä½†ä¸ä¼šæš‚åœç”¨æˆ·çº¿ç¨‹(STW)çš„éƒ¨åˆ†ã€‚ Safepointï¼ˆå®‰å…¨ç‚¹ï¼‰ åœ¨ JVMï¼ˆJava è™šæ‹Ÿæœºï¼‰ä¸­ï¼ŒSafepointï¼ˆå®‰å…¨ç‚¹ï¼‰ æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„æ¦‚å¿µï¼Œå®ƒä»£è¡¨ æ‰€æœ‰çº¿ç¨‹å¿…é¡»â€œå®‰å…¨åœ°â€æš‚åœçš„æŸä¸ªæ—¶é—´ç‚¹ï¼Œä»¥ä¾¿ JVM èƒ½å¤Ÿæ‰§è¡ŒæŸäº›å…¨å±€æ“ä½œï¼Œæ¯”å¦‚ï¼š åƒåœ¾å›æ”¶ï¼ˆGCï¼‰ æ ˆéå†ï¼ˆä¾‹å¦‚ç”Ÿæˆå †å¿«ç…§ã€åšé€ƒé€¸åˆ†æç­‰ï¼‰ ç±»å¸è½½ JIT ç¼–è¯‘çš„ä¸€äº›é‡å†™æ“ä½œç­‰ å¦‚æœçº¿ç¨‹æ­£åœ¨è¿è¡Œã€æ”¹å˜å †ä¸­å¯¹è±¡çš„æ•°æ®ï¼Œé‚£ä¹ˆ GC å°±æ— æ³•å‡†ç¡®æ ‡è®°å’Œå›æ”¶å¯¹è±¡ã€‚å› æ­¤ JVM éœ€è¦ è®©æ‰€æœ‰çº¿ç¨‹åœ¨ä¸€ä¸ªâ€œå¯æ§ã€å®‰å…¨çš„ä½ç½®â€ä¸Šæš‚åœï¼Œè¿™ä¸ªä½ç½®å°±å« Safepointã€‚ Safepoint æ˜¯æ€ä¹ˆå·¥ä½œçš„ï¼Ÿ 1.JVM å‘å‡ºâ€œè¿›å…¥ Safepointâ€çš„ä¿¡å·ï¼ˆæ¯”å¦‚è¦å¼€å§‹ GCï¼‰ 2.æ‰€æœ‰çº¿ç¨‹æ”¶åˆ°ä¿¡å·åï¼Œå¿…é¡»ç­‰åˆ°â€œæœ€è¿‘çš„ Safepointâ€å†åœä¸‹æ¥ï¼š Safepoint ä¸æ˜¯ä»»æ„ä½ç½®éƒ½å¯ä»¥åœï¼Œå®ƒåªå‡ºç°åœ¨å­—èŠ‚ç ä¸­ä¸€äº›ç‰¹å®šçš„æŒ‡ä»¤ç‚¹ï¼ˆæ¯”å¦‚æ–¹æ³•è°ƒç”¨ã€å¾ªç¯è·³è½¬ç­‰ï¼‰ 3.ç­‰æ‰€æœ‰çº¿ç¨‹éƒ½è¿›å…¥ Safepoint åï¼ŒJVM æ‰èƒ½å¼€å§‹æ‰§è¡Œ GC ç­‰å…¨å±€æ“ä½œã€‚ G1 æ”¶é›†å™¨å‚æ•°é…ç½®è¡¨ å‚æ•°å è¯´æ˜ é»˜è®¤å€¼ -XX:+UseG1GC ä½¿ç”¨ G1 åƒåœ¾æ”¶é›†å™¨ - -XX:ParallelGCThreads æŒ‡å®š GC å·¥ä½œçš„çº¿ç¨‹æ•°é‡ ä¸ CPU æ•°é‡ç›¸å…³ -XX:G1HeapRegionSize è®¾ç½®å †åˆ†åŒºå¤§å°ï¼ˆ1MB~32MBï¼Œ2 çš„å¹‚ï¼‰ï¼Œå †é»˜è®¤åˆ’åˆ†ä¸º 2048 ä¸ª Region è‡ªåŠ¨è®¡ç®— -XX:MaxGCPauseMillis è®¾ç½® GC ç›®æ ‡æœ€å¤§æš‚åœæ—¶é—´ 200ms -XX:G1NewSizePercent æ–°ç”Ÿä»£åˆå§‹å æ¯”ï¼ˆå æ•´ä¸ªå †ï¼‰ï¼Œå®éªŒæ€§å‚æ•°ï¼Œ-XX:+UnlockExperimentalVMOptions 5% -XX:G1MaxNewSizePercent æ–°ç”Ÿä»£æœ€å¤§å æ¯”ï¼ˆå æ•´ä¸ªå †ï¼‰ï¼Œå®éªŒæ€§å‚æ•°ï¼Œ-XX:+UnlockExperimentalVMOptions 60% -XX:TargetSurvivorRatio Survivor åŒºå¡«å……ç›®æ ‡ï¼ˆè¶…è¿‡è¯¥æ¯”ä¾‹ï¼Œæ™‹å‡è€å¹´ä»£ï¼‰ 50% -XX:MaxTenuringThreshold æœ€å¤§å¯¹è±¡å¹´é¾„é˜ˆå€¼ï¼ˆå¹´é¾„è¶…è¿‡å°†è¿›å…¥è€å¹´ä»£ï¼‰ 15 -XX:InitiatingHeapOccupancyPercent è€å¹´ä»£çš„ä½¿ç”¨ç‡è¶…è¿‡è¯¥å€¼è§¦å‘ Mixed GC 45% -XX:G1MixedGCLiveThresholdPercent Mixed GC ä¸­ï¼šRegion å­˜æ´»å¯¹è±¡å æ¯”ä½äºè¯¥å€¼æ‰ä¼šè¢«å›æ”¶ï¼Œå®éªŒæ€§å‚æ•°ï¼Œ-XX:+UnlockExperimentalVMOptions 85% -XX:G1HeapWastePercent Mixed GC å›æ”¶ç›®æ ‡ï¼šç©ºé—² Region è¾¾å †æ€»é‡è¯¥ç™¾åˆ†æ¯”å°±ç»“æŸæ··åˆå›æ”¶ 5% -XX:G1ReservePercent ä¸ºæ»¡è¶³åœé¡¿æ—¶é—´ç›®æ ‡ä¿ç•™çš„å †ç©ºé—´æ¯”ä¾‹ï¼Œæ˜¯ä¸€ç§ç©ºé—´æ¢æ—¶é—´çš„ç­–ç•¥ï¼Œåœ¨å†…å­˜ä¸è¶³æ—¶å¯èƒ½é€ æˆå†…å­˜æ›´åŠ ç´§å¼  10% -XX:G1UseAdaptiveIHOP æ˜¯å¦å¯ç”¨è‡ªé€‚åº”IHOPï¼Œå¯ç”¨åG1ä¼šåœ¨åˆå§‹é‡‡æ ·åè‡ªåŠ¨è°ƒæ•´IHOPå€¼ true -XX:G1AdaptiveIHOPNumInitialSamples æŒ‡å®šå‰å‡ æ¬¡GCæ´»åŠ¨æŒ‰IHOPå‚æ•°è®¡ç®— 3 -XX:SoftRefLRUPolicyMSPerMB æ¯MBå †å†…å­˜ä¸­è½¯å¼•ç”¨çš„è¿‡æœŸæ—¶é—´(ms) 1000 -XX:G1OldCSetRegionThresholdPercent è®¾ç½®ä¸€æ¬¡æ··åˆGCä¸­éœ€è¦æ¸…ç†çš„OldåŒºçš„å†…å­˜æ¯”ä¾‹ï¼Œè°ƒå¤§å¯é™ä½G1é¢‘ç‡ä½†ä¼šå¢åŠ æ¯æ¬¡GCæ—¶é—´ 10% -XX:G1MixedGCCountTarget è®¾ç½®G1åƒåœ¾å›æ”¶å™¨çš„çº¿ç¨‹ä¸Šé™ï¼ŒHotSpotä¼šæ ¹æ®æ¸…ç†ç›®æ ‡è‡ªåŠ¨è®¡ç®—æ‰€éœ€çº¿ç¨‹æ•°ï¼Œä½†ä¸ä¼šè¶…è¿‡æ­¤ä¸Šé™ 8 ZGC åƒåœ¾å›æ”¶å™¨ ZGC(Z Garbage Collector)æ˜¯ä¸€æ¬¾JDK 11ä¸­æ–°åŠ å…¥çš„å…·æœ‰å®éªŒæ€§è´¨çš„ä½å»¶è¿Ÿåƒåœ¾æ”¶é›†å™¨ï¼ŒZGCå¯ä»¥è¯´æºè‡ªäºæ˜¯Azul Systemå…¬å¸å¼€å‘çš„C4ï¼ˆConcurrent Continuously Compacting Collectorï¼‰ æ”¶é›†å™¨ Platform Supported Since Comment Linux/x64 âœ… JDK 11 Linux/AArch64 âœ… JDK 13 macOS âœ… JDK 14 Windows âœ… JDK 14 Requires Windows version 1803 (Windows 10 or Windows Server 2019) or later. ZGCæ”¶é›†å™¨æ˜¯ä¸€æ¬¾åŸºäºRegionå†…å­˜å¸ƒå±€çš„ï¼Œæš‚æ—¶ä¸è®¾åˆ†ä»£çš„(jdk21åæ”¯æŒåˆ†ä»£)ï¼Œä½¿ç”¨äº†è¯»å±éšœã€é¢œè‰²æŒ‡é’ˆç­‰æŠ€æœ¯æ¥å®ç°å¯å¹¶å‘çš„æ ‡è®°-æ•´ç†ç®—æ³•çš„ï¼Œä»¥ä½å»¶è¿Ÿä¸ºé¦–è¦ç›®æ ‡çš„ä¸€æ¬¾åƒåœ¾æ”¶é›†å™¨ã€‚ é¢œè‰²æŒ‡é’ˆ åœ¨ ZGCï¼ˆZ Garbage Collectorï¼‰ä¸­ï¼Œé¢œè‰²æŒ‡é’ˆï¼ˆColored Pointerï¼‰æ˜¯ä¸€ç§æ ¸å¿ƒæœºåˆ¶ï¼ŒæŠŠå¯¹è±¡çš„ GC çŠ¶æ€ä¿¡æ¯ç›´æ¥åµŒå…¥åˆ°å¯¹è±¡çš„å¼•ç”¨ï¼ˆåœ°å€ï¼‰ä¸­ï¼Œç”¨äºåœ¨ä¸å¢åŠ å¯¹è±¡é¢å¤–å…ƒæ•°æ®çš„å‰æä¸‹ï¼Œè·Ÿè¸ªå¯¹è±¡åœ¨åƒåœ¾å›æ”¶è¿‡ç¨‹ä¸­çš„çŠ¶æ€ã€‚ åœ¨ä¼ ç»Ÿ GC ä¸­ï¼Œå¯¹è±¡çš„â€œé¢œè‰²â€ï¼ˆå¦‚ç™½è‰²ã€ç°è‰²ã€é»‘è‰²ï¼‰è¡¨ç¤ºå…¶åœ¨ GC ä¸åŒé˜¶æ®µçš„çŠ¶æ€ï¼Œè¿™äº›ä¿¡æ¯ä¸€èˆ¬å­˜å‚¨åœ¨é¢å¤–çš„æ•°æ®ç»“æ„ä¸­ï¼ˆå¦‚è®°å¿†é›†åˆã€ä½å›¾ç­‰ï¼‰ã€‚ è€Œåœ¨ ZGC ä¸­ï¼ŒZGC å°†å¯¹è±¡çš„è¿™äº›çŠ¶æ€ä¿¡æ¯ç¼–ç è¿›æŒ‡é’ˆçš„é«˜ä½ä¸­ã€‚æ‰€ä»¥ä¸€ä¸ªå¯¹è±¡å¼•ç”¨ï¼ˆpointerï¼‰ä¸ä»…ä»…æ˜¯å†…å­˜åœ°å€ï¼Œè¿˜æºå¸¦äº†å¯¹è±¡åœ¨ GC è¿‡ç¨‹ä¸­çš„â€œé¢œè‰²â€ä¿¡æ¯ã€‚ ZGC ä¸»è¦è¿è¡Œåœ¨ 64 ä½ç³»ç»Ÿä¸Šï¼Œä½†å½“å‰çš„æ“ä½œç³»ç»Ÿå’Œ CPU å®é™…ä¸Šåªä½¿ç”¨ 48ï½57 ä½è™šæ‹Ÿåœ°å€ã€‚ZGC åˆ©ç”¨æœªä½¿ç”¨çš„é«˜ä½è¿›è¡Œç¼–ç ã€‚ æ¯ä¸ªå¯¹è±¡æœ‰ä¸€ä¸ª64ä½æŒ‡é’ˆï¼Œè¿™64ä½è¢«åˆ†ä¸ºï¼š ä½æ•° åç§° å«ä¹‰ 18 ä½ é¢„ç•™ ä¿ç•™ä½ï¼Œæœªæ¥å¯èƒ½ç”¨äºæ‰©å±•åŠŸèƒ½ 1 ä½ Finalizable è¡¨ç¤ºå¯¹è±¡å¯ç»ˆç»“ï¼ˆå³å®ç°äº† finalize() æ–¹æ³•ï¼‰ 1 ä½ Remapped æ ‡è¯†å¯¹è±¡æ˜¯å¦å·²è¢«è½¬ç§»(ç”¨äºæ ‡è¯†æŸä¸ªå¼•ç”¨æ˜¯å¦å·²ç»è¢«é‡å®šå‘ï¼ˆæ›´æ–°ä¸ºæ–°åœ°å€ï¼‰)ï¼›ä¸º 1 è¡¨ç¤ºè¯¥å¯¹è±¡æœªåœ¨é‡å®šä½é›†ï¼ˆRelocation Setï¼‰ä¸­ï¼Œå³æ–°åœ°å€ï¼Œä¸º0è¡¨ç¤ºæ—§åœ°å€ 1 ä½ Marked1 æ ‡è®°ä½ä¹‹ä¸€ï¼Œç”¨äº GC è¿‡ç¨‹ä¸­çš„å¯¹è±¡æ ‡è®°é˜¶æ®µ ,ç”±äº ZGC æ˜¯å¹¶å‘ GCï¼Œéœ€è¦ä¸¤ä½æ¥æ”¯æŒé¢œè‰²åˆ‡æ¢æœºåˆ¶ï¼ˆColor Flipï¼‰ï¼Œç¡®ä¿åœ¨ä¸åŒ GC å‘¨æœŸä¸­å¯ä»¥åŒºåˆ†æ–°æ—§æ ‡è®°ï¼Œéœ€è¦è§¦å‘ä¸€æ¬¡è¯»å–å±éšœï¼ˆload barrierï¼‰ï¼Œæ‰¾åˆ°å¯¹è±¡çš„æ–°ä½ç½®ï¼Œå¹¶æ›´æ–°è¿™ä¸ªå¼•ç”¨ã€‚ 1 ä½ Marked0 å¦ä¸€ä¸ªæ ‡è®°ä½ï¼Œä¸ Marked1 é…åˆç”¨äº GC æ ‡è®°é˜¶æ®µ 42 ä½ å¯¹è±¡åœ°å€éƒ¨åˆ† å®é™…çš„å†…å­˜åœ°å€éƒ¨åˆ†ï¼Œæœ€å¤šå¯è¡¨ç¤º 2^42 å­—èŠ‚ï¼ˆå³ 4 TBï¼‰,jdk15åå ç”¨ 44ä½ï¼Œæ”¯æŒ 16TB è¯»å±éšœ ZGCï¼ˆZ Garbage Collectorï¼‰ä¸­çš„**è¯»å±éšœï¼ˆRead Barrierï¼‰æ˜¯å…¶æ ¸å¿ƒæœºåˆ¶ä¹‹ä¸€ï¼Œå®ƒä¿è¯äº†å¹¶å‘å‹ç¼©ï¼ˆå¯¹è±¡ç§»åŠ¨ï¼‰**æ—¶ç¨‹åºçš„æ­£ç¡®æ€§ï¼Œæ˜¯å®ç°ä½å»¶è¿Ÿã€é«˜å¹¶å‘åƒåœ¾å›æ”¶çš„å…³é”®ã€‚ åœ¨ä¼ ç»Ÿ GC ä¸­ï¼Œå¦‚æœå¯¹è±¡åœ¨ GC è¿‡ç¨‹ä¸­è¢«ç§»åŠ¨ï¼Œç¨‹åºè®¿é—®åˆ°çš„å¯¹è±¡åœ°å€å¯èƒ½å°±æ— æ•ˆäº†ã€‚å› æ­¤ï¼Œéœ€è¦**â€œåœä¸–ç•Œâ€**å°†æ‰€æœ‰å¼•ç”¨æ›´æ–°ã€‚ è€Œ ZGC çš„è®¾è®¡ç›®æ ‡æ˜¯ &lt;10ms çš„ GC åœé¡¿æ—¶é—´ï¼Œæ‰€ä»¥å®ƒé‡‡ç”¨ å¹¶å‘æ ‡è®° + å¹¶å‘ç§»åŠ¨ + å¹¶å‘å¼•ç”¨æ›´æ–° çš„æ¨¡å¼ã€‚åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œå¯¹è±¡å¯ä»¥åœ¨ç¨‹åºè¿è¡Œæ—¶è¢«ç§»åŠ¨ï¼Œä½†ç¨‹åºè®¿é—®æ—¶å¿…é¡»â€œçŸ¥é“â€è¿™ä¸ªå¯¹è±¡æ˜¯å¦å·²ç»è¢«ç§»åŠ¨ï¼Œå¹¶è·å–å…¶æœ€æ–°åœ°å€ï¼Œè¿™å°±æ˜¯è¯»å±éšœçš„èŒè´£ã€‚ è¯»å±éšœæ˜¯ä¸€ç§åœ¨è¯»å–å¯¹è±¡å¼•ç”¨æ—¶è‡ªåŠ¨æ’å…¥çš„é€»è¾‘ï¼Œç”¨äºæ£€æŸ¥å¼•ç”¨æ˜¯å¦æœ‰æ•ˆï¼Œå¹¶åœ¨å¿…è¦æ—¶è¿›è¡Œä¿®æ­£ï¼ˆå³åœ°å€é‡å®šå‘ï¼‰ã€‚ ZGC æ˜¯ç›®å‰å”¯ä¸€åœ¨æ‰€æœ‰å¯¹è±¡è®¿é—®ä¸­éƒ½ä½¿ç”¨è¯»å±éšœçš„ GCï¼Œå®ƒåœ¨æ¯æ¬¡å¯¹è±¡æŒ‡é’ˆè§£å¼•ç”¨æ—¶éƒ½è¿›è¡Œå¦‚ä¸‹æ“ä½œï¼š èŒè´£ è¯´æ˜ æ£€æµ‹å¼•ç”¨æ˜¯å¦æ˜¯è€åœ°å€ åˆ©ç”¨æŒ‡é’ˆä¸­çš„å…ƒä¿¡æ¯ï¼ˆé¢œè‰²æŒ‡é’ˆï¼Œå¦‚ Remapped ä½ï¼‰åˆ¤æ–­å¼•ç”¨æ˜¯å¦å·²ç»è¢«æ›´æ–° å¦‚æœæœªæ›´æ–°åˆ™é‡å®šå‘å¼•ç”¨ å¦‚æœå¼•ç”¨çš„æ˜¯æ—§åœ°å€ï¼Œå±éšœä¼šé€šè¿‡ forwarding table æ‰¾åˆ°æ–°åœ°å€å¹¶æ›´æ–° ä¿è¯æœ€ç»ˆè®¿é—®å¯¹è±¡çš„åœ°å€æ­£ç¡® å³ä½¿åœ¨å¯¹è±¡ç§»åŠ¨è¿‡ç¨‹ä¸­ï¼Œç¨‹åºä¹Ÿæ€»èƒ½è®¿é—®åˆ°æœ‰æ•ˆåœ°å€ï¼Œæ— éœ€åœé¡¿æ‰€æœ‰çº¿ç¨‹ graph TD A[ç¨‹åºè®¿é—®å¯¹è±¡å¼•ç”¨&lt;br&#x2F;&gt;ä¾‹å¦‚ï¼šPerson p &#x3D; personField] --&gt; B[JVM æ’å…¥è¯»å±éšœé€»è¾‘] B --&gt; C[è¯»å±éšœæ£€æŸ¥é¢œè‰²æŒ‡é’ˆä¸­çš„ Remapped ä½] C --&gt; D{Remapped ä½ä¸º 0 å—ï¼Ÿ} D -- æ˜¯ --&gt; E[æ£€æŸ¥å¯¹è±¡æ˜¯å¦å·²è¢«ç§»åŠ¨] E --&gt; F[æ›´æ–°å¼•ç”¨åœ°å€ä¸ºæ–°åœ°å€] F --&gt; G[è®¾ç½® Remapped ä½ä¸º 1] G --&gt; H[ä½¿ç”¨æ›´æ–°åçš„å¼•ç”¨è®¿é—®å¯¹è±¡] D -- å¦ --&gt; I[ç›´æ¥ä½¿ç”¨å½“å‰å¼•ç”¨è®¿é—®å¯¹è±¡] ZGCçš„Regionå¯ä»¥å…·æœ‰å¤§ã€ä¸­ã€å°ä¸‰ç±»å®¹é‡ï¼š å°å‹Regionï¼ˆSmall Regionï¼‰ ï¼š å®¹é‡å›ºå®šä¸º2MBï¼Œç”¨äºæ”¾ç½®å°äº256KBçš„å°å¯¹è±¡ã€‚ ä¸­å‹Regionï¼ˆMedium Regionï¼‰ ï¼š å®¹é‡å›ºå®šä¸º32MBï¼Œç”¨äºæ”¾ç½®å¤§äºç­‰äº256KBä½†å°äº4MBçš„å¯¹è±¡ã€‚ å¤§å‹Regionï¼ˆLarge Regionï¼‰ ï¼š å®¹é‡ä¸å›ºå®šï¼Œå¯ä»¥åŠ¨æ€å˜åŒ–ï¼Œä½†å¿…é¡»ä¸º2MBçš„æ•´æ•°å€ï¼Œç”¨äºæ”¾ç½®4MBæˆ–ä»¥ä¸Šçš„å¤§å¯¹è±¡ã€‚ æ¯ä¸ªå¤§å‹Regionä¸­åªä¼šå­˜æ”¾ä¸€ä¸ªå¤§å¯¹è±¡ï¼Œè¿™ä¹Ÿé¢„ç¤ºç€è™½ç„¶åå­—å«ä½œâ€œå¤§å‹Regionâ€ï¼Œä½†å®ƒçš„å®é™…å®¹é‡å®Œå…¨æœ‰å¯èƒ½å°äºä¸­å‹Regionï¼Œæœ€å°å®¹é‡å¯ä½è‡³4MBã€‚ ZGC ç‰¹ç‚¹ï¼š æ”¯æŒæå¤§å †ï¼ˆJDK 15 èµ·æ”¯æŒæœ€é«˜ 16TBï¼‰ GC åœé¡¿æ—¶é—´é€šå¸¸ä½äº 1msï¼ˆä¸å †å¤§å°åŸºæœ¬æ— å…³ï¼‰ é€‚åˆä½å»¶è¿Ÿã€é«˜ååã€é«˜å¯ç”¨çš„åº”ç”¨åœºæ™¯ï¼Œå¦‚äº¤æ˜“ç³»ç»Ÿã€å¹¿å‘Šæ¨èç­‰ ZGC æ”¶é›†å™¨çš„å·¥ä½œæ–¹å¼ 123456789101112131415161718192021221ï¸âƒ£ å¹¶å‘æ ‡è®°ï¼ˆConcurrent Markï¼‰ï¼š ä¸G1ä¸€æ ·ï¼Œå¹¶å‘æ ‡è®°æ˜¯éå†å¯¹è±¡å›¾åšå¯è¾¾æ€§åˆ†æçš„é˜¶æ®µï¼Œ å®ƒçš„åˆå§‹æ ‡è®°(Mark Start)å’Œæœ€ç»ˆæ ‡è®°(Mark End)ä¹Ÿä¼šå‡ºç°çŸ­æš‚çš„åœé¡¿ï¼Œ ä¸G1ä¸åŒçš„æ˜¯ï¼ŒZGCçš„æ ‡è®°æ˜¯åœ¨æŒ‡é’ˆä¸Šè€Œä¸æ˜¯åœ¨å¯¹è±¡ä¸Šè¿›è¡Œçš„ï¼Œ æ ‡è®°é˜¶æ®µä¼šæ›´æ–°æŸ“è‰²æŒ‡é’ˆä¸­çš„ Marked 0ã€ Marked 1 æ ‡å¿—ä½ã€‚2ï¸âƒ£ å¹¶å‘é¢„å¤‡é‡åˆ†é…ï¼ˆConcurrent Prepare for Relocateï¼‰ï¼š è¿™ä¸ªé˜¶æ®µéœ€è¦æ ¹æ®ç‰¹å®šçš„æŸ¥è¯¢æ¡ä»¶ç»Ÿè®¡å¾—å‡ºæœ¬æ¬¡æ”¶é›†è¿‡ç¨‹è¦æ¸…ç†å“ªäº›Regionï¼Œå°†è¿™äº›Regionç»„æˆé‡åˆ†é…é›†ï¼ˆRelocation Setï¼‰ã€‚ ZGCæ¯æ¬¡å›æ”¶éƒ½ä¼šæ‰«ææ‰€æœ‰çš„Regionï¼Œç”¨èŒƒå›´æ›´å¤§çš„æ‰«ææˆæœ¬æ¢å–çœå»G1ä¸­è®°å¿†é›†çš„ç»´æŠ¤æˆæœ¬ã€‚3ï¸âƒ£ å¹¶å‘é‡åˆ†é…ï¼ˆConcurrent Relocateï¼‰ï¼š é‡åˆ†é…æ˜¯ZGCæ‰§è¡Œè¿‡ç¨‹ä¸­çš„æ ¸å¿ƒé˜¶æ®µï¼Œè¿™ä¸ªè¿‡ç¨‹è¦æŠŠé‡åˆ†é…é›†ä¸­çš„å­˜æ´»å¯¹è±¡å¤åˆ¶åˆ°æ–°çš„Regionä¸Šï¼Œ å¹¶ä¸ºé‡åˆ†é…é›†ä¸­çš„æ¯ä¸ªRegionç»´æŠ¤ä¸€ä¸ªè½¬å‘è¡¨ï¼ˆForward Tableï¼‰ï¼Œè®°å½•ä»æ—§å¯¹è±¡åˆ°æ–°å¯¹è±¡çš„è½¬å‘å…³ç³»ã€‚ ZGCæ”¶é›†å™¨èƒ½ä»…ä»å¼•ç”¨ä¸Šå°±æ˜ç¡®å¾—çŸ¥ä¸€ä¸ªå¯¹è±¡æ˜¯å¦å¤„äºé‡åˆ†é…é›†ä¹‹ä¸­ï¼Œå¦‚æœç”¨æˆ·çº¿ç¨‹æ­¤æ—¶å¹¶å‘è®¿é—®äº†ä½äºé‡åˆ†é…é›†ä¸­çš„å¯¹è±¡ï¼Œ è¿™æ¬¡è®¿é—®å°†ä¼šè¢«é¢„ç½®çš„å†…å­˜å±éšœ(è¯»å±éšœ)æ‰€æˆªè·ï¼Œç„¶åç«‹å³æ ¹æ®Regionä¸Šçš„è½¬å‘è¡¨è®°å½•å°†è®¿é—®è½¬å‘åˆ°æ–°å¤åˆ¶çš„å¯¹è±¡ä¸Šï¼Œ å¹¶åŒæ—¶ä¿®æ­£æ›´æ–°è¯¥å¼•ç”¨çš„å€¼ï¼Œä½¿å…¶ç›´æ¥æŒ‡å‘æ–°å¯¹è±¡ï¼ŒZGCå°†è¿™ç§è¡Œä¸ºç§°ä¸ºæŒ‡é’ˆçš„â€œè‡ªæ„ˆâ€ï¼ˆSelf-Healingï¼‰èƒ½åŠ›ã€‚4ï¸âƒ£ å¹¶å‘é‡æ˜ å°„ï¼ˆConcurrent Remapï¼‰ï¼š é‡æ˜ å°„æ‰€åšçš„å°±æ˜¯ä¿®æ­£æ•´ä¸ªå †ä¸­æŒ‡å‘é‡åˆ†é…é›†ä¸­æ—§å¯¹è±¡çš„æ‰€æœ‰å¼•ç”¨ï¼Œä½†æ˜¯ZGCä¸­å¯¹è±¡å¼•ç”¨å­˜åœ¨â€œè‡ªæ„ˆâ€åŠŸèƒ½ï¼Œæ‰€ä»¥è¿™ä¸ªé‡æ˜ å°„æ“ä½œå¹¶ä¸æ˜¯å¾ˆè¿«åˆ‡ã€‚ ZGCå¾ˆå·§å¦™åœ°æŠŠå¹¶å‘é‡æ˜ å°„é˜¶æ®µï¼ˆConcurrent Remapï¼‰è¦åšçš„å·¥ä½œï¼Œåˆå¹¶åˆ°äº†ä¸‹ä¸€æ¬¡åƒåœ¾æ”¶é›†å¾ªç¯ä¸­çš„å¹¶å‘æ ‡è®°é˜¶æ®µï¼ˆConcurrent Markï¼‰é‡Œå»å®Œæˆï¼Œ åæ­£å®ƒä»¬éƒ½æ˜¯è¦éå†æ‰€æœ‰å¯¹è±¡çš„ï¼Œè¿™æ ·åˆå¹¶å°±èŠ‚çœäº†ä¸€æ¬¡éå†å¯¹è±¡å›¾çš„å¼€é”€ã€‚ ä¸€æ—¦æ‰€æœ‰æŒ‡é’ˆéƒ½è¢«ä¿®æ­£ä¹‹åï¼Œ åŸæ¥è®°å½•æ–°æ—§å¯¹è±¡å…³ç³»çš„è½¬å‘è¡¨å°±å¯ä»¥é‡Šæ”¾æ‰äº†ã€‚ ZGCå­˜åœ¨çš„é—®é¢˜ ZGCæœ€å¤§çš„é—®é¢˜æ˜¯æµ®åŠ¨åƒåœ¾ã€‚ZGCçš„åœé¡¿æ—¶é—´æ˜¯åœ¨10msä»¥ä¸‹ï¼Œä½†æ˜¯ZGCçš„æ‰§è¡Œæ—¶é—´è¿˜æ˜¯è¿œè¿œå¤§äºè¿™ä¸ªæ—¶é—´çš„ã€‚å‡å¦‚ZGCå…¨è¿‡ç¨‹éœ€è¦æ‰§è¡Œ10åˆ†é’Ÿï¼Œåœ¨è¿™ä¸ªæœŸé—´ç”±äºå¯¹è±¡åˆ†é…é€Ÿç‡å¾ˆé«˜ï¼Œå°†åˆ›å»ºå¤§é‡çš„æ–°å¯¹è±¡ï¼Œè¿™äº›å¯¹è±¡å¾ˆéš¾è¿›å…¥å½“æ¬¡GCï¼Œæ‰€ä»¥åªèƒ½åœ¨ä¸‹æ¬¡GCçš„æ—¶å€™è¿›è¡Œå›æ”¶ï¼Œè¿™äº›åªèƒ½ç­‰åˆ°ä¸‹æ¬¡GCæ‰èƒ½å›æ”¶çš„å¯¹è±¡å°±æ˜¯æµ®åŠ¨åƒåœ¾ã€‚ ZGCæ²¡æœ‰åˆ†ä»£æ¦‚å¿µï¼Œæ¯æ¬¡éƒ½éœ€è¦è¿›è¡Œå…¨å †æ‰«æï¼Œå¯¼è‡´ä¸€äº›â€œæœç”Ÿå¤•æ­»â€çš„å¯¹è±¡æ²¡èƒ½åŠæ—¶çš„è¢«å›æ”¶ã€‚ ç›®å‰å”¯ä¸€çš„åŠæ³•æ˜¯å¢å¤§å †çš„å®¹é‡ï¼Œä½¿å¾—ç¨‹åºå¾—åˆ°æ›´å¤šçš„å–˜æ¯æ—¶é—´ï¼Œä½†æ˜¯è¿™ä¸ªä¹Ÿæ˜¯ä¸€ä¸ªæ²»æ ‡ä¸æ²»æœ¬çš„æ–¹æ¡ˆã€‚å¦‚æœéœ€è¦ä»æ ¹æœ¬ä¸Šè§£å†³è¿™ä¸ªé—®é¢˜ï¼Œè¿˜æ˜¯éœ€è¦å¼•å…¥åˆ†ä»£æ”¶é›†ï¼Œè®©æ–°ç”Ÿå¯¹è±¡éƒ½åœ¨ä¸€ä¸ªä¸“é—¨çš„åŒºåŸŸä¸­åˆ›å»ºï¼Œç„¶åä¸“é—¨é’ˆå¯¹è¿™ä¸ªåŒºåŸŸè¿›è¡Œæ›´é¢‘ç¹ã€æ›´å¿«çš„æ”¶é›†ã€‚ JDK21æ­£å¼å¼•å…¥äº†åˆ†ä»£ï¼ˆjdk17æ˜¯é¢„è§ˆç‰ˆï¼‰ï¼Œå¯ä»¥åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ï¼Œéœ€è¦æ‰‹åŠ¨å¼€å¯ï¼š-XX:+ZGenerational ZGC æ”¶é›†å™¨å‚æ•°é…ç½®è¡¨ å‚æ•°å è¯´æ˜ é»˜è®¤å€¼ï¼ˆå¦‚æœªç‰¹æ®Šæ ‡æ³¨ï¼‰ -XX:+UseZGC å¯ç”¨ ZGC åƒåœ¾æ”¶é›†å™¨ - -XX:+UnlockExperimentalVMOptions è§£é”å®éªŒæ€§å‚æ•°ï¼ˆJDK 11~14 ä½¿ç”¨ ZGC å¿…é¡»ï¼‰ - -XX:+UseLargePages å¯ç”¨å¤§é¡µå†…å­˜ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰ false -XX:+UseTransparentHugePages å¯ç”¨é€æ˜å¤§é¡µï¼ˆéƒ¨åˆ† Linux ä¸Šå¯ç»“åˆä½¿ç”¨ï¼‰ false -Xmx / -Xms è®¾ç½®æœ€å¤§/åˆå§‹å †å¤§å° ç”¨æˆ·é…ç½® -XX:ZUncommitDelay=&lt;ç§’&gt; æœªä½¿ç”¨å†…å­˜é‡Šæ”¾å›æ“ä½œç³»ç»Ÿçš„å»¶è¿Ÿæ—¶é—´ï¼ˆZGC ä¼šè‡ªåŠ¨é‡Šæ”¾å†…å­˜ï¼‰ 300ï¼ˆ5åˆ†é’Ÿï¼‰ -XX:SoftMaxHeapSize=&lt;å¤§å°&gt; è½¯æœ€å¤§å †ï¼ˆSoft Heap Limitï¼‰ï¼šZGC å°è¯•å°†ä½¿ç”¨çš„å †æ§åˆ¶åœ¨è¯¥å€¼ä»¥å†… é»˜è®¤ç­‰äº -Xmx -XX:MaxHeapFreeRatio æœ€å¤§å †ç©ºé—²æ¯”ä¾‹ï¼ˆè¶…è¿‡æ­¤æ¯”ä¾‹å¯èƒ½è§¦å‘å†…å­˜é‡Šæ”¾ï¼‰ 70 -XX:MinHeapFreeRatio æœ€å°å †ç©ºé—²æ¯”ä¾‹ï¼ˆä½äºæ­¤æ¯”ä¾‹å¯èƒ½è§¦å‘æ‰©å®¹ï¼‰ 40 -XX:+ZGenerational å¯ç”¨ ZGC åˆ†ä»£æ”¶é›†ï¼ˆä» JDK 21 èµ·æ”¯æŒï¼Œé»˜è®¤å…³é—­ï¼‰ falseï¼ˆJDK 21+ï¼‰ -XX:+PrintGC / -Xlog:gc* å¼€å¯ GC æ—¥å¿—è¾“å‡º - -XX:+ZProactive ä¸»åŠ¨å›æ”¶ç­–ç•¥ï¼ˆåœ¨ç³»ç»Ÿç©ºé—²æ—¶å°è¯•å›æ”¶ï¼‰ true -XX:ZCollectionInterval=&lt;ç§’&gt; ä¸»åŠ¨å›æ”¶ä¹‹é—´çš„æœ€å°æ—¶é—´é—´éš”ï¼ˆé…åˆ ZProactiveï¼‰ é»˜è®¤å€¼å› ç‰ˆæœ¬è€Œå¼‚ ZGC vs G1 GC vs Parallel GC å¯¹æ¯”è¡¨ ç‰¹æ€§ ZGC G1 GC Parallel GC è®¾è®¡ç›®æ ‡ æä½å»¶è¿Ÿï¼Œ&lt;1ms åœé¡¿ å¹³è¡¡ ä½å»¶è¿Ÿ ä¸ é«˜åå é«˜ååï¼Œæœ€å¤§åŒ– CPU ä½¿ç”¨ GC åœé¡¿æ—¶é—´ &lt;1msï¼Œå †å¤§å°å¢åŠ ä¸å½±å“åœé¡¿æ—¶é—´ å‡ ååˆ°å‡ ç™¾æ¯«ç§’ï¼Œå †è¶Šå¤§åœé¡¿è¶Šæ˜æ˜¾ åœé¡¿æ—¶é—´å¯èƒ½è¾¾åˆ°ç§’çº§ï¼Œå †è¶Šå¤§è¶Šæ˜æ˜¾ å †å¤§å°æ”¯æŒ æ”¯æŒé«˜è¾¾ 16TBï¼ˆJDK 15+ï¼‰ æ”¯æŒ æœ€å¤š 4TB æ”¯æŒå¤§å †ï¼Œä½†åœé¡¿æ˜æ˜¾ æ˜¯å¦åˆ†ä»£ é»˜è®¤ä¸åˆ†ä»£ï¼ˆJDK 21+ å¯å¼€å¯ -XX:+ZGenerationalï¼‰ åˆ†ä»£ï¼ˆæ–°ç”Ÿä»£ + è€å¹´ä»£ï¼‰ åˆ†ä»£ï¼ˆæ–°ç”Ÿä»£ + è€å¹´ä»£ï¼‰ å¹¶å‘å›æ”¶ æ˜¯ï¼ŒåŒ…æ‹¬æ ‡è®°ã€å‹ç¼©ã€å¼•ç”¨å¤„ç†éƒ½å¹¶å‘ éƒ¨åˆ†å¹¶å‘ï¼Œä»åŒ…å«æ˜æ˜¾ Stop-The-World é˜¶æ®µ å¦ï¼Œå…¨éƒ¨ Stop-The-World ç§»åŠ¨å¯¹è±¡æ—¶æ˜¯å¦åœé¡¿ å¦ï¼Œä½¿ç”¨è¯»å±éšœå¹¶å‘è½¬ç§»å¯¹è±¡ æ˜¯ï¼ˆé€šè¿‡å¤åˆ¶åŒºåŸŸï¼‰ æ˜¯ å®ç°æœºåˆ¶ æ ‡è®°-é‡å®šä½ï¼ŒåŸºäºè¯»å±éšœ Region åˆ†åŒº + æ ‡è®°-å¤åˆ¶ + Mixed GC æ ‡è®°-å¤åˆ¶ï¼ˆæ–°ç”Ÿä»£ï¼‰ã€æ ‡è®°-æ•´ç†ï¼ˆè€å¹´ä»£ï¼‰ ååèƒ½åŠ› ä¸­é«˜ é«˜ æœ€é«˜ é€‚ç”¨åœºæ™¯ ä½å»¶è¿Ÿç³»ç»Ÿï¼Œå¦‚é‡‘èã€äº¤æ˜“ã€æ¨èç­‰å®æ—¶åº”ç”¨ é€šç”¨åå°ç³»ç»Ÿã€Web æœåŠ¡ç­‰ æ‰¹å¤„ç†ã€æ•°æ®è®¡ç®—ã€æ—¥å¿—åˆ†æç­‰ä¸æ•æ„Ÿäºåœé¡¿çš„ç³»ç»Ÿ é»˜è®¤å¯ç”¨ å¦ï¼Œéœ€æŒ‡å®š -XX:+UseZGC JDK 9+ é»˜è®¤ GC JDK 8 åŠä»¥å‰é»˜è®¤ GC è°ƒä¼˜å¤æ‚åº¦ ä½ï¼Œå¤§å¤šæ•°å‚æ•°å¯çœç•¥ ä¸­ï¼Œéœ€è¦è®¾ç½®ç›®æ ‡åœé¡¿æ—¶é—´ç­‰ é«˜ï¼Œéœ€è¦ç²¾ç»†é…ç½® Eden/Survivor ç­‰æ¯”ä¾‹ GC æ—¥å¿—é…ç½®æ–¹å¼ ç»Ÿä¸€æ—¥å¿—æ ¼å¼ï¼š-Xlog:gc*ï¼ˆJDK 9+ï¼‰ æ”¯æŒä¼ ç»Ÿçš„ -XX:+PrintGCDetails å’Œ -Xlog:gc* æ—¥å¿—è¾“å‡º ä¸»è¦ä½¿ç”¨æ—§å‚æ•°ï¼š-XX:+PrintGCDetails ç­‰ ZGC ååèƒ½åŠ›è¾ƒå¼±çš„åŸå›  åŸå›  è§£é‡Š 1. å¹¶å‘é˜¶æ®µä»£ä»·è¾ƒé«˜ ZGC å‡ ä¹æ‰€æœ‰çš„ GC å·¥ä½œï¼ˆåŒ…æ‹¬æ ‡è®°ã€æ•´ç†ã€å¼•ç”¨å¤„ç†ã€è½¬ç§»å¯¹è±¡ï¼‰éƒ½åœ¨ä¸åº”ç”¨çº¿ç¨‹å¹¶å‘æ‰§è¡Œã€‚è™½ç„¶å‡å°‘äº†åœé¡¿ï¼Œä½†è¿™äº› GC çº¿ç¨‹ä¸ä¸šåŠ¡çº¿ç¨‹å…±äº« CPU èµ„æºï¼Œå¢åŠ äº† CPU ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œç¼“å­˜ç«äº‰ï¼Œä»è€Œå½±å“ä¸šåŠ¡çº¿ç¨‹çš„æ‰§è¡Œæ•ˆç‡ã€‚ 2. è¯»å±éšœå¼€é”€ ZGC ä¾èµ–ç€è‰²æŒ‡é’ˆå’Œè¯»å±éšœï¼ˆload barrierï¼‰æœºåˆ¶æ¥è·Ÿè¸ªå¯¹è±¡å¼•ç”¨çŠ¶æ€ï¼Œæ”¯æŒå¹¶å‘è½¬ç§»ã€‚è™½ç„¶éå¸¸é«˜æ•ˆï¼Œä½†ä»æ¯”ä¼ ç»Ÿ GC çš„æ™®é€šè¯»å†™è·¯å¾„æ…¢ä¸€äº›ï¼Œåœ¨é«˜é¢‘è®¿é—®å¯¹è±¡åœºæ™¯ä¸‹ä¼šå¸¦æ¥ä¸€å®š CPU å¼€é”€ã€‚ 3. å¯¹ç¡¬ä»¶ä¾èµ–é«˜ï¼Œè°ƒåº¦ä¿å®ˆ ä¸ºäº†å®ç°â€œ&lt;1ms åœé¡¿â€çš„ç›®æ ‡ï¼ŒZGC ä¼šé€‰æ‹©æ›´ä¿å®ˆçš„è°ƒåº¦ç­–ç•¥ï¼ˆå¦‚é¿å…å¹¶å‘çº¿ç¨‹ä½¿ç”¨è¿‡å¤š CPUï¼‰ï¼Œè€Œä¸ä¼šåƒ Parallel GC é‚£æ ·â€œæ¦¨å¹²â€æ‰€æœ‰æ ¸å¿ƒèµ„æºã€‚ 4. å†…å­˜å¼€é”€æ›´é«˜ ä¸ºäº†æ”¯æŒå¹¶å‘å‹ç¼©å’Œè½¬ç§»ï¼ŒZGC é€šå¸¸éœ€è¦ä¸ºæ¯ä¸ªå¯¹è±¡ä¿ç•™å…ƒæ•°æ®å’Œæ›´å¤šçš„è½¬ç§»ç©ºé—´ï¼ˆå³â€œæµ®åŠ¨åƒåœ¾â€åŒºåŸŸï¼‰ï¼Œè¿™å¯èƒ½å¯¼è‡´é¢‘ç¹çš„ GC å‘¨æœŸï¼Œå½±å“ååã€‚ 5. è®¾è®¡ç›®æ ‡éååä¼˜å…ˆ ZGC çš„é¦–è¦ç›®æ ‡æ˜¯ä½å»¶è¿Ÿè€Œéæœ€å¤§ååã€‚ä¸ Parallel GCï¼ˆä»¥ååä¸ºæ ¸å¿ƒï¼‰è®¾è®¡ç›®æ ‡ä¸åŒï¼ŒZGC æ›´é€‚åˆåœºæ™¯ä¸ºâ€œå¯¹å»¶è¿Ÿæ•æ„Ÿä½†ååå¯æ¥å—â€çš„ç³»ç»Ÿã€‚ æœ€ç³Ÿç³•çš„æƒ…å†µä¸‹ååé‡ä¼šé™ä½15%ã€‚è¿™éƒ½ä¸æ˜¯äº‹ï¼Œåœé¡¿æ—¶é—´è¶³å¤Ÿä¼˜ç§€ã€‚è‡³äºååé‡ï¼Œé€šè¿‡æ‰©å®¹åˆ†åˆ†é’Ÿè§£å†³ã€‚ å¦å¤–ï¼ŒOracleå®˜æ–¹æåˆ°äº†å®ƒæœ€å¤§çš„ä¼˜ç‚¹æ˜¯ï¼šå®ƒçš„åœé¡¿æ—¶é—´ä¸ä¼šéšç€å †çš„å¢å¤§è€Œå¢é•¿ï¼ ä¹Ÿå°±æ˜¯è¯´ï¼Œå‡ åGå †çš„åœé¡¿æ—¶é—´æ˜¯10msä»¥ä¸‹ï¼Œå‡ ç™¾Gç”šè‡³ä¸ŠTå †çš„åœé¡¿æ—¶é—´ä¹Ÿæ˜¯10msä»¥ä¸‹ã€‚ ZGC ååå¼±ï¼Œä¸æ˜¯å› ä¸ºæŠ€æœ¯è½åï¼Œè€Œæ˜¯å› ä¸ºå®ƒä¸»åŠ¨é€‰æ‹©åœ¨ä½å»¶è¿Ÿå’Œé«˜ååä¹‹é—´åå‘äº†ä½å»¶è¿Ÿã€‚ åœ¨å¯¹å“åº”æ—¶é—´è¦æ±‚æé«˜çš„ç³»ç»Ÿä¸­ï¼Œå®ƒæ˜¯éå¸¸åˆé€‚çš„é€‰æ‹©ã€‚ ä½†å¦‚æœä½ çš„ç›®æ ‡æ˜¯å‹æ¦¨æœºå™¨æ€§èƒ½è·‘æ‰¹å¤„ç†ã€æ—¥å¿—åˆ†æè¿™ç±»ååå¯¼å‘å‹ä»»åŠ¡ï¼ŒParallel GC æˆ– G1 ä¼šæ›´åˆé€‚ã€‚ å†…å­˜æº¢å‡º(OutOfMemoryErrorï¼Œç®€ç§° OOM) JVM å¸¸è§å†…å­˜æº¢å‡ºç±»å‹æ±‡æ€»è¡¨ æº¢å‡ºç±»å‹ å¼‚å¸¸ä¿¡æ¯ è§¦å‘åŸå› /æè¿° ç›¸å…³å‚æ•°å’Œå»ºè®®é…ç½® å †å†…å­˜æº¢å‡º java.lang.OutOfMemoryError: Java heap space - åˆ›å»ºå¤§é‡å¯¹è±¡ï¼Œå †ç©ºé—´ä¸è¶³- å†…å­˜æ³„æ¼ï¼šå¯¹è±¡ä¸å†ä½¿ç”¨å´æœ‰å¼ºå¼•ç”¨- è€å¹´ä»£å¯¹è±¡å¤ªå¤šæ— æ³•æ™‹å‡ -Xms / -Xmx è®¾ç½®å †å¤§å° æ ˆæº¢å‡ºï¼ˆé€’å½’ï¼‰ java.lang.StackOverflowError - æ–¹æ³•æ— é™é€’å½’æˆ–é€’å½’å±‚çº§å¤ªæ·± -Xss è®¾ç½®çº¿ç¨‹æ ˆå¤§å° æ— æ³•åˆ›å»ºæ–°çº¿ç¨‹ java.lang.OutOfMemoryError: unable to create new native thread - åˆ›å»ºçº¿ç¨‹è¿‡å¤šï¼ˆå¦‚çº¿ç¨‹æ± é…ç½®è¿‡å¤§ï¼‰- ç³»ç»Ÿæˆ– JVM native çº¿ç¨‹èµ„æºè€—å°½ æ§åˆ¶çº¿ç¨‹æ± å¤§å°ï¼Œé¿å…æ— é™æ–°å»ºçº¿ç¨‹ å…ƒç©ºé—´æº¢å‡º java.lang.OutOfMemoryError: Metaspace - åŠ¨æ€åŠ è½½ç±»è¿‡å¤šï¼ˆå¦‚ä½¿ç”¨ CGLIBã€JSP åŠ¨æ€ç”Ÿæˆç±»ï¼‰- ç±»æ— æ³•å¸è½½ï¼ˆå¦‚ ClassLoader æ³„æ¼ï¼‰ -XX:MetaspaceSize / -XX:MaxMetaspaceSize ç›´æ¥å†…å­˜æº¢å‡º java.lang.OutOfMemoryError: Direct buffer memory - ä½¿ç”¨ ByteBuffer.allocateDirect() åˆ†é…å¤§é‡ç›´æ¥å†…å­˜- Netty ç­‰æ¡†æ¶é»˜è®¤ä½¿ç”¨ç›´æ¥å†…å­˜ -XX:MaxDirectMemorySize GC å¼€é”€è¿‡é«˜ java.lang.OutOfMemoryError: GC overhead limit exceeded - JVM èŠ±è´¹ &gt;98% çš„æ—¶é—´ GC ä½†å›æ”¶ &lt;2% çš„å†…å­˜ï¼Œè®¤ä¸ºè¿›å…¥â€œGC æ­»å¾ªç¯â€ åˆ†æ GC æ—¥å¿—ã€ä¼˜åŒ–å †è®¾ç½® ç±»å¸è½½å¤±è´¥ï¼ˆå†…å­˜æ³„æ¼ï¼‰ ï¼ˆä¸ä¸€å®šæŠ¥é”™ï¼Œä½†å¯èƒ½å¯¼è‡´ Metaspace OOMï¼‰ - Web å®¹å™¨é¢‘ç¹éƒ¨ç½²çƒ­æ›´æ–° WAR åŒ…æ—¶ï¼ŒClassLoader æ— æ³•å¸è½½ï¼Œå¯¼è‡´ç±»æ°¸ä¹…é©»ç•™ ä¼˜åŒ– ClassLoader ç®¡ç†ï¼Œä½¿ç”¨å†…å­˜åˆ†æå·¥å…· å †å¿«ç…§(å †è½¬å‚¨)æ–‡ä»¶åˆ†æ å‚æ•° è¯´æ˜ -XX:+HeapDumpOnOutOfMemoryError OOM æ—¶ç”Ÿæˆå †è½¬å‚¨æ–‡ä»¶ ,å»ºè®®ç”Ÿäº§ç¯å¢ƒå¼€å¯ -XX:HeapDumpPath=xxx.hprof æŒ‡å®šå †è½¬å‚¨æ–‡ä»¶ä¿å­˜è·¯å¾„ é»˜è®¤ä¿å­˜åœ¨å½“å‰ç›®å½• å¸¸ç”¨åˆ†æå·¥å…·ä¸å‘½ä»¤ å·¥å…·/å‘½ä»¤ ç®€ä»‹ä¸åŠŸèƒ½ ä½¿ç”¨è¯´æ˜ MATï¼ˆMemory Analyzer Toolï¼‰ Eclipse å‡ºå“çš„å¼ºå¤§å›¾å½¢å·¥å…·ï¼Œæ”¯æŒæ³„æ¼åˆ†æã€å¯¹è±¡å¼•ç”¨é“¾åˆ†æã€å†…å­˜å ç”¨ç»Ÿè®¡ç­‰ ä¸‹è½½åœ°å€ï¼šhttps://www.eclipse.org/mat/æ‰“å¼€åç›´æ¥å¯¼å…¥ .hprof æ–‡ä»¶å³å¯åˆ†æ VisualVM å®˜æ–¹å¯è§†åŒ– JVM ç›‘æ§å·¥å…·ï¼Œæ”¯æŒå®æ—¶åˆ†æã€GC æŸ¥çœ‹ã€çº¿ç¨‹çŠ¶æ€ä¸å †è½¬å‚¨æŸ¥çœ‹ é™„å¸¦äº JDKï¼ˆæˆ–å•ç‹¬å®‰è£…ï¼‰ï¼Œæ‰“å¼€ .hprof æ–‡ä»¶è¿›è¡Œå¯è§†åŒ–åˆ†æ JProfiler å•†ä¸šçº§ Java æ€§èƒ½åˆ†æå·¥å…·ï¼Œæä¾›å †åˆ†æã€CPU åˆ†æã€çº¿ç¨‹åˆ†æç­‰å…¨å¥—åŠŸèƒ½ æ”¯æŒæ‰“å¼€ .hprof æ–‡ä»¶ï¼Œä¹Ÿå¯åœ¨è¿è¡Œæ—¶é…åˆä½¿ç”¨ï¼ˆéœ€ä»˜è´¹æˆ–è¯•ç”¨ï¼‰ YourKit å•†ä¸šæ€§èƒ½åˆ†æå·¥å…·ï¼Œç•Œé¢å‹å¥½ï¼Œæ”¯æŒä¸°å¯Œçš„åˆ†æåŠŸèƒ½ æ”¯æŒå †åˆ†æï¼Œé€‚åˆå†…å­˜æ³„æ¼æ’æŸ¥ jhatï¼ˆè¿‡æ—¶ï¼‰ JDK é™„å¸¦çš„æ—§å·¥å…·ï¼Œç”¨äºåˆ†æ .hprof æ–‡ä»¶ï¼Œå¼€å¯ Web ç•Œé¢æŸ¥çœ‹ï¼ˆå·²åºŸå¼ƒï¼‰ å‘½ä»¤ï¼šjhat heapdump.hprofï¼Œæµè§ˆå™¨è®¿é—® http://localhost:7000ï¼ˆJDK 8 åŠä»¥ä¸‹ï¼‰ jmap ç”¨äºç”Ÿæˆå †è½¬å‚¨æ–‡ä»¶æˆ–æŸ¥çœ‹å †å¯¹è±¡ç»Ÿè®¡ä¿¡æ¯ï¼ˆä¸æ˜¯åˆ†æå·¥å…·æœ¬èº«ï¼‰ å‘½ä»¤ï¼šjmap -dump:format=b,file=heap.hprof &lt;pid&gt; ç”Ÿæˆè½¬å‚¨ï¼›é…åˆ MAT ä½¿ç”¨ jcmd æ›´ç°ä»£çš„è¯Šæ–­å‘½ä»¤å·¥å…·ï¼Œå¯ç”Ÿæˆ heap dumpã€æ‰§è¡Œ GCã€æ‰“å° VM çŠ¶æ€ç­‰ å‘½ä»¤ï¼šjcmd &lt;pid&gt; GC.heap_dump heap.hprof GCEasy.io åœ¨çº¿åˆ†æå·¥å…·ï¼Œæ”¯æŒ .hprof æ–‡ä»¶å’Œ GC æ—¥å¿—ä¸Šä¼ åˆ†æ ç½‘ç«™ï¼šhttps://gceasy.io GCæ—¥å¿—ç›¸å…³å‚æ•°(JDK1.8åŠä»¥ä¸‹) å‚æ•° è¯´æ˜ -XX:+PrintGC æ‰“å°åŸºæœ¬ GC ä¿¡æ¯ï¼ˆå»ºè®®é…åˆ -XX:+PrintGCDetails ä½¿ç”¨ï¼‰,ä¸-verbose:gcç­‰ä»· -XX:+PrintGCDetails æ‰“å°è¯¦ç»†çš„ GC æ—¥å¿—ä¿¡æ¯ï¼ˆå¦‚å„åŒºåŸŸä½¿ç”¨æƒ…å†µã€å¯¹è±¡åˆ†é…ã€æ™‹å‡ç­‰ï¼‰ -XX:+PrintGCDateStamps åœ¨ GC æ—¥å¿—ä¸­æ·»åŠ æ—¥æœŸæ—¶é—´æˆ³ -XX:+PrintGCTimeStamps åœ¨ GC æ—¥å¿—ä¸­æ·»åŠ  JVM å¯åŠ¨ä»¥æ¥çš„æ—¶é—´æˆ³ -Xloggc:/var/log/myapp/gc.log å°† GC æ—¥å¿—è¾“å‡ºåˆ°æŒ‡å®šæ–‡ä»¶ -XX:+UseGCLogFileRotation å¯ç”¨ GC æ—¥å¿—æ–‡ä»¶è½®è½¬ï¼ˆé€‚ç”¨äºå¤§è§„æ¨¡ç³»ç»Ÿçš„ GC æ—¥å¿—ç®¡ç†ï¼‰ -XX:NumberOfGCLogFiles=5 æœ€å¤šä¿ç•™ 5 ä¸ª GC æ—¥å¿—å†å²æ–‡ä»¶ -XX:GCLogFileSize=10M æ¯ä¸ª GC æ—¥å¿—æ–‡ä»¶æœ€å¤§ä¸º 10MB -XX:+PrintGCCause æ‰“å° GC çš„è§¦å‘åŸå› ï¼ˆå¦‚ Minor GCã€System.gc() ç­‰ï¼‰ GCæ—¥å¿—ç›¸å…³å‚æ•°(JDK9+) -Xlog æ˜¯ç”¨äºé…ç½® JVM æ—¥å¿—è®°å½•çš„å‚æ•°ï¼Œå®ƒæ˜¯ä» JDK 9 å¼€å§‹å¼•å…¥çš„ç»Ÿä¸€æ—¥å¿—æ¡†æ¶ï¼ˆUnified Loggingï¼‰çš„ä¸€éƒ¨åˆ†ã€‚ é€šè¿‡ -Xlog é€‰é¡¹ï¼Œä½ å¯ä»¥æ§åˆ¶æ—¥å¿—çš„ æ ‡ç­¾ï¼ˆtagsï¼‰ã€è¾“å‡ºçº§åˆ«ï¼ˆlevelï¼‰ã€è¾“å‡ºä½ç½®ï¼ˆoutputï¼‰ ç­‰å†…å®¹ã€‚ åŸºæœ¬æ ¼å¼ 1-Xlog[:[tag1[,tag2...]][[:level][:[output][:[decorators][:rotation]]]]] å¸¸è§ Tagsï¼ˆæ ‡ç­¾ï¼‰ ç±»åˆ« æ ‡ç­¾ å«ä¹‰ ç”¨é€”ç¤ºä¾‹ ç±»åŠ è½½ classload JVM ç±»åŠ è½½æ´»åŠ¨çš„æ€»ä½“ä¿¡æ¯ è§‚å¯Ÿç±»åŠ è½½å¤±è´¥æˆ–é‡å¤åŠ è½½ class+load æ˜¾ç¤ºæ¯ä¸ªç±»åŠ è½½è¿‡ç¨‹ç»†èŠ‚ å®šä½ç±»åŠ è½½å¼‚å¸¸ã€çƒ­åŠ è½½åˆ†æ class+unload è®°å½•ç±»å¸è½½äº‹ä»¶ åˆ†æç±»å¸è½½æ—¶æœºæˆ–å†…å­˜é‡Šæ”¾æƒ…å†µ åƒåœ¾å›æ”¶ gc æ€»ä½“ GC æ´»åŠ¨ä¿¡æ¯ GC è°ƒä¼˜å…¥é—¨ä½¿ç”¨ gc+start GC äº‹ä»¶å¼€å§‹æ—¶é—´ä¸ç±»å‹ æŸ¥çœ‹ GC é¢‘ç‡ä¸è§¦å‘ç‚¹ gc+heap GC å‰åçš„å †ä½¿ç”¨æƒ…å†µ åˆ†æå †ä½¿ç”¨ä¸åˆ†åŒºå æ¯” gc+phases GC å†…éƒ¨é˜¶æ®µç»†èŠ‚ G1/ZGC ç­‰è°ƒè¯•ç”¨ gc+age å¹´é¾„åˆ†å¸ƒæƒ…å†µ åˆ¤æ–­å¯¹è±¡æ™‹å‡è·¯å¾„ã€è€å¹´ä»£å‹åŠ› gc+ergo GC çš„è‡ªé€‚åº”è°ƒæ•´å†³ç­– æŸ¥çœ‹çº¿ç¨‹ã€å †å¤§å°è‡ªåŠ¨è°ƒæ•´é€»è¾‘ JIT ç¼–è¯‘ jit JIT ç¼–è¯‘æ—¥å¿—å…¥å£ æ€§èƒ½çƒ­ç‚¹æ–¹æ³•åˆ†æ compiler æ˜¾ç¤ºæ–¹æ³•ç¼–è¯‘ã€æ—¶é—´ç­‰ åˆ¤æ–­æ˜¯å¦æœ‰æ–¹æ³•æœªè¢«ä¼˜åŒ– codecache å·²ç¼–è¯‘ä»£ç å­˜å‚¨åŒºä½¿ç”¨æƒ…å†µ åˆ¤æ–­æ˜¯å¦è¾¾åˆ°ç¼“å­˜ä¸Šé™ nmethod JIT ç”Ÿæˆçš„ native æ–¹æ³•ç”Ÿå‘½å‘¨æœŸ è§‚å¯Ÿ native ä»£ç ç”Ÿæˆä¸å¸è½½ å†…å­˜ memory æ€»ä½“å†…å­˜ä½¿ç”¨æƒ…å†µ è¯Šæ–­å†…å­˜æ³„æ¼æˆ–æº¢å‡º gc+heap å †ç»“æ„ä¸å ç”¨æƒ…å†µ ä¸ GC è”åˆåˆ†æä½¿ç”¨ os+memory JVM ä¸æ“ä½œç³»ç»Ÿé—´çš„å†…å­˜äº¤äº’ åˆ¤æ–­æ˜¯å¦ç³»ç»Ÿå±‚å†…å­˜ç”³è¯·å¤±è´¥ çº¿ç¨‹ thread çº¿ç¨‹çš„åˆ›å»ºã€ç»ˆæ­¢ã€çŠ¶æ€å˜åŒ– çº¿ç¨‹æ³„æ¼æˆ–é¢‘ç¹åˆ›å»ºæ’æŸ¥ safepoint JVM è¿›å…¥/é€€å‡º safepoint çš„ä¿¡æ¯ åˆ†æ STW åœé¡¿æ—¶é—´ä¸é¢‘ç‡ é”ä¸åŒæ­¥ synchronization é”ç«äº‰ã€è·å–å’Œé‡Šæ”¾ä¿¡æ¯ åˆ†ææ€§èƒ½ç“¶é¢ˆä¸­çš„é”äº‰ç”¨ monitorinflation è½»é‡çº§é”å‡çº§ä¸ºé‡é‡çº§é”è¿‡ç¨‹ æ’æŸ¥é”è†¨èƒ€å¯¼è‡´çš„å»¶è¿Ÿé—®é¢˜ æ“ä½œç³»ç»Ÿäº¤äº’ os JVM ä¸æ“ä½œç³»ç»Ÿäº¤äº’æ—¥å¿— å¸¸è§„ç³»ç»Ÿèµ„æºè¯·æ±‚ä¿¡æ¯ os+thread OS å±‚çº§çº¿ç¨‹ç®¡ç†ä¿¡æ¯ é«˜å¹¶å‘æ—¶çº¿ç¨‹ç»‘å®šä¸è°ƒåº¦åˆ†æ os+cpu CPU ä½¿ç”¨ä¸åˆ†å¸ƒæƒ…å†µ æ’æŸ¥é«˜ CPU ä½¿ç”¨çš„é—®é¢˜ ç±»å…ƒæ•°æ® metaspace å…ƒç©ºé—´å†…å­˜ä½¿ç”¨ä¸å˜åŒ– æ’æŸ¥ Metaspace OOM cds ç±»å…±äº«æ•°æ®ï¼ˆCDSï¼‰æ—¥å¿— åˆ†æç±»åŠ è½½åŠ é€Ÿæ˜¯å¦ç”Ÿæ•ˆ å®‰å…¨ security å®‰å…¨ç›¸å…³æ“ä½œæ—¥å¿— æƒé™æ£€æŸ¥å¤±è´¥ã€å¯†é’¥åŠ è½½ç­‰è°ƒè¯• module æ¨¡å—ç³»ç»Ÿï¼ˆJPMSï¼‰ç›¸å…³æ—¥å¿— æ¨¡å—è®¿é—®æ§åˆ¶å¤±è´¥åˆ†æ å…¶ä»– start JVM å¯åŠ¨æµç¨‹æ—¥å¿— å¯åŠ¨é˜¶æ®µæ…¢ã€å‡ºé”™æ—¶ä½¿ç”¨ init å„å­ç³»ç»Ÿåˆå§‹åŒ–è¿‡ç¨‹ å®šä½å­ç³»ç»Ÿå¯åŠ¨é¡ºåºä¸å¼‚å¸¸ jni Java è°ƒç”¨ native æ–¹æ³•æ—¥å¿— JNI å´©æºƒã€æ€§èƒ½é—®é¢˜åˆ†æ classpath ç±»è·¯å¾„åŠ è½½è¯¦æƒ… ç±»æ‰¾ä¸åˆ°ã€è·¯å¾„å†²çªç­‰é—®é¢˜æ’æŸ¥ exceptions å¼‚å¸¸ä¿¡æ¯åŠå †æ ˆæ‰“å° æ•è·æœªå¤„ç†å¼‚å¸¸ã€é¢‘ç¹æŠ›é”™åˆ†æ Levelï¼ˆçº§åˆ«ï¼‰ ç­‰çº§ å«ä¹‰è¯´æ˜ ç”¨é€”ç¤ºä¾‹ off å…³é—­æ—¥å¿—è®°å½• å®Œå…¨ç¦ç”¨æŒ‡å®šæ ‡ç­¾çš„æ—¥å¿—è¾“å‡º error ä¸¥é‡é”™è¯¯ï¼Œä»…è®°å½•å½±å“ç³»ç»Ÿè¿è¡Œçš„é”™è¯¯ä¿¡æ¯ æ•è·å´©æºƒã€ä¸¥é‡æ•…éšœ warning æ½œåœ¨é—®é¢˜ï¼Œå¯èƒ½å½±å“ç¨³å®šæ€§ è®°å½•å¯èƒ½çš„å†…å­˜ã€é…ç½®é—®é¢˜ info å¸¸è§„ä¿¡æ¯ï¼ˆé»˜è®¤çº§åˆ«ï¼‰ æ—¥å¸¸è¿è¡Œæ—¥å¿—ï¼Œå¦‚ GC æ¬¡æ•° debug æ›´è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯ï¼Œé€‚ç”¨äºé—®é¢˜è¯Šæ–­ è·Ÿè¸ªè¡Œä¸ºå˜åŒ–æˆ–ä»£ç è·¯å¾„ trace æœ€è¯¦ç»†çš„ä¿¡æ¯ï¼Œè®°å½•å‡ ä¹æ‰€æœ‰ç»†èŠ‚ æ·±åº¦è°ƒè¯•ï¼Œå¦‚æ–¹æ³•çº§åˆ«è·Ÿè¸ª all æ‰“å°æ‰€æœ‰çº§åˆ«çš„æ—¥å¿—ï¼ˆåŒ…æ‹¬ trace åŠä»¥ä¸Šï¼‰ å…¨é‡æ—¥å¿—è¾“å‡ºï¼Œç”¨äºå®Œå…¨ç›‘æ§ Outputï¼ˆè¾“å‡ºä½ç½®ï¼‰ è¾“å‡ºä½ç½® å«ä¹‰è¯´æ˜ ç¤ºä¾‹ç”¨æ³• stdout æ ‡å‡†è¾“å‡ºï¼ˆé»˜è®¤ï¼‰ -Xlog:gc=info:stdout stderr æ ‡å‡†é”™è¯¯è¾“å‡º -Xlog:gc=info:stderr file=è·¯å¾„ è¾“å‡ºåˆ°æŒ‡å®šæ–‡ä»¶è·¯å¾„ï¼ˆè‡ªåŠ¨åˆ›å»ºæ–‡ä»¶ï¼‰ -Xlog:gc:file=gc.log å¤šä¸ªè¾“å‡ºç”¨é€—å·åˆ†éš” å¯åŒæ—¶è¾“å‡ºåˆ°å¤šä¸ªä½ç½® -Xlog:gc:file=gc.log,stdout Decoratorsï¼ˆè£…é¥°å™¨ï¼‰ è£…é¥°å™¨ å«ä¹‰è¯´æ˜ ç¤ºä¾‹è¾“å‡ºç‰‡æ®µï¼ˆå«è¯¥è£…é¥°å™¨æ—¶ï¼‰ time æ˜¾ç¤ºå½“å‰ç³»ç»Ÿæ—¶é—´ï¼ˆwall-clock timeï¼‰ 2025-05-16T10:45:12.123+0800 uptime æ˜¾ç¤º JVM å¯åŠ¨ä»¥æ¥çš„è¿è¡Œæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ 5.123sï¼ˆè¡¨ç¤ºå·²è¿è¡Œ 5.123 ç§’ï¼‰ level æ˜¾ç¤ºæ—¥å¿—çº§åˆ«ï¼ˆå¦‚ info, warning ç­‰ï¼‰ [info], [debug] tags æ˜¾ç¤ºæ—¥å¿—æ ‡ç­¾ [gc], [class,load] tid æ˜¾ç¤ºçº¿ç¨‹ ID tid=0x00007fddc4012800 hostname æ˜¾ç¤ºä¸»æœºå host=example.local pid æ˜¾ç¤ºå½“å‰ JVM è¿›ç¨‹ ID pid=12345 Rotation (æ—¥å¿—è½®è½¬è®¾ç½®) è®¾ç½®å‚æ•° å«ä¹‰è¯´æ˜ ç¤ºä¾‹å€¼ filecount=n ä¿ç•™çš„æ—¥å¿—æ–‡ä»¶æ•°é‡ï¼ˆæœ€å¤§æ–‡ä»¶è½®è½¬æ•°ï¼‰ filecount=5 filesize=n å•ä¸ªæ—¥å¿—æ–‡ä»¶çš„æœ€å¤§å¤§å°ï¼ˆæ”¯æŒå•ä½ï¼šk/m/gï¼‰ filesize=10m ç¤ºä¾‹ï¼š 1-Xlog:gc*:file=/var/log/app/gc.log:time,uptime,level,tags:filecount=5,filesize=20M é¡¹ å€¼ å«ä¹‰ tag gc* åŒ¹é…æ‰€æœ‰ä»¥ gc å¼€å¤´çš„æ ‡ç­¾ï¼ˆå¦‚ gc+heap ç­‰ï¼‰ level çœç•¥ é»˜è®¤æ˜¯ info output file=/var/log/app/gc.log æ—¥å¿—å†™å…¥è¯¥æ–‡ä»¶ decorators time,uptime,level,tags æ—¥å¿—å‰ç¼€åŒ…å«æ—¶é—´ã€å¯åŠ¨æ—¶é—´ã€æ—¥å¿—çº§åˆ«ã€æ ‡ç­¾ rotation filecount=5,filesize=20M æœ€å¤šä¿ç•™ 5 ä¸ªæ—¥å¿—æ–‡ä»¶ï¼Œå•ä¸ªæ–‡ä»¶æœ€å¤§ 20MB æ—¥å¿—æ–‡ä»¶ä¸­å¯ä»¥ä½¿ç”¨å˜é‡ 1-Xlog:gc*:file=gc_%p_%t.log å¸¸ç”¨å˜é‡è¡¨ å˜é‡ å«ä¹‰ %p è¿›ç¨‹IDï¼ˆProcess IDï¼‰ %t æ—¶é—´æˆ³ï¼ˆä»£è¡¨æ—¥å¿—æ–‡ä»¶åˆ›å»ºæ—¶çš„æ—¶é—´æˆ³ï¼‰ %h ä¸»æœºåï¼ˆHostnameï¼‰ %n åºåˆ—å·ï¼Œä»0å¼€å§‹ï¼Œæ¯åˆ›å»ºæ–°æ–‡ä»¶åŠ 1 %u å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œç”¨äºè§£å†³æ–‡ä»¶åå†²çª %i å½“å¤šä¸ªJVMè¿›ç¨‹ä½¿ç”¨ç›¸åŒçš„æ–‡ä»¶åæ¨¡å¼æ—¶çš„åŒºåˆ†è®¡æ•°å™¨ æ—¶é—´ç›¸å…³å˜é‡è¡¨ å˜é‡ å«ä¹‰ %Y å¹´ï¼ˆYearï¼‰ %m æœˆï¼ˆMonthï¼‰ %d æ—¥ï¼ˆDayï¼‰ %H å°æ—¶ï¼ˆHourï¼‰ %M åˆ†é’Ÿï¼ˆMinuteï¼‰ %S ç§’ï¼ˆSecondï¼‰ 12345678# åŸºç¡€é…ç½®-Xlog:gc*:file=gc_%p_%Y%m%d_%H%M%S.log:time,uptime,level,tags:filecount=5,filesize=20M# è¯¦ç»†GCæ—¥å¿—é…ç½®-Xlog:gc*=debug:file=gc_%p_%t.log:time,uptime,level,tags:filecount=10,filesize=50M# å¤šç›®æ ‡è¾“å‡º-Xlog:gc*=info:file=gc.log::filecount=5,filesize=20M -Xlog:gc*=debug:file=gc_detailed.log å¯¹äºGCæ—¥å¿—çš„åˆ†æ äººå·¥åˆ†æè¿˜æ˜¯å¤ªå¤æ‚äº†ï¼Œå¯ä»¥ä½¿ç”¨GCEasy.ioï¼Œæ¯ä¸ªæœˆå…è´¹5æ¬¡ã€‚","summary":"æ‘˜è¦ æœ¬æ–‡ä»‹ç»JVMçš„å†…å­˜æ¨¡å‹ä¸åƒåœ¾å›æ”¶æœºåˆ¶ JDK8 The JavaÂ® Virtual Machine Specification JDK8çš„javaæŒ‡ä»¤çš„å®˜â½…â½‚æ¡£ JDKâ¼¯å…·å®˜â½¹â½‚æ¡£ JDK17çš„javaæŒ‡ä»¤çš„å®˜â½…â½‚æ¡£","date_published":"2025-05-12T14:30:05.000Z","tags":["æŠ€æœ¯","jvm","jvm"]},{"id":"https://blog.hanqunfeng.com/2025/05/08/jvm-classloader-01/","url":"https://blog.hanqunfeng.com/2025/05/08/jvm-classloader-01/","title":"JVM ä¹‹ ç±»åŠ è½½å™¨","content_html":"<!--\n **åŠ ç²—**\n *æ–œä½“*\n ***åŠ ç²—å¹¶æ–œä½“***\n ~~åˆ é™¤çº¿~~\n ==çªå‡ºæ˜¾ç¤º==\n `çªå‡ºæ˜¾ç¤º(æ¨è)`\n ++ä¸‹åˆ’çº¿++\n ~ä¸‹æ ‡~\n ^ä¸Šæ ‡^\n è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference.\n å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)\n\n +++ **ç‚¹å‡»æŠ˜å **\n è¿™æ˜¯è¢«éšè—çš„å†…å®¹\n +++\n\n::: tips success warning danger\nè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹\n:::\n\n% note info % success warning danger\nè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹\n% endnote %\n\nå¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{}\n å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ\n -->\n<h2 id=\"æ‘˜è¦\">æ‘˜è¦</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æœ¬æ–‡ä»‹ç»JVMçš„ç±»åŠ è½½å™¨</p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://docs.oracle.com/javase/specs/jvms/se8/html/index.html\">JDK8 The JavaÂ® Virtual Machine Specification</a></p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://docs.oracle.com/javase/8/docs/technotes/tools/unix/java.html\">JDK8çš„javaæŒ‡ä»¤çš„å®˜â½…â½‚æ¡£</a></p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://docs.oracle.com/en/java/javase/17/docs/specs/man/index.html\">JDKâ¼¯å…·å®˜â½¹â½‚æ¡£</a></p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://docs.oracle.com/en/java/javase/17/docs/specs/man/java.html\">JDK17çš„javaæŒ‡ä»¤çš„å®˜â½…â½‚æ¡£</a></p>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"ç±»åŠ è½½å™¨\">ç±»åŠ è½½å™¨</h2>\n<p><img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/weBeGe.png\" alt=\"\" width=\"1200\" height=\"400\"></p>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å·¦ä¾§æ˜¯JDKä¸­å®ç°çš„ç±»åŠ è½½å™¨ï¼Œé€šè¿‡<code>parent</code>å±æ€§å½¢æˆâ½—â¼¦å…³ç³»ã€‚åº”â½¤ä¸­â¾ƒå®šä¹‰çš„ç±»åŠ è½½å™¨çš„<code>parent</code>éƒ½æ˜¯<br>\n<code>AppClassLoader</code></p>\n</li>\n<li class=\"lvl-2\">\n<p>å³ä¾§æ˜¯JDKä¸­çš„ç±»åŠ è½½å™¨å®ç°ç±»ã€‚é€šè¿‡ç±»ç»§æ‰¿çš„æœºåˆ¶å½¢æˆä½“ç³»ã€‚æœªæ¥æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ç»§æ‰¿ç›¸å…³çš„ç±»å®ç°â¾ƒå®šä¹‰ç±»<br>\nåŠ è½½å™¨ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>åœ¨ä»£ç ä¸­æŸ¥çœ‹ç±»åŠ è½½å™¨å…³ç³»</p>\n</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">LoaderDemo</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> ClassNotFoundException &#123;</span><br><span class=\"line\">        <span class=\"comment\">// â½—â¼¦å…³ç³» AppClassLoader &lt;- ExtClassLoader &lt;- BootStrap Classloader</span></span><br><span class=\"line\">        <span class=\"type\">ClassLoader</span> <span class=\"variable\">cl1</span> <span class=\"operator\">=</span> LoaderDemo.class.getClassLoader();</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;cl1 &gt; &quot;</span> + cl1); <span class=\"comment\">// sun.misc.Launcher$AppClassLoader@18b4aac2</span></span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;parent of cl1 &gt; &quot;</span> + cl1.getParent()); <span class=\"comment\">// sun.misc.Launcher$ExtClassLoader@1b6d3586</span></span><br><span class=\"line\">        <span class=\"comment\">// BootStrap Classloaderç”±C++å¼€å‘ï¼Œæ˜¯JVMè™šæ‹Ÿæœºçš„â¼€éƒ¨åˆ†ï¼Œæœ¬èº«ä¸æ˜¯JAVAç±»ã€‚</span></span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;grant parent of cl1 &gt; &quot;</span> + cl1.getParent().getParent()); <span class=\"comment\">// null</span></span><br><span class=\"line\">        <span class=\"comment\">// String,Intç­‰åŸºç¡€ç±»ç”±BootStrap ClassloaderåŠ è½½ã€‚</span></span><br><span class=\"line\">        <span class=\"type\">ClassLoader</span> <span class=\"variable\">cl2</span> <span class=\"operator\">=</span> String.class.getClassLoader();</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;cl2 &gt; &quot;</span> + cl2); <span class=\"comment\">// null</span></span><br><span class=\"line\">        System.out.println(cl1.loadClass(<span class=\"string\">&quot;java.util.List&quot;</span>).getClass().getClassLoader()); <span class=\"comment\">// null</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"åŒäº²å§”æ´¾æœºåˆ¶\">åŒäº²å§”æ´¾æœºåˆ¶</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å½“â¼€ä¸ªç±»åŠ è½½å™¨è¦åŠ è½½â¼€ä¸ªç±»æ—¶ï¼Œæ•´ä½“çš„è¿‡ç¨‹å°±æ˜¯é€šè¿‡åŒäº²å§”æ´¾æœºåˆ¶å‘ä¸Šå§”æ‰˜æŸ¥æ‰¾ï¼Œå¦‚æœæ²¡æœ‰æŸ¥æ‰¾åˆ°ï¼Œå°±å‘ä¸‹å§”æ‰˜åŠ è½½ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>Java ç±»åŠ è½½æœºåˆ¶ä¸­çš„<code>åŒäº²å§”æ´¾æ¨¡å‹ï¼ˆParent Delegation Modelï¼‰</code>æ˜¯ä¸€ç§ä¿è¯äº†ç±»åŠ è½½å™¨æŒ‰ç…§å±‚æ¬¡ç»“æ„ä»ä¸Šåˆ°ä¸‹æ¥åŠ è½½ç±»çš„ç­–ç•¥ã€‚è¿™ç§å±‚çº§åŒ–çš„åŠ è½½æµç¨‹ç¡®ä¿äº†åº”ç”¨ç¨‹åºèƒ½å¤Ÿå®‰å…¨åœ°åŠ è½½å¹¶ä½¿ç”¨æ¥è‡ªä¸åŒæ¥æºçš„ç±»ï¼ŒåŒæ—¶ä¹Ÿé¿å…äº†å†…å­˜ä¸­å‡ºç°ç›¸åŒç±»çš„å¤šä¸ªæ‹·è´ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>ä»¥ä¸‹æ˜¯åŒäº²å§”æ´¾æœºåˆ¶çš„å·¥ä½œåŸç†ï¼š</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-4\">1.å½“ä¸€ä¸ªç±»åŠ è½½å™¨æ¥æ”¶åˆ°ç±»åŠ è½½è¯·æ±‚æ—¶ï¼Œå®ƒé¦–å…ˆä¸ä¼šè‡ªè¡Œå°è¯•å»å¯»æ‰¾ç±»æ–‡ä»¶ï¼Œè€Œæ˜¯å°†è¿™ä¸ªè¯·æ±‚å§”æ´¾ç»™å®ƒçš„çˆ¶ç±»åŠ è½½å™¨ã€‚</li>\n<li class=\"lvl-4\">2.çˆ¶ç±»åŠ è½½å™¨åŒæ ·éµå¾ªæ­¤è§„åˆ™ï¼Œå®ƒä¼šç»§ç»­æŠŠè¯·æ±‚å‘ä¸Šå§”æ´¾ç»™å®ƒçš„çˆ¶ç±»åŠ è½½å™¨ï¼Œç›´åˆ°è¾¾åˆ°æ ¹ï¼ˆbootstrappï¼‰ç±»åŠ è½½å™¨ä¸ºæ­¢ã€‚</li>\n<li class=\"lvl-4\">3.æ ¹ç±»åŠ è½½å™¨ä¸€èˆ¬ä¼šç›´æ¥è®¿é—®æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿæ¥æŸ¥æ‰¾ç±»æ–‡ä»¶ï¼Œæ¯”å¦‚ JDK è‡ªå¸¦çš„æ ¸å¿ƒç±»åº“ï¼Œæˆ–è€…åœ¨-XbootclasspathæŒ‡å®šçš„è·¯å¾„ä¸‹æŸ¥æ‰¾ã€‚</li>\n<li class=\"lvl-4\">4.å¦‚æœæ ¹ç±»åŠ è½½å™¨æ‰¾åˆ°äº†è¯¥ç±»ï¼Œåˆ™è¿›è¡Œç±»çš„åŠ è½½ï¼›å¦‚æœæ‰¾ä¸åˆ°ï¼Œåˆ™æŠŠè¿™ä¸ªä»»åŠ¡äº¤å›ç»™å‘å‡ºè¯·æ±‚çš„å­ç±»åŠ è½½å™¨ã€‚</li>\n<li class=\"lvl-4\">5.å­ç±»åŠ è½½å™¨ä¹Ÿé‡å¤æ­¥éª¤ 4ï¼Œè‹¥æ‰¾åˆ°åˆ™åŠ è½½ï¼Œå¦åˆ™ä¼ é€’ç»™ä¸‹ä¸€ä¸ªå­ç±»åŠ è½½å™¨ï¼Œç›´è‡³åŸå§‹æå‡ºè¯·æ±‚çš„ç±»åŠ è½½å™¨ã€‚</li>\n<li class=\"lvl-4\">6.è‹¥æ‰€æœ‰çš„ç±»åŠ è½½å™¨éƒ½æœªèƒ½æ‰¾åˆ°æ‰€éœ€çš„ç±»ï¼Œåˆ™æœ€ç»ˆæŠ›å‡ºClassNotFoundExceptionå¼‚å¸¸ã€‚<br>\n<img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/ftDnCj.png\" alt=\"\" width=\"600\" height=\"800\"></li>\n</ul>\n</li>\n<li class=\"lvl-2\">\n<p>åŒäº²å§”æ´¾æœ‰ä»¥ä¸‹å‡ ä¸ªä¼˜ç‚¹ï¼š</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-4\">å®‰å…¨æ€§ï¼šç”±äºç±»åŠ è½½æ˜¯ä»é¡¶å±‚å¼€å§‹ï¼Œè¿™èƒ½é˜²æ­¢æ¶æ„ä»£ç é€šè¿‡åŠ è½½ç›¸åŒçš„åŒ…åå’Œç±»åæ›¿ä»£ç³»ç»Ÿçš„å…³é”®ç±»ã€‚</li>\n<li class=\"lvl-4\">å”¯ä¸€æ€§ï¼šæ¯ä¸ªç±»éƒ½ä¼šè¢«ç‰¹å®šçš„ç±»åŠ è½½å™¨åŠ è½½ä¸€æ¬¡ï¼Œå³ä¾¿æ˜¯åœ¨åˆ†å¸ƒå¼çš„ç¯å¢ƒä¸­ä¹Ÿèƒ½ä¿è¯ç±»çš„ç»Ÿä¸€æ€§ï¼Œé¿å…å› ä¸ºå¤šæ¬¡åŠ è½½å¯¼è‡´çš„é”™è¯¯ã€‚</li>\n<li class=\"lvl-4\">å¯é æ€§ï¼šç”¨æˆ·è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨ä¸ç”¨æ‹…å¿ƒåŸºç¡€ç±»å·²ç»è¢«åŠ è½½ï¼Œå®ƒä»¬å¯ä»¥ä¸“å¿ƒäºè‡ªå·±éœ€è¦å¤„ç†çš„éƒ¨åˆ†ã€‚</li>\n</ul>\n</li>\n<li class=\"lvl-2\">\n<p>ä¾‹å¦‚ï¼Œå½“åº”ç”¨ç¨‹åºè¿è¡Œæ—¶ï¼Œåº”ç”¨ç±»åŠ è½½å™¨ï¼ˆApplication ClassLoaderï¼‰æ¥æ”¶åˆ°å¯¹java.lang.Stringç±»çš„åŠ è½½è¯·æ±‚æ—¶ï¼Œå®ƒä¼šé¦–å…ˆå°†è¯·æ±‚ä¼ é€’ç»™æ‰©å±•ç±»åŠ è½½å™¨ï¼ˆExtension ClassLoaderï¼‰ï¼Œåè€…å†ä¼ é€’ç»™å¼•å¯¼ç±»åŠ è½½å™¨ï¼ˆBootstrap ClassLoaderï¼‰ã€‚å¼•å¯¼ç±»åŠ è½½å™¨ä¼šåœ¨å…¶æœç´¢è·¯å¾„ä¸­æ‰¾åˆ°Stringç±»ï¼Œå¹¶å®ŒæˆåŠ è½½è¿‡ç¨‹ã€‚å¦‚æœåº”ç”¨ç¨‹åºè¯•å›¾æä¾›è‡ªå·±çš„Stringç±»ï¼Œç”±äºåŒäº²å§”æ´¾çš„å­˜åœ¨ï¼Œåº”ç”¨ç¨‹åºæ‰€æŒ‡å®šçš„ç±»å¹¶ä¸ä¼šè¢«åŠ è½½ï¼Œä»è€Œä¿è¯äº†å¹³å°æ ¸å¿ƒ API çš„ä¸€è‡´æ€§ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>æ€»ä¹‹ï¼ŒåŒäº²å§”æ´¾æœºåˆ¶æ˜¯ Java ç±»åŠ è½½è¿‡ç¨‹ä¸­ä¸€ä¸ªéå¸¸é‡è¦çš„ç‰¹æ€§ï¼Œå®ƒä¸ä»…ç»´æŠ¤äº†ç±»åŠ è½½çš„å®‰å…¨æ€§å’Œä¸€è‡´æ€§ï¼Œä¹Ÿä¸ºå¼€å‘è€…æä¾›äº†çµæ´»å®šåˆ¶ç±»åŠ è½½è§„åˆ™çš„èƒ½åŠ›ã€‚</p>\n</li>\n</ul>\n<h3 id=\"æ¯ä¸ªç±»åŠ è½½å™¨æŸ¥æ‰¾ç±»çš„é»˜è®¤è·¯å¾„\">æ¯ä¸ªç±»åŠ è½½å™¨æŸ¥æ‰¾ç±»çš„é»˜è®¤è·¯å¾„</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åœ¨ Java ä¸­ï¼Œæ¯ä¸ªç±»åŠ è½½å™¨éƒ½æœ‰è‡ªå·±çš„ç±»è·¯å¾„ï¼ˆClasspathï¼‰å»æŸ¥æ‰¾ç±»æ–‡ä»¶ã€‚ä¸‹é¢æ˜¯å‡ ä¸ªä¸»è¦çš„ç±»åŠ è½½å™¨ä»¥åŠå®ƒä»¬çš„é»˜è®¤æŸ¥æ‰¾è·¯å¾„ï¼š</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>ç±»åŠ è½½å™¨åç§°</th>\n<th>ç±»å / åˆ«å</th>\n<th>çˆ¶ç±»åŠ è½½å™¨</th>\n<th>åŠ è½½å†…å®¹æè¿°</th>\n<th>é»˜è®¤æŸ¥æ‰¾è·¯å¾„ / ç³»ç»Ÿå±æ€§</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>å¯åŠ¨ç±»åŠ è½½å™¨</strong></td>\n<td>BootstrapClassLoader</td>\n<td>æ— </td>\n<td>åŠ è½½ <strong>æ ¸å¿ƒ Java ç±»åº“</strong></td>\n<td><code>&lt;JAVA_HOME&gt;/jre/lib/rt.jar</code>ï¼ˆJDK8 åŠä¹‹å‰ï¼‰æˆ– <code>sun.boot.class.path</code> æŒ‡å®šè·¯å¾„</td>\n</tr>\n<tr>\n<td><strong>æ‰©å±•ç±»åŠ è½½å™¨</strong></td>\n<td>ExtClassLoader</td>\n<td>BootstrapClassLoader</td>\n<td>åŠ è½½ Java å¹³å°æ‰©å±•ç±»åº“</td>\n<td><code>&lt;JAVA_HOME&gt;/jre/lib/ext</code> æˆ–ç”± <code>java.ext.dirs</code> ç³»ç»Ÿå±æ€§æŒ‡å®š</td>\n</tr>\n<tr>\n<td><strong>åº”ç”¨ç±»åŠ è½½å™¨</strong></td>\n<td>AppClassLoader</td>\n<td>ExtClassLoader</td>\n<td>åŠ è½½ <strong>åº”ç”¨ç¨‹åºç±»</strong>ï¼ˆç”¨æˆ·ç¼–å†™çš„ä»£ç ï¼‰</td>\n<td><code>-classpath</code>ã€<code>-cp</code> å‚æ•°ã€<code>CLASSPATH</code> ç¯å¢ƒå˜é‡ã€<code>java.class.path</code> å±æ€§ã€å½“å‰ç›®å½• (.)</td>\n</tr>\n<tr>\n<td><strong>è‡ªå®šä¹‰ç±»åŠ è½½å™¨</strong></td>\n<td>ç”¨æˆ·è‡ªå®šä¹‰</td>\n<td>å¯æŒ‡å®š</td>\n<td>å¯é€šè¿‡ç»§æ‰¿ <code>ClassLoader</code> å¹¶é‡å†™ <code>findClass()</code> æ–¹æ³•å®ç°è‡ªå®šä¹‰ç±»åŠ è½½é€»è¾‘ï¼Œå¦‚ä»ç½‘ç»œã€æ•°æ®åº“ç­‰åŠ è½½ç±»æ–‡ä»¶</td>\n<td>é»˜è®¤ç»§æ‰¿çˆ¶åŠ è½½å™¨æŸ¥æ‰¾è·¯å¾„ï¼Œä¹Ÿå¯è‡ªå®šä¹‰</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé™¤äº† Bootstrap ClassLoader å¤–ï¼Œå…¶ä»–çš„æ‰€æœ‰ç±»åŠ è½½å™¨æœ€ç»ˆéƒ½æ˜¯java.lang.ClassLoaderçš„å­ç±»ï¼Œå¹¶ä¸”æ¯ä¸ªç±»åŠ è½½å™¨å®ä¾‹éƒ½æœ‰ä¸€ä¸ªç›´æ¥çš„çˆ¶ç±»åŠ è½½å™¨ã€‚å¦‚æœä½ åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ç±»åŠ è½½å™¨ï¼Œå®ƒå°†ç»§æ‰¿ Application ClassLoader ä½œä¸ºå®ƒçš„çˆ¶ç±»ï¼Œé™¤éä½ åœ¨åˆ›å»ºæ—¶æŒ‡å®šäº†ä¸åŒçš„çˆ¶ç±»åŠ è½½å™¨ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>æ­¤å¤–ï¼ŒJava 9 å¼•å…¥äº†æ¨¡å—åŒ–ç³»ç»Ÿåï¼Œç±»åŠ è½½æœºåˆ¶ä¹Ÿæœ‰äº†ä¸€äº›å˜åŒ–ï¼Œå¯¹äºæ¨¡å—è·¯å¾„ä¸Šçš„ç±»åŠ è½½ï¼Œä¼šä½¿ç”¨æ–°çš„å±‚æ¬¡ç»“æ„æ¥å¤„ç†ï¼Œè¿™ä½¿å¾—ç±»åŠ è½½è¿‡ç¨‹æ›´åŠ çµæ´»åŒæ—¶ä¿æŒäº†å‘åçš„å…¼å®¹æ€§ã€‚ä¸è¿‡ï¼Œå¯¹äºä¼ ç»Ÿçš„ç±»è·¯å¾„ä¸Šçš„ç±»åŠ è½½ï¼ŒåŒäº²å§”æ´¾æ¨¡å‹ä»ç„¶é€‚ç”¨ã€‚<br>\n<img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/50fvA9.png\" alt=\"\" width=\"1200\" height=\"400\"></p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>ç±»åŠ è½½å™¨åç§°</th>\n<th>ç±»å / åˆ«å</th>\n<th>çˆ¶ç±»åŠ è½½å™¨</th>\n<th>åŠ è½½æ¨¡å—èŒƒå›´</th>\n<th>é»˜è®¤æŸ¥æ‰¾è·¯å¾„ / æ¨¡å—æ¥æº</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>å¼•å¯¼ç±»åŠ è½½å™¨</strong></td>\n<td><code>BootstrapClassLoader</code></td>\n<td>æ— </td>\n<td>åŠ è½½ <code>java.*</code> æ¨¡å—ï¼Œä¾‹å¦‚ <code>java.base</code>ï¼ˆåŒ…å« <code>java.lang</code>, <code>java.util</code> ç­‰ï¼‰</td>\n<td><code>$JAVA_HOME/jmods</code> ä¸­çš„æ¨¡å—æ–‡ä»¶ï¼Œæ ¸å¿ƒæ¨¡å—ç”± JVM å¯åŠ¨æ—¶ç›´æ¥åŠ è½½</td>\n</tr>\n<tr>\n<td><strong>å¹³å°ç±»åŠ è½½å™¨</strong></td>\n<td><code>PlatformClassLoader</code></td>\n<td>BootstrapClassLoader</td>\n<td>åŠ è½½ <code>jdk.*</code>ã€<code>javafx.*</code> ç­‰å¹³å°æ‰©å±•æ¨¡å—</td>\n<td><code>$JAVA_HOME/jmods</code>ï¼Œæ¨¡å—åä¸º <code>jdk.*</code>ã€<code>javafx.*</code> ç­‰ï¼›</td>\n</tr>\n<tr>\n<td><strong>åº”ç”¨ç±»åŠ è½½å™¨</strong></td>\n<td><code>AppClassLoader</code></td>\n<td>PlatformClassLoader</td>\n<td>åŠ è½½åº”ç”¨æ¨¡å—ï¼ˆç”¨æˆ·ä»£ç ï¼‰ï¼ŒåŒ…æ‹¬æ¨¡å—è·¯å¾„ <code>--module-path</code> å’Œç±»è·¯å¾„ <code>-classpath</code> ä¸‹çš„ç±»</td>\n<td>åº”ç”¨ç¨‹åºç¼–å†™çš„æ¨¡å—æˆ–ç±»ï¼Œæ¥è‡ªå‘½ä»¤è¡Œ <code>--module-path</code>ã€<code>-classpath</code> å‚æ•°ã€<code>CLASSPATH</code> ç¯å¢ƒå˜é‡ç­‰</td>\n</tr>\n<tr>\n<td><strong>è‡ªå®šä¹‰ç±»åŠ è½½å™¨</strong></td>\n<td>ç”¨æˆ·è‡ªå®šä¹‰</td>\n<td>å¯æŒ‡å®šçˆ¶åŠ è½½å™¨</td>\n<td>åŠ è½½éæ ‡å‡†ä½ç½®çš„ç±»ï¼Œå¯ç”¨äºæ’ä»¶ã€ç½‘ç»œåŠ è½½ã€åŠ å¯†ç±»åŠ è½½ç­‰</td>\n<td>é»˜è®¤éµå¾ªåŒäº²å§”æ´¾ï¼Œå¯é‡å†™ <code>findClass()</code> å®ç°è‡ªå®šä¹‰è·¯å¾„æŸ¥æ‰¾æˆ–å…¶ä»–æ•°æ®æºï¼Œå¦‚ç½‘ç»œã€æ•°æ®åº“ã€åŠ å¯†æ–‡ä»¶ç­‰</td>\n</tr>\n</tbody>\n</table>\n<blockquote>\n<p>jdk9+ä¸­ï¼Œåœ¨å§”æ´¾ç»™çˆ¶åŠ è½½å™¨åŠ è½½å‰ï¼Œå…ˆåˆ¤æ–­è¯¥ç±»æ˜¯å¦èƒ½å¤Ÿå½’å±åˆ°æŸä¸€ä¸ªç³»ç»Ÿæ¨¡å—ä¸­ï¼Œå¦‚æœå¯ä»¥æ‰¾åˆ°è¿™æ ·çš„å½’å±å…³ç³»ï¼Œå°±è¦ä¼˜å…ˆå§”æ´¾ç»™è´Ÿè´£é‚£ä¸ªæ¨¡å—çš„åŠ è½½å™¨å®ŒæˆåŠ è½½ã€‚</p>\n</blockquote>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åœ¨ä»£ç ä¸­æŸ¥çœ‹ç±»åŠ è½½è·¯å¾„</p>\n</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// BootStrap Classloaderï¼ŒåŠ è½½javaåŸºç¡€ç±»ã€‚</span></span><br><span class=\"line\">System.out.println(<span class=\"string\">&quot;BootStrap ClassLoaderåŠ è½½â½¬å½•ï¼š&quot;</span> + System.getProperty(<span class=\"string\">&quot;sun.boot.class.path&quot;</span>));</span><br><span class=\"line\"><span class=\"comment\">// Extention Classloader åŠ è½½â¼€äº›æ‰©å±•ç±»ã€‚ å¯é€šè¿‡-D java.ext.dirså¦â¾æŒ‡å®šâ½¬å½•</span></span><br><span class=\"line\">System.out.println(<span class=\"string\">&quot;Extention ClassLoaderåŠ è½½â½¬å½•ï¼š&quot;</span> + System.getProperty(<span class=\"string\">&quot;java.ext.dirs&quot;</span>));</span><br><span class=\"line\"><span class=\"comment\">// AppClassLoader åŠ è½½CLASSPATHï¼Œåº”â½¤ä¸‹çš„JaråŒ…ã€‚å¯é€šè¿‡-D java.class.pathå¦â¾æŒ‡å®šâ½¬å½•</span></span><br><span class=\"line\">System.out.println(<span class=\"string\">&quot;AppClassLoaderåŠ è½½â½¬å½•ï¼š&quot;</span> + System.getProperty(<span class=\"string\">&quot;java.class.path&quot;</span>));</span><br></pre></td></tr></table></figure>\n<h3 id=\"åŒäº²å§”æ´¾æœºåˆ¶çš„å®ç°åŸç†\">åŒäº²å§”æ´¾æœºåˆ¶çš„å®ç°åŸç†</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>java.lang.ClassLoader ç±»çš„ loadClass æ–¹æ³•æ˜¯åŒäº²å§”æ´¾çš„æ ¸å¿ƒå®ç°</p>\n</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * åŠ è½½æŒ‡å®šåç§°çš„ç±»ï¼Œå¹¶æ ¹æ® resolve å‚æ•°å†³å®šæ˜¯å¦è§£æè¯¥ç±»ã€‚</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> * è¯¥æ–¹æ³•å®ç°äº†ç±»åŠ è½½çš„åŸºæœ¬é€»è¾‘ï¼ŒåŒ…æ‹¬æ£€æŸ¥ç±»æ˜¯å¦å·²åŠ è½½ã€å§”æ‰˜çˆ¶ç±»åŠ è½½å™¨åŠ è½½ã€</span></span><br><span class=\"line\"><span class=\"comment\"> * è‡ªè¡ŒåŠ è½½ç±»ä»¥åŠè§£æç±»ç­‰æ­¥éª¤ã€‚è¯¥æ–¹æ³•æ˜¯ Java ç±»åŠ è½½æœºåˆ¶çš„æ ¸å¿ƒéƒ¨åˆ†ä¹‹ä¸€ï¼Œ</span></span><br><span class=\"line\"><span class=\"comment\"> * éµå¾ªåŒäº²å§”æ´¾æ¨¡å‹ã€‚</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> name    è¦åŠ è½½çš„ç±»çš„å…¨é™å®šå</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> resolve å¦‚æœä¸º trueï¼Œåˆ™åœ¨åŠ è½½åè§£æè¯¥ç±»</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@return</span> åŠ è½½çš„ Class å¯¹è±¡</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@throws</span> ClassNotFoundException å¦‚æœæ‰¾ä¸åˆ°æŒ‡å®šçš„ç±»</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"comment\">// è¿™ä¸ªâ½…æ³•æ˜¯protectedå£°æ˜çš„ï¼Œæ„å‘³ç€ï¼Œæ˜¯å¯ä»¥è¢«â¼¦ç±»è¦†ç›–çš„ï¼Œæ‰€ä»¥ï¼ŒåŒäº²å§”æ´¾æœºåˆ¶ä¹Ÿæ˜¯å¯ä»¥è¢«æ‰“ç ´çš„ï¼Œå¦‚Tomcatâ¼¦ç±»é‡å†™è¿™ä¸ªâ½…æ³•ï¼Œå¹¶ä½¿â½¤è‡ªå·±çš„ç±»åŠ è½½é€»è¾‘ã€‚</span></span><br><span class=\"line\"><span class=\"keyword\">protected</span> Class&lt;?&gt; loadClass(String name, <span class=\"type\">boolean</span> resolve)</span><br><span class=\"line\">        <span class=\"keyword\">throws</span> ClassNotFoundException &#123;</span><br><span class=\"line\">    <span class=\"comment\">// ä½¿ç”¨ synchronized ç¡®ä¿å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ç±»åŠ è½½çš„åŒæ­¥</span></span><br><span class=\"line\">    <span class=\"keyword\">synchronized</span> (getClassLoadingLock(name)) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// First, check if the class has already been loaded</span></span><br><span class=\"line\">        <span class=\"comment\">// æ¯ä¸ªç±»åŠ è½½å™¨å¯¹ä»–åŠ è½½è¿‡çš„ç±»éƒ½æœ‰â¼€ä¸ªç¼“å­˜ï¼Œå…ˆå»ç¼“å­˜ä¸­æŸ¥çœ‹æœ‰æ²¡æœ‰åŠ è½½è¿‡</span></span><br><span class=\"line\">        Class&lt;?&gt; c = findLoadedClass(name);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (c == <span class=\"literal\">null</span>) &#123; <span class=\"comment\">//æ²¡æœ‰åŠ è½½è¿‡ï¼Œå°±â¾›åŒäº²å§”æ´¾</span></span><br><span class=\"line\">            <span class=\"type\">long</span> <span class=\"variable\">t0</span> <span class=\"operator\">=</span> System.nanoTime();</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                <span class=\"comment\">// çˆ¶ç±»å­˜åœ¨åˆ™è®©â½—ç±»åŠ è½½å™¨è¿›â¾åŠ è½½</span></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (parent != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">                    c = parent.loadClass(name, <span class=\"literal\">false</span>);</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> &#123; <span class=\"comment\">//å¦‚æœçˆ¶ç±»ä¸å­˜åœ¨ï¼Œåˆ™ä»å¼•å¯¼ç±»åŠ è½½å™¨è¿›â¾åŠ è½½</span></span><br><span class=\"line\">                    c = findBootstrapClassOrNull(name);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (ClassNotFoundException e) &#123;</span><br><span class=\"line\">                <span class=\"comment\">// ClassNotFoundException thrown if class not found</span></span><br><span class=\"line\">                <span class=\"comment\">// from the non-null parent class loader</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (c == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">                <span class=\"comment\">// If still not found, then invoke findClass in order</span></span><br><span class=\"line\">                <span class=\"comment\">// to find the class.</span></span><br><span class=\"line\">                <span class=\"type\">long</span> <span class=\"variable\">t1</span> <span class=\"operator\">=</span> System.nanoTime();</span><br><span class=\"line\">                <span class=\"comment\">// findClass æ–¹æ³•æ˜¯å­ç±»å®ç°çš„ï¼Œç”¨äºåŠ è½½æŒ‡å®šåç§°çš„ç±»</span></span><br><span class=\"line\">                <span class=\"comment\">// â½—ç±»åŠ è½½å™¨æ²¡æœ‰åŠ è½½è¿‡ï¼Œå°±â¾ƒâ¾è§£æclassâ½‚ä»¶åŠ è½½</span></span><br><span class=\"line\">                c = findClass(name);</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"comment\">// this is the defining class loader; record the stats</span></span><br><span class=\"line\">                <span class=\"comment\">// æ€§èƒ½ç»Ÿè®¡ï¼šè®°å½•ç±»åŠ è½½è¿‡ç¨‹ä¸­çš„æ—¶é—´æ¶ˆè€—å’Œè°ƒç”¨æ¬¡æ•°ï¼Œä¾¿äºç›‘æ§å’Œä¼˜åŒ–ã€‚</span></span><br><span class=\"line\">                sun.misc.PerfCounter.getParentDelegationTime().addTime(t1 - t0);</span><br><span class=\"line\">                sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1);</span><br><span class=\"line\">                sun.misc.PerfCounter.getFindClasses().increment();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// é»˜è®¤æƒ…å†µä¸‹ï¼ŒåŒäº²å§”æ´¾æ¨¡å‹åªè¿›â¾äº†éªŒè¯å’Œå‡†å¤‡é˜¶æ®µï¼Œâ½½ä¸è¿›â¾è§£æ(å¦‚é“¾æ¥ã€åˆå§‹åŒ–)</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (resolve) &#123;</span><br><span class=\"line\">            resolveClass(c);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> c;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>è¯¥æ–¹æ³•å®ç°äº†ç±»åŠ è½½çš„åŸºæœ¬é€»è¾‘ï¼ŒåŒ…æ‹¬æ£€æŸ¥ç±»æ˜¯å¦å·²åŠ è½½ã€å§”æ‰˜çˆ¶ç±»åŠ è½½å™¨åŠ è½½ã€è‡ªè¡ŒåŠ è½½ç±»ä»¥åŠè§£æç±»ç­‰æ­¥éª¤ã€‚è¯¥æ–¹æ³•æ˜¯ Java ç±»åŠ è½½æœºåˆ¶çš„æ ¸å¿ƒéƒ¨åˆ†ä¹‹ä¸€ï¼Œéµå¾ªåŒäº²å§”æ´¾æ¨¡å‹ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>è¿™ä¸ªâ½…æ³•æ˜¯<code>protected</code>å£°æ˜çš„ï¼Œæ„å‘³ç€ï¼Œæ˜¯å¯ä»¥è¢«â¼¦ç±»è¦†ç›–çš„ï¼Œæ‰€ä»¥ï¼ŒåŒäº²å§”æ´¾æœºåˆ¶ä¹Ÿæ˜¯å¯ä»¥è¢«æ‰“ç ´çš„ï¼Œå¦‚Tomcatâ¼¦ç±»é‡å†™è¿™ä¸ªâ½…æ³•ï¼Œå¹¶ä½¿â½¤è‡ªå·±çš„ç±»åŠ è½½é€»è¾‘ã€‚</p>\n</li>\n</ul>\n<h2 id=\"æ²™ç®±ä¿æŠ¤æœºåˆ¶\">æ²™ç®±ä¿æŠ¤æœºåˆ¶</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æ²™ç®±ä¿æŠ¤æœºåˆ¶æ˜¯ Java è™šæ‹Ÿæœºæä¾›çš„ä¸€ç§å®‰å…¨æœºåˆ¶ï¼Œç”¨äºä¿æŠ¤åº”ç”¨ç¨‹åºå…å—æ¶æ„ä»£ç çš„æ”»å‡»ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>java.lang.ClassLoader ç±»çš„ preDefineClass æ–¹æ³•æ˜¯æ²™ç®±ä¿æŠ¤æœºåˆ¶çš„æ ¸å¿ƒå®ç°</p>\n</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// è¿™ä¸ªæ–¹æ³•åœ¨åŒäº²å§”æ´¾æ¨¡å‹ä¹‹å‰è¢«è°ƒç”¨ï¼Œç”¨äºåœ¨åŠ è½½ç±»ä¹‹å‰è¿›è¡Œä¸€äº›é¢„å¤„ç†æ“ä½œã€‚</span></span><br><span class=\"line\"><span class=\"comment\">// å‚æ•°ï¼š</span></span><br><span class=\"line\"><span class=\"comment\">// name: è¦åŠ è½½çš„ç±»çš„å…¨é™å®šåã€‚</span></span><br><span class=\"line\"><span class=\"comment\">// pd: æä¾›çš„ä¿æŠ¤åŸŸä¿¡æ¯ï¼Œå¯èƒ½ä¸º nullã€‚</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> ProtectionDomain <span class=\"title function_\">preDefineClass</span><span class=\"params\">(String name,</span></span><br><span class=\"line\"><span class=\"params\">                                            ProtectionDomain pd)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!checkName(name))</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">NoClassDefFoundError</span>(<span class=\"string\">&quot;IllegalName: &quot;</span> + name);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// Note:  Checking logic in java.lang.invoke.MemberName.checkForTypeAlias</span></span><br><span class=\"line\">        <span class=\"comment\">// relies on the fact that spoofing is impossible if a class has a name</span></span><br><span class=\"line\">        <span class=\"comment\">// of the form &quot;java.*&quot;</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((name != <span class=\"literal\">null</span>) &amp;&amp; name.startsWith(<span class=\"string\">&quot;java.&quot;</span>)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">SecurityException</span></span><br><span class=\"line\">                (<span class=\"string\">&quot;Prohibited package name: &quot;</span> +</span><br><span class=\"line\">                 name.substring(<span class=\"number\">0</span>, name.lastIndexOf(<span class=\"string\">&#x27;.&#x27;</span>)));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (pd == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            pd = defaultDomain;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (name != <span class=\"literal\">null</span>) checkCerts(name, pd.getCodeSource());</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> pd;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>è¿™ä¸ªæ–¹æ³• <code>preDefineClass</code> çš„ä½œç”¨æ˜¯åœ¨ç±»è¢«å®šä¹‰ä¹‹å‰è¿›è¡Œä¸€äº›å®‰å…¨æ£€æŸ¥å’Œå‡†å¤‡å·¥ä½œï¼Œç¡®ä¿ç±»çš„åˆæ³•æ€§ä¸å®‰å…¨æ€§ã€‚å®ƒé€šå¸¸ç”¨äºè‡ªå®šä¹‰ç±»åŠ è½½å™¨ä¸­ï¼Œä»¥å¢å¼ºç±»åŠ è½½è¿‡ç¨‹ä¸­çš„å®‰å…¨æ§åˆ¶ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>æ–¹æ³•ä½œç”¨è¯¦è§£ï¼š</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-4\">1.é˜²æ­¢å®šä¹‰éæ³•ç±»åçš„ç±»ï¼ˆå¦‚ java.* åŒ…ä¸‹çš„ç±»ï¼‰ï¼š\n<ul class=\"lvl-4\">\n<li class=\"lvl-6\">å¦‚æœå°è¯•åŠ è½½çš„ç±»å±äº java. å¼€å¤´çš„æ ‡å‡†åŒ…ï¼ˆå¦‚ java.lang, java.util ç­‰ï¼‰ï¼Œä¼šæŠ›å‡º SecurityExceptionã€‚</li>\n<li class=\"lvl-6\">è¿™æ˜¯ä¸ºäº†é˜²æ­¢ç”¨æˆ·è‡ªå®šä¹‰ç±»ä¼ªè£…æˆ Java æ ¸å¿ƒç±»åº“ä¸­çš„ç±»ï¼Œä»è€Œé€ æˆå®‰å…¨é£é™©ã€‚</li>\n</ul>\n</li>\n<li class=\"lvl-4\">2.æ ¡éªŒç±»ååˆæ³•æ€§ï¼š\n<ul class=\"lvl-4\">\n<li class=\"lvl-6\">è°ƒç”¨ checkName(name) æ£€æŸ¥ç±»åæ˜¯å¦åˆæ³•ï¼ˆä¾‹å¦‚ä¸èƒ½åŒ…å« /ã€éæ³•å­—ç¬¦ç­‰ï¼‰ï¼Œè‹¥ä¸åˆæ³•åˆ™æŠ›å‡º NoClassDefFoundErrorã€‚</li>\n</ul>\n</li>\n<li class=\"lvl-4\">3.è¯ä¹¦ä¸€è‡´æ€§æ ¡éªŒï¼ˆç­¾åä¸€è‡´æ€§æ ¡éªŒï¼‰ï¼š\n<ul class=\"lvl-4\">\n<li class=\"lvl-6\">å¦‚æœç±»æœ‰åç§°ä¸”æä¾›äº† ProtectionDomainï¼Œä¼šè°ƒç”¨ checkCerts(name, codeSource) æ¥ç¡®ä¿å½“å‰ç±»çš„ç­¾åä¸å…¶æ‰€åœ¨åŒ…ä¸­å…¶ä»–ç±»çš„ç­¾åä¸€è‡´ã€‚</li>\n<li class=\"lvl-6\">é˜²æ­¢åŒä¸€åŒ…ä¸­æ··å…¥ä¸åŒç­¾åçš„ç±»ï¼Œé¿å…æ½œåœ¨çš„æ¶æ„ç¯¡æ”¹ã€‚</li>\n</ul>\n</li>\n<li class=\"lvl-4\">4.è®¾ç½®é»˜è®¤ä¿æŠ¤åŸŸï¼ˆProtectionDomainï¼‰ï¼š\n<ul class=\"lvl-4\">\n<li class=\"lvl-6\">å¦‚æœä¼ å…¥çš„ ProtectionDomain ä¸º nullï¼Œåˆ™ä½¿ç”¨ç±»åŠ è½½å™¨çš„é»˜è®¤åŸŸ defaultDomainã€‚</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"Linkingé“¾æ¥è¿‡ç¨‹\">Linkingé“¾æ¥è¿‡ç¨‹</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åœ¨ClassLoaderçš„<code>loadClass</code>â½…æ³•ä¸­ï¼Œè¿˜æœ‰â¼€ä¸ªä¸èµ·çœ¼çš„æ­¥éª¤ï¼Œ<code>resolveClass</code>ã€‚è¿™æ˜¯â¼€ä¸ª<code>native</code>â½…æ³•ã€‚â½½å…¶å®ç°çš„è¿‡ç¨‹ç§°ä¸º<code>linking-é“¾æ¥</code>ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>é“¾æ¥è¿‡ç¨‹çš„å®ç°åŠŸèƒ½å¦‚ä¸‹å›¾ï¼š<br>\n<img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/9vkhLN.png\" alt=\"\" width=\"900\" height=\"500\"></p>\n</li>\n<li class=\"lvl-2\">\n<p>å…¶ä¸­å…³äºåŠåˆå§‹åŒ–çŠ¶æ€å°±æ˜¯JDKåœ¨å¤„ç†â¼€ä¸ªç±»çš„staticé™æ€å±æ€§æ—¶ï¼Œä¼šå…ˆç»™è¿™ä¸ªå±æ€§åˆ†é…â¼€ä¸ªé»˜è®¤å€¼ï¼Œä½œâ½¤æ˜¯å ä½å†…å­˜ã€‚ç„¶åç­‰è¿æ¥è¿‡ç¨‹å®Œæˆåï¼Œåœ¨åâ¾¯çš„åˆå§‹åŒ–é˜¶æ®µï¼Œå†å°†é™æ€å±æ€§ä»é»˜è®¤å€¼ä¿®æ”¹ä¸ºæŒ‡å®šçš„åˆå§‹å€¼ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>ç¬¦å·å¼•â½¤å’Œç›´æ¥å¼•â½¤</p>\n</li>\n</ul>\n<blockquote>\n<p>å¦‚æœAç±»ä¸­æœ‰â¼€ä¸ªé™æ€å±æ€§ï¼Œå¼•â½¤äº†å¦â¼€ä¸ªBç±»ã€‚é‚£ä¹ˆåœ¨å¯¹ç±»è¿›â¾åˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­ï¼Œå› ä¸ºAå’ŒBè¿™ä¸¤ä¸ªç±»éƒ½æ²¡æœ‰åˆå§‹åŒ–ï¼ŒJVMå¹¶ä¸çŸ¥é“Aå’ŒBè¿™ä¸¤ä¸ªç±»çš„å…·ä½“åœ°å€ã€‚æ‰€ä»¥è¿™æ—¶ï¼Œåœ¨Aç±»ä¸­ï¼Œåªèƒ½åˆ›å»ºâ¼€ä¸ªä¸çŸ¥é“å…·ä½“åœ°å€çš„å¼•â½¤ï¼ŒæŒ‡å‘Bç±»ã€‚è¿™ä¸ªå¼•â½¤å°±ç§°ä¸ºç¬¦å·å¼•â½¤ã€‚â½½å½“Aç±»å’ŒBç±»éƒ½å®Œæˆåˆå§‹åŒ–åï¼ŒJVMâ¾ƒç„¶å°±éœ€è¦å°†è¿™ä¸ªç¬¦å·å¼•â½¤è½¬â½½æŒ‡å‘Bç±»å…·ä½“çš„å†…å­˜åœ°å€ï¼Œè¿™ä¸ªå¼•â½¤å°±ç§°ä¸ºç›´æ¥å¼•â½¤ã€‚</p>\n</blockquote>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æ¥çœ‹ä¸€ä¸ªæœ‰æ„æ€çš„ç¤ºä¾‹</p>\n</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Apple</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// é™æ€å˜é‡æŒ‰å£°æ˜é¡ºåºåˆå§‹åŒ–</span></span><br><span class=\"line\">    <span class=\"comment\">// æ„é€ æ–¹æ³•åˆå§‹åŒ–appleå¯¹è±¡æ—¶ï¼Œpriceè¿˜æ²¡æœ‰è¢«åˆå§‹åŒ–ï¼Œå¤„äºé“¾æ¥è¿‡ç¨‹ä¸­çš„å‡†å¤‡é˜¶æ®µï¼Œå³åŠåˆå§‹åŒ–çŠ¶æ€ï¼Œæ‰€ä»¥priceä¸ºé»˜è®¤å€¼0.0</span></span><br><span class=\"line\">    <span class=\"keyword\">static</span> <span class=\"type\">Apple</span> <span class=\"variable\">apple</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Apple</span>(<span class=\"number\">10</span>);</span><br><span class=\"line\">    <span class=\"comment\">// è§£å†³æ–¹æ³•æ˜¯å°†priceå£°æ˜åœ¨appleçš„ä¸Šé¢å³å¯</span></span><br><span class=\"line\">    <span class=\"keyword\">static</span> <span class=\"type\">double</span> <span class=\"variable\">price</span> <span class=\"operator\">=</span> <span class=\"number\">20.00</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"type\">double</span> totalpay;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"title function_\">Apple</span><span class=\"params\">(<span class=\"type\">double</span> discount)</span> &#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;====&quot;</span> + price);</span><br><span class=\"line\">        totalpay = price - discount;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">PriceTest</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> &#123;</span><br><span class=\"line\">        System.out.println(Apple.apple.totalpay); <span class=\"comment\">// -10.0</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>è¿™é‡Œæœ‰ä¸€ä¸ªæœ‰æ„æ€çš„é—®é¢˜ï¼Œå°±æ˜¯åªæœ‰å½“<code>loadClass</code>æ–¹æ³•ä¸­çš„<code>resolve</code>å‚æ•°ä¸º<code>true</code>æ—¶<code>resolveClass</code>æ–¹æ³•æ‰ä¼šè¢«è°ƒç”¨ï¼Œä½†æ˜¯å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œ<code>resolve</code>å‚æ•°éƒ½æ˜¯<code>false</code>ï¼Œè¿™ä¸æ˜¯å¼ºåˆ¶é™åˆ¶è€Œæ˜¯å‡ºäºä»¥ä¸‹åŸå› ï¼š</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-4\">\n<ol>\n<li class=\"lvl-7\">é¿å…é€’å½’è§£æä¸­å‡ºç°é”™è¯¯æˆ–æ­»å¾ªç¯<br>\nåœ¨ç±»çš„è§£æè¿‡ç¨‹ä¸­ï¼Œå¦‚æœè¯¥ç±»å¼•ç”¨äº†å¦ä¸€ä¸ªè¿˜æ²¡åŠ è½½çš„ç±»ï¼Œç«‹å³è§£æå¯èƒ½ä¼šå¯¼è‡´æ— é™é€’å½’æˆ–åŠ è½½é¡ºåºé—®é¢˜ã€‚é€šè¿‡å»¶è¿Ÿè§£æï¼Œå¯ä»¥æ›´å¥½åœ°æ§åˆ¶åŠ è½½æµç¨‹ã€‚</li>\n</ol>\n</li>\n<li class=\"lvl-4\">\n<ol start=\"2\">\n<li class=\"lvl-7\">æé«˜åŠ è½½æ•ˆç‡<br>\nåŠ è½½ç±»å¯èƒ½ä¸ä¸€å®šé©¬ä¸Šå°±ç”¨åˆ°æ‰€æœ‰æ–¹æ³•ã€å­—æ®µç­‰ç¬¦å·å¼•ç”¨ï¼Œæ¨è¿Ÿè§£æå¯ä»¥æé«˜æ€§èƒ½ï¼Œå°¤å…¶åœ¨æ‰¹é‡åŠ è½½å¾ˆå¤šç±»æ—¶ã€‚</li>\n</ol>\n</li>\n<li class=\"lvl-4\">\n<ol start=\"3\">\n<li class=\"lvl-7\">æ›´çµæ´»åœ°å¤„ç†ç±»çš„ä¾èµ–<br>\nå¼€å‘è€…å¯ä»¥å…ˆåŠ è½½ç±»ï¼Œç¨åæ ¹æ®éœ€è¦å†è§£æã€‚ä¾‹å¦‚ï¼Œåœ¨è‡ªå®šä¹‰ç±»åŠ è½½å™¨ä¸­ï¼Œå¯èƒ½å…ˆåˆ¤æ–­ç±»æ˜¯å¦å·²ç»å­˜åœ¨ã€æ˜¯å¦éœ€è¦è¢«å¢å¼ºï¼ˆæ¯”å¦‚å­—èŠ‚ç å¢å¼ºï¼‰ï¼Œå†å†³å®šæ˜¯å¦è§£æã€‚</li>\n</ol>\n</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"é€šè¿‡ç±»åŠ è½½å™¨å¼•â¼Šå¤–éƒ¨JaråŒ…\">é€šè¿‡ç±»åŠ è½½å™¨å¼•â¼Šå¤–éƒ¨JaråŒ…</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>è™½ç„¶é€šå¸¸æˆ‘ä»¬ä¼šå°†ä¾èµ–çš„ jar åŒ…ç›´æ¥æ”¾å…¥é¡¹ç›®çš„ classpath ä¸­ï¼ˆæ¯”å¦‚é€šè¿‡æ„å»ºå·¥å…·å¦‚ Maven æˆ– Gradle ç®¡ç†ï¼‰ï¼Œä½†åœ¨æŸäº›ç‰¹å®šåœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬ç¡®å®éœ€è¦åŠ¨æ€åœ°é€šè¿‡ URLClassLoader åŠ è½½å¤–éƒ¨ jar åŒ…ï¼Œè¿™æ˜¯ Java æä¾›çš„ä¸€ç§æ›´çµæ´»çš„ç±»åŠ è½½æœºåˆ¶ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>ä»¥ä¸‹æ˜¯ä¸€äº›å¿…é¡»æˆ–æ¨èä½¿ç”¨ URLClassLoader çš„å…¸å‹åº”ç”¨åœºæ™¯ï¼š</p>\n</li>\n</ul>\n<h3 id=\"1-æ’ä»¶æœºåˆ¶ï¼ˆPlugin-Systemï¼‰\">1. æ’ä»¶æœºåˆ¶ï¼ˆPlugin Systemï¼‰</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åœºæ™¯è¯´æ˜ï¼š<br>\nç³»ç»Ÿæ”¯æŒç”¨æˆ·è‡ªå®šä¹‰æ’ä»¶ï¼ˆå¦‚ IDE æ’ä»¶ã€æµè§ˆå™¨æ‰©å±•ã€æ¸¸æˆ modï¼‰ï¼Œè¿™äº›æ’ä»¶åœ¨è¿è¡Œæ—¶æ‰åŠ è½½ï¼Œé¡¹ç›®æœ¬èº«åœ¨ç¼–è¯‘æœŸå¹¶ä¸çŸ¥é“æœ‰å“ªäº›æ’ä»¶ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>ä¸¾ä¾‹ï¼š<br>\nEclipse æˆ– IntelliJ çš„æ’ä»¶ç³»ç»Ÿ<br>\nMinecraft çš„ mod åŠ è½½å™¨<br>\nSpring Boot Devtools é‡æ–°åŠ è½½æœºåˆ¶</p>\n</li>\n<li class=\"lvl-2\">\n<p>ä¸ºä»€ä¹ˆä¸èƒ½ç›´æ¥æ”¾å…¥ classpathï¼Ÿ<br>\nå› ä¸ºæ’ä»¶æ˜¯åŠ¨æ€å‘ç°å’ŒåŠ è½½çš„ï¼Œä¸æ˜¯ç¼–è¯‘æ—¶ç¡®å®šçš„ã€‚</p>\n</li>\n</ul>\n<h3 id=\"2-çƒ­éƒ¨ç½²-åŠ¨æ€åŠ è½½ç±»\">2. çƒ­éƒ¨ç½² / åŠ¨æ€åŠ è½½ç±»</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åœºæ™¯è¯´æ˜ï¼š<br>\nä½ æƒ³åœ¨åº”ç”¨è¿è¡Œè¿‡ç¨‹ä¸­åŠ è½½æ–°çš„ jar æˆ–ç±»ï¼Œæ¯”å¦‚çƒ­æ›´æ–°ä¸€ä¸ªæ¨¡å—è€Œæ— éœ€é‡å¯æœåŠ¡ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>ä¸¾ä¾‹ï¼š<br>\nWeb å®¹å™¨ï¼ˆå¦‚ Tomcatï¼‰çš„åº”ç”¨é‡æ–°éƒ¨ç½²<br>\nä½¿ç”¨ URLClassLoader åŠ è½½æŸä¸ªæ¨¡å—çš„æ–°ç‰ˆæœ¬ä»¥å®ç°çƒ­æ›¿æ¢</p>\n</li>\n<li class=\"lvl-2\">\n<p>ä¸ºä»€ä¹ˆä¸èƒ½æ”¾å…¥ classpathï¼Ÿ<br>\nclasspath åœ¨å¯åŠ¨æ—¶å°±å›ºå®šäº†ï¼Œä¸èƒ½åŠ¨æ€æ·»åŠ ï¼›è€Œ URLClassLoader å¯ä»¥è¿è¡Œæ—¶åŠ è½½æ–° jarã€‚</p>\n</li>\n</ul>\n<h3 id=\"3-å¤šç‰ˆæœ¬éš”ç¦»\">3. å¤šç‰ˆæœ¬éš”ç¦»</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åœºæ™¯è¯´æ˜ï¼š<br>\nä½ å¸Œæœ›ä¸åŒçš„æ¨¡å—ä½¿ç”¨åŒä¸€ä¸ªåº“çš„ä¸åŒç‰ˆæœ¬ï¼Œä½† classpath æ— æ³•æ”¯æŒä¸¤ä¸ªç‰ˆæœ¬çš„åŒä¸€ä¸ªç±»ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>ä¸¾ä¾‹ï¼š<br>\nä¸€ä¸ªæœåŠ¡å™¨è¿è¡Œå¤šä¸ªæœåŠ¡å®ä¾‹ï¼Œå®ƒä»¬åˆ†åˆ«ä¾èµ– log4j çš„ä¸åŒç‰ˆæœ¬<br>\nä¸€ä¸ªç³»ç»Ÿçš„æ’ä»¶ A ä½¿ç”¨ fastjson 1.xï¼Œæ’ä»¶ B ä½¿ç”¨ fastjson 2.x</p>\n</li>\n<li class=\"lvl-2\">\n<p>ä¸ºä»€ä¹ˆä¸èƒ½æ”¾å…¥ classpathï¼Ÿ<br>\nclasspath æ˜¯å…±äº«çš„ï¼Œä¼šå‘ç”Ÿç±»å†²çªã€‚ä½¿ç”¨å¤šä¸ª URLClassLoaderï¼Œå¯å®ç°ç±»éš”ç¦»ã€‚</p>\n</li>\n</ul>\n<h3 id=\"4-è„šæœ¬æˆ–ç”¨æˆ·ä¸Šä¼ ä»£ç æ‰§è¡Œ\">4. è„šæœ¬æˆ–ç”¨æˆ·ä¸Šä¼ ä»£ç æ‰§è¡Œ</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åœºæ™¯è¯´æ˜ï¼š<br>\nç³»ç»Ÿå…è®¸ç”¨æˆ·ä¸Šä¼  jar æˆ– class æ–‡ä»¶ï¼Œç„¶ååœ¨æœåŠ¡ç«¯æ‰§è¡Œå…¶ä¸­çš„ç±»é€»è¾‘ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>ä¸¾ä¾‹ï¼š<br>\nåœ¨çº¿ç¼–ç¨‹å¹³å°ï¼ˆå¦‚ LeetCode åç«¯ï¼‰<br>\nç”¨æˆ·ä¸Šä¼ ç®—æ³• jarï¼Œå¹³å°è¿è¡Œå¹¶è¿”å›ç»“æœ</p>\n</li>\n<li class=\"lvl-2\">\n<p>ä¸ºä»€ä¹ˆä¸èƒ½æ”¾å…¥ classpathï¼Ÿ<br>\nç”¨æˆ·ä¸Šä¼ å†…å®¹æ˜¯åŠ¨æ€çš„ï¼Œç³»ç»Ÿåœ¨è¿è¡Œå‰æ— æ³•é¢„çŸ¥ã€‚</p>\n</li>\n</ul>\n<h3 id=\"5-å®ç°ç±»çš„å»¶è¿ŸåŠ è½½ï¼ˆèŠ‚çœèµ„æºï¼‰\">5. å®ç°ç±»çš„å»¶è¿ŸåŠ è½½ï¼ˆèŠ‚çœèµ„æºï¼‰</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åœºæ™¯è¯´æ˜ï¼š<br>\næŸäº›ç±»/æ¨¡å—ä½“ç§¯è¾ƒå¤§æˆ–ä¾èµ–è¾ƒå¤šï¼Œä¸å¸Œæœ›åœ¨ç¨‹åºå¯åŠ¨æ—¶å°±åŠ è½½ï¼Œåªæœ‰çœŸæ­£ä½¿ç”¨æ—¶å†åŠ è½½ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>ä¸¾ä¾‹ï¼š<br>\nå¤§å‹æ¡Œé¢åº”ç”¨ï¼ˆå¦‚ IntelliJï¼‰åœ¨æ‰“å¼€æŸä¸ªåŠŸèƒ½æ¨¡å—æ—¶æ‰åŠ è½½ç›¸åº” jar</p>\n</li>\n</ul>\n<h3 id=\"æ€»ç»“\">æ€»ç»“</h3>\n<table>\n<thead>\n<tr>\n<th>åœºæ™¯</th>\n<th>ä½¿ç”¨ <code>URLClassLoader</code> çš„åŸå› </th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>æ’ä»¶ç³»ç»Ÿ</td>\n<td>æ’ä»¶åŠ¨æ€åŠ è½½ï¼Œä¸åœ¨é¡¹ç›®ç¼–è¯‘æ—¶å¯çŸ¥</td>\n</tr>\n<tr>\n<td>çƒ­éƒ¨ç½²</td>\n<td>åŠ¨æ€æ›¿æ¢æ¨¡å—ï¼Œæ— éœ€é‡å¯</td>\n</tr>\n<tr>\n<td>å¤šç‰ˆæœ¬å…±å­˜</td>\n<td>é¿å…ç±»å†²çªï¼Œå®ç°ç±»åŠ è½½éš”ç¦»</td>\n</tr>\n<tr>\n<td>ç”¨æˆ·ä¸Šä¼  jar</td>\n<td>å†…å®¹åŠ¨æ€ç”Ÿæˆï¼Œclasspath æ— æ³•é¢„å…ˆé…ç½®</td>\n</tr>\n<tr>\n<td>å»¶è¿ŸåŠ è½½æ¨¡å—</td>\n<td>å¯åŠ¨æ›´å¿«ï¼ŒèŠ‚çœå†…å­˜</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å¦‚æœä½ æ˜¯åœ¨åšæ¡†æ¶è®¾è®¡æˆ–éœ€è¦åŠ¨æ€æ‰©å±•èƒ½åŠ›çš„åœºæ™¯ï¼Œç†è§£å¹¶ä½¿ç”¨ URLClassLoader ä¼šéå¸¸æœ‰å¸®åŠ©ã€‚</p>\n</li>\n</ul>\n<h3 id=\"åœºæ™¯å‡è®¾\">åœºæ™¯å‡è®¾</h3>\n<h4 id=\"è°ƒç”¨å¤–éƒ¨jar\">è°ƒç”¨å¤–éƒ¨jar</h4>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æˆ‘ä»¬æœ‰ä¸€ä¸ªå¤–éƒ¨ jar æ–‡ä»¶ï¼šhello-plugin.jarï¼Œå®ƒåŒ…å«ä¸€ä¸ªç±»ï¼š</p>\n</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// è¿™ä¸ªç±»ç¼–è¯‘åæ‰“åŒ…è¿› hello-plugin.jar</span></span><br><span class=\"line\"><span class=\"keyword\">package</span> com.example.plugin;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">HelloPlugin</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">sayHello</span><span class=\"params\">(String name)</span> &#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;Hello from plugin! :&quot;</span> + name);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ä¸»ç¨‹åºä½¿ç”¨ URLClassLoader åŠ¨æ€åŠ è½½è¿™ä¸ª jar</p>\n</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> java.io.File;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.lang.reflect.Method;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.net.URL;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.net.URLClassLoader;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">PluginLoader</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        <span class=\"comment\">// å¤–éƒ¨ jar çš„è·¯å¾„</span></span><br><span class=\"line\">        <span class=\"type\">File</span> <span class=\"variable\">jarFile</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">File</span>(<span class=\"string\">&quot;plugins/hello-plugin.jar&quot;</span>);</span><br><span class=\"line\">        <span class=\"type\">URL</span> <span class=\"variable\">jarUrl</span> <span class=\"operator\">=</span> jarFile.toURI().toURL();</span><br><span class=\"line\">        <span class=\"comment\">// HTTPS jar çš„ URL</span></span><br><span class=\"line\">        <span class=\"comment\">// URL jarUrl = new URL(&quot;https://your-domain.com/libs/hello-plugin.jar&quot;);</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// æ„å»º URLClassLoaderï¼ˆä¹Ÿå¯ä»¥è®¾ç½®çˆ¶åŠ è½½å™¨ï¼‰</span></span><br><span class=\"line\">        <span class=\"type\">URLClassLoader</span> <span class=\"variable\">classLoader</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">URLClassLoader</span>(<span class=\"keyword\">new</span> <span class=\"title class_\">URL</span>[]&#123;jarUrl&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// åŠ è½½æ’ä»¶ç±»</span></span><br><span class=\"line\">        Class&lt;?&gt; clazz = classLoader.loadClass(<span class=\"string\">&quot;com.example.plugin.HelloPlugin&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// åˆ›å»ºå®ä¾‹å¹¶è°ƒç”¨æ–¹æ³•</span></span><br><span class=\"line\">        <span class=\"type\">Object</span> <span class=\"variable\">plugin</span> <span class=\"operator\">=</span> clazz.getDeclaredConstructor().newInstance();</span><br><span class=\"line\">        <span class=\"type\">Method</span> <span class=\"variable\">sayHello</span> <span class=\"operator\">=</span> clazz.getMethod(<span class=\"string\">&quot;sayHello&quot;</span>, String.class);</span><br><span class=\"line\">        sayHello.invoke(plugin, <span class=\"string\">&quot;World&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// å…³é—­ ClassLoaderï¼ˆJava 7+ æ¨èï¼‰</span></span><br><span class=\"line\">        classLoader.close();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"è¿è¡Œæ—¶åŠ¨æ€ç¼–è¯‘-Java-æºä»£ç \">è¿è¡Œæ—¶åŠ¨æ€ç¼–è¯‘ Java æºä»£ç </h4>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æˆ‘ä»¬æœ‰ä¸€ä¸ª java ä»£ç ç‰‡æ®µï¼š</p>\n</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> javax.tools.JavaCompiler;</span><br><span class=\"line\"><span class=\"keyword\">import</span> javax.tools.ToolProvider;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.File;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.FileWriter;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.lang.reflect.Method;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.net.URL;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.net.URLClassLoader;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.nio.file.Files;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.nio.file.Path;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">DynamicJavaRunner</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">className</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;com.example.dynamic.Hello&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// Java æºä»£ç </span></span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">sourceCode</span> <span class=\"operator\">=</span></span><br><span class=\"line\">                <span class=\"string\">&quot;package com.example.dynamic;\\n&quot;</span> +</span><br><span class=\"line\">                        <span class=\"string\">&quot;\\n&quot;</span> +</span><br><span class=\"line\">                        <span class=\"string\">&quot;public class Hello &#123;\\n&quot;</span> +</span><br><span class=\"line\">                        <span class=\"string\">&quot;    public void say() &#123;\\n&quot;</span> +</span><br><span class=\"line\">                        <span class=\"string\">&quot;        System.out.println(\\&quot;Hello from dynamic source!\\&quot;);\\n&quot;</span> +</span><br><span class=\"line\">                        <span class=\"string\">&quot;    &#125;\\n&quot;</span> +</span><br><span class=\"line\">                        <span class=\"string\">&quot;&#125;\\n&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// åˆ›å»ºä¸´æ—¶ç›®å½•</span></span><br><span class=\"line\">        <span class=\"type\">Path</span> <span class=\"variable\">tempDir</span> <span class=\"operator\">=</span> Files.createTempDirectory(<span class=\"string\">&quot;dynamic-classes&quot;</span>);</span><br><span class=\"line\">        <span class=\"type\">File</span> <span class=\"variable\">outputDir</span> <span class=\"operator\">=</span> tempDir.toFile();</span><br><span class=\"line\">        <span class=\"comment\">// System.out.println(&quot;ä¸´æ—¶ç›®å½•ï¼š&quot; + outputDir.getAbsolutePath());</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// åˆ›å»º .java æ–‡ä»¶</span></span><br><span class=\"line\">        <span class=\"type\">File</span> <span class=\"variable\">javaFile</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">File</span>(outputDir, <span class=\"string\">&quot;com/example/dynamic/Hello.java&quot;</span>);</span><br><span class=\"line\">        javaFile.getParentFile().mkdirs();</span><br><span class=\"line\">        <span class=\"keyword\">try</span> (<span class=\"type\">FileWriter</span> <span class=\"variable\">writer</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">FileWriter</span>(javaFile)) &#123;</span><br><span class=\"line\">            writer.write(sourceCode);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// ç¼–è¯‘ Java æ–‡ä»¶</span></span><br><span class=\"line\">        <span class=\"type\">JavaCompiler</span> <span class=\"variable\">compiler</span> <span class=\"operator\">=</span> ToolProvider.getSystemJavaCompiler();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (compiler == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            System.err.println(<span class=\"string\">&quot;è¯·ç”¨ JDK è€Œé JRE è¿è¡Œï¼&quot;</span>);</span><br><span class=\"line\">            <span class=\"keyword\">return</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"type\">int</span> <span class=\"variable\">result</span> <span class=\"operator\">=</span> compiler.run(<span class=\"literal\">null</span>, <span class=\"literal\">null</span>, <span class=\"literal\">null</span>, javaFile.getPath());</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (result != <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            System.err.println(<span class=\"string\">&quot;ç¼–è¯‘å¤±è´¥ï¼&quot;</span>);</span><br><span class=\"line\">            <span class=\"keyword\">return</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// åŠ è½½ç±»å¹¶è°ƒç”¨</span></span><br><span class=\"line\">        <span class=\"type\">URLClassLoader</span> <span class=\"variable\">classLoader</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">URLClassLoader</span>(<span class=\"keyword\">new</span> <span class=\"title class_\">URL</span>[]&#123;outputDir.toURI().toURL()&#125;);</span><br><span class=\"line\">        Class&lt;?&gt; clazz = classLoader.loadClass(className);</span><br><span class=\"line\">        <span class=\"type\">Object</span> <span class=\"variable\">instance</span> <span class=\"operator\">=</span> clazz.getDeclaredConstructor().newInstance();</span><br><span class=\"line\">        <span class=\"type\">Method</span> <span class=\"variable\">method</span> <span class=\"operator\">=</span> clazz.getMethod(<span class=\"string\">&quot;say&quot;</span>);</span><br><span class=\"line\">        method.invoke(instance);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// æ¸…ç†ï¼ˆå¯é€‰ï¼‰</span></span><br><span class=\"line\">        classLoader.close();</span><br><span class=\"line\">        <span class=\"comment\">// åˆ é™¤ä¸´æ—¶ç›®å½•</span></span><br><span class=\"line\">        Files.walk(outputDir.toPath())</span><br><span class=\"line\">                .sorted(Comparator.reverseOrder()) <span class=\"comment\">// å…ˆåˆ æ–‡ä»¶ï¼Œå†åˆ ç›®å½•</span></span><br><span class=\"line\">                .map(Path::toFile)</span><br><span class=\"line\">                .forEach(File::delete);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å…³é”®ç‚¹è¯´æ˜</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>æœºåˆ¶</th>\n<th>è¯´æ˜</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>JavaCompiler</code></td>\n<td>JDK è‡ªå¸¦çš„ç¼–è¯‘å™¨ï¼ˆ<code>tools.jar</code>ï¼‰</td>\n</tr>\n<tr>\n<td><code>ToolProvider.getSystemJavaCompiler()</code></td>\n<td>åªèƒ½åœ¨ JDK ç¯å¢ƒä¸­å·¥ä½œï¼ŒJRE æ— æ³•ä½¿ç”¨</td>\n</tr>\n<tr>\n<td><code>URLClassLoader</code></td>\n<td>ç”¨äºåŠ è½½ç¼–è¯‘åçš„ .class æ–‡ä»¶</td>\n</tr>\n<tr>\n<td><code>FileWriter</code></td>\n<td>ä¿å­˜ä»£ç ä¸ºä¸´æ—¶ Java æ–‡ä»¶</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"è‡ªå®šä¹‰ç±»åŠ è½½å™¨\">è‡ªå®šä¹‰ç±»åŠ è½½å™¨</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>è¦è‡ªå®šä¹‰ ClassLoaderï¼Œåªéœ€è¦ç»§æ‰¿äº <code>ClassLoader</code> æˆ–è€… <code>SecureClassLoader</code>ï¼Œå¹¶é‡å†™ <code>findClass()</code> æ–¹æ³•å³å¯</p>\n</li>\n<li class=\"lvl-2\">\n<p>ç¤ºä¾‹ï¼šæˆ‘ä»¬å¯¹ä¸Šé¢çš„ä»£ç è¿›è¡Œå‡çº§ï¼Œä¸åˆ›å»ºä¸´æ—¶æ–‡ä»¶ï¼Œè€Œæ˜¯åœ¨å†…å­˜ä¸­ç¼–è¯‘ä»£ç ï¼Œå¹¶ä»å†…å­˜ä¸­åŠ è½½å­—èŠ‚ç ï¼Œè€Œä¸ä¾èµ–ç£ç›˜æ–‡ä»¶ï¼Œæ›´é«˜æ•ˆä¹Ÿæ›´é€‚åˆç”Ÿäº§ç¯å¢ƒä¸­åŠ¨æ€ç±»åŠ è½½ï¼ˆå¦‚åœ¨çº¿ä»£ç æ‰§è¡Œã€è„šæœ¬å¼•æ“ç­‰ï¼‰ã€‚</p>\n</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> javax.tools.*;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.*;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.net.URI;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.*;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.lang.reflect.*;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">InMemoryJavaRunner</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">className</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;com.example.dynamic.Hello&quot;</span>;</span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">sourceCode</span> <span class=\"operator\">=</span></span><br><span class=\"line\">                <span class=\"string\">&quot;package com.example.dynamic;\\n&quot;</span> +</span><br><span class=\"line\">                        <span class=\"string\">&quot;public class Hello &#123;\\n&quot;</span> +</span><br><span class=\"line\">                        <span class=\"string\">&quot;    public void say() &#123;\\n&quot;</span> +</span><br><span class=\"line\">                        <span class=\"string\">&quot;        System.out.println(\\&quot;Hello from memory compiled class!\\&quot;);\\n&quot;</span> +</span><br><span class=\"line\">                        <span class=\"string\">&quot;    &#125;\\n&quot;</span> +</span><br><span class=\"line\">                        <span class=\"string\">&quot;&#125;&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// è·å–ç³»ç»Ÿ Java ç¼–è¯‘å™¨</span></span><br><span class=\"line\">        <span class=\"type\">JavaCompiler</span> <span class=\"variable\">compiler</span> <span class=\"operator\">=</span> ToolProvider.getSystemJavaCompiler();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (compiler == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            System.err.println(<span class=\"string\">&quot;è¯·ä½¿ç”¨ JDK è¿è¡Œæ­¤ç¨‹åºï¼ˆé JREï¼‰&quot;</span>);</span><br><span class=\"line\">            <span class=\"keyword\">return</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// å‡†å¤‡ç¼–è¯‘æºä»£ç ï¼šä¸€ä¸ª JavaFileObject è¡¨ç¤ºæºä»£ç </span></span><br><span class=\"line\">        <span class=\"type\">JavaFileObject</span> <span class=\"variable\">sourceFile</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">JavaSourceFromString</span>(className, sourceCode);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// åˆ›å»ºè‡ªå®šä¹‰çš„å†…å­˜æ–‡ä»¶ç®¡ç†å™¨ï¼ˆæ›¿ä»£æ ‡å‡†çš„ç£ç›˜ç®¡ç†å™¨ï¼‰</span></span><br><span class=\"line\">        <span class=\"type\">StandardJavaFileManager</span> <span class=\"variable\">standardFileManager</span> <span class=\"operator\">=</span> compiler.getStandardFileManager(<span class=\"literal\">null</span>, <span class=\"literal\">null</span>, <span class=\"literal\">null</span>);</span><br><span class=\"line\">        <span class=\"type\">MemoryJavaFileManager</span> <span class=\"variable\">fileManager</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">MemoryJavaFileManager</span>(standardFileManager);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// æ‰§è¡Œç¼–è¯‘ä»»åŠ¡</span></span><br><span class=\"line\">        JavaCompiler.<span class=\"type\">CompilationTask</span> <span class=\"variable\">task</span> <span class=\"operator\">=</span> compiler.getTask(<span class=\"literal\">null</span>, fileManager, <span class=\"literal\">null</span>, <span class=\"literal\">null</span>, <span class=\"literal\">null</span>, Collections.singletonList(sourceFile));</span><br><span class=\"line\">        <span class=\"type\">boolean</span> <span class=\"variable\">success</span> <span class=\"operator\">=</span> task.call();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!success) &#123;</span><br><span class=\"line\">            System.err.println(<span class=\"string\">&quot;ç¼–è¯‘å¤±è´¥ï¼&quot;</span>);</span><br><span class=\"line\">            <span class=\"keyword\">return</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// åŠ è½½ç¼–è¯‘åçš„ç±»</span></span><br><span class=\"line\">        Map&lt;String, <span class=\"type\">byte</span>[]&gt; classBytes = fileManager.getClassBytes();</span><br><span class=\"line\">        <span class=\"type\">InMemoryClassLoader</span> <span class=\"variable\">classLoader</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">InMemoryClassLoader</span>(classBytes);</span><br><span class=\"line\">        Class&lt;?&gt; clazz = classLoader.loadClass(className);</span><br><span class=\"line\">        <span class=\"type\">Object</span> <span class=\"variable\">instance</span> <span class=\"operator\">=</span> clazz.getDeclaredConstructor().newInstance();</span><br><span class=\"line\">        <span class=\"type\">Method</span> <span class=\"variable\">method</span> <span class=\"operator\">=</span> clazz.getMethod(<span class=\"string\">&quot;say&quot;</span>);</span><br><span class=\"line\">        method.invoke(instance);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// ç”¨äºè¡¨ç¤ºå†…å­˜ä¸­çš„ Java æºä»£ç </span></span><br><span class=\"line\">    <span class=\"keyword\">static</span> <span class=\"keyword\">class</span> <span class=\"title class_\">JavaSourceFromString</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">SimpleJavaFileObject</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">final</span> String code;</span><br><span class=\"line\"></span><br><span class=\"line\">        JavaSourceFromString(String className, String code) &#123;</span><br><span class=\"line\">            <span class=\"built_in\">super</span>(URI.create(<span class=\"string\">&quot;string:///&quot;</span> + className.replace(<span class=\"string\">&#x27;.&#x27;</span>, <span class=\"string\">&#x27;/&#x27;</span>) + Kind.SOURCE.extension), Kind.SOURCE);</span><br><span class=\"line\">            <span class=\"built_in\">this</span>.code = code;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">public</span> CharSequence <span class=\"title function_\">getCharContent</span><span class=\"params\">(<span class=\"type\">boolean</span> ignoreEncodingErrors)</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> code;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// å°†ç¼–è¯‘çš„ class æ–‡ä»¶ä¿å­˜åœ¨å†…å­˜ä¸­ï¼ˆä¸æ˜¯æ–‡ä»¶ç³»ç»Ÿï¼‰</span></span><br><span class=\"line\">    <span class=\"keyword\">static</span> <span class=\"keyword\">class</span> <span class=\"title class_\">MemoryJavaFileManager</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">ForwardingJavaFileManager</span>&lt;StandardJavaFileManager&gt; &#123;</span><br><span class=\"line\">        <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Map&lt;String, ByteArrayOutputStream&gt; classOutputBuffers = <span class=\"keyword\">new</span> <span class=\"title class_\">HashMap</span>&lt;&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">        MemoryJavaFileManager(StandardJavaFileManager standardManager) &#123;</span><br><span class=\"line\">            <span class=\"built_in\">super</span>(standardManager);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"meta\">@Override</span></span><br><span class=\"line\">        <span class=\"keyword\">public</span> JavaFileObject <span class=\"title function_\">getJavaFileForOutput</span><span class=\"params\">(Location location, String className,</span></span><br><span class=\"line\"><span class=\"params\">                                                   JavaFileObject.Kind kind, FileObject sibling)</span> &#123;</span><br><span class=\"line\">            <span class=\"type\">ByteArrayOutputStream</span> <span class=\"variable\">outputStream</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ByteArrayOutputStream</span>();</span><br><span class=\"line\">            classOutputBuffers.put(className, outputStream);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">SimpleJavaFileObject</span>(</span><br><span class=\"line\">                    URI.create(<span class=\"string\">&quot;mem:///&quot;</span> + className.replace(<span class=\"string\">&#x27;.&#x27;</span>, <span class=\"string\">&#x27;/&#x27;</span>) + kind.extension), kind) &#123;</span><br><span class=\"line\">                <span class=\"meta\">@Override</span></span><br><span class=\"line\">                <span class=\"keyword\">public</span> OutputStream <span class=\"title function_\">openOutputStream</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">return</span> outputStream;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">public</span> Map&lt;String, <span class=\"type\">byte</span>[]&gt; getClassBytes() &#123;</span><br><span class=\"line\">            Map&lt;String, <span class=\"type\">byte</span>[]&gt; result = <span class=\"keyword\">new</span> <span class=\"title class_\">HashMap</span>&lt;&gt;();</span><br><span class=\"line\">            <span class=\"keyword\">for</span> (Map.Entry&lt;String, ByteArrayOutputStream&gt; entry : classOutputBuffers.entrySet()) &#123;</span><br><span class=\"line\">                result.put(entry.getKey(), entry.getValue().toByteArray());</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// è‡ªå®šä¹‰ ClassLoaderï¼Œç”¨äºä»å†…å­˜ä¸­åŠ è½½å­—èŠ‚ç </span></span><br><span class=\"line\">    <span class=\"keyword\">static</span> <span class=\"keyword\">class</span> <span class=\"title class_\">InMemoryClassLoader</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">ClassLoader</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Map&lt;String, <span class=\"type\">byte</span>[]&gt; classBytes;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">public</span> <span class=\"title function_\">InMemoryClassLoader</span><span class=\"params\">(Map&lt;String, <span class=\"type\">byte</span>[]&gt; classBytes)</span> &#123;</span><br><span class=\"line\">            <span class=\"built_in\">super</span>(ClassLoader.getSystemClassLoader());</span><br><span class=\"line\">            <span class=\"built_in\">this</span>.classBytes = classBytes;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"meta\">@Override</span></span><br><span class=\"line\">        <span class=\"keyword\">protected</span> Class&lt;?&gt; findClass(String name) <span class=\"keyword\">throws</span> ClassNotFoundException &#123;</span><br><span class=\"line\">            <span class=\"comment\">// ä»å†…å­˜ä¸­è·å–å­—èŠ‚ç </span></span><br><span class=\"line\">            <span class=\"type\">byte</span>[] bytes = classBytes.get(name);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (bytes == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"built_in\">super</span>.findClass(name);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"comment\">// å®šä¹‰ç±»å¹¶è¿”å›ï¼Œä¸€å®šè¦ä½¿ç”¨ defineClass æ–¹æ³•</span></span><br><span class=\"line\">            <span class=\"keyword\">return</span> defineClass(name, bytes, <span class=\"number\">0</span>, bytes.length);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>è¿›ä¸€æ­¥å‡çº§ï¼šæˆ‘ä»¬ç°åœ¨å°†è¿™ä¸ªç³»ç»Ÿæ‰©å±•ä¸ºæ”¯æŒå¤šä¸ªç±»åŒæ—¶åŠ¨æ€ç¼–è¯‘ã€å†…å­˜åŠ è½½å¹¶æ‰§è¡Œã€‚è¿™å¯¹äºéœ€è¦å¤„ç†å¤šä¸ªç±»ï¼ˆä¾‹å¦‚æ¥å£ + å®ç°ã€å†…éƒ¨ä¾èµ–ç­‰ï¼‰éå¸¸å®ç”¨ã€‚</p>\n</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> javax.tools.*;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.*;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.net.URI;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.*;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.lang.reflect.*;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// ä¸»ç±»</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">MultiClassInMemoryCompiler</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        <span class=\"comment\">// å‡†å¤‡å¤šä¸ªç±»çš„æºä»£ç </span></span><br><span class=\"line\">        Map&lt;String, String&gt; sources = <span class=\"keyword\">new</span> <span class=\"title class_\">HashMap</span>&lt;&gt;();</span><br><span class=\"line\">        sources.put(<span class=\"string\">&quot;com.example.api.Greeter&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;package com.example.api;\\n&quot;</span> +</span><br><span class=\"line\">                        <span class=\"string\">&quot;public interface Greeter &#123;\\n&quot;</span> +</span><br><span class=\"line\">                        <span class=\"string\">&quot;    void greet();\\n&quot;</span> +</span><br><span class=\"line\">                        <span class=\"string\">&quot;&#125;\\n&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        sources.put(<span class=\"string\">&quot;com.example.impl.EnglishGreeter&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;package com.example.impl;\\n&quot;</span> +</span><br><span class=\"line\">                        <span class=\"string\">&quot;import com.example.api.Greeter;\\n&quot;</span> +</span><br><span class=\"line\">                        <span class=\"string\">&quot;public class EnglishGreeter implements Greeter &#123;\\n&quot;</span> +</span><br><span class=\"line\">                        <span class=\"string\">&quot;    public void greet() &#123;\\n&quot;</span> +</span><br><span class=\"line\">                        <span class=\"string\">&quot;        System.out.println(\\&quot;Hello from EnglishGreeter!\\&quot;);\\n&quot;</span> +</span><br><span class=\"line\">                        <span class=\"string\">&quot;    &#125;\\n&quot;</span> +</span><br><span class=\"line\">                        <span class=\"string\">&quot;&#125;\\n&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">entryClassName</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;com.example.impl.EnglishGreeter&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// ç¼–è¯‘</span></span><br><span class=\"line\">        Map&lt;String, <span class=\"type\">byte</span>[]&gt; compiledClasses = compile(sources);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (compiledClasses == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            System.err.println(<span class=\"string\">&quot;ç¼–è¯‘å¤±è´¥&quot;</span>);</span><br><span class=\"line\">            <span class=\"keyword\">return</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// åŠ è½½å¹¶æ‰§è¡Œ</span></span><br><span class=\"line\">        <span class=\"type\">InMemoryClassLoader</span> <span class=\"variable\">classLoader</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">InMemoryClassLoader</span>(compiledClasses);</span><br><span class=\"line\">        Class&lt;?&gt; clazz = classLoader.loadClass(entryClassName);</span><br><span class=\"line\">        <span class=\"type\">Object</span> <span class=\"variable\">obj</span> <span class=\"operator\">=</span> clazz.getDeclaredConstructor().newInstance();</span><br><span class=\"line\">        <span class=\"type\">Method</span> <span class=\"variable\">method</span> <span class=\"operator\">=</span> clazz.getMethod(<span class=\"string\">&quot;greet&quot;</span>);</span><br><span class=\"line\">        method.invoke(obj);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// ç¼–è¯‘å™¨å…¥å£ï¼Œæ”¯æŒå¤šä¸ªç±»</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> Map&lt;String, <span class=\"type\">byte</span>[]&gt; compile(Map&lt;String, String&gt; sources) &#123;</span><br><span class=\"line\">        <span class=\"type\">JavaCompiler</span> <span class=\"variable\">compiler</span> <span class=\"operator\">=</span> ToolProvider.getSystemJavaCompiler();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (compiler == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            System.err.println(<span class=\"string\">&quot;è¯·ä½¿ç”¨ JDK è¿è¡Œ&quot;</span>);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        List&lt;JavaFileObject&gt; compilationUnits = <span class=\"keyword\">new</span> <span class=\"title class_\">ArrayList</span>&lt;&gt;();</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (Map.Entry&lt;String, String&gt; entry : sources.entrySet()) &#123;</span><br><span class=\"line\">            compilationUnits.add(<span class=\"keyword\">new</span> <span class=\"title class_\">JavaSourceFromString</span>(entry.getKey(), entry.getValue()));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">StandardJavaFileManager</span> <span class=\"variable\">stdManager</span> <span class=\"operator\">=</span> compiler.getStandardFileManager(<span class=\"literal\">null</span>, <span class=\"literal\">null</span>, <span class=\"literal\">null</span>);</span><br><span class=\"line\">        <span class=\"type\">MemoryJavaFileManager</span> <span class=\"variable\">memManager</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">MemoryJavaFileManager</span>(stdManager);</span><br><span class=\"line\"></span><br><span class=\"line\">        JavaCompiler.<span class=\"type\">CompilationTask</span> <span class=\"variable\">task</span> <span class=\"operator\">=</span> compiler.getTask(<span class=\"literal\">null</span>, memManager, <span class=\"literal\">null</span>, <span class=\"literal\">null</span>, <span class=\"literal\">null</span>, compilationUnits);</span><br><span class=\"line\">        <span class=\"type\">boolean</span> <span class=\"variable\">success</span> <span class=\"operator\">=</span> task.call();</span><br><span class=\"line\">        <span class=\"keyword\">return</span> success ? memManager.getClassBytes() : <span class=\"literal\">null</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// æºæ–‡ä»¶è¡¨ç¤ºï¼ˆJava ä»£ç ä»¥å­—ç¬¦ä¸²æä¾›ï¼‰</span></span><br><span class=\"line\">    <span class=\"keyword\">static</span> <span class=\"keyword\">class</span> <span class=\"title class_\">JavaSourceFromString</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">SimpleJavaFileObject</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">final</span> String code;</span><br><span class=\"line\"></span><br><span class=\"line\">        JavaSourceFromString(String className, String code) &#123;</span><br><span class=\"line\">            <span class=\"built_in\">super</span>(URI.create(<span class=\"string\">&quot;string:///&quot;</span> + className.replace(<span class=\"string\">&#x27;.&#x27;</span>, <span class=\"string\">&#x27;/&#x27;</span>) + Kind.SOURCE.extension), Kind.SOURCE);</span><br><span class=\"line\">            <span class=\"built_in\">this</span>.code = code;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"meta\">@Override</span></span><br><span class=\"line\">        <span class=\"keyword\">public</span> CharSequence <span class=\"title function_\">getCharContent</span><span class=\"params\">(<span class=\"type\">boolean</span> ignoreEncodingErrors)</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> code;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// å†…å­˜ä¸­çš„ç¼–è¯‘è¾“å‡ºç®¡ç†å™¨</span></span><br><span class=\"line\">    <span class=\"keyword\">static</span> <span class=\"keyword\">class</span> <span class=\"title class_\">MemoryJavaFileManager</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">ForwardingJavaFileManager</span>&lt;StandardJavaFileManager&gt; &#123;</span><br><span class=\"line\">        <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Map&lt;String, ByteArrayOutputStream&gt; classOutputBuffers = <span class=\"keyword\">new</span> <span class=\"title class_\">HashMap</span>&lt;&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">        MemoryJavaFileManager(StandardJavaFileManager standardManager) &#123;</span><br><span class=\"line\">            <span class=\"built_in\">super</span>(standardManager);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"meta\">@Override</span></span><br><span class=\"line\">        <span class=\"keyword\">public</span> JavaFileObject <span class=\"title function_\">getJavaFileForOutput</span><span class=\"params\">(Location location, String className,</span></span><br><span class=\"line\"><span class=\"params\">                                                   JavaFileObject.Kind kind, FileObject sibling)</span> &#123;</span><br><span class=\"line\">            <span class=\"type\">ByteArrayOutputStream</span> <span class=\"variable\">outputStream</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ByteArrayOutputStream</span>();</span><br><span class=\"line\">            classOutputBuffers.put(className, outputStream);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">SimpleJavaFileObject</span>(</span><br><span class=\"line\">                    URI.create(<span class=\"string\">&quot;mem:///&quot;</span> + className.replace(<span class=\"string\">&#x27;.&#x27;</span>, <span class=\"string\">&#x27;/&#x27;</span>) + kind.extension), kind) &#123;</span><br><span class=\"line\">                <span class=\"meta\">@Override</span></span><br><span class=\"line\">                <span class=\"keyword\">public</span> OutputStream <span class=\"title function_\">openOutputStream</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">return</span> outputStream;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">public</span> Map&lt;String, <span class=\"type\">byte</span>[]&gt; getClassBytes() &#123;</span><br><span class=\"line\">            Map&lt;String, <span class=\"type\">byte</span>[]&gt; result = <span class=\"keyword\">new</span> <span class=\"title class_\">HashMap</span>&lt;&gt;();</span><br><span class=\"line\">            <span class=\"keyword\">for</span> (Map.Entry&lt;String, ByteArrayOutputStream&gt; entry : classOutputBuffers.entrySet()) &#123;</span><br><span class=\"line\">                result.put(entry.getKey(), entry.getValue().toByteArray());</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// ç”¨äºåŠ è½½å†…å­˜ä¸­çš„ class</span></span><br><span class=\"line\">    <span class=\"keyword\">static</span> <span class=\"keyword\">class</span> <span class=\"title class_\">InMemoryClassLoader</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">ClassLoader</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Map&lt;String, <span class=\"type\">byte</span>[]&gt; classBytes;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">public</span> <span class=\"title function_\">InMemoryClassLoader</span><span class=\"params\">(Map&lt;String, <span class=\"type\">byte</span>[]&gt; classBytes)</span> &#123;</span><br><span class=\"line\">            <span class=\"built_in\">super</span>(ClassLoader.getSystemClassLoader());</span><br><span class=\"line\">            <span class=\"built_in\">this</span>.classBytes = classBytes;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"meta\">@Override</span></span><br><span class=\"line\">        <span class=\"keyword\">protected</span> Class&lt;?&gt; findClass(String name) <span class=\"keyword\">throws</span> ClassNotFoundException &#123;</span><br><span class=\"line\">            <span class=\"type\">byte</span>[] bytes = classBytes.get(name);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (bytes == <span class=\"literal\">null</span>) <span class=\"keyword\">return</span> <span class=\"built_in\">super</span>.findClass(name);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> defineClass(name, bytes, <span class=\"number\">0</span>, bytes.length);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"æ‰“ç ´åŒäº²å§”æ´¾ï¼Œå®ç°åŒç±»å¤šç‰ˆæœ¬å…±å­˜\">æ‰“ç ´åŒäº²å§”æ´¾ï¼Œå®ç°åŒç±»å¤šç‰ˆæœ¬å…±å­˜</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å‡è®¾æˆ‘ä»¬æœ‰åŒä¸€ä¸ªjaråŒ…çš„ä¸åŒç‰ˆæœ¬ï¼Œæ¯”å¦‚ï¼š<code>a-1.0.jar</code>å’Œ<code>a-2.0.jar</code>ï¼Œä»–ä»¬å…·æœ‰åŒåçš„ <code>DemoClass</code>ç±» ,ç³»ç»Ÿ<code>classpath</code>ä¸­å¼•å…¥çš„æ˜¯ <code>a-1.0.jar</code>ï¼Œè€Œæ­¤æ—¶æˆ‘ä»¬é€šè¿‡â¾ƒå®šçš„ClassLoaderåŠ è½½ <code>a-2.0.jar</code>ï¼Œå¹¶è°ƒç”¨ <code>DemoClass</code>ç±» ï¼Œæˆ‘ä»¬ä¼šå‘ç°ï¼Œâ¾ƒå®šçš„ClassLoaderåŠ è½½çš„ç±»ä¾æ—§æ˜¯ <code>a-1.0.jar</code> ä¸­çš„ç±»ï¼Œè€Œä¸æ˜¯ <code>a-2.0.jar</code> ä¸­çš„ç±»ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ç§æƒ…å†µå‘¢ï¼Ÿè¿™å°±æ˜¯å› ä¸ºJDKçš„åŒäº²å§”æ´¾æœºåˆ¶ã€‚â¾ƒå®šçš„ClassLoaderçš„<code>parent</code>å±æ€§æŒ‡å‘çš„æ˜¯JDKå†…çš„<code>AppClassLoader</code>ï¼Œâ½½ <code>AppClassLoader</code> ä¼šåŠ è½½ç³»ç»Ÿå½“ä¸­çš„æ‰€æœ‰ä»£ç ï¼Œå°±åŒ…æ‹¬ <code>a-1.0.jar</code>ä¸­çš„ <code>DemoClass</code>ç±»ã€‚è¿™æ—¶ï¼Œâ¾ƒå®šçš„ClassLoaderå»åŠ è½½ <code>DemoClass</code>ç±»æ—¶ï¼Œé€šè¿‡åŒäº²å§”æ´¾å‘ä¸ŠæŸ¥æ‰¾ï¼Œâ¾ƒç„¶åŠ è½½å‡ºæ¥çš„å°±æ˜¯APPClassloaderä¸­çš„<code>DemoClass</code>äº†ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>å¦‚ä½•æ‰“ç ´åŒäº²å§”æ´¾å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥é€šè¿‡é‡å†™ <code>loadClass()</code>æ–¹æ³•ï¼Œæ¥æ‰“ç ´åŒäº²å§”æ´¾ï¼Œå®ç°ç±»â½‚ä»¶çš„åŠ è½½ã€‚</p>\n</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> java.io.ByteArrayOutputStream;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.InputStream;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.net.URL;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.net.URLConnection;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.security.SecureClassLoader;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">CustomClassLoader</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">SecureClassLoader</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> URL jarUrl;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"title function_\">CustomClassLoader</span><span class=\"params\">(URL jarUrl)</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„å­ç±»åŠ è½½å™¨ï¼ŒåªåŠ è½½æŒ‡å®š JAR</span></span><br><span class=\"line\">        <span class=\"built_in\">this</span>.jarUrl = jarUrl;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> Class&lt;?&gt; loadClass(String name, <span class=\"type\">boolean</span> resolve) <span class=\"keyword\">throws</span> ClassNotFoundException &#123;</span><br><span class=\"line\">        <span class=\"comment\">// æŠŠåŒäº²å§”æ´¾æœºåˆ¶åè¿‡æ¥ï¼Œå…ˆåˆ°â¼¦ç±»åŠ è½½å™¨ä¸­åŠ è½½ï¼ŒåŠ è½½ä¸åˆ°å†å»â½—ç±»åŠ è½½å™¨ä¸­åŠ è½½ã€‚</span></span><br><span class=\"line\">        <span class=\"keyword\">synchronized</span> (getClassLoadingLock(name)) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// å¦‚æœç±»å·²åŠ è½½ï¼Œåˆ™ç›´æ¥è¿”å›</span></span><br><span class=\"line\">            Class&lt;?&gt; loadedClass = findLoadedClass(name);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (loadedClass == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">                loadedClass = findClass(name);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                <span class=\"comment\">// å§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨</span></span><br><span class=\"line\">                loadedClass = <span class=\"built_in\">super</span>.loadClass(name, resolve);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> loadedClass;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> Class&lt;?&gt; findClass(String name) &#123;</span><br><span class=\"line\">        <span class=\"type\">int</span> code;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// è®¿é—®jaråŒ…çš„url</span></span><br><span class=\"line\">            <span class=\"type\">URLConnection</span> <span class=\"variable\">urlConnection</span> <span class=\"operator\">=</span> jarUrl.openConnection();</span><br><span class=\"line\">            urlConnection.setUseCaches(<span class=\"literal\">false</span>);</span><br><span class=\"line\">            <span class=\"type\">InputStream</span> <span class=\"variable\">is</span> <span class=\"operator\">=</span> urlConnection.getInputStream();</span><br><span class=\"line\">            <span class=\"type\">ByteArrayOutputStream</span> <span class=\"variable\">bos</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ByteArrayOutputStream</span>();</span><br><span class=\"line\">            <span class=\"keyword\">while</span> ((code = is.read()) != -<span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">                bos.write(code);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"type\">byte</span>[] data = bos.toByteArray();</span><br><span class=\"line\">            is.close();</span><br><span class=\"line\">            bos.close();</span><br><span class=\"line\">            <span class=\"keyword\">return</span> defineClass(name, data, <span class=\"number\">0</span>, data.length);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æµ‹è¯•ä»£ç </p>\n</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> java.io.File;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.net.URL;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Test</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        <span class=\"type\">File</span> <span class=\"variable\">jarFile</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">File</span>(<span class=\"string\">&quot;path/to/a-2.0.jar&quot;</span>);</span><br><span class=\"line\">        <span class=\"type\">URL</span> <span class=\"variable\">jarUrl</span> <span class=\"operator\">=</span> jarFile.toURI().toURL();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">CustomClassLoader</span> <span class=\"variable\">loader</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">CustomClassLoader</span>(jarUrl);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// åŠ è½½ DemoClass</span></span><br><span class=\"line\">        Class&lt;?&gt; clazz = loader.loadClass(<span class=\"string\">&quot;com.example.DemoClass&quot;</span>);</span><br><span class=\"line\">        <span class=\"type\">Object</span> <span class=\"variable\">obj</span> <span class=\"operator\">=</span> clazz.getDeclaredConstructor().newInstance();</span><br><span class=\"line\">        clazz.getMethod(<span class=\"string\">&quot;print&quot;</span>).invoke(obj);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶çš„å…¸å‹åœºæ™¯\">æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶çš„å…¸å‹åœºæ™¯</h3>\n<h4 id=\"Tomcatç±»åŠ è½½å™¨\">Tomcatç±»åŠ è½½å™¨</h4>\n<p><img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/eGKhDn.png\" alt=\"\" width=\"550\" height=\"700\"></p>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>CommonClassLoaderï¼šTomcatæœ€åŸºæœ¬çš„ç±»åŠ è½½å™¨ï¼ŒåŠ è½½è·¯å¾„ä¸­çš„classå¯ä»¥è¢«Tomcatå®¹å™¨æœ¬èº«ä»¥åŠå„ä¸ªWebappè®¿é—®ï¼›</p>\n</li>\n<li class=\"lvl-2\">\n<p>CatalinaClassLoaderï¼šTomcatå®¹å™¨ç§æœ‰çš„ç±»åŠ è½½å™¨ï¼ŒåŠ è½½è·¯å¾„ä¸­çš„classå¯¹äºWebappä¸å¯â»…ï¼›</p>\n</li>\n<li class=\"lvl-2\">\n<p>SharedClassLoaderï¼šå„ä¸ªWebappå…±äº«çš„ç±»åŠ è½½å™¨ï¼ŒåŠ è½½è·¯å¾„ä¸­çš„classå¯¹äºæ‰€æœ‰Webappå¯â»…ï¼Œä½†æ˜¯å¯¹äºTomcatå®¹å™¨ä¸å¯â»…ï¼›</p>\n</li>\n<li class=\"lvl-2\">\n<p>WebappClassLoaderï¼šå„ä¸ªWebappç§æœ‰çš„ç±»åŠ è½½å™¨ï¼ŒåŠ è½½è·¯å¾„ä¸­çš„classåªå¯¹å½“å‰Webappå¯â»…ï¼Œâ½å¦‚åŠ è½½waråŒ…â¾¥ç›¸å…³çš„ç±»ï¼Œæ¯ä¸ªwaråŒ…åº”â½¤éƒ½æœ‰â¾ƒâ¼°çš„WebappClassLoaderï¼Œå®ç°ç›¸äº’éš”ç¦»ï¼Œâ½å¦‚ä¸åŒwaråŒ…åº”â½¤å¼•â¼Šäº†ä¸åŒçš„springç‰ˆæœ¬ï¼Œè¿™æ ·å®ç°å°±èƒ½åŠ è½½å„â¾ƒçš„springç‰ˆæœ¬ï¼›</p>\n</li>\n<li class=\"lvl-2\">\n<p>Jspç±»åŠ è½½å™¨ï¼šé’ˆå¯¹æ¯ä¸ªJSPâ»šâ¾¯åˆ›å»ºâ¼€ä¸ªåŠ è½½å™¨ã€‚è¿™ä¸ªåŠ è½½å™¨â½è¾ƒè½»é‡çº§ï¼Œæ‰€ä»¥Tomcatè¿˜å®ç°äº†çƒ­åŠ è½½ï¼Œä¹Ÿå°±æ˜¯JSPåªè¦ä¿®æ”¹äº†ï¼Œå°±åˆ›å»ºâ¼€ä¸ªæ–°çš„åŠ è½½å™¨ï¼Œä»â½½å®ç°äº†JSPâ»šâ¾¯çš„çƒ­æ›´æ–°ã€‚</p>\n</li>\n</ul>\n","content_text":"æ‘˜è¦ æœ¬æ–‡ä»‹ç»JVMçš„ç±»åŠ è½½å™¨ JDK8 The JavaÂ® Virtual Machine Specification JDK8çš„javaæŒ‡ä»¤çš„å®˜â½…â½‚æ¡£ JDKâ¼¯å…·å®˜â½¹â½‚æ¡£ JDK17çš„javaæŒ‡ä»¤çš„å®˜â½…â½‚æ¡£ ç±»åŠ è½½å™¨ å·¦ä¾§æ˜¯JDKä¸­å®ç°çš„ç±»åŠ è½½å™¨ï¼Œé€šè¿‡parentå±æ€§å½¢æˆâ½—â¼¦å…³ç³»ã€‚åº”â½¤ä¸­â¾ƒå®šä¹‰çš„ç±»åŠ è½½å™¨çš„parentéƒ½æ˜¯ AppClassLoader å³ä¾§æ˜¯JDKä¸­çš„ç±»åŠ è½½å™¨å®ç°ç±»ã€‚é€šè¿‡ç±»ç»§æ‰¿çš„æœºåˆ¶å½¢æˆä½“ç³»ã€‚æœªæ¥æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ç»§æ‰¿ç›¸å…³çš„ç±»å®ç°â¾ƒå®šä¹‰ç±» åŠ è½½å™¨ã€‚ åœ¨ä»£ç ä¸­æŸ¥çœ‹ç±»åŠ è½½å™¨å…³ç³» 1234567891011121314public class LoaderDemo &#123; public static void main(String[] args) throws ClassNotFoundException &#123; // â½—â¼¦å…³ç³» AppClassLoader &lt;- ExtClassLoader &lt;- BootStrap Classloader ClassLoader cl1 = LoaderDemo.class.getClassLoader(); System.out.println(&quot;cl1 &gt; &quot; + cl1); // sun.misc.Launcher$AppClassLoader@18b4aac2 System.out.println(&quot;parent of cl1 &gt; &quot; + cl1.getParent()); // sun.misc.Launcher$ExtClassLoader@1b6d3586 // BootStrap Classloaderç”±C++å¼€å‘ï¼Œæ˜¯JVMè™šæ‹Ÿæœºçš„â¼€éƒ¨åˆ†ï¼Œæœ¬èº«ä¸æ˜¯JAVAç±»ã€‚ System.out.println(&quot;grant parent of cl1 &gt; &quot; + cl1.getParent().getParent()); // null // String,Intç­‰åŸºç¡€ç±»ç”±BootStrap ClassloaderåŠ è½½ã€‚ ClassLoader cl2 = String.class.getClassLoader(); System.out.println(&quot;cl2 &gt; &quot; + cl2); // null System.out.println(cl1.loadClass(&quot;java.util.List&quot;).getClass().getClassLoader()); // null &#125;&#125; åŒäº²å§”æ´¾æœºåˆ¶ å½“â¼€ä¸ªç±»åŠ è½½å™¨è¦åŠ è½½â¼€ä¸ªç±»æ—¶ï¼Œæ•´ä½“çš„è¿‡ç¨‹å°±æ˜¯é€šè¿‡åŒäº²å§”æ´¾æœºåˆ¶å‘ä¸Šå§”æ‰˜æŸ¥æ‰¾ï¼Œå¦‚æœæ²¡æœ‰æŸ¥æ‰¾åˆ°ï¼Œå°±å‘ä¸‹å§”æ‰˜åŠ è½½ã€‚ Java ç±»åŠ è½½æœºåˆ¶ä¸­çš„åŒäº²å§”æ´¾æ¨¡å‹ï¼ˆParent Delegation Modelï¼‰æ˜¯ä¸€ç§ä¿è¯äº†ç±»åŠ è½½å™¨æŒ‰ç…§å±‚æ¬¡ç»“æ„ä»ä¸Šåˆ°ä¸‹æ¥åŠ è½½ç±»çš„ç­–ç•¥ã€‚è¿™ç§å±‚çº§åŒ–çš„åŠ è½½æµç¨‹ç¡®ä¿äº†åº”ç”¨ç¨‹åºèƒ½å¤Ÿå®‰å…¨åœ°åŠ è½½å¹¶ä½¿ç”¨æ¥è‡ªä¸åŒæ¥æºçš„ç±»ï¼ŒåŒæ—¶ä¹Ÿé¿å…äº†å†…å­˜ä¸­å‡ºç°ç›¸åŒç±»çš„å¤šä¸ªæ‹·è´ã€‚ ä»¥ä¸‹æ˜¯åŒäº²å§”æ´¾æœºåˆ¶çš„å·¥ä½œåŸç†ï¼š 1.å½“ä¸€ä¸ªç±»åŠ è½½å™¨æ¥æ”¶åˆ°ç±»åŠ è½½è¯·æ±‚æ—¶ï¼Œå®ƒé¦–å…ˆä¸ä¼šè‡ªè¡Œå°è¯•å»å¯»æ‰¾ç±»æ–‡ä»¶ï¼Œè€Œæ˜¯å°†è¿™ä¸ªè¯·æ±‚å§”æ´¾ç»™å®ƒçš„çˆ¶ç±»åŠ è½½å™¨ã€‚ 2.çˆ¶ç±»åŠ è½½å™¨åŒæ ·éµå¾ªæ­¤è§„åˆ™ï¼Œå®ƒä¼šç»§ç»­æŠŠè¯·æ±‚å‘ä¸Šå§”æ´¾ç»™å®ƒçš„çˆ¶ç±»åŠ è½½å™¨ï¼Œç›´åˆ°è¾¾åˆ°æ ¹ï¼ˆbootstrappï¼‰ç±»åŠ è½½å™¨ä¸ºæ­¢ã€‚ 3.æ ¹ç±»åŠ è½½å™¨ä¸€èˆ¬ä¼šç›´æ¥è®¿é—®æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿæ¥æŸ¥æ‰¾ç±»æ–‡ä»¶ï¼Œæ¯”å¦‚ JDK è‡ªå¸¦çš„æ ¸å¿ƒç±»åº“ï¼Œæˆ–è€…åœ¨-XbootclasspathæŒ‡å®šçš„è·¯å¾„ä¸‹æŸ¥æ‰¾ã€‚ 4.å¦‚æœæ ¹ç±»åŠ è½½å™¨æ‰¾åˆ°äº†è¯¥ç±»ï¼Œåˆ™è¿›è¡Œç±»çš„åŠ è½½ï¼›å¦‚æœæ‰¾ä¸åˆ°ï¼Œåˆ™æŠŠè¿™ä¸ªä»»åŠ¡äº¤å›ç»™å‘å‡ºè¯·æ±‚çš„å­ç±»åŠ è½½å™¨ã€‚ 5.å­ç±»åŠ è½½å™¨ä¹Ÿé‡å¤æ­¥éª¤ 4ï¼Œè‹¥æ‰¾åˆ°åˆ™åŠ è½½ï¼Œå¦åˆ™ä¼ é€’ç»™ä¸‹ä¸€ä¸ªå­ç±»åŠ è½½å™¨ï¼Œç›´è‡³åŸå§‹æå‡ºè¯·æ±‚çš„ç±»åŠ è½½å™¨ã€‚ 6.è‹¥æ‰€æœ‰çš„ç±»åŠ è½½å™¨éƒ½æœªèƒ½æ‰¾åˆ°æ‰€éœ€çš„ç±»ï¼Œåˆ™æœ€ç»ˆæŠ›å‡ºClassNotFoundExceptionå¼‚å¸¸ã€‚ åŒäº²å§”æ´¾æœ‰ä»¥ä¸‹å‡ ä¸ªä¼˜ç‚¹ï¼š å®‰å…¨æ€§ï¼šç”±äºç±»åŠ è½½æ˜¯ä»é¡¶å±‚å¼€å§‹ï¼Œè¿™èƒ½é˜²æ­¢æ¶æ„ä»£ç é€šè¿‡åŠ è½½ç›¸åŒçš„åŒ…åå’Œç±»åæ›¿ä»£ç³»ç»Ÿçš„å…³é”®ç±»ã€‚ å”¯ä¸€æ€§ï¼šæ¯ä¸ªç±»éƒ½ä¼šè¢«ç‰¹å®šçš„ç±»åŠ è½½å™¨åŠ è½½ä¸€æ¬¡ï¼Œå³ä¾¿æ˜¯åœ¨åˆ†å¸ƒå¼çš„ç¯å¢ƒä¸­ä¹Ÿèƒ½ä¿è¯ç±»çš„ç»Ÿä¸€æ€§ï¼Œé¿å…å› ä¸ºå¤šæ¬¡åŠ è½½å¯¼è‡´çš„é”™è¯¯ã€‚ å¯é æ€§ï¼šç”¨æˆ·è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨ä¸ç”¨æ‹…å¿ƒåŸºç¡€ç±»å·²ç»è¢«åŠ è½½ï¼Œå®ƒä»¬å¯ä»¥ä¸“å¿ƒäºè‡ªå·±éœ€è¦å¤„ç†çš„éƒ¨åˆ†ã€‚ ä¾‹å¦‚ï¼Œå½“åº”ç”¨ç¨‹åºè¿è¡Œæ—¶ï¼Œåº”ç”¨ç±»åŠ è½½å™¨ï¼ˆApplication ClassLoaderï¼‰æ¥æ”¶åˆ°å¯¹java.lang.Stringç±»çš„åŠ è½½è¯·æ±‚æ—¶ï¼Œå®ƒä¼šé¦–å…ˆå°†è¯·æ±‚ä¼ é€’ç»™æ‰©å±•ç±»åŠ è½½å™¨ï¼ˆExtension ClassLoaderï¼‰ï¼Œåè€…å†ä¼ é€’ç»™å¼•å¯¼ç±»åŠ è½½å™¨ï¼ˆBootstrap ClassLoaderï¼‰ã€‚å¼•å¯¼ç±»åŠ è½½å™¨ä¼šåœ¨å…¶æœç´¢è·¯å¾„ä¸­æ‰¾åˆ°Stringç±»ï¼Œå¹¶å®ŒæˆåŠ è½½è¿‡ç¨‹ã€‚å¦‚æœåº”ç”¨ç¨‹åºè¯•å›¾æä¾›è‡ªå·±çš„Stringç±»ï¼Œç”±äºåŒäº²å§”æ´¾çš„å­˜åœ¨ï¼Œåº”ç”¨ç¨‹åºæ‰€æŒ‡å®šçš„ç±»å¹¶ä¸ä¼šè¢«åŠ è½½ï¼Œä»è€Œä¿è¯äº†å¹³å°æ ¸å¿ƒ API çš„ä¸€è‡´æ€§ã€‚ æ€»ä¹‹ï¼ŒåŒäº²å§”æ´¾æœºåˆ¶æ˜¯ Java ç±»åŠ è½½è¿‡ç¨‹ä¸­ä¸€ä¸ªéå¸¸é‡è¦çš„ç‰¹æ€§ï¼Œå®ƒä¸ä»…ç»´æŠ¤äº†ç±»åŠ è½½çš„å®‰å…¨æ€§å’Œä¸€è‡´æ€§ï¼Œä¹Ÿä¸ºå¼€å‘è€…æä¾›äº†çµæ´»å®šåˆ¶ç±»åŠ è½½è§„åˆ™çš„èƒ½åŠ›ã€‚ æ¯ä¸ªç±»åŠ è½½å™¨æŸ¥æ‰¾ç±»çš„é»˜è®¤è·¯å¾„ åœ¨ Java ä¸­ï¼Œæ¯ä¸ªç±»åŠ è½½å™¨éƒ½æœ‰è‡ªå·±çš„ç±»è·¯å¾„ï¼ˆClasspathï¼‰å»æŸ¥æ‰¾ç±»æ–‡ä»¶ã€‚ä¸‹é¢æ˜¯å‡ ä¸ªä¸»è¦çš„ç±»åŠ è½½å™¨ä»¥åŠå®ƒä»¬çš„é»˜è®¤æŸ¥æ‰¾è·¯å¾„ï¼š ç±»åŠ è½½å™¨åç§° ç±»å / åˆ«å çˆ¶ç±»åŠ è½½å™¨ åŠ è½½å†…å®¹æè¿° é»˜è®¤æŸ¥æ‰¾è·¯å¾„ / ç³»ç»Ÿå±æ€§ å¯åŠ¨ç±»åŠ è½½å™¨ BootstrapClassLoader æ—  åŠ è½½ æ ¸å¿ƒ Java ç±»åº“ &lt;JAVA_HOME&gt;/jre/lib/rt.jarï¼ˆJDK8 åŠä¹‹å‰ï¼‰æˆ– sun.boot.class.path æŒ‡å®šè·¯å¾„ æ‰©å±•ç±»åŠ è½½å™¨ ExtClassLoader BootstrapClassLoader åŠ è½½ Java å¹³å°æ‰©å±•ç±»åº“ &lt;JAVA_HOME&gt;/jre/lib/ext æˆ–ç”± java.ext.dirs ç³»ç»Ÿå±æ€§æŒ‡å®š åº”ç”¨ç±»åŠ è½½å™¨ AppClassLoader ExtClassLoader åŠ è½½ åº”ç”¨ç¨‹åºç±»ï¼ˆç”¨æˆ·ç¼–å†™çš„ä»£ç ï¼‰ -classpathã€-cp å‚æ•°ã€CLASSPATH ç¯å¢ƒå˜é‡ã€java.class.path å±æ€§ã€å½“å‰ç›®å½• (.) è‡ªå®šä¹‰ç±»åŠ è½½å™¨ ç”¨æˆ·è‡ªå®šä¹‰ å¯æŒ‡å®š å¯é€šè¿‡ç»§æ‰¿ ClassLoader å¹¶é‡å†™ findClass() æ–¹æ³•å®ç°è‡ªå®šä¹‰ç±»åŠ è½½é€»è¾‘ï¼Œå¦‚ä»ç½‘ç»œã€æ•°æ®åº“ç­‰åŠ è½½ç±»æ–‡ä»¶ é»˜è®¤ç»§æ‰¿çˆ¶åŠ è½½å™¨æŸ¥æ‰¾è·¯å¾„ï¼Œä¹Ÿå¯è‡ªå®šä¹‰ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé™¤äº† Bootstrap ClassLoader å¤–ï¼Œå…¶ä»–çš„æ‰€æœ‰ç±»åŠ è½½å™¨æœ€ç»ˆéƒ½æ˜¯java.lang.ClassLoaderçš„å­ç±»ï¼Œå¹¶ä¸”æ¯ä¸ªç±»åŠ è½½å™¨å®ä¾‹éƒ½æœ‰ä¸€ä¸ªç›´æ¥çš„çˆ¶ç±»åŠ è½½å™¨ã€‚å¦‚æœä½ åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ç±»åŠ è½½å™¨ï¼Œå®ƒå°†ç»§æ‰¿ Application ClassLoader ä½œä¸ºå®ƒçš„çˆ¶ç±»ï¼Œé™¤éä½ åœ¨åˆ›å»ºæ—¶æŒ‡å®šäº†ä¸åŒçš„çˆ¶ç±»åŠ è½½å™¨ã€‚ æ­¤å¤–ï¼ŒJava 9 å¼•å…¥äº†æ¨¡å—åŒ–ç³»ç»Ÿåï¼Œç±»åŠ è½½æœºåˆ¶ä¹Ÿæœ‰äº†ä¸€äº›å˜åŒ–ï¼Œå¯¹äºæ¨¡å—è·¯å¾„ä¸Šçš„ç±»åŠ è½½ï¼Œä¼šä½¿ç”¨æ–°çš„å±‚æ¬¡ç»“æ„æ¥å¤„ç†ï¼Œè¿™ä½¿å¾—ç±»åŠ è½½è¿‡ç¨‹æ›´åŠ çµæ´»åŒæ—¶ä¿æŒäº†å‘åçš„å…¼å®¹æ€§ã€‚ä¸è¿‡ï¼Œå¯¹äºä¼ ç»Ÿçš„ç±»è·¯å¾„ä¸Šçš„ç±»åŠ è½½ï¼ŒåŒäº²å§”æ´¾æ¨¡å‹ä»ç„¶é€‚ç”¨ã€‚ ç±»åŠ è½½å™¨åç§° ç±»å / åˆ«å çˆ¶ç±»åŠ è½½å™¨ åŠ è½½æ¨¡å—èŒƒå›´ é»˜è®¤æŸ¥æ‰¾è·¯å¾„ / æ¨¡å—æ¥æº å¼•å¯¼ç±»åŠ è½½å™¨ BootstrapClassLoader æ—  åŠ è½½ java.* æ¨¡å—ï¼Œä¾‹å¦‚ java.baseï¼ˆåŒ…å« java.lang, java.util ç­‰ï¼‰ $JAVA_HOME/jmods ä¸­çš„æ¨¡å—æ–‡ä»¶ï¼Œæ ¸å¿ƒæ¨¡å—ç”± JVM å¯åŠ¨æ—¶ç›´æ¥åŠ è½½ å¹³å°ç±»åŠ è½½å™¨ PlatformClassLoader BootstrapClassLoader åŠ è½½ jdk.*ã€javafx.* ç­‰å¹³å°æ‰©å±•æ¨¡å— $JAVA_HOME/jmodsï¼Œæ¨¡å—åä¸º jdk.*ã€javafx.* ç­‰ï¼› åº”ç”¨ç±»åŠ è½½å™¨ AppClassLoader PlatformClassLoader åŠ è½½åº”ç”¨æ¨¡å—ï¼ˆç”¨æˆ·ä»£ç ï¼‰ï¼ŒåŒ…æ‹¬æ¨¡å—è·¯å¾„ --module-path å’Œç±»è·¯å¾„ -classpath ä¸‹çš„ç±» åº”ç”¨ç¨‹åºç¼–å†™çš„æ¨¡å—æˆ–ç±»ï¼Œæ¥è‡ªå‘½ä»¤è¡Œ --module-pathã€-classpath å‚æ•°ã€CLASSPATH ç¯å¢ƒå˜é‡ç­‰ è‡ªå®šä¹‰ç±»åŠ è½½å™¨ ç”¨æˆ·è‡ªå®šä¹‰ å¯æŒ‡å®šçˆ¶åŠ è½½å™¨ åŠ è½½éæ ‡å‡†ä½ç½®çš„ç±»ï¼Œå¯ç”¨äºæ’ä»¶ã€ç½‘ç»œåŠ è½½ã€åŠ å¯†ç±»åŠ è½½ç­‰ é»˜è®¤éµå¾ªåŒäº²å§”æ´¾ï¼Œå¯é‡å†™ findClass() å®ç°è‡ªå®šä¹‰è·¯å¾„æŸ¥æ‰¾æˆ–å…¶ä»–æ•°æ®æºï¼Œå¦‚ç½‘ç»œã€æ•°æ®åº“ã€åŠ å¯†æ–‡ä»¶ç­‰ jdk9+ä¸­ï¼Œåœ¨å§”æ´¾ç»™çˆ¶åŠ è½½å™¨åŠ è½½å‰ï¼Œå…ˆåˆ¤æ–­è¯¥ç±»æ˜¯å¦èƒ½å¤Ÿå½’å±åˆ°æŸä¸€ä¸ªç³»ç»Ÿæ¨¡å—ä¸­ï¼Œå¦‚æœå¯ä»¥æ‰¾åˆ°è¿™æ ·çš„å½’å±å…³ç³»ï¼Œå°±è¦ä¼˜å…ˆå§”æ´¾ç»™è´Ÿè´£é‚£ä¸ªæ¨¡å—çš„åŠ è½½å™¨å®ŒæˆåŠ è½½ã€‚ åœ¨ä»£ç ä¸­æŸ¥çœ‹ç±»åŠ è½½è·¯å¾„ 123456// BootStrap Classloaderï¼ŒåŠ è½½javaåŸºç¡€ç±»ã€‚System.out.println(&quot;BootStrap ClassLoaderåŠ è½½â½¬å½•ï¼š&quot; + System.getProperty(&quot;sun.boot.class.path&quot;));// Extention Classloader åŠ è½½â¼€äº›æ‰©å±•ç±»ã€‚ å¯é€šè¿‡-D java.ext.dirså¦â¾æŒ‡å®šâ½¬å½•System.out.println(&quot;Extention ClassLoaderåŠ è½½â½¬å½•ï¼š&quot; + System.getProperty(&quot;java.ext.dirs&quot;));// AppClassLoader åŠ è½½CLASSPATHï¼Œåº”â½¤ä¸‹çš„JaråŒ…ã€‚å¯é€šè¿‡-D java.class.pathå¦â¾æŒ‡å®šâ½¬å½•System.out.println(&quot;AppClassLoaderåŠ è½½â½¬å½•ï¼š&quot; + System.getProperty(&quot;java.class.path&quot;)); åŒäº²å§”æ´¾æœºåˆ¶çš„å®ç°åŸç† java.lang.ClassLoader ç±»çš„ loadClass æ–¹æ³•æ˜¯åŒäº²å§”æ´¾çš„æ ¸å¿ƒå®ç° 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657/** * åŠ è½½æŒ‡å®šåç§°çš„ç±»ï¼Œå¹¶æ ¹æ® resolve å‚æ•°å†³å®šæ˜¯å¦è§£æè¯¥ç±»ã€‚ * * è¯¥æ–¹æ³•å®ç°äº†ç±»åŠ è½½çš„åŸºæœ¬é€»è¾‘ï¼ŒåŒ…æ‹¬æ£€æŸ¥ç±»æ˜¯å¦å·²åŠ è½½ã€å§”æ‰˜çˆ¶ç±»åŠ è½½å™¨åŠ è½½ã€ * è‡ªè¡ŒåŠ è½½ç±»ä»¥åŠè§£æç±»ç­‰æ­¥éª¤ã€‚è¯¥æ–¹æ³•æ˜¯ Java ç±»åŠ è½½æœºåˆ¶çš„æ ¸å¿ƒéƒ¨åˆ†ä¹‹ä¸€ï¼Œ * éµå¾ªåŒäº²å§”æ´¾æ¨¡å‹ã€‚ * * @param name è¦åŠ è½½çš„ç±»çš„å…¨é™å®šå * @param resolve å¦‚æœä¸º trueï¼Œåˆ™åœ¨åŠ è½½åè§£æè¯¥ç±» * @return åŠ è½½çš„ Class å¯¹è±¡ * @throws ClassNotFoundException å¦‚æœæ‰¾ä¸åˆ°æŒ‡å®šçš„ç±» */// è¿™ä¸ªâ½…æ³•æ˜¯protectedå£°æ˜çš„ï¼Œæ„å‘³ç€ï¼Œæ˜¯å¯ä»¥è¢«â¼¦ç±»è¦†ç›–çš„ï¼Œæ‰€ä»¥ï¼ŒåŒäº²å§”æ´¾æœºåˆ¶ä¹Ÿæ˜¯å¯ä»¥è¢«æ‰“ç ´çš„ï¼Œå¦‚Tomcatâ¼¦ç±»é‡å†™è¿™ä¸ªâ½…æ³•ï¼Œå¹¶ä½¿â½¤è‡ªå·±çš„ç±»åŠ è½½é€»è¾‘ã€‚protected Class&lt;?&gt; loadClass(String name, boolean resolve) throws ClassNotFoundException &#123; // ä½¿ç”¨ synchronized ç¡®ä¿å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ç±»åŠ è½½çš„åŒæ­¥ synchronized (getClassLoadingLock(name)) &#123; // First, check if the class has already been loaded // æ¯ä¸ªç±»åŠ è½½å™¨å¯¹ä»–åŠ è½½è¿‡çš„ç±»éƒ½æœ‰â¼€ä¸ªç¼“å­˜ï¼Œå…ˆå»ç¼“å­˜ä¸­æŸ¥çœ‹æœ‰æ²¡æœ‰åŠ è½½è¿‡ Class&lt;?&gt; c = findLoadedClass(name); if (c == null) &#123; //æ²¡æœ‰åŠ è½½è¿‡ï¼Œå°±â¾›åŒäº²å§”æ´¾ long t0 = System.nanoTime(); try &#123; // çˆ¶ç±»å­˜åœ¨åˆ™è®©â½—ç±»åŠ è½½å™¨è¿›â¾åŠ è½½ if (parent != null) &#123; c = parent.loadClass(name, false); &#125; else &#123; //å¦‚æœçˆ¶ç±»ä¸å­˜åœ¨ï¼Œåˆ™ä»å¼•å¯¼ç±»åŠ è½½å™¨è¿›â¾åŠ è½½ c = findBootstrapClassOrNull(name); &#125; &#125; catch (ClassNotFoundException e) &#123; // ClassNotFoundException thrown if class not found // from the non-null parent class loader &#125; if (c == null) &#123; // If still not found, then invoke findClass in order // to find the class. long t1 = System.nanoTime(); // findClass æ–¹æ³•æ˜¯å­ç±»å®ç°çš„ï¼Œç”¨äºåŠ è½½æŒ‡å®šåç§°çš„ç±» // â½—ç±»åŠ è½½å™¨æ²¡æœ‰åŠ è½½è¿‡ï¼Œå°±â¾ƒâ¾è§£æclassâ½‚ä»¶åŠ è½½ c = findClass(name); // this is the defining class loader; record the stats // æ€§èƒ½ç»Ÿè®¡ï¼šè®°å½•ç±»åŠ è½½è¿‡ç¨‹ä¸­çš„æ—¶é—´æ¶ˆè€—å’Œè°ƒç”¨æ¬¡æ•°ï¼Œä¾¿äºç›‘æ§å’Œä¼˜åŒ–ã€‚ sun.misc.PerfCounter.getParentDelegationTime().addTime(t1 - t0); sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1); sun.misc.PerfCounter.getFindClasses().increment(); &#125; &#125; // é»˜è®¤æƒ…å†µä¸‹ï¼ŒåŒäº²å§”æ´¾æ¨¡å‹åªè¿›â¾äº†éªŒè¯å’Œå‡†å¤‡é˜¶æ®µï¼Œâ½½ä¸è¿›â¾è§£æ(å¦‚é“¾æ¥ã€åˆå§‹åŒ–) if (resolve) &#123; resolveClass(c); &#125; return c; &#125;&#125; è¯¥æ–¹æ³•å®ç°äº†ç±»åŠ è½½çš„åŸºæœ¬é€»è¾‘ï¼ŒåŒ…æ‹¬æ£€æŸ¥ç±»æ˜¯å¦å·²åŠ è½½ã€å§”æ‰˜çˆ¶ç±»åŠ è½½å™¨åŠ è½½ã€è‡ªè¡ŒåŠ è½½ç±»ä»¥åŠè§£æç±»ç­‰æ­¥éª¤ã€‚è¯¥æ–¹æ³•æ˜¯ Java ç±»åŠ è½½æœºåˆ¶çš„æ ¸å¿ƒéƒ¨åˆ†ä¹‹ä¸€ï¼Œéµå¾ªåŒäº²å§”æ´¾æ¨¡å‹ã€‚ è¿™ä¸ªâ½…æ³•æ˜¯protectedå£°æ˜çš„ï¼Œæ„å‘³ç€ï¼Œæ˜¯å¯ä»¥è¢«â¼¦ç±»è¦†ç›–çš„ï¼Œæ‰€ä»¥ï¼ŒåŒäº²å§”æ´¾æœºåˆ¶ä¹Ÿæ˜¯å¯ä»¥è¢«æ‰“ç ´çš„ï¼Œå¦‚Tomcatâ¼¦ç±»é‡å†™è¿™ä¸ªâ½…æ³•ï¼Œå¹¶ä½¿â½¤è‡ªå·±çš„ç±»åŠ è½½é€»è¾‘ã€‚ æ²™ç®±ä¿æŠ¤æœºåˆ¶ æ²™ç®±ä¿æŠ¤æœºåˆ¶æ˜¯ Java è™šæ‹Ÿæœºæä¾›çš„ä¸€ç§å®‰å…¨æœºåˆ¶ï¼Œç”¨äºä¿æŠ¤åº”ç”¨ç¨‹åºå…å—æ¶æ„ä»£ç çš„æ”»å‡»ã€‚ java.lang.ClassLoader ç±»çš„ preDefineClass æ–¹æ³•æ˜¯æ²™ç®±ä¿æŠ¤æœºåˆ¶çš„æ ¸å¿ƒå®ç° 1234567891011121314151617181920212223242526// è¿™ä¸ªæ–¹æ³•åœ¨åŒäº²å§”æ´¾æ¨¡å‹ä¹‹å‰è¢«è°ƒç”¨ï¼Œç”¨äºåœ¨åŠ è½½ç±»ä¹‹å‰è¿›è¡Œä¸€äº›é¢„å¤„ç†æ“ä½œã€‚// å‚æ•°ï¼š// name: è¦åŠ è½½çš„ç±»çš„å…¨é™å®šåã€‚// pd: æä¾›çš„ä¿æŠ¤åŸŸä¿¡æ¯ï¼Œå¯èƒ½ä¸º nullã€‚private ProtectionDomain preDefineClass(String name, ProtectionDomain pd) &#123; if (!checkName(name)) throw new NoClassDefFoundError(&quot;IllegalName: &quot; + name); // Note: Checking logic in java.lang.invoke.MemberName.checkForTypeAlias // relies on the fact that spoofing is impossible if a class has a name // of the form &quot;java.*&quot; if ((name != null) &amp;&amp; name.startsWith(&quot;java.&quot;)) &#123; throw new SecurityException (&quot;Prohibited package name: &quot; + name.substring(0, name.lastIndexOf(&#x27;.&#x27;))); &#125; if (pd == null) &#123; pd = defaultDomain; &#125; if (name != null) checkCerts(name, pd.getCodeSource()); return pd; &#125; è¿™ä¸ªæ–¹æ³• preDefineClass çš„ä½œç”¨æ˜¯åœ¨ç±»è¢«å®šä¹‰ä¹‹å‰è¿›è¡Œä¸€äº›å®‰å…¨æ£€æŸ¥å’Œå‡†å¤‡å·¥ä½œï¼Œç¡®ä¿ç±»çš„åˆæ³•æ€§ä¸å®‰å…¨æ€§ã€‚å®ƒé€šå¸¸ç”¨äºè‡ªå®šä¹‰ç±»åŠ è½½å™¨ä¸­ï¼Œä»¥å¢å¼ºç±»åŠ è½½è¿‡ç¨‹ä¸­çš„å®‰å…¨æ§åˆ¶ã€‚ æ–¹æ³•ä½œç”¨è¯¦è§£ï¼š 1.é˜²æ­¢å®šä¹‰éæ³•ç±»åçš„ç±»ï¼ˆå¦‚ java.* åŒ…ä¸‹çš„ç±»ï¼‰ï¼š å¦‚æœå°è¯•åŠ è½½çš„ç±»å±äº java. å¼€å¤´çš„æ ‡å‡†åŒ…ï¼ˆå¦‚ java.lang, java.util ç­‰ï¼‰ï¼Œä¼šæŠ›å‡º SecurityExceptionã€‚ è¿™æ˜¯ä¸ºäº†é˜²æ­¢ç”¨æˆ·è‡ªå®šä¹‰ç±»ä¼ªè£…æˆ Java æ ¸å¿ƒç±»åº“ä¸­çš„ç±»ï¼Œä»è€Œé€ æˆå®‰å…¨é£é™©ã€‚ 2.æ ¡éªŒç±»ååˆæ³•æ€§ï¼š è°ƒç”¨ checkName(name) æ£€æŸ¥ç±»åæ˜¯å¦åˆæ³•ï¼ˆä¾‹å¦‚ä¸èƒ½åŒ…å« /ã€éæ³•å­—ç¬¦ç­‰ï¼‰ï¼Œè‹¥ä¸åˆæ³•åˆ™æŠ›å‡º NoClassDefFoundErrorã€‚ 3.è¯ä¹¦ä¸€è‡´æ€§æ ¡éªŒï¼ˆç­¾åä¸€è‡´æ€§æ ¡éªŒï¼‰ï¼š å¦‚æœç±»æœ‰åç§°ä¸”æä¾›äº† ProtectionDomainï¼Œä¼šè°ƒç”¨ checkCerts(name, codeSource) æ¥ç¡®ä¿å½“å‰ç±»çš„ç­¾åä¸å…¶æ‰€åœ¨åŒ…ä¸­å…¶ä»–ç±»çš„ç­¾åä¸€è‡´ã€‚ é˜²æ­¢åŒä¸€åŒ…ä¸­æ··å…¥ä¸åŒç­¾åçš„ç±»ï¼Œé¿å…æ½œåœ¨çš„æ¶æ„ç¯¡æ”¹ã€‚ 4.è®¾ç½®é»˜è®¤ä¿æŠ¤åŸŸï¼ˆProtectionDomainï¼‰ï¼š å¦‚æœä¼ å…¥çš„ ProtectionDomain ä¸º nullï¼Œåˆ™ä½¿ç”¨ç±»åŠ è½½å™¨çš„é»˜è®¤åŸŸ defaultDomainã€‚ Linkingé“¾æ¥è¿‡ç¨‹ åœ¨ClassLoaderçš„loadClassâ½…æ³•ä¸­ï¼Œè¿˜æœ‰â¼€ä¸ªä¸èµ·çœ¼çš„æ­¥éª¤ï¼ŒresolveClassã€‚è¿™æ˜¯â¼€ä¸ªnativeâ½…æ³•ã€‚â½½å…¶å®ç°çš„è¿‡ç¨‹ç§°ä¸ºlinking-é“¾æ¥ã€‚ é“¾æ¥è¿‡ç¨‹çš„å®ç°åŠŸèƒ½å¦‚ä¸‹å›¾ï¼š å…¶ä¸­å…³äºåŠåˆå§‹åŒ–çŠ¶æ€å°±æ˜¯JDKåœ¨å¤„ç†â¼€ä¸ªç±»çš„staticé™æ€å±æ€§æ—¶ï¼Œä¼šå…ˆç»™è¿™ä¸ªå±æ€§åˆ†é…â¼€ä¸ªé»˜è®¤å€¼ï¼Œä½œâ½¤æ˜¯å ä½å†…å­˜ã€‚ç„¶åç­‰è¿æ¥è¿‡ç¨‹å®Œæˆåï¼Œåœ¨åâ¾¯çš„åˆå§‹åŒ–é˜¶æ®µï¼Œå†å°†é™æ€å±æ€§ä»é»˜è®¤å€¼ä¿®æ”¹ä¸ºæŒ‡å®šçš„åˆå§‹å€¼ã€‚ ç¬¦å·å¼•â½¤å’Œç›´æ¥å¼•â½¤ å¦‚æœAç±»ä¸­æœ‰â¼€ä¸ªé™æ€å±æ€§ï¼Œå¼•â½¤äº†å¦â¼€ä¸ªBç±»ã€‚é‚£ä¹ˆåœ¨å¯¹ç±»è¿›â¾åˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­ï¼Œå› ä¸ºAå’ŒBè¿™ä¸¤ä¸ªç±»éƒ½æ²¡æœ‰åˆå§‹åŒ–ï¼ŒJVMå¹¶ä¸çŸ¥é“Aå’ŒBè¿™ä¸¤ä¸ªç±»çš„å…·ä½“åœ°å€ã€‚æ‰€ä»¥è¿™æ—¶ï¼Œåœ¨Aç±»ä¸­ï¼Œåªèƒ½åˆ›å»ºâ¼€ä¸ªä¸çŸ¥é“å…·ä½“åœ°å€çš„å¼•â½¤ï¼ŒæŒ‡å‘Bç±»ã€‚è¿™ä¸ªå¼•â½¤å°±ç§°ä¸ºç¬¦å·å¼•â½¤ã€‚â½½å½“Aç±»å’ŒBç±»éƒ½å®Œæˆåˆå§‹åŒ–åï¼ŒJVMâ¾ƒç„¶å°±éœ€è¦å°†è¿™ä¸ªç¬¦å·å¼•â½¤è½¬â½½æŒ‡å‘Bç±»å…·ä½“çš„å†…å­˜åœ°å€ï¼Œè¿™ä¸ªå¼•â½¤å°±ç§°ä¸ºç›´æ¥å¼•â½¤ã€‚ æ¥çœ‹ä¸€ä¸ªæœ‰æ„æ€çš„ç¤ºä¾‹ 1234567891011121314151617181920class Apple &#123; // é™æ€å˜é‡æŒ‰å£°æ˜é¡ºåºåˆå§‹åŒ– // æ„é€ æ–¹æ³•åˆå§‹åŒ–appleå¯¹è±¡æ—¶ï¼Œpriceè¿˜æ²¡æœ‰è¢«åˆå§‹åŒ–ï¼Œå¤„äºé“¾æ¥è¿‡ç¨‹ä¸­çš„å‡†å¤‡é˜¶æ®µï¼Œå³åŠåˆå§‹åŒ–çŠ¶æ€ï¼Œæ‰€ä»¥priceä¸ºé»˜è®¤å€¼0.0 static Apple apple = new Apple(10); // è§£å†³æ–¹æ³•æ˜¯å°†priceå£°æ˜åœ¨appleçš„ä¸Šé¢å³å¯ static double price = 20.00; double totalpay; public Apple(double discount) &#123; System.out.println(&quot;====&quot; + price); totalpay = price - discount; &#125;&#125;public class PriceTest &#123; public static void main(String[] args) &#123; System.out.println(Apple.apple.totalpay); // -10.0 &#125;&#125; è¿™é‡Œæœ‰ä¸€ä¸ªæœ‰æ„æ€çš„é—®é¢˜ï¼Œå°±æ˜¯åªæœ‰å½“loadClassæ–¹æ³•ä¸­çš„resolveå‚æ•°ä¸ºtrueæ—¶resolveClassæ–¹æ³•æ‰ä¼šè¢«è°ƒç”¨ï¼Œä½†æ˜¯å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œresolveå‚æ•°éƒ½æ˜¯falseï¼Œè¿™ä¸æ˜¯å¼ºåˆ¶é™åˆ¶è€Œæ˜¯å‡ºäºä»¥ä¸‹åŸå› ï¼š é¿å…é€’å½’è§£æä¸­å‡ºç°é”™è¯¯æˆ–æ­»å¾ªç¯ åœ¨ç±»çš„è§£æè¿‡ç¨‹ä¸­ï¼Œå¦‚æœè¯¥ç±»å¼•ç”¨äº†å¦ä¸€ä¸ªè¿˜æ²¡åŠ è½½çš„ç±»ï¼Œç«‹å³è§£æå¯èƒ½ä¼šå¯¼è‡´æ— é™é€’å½’æˆ–åŠ è½½é¡ºåºé—®é¢˜ã€‚é€šè¿‡å»¶è¿Ÿè§£æï¼Œå¯ä»¥æ›´å¥½åœ°æ§åˆ¶åŠ è½½æµç¨‹ã€‚ æé«˜åŠ è½½æ•ˆç‡ åŠ è½½ç±»å¯èƒ½ä¸ä¸€å®šé©¬ä¸Šå°±ç”¨åˆ°æ‰€æœ‰æ–¹æ³•ã€å­—æ®µç­‰ç¬¦å·å¼•ç”¨ï¼Œæ¨è¿Ÿè§£æå¯ä»¥æé«˜æ€§èƒ½ï¼Œå°¤å…¶åœ¨æ‰¹é‡åŠ è½½å¾ˆå¤šç±»æ—¶ã€‚ æ›´çµæ´»åœ°å¤„ç†ç±»çš„ä¾èµ– å¼€å‘è€…å¯ä»¥å…ˆåŠ è½½ç±»ï¼Œç¨åæ ¹æ®éœ€è¦å†è§£æã€‚ä¾‹å¦‚ï¼Œåœ¨è‡ªå®šä¹‰ç±»åŠ è½½å™¨ä¸­ï¼Œå¯èƒ½å…ˆåˆ¤æ–­ç±»æ˜¯å¦å·²ç»å­˜åœ¨ã€æ˜¯å¦éœ€è¦è¢«å¢å¼ºï¼ˆæ¯”å¦‚å­—èŠ‚ç å¢å¼ºï¼‰ï¼Œå†å†³å®šæ˜¯å¦è§£æã€‚ é€šè¿‡ç±»åŠ è½½å™¨å¼•â¼Šå¤–éƒ¨JaråŒ… è™½ç„¶é€šå¸¸æˆ‘ä»¬ä¼šå°†ä¾èµ–çš„ jar åŒ…ç›´æ¥æ”¾å…¥é¡¹ç›®çš„ classpath ä¸­ï¼ˆæ¯”å¦‚é€šè¿‡æ„å»ºå·¥å…·å¦‚ Maven æˆ– Gradle ç®¡ç†ï¼‰ï¼Œä½†åœ¨æŸäº›ç‰¹å®šåœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬ç¡®å®éœ€è¦åŠ¨æ€åœ°é€šè¿‡ URLClassLoader åŠ è½½å¤–éƒ¨ jar åŒ…ï¼Œè¿™æ˜¯ Java æä¾›çš„ä¸€ç§æ›´çµæ´»çš„ç±»åŠ è½½æœºåˆ¶ã€‚ ä»¥ä¸‹æ˜¯ä¸€äº›å¿…é¡»æˆ–æ¨èä½¿ç”¨ URLClassLoader çš„å…¸å‹åº”ç”¨åœºæ™¯ï¼š 1. æ’ä»¶æœºåˆ¶ï¼ˆPlugin Systemï¼‰ åœºæ™¯è¯´æ˜ï¼š ç³»ç»Ÿæ”¯æŒç”¨æˆ·è‡ªå®šä¹‰æ’ä»¶ï¼ˆå¦‚ IDE æ’ä»¶ã€æµè§ˆå™¨æ‰©å±•ã€æ¸¸æˆ modï¼‰ï¼Œè¿™äº›æ’ä»¶åœ¨è¿è¡Œæ—¶æ‰åŠ è½½ï¼Œé¡¹ç›®æœ¬èº«åœ¨ç¼–è¯‘æœŸå¹¶ä¸çŸ¥é“æœ‰å“ªäº›æ’ä»¶ã€‚ ä¸¾ä¾‹ï¼š Eclipse æˆ– IntelliJ çš„æ’ä»¶ç³»ç»Ÿ Minecraft çš„ mod åŠ è½½å™¨ Spring Boot Devtools é‡æ–°åŠ è½½æœºåˆ¶ ä¸ºä»€ä¹ˆä¸èƒ½ç›´æ¥æ”¾å…¥ classpathï¼Ÿ å› ä¸ºæ’ä»¶æ˜¯åŠ¨æ€å‘ç°å’ŒåŠ è½½çš„ï¼Œä¸æ˜¯ç¼–è¯‘æ—¶ç¡®å®šçš„ã€‚ 2. çƒ­éƒ¨ç½² / åŠ¨æ€åŠ è½½ç±» åœºæ™¯è¯´æ˜ï¼š ä½ æƒ³åœ¨åº”ç”¨è¿è¡Œè¿‡ç¨‹ä¸­åŠ è½½æ–°çš„ jar æˆ–ç±»ï¼Œæ¯”å¦‚çƒ­æ›´æ–°ä¸€ä¸ªæ¨¡å—è€Œæ— éœ€é‡å¯æœåŠ¡ã€‚ ä¸¾ä¾‹ï¼š Web å®¹å™¨ï¼ˆå¦‚ Tomcatï¼‰çš„åº”ç”¨é‡æ–°éƒ¨ç½² ä½¿ç”¨ URLClassLoader åŠ è½½æŸä¸ªæ¨¡å—çš„æ–°ç‰ˆæœ¬ä»¥å®ç°çƒ­æ›¿æ¢ ä¸ºä»€ä¹ˆä¸èƒ½æ”¾å…¥ classpathï¼Ÿ classpath åœ¨å¯åŠ¨æ—¶å°±å›ºå®šäº†ï¼Œä¸èƒ½åŠ¨æ€æ·»åŠ ï¼›è€Œ URLClassLoader å¯ä»¥è¿è¡Œæ—¶åŠ è½½æ–° jarã€‚ 3. å¤šç‰ˆæœ¬éš”ç¦» åœºæ™¯è¯´æ˜ï¼š ä½ å¸Œæœ›ä¸åŒçš„æ¨¡å—ä½¿ç”¨åŒä¸€ä¸ªåº“çš„ä¸åŒç‰ˆæœ¬ï¼Œä½† classpath æ— æ³•æ”¯æŒä¸¤ä¸ªç‰ˆæœ¬çš„åŒä¸€ä¸ªç±»ã€‚ ä¸¾ä¾‹ï¼š ä¸€ä¸ªæœåŠ¡å™¨è¿è¡Œå¤šä¸ªæœåŠ¡å®ä¾‹ï¼Œå®ƒä»¬åˆ†åˆ«ä¾èµ– log4j çš„ä¸åŒç‰ˆæœ¬ ä¸€ä¸ªç³»ç»Ÿçš„æ’ä»¶ A ä½¿ç”¨ fastjson 1.xï¼Œæ’ä»¶ B ä½¿ç”¨ fastjson 2.x ä¸ºä»€ä¹ˆä¸èƒ½æ”¾å…¥ classpathï¼Ÿ classpath æ˜¯å…±äº«çš„ï¼Œä¼šå‘ç”Ÿç±»å†²çªã€‚ä½¿ç”¨å¤šä¸ª URLClassLoaderï¼Œå¯å®ç°ç±»éš”ç¦»ã€‚ 4. è„šæœ¬æˆ–ç”¨æˆ·ä¸Šä¼ ä»£ç æ‰§è¡Œ åœºæ™¯è¯´æ˜ï¼š ç³»ç»Ÿå…è®¸ç”¨æˆ·ä¸Šä¼  jar æˆ– class æ–‡ä»¶ï¼Œç„¶ååœ¨æœåŠ¡ç«¯æ‰§è¡Œå…¶ä¸­çš„ç±»é€»è¾‘ã€‚ ä¸¾ä¾‹ï¼š åœ¨çº¿ç¼–ç¨‹å¹³å°ï¼ˆå¦‚ LeetCode åç«¯ï¼‰ ç”¨æˆ·ä¸Šä¼ ç®—æ³• jarï¼Œå¹³å°è¿è¡Œå¹¶è¿”å›ç»“æœ ä¸ºä»€ä¹ˆä¸èƒ½æ”¾å…¥ classpathï¼Ÿ ç”¨æˆ·ä¸Šä¼ å†…å®¹æ˜¯åŠ¨æ€çš„ï¼Œç³»ç»Ÿåœ¨è¿è¡Œå‰æ— æ³•é¢„çŸ¥ã€‚ 5. å®ç°ç±»çš„å»¶è¿ŸåŠ è½½ï¼ˆèŠ‚çœèµ„æºï¼‰ åœºæ™¯è¯´æ˜ï¼š æŸäº›ç±»/æ¨¡å—ä½“ç§¯è¾ƒå¤§æˆ–ä¾èµ–è¾ƒå¤šï¼Œä¸å¸Œæœ›åœ¨ç¨‹åºå¯åŠ¨æ—¶å°±åŠ è½½ï¼Œåªæœ‰çœŸæ­£ä½¿ç”¨æ—¶å†åŠ è½½ã€‚ ä¸¾ä¾‹ï¼š å¤§å‹æ¡Œé¢åº”ç”¨ï¼ˆå¦‚ IntelliJï¼‰åœ¨æ‰“å¼€æŸä¸ªåŠŸèƒ½æ¨¡å—æ—¶æ‰åŠ è½½ç›¸åº” jar æ€»ç»“ åœºæ™¯ ä½¿ç”¨ URLClassLoader çš„åŸå›  æ’ä»¶ç³»ç»Ÿ æ’ä»¶åŠ¨æ€åŠ è½½ï¼Œä¸åœ¨é¡¹ç›®ç¼–è¯‘æ—¶å¯çŸ¥ çƒ­éƒ¨ç½² åŠ¨æ€æ›¿æ¢æ¨¡å—ï¼Œæ— éœ€é‡å¯ å¤šç‰ˆæœ¬å…±å­˜ é¿å…ç±»å†²çªï¼Œå®ç°ç±»åŠ è½½éš”ç¦» ç”¨æˆ·ä¸Šä¼  jar å†…å®¹åŠ¨æ€ç”Ÿæˆï¼Œclasspath æ— æ³•é¢„å…ˆé…ç½® å»¶è¿ŸåŠ è½½æ¨¡å— å¯åŠ¨æ›´å¿«ï¼ŒèŠ‚çœå†…å­˜ å¦‚æœä½ æ˜¯åœ¨åšæ¡†æ¶è®¾è®¡æˆ–éœ€è¦åŠ¨æ€æ‰©å±•èƒ½åŠ›çš„åœºæ™¯ï¼Œç†è§£å¹¶ä½¿ç”¨ URLClassLoader ä¼šéå¸¸æœ‰å¸®åŠ©ã€‚ åœºæ™¯å‡è®¾ è°ƒç”¨å¤–éƒ¨jar æˆ‘ä»¬æœ‰ä¸€ä¸ªå¤–éƒ¨ jar æ–‡ä»¶ï¼šhello-plugin.jarï¼Œå®ƒåŒ…å«ä¸€ä¸ªç±»ï¼š 12345678// è¿™ä¸ªç±»ç¼–è¯‘åæ‰“åŒ…è¿› hello-plugin.jarpackage com.example.plugin;public class HelloPlugin &#123; public void sayHello(String name) &#123; System.out.println(&quot;Hello from plugin! :&quot; + name); &#125;&#125; ä¸»ç¨‹åºä½¿ç”¨ URLClassLoader åŠ¨æ€åŠ è½½è¿™ä¸ª jar 12345678910111213141516171819202122232425262728import java.io.File;import java.lang.reflect.Method;import java.net.URL;import java.net.URLClassLoader;public class PluginLoader &#123; public static void main(String[] args) throws Exception &#123; // å¤–éƒ¨ jar çš„è·¯å¾„ File jarFile = new File(&quot;plugins/hello-plugin.jar&quot;); URL jarUrl = jarFile.toURI().toURL(); // HTTPS jar çš„ URL // URL jarUrl = new URL(&quot;https://your-domain.com/libs/hello-plugin.jar&quot;); // æ„å»º URLClassLoaderï¼ˆä¹Ÿå¯ä»¥è®¾ç½®çˆ¶åŠ è½½å™¨ï¼‰ URLClassLoader classLoader = new URLClassLoader(new URL[]&#123;jarUrl&#125;); // åŠ è½½æ’ä»¶ç±» Class&lt;?&gt; clazz = classLoader.loadClass(&quot;com.example.plugin.HelloPlugin&quot;); // åˆ›å»ºå®ä¾‹å¹¶è°ƒç”¨æ–¹æ³• Object plugin = clazz.getDeclaredConstructor().newInstance(); Method sayHello = clazz.getMethod(&quot;sayHello&quot;, String.class); sayHello.invoke(plugin, &quot;World&quot;); // å…³é—­ ClassLoaderï¼ˆJava 7+ æ¨èï¼‰ classLoader.close(); &#125;&#125; è¿è¡Œæ—¶åŠ¨æ€ç¼–è¯‘ Java æºä»£ç  æˆ‘ä»¬æœ‰ä¸€ä¸ª java ä»£ç ç‰‡æ®µï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364import javax.tools.JavaCompiler;import javax.tools.ToolProvider;import java.io.File;import java.io.FileWriter;import java.lang.reflect.Method;import java.net.URL;import java.net.URLClassLoader;import java.nio.file.Files;import java.nio.file.Path;public class DynamicJavaRunner &#123; public static void main(String[] args) throws Exception &#123; String className = &quot;com.example.dynamic.Hello&quot;; // Java æºä»£ç  String sourceCode = &quot;package com.example.dynamic;\\n&quot; + &quot;\\n&quot; + &quot;public class Hello &#123;\\n&quot; + &quot; public void say() &#123;\\n&quot; + &quot; System.out.println(\\&quot;Hello from dynamic source!\\&quot;);\\n&quot; + &quot; &#125;\\n&quot; + &quot;&#125;\\n&quot;; // åˆ›å»ºä¸´æ—¶ç›®å½• Path tempDir = Files.createTempDirectory(&quot;dynamic-classes&quot;); File outputDir = tempDir.toFile(); // System.out.println(&quot;ä¸´æ—¶ç›®å½•ï¼š&quot; + outputDir.getAbsolutePath()); // åˆ›å»º .java æ–‡ä»¶ File javaFile = new File(outputDir, &quot;com/example/dynamic/Hello.java&quot;); javaFile.getParentFile().mkdirs(); try (FileWriter writer = new FileWriter(javaFile)) &#123; writer.write(sourceCode); &#125; // ç¼–è¯‘ Java æ–‡ä»¶ JavaCompiler compiler = ToolProvider.getSystemJavaCompiler(); if (compiler == null) &#123; System.err.println(&quot;è¯·ç”¨ JDK è€Œé JRE è¿è¡Œï¼&quot;); return; &#125; int result = compiler.run(null, null, null, javaFile.getPath()); if (result != 0) &#123; System.err.println(&quot;ç¼–è¯‘å¤±è´¥ï¼&quot;); return; &#125; // åŠ è½½ç±»å¹¶è°ƒç”¨ URLClassLoader classLoader = new URLClassLoader(new URL[]&#123;outputDir.toURI().toURL()&#125;); Class&lt;?&gt; clazz = classLoader.loadClass(className); Object instance = clazz.getDeclaredConstructor().newInstance(); Method method = clazz.getMethod(&quot;say&quot;); method.invoke(instance); // æ¸…ç†ï¼ˆå¯é€‰ï¼‰ classLoader.close(); // åˆ é™¤ä¸´æ—¶ç›®å½• Files.walk(outputDir.toPath()) .sorted(Comparator.reverseOrder()) // å…ˆåˆ æ–‡ä»¶ï¼Œå†åˆ ç›®å½• .map(Path::toFile) .forEach(File::delete); &#125;&#125; å…³é”®ç‚¹è¯´æ˜ æœºåˆ¶ è¯´æ˜ JavaCompiler JDK è‡ªå¸¦çš„ç¼–è¯‘å™¨ï¼ˆtools.jarï¼‰ ToolProvider.getSystemJavaCompiler() åªèƒ½åœ¨ JDK ç¯å¢ƒä¸­å·¥ä½œï¼ŒJRE æ— æ³•ä½¿ç”¨ URLClassLoader ç”¨äºåŠ è½½ç¼–è¯‘åçš„ .class æ–‡ä»¶ FileWriter ä¿å­˜ä»£ç ä¸ºä¸´æ—¶ Java æ–‡ä»¶ è‡ªå®šä¹‰ç±»åŠ è½½å™¨ è¦è‡ªå®šä¹‰ ClassLoaderï¼Œåªéœ€è¦ç»§æ‰¿äº ClassLoader æˆ–è€… SecureClassLoaderï¼Œå¹¶é‡å†™ findClass() æ–¹æ³•å³å¯ ç¤ºä¾‹ï¼šæˆ‘ä»¬å¯¹ä¸Šé¢çš„ä»£ç è¿›è¡Œå‡çº§ï¼Œä¸åˆ›å»ºä¸´æ—¶æ–‡ä»¶ï¼Œè€Œæ˜¯åœ¨å†…å­˜ä¸­ç¼–è¯‘ä»£ç ï¼Œå¹¶ä»å†…å­˜ä¸­åŠ è½½å­—èŠ‚ç ï¼Œè€Œä¸ä¾èµ–ç£ç›˜æ–‡ä»¶ï¼Œæ›´é«˜æ•ˆä¹Ÿæ›´é€‚åˆç”Ÿäº§ç¯å¢ƒä¸­åŠ¨æ€ç±»åŠ è½½ï¼ˆå¦‚åœ¨çº¿ä»£ç æ‰§è¡Œã€è„šæœ¬å¼•æ“ç­‰ï¼‰ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114import javax.tools.*;import java.io.*;import java.net.URI;import java.util.*;import java.lang.reflect.*;public class InMemoryJavaRunner &#123; public static void main(String[] args) throws Exception &#123; String className = &quot;com.example.dynamic.Hello&quot;; String sourceCode = &quot;package com.example.dynamic;\\n&quot; + &quot;public class Hello &#123;\\n&quot; + &quot; public void say() &#123;\\n&quot; + &quot; System.out.println(\\&quot;Hello from memory compiled class!\\&quot;);\\n&quot; + &quot; &#125;\\n&quot; + &quot;&#125;&quot;; // è·å–ç³»ç»Ÿ Java ç¼–è¯‘å™¨ JavaCompiler compiler = ToolProvider.getSystemJavaCompiler(); if (compiler == null) &#123; System.err.println(&quot;è¯·ä½¿ç”¨ JDK è¿è¡Œæ­¤ç¨‹åºï¼ˆé JREï¼‰&quot;); return; &#125; // å‡†å¤‡ç¼–è¯‘æºä»£ç ï¼šä¸€ä¸ª JavaFileObject è¡¨ç¤ºæºä»£ç  JavaFileObject sourceFile = new JavaSourceFromString(className, sourceCode); // åˆ›å»ºè‡ªå®šä¹‰çš„å†…å­˜æ–‡ä»¶ç®¡ç†å™¨ï¼ˆæ›¿ä»£æ ‡å‡†çš„ç£ç›˜ç®¡ç†å™¨ï¼‰ StandardJavaFileManager standardFileManager = compiler.getStandardFileManager(null, null, null); MemoryJavaFileManager fileManager = new MemoryJavaFileManager(standardFileManager); // æ‰§è¡Œç¼–è¯‘ä»»åŠ¡ JavaCompiler.CompilationTask task = compiler.getTask(null, fileManager, null, null, null, Collections.singletonList(sourceFile)); boolean success = task.call(); if (!success) &#123; System.err.println(&quot;ç¼–è¯‘å¤±è´¥ï¼&quot;); return; &#125; // åŠ è½½ç¼–è¯‘åçš„ç±» Map&lt;String, byte[]&gt; classBytes = fileManager.getClassBytes(); InMemoryClassLoader classLoader = new InMemoryClassLoader(classBytes); Class&lt;?&gt; clazz = classLoader.loadClass(className); Object instance = clazz.getDeclaredConstructor().newInstance(); Method method = clazz.getMethod(&quot;say&quot;); method.invoke(instance); &#125; // ç”¨äºè¡¨ç¤ºå†…å­˜ä¸­çš„ Java æºä»£ç  static class JavaSourceFromString extends SimpleJavaFileObject &#123; final String code; JavaSourceFromString(String className, String code) &#123; super(URI.create(&quot;string:///&quot; + className.replace(&#x27;.&#x27;, &#x27;/&#x27;) + Kind.SOURCE.extension), Kind.SOURCE); this.code = code; &#125; public CharSequence getCharContent(boolean ignoreEncodingErrors) &#123; return code; &#125; &#125; // å°†ç¼–è¯‘çš„ class æ–‡ä»¶ä¿å­˜åœ¨å†…å­˜ä¸­ï¼ˆä¸æ˜¯æ–‡ä»¶ç³»ç»Ÿï¼‰ static class MemoryJavaFileManager extends ForwardingJavaFileManager&lt;StandardJavaFileManager&gt; &#123; private final Map&lt;String, ByteArrayOutputStream&gt; classOutputBuffers = new HashMap&lt;&gt;(); MemoryJavaFileManager(StandardJavaFileManager standardManager) &#123; super(standardManager); &#125; @Override public JavaFileObject getJavaFileForOutput(Location location, String className, JavaFileObject.Kind kind, FileObject sibling) &#123; ByteArrayOutputStream outputStream = new ByteArrayOutputStream(); classOutputBuffers.put(className, outputStream); return new SimpleJavaFileObject( URI.create(&quot;mem:///&quot; + className.replace(&#x27;.&#x27;, &#x27;/&#x27;) + kind.extension), kind) &#123; @Override public OutputStream openOutputStream() &#123; return outputStream; &#125; &#125;; &#125; public Map&lt;String, byte[]&gt; getClassBytes() &#123; Map&lt;String, byte[]&gt; result = new HashMap&lt;&gt;(); for (Map.Entry&lt;String, ByteArrayOutputStream&gt; entry : classOutputBuffers.entrySet()) &#123; result.put(entry.getKey(), entry.getValue().toByteArray()); &#125; return result; &#125; &#125; // è‡ªå®šä¹‰ ClassLoaderï¼Œç”¨äºä»å†…å­˜ä¸­åŠ è½½å­—èŠ‚ç  static class InMemoryClassLoader extends ClassLoader &#123; private final Map&lt;String, byte[]&gt; classBytes; public InMemoryClassLoader(Map&lt;String, byte[]&gt; classBytes) &#123; super(ClassLoader.getSystemClassLoader()); this.classBytes = classBytes; &#125; @Override protected Class&lt;?&gt; findClass(String name) throws ClassNotFoundException &#123; // ä»å†…å­˜ä¸­è·å–å­—èŠ‚ç  byte[] bytes = classBytes.get(name); if (bytes == null) &#123; return super.findClass(name); &#125; // å®šä¹‰ç±»å¹¶è¿”å›ï¼Œä¸€å®šè¦ä½¿ç”¨ defineClass æ–¹æ³• return defineClass(name, bytes, 0, bytes.length); &#125; &#125;&#125; è¿›ä¸€æ­¥å‡çº§ï¼šæˆ‘ä»¬ç°åœ¨å°†è¿™ä¸ªç³»ç»Ÿæ‰©å±•ä¸ºæ”¯æŒå¤šä¸ªç±»åŒæ—¶åŠ¨æ€ç¼–è¯‘ã€å†…å­˜åŠ è½½å¹¶æ‰§è¡Œã€‚è¿™å¯¹äºéœ€è¦å¤„ç†å¤šä¸ªç±»ï¼ˆä¾‹å¦‚æ¥å£ + å®ç°ã€å†…éƒ¨ä¾èµ–ç­‰ï¼‰éå¸¸å®ç”¨ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127import javax.tools.*;import java.io.*;import java.net.URI;import java.util.*;import java.lang.reflect.*;// ä¸»ç±»public class MultiClassInMemoryCompiler &#123; public static void main(String[] args) throws Exception &#123; // å‡†å¤‡å¤šä¸ªç±»çš„æºä»£ç  Map&lt;String, String&gt; sources = new HashMap&lt;&gt;(); sources.put(&quot;com.example.api.Greeter&quot;, &quot;package com.example.api;\\n&quot; + &quot;public interface Greeter &#123;\\n&quot; + &quot; void greet();\\n&quot; + &quot;&#125;\\n&quot;); sources.put(&quot;com.example.impl.EnglishGreeter&quot;, &quot;package com.example.impl;\\n&quot; + &quot;import com.example.api.Greeter;\\n&quot; + &quot;public class EnglishGreeter implements Greeter &#123;\\n&quot; + &quot; public void greet() &#123;\\n&quot; + &quot; System.out.println(\\&quot;Hello from EnglishGreeter!\\&quot;);\\n&quot; + &quot; &#125;\\n&quot; + &quot;&#125;\\n&quot;); String entryClassName = &quot;com.example.impl.EnglishGreeter&quot;; // ç¼–è¯‘ Map&lt;String, byte[]&gt; compiledClasses = compile(sources); if (compiledClasses == null) &#123; System.err.println(&quot;ç¼–è¯‘å¤±è´¥&quot;); return; &#125; // åŠ è½½å¹¶æ‰§è¡Œ InMemoryClassLoader classLoader = new InMemoryClassLoader(compiledClasses); Class&lt;?&gt; clazz = classLoader.loadClass(entryClassName); Object obj = clazz.getDeclaredConstructor().newInstance(); Method method = clazz.getMethod(&quot;greet&quot;); method.invoke(obj); &#125; // ç¼–è¯‘å™¨å…¥å£ï¼Œæ”¯æŒå¤šä¸ªç±» public static Map&lt;String, byte[]&gt; compile(Map&lt;String, String&gt; sources) &#123; JavaCompiler compiler = ToolProvider.getSystemJavaCompiler(); if (compiler == null) &#123; System.err.println(&quot;è¯·ä½¿ç”¨ JDK è¿è¡Œ&quot;); return null; &#125; List&lt;JavaFileObject&gt; compilationUnits = new ArrayList&lt;&gt;(); for (Map.Entry&lt;String, String&gt; entry : sources.entrySet()) &#123; compilationUnits.add(new JavaSourceFromString(entry.getKey(), entry.getValue())); &#125; StandardJavaFileManager stdManager = compiler.getStandardFileManager(null, null, null); MemoryJavaFileManager memManager = new MemoryJavaFileManager(stdManager); JavaCompiler.CompilationTask task = compiler.getTask(null, memManager, null, null, null, compilationUnits); boolean success = task.call(); return success ? memManager.getClassBytes() : null; &#125; // æºæ–‡ä»¶è¡¨ç¤ºï¼ˆJava ä»£ç ä»¥å­—ç¬¦ä¸²æä¾›ï¼‰ static class JavaSourceFromString extends SimpleJavaFileObject &#123; final String code; JavaSourceFromString(String className, String code) &#123; super(URI.create(&quot;string:///&quot; + className.replace(&#x27;.&#x27;, &#x27;/&#x27;) + Kind.SOURCE.extension), Kind.SOURCE); this.code = code; &#125; @Override public CharSequence getCharContent(boolean ignoreEncodingErrors) &#123; return code; &#125; &#125; // å†…å­˜ä¸­çš„ç¼–è¯‘è¾“å‡ºç®¡ç†å™¨ static class MemoryJavaFileManager extends ForwardingJavaFileManager&lt;StandardJavaFileManager&gt; &#123; private final Map&lt;String, ByteArrayOutputStream&gt; classOutputBuffers = new HashMap&lt;&gt;(); MemoryJavaFileManager(StandardJavaFileManager standardManager) &#123; super(standardManager); &#125; @Override public JavaFileObject getJavaFileForOutput(Location location, String className, JavaFileObject.Kind kind, FileObject sibling) &#123; ByteArrayOutputStream outputStream = new ByteArrayOutputStream(); classOutputBuffers.put(className, outputStream); return new SimpleJavaFileObject( URI.create(&quot;mem:///&quot; + className.replace(&#x27;.&#x27;, &#x27;/&#x27;) + kind.extension), kind) &#123; @Override public OutputStream openOutputStream() &#123; return outputStream; &#125; &#125;; &#125; public Map&lt;String, byte[]&gt; getClassBytes() &#123; Map&lt;String, byte[]&gt; result = new HashMap&lt;&gt;(); for (Map.Entry&lt;String, ByteArrayOutputStream&gt; entry : classOutputBuffers.entrySet()) &#123; result.put(entry.getKey(), entry.getValue().toByteArray()); &#125; return result; &#125; &#125; // ç”¨äºåŠ è½½å†…å­˜ä¸­çš„ class static class InMemoryClassLoader extends ClassLoader &#123; private final Map&lt;String, byte[]&gt; classBytes; public InMemoryClassLoader(Map&lt;String, byte[]&gt; classBytes) &#123; super(ClassLoader.getSystemClassLoader()); this.classBytes = classBytes; &#125; @Override protected Class&lt;?&gt; findClass(String name) throws ClassNotFoundException &#123; byte[] bytes = classBytes.get(name); if (bytes == null) return super.findClass(name); return defineClass(name, bytes, 0, bytes.length); &#125; &#125;&#125; æ‰“ç ´åŒäº²å§”æ´¾ï¼Œå®ç°åŒç±»å¤šç‰ˆæœ¬å…±å­˜ å‡è®¾æˆ‘ä»¬æœ‰åŒä¸€ä¸ªjaråŒ…çš„ä¸åŒç‰ˆæœ¬ï¼Œæ¯”å¦‚ï¼ša-1.0.jarå’Œa-2.0.jarï¼Œä»–ä»¬å…·æœ‰åŒåçš„ DemoClassç±» ,ç³»ç»Ÿclasspathä¸­å¼•å…¥çš„æ˜¯ a-1.0.jarï¼Œè€Œæ­¤æ—¶æˆ‘ä»¬é€šè¿‡â¾ƒå®šçš„ClassLoaderåŠ è½½ a-2.0.jarï¼Œå¹¶è°ƒç”¨ DemoClassç±» ï¼Œæˆ‘ä»¬ä¼šå‘ç°ï¼Œâ¾ƒå®šçš„ClassLoaderåŠ è½½çš„ç±»ä¾æ—§æ˜¯ a-1.0.jar ä¸­çš„ç±»ï¼Œè€Œä¸æ˜¯ a-2.0.jar ä¸­çš„ç±»ã€‚ ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ç§æƒ…å†µå‘¢ï¼Ÿè¿™å°±æ˜¯å› ä¸ºJDKçš„åŒäº²å§”æ´¾æœºåˆ¶ã€‚â¾ƒå®šçš„ClassLoaderçš„parentå±æ€§æŒ‡å‘çš„æ˜¯JDKå†…çš„AppClassLoaderï¼Œâ½½ AppClassLoader ä¼šåŠ è½½ç³»ç»Ÿå½“ä¸­çš„æ‰€æœ‰ä»£ç ï¼Œå°±åŒ…æ‹¬ a-1.0.jarä¸­çš„ DemoClassç±»ã€‚è¿™æ—¶ï¼Œâ¾ƒå®šçš„ClassLoaderå»åŠ è½½ DemoClassç±»æ—¶ï¼Œé€šè¿‡åŒäº²å§”æ´¾å‘ä¸ŠæŸ¥æ‰¾ï¼Œâ¾ƒç„¶åŠ è½½å‡ºæ¥çš„å°±æ˜¯APPClassloaderä¸­çš„DemoClassäº†ã€‚ å¦‚ä½•æ‰“ç ´åŒäº²å§”æ´¾å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥é€šè¿‡é‡å†™ loadClass()æ–¹æ³•ï¼Œæ¥æ‰“ç ´åŒäº²å§”æ´¾ï¼Œå®ç°ç±»â½‚ä»¶çš„åŠ è½½ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152import java.io.ByteArrayOutputStream;import java.io.InputStream;import java.net.URL;import java.net.URLConnection;import java.security.SecureClassLoader;public class CustomClassLoader extends SecureClassLoader &#123; private URL jarUrl; public CustomClassLoader(URL jarUrl) &#123; // åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„å­ç±»åŠ è½½å™¨ï¼ŒåªåŠ è½½æŒ‡å®š JAR this.jarUrl = jarUrl; &#125; @Override public Class&lt;?&gt; loadClass(String name, boolean resolve) throws ClassNotFoundException &#123; // æŠŠåŒäº²å§”æ´¾æœºåˆ¶åè¿‡æ¥ï¼Œå…ˆåˆ°â¼¦ç±»åŠ è½½å™¨ä¸­åŠ è½½ï¼ŒåŠ è½½ä¸åˆ°å†å»â½—ç±»åŠ è½½å™¨ä¸­åŠ è½½ã€‚ synchronized (getClassLoadingLock(name)) &#123; // å¦‚æœç±»å·²åŠ è½½ï¼Œåˆ™ç›´æ¥è¿”å› Class&lt;?&gt; loadedClass = findLoadedClass(name); if (loadedClass == null) &#123; loadedClass = findClass(name); &#125; else &#123; // å§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨ loadedClass = super.loadClass(name, resolve); &#125; return loadedClass; &#125; &#125; @Override protected Class&lt;?&gt; findClass(String name) &#123; int code; try &#123; // è®¿é—®jaråŒ…çš„url URLConnection urlConnection = jarUrl.openConnection(); urlConnection.setUseCaches(false); InputStream is = urlConnection.getInputStream(); ByteArrayOutputStream bos = new ByteArrayOutputStream(); while ((code = is.read()) != -1) &#123; bos.write(code); &#125; byte[] data = bos.toByteArray(); is.close(); bos.close(); return defineClass(name, data, 0, data.length); &#125; catch (Exception e) &#123; return null; &#125; &#125;&#125; æµ‹è¯•ä»£ç  12345678910111213141516import java.io.File;import java.net.URL;public class Test &#123; public static void main(String[] args) throws Exception &#123; File jarFile = new File(&quot;path/to/a-2.0.jar&quot;); URL jarUrl = jarFile.toURI().toURL(); CustomClassLoader loader = new CustomClassLoader(jarUrl); // åŠ è½½ DemoClass Class&lt;?&gt; clazz = loader.loadClass(&quot;com.example.DemoClass&quot;); Object obj = clazz.getDeclaredConstructor().newInstance(); clazz.getMethod(&quot;print&quot;).invoke(obj); &#125;&#125; æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶çš„å…¸å‹åœºæ™¯ Tomcatç±»åŠ è½½å™¨ CommonClassLoaderï¼šTomcatæœ€åŸºæœ¬çš„ç±»åŠ è½½å™¨ï¼ŒåŠ è½½è·¯å¾„ä¸­çš„classå¯ä»¥è¢«Tomcatå®¹å™¨æœ¬èº«ä»¥åŠå„ä¸ªWebappè®¿é—®ï¼› CatalinaClassLoaderï¼šTomcatå®¹å™¨ç§æœ‰çš„ç±»åŠ è½½å™¨ï¼ŒåŠ è½½è·¯å¾„ä¸­çš„classå¯¹äºWebappä¸å¯â»…ï¼› SharedClassLoaderï¼šå„ä¸ªWebappå…±äº«çš„ç±»åŠ è½½å™¨ï¼ŒåŠ è½½è·¯å¾„ä¸­çš„classå¯¹äºæ‰€æœ‰Webappå¯â»…ï¼Œä½†æ˜¯å¯¹äºTomcatå®¹å™¨ä¸å¯â»…ï¼› WebappClassLoaderï¼šå„ä¸ªWebappç§æœ‰çš„ç±»åŠ è½½å™¨ï¼ŒåŠ è½½è·¯å¾„ä¸­çš„classåªå¯¹å½“å‰Webappå¯â»…ï¼Œâ½å¦‚åŠ è½½waråŒ…â¾¥ç›¸å…³çš„ç±»ï¼Œæ¯ä¸ªwaråŒ…åº”â½¤éƒ½æœ‰â¾ƒâ¼°çš„WebappClassLoaderï¼Œå®ç°ç›¸äº’éš”ç¦»ï¼Œâ½å¦‚ä¸åŒwaråŒ…åº”â½¤å¼•â¼Šäº†ä¸åŒçš„springç‰ˆæœ¬ï¼Œè¿™æ ·å®ç°å°±èƒ½åŠ è½½å„â¾ƒçš„springç‰ˆæœ¬ï¼› Jspç±»åŠ è½½å™¨ï¼šé’ˆå¯¹æ¯ä¸ªJSPâ»šâ¾¯åˆ›å»ºâ¼€ä¸ªåŠ è½½å™¨ã€‚è¿™ä¸ªåŠ è½½å™¨â½è¾ƒè½»é‡çº§ï¼Œæ‰€ä»¥Tomcatè¿˜å®ç°äº†çƒ­åŠ è½½ï¼Œä¹Ÿå°±æ˜¯JSPåªè¦ä¿®æ”¹äº†ï¼Œå°±åˆ›å»ºâ¼€ä¸ªæ–°çš„åŠ è½½å™¨ï¼Œä»â½½å®ç°äº†JSPâ»šâ¾¯çš„çƒ­æ›´æ–°ã€‚","summary":"æ‘˜è¦ æœ¬æ–‡ä»‹ç»JVMçš„ç±»åŠ è½½å™¨ JDK8 The JavaÂ® Virtual Machine Specification JDK8çš„javaæŒ‡ä»¤çš„å®˜â½…â½‚æ¡£ JDKâ¼¯å…·å®˜â½¹â½‚æ¡£ JDK17çš„javaæŒ‡ä»¤çš„å®˜â½…â½‚æ¡£","date_published":"2025-05-08T13:30:05.000Z","tags":["æŠ€æœ¯","jvm","jvm"]},{"id":"https://blog.hanqunfeng.com/2025/04/22/elasticsearch-06-api-aggs/","url":"https://blog.hanqunfeng.com/2025/04/22/elasticsearch-06-api-aggs/","title":"Elasticsearch çš„ REST APIs:èšåˆæŸ¥è¯¢","content_html":"<!--\n **åŠ ç²—**\n *æ–œä½“*\n ***åŠ ç²—å¹¶æ–œä½“***\n ~~åˆ é™¤çº¿~~\n ==çªå‡ºæ˜¾ç¤º==\n `çªå‡ºæ˜¾ç¤º(æ¨è)`\n ++ä¸‹åˆ’çº¿++\n ~ä¸‹æ ‡~\n ^ä¸Šæ ‡^\n è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference.\n å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)\n\n +++ **ç‚¹å‡»æŠ˜å **\n è¿™æ˜¯è¢«éšè—çš„å†…å®¹\n +++\n\n::: tips success warning danger\nè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹\n:::\n\n% note info % success warning danger\nè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹\n% endnote %\n\nå¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{}\n å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ\n -->\n<h2 id=\"æ‘˜è¦\">æ‘˜è¦</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æœ¬æ–‡ä»‹ç» Elasticsearch çš„ REST APIsï¼šèšåˆæŸ¥è¯¢</p>\n</li>\n<li class=\"lvl-2\">\n<p>Elasticsearchç‰ˆæœ¬8.17.3</p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/8.17/rest-apis.html\">å®˜æ–¹æ–‡æ¡£:REST APIs</a></p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/8.17/search-aggregations.html\">å®˜æ–¹æ–‡æ¡£:Aggregations</a></p>\n</li>\n<li class=\"lvl-2\">\n<a href=\"/2025/04/17/elasticsearch-05-api/\" title=\"Elasticsearch çš„ REST APIs\">Elasticsearch çš„ REST APIs</a>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"èšåˆæŸ¥è¯¢\">èšåˆæŸ¥è¯¢</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations.html\">èšåˆæŸ¥è¯¢</a>ï¼Œå¯ä»¥è®©æˆ‘ä»¬æå…¶æ–¹ä¾¿çš„å®ç°å¯¹ç´¢å¼•æ•°æ®çš„ç»Ÿè®¡ã€åˆ†æã€è¿ç®—ç­‰æ“ä½œã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>åŸºæœ¬è¯­æ³•åŒ…æ‹¬ä»¥ä¸‹éƒ¨åˆ†ï¼š</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-4\">æŸ¥è¯¢æ¡ä»¶ï¼šæŒ‡å®šéœ€è¦èšåˆçš„æ–‡æ¡£ï¼Œå¯ä»¥ä½¿ç”¨æ ‡å‡†çš„ Elasticsearch æŸ¥è¯¢è¯­æ³•ï¼Œå¦‚ termã€matchã€range ç­‰ç­‰ã€‚</li>\n<li class=\"lvl-4\">èšåˆå‡½æ•°ï¼šæŒ‡å®šè¦æ‰§è¡Œçš„èšåˆæ“ä½œï¼Œå¦‚ sumã€avgã€minã€maxã€termsã€date_histogram ç­‰ç­‰ã€‚æ¯ä¸ªèšåˆå‘½ä»¤éƒ½ä¼šç”Ÿæˆä¸€ä¸ªèšåˆç»“æœã€‚</li>\n<li class=\"lvl-4\">èšåˆåµŒå¥—ï¼šèšåˆå‘½ä»¤å¯ä»¥åµŒå¥—ï¼Œä»¥ä¾¿æ›´ç»†ç²’åº¦åœ°åˆ†ææ•°æ®ã€‚</li>\n</ul>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET &lt;index_name&gt;/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;&lt;aggs_name&gt;&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;&lt;agg_type&gt;&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;&lt;field_name&gt;&quot;</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\"># è¯´æ˜</span></span><br><span class=\"line\">  <span class=\"comment\"># aggsï¼šèšåˆçš„æ ¹èŠ‚ç‚¹ï¼Œå›ºå®šå†™æ³•</span></span><br><span class=\"line\">  <span class=\"comment\"># aggs_nameï¼šèšåˆå‡½æ•°çš„åç§°ï¼Œè‡ªå·±éšæ„å®šä¹‰</span></span><br><span class=\"line\">  <span class=\"comment\"># agg_typeï¼šèšåˆç§ç±»ï¼Œæ¯”å¦‚æ˜¯æ¡¶èšåˆï¼ˆtermsï¼‰æˆ–è€…æ˜¯æŒ‡æ ‡èšåˆï¼ˆavgã€sumã€minã€maxç­‰ï¼‰</span></span><br><span class=\"line\">  <span class=\"comment\"># field_nameï¼šå­—æ®µåç§°æˆ–è€…å«åŸŸåã€‚</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>èšåˆçš„åˆ†ç±»</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-4\">Metric Aggregationï¼šâ€”äº›æ•°å­¦è¿ç®—ï¼Œå¯ä»¥å¯¹æ–‡æ¡£å­—æ®µè¿›è¡Œç»Ÿè®¡åˆ†æï¼Œç±»æ¯”Mysqlä¸­çš„ min(), max(), sum() æ“ä½œã€‚</li>\n<li class=\"lvl-4\">Bucket Aggregationï¼šä¸€äº›æ»¡è¶³ç‰¹å®šæ¡ä»¶çš„æ–‡æ¡£çš„é›†åˆæ”¾ç½®åˆ°ä¸€ä¸ªæ¡¶é‡Œï¼Œæ¯ä¸€ä¸ªæ¡¶å…³è”ä¸€ä¸ªkeyï¼Œç±»æ¯”Mysqlä¸­çš„group byæ“ä½œã€‚</li>\n<li class=\"lvl-4\">Pipeline Aggregationï¼šå¯¹å…¶ä»–çš„èšåˆç»“æœè¿›è¡ŒäºŒæ¬¡èšåˆ</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"ç¤ºä¾‹æ•°æ®å‡†å¤‡\">ç¤ºä¾‹æ•°æ®å‡†å¤‡</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æˆ‘ä»¬éœ€è¦å…ˆå‡†å¤‡ä¸€äº›æ•°æ®ï¼Œæ‰èƒ½è¿›è¡Œèšåˆåˆ†æã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>åˆ›å»ºç´¢å¼•</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># å¦‚æœå­˜åœ¨å…ˆåˆ é™¤</span></span><br><span class=\"line\">curl -X DELETE -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># åˆ›å»ºç´¢å¼•</span></span><br><span class=\"line\">curl -X PUT -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;settings&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;number_of_shards&quot;:&quot;1&quot;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;number_of_replicas&quot;:&quot;2&quot;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;mappings&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;properties&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;category&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">          &quot;type&quot;:&quot;keyword&quot;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;price&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">          &quot;type&quot;:&quot;double&quot;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;count&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">          &quot;type&quot;:&quot;integer&quot;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;title&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">          &quot;type&quot;:&quot;text&quot;,</span></span><br><span class=\"line\"><span class=\"string\">          &quot;analyzer&quot;:&quot;ik_max_word&quot;,</span></span><br><span class=\"line\"><span class=\"string\">          &quot;search_analyzer&quot;:&quot;ik_smart&quot;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;remark&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;type&quot;:&quot;text&quot;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;analyzer&quot;:&quot;ik_max_word&quot;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;search_analyzer&quot;:&quot;ik_smart&quot;</span></span><br><span class=\"line\"><span class=\"string\">      &#125;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;address&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;type&quot;: &quot;text&quot;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;analyzer&quot;: &quot;ik_max_word&quot;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;fields&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">          &quot;keyword&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">            &quot;type&quot;: &quot;keyword&quot;</span></span><br><span class=\"line\"><span class=\"string\">          &#125;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;</span></span><br><span class=\"line\"><span class=\"string\">      &#125;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;tags&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;type&quot;: &quot;keyword&quot;</span></span><br><span class=\"line\"><span class=\"string\">      &#125;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;created_at&quot;: &#123;&quot;type&quot;: &quot;date&quot;, &quot;format&quot;: &quot;yyyy-MM-dd HH:mm:ss&quot;&#125;</span></span><br><span class=\"line\"><span class=\"string\">      &#125;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">  &#125;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æ’å…¥æ•°æ®</span></span><br><span class=\"line\">curl -X POST -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/_bulk&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123; &quot;index&quot;: &#123; &quot;_index&quot;: &quot;shopping&quot;, &quot;_id&quot;: &quot;1&quot; &#125; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;category&quot;: &quot;electronics&quot;, &quot;price&quot;: 999.99, &quot;count&quot;: 10, &quot;title&quot;: &quot;Smartphone X - 128GB&quot;, &quot;remark&quot;: &quot;This latest Smartphone X comes with a powerful processor and high-resolution camera.&quot;, &quot;address&quot;: &quot;å¹¿å·å¤©æ²³å…¬å›­&quot;, &quot;tags&quot;: [&quot;latest&quot;, &quot;smartphone&quot;, &quot;technology&quot;], &quot;created_at&quot;: &quot;2025-04-22 03:30:02&quot; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;index&quot;: &#123; &quot;_index&quot;: &quot;shopping&quot;, &quot;_id&quot;: &quot;2&quot; &#125; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;category&quot;: &quot;fashion&quot;, &quot;price&quot;: 49.99, &quot;count&quot;: 25, &quot;title&quot;: &quot;Designer T-shirt&quot;, &quot;remark&quot;: &quot;Trendy designer T-shirt made with high quality fabric.&quot;, &quot;address&quot;: &quot;å¹¿å·è”æ¹¾å¤§å¦&quot;, &quot;tags&quot;: [&quot;clothing&quot;, &quot;designer&quot;, &quot;style&quot;], &quot;created_at&quot;: &quot;2025-04-21 12:15:00&quot; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;index&quot;: &#123; &quot;_index&quot;: &quot;shopping&quot;, &quot;_id&quot;: &quot;3&quot; &#125; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;category&quot;: &quot;home_appliances&quot;, &quot;price&quot;: 299.99, &quot;count&quot;: 5, &quot;title&quot;: &quot;Robot Vacuum Cleaner&quot;, &quot;remark&quot;: &quot;Efficient robot vacuum cleaner with smart navigation.&quot;, &quot;address&quot;: &quot;å¹¿å·ç™½äº‘å±±å…¬å›­&quot;, &quot;tags&quot;: [&quot;appliances&quot;, &quot;vacuum&quot;, &quot;robot&quot;], &quot;created_at&quot;: &quot;2025-04-20 08:45:30&quot; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;index&quot;: &#123; &quot;_index&quot;: &quot;shopping&quot;, &quot;_id&quot;: &quot;4&quot; &#125; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;category&quot;: &quot;books&quot;, &quot;price&quot;: 19.99, &quot;count&quot;: 100, &quot;title&quot;: &quot;Inspirational Novel&quot;, &quot;remark&quot;: &quot;A gripping novel that inspires and motivates.&quot;, &quot;address&quot;: &quot;321 Book Rd, Shenzhen, China&quot;, &quot;tags&quot;: [&quot;book&quot;, &quot;novel&quot;, &quot;inspiration&quot;], &quot;created_at&quot;: &quot;2025-04-19 10:05:00&quot; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;index&quot;: &#123; &quot;_index&quot;: &quot;shopping&quot;, &quot;_id&quot;: &quot;5&quot; &#125; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;category&quot;: &quot;groceries&quot;, &quot;price&quot;: 3.99, &quot;count&quot;: 200, &quot;title&quot;: &quot;Organic Apples&quot;, &quot;remark&quot;: &quot;Fresh and crispy organic apples.&quot;, &quot;address&quot;: &quot;654 Grocery Ln, Chengdu, China&quot;, &quot;tags&quot;: [&quot;fruit&quot;, &quot;organic&quot;, &quot;healthy&quot;], &quot;created_at&quot;: &quot;2025-04-18 14:30:45&quot; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;index&quot;: &#123; &quot;_index&quot;: &quot;shopping&quot;, &quot;_id&quot;: &quot;6&quot; &#125; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;category&quot;: &quot;electronics&quot;, &quot;price&quot;: 1999.99, &quot;count&quot;: 15, &quot;title&quot;: &quot;Smartphone X - 256GB&quot;, &quot;remark&quot;: &quot;This latest Smartphone X comes with a powerful processor and high-resolution camera.&quot;, &quot;address&quot;: &quot;å¹¿å·å¤©æ²³å…¬å›­&quot;, &quot;tags&quot;: [&quot;latest&quot;, &quot;smartphone&quot;, &quot;technology&quot;], &quot;created_at&quot;: &quot;2025-04-22 03:30:02&quot; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#x27;</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"Metric-Aggregation-æŒ‡æ ‡èšåˆ\">Metric Aggregation(æŒ‡æ ‡èšåˆ)</h2>\n<h3 id=\"å•å€¼åˆ†æï¸°åªè¾“å‡ºä¸€ä¸ªåˆ†æç»“æœ\">å•å€¼åˆ†æï¸°åªè¾“å‡ºä¸€ä¸ªåˆ†æç»“æœ</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>min, max, avg, sum</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># æœ€å¤§å€¼ã€æœ€å°å€¼ã€å¹³å‡å€¼ã€æ€»å’Œ</span></span><br><span class=\"line\">GET /shopping/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;size&quot;</span>: 0,  <span class=\"comment\"># ä¸è¿”å›æ–‡æ¡£ï¼Œåªè¿”å›èšåˆç»“æœ</span></span><br><span class=\"line\">  <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;max_price&quot;</span>: &#123; <span class=\"comment\"># è‡ªå®šä¹‰åç§°ï¼Œè¿™é‡Œè¿”å›æœ€å¤§å€¼</span></span><br><span class=\"line\">      <span class=\"string\">&quot;max&quot;</span>: &#123;     <span class=\"comment\"># æŒ‡æ ‡èšåˆå‡½æ•°åç§°</span></span><br><span class=\"line\">        <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;price&quot;</span> <span class=\"comment\"># æŒ‡æ ‡èšåˆå­—æ®µ</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">&quot;min_price&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;min&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;price&quot;</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">&quot;avg_price&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;avg&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;price&quot;</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">&quot;sum_price&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;sum&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;price&quot;</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Cardinalityï¼ˆç±»ä¼¼distinct Count)</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /shopping/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;size&quot;</span>: 0, <span class=\"comment\"># ä¸è¿”å›æ–‡æ¡£ï¼Œåªè¿”å›èšåˆç»“æœ</span></span><br><span class=\"line\">  <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;cardinality_count&quot;</span>: &#123; <span class=\"comment\"># è‡ªå®šä¹‰åç§°ï¼Œè¿”å›å»é‡åçš„æ•°é‡</span></span><br><span class=\"line\">      <span class=\"string\">&quot;cardinality&quot;</span>: &#123;  <span class=\"comment\"># æŒ‡æ ‡èšåˆå‡½æ•°åç§°ï¼Œcardinalityè¡¨ç¤ºå»é‡</span></span><br><span class=\"line\">        <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;category&quot;</span> <span class=\"comment\"># æŒ‡æ ‡èšåˆå­—æ®µï¼Œå»é‡çš„å­—æ®µ</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"å¤šå€¼åˆ†æ-è¾“å‡ºå¤šä¸ªåˆ†æç»“æœ\">å¤šå€¼åˆ†æ:è¾“å‡ºå¤šä¸ªåˆ†æç»“æœ</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>statsï¼ˆç»Ÿè®¡ï¼‰, extended stats</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /shopping/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;size&quot;</span>: 0,</span><br><span class=\"line\">  <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;stats_price&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;stats&quot;</span>: &#123; <span class=\"comment\"># æŒ‡æ ‡èšåˆå‡½æ•°åç§°ï¼Œstatsè¡¨ç¤ºç»Ÿè®¡ï¼Œä¼šè¿”å›å¤šä¸ªæŒ‡æ ‡</span></span><br><span class=\"line\">        <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;price&quot;</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\"># ç»“æœ</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;took&quot;</span>: 15,</span><br><span class=\"line\">  <span class=\"string\">&quot;timed_out&quot;</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;_shards&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;total&quot;</span>: 1,</span><br><span class=\"line\">    <span class=\"string\">&quot;successful&quot;</span>: 1,</span><br><span class=\"line\">    <span class=\"string\">&quot;skipped&quot;</span>: 0,</span><br><span class=\"line\">    <span class=\"string\">&quot;failed&quot;</span>: 0</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;hits&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;total&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;value&quot;</span>: 12,</span><br><span class=\"line\">      <span class=\"string\">&quot;relation&quot;</span>: <span class=\"string\">&quot;eq&quot;</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">&quot;max_score&quot;</span>: null,</span><br><span class=\"line\">    <span class=\"string\">&quot;hits&quot;</span>: []     <span class=\"comment\"># å› ä¸ºè®¾ç½®size ä¸º 0ï¼Œæ‰€ä»¥è¿”å›çš„ç»“æœä¸ºç©º</span></span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;aggregations&quot;</span>: &#123; <span class=\"comment\"># èšåˆç»“æœ</span></span><br><span class=\"line\">    <span class=\"string\">&quot;stats_price&quot;</span>: &#123; <span class=\"comment\"># è‡ªå®šä¹‰åç§°ï¼Œè¿”å›å¤šç»„èšåˆç»“æœ</span></span><br><span class=\"line\">      <span class=\"string\">&quot;count&quot;</span>: 12,</span><br><span class=\"line\">      <span class=\"string\">&quot;min&quot;</span>: 3.99,</span><br><span class=\"line\">      <span class=\"string\">&quot;max&quot;</span>: 1999.99,</span><br><span class=\"line\">      <span class=\"string\">&quot;avg&quot;</span>: 562.1666666666666,</span><br><span class=\"line\">      <span class=\"string\">&quot;sum&quot;</span>: 6746</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>percentile ï¼ˆç™¾åˆ†ä½ï¼‰, percentile rank</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /shopping/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;size&quot;</span>: 0,</span><br><span class=\"line\">  <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;percentile_price&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;percentiles&quot;</span>: &#123; <span class=\"comment\"># æŒ‡æ ‡èšåˆå‡½æ•°åç§°ï¼Œpercentilesè¡¨ç¤ºç™¾åˆ†ä½æ•°èšåˆè®¡ç®—</span></span><br><span class=\"line\">        <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;price&quot;</span>, <span class=\"comment\"># æŒ‡æ ‡èšåˆå­—æ®µ</span></span><br><span class=\"line\">        <span class=\"string\">&quot;percents&quot;</span>: [1, 5, 25, 50, 75, 95, 99] <span class=\"comment\"># éœ€è¦è®¡ç®—ç™¾åˆ†ä½æ•°çš„æ•°ç»„</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\"># ç™¾åˆ†ä½æ•°æ˜¯ä¸€ä¸ªç»Ÿè®¡å­¦æ¦‚å¿µï¼Œç”¨äºæè¿°ä¸€ä¸ªç»™å®šé›†åˆçš„æ’åºå€¼ã€‚ä¾‹å¦‚ï¼š</span></span><br><span class=\"line\"><span class=\"comment\"># ç¬¬ 1 ç™¾åˆ†ä½æ•°è¡¨ç¤ºæ•°æ®ä¸­å°äºè¿™ä¸ªå€¼çš„æ‰€æœ‰æ•°æ®å æ€»æ•°çš„ 1%ã€‚</span></span><br><span class=\"line\"><span class=\"comment\"># ç¬¬ 50 ç™¾åˆ†ä½æ•°ï¼ˆä¸­ä½æ•°ï¼‰è¡¨ç¤ºæ•°æ®ä¸­çš„ä¸€åŠå°äºè¿™ä¸ªå€¼ï¼Œå¦ä¸€åŠå¤§äºè¿™ä¸ªå€¼ã€‚</span></span><br><span class=\"line\"><span class=\"comment\"># ç¬¬ 99 ç™¾åˆ†ä½æ•°è¡¨ç¤ºæ•°æ®ä¸­å°äºè¿™ä¸ªå€¼çš„æ‰€æœ‰æ•°æ®å æ€»æ•°çš„ 99%ã€‚</span></span><br><span class=\"line\"><span class=\"comment\"># é€šè¿‡è®¡ç®—è¿™äº›ç™¾åˆ†ä½æ•°ï¼Œä½ å¯ä»¥äº†è§£ price å­—æ®µåœ¨æ•´ä¸ªshoppingç´¢å¼•ä¸­çš„åˆ†å¸ƒæƒ…å†µï¼Œä»è€Œå¯ä»¥ç”¨äºæ•°æ®åˆ†æã€è¶‹åŠ¿åˆ¤æ–­ç­‰ã€‚</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>top hits(æ’åœ¨å‰é¢çš„ç¤ºä¾‹)</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /shopping/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;size&quot;</span>: 0,</span><br><span class=\"line\">  <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;top_hits&quot;</span>: &#123; <span class=\"comment\"># è‡ªå®šä¹‰åç§°ï¼Œè¿”å›æ’åœ¨å‰é¢çš„ç¤ºä¾‹</span></span><br><span class=\"line\">      <span class=\"string\">&quot;top_hits&quot;</span>: &#123; <span class=\"comment\"># æŒ‡æ ‡èšåˆå‡½æ•°åç§°ï¼Œtop_hitsè¡¨ç¤ºè¿”å›æ’åœ¨å‰é¢çš„ç¤ºä¾‹</span></span><br><span class=\"line\">        <span class=\"string\">&quot;sort&quot;</span>: [&#123;<span class=\"string\">&quot;price&quot;</span>: &#123;<span class=\"string\">&quot;order&quot;</span>: <span class=\"string\">&quot;desc&quot;</span>&#125;&#125;], <span class=\"comment\"># æ’åºï¼ŒæŒ‰ç…§priceå­—æ®µé™åºæ’åº</span></span><br><span class=\"line\">        <span class=\"string\">&quot;size&quot;</span>: 3 <span class=\"comment\"># åªè¿”å›å‰3ä¸ª</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"Bucket-Aggregation-æ¡¶èšåˆ\">Bucket Aggregation(æ¡¶èšåˆ)</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æŒ‰ç…§ä¸€å®šçš„è§„åˆ™ï¼Œå°†æ–‡æ¡£åˆ†é…åˆ°ä¸åŒçš„æ¡¶ä¸­ï¼Œä»è€Œè¾¾åˆ°åˆ†ç±»çš„ç›®çš„ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>ESæä¾›çš„ä¸€äº›å¸¸è§çš„ Bucket Aggregationã€‚</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-4\">termsï¼ˆè¯æ¡ï¼‰, rangeï¼ˆèŒƒå›´ï¼‰, date_rangeï¼ˆæ—¥æœŸèŒƒå›´ï¼‰, ip_rangeï¼ˆIPèŒƒå›´ï¼‰, missingï¼ˆç¼ºå¤±ï¼‰, histogramï¼ˆç›´æ–¹å›¾ï¼‰, date_histogramï¼ˆæ—¥æœŸç›´æ–¹å›¾ï¼‰, geo_distanceï¼ˆåœ°ç†è·ç¦»ï¼‰, significant_termsï¼ˆé‡è¦è¯æ¡ï¼‰, compositeï¼ˆç»„åˆï¼‰</li>\n</ul>\n</li>\n<li class=\"lvl-2\">\n<p>æ¡¶èšåˆå¯ä»¥ç”¨äºå„ç§åœºæ™¯ï¼Œä¾‹å¦‚ï¼š</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-4\">å¯¹æ•°æ®è¿›è¡Œåˆ†ç»„ç»Ÿè®¡ï¼Œæ¯”å¦‚æŒ‰ç…§åœ°åŒºã€å¹´é¾„æ®µã€æ€§åˆ«ç­‰å­—æ®µè¿›è¡Œåˆ†ç»„ç»Ÿè®¡ã€‚</li>\n<li class=\"lvl-4\">å¯¹æ—¶é—´åºåˆ—æ•°æ®è¿›è¡Œæ—¶é—´æ®µåˆ†æï¼Œæ¯”å¦‚æŒ‰ç…§æ¯å°æ—¶ã€æ¯å¤©ã€æ¯æœˆã€æ¯å­£åº¦ã€æ¯å¹´ç­‰æ—¶é—´æ®µè¿›è¡Œåˆ†æã€‚</li>\n<li class=\"lvl-4\">å¯¹å„ç§æ ‡ç­¾ä¿¡æ¯åˆ†ç±»ï¼Œå¹¶ç»Ÿè®¡å…¶æ•°é‡ã€‚</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"termsï¼ˆè¯æ¡ï¼‰\">termsï¼ˆè¯æ¡ï¼‰</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æŒ‰ç…§å­—æ®µçš„å€¼è¿›è¡Œåˆ†ç»„ï¼Œå¹¶ç»Ÿè®¡æ¯ä¸ªç»„çš„æ•°é‡ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>ç¤ºä¾‹ï¼šæŒ‰ç…§categoryå­—æ®µè¿›è¡Œåˆ†ç»„ï¼Œå¹¶ç»Ÿè®¡æ¯ä¸ªç»„çš„æ•°é‡ã€‚</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /shopping/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;size&quot;</span>: 0,</span><br><span class=\"line\">  <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;category_count&quot;</span>: &#123; <span class=\"comment\"># è‡ªå®šä¹‰åç§°ï¼Œè¿”å›æ¯ä¸ªç»„çš„æ•°é‡</span></span><br><span class=\"line\">      <span class=\"string\">&quot;terms&quot;</span>: &#123; <span class=\"comment\"># æ¡¶èšåˆå‡½æ•°åç§°ï¼Œtermsè¡¨ç¤ºæŒ‰ç…§å­—æ®µçš„å€¼è¿›è¡Œåˆ†ç»„</span></span><br><span class=\"line\">        <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;category&quot;</span>, <span class=\"comment\"># æŒ‰ç…§categoryå­—æ®µè¿›è¡Œåˆ†ç»„ï¼Œæ³¨æ„ä¸èƒ½æ˜¯textç±»å‹ï¼Œå¦åˆ™ä¼šæŠ¥é”™</span></span><br><span class=\"line\">        <span class=\"string\">&quot;size&quot;</span>: 10, <span class=\"comment\"># åªè¿”å›å‰10ä¸ªï¼Œé»˜è®¤æ˜¯10</span></span><br><span class=\"line\">        <span class=\"string\">&quot;order&quot;</span>: &#123;<span class=\"string\">&quot;_count&quot;</span>: <span class=\"string\">&quot;desc&quot;</span>&#125; <span class=\"comment\"># æŒ‰ç…§æ•°é‡é™åºæ’åºï¼Œé»˜è®¤æ˜¯descï¼ŒBucketèšåˆä¼šç»Ÿè®¡Bucketå†…çš„æ–‡æ¡£æ•°é‡ï¼Œè®°ä¸º_countï¼Œå¹¶ä¸”æŒ‰ç…§_counté™åºæ’åº</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ç»“æœ</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;took&quot;</span>: 15,</span><br><span class=\"line\">  <span class=\"string\">&quot;timed_out&quot;</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;_shards&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;total&quot;</span>: 1,</span><br><span class=\"line\">    <span class=\"string\">&quot;successful&quot;</span>: 1,</span><br><span class=\"line\">    <span class=\"string\">&quot;skipped&quot;</span>: 0,</span><br><span class=\"line\">    <span class=\"string\">&quot;failed&quot;</span>: 0</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;hits&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;total&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;value&quot;</span>: 12,</span><br><span class=\"line\">      <span class=\"string\">&quot;relation&quot;</span>: <span class=\"string\">&quot;eq&quot;</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">&quot;max_score&quot;</span>: null,</span><br><span class=\"line\">    <span class=\"string\">&quot;hits&quot;</span>: []</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;aggregations&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;category_count&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;doc_count_error_upper_bound&quot;</span>: 0,  <span class=\"comment\"># é”™è¯¯ä¸Šç•Œï¼Œè¡¨ç¤ºåœ¨èšåˆè¿‡ç¨‹ä¸­å¯èƒ½å­˜åœ¨ä¸€äº›é”™è¯¯ï¼Œä½†é”™è¯¯æ•°é‡ä¸ä¼šè¶…è¿‡è¿™ä¸ªå€¼</span></span><br><span class=\"line\">      <span class=\"string\">&quot;sum_other_doc_count&quot;</span>: 0,         <span class=\"comment\"># è¡¨ç¤ºåœ¨èšåˆè¿‡ç¨‹ä¸­ï¼Œé™¤äº†è¿”å›çš„10ä¸ªbucketï¼Œè¿˜æœ‰å…¶ä»–æ•°é‡ï¼Œè¿™ä¸ªæ•°é‡å°±æ˜¯sum_other_doc_count</span></span><br><span class=\"line\">      <span class=\"string\">&quot;buckets&quot;</span>: [                     <span class=\"comment\"># è¿”å›çš„bucket</span></span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;key&quot;</span>: <span class=\"string\">&quot;electronics&quot;</span>,          <span class=\"comment\"># åˆ†ç»„çš„key</span></span><br><span class=\"line\">          <span class=\"string\">&quot;doc_count&quot;</span>: 4                 <span class=\"comment\"># åˆ†ç»„çš„æ•°é‡</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;key&quot;</span>: <span class=\"string\">&quot;books&quot;</span>,</span><br><span class=\"line\">          <span class=\"string\">&quot;doc_count&quot;</span>: 2</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;key&quot;</span>: <span class=\"string\">&quot;fashion&quot;</span>,</span><br><span class=\"line\">          <span class=\"string\">&quot;doc_count&quot;</span>: 2</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;key&quot;</span>: <span class=\"string\">&quot;groceries&quot;</span>,</span><br><span class=\"line\">          <span class=\"string\">&quot;doc_count&quot;</span>: 2</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;key&quot;</span>: <span class=\"string\">&quot;home_appliances&quot;</span>,</span><br><span class=\"line\">          <span class=\"string\">&quot;doc_count&quot;</span>: 2</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      ]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>é™å®šèšåˆèŒƒå›´</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /shopping/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;query&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;range&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;price&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;gte&quot;</span>: 100 <span class=\"comment\"># é™å®šä»·æ ¼èŒƒå›´</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;size&quot;</span>: 0,</span><br><span class=\"line\">  <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;category_count&quot;</span>: &#123; <span class=\"comment\"># è‡ªå®šä¹‰åç§°ï¼Œè¿”å›æ¯ä¸ªç»„çš„æ•°é‡</span></span><br><span class=\"line\">      <span class=\"string\">&quot;terms&quot;</span>: &#123; <span class=\"comment\"># æ¡¶èšåˆå‡½æ•°åç§°ï¼Œtermsè¡¨ç¤ºæŒ‰ç…§å­—æ®µçš„å€¼è¿›è¡Œåˆ†ç»„</span></span><br><span class=\"line\">        <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;category&quot;</span>, <span class=\"comment\"># æŒ‰ç…§categoryå­—æ®µè¿›è¡Œåˆ†ç»„</span></span><br><span class=\"line\">        <span class=\"string\">&quot;size&quot;</span>: 10, <span class=\"comment\"># åªè¿”å›å‰10ä¸ªï¼Œé»˜è®¤æ˜¯10</span></span><br><span class=\"line\">        <span class=\"string\">&quot;order&quot;</span>: &#123;<span class=\"string\">&quot;_count&quot;</span>: <span class=\"string\">&quot;desc&quot;</span>&#125; <span class=\"comment\"># æŒ‰ç…§æ•°é‡é™åºæ’åºï¼Œé»˜è®¤æ˜¯descï¼ŒBucketèšåˆä¼šç»Ÿè®¡Bucketå†…çš„æ–‡æ¡£æ•°é‡ï¼Œè®°ä¸º_countï¼Œå¹¶ä¸”æŒ‰ç…§_counté™åºæ’åº</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"rangeï¼ˆèŒƒå›´ï¼‰\">rangeï¼ˆèŒƒå›´ï¼‰</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æŒ‰ç…§å­—æ®µçš„å€¼è¿›è¡Œåˆ†ç»„ï¼Œå¹¶ç»Ÿè®¡æ¯ä¸ªç»„çš„æ•°é‡ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>ç¤ºä¾‹ï¼šæŒ‰ç…§ä»·æ ¼èŒƒå›´è¿›è¡Œåˆ†ç»„ï¼Œå¹¶ç»Ÿè®¡æ¯ä¸ªç»„çš„æ•°é‡ã€‚</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /shopping/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;size&quot;</span>: 0,</span><br><span class=\"line\">  <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;price_range&quot;</span>: &#123; <span class=\"comment\"># è‡ªå®šä¹‰åç§°ï¼Œè¿”å›æ¯ä¸ªç»„çš„æ•°é‡</span></span><br><span class=\"line\">      <span class=\"string\">&quot;range&quot;</span>: &#123; <span class=\"comment\"># æ¡¶èšåˆå‡½æ•°åç§°ï¼Œrangeè¡¨ç¤ºæŒ‰ç…§å­—æ®µçš„å€¼è¿›è¡Œåˆ†ç»„</span></span><br><span class=\"line\">        <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;price&quot;</span>, <span class=\"comment\"># æŒ‰ç…§priceå­—æ®µè¿›è¡Œåˆ†ç»„</span></span><br><span class=\"line\">        <span class=\"string\">&quot;ranges&quot;</span>: [</span><br><span class=\"line\">          &#123;<span class=\"string\">&quot;to&quot;</span>: 100&#125;, <span class=\"comment\"># å°äº100</span></span><br><span class=\"line\">          &#123;<span class=\"string\">&quot;from&quot;</span>: 100, <span class=\"string\">&quot;to&quot;</span>: 200&#125;, <span class=\"comment\"># 100-200ï¼ŒåŒ…æ‹¬100ï¼Œä¸åŒ…æ‹¬200</span></span><br><span class=\"line\">          &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;key&quot;</span>:<span class=\"string\">&quot;&gt;=200&quot;</span>, <span class=\"comment\"># è®¾å®šé”®å€¼ï¼Œç”¨äºåŒºåˆ†ä¸åŒèŒƒå›´</span></span><br><span class=\"line\">            <span class=\"string\">&quot;from&quot;</span>:200 <span class=\"comment\"># å¤§äºç­‰äº200</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        ]</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\"># ç»“æœ</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;took&quot;</span>: 5,</span><br><span class=\"line\">  <span class=\"string\">&quot;timed_out&quot;</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;_shards&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;total&quot;</span>: 1,</span><br><span class=\"line\">    <span class=\"string\">&quot;successful&quot;</span>: 1,</span><br><span class=\"line\">    <span class=\"string\">&quot;skipped&quot;</span>: 0,</span><br><span class=\"line\">    <span class=\"string\">&quot;failed&quot;</span>: 0</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;hits&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;total&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;value&quot;</span>: 12,</span><br><span class=\"line\">      <span class=\"string\">&quot;relation&quot;</span>: <span class=\"string\">&quot;eq&quot;</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">&quot;max_score&quot;</span>: null,</span><br><span class=\"line\">    <span class=\"string\">&quot;hits&quot;</span>: []</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;aggregations&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;price_range&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;buckets&quot;</span>: [</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;key&quot;</span>: <span class=\"string\">&quot;*-100.0&quot;</span>,</span><br><span class=\"line\">          <span class=\"string\">&quot;to&quot;</span>: 100,</span><br><span class=\"line\">          <span class=\"string\">&quot;doc_count&quot;</span>: 6</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;key&quot;</span>: <span class=\"string\">&quot;100.0-200.0&quot;</span>,</span><br><span class=\"line\">          <span class=\"string\">&quot;from&quot;</span>: 100,</span><br><span class=\"line\">          <span class=\"string\">&quot;to&quot;</span>: 200,</span><br><span class=\"line\">          <span class=\"string\">&quot;doc_count&quot;</span>: 0</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;key&quot;</span>: <span class=\"string\">&quot;&gt;=200&quot;</span>,</span><br><span class=\"line\">          <span class=\"string\">&quot;from&quot;</span>: 200,</span><br><span class=\"line\">          <span class=\"string\">&quot;doc_count&quot;</span>: 6</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      ]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"date-rangeï¼ˆæ—¥æœŸèŒƒå›´ï¼‰\">date_rangeï¼ˆæ—¥æœŸèŒƒå›´ï¼‰</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æŒ‰ç…§å­—æ®µçš„å€¼è¿›è¡Œåˆ†ç»„ï¼Œå¹¶ç»Ÿè®¡æ¯ä¸ªç»„çš„æ•°é‡ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>ç¤ºä¾‹ï¼šæŒ‰ç…§æ—¥æœŸèŒƒå›´è¿›è¡Œåˆ†ç»„ï¼Œå¹¶ç»Ÿè®¡æ¯ä¸ªç»„çš„æ•°é‡ã€‚</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /shopping/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;size&quot;</span>: 0,</span><br><span class=\"line\">  <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;date_range&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;date_range&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;created_at&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;ranges&quot;</span>: [</span><br><span class=\"line\">          &#123;<span class=\"string\">&quot;to&quot;</span>: <span class=\"string\">&quot;now-3d&quot;</span>&#125;, <span class=\"comment\"># å°äºå½“å‰æ—¶é—´å‡å»3å¤©</span></span><br><span class=\"line\">          &#123;<span class=\"string\">&quot;from&quot;</span>: <span class=\"string\">&quot;now-3d&quot;</span>,<span class=\"string\">&quot;to&quot;</span>: <span class=\"string\">&quot;now-1d&quot;</span>&#125;, <span class=\"comment\"># å¤§äºå½“å‰æ—¶é—´å‡å»3å¤©ï¼ˆåŒ…å«ï¼‰ï¼Œå°äºå½“å‰æ—¶é—´å‡å»1å¤©</span></span><br><span class=\"line\">          &#123;<span class=\"string\">&quot;key&quot;</span>:<span class=\"string\">&quot;now-1d&quot;</span>,<span class=\"string\">&quot;from&quot;</span>: <span class=\"string\">&quot;now-1d&quot;</span>&#125; <span class=\"comment\"># å¤§äºå½“å‰æ—¶é—´å‡å»1å¤©ï¼ˆåŒ…å«ï¼‰ï¼Œå¹¶è®¾ç½®é”®å€¼</span></span><br><span class=\"line\">        ]</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\"># ç»“æœ</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;took&quot;</span>: 3,</span><br><span class=\"line\">  <span class=\"string\">&quot;timed_out&quot;</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;_shards&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;total&quot;</span>: 1,</span><br><span class=\"line\">    <span class=\"string\">&quot;successful&quot;</span>: 1,</span><br><span class=\"line\">    <span class=\"string\">&quot;skipped&quot;</span>: 0,</span><br><span class=\"line\">    <span class=\"string\">&quot;failed&quot;</span>: 0</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;hits&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;total&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;value&quot;</span>: 12,</span><br><span class=\"line\">      <span class=\"string\">&quot;relation&quot;</span>: <span class=\"string\">&quot;eq&quot;</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">&quot;max_score&quot;</span>: null,</span><br><span class=\"line\">    <span class=\"string\">&quot;hits&quot;</span>: []</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;aggregations&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;date_range&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;buckets&quot;</span>: [</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;key&quot;</span>: <span class=\"string\">&quot;*-2025-04-20 03:14:17&quot;</span>,</span><br><span class=\"line\">          <span class=\"string\">&quot;to&quot;</span>: 1745118857610,</span><br><span class=\"line\">          <span class=\"string\">&quot;to_as_string&quot;</span>: <span class=\"string\">&quot;2025-04-20 03:14:17&quot;</span>,</span><br><span class=\"line\">          <span class=\"string\">&quot;doc_count&quot;</span>: 4</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;key&quot;</span>: <span class=\"string\">&quot;2025-04-20 03:14:17-2025-04-22 03:14:17&quot;</span>,</span><br><span class=\"line\">          <span class=\"string\">&quot;from&quot;</span>: 1745118857610,</span><br><span class=\"line\">          <span class=\"string\">&quot;from_as_string&quot;</span>: <span class=\"string\">&quot;2025-04-20 03:14:17&quot;</span>,</span><br><span class=\"line\">          <span class=\"string\">&quot;to&quot;</span>: 1745291657610,</span><br><span class=\"line\">          <span class=\"string\">&quot;to_as_string&quot;</span>: <span class=\"string\">&quot;2025-04-22 03:14:17&quot;</span>,</span><br><span class=\"line\">          <span class=\"string\">&quot;doc_count&quot;</span>: 4</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;key&quot;</span>: <span class=\"string\">&quot;now-1d&quot;</span>,</span><br><span class=\"line\">          <span class=\"string\">&quot;from&quot;</span>: 1745291657610,</span><br><span class=\"line\">          <span class=\"string\">&quot;from_as_string&quot;</span>: <span class=\"string\">&quot;2025-04-22 03:14:17&quot;</span>,</span><br><span class=\"line\">          <span class=\"string\">&quot;doc_count&quot;</span>: 4</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      ]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æ—¥æœŸæ ¼å¼</span></span><br><span class=\"line\">GET /shopping/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;size&quot;</span>: 0,</span><br><span class=\"line\">  <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;date_range&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;date_range&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;created_at&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;ranges&quot;</span>: [</span><br><span class=\"line\">          &#123;<span class=\"string\">&quot;to&quot;</span>: <span class=\"string\">&quot;2025-04-20 00:00:00&quot;</span>&#125;, <span class=\"comment\"># æ³¨æ„è¿™é‡Œçš„æ ¼å¼å¿…é¡»ä¸å­—æ®µæ ¼å¼ä¸€è‡´</span></span><br><span class=\"line\">          &#123;<span class=\"string\">&quot;from&quot;</span>: <span class=\"string\">&quot;2025-04-20 00:00:00&quot;</span>,<span class=\"string\">&quot;to&quot;</span>: <span class=\"string\">&quot;2025-04-22 00:00:00&quot;</span>&#125;,</span><br><span class=\"line\">          &#123;<span class=\"string\">&quot;key&quot;</span>:<span class=\"string\">&quot;2025-04-22 00:00:00&quot;</span>,<span class=\"string\">&quot;from&quot;</span>: <span class=\"string\">&quot;2025-04-22 00:00:00&quot;</span>&#125;</span><br><span class=\"line\">        ]</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"histogramï¼ˆç›´æ–¹å›¾ï¼‰\">histogramï¼ˆç›´æ–¹å›¾ï¼‰</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æŒ‰ç…§é—´éš”è¿›è¡Œåˆ†ç»„ï¼Œå¹¶ç»Ÿè®¡æ¯ä¸ªç»„çš„æ•°é‡ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>ç¤ºä¾‹ï¼šæŒ‰ç…§ä»·æ ¼çš„é—´éš”è¿›è¡Œåˆ†ç»„ï¼Œå¹¶ç»Ÿè®¡æ¯ä¸ªç»„çš„æ•°é‡ã€‚</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /shopping/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;size&quot;</span>: 0,</span><br><span class=\"line\">  <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;price_histogram&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;histogram&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;price&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;interval&quot;</span>: 500, <span class=\"comment\"># é—´éš”500</span></span><br><span class=\"line\">        <span class=\"string\">&quot;extended_bounds&quot;</span>:&#123; <span class=\"comment\"># è®¾ç½®è¾¹ç•Œ</span></span><br><span class=\"line\">          <span class=\"string\">&quot;min&quot;</span>:0, <span class=\"comment\"># æœ€å°å€¼0</span></span><br><span class=\"line\">          <span class=\"string\">&quot;max&quot;</span>:2000 <span class=\"comment\"># æœ€å¤§å€¼2000</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\"># ç»“æœ</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;took&quot;</span>: 2,</span><br><span class=\"line\">  <span class=\"string\">&quot;timed_out&quot;</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;_shards&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;total&quot;</span>: 1,</span><br><span class=\"line\">    <span class=\"string\">&quot;successful&quot;</span>: 1,</span><br><span class=\"line\">    <span class=\"string\">&quot;skipped&quot;</span>: 0,</span><br><span class=\"line\">    <span class=\"string\">&quot;failed&quot;</span>: 0</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;hits&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;total&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;value&quot;</span>: 12,</span><br><span class=\"line\">      <span class=\"string\">&quot;relation&quot;</span>: <span class=\"string\">&quot;eq&quot;</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">&quot;max_score&quot;</span>: null,</span><br><span class=\"line\">    <span class=\"string\">&quot;hits&quot;</span>: []</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;aggregations&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;price_histogram&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;buckets&quot;</span>: [</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;key&quot;</span>: 0,</span><br><span class=\"line\">          <span class=\"string\">&quot;doc_count&quot;</span>: 8</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;key&quot;</span>: 500,</span><br><span class=\"line\">          <span class=\"string\">&quot;doc_count&quot;</span>: 1</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;key&quot;</span>: 1000,</span><br><span class=\"line\">          <span class=\"string\">&quot;doc_count&quot;</span>: 1</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;key&quot;</span>: 1500,</span><br><span class=\"line\">          <span class=\"string\">&quot;doc_count&quot;</span>: 2</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;key&quot;</span>: 2000,</span><br><span class=\"line\">          <span class=\"string\">&quot;doc_count&quot;</span>: 0</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      ]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"top-hitsï¼ˆåˆ†æ¡¶å–å‰Næ¡ï¼‰\">top_hitsï¼ˆåˆ†æ¡¶å–å‰Næ¡ï¼‰</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æŒ‰ç…§å­—æ®µçš„å€¼è¿›è¡Œåˆ†ç»„ï¼Œå¹¶è¿”å›æ¯ä¸ªç»„çš„å‰Næ¡æ•°æ®ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>ç¤ºä¾‹ï¼šæŒ‰ç…§categoryè¿›è¡Œåˆ†ç»„ï¼Œå¹¶è¿”å›æ¯ä¸ªç»„çš„å‰3æ¡æ•°æ®ã€‚</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /shopping/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;size&quot;</span>: 0,</span><br><span class=\"line\">  <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;price_top_hits&quot;</span>: &#123; <span class=\"comment\"># è‡ªå®šä¹‰åç§°</span></span><br><span class=\"line\">      <span class=\"string\">&quot;terms&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;category&quot;</span>  <span class=\"comment\"># æŒ‰ç…§categoryå­—æ®µè¿›è¡Œåˆ†ç»„</span></span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;top_hits&quot;</span>: &#123; <span class=\"comment\"># è‡ªå®šä¹‰åç§°</span></span><br><span class=\"line\">          <span class=\"string\">&quot;top_hits&quot;</span>: &#123; <span class=\"comment\"># è¿”å›æ¯ä¸ªç»„çš„å‰3æ¡æ•°æ®</span></span><br><span class=\"line\">            <span class=\"string\">&quot;size&quot;</span>: 3, <span class=\"comment\"># è¿”å›å‰3æ¡æ•°æ®</span></span><br><span class=\"line\">            <span class=\"string\">&quot;sort&quot;</span>: &#123; <span class=\"comment\"># æŒ‰ç…§created_atå­—æ®µè¿›è¡Œæ’åº</span></span><br><span class=\"line\">              <span class=\"string\">&quot;created_at&quot;</span>: &#123;</span><br><span class=\"line\">                <span class=\"string\">&quot;order&quot;</span>: <span class=\"string\">&quot;desc&quot;</span> <span class=\"comment\"># é™åº</span></span><br><span class=\"line\">              &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"å­èšåˆ\">å­èšåˆ</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å­èšåˆï¼šåœ¨èšåˆå‡½æ•°ä¸­ï¼Œè¿˜å¯ä»¥å†å®šä¹‰ä¸€ä¸ªèšåˆå‡½æ•°ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>ç¤ºä¾‹ï¼šæŒ‰ç…§categoryè¿›è¡Œåˆ†ç»„ï¼Œå¹¶ç»Ÿè®¡ä»·æ ¼ä¿¡æ¯</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /shopping/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;size&quot;</span>: 0,</span><br><span class=\"line\">  <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;category_buckets&quot;</span>: &#123; <span class=\"comment\"># è‡ªå®šä¹‰åç§°</span></span><br><span class=\"line\">      <span class=\"string\">&quot;terms&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;category&quot;</span>  <span class=\"comment\"># æŒ‰ç…§categoryå­—æ®µè¿›è¡Œåˆ†ç»„</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"string\">&quot;aggs&quot;</span>: &#123; <span class=\"comment\"># å®šä¹‰å­èšåˆ</span></span><br><span class=\"line\">        <span class=\"string\">&quot;price_stats&quot;</span>: &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;stats&quot;</span>: &#123; <span class=\"comment\"># ç»Ÿè®¡ä»·æ ¼ä¿¡æ¯</span></span><br><span class=\"line\">            <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;price&quot;</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># å¤šå±‚åµŒå¥—</span></span><br><span class=\"line\"><span class=\"comment\"># å…ˆæŒ‰ç…§categoryè¿›è¡Œåˆ†ç»„ï¼Œå†æŒ‰ç…§addressè¿›è¡Œåˆ†ç»„ï¼Œå¹¶ç»Ÿè®¡ä»·æ ¼ä¿¡æ¯</span></span><br><span class=\"line\">GET /shopping/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;size&quot;</span>:0,</span><br><span class=\"line\">  <span class=\"string\">&quot;aggs&quot;</span>:&#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;category_buckets&quot;</span>:&#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;terms&quot;</span>:&#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;field&quot;</span>:<span class=\"string\">&quot;category&quot;</span></span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      <span class=\"string\">&quot;aggs&quot;</span>:&#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;address_buckets&quot;</span>:&#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;terms&quot;</span>:&#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;field&quot;</span>:<span class=\"string\">&quot;address.keyword&quot;</span></span><br><span class=\"line\">          &#125;,</span><br><span class=\"line\">          <span class=\"string\">&quot;aggs&quot;</span>:&#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;price_stats&quot;</span>:&#123;</span><br><span class=\"line\">              <span class=\"string\">&quot;stats&quot;</span>:&#123;</span><br><span class=\"line\">                <span class=\"string\">&quot;field&quot;</span>:<span class=\"string\">&quot;price&quot;</span></span><br><span class=\"line\">              &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"Pipeline-Aggregation-ç®¡é“èšåˆ\">Pipeline Aggregation(ç®¡é“èšåˆ)</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æ”¯æŒå¯¹èšåˆåˆ†æçš„ç»“æœï¼Œå†æ¬¡è¿›è¡Œèšåˆåˆ†æã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>Pipeline çš„åˆ†æç»“æœä¼šè¾“å‡ºåˆ°åŸç»“æœä¸­ï¼Œæ ¹æ®ä½ç½®çš„ä¸åŒï¼Œåˆ†ä¸ºä¸¤ç±»ï¼š</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-4\">Sibling - ç»“æœå’Œç°æœ‰åˆ†æç»“æœåŒçº§\n<ul class=\"lvl-4\">\n<li class=\"lvl-6\">Maxï¼Œminï¼ŒAvg &amp; Sum Bucket</li>\n<li class=\"lvl-6\">Statsï¼ŒExtended Status Bucket</li>\n<li class=\"lvl-6\">Percentiles Bucket</li>\n</ul>\n</li>\n<li class=\"lvl-4\">Parent -ç»“æœå†…åµŒåˆ°ç°æœ‰çš„èšåˆåˆ†æç»“æœä¹‹ä¸­\n<ul class=\"lvl-4\">\n<li class=\"lvl-6\">Derivative(æ±‚å¯¼)</li>\n<li class=\"lvl-6\">Cumultive Sum(ç´¯è®¡æ±‚å’Œ)</li>\n<li class=\"lvl-6\">Moving Function(ç§»åŠ¨å¹³å‡å€¼)</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"Maxï¼Œminï¼ŒAvg-Sum-Bucket\">Maxï¼Œminï¼ŒAvg &amp; Sum Bucket</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Maxï¼Œminï¼ŒAvg &amp; Sum Bucketï¼šå¯¹èšåˆåˆ†æçš„ç»“æœè¿›è¡Œæœ€å¤§å€¼ã€æœ€å°å€¼ã€å¹³å‡å€¼ã€æ±‚å’Œç­‰æ“ä½œã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>ç¤ºä¾‹ï¼šæŒ‰ç…§categoryè¿›è¡Œåˆ†ç»„æ±‚å‡ºå•†å“çš„å¹³å‡ä»·æ ¼ï¼Œå¹¶æ‰¾å‡ºå¹³å‡ä»·æ ¼æœ€ä½çš„åˆ†ç»„</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /shopping/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;size&quot;</span>:0,</span><br><span class=\"line\">  <span class=\"string\">&quot;aggs&quot;</span>:&#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;category_buckets&quot;</span>:&#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;terms&quot;</span>:&#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;field&quot;</span>:<span class=\"string\">&quot;category&quot;</span> <span class=\"comment\"># æŒ‰ç…§categoryå­—æ®µè¿›è¡Œåˆ†ç»„</span></span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      <span class=\"string\">&quot;aggs&quot;</span>:&#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;price_avg&quot;</span>:&#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;avg&quot;</span>:&#123; <span class=\"comment\"># æ±‚ä»·æ ¼å¹³å‡å€¼</span></span><br><span class=\"line\">            <span class=\"string\">&quot;field&quot;</span>:<span class=\"string\">&quot;price&quot;</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">&quot;min_price_in_category&quot;</span>:&#123; <span class=\"comment\"># æ‰¾å‡ºå¹³å‡ä»·æ ¼æœ€ä½çš„åˆ†ç»„</span></span><br><span class=\"line\">      <span class=\"string\">&quot;min_bucket&quot;</span>:&#123; <span class=\"comment\"># å¯¹èšåˆç»“æœè¿›è¡Œæœ€å°å€¼æ“ä½œ</span></span><br><span class=\"line\">        <span class=\"string\">&quot;buckets_path&quot;</span>:<span class=\"string\">&quot;category_buckets&gt;price_avg&quot;</span> <span class=\"comment\"># æŒ‡å®šè·¯å¾„ï¼Œå¯¹category_bucketsèšåˆç»“æœä¸­çš„price_avgå­—æ®µè¿›è¡Œæœ€å°å€¼æ“ä½œ</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"Statsï¼ŒExtended-Status-Bucket\">Statsï¼ŒExtended Status Bucket</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Statsï¼ŒExtended Status Bucketï¼šå¯¹èšåˆåˆ†æçš„ç»“æœè¿›è¡Œç»Ÿè®¡æ“ä½œï¼ŒåŒ…æ‹¬æœ€å¤§å€¼ã€æœ€å°å€¼ã€å¹³å‡å€¼ã€æ±‚å’Œã€æ•°é‡ç­‰ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>ç¤ºä¾‹ï¼šæŒ‰ç…§categoryè¿›è¡Œåˆ†ç»„æ±‚å‡ºå•†å“çš„å¹³å‡ä»·æ ¼ï¼Œå¹¶å¯¹åˆ†ç»„ç»“æœè¿›è¡Œç»Ÿè®¡æ“ä½œ</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /shopping/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;size&quot;</span>: 0,</span><br><span class=\"line\">  <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;category_buckets&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;terms&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;category&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;size&quot;</span>: 10 <span class=\"comment\"># æŒ‡å®šåˆ†ç»„æ•°é‡</span></span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;avg_price&quot;</span>: &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;avg&quot;</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;price&quot;</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">&quot;stats_price_by_job&quot;</span>:&#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;stats_bucket&quot;</span>: &#123; <span class=\"comment\"># å¯¹èšåˆç»“æœè¿›è¡Œç»Ÿè®¡æ“ä½œ</span></span><br><span class=\"line\">        <span class=\"string\">&quot;buckets_path&quot;</span>: <span class=\"string\">&quot;category_buckets&gt;avg_price&quot;</span> <span class=\"comment\"># æŒ‡å®šè·¯å¾„ï¼Œå¯¹category_bucketsèšåˆç»“æœä¸­çš„avg_priceå­—æ®µè¿›è¡Œç»Ÿè®¡æ“ä½œ</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"Percentiles-Bucket\">Percentiles Bucket</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Percentiles Bucketï¼šå¯¹èšåˆåˆ†æçš„ç»“æœè¿›è¡Œç™¾åˆ†æ¯”æ“ä½œï¼ŒåŒ…æ‹¬ç™¾åˆ†æ¯”ã€ä¸­ä½æ•°ç­‰ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>ç¤ºä¾‹ï¼šæŒ‰ç…§categoryè¿›è¡Œåˆ†ç»„æ±‚å‡ºå•†å“çš„å¹³å‡ä»·æ ¼ï¼Œå¹¶å¯¹åˆ†ç»„ç»“æœè¿›è¡Œç™¾åˆ†æ¯”æ“ä½œ</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /shopping/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;size&quot;</span>: 0,</span><br><span class=\"line\">  <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;category_buckets&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;terms&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;category&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;size&quot;</span>: 10</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;avg_price&quot;</span>: &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;avg&quot;</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;price&quot;</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">&quot;percentiles_price_by_category&quot;</span>:&#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;percentiles_bucket&quot;</span>: &#123; <span class=\"comment\"># å¯¹èšåˆç»“æœè¿›è¡Œç»Ÿè®¡æ“ä½œ</span></span><br><span class=\"line\">        <span class=\"string\">&quot;buckets_path&quot;</span>: <span class=\"string\">&quot;category_buckets&gt;avg_price&quot;</span> <span class=\"comment\"># æŒ‡å®šè·¯å¾„ï¼Œå¯¹category_bucketsèšåˆç»“æœä¸­çš„avg_priceå­—æ®µè¿›è¡Œç»Ÿè®¡æ“ä½œ</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"Cumulative-Sum\">Cumulative Sum</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Cumulative Sumï¼šå¯¹èšåˆåˆ†æçš„ç»“æœè¿›è¡Œç´¯è®¡æ±‚å’Œæ“ä½œã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>ç¤ºä¾‹: æŒ‰ç…§ä»·æ ¼è¿›è¡Œåˆ†ç»„ï¼Œå¹¶ç»Ÿè®¡å¹³å‡ä»·æ ¼ä¿¡æ¯ï¼Œå¯¹åˆ†ç»„ç»“æœè¿›è¡Œç´¯è®¡æ±‚å’Œæ“ä½œã€‚</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /shopping/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;size&quot;</span>: 0,</span><br><span class=\"line\">  <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;price_histogram&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;histogram&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;price&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;interval&quot;</span>: 500, <span class=\"comment\"># é—´éš”500</span></span><br><span class=\"line\">        <span class=\"string\">&quot;extended_bounds&quot;</span>:&#123; <span class=\"comment\"># è®¾ç½®è¾¹ç•Œ</span></span><br><span class=\"line\">          <span class=\"string\">&quot;min&quot;</span>:0, <span class=\"comment\"># æœ€å°å€¼0</span></span><br><span class=\"line\">          <span class=\"string\">&quot;max&quot;</span>:2000 <span class=\"comment\"># æœ€å¤§å€¼2000</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;avg_price&quot;</span>: &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;avg&quot;</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;price&quot;</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;cumulative_sum_price&quot;</span>: &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;cumulative_sum&quot;</span>: &#123; <span class=\"comment\"># å¯¹èšåˆç»“æœè¿›è¡Œç´¯è®¡æ±‚å’Œæ“ä½œ</span></span><br><span class=\"line\">            <span class=\"string\">&quot;buckets_path&quot;</span>: <span class=\"string\">&quot;avg_price&quot;</span> <span class=\"comment\"># æŒ‡å®šè·¯å¾„ï¼Œå¯¹avg_priceå­—æ®µè¿›è¡Œç´¯è®¡æ±‚å’Œæ“ä½œ</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"Derivative\">Derivative</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Derivativeï¼šå¯¹èšåˆåˆ†æçš„ç»“æœè¿›è¡Œæ±‚å¯¼æ“ä½œã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>Derivative èšåˆæŸ¥è¯¢æ˜¯ Elasticsearch ä¸­çš„ä¸€ç§é«˜çº§èšåˆç±»å‹ï¼Œç”¨äºè®¡ç®—æŸä¸ªåº¦é‡å€¼éšæ—¶é—´ï¼ˆæˆ–å…¶ä»–é¡ºåºå­—æ®µï¼‰å˜åŒ–çš„é€Ÿç‡ã€‚å®ƒé€šå¸¸ç”¨äºæ—¶é—´åºåˆ—åˆ†æï¼Œä»¥æ­ç¤ºåº¦é‡å€¼çš„å¢å‡è¶‹åŠ¿ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>ç¤ºä¾‹ï¼šæ˜¾ç¤ºæ¯å¤©çš„å¹³å‡ä»·æ ¼ä»¥åŠå¹³å‡ä»·æ ¼çš„å˜åŒ–è¶‹åŠ¿</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /shopping/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;size&quot;</span>: 0,</span><br><span class=\"line\">  <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;price_over_time&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;date_histogram&quot;</span>: &#123; <span class=\"comment\"># æŒ‰ç…§æ—¥æœŸè¿›è¡Œåˆ†ç»„</span></span><br><span class=\"line\">        <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;created_at&quot;</span>, <span class=\"comment\"># æŒ‡å®šå­—æ®µ</span></span><br><span class=\"line\">        <span class=\"string\">&quot;calendar_interval&quot;</span>: <span class=\"string\">&quot;day&quot;</span> <span class=\"comment\"># æŒ‡å®šæ—¶é—´é—´éš”ï¼Œå¯ç”¨çš„å€¼ï¼šyearã€quarterã€monthã€weekã€dayã€hourã€minuteã€second</span></span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;average_price&quot;</span>: &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;avg&quot;</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;price&quot;</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;price_derivative&quot;</span>: &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;derivative&quot;</span>: &#123; <span class=\"comment\"># å¯¹èšåˆç»“æœè¿›è¡Œæ±‚å¯¼æ“ä½œ</span></span><br><span class=\"line\">            <span class=\"string\">&quot;buckets_path&quot;</span>: <span class=\"string\">&quot;average_price&quot;</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"Moving-Function\">Moving Function</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Moving Functionï¼šå¯¹èšåˆåˆ†æçš„ç»“æœè¿›è¡Œç§»åŠ¨å¹³å‡å€¼æ“ä½œã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>Moving Function èšåˆæŸ¥è¯¢æ˜¯ Elasticsearch ä¸­çš„ä¸€ç§é«˜çº§èšåˆç±»å‹ï¼Œç”¨äºè®¡ç®—æŸä¸ªåº¦é‡å€¼åœ¨æ—¶é—´çª—å£å†…çš„ç§»åŠ¨å¹³å‡å€¼ã€‚å®ƒé€šå¸¸ç”¨äºæ—¶é—´åºåˆ—åˆ†æï¼Œä»¥äº†è§£åº¦é‡å€¼çš„å˜åŒ–è¶‹åŠ¿ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>ç¤ºä¾‹ï¼šè®¡ç®— price å­—æ®µçš„ 7 å¤©ç§»åŠ¨å¹³å‡å€¼</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /shopping/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;size&quot;</span>: 0,</span><br><span class=\"line\">  <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;price_over_time&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;date_histogram&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;created_at&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;calendar_interval&quot;</span>: <span class=\"string\">&quot;day&quot;</span></span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;daily_avg_price&quot;</span>: &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;avg&quot;</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;price&quot;</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;moving_avg_price&quot;</span>: &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;moving_fn&quot;</span>: &#123; <span class=\"comment\"># å¯¹èšåˆç»“æœè¿›è¡Œç§»åŠ¨å¹³å‡å€¼æ“ä½œ</span></span><br><span class=\"line\">            <span class=\"string\">&quot;buckets_path&quot;</span>: <span class=\"string\">&quot;daily_avg_price&quot;</span>, <span class=\"comment\"># æŒ‡å®šè·¯å¾„ï¼Œå¯¹daily_avg_priceå­—æ®µè¿›è¡Œç§»åŠ¨å¹³å‡å€¼æ“ä½œ</span></span><br><span class=\"line\">            <span class=\"string\">&quot;script&quot;</span>: <span class=\"string\">&quot;MovingFunctions.unweightedAvg(values)&quot;</span>, <span class=\"comment\"># æŒ‡å®šè„šæœ¬ï¼Œè®¡ç®—ç§»åŠ¨å¹³å‡å€¼</span></span><br><span class=\"line\">            <span class=\"string\">&quot;window&quot;</span>: 7, <span class=\"comment\"># çª—å£å¤§å°ï¼Œé»˜è®¤ä¸º 10</span></span><br><span class=\"line\">            <span class=\"string\">&quot;shift&quot;</span>: 0 <span class=\"comment\"># çª—å£åç§»é‡ï¼Œé»˜è®¤ä¸º 0</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"ES-èšåˆæ€§èƒ½ä¼˜åŒ–\">ES èšåˆæ€§èƒ½ä¼˜åŒ–</h2>\n<h3 id=\"ç´¢å¼•é¢„æ’åº\">ç´¢å¼•é¢„æ’åº</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å¦‚æœæ˜¯ Elasticsearch 6.X ä¹‹åç‰ˆæœ¬ï¼Œå¯ä»¥åœ¨æ’å…¥æ•°æ®æ—¶å¯¹ç´¢å¼•è¿›è¡Œé¢„æ’åºï¼Œè€Œä¸æ˜¯åœ¨æŸ¥è¯¢æ—¶å†å¯¹ç´¢å¼•è¿›è¡Œæ’åºï¼Œè¿™å°†æé«˜èŒƒå›´æŸ¥è¯¢ï¼ˆrange queryï¼‰å’Œæ’åºæ“ä½œçš„æ€§èƒ½ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>ä½†é¢„æ’åºå°†å¢åŠ  Elasticsearch å†™å…¥çš„æˆæœ¬ï¼Œå¯¼è‡´å¤§çº¦ 40%-50% çš„å†™æ€§èƒ½ä¸‹é™ï¼Œå¦‚æœåº”ç”¨åœºæ™¯æ˜¯æ›´å…³æ³¨å†™æ€§èƒ½çš„ä¸šåŠ¡ï¼Œå¼€å¯ç´¢å¼•é¢„æ’åºä¸æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ã€‚</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT /my_index</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;settings&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;index&quot;</span>:&#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;sort.field&quot;</span>: <span class=\"string\">&quot;create_time&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;sort.order&quot;</span>: <span class=\"string\">&quot;desc&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;mappings&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;properties&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;create_time&quot;</span>:&#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;type&quot;</span>: <span class=\"string\">&quot;date&quot;</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"ä½¿ç”¨åˆ†ç‰‡è¯·æ±‚ç¼“å­˜\">ä½¿ç”¨åˆ†ç‰‡è¯·æ±‚ç¼“å­˜</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>èšåˆè¯­å¥ä¸­ï¼Œè®¾ç½®ï¼šsizeï¼š0ï¼Œå°±ä¼šä½¿ç”¨åˆ†ç‰‡è¯·æ±‚ç¼“å­˜ç¼“å­˜ç»“æœã€‚size = 0 çš„å«ä¹‰æ˜¯ï¼šåªè¿”å›èšåˆç»“æœï¼Œä¸è¿”å›æŸ¥è¯¢ç»“æœã€‚</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /my_index/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;size&quot;</span>: 0,</span><br><span class=\"line\">  <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;remark_agg&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;terms&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;remark.keyword&quot;</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"æ‹†åˆ†èšåˆï¼Œä½¿èšåˆå¹¶è¡ŒåŒ–\">æ‹†åˆ†èšåˆï¼Œä½¿èšåˆå¹¶è¡ŒåŒ–</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Elasticsearch æŸ¥è¯¢æ¡ä»¶ä¸­åŒæ—¶æœ‰å¤šä¸ªæ¡ä»¶èšåˆï¼Œé»˜è®¤æƒ…å†µä¸‹èšåˆä¸æ˜¯å¹¶è¡Œè¿è¡Œçš„ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>å½“ä¸ºæ¯ä¸ªèšåˆæä¾›è‡ªå·±çš„æŸ¥è¯¢å¹¶æ‰§è¡Œ msearch æ—¶ï¼Œæ€§èƒ½ä¼šæœ‰æ˜¾è‘—æå‡ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>å› æ­¤ï¼Œåœ¨ CPU èµ„æºä¸æ˜¯ç“¶é¢ˆçš„å‰æä¸‹ï¼Œå¦‚æœæƒ³ç¼©çŸ­å“åº”æ—¶é—´ï¼Œå¯ä»¥å°†å¤šä¸ªèšåˆæ‹†åˆ†ä¸ºå¤šä¸ªæŸ¥è¯¢ï¼Œå€ŸåŠ©ï¼šmsearch å®ç°å¹¶è¡Œèšåˆã€‚</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#å¸¸è§„çš„å¤šæ¡ä»¶èšåˆå®ç°</span></span><br><span class=\"line\">GET /employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;size&quot;</span>: 0,</span><br><span class=\"line\">  <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;job_agg&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;terms&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;job.keyword&quot;</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">&quot;max_salary&quot;</span>:&#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;max&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;salary&quot;</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\"># msearch æ‹†åˆ†å¤šä¸ªè¯­å¥çš„èšåˆå®ç°</span></span><br><span class=\"line\">GET _msearch</span><br><span class=\"line\">&#123;<span class=\"string\">&quot;index&quot;</span>:<span class=\"string\">&quot;employees&quot;</span>&#125;</span><br><span class=\"line\">&#123;<span class=\"string\">&quot;size&quot;</span>:0,<span class=\"string\">&quot;aggs&quot;</span>:&#123;<span class=\"string\">&quot;job_agg&quot;</span>:&#123;<span class=\"string\">&quot;terms&quot;</span>:&#123;<span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;job.keyword&quot;</span>&#125;&#125;&#125;&#125;</span><br><span class=\"line\">&#123;<span class=\"string\">&quot;index&quot;</span>:<span class=\"string\">&quot;employees&quot;</span>&#125;</span><br><span class=\"line\">&#123;<span class=\"string\">&quot;size&quot;</span>:0,<span class=\"string\">&quot;aggs&quot;</span>:&#123;<span class=\"string\">&quot;max_salary&quot;</span>:&#123;<span class=\"string\">&quot;max&quot;</span>:&#123;<span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;salary&quot;</span>&#125;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>","content_text":"æ‘˜è¦ æœ¬æ–‡ä»‹ç» Elasticsearch çš„ REST APIsï¼šèšåˆæŸ¥è¯¢ Elasticsearchç‰ˆæœ¬8.17.3 å®˜æ–¹æ–‡æ¡£:REST APIs å®˜æ–¹æ–‡æ¡£:Aggregations Elasticsearch çš„ REST APIs èšåˆæŸ¥è¯¢ èšåˆæŸ¥è¯¢ï¼Œå¯ä»¥è®©æˆ‘ä»¬æå…¶æ–¹ä¾¿çš„å®ç°å¯¹ç´¢å¼•æ•°æ®çš„ç»Ÿè®¡ã€åˆ†æã€è¿ç®—ç­‰æ“ä½œã€‚ åŸºæœ¬è¯­æ³•åŒ…æ‹¬ä»¥ä¸‹éƒ¨åˆ†ï¼š æŸ¥è¯¢æ¡ä»¶ï¼šæŒ‡å®šéœ€è¦èšåˆçš„æ–‡æ¡£ï¼Œå¯ä»¥ä½¿ç”¨æ ‡å‡†çš„ Elasticsearch æŸ¥è¯¢è¯­æ³•ï¼Œå¦‚ termã€matchã€range ç­‰ç­‰ã€‚ èšåˆå‡½æ•°ï¼šæŒ‡å®šè¦æ‰§è¡Œçš„èšåˆæ“ä½œï¼Œå¦‚ sumã€avgã€minã€maxã€termsã€date_histogram ç­‰ç­‰ã€‚æ¯ä¸ªèšåˆå‘½ä»¤éƒ½ä¼šç”Ÿæˆä¸€ä¸ªèšåˆç»“æœã€‚ èšåˆåµŒå¥—ï¼šèšåˆå‘½ä»¤å¯ä»¥åµŒå¥—ï¼Œä»¥ä¾¿æ›´ç»†ç²’åº¦åœ°åˆ†ææ•°æ®ã€‚ 123456789101112131415GET &lt;index_name&gt;/_search&#123; &quot;aggs&quot;: &#123; &quot;&lt;aggs_name&gt;&quot;: &#123; &quot;&lt;agg_type&gt;&quot;: &#123; &quot;field&quot;: &quot;&lt;field_name&gt;&quot; &#125; &#125; &#125;&#125;# è¯´æ˜ # aggsï¼šèšåˆçš„æ ¹èŠ‚ç‚¹ï¼Œå›ºå®šå†™æ³• # aggs_nameï¼šèšåˆå‡½æ•°çš„åç§°ï¼Œè‡ªå·±éšæ„å®šä¹‰ # agg_typeï¼šèšåˆç§ç±»ï¼Œæ¯”å¦‚æ˜¯æ¡¶èšåˆï¼ˆtermsï¼‰æˆ–è€…æ˜¯æŒ‡æ ‡èšåˆï¼ˆavgã€sumã€minã€maxç­‰ï¼‰ # field_nameï¼šå­—æ®µåç§°æˆ–è€…å«åŸŸåã€‚ èšåˆçš„åˆ†ç±» Metric Aggregationï¼šâ€”äº›æ•°å­¦è¿ç®—ï¼Œå¯ä»¥å¯¹æ–‡æ¡£å­—æ®µè¿›è¡Œç»Ÿè®¡åˆ†æï¼Œç±»æ¯”Mysqlä¸­çš„ min(), max(), sum() æ“ä½œã€‚ Bucket Aggregationï¼šä¸€äº›æ»¡è¶³ç‰¹å®šæ¡ä»¶çš„æ–‡æ¡£çš„é›†åˆæ”¾ç½®åˆ°ä¸€ä¸ªæ¡¶é‡Œï¼Œæ¯ä¸€ä¸ªæ¡¶å…³è”ä¸€ä¸ªkeyï¼Œç±»æ¯”Mysqlä¸­çš„group byæ“ä½œã€‚ Pipeline Aggregationï¼šå¯¹å…¶ä»–çš„èšåˆç»“æœè¿›è¡ŒäºŒæ¬¡èšåˆ ç¤ºä¾‹æ•°æ®å‡†å¤‡ æˆ‘ä»¬éœ€è¦å…ˆå‡†å¤‡ä¸€äº›æ•°æ®ï¼Œæ‰èƒ½è¿›è¡Œèšåˆåˆ†æã€‚ åˆ›å»ºç´¢å¼• 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465# å¦‚æœå­˜åœ¨å…ˆåˆ é™¤curl -X DELETE -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping&#x27;# åˆ›å»ºç´¢å¼•curl -X PUT -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;settings&quot;:&#123; &quot;number_of_shards&quot;:&quot;1&quot;, &quot;number_of_replicas&quot;:&quot;2&quot; &#125;, &quot;mappings&quot;:&#123; &quot;properties&quot;:&#123; &quot;category&quot;:&#123; &quot;type&quot;:&quot;keyword&quot; &#125;, &quot;price&quot;:&#123; &quot;type&quot;:&quot;double&quot; &#125;, &quot;count&quot;:&#123; &quot;type&quot;:&quot;integer&quot; &#125;, &quot;title&quot;:&#123; &quot;type&quot;:&quot;text&quot;, &quot;analyzer&quot;:&quot;ik_max_word&quot;, &quot;search_analyzer&quot;:&quot;ik_smart&quot; &#125;, &quot;remark&quot;:&#123; &quot;type&quot;:&quot;text&quot;, &quot;analyzer&quot;:&quot;ik_max_word&quot;, &quot;search_analyzer&quot;:&quot;ik_smart&quot; &#125;, &quot;address&quot;: &#123; &quot;type&quot;: &quot;text&quot;, &quot;analyzer&quot;: &quot;ik_max_word&quot;, &quot;fields&quot;: &#123; &quot;keyword&quot;: &#123; &quot;type&quot;: &quot;keyword&quot; &#125; &#125; &#125;, &quot;tags&quot;: &#123; &quot;type&quot;: &quot;keyword&quot; &#125;, &quot;created_at&quot;: &#123;&quot;type&quot;: &quot;date&quot;, &quot;format&quot;: &quot;yyyy-MM-dd HH:mm:ss&quot;&#125; &#125; &#125; &#125;&#x27;# æ’å…¥æ•°æ®curl -X POST -u elastic:123456 -k &#x27;https://127.0.0.1:9200/_bulk&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;index&quot;: &#123; &quot;_index&quot;: &quot;shopping&quot;, &quot;_id&quot;: &quot;1&quot; &#125; &#125;&#123; &quot;category&quot;: &quot;electronics&quot;, &quot;price&quot;: 999.99, &quot;count&quot;: 10, &quot;title&quot;: &quot;Smartphone X - 128GB&quot;, &quot;remark&quot;: &quot;This latest Smartphone X comes with a powerful processor and high-resolution camera.&quot;, &quot;address&quot;: &quot;å¹¿å·å¤©æ²³å…¬å›­&quot;, &quot;tags&quot;: [&quot;latest&quot;, &quot;smartphone&quot;, &quot;technology&quot;], &quot;created_at&quot;: &quot;2025-04-22 03:30:02&quot; &#125;&#123; &quot;index&quot;: &#123; &quot;_index&quot;: &quot;shopping&quot;, &quot;_id&quot;: &quot;2&quot; &#125; &#125;&#123; &quot;category&quot;: &quot;fashion&quot;, &quot;price&quot;: 49.99, &quot;count&quot;: 25, &quot;title&quot;: &quot;Designer T-shirt&quot;, &quot;remark&quot;: &quot;Trendy designer T-shirt made with high quality fabric.&quot;, &quot;address&quot;: &quot;å¹¿å·è”æ¹¾å¤§å¦&quot;, &quot;tags&quot;: [&quot;clothing&quot;, &quot;designer&quot;, &quot;style&quot;], &quot;created_at&quot;: &quot;2025-04-21 12:15:00&quot; &#125;&#123; &quot;index&quot;: &#123; &quot;_index&quot;: &quot;shopping&quot;, &quot;_id&quot;: &quot;3&quot; &#125; &#125;&#123; &quot;category&quot;: &quot;home_appliances&quot;, &quot;price&quot;: 299.99, &quot;count&quot;: 5, &quot;title&quot;: &quot;Robot Vacuum Cleaner&quot;, &quot;remark&quot;: &quot;Efficient robot vacuum cleaner with smart navigation.&quot;, &quot;address&quot;: &quot;å¹¿å·ç™½äº‘å±±å…¬å›­&quot;, &quot;tags&quot;: [&quot;appliances&quot;, &quot;vacuum&quot;, &quot;robot&quot;], &quot;created_at&quot;: &quot;2025-04-20 08:45:30&quot; &#125;&#123; &quot;index&quot;: &#123; &quot;_index&quot;: &quot;shopping&quot;, &quot;_id&quot;: &quot;4&quot; &#125; &#125;&#123; &quot;category&quot;: &quot;books&quot;, &quot;price&quot;: 19.99, &quot;count&quot;: 100, &quot;title&quot;: &quot;Inspirational Novel&quot;, &quot;remark&quot;: &quot;A gripping novel that inspires and motivates.&quot;, &quot;address&quot;: &quot;321 Book Rd, Shenzhen, China&quot;, &quot;tags&quot;: [&quot;book&quot;, &quot;novel&quot;, &quot;inspiration&quot;], &quot;created_at&quot;: &quot;2025-04-19 10:05:00&quot; &#125;&#123; &quot;index&quot;: &#123; &quot;_index&quot;: &quot;shopping&quot;, &quot;_id&quot;: &quot;5&quot; &#125; &#125;&#123; &quot;category&quot;: &quot;groceries&quot;, &quot;price&quot;: 3.99, &quot;count&quot;: 200, &quot;title&quot;: &quot;Organic Apples&quot;, &quot;remark&quot;: &quot;Fresh and crispy organic apples.&quot;, &quot;address&quot;: &quot;654 Grocery Ln, Chengdu, China&quot;, &quot;tags&quot;: [&quot;fruit&quot;, &quot;organic&quot;, &quot;healthy&quot;], &quot;created_at&quot;: &quot;2025-04-18 14:30:45&quot; &#125;&#123; &quot;index&quot;: &#123; &quot;_index&quot;: &quot;shopping&quot;, &quot;_id&quot;: &quot;6&quot; &#125; &#125;&#123; &quot;category&quot;: &quot;electronics&quot;, &quot;price&quot;: 1999.99, &quot;count&quot;: 15, &quot;title&quot;: &quot;Smartphone X - 256GB&quot;, &quot;remark&quot;: &quot;This latest Smartphone X comes with a powerful processor and high-resolution camera.&quot;, &quot;address&quot;: &quot;å¹¿å·å¤©æ²³å…¬å›­&quot;, &quot;tags&quot;: [&quot;latest&quot;, &quot;smartphone&quot;, &quot;technology&quot;], &quot;created_at&quot;: &quot;2025-04-22 03:30:02&quot; &#125;&#x27; Metric Aggregation(æŒ‡æ ‡èšåˆ) å•å€¼åˆ†æï¸°åªè¾“å‡ºä¸€ä¸ªåˆ†æç»“æœ min, max, avg, sum 123456789101112131415161718192021222324252627# æœ€å¤§å€¼ã€æœ€å°å€¼ã€å¹³å‡å€¼ã€æ€»å’ŒGET /shopping/_search&#123; &quot;size&quot;: 0, # ä¸è¿”å›æ–‡æ¡£ï¼Œåªè¿”å›èšåˆç»“æœ &quot;aggs&quot;: &#123; &quot;max_price&quot;: &#123; # è‡ªå®šä¹‰åç§°ï¼Œè¿™é‡Œè¿”å›æœ€å¤§å€¼ &quot;max&quot;: &#123; # æŒ‡æ ‡èšåˆå‡½æ•°åç§° &quot;field&quot;: &quot;price&quot; # æŒ‡æ ‡èšåˆå­—æ®µ &#125; &#125;, &quot;min_price&quot;: &#123; &quot;min&quot;: &#123; &quot;field&quot;: &quot;price&quot; &#125; &#125;, &quot;avg_price&quot;: &#123; &quot;avg&quot;: &#123; &quot;field&quot;: &quot;price&quot; &#125; &#125;, &quot;sum_price&quot;: &#123; &quot;sum&quot;: &#123; &quot;field&quot;: &quot;price&quot; &#125; &#125; &#125;&#125; Cardinalityï¼ˆç±»ä¼¼distinct Count) 1234567891011GET /shopping/_search&#123; &quot;size&quot;: 0, # ä¸è¿”å›æ–‡æ¡£ï¼Œåªè¿”å›èšåˆç»“æœ &quot;aggs&quot;: &#123; &quot;cardinality_count&quot;: &#123; # è‡ªå®šä¹‰åç§°ï¼Œè¿”å›å»é‡åçš„æ•°é‡ &quot;cardinality&quot;: &#123; # æŒ‡æ ‡èšåˆå‡½æ•°åç§°ï¼Œcardinalityè¡¨ç¤ºå»é‡ &quot;field&quot;: &quot;category&quot; # æŒ‡æ ‡èšåˆå­—æ®µï¼Œå»é‡çš„å­—æ®µ &#125; &#125; &#125;&#125; å¤šå€¼åˆ†æ:è¾“å‡ºå¤šä¸ªåˆ†æç»“æœ statsï¼ˆç»Ÿè®¡ï¼‰, extended stats 123456789101112131415161718192021222324252627282930313233343536373839GET /shopping/_search&#123; &quot;size&quot;: 0, &quot;aggs&quot;: &#123; &quot;stats_price&quot;: &#123; &quot;stats&quot;: &#123; # æŒ‡æ ‡èšåˆå‡½æ•°åç§°ï¼Œstatsè¡¨ç¤ºç»Ÿè®¡ï¼Œä¼šè¿”å›å¤šä¸ªæŒ‡æ ‡ &quot;field&quot;: &quot;price&quot; &#125; &#125; &#125;&#125;# ç»“æœ&#123; &quot;took&quot;: 15, &quot;timed_out&quot;: false, &quot;_shards&quot;: &#123; &quot;total&quot;: 1, &quot;successful&quot;: 1, &quot;skipped&quot;: 0, &quot;failed&quot;: 0 &#125;, &quot;hits&quot;: &#123; &quot;total&quot;: &#123; &quot;value&quot;: 12, &quot;relation&quot;: &quot;eq&quot; &#125;, &quot;max_score&quot;: null, &quot;hits&quot;: [] # å› ä¸ºè®¾ç½®size ä¸º 0ï¼Œæ‰€ä»¥è¿”å›çš„ç»“æœä¸ºç©º &#125;, &quot;aggregations&quot;: &#123; # èšåˆç»“æœ &quot;stats_price&quot;: &#123; # è‡ªå®šä¹‰åç§°ï¼Œè¿”å›å¤šç»„èšåˆç»“æœ &quot;count&quot;: 12, &quot;min&quot;: 3.99, &quot;max&quot;: 1999.99, &quot;avg&quot;: 562.1666666666666, &quot;sum&quot;: 6746 &#125; &#125;&#125; percentile ï¼ˆç™¾åˆ†ä½ï¼‰, percentile rank 1234567891011121314151617GET /shopping/_search&#123; &quot;size&quot;: 0, &quot;aggs&quot;: &#123; &quot;percentile_price&quot;: &#123; &quot;percentiles&quot;: &#123; # æŒ‡æ ‡èšåˆå‡½æ•°åç§°ï¼Œpercentilesè¡¨ç¤ºç™¾åˆ†ä½æ•°èšåˆè®¡ç®— &quot;field&quot;: &quot;price&quot;, # æŒ‡æ ‡èšåˆå­—æ®µ &quot;percents&quot;: [1, 5, 25, 50, 75, 95, 99] # éœ€è¦è®¡ç®—ç™¾åˆ†ä½æ•°çš„æ•°ç»„ &#125; &#125; &#125;&#125;# ç™¾åˆ†ä½æ•°æ˜¯ä¸€ä¸ªç»Ÿè®¡å­¦æ¦‚å¿µï¼Œç”¨äºæè¿°ä¸€ä¸ªç»™å®šé›†åˆçš„æ’åºå€¼ã€‚ä¾‹å¦‚ï¼š# ç¬¬ 1 ç™¾åˆ†ä½æ•°è¡¨ç¤ºæ•°æ®ä¸­å°äºè¿™ä¸ªå€¼çš„æ‰€æœ‰æ•°æ®å æ€»æ•°çš„ 1%ã€‚# ç¬¬ 50 ç™¾åˆ†ä½æ•°ï¼ˆä¸­ä½æ•°ï¼‰è¡¨ç¤ºæ•°æ®ä¸­çš„ä¸€åŠå°äºè¿™ä¸ªå€¼ï¼Œå¦ä¸€åŠå¤§äºè¿™ä¸ªå€¼ã€‚# ç¬¬ 99 ç™¾åˆ†ä½æ•°è¡¨ç¤ºæ•°æ®ä¸­å°äºè¿™ä¸ªå€¼çš„æ‰€æœ‰æ•°æ®å æ€»æ•°çš„ 99%ã€‚# é€šè¿‡è®¡ç®—è¿™äº›ç™¾åˆ†ä½æ•°ï¼Œä½ å¯ä»¥äº†è§£ price å­—æ®µåœ¨æ•´ä¸ªshoppingç´¢å¼•ä¸­çš„åˆ†å¸ƒæƒ…å†µï¼Œä»è€Œå¯ä»¥ç”¨äºæ•°æ®åˆ†æã€è¶‹åŠ¿åˆ¤æ–­ç­‰ã€‚ top hits(æ’åœ¨å‰é¢çš„ç¤ºä¾‹) 123456789101112GET /shopping/_search&#123; &quot;size&quot;: 0, &quot;aggs&quot;: &#123; &quot;top_hits&quot;: &#123; # è‡ªå®šä¹‰åç§°ï¼Œè¿”å›æ’åœ¨å‰é¢çš„ç¤ºä¾‹ &quot;top_hits&quot;: &#123; # æŒ‡æ ‡èšåˆå‡½æ•°åç§°ï¼Œtop_hitsè¡¨ç¤ºè¿”å›æ’åœ¨å‰é¢çš„ç¤ºä¾‹ &quot;sort&quot;: [&#123;&quot;price&quot;: &#123;&quot;order&quot;: &quot;desc&quot;&#125;&#125;], # æ’åºï¼ŒæŒ‰ç…§priceå­—æ®µé™åºæ’åº &quot;size&quot;: 3 # åªè¿”å›å‰3ä¸ª &#125; &#125; &#125;&#125; Bucket Aggregation(æ¡¶èšåˆ) æŒ‰ç…§ä¸€å®šçš„è§„åˆ™ï¼Œå°†æ–‡æ¡£åˆ†é…åˆ°ä¸åŒçš„æ¡¶ä¸­ï¼Œä»è€Œè¾¾åˆ°åˆ†ç±»çš„ç›®çš„ã€‚ ESæä¾›çš„ä¸€äº›å¸¸è§çš„ Bucket Aggregationã€‚ termsï¼ˆè¯æ¡ï¼‰, rangeï¼ˆèŒƒå›´ï¼‰, date_rangeï¼ˆæ—¥æœŸèŒƒå›´ï¼‰, ip_rangeï¼ˆIPèŒƒå›´ï¼‰, missingï¼ˆç¼ºå¤±ï¼‰, histogramï¼ˆç›´æ–¹å›¾ï¼‰, date_histogramï¼ˆæ—¥æœŸç›´æ–¹å›¾ï¼‰, geo_distanceï¼ˆåœ°ç†è·ç¦»ï¼‰, significant_termsï¼ˆé‡è¦è¯æ¡ï¼‰, compositeï¼ˆç»„åˆï¼‰ æ¡¶èšåˆå¯ä»¥ç”¨äºå„ç§åœºæ™¯ï¼Œä¾‹å¦‚ï¼š å¯¹æ•°æ®è¿›è¡Œåˆ†ç»„ç»Ÿè®¡ï¼Œæ¯”å¦‚æŒ‰ç…§åœ°åŒºã€å¹´é¾„æ®µã€æ€§åˆ«ç­‰å­—æ®µè¿›è¡Œåˆ†ç»„ç»Ÿè®¡ã€‚ å¯¹æ—¶é—´åºåˆ—æ•°æ®è¿›è¡Œæ—¶é—´æ®µåˆ†æï¼Œæ¯”å¦‚æŒ‰ç…§æ¯å°æ—¶ã€æ¯å¤©ã€æ¯æœˆã€æ¯å­£åº¦ã€æ¯å¹´ç­‰æ—¶é—´æ®µè¿›è¡Œåˆ†æã€‚ å¯¹å„ç§æ ‡ç­¾ä¿¡æ¯åˆ†ç±»ï¼Œå¹¶ç»Ÿè®¡å…¶æ•°é‡ã€‚ termsï¼ˆè¯æ¡ï¼‰ æŒ‰ç…§å­—æ®µçš„å€¼è¿›è¡Œåˆ†ç»„ï¼Œå¹¶ç»Ÿè®¡æ¯ä¸ªç»„çš„æ•°é‡ã€‚ ç¤ºä¾‹ï¼šæŒ‰ç…§categoryå­—æ®µè¿›è¡Œåˆ†ç»„ï¼Œå¹¶ç»Ÿè®¡æ¯ä¸ªç»„çš„æ•°é‡ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061GET /shopping/_search&#123; &quot;size&quot;: 0, &quot;aggs&quot;: &#123; &quot;category_count&quot;: &#123; # è‡ªå®šä¹‰åç§°ï¼Œè¿”å›æ¯ä¸ªç»„çš„æ•°é‡ &quot;terms&quot;: &#123; # æ¡¶èšåˆå‡½æ•°åç§°ï¼Œtermsè¡¨ç¤ºæŒ‰ç…§å­—æ®µçš„å€¼è¿›è¡Œåˆ†ç»„ &quot;field&quot;: &quot;category&quot;, # æŒ‰ç…§categoryå­—æ®µè¿›è¡Œåˆ†ç»„ï¼Œæ³¨æ„ä¸èƒ½æ˜¯textç±»å‹ï¼Œå¦åˆ™ä¼šæŠ¥é”™ &quot;size&quot;: 10, # åªè¿”å›å‰10ä¸ªï¼Œé»˜è®¤æ˜¯10 &quot;order&quot;: &#123;&quot;_count&quot;: &quot;desc&quot;&#125; # æŒ‰ç…§æ•°é‡é™åºæ’åºï¼Œé»˜è®¤æ˜¯descï¼ŒBucketèšåˆä¼šç»Ÿè®¡Bucketå†…çš„æ–‡æ¡£æ•°é‡ï¼Œè®°ä¸º_countï¼Œå¹¶ä¸”æŒ‰ç…§_counté™åºæ’åº &#125; &#125; &#125;&#125;# ç»“æœ&#123; &quot;took&quot;: 15, &quot;timed_out&quot;: false, &quot;_shards&quot;: &#123; &quot;total&quot;: 1, &quot;successful&quot;: 1, &quot;skipped&quot;: 0, &quot;failed&quot;: 0 &#125;, &quot;hits&quot;: &#123; &quot;total&quot;: &#123; &quot;value&quot;: 12, &quot;relation&quot;: &quot;eq&quot; &#125;, &quot;max_score&quot;: null, &quot;hits&quot;: [] &#125;, &quot;aggregations&quot;: &#123; &quot;category_count&quot;: &#123; &quot;doc_count_error_upper_bound&quot;: 0, # é”™è¯¯ä¸Šç•Œï¼Œè¡¨ç¤ºåœ¨èšåˆè¿‡ç¨‹ä¸­å¯èƒ½å­˜åœ¨ä¸€äº›é”™è¯¯ï¼Œä½†é”™è¯¯æ•°é‡ä¸ä¼šè¶…è¿‡è¿™ä¸ªå€¼ &quot;sum_other_doc_count&quot;: 0, # è¡¨ç¤ºåœ¨èšåˆè¿‡ç¨‹ä¸­ï¼Œé™¤äº†è¿”å›çš„10ä¸ªbucketï¼Œè¿˜æœ‰å…¶ä»–æ•°é‡ï¼Œè¿™ä¸ªæ•°é‡å°±æ˜¯sum_other_doc_count &quot;buckets&quot;: [ # è¿”å›çš„bucket &#123; &quot;key&quot;: &quot;electronics&quot;, # åˆ†ç»„çš„key &quot;doc_count&quot;: 4 # åˆ†ç»„çš„æ•°é‡ &#125;, &#123; &quot;key&quot;: &quot;books&quot;, &quot;doc_count&quot;: 2 &#125;, &#123; &quot;key&quot;: &quot;fashion&quot;, &quot;doc_count&quot;: 2 &#125;, &#123; &quot;key&quot;: &quot;groceries&quot;, &quot;doc_count&quot;: 2 &#125;, &#123; &quot;key&quot;: &quot;home_appliances&quot;, &quot;doc_count&quot;: 2 &#125; ] &#125; &#125;&#125; é™å®šèšåˆèŒƒå›´ 1234567891011121314151617181920GET /shopping/_search&#123; &quot;query&quot;: &#123; &quot;range&quot;: &#123; &quot;price&quot;: &#123; &quot;gte&quot;: 100 # é™å®šä»·æ ¼èŒƒå›´ &#125; &#125; &#125;, &quot;size&quot;: 0, &quot;aggs&quot;: &#123; &quot;category_count&quot;: &#123; # è‡ªå®šä¹‰åç§°ï¼Œè¿”å›æ¯ä¸ªç»„çš„æ•°é‡ &quot;terms&quot;: &#123; # æ¡¶èšåˆå‡½æ•°åç§°ï¼Œtermsè¡¨ç¤ºæŒ‰ç…§å­—æ®µçš„å€¼è¿›è¡Œåˆ†ç»„ &quot;field&quot;: &quot;category&quot;, # æŒ‰ç…§categoryå­—æ®µè¿›è¡Œåˆ†ç»„ &quot;size&quot;: 10, # åªè¿”å›å‰10ä¸ªï¼Œé»˜è®¤æ˜¯10 &quot;order&quot;: &#123;&quot;_count&quot;: &quot;desc&quot;&#125; # æŒ‰ç…§æ•°é‡é™åºæ’åºï¼Œé»˜è®¤æ˜¯descï¼ŒBucketèšåˆä¼šç»Ÿè®¡Bucketå†…çš„æ–‡æ¡£æ•°é‡ï¼Œè®°ä¸º_countï¼Œå¹¶ä¸”æŒ‰ç…§_counté™åºæ’åº &#125; &#125; &#125;&#125; rangeï¼ˆèŒƒå›´ï¼‰ æŒ‰ç…§å­—æ®µçš„å€¼è¿›è¡Œåˆ†ç»„ï¼Œå¹¶ç»Ÿè®¡æ¯ä¸ªç»„çš„æ•°é‡ã€‚ ç¤ºä¾‹ï¼šæŒ‰ç…§ä»·æ ¼èŒƒå›´è¿›è¡Œåˆ†ç»„ï¼Œå¹¶ç»Ÿè®¡æ¯ä¸ªç»„çš„æ•°é‡ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960GET /shopping/_search&#123; &quot;size&quot;: 0, &quot;aggs&quot;: &#123; &quot;price_range&quot;: &#123; # è‡ªå®šä¹‰åç§°ï¼Œè¿”å›æ¯ä¸ªç»„çš„æ•°é‡ &quot;range&quot;: &#123; # æ¡¶èšåˆå‡½æ•°åç§°ï¼Œrangeè¡¨ç¤ºæŒ‰ç…§å­—æ®µçš„å€¼è¿›è¡Œåˆ†ç»„ &quot;field&quot;: &quot;price&quot;, # æŒ‰ç…§priceå­—æ®µè¿›è¡Œåˆ†ç»„ &quot;ranges&quot;: [ &#123;&quot;to&quot;: 100&#125;, # å°äº100 &#123;&quot;from&quot;: 100, &quot;to&quot;: 200&#125;, # 100-200ï¼ŒåŒ…æ‹¬100ï¼Œä¸åŒ…æ‹¬200 &#123; &quot;key&quot;:&quot;&gt;=200&quot;, # è®¾å®šé”®å€¼ï¼Œç”¨äºåŒºåˆ†ä¸åŒèŒƒå›´ &quot;from&quot;:200 # å¤§äºç­‰äº200 &#125; ] &#125; &#125; &#125;&#125;# ç»“æœ&#123; &quot;took&quot;: 5, &quot;timed_out&quot;: false, &quot;_shards&quot;: &#123; &quot;total&quot;: 1, &quot;successful&quot;: 1, &quot;skipped&quot;: 0, &quot;failed&quot;: 0 &#125;, &quot;hits&quot;: &#123; &quot;total&quot;: &#123; &quot;value&quot;: 12, &quot;relation&quot;: &quot;eq&quot; &#125;, &quot;max_score&quot;: null, &quot;hits&quot;: [] &#125;, &quot;aggregations&quot;: &#123; &quot;price_range&quot;: &#123; &quot;buckets&quot;: [ &#123; &quot;key&quot;: &quot;*-100.0&quot;, &quot;to&quot;: 100, &quot;doc_count&quot;: 6 &#125;, &#123; &quot;key&quot;: &quot;100.0-200.0&quot;, &quot;from&quot;: 100, &quot;to&quot;: 200, &quot;doc_count&quot;: 0 &#125;, &#123; &quot;key&quot;: &quot;&gt;=200&quot;, &quot;from&quot;: 200, &quot;doc_count&quot;: 6 &#125; ] &#125; &#125;&#125; date_rangeï¼ˆæ—¥æœŸèŒƒå›´ï¼‰ æŒ‰ç…§å­—æ®µçš„å€¼è¿›è¡Œåˆ†ç»„ï¼Œå¹¶ç»Ÿè®¡æ¯ä¸ªç»„çš„æ•°é‡ã€‚ ç¤ºä¾‹ï¼šæŒ‰ç…§æ—¥æœŸèŒƒå›´è¿›è¡Œåˆ†ç»„ï¼Œå¹¶ç»Ÿè®¡æ¯ä¸ªç»„çš„æ•°é‡ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879GET /shopping/_search&#123; &quot;size&quot;: 0, &quot;aggs&quot;: &#123; &quot;date_range&quot;: &#123; &quot;date_range&quot;: &#123; &quot;field&quot;: &quot;created_at&quot;, &quot;ranges&quot;: [ &#123;&quot;to&quot;: &quot;now-3d&quot;&#125;, # å°äºå½“å‰æ—¶é—´å‡å»3å¤© &#123;&quot;from&quot;: &quot;now-3d&quot;,&quot;to&quot;: &quot;now-1d&quot;&#125;, # å¤§äºå½“å‰æ—¶é—´å‡å»3å¤©ï¼ˆåŒ…å«ï¼‰ï¼Œå°äºå½“å‰æ—¶é—´å‡å»1å¤© &#123;&quot;key&quot;:&quot;now-1d&quot;,&quot;from&quot;: &quot;now-1d&quot;&#125; # å¤§äºå½“å‰æ—¶é—´å‡å»1å¤©ï¼ˆåŒ…å«ï¼‰ï¼Œå¹¶è®¾ç½®é”®å€¼ ] &#125; &#125; &#125;&#125;# ç»“æœ&#123; &quot;took&quot;: 3, &quot;timed_out&quot;: false, &quot;_shards&quot;: &#123; &quot;total&quot;: 1, &quot;successful&quot;: 1, &quot;skipped&quot;: 0, &quot;failed&quot;: 0 &#125;, &quot;hits&quot;: &#123; &quot;total&quot;: &#123; &quot;value&quot;: 12, &quot;relation&quot;: &quot;eq&quot; &#125;, &quot;max_score&quot;: null, &quot;hits&quot;: [] &#125;, &quot;aggregations&quot;: &#123; &quot;date_range&quot;: &#123; &quot;buckets&quot;: [ &#123; &quot;key&quot;: &quot;*-2025-04-20 03:14:17&quot;, &quot;to&quot;: 1745118857610, &quot;to_as_string&quot;: &quot;2025-04-20 03:14:17&quot;, &quot;doc_count&quot;: 4 &#125;, &#123; &quot;key&quot;: &quot;2025-04-20 03:14:17-2025-04-22 03:14:17&quot;, &quot;from&quot;: 1745118857610, &quot;from_as_string&quot;: &quot;2025-04-20 03:14:17&quot;, &quot;to&quot;: 1745291657610, &quot;to_as_string&quot;: &quot;2025-04-22 03:14:17&quot;, &quot;doc_count&quot;: 4 &#125;, &#123; &quot;key&quot;: &quot;now-1d&quot;, &quot;from&quot;: 1745291657610, &quot;from_as_string&quot;: &quot;2025-04-22 03:14:17&quot;, &quot;doc_count&quot;: 4 &#125; ] &#125; &#125;&#125;# æ—¥æœŸæ ¼å¼GET /shopping/_search&#123; &quot;size&quot;: 0, &quot;aggs&quot;: &#123; &quot;date_range&quot;: &#123; &quot;date_range&quot;: &#123; &quot;field&quot;: &quot;created_at&quot;, &quot;ranges&quot;: [ &#123;&quot;to&quot;: &quot;2025-04-20 00:00:00&quot;&#125;, # æ³¨æ„è¿™é‡Œçš„æ ¼å¼å¿…é¡»ä¸å­—æ®µæ ¼å¼ä¸€è‡´ &#123;&quot;from&quot;: &quot;2025-04-20 00:00:00&quot;,&quot;to&quot;: &quot;2025-04-22 00:00:00&quot;&#125;, &#123;&quot;key&quot;:&quot;2025-04-22 00:00:00&quot;,&quot;from&quot;: &quot;2025-04-22 00:00:00&quot;&#125; ] &#125; &#125; &#125;&#125; histogramï¼ˆç›´æ–¹å›¾ï¼‰ æŒ‰ç…§é—´éš”è¿›è¡Œåˆ†ç»„ï¼Œå¹¶ç»Ÿè®¡æ¯ä¸ªç»„çš„æ•°é‡ã€‚ ç¤ºä¾‹ï¼šæŒ‰ç…§ä»·æ ¼çš„é—´éš”è¿›è¡Œåˆ†ç»„ï¼Œå¹¶ç»Ÿè®¡æ¯ä¸ªç»„çš„æ•°é‡ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061GET /shopping/_search&#123; &quot;size&quot;: 0, &quot;aggs&quot;: &#123; &quot;price_histogram&quot;: &#123; &quot;histogram&quot;: &#123; &quot;field&quot;: &quot;price&quot;, &quot;interval&quot;: 500, # é—´éš”500 &quot;extended_bounds&quot;:&#123; # è®¾ç½®è¾¹ç•Œ &quot;min&quot;:0, # æœ€å°å€¼0 &quot;max&quot;:2000 # æœ€å¤§å€¼2000 &#125; &#125; &#125; &#125;&#125;# ç»“æœ&#123; &quot;took&quot;: 2, &quot;timed_out&quot;: false, &quot;_shards&quot;: &#123; &quot;total&quot;: 1, &quot;successful&quot;: 1, &quot;skipped&quot;: 0, &quot;failed&quot;: 0 &#125;, &quot;hits&quot;: &#123; &quot;total&quot;: &#123; &quot;value&quot;: 12, &quot;relation&quot;: &quot;eq&quot; &#125;, &quot;max_score&quot;: null, &quot;hits&quot;: [] &#125;, &quot;aggregations&quot;: &#123; &quot;price_histogram&quot;: &#123; &quot;buckets&quot;: [ &#123; &quot;key&quot;: 0, &quot;doc_count&quot;: 8 &#125;, &#123; &quot;key&quot;: 500, &quot;doc_count&quot;: 1 &#125;, &#123; &quot;key&quot;: 1000, &quot;doc_count&quot;: 1 &#125;, &#123; &quot;key&quot;: 1500, &quot;doc_count&quot;: 2 &#125;, &#123; &quot;key&quot;: 2000, &quot;doc_count&quot;: 0 &#125; ] &#125; &#125;&#125; top_hitsï¼ˆåˆ†æ¡¶å–å‰Næ¡ï¼‰ æŒ‰ç…§å­—æ®µçš„å€¼è¿›è¡Œåˆ†ç»„ï¼Œå¹¶è¿”å›æ¯ä¸ªç»„çš„å‰Næ¡æ•°æ®ã€‚ ç¤ºä¾‹ï¼šæŒ‰ç…§categoryè¿›è¡Œåˆ†ç»„ï¼Œå¹¶è¿”å›æ¯ä¸ªç»„çš„å‰3æ¡æ•°æ®ã€‚ 1234567891011121314151617181920212223GET /shopping/_search&#123; &quot;size&quot;: 0, &quot;aggs&quot;: &#123; &quot;price_top_hits&quot;: &#123; # è‡ªå®šä¹‰åç§° &quot;terms&quot;: &#123; &quot;field&quot;: &quot;category&quot; # æŒ‰ç…§categoryå­—æ®µè¿›è¡Œåˆ†ç»„ &#125;, &quot;aggs&quot;: &#123; &quot;top_hits&quot;: &#123; # è‡ªå®šä¹‰åç§° &quot;top_hits&quot;: &#123; # è¿”å›æ¯ä¸ªç»„çš„å‰3æ¡æ•°æ® &quot;size&quot;: 3, # è¿”å›å‰3æ¡æ•°æ® &quot;sort&quot;: &#123; # æŒ‰ç…§created_atå­—æ®µè¿›è¡Œæ’åº &quot;created_at&quot;: &#123; &quot;order&quot;: &quot;desc&quot; # é™åº &#125; &#125; &#125; &#125; &#125; &#125; &#125;&#125; å­èšåˆ å­èšåˆï¼šåœ¨èšåˆå‡½æ•°ä¸­ï¼Œè¿˜å¯ä»¥å†å®šä¹‰ä¸€ä¸ªèšåˆå‡½æ•°ã€‚ ç¤ºä¾‹ï¼šæŒ‰ç…§categoryè¿›è¡Œåˆ†ç»„ï¼Œå¹¶ç»Ÿè®¡ä»·æ ¼ä¿¡æ¯ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546GET /shopping/_search&#123; &quot;size&quot;: 0, &quot;aggs&quot;: &#123; &quot;category_buckets&quot;: &#123; # è‡ªå®šä¹‰åç§° &quot;terms&quot;: &#123; &quot;field&quot;: &quot;category&quot; # æŒ‰ç…§categoryå­—æ®µè¿›è¡Œåˆ†ç»„ &#125; &quot;aggs&quot;: &#123; # å®šä¹‰å­èšåˆ &quot;price_stats&quot;: &#123; &quot;stats&quot;: &#123; # ç»Ÿè®¡ä»·æ ¼ä¿¡æ¯ &quot;field&quot;: &quot;price&quot; &#125; &#125; &#125; &#125; &#125;&#125;# å¤šå±‚åµŒå¥—# å…ˆæŒ‰ç…§categoryè¿›è¡Œåˆ†ç»„ï¼Œå†æŒ‰ç…§addressè¿›è¡Œåˆ†ç»„ï¼Œå¹¶ç»Ÿè®¡ä»·æ ¼ä¿¡æ¯GET /shopping/_search&#123; &quot;size&quot;:0, &quot;aggs&quot;:&#123; &quot;category_buckets&quot;:&#123; &quot;terms&quot;:&#123; &quot;field&quot;:&quot;category&quot; &#125;, &quot;aggs&quot;:&#123; &quot;address_buckets&quot;:&#123; &quot;terms&quot;:&#123; &quot;field&quot;:&quot;address.keyword&quot; &#125;, &quot;aggs&quot;:&#123; &quot;price_stats&quot;:&#123; &quot;stats&quot;:&#123; &quot;field&quot;:&quot;price&quot; &#125; &#125; &#125; &#125; &#125; &#125; &#125;&#125; Pipeline Aggregation(ç®¡é“èšåˆ) æ”¯æŒå¯¹èšåˆåˆ†æçš„ç»“æœï¼Œå†æ¬¡è¿›è¡Œèšåˆåˆ†æã€‚ Pipeline çš„åˆ†æç»“æœä¼šè¾“å‡ºåˆ°åŸç»“æœä¸­ï¼Œæ ¹æ®ä½ç½®çš„ä¸åŒï¼Œåˆ†ä¸ºä¸¤ç±»ï¼š Sibling - ç»“æœå’Œç°æœ‰åˆ†æç»“æœåŒçº§ Maxï¼Œminï¼ŒAvg &amp; Sum Bucket Statsï¼ŒExtended Status Bucket Percentiles Bucket Parent -ç»“æœå†…åµŒåˆ°ç°æœ‰çš„èšåˆåˆ†æç»“æœä¹‹ä¸­ Derivative(æ±‚å¯¼) Cumultive Sum(ç´¯è®¡æ±‚å’Œ) Moving Function(ç§»åŠ¨å¹³å‡å€¼) Maxï¼Œminï¼ŒAvg &amp; Sum Bucket Maxï¼Œminï¼ŒAvg &amp; Sum Bucketï¼šå¯¹èšåˆåˆ†æçš„ç»“æœè¿›è¡Œæœ€å¤§å€¼ã€æœ€å°å€¼ã€å¹³å‡å€¼ã€æ±‚å’Œç­‰æ“ä½œã€‚ ç¤ºä¾‹ï¼šæŒ‰ç…§categoryè¿›è¡Œåˆ†ç»„æ±‚å‡ºå•†å“çš„å¹³å‡ä»·æ ¼ï¼Œå¹¶æ‰¾å‡ºå¹³å‡ä»·æ ¼æœ€ä½çš„åˆ†ç»„ 1234567891011121314151617181920212223GET /shopping/_search&#123; &quot;size&quot;:0, &quot;aggs&quot;:&#123; &quot;category_buckets&quot;:&#123; &quot;terms&quot;:&#123; &quot;field&quot;:&quot;category&quot; # æŒ‰ç…§categoryå­—æ®µè¿›è¡Œåˆ†ç»„ &#125;, &quot;aggs&quot;:&#123; &quot;price_avg&quot;:&#123; &quot;avg&quot;:&#123; # æ±‚ä»·æ ¼å¹³å‡å€¼ &quot;field&quot;:&quot;price&quot; &#125; &#125; &#125; &#125;, &quot;min_price_in_category&quot;:&#123; # æ‰¾å‡ºå¹³å‡ä»·æ ¼æœ€ä½çš„åˆ†ç»„ &quot;min_bucket&quot;:&#123; # å¯¹èšåˆç»“æœè¿›è¡Œæœ€å°å€¼æ“ä½œ &quot;buckets_path&quot;:&quot;category_buckets&gt;price_avg&quot; # æŒ‡å®šè·¯å¾„ï¼Œå¯¹category_bucketsèšåˆç»“æœä¸­çš„price_avgå­—æ®µè¿›è¡Œæœ€å°å€¼æ“ä½œ &#125; &#125; &#125;&#125; Statsï¼ŒExtended Status Bucket Statsï¼ŒExtended Status Bucketï¼šå¯¹èšåˆåˆ†æçš„ç»“æœè¿›è¡Œç»Ÿè®¡æ“ä½œï¼ŒåŒ…æ‹¬æœ€å¤§å€¼ã€æœ€å°å€¼ã€å¹³å‡å€¼ã€æ±‚å’Œã€æ•°é‡ç­‰ã€‚ ç¤ºä¾‹ï¼šæŒ‰ç…§categoryè¿›è¡Œåˆ†ç»„æ±‚å‡ºå•†å“çš„å¹³å‡ä»·æ ¼ï¼Œå¹¶å¯¹åˆ†ç»„ç»“æœè¿›è¡Œç»Ÿè®¡æ“ä½œ 123456789101112131415161718192021222324GET /shopping/_search&#123; &quot;size&quot;: 0, &quot;aggs&quot;: &#123; &quot;category_buckets&quot;: &#123; &quot;terms&quot;: &#123; &quot;field&quot;: &quot;category&quot;, &quot;size&quot;: 10 # æŒ‡å®šåˆ†ç»„æ•°é‡ &#125;, &quot;aggs&quot;: &#123; &quot;avg_price&quot;: &#123; &quot;avg&quot;: &#123; &quot;field&quot;: &quot;price&quot; &#125; &#125; &#125; &#125;, &quot;stats_price_by_job&quot;:&#123; &quot;stats_bucket&quot;: &#123; # å¯¹èšåˆç»“æœè¿›è¡Œç»Ÿè®¡æ“ä½œ &quot;buckets_path&quot;: &quot;category_buckets&gt;avg_price&quot; # æŒ‡å®šè·¯å¾„ï¼Œå¯¹category_bucketsèšåˆç»“æœä¸­çš„avg_priceå­—æ®µè¿›è¡Œç»Ÿè®¡æ“ä½œ &#125; &#125; &#125;&#125; Percentiles Bucket Percentiles Bucketï¼šå¯¹èšåˆåˆ†æçš„ç»“æœè¿›è¡Œç™¾åˆ†æ¯”æ“ä½œï¼ŒåŒ…æ‹¬ç™¾åˆ†æ¯”ã€ä¸­ä½æ•°ç­‰ã€‚ ç¤ºä¾‹ï¼šæŒ‰ç…§categoryè¿›è¡Œåˆ†ç»„æ±‚å‡ºå•†å“çš„å¹³å‡ä»·æ ¼ï¼Œå¹¶å¯¹åˆ†ç»„ç»“æœè¿›è¡Œç™¾åˆ†æ¯”æ“ä½œ 123456789101112131415161718192021222324GET /shopping/_search&#123; &quot;size&quot;: 0, &quot;aggs&quot;: &#123; &quot;category_buckets&quot;: &#123; &quot;terms&quot;: &#123; &quot;field&quot;: &quot;category&quot;, &quot;size&quot;: 10 &#125;, &quot;aggs&quot;: &#123; &quot;avg_price&quot;: &#123; &quot;avg&quot;: &#123; &quot;field&quot;: &quot;price&quot; &#125; &#125; &#125; &#125;, &quot;percentiles_price_by_category&quot;:&#123; &quot;percentiles_bucket&quot;: &#123; # å¯¹èšåˆç»“æœè¿›è¡Œç»Ÿè®¡æ“ä½œ &quot;buckets_path&quot;: &quot;category_buckets&gt;avg_price&quot; # æŒ‡å®šè·¯å¾„ï¼Œå¯¹category_bucketsèšåˆç»“æœä¸­çš„avg_priceå­—æ®µè¿›è¡Œç»Ÿè®¡æ“ä½œ &#125; &#125; &#125;&#125; Cumulative Sum Cumulative Sumï¼šå¯¹èšåˆåˆ†æçš„ç»“æœè¿›è¡Œç´¯è®¡æ±‚å’Œæ“ä½œã€‚ ç¤ºä¾‹: æŒ‰ç…§ä»·æ ¼è¿›è¡Œåˆ†ç»„ï¼Œå¹¶ç»Ÿè®¡å¹³å‡ä»·æ ¼ä¿¡æ¯ï¼Œå¯¹åˆ†ç»„ç»“æœè¿›è¡Œç´¯è®¡æ±‚å’Œæ“ä½œã€‚ 12345678910111213141516171819202122232425262728GET /shopping/_search&#123; &quot;size&quot;: 0, &quot;aggs&quot;: &#123; &quot;price_histogram&quot;: &#123; &quot;histogram&quot;: &#123; &quot;field&quot;: &quot;price&quot;, &quot;interval&quot;: 500, # é—´éš”500 &quot;extended_bounds&quot;:&#123; # è®¾ç½®è¾¹ç•Œ &quot;min&quot;:0, # æœ€å°å€¼0 &quot;max&quot;:2000 # æœ€å¤§å€¼2000 &#125; &#125;, &quot;aggs&quot;: &#123; &quot;avg_price&quot;: &#123; &quot;avg&quot;: &#123; &quot;field&quot;: &quot;price&quot; &#125; &#125;, &quot;cumulative_sum_price&quot;: &#123; &quot;cumulative_sum&quot;: &#123; # å¯¹èšåˆç»“æœè¿›è¡Œç´¯è®¡æ±‚å’Œæ“ä½œ &quot;buckets_path&quot;: &quot;avg_price&quot; # æŒ‡å®šè·¯å¾„ï¼Œå¯¹avg_priceå­—æ®µè¿›è¡Œç´¯è®¡æ±‚å’Œæ“ä½œ &#125; &#125; &#125; &#125; &#125;&#125; Derivative Derivativeï¼šå¯¹èšåˆåˆ†æçš„ç»“æœè¿›è¡Œæ±‚å¯¼æ“ä½œã€‚ Derivative èšåˆæŸ¥è¯¢æ˜¯ Elasticsearch ä¸­çš„ä¸€ç§é«˜çº§èšåˆç±»å‹ï¼Œç”¨äºè®¡ç®—æŸä¸ªåº¦é‡å€¼éšæ—¶é—´ï¼ˆæˆ–å…¶ä»–é¡ºåºå­—æ®µï¼‰å˜åŒ–çš„é€Ÿç‡ã€‚å®ƒé€šå¸¸ç”¨äºæ—¶é—´åºåˆ—åˆ†æï¼Œä»¥æ­ç¤ºåº¦é‡å€¼çš„å¢å‡è¶‹åŠ¿ã€‚ ç¤ºä¾‹ï¼šæ˜¾ç¤ºæ¯å¤©çš„å¹³å‡ä»·æ ¼ä»¥åŠå¹³å‡ä»·æ ¼çš„å˜åŒ–è¶‹åŠ¿ 123456789101112131415161718192021222324GET /shopping/_search&#123; &quot;size&quot;: 0, &quot;aggs&quot;: &#123; &quot;price_over_time&quot;: &#123; &quot;date_histogram&quot;: &#123; # æŒ‰ç…§æ—¥æœŸè¿›è¡Œåˆ†ç»„ &quot;field&quot;: &quot;created_at&quot;, # æŒ‡å®šå­—æ®µ &quot;calendar_interval&quot;: &quot;day&quot; # æŒ‡å®šæ—¶é—´é—´éš”ï¼Œå¯ç”¨çš„å€¼ï¼šyearã€quarterã€monthã€weekã€dayã€hourã€minuteã€second &#125;, &quot;aggs&quot;: &#123; &quot;average_price&quot;: &#123; &quot;avg&quot;: &#123; &quot;field&quot;: &quot;price&quot; &#125; &#125;, &quot;price_derivative&quot;: &#123; &quot;derivative&quot;: &#123; # å¯¹èšåˆç»“æœè¿›è¡Œæ±‚å¯¼æ“ä½œ &quot;buckets_path&quot;: &quot;average_price&quot; &#125; &#125; &#125; &#125; &#125;&#125; Moving Function Moving Functionï¼šå¯¹èšåˆåˆ†æçš„ç»“æœè¿›è¡Œç§»åŠ¨å¹³å‡å€¼æ“ä½œã€‚ Moving Function èšåˆæŸ¥è¯¢æ˜¯ Elasticsearch ä¸­çš„ä¸€ç§é«˜çº§èšåˆç±»å‹ï¼Œç”¨äºè®¡ç®—æŸä¸ªåº¦é‡å€¼åœ¨æ—¶é—´çª—å£å†…çš„ç§»åŠ¨å¹³å‡å€¼ã€‚å®ƒé€šå¸¸ç”¨äºæ—¶é—´åºåˆ—åˆ†æï¼Œä»¥äº†è§£åº¦é‡å€¼çš„å˜åŒ–è¶‹åŠ¿ã€‚ ç¤ºä¾‹ï¼šè®¡ç®— price å­—æ®µçš„ 7 å¤©ç§»åŠ¨å¹³å‡å€¼ 123456789101112131415161718192021222324252627GET /shopping/_search&#123; &quot;size&quot;: 0, &quot;aggs&quot;: &#123; &quot;price_over_time&quot;: &#123; &quot;date_histogram&quot;: &#123; &quot;field&quot;: &quot;created_at&quot;, &quot;calendar_interval&quot;: &quot;day&quot; &#125;, &quot;aggs&quot;: &#123; &quot;daily_avg_price&quot;: &#123; &quot;avg&quot;: &#123; &quot;field&quot;: &quot;price&quot; &#125; &#125;, &quot;moving_avg_price&quot;: &#123; &quot;moving_fn&quot;: &#123; # å¯¹èšåˆç»“æœè¿›è¡Œç§»åŠ¨å¹³å‡å€¼æ“ä½œ &quot;buckets_path&quot;: &quot;daily_avg_price&quot;, # æŒ‡å®šè·¯å¾„ï¼Œå¯¹daily_avg_priceå­—æ®µè¿›è¡Œç§»åŠ¨å¹³å‡å€¼æ“ä½œ &quot;script&quot;: &quot;MovingFunctions.unweightedAvg(values)&quot;, # æŒ‡å®šè„šæœ¬ï¼Œè®¡ç®—ç§»åŠ¨å¹³å‡å€¼ &quot;window&quot;: 7, # çª—å£å¤§å°ï¼Œé»˜è®¤ä¸º 10 &quot;shift&quot;: 0 # çª—å£åç§»é‡ï¼Œé»˜è®¤ä¸º 0 &#125; &#125; &#125; &#125; &#125;&#125; ES èšåˆæ€§èƒ½ä¼˜åŒ– ç´¢å¼•é¢„æ’åº å¦‚æœæ˜¯ Elasticsearch 6.X ä¹‹åç‰ˆæœ¬ï¼Œå¯ä»¥åœ¨æ’å…¥æ•°æ®æ—¶å¯¹ç´¢å¼•è¿›è¡Œé¢„æ’åºï¼Œè€Œä¸æ˜¯åœ¨æŸ¥è¯¢æ—¶å†å¯¹ç´¢å¼•è¿›è¡Œæ’åºï¼Œè¿™å°†æé«˜èŒƒå›´æŸ¥è¯¢ï¼ˆrange queryï¼‰å’Œæ’åºæ“ä½œçš„æ€§èƒ½ã€‚ ä½†é¢„æ’åºå°†å¢åŠ  Elasticsearch å†™å…¥çš„æˆæœ¬ï¼Œå¯¼è‡´å¤§çº¦ 40%-50% çš„å†™æ€§èƒ½ä¸‹é™ï¼Œå¦‚æœåº”ç”¨åœºæ™¯æ˜¯æ›´å…³æ³¨å†™æ€§èƒ½çš„ä¸šåŠ¡ï¼Œå¼€å¯ç´¢å¼•é¢„æ’åºä¸æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ã€‚ 12345678910111213141516PUT /my_index&#123; &quot;settings&quot;: &#123; &quot;index&quot;:&#123; &quot;sort.field&quot;: &quot;create_time&quot;, &quot;sort.order&quot;: &quot;desc&quot; &#125; &#125;, &quot;mappings&quot;: &#123; &quot;properties&quot;: &#123; &quot;create_time&quot;:&#123; &quot;type&quot;: &quot;date&quot; &#125; &#125; &#125;&#125; ä½¿ç”¨åˆ†ç‰‡è¯·æ±‚ç¼“å­˜ èšåˆè¯­å¥ä¸­ï¼Œè®¾ç½®ï¼šsizeï¼š0ï¼Œå°±ä¼šä½¿ç”¨åˆ†ç‰‡è¯·æ±‚ç¼“å­˜ç¼“å­˜ç»“æœã€‚size = 0 çš„å«ä¹‰æ˜¯ï¼šåªè¿”å›èšåˆç»“æœï¼Œä¸è¿”å›æŸ¥è¯¢ç»“æœã€‚ 1234567891011GET /my_index/_search&#123; &quot;size&quot;: 0, &quot;aggs&quot;: &#123; &quot;remark_agg&quot;: &#123; &quot;terms&quot;: &#123; &quot;field&quot;: &quot;remark.keyword&quot; &#125; &#125; &#125;&#125; æ‹†åˆ†èšåˆï¼Œä½¿èšåˆå¹¶è¡ŒåŒ– Elasticsearch æŸ¥è¯¢æ¡ä»¶ä¸­åŒæ—¶æœ‰å¤šä¸ªæ¡ä»¶èšåˆï¼Œé»˜è®¤æƒ…å†µä¸‹èšåˆä¸æ˜¯å¹¶è¡Œè¿è¡Œçš„ã€‚ å½“ä¸ºæ¯ä¸ªèšåˆæä¾›è‡ªå·±çš„æŸ¥è¯¢å¹¶æ‰§è¡Œ msearch æ—¶ï¼Œæ€§èƒ½ä¼šæœ‰æ˜¾è‘—æå‡ã€‚ å› æ­¤ï¼Œåœ¨ CPU èµ„æºä¸æ˜¯ç“¶é¢ˆçš„å‰æä¸‹ï¼Œå¦‚æœæƒ³ç¼©çŸ­å“åº”æ—¶é—´ï¼Œå¯ä»¥å°†å¤šä¸ªèšåˆæ‹†åˆ†ä¸ºå¤šä¸ªæŸ¥è¯¢ï¼Œå€ŸåŠ©ï¼šmsearch å®ç°å¹¶è¡Œèšåˆã€‚ 1234567891011121314151617181920212223#å¸¸è§„çš„å¤šæ¡ä»¶èšåˆå®ç°GET /employees/_search&#123; &quot;size&quot;: 0, &quot;aggs&quot;: &#123; &quot;job_agg&quot;: &#123; &quot;terms&quot;: &#123; &quot;field&quot;: &quot;job.keyword&quot; &#125; &#125;, &quot;max_salary&quot;:&#123; &quot;max&quot;: &#123; &quot;field&quot;: &quot;salary&quot; &#125; &#125; &#125;&#125;# msearch æ‹†åˆ†å¤šä¸ªè¯­å¥çš„èšåˆå®ç°GET _msearch&#123;&quot;index&quot;:&quot;employees&quot;&#125;&#123;&quot;size&quot;:0,&quot;aggs&quot;:&#123;&quot;job_agg&quot;:&#123;&quot;terms&quot;:&#123;&quot;field&quot;: &quot;job.keyword&quot;&#125;&#125;&#125;&#125;&#123;&quot;index&quot;:&quot;employees&quot;&#125;&#123;&quot;size&quot;:0,&quot;aggs&quot;:&#123;&quot;max_salary&quot;:&#123;&quot;max&quot;:&#123;&quot;field&quot;: &quot;salary&quot;&#125;&#125;&#125;&#125;","summary":"æ‘˜è¦ æœ¬æ–‡ä»‹ç» Elasticsearch çš„ REST APIsï¼šèšåˆæŸ¥è¯¢ Elasticsearchç‰ˆæœ¬8.17.3 å®˜æ–¹æ–‡æ¡£:REST APIs å®˜æ–¹æ–‡æ¡£:Aggregations Elasticsearch çš„ REST APIs","date_published":"2025-04-22T13:30:05.000Z","tags":["æŠ€æœ¯","elastic","elasticsearch","elasticsearch"]},{"id":"https://blog.hanqunfeng.com/2025/04/17/elasticsearch-05-api/","url":"https://blog.hanqunfeng.com/2025/04/17/elasticsearch-05-api/","title":"Elasticsearch çš„ REST APIs","content_html":"<!--\n **åŠ ç²—**\n *æ–œä½“*\n ***åŠ ç²—å¹¶æ–œä½“***\n ~~åˆ é™¤çº¿~~\n ==çªå‡ºæ˜¾ç¤º==\n `çªå‡ºæ˜¾ç¤º(æ¨è)`\n ++ä¸‹åˆ’çº¿++\n ~ä¸‹æ ‡~\n ^ä¸Šæ ‡^\n è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference.\n å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)\n\n +++ **ç‚¹å‡»æŠ˜å **\n è¿™æ˜¯è¢«éšè—çš„å†…å®¹\n +++\n\n::: tips success warning danger\nè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹\n:::\n\n% note info % success warning danger\nè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹\n% endnote %\n\nå¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{}\n å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ\n -->\n<h2 id=\"æ‘˜è¦\">æ‘˜è¦</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æœ¬æ–‡ä»‹ç» Elasticsearch çš„ REST APIs</p>\n</li>\n<li class=\"lvl-2\">\n<p>Elasticsearchç‰ˆæœ¬8.17.3</p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/8.17/rest-apis.html\">å®˜æ–¹æ–‡æ¡£:REST APIs</a></p>\n</li>\n<li class=\"lvl-2\">\n<a href=\"/2025/04/22/elasticsearch-06-api-aggs/\" title=\"Elasticsearch çš„ REST APIs:èšåˆæŸ¥è¯¢\">Elasticsearch çš„ REST APIs:èšåˆæŸ¥è¯¢</a>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"è¿”å›å†…å®¹æ ¼å¼åŒ–\">è¿”å›å†…å®¹æ ¼å¼åŒ–</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>è¿”å›jsonä¿¡æ¯æ ¼å¼: <code>?pretty</code> è¾“å‡ºæ ¼å¼åŒ–åçš„jsonï¼Œæ¯”å¦‚ï¼š<code>curl http://localhost:9200/_cluster/health?pretty</code></p>\n</li>\n<li class=\"lvl-2\">\n<p>è¿”å›è¡Œä¿¡æ¯æ ¼å¼: <code>?v</code> è¾“å‡ºå†…å®¹ä¸Šæ–¹ä¼šåŠ ä¸Šæ ‡é¢˜è¡Œï¼Œæ¯”å¦‚ï¼š<code>curl http://localhost:9200/_cat/health?v</code></p>\n</li>\n</ul>\n<h2 id=\"CAT-APIs\">CAT APIs</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Elasticsearch æä¾›äº† <a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/8.17/cat.html\">CAT APIs</a>ï¼Œå®ƒä»¬æä¾›äº†ä¸€ç§ç®€å•çš„æ–¹å¼æ¥æŸ¥çœ‹é›†ç¾¤çŠ¶æ€å’Œé›†ç¾¤ä¸­çš„å„ç§èµ„æºï¼Œæ¯”å¦‚ç´¢å¼•ã€åˆ†ç‰‡ã€èŠ‚ç‚¹ç­‰ã€‚</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET     /_cat/health             <span class=\"comment\">#æŸ¥çœ‹é›†ç¾¤å½“å‰çŠ¶æ€ï¼šçº¢ã€é»„ã€ç»¿</span></span><br><span class=\"line\">GET     /_cat/master             <span class=\"comment\">#æŸ¥çœ‹masterèŠ‚ç‚¹ä¿¡æ¯</span></span><br><span class=\"line\">GET     /_cat/nodes              <span class=\"comment\">#æŸ¥çœ‹æ‰€æœ‰èŠ‚ç‚¹ä¿¡æ¯</span></span><br><span class=\"line\">GET     /_cat/plugins            <span class=\"comment\">#æŸ¥çœ‹é›†ç¾¤å„ä¸ªèŠ‚ç‚¹ä¸Šçš„pluginä¿¡æ¯</span></span><br><span class=\"line\">GET     /_cat/indices            <span class=\"comment\">#æŸ¥çœ‹é›†ç¾¤ä¸­æ‰€æœ‰indexçš„è¯¦ç»†ä¿¡æ¯</span></span><br><span class=\"line\">GET     /_cat/indices/&#123;index&#125;    <span class=\"comment\">#æŸ¥çœ‹é›†ç¾¤ä¸­æŒ‡å®šindexçš„è¯¦ç»†ä¿¡æ¯ï¼Œindexï¼šç´¢å¼•åç§°</span></span><br><span class=\"line\">GET     /_cat/allocation         <span class=\"comment\">#æŸ¥çœ‹å•èŠ‚ç‚¹çš„shardåˆ†é…æ•´ä½“æƒ…å†µ</span></span><br><span class=\"line\">GET     /_cat/shards             <span class=\"comment\">#æŸ¥çœ‹å„shardçš„è¯¦ç»†æƒ…å†µ</span></span><br><span class=\"line\">GET     /_cat/shards/&#123;index&#125;     <span class=\"comment\">#æŸ¥çœ‹æŒ‡å®šåˆ†ç‰‡çš„è¯¦ç»†æƒ…å†µ</span></span><br><span class=\"line\">GET     /_cat/segments           <span class=\"comment\">#æŸ¥çœ‹å„indexçš„segmentè¯¦ç»†ä¿¡æ¯,åŒ…æ‹¬segmentå, æ‰€å±shard, å†…å­˜(ç£ç›˜)å ç”¨å¤§å°, æ˜¯å¦åˆ·ç›˜</span></span><br><span class=\"line\">GET     /_cat/segments/&#123;index&#125;   <span class=\"comment\">#æŸ¥çœ‹æŒ‡å®šindexçš„segmentè¯¦ç»†ä¿¡æ¯</span></span><br><span class=\"line\">GET     /_cat/count              <span class=\"comment\">#æŸ¥çœ‹å½“å‰é›†ç¾¤çš„docæ•°é‡</span></span><br><span class=\"line\">GET     /_cat/count/&#123;index&#125;      <span class=\"comment\">#æŸ¥çœ‹æŒ‡å®šç´¢å¼•çš„docæ•°é‡</span></span><br><span class=\"line\">GET     /_cat/recovery           <span class=\"comment\">#æŸ¥çœ‹é›†ç¾¤å†…æ¯ä¸ªshardçš„recoveryè¿‡ç¨‹.è°ƒæ•´replicaã€‚</span></span><br><span class=\"line\">GET     /_cat/recovery/&#123;index&#125;   <span class=\"comment\">#æŸ¥çœ‹æŒ‡å®šç´¢å¼•shardçš„recoveryè¿‡ç¨‹</span></span><br><span class=\"line\">GET     /_cat/pending_tasks      <span class=\"comment\">#æŸ¥çœ‹å½“å‰é›†ç¾¤çš„pending task</span></span><br><span class=\"line\">GET     /_cat/aliases            <span class=\"comment\">#æŸ¥çœ‹é›†ç¾¤ä¸­æ‰€æœ‰aliasä¿¡æ¯,è·¯ç”±é…ç½®ç­‰</span></span><br><span class=\"line\">GET     /_cat/aliases/&#123;<span class=\"built_in\">alias</span>&#125;    <span class=\"comment\">#æŸ¥çœ‹æŒ‡å®šç´¢å¼•çš„aliasä¿¡æ¯</span></span><br><span class=\"line\">GET     /_cat/thread_pool        <span class=\"comment\">#æŸ¥çœ‹é›†ç¾¤å„èŠ‚ç‚¹å†…éƒ¨ä¸åŒç±»å‹çš„threadpoolçš„ç»Ÿè®¡ä¿¡æ¯,</span></span><br><span class=\"line\">GET     /_cat/fielddata          <span class=\"comment\">#æŸ¥çœ‹å½“å‰é›†ç¾¤å„ä¸ªèŠ‚ç‚¹çš„fielddataå†…å­˜ä½¿ç”¨æƒ…å†µ</span></span><br><span class=\"line\">GET     /_cat/fielddata/&#123;fields&#125; <span class=\"comment\">#æŸ¥çœ‹æŒ‡å®šfieldçš„å†…å­˜ä½¿ç”¨æƒ…å†µ,é‡Œé¢ä¼ fieldå±æ€§å¯¹åº”çš„å€¼</span></span><br><span class=\"line\">GET     /_cat/nodeattrs          <span class=\"comment\">#æŸ¥çœ‹å•èŠ‚ç‚¹çš„è‡ªå®šä¹‰å±æ€§</span></span><br><span class=\"line\">GET     /_cat/repositories       <span class=\"comment\">#è¾“å‡ºé›†ç¾¤ä¸­æ³¨å†Œå¿«ç…§å­˜å‚¨åº“</span></span><br><span class=\"line\">GET     /_cat/templates          <span class=\"comment\">#è¾“å‡ºå½“å‰æ­£åœ¨å­˜åœ¨çš„æ¨¡æ¿ä¿¡æ¯</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"Cluster-APIs\">Cluster APIs</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Elasticsearch æä¾›äº†ä¸€ç³»åˆ—çš„ <a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/8.17/cluster.html\">Cluster APIs</a>ï¼Œå®ƒä»¬æä¾›äº†ç®¡ç†å’Œç›‘æ§é›†ç¾¤çŠ¶æ€çš„åŠŸèƒ½</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET     /_cluster/health            <span class=\"comment\"># è·å–é›†ç¾¤çš„å¥åº·çŠ¶æ€ä¿¡æ¯ï¼ŒåŒ…æ‹¬äº†é›†ç¾¤æ€»ä½“çš„çŠ¶å†µå¦‚statusã€number_of_nodesç­‰ã€‚</span></span><br><span class=\"line\">GET     /_cluster/stats             <span class=\"comment\"># æä¾›æ•´ä¸ªé›†ç¾¤å±‚é¢çš„ç»Ÿè®¡ä¿¡æ¯ï¼ŒåŒ…å«ç´¢å¼•ã€èŠ‚ç‚¹å’Œå…¶ä»–é«˜çº§æŒ‡æ ‡ã€‚</span></span><br><span class=\"line\">GET     /_cluster/state             <span class=\"comment\"># æ˜¾ç¤ºé›†ç¾¤å…ƒæ•°æ®çš„çŠ¶æ€ï¼ŒåŒ…æ‹¬è®¾ç½®ã€å—ã€è·¯ç”±è¡¨åŠå…ƒæ•°æ®ç­‰ï¼Œå…è®¸ç”¨æˆ·æŸ¥çœ‹é›†ç¾¤çš„å½“å‰è§†å›¾ã€‚</span></span><br><span class=\"line\">POST    /_cluster/reroute           <span class=\"comment\"># POSTè¯·æ±‚ï¼Œç”¨äºæ‰‹åŠ¨æ”¹å˜åˆ†ç‰‡åˆ†é…æƒ…å†µï¼Œå¯ä»¥å®ç°å¦‚è¿ç§»åˆ†ç‰‡ã€å–æ¶ˆåˆ†é…ç­‰æ“ä½œã€‚</span></span><br><span class=\"line\">GET     /_cluster/nodes/hot_threads <span class=\"comment\"># è¿”å›é›†ç¾¤ä¸­å„ä¸ªèŠ‚ç‚¹â€œæœ€çƒ­â€çš„çº¿ç¨‹å †æ ˆè·Ÿè¸ªï¼Œé»˜è®¤æ˜¾ç¤ºå‰ä¸‰ä¸ªCPUæ—¶é—´æœ€é•¿çš„çº¿ç¨‹ã€‚</span></span><br><span class=\"line\">GET     /_cluster/allocation/explain <span class=\"comment\"># è§£é‡Šä¸ºä½•æŸä¸ªåˆ†ç‰‡è¢«å¦‚æ­¤åˆ†é…ï¼Œå¹¶æä¾›å¦‚ä½•è°ƒæ•´çš„å»ºè®®ã€‚</span></span><br><span class=\"line\">GET     /_cluster/pending_tasks     <span class=\"comment\"># åˆ—å‡ºæ‰€æœ‰ç­‰å¾…æ‰§è¡Œçš„ä»»åŠ¡åˆ—è¡¨ã€‚</span></span><br><span class=\"line\">GET     /_cluster/settings          <span class=\"comment\"># æŸ¥çœ‹æ•´ä¸ªé›†ç¾¤çº§åˆ«çš„è®¾ç½®ã€‚</span></span><br><span class=\"line\">PUT     /_cluster/settings          <span class=\"comment\"># æ›´æ–°æ•´ä¸ªé›†ç¾¤çº§åˆ«çš„è®¾ç½®ã€‚</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"Index-APIs\">Index APIs</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Elasticsearch æä¾›äº† <a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/8.17/indices.html\">Index APIs</a>ï¼Œå®ƒä»¬æä¾›äº†å¯¹ç´¢å¼•çš„åˆ›å»ºã€æ›´æ–°ã€æŸ¥è¯¢å’Œåˆ é™¤ç­‰æ“ä½œã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>åˆ›å»ºç´¢å¼•</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># PUT /&lt;target&gt;</span></span><br><span class=\"line\"><span class=\"comment\"># è¿™é‡Œ shopping ä¸ºç´¢å¼•åç§°ï¼Œä½†æ­¤æ—¶æ²¡æœ‰ä¸ºç´¢å¼•è®¾ç½®åˆ†ç‰‡ç­–ç•¥ï¼Œä¹Ÿæ²¡æœ‰è®¾ç½®å­—æ®µä¿¡æ¯</span></span><br><span class=\"line\">curl -X PUT -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># è¿”å›å€¼</span></span><br><span class=\"line\">&#123;<span class=\"string\">&quot;acknowledged&quot;</span>:<span class=\"literal\">true</span>,<span class=\"string\">&quot;shards_acknowledged&quot;</span>:<span class=\"literal\">true</span>,<span class=\"string\">&quot;index&quot;</span>:<span class=\"string\">&quot;shopping&quot;</span>&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åˆ›å»ºç´¢å¼•å¹¶è®¾ç½®ç´¢å¼•</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># PUT /&lt;target&gt;</span></span><br><span class=\"line\">curl -X PUT -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;&quot;settings&quot;:&#123;&quot;number_of_shards&quot;:&quot;1&quot;,&quot;number_of_replicas&quot;:&quot;2&quot;&#125;&#125;&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># è¿”å›å€¼</span></span><br><span class=\"line\">&#123;<span class=\"string\">&quot;acknowledged&quot;</span>:<span class=\"literal\">true</span>,<span class=\"string\">&quot;shards_acknowledged&quot;</span>:<span class=\"literal\">true</span>,<span class=\"string\">&quot;index&quot;</span>:<span class=\"string\">&quot;shopping&quot;</span>&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åˆ›å»ºå¹¶æ˜ å°„ç´¢å¼•</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># PUT /&lt;target&gt;</span></span><br><span class=\"line\"><span class=\"comment\"># è¿™é‡Œè®¾ç½®ç´¢å¼•åˆ†ç‰‡æ•°é‡ä¸º1ï¼Œå‰¯æœ¬æ•°é‡ä¸º2ï¼Œå¹¶è®¾ç½®å­—æ®µä¿¡æ¯</span></span><br><span class=\"line\">curl -X PUT -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;settings&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;number_of_shards&quot;:&quot;1&quot;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;number_of_replicas&quot;:&quot;2&quot;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;mappings&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;properties&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;title&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">          &quot;type&quot;:&quot;text&quot;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;category&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">          &quot;type&quot;:&quot;keyword&quot;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;price&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">          &quot;type&quot;:&quot;double&quot;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;count&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">          &quot;type&quot;:&quot;integer&quot;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;</span></span><br><span class=\"line\"><span class=\"string\">      &#125;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">  &#125;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># å‚æ•°è¯´æ˜</span></span><br><span class=\"line\"><span class=\"comment\">## settings: è¿™ä¸ªå‚æ•°ç”¨äºé…ç½®ç´¢å¼•çš„è®¾ç½®ï¼ŒåŒ…æ‹¬åˆ†ç‰‡æ•°é‡å’Œå‰¯æœ¬æ•°é‡ã€‚</span></span><br><span class=\"line\"><span class=\"comment\">### number_of_shards: è¿™ä¸ªå‚æ•°æŒ‡å®šäº†ç´¢å¼•ä¸­åˆ†ç‰‡çš„æ•°é‡ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œnumber_of_shards è®¾ç½®ä¸º 1ï¼Œæ„å‘³ç€ç´¢å¼•å°†åªæœ‰ä¸€ä¸ªä¸»åˆ†ç‰‡ã€‚</span></span><br><span class=\"line\"><span class=\"comment\">### number_of_replicas: è¿™ä¸ªå‚æ•°æŒ‡å®šäº†æ¯ä¸ªä¸»åˆ†ç‰‡çš„å‰¯æœ¬æ•°é‡ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œnumber_of_replicas è®¾ç½®ä¸º 2ï¼Œæ„å‘³ç€æ¯ä¸ªä¸»åˆ†ç‰‡å°†æœ‰ä¸¤ä¸ªå‰¯æœ¬ã€‚</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## mappings: è¿™ä¸ªå‚æ•°ç”¨äºå®šä¹‰ç´¢å¼•ä¸­çš„å­—æ®µå’Œå­—æ®µç±»å‹ã€‚</span></span><br><span class=\"line\"><span class=\"comment\">### properties: è¿™ä¸ªå‚æ•°å®šä¹‰äº†ç´¢å¼•ä¸­çš„å­—æ®µå’Œå­—æ®µç±»å‹ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæœ‰å››ä¸ªå­—æ®µï¼štitleã€categoryã€images å’Œ priceã€‚</span></span><br><span class=\"line\"><span class=\"comment\">### title: è¿™ä¸ªå­—æ®µçš„ç±»å‹æ˜¯ textï¼Œè¡¨ç¤ºå®ƒæ˜¯ä¸€ä¸ªå…¨æ–‡æ£€ç´¢å­—æ®µã€‚text é€‚åˆå­˜å‚¨é•¿æ–‡æœ¬æ•°æ®ï¼Œå¹¶æ”¯æŒå…¨æ–‡æœç´¢ã€‚</span></span><br><span class=\"line\"><span class=\"comment\">### category: è¿™ä¸ªå­—æ®µçš„ç±»å‹æ˜¯ keywordï¼Œè¡¨ç¤ºå®ƒæ˜¯ä¸€ä¸ªå…³é”®å­—å­—æ®µï¼Œä¸æ”¯æŒå…¨æ–‡æ£€ç´¢ã€‚keyword é€‚åˆå­˜å‚¨ä¸éœ€è¦åˆ†è¯çš„çŸ­æ–‡æœ¬æ•°æ®ï¼ˆå¦‚æ ‡ç­¾ã€ç±»åˆ«ç­‰ï¼‰ï¼Œå¹¶ä¸”å¯ä»¥ç”¨äºèšåˆå’Œè¿‡æ»¤ã€‚</span></span><br><span class=\"line\"><span class=\"comment\">### price: è¿™ä¸ªå­—æ®µçš„ç±»å‹æ˜¯ doubleï¼Œè¡¨ç¤ºå®ƒæ˜¯ä¸€ä¸ªæ•°å­—å­—æ®µã€‚double è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªåŒç²¾åº¦æµ®ç‚¹æ•°å­—æ®µï¼Œé€‚åˆå­˜å‚¨æ•°å€¼æ•°æ®ï¼Œå¦‚ä»·æ ¼</span></span><br><span class=\"line\"><span class=\"comment\">### count: è¿™ä¸ªå­—æ®µçš„ç±»å‹æ˜¯ integerï¼Œè¡¨ç¤ºå®ƒæ˜¯ä¸€ä¸ªæ•´æ•°å­—æ®µã€‚integer è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªæ•´æ•°å­—æ®µï¼Œé€‚åˆå­˜å‚¨æ•´æ•°æ•°æ®ï¼Œå¦‚å•†å“æ•°é‡ç­‰ã€‚</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># è¿”å›å€¼</span></span><br><span class=\"line\">&#123;<span class=\"string\">&quot;acknowledged&quot;</span>:<span class=\"literal\">true</span>,<span class=\"string\">&quot;shards_acknowledged&quot;</span>:<span class=\"literal\">true</span>,<span class=\"string\">&quot;index&quot;</span>:<span class=\"string\">&quot;shopping&quot;</span>&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æ›´æ–°ç´¢å¼•æ˜ å°„</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># PUT /&lt;target&gt;/_mapping</span></span><br><span class=\"line\"><span class=\"comment\"># æ³¨æ„è¯¥apiåªèƒ½å¢åŠ æ–°çš„å­—æ®µï¼Œä¸èƒ½ä¿®æ”¹å·²æœ‰å­—æ®µï¼Œå¦‚æœè¦ä¿®æ”¹æºå­—æ®µç±»å‹æˆ–è€…åˆ†è¯å™¨ç±»å‹ï¼Œä¸‹æ–‡ä¼šä»‹ç»</span></span><br><span class=\"line\">curl -X PUT -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_mapping&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;properties&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;remark&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;type&quot;:&quot;text&quot;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;analyzer&quot;:&quot;ik_max_word&quot;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;search_analyzer&quot;:&quot;ik_smart&quot;</span></span><br><span class=\"line\"><span class=\"string\">      &#125;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;address&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;type&quot;: &quot;text&quot;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;analyzer&quot;: &quot;ik_max_word&quot;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;fields&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">          &quot;keyword&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">            &quot;type&quot;: &quot;keyword&quot;</span></span><br><span class=\"line\"><span class=\"string\">          &#125;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;</span></span><br><span class=\"line\"><span class=\"string\">      &#125;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;tags&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;type&quot;: &quot;keyword&quot;</span></span><br><span class=\"line\"><span class=\"string\">      &#125;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;created_at&quot;: &#123;&quot;type&quot;: &quot;date&quot;, &quot;format&quot;: &quot;yyyy-MM-dd HH:mm:ss&quot;&#125;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">  &#125;&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># å‚æ•°è¯´æ˜</span></span><br><span class=\"line\"><span class=\"comment\"># è¿™é‡Œä¸ºç´¢å¼•æ·»åŠ äº†4ä¸ªå­—æ®µ</span></span><br><span class=\"line\"><span class=\"comment\"># remarkï¼šæ–°å¢å­—æ®µï¼Œç±»å‹ä¸ºtextï¼Œåˆ†è¯å™¨ä¸ºik_max_wordï¼Œæœç´¢åˆ†è¯å™¨ä¸ºik_smart</span></span><br><span class=\"line\">  <span class=\"comment\"># analyzer: ç´¢å¼•åˆ†è¯å™¨</span></span><br><span class=\"line\">  <span class=\"comment\"># search_analyzerï¼šæœç´¢åˆ†è¯å™¨</span></span><br><span class=\"line\">  <span class=\"comment\"># ik_max_wordï¼šä¸­æ–‡åˆ†è¯å™¨ï¼Œå°†å¥å­æ‹†åˆ†ä¸ºæœ€å¤šè¯å…ƒï¼Œé€‚åˆé•¿å¥å­</span></span><br><span class=\"line\">  <span class=\"comment\"># ik_smartï¼šä¸­æ–‡åˆ†è¯å™¨ï¼Œå°†å¥å­æ‹†åˆ†ä¸ºæœ€å°‘è¯å…ƒï¼Œé€‚åˆçŸ­å¥å­</span></span><br><span class=\"line\"><span class=\"comment\"># addressï¼šæ–°å¢å­—æ®µï¼Œç±»å‹ä¸ºtextï¼Œåˆ†è¯å™¨ä¸ºik_max_wordï¼Œæœç´¢åˆ†è¯å™¨æœªæŒ‡å®šï¼Œé»˜è®¤ä¸åˆ†è¯å™¨åŒä¸€ä¸ªï¼Œè¿™é‡Œè¿˜ä¸ºaddressæ·»åŠ äº†keywordå­—æ®µï¼Œç”¨äºå­˜å‚¨åŸå§‹æ•°æ®ï¼Œä»¥æ”¯æŒç²¾ç¡®æœç´¢</span></span><br><span class=\"line\"><span class=\"comment\"># tagsï¼šæ–°å¢å­—æ®µï¼Œç±»å‹ä¸ºkeywordï¼Œä¸æ”¯æŒåˆ†è¯ï¼Œé€‚åˆå­˜å‚¨çŸ­æ–‡æœ¬æ•°æ®ï¼ˆå¦‚æ ‡ç­¾ã€ç±»åˆ«ç­‰ï¼‰ï¼Œå¹¶ä¸”å¯ä»¥ç”¨äºèšåˆå’Œè¿‡æ»¤ï¼Œå¯ä»¥å­˜å‚¨æ•°ç»„</span></span><br><span class=\"line\"><span class=\"comment\"># created_atï¼šæ–°å¢å­—æ®µï¼Œç±»å‹ä¸ºdateï¼Œæ ¼å¼ä¸ºyyyy-MM-dd HH:mm:ss</span></span><br><span class=\"line\"><span class=\"comment\"># è¿”å›å€¼</span></span><br><span class=\"line\">&#123;<span class=\"string\">&quot;acknowledged&quot;</span>:<span class=\"literal\">true</span>&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æ›´æ–°ç´¢å¼•è®¾ç½®</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># PUT /&lt;target&gt;/_settings</span></span><br><span class=\"line\"><span class=\"comment\"># æ³¨æ„è¿™é‡Œä¸èƒ½æ›´æ–°number_of_shards</span></span><br><span class=\"line\">curl -X PUT -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_settings&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;&quot;number_of_replicas&quot;:&quot;1&quot;&#125;&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># è¿”å›å€¼</span></span><br><span class=\"line\">&#123;<span class=\"string\">&quot;acknowledged&quot;</span>:<span class=\"literal\">true</span>&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æŸ¥çœ‹æŒ‡å®šç´¢å¼•</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># GET /&lt;target&gt;</span></span><br><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping?pretty&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># è¿”å›å€¼</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;shopping&quot;</span> : &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;aliases&quot;</span> : &#123; &#125;,</span><br><span class=\"line\">    <span class=\"string\">&quot;mappings&quot;</span> : &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;properties&quot;</span> : &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;address&quot;</span> : &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;text&quot;</span>,</span><br><span class=\"line\">          <span class=\"string\">&quot;fields&quot;</span> : &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;keyword&quot;</span> : &#123;</span><br><span class=\"line\">              <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;keyword&quot;</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;,</span><br><span class=\"line\">          <span class=\"string\">&quot;analyzer&quot;</span> : <span class=\"string\">&quot;ik_max_word&quot;</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;category&quot;</span> : &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;keyword&quot;</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;count&quot;</span> : &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;integer&quot;</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;created_at&quot;</span> : &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;date&quot;</span>,</span><br><span class=\"line\">          <span class=\"string\">&quot;format&quot;</span> : <span class=\"string\">&quot;yyyy-MM-dd HH:mm:ss&quot;</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;price&quot;</span> : &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;double&quot;</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;remark&quot;</span> : &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;text&quot;</span>,</span><br><span class=\"line\">          <span class=\"string\">&quot;analyzer&quot;</span> : <span class=\"string\">&quot;ik_max_word&quot;</span>,</span><br><span class=\"line\">          <span class=\"string\">&quot;search_analyzer&quot;</span> : <span class=\"string\">&quot;ik_smart&quot;</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;tags&quot;</span> : &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;keyword&quot;</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;title&quot;</span> : &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;text&quot;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">&quot;settings&quot;</span> : &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;index&quot;</span> : &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;routing&quot;</span> : &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;allocation&quot;</span> : &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;include&quot;</span> : &#123;</span><br><span class=\"line\">              <span class=\"string\">&quot;_tier_preference&quot;</span> : <span class=\"string\">&quot;data_content&quot;</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;number_of_shards&quot;</span> : <span class=\"string\">&quot;1&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;provided_name&quot;</span> : <span class=\"string\">&quot;shopping&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;creation_date&quot;</span> : <span class=\"string\">&quot;1745291743120&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;number_of_replicas&quot;</span> : <span class=\"string\">&quot;1&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;uuid&quot;</span> : <span class=\"string\">&quot;Y1IWrdlQTUm-CbbIWweSxQ&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;version&quot;</span> : &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;created&quot;</span> : <span class=\"string\">&quot;8525000&quot;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æŸ¥çœ‹ç´¢å¼•è®¾ç½®</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># GET /&lt;target&gt;/_settings</span></span><br><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_settings?pretty&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># è¿”å›å€¼</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;shopping&quot;</span> : &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;mappings&quot;</span> : &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;properties&quot;</span> : &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;address&quot;</span> : &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;text&quot;</span>,</span><br><span class=\"line\">          <span class=\"string\">&quot;fields&quot;</span> : &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;keyword&quot;</span> : &#123;</span><br><span class=\"line\">              <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;keyword&quot;</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;,</span><br><span class=\"line\">          <span class=\"string\">&quot;analyzer&quot;</span> : <span class=\"string\">&quot;ik_max_word&quot;</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;category&quot;</span> : &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;keyword&quot;</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;count&quot;</span> : &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;integer&quot;</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;created_at&quot;</span> : &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;date&quot;</span>,</span><br><span class=\"line\">          <span class=\"string\">&quot;format&quot;</span> : <span class=\"string\">&quot;yyyy-MM-dd HH:mm:ss&quot;</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;price&quot;</span> : &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;double&quot;</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;remark&quot;</span> : &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;text&quot;</span>,</span><br><span class=\"line\">          <span class=\"string\">&quot;analyzer&quot;</span> : <span class=\"string\">&quot;ik_max_word&quot;</span>,</span><br><span class=\"line\">          <span class=\"string\">&quot;search_analyzer&quot;</span> : <span class=\"string\">&quot;ik_smart&quot;</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;tags&quot;</span> : &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;keyword&quot;</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;title&quot;</span> : &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;text&quot;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æŸ¥çœ‹å­—æ®µæ˜ å°„</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># GET /&lt;target&gt;/_mapping/field/&lt;field&gt;</span></span><br><span class=\"line\"><span class=\"comment\"># shopping ä¸ºç´¢å¼•åç§°ï¼Œtitle ä¸ºå­—æ®µåç§°</span></span><br><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_mapping/field/title?pretty&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># è¿”å›å€¼</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;shopping&quot;</span> : &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;mappings&quot;</span> : &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;title&quot;</span> : &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;full_name&quot;</span> : <span class=\"string\">&quot;title&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;mapping&quot;</span> : &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;title&quot;</span> : &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;text&quot;</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åˆ¤æ–­ç´¢å¼•æ˜¯å¦å­˜åœ¨</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨ -I å‚æ•°æ¥å‘é€ HEAD è¯·æ±‚ï¼Œå¯ä»¥è·å–å“åº”å¤´è€Œä¸å¿…ä¸‹è½½å“åº”ä½“ã€‚</span></span><br><span class=\"line\"><span class=\"comment\"># HEAD /&lt;target&gt;</span></span><br><span class=\"line\">curl -I -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># è¿”å›å€¼</span></span><br><span class=\"line\">HTTP/1.1 200 OK</span><br><span class=\"line\">X-elastic-product: Elasticsearch</span><br><span class=\"line\">content-type: application/json</span><br><span class=\"line\">content-length: 603</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># è¿™ä¸ªå‘½ä»¤ä¸ä¼šè¿”å›å“åº”ä½“ï¼Œä½†å®ƒçš„ HTTP å“åº”ä»£ç å¯ä»¥å‘Šè¯‰ä½ ç´¢å¼•çš„å­˜åœ¨æƒ…å†µï¼š</span></span><br><span class=\"line\">  <span class=\"comment\"># 200 OK è¡¨ç¤ºç´¢å¼•å­˜åœ¨ã€‚</span></span><br><span class=\"line\">  <span class=\"comment\"># 404 Not Found è¡¨ç¤ºç´¢å¼•ä¸å­˜åœ¨ã€‚</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åˆ é™¤ç´¢å¼•</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># DELETE /&lt;target&gt;</span></span><br><span class=\"line\">curl -X DELETE -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># è¿”å›å€¼</span></span><br><span class=\"line\">&#123;<span class=\"string\">&quot;acknowledged&quot;</span>:<span class=\"literal\">true</span>&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ä¸ºç´¢å¼•åˆ›å»ºåˆ«å</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># æ³¨æ„ï¼šä¸åŒç´¢å¼•å¯ä»¥æœ‰ç›¸åŒåç§°çš„åˆ«åï¼Œæ‰€ä»¥åœ¨æ•°æ®ç»“æ„ä¸€è‡´çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºä¸åŒçš„ç´¢å¼•åˆ›å»ºç›¸åŒçš„åˆ«åï¼Œç„¶åæ ¹æ®åˆ«åè¿›è¡Œæ•°æ®æŸ¥è¯¢</span></span><br><span class=\"line\"><span class=\"comment\"># POST /&lt;target&gt;/_alias/&lt;alias&gt;</span></span><br><span class=\"line\">curl -X POST -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_alias/shopping_alias&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># è¿”å›å€¼</span></span><br><span class=\"line\">&#123;<span class=\"string\">&quot;acknowledged&quot;</span>:<span class=\"literal\">true</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ä¹Ÿå¯ä»¥ä½¿ç”¨å¦‚ä¸‹æ–¹æ³•</span></span><br><span class=\"line\">curl -X POST -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/_aliases&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;actions&quot;: [</span></span><br><span class=\"line\"><span class=\"string\">      &#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;add&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">          &quot;index&quot;: &quot;shopping&quot;,</span></span><br><span class=\"line\"><span class=\"string\">          &quot;alias&quot;: &quot;shopping_alias2&quot;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;</span></span><br><span class=\"line\"><span class=\"string\">      &#125;</span></span><br><span class=\"line\"><span class=\"string\">    ]</span></span><br><span class=\"line\"><span class=\"string\">  &#125;&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># è¿”å›å€¼</span></span><br><span class=\"line\">&#123;<span class=\"string\">&quot;acknowledged&quot;</span>:<span class=\"literal\">true</span>&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æŸ¥çœ‹ç´¢å¼•åˆ«å</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># GET /&lt;target&gt;/_alias/&lt;alias&gt;</span></span><br><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_alias/shopping_alias?pretty&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># è¿”å›å€¼</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;shopping&quot;</span> : &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;aliases&quot;</span> : &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;shopping_alias&quot;</span> : &#123; &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹å½“å‰ç´¢å¼•çš„æ‰€æœ‰åˆ«å</span></span><br><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_alias?pretty&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹æ‰€æœ‰ç´¢å¼•çš„åˆ«å</span></span><br><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/_alias?pretty&#x27;</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ä¸ºç´¢å¼•åˆ é™¤åˆ«å</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># DELETE /&lt;target&gt;/_alias/&lt;alias&gt;</span></span><br><span class=\"line\">curl -X DELETE -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_alias/shopping_alias&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># è¿”å›å€¼</span></span><br><span class=\"line\">&#123;<span class=\"string\">&quot;acknowledged&quot;</span>:<span class=\"literal\">true</span>&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"å¦‚ä½•ä¿®æ”¹ç´¢å¼•å­—æ®µç±»å‹æˆ–åˆ†è¯å™¨ç±»å‹ï¼Ÿ\">å¦‚ä½•ä¿®æ”¹ç´¢å¼•å­—æ®µç±»å‹æˆ–åˆ†è¯å™¨ç±»å‹ï¼Ÿ</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åˆ›å»ºæ–°çš„ç´¢å¼•</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># è¿™é‡Œä¸ºtitleå­—æ®µå¢åŠ åˆ†è¯å™¨</span></span><br><span class=\"line\">curl -X PUT -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping_new&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;settings&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;number_of_shards&quot;:&quot;1&quot;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;number_of_replicas&quot;:&quot;2&quot;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;mappings&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;properties&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;category&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">          &quot;type&quot;:&quot;keyword&quot;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;price&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">          &quot;type&quot;:&quot;double&quot;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;count&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">          &quot;type&quot;:&quot;integer&quot;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;title&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">          &quot;type&quot;:&quot;text&quot;,</span></span><br><span class=\"line\"><span class=\"string\">          &quot;analyzer&quot;:&quot;ik_max_word&quot;,</span></span><br><span class=\"line\"><span class=\"string\">          &quot;search_analyzer&quot;:&quot;ik_smart&quot;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;remark&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;type&quot;:&quot;text&quot;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;analyzer&quot;:&quot;ik_max_word&quot;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;search_analyzer&quot;:&quot;ik_smart&quot;</span></span><br><span class=\"line\"><span class=\"string\">      &#125;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;address&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;type&quot;: &quot;text&quot;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;analyzer&quot;: &quot;ik_max_word&quot;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;fields&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">          &quot;keyword&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">            &quot;type&quot;: &quot;keyword&quot;</span></span><br><span class=\"line\"><span class=\"string\">          &#125;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;</span></span><br><span class=\"line\"><span class=\"string\">      &#125;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;tags&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;type&quot;: &quot;keyword&quot;</span></span><br><span class=\"line\"><span class=\"string\">      &#125;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;created_at&quot;: &#123;&quot;type&quot;: &quot;date&quot;, &quot;format&quot;: &quot;yyyy-MM-dd HH:mm:ss&quot;&#125;</span></span><br><span class=\"line\"><span class=\"string\">      &#125;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">  &#125;&#x27;</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å°†åŸç´¢å¼•çš„æ•°æ®è¿ç§»åˆ°æ–°ç´¢å¼•</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -X POST -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/_reindex&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">  &quot;source&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;index&quot;: &quot;shopping&quot;</span></span><br><span class=\"line\"><span class=\"string\">  &#125;,</span></span><br><span class=\"line\"><span class=\"string\">  &quot;dest&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;index&quot;: &quot;shopping_new&quot;</span></span><br><span class=\"line\"><span class=\"string\">  &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#125;&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># è¿”å›å€¼</span></span><br><span class=\"line\">&#123;<span class=\"string\">&quot;took&quot;</span>:101,<span class=\"string\">&quot;timed_out&quot;</span>:<span class=\"literal\">false</span>,<span class=\"string\">&quot;total&quot;</span>:2,<span class=\"string\">&quot;updated&quot;</span>:0,<span class=\"string\">&quot;created&quot;</span>:2,<span class=\"string\">&quot;deleted&quot;</span>:0,<span class=\"string\">&quot;batches&quot;</span>:1,<span class=\"string\">&quot;version_conflicts&quot;</span>:0,<span class=\"string\">&quot;noops&quot;</span>:0,<span class=\"string\">&quot;retries&quot;</span>:&#123;<span class=\"string\">&quot;bulk&quot;</span>:0,<span class=\"string\">&quot;search&quot;</span>:0&#125;,<span class=\"string\">&quot;throttled_millis&quot;</span>:0,<span class=\"string\">&quot;requests_per_second&quot;</span>:-1.0,<span class=\"string\">&quot;throttled_until_millis&quot;</span>:0,<span class=\"string\">&quot;failures&quot;</span>:[]&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åˆ é™¤åŸç´¢å¼•</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -X DELETE -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># è¿”å›å€¼</span></span><br><span class=\"line\">&#123;<span class=\"string\">&quot;acknowledged&quot;</span>:<span class=\"literal\">true</span>&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ä¸ºæ–°ç´¢å¼•åˆ›å»ºåˆ«å</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -X POST -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping_new/_alias/shopping&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># è¿”å›å€¼</span></span><br><span class=\"line\">&#123;<span class=\"string\">&quot;acknowledged&quot;</span>:<span class=\"literal\">true</span>,<span class=\"string\">&quot;errors&quot;</span>:<span class=\"literal\">false</span>&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"æ•°æ®å¢åˆ æ”¹åŸºæœ¬æ“ä½œ\">æ•°æ®å¢åˆ æ”¹åŸºæœ¬æ“ä½œ</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æ–°å¢æ•°æ®</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-4\">1.ä¸ºæŒ‡å®šç´¢å¼•æ’å…¥ä¸€æ¡æ•°æ®(_docæ–¹å¼ï¼šä¸æŒ‡å®šidé»˜è®¤éšæœºå­—ç¬¦ä¸²)</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># _doc çš„æ–¹å¼åˆ›å»ºç´¢å¼•æ•°æ®æ—¶ï¼Œå¯ä»¥ä¸æŒ‡å®šidï¼Œé»˜è®¤ä¼šåˆ›å»ºæ–°çš„idï¼Œidç±»å‹ä¸ºéšæœºå­—ç¬¦ä¸²</span></span><br><span class=\"line\"><span class=\"comment\"># POST /&lt;target&gt;/_doc</span></span><br><span class=\"line\">curl -X POST -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_doc?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;category&quot;: &quot;electronics&quot;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;price&quot;: 999.99,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;count&quot;: 10,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;title&quot;: &quot;Smartphone X - 128GB&quot;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;remark&quot;: &quot;This latest Smartphone X comes with a powerful processor and high-resolution camera.&quot;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;address&quot;: &quot;123 Electronic Ave, Beijing, China&quot;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;tags&quot;: [&quot;latest&quot;, &quot;smartphone&quot;, &quot;technology&quot;],</span></span><br><span class=\"line\"><span class=\"string\">    &quot;created_at&quot;: &quot;2025-04-22 03:30:02&quot;</span></span><br><span class=\"line\"><span class=\"string\">  &#125;&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># è¿”å›å€¼</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;_index&quot;</span> : <span class=\"string\">&quot;shopping_new&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;_id&quot;</span> : <span class=\"string\">&quot;sImNW5YBmgASmV9McVvI&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;_version&quot;</span> : 1,</span><br><span class=\"line\">  <span class=\"string\">&quot;result&quot;</span> : <span class=\"string\">&quot;created&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;_shards&quot;</span> : &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;total&quot;</span> : 3,</span><br><span class=\"line\">    <span class=\"string\">&quot;successful&quot;</span> : 1,</span><br><span class=\"line\">    <span class=\"string\">&quot;failed&quot;</span> : 0</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;_seq_no&quot;</span> : 1,</span><br><span class=\"line\">  <span class=\"string\">&quot;_primary_term&quot;</span> : 1</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-2\">\n<li class=\"lvl-4\">2.ä¸ºæŒ‡å®šç´¢å¼•æ’å…¥ä¸€æ¡æ•°æ®(_docæ–¹å¼ï¼šæŒ‡å®šid)</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># _doc çš„æ–¹å¼åˆ›å»ºç´¢å¼•æ•°æ®æ—¶ï¼Œå¦‚æœæŒ‡å®šidï¼Œå†æ¬¡æ‰§è¡Œæ—¶ä¼šå…ˆåˆ é™¤åŸæ•°æ®å†åˆ›å»ºæ–°æ•°æ®ï¼Œæ‰€ä»¥å¿…é¡»å…¨é‡æ›´æ–°æ‰è¡Œã€‚</span></span><br><span class=\"line\"><span class=\"comment\"># PUT /&lt;target&gt;/_doc</span></span><br><span class=\"line\">curl -X PUT -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_doc/100?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;category&quot;: &quot;electronics&quot;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;price&quot;: 999.99,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;count&quot;: 10,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;title&quot;: &quot;Smartphone X - 128GB&quot;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;remark&quot;: &quot;This latest Smartphone X comes with a powerful processor and high-resolution camera.&quot;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;address&quot;: &quot;123 Electronic Ave, Beijing, China&quot;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;tags&quot;: [&quot;latest&quot;, &quot;smartphone&quot;, &quot;technology&quot;],</span></span><br><span class=\"line\"><span class=\"string\">    &quot;created_at&quot;: &quot;2025-04-22 03:30:02&quot;</span></span><br><span class=\"line\"><span class=\"string\">  &#125;&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># è¿”å›å€¼</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;_index&quot;</span> : <span class=\"string\">&quot;shopping_new&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;_id&quot;</span> : <span class=\"string\">&quot;100&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;_version&quot;</span> : 1,</span><br><span class=\"line\">  <span class=\"string\">&quot;result&quot;</span> : <span class=\"string\">&quot;created&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;_shards&quot;</span> : &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;total&quot;</span> : 3,</span><br><span class=\"line\">    <span class=\"string\">&quot;successful&quot;</span> : 1,</span><br><span class=\"line\">    <span class=\"string\">&quot;failed&quot;</span> : 0</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;_seq_no&quot;</span> : 2,</span><br><span class=\"line\">  <span class=\"string\">&quot;_primary_term&quot;</span> : 1</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-2\">\n<li class=\"lvl-4\">\n<p>3.ä¸ºæŒ‡å®šç´¢å¼•æ’å…¥ä¸€æ¡æ•°æ®(_createæ–¹å¼ï¼šæŒ‡å®šid)</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># _create çš„æ–¹å¼åˆ›å»ºç´¢å¼•æ•°æ®æ—¶ï¼Œå¿…é¡»æŒ‡å®šid,è€Œä¸”åªèƒ½æ‰§è¡Œä¸€æ¬¡ï¼Œå› ä¸ºæ‰§è¡Œè¿‡ä¸€æ¬¡åæŒ‡å®šidçš„æ•°æ®å°±å­˜åœ¨äº†ï¼Œä¸èƒ½å†æ¬¡åˆ›å»º</span></span><br><span class=\"line\"><span class=\"comment\"># POST /&lt;target&gt;/_create/&lt;id&gt;</span></span><br><span class=\"line\">curl -X POST -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_create/1?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;category&quot;: &quot;electronics&quot;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;price&quot;: 999.99,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;count&quot;: 10,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;title&quot;: &quot;Smartphone X - 128GB&quot;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;remark&quot;: &quot;This latest Smartphone X comes with a powerful processor and high-resolution camera.&quot;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;address&quot;: &quot;123 Electronic Ave, Beijing, China&quot;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;tags&quot;: [&quot;latest&quot;, &quot;smartphone&quot;, &quot;technology&quot;],</span></span><br><span class=\"line\"><span class=\"string\">    &quot;created_at&quot;: &quot;2025-04-22 03:30:02&quot;</span></span><br><span class=\"line\"><span class=\"string\">  &#125;&#x27;</span></span><br></pre></td></tr></table></figure>\n</li>\n<li class=\"lvl-2\">\n<p>ä¿®æ”¹æ•°æ®</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-4\">1.ä¿®æ”¹å…¨éƒ¨æ•°æ®</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># POST /&lt;target&gt;/_doc/&lt;id&gt;</span></span><br><span class=\"line\"><span class=\"comment\"># æ‰§è¡Œæ—¶ä¼šå…ˆåˆ é™¤åŸæ•°æ®å†åˆ›å»ºæ–°æ•°æ®ï¼Œæ‰€ä»¥å¿…é¡»å…¨é‡æ›´æ–°æ‰è¡Œã€‚</span></span><br><span class=\"line\">curl -X POST -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_doc/sImNW5YBmgASmV9McVvI&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;category&quot;: &quot;electronics&quot;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;price&quot;: 999.99,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;count&quot;: 20,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;title&quot;: &quot;Smartphone X - 128GB&quot;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;remark&quot;: &quot;This latest Smartphone X comes with a powerful processor and high-resolution camera.&quot;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;address&quot;: &quot;123 Electronic Ave, Beijing, China&quot;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;tags&quot;: [&quot;latest&quot;, &quot;smartphone&quot;, &quot;technology&quot;],</span></span><br><span class=\"line\"><span class=\"string\">    &quot;created_at&quot;: &quot;2025-04-22 03:30:02&quot;</span></span><br><span class=\"line\"><span class=\"string\">  &#125;&#x27;</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-2\">\n<li class=\"lvl-4\">2.ä¿®æ”¹éƒ¨åˆ†æ•°æ®</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># POST /&lt;target&gt;/_update/&lt;id&gt;</span></span><br><span class=\"line\"><span class=\"comment\"># æ‰§è¡Œæ—¶åªä¼šä¿®æ”¹æŒ‡å®šå­—æ®µï¼Œä¸ä¼šåˆ é™¤åŸæ•°æ®ï¼Œæ‰€ä»¥å¯ä»¥éƒ¨åˆ†æ›´æ–°ã€‚</span></span><br><span class=\"line\">curl -X POST -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_update/1&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;&quot;doc&quot;:&#123;&quot;count&quot;:100&#125;&#125;&#x27;</span></span><br></pre></td></tr></table></figure>\n</li>\n<li class=\"lvl-2\">\n<p>æŸ¥è¯¢æŒ‡å®šç´¢å¼•çš„æŒ‡å®šidçš„æ•°æ®</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># GET /&lt;target&gt;/_doc/&lt;id&gt;</span></span><br><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_doc/100?pretty&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># è¿”å›å€¼</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;_index&quot;</span> : <span class=\"string\">&quot;shopping_new&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;_id&quot;</span> : <span class=\"string\">&quot;100&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;_version&quot;</span> : 1,</span><br><span class=\"line\">  <span class=\"string\">&quot;_seq_no&quot;</span> : 2,</span><br><span class=\"line\">  <span class=\"string\">&quot;_primary_term&quot;</span> : 1,</span><br><span class=\"line\">  <span class=\"string\">&quot;found&quot;</span> : <span class=\"literal\">true</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;_source&quot;</span> : &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;category&quot;</span> : <span class=\"string\">&quot;electronics&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;price&quot;</span> : 999.99,</span><br><span class=\"line\">    <span class=\"string\">&quot;count&quot;</span> : 10,</span><br><span class=\"line\">    <span class=\"string\">&quot;title&quot;</span> : <span class=\"string\">&quot;Smartphone X - 128GB&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;remark&quot;</span> : <span class=\"string\">&quot;This latest Smartphone X comes with a powerful processor and high-resolution camera.&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;address&quot;</span> : <span class=\"string\">&quot;123 Electronic Ave, Beijing, China&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;tags&quot;</span> : [</span><br><span class=\"line\">      <span class=\"string\">&quot;latest&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;smartphone&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;technology&quot;</span></span><br><span class=\"line\">    ],</span><br><span class=\"line\">    <span class=\"string\">&quot;created_at&quot;</span> : <span class=\"string\">&quot;2025-04-22 03:30:02&quot;</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åˆ é™¤æŒ‡å®šç´¢å¼•çš„æŒ‡å®šidçš„æ•°æ®</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># DELETE /&lt;target&gt;/_doc/&lt;id&gt;</span></span><br><span class=\"line\">curl -X DELETE -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_doc/100&#x27;</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åˆ é™¤ç´¢å¼•å…¨éƒ¨æ•°æ®</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -X POST -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_delete_by_query?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;&quot;query&quot;:&#123;&quot;match_all&quot;:&#123;&#125;&#125;&#125;&#x27;</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"æ‰¹é‡æ“ä½œ\">æ‰¹é‡æ“ä½œ</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æ‰¹é‡æ–°å¢æ•°æ®</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># æ³¨æ„æ•°æ®è¡Œè¦é¡¶è¡Œå†™ï¼Œå‰é¢ä¸è¦æœ‰ç©ºæ ¼</span></span><br><span class=\"line\"><span class=\"comment\"># POST /_bulk</span></span><br><span class=\"line\">curl -X POST -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/_bulk&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123; &quot;index&quot;: &#123; &quot;_index&quot;: &quot;shopping&quot;, &quot;_id&quot;: &quot;1&quot; &#125; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;category&quot;: &quot;electronics&quot;, &quot;price&quot;: 999.99, &quot;count&quot;: 10, &quot;title&quot;: &quot;Smartphone X - 128GB&quot;, &quot;remark&quot;: &quot;This latest Smartphone X comes with a powerful processor and high-resolution camera.&quot;, &quot;address&quot;: &quot;å¹¿å·å¤©æ²³å…¬å›­&quot;, &quot;tags&quot;: [&quot;latest&quot;, &quot;smartphone&quot;, &quot;technology&quot;], &quot;created_at&quot;: &quot;2025-04-22 03:30:02&quot; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;index&quot;: &#123; &quot;_index&quot;: &quot;shopping&quot;, &quot;_id&quot;: &quot;2&quot; &#125; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;category&quot;: &quot;fashion&quot;, &quot;price&quot;: 49.99, &quot;count&quot;: 25, &quot;title&quot;: &quot;Designer T-shirt&quot;, &quot;remark&quot;: &quot;Trendy designer T-shirt made with high quality fabric.&quot;, &quot;address&quot;: &quot;å¹¿å·è”æ¹¾å¤§å¦&quot;, &quot;tags&quot;: [&quot;clothing&quot;, &quot;designer&quot;, &quot;style&quot;], &quot;created_at&quot;: &quot;2025-04-21 12:15:00&quot; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;index&quot;: &#123; &quot;_index&quot;: &quot;shopping&quot;, &quot;_id&quot;: &quot;3&quot; &#125; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;category&quot;: &quot;home_appliances&quot;, &quot;price&quot;: 299.99, &quot;count&quot;: 5, &quot;title&quot;: &quot;Robot Vacuum Cleaner&quot;, &quot;remark&quot;: &quot;Efficient robot vacuum cleaner with smart navigation.&quot;, &quot;address&quot;: &quot;å¹¿å·ç™½äº‘å±±å…¬å›­&quot;, &quot;tags&quot;: [&quot;appliances&quot;, &quot;vacuum&quot;, &quot;robot&quot;], &quot;created_at&quot;: &quot;2025-04-20 08:45:30&quot; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;index&quot;: &#123; &quot;_index&quot;: &quot;shopping&quot;, &quot;_id&quot;: &quot;4&quot; &#125; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;category&quot;: &quot;books&quot;, &quot;price&quot;: 19.99, &quot;count&quot;: 100, &quot;title&quot;: &quot;Inspirational Novel&quot;, &quot;remark&quot;: &quot;A gripping novel that inspires and motivates.&quot;, &quot;address&quot;: &quot;321 Book Rd, Shenzhen, China&quot;, &quot;tags&quot;: [&quot;book&quot;, &quot;novel&quot;, &quot;inspiration&quot;], &quot;created_at&quot;: &quot;2025-04-19 10:05:00&quot; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;index&quot;: &#123; &quot;_index&quot;: &quot;shopping&quot;, &quot;_id&quot;: &quot;5&quot; &#125; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;category&quot;: &quot;groceries&quot;, &quot;price&quot;: 3.99, &quot;count&quot;: 200, &quot;title&quot;: &quot;Organic Apples&quot;, &quot;remark&quot;: &quot;Fresh and crispy organic apples.&quot;, &quot;address&quot;: &quot;654 Grocery Ln, Chengdu, China&quot;, &quot;tags&quot;: [&quot;fruit&quot;, &quot;organic&quot;, &quot;healthy&quot;], &quot;created_at&quot;: &quot;2025-04-18 14:30:45&quot; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;index&quot;: &#123; &quot;_index&quot;: &quot;shopping&quot;, &quot;_id&quot;: &quot;6&quot; &#125; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;category&quot;: &quot;electronics&quot;, &quot;price&quot;: 1999.99, &quot;count&quot;: 15, &quot;title&quot;: &quot;Smartphone X - 256GB&quot;, &quot;remark&quot;: &quot;This latest Smartphone X comes with a powerful processor and high-resolution camera.&quot;, &quot;address&quot;: &quot;å¹¿å·å¤©æ²³å…¬å›­&quot;, &quot;tags&quot;: [&quot;latest&quot;, &quot;smartphone&quot;, &quot;technology&quot;], &quot;created_at&quot;: &quot;2025-04-22 03:30:02&quot; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># å‚æ•°è¯´æ˜</span></span><br><span class=\"line\"><span class=\"comment\"># index: ç”¨äºåˆ›å»ºæ–°æ–‡æ¡£æˆ–æ›¿æ¢å·²æœ‰æ–‡æ¡£ã€‚</span></span><br><span class=\"line\"><span class=\"comment\"># create: ç”¨äºåˆ›å»ºæ–°æ–‡æ¡£ï¼Œå¦‚æœæ–‡æ¡£å·²å­˜åœ¨ï¼Œåˆ™è¿”å›é”™è¯¯ã€‚</span></span><br><span class=\"line\"><span class=\"comment\"># _index: æŒ‡å®šç´¢å¼•åç§°ã€‚</span></span><br><span class=\"line\"><span class=\"comment\"># _id: æŒ‡å®šæ–‡æ¡£IDã€‚å¦‚æœä¸æŒ‡å®šåˆ™ä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªéšæœºçš„IDã€‚</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æ‰¹é‡æ–°å¢æ•°æ®æ—¶ä¹Ÿå¯ä»¥åœ¨urlä¸­æŒ‡å®šç´¢å¼•åç§°</span></span><br><span class=\"line\"><span class=\"comment\"># æ­¤æ—¶å¯ä»¥æŒ‡å®šidï¼Œå¦‚æœä¸æŒ‡å®šåˆ™è‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªéšæœºå­—ç¬¦ä¸²çš„ID</span></span><br><span class=\"line\"><span class=\"comment\"># POST /&lt;target&gt;/_bulk</span></span><br><span class=\"line\">curl -X POST -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_bulk&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123; &quot;index&quot;: &#123;&#125; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;category&quot;: &quot;electronics&quot;, &quot;price&quot;: 999.99, &quot;count&quot;: 10, &quot;title&quot;: &quot;Smartphone X - 128GB&quot;, &quot;remark&quot;: &quot;This latest Smartphone X comes with a powerful processor and high-resolution camera.&quot;, &quot;address&quot;: &quot;å¹¿å·å¤©æ²³å…¬å›­&quot;, &quot;tags&quot;: [&quot;latest&quot;, &quot;smartphone&quot;, &quot;technology&quot;], &quot;created_at&quot;: &quot;2025-04-22 03:30:02&quot; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;index&quot;: &#123;&#125; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;category&quot;: &quot;fashion&quot;, &quot;price&quot;: 49.99, &quot;count&quot;: 25, &quot;title&quot;: &quot;Designer T-shirt&quot;, &quot;remark&quot;: &quot;Trendy designer T-shirt made with high quality fabric.&quot;, &quot;address&quot;: &quot;å¹¿å·è”æ¹¾å¤§å¦&quot;, &quot;tags&quot;: [&quot;clothing&quot;, &quot;designer&quot;, &quot;style&quot;], &quot;created_at&quot;: &quot;2025-04-21 12:15:00&quot; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;index&quot;: &#123;&#125; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;category&quot;: &quot;home_appliances&quot;, &quot;price&quot;: 299.99, &quot;count&quot;: 5, &quot;title&quot;: &quot;Robot Vacuum Cleaner&quot;, &quot;remark&quot;: &quot;Efficient robot vacuum cleaner with smart navigation.&quot;, &quot;address&quot;: &quot;å¹¿å·ç™½äº‘å±±å…¬å›­&quot;, &quot;tags&quot;: [&quot;appliances&quot;, &quot;vacuum&quot;, &quot;robot&quot;], &quot;created_at&quot;: &quot;2025-04-20 08:45:30&quot; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;index&quot;: &#123;&#125; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;category&quot;: &quot;books&quot;, &quot;price&quot;: 19.99, &quot;count&quot;: 100, &quot;title&quot;: &quot;Inspirational Novel&quot;, &quot;remark&quot;: &quot;A gripping novel that inspires and motivates.&quot;, &quot;address&quot;: &quot;321 Book Rd, Shenzhen, China&quot;, &quot;tags&quot;: [&quot;book&quot;, &quot;novel&quot;, &quot;inspiration&quot;], &quot;created_at&quot;: &quot;2025-04-19 10:05:00&quot; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;index&quot;: &#123;&#125; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;category&quot;: &quot;groceries&quot;, &quot;price&quot;: 3.99, &quot;count&quot;: 200, &quot;title&quot;: &quot;Organic Apples&quot;, &quot;remark&quot;: &quot;Fresh and crispy organic apples.&quot;, &quot;address&quot;: &quot;654 Grocery Ln, Chengdu, China&quot;, &quot;tags&quot;: [&quot;fruit&quot;, &quot;organic&quot;, &quot;healthy&quot;], &quot;created_at&quot;: &quot;2025-04-18 14:30:45&quot; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;index&quot;: &#123;&#125; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;category&quot;: &quot;electronics&quot;, &quot;price&quot;: 1999.99, &quot;count&quot;: 15, &quot;title&quot;: &quot;Smartphone X - 256GB&quot;, &quot;remark&quot;: &quot;This latest Smartphone X comes with a powerful processor and high-resolution camera.&quot;, &quot;address&quot;: &quot;å¹¿å·å¤©æ²³å…¬å›­&quot;, &quot;tags&quot;: [&quot;latest&quot;, &quot;smartphone&quot;, &quot;technology&quot;], &quot;created_at&quot;: &quot;2025-04-22 03:30:02&quot; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#x27;</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æ‰¹é‡ä¿®æ”¹æ•°æ®</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># æ³¨æ„æ•°æ®è¡Œè¦é¡¶è¡Œå†™ï¼Œå‰é¢ä¸è¦æœ‰ç©ºæ ¼</span></span><br><span class=\"line\">curl -X POST -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/_bulk&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;&quot;update&quot;:&#123;&quot;_index&quot;:&quot;shopping&quot;,&quot;_id&quot;:&quot;1&quot;&#125;&#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123;&quot;doc&quot;:&#123;&quot;title&quot;:&quot;Smartphone X2 - 128GB&quot;,&quot;price&quot;:1000.11&#125;&#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123;&quot;update&quot;:&#123;&quot;_index&quot;:&quot;shopping&quot;,&quot;_id&quot;:&quot;2&quot;&#125;&#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123;&quot;doc&quot;:&#123;&quot;title&quot;:&quot;T-shirt&quot;,&quot;price&quot;:45.99&#125;&#125;</span></span><br><span class=\"line\"><span class=\"string\">&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># å‚æ•°è¯´æ˜</span></span><br><span class=\"line\"><span class=\"comment\"># update: ç”¨äºæ›´æ–°æ–‡æ¡£ã€‚</span></span><br><span class=\"line\"><span class=\"comment\"># doc: æŒ‡å®šè¦æ›´æ–°çš„å­—æ®µã€‚</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æ‰¹é‡åˆ é™¤æ•°æ®</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># æ³¨æ„æ•°æ®è¡Œè¦é¡¶è¡Œå†™ï¼Œå‰é¢ä¸è¦æœ‰ç©ºæ ¼</span></span><br><span class=\"line\">curl -X POST -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/_bulk&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;&quot;delete&quot;:&#123;&quot;_index&quot;:&quot;shopping&quot;,&quot;_id&quot;:&quot;1&quot;&#125;&#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123;&quot;delete&quot;:&#123;&quot;_index&quot;:&quot;shopping&quot;,&quot;_id&quot;:&quot;2&quot;&#125;&#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123;&quot;delete&quot;:&#123;&quot;_index&quot;:&quot;shopping&quot;,&quot;_id&quot;:&quot;3&quot;&#125;&#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123;&quot;delete&quot;:&#123;&quot;_index&quot;:&quot;shopping&quot;,&quot;_id&quot;:&quot;4&quot;&#125;&#125;</span></span><br><span class=\"line\"><span class=\"string\">&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># å‚æ•°è¯´æ˜</span></span><br><span class=\"line\"><span class=\"comment\"># delete: ç”¨äºåˆ é™¤æ–‡æ¡£ã€‚</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"æ¡ä»¶æ›´æ–°\">æ¡ä»¶æ›´æ–°</h2>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># POST /&lt;target&gt;/_update_by_query</span></span><br><span class=\"line\"><span class=\"comment\"># è¿™é‡Œå°†categoryä¸ºåä¸ºçš„æ•°æ®ä»·æ ¼æ”¹ä¸º1999</span></span><br><span class=\"line\">curl -X POST -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_update_by_query?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;query&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;match&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;category&quot;: &quot;books&quot;</span></span><br><span class=\"line\"><span class=\"string\">      &#125;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;script&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;source&quot;: &quot;ctx._source.price = 20.99&quot;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;lang&quot;: &quot;painless&quot;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">  &#125;&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># å‚æ•°è¯´æ˜</span></span><br><span class=\"line\"><span class=\"comment\">## &quot;query&quot;: &#123;&#125;  æŸ¥è¯¢æ¡ä»¶</span></span><br><span class=\"line\"><span class=\"comment\">## &quot;script&quot;: &#123;&#125;  è„šæœ¬</span></span><br><span class=\"line\"><span class=\"comment\">### source: è„šæœ¬å†…å®¹</span></span><br><span class=\"line\"><span class=\"comment\">### lang: è„šæœ¬è¯­è¨€</span></span><br><span class=\"line\"><span class=\"comment\">#### painless æ˜¯ Elasticsearch å®˜æ–¹æä¾›çš„è„šæœ¬è¯­è¨€ï¼Œå®ƒæä¾›äº†è®¸å¤šå†…ç½®å‡½æ•°å’Œå˜é‡ï¼Œå¯ä»¥æ–¹ä¾¿åœ°å®ç°å„ç§å¤æ‚çš„é€»è¾‘æ“ä½œã€‚https://www.elastic.co/guide/en/elasticsearch/painless/current/painless-lang-spec.html</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"æ¡ä»¶åˆ é™¤\">æ¡ä»¶åˆ é™¤</h2>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># POST /&lt;target&gt;/_delete_by_query</span></span><br><span class=\"line\">curl -X POST -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_delete_by_query?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;&quot;query&quot;:&#123;&quot;match&quot;:&#123;&quot;category&quot;:&quot;books&quot;&#125;&#125;&#125;&#x27;</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"æ¡ä»¶æŸ¥è¯¢\">æ¡ä»¶æŸ¥è¯¢</h2>\n<h3 id=\"match-all-å…¨éƒ¨åŒ¹é…æŸ¥è¯¢\">match_all: å…¨éƒ¨åŒ¹é…æŸ¥è¯¢</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># GET /&lt;target&gt;/_search</span></span><br><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span></span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;&quot;query&quot;:&#123;&quot;match_all&quot;:&#123;&#125;&#125;&#125;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æˆ–è€…ç®€å†™ä¸º</span></span><br><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"term-ç²¾ç¡®åŒ¹é…æŸ¥è¯¢ï¼ˆå…³é”®å­—æŸ¥è¯¢ï¼Œå³ä¸åˆ†è¯ï¼‰\">term: ç²¾ç¡®åŒ¹é…æŸ¥è¯¢ï¼ˆå…³é”®å­—æŸ¥è¯¢ï¼Œå³ä¸åˆ†è¯ï¼‰</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;&quot;query&quot;:&#123;&quot;term&quot;:&#123;&quot;category&quot;:&quot;electronics&quot;&#125;&#125;&#125;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># å¦‚æœå­—æ®µè¢«é¢å¤–è®¾ç½® keyword ç±»å‹ï¼Œåˆ™éœ€è¦åŠ ä¸Š .keyword åç¼€</span></span><br><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;&quot;query&quot;:&#123;&quot;term&quot;:&#123;&quot;address.keyword&quot;:&quot;å¹¿å·ç™½äº‘å±±å…¬å›­&quot;&#125;&#125;&#125;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># termå¤„ç†å¤šå€¼å­—æ®µ(æ•°ç»„)æ—¶ï¼ŒtermæŸ¥è¯¢æ˜¯åŒ…å«ï¼Œä¸æ˜¯ç­‰äº</span></span><br><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;&quot;query&quot;:&#123;&quot;term&quot;:&#123;&quot;tags&quot;:&quot;technology&quot;&#125;&#125;&#125;&#x27;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"terms-å¤šå…³é”®å­—ç²¾ç¡®åŒ¹é…æŸ¥è¯¢\">terms: å¤šå…³é”®å­—ç²¾ç¡®åŒ¹é…æŸ¥è¯¢</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;&quot;query&quot;:&#123;&quot;terms&quot;:&#123;&quot;category&quot;:[&quot;electronics&quot;,&quot;books&quot;]&#125;&#125;&#125;&#x27;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"range-èŒƒå›´æŸ¥è¯¢\">range: èŒƒå›´æŸ¥è¯¢</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;&quot;query&quot;:&#123;&quot;range&quot;:&#123;&quot;price&quot;:&#123;&quot;gte&quot;:20,&quot;lte&quot;:30&#125;&#125;&#125;&#125;&#x27;</span></span><br><span class=\"line\">  <span class=\"comment\"># gte: å¤§äºç­‰äº</span></span><br><span class=\"line\">  <span class=\"comment\"># lte: å°äºç­‰äº</span></span><br><span class=\"line\">  <span class=\"comment\"># gt: å¤§äº</span></span><br><span class=\"line\">  <span class=\"comment\"># lt: å°äº</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æ—¶é—´èŒƒå›´æŸ¥è¯¢</span></span><br><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;&quot;query&quot;:&#123;&quot;range&quot;:&#123;&quot;created_at&quot;:&#123;&quot;gte&quot;:&quot;2025-04-20 00:00:00&quot;,&quot;lte&quot;:&quot;2025-05-20 23:59:59&quot;&#125;&#125;&#125;&#125;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># åŸºäºæ—¥æœŸæ•°å­¦è¡¨è¾¾å¼æŸ¥è¯¢</span></span><br><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;&quot;query&quot;:&#123;&quot;range&quot;:&#123;&quot;created_at&quot;:&#123;&quot;gte&quot;:&quot;now-1y&quot;&#125;&#125;&#125;&#125;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æ”¯æŒçš„æ—¥æœŸè¡¨è¾¾å¼</span></span><br><span class=\"line\"><span class=\"comment\"># - nowï¼šå½“å‰æ—¶é—´ç‚¹ã€‚</span></span><br><span class=\"line\"><span class=\"comment\"># - now-1dï¼šä»å½“å‰æ—¶é—´ç‚¹å‘å‰æ¨1å¤©çš„æ—¶é—´ç‚¹ã€‚</span></span><br><span class=\"line\"><span class=\"comment\"># - now-1wï¼šä»å½“å‰æ—¶é—´ç‚¹å‘å‰æ¨1å‘¨çš„æ—¶é—´ç‚¹ã€‚</span></span><br><span class=\"line\"><span class=\"comment\"># - now-1Mï¼šä»å½“å‰æ—¶é—´ç‚¹å‘å‰æ¨1ä¸ªæœˆçš„æ—¶é—´ç‚¹ã€‚</span></span><br><span class=\"line\"><span class=\"comment\"># - now-1yï¼šä»å½“å‰æ—¶é—´ç‚¹å‘å‰æ¨1å¹´çš„æ—¶é—´ç‚¹ã€‚</span></span><br><span class=\"line\"><span class=\"comment\"># - now+1hï¼šä»å½“å‰æ—¶é—´ç‚¹å‘åæ¨1å°æ—¶çš„æ—¶é—´ç‚¹ã€‚</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"exists-æŸ¥è¯¢å­—æ®µå­˜åœ¨çš„æ•°æ®\">exists: æŸ¥è¯¢å­—æ®µå­˜åœ¨çš„æ•°æ®</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;&quot;query&quot;:&#123;&quot;exists&quot;:&#123;&quot;field&quot;:&quot;title&quot;&#125;&#125;&#125;&#x27;</span></span><br><span class=\"line\">  <span class=\"comment\"># field: æŒ‡å®šè¦æŸ¥è¯¢çš„å­—æ®µ</span></span><br><span class=\"line\">  <span class=\"comment\"># ç¤ºä¾‹ï¼šæŸ¥è¯¢ title å­—æ®µå­˜åœ¨çš„æ–‡æ¡£</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"ids-æ ¹æ®ä¸€ç»„IDæŸ¥è¯¢\">ids: æ ¹æ®ä¸€ç»„IDæŸ¥è¯¢</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;&quot;query&quot;:&#123;&quot;ids&quot;:&#123;&quot;values&quot;:[&quot;1&quot;,&quot;2&quot;]&#125;&#125;&#125;&#x27;</span></span><br><span class=\"line\">  <span class=\"comment\"># values: æŒ‡å®šè¦æŸ¥è¯¢çš„IDåˆ—è¡¨</span></span><br><span class=\"line\">  <span class=\"comment\"># ç¤ºä¾‹ï¼šæŸ¥è¯¢IDä¸º1å’Œ2çš„æ–‡æ¡£</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"prefix-å‰ç¼€æŸ¥è¯¢\">prefix: å‰ç¼€æŸ¥è¯¢</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ä»…é€‚ç”¨äºå…³é”®å­—ç±»å‹(keyword)çš„å­—æ®µ</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;&quot;query&quot;:&#123;&quot;prefix&quot;:&#123;&quot;category&quot;:&quot;elec&quot;&#125;&#125;&#125;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ä»…é€‚ç”¨äºkeywordç±»å‹å­—æ®µï¼Œæ‰€ä»¥ä¸‹é¢è¿™ä¸ªè¯·æ±‚æŸ¥è¯¢ä¸åˆ°æ•°æ®</span></span><br><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;&quot;query&quot;:&#123;&quot;prefix&quot;:&#123;&quot;address&quot;:&quot;å¹¿å·ç™½äº‘å±±&quot;&#125;&#125;&#125;&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># å› ä¸ºaddressè¢«é™„åŠ äº†keywordç±»å‹ï¼Œæ‰€ä»¥éœ€è¦åŠ ä¸Š.keywordåç¼€åå¯ä»¥æŸ¥è¯¢åˆ°æ•°æ®</span></span><br><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;&quot;query&quot;:&#123;&quot;prefix&quot;:&#123;&quot;address.keyword&quot;:&quot;å¹¿å·ç™½äº‘å±±&quot;&#125;&#125;&#125;&#x27;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"wildcard-é€šé…ç¬¦æŸ¥è¯¢\">wildcard: é€šé…ç¬¦æŸ¥è¯¢</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ä»…é€‚ç”¨äºå…³é”®å­—ç±»å‹(keyword)çš„å­—æ®µ</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;&quot;query&quot;:&#123;&quot;wildcard&quot;:&#123;&quot;category&quot;:&quot;e?e*&quot;&#125;&#125;&#125;&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># ?: ä»»æ„å•ä¸ªå­—ç¬¦</span></span><br><span class=\"line\"><span class=\"comment\"># *: ä»»æ„å¤šä¸ªå­—ç¬¦</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"regexp-æ­£åˆ™è¡¨è¾¾å¼æŸ¥è¯¢\">regexp: æ­£åˆ™è¡¨è¾¾å¼æŸ¥è¯¢</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ä»…é€‚ç”¨äºå…³é”®å­—ç±»å‹(keyword)çš„å­—æ®µ</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;&quot;query&quot;:&#123;&quot;regexp&quot;:&#123;&quot;category&quot;:&quot;e.e.*&quot;&#125;&#125;&#125;&#x27;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"fuzzy-æ”¯æŒç¼–è¾‘è·ç¦»çš„æ¨¡ç³ŠæŸ¥è¯¢\">fuzzy: æ”¯æŒç¼–è¾‘è·ç¦»çš„æ¨¡ç³ŠæŸ¥è¯¢</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ä»…é€‚ç”¨äºå…³é”®å­—ç±»å‹(keyword)çš„å­—æ®µ</p>\n</li>\n<li class=\"lvl-2\">\n<p>fuzzyæ£€ç´¢æ˜¯ä¸€ç§å¼ºå¤§çš„æœç´¢åŠŸèƒ½ï¼Œå®ƒèƒ½å¤Ÿåœ¨ç”¨æˆ·è¾“å…¥å†…å®¹å­˜åœ¨æ‹¼å†™é”™è¯¯æˆ–ä¸Šä¸‹æ–‡ä¸ä¸€è‡´æ—¶ï¼Œä»ç„¶è¿”å›ä¸æœç´¢è¯ç›¸ä¼¼çš„æ–‡æ¡£ã€‚é€šè¿‡ä½¿ç”¨ç¼–è¾‘è·ç¦»ç®—æ³•æ¥åº¦é‡è¾“å…¥è¯ä¸æ–‡æ¡£ä¸­è¯æ¡çš„ç›¸ä¼¼ç¨‹åº¦ï¼Œæ¨¡ç³ŠæŸ¥è¯¢åœ¨ä¿è¯æœç´¢ç»“æœç›¸å…³æ€§çš„åŒæ—¶ï¼Œæœ‰æ•ˆåœ°æé«˜äº†æœç´¢å®¹é”™èƒ½åŠ›ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>ç¼–è¾‘è·ç¦»æ˜¯æŒ‡ä»ä¸€ä¸ªå•è¯è½¬æ¢åˆ°å¦ä¸€ä¸ªå•è¯éœ€è¦ç¼–è¾‘å•å­—ç¬¦çš„æ¬¡æ•°ã€‚å¦‚ä¸­æ–‡é›†å›¢åˆ°ä¸­å¨é›†å›¢ç¼–è¾‘è·ç¦»å°±æ˜¯1ï¼Œåªéœ€è¦ä¿®æ”¹ä¸€ä¸ªå­—ç¬¦ï¼›å¦‚æœfuzzinesså€¼åœ¨è¿™é‡Œè®¾ç½®æˆ2ï¼Œä¼šæŠŠç¼–è¾‘è·ç¦»ä¸º2çš„ä¸œä¸œé›†å›¢ä¹ŸæŸ¥å‡ºæ¥ã€‚</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;query&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;fuzzy&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">          &quot;category&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">            &quot;value&quot;:&quot;beeks&quot;,</span></span><br><span class=\"line\"><span class=\"string\">            &quot;fuzziness&quot;:&quot;2&quot;,</span></span><br><span class=\"line\"><span class=\"string\">            &quot;prefix_length&quot;:1</span></span><br><span class=\"line\"><span class=\"string\">          &#125;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;</span></span><br><span class=\"line\"><span class=\"string\">      &#125;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># fuzzinessï¼šç”¨äºç¼–è¾‘è·ç¦»çš„è®¾ç½®ï¼Œå…¶é»˜è®¤å€¼ä¸ºAUTOï¼Œæ”¯æŒçš„æ•°å€¼ä¸º[0ï¼Œ1ï¼Œ2]ã€‚å¦‚æœå€¼è®¾ç½®è¶Šç•Œä¼šæŠ¥é”™ã€‚</span></span><br><span class=\"line\"><span class=\"comment\"># prefix_length: æœç´¢è¯çš„å‰ç¼€é•¿åº¦ï¼Œåœ¨æ­¤é•¿åº¦å†…ä¸ä¼šåº”ç”¨æ¨¡ç³ŠåŒ¹é…ã€‚é»˜è®¤æ˜¯0ï¼Œå³æ•´ä¸ªè¯éƒ½ä¼šè¢«æ¨¡ç³ŠåŒ¹é…ã€‚</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"match-å…¨æ–‡æ£€ç´¢-å³åˆ†è¯\">match: å…¨æ–‡æ£€ç´¢(å³åˆ†è¯)</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;&quot;query&quot;:&#123;&quot;match&quot;:&#123;&quot;address&quot;:&quot;å¹¿å·ç™½äº‘å±±å…¬å›­&quot;&#125;&#125;&#125;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># å› ä¸º desc çš„ç´¢å¼•åˆ†è¯å™¨æ˜¯ ik_max_wordï¼ŒæŸ¥çœ‹â€œå¹¿å·ç™½äº‘å±±å…¬å›­â€è¢«åˆ†è¯åçš„ç»“æœ</span></span><br><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/_analyze?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;analyzer&quot;: &quot;ik_max_word&quot;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;text&quot;: &quot;å¹¿å·ç™½äº‘å±±å…¬å›­&quot;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># è¿”å›å€¼</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;tokens&quot;</span> : [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;token&quot;</span> : <span class=\"string\">&quot;å¹¿å·&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;start_offset&quot;</span> : 0,</span><br><span class=\"line\">      <span class=\"string\">&quot;end_offset&quot;</span> : 2,</span><br><span class=\"line\">      <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;CN_WORD&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;position&quot;</span> : 0</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;token&quot;</span> : <span class=\"string\">&quot;ç™½äº‘å±±&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;start_offset&quot;</span> : 2,</span><br><span class=\"line\">      <span class=\"string\">&quot;end_offset&quot;</span> : 5,</span><br><span class=\"line\">      <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;CN_WORD&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;position&quot;</span> : 1</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;token&quot;</span> : <span class=\"string\">&quot;ç™½äº‘&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;start_offset&quot;</span> : 2,</span><br><span class=\"line\">      <span class=\"string\">&quot;end_offset&quot;</span> : 4,</span><br><span class=\"line\">      <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;CN_WORD&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;position&quot;</span> : 2</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;token&quot;</span> : <span class=\"string\">&quot;äº‘å±±&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;start_offset&quot;</span> : 3,</span><br><span class=\"line\">      <span class=\"string\">&quot;end_offset&quot;</span> : 5,</span><br><span class=\"line\">      <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;CN_WORD&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;position&quot;</span> : 3</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;token&quot;</span> : <span class=\"string\">&quot;å…¬å›­&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;start_offset&quot;</span> : 5,</span><br><span class=\"line\">      <span class=\"string\">&quot;end_offset&quot;</span> : 7,</span><br><span class=\"line\">      <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;CN_WORD&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;position&quot;</span> : 4</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\"># æ‰€ä»¥åªè¦descä¸­åŒ…å«å¦‚ä¸Šè¿™äº›å†…å®¹çš„æ•°æ®éƒ½ä¼šè¢«åŒ¹é…ä¸Š</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ä½†æ˜¯è¿™æ ·åŒ¹é…çš„ç»“æœå°±ä¸å¤Ÿç²¾ç¡®ï¼Œå¦‚ä½•å°½é‡åŒ¹é…æ›´å¤šçš„åˆ†è¯å‘¢ï¼Œå¯ä»¥å¢åŠ  minimum_should_match</span></span><br><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;query&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;match&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;address&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">          &quot;query&quot;: &quot;å¹¿å·ç™½äº‘å±±å…¬å›­&quot;,</span></span><br><span class=\"line\"><span class=\"string\">          &quot;minimum_should_match&quot;: 2</span></span><br><span class=\"line\"><span class=\"string\">        &#125;</span></span><br><span class=\"line\"><span class=\"string\">      &#125;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">  &#125;&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># minimum_should_match: 2 è¡¨ç¤ºè‡³å°‘åŒ¹é…ä¸¤ä¸ª</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># å¦‚æœå¸Œæœ›å…¨éƒ¨éƒ½åŒ¹é…å‘¢</span></span><br><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;query&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;match&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;address&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">          &quot;query&quot;: &quot;å¹¿å·ç™½äº‘å±±å…¬å›­&quot;,</span></span><br><span class=\"line\"><span class=\"string\">          &quot;operator&quot;: &quot;and&quot;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;</span></span><br><span class=\"line\"><span class=\"string\">      &#125;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">  &#125;&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># operator: and è¡¨ç¤ºå…¨éƒ¨åŒ¹é…ï¼Œæ­¤æ—¶ç›¸å½“äºç²¾ç¡®åŒ¹é…ï¼Œå…¶é»˜è®¤å€¼æ˜¯ or</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"multi-match-å¤šå­—æ®µæŸ¥è¯¢\">multi_match: å¤šå­—æ®µæŸ¥è¯¢</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>multi_matchæŸ¥è¯¢åœ¨Elasticsearchä¸­ç”¨äºåœ¨å¤šä¸ªå­—æ®µä¸Šæ‰§è¡Œç›¸åŒçš„æœç´¢æ“ä½œã€‚å®ƒå¯ä»¥æ¥å—ä¸€ä¸ªæŸ¥è¯¢å­—ç¬¦ä¸²ï¼Œå¹¶åœ¨æŒ‡å®šçš„å­—æ®µé›†åˆä¸­æœç´¢è¿™ä¸ªå­—ç¬¦ä¸²ã€‚multi_matchæŸ¥è¯¢æä¾›äº†çµæ´»çš„åŒ¹é…ç±»å‹å’Œæ“ä½œç¬¦é€‰é¡¹ï¼Œä»¥ä¾¿æ ¹æ®ä¸åŒçš„æœç´¢éœ€æ±‚è°ƒæ•´æœç´¢è¡Œä¸ºã€‚</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;query&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;multi_match&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;query&quot;: &quot;å¹¿å·shirt&quot;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;fields&quot;:[&quot;title&quot;,&quot;address&quot;]</span></span><br><span class=\"line\"><span class=\"string\">      &#125;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">  &#125;&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># query: æŸ¥è¯¢æ¡ä»¶</span></span><br><span class=\"line\"><span class=\"comment\"># fields: æŒ‡å®šå¤šä¸ªå­—æ®µè¿›è¡ŒåŒ¹é…</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"match-phrase-çŸ­è¯­æŸ¥è¯¢\">match_phrase: çŸ­è¯­æŸ¥è¯¢</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>match_phraseæŸ¥è¯¢åœ¨Elasticsearchä¸­ç”¨äºæ‰§è¡ŒçŸ­è¯­æœç´¢ï¼Œå®ƒä¸ä»…åŒ¹é…æ•´ä¸ªçŸ­è¯­ï¼Œè€Œä¸”è¿˜è€ƒè™‘äº†çŸ­è¯­ä¸­å„ä¸ªè¯çš„é¡ºåºå’Œä½ç½®ã€‚è¿™ç§æŸ¥è¯¢ç±»å‹å¯¹äºæœç´¢ç²¾ç¡®çŸ­è¯­éå¸¸æœ‰ç”¨ï¼Œå°¤å…¶æ˜¯åœ¨ç”¨æˆ·è¾“å…¥çš„æŸ¥è¯¢ä¸æ–‡æ¡£ä¸­çš„æ–‡æœ¬è¡¨è¾¾æ–¹å¼éœ€è¦ä¸¥æ ¼åŒ¹é…æ—¶ã€‚</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">  &quot;query&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;match_phrase&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;address&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">          &quot;query&quot;:&quot;å¹¿å·ç™½äº‘å±±&quot;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;</span></span><br><span class=\"line\"><span class=\"string\">      &#125;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">  &#125;&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># è¦æ±‚æŸ¥è¯¢ç»“æœä¸­çš„æ•°æ®å¿…é¡»åŒ…å«&quot;å¹¿å·ç™½äº‘å±±&quot;ï¼Œè€Œä¸”â€œå¹¿å·â€å’Œâ€œç™½äº‘å±±â€è¿™ä¸¤ä¸ªè¯æ˜¯ä¸èƒ½åˆ†å¼€çš„ï¼Œå› ä¸º match_phrase åŒ¹é…çš„æ˜¯ç›¸é‚»è¯æ¡</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"query-string-æ”¯æŒä¸æˆ–éè¡¨è¾¾å¼çš„æŸ¥è¯¢\">query_string: æ”¯æŒ<code>ä¸æˆ–é</code>è¡¨è¾¾å¼çš„æŸ¥è¯¢</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>query_stringæŸ¥è¯¢æ˜¯ä¸€ç§çµæ´»çš„æŸ¥è¯¢ç±»å‹ï¼Œå®ƒå…è®¸ä½¿ç”¨LuceneæŸ¥è¯¢è¯­æ³•æ¥æ„å»ºå¤æ‚çš„æœç´¢æŸ¥è¯¢ã€‚è¿™ç§æŸ¥è¯¢ç±»å‹æ”¯æŒå¤šç§é€»è¾‘è¿ç®—ç¬¦ï¼ŒåŒ…æ‹¬ä¸ï¼ˆANDï¼‰ã€æˆ–ï¼ˆORï¼‰å’Œéï¼ˆNOTï¼‰ï¼Œä»¥åŠé€šé…ç¬¦ã€æ¨¡ç³Šæœç´¢å’Œæ­£åˆ™è¡¨è¾¾å¼ç­‰åŠŸèƒ½ã€‚query_stringæŸ¥è¯¢å¯ä»¥åœ¨å•ä¸ªæˆ–å¤šä¸ªå­—æ®µä¸Šè¿›è¡Œæœç´¢ï¼Œå¹¶ä¸”å¯ä»¥å¤„ç†å¤æ‚çš„æŸ¥è¯¢é€»è¾‘ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>æ³¨æ„: æŸ¥è¯¢å­—æ®µåˆ†è¯å°±å°†æŸ¥è¯¢æ¡ä»¶åˆ†è¯æŸ¥è¯¢ï¼ŒæŸ¥è¯¢å­—æ®µä¸åˆ†è¯å°†æŸ¥è¯¢æ¡ä»¶ä¸åˆ†è¯æŸ¥è¯¢</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># æŸ¥è¯¢æ‰€æœ‰å­—æ®µä¸­åŒ…å« &quot;å…¬å›­&quot;å’Œ &quot;åä¸º&quot; çš„æ–‡æ¡£</span></span><br><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">  &quot;query&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;query_string&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;query&quot;:&quot;å…¬å›­ AND electronics&quot;</span></span><br><span class=\"line\"><span class=\"string\">      &#125;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">  &#125;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æŒ‡å®šæŸ¥è¯¢çš„å•ä¸ªå­—æ®µ</span></span><br><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">  &quot;query&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;query_string&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;default_field&quot;:&quot;category&quot;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;query&quot;:&quot;ç™½äº‘å±± OR books&quot;</span></span><br><span class=\"line\"><span class=\"string\">      &#125;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">  &#125;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æŒ‡å®šæŸ¥è¯¢çš„å¤šä¸ªå­—æ®µ</span></span><br><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">  &quot;query&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;query_string&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;fields&quot;:[&quot;category&quot;,&quot;address&quot;],</span></span><br><span class=\"line\"><span class=\"string\">        &quot;query&quot;:&quot;ç™½äº‘å±± OR (electronics AND shirt)&quot;</span></span><br><span class=\"line\"><span class=\"string\">      &#125;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">  &#125;&#x27;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"simple-query-string-ç±»ä¼¼-query-stringï¼Œä½†æ˜¯ä¼šå¿½ç•¥é”™è¯¯çš„è¯­æ³•ï¼ŒåŒæ—¶åªæ”¯æŒéƒ¨åˆ†æŸ¥è¯¢è¯­æ³•\">simple_query_string: ç±»ä¼¼ <code>query_string</code>ï¼Œä½†æ˜¯ä¼šå¿½ç•¥é”™è¯¯çš„è¯­æ³•ï¼ŒåŒæ—¶åªæ”¯æŒéƒ¨åˆ†æŸ¥è¯¢è¯­æ³•</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">  &quot;query&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;simple_query_string&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;query&quot;:&quot;å¹¿å·å…¬å›­&quot;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;default_operator&quot;:&quot;AND&quot;</span></span><br><span class=\"line\"><span class=\"string\">      &#125;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">  &#125;&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># default_operator: é»˜è®¤ä¸º ORï¼Œè®¾ç½®ä¸º AND åˆ™å¿…é¡»åŒæ—¶åŒ¹é…</span></span><br></pre></td></tr></table></figure>\n<div class=\"tips\">\n<p><em><strong>ESæŸ¥è¯¢ç»“æœå±æ€§å«ä¹‰</strong></em></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;took&quot;</span>:16,          <span class=\"comment\"># è¡¨ç¤ºæŸ¥è¯¢ä»è¯·æ±‚åˆ°å®Œæˆè€—æ—¶ 16 æ¯«ç§’ã€‚</span></span><br><span class=\"line\">  <span class=\"string\">&quot;timed_out&quot;</span>:<span class=\"literal\">false</span>,  <span class=\"comment\"># è¡¨ç¤ºæŸ¥è¯¢åœ¨è§„å®šçš„æ—¶é—´å†…å®Œæˆï¼Œæ²¡æœ‰å‘ç”Ÿè¶…æ—¶ã€‚å¦‚æœä¸º trueï¼Œåˆ™è¡¨ç¤ºæŸ¥è¯¢è¶…æ—¶ã€‚</span></span><br><span class=\"line\">  <span class=\"string\">&quot;_shards&quot;</span>:&#123;         <span class=\"comment\"># æ¶‰åŠåˆ°æŸ¥è¯¢è¿‡ç¨‹ä¸­ä½¿ç”¨çš„åˆ†ç‰‡ä¿¡æ¯</span></span><br><span class=\"line\">    <span class=\"string\">&quot;total&quot;</span>:1,        <span class=\"comment\"># è¡¨ç¤ºæŸ¥è¯¢æ¶‰åŠåˆ°çš„æ€»åˆ†ç‰‡æ•°ä¸º 1</span></span><br><span class=\"line\">    <span class=\"string\">&quot;successful&quot;</span>:1,   <span class=\"comment\"># è¡¨ç¤ºæŸ¥è¯¢æˆåŠŸå®Œæˆçš„åˆ†ç‰‡æ•°ä¸º 1</span></span><br><span class=\"line\">    <span class=\"string\">&quot;skipped&quot;</span>:0,      <span class=\"comment\"># è¡¨ç¤ºæŸ¥è¯¢è¿‡ç¨‹ä¸­è¢«è·³è¿‡çš„åˆ†ç‰‡æ•°ä¸º 0</span></span><br><span class=\"line\">    <span class=\"string\">&quot;failed&quot;</span>:0        <span class=\"comment\"># è¡¨ç¤ºæŸ¥è¯¢è¿‡ç¨‹ä¸­å¤±è´¥çš„åˆ†ç‰‡æ•°ä¸º 0</span></span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;hits&quot;</span>:&#123;            <span class=\"comment\"># åŒ…å«æŸ¥è¯¢ç»“æœçš„è¯¦ç»†ä¿¡æ¯</span></span><br><span class=\"line\">    <span class=\"string\">&quot;total&quot;</span>:&#123;         <span class=\"comment\"># åŒ…å«æŸ¥è¯¢ç»“æœçš„æ€»æ•°</span></span><br><span class=\"line\">      <span class=\"string\">&quot;value&quot;</span>:4,      <span class=\"comment\"># è¡¨ç¤ºæŸ¥è¯¢ç»“æœçš„æ€»æ•°ä¸º 4</span></span><br><span class=\"line\">      <span class=\"string\">&quot;relation&quot;</span>:<span class=\"string\">&quot;eq&quot;</span> <span class=\"comment\"># è¡¨ç¤ºè¿”å›çš„æ€»æ•° value æ˜¯ç¡®åˆ‡çš„ï¼ˆequalï¼‰ã€‚å¦‚æœä¸º gteï¼Œåˆ™è¡¨ç¤ºè¿”å›çš„æ€»æ•°æ˜¯ä¸€ä¸ªä¸‹é™å€¼ã€‚</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">&quot;max_score&quot;</span>:0.0,  <span class=\"comment\"># è¡¨ç¤ºåŒ¹é…åˆ°çš„æ–‡æ¡£ä¸­æœ€é«˜çš„å¾—åˆ†ã€‚å¦‚æœæ˜¯æ’åºæŸ¥è¯¢ï¼Œè¿™ä¸ªå€¼ä¼šæœ‰æ„ä¹‰ã€‚å½“å‰ç»“æœå› ä¸º size: 0ï¼Œæ²¡æœ‰å®é™…è¿”å›æ–‡æ¡£ï¼Œæ‰€ä»¥å¾—åˆ†ä¸º 0.0</span></span><br><span class=\"line\">    <span class=\"string\">&quot;hits&quot;</span>:[ ]        <span class=\"comment\"># åŒ…å«æŸ¥è¯¢ç»“æœçš„åˆ—è¡¨ï¼Œæ¯ä¸ªç»“æœéƒ½æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼ŒåŒ…å«æ–‡æ¡£çš„å…ƒæ•°æ®ï¼Œå¦‚ idã€åˆ†æ•°ç­‰ã€‚</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</div>\n<h2 id=\"bool-æŸ¥è¯¢\">bool æŸ¥è¯¢</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å¸ƒå°”æŸ¥è¯¢å¯ä»¥æŒ‰ç…§å¸ƒå°”é€»è¾‘æ¡ä»¶ç»„ç»‡å¤šæ¡æŸ¥è¯¢è¯­å¥ï¼Œåªæœ‰ç¬¦åˆæ•´ä¸ªå¸ƒå°”æ¡ä»¶çš„æ–‡æ¡£æ‰ä¼šè¢«æœç´¢å‡ºæ¥ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>åœ¨å¸ƒå°”æ¡ä»¶ä¸­ï¼Œå¯ä»¥åŒ…å«ä¸¤ç§ä¸åŒçš„ä¸Šä¸‹æ–‡ã€‚</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-4\">1.æœç´¢ä¸Šä¸‹æ–‡(query context)ï¼šä½¿ç”¨æœç´¢ä¸Šä¸‹æ–‡æ—¶ï¼ŒElasticsearchéœ€è¦è®¡ç®—æ¯ä¸ªæ–‡æ¡£ä¸æœç´¢æ¡ä»¶çš„ç›¸å…³åº¦å¾—åˆ†ï¼Œè¿™ä¸ªå¾—åˆ†çš„è®¡ç®—éœ€ä½¿ç”¨ä¸€å¥—å¤æ‚çš„è®¡ç®—å…¬å¼ï¼Œæœ‰ä¸€å®šçš„æ€§èƒ½å¼€é”€ï¼Œå¸¦æ–‡æœ¬åˆ†æçš„å…¨æ–‡æ£€ç´¢çš„æŸ¥è¯¢è¯­å¥å¾ˆé€‚åˆæ”¾åœ¨æœç´¢ä¸Šä¸‹æ–‡ä¸­ã€‚</li>\n<li class=\"lvl-4\">2.è¿‡æ»¤ä¸Šä¸‹æ–‡(filter context)ï¼šä½¿ç”¨è¿‡æ»¤ä¸Šä¸‹æ–‡æ—¶ï¼ŒElasticsearchåªéœ€è¦åˆ¤æ–­æœç´¢æ¡ä»¶è·Ÿæ–‡æ¡£æ•°æ®æ˜¯å¦åŒ¹é…ï¼Œä¾‹å¦‚ä½¿ç”¨<code>Term query</code>åˆ¤æ–­ä¸€ä¸ªå€¼æ˜¯å¦è·Ÿæœç´¢å†…å®¹ä¸€è‡´ï¼Œä½¿ç”¨<code>Range query</code>åˆ¤æ–­æŸæ•°æ®æ˜¯å¦ä½äºæŸä¸ªåŒºé—´ç­‰ã€‚è¿‡æ»¤ä¸Šä¸‹æ–‡çš„æŸ¥è¯¢ä¸éœ€è¦è¿›è¡Œç›¸å…³åº¦å¾—åˆ†è®¡ç®—ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ç¼“å­˜åŠ å¿«å“åº”é€Ÿåº¦ï¼Œå¾ˆå¤šæœ¯è¯­çº§æŸ¥è¯¢è¯­å¥éƒ½é€‚åˆæ”¾åœ¨è¿‡æ»¤ä¸Šä¸‹æ–‡ä¸­ã€‚</li>\n</ul>\n</li>\n<li class=\"lvl-2\">\n<p>bool æŸ¥è¯¢åŒ…å« mustã€must_notã€shouldã€filter å››ç§å­å¥ã€‚</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>ç±»å‹</th>\n<th>è¯´æ˜</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>must</td>\n<td>å¯åŒ…å«å¤šä¸ªæŸ¥è¯¢æ¡ä»¶ï¼Œæ¯ä¸ªæ¡ä»¶å‡æ»¡è¶³çš„æ–‡æ¡£æ‰èƒ½è¢«æœç´¢åˆ°ï¼Œæ¯æ¬¡æŸ¥è¯¢éœ€è¦è®¡ç®—ç›¸å…³åº¦å¾—åˆ†ï¼Œå±äºæœç´¢ä¸Šä¸‹æ–‡</td>\n</tr>\n<tr>\n<td>should</td>\n<td>å¯åŒ…å«å¤šä¸ªæŸ¥è¯¢æ¡ä»¶ï¼Œä¸å­˜åœ¨mustå’Œfiteræ¡ä»¶æ—¶ï¼Œè‡³å°‘è¦æ»¡è¶³å¤šä¸ªæŸ¥è¯¢æ¡ä»¶ä¸­çš„ä¸€ä¸ªï¼Œæ–‡æ¡£æ‰èƒ½è¢«æœç´¢åˆ°ï¼Œå¦åˆ™éœ€æ»¡è¶³çš„æ¡ä»¶æ•°é‡ä¸å—é™åˆ¶,åŒ¹é…åˆ°çš„æŸ¥è¯¢è¶Šå¤šç›¸å…³åº¦è¶Šé«˜ï¼Œä¹Ÿå±äºæœç´¢ä¸Šä¸‹æ–‡</td>\n</tr>\n<tr>\n<td>filter</td>\n<td>å¯åŒ…å«å¤šä¸ªè¿‡æ»¤æ¡ä»¶ï¼Œæ¯ä¸ªæ¡ä»¶å‡æ»¡è¶³çš„æ–‡æ¡£æ‰èƒ½è¢«æœç´¢åˆ°ï¼Œæ¯ä¸ªè¿‡æ»¤æ¡ä»¶ä¸è®¡ç®—ç›¸å…³åº¦å¾—åˆ†ï¼Œç»“æœåœ¨ä¸€å®šæ¡ä»¶ä¸‹ä¼šè¢«ç¼“å­˜ï¼Œ å±äºè¿‡æ»¤ä¸Šä¸‹æ–‡</td>\n</tr>\n<tr>\n<td>must_not</td>\n<td>å¯åŒ…å«å¤šä¸ªè¿‡æ»¤æ¡ä»¶ï¼Œæ¯ä¸ªæ¡ä»¶å‡ä¸æ»¡è¶³çš„æ–‡æ¡£æ‰èƒ½è¢«æœç´¢åˆ°ï¼Œæ¯ä¸ªè¿‡æ»¤æ¡ä»¶ä¸è®¡ç®—ç›¸å…³åº¦å¾—åˆ†ï¼Œç»“æœåœ¨ä¸€å®šæ¡ä»¶ä¸‹ä¼šè¢«ç¼“å­˜ï¼Œ å±äºè¿‡æ»¤ä¸Šä¸‹æ–‡</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"must\">must</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ä¸¤ä¸ªæ¡ä»¶éƒ½éœ€è¦æ»¡è¶³</span></span><br><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">  &quot;query&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;bool&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;must&quot;:[</span></span><br><span class=\"line\"><span class=\"string\">          &#123;&quot;match&quot;:&#123;&quot;category&quot;:&quot;electronics&quot;&#125;&#125;,</span></span><br><span class=\"line\"><span class=\"string\">          &#123;&quot;match&quot;:&#123;&quot;desc&quot;:&quot;å…¬å›­&quot;&#125;&#125;</span></span><br><span class=\"line\"><span class=\"string\">        ]</span></span><br><span class=\"line\"><span class=\"string\">      &#125;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">  &#125;&#x27;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"must-not\">must_not</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ä¸¤ä¸ªæ¡ä»¶éƒ½ä¸æ»¡è¶³</span></span><br><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">  &quot;query&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;bool&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;must_not&quot;:[</span></span><br><span class=\"line\"><span class=\"string\">          &#123;&quot;match&quot;:&#123;&quot;category&quot;:&quot;electronics&quot;&#125;&#125;,</span></span><br><span class=\"line\"><span class=\"string\">          &#123;&quot;match&quot;:&#123;&quot;desc&quot;:&quot;å…¬å›­&quot;&#125;&#125;</span></span><br><span class=\"line\"><span class=\"string\">        ]</span></span><br><span class=\"line\"><span class=\"string\">      &#125;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">  &#125;&#x27;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"should\">should</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ä¸¤ä¸ªæ¡ä»¶æ»¡è¶³ä¸€ä¸ªå³å¯</span></span><br><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">  &quot;query&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;bool&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;should&quot;:[</span></span><br><span class=\"line\"><span class=\"string\">          &#123;&quot;match&quot;:&#123;&quot;category&quot;:&quot;electronics&quot;&#125;&#125;,</span></span><br><span class=\"line\"><span class=\"string\">          &#123;&quot;match&quot;:&#123;&quot;desc&quot;:&quot;å…¬å›­&quot;&#125;&#125;</span></span><br><span class=\"line\"><span class=\"string\">        ]</span></span><br><span class=\"line\"><span class=\"string\">      &#125;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">  &#125;&#x27;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"filter\">filter</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># filterä¸­çš„æ¡ä»¶ä¸ºé matchï¼Œå³ä¸èƒ½æ˜¯å…¨æ–‡æ£€ç´¢</span></span><br><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">  &quot;query&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;bool&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;filter&quot;:[</span></span><br><span class=\"line\"><span class=\"string\">          &#123;&quot;term&quot;:&#123;&quot;category&quot;:&quot;electronics&quot;&#125;&#125;,</span></span><br><span class=\"line\"><span class=\"string\">          &#123;&quot;range&quot;:&#123;&quot;price&quot;:&#123;&quot;gte&quot;:20&#125;&#125;&#125;</span></span><br><span class=\"line\"><span class=\"string\">        ]</span></span><br><span class=\"line\"><span class=\"string\">      &#125;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">  &#125;&#x27;</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"åˆ†é¡µä¸æ’åº\">åˆ†é¡µä¸æ’åº</h2>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># from: ä»ç¬¬å‡ æ¡å¼€å§‹ï¼Œé»˜è®¤0</span></span><br><span class=\"line\"><span class=\"comment\"># size: å–å¤šå°‘æ¡</span></span><br><span class=\"line\"><span class=\"comment\"># sort: æ’åºï¼Œé»˜è®¤ä¸ºæŒ‰æ–‡æ¡£idå‡åº</span></span><br><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">  &quot;query&quot;:&#123;&quot;range&quot;:&#123;&quot;price&quot;:&#123;&quot;gte&quot;:20,&quot;lte&quot;:30&#125;&#125;&#125;,</span></span><br><span class=\"line\"><span class=\"string\">  &quot;sort&quot;:[&#123;&quot;price&quot;:&quot;address&quot;&#125;],</span></span><br><span class=\"line\"><span class=\"string\">  &quot;from&quot;:0,</span></span><br><span class=\"line\"><span class=\"string\">  &quot;size&quot;:5</span></span><br><span class=\"line\"><span class=\"string\">  &#125;&#x27;</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"åªè¿”å›éƒ¨åˆ†å­—æ®µ\">åªè¿”å›éƒ¨åˆ†å­—æ®µ</h2>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># _source: æŒ‡å®šè¦è¿”å›çš„å­—æ®µåˆ—è¡¨</span></span><br><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;</span></span><br><span class=\"line\"><span class=\"string\">  &#123;&quot;query&quot;:&#123;&quot;range&quot;:&#123;&quot;price&quot;:&#123;&quot;gte&quot;:20,&quot;lte&quot;:30&#125;&#125;&#125;,</span></span><br><span class=\"line\"><span class=\"string\">  &quot;_source&quot;:[&quot;category&quot;,&quot;title&quot;,&quot;price&quot;]</span></span><br><span class=\"line\"><span class=\"string\">  &#125;&#x27;</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"é«˜äº®æ˜¾ç¤º\">é«˜äº®æ˜¾ç¤º</h2>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># é«˜äº®æ˜¾ç¤ºä»…æ”¯æŒå…¨æ–‡æ£€ç´¢å­—æ®µ</span></span><br><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;query&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;multi_match&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;fields&quot;: [&quot;title&quot;,&quot;address&quot;],</span></span><br><span class=\"line\"><span class=\"string\">        &quot;query&quot;: &quot;å…¬å›­shirt&quot;</span></span><br><span class=\"line\"><span class=\"string\">      &#125;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;highlight&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;post_tags&quot;: [&quot;&lt;/span&gt;&quot;],</span></span><br><span class=\"line\"><span class=\"string\">      &quot;pre_tags&quot;: [&quot;&lt;span style=&#x27;</span>color:red<span class=\"string\">&#x27;&gt;&quot;],</span></span><br><span class=\"line\"><span class=\"string\">      &quot;fields&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;*&quot;:&#123;&#125;</span></span><br><span class=\"line\"><span class=\"string\">      &#125;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">  &#125;&#x27;</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"åœ°ç†ç©ºé—´ä½ç½®æŸ¥è¯¢\">åœ°ç†ç©ºé—´ä½ç½®æŸ¥è¯¢</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åœ°ç†ç©ºé—´ä½ç½®æŸ¥è¯¢æ˜¯æ•°æ®åº“å’Œæœç´¢ç³»ç»Ÿä¸­çš„ä¸€ä¸ªé‡è¦ç‰¹æ€§ï¼Œç‰¹åˆ«æ˜¯åœ¨åœ°ç†ä¿¡æ¯ç³»ç»Ÿï¼ˆGISï¼‰å’Œä½ç½®æœåŠ¡ä¸­ã€‚å®ƒå…è®¸ç”¨æˆ·åŸºäºåœ°ç†ä½ç½®ä¿¡æ¯æ¥æœç´¢å’Œè¿‡æ»¤æ•°æ®ã€‚åœ¨Elasticsearchè¿™æ ·çš„å…¨æ–‡æœç´¢å¼•æ“ä¸­ï¼Œåœ°ç†ç©ºé—´ä½ç½®æŸ¥è¯¢è¢«å¹¿æ³›åº”ç”¨ï¼Œä¾‹å¦‚åœ¨æ—…è¡Œã€æˆ¿åœ°äº§ã€ç‰©æµå’Œé›¶å”®ç­‰è¡Œä¸šï¼Œç”¨äºæä¾›åŸºäºä½ç½®çš„æœç´¢åŠŸèƒ½ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>åœ¨Elasticsearchä¸­ï¼Œåœ°ç†ç©ºé—´æ•°æ®é€šå¸¸å­˜å‚¨åœ¨<code>geo_point</code>å­—æ®µç±»å‹ä¸­ã€‚è¿™ç§å­—æ®µç±»å‹å¯ä»¥å­˜å‚¨çº¬åº¦å’Œç»åº¦åæ ‡ï¼Œç”¨äºè¡¨ç¤ºåœ°çƒä¸Šçš„ä¸€ä¸ªç‚¹ã€‚</p>\n</li>\n</ul>\n<h3 id=\"ç¤ºä¾‹\">ç¤ºä¾‹</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åˆ›å»ºä¸€ä¸ªç´¢å¼•ï¼Œå¹¶æ·»åŠ ä¸€ä¸ª<code>geo_point</code>å­—æ®µï¼š</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -X PUT -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/tourist_spots&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;mappings&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;properties&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;name&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">          &quot;type&quot;: &quot;text&quot;,</span></span><br><span class=\"line\"><span class=\"string\">          &quot;analyzer&quot;: &quot;ik_max_word&quot;,</span></span><br><span class=\"line\"><span class=\"string\">          &quot;search_analyzer&quot;: &quot;ik_max_word&quot;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;location&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">          &quot;type&quot;: &quot;geo_point&quot;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;</span></span><br><span class=\"line\"><span class=\"string\">      &#125;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">  &#125;&#x27;</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æ’å…¥æ•°æ®</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -X POST -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/tourist_spots/_bulk&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;&quot;index&quot;:&#123;&#125;&#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123;&quot;name&quot;:&quot;é›·å³°å¡”&quot;,&quot;location&quot;:&#123;&quot;lat&quot;:30.2615,&quot;lon&quot;:120.1480&#125;&#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123;&quot;index&quot;:&#123;&#125;&#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123;&quot;name&quot;:&quot;è¥¿æ¹–&quot;,&quot;location&quot;:&#123;&quot;lat&quot;:30.2614,&quot;lon&quot;:120.1479&#125;&#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123;&quot;index&quot;:&#123;&#125;&#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123;&quot;name&quot;:&quot;è‹å ¤æ˜¥æ™“&quot;,&quot;location&quot;:&#123;&quot;lat&quot;:30.2624,&quot;lon&quot;:120.1708&#125;&#125;</span></span><br><span class=\"line\"><span class=\"string\">&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># lat: çº¬åº¦</span></span><br><span class=\"line\"><span class=\"comment\"># lon: ç»åº¦</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æŸ¥è¯¢æ•°æ®</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># æŸ¥è¯¢æ­å·è¥¿æ¹–5kmé™„è¿‘çš„æ™¯ç‚¹</span></span><br><span class=\"line\"><span class=\"comment\"># é›·å³°å¡” - ä½äºè¥¿æ¹–é™„è¿‘ï¼Œè·ç¦»çº¦2.8å…¬é‡Œã€‚</span></span><br><span class=\"line\"><span class=\"comment\"># è‹å ¤æ˜¥æ™“ - ä½äºè¥¿æ¹–è¾¹ï¼Œè·ç¦»è¥¿æ¹–ä¸­å¿ƒçº¦1å…¬é‡Œã€‚</span></span><br><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/tourist_spots/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;query&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;bool&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;must&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">          &quot;match_all&quot;: &#123;&#125;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;filter&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">          &quot;geo_distance&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">            &quot;distance&quot;: &quot;5km&quot;,</span></span><br><span class=\"line\"><span class=\"string\">            &quot;distance_type&quot;: &quot;arc&quot;,</span></span><br><span class=\"line\"><span class=\"string\">            &quot;location&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">              &quot;lat&quot;: 30.2614,</span></span><br><span class=\"line\"><span class=\"string\">              &quot;lon&quot;: 120.1479</span></span><br><span class=\"line\"><span class=\"string\">            &#125;</span></span><br><span class=\"line\"><span class=\"string\">          &#125;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;</span></span><br><span class=\"line\"><span class=\"string\">      &#125;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">  &#125;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># distance: 5km è¡¨ç¤ºè·ç¦»ä¸º5å…¬é‡Œ</span></span><br><span class=\"line\"><span class=\"comment\"># distance_type: arc, plane, sloppy_arc,</span></span><br><span class=\"line\">  <span class=\"comment\"># arc: é»˜è®¤å€¼ï¼Œä½¿ç”¨haversineå…¬å¼è®¡ç®—è·ç¦»ï¼Œç»“æœæ˜¯ç²¾ç¡®çš„ï¼Œä½†è®¡ç®—é€Ÿåº¦è¾ƒæ…¢ã€‚</span></span><br><span class=\"line\">  <span class=\"comment\"># plane: ä½¿ç”¨å¹³é¢ç›´è§’åæ ‡ç³»è®¡ç®—è·ç¦»ï¼Œç»“æœæ˜¯ç²—ç•¥çš„ï¼Œä½†è®¡ç®—é€Ÿåº¦æ›´å¿«ã€‚</span></span><br><span class=\"line\">  <span class=\"comment\"># sloppy_arc: ä½¿ç”¨haversineå…¬å¼è®¡ç®—è·ç¦»ï¼Œä½†å…è®¸è¯¯å·®ã€‚</span></span><br><span class=\"line\"><span class=\"comment\"># location: æœç´¢æ¡ä»¶</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"å‘é‡æœç´¢\">å‘é‡æœç´¢</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Elasticsearch 8.x å¼•å…¥äº†ä¸€ä¸ªé‡è¦çš„æ–°ç‰¹æ€§ï¼šå‘é‡æ£€ç´¢ï¼ˆVector Searchï¼‰ï¼Œç‰¹åˆ«æ˜¯é€šè¿‡KNNï¼ˆK-Nearest Neighborsï¼‰ç®—æ³•æ”¯æŒå‘é‡è¿‘é‚»æ£€ç´¢ã€‚è¿™ä¸€ç‰¹æ€§ä½¿å¾—Elasticsearchåœ¨æœºå™¨å­¦ä¹ ã€æ•°æ®åˆ†æå’Œæ¨èç³»ç»Ÿç­‰é¢†åŸŸçš„åº”ç”¨å˜å¾—æ›´åŠ å¹¿æ³›å’Œå¼ºå¤§ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>å‘é‡æ£€ç´¢çš„åŸºæœ¬æ€è·¯æ˜¯ï¼Œå°†æ–‡æ¡£ï¼ˆæˆ–æ•°æ®é¡¹ï¼‰è¡¨ç¤ºä¸ºé«˜ç»´å‘é‡ï¼Œå¹¶ä½¿ç”¨è¿™äº›å‘é‡æ¥æ‰§è¡Œç›¸ä¼¼æ€§æœç´¢ã€‚åœ¨Elasticsearchä¸­ï¼Œè¿™äº›å‘é‡è¢«å­˜å‚¨åœ¨<code>dense_vector</code>ç±»å‹çš„å­—æ®µä¸­ï¼Œç„¶åä½¿ç”¨KNNç®—æ³•æ¥æ‰¾åˆ°ä¸ç»™å®šå‘é‡æœ€ç›¸ä¼¼çš„å…¶ä»–å‘é‡ã€‚</p>\n</li>\n</ul>\n<h3 id=\"ç¤ºä¾‹-2\">ç¤ºä¾‹</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åˆ›å»ºç´¢å¼•</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -X PUT -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/image-index&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;mappings&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;properties&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;image-vector&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">          &quot;type&quot;: &quot;dense_vector&quot;,</span></span><br><span class=\"line\"><span class=\"string\">          &quot;dims&quot;: 3</span></span><br><span class=\"line\"><span class=\"string\">        &#125;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;title&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">          &quot;type&quot;: &quot;text&quot;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;file-type&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">          &quot;type&quot;: &quot;keyword&quot;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;my_label&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">          &quot;type&quot;: &quot;text&quot;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;</span></span><br><span class=\"line\"><span class=\"string\">      &#125;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">  &#125;&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># dims: 3  è¡¨ç¤º3ç»´å‘é‡ï¼Œæœ€é«˜æ”¯æŒ2048</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æ·»åŠ æ•°æ®</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -X POST -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/image-index/_bulk&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123; &quot;index&quot;: &#123;&#125; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;image-vector&quot;: [-5, 9, -12], &quot;title&quot;: &quot;Image A&quot;, &quot;file-type&quot;: &quot;jpeg&quot;, &quot;my_label&quot;: &quot;red&quot; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;index&quot;: &#123;&#125; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;image-vector&quot;: [10, -2, 3], &quot;title&quot;: &quot;Image B&quot;, &quot;file-type&quot;: &quot;png&quot;, &quot;my_label&quot;: &quot;blue&quot; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;index&quot;: &#123;&#125; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;image-vector&quot;: [4, 0, -1], &quot;title&quot;: &quot;Image C&quot;, &quot;file-type&quot;: &quot;gif&quot;, &quot;my_label&quot;: &quot;red&quot; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#x27;</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å‘é‡æ£€ç´¢</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -X POST -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/image-index/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;query&quot;:&#123; &quot;match_all&quot;: &#123;&#125; &#125;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;knn&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;field&quot;: &quot;image-vector&quot;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;query_vector&quot;: [-5, 10, -12],</span></span><br><span class=\"line\"><span class=\"string\">      &quot;k&quot;: 10,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;num_candidates&quot;: 100</span></span><br><span class=\"line\"><span class=\"string\">    &#125;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;fields&quot;: [ &quot;title&quot;, &quot;file-type&quot; ]</span></span><br><span class=\"line\"><span class=\"string\">  &#125;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># query: æœç´¢æ¡ä»¶ï¼Œè¿™é‡Œå¯ä»¥ä¸åŠ è¿™ä¸ª</span></span><br><span class=\"line\"><span class=\"comment\"># knn: 8.8.1 ç‰ˆæœ¬å¼€å§‹é»˜è®¤æ”¯æŒ</span></span><br><span class=\"line\"><span class=\"comment\"># field: æœç´¢å‘é‡å­—æ®µ</span></span><br><span class=\"line\"><span class=\"comment\"># query_vector: æœç´¢å‘é‡</span></span><br><span class=\"line\"><span class=\"comment\"># k: æœç´¢ç»“æœæ•°é‡</span></span><br><span class=\"line\"><span class=\"comment\"># num_candidates: æœç´¢å€™é€‰æ•°é‡ï¼Œç”¨äºä¼˜åŒ–æ€§èƒ½</span></span><br><span class=\"line\"><span class=\"comment\"># fields: æœç´¢ç»“æœè¿”å›å­—æ®µ</span></span><br></pre></td></tr></table></figure>","content_text":"æ‘˜è¦ æœ¬æ–‡ä»‹ç» Elasticsearch çš„ REST APIs Elasticsearchç‰ˆæœ¬8.17.3 å®˜æ–¹æ–‡æ¡£:REST APIs Elasticsearch çš„ REST APIs:èšåˆæŸ¥è¯¢ è¿”å›å†…å®¹æ ¼å¼åŒ– è¿”å›jsonä¿¡æ¯æ ¼å¼: ?pretty è¾“å‡ºæ ¼å¼åŒ–åçš„jsonï¼Œæ¯”å¦‚ï¼šcurl http://localhost:9200/_cluster/health?pretty è¿”å›è¡Œä¿¡æ¯æ ¼å¼: ?v è¾“å‡ºå†…å®¹ä¸Šæ–¹ä¼šåŠ ä¸Šæ ‡é¢˜è¡Œï¼Œæ¯”å¦‚ï¼šcurl http://localhost:9200/_cat/health?v CAT APIs Elasticsearch æä¾›äº† CAT APIsï¼Œå®ƒä»¬æä¾›äº†ä¸€ç§ç®€å•çš„æ–¹å¼æ¥æŸ¥çœ‹é›†ç¾¤çŠ¶æ€å’Œé›†ç¾¤ä¸­çš„å„ç§èµ„æºï¼Œæ¯”å¦‚ç´¢å¼•ã€åˆ†ç‰‡ã€èŠ‚ç‚¹ç­‰ã€‚ 123456789101112131415161718192021222324GET /_cat/health #æŸ¥çœ‹é›†ç¾¤å½“å‰çŠ¶æ€ï¼šçº¢ã€é»„ã€ç»¿GET /_cat/master #æŸ¥çœ‹masterèŠ‚ç‚¹ä¿¡æ¯GET /_cat/nodes #æŸ¥çœ‹æ‰€æœ‰èŠ‚ç‚¹ä¿¡æ¯GET /_cat/plugins #æŸ¥çœ‹é›†ç¾¤å„ä¸ªèŠ‚ç‚¹ä¸Šçš„pluginä¿¡æ¯GET /_cat/indices #æŸ¥çœ‹é›†ç¾¤ä¸­æ‰€æœ‰indexçš„è¯¦ç»†ä¿¡æ¯GET /_cat/indices/&#123;index&#125; #æŸ¥çœ‹é›†ç¾¤ä¸­æŒ‡å®šindexçš„è¯¦ç»†ä¿¡æ¯ï¼Œindexï¼šç´¢å¼•åç§°GET /_cat/allocation #æŸ¥çœ‹å•èŠ‚ç‚¹çš„shardåˆ†é…æ•´ä½“æƒ…å†µGET /_cat/shards #æŸ¥çœ‹å„shardçš„è¯¦ç»†æƒ…å†µGET /_cat/shards/&#123;index&#125; #æŸ¥çœ‹æŒ‡å®šåˆ†ç‰‡çš„è¯¦ç»†æƒ…å†µGET /_cat/segments #æŸ¥çœ‹å„indexçš„segmentè¯¦ç»†ä¿¡æ¯,åŒ…æ‹¬segmentå, æ‰€å±shard, å†…å­˜(ç£ç›˜)å ç”¨å¤§å°, æ˜¯å¦åˆ·ç›˜GET /_cat/segments/&#123;index&#125; #æŸ¥çœ‹æŒ‡å®šindexçš„segmentè¯¦ç»†ä¿¡æ¯GET /_cat/count #æŸ¥çœ‹å½“å‰é›†ç¾¤çš„docæ•°é‡GET /_cat/count/&#123;index&#125; #æŸ¥çœ‹æŒ‡å®šç´¢å¼•çš„docæ•°é‡GET /_cat/recovery #æŸ¥çœ‹é›†ç¾¤å†…æ¯ä¸ªshardçš„recoveryè¿‡ç¨‹.è°ƒæ•´replicaã€‚GET /_cat/recovery/&#123;index&#125; #æŸ¥çœ‹æŒ‡å®šç´¢å¼•shardçš„recoveryè¿‡ç¨‹GET /_cat/pending_tasks #æŸ¥çœ‹å½“å‰é›†ç¾¤çš„pending taskGET /_cat/aliases #æŸ¥çœ‹é›†ç¾¤ä¸­æ‰€æœ‰aliasä¿¡æ¯,è·¯ç”±é…ç½®ç­‰GET /_cat/aliases/&#123;alias&#125; #æŸ¥çœ‹æŒ‡å®šç´¢å¼•çš„aliasä¿¡æ¯GET /_cat/thread_pool #æŸ¥çœ‹é›†ç¾¤å„èŠ‚ç‚¹å†…éƒ¨ä¸åŒç±»å‹çš„threadpoolçš„ç»Ÿè®¡ä¿¡æ¯,GET /_cat/fielddata #æŸ¥çœ‹å½“å‰é›†ç¾¤å„ä¸ªèŠ‚ç‚¹çš„fielddataå†…å­˜ä½¿ç”¨æƒ…å†µGET /_cat/fielddata/&#123;fields&#125; #æŸ¥çœ‹æŒ‡å®šfieldçš„å†…å­˜ä½¿ç”¨æƒ…å†µ,é‡Œé¢ä¼ fieldå±æ€§å¯¹åº”çš„å€¼GET /_cat/nodeattrs #æŸ¥çœ‹å•èŠ‚ç‚¹çš„è‡ªå®šä¹‰å±æ€§GET /_cat/repositories #è¾“å‡ºé›†ç¾¤ä¸­æ³¨å†Œå¿«ç…§å­˜å‚¨åº“GET /_cat/templates #è¾“å‡ºå½“å‰æ­£åœ¨å­˜åœ¨çš„æ¨¡æ¿ä¿¡æ¯ Cluster APIs Elasticsearch æä¾›äº†ä¸€ç³»åˆ—çš„ Cluster APIsï¼Œå®ƒä»¬æä¾›äº†ç®¡ç†å’Œç›‘æ§é›†ç¾¤çŠ¶æ€çš„åŠŸèƒ½ 123456789GET /_cluster/health # è·å–é›†ç¾¤çš„å¥åº·çŠ¶æ€ä¿¡æ¯ï¼ŒåŒ…æ‹¬äº†é›†ç¾¤æ€»ä½“çš„çŠ¶å†µå¦‚statusã€number_of_nodesç­‰ã€‚GET /_cluster/stats # æä¾›æ•´ä¸ªé›†ç¾¤å±‚é¢çš„ç»Ÿè®¡ä¿¡æ¯ï¼ŒåŒ…å«ç´¢å¼•ã€èŠ‚ç‚¹å’Œå…¶ä»–é«˜çº§æŒ‡æ ‡ã€‚GET /_cluster/state # æ˜¾ç¤ºé›†ç¾¤å…ƒæ•°æ®çš„çŠ¶æ€ï¼ŒåŒ…æ‹¬è®¾ç½®ã€å—ã€è·¯ç”±è¡¨åŠå…ƒæ•°æ®ç­‰ï¼Œå…è®¸ç”¨æˆ·æŸ¥çœ‹é›†ç¾¤çš„å½“å‰è§†å›¾ã€‚POST /_cluster/reroute # POSTè¯·æ±‚ï¼Œç”¨äºæ‰‹åŠ¨æ”¹å˜åˆ†ç‰‡åˆ†é…æƒ…å†µï¼Œå¯ä»¥å®ç°å¦‚è¿ç§»åˆ†ç‰‡ã€å–æ¶ˆåˆ†é…ç­‰æ“ä½œã€‚GET /_cluster/nodes/hot_threads # è¿”å›é›†ç¾¤ä¸­å„ä¸ªèŠ‚ç‚¹â€œæœ€çƒ­â€çš„çº¿ç¨‹å †æ ˆè·Ÿè¸ªï¼Œé»˜è®¤æ˜¾ç¤ºå‰ä¸‰ä¸ªCPUæ—¶é—´æœ€é•¿çš„çº¿ç¨‹ã€‚GET /_cluster/allocation/explain # è§£é‡Šä¸ºä½•æŸä¸ªåˆ†ç‰‡è¢«å¦‚æ­¤åˆ†é…ï¼Œå¹¶æä¾›å¦‚ä½•è°ƒæ•´çš„å»ºè®®ã€‚GET /_cluster/pending_tasks # åˆ—å‡ºæ‰€æœ‰ç­‰å¾…æ‰§è¡Œçš„ä»»åŠ¡åˆ—è¡¨ã€‚GET /_cluster/settings # æŸ¥çœ‹æ•´ä¸ªé›†ç¾¤çº§åˆ«çš„è®¾ç½®ã€‚PUT /_cluster/settings # æ›´æ–°æ•´ä¸ªé›†ç¾¤çº§åˆ«çš„è®¾ç½®ã€‚ Index APIs Elasticsearch æä¾›äº† Index APIsï¼Œå®ƒä»¬æä¾›äº†å¯¹ç´¢å¼•çš„åˆ›å»ºã€æ›´æ–°ã€æŸ¥è¯¢å’Œåˆ é™¤ç­‰æ“ä½œã€‚ åˆ›å»ºç´¢å¼• 12345# PUT /&lt;target&gt;# è¿™é‡Œ shopping ä¸ºç´¢å¼•åç§°ï¼Œä½†æ­¤æ—¶æ²¡æœ‰ä¸ºç´¢å¼•è®¾ç½®åˆ†ç‰‡ç­–ç•¥ï¼Œä¹Ÿæ²¡æœ‰è®¾ç½®å­—æ®µä¿¡æ¯curl -X PUT -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping&#x27;# è¿”å›å€¼&#123;&quot;acknowledged&quot;:true,&quot;shards_acknowledged&quot;:true,&quot;index&quot;:&quot;shopping&quot;&#125; åˆ›å»ºç´¢å¼•å¹¶è®¾ç½®ç´¢å¼• 123456# PUT /&lt;target&gt;curl -X PUT -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123;&quot;settings&quot;:&#123;&quot;number_of_shards&quot;:&quot;1&quot;,&quot;number_of_replicas&quot;:&quot;2&quot;&#125;&#125;&#x27;# è¿”å›å€¼&#123;&quot;acknowledged&quot;:true,&quot;shards_acknowledged&quot;:true,&quot;index&quot;:&quot;shopping&quot;&#125; åˆ›å»ºå¹¶æ˜ å°„ç´¢å¼• 1234567891011121314151617181920212223242526272829303132333435363738394041# PUT /&lt;target&gt;# è¿™é‡Œè®¾ç½®ç´¢å¼•åˆ†ç‰‡æ•°é‡ä¸º1ï¼Œå‰¯æœ¬æ•°é‡ä¸º2ï¼Œå¹¶è®¾ç½®å­—æ®µä¿¡æ¯curl -X PUT -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;settings&quot;:&#123; &quot;number_of_shards&quot;:&quot;1&quot;, &quot;number_of_replicas&quot;:&quot;2&quot; &#125;, &quot;mappings&quot;:&#123; &quot;properties&quot;:&#123; &quot;title&quot;:&#123; &quot;type&quot;:&quot;text&quot; &#125;, &quot;category&quot;:&#123; &quot;type&quot;:&quot;keyword&quot; &#125;, &quot;price&quot;:&#123; &quot;type&quot;:&quot;double&quot; &#125;, &quot;count&quot;:&#123; &quot;type&quot;:&quot;integer&quot; &#125; &#125; &#125; &#125;&#x27;# å‚æ•°è¯´æ˜## settings: è¿™ä¸ªå‚æ•°ç”¨äºé…ç½®ç´¢å¼•çš„è®¾ç½®ï¼ŒåŒ…æ‹¬åˆ†ç‰‡æ•°é‡å’Œå‰¯æœ¬æ•°é‡ã€‚### number_of_shards: è¿™ä¸ªå‚æ•°æŒ‡å®šäº†ç´¢å¼•ä¸­åˆ†ç‰‡çš„æ•°é‡ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œnumber_of_shards è®¾ç½®ä¸º 1ï¼Œæ„å‘³ç€ç´¢å¼•å°†åªæœ‰ä¸€ä¸ªä¸»åˆ†ç‰‡ã€‚### number_of_replicas: è¿™ä¸ªå‚æ•°æŒ‡å®šäº†æ¯ä¸ªä¸»åˆ†ç‰‡çš„å‰¯æœ¬æ•°é‡ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œnumber_of_replicas è®¾ç½®ä¸º 2ï¼Œæ„å‘³ç€æ¯ä¸ªä¸»åˆ†ç‰‡å°†æœ‰ä¸¤ä¸ªå‰¯æœ¬ã€‚## mappings: è¿™ä¸ªå‚æ•°ç”¨äºå®šä¹‰ç´¢å¼•ä¸­çš„å­—æ®µå’Œå­—æ®µç±»å‹ã€‚### properties: è¿™ä¸ªå‚æ•°å®šä¹‰äº†ç´¢å¼•ä¸­çš„å­—æ®µå’Œå­—æ®µç±»å‹ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæœ‰å››ä¸ªå­—æ®µï¼štitleã€categoryã€images å’Œ priceã€‚### title: è¿™ä¸ªå­—æ®µçš„ç±»å‹æ˜¯ textï¼Œè¡¨ç¤ºå®ƒæ˜¯ä¸€ä¸ªå…¨æ–‡æ£€ç´¢å­—æ®µã€‚text é€‚åˆå­˜å‚¨é•¿æ–‡æœ¬æ•°æ®ï¼Œå¹¶æ”¯æŒå…¨æ–‡æœç´¢ã€‚### category: è¿™ä¸ªå­—æ®µçš„ç±»å‹æ˜¯ keywordï¼Œè¡¨ç¤ºå®ƒæ˜¯ä¸€ä¸ªå…³é”®å­—å­—æ®µï¼Œä¸æ”¯æŒå…¨æ–‡æ£€ç´¢ã€‚keyword é€‚åˆå­˜å‚¨ä¸éœ€è¦åˆ†è¯çš„çŸ­æ–‡æœ¬æ•°æ®ï¼ˆå¦‚æ ‡ç­¾ã€ç±»åˆ«ç­‰ï¼‰ï¼Œå¹¶ä¸”å¯ä»¥ç”¨äºèšåˆå’Œè¿‡æ»¤ã€‚### price: è¿™ä¸ªå­—æ®µçš„ç±»å‹æ˜¯ doubleï¼Œè¡¨ç¤ºå®ƒæ˜¯ä¸€ä¸ªæ•°å­—å­—æ®µã€‚double è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªåŒç²¾åº¦æµ®ç‚¹æ•°å­—æ®µï¼Œé€‚åˆå­˜å‚¨æ•°å€¼æ•°æ®ï¼Œå¦‚ä»·æ ¼### count: è¿™ä¸ªå­—æ®µçš„ç±»å‹æ˜¯ integerï¼Œè¡¨ç¤ºå®ƒæ˜¯ä¸€ä¸ªæ•´æ•°å­—æ®µã€‚integer è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªæ•´æ•°å­—æ®µï¼Œé€‚åˆå­˜å‚¨æ•´æ•°æ•°æ®ï¼Œå¦‚å•†å“æ•°é‡ç­‰ã€‚# è¿”å›å€¼&#123;&quot;acknowledged&quot;:true,&quot;shards_acknowledged&quot;:true,&quot;index&quot;:&quot;shopping&quot;&#125; æ›´æ–°ç´¢å¼•æ˜ å°„ 1234567891011121314151617181920212223242526272829303132333435363738# PUT /&lt;target&gt;/_mapping# æ³¨æ„è¯¥apiåªèƒ½å¢åŠ æ–°çš„å­—æ®µï¼Œä¸èƒ½ä¿®æ”¹å·²æœ‰å­—æ®µï¼Œå¦‚æœè¦ä¿®æ”¹æºå­—æ®µç±»å‹æˆ–è€…åˆ†è¯å™¨ç±»å‹ï¼Œä¸‹æ–‡ä¼šä»‹ç»curl -X PUT -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_mapping&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;properties&quot;:&#123; &quot;remark&quot;:&#123; &quot;type&quot;:&quot;text&quot;, &quot;analyzer&quot;:&quot;ik_max_word&quot;, &quot;search_analyzer&quot;:&quot;ik_smart&quot; &#125;, &quot;address&quot;: &#123; &quot;type&quot;: &quot;text&quot;, &quot;analyzer&quot;: &quot;ik_max_word&quot;, &quot;fields&quot;: &#123; &quot;keyword&quot;: &#123; &quot;type&quot;: &quot;keyword&quot; &#125; &#125; &#125;, &quot;tags&quot;: &#123; &quot;type&quot;: &quot;keyword&quot; &#125;, &quot;created_at&quot;: &#123;&quot;type&quot;: &quot;date&quot;, &quot;format&quot;: &quot;yyyy-MM-dd HH:mm:ss&quot;&#125; &#125; &#125;&#x27;# å‚æ•°è¯´æ˜# è¿™é‡Œä¸ºç´¢å¼•æ·»åŠ äº†4ä¸ªå­—æ®µ# remarkï¼šæ–°å¢å­—æ®µï¼Œç±»å‹ä¸ºtextï¼Œåˆ†è¯å™¨ä¸ºik_max_wordï¼Œæœç´¢åˆ†è¯å™¨ä¸ºik_smart # analyzer: ç´¢å¼•åˆ†è¯å™¨ # search_analyzerï¼šæœç´¢åˆ†è¯å™¨ # ik_max_wordï¼šä¸­æ–‡åˆ†è¯å™¨ï¼Œå°†å¥å­æ‹†åˆ†ä¸ºæœ€å¤šè¯å…ƒï¼Œé€‚åˆé•¿å¥å­ # ik_smartï¼šä¸­æ–‡åˆ†è¯å™¨ï¼Œå°†å¥å­æ‹†åˆ†ä¸ºæœ€å°‘è¯å…ƒï¼Œé€‚åˆçŸ­å¥å­# addressï¼šæ–°å¢å­—æ®µï¼Œç±»å‹ä¸ºtextï¼Œåˆ†è¯å™¨ä¸ºik_max_wordï¼Œæœç´¢åˆ†è¯å™¨æœªæŒ‡å®šï¼Œé»˜è®¤ä¸åˆ†è¯å™¨åŒä¸€ä¸ªï¼Œè¿™é‡Œè¿˜ä¸ºaddressæ·»åŠ äº†keywordå­—æ®µï¼Œç”¨äºå­˜å‚¨åŸå§‹æ•°æ®ï¼Œä»¥æ”¯æŒç²¾ç¡®æœç´¢# tagsï¼šæ–°å¢å­—æ®µï¼Œç±»å‹ä¸ºkeywordï¼Œä¸æ”¯æŒåˆ†è¯ï¼Œé€‚åˆå­˜å‚¨çŸ­æ–‡æœ¬æ•°æ®ï¼ˆå¦‚æ ‡ç­¾ã€ç±»åˆ«ç­‰ï¼‰ï¼Œå¹¶ä¸”å¯ä»¥ç”¨äºèšåˆå’Œè¿‡æ»¤ï¼Œå¯ä»¥å­˜å‚¨æ•°ç»„# created_atï¼šæ–°å¢å­—æ®µï¼Œç±»å‹ä¸ºdateï¼Œæ ¼å¼ä¸ºyyyy-MM-dd HH:mm:ss# è¿”å›å€¼&#123;&quot;acknowledged&quot;:true&#125; æ›´æ–°ç´¢å¼•è®¾ç½® 1234567# PUT /&lt;target&gt;/_settings# æ³¨æ„è¿™é‡Œä¸èƒ½æ›´æ–°number_of_shardscurl -X PUT -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_settings&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123;&quot;number_of_replicas&quot;:&quot;1&quot;&#125;&#x27;# è¿”å›å€¼&#123;&quot;acknowledged&quot;:true&#125; æŸ¥çœ‹æŒ‡å®šç´¢å¼• 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364# GET /&lt;target&gt;curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping?pretty&#x27;# è¿”å›å€¼&#123; &quot;shopping&quot; : &#123; &quot;aliases&quot; : &#123; &#125;, &quot;mappings&quot; : &#123; &quot;properties&quot; : &#123; &quot;address&quot; : &#123; &quot;type&quot; : &quot;text&quot;, &quot;fields&quot; : &#123; &quot;keyword&quot; : &#123; &quot;type&quot; : &quot;keyword&quot; &#125; &#125;, &quot;analyzer&quot; : &quot;ik_max_word&quot; &#125;, &quot;category&quot; : &#123; &quot;type&quot; : &quot;keyword&quot; &#125;, &quot;count&quot; : &#123; &quot;type&quot; : &quot;integer&quot; &#125;, &quot;created_at&quot; : &#123; &quot;type&quot; : &quot;date&quot;, &quot;format&quot; : &quot;yyyy-MM-dd HH:mm:ss&quot; &#125;, &quot;price&quot; : &#123; &quot;type&quot; : &quot;double&quot; &#125;, &quot;remark&quot; : &#123; &quot;type&quot; : &quot;text&quot;, &quot;analyzer&quot; : &quot;ik_max_word&quot;, &quot;search_analyzer&quot; : &quot;ik_smart&quot; &#125;, &quot;tags&quot; : &#123; &quot;type&quot; : &quot;keyword&quot; &#125;, &quot;title&quot; : &#123; &quot;type&quot; : &quot;text&quot; &#125; &#125; &#125;, &quot;settings&quot; : &#123; &quot;index&quot; : &#123; &quot;routing&quot; : &#123; &quot;allocation&quot; : &#123; &quot;include&quot; : &#123; &quot;_tier_preference&quot; : &quot;data_content&quot; &#125; &#125; &#125;, &quot;number_of_shards&quot; : &quot;1&quot;, &quot;provided_name&quot; : &quot;shopping&quot;, &quot;creation_date&quot; : &quot;1745291743120&quot;, &quot;number_of_replicas&quot; : &quot;1&quot;, &quot;uuid&quot; : &quot;Y1IWrdlQTUm-CbbIWweSxQ&quot;, &quot;version&quot; : &#123; &quot;created&quot; : &quot;8525000&quot; &#125; &#125; &#125; &#125;&#125; æŸ¥çœ‹ç´¢å¼•è®¾ç½® 1234567891011121314151617181920212223242526272829303132333435363738394041424344# GET /&lt;target&gt;/_settingscurl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_settings?pretty&#x27;# è¿”å›å€¼&#123; &quot;shopping&quot; : &#123; &quot;mappings&quot; : &#123; &quot;properties&quot; : &#123; &quot;address&quot; : &#123; &quot;type&quot; : &quot;text&quot;, &quot;fields&quot; : &#123; &quot;keyword&quot; : &#123; &quot;type&quot; : &quot;keyword&quot; &#125; &#125;, &quot;analyzer&quot; : &quot;ik_max_word&quot; &#125;, &quot;category&quot; : &#123; &quot;type&quot; : &quot;keyword&quot; &#125;, &quot;count&quot; : &#123; &quot;type&quot; : &quot;integer&quot; &#125;, &quot;created_at&quot; : &#123; &quot;type&quot; : &quot;date&quot;, &quot;format&quot; : &quot;yyyy-MM-dd HH:mm:ss&quot; &#125;, &quot;price&quot; : &#123; &quot;type&quot; : &quot;double&quot; &#125;, &quot;remark&quot; : &#123; &quot;type&quot; : &quot;text&quot;, &quot;analyzer&quot; : &quot;ik_max_word&quot;, &quot;search_analyzer&quot; : &quot;ik_smart&quot; &#125;, &quot;tags&quot; : &#123; &quot;type&quot; : &quot;keyword&quot; &#125;, &quot;title&quot; : &#123; &quot;type&quot; : &quot;text&quot; &#125; &#125; &#125; &#125;&#125; æŸ¥çœ‹å­—æ®µæ˜ å°„ 123456789101112131415161718# GET /&lt;target&gt;/_mapping/field/&lt;field&gt;# shopping ä¸ºç´¢å¼•åç§°ï¼Œtitle ä¸ºå­—æ®µåç§°curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_mapping/field/title?pretty&#x27;# è¿”å›å€¼&#123; &quot;shopping&quot; : &#123; &quot;mappings&quot; : &#123; &quot;title&quot; : &#123; &quot;full_name&quot; : &quot;title&quot;, &quot;mapping&quot; : &#123; &quot;title&quot; : &#123; &quot;type&quot; : &quot;text&quot; &#125; &#125; &#125; &#125; &#125;&#125; åˆ¤æ–­ç´¢å¼•æ˜¯å¦å­˜åœ¨ 12345678910111213# ä½¿ç”¨ -I å‚æ•°æ¥å‘é€ HEAD è¯·æ±‚ï¼Œå¯ä»¥è·å–å“åº”å¤´è€Œä¸å¿…ä¸‹è½½å“åº”ä½“ã€‚# HEAD /&lt;target&gt;curl -I -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping&#x27;# è¿”å›å€¼HTTP/1.1 200 OKX-elastic-product: Elasticsearchcontent-type: application/jsoncontent-length: 603# è¿™ä¸ªå‘½ä»¤ä¸ä¼šè¿”å›å“åº”ä½“ï¼Œä½†å®ƒçš„ HTTP å“åº”ä»£ç å¯ä»¥å‘Šè¯‰ä½ ç´¢å¼•çš„å­˜åœ¨æƒ…å†µï¼š # 200 OK è¡¨ç¤ºç´¢å¼•å­˜åœ¨ã€‚ # 404 Not Found è¡¨ç¤ºç´¢å¼•ä¸å­˜åœ¨ã€‚ åˆ é™¤ç´¢å¼• 1234# DELETE /&lt;target&gt;curl -X DELETE -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping&#x27;# è¿”å›å€¼&#123;&quot;acknowledged&quot;:true&#125; ä¸ºç´¢å¼•åˆ›å»ºåˆ«å 123456789101112131415161718192021# æ³¨æ„ï¼šä¸åŒç´¢å¼•å¯ä»¥æœ‰ç›¸åŒåç§°çš„åˆ«åï¼Œæ‰€ä»¥åœ¨æ•°æ®ç»“æ„ä¸€è‡´çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºä¸åŒçš„ç´¢å¼•åˆ›å»ºç›¸åŒçš„åˆ«åï¼Œç„¶åæ ¹æ®åˆ«åè¿›è¡Œæ•°æ®æŸ¥è¯¢# POST /&lt;target&gt;/_alias/&lt;alias&gt;curl -X POST -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_alias/shopping_alias&#x27;# è¿”å›å€¼&#123;&quot;acknowledged&quot;:true&#125;# ä¹Ÿå¯ä»¥ä½¿ç”¨å¦‚ä¸‹æ–¹æ³•curl -X POST -u elastic:123456 -k &#x27;https://127.0.0.1:9200/_aliases&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;actions&quot;: [ &#123; &quot;add&quot;: &#123; &quot;index&quot;: &quot;shopping&quot;, &quot;alias&quot;: &quot;shopping_alias2&quot; &#125; &#125; ] &#125;&#x27;# è¿”å›å€¼&#123;&quot;acknowledged&quot;:true&#125; æŸ¥çœ‹ç´¢å¼•åˆ«å 12345678910111213141516# GET /&lt;target&gt;/_alias/&lt;alias&gt;curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_alias/shopping_alias?pretty&#x27;# è¿”å›å€¼&#123; &quot;shopping&quot; : &#123; &quot;aliases&quot; : &#123; &quot;shopping_alias&quot; : &#123; &#125; &#125; &#125;&#125;# æŸ¥çœ‹å½“å‰ç´¢å¼•çš„æ‰€æœ‰åˆ«åcurl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_alias?pretty&#x27;# æŸ¥çœ‹æ‰€æœ‰ç´¢å¼•çš„åˆ«åcurl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/_alias?pretty&#x27; ä¸ºç´¢å¼•åˆ é™¤åˆ«å 1234# DELETE /&lt;target&gt;/_alias/&lt;alias&gt;curl -X DELETE -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_alias/shopping_alias&#x27;# è¿”å›å€¼&#123;&quot;acknowledged&quot;:true&#125; å¦‚ä½•ä¿®æ”¹ç´¢å¼•å­—æ®µç±»å‹æˆ–åˆ†è¯å™¨ç±»å‹ï¼Ÿ åˆ›å»ºæ–°çš„ç´¢å¼• 123456789101112131415161718192021222324252627282930313233343536373839404142434445# è¿™é‡Œä¸ºtitleå­—æ®µå¢åŠ åˆ†è¯å™¨curl -X PUT -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping_new&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;settings&quot;:&#123; &quot;number_of_shards&quot;:&quot;1&quot;, &quot;number_of_replicas&quot;:&quot;2&quot; &#125;, &quot;mappings&quot;:&#123; &quot;properties&quot;:&#123; &quot;category&quot;:&#123; &quot;type&quot;:&quot;keyword&quot; &#125;, &quot;price&quot;:&#123; &quot;type&quot;:&quot;double&quot; &#125;, &quot;count&quot;:&#123; &quot;type&quot;:&quot;integer&quot; &#125;, &quot;title&quot;:&#123; &quot;type&quot;:&quot;text&quot;, &quot;analyzer&quot;:&quot;ik_max_word&quot;, &quot;search_analyzer&quot;:&quot;ik_smart&quot; &#125;, &quot;remark&quot;:&#123; &quot;type&quot;:&quot;text&quot;, &quot;analyzer&quot;:&quot;ik_max_word&quot;, &quot;search_analyzer&quot;:&quot;ik_smart&quot; &#125;, &quot;address&quot;: &#123; &quot;type&quot;: &quot;text&quot;, &quot;analyzer&quot;: &quot;ik_max_word&quot;, &quot;fields&quot;: &#123; &quot;keyword&quot;: &#123; &quot;type&quot;: &quot;keyword&quot; &#125; &#125; &#125;, &quot;tags&quot;: &#123; &quot;type&quot;: &quot;keyword&quot; &#125;, &quot;created_at&quot;: &#123;&quot;type&quot;: &quot;date&quot;, &quot;format&quot;: &quot;yyyy-MM-dd HH:mm:ss&quot;&#125; &#125; &#125; &#125;&#x27; å°†åŸç´¢å¼•çš„æ•°æ®è¿ç§»åˆ°æ–°ç´¢å¼• 123456789101112curl -X POST -u elastic:123456 -k &#x27;https://127.0.0.1:9200/_reindex&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;source&quot;: &#123; &quot;index&quot;: &quot;shopping&quot; &#125;, &quot;dest&quot;: &#123; &quot;index&quot;: &quot;shopping_new&quot; &#125;&#125;&#x27;# è¿”å›å€¼&#123;&quot;took&quot;:101,&quot;timed_out&quot;:false,&quot;total&quot;:2,&quot;updated&quot;:0,&quot;created&quot;:2,&quot;deleted&quot;:0,&quot;batches&quot;:1,&quot;version_conflicts&quot;:0,&quot;noops&quot;:0,&quot;retries&quot;:&#123;&quot;bulk&quot;:0,&quot;search&quot;:0&#125;,&quot;throttled_millis&quot;:0,&quot;requests_per_second&quot;:-1.0,&quot;throttled_until_millis&quot;:0,&quot;failures&quot;:[]&#125; åˆ é™¤åŸç´¢å¼• 123curl -X DELETE -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping&#x27;# è¿”å›å€¼&#123;&quot;acknowledged&quot;:true&#125; ä¸ºæ–°ç´¢å¼•åˆ›å»ºåˆ«å 123curl -X POST -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping_new/_alias/shopping&#x27;# è¿”å›å€¼&#123;&quot;acknowledged&quot;:true,&quot;errors&quot;:false&#125; æ•°æ®å¢åˆ æ”¹åŸºæœ¬æ“ä½œ æ–°å¢æ•°æ® 1.ä¸ºæŒ‡å®šç´¢å¼•æ’å…¥ä¸€æ¡æ•°æ®(_docæ–¹å¼ï¼šä¸æŒ‡å®šidé»˜è®¤éšæœºå­—ç¬¦ä¸²) 12345678910111213141516171819202122232425262728# _doc çš„æ–¹å¼åˆ›å»ºç´¢å¼•æ•°æ®æ—¶ï¼Œå¯ä»¥ä¸æŒ‡å®šidï¼Œé»˜è®¤ä¼šåˆ›å»ºæ–°çš„idï¼Œidç±»å‹ä¸ºéšæœºå­—ç¬¦ä¸²# POST /&lt;target&gt;/_doccurl -X POST -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_doc?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;category&quot;: &quot;electronics&quot;, &quot;price&quot;: 999.99, &quot;count&quot;: 10, &quot;title&quot;: &quot;Smartphone X - 128GB&quot;, &quot;remark&quot;: &quot;This latest Smartphone X comes with a powerful processor and high-resolution camera.&quot;, &quot;address&quot;: &quot;123 Electronic Ave, Beijing, China&quot;, &quot;tags&quot;: [&quot;latest&quot;, &quot;smartphone&quot;, &quot;technology&quot;], &quot;created_at&quot;: &quot;2025-04-22 03:30:02&quot; &#125;&#x27;# è¿”å›å€¼&#123; &quot;_index&quot; : &quot;shopping_new&quot;, &quot;_id&quot; : &quot;sImNW5YBmgASmV9McVvI&quot;, &quot;_version&quot; : 1, &quot;result&quot; : &quot;created&quot;, &quot;_shards&quot; : &#123; &quot;total&quot; : 3, &quot;successful&quot; : 1, &quot;failed&quot; : 0 &#125;, &quot;_seq_no&quot; : 1, &quot;_primary_term&quot; : 1&#125; 2.ä¸ºæŒ‡å®šç´¢å¼•æ’å…¥ä¸€æ¡æ•°æ®(_docæ–¹å¼ï¼šæŒ‡å®šid) 12345678910111213141516171819202122232425262728# _doc çš„æ–¹å¼åˆ›å»ºç´¢å¼•æ•°æ®æ—¶ï¼Œå¦‚æœæŒ‡å®šidï¼Œå†æ¬¡æ‰§è¡Œæ—¶ä¼šå…ˆåˆ é™¤åŸæ•°æ®å†åˆ›å»ºæ–°æ•°æ®ï¼Œæ‰€ä»¥å¿…é¡»å…¨é‡æ›´æ–°æ‰è¡Œã€‚# PUT /&lt;target&gt;/_doccurl -X PUT -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_doc/100?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;category&quot;: &quot;electronics&quot;, &quot;price&quot;: 999.99, &quot;count&quot;: 10, &quot;title&quot;: &quot;Smartphone X - 128GB&quot;, &quot;remark&quot;: &quot;This latest Smartphone X comes with a powerful processor and high-resolution camera.&quot;, &quot;address&quot;: &quot;123 Electronic Ave, Beijing, China&quot;, &quot;tags&quot;: [&quot;latest&quot;, &quot;smartphone&quot;, &quot;technology&quot;], &quot;created_at&quot;: &quot;2025-04-22 03:30:02&quot; &#125;&#x27;# è¿”å›å€¼&#123; &quot;_index&quot; : &quot;shopping_new&quot;, &quot;_id&quot; : &quot;100&quot;, &quot;_version&quot; : 1, &quot;result&quot; : &quot;created&quot;, &quot;_shards&quot; : &#123; &quot;total&quot; : 3, &quot;successful&quot; : 1, &quot;failed&quot; : 0 &#125;, &quot;_seq_no&quot; : 2, &quot;_primary_term&quot; : 1&#125; 3.ä¸ºæŒ‡å®šç´¢å¼•æ’å…¥ä¸€æ¡æ•°æ®(_createæ–¹å¼ï¼šæŒ‡å®šid) 1234567891011121314# _create çš„æ–¹å¼åˆ›å»ºç´¢å¼•æ•°æ®æ—¶ï¼Œå¿…é¡»æŒ‡å®šid,è€Œä¸”åªèƒ½æ‰§è¡Œä¸€æ¬¡ï¼Œå› ä¸ºæ‰§è¡Œè¿‡ä¸€æ¬¡åæŒ‡å®šidçš„æ•°æ®å°±å­˜åœ¨äº†ï¼Œä¸èƒ½å†æ¬¡åˆ›å»º# POST /&lt;target&gt;/_create/&lt;id&gt;curl -X POST -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_create/1?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;category&quot;: &quot;electronics&quot;, &quot;price&quot;: 999.99, &quot;count&quot;: 10, &quot;title&quot;: &quot;Smartphone X - 128GB&quot;, &quot;remark&quot;: &quot;This latest Smartphone X comes with a powerful processor and high-resolution camera.&quot;, &quot;address&quot;: &quot;123 Electronic Ave, Beijing, China&quot;, &quot;tags&quot;: [&quot;latest&quot;, &quot;smartphone&quot;, &quot;technology&quot;], &quot;created_at&quot;: &quot;2025-04-22 03:30:02&quot; &#125;&#x27; ä¿®æ”¹æ•°æ® 1.ä¿®æ”¹å…¨éƒ¨æ•°æ® 1234567891011121314# POST /&lt;target&gt;/_doc/&lt;id&gt;# æ‰§è¡Œæ—¶ä¼šå…ˆåˆ é™¤åŸæ•°æ®å†åˆ›å»ºæ–°æ•°æ®ï¼Œæ‰€ä»¥å¿…é¡»å…¨é‡æ›´æ–°æ‰è¡Œã€‚curl -X POST -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_doc/sImNW5YBmgASmV9McVvI&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;category&quot;: &quot;electronics&quot;, &quot;price&quot;: 999.99, &quot;count&quot;: 20, &quot;title&quot;: &quot;Smartphone X - 128GB&quot;, &quot;remark&quot;: &quot;This latest Smartphone X comes with a powerful processor and high-resolution camera.&quot;, &quot;address&quot;: &quot;123 Electronic Ave, Beijing, China&quot;, &quot;tags&quot;: [&quot;latest&quot;, &quot;smartphone&quot;, &quot;technology&quot;], &quot;created_at&quot;: &quot;2025-04-22 03:30:02&quot; &#125;&#x27; 2.ä¿®æ”¹éƒ¨åˆ†æ•°æ® 12345# POST /&lt;target&gt;/_update/&lt;id&gt;# æ‰§è¡Œæ—¶åªä¼šä¿®æ”¹æŒ‡å®šå­—æ®µï¼Œä¸ä¼šåˆ é™¤åŸæ•°æ®ï¼Œæ‰€ä»¥å¯ä»¥éƒ¨åˆ†æ›´æ–°ã€‚curl -X POST -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_update/1&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123;&quot;doc&quot;:&#123;&quot;count&quot;:100&#125;&#125;&#x27; æŸ¥è¯¢æŒ‡å®šç´¢å¼•çš„æŒ‡å®šidçš„æ•°æ® 12345678910111213141516171819202122232425# GET /&lt;target&gt;/_doc/&lt;id&gt;curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_doc/100?pretty&#x27;# è¿”å›å€¼&#123; &quot;_index&quot; : &quot;shopping_new&quot;, &quot;_id&quot; : &quot;100&quot;, &quot;_version&quot; : 1, &quot;_seq_no&quot; : 2, &quot;_primary_term&quot; : 1, &quot;found&quot; : true, &quot;_source&quot; : &#123; &quot;category&quot; : &quot;electronics&quot;, &quot;price&quot; : 999.99, &quot;count&quot; : 10, &quot;title&quot; : &quot;Smartphone X - 128GB&quot;, &quot;remark&quot; : &quot;This latest Smartphone X comes with a powerful processor and high-resolution camera.&quot;, &quot;address&quot; : &quot;123 Electronic Ave, Beijing, China&quot;, &quot;tags&quot; : [ &quot;latest&quot;, &quot;smartphone&quot;, &quot;technology&quot; ], &quot;created_at&quot; : &quot;2025-04-22 03:30:02&quot; &#125;&#125; åˆ é™¤æŒ‡å®šç´¢å¼•çš„æŒ‡å®šidçš„æ•°æ® 12# DELETE /&lt;target&gt;/_doc/&lt;id&gt;curl -X DELETE -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_doc/100&#x27; åˆ é™¤ç´¢å¼•å…¨éƒ¨æ•°æ® 123curl -X POST -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_delete_by_query?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123;&quot;query&quot;:&#123;&quot;match_all&quot;:&#123;&#125;&#125;&#125;&#x27; æ‰¹é‡æ“ä½œ æ‰¹é‡æ–°å¢æ•°æ® 1234567891011121314151617181920212223242526272829303132333435363738394041# æ³¨æ„æ•°æ®è¡Œè¦é¡¶è¡Œå†™ï¼Œå‰é¢ä¸è¦æœ‰ç©ºæ ¼# POST /_bulkcurl -X POST -u elastic:123456 -k &#x27;https://127.0.0.1:9200/_bulk&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;index&quot;: &#123; &quot;_index&quot;: &quot;shopping&quot;, &quot;_id&quot;: &quot;1&quot; &#125; &#125;&#123; &quot;category&quot;: &quot;electronics&quot;, &quot;price&quot;: 999.99, &quot;count&quot;: 10, &quot;title&quot;: &quot;Smartphone X - 128GB&quot;, &quot;remark&quot;: &quot;This latest Smartphone X comes with a powerful processor and high-resolution camera.&quot;, &quot;address&quot;: &quot;å¹¿å·å¤©æ²³å…¬å›­&quot;, &quot;tags&quot;: [&quot;latest&quot;, &quot;smartphone&quot;, &quot;technology&quot;], &quot;created_at&quot;: &quot;2025-04-22 03:30:02&quot; &#125;&#123; &quot;index&quot;: &#123; &quot;_index&quot;: &quot;shopping&quot;, &quot;_id&quot;: &quot;2&quot; &#125; &#125;&#123; &quot;category&quot;: &quot;fashion&quot;, &quot;price&quot;: 49.99, &quot;count&quot;: 25, &quot;title&quot;: &quot;Designer T-shirt&quot;, &quot;remark&quot;: &quot;Trendy designer T-shirt made with high quality fabric.&quot;, &quot;address&quot;: &quot;å¹¿å·è”æ¹¾å¤§å¦&quot;, &quot;tags&quot;: [&quot;clothing&quot;, &quot;designer&quot;, &quot;style&quot;], &quot;created_at&quot;: &quot;2025-04-21 12:15:00&quot; &#125;&#123; &quot;index&quot;: &#123; &quot;_index&quot;: &quot;shopping&quot;, &quot;_id&quot;: &quot;3&quot; &#125; &#125;&#123; &quot;category&quot;: &quot;home_appliances&quot;, &quot;price&quot;: 299.99, &quot;count&quot;: 5, &quot;title&quot;: &quot;Robot Vacuum Cleaner&quot;, &quot;remark&quot;: &quot;Efficient robot vacuum cleaner with smart navigation.&quot;, &quot;address&quot;: &quot;å¹¿å·ç™½äº‘å±±å…¬å›­&quot;, &quot;tags&quot;: [&quot;appliances&quot;, &quot;vacuum&quot;, &quot;robot&quot;], &quot;created_at&quot;: &quot;2025-04-20 08:45:30&quot; &#125;&#123; &quot;index&quot;: &#123; &quot;_index&quot;: &quot;shopping&quot;, &quot;_id&quot;: &quot;4&quot; &#125; &#125;&#123; &quot;category&quot;: &quot;books&quot;, &quot;price&quot;: 19.99, &quot;count&quot;: 100, &quot;title&quot;: &quot;Inspirational Novel&quot;, &quot;remark&quot;: &quot;A gripping novel that inspires and motivates.&quot;, &quot;address&quot;: &quot;321 Book Rd, Shenzhen, China&quot;, &quot;tags&quot;: [&quot;book&quot;, &quot;novel&quot;, &quot;inspiration&quot;], &quot;created_at&quot;: &quot;2025-04-19 10:05:00&quot; &#125;&#123; &quot;index&quot;: &#123; &quot;_index&quot;: &quot;shopping&quot;, &quot;_id&quot;: &quot;5&quot; &#125; &#125;&#123; &quot;category&quot;: &quot;groceries&quot;, &quot;price&quot;: 3.99, &quot;count&quot;: 200, &quot;title&quot;: &quot;Organic Apples&quot;, &quot;remark&quot;: &quot;Fresh and crispy organic apples.&quot;, &quot;address&quot;: &quot;654 Grocery Ln, Chengdu, China&quot;, &quot;tags&quot;: [&quot;fruit&quot;, &quot;organic&quot;, &quot;healthy&quot;], &quot;created_at&quot;: &quot;2025-04-18 14:30:45&quot; &#125;&#123; &quot;index&quot;: &#123; &quot;_index&quot;: &quot;shopping&quot;, &quot;_id&quot;: &quot;6&quot; &#125; &#125;&#123; &quot;category&quot;: &quot;electronics&quot;, &quot;price&quot;: 1999.99, &quot;count&quot;: 15, &quot;title&quot;: &quot;Smartphone X - 256GB&quot;, &quot;remark&quot;: &quot;This latest Smartphone X comes with a powerful processor and high-resolution camera.&quot;, &quot;address&quot;: &quot;å¹¿å·å¤©æ²³å…¬å›­&quot;, &quot;tags&quot;: [&quot;latest&quot;, &quot;smartphone&quot;, &quot;technology&quot;], &quot;created_at&quot;: &quot;2025-04-22 03:30:02&quot; &#125;&#x27;# å‚æ•°è¯´æ˜# index: ç”¨äºåˆ›å»ºæ–°æ–‡æ¡£æˆ–æ›¿æ¢å·²æœ‰æ–‡æ¡£ã€‚# create: ç”¨äºåˆ›å»ºæ–°æ–‡æ¡£ï¼Œå¦‚æœæ–‡æ¡£å·²å­˜åœ¨ï¼Œåˆ™è¿”å›é”™è¯¯ã€‚# _index: æŒ‡å®šç´¢å¼•åç§°ã€‚# _id: æŒ‡å®šæ–‡æ¡£IDã€‚å¦‚æœä¸æŒ‡å®šåˆ™ä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªéšæœºçš„IDã€‚# æ‰¹é‡æ–°å¢æ•°æ®æ—¶ä¹Ÿå¯ä»¥åœ¨urlä¸­æŒ‡å®šç´¢å¼•åç§°# æ­¤æ—¶å¯ä»¥æŒ‡å®šidï¼Œå¦‚æœä¸æŒ‡å®šåˆ™è‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªéšæœºå­—ç¬¦ä¸²çš„ID# POST /&lt;target&gt;/_bulkcurl -X POST -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_bulk&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;index&quot;: &#123;&#125; &#125;&#123; &quot;category&quot;: &quot;electronics&quot;, &quot;price&quot;: 999.99, &quot;count&quot;: 10, &quot;title&quot;: &quot;Smartphone X - 128GB&quot;, &quot;remark&quot;: &quot;This latest Smartphone X comes with a powerful processor and high-resolution camera.&quot;, &quot;address&quot;: &quot;å¹¿å·å¤©æ²³å…¬å›­&quot;, &quot;tags&quot;: [&quot;latest&quot;, &quot;smartphone&quot;, &quot;technology&quot;], &quot;created_at&quot;: &quot;2025-04-22 03:30:02&quot; &#125;&#123; &quot;index&quot;: &#123;&#125; &#125;&#123; &quot;category&quot;: &quot;fashion&quot;, &quot;price&quot;: 49.99, &quot;count&quot;: 25, &quot;title&quot;: &quot;Designer T-shirt&quot;, &quot;remark&quot;: &quot;Trendy designer T-shirt made with high quality fabric.&quot;, &quot;address&quot;: &quot;å¹¿å·è”æ¹¾å¤§å¦&quot;, &quot;tags&quot;: [&quot;clothing&quot;, &quot;designer&quot;, &quot;style&quot;], &quot;created_at&quot;: &quot;2025-04-21 12:15:00&quot; &#125;&#123; &quot;index&quot;: &#123;&#125; &#125;&#123; &quot;category&quot;: &quot;home_appliances&quot;, &quot;price&quot;: 299.99, &quot;count&quot;: 5, &quot;title&quot;: &quot;Robot Vacuum Cleaner&quot;, &quot;remark&quot;: &quot;Efficient robot vacuum cleaner with smart navigation.&quot;, &quot;address&quot;: &quot;å¹¿å·ç™½äº‘å±±å…¬å›­&quot;, &quot;tags&quot;: [&quot;appliances&quot;, &quot;vacuum&quot;, &quot;robot&quot;], &quot;created_at&quot;: &quot;2025-04-20 08:45:30&quot; &#125;&#123; &quot;index&quot;: &#123;&#125; &#125;&#123; &quot;category&quot;: &quot;books&quot;, &quot;price&quot;: 19.99, &quot;count&quot;: 100, &quot;title&quot;: &quot;Inspirational Novel&quot;, &quot;remark&quot;: &quot;A gripping novel that inspires and motivates.&quot;, &quot;address&quot;: &quot;321 Book Rd, Shenzhen, China&quot;, &quot;tags&quot;: [&quot;book&quot;, &quot;novel&quot;, &quot;inspiration&quot;], &quot;created_at&quot;: &quot;2025-04-19 10:05:00&quot; &#125;&#123; &quot;index&quot;: &#123;&#125; &#125;&#123; &quot;category&quot;: &quot;groceries&quot;, &quot;price&quot;: 3.99, &quot;count&quot;: 200, &quot;title&quot;: &quot;Organic Apples&quot;, &quot;remark&quot;: &quot;Fresh and crispy organic apples.&quot;, &quot;address&quot;: &quot;654 Grocery Ln, Chengdu, China&quot;, &quot;tags&quot;: [&quot;fruit&quot;, &quot;organic&quot;, &quot;healthy&quot;], &quot;created_at&quot;: &quot;2025-04-18 14:30:45&quot; &#125;&#123; &quot;index&quot;: &#123;&#125; &#125;&#123; &quot;category&quot;: &quot;electronics&quot;, &quot;price&quot;: 1999.99, &quot;count&quot;: 15, &quot;title&quot;: &quot;Smartphone X - 256GB&quot;, &quot;remark&quot;: &quot;This latest Smartphone X comes with a powerful processor and high-resolution camera.&quot;, &quot;address&quot;: &quot;å¹¿å·å¤©æ²³å…¬å›­&quot;, &quot;tags&quot;: [&quot;latest&quot;, &quot;smartphone&quot;, &quot;technology&quot;], &quot;created_at&quot;: &quot;2025-04-22 03:30:02&quot; &#125;&#x27; æ‰¹é‡ä¿®æ”¹æ•°æ® 1234567891011# æ³¨æ„æ•°æ®è¡Œè¦é¡¶è¡Œå†™ï¼Œå‰é¢ä¸è¦æœ‰ç©ºæ ¼curl -X POST -u elastic:123456 -k &#x27;https://127.0.0.1:9200/_bulk&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123;&quot;update&quot;:&#123;&quot;_index&quot;:&quot;shopping&quot;,&quot;_id&quot;:&quot;1&quot;&#125;&#125;&#123;&quot;doc&quot;:&#123;&quot;title&quot;:&quot;Smartphone X2 - 128GB&quot;,&quot;price&quot;:1000.11&#125;&#125;&#123;&quot;update&quot;:&#123;&quot;_index&quot;:&quot;shopping&quot;,&quot;_id&quot;:&quot;2&quot;&#125;&#125;&#123;&quot;doc&quot;:&#123;&quot;title&quot;:&quot;T-shirt&quot;,&quot;price&quot;:45.99&#125;&#125;&#x27;# å‚æ•°è¯´æ˜# update: ç”¨äºæ›´æ–°æ–‡æ¡£ã€‚# doc: æŒ‡å®šè¦æ›´æ–°çš„å­—æ®µã€‚ æ‰¹é‡åˆ é™¤æ•°æ® 12345678910# æ³¨æ„æ•°æ®è¡Œè¦é¡¶è¡Œå†™ï¼Œå‰é¢ä¸è¦æœ‰ç©ºæ ¼curl -X POST -u elastic:123456 -k &#x27;https://127.0.0.1:9200/_bulk&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123;&quot;delete&quot;:&#123;&quot;_index&quot;:&quot;shopping&quot;,&quot;_id&quot;:&quot;1&quot;&#125;&#125;&#123;&quot;delete&quot;:&#123;&quot;_index&quot;:&quot;shopping&quot;,&quot;_id&quot;:&quot;2&quot;&#125;&#125;&#123;&quot;delete&quot;:&#123;&quot;_index&quot;:&quot;shopping&quot;,&quot;_id&quot;:&quot;3&quot;&#125;&#125;&#123;&quot;delete&quot;:&#123;&quot;_index&quot;:&quot;shopping&quot;,&quot;_id&quot;:&quot;4&quot;&#125;&#125;&#x27;# å‚æ•°è¯´æ˜# delete: ç”¨äºåˆ é™¤æ–‡æ¡£ã€‚ æ¡ä»¶æ›´æ–° 123456789101112131415161718192021# POST /&lt;target&gt;/_update_by_query# è¿™é‡Œå°†categoryä¸ºåä¸ºçš„æ•°æ®ä»·æ ¼æ”¹ä¸º1999curl -X POST -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_update_by_query?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;query&quot;: &#123; &quot;match&quot;: &#123; &quot;category&quot;: &quot;books&quot; &#125; &#125;, &quot;script&quot;: &#123; &quot;source&quot;: &quot;ctx._source.price = 20.99&quot;, &quot;lang&quot;: &quot;painless&quot; &#125; &#125;&#x27;# å‚æ•°è¯´æ˜## &quot;query&quot;: &#123;&#125; æŸ¥è¯¢æ¡ä»¶## &quot;script&quot;: &#123;&#125; è„šæœ¬### source: è„šæœ¬å†…å®¹### lang: è„šæœ¬è¯­è¨€#### painless æ˜¯ Elasticsearch å®˜æ–¹æä¾›çš„è„šæœ¬è¯­è¨€ï¼Œå®ƒæä¾›äº†è®¸å¤šå†…ç½®å‡½æ•°å’Œå˜é‡ï¼Œå¯ä»¥æ–¹ä¾¿åœ°å®ç°å„ç§å¤æ‚çš„é€»è¾‘æ“ä½œã€‚https://www.elastic.co/guide/en/elasticsearch/painless/current/painless-lang-spec.html æ¡ä»¶åˆ é™¤ 1234# POST /&lt;target&gt;/_delete_by_querycurl -X POST -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_delete_by_query?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123;&quot;query&quot;:&#123;&quot;match&quot;:&#123;&quot;category&quot;:&quot;books&quot;&#125;&#125;&#125;&#x27; æ¡ä»¶æŸ¥è¯¢ match_all: å…¨éƒ¨åŒ¹é…æŸ¥è¯¢ 1234567# GET /&lt;target&gt;/_searchcurl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123;&quot;query&quot;:&#123;&quot;match_all&quot;:&#123;&#125;&#125;&#125;&#x27;# æˆ–è€…ç®€å†™ä¸ºcurl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; term: ç²¾ç¡®åŒ¹é…æŸ¥è¯¢ï¼ˆå…³é”®å­—æŸ¥è¯¢ï¼Œå³ä¸åˆ†è¯ï¼‰ 12345678910111213curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123;&quot;query&quot;:&#123;&quot;term&quot;:&#123;&quot;category&quot;:&quot;electronics&quot;&#125;&#125;&#125;&#x27;# å¦‚æœå­—æ®µè¢«é¢å¤–è®¾ç½® keyword ç±»å‹ï¼Œåˆ™éœ€è¦åŠ ä¸Š .keyword åç¼€curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123;&quot;query&quot;:&#123;&quot;term&quot;:&#123;&quot;address.keyword&quot;:&quot;å¹¿å·ç™½äº‘å±±å…¬å›­&quot;&#125;&#125;&#125;&#x27;# termå¤„ç†å¤šå€¼å­—æ®µ(æ•°ç»„)æ—¶ï¼ŒtermæŸ¥è¯¢æ˜¯åŒ…å«ï¼Œä¸æ˜¯ç­‰äºcurl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123;&quot;query&quot;:&#123;&quot;term&quot;:&#123;&quot;tags&quot;:&quot;technology&quot;&#125;&#125;&#125;&#x27; terms: å¤šå…³é”®å­—ç²¾ç¡®åŒ¹é…æŸ¥è¯¢ 123curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123;&quot;query&quot;:&#123;&quot;terms&quot;:&#123;&quot;category&quot;:[&quot;electronics&quot;,&quot;books&quot;]&#125;&#125;&#125;&#x27; range: èŒƒå›´æŸ¥è¯¢ 12345678910111213141516171819202122232425curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123;&quot;query&quot;:&#123;&quot;range&quot;:&#123;&quot;price&quot;:&#123;&quot;gte&quot;:20,&quot;lte&quot;:30&#125;&#125;&#125;&#125;&#x27; # gte: å¤§äºç­‰äº # lte: å°äºç­‰äº # gt: å¤§äº # lt: å°äº# æ—¶é—´èŒƒå›´æŸ¥è¯¢curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123;&quot;query&quot;:&#123;&quot;range&quot;:&#123;&quot;created_at&quot;:&#123;&quot;gte&quot;:&quot;2025-04-20 00:00:00&quot;,&quot;lte&quot;:&quot;2025-05-20 23:59:59&quot;&#125;&#125;&#125;&#125;&#x27;# åŸºäºæ—¥æœŸæ•°å­¦è¡¨è¾¾å¼æŸ¥è¯¢curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123;&quot;query&quot;:&#123;&quot;range&quot;:&#123;&quot;created_at&quot;:&#123;&quot;gte&quot;:&quot;now-1y&quot;&#125;&#125;&#125;&#125;&#x27;# æ”¯æŒçš„æ—¥æœŸè¡¨è¾¾å¼# - nowï¼šå½“å‰æ—¶é—´ç‚¹ã€‚# - now-1dï¼šä»å½“å‰æ—¶é—´ç‚¹å‘å‰æ¨1å¤©çš„æ—¶é—´ç‚¹ã€‚# - now-1wï¼šä»å½“å‰æ—¶é—´ç‚¹å‘å‰æ¨1å‘¨çš„æ—¶é—´ç‚¹ã€‚# - now-1Mï¼šä»å½“å‰æ—¶é—´ç‚¹å‘å‰æ¨1ä¸ªæœˆçš„æ—¶é—´ç‚¹ã€‚# - now-1yï¼šä»å½“å‰æ—¶é—´ç‚¹å‘å‰æ¨1å¹´çš„æ—¶é—´ç‚¹ã€‚# - now+1hï¼šä»å½“å‰æ—¶é—´ç‚¹å‘åæ¨1å°æ—¶çš„æ—¶é—´ç‚¹ã€‚ exists: æŸ¥è¯¢å­—æ®µå­˜åœ¨çš„æ•°æ® 12345curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123;&quot;query&quot;:&#123;&quot;exists&quot;:&#123;&quot;field&quot;:&quot;title&quot;&#125;&#125;&#125;&#x27; # field: æŒ‡å®šè¦æŸ¥è¯¢çš„å­—æ®µ # ç¤ºä¾‹ï¼šæŸ¥è¯¢ title å­—æ®µå­˜åœ¨çš„æ–‡æ¡£ ids: æ ¹æ®ä¸€ç»„IDæŸ¥è¯¢ 12345curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123;&quot;query&quot;:&#123;&quot;ids&quot;:&#123;&quot;values&quot;:[&quot;1&quot;,&quot;2&quot;]&#125;&#125;&#125;&#x27; # values: æŒ‡å®šè¦æŸ¥è¯¢çš„IDåˆ—è¡¨ # ç¤ºä¾‹ï¼šæŸ¥è¯¢IDä¸º1å’Œ2çš„æ–‡æ¡£ prefix: å‰ç¼€æŸ¥è¯¢ ä»…é€‚ç”¨äºå…³é”®å­—ç±»å‹(keyword)çš„å­—æ®µ 123456789101112curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123;&quot;query&quot;:&#123;&quot;prefix&quot;:&#123;&quot;category&quot;:&quot;elec&quot;&#125;&#125;&#125;&#x27;# ä»…é€‚ç”¨äºkeywordç±»å‹å­—æ®µï¼Œæ‰€ä»¥ä¸‹é¢è¿™ä¸ªè¯·æ±‚æŸ¥è¯¢ä¸åˆ°æ•°æ®curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123;&quot;query&quot;:&#123;&quot;prefix&quot;:&#123;&quot;address&quot;:&quot;å¹¿å·ç™½äº‘å±±&quot;&#125;&#125;&#125;&#x27;# å› ä¸ºaddressè¢«é™„åŠ äº†keywordç±»å‹ï¼Œæ‰€ä»¥éœ€è¦åŠ ä¸Š.keywordåç¼€åå¯ä»¥æŸ¥è¯¢åˆ°æ•°æ®curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123;&quot;query&quot;:&#123;&quot;prefix&quot;:&#123;&quot;address.keyword&quot;:&quot;å¹¿å·ç™½äº‘å±±&quot;&#125;&#125;&#125;&#x27; wildcard: é€šé…ç¬¦æŸ¥è¯¢ ä»…é€‚ç”¨äºå…³é”®å­—ç±»å‹(keyword)çš„å­—æ®µ 12345curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123;&quot;query&quot;:&#123;&quot;wildcard&quot;:&#123;&quot;category&quot;:&quot;e?e*&quot;&#125;&#125;&#125;&#x27;# ?: ä»»æ„å•ä¸ªå­—ç¬¦# *: ä»»æ„å¤šä¸ªå­—ç¬¦ regexp: æ­£åˆ™è¡¨è¾¾å¼æŸ¥è¯¢ ä»…é€‚ç”¨äºå…³é”®å­—ç±»å‹(keyword)çš„å­—æ®µ 123curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123;&quot;query&quot;:&#123;&quot;regexp&quot;:&#123;&quot;category&quot;:&quot;e.e.*&quot;&#125;&#125;&#125;&#x27; fuzzy: æ”¯æŒç¼–è¾‘è·ç¦»çš„æ¨¡ç³ŠæŸ¥è¯¢ ä»…é€‚ç”¨äºå…³é”®å­—ç±»å‹(keyword)çš„å­—æ®µ fuzzyæ£€ç´¢æ˜¯ä¸€ç§å¼ºå¤§çš„æœç´¢åŠŸèƒ½ï¼Œå®ƒèƒ½å¤Ÿåœ¨ç”¨æˆ·è¾“å…¥å†…å®¹å­˜åœ¨æ‹¼å†™é”™è¯¯æˆ–ä¸Šä¸‹æ–‡ä¸ä¸€è‡´æ—¶ï¼Œä»ç„¶è¿”å›ä¸æœç´¢è¯ç›¸ä¼¼çš„æ–‡æ¡£ã€‚é€šè¿‡ä½¿ç”¨ç¼–è¾‘è·ç¦»ç®—æ³•æ¥åº¦é‡è¾“å…¥è¯ä¸æ–‡æ¡£ä¸­è¯æ¡çš„ç›¸ä¼¼ç¨‹åº¦ï¼Œæ¨¡ç³ŠæŸ¥è¯¢åœ¨ä¿è¯æœç´¢ç»“æœç›¸å…³æ€§çš„åŒæ—¶ï¼Œæœ‰æ•ˆåœ°æé«˜äº†æœç´¢å®¹é”™èƒ½åŠ›ã€‚ ç¼–è¾‘è·ç¦»æ˜¯æŒ‡ä»ä¸€ä¸ªå•è¯è½¬æ¢åˆ°å¦ä¸€ä¸ªå•è¯éœ€è¦ç¼–è¾‘å•å­—ç¬¦çš„æ¬¡æ•°ã€‚å¦‚ä¸­æ–‡é›†å›¢åˆ°ä¸­å¨é›†å›¢ç¼–è¾‘è·ç¦»å°±æ˜¯1ï¼Œåªéœ€è¦ä¿®æ”¹ä¸€ä¸ªå­—ç¬¦ï¼›å¦‚æœfuzzinesså€¼åœ¨è¿™é‡Œè®¾ç½®æˆ2ï¼Œä¼šæŠŠç¼–è¾‘è·ç¦»ä¸º2çš„ä¸œä¸œé›†å›¢ä¹ŸæŸ¥å‡ºæ¥ã€‚ 123456789101112131415curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;query&quot;:&#123; &quot;fuzzy&quot;:&#123; &quot;category&quot;:&#123; &quot;value&quot;:&quot;beeks&quot;, &quot;fuzziness&quot;:&quot;2&quot;, &quot;prefix_length&quot;:1 &#125; &#125; &#125; &#125;&#x27;# fuzzinessï¼šç”¨äºç¼–è¾‘è·ç¦»çš„è®¾ç½®ï¼Œå…¶é»˜è®¤å€¼ä¸ºAUTOï¼Œæ”¯æŒçš„æ•°å€¼ä¸º[0ï¼Œ1ï¼Œ2]ã€‚å¦‚æœå€¼è®¾ç½®è¶Šç•Œä¼šæŠ¥é”™ã€‚# prefix_length: æœç´¢è¯çš„å‰ç¼€é•¿åº¦ï¼Œåœ¨æ­¤é•¿åº¦å†…ä¸ä¼šåº”ç”¨æ¨¡ç³ŠåŒ¹é…ã€‚é»˜è®¤æ˜¯0ï¼Œå³æ•´ä¸ªè¯éƒ½ä¼šè¢«æ¨¡ç³ŠåŒ¹é…ã€‚ match: å…¨æ–‡æ£€ç´¢(å³åˆ†è¯) 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123;&quot;query&quot;:&#123;&quot;match&quot;:&#123;&quot;address&quot;:&quot;å¹¿å·ç™½äº‘å±±å…¬å›­&quot;&#125;&#125;&#125;&#x27;# å› ä¸º desc çš„ç´¢å¼•åˆ†è¯å™¨æ˜¯ ik_max_wordï¼ŒæŸ¥çœ‹â€œå¹¿å·ç™½äº‘å±±å…¬å›­â€è¢«åˆ†è¯åçš„ç»“æœcurl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/_analyze?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;analyzer&quot;: &quot;ik_max_word&quot;, &quot;text&quot;: &quot;å¹¿å·ç™½äº‘å±±å…¬å›­&quot; &#125;&#x27;# è¿”å›å€¼&#123; &quot;tokens&quot; : [ &#123; &quot;token&quot; : &quot;å¹¿å·&quot;, &quot;start_offset&quot; : 0, &quot;end_offset&quot; : 2, &quot;type&quot; : &quot;CN_WORD&quot;, &quot;position&quot; : 0 &#125;, &#123; &quot;token&quot; : &quot;ç™½äº‘å±±&quot;, &quot;start_offset&quot; : 2, &quot;end_offset&quot; : 5, &quot;type&quot; : &quot;CN_WORD&quot;, &quot;position&quot; : 1 &#125;, &#123; &quot;token&quot; : &quot;ç™½äº‘&quot;, &quot;start_offset&quot; : 2, &quot;end_offset&quot; : 4, &quot;type&quot; : &quot;CN_WORD&quot;, &quot;position&quot; : 2 &#125;, &#123; &quot;token&quot; : &quot;äº‘å±±&quot;, &quot;start_offset&quot; : 3, &quot;end_offset&quot; : 5, &quot;type&quot; : &quot;CN_WORD&quot;, &quot;position&quot; : 3 &#125;, &#123; &quot;token&quot; : &quot;å…¬å›­&quot;, &quot;start_offset&quot; : 5, &quot;end_offset&quot; : 7, &quot;type&quot; : &quot;CN_WORD&quot;, &quot;position&quot; : 4 &#125; ]&#125;# æ‰€ä»¥åªè¦descä¸­åŒ…å«å¦‚ä¸Šè¿™äº›å†…å®¹çš„æ•°æ®éƒ½ä¼šè¢«åŒ¹é…ä¸Š# ä½†æ˜¯è¿™æ ·åŒ¹é…çš„ç»“æœå°±ä¸å¤Ÿç²¾ç¡®ï¼Œå¦‚ä½•å°½é‡åŒ¹é…æ›´å¤šçš„åˆ†è¯å‘¢ï¼Œå¯ä»¥å¢åŠ  minimum_should_matchcurl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;query&quot;:&#123; &quot;match&quot;:&#123; &quot;address&quot;:&#123; &quot;query&quot;: &quot;å¹¿å·ç™½äº‘å±±å…¬å›­&quot;, &quot;minimum_should_match&quot;: 2 &#125; &#125; &#125; &#125;&#x27;# minimum_should_match: 2 è¡¨ç¤ºè‡³å°‘åŒ¹é…ä¸¤ä¸ª# å¦‚æœå¸Œæœ›å…¨éƒ¨éƒ½åŒ¹é…å‘¢curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;query&quot;:&#123; &quot;match&quot;:&#123; &quot;address&quot;:&#123; &quot;query&quot;: &quot;å¹¿å·ç™½äº‘å±±å…¬å›­&quot;, &quot;operator&quot;: &quot;and&quot; &#125; &#125; &#125; &#125;&#x27;# operator: and è¡¨ç¤ºå…¨éƒ¨åŒ¹é…ï¼Œæ­¤æ—¶ç›¸å½“äºç²¾ç¡®åŒ¹é…ï¼Œå…¶é»˜è®¤å€¼æ˜¯ or multi_match: å¤šå­—æ®µæŸ¥è¯¢ multi_matchæŸ¥è¯¢åœ¨Elasticsearchä¸­ç”¨äºåœ¨å¤šä¸ªå­—æ®µä¸Šæ‰§è¡Œç›¸åŒçš„æœç´¢æ“ä½œã€‚å®ƒå¯ä»¥æ¥å—ä¸€ä¸ªæŸ¥è¯¢å­—ç¬¦ä¸²ï¼Œå¹¶åœ¨æŒ‡å®šçš„å­—æ®µé›†åˆä¸­æœç´¢è¿™ä¸ªå­—ç¬¦ä¸²ã€‚multi_matchæŸ¥è¯¢æä¾›äº†çµæ´»çš„åŒ¹é…ç±»å‹å’Œæ“ä½œç¬¦é€‰é¡¹ï¼Œä»¥ä¾¿æ ¹æ®ä¸åŒçš„æœç´¢éœ€æ±‚è°ƒæ•´æœç´¢è¡Œä¸ºã€‚ 123456789101112curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;query&quot;:&#123; &quot;multi_match&quot;:&#123; &quot;query&quot;: &quot;å¹¿å·shirt&quot;, &quot;fields&quot;:[&quot;title&quot;,&quot;address&quot;] &#125; &#125; &#125;&#x27;# query: æŸ¥è¯¢æ¡ä»¶# fields: æŒ‡å®šå¤šä¸ªå­—æ®µè¿›è¡ŒåŒ¹é… match_phrase: çŸ­è¯­æŸ¥è¯¢ match_phraseæŸ¥è¯¢åœ¨Elasticsearchä¸­ç”¨äºæ‰§è¡ŒçŸ­è¯­æœç´¢ï¼Œå®ƒä¸ä»…åŒ¹é…æ•´ä¸ªçŸ­è¯­ï¼Œè€Œä¸”è¿˜è€ƒè™‘äº†çŸ­è¯­ä¸­å„ä¸ªè¯çš„é¡ºåºå’Œä½ç½®ã€‚è¿™ç§æŸ¥è¯¢ç±»å‹å¯¹äºæœç´¢ç²¾ç¡®çŸ­è¯­éå¸¸æœ‰ç”¨ï¼Œå°¤å…¶æ˜¯åœ¨ç”¨æˆ·è¾“å…¥çš„æŸ¥è¯¢ä¸æ–‡æ¡£ä¸­çš„æ–‡æœ¬è¡¨è¾¾æ–¹å¼éœ€è¦ä¸¥æ ¼åŒ¹é…æ—¶ã€‚ 123456789101112curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;query&quot;:&#123; &quot;match_phrase&quot;:&#123; &quot;address&quot;:&#123; &quot;query&quot;:&quot;å¹¿å·ç™½äº‘å±±&quot; &#125; &#125; &#125; &#125;&#x27;# è¦æ±‚æŸ¥è¯¢ç»“æœä¸­çš„æ•°æ®å¿…é¡»åŒ…å«&quot;å¹¿å·ç™½äº‘å±±&quot;ï¼Œè€Œä¸”â€œå¹¿å·â€å’Œâ€œç™½äº‘å±±â€è¿™ä¸¤ä¸ªè¯æ˜¯ä¸èƒ½åˆ†å¼€çš„ï¼Œå› ä¸º match_phrase åŒ¹é…çš„æ˜¯ç›¸é‚»è¯æ¡ query_string: æ”¯æŒä¸æˆ–éè¡¨è¾¾å¼çš„æŸ¥è¯¢ query_stringæŸ¥è¯¢æ˜¯ä¸€ç§çµæ´»çš„æŸ¥è¯¢ç±»å‹ï¼Œå®ƒå…è®¸ä½¿ç”¨LuceneæŸ¥è¯¢è¯­æ³•æ¥æ„å»ºå¤æ‚çš„æœç´¢æŸ¥è¯¢ã€‚è¿™ç§æŸ¥è¯¢ç±»å‹æ”¯æŒå¤šç§é€»è¾‘è¿ç®—ç¬¦ï¼ŒåŒ…æ‹¬ä¸ï¼ˆANDï¼‰ã€æˆ–ï¼ˆORï¼‰å’Œéï¼ˆNOTï¼‰ï¼Œä»¥åŠé€šé…ç¬¦ã€æ¨¡ç³Šæœç´¢å’Œæ­£åˆ™è¡¨è¾¾å¼ç­‰åŠŸèƒ½ã€‚query_stringæŸ¥è¯¢å¯ä»¥åœ¨å•ä¸ªæˆ–å¤šä¸ªå­—æ®µä¸Šè¿›è¡Œæœç´¢ï¼Œå¹¶ä¸”å¯ä»¥å¤„ç†å¤æ‚çš„æŸ¥è¯¢é€»è¾‘ã€‚ æ³¨æ„: æŸ¥è¯¢å­—æ®µåˆ†è¯å°±å°†æŸ¥è¯¢æ¡ä»¶åˆ†è¯æŸ¥è¯¢ï¼ŒæŸ¥è¯¢å­—æ®µä¸åˆ†è¯å°†æŸ¥è¯¢æ¡ä»¶ä¸åˆ†è¯æŸ¥è¯¢ 12345678910111213141516171819202122232425262728293031323334# æŸ¥è¯¢æ‰€æœ‰å­—æ®µä¸­åŒ…å« &quot;å…¬å›­&quot;å’Œ &quot;åä¸º&quot; çš„æ–‡æ¡£curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;query&quot;:&#123; &quot;query_string&quot;:&#123; &quot;query&quot;:&quot;å…¬å›­ AND electronics&quot; &#125; &#125; &#125;&#x27;# æŒ‡å®šæŸ¥è¯¢çš„å•ä¸ªå­—æ®µcurl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;query&quot;:&#123; &quot;query_string&quot;:&#123; &quot;default_field&quot;:&quot;category&quot;, &quot;query&quot;:&quot;ç™½äº‘å±± OR books&quot; &#125; &#125; &#125;&#x27;# æŒ‡å®šæŸ¥è¯¢çš„å¤šä¸ªå­—æ®µcurl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;query&quot;:&#123; &quot;query_string&quot;:&#123; &quot;fields&quot;:[&quot;category&quot;,&quot;address&quot;], &quot;query&quot;:&quot;ç™½äº‘å±± OR (electronics AND shirt)&quot; &#125; &#125; &#125;&#x27; simple_query_string: ç±»ä¼¼ query_stringï¼Œä½†æ˜¯ä¼šå¿½ç•¥é”™è¯¯çš„è¯­æ³•ï¼ŒåŒæ—¶åªæ”¯æŒéƒ¨åˆ†æŸ¥è¯¢è¯­æ³• 1234567891011curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;query&quot;:&#123; &quot;simple_query_string&quot;:&#123; &quot;query&quot;:&quot;å¹¿å·å…¬å›­&quot;, &quot;default_operator&quot;:&quot;AND&quot; &#125; &#125; &#125;&#x27;# default_operator: é»˜è®¤ä¸º ORï¼Œè®¾ç½®ä¸º AND åˆ™å¿…é¡»åŒæ—¶åŒ¹é… ESæŸ¥è¯¢ç»“æœå±æ€§å«ä¹‰ 123456789101112131415161718&#123; &quot;took&quot;:16, # è¡¨ç¤ºæŸ¥è¯¢ä»è¯·æ±‚åˆ°å®Œæˆè€—æ—¶ 16 æ¯«ç§’ã€‚ &quot;timed_out&quot;:false, # è¡¨ç¤ºæŸ¥è¯¢åœ¨è§„å®šçš„æ—¶é—´å†…å®Œæˆï¼Œæ²¡æœ‰å‘ç”Ÿè¶…æ—¶ã€‚å¦‚æœä¸º trueï¼Œåˆ™è¡¨ç¤ºæŸ¥è¯¢è¶…æ—¶ã€‚ &quot;_shards&quot;:&#123; # æ¶‰åŠåˆ°æŸ¥è¯¢è¿‡ç¨‹ä¸­ä½¿ç”¨çš„åˆ†ç‰‡ä¿¡æ¯ &quot;total&quot;:1, # è¡¨ç¤ºæŸ¥è¯¢æ¶‰åŠåˆ°çš„æ€»åˆ†ç‰‡æ•°ä¸º 1 &quot;successful&quot;:1, # è¡¨ç¤ºæŸ¥è¯¢æˆåŠŸå®Œæˆçš„åˆ†ç‰‡æ•°ä¸º 1 &quot;skipped&quot;:0, # è¡¨ç¤ºæŸ¥è¯¢è¿‡ç¨‹ä¸­è¢«è·³è¿‡çš„åˆ†ç‰‡æ•°ä¸º 0 &quot;failed&quot;:0 # è¡¨ç¤ºæŸ¥è¯¢è¿‡ç¨‹ä¸­å¤±è´¥çš„åˆ†ç‰‡æ•°ä¸º 0 &#125;, &quot;hits&quot;:&#123; # åŒ…å«æŸ¥è¯¢ç»“æœçš„è¯¦ç»†ä¿¡æ¯ &quot;total&quot;:&#123; # åŒ…å«æŸ¥è¯¢ç»“æœçš„æ€»æ•° &quot;value&quot;:4, # è¡¨ç¤ºæŸ¥è¯¢ç»“æœçš„æ€»æ•°ä¸º 4 &quot;relation&quot;:&quot;eq&quot; # è¡¨ç¤ºè¿”å›çš„æ€»æ•° value æ˜¯ç¡®åˆ‡çš„ï¼ˆequalï¼‰ã€‚å¦‚æœä¸º gteï¼Œåˆ™è¡¨ç¤ºè¿”å›çš„æ€»æ•°æ˜¯ä¸€ä¸ªä¸‹é™å€¼ã€‚ &#125;, &quot;max_score&quot;:0.0, # è¡¨ç¤ºåŒ¹é…åˆ°çš„æ–‡æ¡£ä¸­æœ€é«˜çš„å¾—åˆ†ã€‚å¦‚æœæ˜¯æ’åºæŸ¥è¯¢ï¼Œè¿™ä¸ªå€¼ä¼šæœ‰æ„ä¹‰ã€‚å½“å‰ç»“æœå› ä¸º size: 0ï¼Œæ²¡æœ‰å®é™…è¿”å›æ–‡æ¡£ï¼Œæ‰€ä»¥å¾—åˆ†ä¸º 0.0 &quot;hits&quot;:[ ] # åŒ…å«æŸ¥è¯¢ç»“æœçš„åˆ—è¡¨ï¼Œæ¯ä¸ªç»“æœéƒ½æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼ŒåŒ…å«æ–‡æ¡£çš„å…ƒæ•°æ®ï¼Œå¦‚ idã€åˆ†æ•°ç­‰ã€‚ &#125;&#125; bool æŸ¥è¯¢ å¸ƒå°”æŸ¥è¯¢å¯ä»¥æŒ‰ç…§å¸ƒå°”é€»è¾‘æ¡ä»¶ç»„ç»‡å¤šæ¡æŸ¥è¯¢è¯­å¥ï¼Œåªæœ‰ç¬¦åˆæ•´ä¸ªå¸ƒå°”æ¡ä»¶çš„æ–‡æ¡£æ‰ä¼šè¢«æœç´¢å‡ºæ¥ã€‚ åœ¨å¸ƒå°”æ¡ä»¶ä¸­ï¼Œå¯ä»¥åŒ…å«ä¸¤ç§ä¸åŒçš„ä¸Šä¸‹æ–‡ã€‚ 1.æœç´¢ä¸Šä¸‹æ–‡(query context)ï¼šä½¿ç”¨æœç´¢ä¸Šä¸‹æ–‡æ—¶ï¼ŒElasticsearchéœ€è¦è®¡ç®—æ¯ä¸ªæ–‡æ¡£ä¸æœç´¢æ¡ä»¶çš„ç›¸å…³åº¦å¾—åˆ†ï¼Œè¿™ä¸ªå¾—åˆ†çš„è®¡ç®—éœ€ä½¿ç”¨ä¸€å¥—å¤æ‚çš„è®¡ç®—å…¬å¼ï¼Œæœ‰ä¸€å®šçš„æ€§èƒ½å¼€é”€ï¼Œå¸¦æ–‡æœ¬åˆ†æçš„å…¨æ–‡æ£€ç´¢çš„æŸ¥è¯¢è¯­å¥å¾ˆé€‚åˆæ”¾åœ¨æœç´¢ä¸Šä¸‹æ–‡ä¸­ã€‚ 2.è¿‡æ»¤ä¸Šä¸‹æ–‡(filter context)ï¼šä½¿ç”¨è¿‡æ»¤ä¸Šä¸‹æ–‡æ—¶ï¼ŒElasticsearchåªéœ€è¦åˆ¤æ–­æœç´¢æ¡ä»¶è·Ÿæ–‡æ¡£æ•°æ®æ˜¯å¦åŒ¹é…ï¼Œä¾‹å¦‚ä½¿ç”¨Term queryåˆ¤æ–­ä¸€ä¸ªå€¼æ˜¯å¦è·Ÿæœç´¢å†…å®¹ä¸€è‡´ï¼Œä½¿ç”¨Range queryåˆ¤æ–­æŸæ•°æ®æ˜¯å¦ä½äºæŸä¸ªåŒºé—´ç­‰ã€‚è¿‡æ»¤ä¸Šä¸‹æ–‡çš„æŸ¥è¯¢ä¸éœ€è¦è¿›è¡Œç›¸å…³åº¦å¾—åˆ†è®¡ç®—ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ç¼“å­˜åŠ å¿«å“åº”é€Ÿåº¦ï¼Œå¾ˆå¤šæœ¯è¯­çº§æŸ¥è¯¢è¯­å¥éƒ½é€‚åˆæ”¾åœ¨è¿‡æ»¤ä¸Šä¸‹æ–‡ä¸­ã€‚ bool æŸ¥è¯¢åŒ…å« mustã€must_notã€shouldã€filter å››ç§å­å¥ã€‚ ç±»å‹ è¯´æ˜ must å¯åŒ…å«å¤šä¸ªæŸ¥è¯¢æ¡ä»¶ï¼Œæ¯ä¸ªæ¡ä»¶å‡æ»¡è¶³çš„æ–‡æ¡£æ‰èƒ½è¢«æœç´¢åˆ°ï¼Œæ¯æ¬¡æŸ¥è¯¢éœ€è¦è®¡ç®—ç›¸å…³åº¦å¾—åˆ†ï¼Œå±äºæœç´¢ä¸Šä¸‹æ–‡ should å¯åŒ…å«å¤šä¸ªæŸ¥è¯¢æ¡ä»¶ï¼Œä¸å­˜åœ¨mustå’Œfiteræ¡ä»¶æ—¶ï¼Œè‡³å°‘è¦æ»¡è¶³å¤šä¸ªæŸ¥è¯¢æ¡ä»¶ä¸­çš„ä¸€ä¸ªï¼Œæ–‡æ¡£æ‰èƒ½è¢«æœç´¢åˆ°ï¼Œå¦åˆ™éœ€æ»¡è¶³çš„æ¡ä»¶æ•°é‡ä¸å—é™åˆ¶,åŒ¹é…åˆ°çš„æŸ¥è¯¢è¶Šå¤šç›¸å…³åº¦è¶Šé«˜ï¼Œä¹Ÿå±äºæœç´¢ä¸Šä¸‹æ–‡ filter å¯åŒ…å«å¤šä¸ªè¿‡æ»¤æ¡ä»¶ï¼Œæ¯ä¸ªæ¡ä»¶å‡æ»¡è¶³çš„æ–‡æ¡£æ‰èƒ½è¢«æœç´¢åˆ°ï¼Œæ¯ä¸ªè¿‡æ»¤æ¡ä»¶ä¸è®¡ç®—ç›¸å…³åº¦å¾—åˆ†ï¼Œç»“æœåœ¨ä¸€å®šæ¡ä»¶ä¸‹ä¼šè¢«ç¼“å­˜ï¼Œ å±äºè¿‡æ»¤ä¸Šä¸‹æ–‡ must_not å¯åŒ…å«å¤šä¸ªè¿‡æ»¤æ¡ä»¶ï¼Œæ¯ä¸ªæ¡ä»¶å‡ä¸æ»¡è¶³çš„æ–‡æ¡£æ‰èƒ½è¢«æœç´¢åˆ°ï¼Œæ¯ä¸ªè¿‡æ»¤æ¡ä»¶ä¸è®¡ç®—ç›¸å…³åº¦å¾—åˆ†ï¼Œç»“æœåœ¨ä¸€å®šæ¡ä»¶ä¸‹ä¼šè¢«ç¼“å­˜ï¼Œ å±äºè¿‡æ»¤ä¸Šä¸‹æ–‡ must 12345678910111213# ä¸¤ä¸ªæ¡ä»¶éƒ½éœ€è¦æ»¡è¶³curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;query&quot;:&#123; &quot;bool&quot;:&#123; &quot;must&quot;:[ &#123;&quot;match&quot;:&#123;&quot;category&quot;:&quot;electronics&quot;&#125;&#125;, &#123;&quot;match&quot;:&#123;&quot;desc&quot;:&quot;å…¬å›­&quot;&#125;&#125; ] &#125; &#125; &#125;&#x27; must_not 12345678910111213# ä¸¤ä¸ªæ¡ä»¶éƒ½ä¸æ»¡è¶³curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;query&quot;:&#123; &quot;bool&quot;:&#123; &quot;must_not&quot;:[ &#123;&quot;match&quot;:&#123;&quot;category&quot;:&quot;electronics&quot;&#125;&#125;, &#123;&quot;match&quot;:&#123;&quot;desc&quot;:&quot;å…¬å›­&quot;&#125;&#125; ] &#125; &#125; &#125;&#x27; should 12345678910111213# ä¸¤ä¸ªæ¡ä»¶æ»¡è¶³ä¸€ä¸ªå³å¯curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;query&quot;:&#123; &quot;bool&quot;:&#123; &quot;should&quot;:[ &#123;&quot;match&quot;:&#123;&quot;category&quot;:&quot;electronics&quot;&#125;&#125;, &#123;&quot;match&quot;:&#123;&quot;desc&quot;:&quot;å…¬å›­&quot;&#125;&#125; ] &#125; &#125; &#125;&#x27; filter 12345678910111213# filterä¸­çš„æ¡ä»¶ä¸ºé matchï¼Œå³ä¸èƒ½æ˜¯å…¨æ–‡æ£€ç´¢curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;query&quot;:&#123; &quot;bool&quot;:&#123; &quot;filter&quot;:[ &#123;&quot;term&quot;:&#123;&quot;category&quot;:&quot;electronics&quot;&#125;&#125;, &#123;&quot;range&quot;:&#123;&quot;price&quot;:&#123;&quot;gte&quot;:20&#125;&#125;&#125; ] &#125; &#125; &#125;&#x27; åˆ†é¡µä¸æ’åº 1234567891011# from: ä»ç¬¬å‡ æ¡å¼€å§‹ï¼Œé»˜è®¤0# size: å–å¤šå°‘æ¡# sort: æ’åºï¼Œé»˜è®¤ä¸ºæŒ‰æ–‡æ¡£idå‡åºcurl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;query&quot;:&#123;&quot;range&quot;:&#123;&quot;price&quot;:&#123;&quot;gte&quot;:20,&quot;lte&quot;:30&#125;&#125;&#125;, &quot;sort&quot;:[&#123;&quot;price&quot;:&quot;address&quot;&#125;], &quot;from&quot;:0, &quot;size&quot;:5 &#125;&#x27; åªè¿”å›éƒ¨åˆ†å­—æ®µ 1234567# _source: æŒ‡å®šè¦è¿”å›çš„å­—æ®µåˆ—è¡¨curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27; &#123;&quot;query&quot;:&#123;&quot;range&quot;:&#123;&quot;price&quot;:&#123;&quot;gte&quot;:20,&quot;lte&quot;:30&#125;&#125;&#125;, &quot;_source&quot;:[&quot;category&quot;,&quot;title&quot;,&quot;price&quot;] &#125;&#x27; é«˜äº®æ˜¾ç¤º 123456789101112131415161718# é«˜äº®æ˜¾ç¤ºä»…æ”¯æŒå…¨æ–‡æ£€ç´¢å­—æ®µcurl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;query&quot;: &#123; &quot;multi_match&quot;: &#123; &quot;fields&quot;: [&quot;title&quot;,&quot;address&quot;], &quot;query&quot;: &quot;å…¬å›­shirt&quot; &#125; &#125;, &quot;highlight&quot;: &#123; &quot;post_tags&quot;: [&quot;&lt;/span&gt;&quot;], &quot;pre_tags&quot;: [&quot;&lt;span style=&#x27;color:red&#x27;&gt;&quot;], &quot;fields&quot;: &#123; &quot;*&quot;:&#123;&#125; &#125; &#125; &#125;&#x27; åœ°ç†ç©ºé—´ä½ç½®æŸ¥è¯¢ åœ°ç†ç©ºé—´ä½ç½®æŸ¥è¯¢æ˜¯æ•°æ®åº“å’Œæœç´¢ç³»ç»Ÿä¸­çš„ä¸€ä¸ªé‡è¦ç‰¹æ€§ï¼Œç‰¹åˆ«æ˜¯åœ¨åœ°ç†ä¿¡æ¯ç³»ç»Ÿï¼ˆGISï¼‰å’Œä½ç½®æœåŠ¡ä¸­ã€‚å®ƒå…è®¸ç”¨æˆ·åŸºäºåœ°ç†ä½ç½®ä¿¡æ¯æ¥æœç´¢å’Œè¿‡æ»¤æ•°æ®ã€‚åœ¨Elasticsearchè¿™æ ·çš„å…¨æ–‡æœç´¢å¼•æ“ä¸­ï¼Œåœ°ç†ç©ºé—´ä½ç½®æŸ¥è¯¢è¢«å¹¿æ³›åº”ç”¨ï¼Œä¾‹å¦‚åœ¨æ—…è¡Œã€æˆ¿åœ°äº§ã€ç‰©æµå’Œé›¶å”®ç­‰è¡Œä¸šï¼Œç”¨äºæä¾›åŸºäºä½ç½®çš„æœç´¢åŠŸèƒ½ã€‚ åœ¨Elasticsearchä¸­ï¼Œåœ°ç†ç©ºé—´æ•°æ®é€šå¸¸å­˜å‚¨åœ¨geo_pointå­—æ®µç±»å‹ä¸­ã€‚è¿™ç§å­—æ®µç±»å‹å¯ä»¥å­˜å‚¨çº¬åº¦å’Œç»åº¦åæ ‡ï¼Œç”¨äºè¡¨ç¤ºåœ°çƒä¸Šçš„ä¸€ä¸ªç‚¹ã€‚ ç¤ºä¾‹ åˆ›å»ºä¸€ä¸ªç´¢å¼•ï¼Œå¹¶æ·»åŠ ä¸€ä¸ªgeo_pointå­—æ®µï¼š 12345678910111213141516curl -X PUT -u elastic:123456 -k &#x27;https://127.0.0.1:9200/tourist_spots&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;mappings&quot;: &#123; &quot;properties&quot;: &#123; &quot;name&quot;: &#123; &quot;type&quot;: &quot;text&quot;, &quot;analyzer&quot;: &quot;ik_max_word&quot;, &quot;search_analyzer&quot;: &quot;ik_max_word&quot; &#125;, &quot;location&quot;: &#123; &quot;type&quot;: &quot;geo_point&quot; &#125; &#125; &#125; &#125;&#x27; æ’å…¥æ•°æ® 1234567891011curl -X POST -u elastic:123456 -k &#x27;https://127.0.0.1:9200/tourist_spots/_bulk&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123;&quot;index&quot;:&#123;&#125;&#125;&#123;&quot;name&quot;:&quot;é›·å³°å¡”&quot;,&quot;location&quot;:&#123;&quot;lat&quot;:30.2615,&quot;lon&quot;:120.1480&#125;&#125;&#123;&quot;index&quot;:&#123;&#125;&#125;&#123;&quot;name&quot;:&quot;è¥¿æ¹–&quot;,&quot;location&quot;:&#123;&quot;lat&quot;:30.2614,&quot;lon&quot;:120.1479&#125;&#125;&#123;&quot;index&quot;:&#123;&#125;&#125;&#123;&quot;name&quot;:&quot;è‹å ¤æ˜¥æ™“&quot;,&quot;location&quot;:&#123;&quot;lat&quot;:30.2624,&quot;lon&quot;:120.1708&#125;&#125;&#x27;# lat: çº¬åº¦# lon: ç»åº¦ æŸ¥è¯¢æ•°æ® 12345678910111213141516171819202122232425262728293031# æŸ¥è¯¢æ­å·è¥¿æ¹–5kmé™„è¿‘çš„æ™¯ç‚¹# é›·å³°å¡” - ä½äºè¥¿æ¹–é™„è¿‘ï¼Œè·ç¦»çº¦2.8å…¬é‡Œã€‚# è‹å ¤æ˜¥æ™“ - ä½äºè¥¿æ¹–è¾¹ï¼Œè·ç¦»è¥¿æ¹–ä¸­å¿ƒçº¦1å…¬é‡Œã€‚curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/tourist_spots/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;query&quot;: &#123; &quot;bool&quot;: &#123; &quot;must&quot;: &#123; &quot;match_all&quot;: &#123;&#125; &#125;, &quot;filter&quot;: &#123; &quot;geo_distance&quot;: &#123; &quot;distance&quot;: &quot;5km&quot;, &quot;distance_type&quot;: &quot;arc&quot;, &quot;location&quot;: &#123; &quot;lat&quot;: 30.2614, &quot;lon&quot;: 120.1479 &#125; &#125; &#125; &#125; &#125; &#125;&#x27;# distance: 5km è¡¨ç¤ºè·ç¦»ä¸º5å…¬é‡Œ# distance_type: arc, plane, sloppy_arc, # arc: é»˜è®¤å€¼ï¼Œä½¿ç”¨haversineå…¬å¼è®¡ç®—è·ç¦»ï¼Œç»“æœæ˜¯ç²¾ç¡®çš„ï¼Œä½†è®¡ç®—é€Ÿåº¦è¾ƒæ…¢ã€‚ # plane: ä½¿ç”¨å¹³é¢ç›´è§’åæ ‡ç³»è®¡ç®—è·ç¦»ï¼Œç»“æœæ˜¯ç²—ç•¥çš„ï¼Œä½†è®¡ç®—é€Ÿåº¦æ›´å¿«ã€‚ # sloppy_arc: ä½¿ç”¨haversineå…¬å¼è®¡ç®—è·ç¦»ï¼Œä½†å…è®¸è¯¯å·®ã€‚# location: æœç´¢æ¡ä»¶ å‘é‡æœç´¢ Elasticsearch 8.x å¼•å…¥äº†ä¸€ä¸ªé‡è¦çš„æ–°ç‰¹æ€§ï¼šå‘é‡æ£€ç´¢ï¼ˆVector Searchï¼‰ï¼Œç‰¹åˆ«æ˜¯é€šè¿‡KNNï¼ˆK-Nearest Neighborsï¼‰ç®—æ³•æ”¯æŒå‘é‡è¿‘é‚»æ£€ç´¢ã€‚è¿™ä¸€ç‰¹æ€§ä½¿å¾—Elasticsearchåœ¨æœºå™¨å­¦ä¹ ã€æ•°æ®åˆ†æå’Œæ¨èç³»ç»Ÿç­‰é¢†åŸŸçš„åº”ç”¨å˜å¾—æ›´åŠ å¹¿æ³›å’Œå¼ºå¤§ã€‚ å‘é‡æ£€ç´¢çš„åŸºæœ¬æ€è·¯æ˜¯ï¼Œå°†æ–‡æ¡£ï¼ˆæˆ–æ•°æ®é¡¹ï¼‰è¡¨ç¤ºä¸ºé«˜ç»´å‘é‡ï¼Œå¹¶ä½¿ç”¨è¿™äº›å‘é‡æ¥æ‰§è¡Œç›¸ä¼¼æ€§æœç´¢ã€‚åœ¨Elasticsearchä¸­ï¼Œè¿™äº›å‘é‡è¢«å­˜å‚¨åœ¨dense_vectorç±»å‹çš„å­—æ®µä¸­ï¼Œç„¶åä½¿ç”¨KNNç®—æ³•æ¥æ‰¾åˆ°ä¸ç»™å®šå‘é‡æœ€ç›¸ä¼¼çš„å…¶ä»–å‘é‡ã€‚ ç¤ºä¾‹ åˆ›å»ºç´¢å¼• 12345678910111213141516171819202122curl -X PUT -u elastic:123456 -k &#x27;https://127.0.0.1:9200/image-index&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;mappings&quot;: &#123; &quot;properties&quot;: &#123; &quot;image-vector&quot;: &#123; &quot;type&quot;: &quot;dense_vector&quot;, &quot;dims&quot;: 3 &#125;, &quot;title&quot;: &#123; &quot;type&quot;: &quot;text&quot; &#125;, &quot;file-type&quot;: &#123; &quot;type&quot;: &quot;keyword&quot; &#125;, &quot;my_label&quot;: &#123; &quot;type&quot;: &quot;text&quot; &#125; &#125; &#125; &#125;&#x27;# dims: 3 è¡¨ç¤º3ç»´å‘é‡ï¼Œæœ€é«˜æ”¯æŒ2048 æ·»åŠ æ•°æ® 123456789curl -X POST -u elastic:123456 -k &#x27;https://127.0.0.1:9200/image-index/_bulk&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;index&quot;: &#123;&#125; &#125;&#123; &quot;image-vector&quot;: [-5, 9, -12], &quot;title&quot;: &quot;Image A&quot;, &quot;file-type&quot;: &quot;jpeg&quot;, &quot;my_label&quot;: &quot;red&quot; &#125;&#123; &quot;index&quot;: &#123;&#125; &#125;&#123; &quot;image-vector&quot;: [10, -2, 3], &quot;title&quot;: &quot;Image B&quot;, &quot;file-type&quot;: &quot;png&quot;, &quot;my_label&quot;: &quot;blue&quot; &#125;&#123; &quot;index&quot;: &#123;&#125; &#125;&#123; &quot;image-vector&quot;: [4, 0, -1], &quot;title&quot;: &quot;Image C&quot;, &quot;file-type&quot;: &quot;gif&quot;, &quot;my_label&quot;: &quot;red&quot; &#125;&#x27; å‘é‡æ£€ç´¢ 1234567891011121314151617181920curl -X POST -u elastic:123456 -k &#x27;https://127.0.0.1:9200/image-index/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;query&quot;:&#123; &quot;match_all&quot;: &#123;&#125; &#125;, &quot;knn&quot;: &#123; &quot;field&quot;: &quot;image-vector&quot;, &quot;query_vector&quot;: [-5, 10, -12], &quot;k&quot;: 10, &quot;num_candidates&quot;: 100 &#125;, &quot;fields&quot;: [ &quot;title&quot;, &quot;file-type&quot; ] &#125;&#x27;# query: æœç´¢æ¡ä»¶ï¼Œè¿™é‡Œå¯ä»¥ä¸åŠ è¿™ä¸ª# knn: 8.8.1 ç‰ˆæœ¬å¼€å§‹é»˜è®¤æ”¯æŒ# field: æœç´¢å‘é‡å­—æ®µ# query_vector: æœç´¢å‘é‡# k: æœç´¢ç»“æœæ•°é‡# num_candidates: æœç´¢å€™é€‰æ•°é‡ï¼Œç”¨äºä¼˜åŒ–æ€§èƒ½# fields: æœç´¢ç»“æœè¿”å›å­—æ®µ","summary":"æ‘˜è¦ æœ¬æ–‡ä»‹ç» Elasticsearch çš„ REST APIs Elasticsearchç‰ˆæœ¬8.17.3 å®˜æ–¹æ–‡æ¡£:REST APIs Elasticsearch çš„ REST APIs:èšåˆæŸ¥è¯¢","date_published":"2025-04-17T13:30:05.000Z","tags":["æŠ€æœ¯","elastic","elasticsearch","elasticsearch"]},{"id":"https://blog.hanqunfeng.com/2025/04/16/elasticsearch-04-cert/","url":"https://blog.hanqunfeng.com/2025/04/16/elasticsearch-04-cert/","title":"Elasticsearchçš„è¯ä¹¦è¿‡æœŸå¤„ç†æ–¹æ³•","content_html":"<!--\n **åŠ ç²—**\n *æ–œä½“*\n ***åŠ ç²—å¹¶æ–œä½“***\n ~~åˆ é™¤çº¿~~\n ==çªå‡ºæ˜¾ç¤º==\n `çªå‡ºæ˜¾ç¤º(æ¨è)`\n ++ä¸‹åˆ’çº¿++\n ~ä¸‹æ ‡~\n ^ä¸Šæ ‡^\n è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference.\n å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)\n\n +++ **ç‚¹å‡»æŠ˜å **\n è¿™æ˜¯è¢«éšè—çš„å†…å®¹\n +++\n\n::: tips success warning danger\nè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹\n:::\n\n% note info % success warning danger\nè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹\n% endnote %\n\nå¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{}\n å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ\n -->\n<h2 id=\"æ‘˜è¦\">æ‘˜è¦</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æœ¬æ–‡ä»‹ç»Elasticsearchè¯ä¹¦è¿‡æœŸæ—¶çš„å¤„ç†æ–¹æ³•</p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/8.17/index.html\">Elasticsearch</a>ç‰ˆæœ¬8.17.3</p>\n</li>\n<li class=\"lvl-2\">\n<p>æœ¬æ–‡åŸºäº <a href=\"/2025/03/20/elasticsearch-01-install/\" title=\"linuxä¸‹å®‰è£…Elasticsearch\">linuxä¸‹å®‰è£…Elasticsearch</a></p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/8.17/update-node-certs.html\">å®˜æ–¹æ–‡æ¡£:Updating node security certificates</a></p>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"ESè¯ä¹¦ç®€ä»‹\">ESè¯ä¹¦ç®€ä»‹</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Elasticsearch 8 é»˜è®¤æƒ…å†µä¸‹åˆ›å»ºçš„è¯ä¹¦åªæœ‰3å¹´æœ‰æ•ˆæœŸï¼Œè¿‡æœŸæ—¶éœ€è¦åˆ›å»ºæ–°çš„è¯ä¹¦ï¼Œä¸ºäº†ä¸å¿…è¦çš„éº»çƒ¦ï¼Œä¹Ÿå¯ä»¥ä¸€å¼€å§‹å°±åˆ›å»ºä¸€ä¸ªæœ‰æ•ˆæœŸæ¯”è¾ƒé•¿çš„è¯ä¹¦ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>åœ¨ Elasticsearch 8 çš„é…ç½®ä¸‹ï¼Œ<code>config/certs</code> ç›®å½•é€šå¸¸å­˜æ”¾çš„æ˜¯ç”¨äºå®‰å…¨é€šä¿¡çš„è¯ä¹¦å’Œå¯†é’¥æ–‡ä»¶ã€‚è¿™äº›æ–‡ä»¶ç¡®ä¿äº† Elasticsearch å®ä¾‹ä¹‹é—´çš„é€šè®¯ä»¥åŠä¸å¤–éƒ¨å®¢æˆ·ç«¯çš„é€šè®¯èƒ½å¤Ÿè¢«åŠ å¯†ä¸”ç»è¿‡è®¤è¯ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p><code>config/certs</code> ç›®å½•åŒ…å«ä¸‰ä¸ªæ–‡ä»¶åˆ†åˆ«æ˜¯ï¼š</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-4\"><code>http.p12</code>: è¿™æ˜¯ä¸€ä¸ª PKCS#12 æ ¼å¼çš„æ–‡ä»¶ï¼ˆé€šå¸¸å¸¦æœ‰.p12æˆ–.pfxæ‰©å±•åï¼‰ï¼ŒåŒ…å«äº† Elasticsearch HTTP å±‚ç”¨æ¥è¿›è¡Œ TLS/SSL é€šä¿¡æ‰€éœ€çš„ä¸€åˆ‡ï¼ŒåŒ…æ‹¬ä¸€ä¸ªç§é’¥ã€ç›¸åº”çš„å…¬é’¥è¯ä¹¦ï¼ˆæœåŠ¡å™¨è¯ä¹¦ï¼‰åŠ CA è¯ä¹¦é“¾ã€‚å®¢æˆ·ç«¯ä½¿ç”¨è¿™ä¸ªæ–‡ä»¶æ¥éªŒè¯å®ƒä»¬æ­£åœ¨ä¸æ­£ç¡®çš„æœåŠ¡å™¨è¿›è¡Œé€šä¿¡ï¼Œå¹¶ä¸”æ­¤æœåŠ¡å™¨ä¹Ÿä¿¡ä»»è¯¥å®¢æˆ·ç«¯ã€‚</li>\n<li class=\"lvl-4\"><code>http_ca.crt</code>: CA (Certificate Authority) æ ¹è¯ä¹¦æˆ–ä¸­é—´è¯ä¹¦ï¼Œç”¨äºéªŒè¯é€šè¿‡ HTTP åè®®è¿æ¥è‡³ Elasticsearch æœåŠ¡ç«¯ç‚¹çš„èº«ä»½ã€‚å½“å®¢æˆ·ç«¯å°è¯•å»ºç«‹ HTTPS è¿æ¥æ—¶ï¼Œå®ƒä¼šæ£€æŸ¥æ¥è‡ª Elasticsearch çš„è¯ä¹¦æ˜¯å¦ç”±è¿™ä¸ª CA ç­¾åï¼›è¿™æ˜¯ç¡®ä¿åŒæ–¹é€šä¿¡å®‰å…¨çš„é‡è¦æ­¥éª¤ä¹‹ä¸€ã€‚</li>\n<li class=\"lvl-4\"><code>transport.p12</code>: åŒæ ·ä¸º PKCS#12 æ ¼å¼ï¼Œä½†è¿™ä¸ªç‰¹å®šçš„æ–‡ä»¶æ˜¯ç»™ Elasticsearch èŠ‚ç‚¹ä¹‹é—´å†…éƒ¨ä¼ è¾“å±‚ä½¿ç”¨çš„ã€‚åœ¨é›†ç¾¤å†…ï¼ŒèŠ‚ç‚¹é—´éœ€<br>\nè¦ç›¸äº’è®¤è¯ï¼Œtransport.p12å°±åŒ…å«ç€è®©ä¸åŒ Elasticsearch å®ä¾‹èƒ½äº’ç›¸è¯†åˆ«æ‰€éœ€çš„ç§é’¥å’Œè¯ä¹¦ã€‚</li>\n</ul>\n</li>\n<li class=\"lvl-2\">\n<p>æ€»ä¹‹ï¼Œ<code>http.p12</code>æœåŠ¡äºé¢å‘ Web çš„æ¥å£ï¼Œè€Œ<code>transport.p12</code>åˆ™å¤„ç† Elasticsearch ç¾¤é›†å†…çš„äº¤äº’ï¼›ä¸¤è€…éƒ½ä¾èµ–äº<code>http_ca.crt</code>æ¥è¿›è¡Œèº«ä»½éªŒè¯è¿‡ç¨‹çš„ä¸€éƒ¨åˆ†ã€‚</p>\n</li>\n</ul>\n<h2 id=\"ESè¯ä¹¦è¿‡æœŸçš„å½±å“\">ESè¯ä¹¦è¿‡æœŸçš„å½±å“</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>â€Œé›†ç¾¤æ— æ³•å¢åŠ æ–°èŠ‚ç‚¹â€Œï¼šç‰¹åˆ«æ˜¯åœ¨é‡å¯é›†ç¾¤æ—¶ï¼ŒèŠ‚ç‚¹æ— æ³•åŠ å…¥é›†ç¾¤ï¼Œå¯¼è‡´æ— æ³•æ­£å¸¸é‡å¯ã€‚â€Œ</p>\n</li>\n<li class=\"lvl-2\">\n<p>â€Œè®¿é—®å¼‚å¸¸â€Œï¼šå¦‚æœä½¿ç”¨è¯ä¹¦è¿æ¥ESé›†ç¾¤ï¼Œä¼šå¯¼è‡´æ— æ³•æ­£å¸¸è®¿é—®é›†ç¾¤ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>â€Œå®‰å…¨é£é™©â€Œï¼šè¯ä¹¦è¿‡æœŸä¼šç ´åè¯ä¹¦é“¾çš„ä¿¡ä»»ï¼Œå¯èƒ½å¼•å‘å®‰å…¨æ¼æ´ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>â€Œæ—¥å¿—å¹²æ‰°â€Œï¼šä¼šæŒç»­å‡ºç°è¯ä¹¦è¿‡æœŸçš„é”™è¯¯æ—¥å¿—ï¼Œå¹²æ‰°é—®é¢˜æ’æŸ¥å’Œè¯Šæ–­ã€‚</p>\n</li>\n</ul>\n<h2 id=\"æŸ¥çœ‹è¯ä¹¦çš„è¿‡æœŸæ—¶é—´\">æŸ¥çœ‹è¯ä¹¦çš„è¿‡æœŸæ—¶é—´</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>é€šè¿‡opensslæŸ¥çœ‹è¯ä¹¦çš„è¿‡æœŸæ—¶é—´</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹crtè¯ä¹¦åˆ°æœŸæ—¶é—´</span></span><br><span class=\"line\"><span class=\"comment\"># -dates: æ˜¾ç¤ºè¯ä¹¦çš„å¼€å§‹æ—¶é—´å’Œç»“æŸæ—¶é—´</span></span><br><span class=\"line\"><span class=\"comment\"># -noout: ä¸è¾“å‡ºè¯ä¹¦çš„è¯¦ç»†ä¿¡æ¯</span></span><br><span class=\"line\">openssl x509 -<span class=\"keyword\">in</span> config/certs/http_ca.crt -dates -noout</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹p12è¯ä¹¦åˆ°æœŸæ—¶é—´</span></span><br><span class=\"line\"><span class=\"comment\"># -clcerts: åªæ˜¾ç¤ºè¯ä¹¦ï¼Œä¸æ˜¾ç¤ºç§é’¥</span></span><br><span class=\"line\"><span class=\"comment\"># -nokeys: ä¸è¾“å‡ºç§é’¥</span></span><br><span class=\"line\"><span class=\"comment\"># -password pass: æŒ‡å®šç§é’¥çš„å¯†ç ï¼Œè¿™é‡Œä¸ºç©º(å› ä¸ºåœ¨åˆ›å»ºè¯ä¹¦æ—¶æ²¡æœ‰è®¾ç½®å¯†ç )ï¼Œæ³¨æ„å¯†ç å¿…é¡»å†™åœ¨pass:çš„åé¢ï¼Œä¸åŠ è¿™ä¸ªå‚æ•°ä¼šæç¤ºä½ è¾“å…¥å¯†ç ï¼Œç›´æ¥å›è½¦å³å¯</span></span><br><span class=\"line\">openssl pkcs12 -<span class=\"keyword\">in</span> ca.p12 -password pass: -clcerts -nokeys | openssl x509 -dates -noout</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>é€šè¿‡ESçš„APIæŸ¥çœ‹è¯ä¹¦è¿‡æœŸæ—¶é—´</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -XGET -k -u <span class=\"string\">&#x27;elastic:123456&#x27;</span> <span class=\"string\">&#x27;https://127.0.0.1:9200/_ssl/certificates?pretty&#x27;</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"è¯ä¹¦è¿‡æœŸå¤„ç†\">è¯ä¹¦è¿‡æœŸå¤„ç†</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Elasticsearch 8 çš„è¯ä¹¦åˆ›å»ºéœ€è¦ä½¿ç”¨å‘½ä»¤è¡Œå·¥å…· <code>elasticsearch-certutil</code>ï¼Œè¿™éƒ¨åˆ†çš„è¯¦ç»†ä¿¡æ¯å¯ä»¥å‚è€ƒ<a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/8.17/certutil.html\">å®˜æ–¹æ–‡æ¡£:elasticsearch-certutil</a></p>\n</li>\n<li class=\"lvl-2\">\n<p>å½“è¯ä¹¦è¿‡æœŸæ—¶ï¼Œéœ€è¦é‡æ–°ç”Ÿæˆè¯ä¹¦ï¼Œå¹¶æ›´æ–°<code>config/certs</code>ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼Œæ›´æ–°å‰è¦å¤‡ä»½åŸè¯ä¹¦ã€‚</p>\n</li>\n</ul>\n<h3 id=\"å¤‡ä»½åŸè¯ä¹¦\">å¤‡ä»½åŸè¯ä¹¦</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ <span class=\"built_in\">cp</span> -r config/certs config/certs.bak</span><br><span class=\"line\">$ <span class=\"built_in\">rm</span> -rf config/certs/*</span><br></pre></td></tr></table></figure>\n<h3 id=\"ç”Ÿæˆæ–°è¯ä¹¦\">ç”Ÿæˆæ–°è¯ä¹¦</h3>\n<h4 id=\"ç”ŸæˆCAè¯ä¹¦\">ç”ŸæˆCAè¯ä¹¦</h4>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ç”Ÿæˆcrtè¯ä¹¦</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># --days 36500: æŒ‡å®šè¯ä¹¦çš„æœ‰æ•ˆæœŸï¼Œå•ä½ä¸ºå¤©ï¼Œè¿™é‡Œè®¾ç½®ä¸º 36500 å¤©ï¼Œå¤§çº¦ 10 å¹´</span></span><br><span class=\"line\">$ bin/elasticsearch-certutil ca --pem --out new-ca.zip --days 36500</span><br><span class=\"line\"><span class=\"comment\"># è§£å‹</span></span><br><span class=\"line\">$ unzip new-ca.zip</span><br><span class=\"line\"><span class=\"comment\"># å°†åˆ›å»ºçš„è¯ä¹¦ç§»åŠ¨åˆ°æŒ‡å®šç›®å½•</span></span><br><span class=\"line\">$ <span class=\"built_in\">mv</span> ca/ca.crt config/certs/http_ca.crt</span><br><span class=\"line\">$ <span class=\"built_in\">mv</span> ca/ca.key config/certs/http_ca.key</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ä¹Ÿå¯ä»¥ç”ŸæˆPKCS#12æ ¼å¼çš„è¯ä¹¦</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ bin/elasticsearch-certutil ca --out config/certs/ca.p12 --days 36500</span><br></pre></td></tr></table></figure>\n<h4 id=\"ç”Ÿæˆtransportè¯ä¹¦\">ç”Ÿæˆtransportè¯ä¹¦</h4>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># åŸºäºcrtè¯ä¹¦</span></span><br><span class=\"line\">$ bin/elasticsearch-certutil cert --ca-cert config/certs/http_ca.crt --ca-key config/certs/http_ca.key --out config/certs/transport.p12 --days 36500</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># åŸºäºPKCS#12æ ¼å¼çš„è¯ä¹¦</span></span><br><span class=\"line\">$ bin/elasticsearch-certutil cert --ca config/certs/ca.p12 --out config/certs/transport.p12 --days 36500</span><br></pre></td></tr></table></figure>\n<h4 id=\"ç”Ÿæˆhttpè¯ä¹¦\">ç”Ÿæˆhttpè¯ä¹¦</h4>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># è¿™é‡Œæ˜¯äº¤äº’å¼å‘½ä»¤è¡Œ</span></span><br><span class=\"line\">$ bin/elasticsearch-certutil http</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>è¾“å‡ºè¯´æ˜</p>\n</li>\n</ul>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Generate a CSR? [y/N]n # ä¸ç”ŸæˆCSR</span><br><span class=\"line\">Use an existing CA? [y/N]y # ä½¿ç”¨å·²æœ‰çš„CA</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">ä»¥ä¸‹åŒºåˆ†crtè¯ä¹¦å’ŒPKCS#12æ ¼å¼çš„è¯ä¹¦</span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">crt è¯ä¹¦</span></span><br><span class=\"line\">CA Path: certs/http_ca.crt # CAè¯ä¹¦ï¼Œè¿™é‡Œç›¸å¯¹è·¯å¾„æ˜¯ç›¸å¯¹åº” config ç›®å½•ï¼Œä¹Ÿå¯ä»¥æ˜¯ç»å¯¹è·¯å¾„</span><br><span class=\"line\">CA Key: certs/http_ca.key # CAå¯†é’¥ï¼Œè¿™é‡Œç›¸å¯¹è·¯å¾„æ˜¯ç›¸å¯¹åº” config ç›®å½•ï¼Œä¹Ÿå¯ä»¥æ˜¯ç»å¯¹è·¯å¾„</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">PKCS#12æ ¼å¼çš„è¯ä¹¦</span></span><br><span class=\"line\">CA Path: certs/ca.p12 # CAè¯ä¹¦ï¼Œè¿™é‡Œç›¸å¯¹è·¯å¾„æ˜¯ç›¸å¯¹åº” config ç›®å½•ï¼Œä¹Ÿå¯ä»¥æ˜¯ç»å¯¹è·¯å¾„</span><br><span class=\"line\">Password for ca.p12: # CAå¯†ç ï¼Œå› ä¸ºæ²¡æœ‰è®¾ç½®å¯†ç ï¼Œæ‰€ä»¥è¿™é‡Œç›´æ¥å›è½¦</span><br><span class=\"line\"></span><br><span class=\"line\">For how long should your certificate be valid? [5y] 100y # è¯ä¹¦æœ‰æ•ˆæœŸï¼Œå•ä½ä¸ºå¹´ï¼Œé»˜è®¤æ˜¯ 5 å¹´ï¼Œè¿™é‡Œè®¾ç½®ä¸º 100 å¹´</span><br><span class=\"line\">Generate a certificate per node? [y/N]n # ä¸ä¸ºæ¯ä¸ªèŠ‚ç‚¹åˆ›å»ºç‹¬ç«‹çš„è¯ä¹¦ï¼Œå³æ‰€æœ‰èŠ‚ç‚¹éƒ½ä½¿ç”¨åŒä¸€ä¸ªè¯ä¹¦</span><br><span class=\"line\">Enter all the hostnames that you need, one per line.</span><br><span class=\"line\">When you are done, press &lt;ENTER&gt; once more to move on to the next step.</span><br><span class=\"line\"></span><br><span class=\"line\">localhost # ä¸»æœºåï¼Œè¿™é‡Œå¯ä»¥æ·»åŠ å¤šä¸ªï¼Œå›è½¦ä¸€è¡Œä¸€ä¸ªï¼Œè¿™é‡Œåº”è¯¥å¡«å†™é›†ç¾¤å†…æ‰€æœ‰èŠ‚ç‚¹æœåŠ¡å™¨çš„hostnameï¼Œå¯ä»¥é€šè¿‡ hostname å‘½ä»¤æŸ¥çœ‹</span><br><span class=\"line\">ip-10-250-0-17.cn-northwest-1.compute.internal</span><br><span class=\"line\">ip-10-250-0-173.cn-northwest-1.compute.internal</span><br><span class=\"line\">ip-10-250-0-239.cn-northwest-1.compute.internal</span><br><span class=\"line\"></span><br><span class=\"line\">You entered the following hostnames.</span><br><span class=\"line\"></span><br><span class=\"line\"> - localhost</span><br><span class=\"line\"> - ip-10-250-0-17.cn-northwest-1.compute.internal</span><br><span class=\"line\"> - ip-10-250-0-173.cn-northwest-1.compute.internal</span><br><span class=\"line\"> - ip-10-250-0-239.cn-northwest-1.compute.internal</span><br><span class=\"line\"></span><br><span class=\"line\">Is this correct [Y/n]y # ç¡®è®¤ä¸»æœºåæ˜¯å¦æ­£ç¡®</span><br><span class=\"line\"></span><br><span class=\"line\">Enter all the IP addresses that you need, one per line.</span><br><span class=\"line\">When you are done, press &lt;ENTER&gt; once more to move on to the next step.</span><br><span class=\"line\"></span><br><span class=\"line\">127.0.0.1 # ä¸»æœºIPï¼Œè¿™é‡Œå¯ä»¥æ·»åŠ å¤šä¸ªï¼Œå›è½¦ä¸€è¡Œä¸€ä¸ªï¼Œè¿™é‡Œåº”è¯¥å¡«å†™é›†ç¾¤å†…æ‰€æœ‰èŠ‚ç‚¹æœåŠ¡å™¨çš„IPåœ°å€</span><br><span class=\"line\">10.250.0.17</span><br><span class=\"line\">10.250.0.173</span><br><span class=\"line\">10.250.0.239</span><br><span class=\"line\"></span><br><span class=\"line\">You entered the following IP addresses.</span><br><span class=\"line\"></span><br><span class=\"line\"> - 127.0.0.1</span><br><span class=\"line\"> - 10.250.0.17</span><br><span class=\"line\"> - 10.250.0.173</span><br><span class=\"line\"> - 10.250.0.239</span><br><span class=\"line\"></span><br><span class=\"line\">Is this correct [Y/n]y # ç¡®è®¤IPæ˜¯å¦æ­£ç¡®</span><br><span class=\"line\"></span><br><span class=\"line\">Do you wish to change any of these options? [y/N]n # ä¸ä¿®æ”¹ä»»ä½•é€‰é¡¹</span><br><span class=\"line\"></span><br><span class=\"line\">If you wish to use a blank password, simply press &lt;enter&gt; at the prompt below.</span><br><span class=\"line\">Provide a password for the &quot;http.p12&quot; file:  [&lt;ENTER&gt; for none] # ç›´æ¥å›è½¦ä¸è®¾ç½®å¯†ç </span><br><span class=\"line\"></span><br><span class=\"line\">What filename should be used for the output zip file? [/usr/local/elasticsearch/elasticsearch-8.17.3/elasticsearch-ssl-http.zip] # è¾“å‡ºæ–‡ä»¶åï¼Œè¿™é‡Œå¯ä»¥è‡ªå®šä¹‰ï¼Œé»˜è®¤æ˜¯ elasticsearch-ssl-http.zip</span><br><span class=\"line\"></span><br><span class=\"line\">Zip file written to /usr/local/elasticsearch/elasticsearch-8.17.3/elasticsearch-ssl-http.zip</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>è§£å‹å¹¶å°†httpè¯ä¹¦æ‹·è´åˆ°config/certsç›®å½•ä¸‹</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ unzip elasticsearch-ssl-http.zip</span><br><span class=\"line\">Archive:  elasticsearch-ssl-http.zip</span><br><span class=\"line\">   creating: elasticsearch/</span><br><span class=\"line\">  inflating: elasticsearch/README.txt <span class=\"comment\"># è¯´æ˜æ–‡ä»¶</span></span><br><span class=\"line\">  inflating: elasticsearch/http.p12  <span class=\"comment\"># httpè¯ä¹¦</span></span><br><span class=\"line\">  inflating: elasticsearch/sample-elasticsearch.yml <span class=\"comment\"># ç¤ºä¾‹elasticsearché…ç½®æ–‡ä»¶</span></span><br><span class=\"line\">   creating: kibana/</span><br><span class=\"line\">  inflating: kibana/README.txt <span class=\"comment\"># è¯´æ˜æ–‡ä»¶</span></span><br><span class=\"line\">  inflating: kibana/elasticsearch-ca.pem  <span class=\"comment\"># kibanaç”¨äºéªŒè¯ESçš„è¯ä¹¦ï¼Œå³ elasticsearch.ssl.certificateAuthorities ä¸­çš„é…ç½®</span></span><br><span class=\"line\">  inflating: kibana/sample-kibana.yml <span class=\"comment\"># ç¤ºä¾‹kibanaé…ç½®æ–‡ä»¶</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># å°†httpè¯ä¹¦æ‹·è´åˆ°config/certsç›®å½•ä¸‹</span></span><br><span class=\"line\">$ <span class=\"built_in\">cp</span> elasticsearch/http.p12 config/certs/http.p12</span><br></pre></td></tr></table></figure>\n<h3 id=\"åˆ†å‘åˆ°ESé›†ç¾¤ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹\">åˆ†å‘åˆ°ESé›†ç¾¤ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ä¸Šé¢åˆ›å»ºæ–°çš„è¯ä¹¦æ—¶æˆ‘ä»¬åªåœ¨ä¸€ä¸ªèŠ‚ç‚¹ä¸Šè¿›è¡Œå³å¯ï¼Œä¹‹åå°†ç”Ÿæˆå¥½çš„è¯ä¹¦åˆ†å‘åˆ°ESé›†ç¾¤ä¸­çš„å…¶å®ƒèŠ‚ç‚¹ï¼Œè¿™é‡Œå°±æ˜¯ <code>http.p12</code> å’Œ <code>transport.p12</code>ï¼Œå°†å…¶æ‹·è´åˆ°æ¯ä¸ªèŠ‚ç‚¹çš„ <code>config/certs</code> ç›®å½•ä¸‹ï¼Œæ‹·è´å‰åšå¥½åŸè¯ä¹¦çš„å¤‡ä»½ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>å¦‚æœ‰å¿…è¦ä¹Ÿå¯ä»¥æ‹·è´ <code>ca.p12</code> æˆ–è€… <code>http_ca.crt</code> å’Œ <code>http_ca.key</code> åˆ°æ¯ä¸ªèŠ‚ç‚¹çš„ <code>config/certs</code> ç›®å½•ä¸‹</p>\n</li>\n</ul>\n<h3 id=\"é‡å¯ESæœåŠ¡\">é‡å¯ESæœåŠ¡</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>é›†ç¾¤ä¸­çš„èŠ‚ç‚¹ä¾æ¬¡é‡å¯</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ bin/elasticsearch -d</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>é‡å¯æ—¶å¯èƒ½ä¼šæŠ¥é”™</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">org.elasticsearch.ElasticsearchSecurityException: failed to load SSL configuration [xpack.security.transport.ssl] - cannot <span class=\"built_in\">read</span> configured [PKCS12] keystore (as a truststore) [/usr/local/elasticsearch/elasticsearch-8.17.3/config/certs/transport.p12] - this is usually caused by an incorrect password; (a keystore password was provided)</span><br><span class=\"line\"><span class=\"comment\"># è™½ç„¶æˆ‘ä»¬æ²¡æœ‰ç»™transport.p12è®¾ç½®å¯†ç ï¼Œä½†è¿™é‡Œä¾æ—§æç¤ºæä¾›çš„å¯†ç ä¸æ­£ç¡®ï¼Œå®é™…ä¸Šè¿™é‡Œä½¿ç”¨çš„æ˜¯ secure_password</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>è§£å†³æ–¹æ³•</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨bin/elasticsearch-keystore listæŸ¥çœ‹ç°æœ‰çš„å¯†é’¥åˆ—è¡¨</span></span><br><span class=\"line\">$ bin/elasticsearch-keystore list</span><br><span class=\"line\">keystore.seed</span><br><span class=\"line\">xpack.security.http.ssl.keystore.secure_password</span><br><span class=\"line\">xpack.security.transport.ssl.keystore.secure_password</span><br><span class=\"line\">xpack.security.transport.ssl.truststore.secure_password</span><br><span class=\"line\"><span class=\"comment\"># åˆ é™¤secure_passwordåå†æ¬¡é‡å¯ESæœåŠ¡å°±ä¼šæ­£å¸¸äº†</span></span><br><span class=\"line\">$ bin/elasticsearch-keystore remove xpack.security.http.ssl.keystore.secure_password</span><br><span class=\"line\">$ bin/elasticsearch-keystore remove xpack.security.transport.ssl.keystore.secure_password</span><br><span class=\"line\">$ bin/elasticsearch-keystore remove xpack.security.transport.ssl.truststore.secure_password</span><br></pre></td></tr></table></figure>\n<h3 id=\"æ›¿æ¢Kibanaçš„è¯ä¹¦\">æ›¿æ¢Kibanaçš„è¯ä¹¦</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å°†ä¸Šé¢åˆ›å»ºå¥½çš„ <code>kibana/elasticsearch-ca.pem</code> æ‹·è´åˆ°KibanaæœåŠ¡å™¨ï¼Œæ¯”å¦‚ <code>/usr/local/kibana/kibana-8.17.3/config/certs/elasticsearch-ca.pem</code></p>\n</li>\n<li class=\"lvl-2\">\n<p>ä¿®æ”¹Kibanaé…ç½®æ–‡ä»¶ <code>config/kibana.yml</code> ä¸­çš„ <code>elasticsearch.ssl.certificateAuthorities</code> é…ç½®ï¼Œä½¿å…¶æŒ‡å‘ <code>/usr/local/kibana/kibana-8.17.3/config/certs/elasticsearch-ca.pem</code></p>\n</li>\n</ul>\n<figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">elasticsearch.ssl.certificateAuthorities:</span> [<span class=\"string\">&quot;/usr/local/kibana/kibana-8.17.3/config/certs/elasticsearch-ca.pem&quot;</span>]</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>é‡å¯KibanaæœåŠ¡</p>\n</li>\n</ul>\n<h2 id=\"è¯ä¹¦æ ¼å¼è½¬æ¢\">è¯ä¹¦æ ¼å¼è½¬æ¢</h2>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># p12è½¬æ¢ä¸ºcrtæ ¼å¼</span></span><br><span class=\"line\">$ openssl pkcs12 -<span class=\"keyword\">in</span> config/certs/ca.p12 -out config/certs/http_ca.crt -nokeys</span><br><span class=\"line\"><span class=\"comment\"># p12è½¬æ¢ä¸ºkeyæ ¼å¼</span></span><br><span class=\"line\">$ openssl pkcs12 -<span class=\"keyword\">in</span> config/certs/ca.p12 -out config/certs/http_ca.key -nocerts -nodes</span><br><span class=\"line\"><span class=\"comment\"># p12è½¬æ¢ä¸ºpemæ ¼å¼</span></span><br><span class=\"line\">$ openssl pkcs12 -<span class=\"keyword\">in</span> config/certs/ca.p12 -out config/certs/http_ca.pem -nodes</span><br><span class=\"line\"><span class=\"comment\"># crtè½¬æ¢å›PKCS12æ ¼å¼</span></span><br><span class=\"line\">$ openssl pkcs12 -<span class=\"built_in\">export</span> -out config/certs/http_ca.p12 -inkey config/certs/http_ca.key -<span class=\"keyword\">in</span> config/certs/http_ca.crt -name <span class=\"string\">&quot;My CA&quot;</span></span><br></pre></td></tr></table></figure>\n<div class=\"tips\">\n<p><em><strong>ç”Ÿæˆhttpè¯ä¹¦æ—¶ä¸ºæ¯ä¸ªèŠ‚ç‚¹å•ç‹¬é…ç½®è¯ä¹¦</strong></em></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Generate a certificate per node? [y/N]y <span class=\"comment\"># æ˜¯å¦ä¸ºæ¯ä¸ªèŠ‚ç‚¹å•ç‹¬é…ç½®è¯ä¹¦ï¼Œè¿™é‡Œé€‰æ‹©æ˜¯</span></span><br><span class=\"line\">node <span class=\"comment\">#1 name: node-1 # èŠ‚ç‚¹åç§°ï¼Œå¿…é¡»ä¸ESé…ç½®æ–‡ä»¶ä¸­çš„node.nameä¸€è‡´</span></span><br><span class=\"line\"></span><br><span class=\"line\">Enter all the hostnames that you need, one per line. <span class=\"comment\"># è¾“å…¥ node-1 èŠ‚ç‚¹çš„hostname</span></span><br><span class=\"line\">When you are <span class=\"keyword\">done</span>, press &lt;ENTER&gt; once more to move on to the next step.</span><br><span class=\"line\"></span><br><span class=\"line\">localhost                                         <span class=\"comment\"># ä¹ æƒ¯åŠ ä¸Š localhost</span></span><br><span class=\"line\">ip-10-250-0-239.cn-northwest-1.compute.internal   <span class=\"comment\"># node-1 çš„ hostname</span></span><br><span class=\"line\"></span><br><span class=\"line\">You entered the following hostnames.</span><br><span class=\"line\"></span><br><span class=\"line\"> - localhost</span><br><span class=\"line\"> - ip-10-250-0-239.cn-northwest-1.compute.internal</span><br><span class=\"line\"></span><br><span class=\"line\">Is this correct [Y/n]y <span class=\"comment\"># ç¡®è®¤æ˜¯å¦æ­£ç¡®</span></span><br><span class=\"line\"></span><br><span class=\"line\">Enter all the IP addresses that you need, one per line. <span class=\"comment\"># è¾“å…¥ node-1 èŠ‚ç‚¹çš„IPåœ°å€</span></span><br><span class=\"line\">When you are <span class=\"keyword\">done</span>, press &lt;ENTER&gt; once more to move on to the next step.</span><br><span class=\"line\"></span><br><span class=\"line\">127.0.0.1                                         <span class=\"comment\"># ä¹ æƒ¯åŠ ä¸Š 127.0.0.1</span></span><br><span class=\"line\">10.250.0.239                                      <span class=\"comment\"># node-1 çš„ IP</span></span><br><span class=\"line\"></span><br><span class=\"line\">You entered the following IP addresses.</span><br><span class=\"line\"></span><br><span class=\"line\"> - 127.0.0.1</span><br><span class=\"line\"> - 10.250.0.239</span><br><span class=\"line\"></span><br><span class=\"line\">Is this correct [Y/n]y <span class=\"comment\"># ç¡®è®¤æ˜¯å¦æ­£ç¡®</span></span><br><span class=\"line\"></span><br><span class=\"line\">Do you wish to change any of these options? [y/N]n <span class=\"comment\"># ä¸ä¿®æ”¹ä»»ä½•é€‰é¡¹</span></span><br><span class=\"line\">Generate additional certificates? [Y/n]y  <span class=\"comment\"># æ˜¯å¦ç”Ÿæˆå…¶ä»–è¯ä¹¦ï¼Œè¿™é‡Œé€‰æ‹©æ˜¯ï¼Œæ¥ç€ä¸ºå…¶å®ƒèŠ‚ç‚¹åˆ›å»ºè¯ä¹¦</span></span><br><span class=\"line\">node <span class=\"comment\">#2 name: node-2 # èŠ‚ç‚¹åç§°ï¼Œå¿…é¡»ä¸ESé…ç½®æ–‡ä»¶ä¸­çš„node.nameä¸€è‡´</span></span><br><span class=\"line\"><span class=\"comment\"># ä¾æ¬¡ä¸ºæ¯ä¸ªèŠ‚ç‚¹åˆ›å»ºè¯ä¹¦</span></span><br><span class=\"line\">â€¦â€¦â€¦â€¦â€¦â€¦</span><br><span class=\"line\"></span><br><span class=\"line\">Generate additional certificates? [Y/n]n <span class=\"comment\"># åˆ›å»ºå¥½æ‰€æœ‰èŠ‚ç‚¹çš„è¯ä¹¦åï¼Œé€‰æ‹©nï¼Œä¸å†åˆ›å»ºæ–°çš„è¯ä¹¦</span></span><br><span class=\"line\"></span><br><span class=\"line\">If you wish to use a blank password, simply press &lt;enter&gt; at the prompt below.</span><br><span class=\"line\">Provide a password <span class=\"keyword\">for</span> the <span class=\"string\">&quot;http.p12&quot;</span> file:  [&lt;ENTER&gt; <span class=\"keyword\">for</span> none] <span class=\"comment\"># ç›´æ¥å›è½¦ä¸è®¾ç½®å¯†ç </span></span><br><span class=\"line\"></span><br><span class=\"line\">What filename should be used <span class=\"keyword\">for</span> the output zip file? [/usr/local/elasticsearch/elasticsearch-8.17.3/elasticsearch-ssl-http.zip] <span class=\"comment\"># è¾“å‡ºæ–‡ä»¶åï¼Œè¿™é‡Œå¯ä»¥è‡ªå®šä¹‰ï¼Œé»˜è®¤æ˜¯ elasticsearch-ssl-http.zip</span></span><br><span class=\"line\"></span><br><span class=\"line\">Zip file written to /usr/local/elasticsearch/elasticsearch-8.17.3/elasticsearch-ssl-http.zip</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">æ­¤æ—¶è§£å‹æŸ¥çœ‹æ–‡ä»¶ç»“æ„</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">unzip elasticsearch-ssl-http.zip</span><br><span class=\"line\">Archive:  elasticsearch-ssl-http.zip</span><br><span class=\"line\">   creating: elasticsearch/</span><br><span class=\"line\">   creating: elasticsearch/node-1/</span><br><span class=\"line\">  inflating: elasticsearch/node-1/README.txt</span><br><span class=\"line\">  inflating: elasticsearch/node-1/http.p12  <span class=\"comment\"># node-1 çš„è¯ä¹¦</span></span><br><span class=\"line\">  inflating: elasticsearch/node-1/sample-elasticsearch.yml</span><br><span class=\"line\">   creating: elasticsearch/node-2/</span><br><span class=\"line\">  inflating: elasticsearch/node-2/README.txt</span><br><span class=\"line\">  inflating: elasticsearch/node-2/http.p12 <span class=\"comment\"># node-2 çš„è¯ä¹¦</span></span><br><span class=\"line\">  inflating: elasticsearch/node-2/sample-elasticsearch.yml</span><br><span class=\"line\">  creating: elasticsearch/node-3/</span><br><span class=\"line\">  inflating: elasticsearch/node-3/README.txt</span><br><span class=\"line\">  inflating: elasticsearch/node-3/http.p12 <span class=\"comment\"># node-3 çš„è¯ä¹¦</span></span><br><span class=\"line\">  inflating: elasticsearch/node-3/sample-elasticsearch.yml</span><br><span class=\"line\">   creating: kibana/</span><br><span class=\"line\">  inflating: kibana/README.txt</span><br><span class=\"line\">  inflating: kibana/elasticsearch-ca.pem <span class=\"comment\"># kibana çš„è¯ä¹¦</span></span><br><span class=\"line\">  inflating: kibana/sample-kibana.yml</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">\n<p>å°†å¯¹åº”çš„è¯ä¹¦æ‹·è´åˆ°å¯¹åº”èŠ‚ç‚¹çš„ <code>config/certs</code> ç›®å½•ä¸‹</p>\n</li>\n</ul>\n</div>\n","content_text":"æ‘˜è¦ æœ¬æ–‡ä»‹ç»Elasticsearchè¯ä¹¦è¿‡æœŸæ—¶çš„å¤„ç†æ–¹æ³• Elasticsearchç‰ˆæœ¬8.17.3 æœ¬æ–‡åŸºäº linuxä¸‹å®‰è£…Elasticsearch å®˜æ–¹æ–‡æ¡£:Updating node security certificates ESè¯ä¹¦ç®€ä»‹ Elasticsearch 8 é»˜è®¤æƒ…å†µä¸‹åˆ›å»ºçš„è¯ä¹¦åªæœ‰3å¹´æœ‰æ•ˆæœŸï¼Œè¿‡æœŸæ—¶éœ€è¦åˆ›å»ºæ–°çš„è¯ä¹¦ï¼Œä¸ºäº†ä¸å¿…è¦çš„éº»çƒ¦ï¼Œä¹Ÿå¯ä»¥ä¸€å¼€å§‹å°±åˆ›å»ºä¸€ä¸ªæœ‰æ•ˆæœŸæ¯”è¾ƒé•¿çš„è¯ä¹¦ã€‚ åœ¨ Elasticsearch 8 çš„é…ç½®ä¸‹ï¼Œconfig/certs ç›®å½•é€šå¸¸å­˜æ”¾çš„æ˜¯ç”¨äºå®‰å…¨é€šä¿¡çš„è¯ä¹¦å’Œå¯†é’¥æ–‡ä»¶ã€‚è¿™äº›æ–‡ä»¶ç¡®ä¿äº† Elasticsearch å®ä¾‹ä¹‹é—´çš„é€šè®¯ä»¥åŠä¸å¤–éƒ¨å®¢æˆ·ç«¯çš„é€šè®¯èƒ½å¤Ÿè¢«åŠ å¯†ä¸”ç»è¿‡è®¤è¯ã€‚ config/certs ç›®å½•åŒ…å«ä¸‰ä¸ªæ–‡ä»¶åˆ†åˆ«æ˜¯ï¼š http.p12: è¿™æ˜¯ä¸€ä¸ª PKCS#12 æ ¼å¼çš„æ–‡ä»¶ï¼ˆé€šå¸¸å¸¦æœ‰.p12æˆ–.pfxæ‰©å±•åï¼‰ï¼ŒåŒ…å«äº† Elasticsearch HTTP å±‚ç”¨æ¥è¿›è¡Œ TLS/SSL é€šä¿¡æ‰€éœ€çš„ä¸€åˆ‡ï¼ŒåŒ…æ‹¬ä¸€ä¸ªç§é’¥ã€ç›¸åº”çš„å…¬é’¥è¯ä¹¦ï¼ˆæœåŠ¡å™¨è¯ä¹¦ï¼‰åŠ CA è¯ä¹¦é“¾ã€‚å®¢æˆ·ç«¯ä½¿ç”¨è¿™ä¸ªæ–‡ä»¶æ¥éªŒè¯å®ƒä»¬æ­£åœ¨ä¸æ­£ç¡®çš„æœåŠ¡å™¨è¿›è¡Œé€šä¿¡ï¼Œå¹¶ä¸”æ­¤æœåŠ¡å™¨ä¹Ÿä¿¡ä»»è¯¥å®¢æˆ·ç«¯ã€‚ http_ca.crt: CA (Certificate Authority) æ ¹è¯ä¹¦æˆ–ä¸­é—´è¯ä¹¦ï¼Œç”¨äºéªŒè¯é€šè¿‡ HTTP åè®®è¿æ¥è‡³ Elasticsearch æœåŠ¡ç«¯ç‚¹çš„èº«ä»½ã€‚å½“å®¢æˆ·ç«¯å°è¯•å»ºç«‹ HTTPS è¿æ¥æ—¶ï¼Œå®ƒä¼šæ£€æŸ¥æ¥è‡ª Elasticsearch çš„è¯ä¹¦æ˜¯å¦ç”±è¿™ä¸ª CA ç­¾åï¼›è¿™æ˜¯ç¡®ä¿åŒæ–¹é€šä¿¡å®‰å…¨çš„é‡è¦æ­¥éª¤ä¹‹ä¸€ã€‚ transport.p12: åŒæ ·ä¸º PKCS#12 æ ¼å¼ï¼Œä½†è¿™ä¸ªç‰¹å®šçš„æ–‡ä»¶æ˜¯ç»™ Elasticsearch èŠ‚ç‚¹ä¹‹é—´å†…éƒ¨ä¼ è¾“å±‚ä½¿ç”¨çš„ã€‚åœ¨é›†ç¾¤å†…ï¼ŒèŠ‚ç‚¹é—´éœ€ è¦ç›¸äº’è®¤è¯ï¼Œtransport.p12å°±åŒ…å«ç€è®©ä¸åŒ Elasticsearch å®ä¾‹èƒ½äº’ç›¸è¯†åˆ«æ‰€éœ€çš„ç§é’¥å’Œè¯ä¹¦ã€‚ æ€»ä¹‹ï¼Œhttp.p12æœåŠ¡äºé¢å‘ Web çš„æ¥å£ï¼Œè€Œtransport.p12åˆ™å¤„ç† Elasticsearch ç¾¤é›†å†…çš„äº¤äº’ï¼›ä¸¤è€…éƒ½ä¾èµ–äºhttp_ca.crtæ¥è¿›è¡Œèº«ä»½éªŒè¯è¿‡ç¨‹çš„ä¸€éƒ¨åˆ†ã€‚ ESè¯ä¹¦è¿‡æœŸçš„å½±å“ â€Œé›†ç¾¤æ— æ³•å¢åŠ æ–°èŠ‚ç‚¹â€Œï¼šç‰¹åˆ«æ˜¯åœ¨é‡å¯é›†ç¾¤æ—¶ï¼ŒèŠ‚ç‚¹æ— æ³•åŠ å…¥é›†ç¾¤ï¼Œå¯¼è‡´æ— æ³•æ­£å¸¸é‡å¯ã€‚â€Œ â€Œè®¿é—®å¼‚å¸¸â€Œï¼šå¦‚æœä½¿ç”¨è¯ä¹¦è¿æ¥ESé›†ç¾¤ï¼Œä¼šå¯¼è‡´æ— æ³•æ­£å¸¸è®¿é—®é›†ç¾¤ã€‚ â€Œå®‰å…¨é£é™©â€Œï¼šè¯ä¹¦è¿‡æœŸä¼šç ´åè¯ä¹¦é“¾çš„ä¿¡ä»»ï¼Œå¯èƒ½å¼•å‘å®‰å…¨æ¼æ´ã€‚ â€Œæ—¥å¿—å¹²æ‰°â€Œï¼šä¼šæŒç»­å‡ºç°è¯ä¹¦è¿‡æœŸçš„é”™è¯¯æ—¥å¿—ï¼Œå¹²æ‰°é—®é¢˜æ’æŸ¥å’Œè¯Šæ–­ã€‚ æŸ¥çœ‹è¯ä¹¦çš„è¿‡æœŸæ—¶é—´ é€šè¿‡opensslæŸ¥çœ‹è¯ä¹¦çš„è¿‡æœŸæ—¶é—´ 12345678910# æŸ¥çœ‹crtè¯ä¹¦åˆ°æœŸæ—¶é—´# -dates: æ˜¾ç¤ºè¯ä¹¦çš„å¼€å§‹æ—¶é—´å’Œç»“æŸæ—¶é—´# -noout: ä¸è¾“å‡ºè¯ä¹¦çš„è¯¦ç»†ä¿¡æ¯openssl x509 -in config/certs/http_ca.crt -dates -noout# æŸ¥çœ‹p12è¯ä¹¦åˆ°æœŸæ—¶é—´# -clcerts: åªæ˜¾ç¤ºè¯ä¹¦ï¼Œä¸æ˜¾ç¤ºç§é’¥# -nokeys: ä¸è¾“å‡ºç§é’¥# -password pass: æŒ‡å®šç§é’¥çš„å¯†ç ï¼Œè¿™é‡Œä¸ºç©º(å› ä¸ºåœ¨åˆ›å»ºè¯ä¹¦æ—¶æ²¡æœ‰è®¾ç½®å¯†ç )ï¼Œæ³¨æ„å¯†ç å¿…é¡»å†™åœ¨pass:çš„åé¢ï¼Œä¸åŠ è¿™ä¸ªå‚æ•°ä¼šæç¤ºä½ è¾“å…¥å¯†ç ï¼Œç›´æ¥å›è½¦å³å¯openssl pkcs12 -in ca.p12 -password pass: -clcerts -nokeys | openssl x509 -dates -noout é€šè¿‡ESçš„APIæŸ¥çœ‹è¯ä¹¦è¿‡æœŸæ—¶é—´ 1curl -XGET -k -u &#x27;elastic:123456&#x27; &#x27;https://127.0.0.1:9200/_ssl/certificates?pretty&#x27; è¯ä¹¦è¿‡æœŸå¤„ç† Elasticsearch 8 çš„è¯ä¹¦åˆ›å»ºéœ€è¦ä½¿ç”¨å‘½ä»¤è¡Œå·¥å…· elasticsearch-certutilï¼Œè¿™éƒ¨åˆ†çš„è¯¦ç»†ä¿¡æ¯å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£:elasticsearch-certutil å½“è¯ä¹¦è¿‡æœŸæ—¶ï¼Œéœ€è¦é‡æ–°ç”Ÿæˆè¯ä¹¦ï¼Œå¹¶æ›´æ–°config/certsç›®å½•ä¸‹çš„æ–‡ä»¶ï¼Œæ›´æ–°å‰è¦å¤‡ä»½åŸè¯ä¹¦ã€‚ å¤‡ä»½åŸè¯ä¹¦ 12$ cp -r config/certs config/certs.bak$ rm -rf config/certs/* ç”Ÿæˆæ–°è¯ä¹¦ ç”ŸæˆCAè¯ä¹¦ ç”Ÿæˆcrtè¯ä¹¦ 1234567# --days 36500: æŒ‡å®šè¯ä¹¦çš„æœ‰æ•ˆæœŸï¼Œå•ä½ä¸ºå¤©ï¼Œè¿™é‡Œè®¾ç½®ä¸º 36500 å¤©ï¼Œå¤§çº¦ 10 å¹´$ bin/elasticsearch-certutil ca --pem --out new-ca.zip --days 36500# è§£å‹$ unzip new-ca.zip# å°†åˆ›å»ºçš„è¯ä¹¦ç§»åŠ¨åˆ°æŒ‡å®šç›®å½•$ mv ca/ca.crt config/certs/http_ca.crt$ mv ca/ca.key config/certs/http_ca.key ä¹Ÿå¯ä»¥ç”ŸæˆPKCS#12æ ¼å¼çš„è¯ä¹¦ 1$ bin/elasticsearch-certutil ca --out config/certs/ca.p12 --days 36500 ç”Ÿæˆtransportè¯ä¹¦ 12345# åŸºäºcrtè¯ä¹¦$ bin/elasticsearch-certutil cert --ca-cert config/certs/http_ca.crt --ca-key config/certs/http_ca.key --out config/certs/transport.p12 --days 36500# åŸºäºPKCS#12æ ¼å¼çš„è¯ä¹¦$ bin/elasticsearch-certutil cert --ca config/certs/ca.p12 --out config/certs/transport.p12 --days 36500 ç”Ÿæˆhttpè¯ä¹¦ 12# è¿™é‡Œæ˜¯äº¤äº’å¼å‘½ä»¤è¡Œ$ bin/elasticsearch-certutil http è¾“å‡ºè¯´æ˜ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556Generate a CSR? [y/N]n # ä¸ç”ŸæˆCSRUse an existing CA? [y/N]y # ä½¿ç”¨å·²æœ‰çš„CA# ä»¥ä¸‹åŒºåˆ†crtè¯ä¹¦å’ŒPKCS#12æ ¼å¼çš„è¯ä¹¦# crt è¯ä¹¦CA Path: certs/http_ca.crt # CAè¯ä¹¦ï¼Œè¿™é‡Œç›¸å¯¹è·¯å¾„æ˜¯ç›¸å¯¹åº” config ç›®å½•ï¼Œä¹Ÿå¯ä»¥æ˜¯ç»å¯¹è·¯å¾„CA Key: certs/http_ca.key # CAå¯†é’¥ï¼Œè¿™é‡Œç›¸å¯¹è·¯å¾„æ˜¯ç›¸å¯¹åº” config ç›®å½•ï¼Œä¹Ÿå¯ä»¥æ˜¯ç»å¯¹è·¯å¾„# PKCS#12æ ¼å¼çš„è¯ä¹¦CA Path: certs/ca.p12 # CAè¯ä¹¦ï¼Œè¿™é‡Œç›¸å¯¹è·¯å¾„æ˜¯ç›¸å¯¹åº” config ç›®å½•ï¼Œä¹Ÿå¯ä»¥æ˜¯ç»å¯¹è·¯å¾„Password for ca.p12: # CAå¯†ç ï¼Œå› ä¸ºæ²¡æœ‰è®¾ç½®å¯†ç ï¼Œæ‰€ä»¥è¿™é‡Œç›´æ¥å›è½¦For how long should your certificate be valid? [5y] 100y # è¯ä¹¦æœ‰æ•ˆæœŸï¼Œå•ä½ä¸ºå¹´ï¼Œé»˜è®¤æ˜¯ 5 å¹´ï¼Œè¿™é‡Œè®¾ç½®ä¸º 100 å¹´Generate a certificate per node? [y/N]n # ä¸ä¸ºæ¯ä¸ªèŠ‚ç‚¹åˆ›å»ºç‹¬ç«‹çš„è¯ä¹¦ï¼Œå³æ‰€æœ‰èŠ‚ç‚¹éƒ½ä½¿ç”¨åŒä¸€ä¸ªè¯ä¹¦Enter all the hostnames that you need, one per line.When you are done, press &lt;ENTER&gt; once more to move on to the next step.localhost # ä¸»æœºåï¼Œè¿™é‡Œå¯ä»¥æ·»åŠ å¤šä¸ªï¼Œå›è½¦ä¸€è¡Œä¸€ä¸ªï¼Œè¿™é‡Œåº”è¯¥å¡«å†™é›†ç¾¤å†…æ‰€æœ‰èŠ‚ç‚¹æœåŠ¡å™¨çš„hostnameï¼Œå¯ä»¥é€šè¿‡ hostname å‘½ä»¤æŸ¥çœ‹ip-10-250-0-17.cn-northwest-1.compute.internalip-10-250-0-173.cn-northwest-1.compute.internalip-10-250-0-239.cn-northwest-1.compute.internalYou entered the following hostnames. - localhost - ip-10-250-0-17.cn-northwest-1.compute.internal - ip-10-250-0-173.cn-northwest-1.compute.internal - ip-10-250-0-239.cn-northwest-1.compute.internalIs this correct [Y/n]y # ç¡®è®¤ä¸»æœºåæ˜¯å¦æ­£ç¡®Enter all the IP addresses that you need, one per line.When you are done, press &lt;ENTER&gt; once more to move on to the next step.127.0.0.1 # ä¸»æœºIPï¼Œè¿™é‡Œå¯ä»¥æ·»åŠ å¤šä¸ªï¼Œå›è½¦ä¸€è¡Œä¸€ä¸ªï¼Œè¿™é‡Œåº”è¯¥å¡«å†™é›†ç¾¤å†…æ‰€æœ‰èŠ‚ç‚¹æœåŠ¡å™¨çš„IPåœ°å€10.250.0.1710.250.0.17310.250.0.239You entered the following IP addresses. - 127.0.0.1 - 10.250.0.17 - 10.250.0.173 - 10.250.0.239Is this correct [Y/n]y # ç¡®è®¤IPæ˜¯å¦æ­£ç¡®Do you wish to change any of these options? [y/N]n # ä¸ä¿®æ”¹ä»»ä½•é€‰é¡¹If you wish to use a blank password, simply press &lt;enter&gt; at the prompt below.Provide a password for the &quot;http.p12&quot; file: [&lt;ENTER&gt; for none] # ç›´æ¥å›è½¦ä¸è®¾ç½®å¯†ç What filename should be used for the output zip file? [/usr/local/elasticsearch/elasticsearch-8.17.3/elasticsearch-ssl-http.zip] # è¾“å‡ºæ–‡ä»¶åï¼Œè¿™é‡Œå¯ä»¥è‡ªå®šä¹‰ï¼Œé»˜è®¤æ˜¯ elasticsearch-ssl-http.zipZip file written to /usr/local/elasticsearch/elasticsearch-8.17.3/elasticsearch-ssl-http.zip è§£å‹å¹¶å°†httpè¯ä¹¦æ‹·è´åˆ°config/certsç›®å½•ä¸‹ 12345678910111213$ unzip elasticsearch-ssl-http.zipArchive: elasticsearch-ssl-http.zip creating: elasticsearch/ inflating: elasticsearch/README.txt # è¯´æ˜æ–‡ä»¶ inflating: elasticsearch/http.p12 # httpè¯ä¹¦ inflating: elasticsearch/sample-elasticsearch.yml # ç¤ºä¾‹elasticsearché…ç½®æ–‡ä»¶ creating: kibana/ inflating: kibana/README.txt # è¯´æ˜æ–‡ä»¶ inflating: kibana/elasticsearch-ca.pem # kibanaç”¨äºéªŒè¯ESçš„è¯ä¹¦ï¼Œå³ elasticsearch.ssl.certificateAuthorities ä¸­çš„é…ç½® inflating: kibana/sample-kibana.yml # ç¤ºä¾‹kibanaé…ç½®æ–‡ä»¶# å°†httpè¯ä¹¦æ‹·è´åˆ°config/certsç›®å½•ä¸‹$ cp elasticsearch/http.p12 config/certs/http.p12 åˆ†å‘åˆ°ESé›†ç¾¤ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹ ä¸Šé¢åˆ›å»ºæ–°çš„è¯ä¹¦æ—¶æˆ‘ä»¬åªåœ¨ä¸€ä¸ªèŠ‚ç‚¹ä¸Šè¿›è¡Œå³å¯ï¼Œä¹‹åå°†ç”Ÿæˆå¥½çš„è¯ä¹¦åˆ†å‘åˆ°ESé›†ç¾¤ä¸­çš„å…¶å®ƒèŠ‚ç‚¹ï¼Œè¿™é‡Œå°±æ˜¯ http.p12 å’Œ transport.p12ï¼Œå°†å…¶æ‹·è´åˆ°æ¯ä¸ªèŠ‚ç‚¹çš„ config/certs ç›®å½•ä¸‹ï¼Œæ‹·è´å‰åšå¥½åŸè¯ä¹¦çš„å¤‡ä»½ã€‚ å¦‚æœ‰å¿…è¦ä¹Ÿå¯ä»¥æ‹·è´ ca.p12 æˆ–è€… http_ca.crt å’Œ http_ca.key åˆ°æ¯ä¸ªèŠ‚ç‚¹çš„ config/certs ç›®å½•ä¸‹ é‡å¯ESæœåŠ¡ é›†ç¾¤ä¸­çš„èŠ‚ç‚¹ä¾æ¬¡é‡å¯ 1$ bin/elasticsearch -d é‡å¯æ—¶å¯èƒ½ä¼šæŠ¥é”™ 12org.elasticsearch.ElasticsearchSecurityException: failed to load SSL configuration [xpack.security.transport.ssl] - cannot read configured [PKCS12] keystore (as a truststore) [/usr/local/elasticsearch/elasticsearch-8.17.3/config/certs/transport.p12] - this is usually caused by an incorrect password; (a keystore password was provided)# è™½ç„¶æˆ‘ä»¬æ²¡æœ‰ç»™transport.p12è®¾ç½®å¯†ç ï¼Œä½†è¿™é‡Œä¾æ—§æç¤ºæä¾›çš„å¯†ç ä¸æ­£ç¡®ï¼Œå®é™…ä¸Šè¿™é‡Œä½¿ç”¨çš„æ˜¯ secure_password è§£å†³æ–¹æ³• 12345678910# ä½¿ç”¨bin/elasticsearch-keystore listæŸ¥çœ‹ç°æœ‰çš„å¯†é’¥åˆ—è¡¨$ bin/elasticsearch-keystore listkeystore.seedxpack.security.http.ssl.keystore.secure_passwordxpack.security.transport.ssl.keystore.secure_passwordxpack.security.transport.ssl.truststore.secure_password# åˆ é™¤secure_passwordåå†æ¬¡é‡å¯ESæœåŠ¡å°±ä¼šæ­£å¸¸äº†$ bin/elasticsearch-keystore remove xpack.security.http.ssl.keystore.secure_password$ bin/elasticsearch-keystore remove xpack.security.transport.ssl.keystore.secure_password$ bin/elasticsearch-keystore remove xpack.security.transport.ssl.truststore.secure_password æ›¿æ¢Kibanaçš„è¯ä¹¦ å°†ä¸Šé¢åˆ›å»ºå¥½çš„ kibana/elasticsearch-ca.pem æ‹·è´åˆ°KibanaæœåŠ¡å™¨ï¼Œæ¯”å¦‚ /usr/local/kibana/kibana-8.17.3/config/certs/elasticsearch-ca.pem ä¿®æ”¹Kibanaé…ç½®æ–‡ä»¶ config/kibana.yml ä¸­çš„ elasticsearch.ssl.certificateAuthorities é…ç½®ï¼Œä½¿å…¶æŒ‡å‘ /usr/local/kibana/kibana-8.17.3/config/certs/elasticsearch-ca.pem 1elasticsearch.ssl.certificateAuthorities: [&quot;/usr/local/kibana/kibana-8.17.3/config/certs/elasticsearch-ca.pem&quot;] é‡å¯KibanaæœåŠ¡ è¯ä¹¦æ ¼å¼è½¬æ¢ 12345678# p12è½¬æ¢ä¸ºcrtæ ¼å¼$ openssl pkcs12 -in config/certs/ca.p12 -out config/certs/http_ca.crt -nokeys# p12è½¬æ¢ä¸ºkeyæ ¼å¼$ openssl pkcs12 -in config/certs/ca.p12 -out config/certs/http_ca.key -nocerts -nodes# p12è½¬æ¢ä¸ºpemæ ¼å¼$ openssl pkcs12 -in config/certs/ca.p12 -out config/certs/http_ca.pem -nodes# crtè½¬æ¢å›PKCS12æ ¼å¼$ openssl pkcs12 -export -out config/certs/http_ca.p12 -inkey config/certs/http_ca.key -in config/certs/http_ca.crt -name &quot;My CA&quot; ç”Ÿæˆhttpè¯ä¹¦æ—¶ä¸ºæ¯ä¸ªèŠ‚ç‚¹å•ç‹¬é…ç½®è¯ä¹¦ 12345678910111213141516171819202122232425262728293031323334353637383940414243Generate a certificate per node? [y/N]y # æ˜¯å¦ä¸ºæ¯ä¸ªèŠ‚ç‚¹å•ç‹¬é…ç½®è¯ä¹¦ï¼Œè¿™é‡Œé€‰æ‹©æ˜¯node #1 name: node-1 # èŠ‚ç‚¹åç§°ï¼Œå¿…é¡»ä¸ESé…ç½®æ–‡ä»¶ä¸­çš„node.nameä¸€è‡´Enter all the hostnames that you need, one per line. # è¾“å…¥ node-1 èŠ‚ç‚¹çš„hostnameWhen you are done, press &lt;ENTER&gt; once more to move on to the next step.localhost # ä¹ æƒ¯åŠ ä¸Š localhostip-10-250-0-239.cn-northwest-1.compute.internal # node-1 çš„ hostnameYou entered the following hostnames. - localhost - ip-10-250-0-239.cn-northwest-1.compute.internalIs this correct [Y/n]y # ç¡®è®¤æ˜¯å¦æ­£ç¡®Enter all the IP addresses that you need, one per line. # è¾“å…¥ node-1 èŠ‚ç‚¹çš„IPåœ°å€When you are done, press &lt;ENTER&gt; once more to move on to the next step.127.0.0.1 # ä¹ æƒ¯åŠ ä¸Š 127.0.0.110.250.0.239 # node-1 çš„ IPYou entered the following IP addresses. - 127.0.0.1 - 10.250.0.239Is this correct [Y/n]y # ç¡®è®¤æ˜¯å¦æ­£ç¡®Do you wish to change any of these options? [y/N]n # ä¸ä¿®æ”¹ä»»ä½•é€‰é¡¹Generate additional certificates? [Y/n]y # æ˜¯å¦ç”Ÿæˆå…¶ä»–è¯ä¹¦ï¼Œè¿™é‡Œé€‰æ‹©æ˜¯ï¼Œæ¥ç€ä¸ºå…¶å®ƒèŠ‚ç‚¹åˆ›å»ºè¯ä¹¦node #2 name: node-2 # èŠ‚ç‚¹åç§°ï¼Œå¿…é¡»ä¸ESé…ç½®æ–‡ä»¶ä¸­çš„node.nameä¸€è‡´# ä¾æ¬¡ä¸ºæ¯ä¸ªèŠ‚ç‚¹åˆ›å»ºè¯ä¹¦â€¦â€¦â€¦â€¦â€¦â€¦Generate additional certificates? [Y/n]n # åˆ›å»ºå¥½æ‰€æœ‰èŠ‚ç‚¹çš„è¯ä¹¦åï¼Œé€‰æ‹©nï¼Œä¸å†åˆ›å»ºæ–°çš„è¯ä¹¦If you wish to use a blank password, simply press &lt;enter&gt; at the prompt below.Provide a password for the &quot;http.p12&quot; file: [&lt;ENTER&gt; for none] # ç›´æ¥å›è½¦ä¸è®¾ç½®å¯†ç What filename should be used for the output zip file? [/usr/local/elasticsearch/elasticsearch-8.17.3/elasticsearch-ssl-http.zip] # è¾“å‡ºæ–‡ä»¶åï¼Œè¿™é‡Œå¯ä»¥è‡ªå®šä¹‰ï¼Œé»˜è®¤æ˜¯ elasticsearch-ssl-http.zipZip file written to /usr/local/elasticsearch/elasticsearch-8.17.3/elasticsearch-ssl-http.zip æ­¤æ—¶è§£å‹æŸ¥çœ‹æ–‡ä»¶ç»“æ„ 12345678910111213141516171819unzip elasticsearch-ssl-http.zipArchive: elasticsearch-ssl-http.zip creating: elasticsearch/ creating: elasticsearch/node-1/ inflating: elasticsearch/node-1/README.txt inflating: elasticsearch/node-1/http.p12 # node-1 çš„è¯ä¹¦ inflating: elasticsearch/node-1/sample-elasticsearch.yml creating: elasticsearch/node-2/ inflating: elasticsearch/node-2/README.txt inflating: elasticsearch/node-2/http.p12 # node-2 çš„è¯ä¹¦ inflating: elasticsearch/node-2/sample-elasticsearch.yml creating: elasticsearch/node-3/ inflating: elasticsearch/node-3/README.txt inflating: elasticsearch/node-3/http.p12 # node-3 çš„è¯ä¹¦ inflating: elasticsearch/node-3/sample-elasticsearch.yml creating: kibana/ inflating: kibana/README.txt inflating: kibana/elasticsearch-ca.pem # kibana çš„è¯ä¹¦ inflating: kibana/sample-kibana.yml å°†å¯¹åº”çš„è¯ä¹¦æ‹·è´åˆ°å¯¹åº”èŠ‚ç‚¹çš„ config/certs ç›®å½•ä¸‹","summary":"æ‘˜è¦ æœ¬æ–‡ä»‹ç»Elasticsearchè¯ä¹¦è¿‡æœŸæ—¶çš„å¤„ç†æ–¹æ³• Elasticsearchç‰ˆæœ¬8.17.3 æœ¬æ–‡åŸºäº linuxä¸‹å®‰è£…Elasticsearch å®˜æ–¹æ–‡æ¡£:Updating node security certificates","date_published":"2025-04-16T13:30:05.000Z","tags":["æŠ€æœ¯","elastic","elasticsearch","elasticsearch"]},{"id":"https://blog.hanqunfeng.com/2025/04/07/elk-02-springboot/","url":"https://blog.hanqunfeng.com/2025/04/07/elk-02-springboot/","title":"Springbootæ•´åˆLogstashå®ç°æ—¥å¿—é‡‡é›†","content_html":"<!--\n **åŠ ç²—**\n *æ–œä½“*\n ***åŠ ç²—å¹¶æ–œä½“***\n ~~åˆ é™¤çº¿~~\n ==çªå‡ºæ˜¾ç¤º==\n `çªå‡ºæ˜¾ç¤º(æ¨è)`\n ++ä¸‹åˆ’çº¿++\n ~ä¸‹æ ‡~\n ^ä¸Šæ ‡^\n è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference.\n å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)\n\n +++ **ç‚¹å‡»æŠ˜å **\n è¿™æ˜¯è¢«éšè—çš„å†…å®¹\n +++\n\n::: tips success warning danger\nè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹\n:::\n\n% note info % success warning danger\nè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹\n% endnote %\n\nå¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{}\n å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ\n -->\n<h2 id=\"æ‘˜è¦\">æ‘˜è¦</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æœ¬æ–‡ä»‹ç»å¦‚ä½•åœ¨Springbooté¡¹ç›®ä¸­æ•´åˆLogStashå®ç°æ—¥å¿—é‡‡é›†</p>\n</li>\n<li class=\"lvl-2\">\n<p>æœ¬æ–‡åŸºäºSpringboot2.7.xç‰ˆæœ¬è¿›è¡Œæµ‹è¯•ï¼ŒLogstashç‰ˆæœ¬ä¸º8.17.3</p>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"ä½¿ç”¨logstashæ—¥å¿—æ’ä»¶\">ä½¿ç”¨logstashæ—¥å¿—æ’ä»¶</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><a href=\"https://github.com/logfellow/logstash-logback-encoder\">SpringBootçš„Logstashæ—¥å¿—æ’ä»¶</a>ï¼Œæœ¬æ–‡åªè¿›è¡Œç®€å•ä»‹ç»ï¼Œæ›´å¤šè¯¦ç»†é…ç½®å¯ä»¥å‚è€ƒ<a href=\"https://github.com/logfellow/logstash-logback-encoder\">å®˜æ–¹æ–‡æ¡£</a></p>\n</li>\n<li class=\"lvl-2\">\n<p>å¼•å…¥ä¾èµ–ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„8.xä»¥ä¸Šçš„ç‰ˆæœ¬éœ€è¦jdk11ï¼Œå¦‚æœæ˜¯jdk8çš„è¯å¯ä»¥ä½¿ç”¨6.xæˆ–7.xç‰ˆæœ¬</p>\n</li>\n</ul>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>net.logstash.logback<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>logstash-logback-encoder<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>7.3<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span> <span class=\"comment\">&lt;!-- ç‰ˆæœ¬å·æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹ --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>æ³¨æ„ï¼š<br>\nspringboot2.7.xä»¥ä¸‹ç‰ˆæœ¬ï¼Œå»ºè®®ä½¿ç”¨logstash-logback-encoderçš„7.3ä»¥ä¸‹ç‰ˆæœ¬ã€‚<br>\nspringboot3.x.xä»¥ä¸Šç‰ˆæœ¬ï¼Œå»ºè®®ä½¿ç”¨logstash-logback-encoderçš„7.4åŠä»¥ä¸Šç‰ˆæœ¬ã€‚</p>\n</blockquote>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>logback-spring.xml</code>ä¸­æ·»åŠ logstashé…ç½®</p>\n</li>\n</ul>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=<span class=\"string\">&quot;1.0&quot;</span> encoding=<span class=\"string\">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">configuration</span> <span class=\"attr\">debug</span>=<span class=\"string\">&quot;false&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- æ§åˆ¶å°è¾“å‡º --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">appender</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;STDOUT&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;ch.qos.logback.core.ConsoleAppender&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">encoder</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;ch.qos.logback.classic.encoder.PatternLayoutEncoder&quot;</span>&gt;</span></span><br><span class=\"line\">            <span class=\"comment\">&lt;!--æ ¼å¼åŒ–è¾“å‡ºï¼š%dè¡¨ç¤ºæ—¥æœŸï¼Œ%threadè¡¨ç¤ºçº¿ç¨‹åï¼Œ%-5levelï¼šçº§åˆ«ä»å·¦æ˜¾ç¤º5ä¸ªå­—ç¬¦å®½åº¦ %logger&#123;50&#125;ï¼šç±»è·¯å¾„ï¼Œæœ€å¤§æ˜¾ç¤º50ä¸ªå­—ç¬¦ %Mï¼šæ–¹æ³•åç§° %Lï¼šè¡Œå· %msgï¼šæ—¥å¿—æ¶ˆæ¯ï¼Œ%næ˜¯æ¢è¡Œç¬¦--&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">pattern</span>&gt;</span>[%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125;] [%thread] %-5level [%X&#123;userName&#125;][%X&#123;userLocale&#125;] %logger&#123;50&#125; - %M - %L - %msg%n<span class=\"tag\">&lt;/<span class=\"name\">pattern</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">encoder</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">appender</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- logstashè¾“å‡º --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">appender</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;LOGSTASH&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;net.logstash.logback.appender.LogstashTcpSocketAppender&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">destination</span>&gt;</span>161.189.78.202:4560<span class=\"tag\">&lt;/<span class=\"name\">destination</span>&gt;</span> <span class=\"comment\">&lt;!-- logstashåœ°å€å’Œç«¯å£ --&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">encoder</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;net.logstash.logback.encoder.LogstashEncoder&quot;</span> &gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">timestampPattern</span>&gt;</span>yyyy-MM-dd&#x27;T&#x27;HH:mm:ss.SSS<span class=\"tag\">&lt;/<span class=\"name\">timestampPattern</span>&gt;</span> <span class=\"comment\">&lt;!-- æ—¶é—´æ ¼å¼ï¼Œè¿™ä¸ªæ˜¯é»˜è®¤å€¼ --&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">includeMdc</span>&gt;</span>true<span class=\"tag\">&lt;/<span class=\"name\">includeMdc</span>&gt;</span>   <span class=\"comment\">&lt;!-- é»˜è®¤true, trueè¡¨ç¤ºè¾“å‡ºMDCä¿¡æ¯ --&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">includeCallerData</span>&gt;</span>true<span class=\"tag\">&lt;/<span class=\"name\">includeCallerData</span>&gt;</span> <span class=\"comment\">&lt;!-- é»˜è®¤false, trueè¡¨ç¤ºè¾“å‡ºæ‰“å°æ—¥å¿—çš„ç±»åã€æ–¹æ³•åã€è¡Œå·ç­‰ä¿¡æ¯ --&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">customFields</span>&gt;</span>&#123;&quot;appname&quot;: &quot;springboot-logstash-demo&quot;&#125;<span class=\"tag\">&lt;/<span class=\"name\">customFields</span>&gt;</span> <span class=\"comment\">&lt;!-- è‡ªå®šä¹‰å­—æ®µ --&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">encoder</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">appender</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- æ—¥å¿—è¾“å‡ºçº§åˆ« --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">root</span> <span class=\"attr\">level</span>=<span class=\"string\">&quot;info&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">appender-ref</span> <span class=\"attr\">ref</span>=<span class=\"string\">&quot;STDOUT&quot;</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">appender-ref</span> <span class=\"attr\">ref</span>=<span class=\"string\">&quot;LOGSTASH&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">root</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æ·»åŠ <code>config/springboot-demo.conf</code>é…ç½®</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">input &#123;</span><br><span class=\"line\">  tcp &#123;</span><br><span class=\"line\">    host =&gt; <span class=\"string\">&quot;0.0.0.0&quot;</span> <span class=\"comment\"># ç›‘å¬ä»»æ„åœ°å€</span></span><br><span class=\"line\">    port =&gt; <span class=\"string\">&quot;4560&quot;</span> <span class=\"comment\"># ç›‘å¬ç«¯å£</span></span><br><span class=\"line\">    mode =&gt; <span class=\"string\">&quot;server&quot;</span> <span class=\"comment\"># serveræ¨¡å¼</span></span><br><span class=\"line\">    codec =&gt; json_lines <span class=\"comment\"># ä½¿ç”¨json_linesæ ¼å¼</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">output &#123;</span><br><span class=\"line\">  stdout &#123;</span><br><span class=\"line\">    codec =&gt; rubydebug</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  elasticsearch &#123; <span class=\"comment\"># è¾“å‡ºåˆ°ES</span></span><br><span class=\"line\">        index =&gt; <span class=\"string\">&quot;%&#123;[appname]&#125;-%&#123;+YYYY-MM-DD&#125;&quot;</span> <span class=\"comment\"># ç´¢å¼•å,æŒ‰å¤©åˆ†éš”ï¼Œè¿™é‡Œä½¿ç”¨å˜é‡appnameä½œä¸ºç´¢å¼•å</span></span><br><span class=\"line\">        hosts =&gt; [<span class=\"string\">&quot;https://10.250.0.239:9200&quot;</span>] <span class=\"comment\"># ESåœ°å€</span></span><br><span class=\"line\">        user =&gt; <span class=\"string\">&quot;elastic&quot;</span>                   <span class=\"comment\"># ESç”¨æˆ·å</span></span><br><span class=\"line\">        password =&gt; <span class=\"string\">&quot;123456&quot;</span>                <span class=\"comment\"># ESå¯†ç </span></span><br><span class=\"line\">        ssl =&gt; <span class=\"literal\">true</span>                         <span class=\"comment\"># æ˜¯å¦å¯ç”¨SSLï¼Œå› ä¸ºè¿™é‡Œæ˜¯httpsè®¿é—®ES</span></span><br><span class=\"line\">        ssl_certificate_verification =&gt; <span class=\"literal\">false</span> <span class=\"comment\"># ç¦ç”¨è¯ä¹¦éªŒè¯</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å¯åŠ¨logstash</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bin/logstash -f config/springboot-demo.conf --config.reload.automatic</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>logstashå¯åŠ¨æˆåŠŸåï¼Œä¼šè¾“å‡ºç±»ä¼¼å¦‚ä¸‹ä¿¡æ¯</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;message&quot;</span> =&gt; <span class=\"string\">&quot;Tomcat started on port(s): 8088 (http) with context path &#x27;/springboot-logstash&#x27;&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;level_value&quot;</span> =&gt; 20000,</span><br><span class=\"line\">            <span class=\"string\">&quot;appname&quot;</span> =&gt; <span class=\"string\">&quot;springboot-logstash-demo&quot;</span>,</span><br><span class=\"line\">              <span class=\"string\">&quot;level&quot;</span> =&gt; <span class=\"string\">&quot;INFO&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;logger_name&quot;</span> =&gt; <span class=\"string\">&quot;org.springframework.boot.web.embedded.tomcat.TomcatWebServer&quot;</span>,</span><br><span class=\"line\">         <span class=\"string\">&quot;@timestamp&quot;</span> =&gt; 2025-04-07T09:39:43.569Z,</span><br><span class=\"line\">           <span class=\"string\">&quot;@version&quot;</span> =&gt; <span class=\"string\">&quot;1&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;thread_name&quot;</span> =&gt; <span class=\"string\">&quot;restartedMain&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;caller_class_name&quot;</span> =&gt; <span class=\"string\">&quot;org.springframework.boot.web.embedded.tomcat.TomcatWebServer&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;caller_file_name&quot;</span> =&gt; <span class=\"string\">&quot;TomcatWebServer.java&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;caller_method_name&quot;</span> =&gt; <span class=\"string\">&quot;start&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;caller_line_number&quot;</span> =&gt; 220,</span><br><span class=\"line\">        <span class=\"string\">&quot;userName&quot;</span> =&gt; <span class=\"string\">&quot;admin&quot;</span>, <span class=\"comment\"># MDCä¿¡æ¯é»˜è®¤ä¼šæ‰“å°</span></span><br><span class=\"line\">        <span class=\"string\">&quot;userLocale&quot;</span> =&gt; <span class=\"string\">&quot;zh_CN&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å¯ä»¥è®¿é—®ESæˆ–è€…KibanaæŸ¥çœ‹ç´¢å¼•ä¿¡æ¯ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚</p>\n</li>\n</ul>\n","content_text":"æ‘˜è¦ æœ¬æ–‡ä»‹ç»å¦‚ä½•åœ¨Springbooté¡¹ç›®ä¸­æ•´åˆLogStashå®ç°æ—¥å¿—é‡‡é›† æœ¬æ–‡åŸºäºSpringboot2.7.xç‰ˆæœ¬è¿›è¡Œæµ‹è¯•ï¼ŒLogstashç‰ˆæœ¬ä¸º8.17.3 ä½¿ç”¨logstashæ—¥å¿—æ’ä»¶ SpringBootçš„Logstashæ—¥å¿—æ’ä»¶ï¼Œæœ¬æ–‡åªè¿›è¡Œç®€å•ä»‹ç»ï¼Œæ›´å¤šè¯¦ç»†é…ç½®å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ å¼•å…¥ä¾èµ–ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„8.xä»¥ä¸Šçš„ç‰ˆæœ¬éœ€è¦jdk11ï¼Œå¦‚æœæ˜¯jdk8çš„è¯å¯ä»¥ä½¿ç”¨6.xæˆ–7.xç‰ˆæœ¬ 12345&lt;dependency&gt; &lt;groupId&gt;net.logstash.logback&lt;/groupId&gt; &lt;artifactId&gt;logstash-logback-encoder&lt;/artifactId&gt; &lt;version&gt;7.3&lt;/version&gt; &lt;!-- ç‰ˆæœ¬å·æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹ --&gt;&lt;/dependency&gt; æ³¨æ„ï¼š springboot2.7.xä»¥ä¸‹ç‰ˆæœ¬ï¼Œå»ºè®®ä½¿ç”¨logstash-logback-encoderçš„7.3ä»¥ä¸‹ç‰ˆæœ¬ã€‚ springboot3.x.xä»¥ä¸Šç‰ˆæœ¬ï¼Œå»ºè®®ä½¿ç”¨logstash-logback-encoderçš„7.4åŠä»¥ä¸Šç‰ˆæœ¬ã€‚ logback-spring.xmlä¸­æ·»åŠ logstashé…ç½® 123456789101112131415161718192021222324252627&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;configuration debug=&quot;false&quot;&gt; &lt;!-- æ§åˆ¶å°è¾“å‡º --&gt; &lt;appender name=&quot;STDOUT&quot; class=&quot;ch.qos.logback.core.ConsoleAppender&quot;&gt; &lt;encoder class=&quot;ch.qos.logback.classic.encoder.PatternLayoutEncoder&quot;&gt; &lt;!--æ ¼å¼åŒ–è¾“å‡ºï¼š%dè¡¨ç¤ºæ—¥æœŸï¼Œ%threadè¡¨ç¤ºçº¿ç¨‹åï¼Œ%-5levelï¼šçº§åˆ«ä»å·¦æ˜¾ç¤º5ä¸ªå­—ç¬¦å®½åº¦ %logger&#123;50&#125;ï¼šç±»è·¯å¾„ï¼Œæœ€å¤§æ˜¾ç¤º50ä¸ªå­—ç¬¦ %Mï¼šæ–¹æ³•åç§° %Lï¼šè¡Œå· %msgï¼šæ—¥å¿—æ¶ˆæ¯ï¼Œ%næ˜¯æ¢è¡Œç¬¦--&gt; &lt;pattern&gt;[%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125;] [%thread] %-5level [%X&#123;userName&#125;][%X&#123;userLocale&#125;] %logger&#123;50&#125; - %M - %L - %msg%n&lt;/pattern&gt; &lt;/encoder&gt; &lt;/appender&gt; &lt;!-- logstashè¾“å‡º --&gt; &lt;appender name=&quot;LOGSTASH&quot; class=&quot;net.logstash.logback.appender.LogstashTcpSocketAppender&quot;&gt; &lt;destination&gt;161.189.78.202:4560&lt;/destination&gt; &lt;!-- logstashåœ°å€å’Œç«¯å£ --&gt; &lt;encoder class=&quot;net.logstash.logback.encoder.LogstashEncoder&quot; &gt; &lt;timestampPattern&gt;yyyy-MM-dd&#x27;T&#x27;HH:mm:ss.SSS&lt;/timestampPattern&gt; &lt;!-- æ—¶é—´æ ¼å¼ï¼Œè¿™ä¸ªæ˜¯é»˜è®¤å€¼ --&gt; &lt;includeMdc&gt;true&lt;/includeMdc&gt; &lt;!-- é»˜è®¤true, trueè¡¨ç¤ºè¾“å‡ºMDCä¿¡æ¯ --&gt; &lt;includeCallerData&gt;true&lt;/includeCallerData&gt; &lt;!-- é»˜è®¤false, trueè¡¨ç¤ºè¾“å‡ºæ‰“å°æ—¥å¿—çš„ç±»åã€æ–¹æ³•åã€è¡Œå·ç­‰ä¿¡æ¯ --&gt; &lt;customFields&gt;&#123;&quot;appname&quot;: &quot;springboot-logstash-demo&quot;&#125;&lt;/customFields&gt; &lt;!-- è‡ªå®šä¹‰å­—æ®µ --&gt; &lt;/encoder&gt; &lt;/appender&gt; &lt;!-- æ—¥å¿—è¾“å‡ºçº§åˆ« --&gt; &lt;root level=&quot;info&quot;&gt; &lt;appender-ref ref=&quot;STDOUT&quot;/&gt; &lt;appender-ref ref=&quot;LOGSTASH&quot;/&gt; &lt;/root&gt;&lt;/configuration&gt; æ·»åŠ config/springboot-demo.confé…ç½® 123456789101112131415161718192021input &#123; tcp &#123; host =&gt; &quot;0.0.0.0&quot; # ç›‘å¬ä»»æ„åœ°å€ port =&gt; &quot;4560&quot; # ç›‘å¬ç«¯å£ mode =&gt; &quot;server&quot; # serveræ¨¡å¼ codec =&gt; json_lines # ä½¿ç”¨json_linesæ ¼å¼ &#125;&#125;output &#123; stdout &#123; codec =&gt; rubydebug &#125; elasticsearch &#123; # è¾“å‡ºåˆ°ES index =&gt; &quot;%&#123;[appname]&#125;-%&#123;+YYYY-MM-DD&#125;&quot; # ç´¢å¼•å,æŒ‰å¤©åˆ†éš”ï¼Œè¿™é‡Œä½¿ç”¨å˜é‡appnameä½œä¸ºç´¢å¼•å hosts =&gt; [&quot;https://10.250.0.239:9200&quot;] # ESåœ°å€ user =&gt; &quot;elastic&quot; # ESç”¨æˆ·å password =&gt; &quot;123456&quot; # ESå¯†ç  ssl =&gt; true # æ˜¯å¦å¯ç”¨SSLï¼Œå› ä¸ºè¿™é‡Œæ˜¯httpsè®¿é—®ES ssl_certificate_verification =&gt; false # ç¦ç”¨è¯ä¹¦éªŒè¯ &#125;&#125; å¯åŠ¨logstash 1bin/logstash -f config/springboot-demo.conf --config.reload.automatic logstashå¯åŠ¨æˆåŠŸåï¼Œä¼šè¾“å‡ºç±»ä¼¼å¦‚ä¸‹ä¿¡æ¯ 12345678910111213141516&#123; &quot;message&quot; =&gt; &quot;Tomcat started on port(s): 8088 (http) with context path &#x27;/springboot-logstash&#x27;&quot;, &quot;level_value&quot; =&gt; 20000, &quot;appname&quot; =&gt; &quot;springboot-logstash-demo&quot;, &quot;level&quot; =&gt; &quot;INFO&quot;, &quot;logger_name&quot; =&gt; &quot;org.springframework.boot.web.embedded.tomcat.TomcatWebServer&quot;, &quot;@timestamp&quot; =&gt; 2025-04-07T09:39:43.569Z, &quot;@version&quot; =&gt; &quot;1&quot;, &quot;thread_name&quot; =&gt; &quot;restartedMain&quot;, &quot;caller_class_name&quot; =&gt; &quot;org.springframework.boot.web.embedded.tomcat.TomcatWebServer&quot;, &quot;caller_file_name&quot; =&gt; &quot;TomcatWebServer.java&quot;, &quot;caller_method_name&quot; =&gt; &quot;start&quot;, &quot;caller_line_number&quot; =&gt; 220, &quot;userName&quot; =&gt; &quot;admin&quot;, # MDCä¿¡æ¯é»˜è®¤ä¼šæ‰“å° &quot;userLocale&quot; =&gt; &quot;zh_CN&quot;&#125; å¯ä»¥è®¿é—®ESæˆ–è€…KibanaæŸ¥çœ‹ç´¢å¼•ä¿¡æ¯ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚","summary":"æ‘˜è¦ æœ¬æ–‡ä»‹ç»å¦‚ä½•åœ¨Springbooté¡¹ç›®ä¸­æ•´åˆLogStashå®ç°æ—¥å¿—é‡‡é›† æœ¬æ–‡åŸºäºSpringboot2.7.xç‰ˆæœ¬è¿›è¡Œæµ‹è¯•ï¼ŒLogstashç‰ˆæœ¬ä¸º8.17.3","date_published":"2025-04-07T13:30:05.000Z","tags":["æŠ€æœ¯","springboot","logstash","springboot","logstash"]},{"id":"https://blog.hanqunfeng.com/2025/03/27/elk-01/","url":"https://blog.hanqunfeng.com/2025/03/27/elk-01/","title":"ä¸€æ–‡ææ‡‚ELK","content_html":"<!--\n **åŠ ç²—**\n *æ–œä½“*\n ***åŠ ç²—å¹¶æ–œä½“***\n ~~åˆ é™¤çº¿~~\n ==çªå‡ºæ˜¾ç¤º==\n `çªå‡ºæ˜¾ç¤º(æ¨è)`\n ++ä¸‹åˆ’çº¿++\n ~ä¸‹æ ‡~\n ^ä¸Šæ ‡^\n è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference.\n å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)\n\n +++ **ç‚¹å‡»æŠ˜å **\n è¿™æ˜¯è¢«éšè—çš„å†…å®¹\n +++\n\n::: tips success warning danger\nè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹\n:::\n\n% note info % success warning danger\nè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹\n% endnote %\n\nå¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{}\n å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ\n -->\n<h2 id=\"æ‘˜è¦\">æ‘˜è¦</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æœ¬æ–‡ä»‹ç»å¦‚ä½•åœ¨linuxä¸‹å®‰è£…LogStashå’ŒFileBeat</p>\n</li>\n<li class=\"lvl-2\">\n<p>é€šè¿‡ç¤ºä¾‹è®²è§£ELKçš„ç»å…¸æ¶æ„å’Œé«˜å¹¶å‘æ¶æ„çš„å®ç°è¿‡ç¨‹</p>\n</li>\n<li class=\"lvl-2\">\n<p>LogStashç‰ˆæœ¬8.17.3ï¼ŒFileBeatç‰ˆæœ¬8.17.3</p>\n</li>\n<li class=\"lvl-2\">\n<p>Elasticsearchç‰ˆæœ¬8.17.3ï¼Œ<a href=\"/2025/03/20/elasticsearch-01-install/\" title=\"linuxä¸‹å®‰è£…Elasticsearch\">linuxä¸‹å®‰è£…Elasticsearch</a></p>\n</li>\n<li class=\"lvl-2\">\n<p>Kibanaç‰ˆæœ¬8.17.3ï¼Œ<a href=\"/2025/03/21/kibana-01-install/\" title=\"linuxä¸‹å®‰è£…Kibana\">linuxä¸‹å®‰è£…Kibana</a></p>\n</li>\n<li class=\"lvl-2\">\n<p>Elasticsearché›†ç¾¤æ­å»ºï¼Œ<a href=\"/2025/03/24/elasticsearch-02-install-cluster/\" title=\"linuxä¸‹å®‰è£…Elasticsearché›†ç¾¤\">linuxä¸‹å®‰è£…Elasticsearché›†ç¾¤</a></p>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"Logstashæ¦‚è¿°\">Logstashæ¦‚è¿°</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><a href=\"https://www.elastic.co/cn/logstash\">Logstash</a> æ˜¯å…è´¹ä¸”å¼€æ”¾çš„æœåŠ¡å™¨ç«¯æ•°æ®å¤„ç†ç®¡é“ï¼Œèƒ½å¤Ÿä»å¤šä¸ªæ¥æºé‡‡é›†æ•°æ®ï¼Œè½¬æ¢æ•°æ®ï¼Œç„¶åå°†æ•°æ®å‘é€åˆ°æ‚¨æœ€å–œæ¬¢çš„å­˜å‚¨åº“ä¸­ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>Logstashæ•°æ®ä¼ è¾“åŸç†<br>\n<img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/image-2.png\" alt=\"\"></p>\n</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.æ•°æ®é‡‡é›†ä¸è¾“å…¥ï¼šLogstashæ”¯æŒå„ç§è¾“å…¥é€‰æ‹©ï¼Œèƒ½å¤Ÿä»¥è¿ç»­çš„æµå¼ä¼ è¾“æ–¹å¼ï¼Œè½»æ¾åœ°ä»æ—¥å¿—ã€æŒ‡æ ‡ã€Webåº”ç”¨ä»¥åŠæ•°æ®å­˜å‚¨ä¸­é‡‡é›†æ•°æ®ã€‚</span><br><span class=\"line\">2.å®æ—¶è§£æå’Œæ•°æ®è½¬æ¢ï¼šé€šè¿‡Logstashè¿‡æ»¤å™¨è§£æå„ä¸ªäº‹ä»¶ï¼Œè¯†åˆ«å·²å‘½åçš„å­—æ®µæ¥æ„å»ºç»“æ„ï¼Œå¹¶å°†å®ƒä»¬è½¬æ¢æˆé€šç”¨æ ¼å¼ï¼Œæœ€ç»ˆå°†æ•°æ®ä»æºç«¯ä¼ è¾“åˆ°å­˜å‚¨åº“ä¸­ã€‚</span><br><span class=\"line\">3.å­˜å‚¨ä¸æ•°æ®å¯¼å‡ºï¼šLogstashæä¾›å¤šç§è¾“å‡ºé€‰æ‹©ï¼Œå¯ä»¥å°†æ•°æ®å‘é€åˆ°æŒ‡å®šçš„åœ°æ–¹ã€‚</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/%E6%88%AA%E5%9B%BE-3.png\" alt=\"\"></p>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Logstashé€šè¿‡ç®¡é“å®Œæˆæ•°æ®çš„é‡‡é›†ä¸å¤„ç†ï¼Œç®¡é“é…ç½®ä¸­åŒ…å«inputã€outputå’Œfilterï¼ˆå¯é€‰ï¼‰æ’ä»¶ï¼Œinputå’Œoutputç”¨æ¥é…ç½®è¾“å…¥å’Œè¾“å‡ºæ•°æ®æºã€filterç”¨æ¥å¯¹æ•°æ®è¿›è¡Œè¿‡æ»¤æˆ–é¢„å¤„ç†ã€‚</p>\n</li>\n</ul>\n<h2 id=\"Logstashä¸‹è½½å®‰è£…\">Logstashä¸‹è½½å®‰è£…</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ä¸‹è½½åœ°å€ï¼š<a href=\"https://www.elastic.co/cn/downloads/past-releases#logstash\">https://www.elastic.co/cn/downloads/past-releases#logstash</a></p>\n</li>\n<li class=\"lvl-2\">\n<p>é€‰æ‹©å¯¹åº”çš„ç‰ˆæœ¬ï¼šè¿™é‡Œé€‰æ‹©å½“å‰çš„æœ€æ–°ç‰ˆ<code>LogStash 8.17.3</code>ï¼Œä¹‹åé€‰æ‹©å¯¹åº”çš„æ“ä½œç³»ç»Ÿ<code>LINUX X86_64</code></p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget https://artifacts.elastic.co/downloads/logstash/logstash-8.17.3-linux-x86_64.tar.gz</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ä¸‹è½½å®Œæˆåè§£å‹åˆ°<code>/usr/local/logstash</code>ç›®å½•ä¸‹ï¼Œè§£å‹å‘½ä»¤å¦‚ä¸‹ï¼š</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">mkdir</span> /usr/local/logstash</span><br><span class=\"line\">tar -zxvf logstash-8.17.3-linux-x86_64.tar.gz -C /usr/local/logstash</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>elasticsearchå’Œkibanaéƒ½ä¸èƒ½ç”¨rootç”¨æˆ·å¯åŠ¨ï¼Œä¸ºäº†ç»Ÿä¸€ç®¡ç†ï¼Œlogstashä¹Ÿä½¿ç”¨è¿™ä¸ªç”¨æˆ·ï¼ˆéå¿…è¦ï¼‰</p>\n</li>\n<li class=\"lvl-2\">\n<p>åˆ›å»ºç”¨æˆ·<code>elastic</code>ï¼Œå¹¶è®¾ç½®å¯†ç ï¼Œè¿™ä¸€æ­¥æˆ‘ä»¬åœ¨å®‰è£…elasticsearchçš„æ—¶å€™å·²ç»é…ç½®è¿‡äº†ï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°äº†</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">useradd elastic</span><br><span class=\"line\">passwd elastic</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ä¿®æ”¹logstashå®‰è£…ç›®å½•çš„ç”¨æˆ·æƒé™</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">chown</span> -R elastic:elastic /usr/local/logstash</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åˆ‡æ¢åˆ°elasticç”¨æˆ·ä¸‹æ‰§è¡Œå‘½ä»¤</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># åˆ‡æ¢ç”¨æˆ·</span></span><br><span class=\"line\">su - elastic</span><br><span class=\"line\"><span class=\"comment\"># è¿›å…¥logstashå®‰è£…ç›®å½•</span></span><br><span class=\"line\"><span class=\"built_in\">cd</span> /usr/local/logstash/logstash-8.17.3/</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>è¿è¡Œä¸€ä¸ªç®€å•çš„æµ‹è¯•</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># -e: ç›´æ¥æŠŠé…ç½®æ”¾åœ¨å‘½ä»¤ä¸­ï¼Œè¿™æ ·å¯ä»¥æœ‰æ•ˆå¿«é€Ÿè¿›è¡Œæµ‹è¯•</span></span><br><span class=\"line\"><span class=\"comment\"># input &#123; stdin &#123; &#125; &#125;: è¾“å…¥æ’ä»¶ï¼Œä»æ ‡å‡†è¾“å…¥ä¸­è¯»å–æ•°æ®</span></span><br><span class=\"line\"><span class=\"comment\"># output &#123; stdout &#123;&#125; &#125;: è¾“å‡ºæ’ä»¶ï¼Œå°†æ•°æ®è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡º</span></span><br><span class=\"line\"><span class=\"comment\"># è¿™é‡ŒåªåŒ…å«äº† input å’Œ output ä¸¤ä¸ªéƒ¨åˆ†ï¼Œå®é™…ä½¿ç”¨ä¸­è¿˜éœ€è¦æ·»åŠ  filter éƒ¨åˆ†</span></span><br><span class=\"line\">./bin/logstash -e <span class=\"string\">&#x27;input &#123; stdin &#123; &#125; &#125; output &#123; stdout &#123;&#125; &#125;&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># è¾“å‡ºï¼š</span></span><br><span class=\"line\">ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ <span class=\"comment\"># è¾“å‡ºå¯åŠ¨ä¿¡æ¯</span></span><br><span class=\"line\">The stdin plugin is now waiting <span class=\"keyword\">for</span> input: <span class=\"comment\"># è¾“å‡ºæç¤ºä¿¡æ¯ï¼Œæç¤ºä½ è¾“å…¥å†…å®¹</span></span><br><span class=\"line\">hello world  <span class=\"comment\"># æˆ‘è¾“å…¥å†…å®¹</span></span><br><span class=\"line\"><span class=\"comment\"># logstashè¾“å‡ºå†…å®¹</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">       <span class=\"string\">&quot;message&quot;</span> =&gt; <span class=\"string\">&quot;hello world&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;@version&quot;</span> =&gt; <span class=\"string\">&quot;1&quot;</span>,</span><br><span class=\"line\">         <span class=\"string\">&quot;event&quot;</span> =&gt; &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;original&quot;</span> =&gt; <span class=\"string\">&quot;hello world&quot;</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">          <span class=\"string\">&quot;host&quot;</span> =&gt; &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;hostname&quot;</span> =&gt; <span class=\"string\">&quot;ip-10-250-0-239.cn-northwest-1.compute.internal&quot;</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">&quot;@timestamp&quot;</span> =&gt; 2025-03-27T06:48:12.810617855Z</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ä¹Ÿå¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶å¯åŠ¨logstash</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># vim test.conf</span></span><br><span class=\"line\">input &#123;</span><br><span class=\"line\">  stdin &#123; &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">output &#123;</span><br><span class=\"line\">  stdout &#123; codec =&gt; rubydebug &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># codec =&gt; rubydebug : æ˜¯æŒ‡å®šäº†ä¸€ä¸ªç¼–ç å™¨ï¼ˆCodecï¼‰ä¸º rubydebugã€‚</span></span><br><span class=\"line\"><span class=\"comment\"># ç¼–ç å™¨è´Ÿè´£å¦‚ä½•æ ¼å¼åŒ–è¾“å‡ºçš„æ•°æ®ã€‚</span></span><br><span class=\"line\"><span class=\"comment\"># Rubydebug ç¼–ç å™¨æ˜¯ä¸€ç§ç‰¹åˆ«é€‚åˆå¼€å‘å’Œè°ƒè¯•ç›®çš„çš„ç¼–ç å™¨ï¼Œå› ä¸ºå®ƒèƒ½ä»¥ç›¸å½“æ˜“è¯»çš„å½¢å¼å±•ç¤ºå¤æ‚çš„ç»“æ„åŒ–æ•°æ®ï¼Œæ¯”å¦‚åµŒå¥—çš„å“ˆå¸Œè¡¨æˆ–è€…æ•°ç»„ã€‚</span></span><br><span class=\"line\"><span class=\"comment\"># é™¤äº† Rubydebug ç¼–ç å™¨ï¼ŒLogstash è¿˜æä¾›äº†å…¶ä»–å‡ ç§ç¼–ç å™¨ï¼Œæ¯”å¦‚ jsonã€plainã€multiline ç­‰ç­‰ã€‚</span></span><br><span class=\"line\"><span class=\"comment\"># å…·ä½“å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼šhttps://www.elastic.co/guide/en/logstash/current/codec-plugins.html</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./bin/logstash -f ./test.conf</span><br></pre></td></tr></table></figure>\n<h2 id=\"Logstashæ’ä»¶\">Logstashæ’ä»¶</h2>\n<h3 id=\"Input-Plugins\">Input Plugins</h3>\n<blockquote>\n<p><a href=\"https://www.elastic.co/guide/en/logstash/8.17/input-plugins.html\">https://www.elastic.co/guide/en/logstash/8.17/input-plugins.html</a></p>\n</blockquote>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ä¸€ä¸ª Pipelineå¯ä»¥æœ‰å¤šä¸ªinputæ’ä»¶</p>\n</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- Stdin / File</span><br><span class=\"line\">- Beats / Log4J /Elasticsearch / JDBC / Kafka /Rabbitmq /Redis</span><br><span class=\"line\">- JMX/ HTTP / Websocket / UDP / TCP</span><br><span class=\"line\">- Google Cloud Storage / S3</span><br><span class=\"line\">- Github / Twitter</span><br></pre></td></tr></table></figure>\n<h3 id=\"Filter-Plugins\">Filter Plugins</h3>\n<blockquote>\n<p><a href=\"https://www.elastic.co/guide/en/logstash/8.17/filter-plugins.html\">https://www.elastic.co/guide/en/logstash/8.17/filter-plugins.html</a></p>\n</blockquote>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Filter Pluginå¯ä»¥å¯¹Logstash Eventè¿›è¡Œå„ç§å¤„ç†ï¼Œä¾‹å¦‚è§£æï¼Œåˆ é™¤å­—æ®µï¼Œç±»å‹è½¬æ¢</p>\n</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- Date: æ—¥æœŸè§£æ</span><br><span class=\"line\">- Dissect: åˆ†å‰²ç¬¦è§£æ</span><br><span class=\"line\">- Grok: æ­£åˆ™åŒ¹é…è§£æ</span><br><span class=\"line\">- Mutate: å¯¹å­—æ®µåšå„ç§æ“ä½œ</span><br><span class=\"line\">- Convert : ç±»å‹è½¬æ¢</span><br><span class=\"line\">- Gsub : å­—ç¬¦ä¸²æ›¿æ¢</span><br><span class=\"line\">- Split / Join /Merge:  å­—ç¬¦ä¸²åˆ‡å‰²ï¼Œæ•°ç»„åˆå¹¶å­—ç¬¦ä¸²ï¼Œæ•°ç»„åˆå¹¶æ•°ç»„</span><br><span class=\"line\">- Rename: å­—æ®µé‡å‘½å</span><br><span class=\"line\">- Update / Replace: å­—æ®µå†…å®¹æ›´æ–°æ›¿æ¢</span><br><span class=\"line\">- Remove_field: å­—æ®µåˆ é™¤</span><br><span class=\"line\">- Ruby: åˆ©ç”¨Ruby ä»£ç æ¥åŠ¨æ€ä¿®æ”¹Event</span><br></pre></td></tr></table></figure>\n<h3 id=\"Output-Plugins\">Output Plugins</h3>\n<blockquote>\n<p><a href=\"https://www.elastic.co/guide/en/logstash/8.17/output-plugins.html\">https://www.elastic.co/guide/en/logstash/8.17/output-plugins.html</a></p>\n</blockquote>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å°†Eventå‘é€åˆ°ç‰¹å®šçš„ç›®çš„åœ°ï¼Œæ˜¯ Pipeline çš„æœ€åä¸€ä¸ªé˜¶æ®µã€‚å¸¸è§ Output Pluginsï¼š</p>\n</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- Elasticsearch</span><br><span class=\"line\">- Email / Pageduty</span><br><span class=\"line\">- Influxdb / Kafka / Mongodb / Opentsdb / Zabbix</span><br><span class=\"line\">- Http / TCP / Websocket</span><br></pre></td></tr></table></figure>\n<h3 id=\"Codec-Plugins\">Codec Plugins</h3>\n<blockquote>\n<p><a href=\"https://www.elastic.co/guide/en/logstash/8.17/codec-plugins.html\">https://www.elastic.co/guide/en/logstash/8.17/codec-plugins.html</a></p>\n</blockquote>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å°†åŸå§‹æ•°æ®decodeæˆEvent;å°†Event encodeæˆç›®æ ‡æ•°æ®ï¼Œå†…ç½®çš„Codec Plugins:</p>\n</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- Line / Multiline</span><br><span class=\"line\">- JSON / Avro / Cef (ArcSight Common Event Format)</span><br><span class=\"line\">- Dots / Rubydebug</span><br></pre></td></tr></table></figure>\n<h2 id=\"FileBeatæ¦‚è¿°\">FileBeatæ¦‚è¿°</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><a href=\"https://www.elastic.co/cn/beats\">Beats</a> æ˜¯ä¸€ä¸ªå…è´¹ä¸”å¼€æ”¾çš„å¹³å°ï¼Œé›†åˆäº†å¤šç§å•ä¸€ç”¨é€”çš„æ•°æ®é‡‡é›†å™¨ã€‚å®ƒä»¬ä»æˆç™¾ä¸Šåƒæˆ–æˆåƒä¸Šä¸‡å°æœºå™¨å’Œç³»ç»Ÿå‘ Logstash æˆ– Elasticsearch å‘é€æ•°æ®ã€‚<br>\n<img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/iEmI1C.png\" alt=\"\"></p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://www.elastic.co/cn/beats/filebeat\">FileBeat</a> ä¸“é—¨ç”¨äºè½¬å‘å’Œæ”¶é›†æ—¥å¿—æ•°æ®çš„è½»é‡çº§é‡‡é›†å·¥å…·ã€‚å®ƒå¯ä»¥ä½œä¸ºä»£ç†å®‰è£…åœ¨æœåŠ¡å™¨ä¸Šï¼ŒFileBeatç›‘è§†æŒ‡å®šè·¯å¾„çš„æ—¥å¿—æ–‡ä»¶ï¼Œæ”¶é›†æ—¥å¿—æ•°æ®ï¼Œå¹¶å°†æ”¶é›†åˆ°çš„æ—¥å¿—è½¬å‘åˆ°Elasticsearchæˆ–è€…Logstashã€‚</p>\n</li>\n</ul>\n<h2 id=\"logstash-vs-FileBeat\">logstash vs FileBeat</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Logstashæ˜¯åœ¨jvmä¸Šè¿è¡Œçš„ï¼Œèµ„æºæ¶ˆè€—æ¯”è¾ƒå¤§ã€‚è€ŒFileBeatæ˜¯åŸºäºgolangç¼–å†™çš„ï¼ŒåŠŸèƒ½è¾ƒå°‘ä½†èµ„æºæ¶ˆè€—ä¹Ÿæ¯”è¾ƒå°ï¼Œæ›´è½»é‡çº§ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>Logstash å’ŒFilebeatéƒ½å…·æœ‰æ—¥å¿—æ”¶é›†åŠŸèƒ½ï¼ŒFilebeatæ›´è½»é‡ï¼Œå ç”¨èµ„æºæ›´å°‘</p>\n</li>\n<li class=\"lvl-2\">\n<p>Logstash å…·æœ‰FilteråŠŸèƒ½ï¼Œèƒ½è¿‡æ»¤åˆ†ææ—¥å¿—</p>\n</li>\n<li class=\"lvl-2\">\n<p>ä¸€èˆ¬ç»“æ„éƒ½æ˜¯Filebeaté‡‡é›†æ—¥å¿—ï¼Œç„¶åå‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—ã€Redisã€MQä¸­ï¼Œç„¶åLogstashå»è·å–ï¼Œåˆ©ç”¨FilteråŠŸèƒ½è¿‡æ»¤åˆ†æï¼Œç„¶åå­˜å‚¨åˆ°Elasticsearchä¸­</p>\n</li>\n<li class=\"lvl-2\">\n<p>FileBeatå’ŒLogstashé…åˆï¼Œå®ç°èƒŒå‹æœºåˆ¶ã€‚å½“å°†æ•°æ®å‘é€åˆ°Logstashæˆ– Elasticsearchæ—¶ï¼ŒFilebeatä½¿ç”¨èƒŒå‹æ•æ„Ÿåè®®ï¼Œä»¥åº”å¯¹æ›´å¤šçš„æ•°æ®é‡ã€‚å¦‚æœLogstashæ­£åœ¨å¿™äºå¤„ç†æ•°æ®ï¼Œåˆ™ä¼šå‘Šè¯‰Filebeat å‡æ…¢è¯»å–é€Ÿåº¦ã€‚ä¸€æ—¦æ‹¥å µå¾—åˆ°è§£å†³ï¼ŒFilebeatå°±ä¼šæ¢å¤åˆ°åŸæ¥çš„æ­¥ä¼å¹¶ç»§ç»­ä¼ è¾“æ•°æ®ã€‚</p>\n</li>\n</ul>\n<h2 id=\"FileBeatä¸‹è½½å’Œå®‰è£…\">FileBeatä¸‹è½½å’Œå®‰è£…</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ä¸‹è½½åœ°å€ï¼š<a href=\"https://www.elastic.co/cn/downloads/past-releases#filebeat\">https://www.elastic.co/cn/downloads/past-releases#filebeat</a></p>\n</li>\n<li class=\"lvl-2\">\n<p>é€‰æ‹©å¯¹åº”çš„ç‰ˆæœ¬ï¼šè¿™é‡Œé€‰æ‹©å½“å‰çš„æœ€æ–°ç‰ˆ<code>FileBeat 8.17.3</code>ï¼Œä¹‹åé€‰æ‹©å¯¹åº”çš„æ“ä½œç³»ç»Ÿ<code>LINUX X86_64</code></p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-8.17.3-linux-x86_64.tar.gz</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ä¸‹è½½å®Œæˆåè§£å‹åˆ°<code>/usr/local/filebeat</code>ç›®å½•ä¸‹ï¼Œè§£å‹å‘½ä»¤å¦‚ä¸‹ï¼š</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">mkdir</span> /usr/local/filebeat</span><br><span class=\"line\">tar -zxvf filebeat-8.17.3-linux-x86_64.tar.gz -C /usr/local/filebeat</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ä¿®æ”¹logstashå®‰è£…ç›®å½•çš„ç”¨æˆ·æƒé™</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">chown</span> -R elastic:elastic /usr/local/filebeat</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åˆ‡æ¢åˆ°elasticç”¨æˆ·ä¸‹æ‰§è¡Œå‘½ä»¤</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># åˆ‡æ¢ç”¨æˆ·</span></span><br><span class=\"line\">su - elastic</span><br><span class=\"line\"><span class=\"comment\"># è¿›å…¥ filebeat å®‰è£…ç›®å½•</span></span><br><span class=\"line\"><span class=\"built_in\">cd</span> /usr/local/filebeat/filebeat-8.17.3-linux-x86_64/</span><br></pre></td></tr></table></figure>\n<h2 id=\"ç»å…¸çš„ELKæ¶æ„\">ç»å…¸çš„ELKæ¶æ„</h2>\n<p><img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/%E6%88%AA%E5%9B%BE.png\" alt=\"\"></p>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Filebeatæ—¥å¿—æ”¶é›†ï¼šFilebeatä½œä¸ºè½»é‡çº§çš„æ—¥å¿—æ”¶é›†ä»£ç†ï¼Œéƒ¨ç½²åœ¨å®¢æˆ·ç«¯ä¸Šï¼Œæ¶ˆè€—èµ„æºå°‘ï¼Œèƒ½å¤Ÿé«˜æ•ˆåœ°æ”¶é›†æ—¥å¿—æ•°æ®ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>Logstashæ•°æ®å¤„ç†ï¼šLogstashä½œä¸ºæ•°æ®å¤„ç†ç®¡é“ï¼Œè´Ÿè´£å°†Filebeatæ”¶é›†çš„æ—¥å¿—æ•°æ®è¿›è¡Œè¿‡æ»¤ã€è½¬æ¢ç­‰æ“ä½œï¼Œç„¶åå‘é€åˆ°Elasticsearchè¿›è¡Œå­˜å‚¨ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>Elasticsearchå­˜å‚¨ä¸æœç´¢ï¼šElasticsearchæ˜¯ä¸€ä¸ªåŸºäºLuceneçš„åˆ†å¸ƒå¼æœç´¢å’Œåˆ†æå¼•æ“ï¼Œæä¾›å¼ºå¤§çš„æ•°æ®å­˜å‚¨å’Œæœç´¢èƒ½åŠ›ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>Kibanaå¯è§†åŒ–ï¼šKibanaä¸ºElasticsearchæä¾›Webå¯è§†åŒ–ç•Œé¢ï¼Œå…è®¸ç”¨æˆ·é€šè¿‡å›¾è¡¨ã€ä»ªè¡¨ç›˜ç­‰æ–¹å¼ç›´è§‚åœ°æŸ¥çœ‹å’Œåˆ†ææ—¥å¿—æ•°æ®ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>é€‚ç”¨åœºæ™¯ï¼šç»å…¸çš„ELKæ¶æ„ä¸»è¦é€‚ç”¨äºæ•°æ®é‡è¾ƒå°çš„å¼€å‘ç¯å¢ƒã€‚ç„¶è€Œï¼Œç”±äºç¼ºå°‘æ¶ˆæ¯é˜Ÿåˆ—çš„ç¼“å†²æœºåˆ¶ï¼Œå½“Logstashæˆ–Elasticsearchå‡ºç°æ•…éšœæ—¶ï¼Œå¯èƒ½å­˜åœ¨æ•°æ®ä¸¢å¤±çš„é£é™©ã€‚</p>\n</li>\n</ul>\n<h2 id=\"ä¸€ä¸ªç»å…¸ELKæ¶æ„ç¤ºä¾‹\">ä¸€ä¸ªç»å…¸ELKæ¶æ„ç¤ºä¾‹</h2>\n<h3 id=\"FileBeaté‡‡é›†NginxæœåŠ¡å™¨æ—¥å¿—å¹¶å‘é€åˆ°Logstash\">FileBeaté‡‡é›†NginxæœåŠ¡å™¨æ—¥å¿—å¹¶å‘é€åˆ°Logstash</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åˆ›å»ºé…ç½®æ–‡ä»¶<code>filebeat-nginx.yml</code>ï¼Œå°†å…¶ä¿å­˜åˆ°Filebeatå®‰è£…ç›®å½•ä¸‹çš„confç›®å½•ä¸‹ã€‚</p>\n</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># å› ä¸ºNginxçš„access.logæ—¥å¿—éƒ½æ˜¯ä»¥IPåœ°å€å¼€å¤´çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¿®æ”¹ä¸‹åŒ¹é…å­—æ®µã€‚</span></span><br><span class=\"line\"><span class=\"comment\"># ä¸ä»¥ipåœ°å€å¼€å¤´çš„è¡Œè¿½åŠ åˆ°ä¸Šä¸€è¡Œ</span></span><br><span class=\"line\"><span class=\"attr\">filebeat.inputs:</span> <span class=\"comment\"># è¾“å…¥æºé…ç½®</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">type:</span> <span class=\"string\">log</span> <span class=\"comment\"># æ—¥å¿—ç±»å‹</span></span><br><span class=\"line\">  <span class=\"attr\">enabled:</span> <span class=\"literal\">true</span> <span class=\"comment\"># æ˜¯å¦å¯ç”¨</span></span><br><span class=\"line\">  <span class=\"attr\">paths:</span> <span class=\"comment\"># é‡‡é›†è·¯å¾„</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">/var/log/nginx/access*.*</span></span><br><span class=\"line\">  <span class=\"attr\">exclude_files:</span> [<span class=\"string\">&quot;.gz$&quot;</span>] <span class=\"comment\"># æ’é™¤ä»¥.gz ç»“å°¾çš„æ–‡ä»¶</span></span><br><span class=\"line\">  <span class=\"attr\">multiline.pattern:</span> <span class=\"string\">&#x27;^\\\\d&#123;1,3&#125;\\\\.\\\\d&#123;1,3&#125;\\\\.\\\\d&#123;1,3&#125;\\\\.\\\\d&#123;1,3&#125;\\\\s&#x27;</span> <span class=\"comment\"># åŒ¹é…ä»¥IPåœ°å€å¼€å¤´ï¼Œå¹¶ç´§è·Ÿä¸€ä¸ªç©ºç™½å­—ç¬¦</span></span><br><span class=\"line\">  <span class=\"attr\">multiline.negate:</span> <span class=\"literal\">true</span> <span class=\"comment\"># ä¸ä»¥ipåœ°å€å¼€å¤´çš„è¡Œè¿½åŠ åˆ°ä¸Šä¸€è¡Œ</span></span><br><span class=\"line\">  <span class=\"attr\">multiline.match:</span> <span class=\"string\">after</span> <span class=\"comment\"># è¿½åŠ åˆ°ä¸Šä¸€è¡Œçš„åé¢</span></span><br><span class=\"line\">  <span class=\"comment\"># multiline: å¤šè¡Œæ—¥å¿—é…ç½®ï¼Œè¿™é‡Œå®é™…ä¸Šä¸éœ€è¦é…ç½®å¤šè¡Œè®¾ç½®ï¼Œå› ä¸ºnginxçš„accessæ—¥å¿—éƒ½æ˜¯å•è¡Œæ—¥å¿—ï¼Œè¿™é‡Œåªåšæ¼”ç¤º</span></span><br><span class=\"line\">    <span class=\"comment\"># pattern: æ­£åˆ™è¡¨è¾¾å¼</span></span><br><span class=\"line\">    <span class=\"comment\"># negate: falseï¼ŒåŒ¹é…patternçš„è¡Œåˆå¹¶åˆ°ä¸Šä¸€è¡Œï¼›trueï¼Œä¸åŒ¹é…patternçš„è¡Œåˆå¹¶åˆ°ä¸Šä¸€è¡Œ</span></span><br><span class=\"line\">    <span class=\"comment\"># match: afterï¼Œåˆå¹¶åˆ°ä¸Šä¸€è¡Œçš„æœ«å°¾ï¼›beforeï¼Œåˆå¹¶åˆ°ä¸Šä¸€è¡Œçš„å¼€å¤´</span></span><br><span class=\"line\">  <span class=\"attr\">scan_frequency:</span> <span class=\"string\">10s</span> <span class=\"comment\"># æ¯ 10 ç§’æ‰«æä¸€æ¬¡æ—¥å¿—æ–‡ä»¶</span></span><br><span class=\"line\">  <span class=\"attr\">clean_removed:</span> <span class=\"literal\">true</span> <span class=\"comment\"># åœ¨æ—¥å¿—æ–‡ä»¶è¢«åˆ é™¤åæ˜¯å¦ä»å…¶å†…éƒ¨çŠ¶æ€ä¸­ç§»é™¤è¯¥æ–‡ä»¶çš„è®°å½•</span></span><br><span class=\"line\">  <span class=\"attr\">clean_inactive:</span> <span class=\"string\">2h</span> <span class=\"comment\"># åœ¨æ—¥å¿—æ–‡ä»¶å¤„äºéæ´»åŠ¨çŠ¶æ€å¤šé•¿æ—¶é—´åå°†å…¶ä»çŠ¶æ€æ•°æ®åº“ä¸­ç§»,è®¾ç½®ä¸ºæ¯” ignore_older + scan_frequency æ›´å¤§çš„å€¼</span></span><br><span class=\"line\">  <span class=\"attr\">ignore_older:</span> <span class=\"string\">1h</span> <span class=\"comment\"># å¿½ç•¥é‚£äº›æ¯”å½“å‰æ—¶é—´æ—©äº 1 å°æ—¶çš„æ—¥å¿—æ–‡ä»¶</span></span><br><span class=\"line\"><span class=\"attr\">output.logstash:</span> <span class=\"comment\"># è¾“å‡ºé…ç½®ï¼Œè¿™é‡Œæ˜¯å‘é€åˆ°Logstash</span></span><br><span class=\"line\">  <span class=\"attr\">enabled:</span> <span class=\"literal\">true</span> <span class=\"comment\"># æ˜¯å¦å¯ç”¨</span></span><br><span class=\"line\">  <span class=\"attr\">hosts:</span> [<span class=\"string\">&quot;10.250.0.239:5044&quot;</span>] <span class=\"comment\"># LogstashæœåŠ¡åœ°å€</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ä¸ºFileBeatçš„ç”¨æˆ·åˆ†é…æ—¥å¿—ç›®å½•çš„è¯»å–æƒé™</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨ setfaclå‘½ä»¤ä¸ºelasticç”¨æˆ·åˆ†é…æ—¥å¿—ç›®å½•çš„è¯»å–æƒé™</span></span><br><span class=\"line\"><span class=\"built_in\">sudo</span> setfacl -d -m u:elastic:r-x -R /var/log/nginx/</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å¯åŠ¨FileBeat</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./filebeat -e -c conf/filebeat-nginx.yml</span><br><span class=\"line\"><span class=\"comment\"># åå°å¯åŠ¨</span></span><br><span class=\"line\"><span class=\"built_in\">nohup</span> ./filebeat -e -c conf/filebeat-nginx.yml &amp;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åœ¨å¯åŠ¨filebeatæ—¶å¯èƒ½ä¼šé‡åˆ°å¦‚ä¸‹é”™è¯¯</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Exiting: error loading config file: config file (<span class=\"string\">&quot;conf/filebeat-nginx.yml&quot;</span>) can only be writable by the owner but the permissions are <span class=\"string\">&quot;-rw-rw-r--&quot;</span> (to fix the permissions use: <span class=\"string\">&#x27;chmod go-w /usr/local/filebeat/filebeat-8.17.3-linux-x86_64/conf/filebeat-nginx.yml&#x27;</span>)</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-4\">\n<p>å› ä¸ºå®‰å…¨åŸå› ä¸è¦å…¶ä»–ç”¨æˆ·å†™çš„æƒé™ï¼Œå»æ‰å†™çš„æƒé™å°±å¯ä»¥äº†</p>\n</li>\n</ul>\n  <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">chmod</span> go-w conf/filebeat-nginx.yml</span><br></pre></td></tr></table></figure>\n<h3 id=\"é…ç½®Logstashæ¥æ”¶FileBeatæ”¶é›†çš„æ•°æ®å¹¶æ‰“å°\">é…ç½®Logstashæ¥æ”¶FileBeatæ”¶é›†çš„æ•°æ®å¹¶æ‰“å°</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åˆ›å»ºé…ç½®æ–‡ä»¶<code>logstash-nginx.conf</code>ï¼Œå°†å…¶ä¿å­˜åˆ°Logstashå®‰è£…ç›®å½•ä¸‹çš„configç›®å½•ä¸‹ã€‚</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># è¿›å…¥logstashå®‰è£…ç›®å½•</span></span><br><span class=\"line\"><span class=\"comment\"># vim config/logstash-nginx.conf</span></span><br><span class=\"line\"><span class=\"comment\"># é…ç½®ä»FileBeatæ¥æ”¶æ•°æ®</span></span><br><span class=\"line\">input &#123; <span class=\"comment\"># è¾“å…¥æºé…ç½®</span></span><br><span class=\"line\">    beats &#123; <span class=\"comment\"># ä»FileBeatæ¥æ”¶æ•°æ®</span></span><br><span class=\"line\">      port =&gt; 5044 <span class=\"comment\"># ç›‘å¬5044ç«¯å£</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">output &#123; <span class=\"comment\"># è¾“å‡ºé…ç½®</span></span><br><span class=\"line\">    stdout &#123; <span class=\"comment\"># æ‰“å°åˆ°æ§åˆ¶å°</span></span><br><span class=\"line\">      codec =&gt; rubydebug <span class=\"comment\"># æŒ‡å®šç¼–ç å™¨</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æµ‹è¯•logstashé…ç½®æ˜¯å¦æ­£ç¡®</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bin/logstash -f config/logstash-nginx.conf --config.test_and_exit</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å¯åŠ¨logstash</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># reload.automaticï¼šä¿®æ”¹é…ç½®æ–‡ä»¶æ—¶è‡ªåŠ¨é‡æ–°åŠ è½½</span></span><br><span class=\"line\">bin/logstash -f config/logstash-nginx.conf --config.reload.automatic</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æ­¤æ—¶åœ¨æ§åˆ¶å°ä¼šçœ‹åˆ°å¦‚ä¸‹è¾“å‡ºï¼š</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">         <span class=\"string\">&quot;input&quot;</span> =&gt; &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;type&quot;</span> =&gt; <span class=\"string\">&quot;log&quot;</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">      <span class=\"string\">&quot;@version&quot;</span> =&gt; <span class=\"string\">&quot;1&quot;</span>,</span><br><span class=\"line\">       <span class=\"string\">&quot;message&quot;</span> =&gt; <span class=\"string\">&quot;1.119.161.30 - elastic [27/Mar/2025:08:52:41 +0000] \\&quot;GET /_cluster/stats HTTP/1.1\\&quot; 200 7445 \\&quot;-\\&quot; \\&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/134.0.0.0 Safari/537.36\\&quot; \\&quot;-\\&quot;&quot;</span>,</span><br><span class=\"line\">           <span class=\"string\">&quot;log&quot;</span> =&gt; &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;file&quot;</span> =&gt; &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;path&quot;</span> =&gt; <span class=\"string\">&quot;/var/log/nginx/access.log&quot;</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;offset&quot;</span> =&gt; 42985</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">          <span class=\"string\">&quot;tags&quot;</span> =&gt; [</span><br><span class=\"line\">        [0] <span class=\"string\">&quot;beats_input_codec_plain_applied&quot;</span></span><br><span class=\"line\">    ],</span><br><span class=\"line\">    <span class=\"string\">&quot;@timestamp&quot;</span> =&gt; 2025-03-27T08:52:42.947Z,</span><br><span class=\"line\">           <span class=\"string\">&quot;ecs&quot;</span> =&gt; &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;version&quot;</span> =&gt; <span class=\"string\">&quot;8.0.0&quot;</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">         <span class=\"string\">&quot;agent&quot;</span> =&gt; &#123;</span><br><span class=\"line\">                  <span class=\"string\">&quot;id&quot;</span> =&gt; <span class=\"string\">&quot;4dbe185b-900d-4990-b841-c13bf9618fc6&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;name&quot;</span> =&gt; <span class=\"string\">&quot;ip-10-250-0-239.cn-northwest-1.compute.internal&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;ephemeral_id&quot;</span> =&gt; <span class=\"string\">&quot;6bb04808-7da7-4acb-95fd-f3f915651457&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;type&quot;</span> =&gt; <span class=\"string\">&quot;filebeat&quot;</span>,</span><br><span class=\"line\">             <span class=\"string\">&quot;version&quot;</span> =&gt; <span class=\"string\">&quot;8.17.3&quot;</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">         <span class=\"string\">&quot;event&quot;</span> =&gt; &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;original&quot;</span> =&gt; <span class=\"string\">&quot;1.119.161.30 - elastic [27/Mar/2025:08:52:41 +0000] \\&quot;GET /_cluster/stats HTTP/1.1\\&quot; 200 7445 \\&quot;-\\&quot; \\&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/134.0.0.0 Safari/537.36\\&quot; \\&quot;-\\&quot;&quot;</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">          <span class=\"string\">&quot;host&quot;</span> =&gt; &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;name&quot;</span> =&gt; <span class=\"string\">&quot;ip-10-250-0-239.cn-northwest-1.compute.internal&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"åˆ©ç”¨Logstashè¿‡æ»¤å™¨è§£ææ—¥å¿—\">åˆ©ç”¨Logstashè¿‡æ»¤å™¨è§£ææ—¥å¿—</h4>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ä»æ‰“å°ç»“æœçœ‹åˆ°åŒ…å«äº†å¤§é‡çš„æ— å…³æ•°æ®ï¼Œæ­¤æ—¶å¯ä»¥åˆ©ç”¨Logstashè¿‡æ»¤å™¨è§£ææ—¥å¿—ï¼Œè¿™é‡Œä½¿ç”¨<code>Grok</code>æ’ä»¶</p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://www.elastic.co/guide/en/logstash/8.17/plugins-filters-grok.html\">Grok</a>æ˜¯ä¸€ç§å°†éç»“æ„åŒ–æ—¥å¿—è§£æä¸ºç»“æ„åŒ–çš„æ’ä»¶ã€‚è¿™ä¸ªå·¥å…·éå¸¸é€‚åˆç”¨æ¥è§£æç³»ç»Ÿæ—¥å¿—ã€WebæœåŠ¡å™¨æ—¥å¿—ã€MySQLæˆ–è€…æ˜¯ä»»æ„å…¶ä»–çš„æ—¥å¿—æ ¼å¼ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>Grokæ˜¯é€šè¿‡æ¨¡å¼åŒ¹é…çš„æ–¹å¼æ¥è¯†åˆ«æ—¥å¿—ä¸­çš„æ•°æ®,å¯ä»¥æŠŠGrokæ’ä»¶ç®€å•ç†è§£ä¸ºå‡çº§ç‰ˆæœ¬çš„æ­£åˆ™è¡¨è¾¾å¼ã€‚å®ƒæ‹¥æœ‰æ›´å¤šçš„æ¨¡å¼ï¼Œé»˜è®¤Logstashæ‹¥æœ‰120ä¸ªæ¨¡å¼ã€‚å¦‚æœè¿™äº›æ¨¡å¼ä¸æ»¡è¶³æˆ‘ä»¬è§£ææ—¥å¿—çš„éœ€æ±‚ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æ¥è¿›è¡ŒåŒ¹é…ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://help.aliyun.com/zh/sls/user-guide/grok-patterns\">GROKæ¨¡å¼å‚è€ƒ</a></p>\n</li>\n<li class=\"lvl-2\">\n<p>grokæ¨¡å¼çš„è¯­æ³•æ˜¯:</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">%&#123;SYNTAX:SEMANTIC&#125;</span><br><span class=\"line\"><span class=\"comment\"># SYNTAXï¼ˆè¯­æ³•ï¼‰æŒ‡çš„æ˜¯Grokæ¨¡å¼åç§°ï¼ŒSEMANTICï¼ˆè¯­ä¹‰ï¼‰æ˜¯ç»™æ¨¡å¼åŒ¹é…åˆ°çš„æ–‡æœ¬å­—æ®µåã€‚ä¾‹å¦‚ï¼š</span></span><br><span class=\"line\">%&#123;NUMBER:duration&#125; %&#123;IP:client&#125;</span><br><span class=\"line\"><span class=\"comment\"># durationè¡¨ç¤ºï¼šåŒ¹é…ä¸€ä¸ªæ•°å­—ï¼Œclientè¡¨ç¤ºåŒ¹é…ä¸€ä¸ªIPåœ°å€ã€‚</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åŒ¹é…nginxæ—¥å¿—</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># nginx accessæ—¥å¿—æ ¼å¼</span></span><br><span class=\"line\">1.119.161.30 - elastic [27/Mar/2025:03:05:36 +0000] <span class=\"string\">&quot;GET /_cluster/stats HTTP/1.1&quot;</span> 200 7446 <span class=\"string\">&quot;-&quot;</span> <span class=\"string\">&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/134.0.0.0 Safari/537.36&quot;</span> <span class=\"string\">&quot;-&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># grok</span></span><br><span class=\"line\">%&#123;IP:client_ip&#125; - %&#123;USER:remote_user&#125; \\[%&#123;HTTPDATE:timestamp&#125;\\] \\&quot;%&#123;WORD:verb&#125; %&#123;URIPATHPARAM:request&#125; HTTP/%&#123;NUMBER:httpversion&#125;\\&quot; %&#123;INT:http_status&#125; %&#123;INT:body_bytes_sent&#125; \\&quot;%&#123;NOTSPACE:referrer&#125;\\&quot; \\&quot;%&#123;GREEDYDATA:agent&#125;\\&quot; %&#123;QUOTEDSTRING:x_forwarded_for&#125;</span><br><span class=\"line\"><span class=\"comment\"># è§£é‡Šæ¯ä¸ªéƒ¨åˆ†çš„ä½œç”¨ï¼š</span></span><br><span class=\"line\"><span class=\"comment\"># %&#123;IP:client_ip&#125;ï¼šåŒ¹é…å®¢æˆ·ç«¯ IP åœ°å€ã€‚</span></span><br><span class=\"line\"><span class=\"comment\"># -ï¼šåŒ¹é…ä¸€ä¸ªç ´æŠ˜å·ï¼ˆ-ï¼‰ï¼Œè¡¨ç¤ºåŒ¿åç”¨æˆ·æˆ–æœªè®¤è¯ç”¨æˆ·ã€‚</span></span><br><span class=\"line\"><span class=\"comment\"># %&#123;USER:remote_user&#125;ï¼šåŒ¹é…è¿œç¨‹ç”¨æˆ·åï¼Œ - è¡¨ç¤ºåŒ¿åç”¨æˆ·ã€‚</span></span><br><span class=\"line\"><span class=\"comment\"># \\[%&#123;HTTPDATE:timestamp&#125;\\]ï¼šåŒ¹é…è¯·æ±‚çš„æ—¶é—´æˆ³ï¼Œæ ¼å¼ä¸º [27/Mar/2025:03:05:36 +0000]ã€‚</span></span><br><span class=\"line\"><span class=\"comment\"># \\&quot;%&#123;WORD:verb&#125; : åŒ¹é…è¯·æ±‚æ–¹æ³• (GET)</span></span><br><span class=\"line\"><span class=\"comment\"># %&#123;URIPATHPARAM:request&#125; : åŒ¹é…è¯·æ±‚è·¯å¾„ (/_cluster/stats)</span></span><br><span class=\"line\"><span class=\"comment\"># HTTP/%&#123;NUMBER:httpversion&#125;\\\\\\&quot;ï¼šåŒ¹é… HTTP ç‰ˆæœ¬ (HTTP/1.1)ã€‚</span></span><br><span class=\"line\"><span class=\"comment\"># %&#123;INT:http_status&#125;ï¼šåŒ¹é… HTTP å“åº”çŠ¶æ€ç  (200)ã€‚</span></span><br><span class=\"line\"><span class=\"comment\"># %&#123;INT:body_bytes_sent&#125;ï¼šåŒ¹é…å“åº”ä½“çš„å­—èŠ‚æ•° (7446)ã€‚</span></span><br><span class=\"line\"><span class=\"comment\"># \\&quot;%&#123;NOTSPACE:referrer&#125;\\&quot;ï¼šåŒ¹é…å¼•ç”¨é¡µ (Referer) å­—æ®µï¼Œè¿™é‡Œä¸ºç©º (&quot;-&quot;)ã€‚</span></span><br><span class=\"line\"><span class=\"comment\"># \\&quot;%&#123;GREEDYDATA:agent&#125;\\&quot;ï¼šåŒ¹é…ç”¨æˆ·ä»£ç† (User-Agent) å­—æ®µã€‚GREEDYDATA ä¼šåŒ¹é…å°½å¯èƒ½å¤šçš„æ•°æ®ï¼Œç›´åˆ°é‡åˆ°ä¸‹ä¸€ä¸ªåˆ†éš”ç¬¦ã€‚</span></span><br><span class=\"line\"><span class=\"comment\"># %&#123;QUOTEDSTRING:x_forwarded_for&#125;ï¼šåŒ¹é… X-Forwarded-For å¤´å­—æ®µï¼Œè¿™é‡Œä¸ºç©º (&quot;-&quot;)ã€‚</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># åŒ¹é…ç»“æœ</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;request&quot;</span>: <span class=\"string\">&quot;/_cluster/stats&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;agent&quot;</span>: <span class=\"string\">&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/134.0.0.0 Safari/537.36&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;body_bytes_sent&quot;</span>: <span class=\"string\">&quot;7446&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;verb&quot;</span>: <span class=\"string\">&quot;GET&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;x_forwarded_for&quot;</span>: <span class=\"string\">&quot;\\&quot;-\\&quot;&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;remote_user&quot;</span>: <span class=\"string\">&quot;elastic&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;referrer&quot;</span>: <span class=\"string\">&quot;-&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;client_ip&quot;</span>: <span class=\"string\">&quot;1.119.161.30&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;httpversion&quot;</span>: <span class=\"string\">&quot;1.1&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;http_status&quot;</span>: <span class=\"string\">&quot;200&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;timestamp&quot;</span>: <span class=\"string\">&quot;27/Mar/2025:03:05:36 +0000&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åŒ¹é…Grokæ¨¡å¼æ˜¯ä¸ªéå¸¸ç¹ççš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨Kibanaæ¥è¿›è¡Œå¯è§†åŒ–çš„Grokè°ƒè¯•<br>\n<img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/nhgnKY.png\" alt=\"\"></p>\n</li>\n<li class=\"lvl-2\">\n<p>groké…ç½®</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">grok &#123;</span><br><span class=\"line\">    match =&gt; &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;message&quot;</span> =&gt; <span class=\"string\">&quot;%&#123;IP:client_ip&#125; - %&#123;USER:remote_user&#125; \\[%&#123;HTTPDATE:timestamp&#125;\\] \\&quot;%&#123;WORD:verb&#125; %&#123;URIPATHPARAM:request&#125; HTTP/%&#123;NUMBER:httpversion&#125;\\&quot; %&#123;INT:http_status&#125; %&#123;INT:body_bytes_sent&#125; \\&quot;%&#123;NOTSPACE:referrer&#125;\\&quot; \\&quot;%&#123;GREEDYDATA:agent&#125;\\&quot; %&#123;QUOTEDSTRING:x_forwarded_for&#125;&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"ä½¿ç”¨mutateæ’ä»¶è¿‡æ»¤æ‰ä¸éœ€è¦çš„å­—æ®µ\">ä½¿ç”¨mutateæ’ä»¶è¿‡æ»¤æ‰ä¸éœ€è¦çš„å­—æ®µ</h4>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>é™¤äº†nginxæ—¥å¿—æœ¬èº«çš„æ ¼å¼å¤–ï¼Œlogstashè¿˜ä¼šæ‰“å°è®¸å¤šæˆ‘ä»¬ä¸éœ€è¦çš„å­—æ®µï¼Œæ­¤æ—¶å¯ä»¥ä½¿ç”¨<code>mutate</code>æ’ä»¶æ¥è¿‡æ»¤æ‰ä¸éœ€è¦çš„å­—æ®µã€‚</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mutate &#123;</span><br><span class=\"line\">    enable_metric =&gt; <span class=\"string\">&quot;false&quot;</span> <span class=\"comment\"># ç¦ç”¨æŒ‡æ ‡ä¸ŠæŠ¥</span></span><br><span class=\"line\">    remove_field =&gt; [<span class=\"string\">&quot;message&quot;</span>, <span class=\"string\">&quot;log&quot;</span>, <span class=\"string\">&quot;tags&quot;</span>, <span class=\"string\">&quot;input&quot;</span>, <span class=\"string\">&quot;agent&quot;</span>, <span class=\"string\">&quot;host&quot;</span>, <span class=\"string\">&quot;ecs&quot;</span>, <span class=\"string\">&quot;@version&quot;</span>] <span class=\"comment\"># ç§»é™¤ä¸éœ€è¦çš„å­—æ®µ</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"ä½¿ç”¨Dateæ’ä»¶å¯¹æ—¶é—´è¿›è¡Œæ ¼å¼è½¬æ¢\">ä½¿ç”¨Dateæ’ä»¶å¯¹æ—¶é—´è¿›è¡Œæ ¼å¼è½¬æ¢</h4>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">date</span> &#123;</span><br><span class=\"line\">    match =&gt; [<span class=\"string\">&quot;timestamp&quot;</span>,<span class=\"string\">&quot;dd/MMM/yyyy:HH:mm:ss Z&quot;</span>,<span class=\"string\">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>] <span class=\"comment\"># æ—¶é—´æ ¼å¼è½¬æ¢</span></span><br><span class=\"line\">    target =&gt; <span class=\"string\">&quot;timestamp&quot;</span> <span class=\"comment\"># ç›®æ ‡å­—æ®µ</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"å®Œæ•´çš„Logstashé…ç½®\">å®Œæ•´çš„Logstashé…ç½®</h4>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># è¿›å…¥logstashå®‰è£…ç›®å½•</span></span><br><span class=\"line\"><span class=\"comment\"># vim config/logstsh-nginx.conf</span></span><br><span class=\"line\"><span class=\"comment\"># é…ç½®ä»FileBeatæ¥æ”¶æ•°æ®</span></span><br><span class=\"line\">input &#123; <span class=\"comment\"># è¾“å…¥æºé…ç½®</span></span><br><span class=\"line\">    beats &#123; <span class=\"comment\"># ä»FileBeatæ¥æ”¶æ•°æ®</span></span><br><span class=\"line\">      port =&gt; 5044 <span class=\"comment\"># ç›‘å¬5044ç«¯å£</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">filter &#123; <span class=\"comment\"># è¿‡æ»¤å™¨é…ç½®</span></span><br><span class=\"line\">    grok &#123;</span><br><span class=\"line\">        match =&gt; &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;message&quot;</span> =&gt; <span class=\"string\">&quot;%&#123;IP:client_ip&#125; - %&#123;USER:remote_user&#125; \\[%&#123;HTTPDATE:timestamp&#125;\\] \\&quot;%&#123;WORD:verb&#125; %&#123;URIPATHPARAM:request&#125; HTTP/%&#123;NUMBER:httpversion&#125;\\&quot; %&#123;INT:http_status&#125; %&#123;INT:body_bytes_sent&#125; \\&quot;%&#123;NOTSPACE:referrer&#125;\\&quot; \\&quot;%&#123;GREEDYDATA:agent&#125;\\&quot; %&#123;QUOTEDSTRING:x_forwarded_for&#125;&quot;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    mutate &#123;</span><br><span class=\"line\">        enable_metric =&gt; <span class=\"string\">&quot;false&quot;</span> <span class=\"comment\"># ç¦ç”¨æŒ‡æ ‡ä¸ŠæŠ¥</span></span><br><span class=\"line\">        remove_field =&gt; [<span class=\"string\">&quot;message&quot;</span>, <span class=\"string\">&quot;log&quot;</span>, <span class=\"string\">&quot;tags&quot;</span>, <span class=\"string\">&quot;input&quot;</span>, <span class=\"string\">&quot;agent&quot;</span>, <span class=\"string\">&quot;host&quot;</span>, <span class=\"string\">&quot;ecs&quot;</span>, <span class=\"string\">&quot;@version&quot;</span>] <span class=\"comment\"># ç§»é™¤ä¸éœ€è¦çš„å­—æ®µ</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">date</span> &#123;</span><br><span class=\"line\">        match =&gt; [<span class=\"string\">&quot;timestamp&quot;</span>,<span class=\"string\">&quot;dd/MMM/yyyy:HH:mm:ss Z&quot;</span>,<span class=\"string\">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>] <span class=\"comment\"># æ—¶é—´æ ¼å¼è½¬æ¢</span></span><br><span class=\"line\">        target =&gt; <span class=\"string\">&quot;timestamp&quot;</span> <span class=\"comment\"># ç›®æ ‡å­—æ®µ</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">output &#123; <span class=\"comment\"># è¾“å‡ºé…ç½®</span></span><br><span class=\"line\">    stdout &#123; <span class=\"comment\"># æ‰“å°åˆ°æ§åˆ¶å°</span></span><br><span class=\"line\">      codec =&gt; rubydebug <span class=\"comment\"># æŒ‡å®šç¼–ç å™¨</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>é‡æ–°å¯åŠ¨logstashåå¾—åˆ°å¦‚ä¸‹ç»“æœï¼š</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">              <span class=\"string\">&quot;event&quot;</span> =&gt; &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;original&quot;</span> =&gt; <span class=\"string\">&quot;1.119.161.30 - elastic [27/Mar/2025:09:49:41 +0000] \\&quot;GET /_cluster/stats HTTP/1.1\\&quot; 200 7445 \\&quot;-\\&quot; \\&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/134.0.0.0 Safari/537.36\\&quot; \\&quot;-\\&quot;&quot;</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">          <span class=\"string\">&quot;client_ip&quot;</span> =&gt; <span class=\"string\">&quot;1.119.161.30&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;request&quot;</span> =&gt; <span class=\"string\">&quot;/_cluster/stats&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;http_status&quot;</span> =&gt; <span class=\"string\">&quot;200&quot;</span>,</span><br><span class=\"line\">         <span class=\"string\">&quot;@timestamp&quot;</span> =&gt; 2025-03-27T09:49:45.751Z,</span><br><span class=\"line\">    <span class=\"string\">&quot;body_bytes_sent&quot;</span> =&gt; <span class=\"string\">&quot;7445&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;x_forwarded_for&quot;</span> =&gt; <span class=\"string\">&quot;\\&quot;-\\&quot;&quot;</span>,</span><br><span class=\"line\">          <span class=\"string\">&quot;timestamp&quot;</span> =&gt; 2025-03-27T09:49:41.000Z,</span><br><span class=\"line\">           <span class=\"string\">&quot;referrer&quot;</span> =&gt; <span class=\"string\">&quot;-&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;remote_user&quot;</span> =&gt; <span class=\"string\">&quot;elastic&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;httpversion&quot;</span> =&gt; <span class=\"string\">&quot;1.1&quot;</span>,</span><br><span class=\"line\">               <span class=\"string\">&quot;verb&quot;</span> =&gt; <span class=\"string\">&quot;GET&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"å°†ç»“æœè¾“å‡ºåˆ°ES\">å°†ç»“æœè¾“å‡ºåˆ°ES</h4>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># åœ¨è¾“å‡ºé…ç½®ä¸­æ·»åŠ ESè¾“å‡ºé…ç½®</span></span><br><span class=\"line\">output &#123; <span class=\"comment\"># è¾“å‡ºé…ç½®</span></span><br><span class=\"line\">    stdout &#123; <span class=\"comment\"># æ‰“å°åˆ°æ§åˆ¶å°</span></span><br><span class=\"line\">      codec =&gt; rubydebug <span class=\"comment\"># æŒ‡å®šç¼–ç å™¨</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    elasticsearch &#123; <span class=\"comment\"># è¾“å‡ºåˆ°ES</span></span><br><span class=\"line\">        index =&gt; <span class=\"string\">&quot;nginx_access_log_%&#123;+YYYY-MM&#125;&quot;</span> <span class=\"comment\"># ç´¢å¼•å,æŒ‰æœˆåˆ†éš”</span></span><br><span class=\"line\">        hosts =&gt; [<span class=\"string\">&quot;https://10.250.0.239:9200&quot;</span>] <span class=\"comment\"># ESåœ°å€</span></span><br><span class=\"line\">        user =&gt; <span class=\"string\">&quot;elastic&quot;</span>                   <span class=\"comment\"># ESç”¨æˆ·å</span></span><br><span class=\"line\">        password =&gt; <span class=\"string\">&quot;123456&quot;</span>                <span class=\"comment\"># ESå¯†ç </span></span><br><span class=\"line\">        ssl =&gt; <span class=\"literal\">true</span>                         <span class=\"comment\"># æ˜¯å¦å¯ç”¨SSLï¼Œå› ä¸ºè¿™é‡Œæ˜¯httpsè®¿é—®ES</span></span><br><span class=\"line\">        ssl_certificate_verification =&gt; <span class=\"literal\">false</span> <span class=\"comment\"># ç¦ç”¨è¯ä¹¦éªŒè¯</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å¦‚æœéœ€è¦å¼€å¯è¯ä¹¦æ ¡éªŒï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹æ³•è¿›è¡Œé…ç½®</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">è·å– Elasticsearch çš„ SSL è¯ä¹¦ï¼š</li>\n</ul>\n  <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ä» Elasticsearch çš„é…ç½®æ–‡ä»¶æˆ–è¯ä¹¦æ–‡ä»¶è·¯å¾„ä¸­è·å–è¯ä¹¦ï¼ˆé€šå¸¸æ˜¯ .pem æˆ– .crt æ–‡ä»¶ï¼‰ã€‚</span></span><br><span class=\"line\">/usr/local/elasticsearch/elasticsearch-8.17.3/config/certs/http_ca.crt</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">å¯¼å…¥è¯ä¹¦åˆ° Java ä¿¡ä»»åº“ï¼šæ³¨æ„è¿™é‡Œè¦å¯¼å…¥åˆ°å¯åŠ¨Logstashçš„JAVAè¿›ç¨‹çš„ä¿¡ä»»åº“</li>\n</ul>\n  <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># logstashçš„jdkè·¯å¾„ï¼Œé»˜è®¤åœ¨logstashçš„å®‰è£…ç›®å½•ä¸‹</span></span><br><span class=\"line\"><span class=\"built_in\">cd</span> /usr/local/logstash/logstash-8.17.3/jdk</span><br><span class=\"line\"></span><br><span class=\"line\">bin/keytool -importcert -<span class=\"built_in\">alias</span> es-cert -keystore /usr/local/logstash/logstash-8.17.3/logstash.keystore -file /usr/local/elasticsearch/elasticsearch-8.17.3/config/certs/http_ca.crt</span><br><span class=\"line\"><span class=\"comment\"># è¾“å‡º</span></span><br><span class=\"line\">Enter keystore password:  <span class=\"comment\"># è¾“å…¥å¯†ç  è¿™é‡Œæ˜¯123456</span></span><br><span class=\"line\">Re-enter new password:</span><br><span class=\"line\">Owner: CN=Elasticsearch security auto-configuration HTTP CA</span><br><span class=\"line\">Issuer: CN=Elasticsearch security auto-configuration HTTP CA</span><br><span class=\"line\">Serial number: 89d5c501a2efd5d45a6ee5e08daa16bd605d8c28</span><br><span class=\"line\">Valid from: Thu Mar 20 08:53:26 UTC 2025 <span class=\"keyword\">until</span>: Sun Mar 19 08:53:26 UTC 2028</span><br><span class=\"line\">Certificate fingerprints:</span><br><span class=\"line\">    SHA1: DE:73:0C:EC:46:59:69:83:52:7C:C4:CC:6B:65:EC:B6:31:BE:10:22</span><br><span class=\"line\">    SHA256: 3F:14:1C:16:DF:C6:E1:65:89:4B:C1:67:20:84:B2:20:DC:DD:22:FF:E0:21:16:D5:1A:C1:80:03:CF:AA:5A:1D</span><br><span class=\"line\">Signature algorithm name: SHA256withRSA</span><br><span class=\"line\">Subject Public Key Algorithm: 4096-bit RSA key</span><br><span class=\"line\">Version: 3</span><br><span class=\"line\"></span><br><span class=\"line\">Extensions:</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#1: ObjectId: 2.5.29.35 Criticality=false</span></span><br><span class=\"line\">AuthorityKeyIdentifier [</span><br><span class=\"line\">KeyIdentifier [</span><br><span class=\"line\">0000: 25 EF BA 81 AE 5E 14 1C   7E FF A1 87 12 F8 D0 2E  %....^..........</span><br><span class=\"line\">0010: 3A D7 54 5F                                        :.T_</span><br><span class=\"line\">]</span><br><span class=\"line\">]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#2: ObjectId: 2.5.29.19 Criticality=true</span></span><br><span class=\"line\">BasicConstraints:[</span><br><span class=\"line\">CA:<span class=\"literal\">true</span></span><br><span class=\"line\">PathLen: no <span class=\"built_in\">limit</span></span><br><span class=\"line\">]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#3: ObjectId: 2.5.29.14 Criticality=false</span></span><br><span class=\"line\">SubjectKeyIdentifier [</span><br><span class=\"line\">KeyIdentifier [</span><br><span class=\"line\">0000: 25 EF BA 81 AE 5E 14 1C   7E FF A1 87 12 F8 D0 2E  %....^..........</span><br><span class=\"line\">0010: 3A D7 54 5F                                        :.T_</span><br><span class=\"line\">]</span><br><span class=\"line\">]</span><br><span class=\"line\"></span><br><span class=\"line\">Trust this certificate? [no]:  <span class=\"built_in\">yes</span> <span class=\"comment\"># yesç¡®è®¤</span></span><br><span class=\"line\">Certificate was added to keystore</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">\n<p>é…ç½® Logstash ä½¿ç”¨ä¿¡ä»»åº“</p>\n</li>\n</ul>\n  <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">output &#123;</span><br><span class=\"line\">    elasticsearch &#123;</span><br><span class=\"line\">        index =&gt; <span class=\"string\">&quot;nginx_access_log_%&#123;+YYYY-MM&#125;&quot;</span> <span class=\"comment\"># ç´¢å¼•å,æŒ‰æœˆåˆ†éš”</span></span><br><span class=\"line\">        hosts =&gt; [<span class=\"string\">&quot;https://10.250.0.239:9200&quot;</span>] <span class=\"comment\"># ESåœ°å€</span></span><br><span class=\"line\">        user =&gt; <span class=\"string\">&quot;elastic&quot;</span>                     <span class=\"comment\"># ESç”¨æˆ·å</span></span><br><span class=\"line\">        password =&gt; <span class=\"string\">&quot;123456&quot;</span>                  <span class=\"comment\"># ESå¯†ç </span></span><br><span class=\"line\">        ssl =&gt; <span class=\"literal\">true</span>                           <span class=\"comment\"># æ˜¯å¦å¯ç”¨SSLï¼Œå› ä¸ºè¿™é‡Œæ˜¯httpsè®¿é—®ES</span></span><br><span class=\"line\">        ssl_certificate_verification =&gt; <span class=\"literal\">true</span>  <span class=\"comment\"># å¯ç”¨è¯ä¹¦æ ¡éªŒ</span></span><br><span class=\"line\">        ssl_truststore_path =&gt; <span class=\"string\">&quot;/usr/local/logstash/logstash-8.17.3/logstash.keystore&quot;</span> <span class=\"comment\"># æŒ‡å®šä¿¡ä»»åº“è·¯å¾„</span></span><br><span class=\"line\">        ssl_truststore_password =&gt; <span class=\"string\">&quot;123456&quot;</span>   <span class=\"comment\"># ä¿¡ä»»åº“å¯†ç </span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<h2 id=\"æ•´åˆæ¶ˆæ¯é˜Ÿåˆ—-Nginxçš„ELKæ¶æ„\">æ•´åˆæ¶ˆæ¯é˜Ÿåˆ—+Nginxçš„ELKæ¶æ„</h2>\n<p><img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/%E6%88%AA%E5%9B%BE-2.png\" alt=\"\"></p>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æ¶ˆæ¯é˜Ÿåˆ—ï¼šå¼•å…¥æ¶ˆæ¯é˜Ÿåˆ—ä½œä¸ºç¼“å†²æœºåˆ¶ï¼Œç¡®ä¿å³ä½¿åœ¨Logstashæˆ–Elasticsearchå‡ºç°æ•…éšœæ—¶ï¼Œæ—¥å¿—æ•°æ®ä¹Ÿä¸ä¼šä¸¢å¤±ã€‚æ¶ˆæ¯é˜Ÿåˆ—èƒ½å¤Ÿå‡è¡¡ç½‘ç»œä¼ è¾“ï¼Œé™ä½æ•°æ®ä¸¢å¤±çš„å¯èƒ½æ€§ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>Nginxï¼šNginxä½œä¸ºé«˜æ€§èƒ½çš„Webå’Œåå‘ä»£ç†æœåŠ¡å™¨ï¼Œå¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ–æ•´ä¸ªç³»ç»Ÿçš„æ€§èƒ½å’Œå¯ç”¨æ€§ã€‚å®ƒå¯ä»¥åœ¨è´Ÿè½½å‡è¡¡ã€ç¼“å­˜ç­‰æ–¹é¢å‘æŒ¥ä½œç”¨ï¼Œæå‡ç”¨æˆ·è®¿é—®ä½“éªŒã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>æ‰©å±•æ€§ï¼šç”±äºå¼•å…¥äº†æ¶ˆæ¯é˜Ÿåˆ—å’ŒNginxç­‰ç»„ä»¶ï¼Œæ•´ä¸ªæ¶æ„çš„æ‰©å±•æ€§å¾—åˆ°å¢å¼ºã€‚å¯ä»¥æ ¹æ®å®é™…éœ€æ±‚åŠ¨æ€è°ƒæ•´å„ç»„ä»¶çš„èµ„æºåˆ†é…å’Œéƒ¨ç½²è§„æ¨¡ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>é€‚ç”¨åœºæ™¯ï¼šæ•´åˆæ¶ˆæ¯é˜Ÿåˆ—+Nginxçš„æ¶æ„ä¸»è¦é€‚ç”¨äºç”Ÿäº§ç¯å¢ƒï¼Œç‰¹åˆ«æ˜¯éœ€è¦å¤„ç†å¤§æ•°æ®é‡çš„åœºæ™¯ã€‚å®ƒèƒ½å¤Ÿç¡®ä¿æ•°æ®çš„å®‰å…¨æ€§å’Œå®Œæ•´æ€§ï¼ŒåŒæ—¶æä¾›é«˜æ€§èƒ½çš„æ—¥å¿—å¤„ç†å’Œå¯è§†åŒ–åˆ†ææœåŠ¡ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>æ€»ç»“æ¥è¯´å°±æ˜¯</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-4\">filebeatå°†é‡‡é›†çš„æ—¥å¿—å‘é€åˆ°Redis\\RabbitMQ\\Kafkaç­‰</li>\n<li class=\"lvl-4\">Logstashå†ä»Redis\\RabbitMQ\\Kafkaä¸­è¯»å–æ—¥å¿—æ•°æ®ï¼Œå¹¶è¿›è¡Œè§£æåå‘é€åˆ°ESä¸­ã€‚</li>\n<li class=\"lvl-4\">ESé›†ç¾¤ä½¿ç”¨nginxè¿›è¡Œè´Ÿè½½å‡è¡¡ï¼Œä»¥å®ç°é«˜å¯ç”¨å’Œé«˜æ€§èƒ½ã€‚å…·ä½“å®ç°æ–¹æ³•æŸ¥çœ‹ï¼š<a href=\"/2025/03/24/elasticsearch-02-install-cluster/\" title=\"linuxä¸‹å®‰è£…Elasticsearché›†ç¾¤\">linuxä¸‹å®‰è£…Elasticsearché›†ç¾¤</a></li>\n</ul>\n</li>\n</ul>\n<h2 id=\"åŸºäºRedisçš„ELKæ¶æ„ç¤ºä¾‹\">åŸºäºRedisçš„ELKæ¶æ„ç¤ºä¾‹</h2>\n<h3 id=\"filebeatå°†é‡‡é›†çš„æ—¥å¿—å‘é€åˆ°Redis\">filebeatå°†é‡‡é›†çš„æ—¥å¿—å‘é€åˆ°Redis</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åˆ›å»ºé…ç½®æ–‡ä»¶<code>filebeat-nginx-to-redis.yml</code>ï¼Œå°†å…¶ä¿å­˜åˆ°Filebeatå®‰è£…ç›®å½•ä¸‹çš„confç›®å½•ä¸‹ã€‚</p>\n</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># å› ä¸ºNginxçš„access.logæ—¥å¿—éƒ½æ˜¯ä»¥IPåœ°å€å¼€å¤´çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¿®æ”¹ä¸‹åŒ¹é…å­—æ®µã€‚</span></span><br><span class=\"line\"><span class=\"comment\"># ä¸ä»¥ipåœ°å€å¼€å¤´çš„è¡Œè¿½åŠ åˆ°ä¸Šä¸€è¡Œ</span></span><br><span class=\"line\"><span class=\"attr\">filebeat.inputs:</span> <span class=\"comment\"># è¾“å…¥æºé…ç½®</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">type:</span> <span class=\"string\">log</span> <span class=\"comment\"># æ—¥å¿—ç±»å‹</span></span><br><span class=\"line\">  <span class=\"attr\">enabled:</span> <span class=\"literal\">true</span> <span class=\"comment\"># æ˜¯å¦å¯ç”¨</span></span><br><span class=\"line\">  <span class=\"attr\">paths:</span> <span class=\"comment\"># é‡‡é›†è·¯å¾„</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">/var/log/nginx/access*.*</span></span><br><span class=\"line\">  <span class=\"attr\">exclude_files:</span> [<span class=\"string\">&quot;.gz$&quot;</span>] <span class=\"comment\"># æ’é™¤ä»¥.gz ç»“å°¾çš„æ–‡ä»¶</span></span><br><span class=\"line\">  <span class=\"attr\">multiline.pattern:</span> <span class=\"string\">&#x27;^\\\\d&#123;1,3&#125;\\\\.\\\\d&#123;1,3&#125;\\\\.\\\\d&#123;1,3&#125;\\\\.\\\\d&#123;1,3&#125;\\\\s&#x27;</span> <span class=\"comment\"># åŒ¹é…ä»¥IPåœ°å€å¼€å¤´ï¼Œå¹¶ç´§è·Ÿä¸€ä¸ªç©ºç™½å­—ç¬¦</span></span><br><span class=\"line\">  <span class=\"attr\">multiline.negate:</span> <span class=\"literal\">true</span> <span class=\"comment\"># ä¸ä»¥ipåœ°å€å¼€å¤´çš„è¡Œè¿½åŠ åˆ°ä¸Šä¸€è¡Œ</span></span><br><span class=\"line\">  <span class=\"attr\">multiline.match:</span> <span class=\"string\">after</span> <span class=\"comment\"># è¿½åŠ åˆ°ä¸Šä¸€è¡Œçš„åé¢</span></span><br><span class=\"line\">  <span class=\"comment\"># multiline: å¤šè¡Œæ—¥å¿—é…ç½®ï¼Œè¿™é‡Œå®é™…ä¸Šä¸éœ€è¦é…ç½®å¤šè¡Œè®¾ç½®ï¼Œå› ä¸ºnginxçš„accessæ—¥å¿—éƒ½æ˜¯å•è¡Œæ—¥å¿—ï¼Œè¿™é‡Œåªåšæ¼”ç¤º</span></span><br><span class=\"line\">    <span class=\"comment\"># pattern: æ­£åˆ™è¡¨è¾¾å¼</span></span><br><span class=\"line\">    <span class=\"comment\"># negate: falseï¼ŒåŒ¹é…patternçš„è¡Œåˆå¹¶åˆ°ä¸Šä¸€è¡Œï¼›trueï¼Œä¸åŒ¹é…patternçš„è¡Œåˆå¹¶åˆ°ä¸Šä¸€è¡Œ</span></span><br><span class=\"line\">    <span class=\"comment\"># match: afterï¼Œåˆå¹¶åˆ°ä¸Šä¸€è¡Œçš„æœ«å°¾ï¼›beforeï¼Œåˆå¹¶åˆ°ä¸Šä¸€è¡Œçš„å¼€å¤´</span></span><br><span class=\"line\">  <span class=\"attr\">scan_frequency:</span> <span class=\"string\">10s</span> <span class=\"comment\"># æ¯ 10 ç§’æ‰«æä¸€æ¬¡æ—¥å¿—æ–‡ä»¶</span></span><br><span class=\"line\">  <span class=\"attr\">clean_removed:</span> <span class=\"literal\">true</span> <span class=\"comment\"># åœ¨æ—¥å¿—æ–‡ä»¶è¢«åˆ é™¤åæ˜¯å¦ä»å…¶å†…éƒ¨çŠ¶æ€ä¸­ç§»é™¤è¯¥æ–‡ä»¶çš„è®°å½•</span></span><br><span class=\"line\">  <span class=\"attr\">clean_inactive:</span> <span class=\"string\">2h</span> <span class=\"comment\"># åœ¨æ—¥å¿—æ–‡ä»¶å¤„äºéæ´»åŠ¨çŠ¶æ€å¤šé•¿æ—¶é—´åå°†å…¶ä»çŠ¶æ€æ•°æ®åº“ä¸­ç§»,è®¾ç½®ä¸ºæ¯” ignore_older + scan_frequency æ›´å¤§çš„å€¼</span></span><br><span class=\"line\">  <span class=\"attr\">ignore_older:</span> <span class=\"string\">1h</span> <span class=\"comment\"># å¿½ç•¥é‚£äº›æ¯”å½“å‰æ—¶é—´æ—©äº 1 å°æ—¶çš„æ—¥å¿—æ–‡ä»¶</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">output.redis:</span> <span class=\"comment\"># Redisè¾“å‡ºé…ç½®</span></span><br><span class=\"line\">  <span class=\"attr\">hosts:</span> [<span class=\"string\">&quot;10.250.0.214:6379&quot;</span>] <span class=\"comment\"># RedisæœåŠ¡å™¨åœ°å€</span></span><br><span class=\"line\">  <span class=\"attr\">password:</span> <span class=\"string\">&quot;123456&quot;</span> <span class=\"comment\"># Rediså¯†ç </span></span><br><span class=\"line\">  <span class=\"attr\">key:</span> <span class=\"string\">&quot;filebeat_nginx&quot;</span> <span class=\"comment\"># Redisçš„keyï¼Œç±»å‹ä¸º list</span></span><br><span class=\"line\">  <span class=\"attr\">db:</span> <span class=\"number\">3</span> <span class=\"comment\"># Redisæ•°æ®åº“</span></span><br><span class=\"line\">  <span class=\"attr\">timeout:</span> <span class=\"number\">3</span> <span class=\"comment\"># Redisè¿æ¥è¶…æ—¶æ—¶é—´ï¼Œå•ä½ç§’</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å¯åŠ¨Filebeatï¼Œå¹¶æŸ¥çœ‹æ—¥å¿—è¾“å‡ºã€‚</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./filebeat -e -c conf/filebeat-nginx-to-redis.yml</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æŸ¥çœ‹Redisä¸­çš„æ•°æ®</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ redis-cli -h 10.250.0.214 -p 6379 -a 123456</span><br><span class=\"line\">10.250.0.214:6379&gt; <span class=\"keyword\">select</span> 3</span><br><span class=\"line\">OK</span><br><span class=\"line\">10.250.0.214:6379[3]&gt; keys filebeat*</span><br><span class=\"line\">1) <span class=\"string\">&quot;filebeat_nginx&quot;</span></span><br><span class=\"line\">10.250.0.214:6379[3]&gt; <span class=\"built_in\">type</span> filebeat_nginx</span><br><span class=\"line\">list</span><br><span class=\"line\">10.250.0.214:6379[3]&gt; LLEN filebeat_nginx</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 14</span><br><span class=\"line\">10.250.0.214:6379[3]&gt; LINDEX filebeat_nginx 1</span><br><span class=\"line\"><span class=\"string\">&quot;&#123;\\&quot;@timestamp\\&quot;:\\&quot;2025-03-28T09:15:23.402Z\\&quot;,\\&quot;@metadata\\&quot;:&#123;\\&quot;beat\\&quot;:\\&quot;filebeat\\&quot;,\\&quot;type\\&quot;:\\&quot;_doc\\&quot;,\\&quot;version\\&quot;:\\&quot;8.17.3\\&quot;&#125;,\\&quot;host\\&quot;:&#123;\\&quot;name\\&quot;:\\&quot;ip-10-250-0-239.cn-northwest-1.compute.internal\\&quot;&#125;,\\&quot;agent\\&quot;:&#123;\\&quot;version\\&quot;:\\&quot;8.17.3\\&quot;,\\&quot;ephemeral_id\\&quot;:\\&quot;c0a521fe-690b-46b1-aadc-bbe16ef1db9a\\&quot;,\\&quot;id\\&quot;:\\&quot;4dbe185b-900d-4990-b841-c13bf9618fc6\\&quot;,\\&quot;name\\&quot;:\\&quot;ip-10-250-0-239.cn-northwest-1.compute.internal\\&quot;,\\&quot;type\\&quot;:\\&quot;filebeat\\&quot;&#125;,\\&quot;log\\&quot;:&#123;\\&quot;offset\\&quot;:46745,\\&quot;file\\&quot;:&#123;\\&quot;path\\&quot;:\\&quot;/var/log/nginx/access.log\\&quot;&#125;&#125;,\\&quot;message\\&quot;:\\&quot;1.119.161.30 - elastic [28/Mar/2025:09:15:13 +0000] \\\\\\&quot;GET /_cluster/stats HTTP/1.1\\\\\\&quot; 200 7457 \\\\\\&quot;-\\\\\\&quot; \\\\\\&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/134.0.0.0 Safari/537.36\\\\\\&quot; \\\\\\&quot;-\\\\\\&quot;\\&quot;,\\&quot;input\\&quot;:&#123;\\&quot;type\\&quot;:\\&quot;log\\&quot;&#125;,\\&quot;ecs\\&quot;:&#123;\\&quot;version\\&quot;:\\&quot;8.0.0\\&quot;&#125;&#125;&quot;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"Logstashä»Redisä¸­è¯»å–æ—¥å¿—å¹¶å†™å…¥Elasticsearch\">Logstashä»Redisä¸­è¯»å–æ—¥å¿—å¹¶å†™å…¥Elasticsearch</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>åˆ›å»ºé…ç½®æ–‡ä»¶<code>logstash-nginx-redis-to-es.conf</code>ï¼Œå°†å…¶ä¿å­˜åˆ°Logstashå®‰è£…ç›®å½•ä¸‹çš„confç›®å½•ä¸‹ã€‚</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># è¿›å…¥logstashå®‰è£…ç›®å½•</span></span><br><span class=\"line\"><span class=\"comment\"># vim logstash-nginx-redis-to-es.conf</span></span><br><span class=\"line\"><span class=\"comment\"># é…ç½®ä» redis æ¥æ”¶æ•°æ®</span></span><br><span class=\"line\">input &#123; <span class=\"comment\"># è¾“å…¥æºé…ç½®</span></span><br><span class=\"line\">    redis &#123; <span class=\"comment\"># Redisè¾“å…¥é…ç½®</span></span><br><span class=\"line\">        host =&gt; <span class=\"string\">&#x27;10.250.0.214&#x27;</span> <span class=\"comment\"># RedisæœåŠ¡å™¨åœ°å€</span></span><br><span class=\"line\">        port =&gt; <span class=\"string\">&quot;6379&quot;</span> <span class=\"comment\"># RedisæœåŠ¡å™¨ç«¯å£</span></span><br><span class=\"line\">        password =&gt; <span class=\"string\">&quot;123456&quot;</span> <span class=\"comment\"># Rediså¯†ç </span></span><br><span class=\"line\">        db =&gt; <span class=\"string\">&quot;3&quot;</span>           <span class=\"comment\"># Redisæ•°æ®åº“</span></span><br><span class=\"line\">        data_type =&gt; <span class=\"string\">&#x27;list&#x27;</span> <span class=\"comment\"># æ•°æ®ç±»å‹ä¸ºlist</span></span><br><span class=\"line\">        key =&gt; <span class=\"string\">&quot;filebeat_nginx&quot;</span>   <span class=\"comment\"># Redisçš„key</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">filter &#123; <span class=\"comment\"># è¿‡æ»¤å™¨é…ç½®</span></span><br><span class=\"line\">    grok &#123;</span><br><span class=\"line\">        match =&gt; &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;message&quot;</span> =&gt; <span class=\"string\">&quot;%&#123;IP:client_ip&#125; - %&#123;USER:remote_user&#125; \\[%&#123;HTTPDATE:timestamp&#125;\\] \\&quot;%&#123;WORD:verb&#125; %&#123;URIPATHPARAM:request&#125; HTTP/%&#123;NUMBER:httpversion&#125;\\&quot; %&#123;INT:http_status&#125; %&#123;INT:body_bytes_sent&#125; \\&quot;%&#123;NOTSPACE:referrer&#125;\\&quot; \\&quot;%&#123;GREEDYDATA:agent&#125;\\&quot; %&#123;QUOTEDSTRING:x_forwarded_for&#125;&quot;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    mutate &#123;</span><br><span class=\"line\">        enable_metric =&gt; <span class=\"string\">&quot;false&quot;</span> <span class=\"comment\"># ç¦ç”¨æŒ‡æ ‡ä¸ŠæŠ¥</span></span><br><span class=\"line\">        remove_field =&gt; [<span class=\"string\">&quot;message&quot;</span>, <span class=\"string\">&quot;log&quot;</span>, <span class=\"string\">&quot;tags&quot;</span>, <span class=\"string\">&quot;input&quot;</span>, <span class=\"string\">&quot;agent&quot;</span>, <span class=\"string\">&quot;host&quot;</span>, <span class=\"string\">&quot;ecs&quot;</span>, <span class=\"string\">&quot;@version&quot;</span>] <span class=\"comment\"># ç§»é™¤ä¸éœ€è¦çš„å­—æ®µ</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">date</span> &#123;</span><br><span class=\"line\">        match =&gt; [<span class=\"string\">&quot;timestamp&quot;</span>,<span class=\"string\">&quot;dd/MMM/yyyy:HH:mm:ss Z&quot;</span>,<span class=\"string\">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>] <span class=\"comment\"># æ—¶é—´æ ¼å¼è½¬æ¢</span></span><br><span class=\"line\">        target =&gt; <span class=\"string\">&quot;timestamp&quot;</span> <span class=\"comment\"># ç›®æ ‡å­—æ®µ</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># åœ¨è¾“å‡ºé…ç½®ä¸­æ·»åŠ ESè¾“å‡ºé…ç½®</span></span><br><span class=\"line\">output &#123; <span class=\"comment\"># è¾“å‡ºé…ç½®</span></span><br><span class=\"line\">    stdout &#123; <span class=\"comment\"># æ‰“å°åˆ°æ§åˆ¶å°</span></span><br><span class=\"line\">      codec =&gt; rubydebug <span class=\"comment\"># æŒ‡å®šç¼–ç å™¨</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    elasticsearch &#123; <span class=\"comment\"># è¾“å‡ºåˆ°ES</span></span><br><span class=\"line\">        index =&gt; <span class=\"string\">&quot;redis_nginx_access_log_%&#123;+YYYY-MM&#125;&quot;</span> <span class=\"comment\"># ç´¢å¼•å,æŒ‰æœˆåˆ†éš”</span></span><br><span class=\"line\">        hosts =&gt; [<span class=\"string\">&quot;https://10.250.0.239:9200&quot;</span>] <span class=\"comment\"># ESåœ°å€</span></span><br><span class=\"line\">        user =&gt; <span class=\"string\">&quot;elastic&quot;</span>                   <span class=\"comment\"># ESç”¨æˆ·å</span></span><br><span class=\"line\">        password =&gt; <span class=\"string\">&quot;123456&quot;</span>                <span class=\"comment\"># ESå¯†ç </span></span><br><span class=\"line\">        ssl =&gt; <span class=\"literal\">true</span>                         <span class=\"comment\"># æ˜¯å¦å¯ç”¨SSLï¼Œå› ä¸ºè¿™é‡Œæ˜¯httpsè®¿é—®ES</span></span><br><span class=\"line\">        ssl_certificate_verification =&gt; <span class=\"literal\">false</span> <span class=\"comment\"># ç¦ç”¨è¯ä¹¦éªŒè¯</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æµ‹è¯•logstashé…ç½®æ˜¯å¦æ­£ç¡®</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bin/logstash -f config/logstash-nginx-redis-to-es.conf --config.test_and_exit</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å¯åŠ¨logstash</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># reload.automaticï¼šä¿®æ”¹é…ç½®æ–‡ä»¶æ—¶è‡ªåŠ¨é‡æ–°åŠ è½½</span></span><br><span class=\"line\">bin/logstash -f config/logstash-nginx-redis-to-es.conf --config.reload.automatic</span><br></pre></td></tr></table></figure>","content_text":"æ‘˜è¦ æœ¬æ–‡ä»‹ç»å¦‚ä½•åœ¨linuxä¸‹å®‰è£…LogStashå’ŒFileBeat é€šè¿‡ç¤ºä¾‹è®²è§£ELKçš„ç»å…¸æ¶æ„å’Œé«˜å¹¶å‘æ¶æ„çš„å®ç°è¿‡ç¨‹ LogStashç‰ˆæœ¬8.17.3ï¼ŒFileBeatç‰ˆæœ¬8.17.3 Elasticsearchç‰ˆæœ¬8.17.3ï¼Œlinuxä¸‹å®‰è£…Elasticsearch Kibanaç‰ˆæœ¬8.17.3ï¼Œlinuxä¸‹å®‰è£…Kibana Elasticsearché›†ç¾¤æ­å»ºï¼Œlinuxä¸‹å®‰è£…Elasticsearché›†ç¾¤ Logstashæ¦‚è¿° Logstash æ˜¯å…è´¹ä¸”å¼€æ”¾çš„æœåŠ¡å™¨ç«¯æ•°æ®å¤„ç†ç®¡é“ï¼Œèƒ½å¤Ÿä»å¤šä¸ªæ¥æºé‡‡é›†æ•°æ®ï¼Œè½¬æ¢æ•°æ®ï¼Œç„¶åå°†æ•°æ®å‘é€åˆ°æ‚¨æœ€å–œæ¬¢çš„å­˜å‚¨åº“ä¸­ã€‚ Logstashæ•°æ®ä¼ è¾“åŸç† 1231.æ•°æ®é‡‡é›†ä¸è¾“å…¥ï¼šLogstashæ”¯æŒå„ç§è¾“å…¥é€‰æ‹©ï¼Œèƒ½å¤Ÿä»¥è¿ç»­çš„æµå¼ä¼ è¾“æ–¹å¼ï¼Œè½»æ¾åœ°ä»æ—¥å¿—ã€æŒ‡æ ‡ã€Webåº”ç”¨ä»¥åŠæ•°æ®å­˜å‚¨ä¸­é‡‡é›†æ•°æ®ã€‚2.å®æ—¶è§£æå’Œæ•°æ®è½¬æ¢ï¼šé€šè¿‡Logstashè¿‡æ»¤å™¨è§£æå„ä¸ªäº‹ä»¶ï¼Œè¯†åˆ«å·²å‘½åçš„å­—æ®µæ¥æ„å»ºç»“æ„ï¼Œå¹¶å°†å®ƒä»¬è½¬æ¢æˆé€šç”¨æ ¼å¼ï¼Œæœ€ç»ˆå°†æ•°æ®ä»æºç«¯ä¼ è¾“åˆ°å­˜å‚¨åº“ä¸­ã€‚3.å­˜å‚¨ä¸æ•°æ®å¯¼å‡ºï¼šLogstashæä¾›å¤šç§è¾“å‡ºé€‰æ‹©ï¼Œå¯ä»¥å°†æ•°æ®å‘é€åˆ°æŒ‡å®šçš„åœ°æ–¹ã€‚ Logstashé€šè¿‡ç®¡é“å®Œæˆæ•°æ®çš„é‡‡é›†ä¸å¤„ç†ï¼Œç®¡é“é…ç½®ä¸­åŒ…å«inputã€outputå’Œfilterï¼ˆå¯é€‰ï¼‰æ’ä»¶ï¼Œinputå’Œoutputç”¨æ¥é…ç½®è¾“å…¥å’Œè¾“å‡ºæ•°æ®æºã€filterç”¨æ¥å¯¹æ•°æ®è¿›è¡Œè¿‡æ»¤æˆ–é¢„å¤„ç†ã€‚ Logstashä¸‹è½½å®‰è£… ä¸‹è½½åœ°å€ï¼šhttps://www.elastic.co/cn/downloads/past-releases#logstash é€‰æ‹©å¯¹åº”çš„ç‰ˆæœ¬ï¼šè¿™é‡Œé€‰æ‹©å½“å‰çš„æœ€æ–°ç‰ˆLogStash 8.17.3ï¼Œä¹‹åé€‰æ‹©å¯¹åº”çš„æ“ä½œç³»ç»ŸLINUX X86_64 1wget https://artifacts.elastic.co/downloads/logstash/logstash-8.17.3-linux-x86_64.tar.gz ä¸‹è½½å®Œæˆåè§£å‹åˆ°/usr/local/logstashç›®å½•ä¸‹ï¼Œè§£å‹å‘½ä»¤å¦‚ä¸‹ï¼š 12mkdir /usr/local/logstashtar -zxvf logstash-8.17.3-linux-x86_64.tar.gz -C /usr/local/logstash elasticsearchå’Œkibanaéƒ½ä¸èƒ½ç”¨rootç”¨æˆ·å¯åŠ¨ï¼Œä¸ºäº†ç»Ÿä¸€ç®¡ç†ï¼Œlogstashä¹Ÿä½¿ç”¨è¿™ä¸ªç”¨æˆ·ï¼ˆéå¿…è¦ï¼‰ åˆ›å»ºç”¨æˆ·elasticï¼Œå¹¶è®¾ç½®å¯†ç ï¼Œè¿™ä¸€æ­¥æˆ‘ä»¬åœ¨å®‰è£…elasticsearchçš„æ—¶å€™å·²ç»é…ç½®è¿‡äº†ï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°äº† 12useradd elasticpasswd elastic ä¿®æ”¹logstashå®‰è£…ç›®å½•çš„ç”¨æˆ·æƒé™ 1chown -R elastic:elastic /usr/local/logstash åˆ‡æ¢åˆ°elasticç”¨æˆ·ä¸‹æ‰§è¡Œå‘½ä»¤ 1234# åˆ‡æ¢ç”¨æˆ·su - elastic# è¿›å…¥logstashå®‰è£…ç›®å½•cd /usr/local/logstash/logstash-8.17.3/ è¿è¡Œä¸€ä¸ªç®€å•çš„æµ‹è¯• 123456789101112131415161718192021# -e: ç›´æ¥æŠŠé…ç½®æ”¾åœ¨å‘½ä»¤ä¸­ï¼Œè¿™æ ·å¯ä»¥æœ‰æ•ˆå¿«é€Ÿè¿›è¡Œæµ‹è¯•# input &#123; stdin &#123; &#125; &#125;: è¾“å…¥æ’ä»¶ï¼Œä»æ ‡å‡†è¾“å…¥ä¸­è¯»å–æ•°æ®# output &#123; stdout &#123;&#125; &#125;: è¾“å‡ºæ’ä»¶ï¼Œå°†æ•°æ®è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡º# è¿™é‡ŒåªåŒ…å«äº† input å’Œ output ä¸¤ä¸ªéƒ¨åˆ†ï¼Œå®é™…ä½¿ç”¨ä¸­è¿˜éœ€è¦æ·»åŠ  filter éƒ¨åˆ†./bin/logstash -e &#x27;input &#123; stdin &#123; &#125; &#125; output &#123; stdout &#123;&#125; &#125;&#x27;# è¾“å‡ºï¼šã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ # è¾“å‡ºå¯åŠ¨ä¿¡æ¯The stdin plugin is now waiting for input: # è¾“å‡ºæç¤ºä¿¡æ¯ï¼Œæç¤ºä½ è¾“å…¥å†…å®¹hello world # æˆ‘è¾“å…¥å†…å®¹# logstashè¾“å‡ºå†…å®¹&#123; &quot;message&quot; =&gt; &quot;hello world&quot;, &quot;@version&quot; =&gt; &quot;1&quot;, &quot;event&quot; =&gt; &#123; &quot;original&quot; =&gt; &quot;hello world&quot; &#125;, &quot;host&quot; =&gt; &#123; &quot;hostname&quot; =&gt; &quot;ip-10-250-0-239.cn-northwest-1.compute.internal&quot; &#125;, &quot;@timestamp&quot; =&gt; 2025-03-27T06:48:12.810617855Z&#125; ä¹Ÿå¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶å¯åŠ¨logstash 1234567891011121314# vim test.confinput &#123; stdin &#123; &#125;&#125;output &#123; stdout &#123; codec =&gt; rubydebug &#125;&#125;# codec =&gt; rubydebug : æ˜¯æŒ‡å®šäº†ä¸€ä¸ªç¼–ç å™¨ï¼ˆCodecï¼‰ä¸º rubydebugã€‚# ç¼–ç å™¨è´Ÿè´£å¦‚ä½•æ ¼å¼åŒ–è¾“å‡ºçš„æ•°æ®ã€‚# Rubydebug ç¼–ç å™¨æ˜¯ä¸€ç§ç‰¹åˆ«é€‚åˆå¼€å‘å’Œè°ƒè¯•ç›®çš„çš„ç¼–ç å™¨ï¼Œå› ä¸ºå®ƒèƒ½ä»¥ç›¸å½“æ˜“è¯»çš„å½¢å¼å±•ç¤ºå¤æ‚çš„ç»“æ„åŒ–æ•°æ®ï¼Œæ¯”å¦‚åµŒå¥—çš„å“ˆå¸Œè¡¨æˆ–è€…æ•°ç»„ã€‚# é™¤äº† Rubydebug ç¼–ç å™¨ï¼ŒLogstash è¿˜æä¾›äº†å…¶ä»–å‡ ç§ç¼–ç å™¨ï¼Œæ¯”å¦‚ jsonã€plainã€multiline ç­‰ç­‰ã€‚# å…·ä½“å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼šhttps://www.elastic.co/guide/en/logstash/current/codec-plugins.html 1./bin/logstash -f ./test.conf Logstashæ’ä»¶ Input Plugins https://www.elastic.co/guide/en/logstash/8.17/input-plugins.html ä¸€ä¸ª Pipelineå¯ä»¥æœ‰å¤šä¸ªinputæ’ä»¶ 12345- Stdin / File- Beats / Log4J /Elasticsearch / JDBC / Kafka /Rabbitmq /Redis- JMX/ HTTP / Websocket / UDP / TCP- Google Cloud Storage / S3- Github / Twitter Filter Plugins https://www.elastic.co/guide/en/logstash/8.17/filter-plugins.html Filter Pluginå¯ä»¥å¯¹Logstash Eventè¿›è¡Œå„ç§å¤„ç†ï¼Œä¾‹å¦‚è§£æï¼Œåˆ é™¤å­—æ®µï¼Œç±»å‹è½¬æ¢ 1234567891011- Date: æ—¥æœŸè§£æ- Dissect: åˆ†å‰²ç¬¦è§£æ- Grok: æ­£åˆ™åŒ¹é…è§£æ- Mutate: å¯¹å­—æ®µåšå„ç§æ“ä½œ- Convert : ç±»å‹è½¬æ¢- Gsub : å­—ç¬¦ä¸²æ›¿æ¢- Split / Join /Merge: å­—ç¬¦ä¸²åˆ‡å‰²ï¼Œæ•°ç»„åˆå¹¶å­—ç¬¦ä¸²ï¼Œæ•°ç»„åˆå¹¶æ•°ç»„- Rename: å­—æ®µé‡å‘½å- Update / Replace: å­—æ®µå†…å®¹æ›´æ–°æ›¿æ¢- Remove_field: å­—æ®µåˆ é™¤- Ruby: åˆ©ç”¨Ruby ä»£ç æ¥åŠ¨æ€ä¿®æ”¹Event Output Plugins https://www.elastic.co/guide/en/logstash/8.17/output-plugins.html å°†Eventå‘é€åˆ°ç‰¹å®šçš„ç›®çš„åœ°ï¼Œæ˜¯ Pipeline çš„æœ€åä¸€ä¸ªé˜¶æ®µã€‚å¸¸è§ Output Pluginsï¼š 1234- Elasticsearch- Email / Pageduty- Influxdb / Kafka / Mongodb / Opentsdb / Zabbix- Http / TCP / Websocket Codec Plugins https://www.elastic.co/guide/en/logstash/8.17/codec-plugins.html å°†åŸå§‹æ•°æ®decodeæˆEvent;å°†Event encodeæˆç›®æ ‡æ•°æ®ï¼Œå†…ç½®çš„Codec Plugins: 123- Line / Multiline- JSON / Avro / Cef (ArcSight Common Event Format)- Dots / Rubydebug FileBeatæ¦‚è¿° Beats æ˜¯ä¸€ä¸ªå…è´¹ä¸”å¼€æ”¾çš„å¹³å°ï¼Œé›†åˆäº†å¤šç§å•ä¸€ç”¨é€”çš„æ•°æ®é‡‡é›†å™¨ã€‚å®ƒä»¬ä»æˆç™¾ä¸Šåƒæˆ–æˆåƒä¸Šä¸‡å°æœºå™¨å’Œç³»ç»Ÿå‘ Logstash æˆ– Elasticsearch å‘é€æ•°æ®ã€‚ FileBeat ä¸“é—¨ç”¨äºè½¬å‘å’Œæ”¶é›†æ—¥å¿—æ•°æ®çš„è½»é‡çº§é‡‡é›†å·¥å…·ã€‚å®ƒå¯ä»¥ä½œä¸ºä»£ç†å®‰è£…åœ¨æœåŠ¡å™¨ä¸Šï¼ŒFileBeatç›‘è§†æŒ‡å®šè·¯å¾„çš„æ—¥å¿—æ–‡ä»¶ï¼Œæ”¶é›†æ—¥å¿—æ•°æ®ï¼Œå¹¶å°†æ”¶é›†åˆ°çš„æ—¥å¿—è½¬å‘åˆ°Elasticsearchæˆ–è€…Logstashã€‚ logstash vs FileBeat Logstashæ˜¯åœ¨jvmä¸Šè¿è¡Œçš„ï¼Œèµ„æºæ¶ˆè€—æ¯”è¾ƒå¤§ã€‚è€ŒFileBeatæ˜¯åŸºäºgolangç¼–å†™çš„ï¼ŒåŠŸèƒ½è¾ƒå°‘ä½†èµ„æºæ¶ˆè€—ä¹Ÿæ¯”è¾ƒå°ï¼Œæ›´è½»é‡çº§ã€‚ Logstash å’ŒFilebeatéƒ½å…·æœ‰æ—¥å¿—æ”¶é›†åŠŸèƒ½ï¼ŒFilebeatæ›´è½»é‡ï¼Œå ç”¨èµ„æºæ›´å°‘ Logstash å…·æœ‰FilteråŠŸèƒ½ï¼Œèƒ½è¿‡æ»¤åˆ†ææ—¥å¿— ä¸€èˆ¬ç»“æ„éƒ½æ˜¯Filebeaté‡‡é›†æ—¥å¿—ï¼Œç„¶åå‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—ã€Redisã€MQä¸­ï¼Œç„¶åLogstashå»è·å–ï¼Œåˆ©ç”¨FilteråŠŸèƒ½è¿‡æ»¤åˆ†æï¼Œç„¶åå­˜å‚¨åˆ°Elasticsearchä¸­ FileBeatå’ŒLogstashé…åˆï¼Œå®ç°èƒŒå‹æœºåˆ¶ã€‚å½“å°†æ•°æ®å‘é€åˆ°Logstashæˆ– Elasticsearchæ—¶ï¼ŒFilebeatä½¿ç”¨èƒŒå‹æ•æ„Ÿåè®®ï¼Œä»¥åº”å¯¹æ›´å¤šçš„æ•°æ®é‡ã€‚å¦‚æœLogstashæ­£åœ¨å¿™äºå¤„ç†æ•°æ®ï¼Œåˆ™ä¼šå‘Šè¯‰Filebeat å‡æ…¢è¯»å–é€Ÿåº¦ã€‚ä¸€æ—¦æ‹¥å µå¾—åˆ°è§£å†³ï¼ŒFilebeatå°±ä¼šæ¢å¤åˆ°åŸæ¥çš„æ­¥ä¼å¹¶ç»§ç»­ä¼ è¾“æ•°æ®ã€‚ FileBeatä¸‹è½½å’Œå®‰è£… ä¸‹è½½åœ°å€ï¼šhttps://www.elastic.co/cn/downloads/past-releases#filebeat é€‰æ‹©å¯¹åº”çš„ç‰ˆæœ¬ï¼šè¿™é‡Œé€‰æ‹©å½“å‰çš„æœ€æ–°ç‰ˆFileBeat 8.17.3ï¼Œä¹‹åé€‰æ‹©å¯¹åº”çš„æ“ä½œç³»ç»ŸLINUX X86_64 1wget https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-8.17.3-linux-x86_64.tar.gz ä¸‹è½½å®Œæˆåè§£å‹åˆ°/usr/local/filebeatç›®å½•ä¸‹ï¼Œè§£å‹å‘½ä»¤å¦‚ä¸‹ï¼š 12mkdir /usr/local/filebeattar -zxvf filebeat-8.17.3-linux-x86_64.tar.gz -C /usr/local/filebeat ä¿®æ”¹logstashå®‰è£…ç›®å½•çš„ç”¨æˆ·æƒé™ 1chown -R elastic:elastic /usr/local/filebeat åˆ‡æ¢åˆ°elasticç”¨æˆ·ä¸‹æ‰§è¡Œå‘½ä»¤ 1234# åˆ‡æ¢ç”¨æˆ·su - elastic# è¿›å…¥ filebeat å®‰è£…ç›®å½•cd /usr/local/filebeat/filebeat-8.17.3-linux-x86_64/ ç»å…¸çš„ELKæ¶æ„ Filebeatæ—¥å¿—æ”¶é›†ï¼šFilebeatä½œä¸ºè½»é‡çº§çš„æ—¥å¿—æ”¶é›†ä»£ç†ï¼Œéƒ¨ç½²åœ¨å®¢æˆ·ç«¯ä¸Šï¼Œæ¶ˆè€—èµ„æºå°‘ï¼Œèƒ½å¤Ÿé«˜æ•ˆåœ°æ”¶é›†æ—¥å¿—æ•°æ®ã€‚ Logstashæ•°æ®å¤„ç†ï¼šLogstashä½œä¸ºæ•°æ®å¤„ç†ç®¡é“ï¼Œè´Ÿè´£å°†Filebeatæ”¶é›†çš„æ—¥å¿—æ•°æ®è¿›è¡Œè¿‡æ»¤ã€è½¬æ¢ç­‰æ“ä½œï¼Œç„¶åå‘é€åˆ°Elasticsearchè¿›è¡Œå­˜å‚¨ã€‚ Elasticsearchå­˜å‚¨ä¸æœç´¢ï¼šElasticsearchæ˜¯ä¸€ä¸ªåŸºäºLuceneçš„åˆ†å¸ƒå¼æœç´¢å’Œåˆ†æå¼•æ“ï¼Œæä¾›å¼ºå¤§çš„æ•°æ®å­˜å‚¨å’Œæœç´¢èƒ½åŠ›ã€‚ Kibanaå¯è§†åŒ–ï¼šKibanaä¸ºElasticsearchæä¾›Webå¯è§†åŒ–ç•Œé¢ï¼Œå…è®¸ç”¨æˆ·é€šè¿‡å›¾è¡¨ã€ä»ªè¡¨ç›˜ç­‰æ–¹å¼ç›´è§‚åœ°æŸ¥çœ‹å’Œåˆ†ææ—¥å¿—æ•°æ®ã€‚ é€‚ç”¨åœºæ™¯ï¼šç»å…¸çš„ELKæ¶æ„ä¸»è¦é€‚ç”¨äºæ•°æ®é‡è¾ƒå°çš„å¼€å‘ç¯å¢ƒã€‚ç„¶è€Œï¼Œç”±äºç¼ºå°‘æ¶ˆæ¯é˜Ÿåˆ—çš„ç¼“å†²æœºåˆ¶ï¼Œå½“Logstashæˆ–Elasticsearchå‡ºç°æ•…éšœæ—¶ï¼Œå¯èƒ½å­˜åœ¨æ•°æ®ä¸¢å¤±çš„é£é™©ã€‚ ä¸€ä¸ªç»å…¸ELKæ¶æ„ç¤ºä¾‹ FileBeaté‡‡é›†NginxæœåŠ¡å™¨æ—¥å¿—å¹¶å‘é€åˆ°Logstash åˆ›å»ºé…ç½®æ–‡ä»¶filebeat-nginx.ymlï¼Œå°†å…¶ä¿å­˜åˆ°Filebeatå®‰è£…ç›®å½•ä¸‹çš„confç›®å½•ä¸‹ã€‚ 12345678910111213141516171819202122# å› ä¸ºNginxçš„access.logæ—¥å¿—éƒ½æ˜¯ä»¥IPåœ°å€å¼€å¤´çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¿®æ”¹ä¸‹åŒ¹é…å­—æ®µã€‚# ä¸ä»¥ipåœ°å€å¼€å¤´çš„è¡Œè¿½åŠ åˆ°ä¸Šä¸€è¡Œfilebeat.inputs: # è¾“å…¥æºé…ç½®- type: log # æ—¥å¿—ç±»å‹ enabled: true # æ˜¯å¦å¯ç”¨ paths: # é‡‡é›†è·¯å¾„ - /var/log/nginx/access*.* exclude_files: [&quot;.gz$&quot;] # æ’é™¤ä»¥.gz ç»“å°¾çš„æ–‡ä»¶ multiline.pattern: &#x27;^\\\\d&#123;1,3&#125;\\\\.\\\\d&#123;1,3&#125;\\\\.\\\\d&#123;1,3&#125;\\\\.\\\\d&#123;1,3&#125;\\\\s&#x27; # åŒ¹é…ä»¥IPåœ°å€å¼€å¤´ï¼Œå¹¶ç´§è·Ÿä¸€ä¸ªç©ºç™½å­—ç¬¦ multiline.negate: true # ä¸ä»¥ipåœ°å€å¼€å¤´çš„è¡Œè¿½åŠ åˆ°ä¸Šä¸€è¡Œ multiline.match: after # è¿½åŠ åˆ°ä¸Šä¸€è¡Œçš„åé¢ # multiline: å¤šè¡Œæ—¥å¿—é…ç½®ï¼Œè¿™é‡Œå®é™…ä¸Šä¸éœ€è¦é…ç½®å¤šè¡Œè®¾ç½®ï¼Œå› ä¸ºnginxçš„accessæ—¥å¿—éƒ½æ˜¯å•è¡Œæ—¥å¿—ï¼Œè¿™é‡Œåªåšæ¼”ç¤º # pattern: æ­£åˆ™è¡¨è¾¾å¼ # negate: falseï¼ŒåŒ¹é…patternçš„è¡Œåˆå¹¶åˆ°ä¸Šä¸€è¡Œï¼›trueï¼Œä¸åŒ¹é…patternçš„è¡Œåˆå¹¶åˆ°ä¸Šä¸€è¡Œ # match: afterï¼Œåˆå¹¶åˆ°ä¸Šä¸€è¡Œçš„æœ«å°¾ï¼›beforeï¼Œåˆå¹¶åˆ°ä¸Šä¸€è¡Œçš„å¼€å¤´ scan_frequency: 10s # æ¯ 10 ç§’æ‰«æä¸€æ¬¡æ—¥å¿—æ–‡ä»¶ clean_removed: true # åœ¨æ—¥å¿—æ–‡ä»¶è¢«åˆ é™¤åæ˜¯å¦ä»å…¶å†…éƒ¨çŠ¶æ€ä¸­ç§»é™¤è¯¥æ–‡ä»¶çš„è®°å½• clean_inactive: 2h # åœ¨æ—¥å¿—æ–‡ä»¶å¤„äºéæ´»åŠ¨çŠ¶æ€å¤šé•¿æ—¶é—´åå°†å…¶ä»çŠ¶æ€æ•°æ®åº“ä¸­ç§»,è®¾ç½®ä¸ºæ¯” ignore_older + scan_frequency æ›´å¤§çš„å€¼ ignore_older: 1h # å¿½ç•¥é‚£äº›æ¯”å½“å‰æ—¶é—´æ—©äº 1 å°æ—¶çš„æ—¥å¿—æ–‡ä»¶output.logstash: # è¾“å‡ºé…ç½®ï¼Œè¿™é‡Œæ˜¯å‘é€åˆ°Logstash enabled: true # æ˜¯å¦å¯ç”¨ hosts: [&quot;10.250.0.239:5044&quot;] # LogstashæœåŠ¡åœ°å€ ä¸ºFileBeatçš„ç”¨æˆ·åˆ†é…æ—¥å¿—ç›®å½•çš„è¯»å–æƒé™ 12# ä½¿ç”¨ setfaclå‘½ä»¤ä¸ºelasticç”¨æˆ·åˆ†é…æ—¥å¿—ç›®å½•çš„è¯»å–æƒé™sudo setfacl -d -m u:elastic:r-x -R /var/log/nginx/ å¯åŠ¨FileBeat 123./filebeat -e -c conf/filebeat-nginx.yml# åå°å¯åŠ¨nohup ./filebeat -e -c conf/filebeat-nginx.yml &amp; åœ¨å¯åŠ¨filebeatæ—¶å¯èƒ½ä¼šé‡åˆ°å¦‚ä¸‹é”™è¯¯ 1Exiting: error loading config file: config file (&quot;conf/filebeat-nginx.yml&quot;) can only be writable by the owner but the permissions are &quot;-rw-rw-r--&quot; (to fix the permissions use: &#x27;chmod go-w /usr/local/filebeat/filebeat-8.17.3-linux-x86_64/conf/filebeat-nginx.yml&#x27;) å› ä¸ºå®‰å…¨åŸå› ä¸è¦å…¶ä»–ç”¨æˆ·å†™çš„æƒé™ï¼Œå»æ‰å†™çš„æƒé™å°±å¯ä»¥äº† 1chmod go-w conf/filebeat-nginx.yml é…ç½®Logstashæ¥æ”¶FileBeatæ”¶é›†çš„æ•°æ®å¹¶æ‰“å° åˆ›å»ºé…ç½®æ–‡ä»¶logstash-nginx.confï¼Œå°†å…¶ä¿å­˜åˆ°Logstashå®‰è£…ç›®å½•ä¸‹çš„configç›®å½•ä¸‹ã€‚ 1234567891011121314# è¿›å…¥logstashå®‰è£…ç›®å½•# vim config/logstash-nginx.conf# é…ç½®ä»FileBeatæ¥æ”¶æ•°æ®input &#123; # è¾“å…¥æºé…ç½® beats &#123; # ä»FileBeatæ¥æ”¶æ•°æ® port =&gt; 5044 # ç›‘å¬5044ç«¯å£ &#125;&#125;output &#123; # è¾“å‡ºé…ç½® stdout &#123; # æ‰“å°åˆ°æ§åˆ¶å° codec =&gt; rubydebug # æŒ‡å®šç¼–ç å™¨ &#125;&#125; æµ‹è¯•logstashé…ç½®æ˜¯å¦æ­£ç¡® 1bin/logstash -f config/logstash-nginx.conf --config.test_and_exit å¯åŠ¨logstash 12345678910111213141516171819202122232425262728293031323334353637# reload.automaticï¼šä¿®æ”¹é…ç½®æ–‡ä»¶æ—¶è‡ªåŠ¨é‡æ–°åŠ è½½bin/logstash -f config/logstash-nginx.conf --config.reload.automatic# æ­¤æ—¶åœ¨æ§åˆ¶å°ä¼šçœ‹åˆ°å¦‚ä¸‹è¾“å‡ºï¼š&#123; &quot;input&quot; =&gt; &#123; &quot;type&quot; =&gt; &quot;log&quot; &#125;, &quot;@version&quot; =&gt; &quot;1&quot;, &quot;message&quot; =&gt; &quot;1.119.161.30 - elastic [27/Mar/2025:08:52:41 +0000] \\&quot;GET /_cluster/stats HTTP/1.1\\&quot; 200 7445 \\&quot;-\\&quot; \\&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/134.0.0.0 Safari/537.36\\&quot; \\&quot;-\\&quot;&quot;, &quot;log&quot; =&gt; &#123; &quot;file&quot; =&gt; &#123; &quot;path&quot; =&gt; &quot;/var/log/nginx/access.log&quot; &#125;, &quot;offset&quot; =&gt; 42985 &#125;, &quot;tags&quot; =&gt; [ [0] &quot;beats_input_codec_plain_applied&quot; ], &quot;@timestamp&quot; =&gt; 2025-03-27T08:52:42.947Z, &quot;ecs&quot; =&gt; &#123; &quot;version&quot; =&gt; &quot;8.0.0&quot; &#125;, &quot;agent&quot; =&gt; &#123; &quot;id&quot; =&gt; &quot;4dbe185b-900d-4990-b841-c13bf9618fc6&quot;, &quot;name&quot; =&gt; &quot;ip-10-250-0-239.cn-northwest-1.compute.internal&quot;, &quot;ephemeral_id&quot; =&gt; &quot;6bb04808-7da7-4acb-95fd-f3f915651457&quot;, &quot;type&quot; =&gt; &quot;filebeat&quot;, &quot;version&quot; =&gt; &quot;8.17.3&quot; &#125;, &quot;event&quot; =&gt; &#123; &quot;original&quot; =&gt; &quot;1.119.161.30 - elastic [27/Mar/2025:08:52:41 +0000] \\&quot;GET /_cluster/stats HTTP/1.1\\&quot; 200 7445 \\&quot;-\\&quot; \\&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/134.0.0.0 Safari/537.36\\&quot; \\&quot;-\\&quot;&quot; &#125;, &quot;host&quot; =&gt; &#123; &quot;name&quot; =&gt; &quot;ip-10-250-0-239.cn-northwest-1.compute.internal&quot; &#125;&#125; åˆ©ç”¨Logstashè¿‡æ»¤å™¨è§£ææ—¥å¿— ä»æ‰“å°ç»“æœçœ‹åˆ°åŒ…å«äº†å¤§é‡çš„æ— å…³æ•°æ®ï¼Œæ­¤æ—¶å¯ä»¥åˆ©ç”¨Logstashè¿‡æ»¤å™¨è§£ææ—¥å¿—ï¼Œè¿™é‡Œä½¿ç”¨Grokæ’ä»¶ Grokæ˜¯ä¸€ç§å°†éç»“æ„åŒ–æ—¥å¿—è§£æä¸ºç»“æ„åŒ–çš„æ’ä»¶ã€‚è¿™ä¸ªå·¥å…·éå¸¸é€‚åˆç”¨æ¥è§£æç³»ç»Ÿæ—¥å¿—ã€WebæœåŠ¡å™¨æ—¥å¿—ã€MySQLæˆ–è€…æ˜¯ä»»æ„å…¶ä»–çš„æ—¥å¿—æ ¼å¼ã€‚ Grokæ˜¯é€šè¿‡æ¨¡å¼åŒ¹é…çš„æ–¹å¼æ¥è¯†åˆ«æ—¥å¿—ä¸­çš„æ•°æ®,å¯ä»¥æŠŠGrokæ’ä»¶ç®€å•ç†è§£ä¸ºå‡çº§ç‰ˆæœ¬çš„æ­£åˆ™è¡¨è¾¾å¼ã€‚å®ƒæ‹¥æœ‰æ›´å¤šçš„æ¨¡å¼ï¼Œé»˜è®¤Logstashæ‹¥æœ‰120ä¸ªæ¨¡å¼ã€‚å¦‚æœè¿™äº›æ¨¡å¼ä¸æ»¡è¶³æˆ‘ä»¬è§£ææ—¥å¿—çš„éœ€æ±‚ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æ¥è¿›è¡ŒåŒ¹é…ã€‚ GROKæ¨¡å¼å‚è€ƒ grokæ¨¡å¼çš„è¯­æ³•æ˜¯: 1234%&#123;SYNTAX:SEMANTIC&#125;# SYNTAXï¼ˆè¯­æ³•ï¼‰æŒ‡çš„æ˜¯Grokæ¨¡å¼åç§°ï¼ŒSEMANTICï¼ˆè¯­ä¹‰ï¼‰æ˜¯ç»™æ¨¡å¼åŒ¹é…åˆ°çš„æ–‡æœ¬å­—æ®µåã€‚ä¾‹å¦‚ï¼š%&#123;NUMBER:duration&#125; %&#123;IP:client&#125;# durationè¡¨ç¤ºï¼šåŒ¹é…ä¸€ä¸ªæ•°å­—ï¼Œclientè¡¨ç¤ºåŒ¹é…ä¸€ä¸ªIPåœ°å€ã€‚ åŒ¹é…nginxæ—¥å¿— 123456789101112131415161718192021222324252627282930313233# nginx accessæ—¥å¿—æ ¼å¼1.119.161.30 - elastic [27/Mar/2025:03:05:36 +0000] &quot;GET /_cluster/stats HTTP/1.1&quot; 200 7446 &quot;-&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/134.0.0.0 Safari/537.36&quot; &quot;-&quot;# grok%&#123;IP:client_ip&#125; - %&#123;USER:remote_user&#125; \\[%&#123;HTTPDATE:timestamp&#125;\\] \\&quot;%&#123;WORD:verb&#125; %&#123;URIPATHPARAM:request&#125; HTTP/%&#123;NUMBER:httpversion&#125;\\&quot; %&#123;INT:http_status&#125; %&#123;INT:body_bytes_sent&#125; \\&quot;%&#123;NOTSPACE:referrer&#125;\\&quot; \\&quot;%&#123;GREEDYDATA:agent&#125;\\&quot; %&#123;QUOTEDSTRING:x_forwarded_for&#125;# è§£é‡Šæ¯ä¸ªéƒ¨åˆ†çš„ä½œç”¨ï¼š# %&#123;IP:client_ip&#125;ï¼šåŒ¹é…å®¢æˆ·ç«¯ IP åœ°å€ã€‚# -ï¼šåŒ¹é…ä¸€ä¸ªç ´æŠ˜å·ï¼ˆ-ï¼‰ï¼Œè¡¨ç¤ºåŒ¿åç”¨æˆ·æˆ–æœªè®¤è¯ç”¨æˆ·ã€‚# %&#123;USER:remote_user&#125;ï¼šåŒ¹é…è¿œç¨‹ç”¨æˆ·åï¼Œ - è¡¨ç¤ºåŒ¿åç”¨æˆ·ã€‚# \\[%&#123;HTTPDATE:timestamp&#125;\\]ï¼šåŒ¹é…è¯·æ±‚çš„æ—¶é—´æˆ³ï¼Œæ ¼å¼ä¸º [27/Mar/2025:03:05:36 +0000]ã€‚# \\&quot;%&#123;WORD:verb&#125; : åŒ¹é…è¯·æ±‚æ–¹æ³• (GET)# %&#123;URIPATHPARAM:request&#125; : åŒ¹é…è¯·æ±‚è·¯å¾„ (/_cluster/stats)# HTTP/%&#123;NUMBER:httpversion&#125;\\\\\\&quot;ï¼šåŒ¹é… HTTP ç‰ˆæœ¬ (HTTP/1.1)ã€‚# %&#123;INT:http_status&#125;ï¼šåŒ¹é… HTTP å“åº”çŠ¶æ€ç  (200)ã€‚# %&#123;INT:body_bytes_sent&#125;ï¼šåŒ¹é…å“åº”ä½“çš„å­—èŠ‚æ•° (7446)ã€‚# \\&quot;%&#123;NOTSPACE:referrer&#125;\\&quot;ï¼šåŒ¹é…å¼•ç”¨é¡µ (Referer) å­—æ®µï¼Œè¿™é‡Œä¸ºç©º (&quot;-&quot;)ã€‚# \\&quot;%&#123;GREEDYDATA:agent&#125;\\&quot;ï¼šåŒ¹é…ç”¨æˆ·ä»£ç† (User-Agent) å­—æ®µã€‚GREEDYDATA ä¼šåŒ¹é…å°½å¯èƒ½å¤šçš„æ•°æ®ï¼Œç›´åˆ°é‡åˆ°ä¸‹ä¸€ä¸ªåˆ†éš”ç¬¦ã€‚# %&#123;QUOTEDSTRING:x_forwarded_for&#125;ï¼šåŒ¹é… X-Forwarded-For å¤´å­—æ®µï¼Œè¿™é‡Œä¸ºç©º (&quot;-&quot;)ã€‚# åŒ¹é…ç»“æœ&#123; &quot;request&quot;: &quot;/_cluster/stats&quot;, &quot;agent&quot;: &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/134.0.0.0 Safari/537.36&quot;, &quot;body_bytes_sent&quot;: &quot;7446&quot;, &quot;verb&quot;: &quot;GET&quot;, &quot;x_forwarded_for&quot;: &quot;\\&quot;-\\&quot;&quot;, &quot;remote_user&quot;: &quot;elastic&quot;, &quot;referrer&quot;: &quot;-&quot;, &quot;client_ip&quot;: &quot;1.119.161.30&quot;, &quot;httpversion&quot;: &quot;1.1&quot;, &quot;http_status&quot;: &quot;200&quot;, &quot;timestamp&quot;: &quot;27/Mar/2025:03:05:36 +0000&quot;&#125; åŒ¹é…Grokæ¨¡å¼æ˜¯ä¸ªéå¸¸ç¹ççš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨Kibanaæ¥è¿›è¡Œå¯è§†åŒ–çš„Grokè°ƒè¯• groké…ç½® 12345grok &#123; match =&gt; &#123; &quot;message&quot; =&gt; &quot;%&#123;IP:client_ip&#125; - %&#123;USER:remote_user&#125; \\[%&#123;HTTPDATE:timestamp&#125;\\] \\&quot;%&#123;WORD:verb&#125; %&#123;URIPATHPARAM:request&#125; HTTP/%&#123;NUMBER:httpversion&#125;\\&quot; %&#123;INT:http_status&#125; %&#123;INT:body_bytes_sent&#125; \\&quot;%&#123;NOTSPACE:referrer&#125;\\&quot; \\&quot;%&#123;GREEDYDATA:agent&#125;\\&quot; %&#123;QUOTEDSTRING:x_forwarded_for&#125;&quot; &#125;&#125; ä½¿ç”¨mutateæ’ä»¶è¿‡æ»¤æ‰ä¸éœ€è¦çš„å­—æ®µ é™¤äº†nginxæ—¥å¿—æœ¬èº«çš„æ ¼å¼å¤–ï¼Œlogstashè¿˜ä¼šæ‰“å°è®¸å¤šæˆ‘ä»¬ä¸éœ€è¦çš„å­—æ®µï¼Œæ­¤æ—¶å¯ä»¥ä½¿ç”¨mutateæ’ä»¶æ¥è¿‡æ»¤æ‰ä¸éœ€è¦çš„å­—æ®µã€‚ 1234mutate &#123; enable_metric =&gt; &quot;false&quot; # ç¦ç”¨æŒ‡æ ‡ä¸ŠæŠ¥ remove_field =&gt; [&quot;message&quot;, &quot;log&quot;, &quot;tags&quot;, &quot;input&quot;, &quot;agent&quot;, &quot;host&quot;, &quot;ecs&quot;, &quot;@version&quot;] # ç§»é™¤ä¸éœ€è¦çš„å­—æ®µ&#125; ä½¿ç”¨Dateæ’ä»¶å¯¹æ—¶é—´è¿›è¡Œæ ¼å¼è½¬æ¢ 1234date &#123; match =&gt; [&quot;timestamp&quot;,&quot;dd/MMM/yyyy:HH:mm:ss Z&quot;,&quot;yyyy-MM-dd HH:mm:ss&quot;] # æ—¶é—´æ ¼å¼è½¬æ¢ target =&gt; &quot;timestamp&quot; # ç›®æ ‡å­—æ®µ&#125; å®Œæ•´çš„Logstashé…ç½® 1234567891011121314151617181920212223242526272829303132# è¿›å…¥logstashå®‰è£…ç›®å½•# vim config/logstsh-nginx.conf# é…ç½®ä»FileBeatæ¥æ”¶æ•°æ®input &#123; # è¾“å…¥æºé…ç½® beats &#123; # ä»FileBeatæ¥æ”¶æ•°æ® port =&gt; 5044 # ç›‘å¬5044ç«¯å£ &#125;&#125;filter &#123; # è¿‡æ»¤å™¨é…ç½® grok &#123; match =&gt; &#123; &quot;message&quot; =&gt; &quot;%&#123;IP:client_ip&#125; - %&#123;USER:remote_user&#125; \\[%&#123;HTTPDATE:timestamp&#125;\\] \\&quot;%&#123;WORD:verb&#125; %&#123;URIPATHPARAM:request&#125; HTTP/%&#123;NUMBER:httpversion&#125;\\&quot; %&#123;INT:http_status&#125; %&#123;INT:body_bytes_sent&#125; \\&quot;%&#123;NOTSPACE:referrer&#125;\\&quot; \\&quot;%&#123;GREEDYDATA:agent&#125;\\&quot; %&#123;QUOTEDSTRING:x_forwarded_for&#125;&quot; &#125; &#125; mutate &#123; enable_metric =&gt; &quot;false&quot; # ç¦ç”¨æŒ‡æ ‡ä¸ŠæŠ¥ remove_field =&gt; [&quot;message&quot;, &quot;log&quot;, &quot;tags&quot;, &quot;input&quot;, &quot;agent&quot;, &quot;host&quot;, &quot;ecs&quot;, &quot;@version&quot;] # ç§»é™¤ä¸éœ€è¦çš„å­—æ®µ &#125; date &#123; match =&gt; [&quot;timestamp&quot;,&quot;dd/MMM/yyyy:HH:mm:ss Z&quot;,&quot;yyyy-MM-dd HH:mm:ss&quot;] # æ—¶é—´æ ¼å¼è½¬æ¢ target =&gt; &quot;timestamp&quot; # ç›®æ ‡å­—æ®µ &#125;&#125;output &#123; # è¾“å‡ºé…ç½® stdout &#123; # æ‰“å°åˆ°æ§åˆ¶å° codec =&gt; rubydebug # æŒ‡å®šç¼–ç å™¨ &#125;&#125; é‡æ–°å¯åŠ¨logstashåå¾—åˆ°å¦‚ä¸‹ç»“æœï¼š 12345678910111213141516&#123; &quot;event&quot; =&gt; &#123; &quot;original&quot; =&gt; &quot;1.119.161.30 - elastic [27/Mar/2025:09:49:41 +0000] \\&quot;GET /_cluster/stats HTTP/1.1\\&quot; 200 7445 \\&quot;-\\&quot; \\&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/134.0.0.0 Safari/537.36\\&quot; \\&quot;-\\&quot;&quot; &#125;, &quot;client_ip&quot; =&gt; &quot;1.119.161.30&quot;, &quot;request&quot; =&gt; &quot;/_cluster/stats&quot;, &quot;http_status&quot; =&gt; &quot;200&quot;, &quot;@timestamp&quot; =&gt; 2025-03-27T09:49:45.751Z, &quot;body_bytes_sent&quot; =&gt; &quot;7445&quot;, &quot;x_forwarded_for&quot; =&gt; &quot;\\&quot;-\\&quot;&quot;, &quot;timestamp&quot; =&gt; 2025-03-27T09:49:41.000Z, &quot;referrer&quot; =&gt; &quot;-&quot;, &quot;remote_user&quot; =&gt; &quot;elastic&quot;, &quot;httpversion&quot; =&gt; &quot;1.1&quot;, &quot;verb&quot; =&gt; &quot;GET&quot;&#125; å°†ç»“æœè¾“å‡ºåˆ°ES 1234567891011121314# åœ¨è¾“å‡ºé…ç½®ä¸­æ·»åŠ ESè¾“å‡ºé…ç½®output &#123; # è¾“å‡ºé…ç½® stdout &#123; # æ‰“å°åˆ°æ§åˆ¶å° codec =&gt; rubydebug # æŒ‡å®šç¼–ç å™¨ &#125; elasticsearch &#123; # è¾“å‡ºåˆ°ES index =&gt; &quot;nginx_access_log_%&#123;+YYYY-MM&#125;&quot; # ç´¢å¼•å,æŒ‰æœˆåˆ†éš” hosts =&gt; [&quot;https://10.250.0.239:9200&quot;] # ESåœ°å€ user =&gt; &quot;elastic&quot; # ESç”¨æˆ·å password =&gt; &quot;123456&quot; # ESå¯†ç  ssl =&gt; true # æ˜¯å¦å¯ç”¨SSLï¼Œå› ä¸ºè¿™é‡Œæ˜¯httpsè®¿é—®ES ssl_certificate_verification =&gt; false # ç¦ç”¨è¯ä¹¦éªŒè¯ &#125;&#125; å¦‚æœéœ€è¦å¼€å¯è¯ä¹¦æ ¡éªŒï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹æ³•è¿›è¡Œé…ç½® è·å– Elasticsearch çš„ SSL è¯ä¹¦ï¼š 12# ä» Elasticsearch çš„é…ç½®æ–‡ä»¶æˆ–è¯ä¹¦æ–‡ä»¶è·¯å¾„ä¸­è·å–è¯ä¹¦ï¼ˆé€šå¸¸æ˜¯ .pem æˆ– .crt æ–‡ä»¶ï¼‰ã€‚/usr/local/elasticsearch/elasticsearch-8.17.3/config/certs/http_ca.crt å¯¼å…¥è¯ä¹¦åˆ° Java ä¿¡ä»»åº“ï¼šæ³¨æ„è¿™é‡Œè¦å¯¼å…¥åˆ°å¯åŠ¨Logstashçš„JAVAè¿›ç¨‹çš„ä¿¡ä»»åº“ 1234567891011121314151617181920212223242526272829303132333435363738394041424344# logstashçš„jdkè·¯å¾„ï¼Œé»˜è®¤åœ¨logstashçš„å®‰è£…ç›®å½•ä¸‹cd /usr/local/logstash/logstash-8.17.3/jdkbin/keytool -importcert -alias es-cert -keystore /usr/local/logstash/logstash-8.17.3/logstash.keystore -file /usr/local/elasticsearch/elasticsearch-8.17.3/config/certs/http_ca.crt# è¾“å‡ºEnter keystore password: # è¾“å…¥å¯†ç  è¿™é‡Œæ˜¯123456Re-enter new password:Owner: CN=Elasticsearch security auto-configuration HTTP CAIssuer: CN=Elasticsearch security auto-configuration HTTP CASerial number: 89d5c501a2efd5d45a6ee5e08daa16bd605d8c28Valid from: Thu Mar 20 08:53:26 UTC 2025 until: Sun Mar 19 08:53:26 UTC 2028Certificate fingerprints: SHA1: DE:73:0C:EC:46:59:69:83:52:7C:C4:CC:6B:65:EC:B6:31:BE:10:22 SHA256: 3F:14:1C:16:DF:C6:E1:65:89:4B:C1:67:20:84:B2:20:DC:DD:22:FF:E0:21:16:D5:1A:C1:80:03:CF:AA:5A:1DSignature algorithm name: SHA256withRSASubject Public Key Algorithm: 4096-bit RSA keyVersion: 3Extensions:#1: ObjectId: 2.5.29.35 Criticality=falseAuthorityKeyIdentifier [KeyIdentifier [0000: 25 EF BA 81 AE 5E 14 1C 7E FF A1 87 12 F8 D0 2E %....^..........0010: 3A D7 54 5F :.T_]]#2: ObjectId: 2.5.29.19 Criticality=trueBasicConstraints:[CA:truePathLen: no limit]#3: ObjectId: 2.5.29.14 Criticality=falseSubjectKeyIdentifier [KeyIdentifier [0000: 25 EF BA 81 AE 5E 14 1C 7E FF A1 87 12 F8 D0 2E %....^..........0010: 3A D7 54 5F :.T_]]Trust this certificate? [no]: yes # yesç¡®è®¤Certificate was added to keystore é…ç½® Logstash ä½¿ç”¨ä¿¡ä»»åº“ 123456789101112output &#123; elasticsearch &#123; index =&gt; &quot;nginx_access_log_%&#123;+YYYY-MM&#125;&quot; # ç´¢å¼•å,æŒ‰æœˆåˆ†éš” hosts =&gt; [&quot;https://10.250.0.239:9200&quot;] # ESåœ°å€ user =&gt; &quot;elastic&quot; # ESç”¨æˆ·å password =&gt; &quot;123456&quot; # ESå¯†ç  ssl =&gt; true # æ˜¯å¦å¯ç”¨SSLï¼Œå› ä¸ºè¿™é‡Œæ˜¯httpsè®¿é—®ES ssl_certificate_verification =&gt; true # å¯ç”¨è¯ä¹¦æ ¡éªŒ ssl_truststore_path =&gt; &quot;/usr/local/logstash/logstash-8.17.3/logstash.keystore&quot; # æŒ‡å®šä¿¡ä»»åº“è·¯å¾„ ssl_truststore_password =&gt; &quot;123456&quot; # ä¿¡ä»»åº“å¯†ç  &#125;&#125; æ•´åˆæ¶ˆæ¯é˜Ÿåˆ—+Nginxçš„ELKæ¶æ„ æ¶ˆæ¯é˜Ÿåˆ—ï¼šå¼•å…¥æ¶ˆæ¯é˜Ÿåˆ—ä½œä¸ºç¼“å†²æœºåˆ¶ï¼Œç¡®ä¿å³ä½¿åœ¨Logstashæˆ–Elasticsearchå‡ºç°æ•…éšœæ—¶ï¼Œæ—¥å¿—æ•°æ®ä¹Ÿä¸ä¼šä¸¢å¤±ã€‚æ¶ˆæ¯é˜Ÿåˆ—èƒ½å¤Ÿå‡è¡¡ç½‘ç»œä¼ è¾“ï¼Œé™ä½æ•°æ®ä¸¢å¤±çš„å¯èƒ½æ€§ã€‚ Nginxï¼šNginxä½œä¸ºé«˜æ€§èƒ½çš„Webå’Œåå‘ä»£ç†æœåŠ¡å™¨ï¼Œå¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ–æ•´ä¸ªç³»ç»Ÿçš„æ€§èƒ½å’Œå¯ç”¨æ€§ã€‚å®ƒå¯ä»¥åœ¨è´Ÿè½½å‡è¡¡ã€ç¼“å­˜ç­‰æ–¹é¢å‘æŒ¥ä½œç”¨ï¼Œæå‡ç”¨æˆ·è®¿é—®ä½“éªŒã€‚ æ‰©å±•æ€§ï¼šç”±äºå¼•å…¥äº†æ¶ˆæ¯é˜Ÿåˆ—å’ŒNginxç­‰ç»„ä»¶ï¼Œæ•´ä¸ªæ¶æ„çš„æ‰©å±•æ€§å¾—åˆ°å¢å¼ºã€‚å¯ä»¥æ ¹æ®å®é™…éœ€æ±‚åŠ¨æ€è°ƒæ•´å„ç»„ä»¶çš„èµ„æºåˆ†é…å’Œéƒ¨ç½²è§„æ¨¡ã€‚ é€‚ç”¨åœºæ™¯ï¼šæ•´åˆæ¶ˆæ¯é˜Ÿåˆ—+Nginxçš„æ¶æ„ä¸»è¦é€‚ç”¨äºç”Ÿäº§ç¯å¢ƒï¼Œç‰¹åˆ«æ˜¯éœ€è¦å¤„ç†å¤§æ•°æ®é‡çš„åœºæ™¯ã€‚å®ƒèƒ½å¤Ÿç¡®ä¿æ•°æ®çš„å®‰å…¨æ€§å’Œå®Œæ•´æ€§ï¼ŒåŒæ—¶æä¾›é«˜æ€§èƒ½çš„æ—¥å¿—å¤„ç†å’Œå¯è§†åŒ–åˆ†ææœåŠ¡ã€‚ æ€»ç»“æ¥è¯´å°±æ˜¯ filebeatå°†é‡‡é›†çš„æ—¥å¿—å‘é€åˆ°Redis\\RabbitMQ\\Kafkaç­‰ Logstashå†ä»Redis\\RabbitMQ\\Kafkaä¸­è¯»å–æ—¥å¿—æ•°æ®ï¼Œå¹¶è¿›è¡Œè§£æåå‘é€åˆ°ESä¸­ã€‚ ESé›†ç¾¤ä½¿ç”¨nginxè¿›è¡Œè´Ÿè½½å‡è¡¡ï¼Œä»¥å®ç°é«˜å¯ç”¨å’Œé«˜æ€§èƒ½ã€‚å…·ä½“å®ç°æ–¹æ³•æŸ¥çœ‹ï¼šlinuxä¸‹å®‰è£…Elasticsearché›†ç¾¤ åŸºäºRedisçš„ELKæ¶æ„ç¤ºä¾‹ filebeatå°†é‡‡é›†çš„æ—¥å¿—å‘é€åˆ°Redis åˆ›å»ºé…ç½®æ–‡ä»¶filebeat-nginx-to-redis.ymlï¼Œå°†å…¶ä¿å­˜åˆ°Filebeatå®‰è£…ç›®å½•ä¸‹çš„confç›®å½•ä¸‹ã€‚ 1234567891011121314151617181920212223242526# å› ä¸ºNginxçš„access.logæ—¥å¿—éƒ½æ˜¯ä»¥IPåœ°å€å¼€å¤´çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¿®æ”¹ä¸‹åŒ¹é…å­—æ®µã€‚# ä¸ä»¥ipåœ°å€å¼€å¤´çš„è¡Œè¿½åŠ åˆ°ä¸Šä¸€è¡Œfilebeat.inputs: # è¾“å…¥æºé…ç½®- type: log # æ—¥å¿—ç±»å‹ enabled: true # æ˜¯å¦å¯ç”¨ paths: # é‡‡é›†è·¯å¾„ - /var/log/nginx/access*.* exclude_files: [&quot;.gz$&quot;] # æ’é™¤ä»¥.gz ç»“å°¾çš„æ–‡ä»¶ multiline.pattern: &#x27;^\\\\d&#123;1,3&#125;\\\\.\\\\d&#123;1,3&#125;\\\\.\\\\d&#123;1,3&#125;\\\\.\\\\d&#123;1,3&#125;\\\\s&#x27; # åŒ¹é…ä»¥IPåœ°å€å¼€å¤´ï¼Œå¹¶ç´§è·Ÿä¸€ä¸ªç©ºç™½å­—ç¬¦ multiline.negate: true # ä¸ä»¥ipåœ°å€å¼€å¤´çš„è¡Œè¿½åŠ åˆ°ä¸Šä¸€è¡Œ multiline.match: after # è¿½åŠ åˆ°ä¸Šä¸€è¡Œçš„åé¢ # multiline: å¤šè¡Œæ—¥å¿—é…ç½®ï¼Œè¿™é‡Œå®é™…ä¸Šä¸éœ€è¦é…ç½®å¤šè¡Œè®¾ç½®ï¼Œå› ä¸ºnginxçš„accessæ—¥å¿—éƒ½æ˜¯å•è¡Œæ—¥å¿—ï¼Œè¿™é‡Œåªåšæ¼”ç¤º # pattern: æ­£åˆ™è¡¨è¾¾å¼ # negate: falseï¼ŒåŒ¹é…patternçš„è¡Œåˆå¹¶åˆ°ä¸Šä¸€è¡Œï¼›trueï¼Œä¸åŒ¹é…patternçš„è¡Œåˆå¹¶åˆ°ä¸Šä¸€è¡Œ # match: afterï¼Œåˆå¹¶åˆ°ä¸Šä¸€è¡Œçš„æœ«å°¾ï¼›beforeï¼Œåˆå¹¶åˆ°ä¸Šä¸€è¡Œçš„å¼€å¤´ scan_frequency: 10s # æ¯ 10 ç§’æ‰«æä¸€æ¬¡æ—¥å¿—æ–‡ä»¶ clean_removed: true # åœ¨æ—¥å¿—æ–‡ä»¶è¢«åˆ é™¤åæ˜¯å¦ä»å…¶å†…éƒ¨çŠ¶æ€ä¸­ç§»é™¤è¯¥æ–‡ä»¶çš„è®°å½• clean_inactive: 2h # åœ¨æ—¥å¿—æ–‡ä»¶å¤„äºéæ´»åŠ¨çŠ¶æ€å¤šé•¿æ—¶é—´åå°†å…¶ä»çŠ¶æ€æ•°æ®åº“ä¸­ç§»,è®¾ç½®ä¸ºæ¯” ignore_older + scan_frequency æ›´å¤§çš„å€¼ ignore_older: 1h # å¿½ç•¥é‚£äº›æ¯”å½“å‰æ—¶é—´æ—©äº 1 å°æ—¶çš„æ—¥å¿—æ–‡ä»¶output.redis: # Redisè¾“å‡ºé…ç½® hosts: [&quot;10.250.0.214:6379&quot;] # RedisæœåŠ¡å™¨åœ°å€ password: &quot;123456&quot; # Rediså¯†ç  key: &quot;filebeat_nginx&quot; # Redisçš„keyï¼Œç±»å‹ä¸º list db: 3 # Redisæ•°æ®åº“ timeout: 3 # Redisè¿æ¥è¶…æ—¶æ—¶é—´ï¼Œå•ä½ç§’ å¯åŠ¨Filebeatï¼Œå¹¶æŸ¥çœ‹æ—¥å¿—è¾“å‡ºã€‚ 1./filebeat -e -c conf/filebeat-nginx-to-redis.yml æŸ¥çœ‹Redisä¸­çš„æ•°æ® 1234567891011$ redis-cli -h 10.250.0.214 -p 6379 -a 12345610.250.0.214:6379&gt; select 3OK10.250.0.214:6379[3]&gt; keys filebeat*1) &quot;filebeat_nginx&quot;10.250.0.214:6379[3]&gt; type filebeat_nginxlist10.250.0.214:6379[3]&gt; LLEN filebeat_nginx(integer) 1410.250.0.214:6379[3]&gt; LINDEX filebeat_nginx 1&quot;&#123;\\&quot;@timestamp\\&quot;:\\&quot;2025-03-28T09:15:23.402Z\\&quot;,\\&quot;@metadata\\&quot;:&#123;\\&quot;beat\\&quot;:\\&quot;filebeat\\&quot;,\\&quot;type\\&quot;:\\&quot;_doc\\&quot;,\\&quot;version\\&quot;:\\&quot;8.17.3\\&quot;&#125;,\\&quot;host\\&quot;:&#123;\\&quot;name\\&quot;:\\&quot;ip-10-250-0-239.cn-northwest-1.compute.internal\\&quot;&#125;,\\&quot;agent\\&quot;:&#123;\\&quot;version\\&quot;:\\&quot;8.17.3\\&quot;,\\&quot;ephemeral_id\\&quot;:\\&quot;c0a521fe-690b-46b1-aadc-bbe16ef1db9a\\&quot;,\\&quot;id\\&quot;:\\&quot;4dbe185b-900d-4990-b841-c13bf9618fc6\\&quot;,\\&quot;name\\&quot;:\\&quot;ip-10-250-0-239.cn-northwest-1.compute.internal\\&quot;,\\&quot;type\\&quot;:\\&quot;filebeat\\&quot;&#125;,\\&quot;log\\&quot;:&#123;\\&quot;offset\\&quot;:46745,\\&quot;file\\&quot;:&#123;\\&quot;path\\&quot;:\\&quot;/var/log/nginx/access.log\\&quot;&#125;&#125;,\\&quot;message\\&quot;:\\&quot;1.119.161.30 - elastic [28/Mar/2025:09:15:13 +0000] \\\\\\&quot;GET /_cluster/stats HTTP/1.1\\\\\\&quot; 200 7457 \\\\\\&quot;-\\\\\\&quot; \\\\\\&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/134.0.0.0 Safari/537.36\\\\\\&quot; \\\\\\&quot;-\\\\\\&quot;\\&quot;,\\&quot;input\\&quot;:&#123;\\&quot;type\\&quot;:\\&quot;log\\&quot;&#125;,\\&quot;ecs\\&quot;:&#123;\\&quot;version\\&quot;:\\&quot;8.0.0\\&quot;&#125;&#125;&quot; Logstashä»Redisä¸­è¯»å–æ—¥å¿—å¹¶å†™å…¥Elasticsearch åˆ›å»ºé…ç½®æ–‡ä»¶logstash-nginx-redis-to-es.confï¼Œå°†å…¶ä¿å­˜åˆ°Logstashå®‰è£…ç›®å½•ä¸‹çš„confç›®å½•ä¸‹ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546# è¿›å…¥logstashå®‰è£…ç›®å½•# vim logstash-nginx-redis-to-es.conf# é…ç½®ä» redis æ¥æ”¶æ•°æ®input &#123; # è¾“å…¥æºé…ç½® redis &#123; # Redisè¾“å…¥é…ç½® host =&gt; &#x27;10.250.0.214&#x27; # RedisæœåŠ¡å™¨åœ°å€ port =&gt; &quot;6379&quot; # RedisæœåŠ¡å™¨ç«¯å£ password =&gt; &quot;123456&quot; # Rediså¯†ç  db =&gt; &quot;3&quot; # Redisæ•°æ®åº“ data_type =&gt; &#x27;list&#x27; # æ•°æ®ç±»å‹ä¸ºlist key =&gt; &quot;filebeat_nginx&quot; # Redisçš„key &#125;&#125;filter &#123; # è¿‡æ»¤å™¨é…ç½® grok &#123; match =&gt; &#123; &quot;message&quot; =&gt; &quot;%&#123;IP:client_ip&#125; - %&#123;USER:remote_user&#125; \\[%&#123;HTTPDATE:timestamp&#125;\\] \\&quot;%&#123;WORD:verb&#125; %&#123;URIPATHPARAM:request&#125; HTTP/%&#123;NUMBER:httpversion&#125;\\&quot; %&#123;INT:http_status&#125; %&#123;INT:body_bytes_sent&#125; \\&quot;%&#123;NOTSPACE:referrer&#125;\\&quot; \\&quot;%&#123;GREEDYDATA:agent&#125;\\&quot; %&#123;QUOTEDSTRING:x_forwarded_for&#125;&quot; &#125; &#125; mutate &#123; enable_metric =&gt; &quot;false&quot; # ç¦ç”¨æŒ‡æ ‡ä¸ŠæŠ¥ remove_field =&gt; [&quot;message&quot;, &quot;log&quot;, &quot;tags&quot;, &quot;input&quot;, &quot;agent&quot;, &quot;host&quot;, &quot;ecs&quot;, &quot;@version&quot;] # ç§»é™¤ä¸éœ€è¦çš„å­—æ®µ &#125; date &#123; match =&gt; [&quot;timestamp&quot;,&quot;dd/MMM/yyyy:HH:mm:ss Z&quot;,&quot;yyyy-MM-dd HH:mm:ss&quot;] # æ—¶é—´æ ¼å¼è½¬æ¢ target =&gt; &quot;timestamp&quot; # ç›®æ ‡å­—æ®µ &#125;&#125;# åœ¨è¾“å‡ºé…ç½®ä¸­æ·»åŠ ESè¾“å‡ºé…ç½®output &#123; # è¾“å‡ºé…ç½® stdout &#123; # æ‰“å°åˆ°æ§åˆ¶å° codec =&gt; rubydebug # æŒ‡å®šç¼–ç å™¨ &#125; elasticsearch &#123; # è¾“å‡ºåˆ°ES index =&gt; &quot;redis_nginx_access_log_%&#123;+YYYY-MM&#125;&quot; # ç´¢å¼•å,æŒ‰æœˆåˆ†éš” hosts =&gt; [&quot;https://10.250.0.239:9200&quot;] # ESåœ°å€ user =&gt; &quot;elastic&quot; # ESç”¨æˆ·å password =&gt; &quot;123456&quot; # ESå¯†ç  ssl =&gt; true # æ˜¯å¦å¯ç”¨SSLï¼Œå› ä¸ºè¿™é‡Œæ˜¯httpsè®¿é—®ES ssl_certificate_verification =&gt; false # ç¦ç”¨è¯ä¹¦éªŒè¯ &#125;&#125; æµ‹è¯•logstashé…ç½®æ˜¯å¦æ­£ç¡® 1bin/logstash -f config/logstash-nginx-redis-to-es.conf --config.test_and_exit å¯åŠ¨logstash 12# reload.automaticï¼šä¿®æ”¹é…ç½®æ–‡ä»¶æ—¶è‡ªåŠ¨é‡æ–°åŠ è½½bin/logstash -f config/logstash-nginx-redis-to-es.conf --config.reload.automatic","summary":"æ‘˜è¦ æœ¬æ–‡ä»‹ç»å¦‚ä½•åœ¨linuxä¸‹å®‰è£…LogStashå’ŒFileBeat é€šè¿‡ç¤ºä¾‹è®²è§£ELKçš„ç»å…¸æ¶æ„å’Œé«˜å¹¶å‘æ¶æ„çš„å®ç°è¿‡ç¨‹ LogStashç‰ˆæœ¬8.17.3ï¼ŒFileBeatç‰ˆæœ¬8.17.3 Elasticsearchç‰ˆæœ¬8.17.3ï¼Œlinuxä¸‹å®‰è£…Elasticsearch Kibanaç‰ˆæœ¬8.17.3ï¼Œlinuxä¸‹å®‰è£…Kibana Elasticsearché›†ç¾¤æ­å»ºï¼Œlinuxä¸‹å®‰è£…Elasticsearché›†ç¾¤","date_published":"2025-03-27T13:30:05.000Z","tags":["æŠ€æœ¯","elastic","kibana","logstash","elasticsearch","kibana","logstash"]},{"id":"https://blog.hanqunfeng.com/2025/03/25/elasticsearch-03-plugins/","url":"https://blog.hanqunfeng.com/2025/03/25/elasticsearch-03-plugins/","title":"linuxä¸‹Elasticsearchæ’ä»¶å®‰è£…","content_html":"<!--\n **åŠ ç²—**\n *æ–œä½“*\n ***åŠ ç²—å¹¶æ–œä½“***\n ~~åˆ é™¤çº¿~~\n ==çªå‡ºæ˜¾ç¤º==\n `çªå‡ºæ˜¾ç¤º(æ¨è)`\n ++ä¸‹åˆ’çº¿++\n ~ä¸‹æ ‡~\n ^ä¸Šæ ‡^\n è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference.\n å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)\n\n +++ **ç‚¹å‡»æŠ˜å **\n è¿™æ˜¯è¢«éšè—çš„å†…å®¹\n +++\n\n::: tips success warning danger\nè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹\n:::\n\n% note info % success warning danger\nè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹\n% endnote %\n\nå¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{}\n å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ\n -->\n<h2 id=\"æ‘˜è¦\">æ‘˜è¦</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æœ¬æ–‡ä»‹ç»å¦‚ä½•åœ¨linuxä¸ºElasticsearchå®‰è£…æ’ä»¶</p>\n</li>\n<li class=\"lvl-2\">\n<p>Elasticsearchç‰ˆæœ¬8.17.3</p>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"å®‰è£…Elasticsearchæ ¸å¿ƒåº“æ’ä»¶\">å®‰è£…Elasticsearchæ ¸å¿ƒåº“æ’ä»¶</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ä»¥å®‰è£… <code>analysis-icu</code> è¿™ä¸ªåˆ†è¯æ’ä»¶ä¸ºä¾‹</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># è¿›å…¥Elasticsearchå®‰è£…ç›®å½•ï¼Œæ’ä»¶çš„å®‰è£…è·¯å¾„åœ¨ plugins ç›®å½•ä¸‹</span></span><br><span class=\"line\"><span class=\"comment\"># å®‰è£…æ’ä»¶</span></span><br><span class=\"line\">bin/elasticsearch-plugin install analysis-icu</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å®‰è£…æˆ–å¸è½½æ’ä»¶åï¼Œéœ€è¦é‡å¯ElasticsearchæœåŠ¡</p>\n</li>\n</ul>\n<h2 id=\"å®‰è£…å…¶å®ƒæ¥æºçš„æ’ä»¶\">å®‰è£…å…¶å®ƒæ¥æºçš„æ’ä»¶</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ä»¥å®‰è£… <code>analysis-ik</code> è¿™ä¸ªä¸­æ–‡åˆ†è¯æ’ä»¶ä¸ºä¾‹</p>\n</li>\n<li class=\"lvl-2\">\n<p>ä»<a href=\"https://release.infinilabs.com/analysis-ik/stable/\">https://release.infinilabs.com/analysis-ik/stable/</a>æ‰¾åˆ°å¯¹åº”ç‰ˆæœ¬çš„æ’ä»¶è¿æ¥ï¼Œè¿™é‡Œä»¥<code>8.17.3</code>ä¸ºä¾‹</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.åŸºäºurlå®‰è£…æ’ä»¶</span></span><br><span class=\"line\">bin/elasticsearch-plugin install https://release.infinilabs.com/analysis-ik/stable/elasticsearch-analysis-ik-8.17.3.zip</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.åŸºäºæœ¬åœ°æ–‡ä»¶å®‰è£…æ’ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆå°†æ’ä»¶ä¸‹è½½çš„æœ¬åœ°ç›®å½•</span></span><br><span class=\"line\">wget https://release.infinilabs.com/analysis-ik/stable/elasticsearch-analysis-ik-8.17.3.zip -P /tmp/</span><br><span class=\"line\">bin/elasticsearch-plugin install file:///tmp/elasticsearch-analysis-ik-8.17.3.zip</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3.å¯ä»¥å°†ä¸‹è½½å¥½çš„åŒ…è§£å‹åˆ°pluginsç›®å½•ä¸‹ï¼Œç„¶åé‡å¯ElasticsearchæœåŠ¡</span></span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> /usr/local/elasticsearch/elasticsearch-8.17.3/plugins/analysis-ik</span><br><span class=\"line\">unzip elasticsearch-analysis-ik-8.17.3.zip -d /usr/local/elasticsearch/elasticsearch-8.17.3/plugins/analysis-ik</span><br></pre></td></tr></table></figure>\n<h2 id=\"æŸ¥çœ‹å’Œå¸è½½æ’ä»¶\">æŸ¥çœ‹å’Œå¸è½½æ’ä»¶</h2>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># åˆ—å‡ºæ‰€æœ‰æ’ä»¶</span></span><br><span class=\"line\">bin/elasticsearch-plugin list</span><br><span class=\"line\"><span class=\"comment\"># å¸è½½æ’ä»¶</span></span><br><span class=\"line\">bin/elasticsearch-plugin remove analysis-ik</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># é€šè¿‡curlå‘½ä»¤æŸ¥çœ‹æ’ä»¶ä¿¡æ¯</span></span><br><span class=\"line\">curl -u elastic:123456 -k https://localhost:9200/_cat/plugins?v</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å®‰è£…æˆ–å¸è½½æ’ä»¶åï¼Œéœ€è¦é‡å¯ElasticsearchæœåŠ¡</p>\n</li>\n</ul>\n<h2 id=\"analysis-ik-ä¸­æ–‡åˆ†è¯æ’ä»¶çš„ä½¿ç”¨\"><code>analysis-ik</code> ä¸­æ–‡åˆ†è¯æ’ä»¶çš„ä½¿ç”¨</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æµ‹è¯•åˆ†è¯æ•ˆæœ</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#ESçš„é»˜è®¤åˆ†è¯å™¨æ˜¯standardï¼Œä¼šå•å­—æ‹†åˆ†</span></span><br><span class=\"line\">POST _analyze</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;analyzer&quot;</span>: <span class=\"string\">&quot;standard&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;text&quot;</span>: <span class=\"string\">&quot;ä¸­åäººæ°‘å…±å’Œå›½&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#analysis-ikçš„ik_smartåˆ†è¯å™¨:ä¼šåšæœ€ç²—ç²’åº¦çš„æ‹†</span></span><br><span class=\"line\">POST _analyze</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;analyzer&quot;</span>: <span class=\"string\">&quot;ik_smart&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;text&quot;</span>: <span class=\"string\">&quot;ä¸­åäººæ°‘å…±å’Œå›½&quot;</span></span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#analysis-ikçš„ik_max_wordåˆ†è¯å™¨:ä¼šå°†æ–‡æœ¬åšæœ€ç»†ç²’åº¦çš„æ‹†åˆ†</span></span><br><span class=\"line\">POST _analyze</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;analyzer&quot;</span>: <span class=\"string\">&quot;ik_max_word&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;text&quot;</span>: <span class=\"string\">&quot;ä¸­åäººæ°‘å…±å’Œå›½&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>é…ç½®ç´¢å¼•çš„åˆ†è¯å™¨</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># åˆ›å»ºç´¢å¼•ï¼Œå¹¶æŒ‡å®šé»˜è®¤åˆ†è¯å™¨ä¸ºik_max_word</span></span><br><span class=\"line\">PUT /test_index</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;settings&quot;</span> : &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;index&quot;</span> : &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;analysis.analyzer.default.type&quot;</span>: <span class=\"string\">&quot;ik_max_word&quot;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹ç´¢å¼•settingä¿¡æ¯</span></span><br><span class=\"line\">GET /test_index/_settings</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>é…ç½®ç´¢å¼•å­—æ®µçš„åˆ†è¯å™¨</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#åˆ›å»ºç´¢å¼•</span></span><br><span class=\"line\">PUT /index</span><br><span class=\"line\"><span class=\"comment\"># æŒ‡å®šcontentå­—æ®µä½¿ç”¨ikåˆ†è¯å™¨</span></span><br><span class=\"line\">POST /index/_mapping</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;properties&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;content&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;type&quot;</span>: <span class=\"string\">&quot;text&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;analyzer&quot;</span>: <span class=\"string\">&quot;ik_max_word&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;search_analyzer&quot;</span>: <span class=\"string\">&quot;ik_smart&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#ç´¢å¼•æ–‡æ¡£ï¼Œä¹Ÿå°±æ˜¯æ’å…¥æ–‡æ¡£</span></span><br><span class=\"line\">POST /index/_create/1</span><br><span class=\"line\">&#123;<span class=\"string\">&quot;content&quot;</span>:<span class=\"string\">&quot;ç¾å›½ç•™ç»™ä¼Šæ‹‰å…‹çš„æ˜¯ä¸ªçƒ‚æ‘Šå­å—&quot;</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST /index/_create/2</span><br><span class=\"line\">&#123;<span class=\"string\">&quot;content&quot;</span>:<span class=\"string\">&quot;å…¬å®‰éƒ¨ï¼šå„åœ°æ ¡è½¦å°†äº«æœ€é«˜è·¯æƒ&quot;</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST /index/_create/3</span><br><span class=\"line\">&#123;<span class=\"string\">&quot;content&quot;</span>:<span class=\"string\">&quot;ä¸­éŸ©æ¸”è­¦å†²çªè°ƒæŸ¥ï¼šéŸ©è­¦å¹³å‡æ¯å¤©æ‰£1è‰˜ä¸­å›½æ¸”èˆ¹&quot;</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST /index/_create/4</span><br><span class=\"line\">&#123;<span class=\"string\">&quot;content&quot;</span>:<span class=\"string\">&quot;ä¸­å›½é©»æ´›æ‰çŸ¶é¢†äº‹é¦†é­äºšè£”ç”·å­æªå‡» å«ŒçŠ¯å·²è‡ªé¦–&quot;</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#å¸¦é«˜äº®çš„æŸ¥è¯¢</span></span><br><span class=\"line\">POST /index/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;query&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;match&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;content&quot;</span>: <span class=\"string\">&quot;ä¸­å›½&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;highlight&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;pre_tags&quot;</span>: [</span><br><span class=\"line\">      <span class=\"string\">&quot;&lt;tag1&gt;&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;&lt;tag2&gt;&quot;</span></span><br><span class=\"line\">    ],</span><br><span class=\"line\">    <span class=\"string\">&quot;post_tags&quot;</span>: [</span><br><span class=\"line\">      <span class=\"string\">&quot;&lt;/tag1&gt;&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;&lt;/tag2&gt;&quot;</span></span><br><span class=\"line\">    ],</span><br><span class=\"line\">    <span class=\"string\">&quot;fields&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;content&quot;</span>: &#123;&#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n","content_text":"æ‘˜è¦ æœ¬æ–‡ä»‹ç»å¦‚ä½•åœ¨linuxä¸ºElasticsearchå®‰è£…æ’ä»¶ Elasticsearchç‰ˆæœ¬8.17.3 å®‰è£…Elasticsearchæ ¸å¿ƒåº“æ’ä»¶ ä»¥å®‰è£… analysis-icu è¿™ä¸ªåˆ†è¯æ’ä»¶ä¸ºä¾‹ 123# è¿›å…¥Elasticsearchå®‰è£…ç›®å½•ï¼Œæ’ä»¶çš„å®‰è£…è·¯å¾„åœ¨ plugins ç›®å½•ä¸‹# å®‰è£…æ’ä»¶bin/elasticsearch-plugin install analysis-icu å®‰è£…æˆ–å¸è½½æ’ä»¶åï¼Œéœ€è¦é‡å¯ElasticsearchæœåŠ¡ å®‰è£…å…¶å®ƒæ¥æºçš„æ’ä»¶ ä»¥å®‰è£… analysis-ik è¿™ä¸ªä¸­æ–‡åˆ†è¯æ’ä»¶ä¸ºä¾‹ ä»https://release.infinilabs.com/analysis-ik/stable/æ‰¾åˆ°å¯¹åº”ç‰ˆæœ¬çš„æ’ä»¶è¿æ¥ï¼Œè¿™é‡Œä»¥8.17.3ä¸ºä¾‹ 12345678910# 1.åŸºäºurlå®‰è£…æ’ä»¶bin/elasticsearch-plugin install https://release.infinilabs.com/analysis-ik/stable/elasticsearch-analysis-ik-8.17.3.zip# 2.åŸºäºæœ¬åœ°æ–‡ä»¶å®‰è£…æ’ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆå°†æ’ä»¶ä¸‹è½½çš„æœ¬åœ°ç›®å½•wget https://release.infinilabs.com/analysis-ik/stable/elasticsearch-analysis-ik-8.17.3.zip -P /tmp/bin/elasticsearch-plugin install file:///tmp/elasticsearch-analysis-ik-8.17.3.zip# 3.å¯ä»¥å°†ä¸‹è½½å¥½çš„åŒ…è§£å‹åˆ°pluginsç›®å½•ä¸‹ï¼Œç„¶åé‡å¯ElasticsearchæœåŠ¡mkdir /usr/local/elasticsearch/elasticsearch-8.17.3/plugins/analysis-ikunzip elasticsearch-analysis-ik-8.17.3.zip -d /usr/local/elasticsearch/elasticsearch-8.17.3/plugins/analysis-ik æŸ¥çœ‹å’Œå¸è½½æ’ä»¶ 1234567# åˆ—å‡ºæ‰€æœ‰æ’ä»¶bin/elasticsearch-plugin list# å¸è½½æ’ä»¶bin/elasticsearch-plugin remove analysis-ik# é€šè¿‡curlå‘½ä»¤æŸ¥çœ‹æ’ä»¶ä¿¡æ¯curl -u elastic:123456 -k https://localhost:9200/_cat/plugins?v å®‰è£…æˆ–å¸è½½æ’ä»¶åï¼Œéœ€è¦é‡å¯ElasticsearchæœåŠ¡ analysis-ik ä¸­æ–‡åˆ†è¯æ’ä»¶çš„ä½¿ç”¨ æµ‹è¯•åˆ†è¯æ•ˆæœ 1234567891011121314151617181920#ESçš„é»˜è®¤åˆ†è¯å™¨æ˜¯standardï¼Œä¼šå•å­—æ‹†åˆ†POST _analyze&#123; &quot;analyzer&quot;: &quot;standard&quot;, &quot;text&quot;: &quot;ä¸­åäººæ°‘å…±å’Œå›½&quot;&#125;#analysis-ikçš„ik_smartåˆ†è¯å™¨:ä¼šåšæœ€ç²—ç²’åº¦çš„æ‹†POST _analyze&#123; &quot;analyzer&quot;: &quot;ik_smart&quot;, &quot;text&quot;: &quot;ä¸­åäººæ°‘å…±å’Œå›½&quot; &#125;#analysis-ikçš„ik_max_wordåˆ†è¯å™¨:ä¼šå°†æ–‡æœ¬åšæœ€ç»†ç²’åº¦çš„æ‹†åˆ†POST _analyze&#123; &quot;analyzer&quot;: &quot;ik_max_word&quot;, &quot;text&quot;: &quot;ä¸­åäººæ°‘å…±å’Œå›½&quot;&#125; é…ç½®ç´¢å¼•çš„åˆ†è¯å™¨ 1234567891011# åˆ›å»ºç´¢å¼•ï¼Œå¹¶æŒ‡å®šé»˜è®¤åˆ†è¯å™¨ä¸ºik_max_wordPUT /test_index&#123; &quot;settings&quot; : &#123; &quot;index&quot; : &#123; &quot;analysis.analyzer.default.type&quot;: &quot;ik_max_word&quot; &#125; &#125;&#125;# æŸ¥çœ‹ç´¢å¼•settingä¿¡æ¯GET /test_index/_settings é…ç½®ç´¢å¼•å­—æ®µçš„åˆ†è¯å™¨ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849#åˆ›å»ºç´¢å¼•PUT /index# æŒ‡å®šcontentå­—æ®µä½¿ç”¨ikåˆ†è¯å™¨POST /index/_mapping&#123; &quot;properties&quot;: &#123; &quot;content&quot;: &#123; &quot;type&quot;: &quot;text&quot;, &quot;analyzer&quot;: &quot;ik_max_word&quot;, &quot;search_analyzer&quot;: &quot;ik_smart&quot; &#125; &#125;&#125;#ç´¢å¼•æ–‡æ¡£ï¼Œä¹Ÿå°±æ˜¯æ’å…¥æ–‡æ¡£POST /index/_create/1&#123;&quot;content&quot;:&quot;ç¾å›½ç•™ç»™ä¼Šæ‹‰å…‹çš„æ˜¯ä¸ªçƒ‚æ‘Šå­å—&quot;&#125;POST /index/_create/2&#123;&quot;content&quot;:&quot;å…¬å®‰éƒ¨ï¼šå„åœ°æ ¡è½¦å°†äº«æœ€é«˜è·¯æƒ&quot;&#125;POST /index/_create/3&#123;&quot;content&quot;:&quot;ä¸­éŸ©æ¸”è­¦å†²çªè°ƒæŸ¥ï¼šéŸ©è­¦å¹³å‡æ¯å¤©æ‰£1è‰˜ä¸­å›½æ¸”èˆ¹&quot;&#125;POST /index/_create/4&#123;&quot;content&quot;:&quot;ä¸­å›½é©»æ´›æ‰çŸ¶é¢†äº‹é¦†é­äºšè£”ç”·å­æªå‡» å«ŒçŠ¯å·²è‡ªé¦–&quot;&#125;#å¸¦é«˜äº®çš„æŸ¥è¯¢POST /index/_search&#123; &quot;query&quot;: &#123; &quot;match&quot;: &#123; &quot;content&quot;: &quot;ä¸­å›½&quot; &#125; &#125;, &quot;highlight&quot;: &#123; &quot;pre_tags&quot;: [ &quot;&lt;tag1&gt;&quot;, &quot;&lt;tag2&gt;&quot; ], &quot;post_tags&quot;: [ &quot;&lt;/tag1&gt;&quot;, &quot;&lt;/tag2&gt;&quot; ], &quot;fields&quot;: &#123; &quot;content&quot;: &#123;&#125; &#125; &#125;&#125;","summary":"æ‘˜è¦ æœ¬æ–‡ä»‹ç»å¦‚ä½•åœ¨linuxä¸ºElasticsearchå®‰è£…æ’ä»¶ Elasticsearchç‰ˆæœ¬8.17.3","date_published":"2025-03-25T13:30:05.000Z","tags":["æŠ€æœ¯","elastic","elasticsearch","elasticsearch"]},{"id":"https://blog.hanqunfeng.com/2025/03/24/elasticsearch-02-install-cluster/","url":"https://blog.hanqunfeng.com/2025/03/24/elasticsearch-02-install-cluster/","title":"linuxä¸‹å®‰è£…Elasticsearché›†ç¾¤","content_html":"<!--\n **åŠ ç²—**\n *æ–œä½“*\n ***åŠ ç²—å¹¶æ–œä½“***\n ~~åˆ é™¤çº¿~~\n ==çªå‡ºæ˜¾ç¤º==\n `çªå‡ºæ˜¾ç¤º(æ¨è)`\n ++ä¸‹åˆ’çº¿++\n ~ä¸‹æ ‡~\n ^ä¸Šæ ‡^\n è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference.\n å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)\n\n +++ **ç‚¹å‡»æŠ˜å **\n è¿™æ˜¯è¢«éšè—çš„å†…å®¹\n +++\n\n::: tips success warning danger\nè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹\n:::\n\n% note info % success warning danger\nè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹\n% endnote %\n\nå¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{}\n å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ\n -->\n<h2 id=\"æ‘˜è¦\">æ‘˜è¦</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>æœ¬æ–‡ä»‹ç»å¦‚ä½•åœ¨linuxä¸‹å®‰è£…Elasticsearché›†ç¾¤(ä¸‰èŠ‚ç‚¹)</p>\n</li>\n<li class=\"lvl-2\">\n<p>Elasticsearchç‰ˆæœ¬8.17.3</p>\n</li>\n<li class=\"lvl-2\">\n<p>å•èŠ‚ç‚¹å®‰è£…å‚è€ƒ<a href=\"/2025/03/20/elasticsearch-01-install/\" title=\"linuxä¸‹å®‰è£…Elasticsearch\">linuxä¸‹å®‰è£…Elasticsearch</a>ï¼Œæœ¬æ–‡åœ¨æ­¤åŸºç¡€ä¸Šå®Œæˆé›†ç¾¤å®‰è£…</p>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"é›†ç¾¤å®‰è£…\">é›†ç¾¤å®‰è£…</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ä¸‰ä¸ªèŠ‚ç‚¹åˆ†åˆ«å®‰ç…§å•èŠ‚ç‚¹çš„å®‰è£…æ–¹å¼å®Œæˆä¸‹è½½ï¼Œç”¨æˆ·é…ç½®ï¼Œç¯å¢ƒå˜é‡é…ç½®ï¼Œç³»ç»Ÿå‚æ•°é…ç½®ï¼Œç­‰ç­‰ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>ä»»é€‰ä¸€ä¸ªèŠ‚ç‚¹ä½œä¸ºé›†ç¾¤çš„masterèŠ‚ç‚¹ï¼Œæˆ‘ä»¬å‘½åä¸º<code>node-1</code>ï¼Œå…¶å®ƒèŠ‚ç‚¹å‘½åä¸º<code>node-2</code>å’Œ<code>node-3</code></p>\n</li>\n<li class=\"lvl-2\">\n<p>å…ˆé…ç½®<code>node-1</code>èŠ‚ç‚¹çš„é…ç½®æ–‡ä»¶</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># é›†ç¾¤åç§°</span></span><br><span class=\"line\">cluster.name: test-elk</span><br><span class=\"line\"><span class=\"comment\"># èŠ‚ç‚¹åç§°</span></span><br><span class=\"line\">node.name: node-1</span><br><span class=\"line\"><span class=\"comment\"># æ•°æ®å­˜å‚¨è·¯å¾„ï¼Œé»˜è®¤å€¼ $ES_HOME/data</span></span><br><span class=\"line\">path.data: /usr/local/elasticsearch/data</span><br><span class=\"line\"><span class=\"comment\"># æ—¥å¿—å­˜å‚¨è·¯å¾„ï¼Œé»˜è®¤å€¼ $ES_HOME/logs</span></span><br><span class=\"line\">path.logs: /usr/local/elasticsearch/logs</span><br><span class=\"line\"><span class=\"comment\"># é…ç½®ESå¯åŠ¨æ—¶æ˜¯å¦è¿›è¡Œå†…å­˜é”å®šæ£€æŸ¥ï¼Œé»˜è®¤å€¼trueï¼Œæœ¬æœºå†…å­˜æ¯”è¾ƒå°æ—¶è®¾ç½®ä¸ºfalse</span></span><br><span class=\"line\">bootstrap.memory_lock: <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"comment\"># å…è®¸é€šè¿‡ä»»ä½•åœ°å€è®¿é—®ï¼Œå¼€å¯è¿œç¨‹è®¿é—®</span></span><br><span class=\"line\">network.host: 0.0.0.0</span><br><span class=\"line\"><span class=\"comment\"># é…ç½®å½“å‰ESèŠ‚ç‚¹å¯¹å¤–æä¾›æœåŠ¡çš„httpç«¯å£ï¼Œé»˜è®¤ 9200</span></span><br><span class=\"line\">http.port: 9200</span><br><span class=\"line\"><span class=\"comment\"># é…ç½®å½“å‰ESèŠ‚ç‚¹å¯¹å¤–æä¾›æœåŠ¡çš„tcpç«¯å£ï¼Œé»˜è®¤ 9300</span></span><br><span class=\"line\">transport.port: 9300</span><br><span class=\"line\"><span class=\"comment\"># é›†ç¾¤å†…çš„ä¸»æœºåˆ—è¡¨ï¼Œå¼€å¯å®‰å…¨è®¤è¯æ—¶æ— éœ€é…ç½®ï¼Œæ³¨æ„è¿™é‡Œä¸è¦è¿›è¡Œé…ç½®</span></span><br><span class=\"line\"><span class=\"comment\"># discovery.seed_hosts: [&quot;127.0.0.1&quot;]</span></span><br><span class=\"line\"><span class=\"comment\"># ç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶éœ€è¦å‚ä¸é€‰ä¸»çš„èŠ‚ç‚¹åç§°ï¼Œè¿™é‡Œåªé…ç½®node-1</span></span><br><span class=\"line\">cluster.initial_master_nodes: [<span class=\"string\">&quot;node-1&quot;</span>]</span><br><span class=\"line\"><span class=\"comment\">#è§£å†³è·¨åŸŸé—®é¢˜</span></span><br><span class=\"line\">http.cors.enabled: <span class=\"literal\">true</span></span><br><span class=\"line\">http.cors.allow-origin: <span class=\"string\">&quot;*&quot;</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>é…ç½®<code>node-2</code>èŠ‚ç‚¹çš„é…ç½®æ–‡ä»¶</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># é›†ç¾¤åç§°</span></span><br><span class=\"line\">cluster.name: test-elk</span><br><span class=\"line\"><span class=\"comment\"># èŠ‚ç‚¹åç§°</span></span><br><span class=\"line\">node.name: node-2</span><br><span class=\"line\"><span class=\"comment\"># æ•°æ®å­˜å‚¨è·¯å¾„ï¼Œé»˜è®¤å€¼ $ES_HOME/data</span></span><br><span class=\"line\">path.data: /usr/local/elasticsearch/data</span><br><span class=\"line\"><span class=\"comment\"># æ—¥å¿—å­˜å‚¨è·¯å¾„ï¼Œé»˜è®¤å€¼ $ES_HOME/logs</span></span><br><span class=\"line\">path.logs: /usr/local/elasticsearch/logs</span><br><span class=\"line\"><span class=\"comment\"># é…ç½®ESå¯åŠ¨æ—¶æ˜¯å¦è¿›è¡Œå†…å­˜é”å®šæ£€æŸ¥ï¼Œé»˜è®¤å€¼trueï¼Œæœ¬æœºå†…å­˜æ¯”è¾ƒå°æ—¶è®¾ç½®ä¸ºfalse</span></span><br><span class=\"line\">bootstrap.memory_lock: <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"comment\"># å…è®¸é€šè¿‡ä»»ä½•åœ°å€è®¿é—®ï¼Œå¼€å¯è¿œç¨‹è®¿é—®</span></span><br><span class=\"line\">network.host: 0.0.0.0</span><br><span class=\"line\"><span class=\"comment\"># é…ç½®å½“å‰ESèŠ‚ç‚¹å¯¹å¤–æä¾›æœåŠ¡çš„httpç«¯å£ï¼Œé»˜è®¤ 9200</span></span><br><span class=\"line\">http.port: 9200</span><br><span class=\"line\"><span class=\"comment\"># é…ç½®å½“å‰ESèŠ‚ç‚¹å¯¹å¤–æä¾›æœåŠ¡çš„tcpç«¯å£ï¼Œé»˜è®¤ 9300</span></span><br><span class=\"line\">transport.port: 9300</span><br><span class=\"line\"><span class=\"comment\">#è§£å†³è·¨åŸŸé—®é¢˜</span></span><br><span class=\"line\">http.cors.enabled: <span class=\"literal\">true</span></span><br><span class=\"line\">http.cors.allow-origin: <span class=\"string\">&quot;*&quot;</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>é…ç½®<code>node-3</code>èŠ‚ç‚¹çš„é…ç½®æ–‡ä»¶</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># é›†ç¾¤åç§°</span></span><br><span class=\"line\">cluster.name: test-elk</span><br><span class=\"line\"><span class=\"comment\"># èŠ‚ç‚¹åç§°</span></span><br><span class=\"line\">node.name: node-3</span><br><span class=\"line\"><span class=\"comment\"># æ•°æ®å­˜å‚¨è·¯å¾„ï¼Œé»˜è®¤å€¼ $ES_HOME/data</span></span><br><span class=\"line\">path.data: /usr/local/elasticsearch/data</span><br><span class=\"line\"><span class=\"comment\"># æ—¥å¿—å­˜å‚¨è·¯å¾„ï¼Œé»˜è®¤å€¼ $ES_HOME/logs</span></span><br><span class=\"line\">path.logs: /usr/local/elasticsearch/logs</span><br><span class=\"line\"><span class=\"comment\"># é…ç½®ESå¯åŠ¨æ—¶æ˜¯å¦è¿›è¡Œå†…å­˜é”å®šæ£€æŸ¥ï¼Œé»˜è®¤å€¼trueï¼Œæœ¬æœºå†…å­˜æ¯”è¾ƒå°æ—¶è®¾ç½®ä¸ºfalse</span></span><br><span class=\"line\">bootstrap.memory_lock: <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"comment\"># å…è®¸é€šè¿‡ä»»ä½•åœ°å€è®¿é—®ï¼Œå¼€å¯è¿œç¨‹è®¿é—®</span></span><br><span class=\"line\">network.host: 0.0.0.0</span><br><span class=\"line\"><span class=\"comment\"># é…ç½®å½“å‰ESèŠ‚ç‚¹å¯¹å¤–æä¾›æœåŠ¡çš„httpç«¯å£ï¼Œé»˜è®¤ 9200</span></span><br><span class=\"line\">http.port: 9200</span><br><span class=\"line\"><span class=\"comment\"># é…ç½®å½“å‰ESèŠ‚ç‚¹å¯¹å¤–æä¾›æœåŠ¡çš„tcpç«¯å£ï¼Œé»˜è®¤ 9300</span></span><br><span class=\"line\">transport.port: 9300</span><br><span class=\"line\"><span class=\"comment\">#è§£å†³è·¨åŸŸé—®é¢˜</span></span><br><span class=\"line\">http.cors.enabled: <span class=\"literal\">true</span></span><br><span class=\"line\">http.cors.allow-origin: <span class=\"string\">&quot;*&quot;</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å¯åŠ¨<code>node-1</code>ï¼Œå¯åŠ¨æˆåŠŸåæˆ‘ä»¬ä¼šåœ¨æ—¥å¿—ä¸­çœ‹åˆ°å¦‚ä¸‹å®‰å…¨è®¤è¯ä¿¡æ¯ä¿¡æ¯ï¼Œè®°å½•å…¶ä¸­çš„åŠ å…¥é›†ç¾¤çš„èŠ‚ç‚¹çš„tokenä¿¡æ¯</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”</span><br><span class=\"line\"><span class=\"comment\"># è¿™äº›æ—¥å¿—ä¿¡æ¯æä¾›äº† Elasticsearch 8 åœ¨é¦–æ¬¡å¯åŠ¨æ—¶è‡ªåŠ¨é…ç½®çš„å®‰å…¨ç‰¹æ€§ã€ç”Ÿæˆçš„é»˜è®¤å¯†ç ã€è¯ä¹¦æŒ‡çº¹ä»¥åŠå¦‚ä½•é…ç½® Kibana å’Œå…¶ä»–èŠ‚ç‚¹åŠ å…¥é›†ç¾¤çš„è¯¦ç»†è¯´æ˜ã€‚</span></span><br><span class=\"line\">âœ… Elasticsearch security features have been automatically configured!</span><br><span class=\"line\">âœ… Authentication is enabled and cluster connections are encrypted.</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># è¿™æ˜¯ elastic ç”¨æˆ·çš„é»˜è®¤å¯†ç ã€‚ç³»ç»Ÿå»ºè®®ä½ ä½¿ç”¨ bin/elasticsearch-reset-password -u elastic å‘½ä»¤æ¥é‡ç½®æ­¤å¯†ç ã€‚</span></span><br><span class=\"line\">â„¹ï¸  Password <span class=\"keyword\">for</span> the elastic user (reset with `bin/elasticsearch-reset-password -u elastic`):</span><br><span class=\"line\">  BNb=*qz6_M*mXL9uZiSP <span class=\"comment\"># è¿™é‡Œä¼šæ‰“å°å‡ºESè‡ªåŠ¨ç”Ÿæˆçš„å¯†ç </span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># è¿™æ˜¯ HTTP CA è¯ä¹¦çš„ SHA-256 æŒ‡çº¹ã€‚CA è¯ä¹¦ç”¨äºéªŒè¯ HTTPS è¿æ¥çš„èº«ä»½ã€‚</span></span><br><span class=\"line\">â„¹ï¸  HTTP CA certificate SHA-256 fingerprint:</span><br><span class=\"line\">  3f141c16dfc6e165894bc1672084b220dcdd22ffe02116d51ac18003cfaa5a1d</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æä¾›äº†å°† Kibana é…ç½®ä¸ºä½¿ç”¨æ­¤ Elasticsearch é›†ç¾¤çš„æ­¥éª¤ã€‚</span></span><br><span class=\"line\">â„¹ï¸  Configure Kibana to use this cluster:</span><br><span class=\"line\"><span class=\"comment\"># å¯åŠ¨ Kibana å¹¶æŒ‰ç…§ç»ˆç«¯ä¸­æ˜¾ç¤ºçš„é…ç½®é“¾æ¥è¿›è¡Œæ“ä½œã€‚</span></span><br><span class=\"line\">â€¢ Run Kibana and click the configuration <span class=\"built_in\">link</span> <span class=\"keyword\">in</span> the terminal when Kibana starts.</span><br><span class=\"line\"><span class=\"comment\"># å¤åˆ¶æä¾›çš„æ³¨å†Œä»¤ç‰Œï¼Œå¹¶åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ Kibana æ—¶ç²˜è´´æ­¤ä»¤ç‰Œã€‚ä»¤ç‰Œåœ¨æ¥ä¸‹æ¥çš„ 30 åˆ†é’Ÿå†…æœ‰æ•ˆã€‚</span></span><br><span class=\"line\"><span class=\"comment\"># è¡¥å……è¯´æ˜ï¼šç”Ÿæˆæ–°çš„kibanaæ³¨å†Œä»¤ç‰Œï¼šbin/elasticsearch-create-enrollment-token -s kibana</span></span><br><span class=\"line\">â€¢ Copy the following enrollment token and <span class=\"built_in\">paste</span> it into Kibana <span class=\"keyword\">in</span> your browser (valid <span class=\"keyword\">for</span> the next 30 minutes):</span><br><span class=\"line\">  eyJ2ZXIiOiI4LjE0LjAiLCJhZHIiOlsiMTAuMjUwLjAuMjM5OjkyMDAiXSwiZmdyIjoiM2YxNDFjMTZkZmM2ZTE2NTg5NGJjMTY3MjA4NGIyMjBkY2RkMjJmZmUwMjExNmQ1MWFjMTgwMDNjZmFhNWExZCIsImtleSI6ImFSWFBzcFVCTVVmc1d5aUJnbjBtOmRzbVBLQV95UXhDZkJpXzQyWDNEMVEifQ==</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æä¾›äº†å°†æ–°çš„ Elasticsearch èŠ‚ç‚¹åŠ å…¥ç°æœ‰é›†ç¾¤çš„æ­¥éª¤ã€‚</span></span><br><span class=\"line\">â„¹ï¸ Configure other nodes to <span class=\"built_in\">join</span> this cluster:</span><br><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨ bin/elasticsearch --enrollment-token &lt;token&gt; å‘½ä»¤å¯åŠ¨æ–°çš„ Elasticsearch èŠ‚ç‚¹ã€‚ä»¤ç‰Œåœ¨æ¥ä¸‹æ¥çš„ 30 åˆ†é’Ÿå†…æœ‰æ•ˆã€‚</span></span><br><span class=\"line\"><span class=\"comment\"># è¡¥å……è¯´æ˜ï¼šç”Ÿæˆæ–°çš„èŠ‚ç‚¹æ³¨å†Œä»¤ç‰Œï¼šbin/elasticsearch-create-enrollment-token -s node</span></span><br><span class=\"line\">â€¢ Copy the following enrollment token and start new Elasticsearch nodes with `bin/elasticsearch --enrollment-token &lt;token&gt;` (valid <span class=\"keyword\">for</span> the next 30 minutes):</span><br><span class=\"line\">  eyJ2ZXIiOiI4LjE0LjAiLCJhZHIiOlsiMTAuMjUwLjAuMjM5OjkyMDAiXSwiZmdyIjoiM2YxNDFjMTZkZmM2ZTE2NTg5NGJjMTY3MjA4NGIyMjBkY2RkMjJmZmUwMjExNmQ1MWFjMTgwMDNjZmFhNWExZCIsImtleSI6ImF4WFBzcFVCTVVmc1d5aUJnbjFtOkFEallPdnpzUzh1MGJqOFpfVFE4a3cifQ==</span><br><span class=\"line\"><span class=\"comment\"># å¦‚æœä½ åœ¨ Docker ä¸­è¿è¡Œ Elasticsearchï¼Œå¯ä»¥ä½¿ç”¨ docker run -e &quot;ENROLLMENT_TOKEN=&lt;token&gt;&quot; docker.elastic.co/elasticsearch/elasticsearch:8.17.3 å‘½ä»¤å¯åŠ¨æ–°èŠ‚ç‚¹ã€‚</span></span><br><span class=\"line\">  If you<span class=\"string\">&#x27;re running in Docker, copy the enrollment token and run:</span></span><br><span class=\"line\"><span class=\"string\">  `docker run -e &quot;ENROLLMENT_TOKEN=&lt;token&gt;&quot; docker.elastic.co/elasticsearch/elasticsearch:8.17.3`</span></span><br><span class=\"line\"><span class=\"string\">â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>tokenä¿¡æ¯æœ‰æ•ˆæ—¶é—´åªæœ‰30åˆ†é’Ÿï¼Œè¶…æ—¶åå¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤é‡æ–°ç”Ÿæˆæ–°çš„token</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># è¿›å…¥node-1èŠ‚ç‚¹çš„ESå®‰è£…ç›®å½•ï¼Œæ­¤å‘½ä»¤ä¼šç”Ÿæˆæ–°çš„èŠ‚ç‚¹æ³¨å†Œä»¤ç‰Œ</span></span><br><span class=\"line\">bin/elasticsearch-create-enrollment-token -s node</span><br><span class=\"line\">eyJ2ZXIiOiI4LjE0LjAiLCJhZHIiOlsiMTAuMjUwLjAuMjM5OjkyMDAiXSwiZmdyIjoiM2YxNDFjMTZkZmM2ZTE2NTg5NGJjMTY3MjA4NGIyMjBkY2RkMjJmZmUwMjExNmQ1MWFjMTgwMDNjZmFhNWExZCIsImtleSI6IlpoRVZ4NVVCeXRPajdLeTBqb3BvOmdHRW44ZW5mU0RDZHA2Yy1uSDF4eGcifQ==</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å¯åŠ¨<code>node-2</code>èŠ‚ç‚¹ï¼Œå¯åŠ¨æ—¶è¦å¸¦ä¸Štokenä¿¡æ¯ï¼Œ<code>node-3</code>ä¸æ­¤ä¸€æ ·ã€‚è¿™é‡Œè¦æ³¨æ„ï¼Œåªæœ‰ç¬¬ä¸€æ¬¡åŠ å…¥é›†ç¾¤æ—¶å¯åŠ¨æ‰éœ€è¦å¸¦ä¸Šæ³¨å†Œä»¤ç‰Œï¼Œåç»­å¯åŠ¨ä¸éœ€è¦tokenä¿¡æ¯</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># è¿›å…¥node-2èŠ‚ç‚¹çš„ESå®‰è£…ç›®å½•ï¼Œæ­¤å‘½ä»¤ä¼šå¯åŠ¨ESèŠ‚ç‚¹ï¼Œå¹¶åŠ å…¥åˆ°é›†ç¾¤ä¸­</span></span><br><span class=\"line\"><span class=\"comment\"># bin/elasticsearch --enrollment-token &lt;token&gt;</span></span><br><span class=\"line\">bin/elasticsearch --enrollment-token eyJ2ZXIiOiI4LjE0LjAiLCJhZHIiOlsiMTAuMjUwLjAuMjM5OjkyMDAiXSwiZmdyIjoiM2YxNDFjMTZkZmM2ZTE2NTg5NGJjMTY3MjA4NGIyMjBkY2RkMjJmZmUwMjExNmQ1MWFjMTgwMDNjZmFhNWExZCIsImtleSI6IlpoRVZ4NVVCeXRPajdLeTBqb3BvOmdHRW44ZW5mU0RDZHA2Yy1uSDF4eGcifQ==</span><br></pre></td></tr></table></figure>\n<div class=\"tips\">\n<p><em><strong>åŠ å…¥é›†ç¾¤å¤±è´¥</strong></em></p>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">åœ¨æ‰§è¡Œ<code>bin/elasticsearch --enrollment-token &lt;token&gt;</code>æ—¶æœ‰å¯èƒ½ä¼šé‡åˆ°å¦‚ä¸‹å¼‚å¸¸ï¼š</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ERROR: Aborting auto configuration because the node keystore contains password settings already, with <span class=\"built_in\">exit</span> code 78</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">è¿™é€šå¸¸æ„å‘³ç€èŠ‚ç‚¹çš„ <code>keystore</code> å·²ç»åŒ…å«äº†å¯†ç è®¾ç½®ï¼Œå› æ­¤è‡ªåŠ¨é…ç½®è¿‡ç¨‹è¢«ä¸­æ­¢ã€‚</li>\n<li class=\"lvl-2\">äº§ç”Ÿè¿™ç§é”™è¯¯çš„åŸå› å¤§æ¦‚ç‡æ˜¯å½“å‰ESæ˜¯ä»å·²ç»å®‰è£…å¥½çš„æœåŠ¡å™¨ä¸Šæ‹·è´è¿‡æ¥çš„ï¼Œè€Œä¸æ˜¯å…¨æ–°å®‰è£…çš„ï¼Œæ­¤æ—¶æˆ‘ä»¬é™¤äº†éœ€è¦æ¸…ç©º<code>data</code>ç›®å½•å¤–ï¼Œè¿˜éœ€è¦åˆ é™¤ <code>keystore</code> ä¸­çš„å¯†ç </li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹keystoreä¸­çš„å¯†ç </span></span><br><span class=\"line\">$ bin/elasticsearch-keystore list</span><br><span class=\"line\">keystore.seed</span><br><span class=\"line\">xpack.security.http.ssl.keystore.secure_password</span><br><span class=\"line\">xpack.security.transport.ssl.keystore.secure_password</span><br><span class=\"line\">xpack.security.transport.ssl.truststore.secure_password</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># åˆ é™¤keystoreä¸­çš„å¯†ç </span></span><br><span class=\"line\">$ bin/elasticsearch-keystore remove xpack.security.http.ssl.keystore.secure_password</span><br><span class=\"line\">$ bin/elasticsearch-keystore remove xpack.security.transport.ssl.keystore.secure_password</span><br><span class=\"line\">$ bin/elasticsearch-keystore remove xpack.security.transport.ssl.truststore.secure_password</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">\n<p>å†æ¬¡æ‰§è¡Œ<code>bin/elasticsearch --enrollment-token &lt;token&gt;</code>å³å¯ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>å¦å¤–è¿˜å¯èƒ½é‡åˆ°å¦‚ä¸‹æŠ¥é”™ï¼š</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ERROR: Aborting enrolling to cluster. Could not communicate with the node on any of the addresses from the enrollment token. All of [10.250.0.239:9200] were attempted., with <span class=\"built_in\">exit</span> code 69</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">è¿™æ˜¯ç”±äºtokenè¿‡æœŸäº†ï¼Œé‡æ–°ç”Ÿæˆæ–°çš„tokenå³å¯</li>\n</ul>\n</div>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å¯åŠ¨æˆåŠŸåä¼šåœ¨<code>node-2</code>çš„é…ç½®æ–‡ä»¶ä¸­çœ‹åˆ°å¦‚ä¸‹é…ç½®ä¿¡æ¯</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#----------------------- BEGIN SECURITY AUTO CONFIGURATION -----------------------</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"comment\"># The following settings, TLS certificates, and keys have been automatically</span></span><br><span class=\"line\"><span class=\"comment\"># generated to configure Elasticsearch security features on 24-03-2025 07:45:11</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"comment\"># --------------------------------------------------------------------------------</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Enable security features</span></span><br><span class=\"line\">xpack.security.enabled: <span class=\"literal\">true</span></span><br><span class=\"line\"></span><br><span class=\"line\">xpack.security.enrollment.enabled: <span class=\"literal\">true</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Enable encryption for HTTP API client connections, such as Kibana, Logstash, and Agents</span></span><br><span class=\"line\">xpack.security.http.ssl:</span><br><span class=\"line\">  enabled: <span class=\"literal\">true</span></span><br><span class=\"line\">  keystore.path: certs/http.p12</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Enable encryption and mutual authentication between cluster nodes</span></span><br><span class=\"line\">xpack.security.transport.ssl:</span><br><span class=\"line\">  enabled: <span class=\"literal\">true</span></span><br><span class=\"line\">  verification_mode: certificate</span><br><span class=\"line\">  keystore.path: certs/transport.p12</span><br><span class=\"line\">  truststore.path: certs/transport.p12</span><br><span class=\"line\"><span class=\"comment\"># Discover existing nodes in the cluster</span></span><br><span class=\"line\">discovery.seed_hosts: [<span class=\"string\">&quot;10.250.0.239:9300&quot;</span>] <span class=\"comment\"># è¿™é‡Œæ˜¯node-1èŠ‚ç‚¹çš„IPåœ°å€å’Œç«¯å£å·</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## è€Œnode-3è¿™é‡Œä¼šæ˜¾ç¤ºå¦‚ä¸‹ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯è¶Šæ˜¯åæ¥åŠ å…¥è¿›æ¥çš„ï¼Œè¿™é‡Œå°±ä¼šåŠ ä¸Šä¹‹å‰æ‰€æœ‰èŠ‚ç‚¹çš„IPåœ°å€å’Œç«¯å£å·</span></span><br><span class=\"line\">discovery.seed_hosts: [<span class=\"string\">&quot;10.250.0.239:9300&quot;</span>, <span class=\"string\">&quot;10.250.0.17:9300&quot;</span>] <span class=\"comment\"># è¿™é‡Œæ˜¯node-1å’Œnode-2èŠ‚ç‚¹çš„IPåœ°å€å’Œç«¯å£å·</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#----------------------- END SECURITY AUTO CONFIGURATION -------------------------</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"éªŒè¯é›†ç¾¤çŠ¶æ€\">éªŒè¯é›†ç¾¤çŠ¶æ€</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>å¯åŠ¨å®Œæˆåï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹é›†ç¾¤çŠ¶æ€ï¼š</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹é›†ç¾¤çŠ¶æ€</span></span><br><span class=\"line\">$ curl -u elastic:123456 --cacert /usr/local/elasticsearch/elasticsearch-8.17.3/config/certs/http_ca.crt  https://127.0.0.1:9200/_cluster/health?pretty</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;cluster_name&quot;</span> : <span class=\"string\">&quot;test-elk&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;status&quot;</span> : <span class=\"string\">&quot;green&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;timed_out&quot;</span> : <span class=\"literal\">false</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;number_of_nodes&quot;</span> : 3,</span><br><span class=\"line\">  <span class=\"string\">&quot;number_of_data_nodes&quot;</span> : 3,</span><br><span class=\"line\">  <span class=\"string\">&quot;active_primary_shards&quot;</span> : 31,</span><br><span class=\"line\">  <span class=\"string\">&quot;active_shards&quot;</span> : 62,</span><br><span class=\"line\">  <span class=\"string\">&quot;relocating_shards&quot;</span> : 0,</span><br><span class=\"line\">  <span class=\"string\">&quot;initializing_shards&quot;</span> : 0,</span><br><span class=\"line\">  <span class=\"string\">&quot;unassigned_shards&quot;</span> : 0,</span><br><span class=\"line\">  <span class=\"string\">&quot;unassigned_primary_shards&quot;</span> : 0,</span><br><span class=\"line\">  <span class=\"string\">&quot;delayed_unassigned_shards&quot;</span> : 0,</span><br><span class=\"line\">  <span class=\"string\">&quot;number_of_pending_tasks&quot;</span> : 0,</span><br><span class=\"line\">  <span class=\"string\">&quot;number_of_in_flight_fetch&quot;</span> : 0,</span><br><span class=\"line\">  <span class=\"string\">&quot;task_max_waiting_in_queue_millis&quot;</span> : 0,</span><br><span class=\"line\">  <span class=\"string\">&quot;active_shards_percent_as_number&quot;</span> : 100.0</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹èŠ‚ç‚¹ä¿¡æ¯ï¼Œå…¶ä¸­ * è¡¨ç¤ºå½“å‰èŠ‚ç‚¹ä¸ºmasterèŠ‚ç‚¹</span></span><br><span class=\"line\">$ curl -u elastic:123456 --cacert /usr/local/elasticsearch/elasticsearch-8.17.3/config/certs/http_ca.crt  https://127.0.0.1:9200/_cat/nodes?v</span><br><span class=\"line\">ip           heap.percent ram.percent cpu load_1m load_5m load_15m node.role   master name</span><br><span class=\"line\">10.250.0.17             8          63  28    1.03    0.38     0.14 cdfhilmrstw -      node-2</span><br><span class=\"line\">10.250.0.173            9          63  22    0.86    0.37     0.19 cdfhilmrstw -      node-3</span><br><span class=\"line\">10.250.0.239            9          78   6    0.38    0.22     0.16 cdfhilmrstw *      node-1</span><br></pre></td></tr></table></figure>\n<h2 id=\"é‡è¦è¯´æ˜\">é‡è¦è¯´æ˜</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>é›†ç¾¤ä¸€æ—¦åˆ›å»ºå®Œæˆï¼Œåˆ™è‡³å°‘éœ€è¦ä¸¤ä¸ªèŠ‚ç‚¹è¿è¡Œæ‰èƒ½ä¿è¯é›†ç¾¤å¯ç”¨æ€§ï¼Œå¦åˆ™é›†ç¾¤å°†æ— æ³•è¿è¡Œã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>å¦‚æœ<code>node-1</code>èŠ‚ç‚¹æŒ‚äº†ï¼Œé›†ç¾¤ä¸­å‰©ä¸‹çš„ä¸¤ä¸ªèŠ‚ç‚¹ä¼šé‡æ–°é€‰æ‹©ä¸€ä¸ªæ–°çš„<code>master</code>èŠ‚ç‚¹ï¼Œä¸ä¼šå½±å“é›†ç¾¤çš„å¯ç”¨æ€§ã€‚</p>\n</li>\n<li class=\"lvl-2\">\n<p>ä¸€æ—¦å…³é—­<code>node-1</code>ï¼Œåˆ™é‡æ–°å¯åŠ¨<code>node-1</code>èŠ‚ç‚¹å‰è¦ä¿®æ”¹å…¶é…ç½®æ–‡ä»¶ï¼Œå¦åˆ™æ— æ³•å¯åŠ¨æˆåŠŸã€‚</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># æ³¨é‡Šæ‰è¯¥é…ç½®</span></span><br><span class=\"line\"><span class=\"comment\"># cluster.initial_master_nodes: [&quot;node-1&quot;]</span></span><br><span class=\"line\"><span class=\"comment\"># åŠ å…¥è¯¥é…ç½®ï¼Œå®é™…ä¸Šæœ€å¥½åœ¨é‡å¯æ¯ä¸ªèŠ‚ç‚¹å‰ï¼Œå°†æ¯ä¸ªèŠ‚ç‚¹éƒ½é…ç½®ä¸ºè¿™æ ·</span></span><br><span class=\"line\">discovery.seed_hosts: [<span class=\"string\">&quot;10.250.0.239:9300&quot;</span>, <span class=\"string\">&quot;10.250.0.17:9300&quot;</span>, <span class=\"string\">&quot;10.250.0.173:9300&quot;</span>]</span><br></pre></td></tr></table></figure>\n<h2 id=\"Kibanaå…³è”ESé›†ç¾¤\">Kibanaå…³è”ESé›†ç¾¤</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Kibana å…³è”å•èŠ‚ç‚¹ESå‚è€ƒ <a href=\"/2025/03/21/kibana-01-install/\" title=\"linuxä¸‹å®‰è£…Kibana\">linuxä¸‹å®‰è£…Kibana</a>ï¼Œåœ¨æ­¤åŸºç¡€ä¸Šå¯¹é…ç½®æ–‡ä»¶è¿›è¡Œå¦‚ä¸‹ä¿®æ”¹ï¼š</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># å…³è”é›†ç¾¤çš„èŠ‚ç‚¹åœ°å€ï¼Œå°†é›†ç¾¤å†…æ‰€æœ‰èŠ‚ç‚¹çš„åœ°å€éƒ½é…ç½®åˆ°è¯¥å­—æ®µä¸­</span></span><br><span class=\"line\">elasticsearch.hosts: [<span class=\"string\">&#x27;https://10.250.0.239:9200&#x27;</span>, <span class=\"string\">&#x27;https://10.250.0.173:9200&#x27;</span>, <span class=\"string\">&#x27;https://10.250.0.17:9200&#x27;</span>]</span><br><span class=\"line\"><span class=\"comment\"># å…³è”é›†ç¾¤çš„è¾“å‡ºåœ°å€ï¼Œå°†é›†ç¾¤å†…æ‰€æœ‰èŠ‚ç‚¹çš„åœ°å€éƒ½é…ç½®åˆ°è¯¥å­—æ®µä¸­</span></span><br><span class=\"line\">xpack.fleet.outputs: [&#123;<span class=\"built_in\">id</span>: fleet-default-output, name: default, is_default: <span class=\"literal\">true</span>, is_default_monitoring: <span class=\"literal\">true</span>, <span class=\"built_in\">type</span>: elasticsearch, hosts: [<span class=\"string\">&#x27;https://10.250.0.239:9200&#x27;</span>, <span class=\"string\">&#x27;https://10.250.0.173:9200&#x27;</span>, <span class=\"string\">&#x27;https://10.250.0.17:9200&#x27;</span>], ca_trusted_fingerprint: 3f141c16dfc6e165894bc1672084b220dcdd22ffe02116d51ac18003cfaa5a1d&#125;]</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>é‡å¯Kibana</p>\n</li>\n<li class=\"lvl-2\">\n<p>åªè¦ä¿è¯é›†ç¾¤å†…è‡³å°‘æœ‰ä¸¤ä¸ªESèŠ‚ç‚¹å·¥ä½œæ­£å¸¸ï¼Œå³å¯æ­£å¸¸è®¿é—®Kibana</p>\n</li>\n</ul>\n<h2 id=\"nginxåå‘ä»£ç†ESé›†ç¾¤\">nginxåå‘ä»£ç†ESé›†ç¾¤</h2>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vim /etc/nginx/conf.d/es.conf <span class=\"comment\"># æ·»åŠ å¦‚ä¸‹å†…å®¹</span></span><br><span class=\"line\">upstream es &#123;</span><br><span class=\"line\">    server 10.250.0.239:9200;</span><br><span class=\"line\">    server 10.250.0.173:9200;</span><br><span class=\"line\">    server 10.250.0.17:9200;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">        listen       8888;</span><br><span class=\"line\">        server_name  localhost es.domain;</span><br><span class=\"line\"></span><br><span class=\"line\">        location / &#123;</span><br><span class=\"line\">            proxy_pass https://es; <span class=\"comment\">#è¿™ä¸ªåç§°å’Œè¦ä¸Šé¢ upstream es å¯¹åº”ï¼Œæ³¨æ„è¿™é‡Œæ˜¯ https åè®®</span></span><br><span class=\"line\">            proxy_redirect     default;</span><br><span class=\"line\">            proxy_http_version 1.1;</span><br><span class=\"line\"></span><br><span class=\"line\">            proxy_set_header   Host              <span class=\"variable\">$host</span>;</span><br><span class=\"line\">            proxy_set_header   X-Real-IP         <span class=\"variable\">$remote_addr</span>;</span><br><span class=\"line\">            proxy_set_header   X-Forwarded-For   <span class=\"variable\">$proxy_add_x_forwarded_for</span>;</span><br><span class=\"line\">            proxy_set_header   X-Forwarded-Proto <span class=\"variable\">$scheme</span>;</span><br><span class=\"line\">            proxy_max_temp_file_size 0;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">#this is the maximum upload size</span></span><br><span class=\"line\">            client_max_body_size       10m;</span><br><span class=\"line\">            client_body_buffer_size    128k;</span><br><span class=\"line\"></span><br><span class=\"line\">            proxy_connect_timeout      90;</span><br><span class=\"line\">            proxy_send_timeout         90;</span><br><span class=\"line\">            proxy_read_timeout         90;</span><br><span class=\"line\">            proxy_buffering            off;</span><br><span class=\"line\">            proxy_request_buffering    off; <span class=\"comment\"># Required for HTTP CLI commands</span></span><br><span class=\"line\">            proxy_set_header Connection <span class=\"string\">&quot;&quot;</span>; <span class=\"comment\"># Clear for keepalive</span></span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># é‡å¯nginx</span></span><br><span class=\"line\">systemctl restart nginx</span><br><span class=\"line\"><span class=\"comment\"># è®¿é—®ESé›†ç¾¤</span></span><br><span class=\"line\">curl -u elastic:123456 http://127.0.0.1:8888/_cluster/health?pretty</span><br></pre></td></tr></table></figure>","content_text":"æ‘˜è¦ æœ¬æ–‡ä»‹ç»å¦‚ä½•åœ¨linuxä¸‹å®‰è£…Elasticsearché›†ç¾¤(ä¸‰èŠ‚ç‚¹) Elasticsearchç‰ˆæœ¬8.17.3 å•èŠ‚ç‚¹å®‰è£…å‚è€ƒlinuxä¸‹å®‰è£…Elasticsearchï¼Œæœ¬æ–‡åœ¨æ­¤åŸºç¡€ä¸Šå®Œæˆé›†ç¾¤å®‰è£… é›†ç¾¤å®‰è£… ä¸‰ä¸ªèŠ‚ç‚¹åˆ†åˆ«å®‰ç…§å•èŠ‚ç‚¹çš„å®‰è£…æ–¹å¼å®Œæˆä¸‹è½½ï¼Œç”¨æˆ·é…ç½®ï¼Œç¯å¢ƒå˜é‡é…ç½®ï¼Œç³»ç»Ÿå‚æ•°é…ç½®ï¼Œç­‰ç­‰ã€‚ ä»»é€‰ä¸€ä¸ªèŠ‚ç‚¹ä½œä¸ºé›†ç¾¤çš„masterèŠ‚ç‚¹ï¼Œæˆ‘ä»¬å‘½åä¸ºnode-1ï¼Œå…¶å®ƒèŠ‚ç‚¹å‘½åä¸ºnode-2å’Œnode-3 å…ˆé…ç½®node-1èŠ‚ç‚¹çš„é…ç½®æ–‡ä»¶ 1234567891011121314151617181920212223# é›†ç¾¤åç§°cluster.name: test-elk# èŠ‚ç‚¹åç§°node.name: node-1# æ•°æ®å­˜å‚¨è·¯å¾„ï¼Œé»˜è®¤å€¼ $ES_HOME/datapath.data: /usr/local/elasticsearch/data# æ—¥å¿—å­˜å‚¨è·¯å¾„ï¼Œé»˜è®¤å€¼ $ES_HOME/logspath.logs: /usr/local/elasticsearch/logs# é…ç½®ESå¯åŠ¨æ—¶æ˜¯å¦è¿›è¡Œå†…å­˜é”å®šæ£€æŸ¥ï¼Œé»˜è®¤å€¼trueï¼Œæœ¬æœºå†…å­˜æ¯”è¾ƒå°æ—¶è®¾ç½®ä¸ºfalsebootstrap.memory_lock: false# å…è®¸é€šè¿‡ä»»ä½•åœ°å€è®¿é—®ï¼Œå¼€å¯è¿œç¨‹è®¿é—®network.host: 0.0.0.0# é…ç½®å½“å‰ESèŠ‚ç‚¹å¯¹å¤–æä¾›æœåŠ¡çš„httpç«¯å£ï¼Œé»˜è®¤ 9200http.port: 9200# é…ç½®å½“å‰ESèŠ‚ç‚¹å¯¹å¤–æä¾›æœåŠ¡çš„tcpç«¯å£ï¼Œé»˜è®¤ 9300transport.port: 9300# é›†ç¾¤å†…çš„ä¸»æœºåˆ—è¡¨ï¼Œå¼€å¯å®‰å…¨è®¤è¯æ—¶æ— éœ€é…ç½®ï¼Œæ³¨æ„è¿™é‡Œä¸è¦è¿›è¡Œé…ç½®# discovery.seed_hosts: [&quot;127.0.0.1&quot;]# ç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶éœ€è¦å‚ä¸é€‰ä¸»çš„èŠ‚ç‚¹åç§°ï¼Œè¿™é‡Œåªé…ç½®node-1cluster.initial_master_nodes: [&quot;node-1&quot;]#è§£å†³è·¨åŸŸé—®é¢˜http.cors.enabled: truehttp.cors.allow-origin: &quot;*&quot; é…ç½®node-2èŠ‚ç‚¹çš„é…ç½®æ–‡ä»¶ 12345678910111213141516171819# é›†ç¾¤åç§°cluster.name: test-elk# èŠ‚ç‚¹åç§°node.name: node-2# æ•°æ®å­˜å‚¨è·¯å¾„ï¼Œé»˜è®¤å€¼ $ES_HOME/datapath.data: /usr/local/elasticsearch/data# æ—¥å¿—å­˜å‚¨è·¯å¾„ï¼Œé»˜è®¤å€¼ $ES_HOME/logspath.logs: /usr/local/elasticsearch/logs# é…ç½®ESå¯åŠ¨æ—¶æ˜¯å¦è¿›è¡Œå†…å­˜é”å®šæ£€æŸ¥ï¼Œé»˜è®¤å€¼trueï¼Œæœ¬æœºå†…å­˜æ¯”è¾ƒå°æ—¶è®¾ç½®ä¸ºfalsebootstrap.memory_lock: false# å…è®¸é€šè¿‡ä»»ä½•åœ°å€è®¿é—®ï¼Œå¼€å¯è¿œç¨‹è®¿é—®network.host: 0.0.0.0# é…ç½®å½“å‰ESèŠ‚ç‚¹å¯¹å¤–æä¾›æœåŠ¡çš„httpç«¯å£ï¼Œé»˜è®¤ 9200http.port: 9200# é…ç½®å½“å‰ESèŠ‚ç‚¹å¯¹å¤–æä¾›æœåŠ¡çš„tcpç«¯å£ï¼Œé»˜è®¤ 9300transport.port: 9300#è§£å†³è·¨åŸŸé—®é¢˜http.cors.enabled: truehttp.cors.allow-origin: &quot;*&quot; é…ç½®node-3èŠ‚ç‚¹çš„é…ç½®æ–‡ä»¶ 12345678910111213141516171819# é›†ç¾¤åç§°cluster.name: test-elk# èŠ‚ç‚¹åç§°node.name: node-3# æ•°æ®å­˜å‚¨è·¯å¾„ï¼Œé»˜è®¤å€¼ $ES_HOME/datapath.data: /usr/local/elasticsearch/data# æ—¥å¿—å­˜å‚¨è·¯å¾„ï¼Œé»˜è®¤å€¼ $ES_HOME/logspath.logs: /usr/local/elasticsearch/logs# é…ç½®ESå¯åŠ¨æ—¶æ˜¯å¦è¿›è¡Œå†…å­˜é”å®šæ£€æŸ¥ï¼Œé»˜è®¤å€¼trueï¼Œæœ¬æœºå†…å­˜æ¯”è¾ƒå°æ—¶è®¾ç½®ä¸ºfalsebootstrap.memory_lock: false# å…è®¸é€šè¿‡ä»»ä½•åœ°å€è®¿é—®ï¼Œå¼€å¯è¿œç¨‹è®¿é—®network.host: 0.0.0.0# é…ç½®å½“å‰ESèŠ‚ç‚¹å¯¹å¤–æä¾›æœåŠ¡çš„httpç«¯å£ï¼Œé»˜è®¤ 9200http.port: 9200# é…ç½®å½“å‰ESèŠ‚ç‚¹å¯¹å¤–æä¾›æœåŠ¡çš„tcpç«¯å£ï¼Œé»˜è®¤ 9300transport.port: 9300#è§£å†³è·¨åŸŸé—®é¢˜http.cors.enabled: truehttp.cors.allow-origin: &quot;*&quot; å¯åŠ¨node-1ï¼Œå¯åŠ¨æˆåŠŸåæˆ‘ä»¬ä¼šåœ¨æ—¥å¿—ä¸­çœ‹åˆ°å¦‚ä¸‹å®‰å…¨è®¤è¯ä¿¡æ¯ä¿¡æ¯ï¼Œè®°å½•å…¶ä¸­çš„åŠ å…¥é›†ç¾¤çš„èŠ‚ç‚¹çš„tokenä¿¡æ¯ 1234567891011121314151617181920212223242526272829303132â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”# è¿™äº›æ—¥å¿—ä¿¡æ¯æä¾›äº† Elasticsearch 8 åœ¨é¦–æ¬¡å¯åŠ¨æ—¶è‡ªåŠ¨é…ç½®çš„å®‰å…¨ç‰¹æ€§ã€ç”Ÿæˆçš„é»˜è®¤å¯†ç ã€è¯ä¹¦æŒ‡çº¹ä»¥åŠå¦‚ä½•é…ç½® Kibana å’Œå…¶ä»–èŠ‚ç‚¹åŠ å…¥é›†ç¾¤çš„è¯¦ç»†è¯´æ˜ã€‚âœ… Elasticsearch security features have been automatically configured!âœ… Authentication is enabled and cluster connections are encrypted.# è¿™æ˜¯ elastic ç”¨æˆ·çš„é»˜è®¤å¯†ç ã€‚ç³»ç»Ÿå»ºè®®ä½ ä½¿ç”¨ bin/elasticsearch-reset-password -u elastic å‘½ä»¤æ¥é‡ç½®æ­¤å¯†ç ã€‚â„¹ï¸ Password for the elastic user (reset with `bin/elasticsearch-reset-password -u elastic`): BNb=*qz6_M*mXL9uZiSP # è¿™é‡Œä¼šæ‰“å°å‡ºESè‡ªåŠ¨ç”Ÿæˆçš„å¯†ç # è¿™æ˜¯ HTTP CA è¯ä¹¦çš„ SHA-256 æŒ‡çº¹ã€‚CA è¯ä¹¦ç”¨äºéªŒè¯ HTTPS è¿æ¥çš„èº«ä»½ã€‚â„¹ï¸ HTTP CA certificate SHA-256 fingerprint: 3f141c16dfc6e165894bc1672084b220dcdd22ffe02116d51ac18003cfaa5a1d# æä¾›äº†å°† Kibana é…ç½®ä¸ºä½¿ç”¨æ­¤ Elasticsearch é›†ç¾¤çš„æ­¥éª¤ã€‚â„¹ï¸ Configure Kibana to use this cluster:# å¯åŠ¨ Kibana å¹¶æŒ‰ç…§ç»ˆç«¯ä¸­æ˜¾ç¤ºçš„é…ç½®é“¾æ¥è¿›è¡Œæ“ä½œã€‚â€¢ Run Kibana and click the configuration link in the terminal when Kibana starts.# å¤åˆ¶æä¾›çš„æ³¨å†Œä»¤ç‰Œï¼Œå¹¶åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ Kibana æ—¶ç²˜è´´æ­¤ä»¤ç‰Œã€‚ä»¤ç‰Œåœ¨æ¥ä¸‹æ¥çš„ 30 åˆ†é’Ÿå†…æœ‰æ•ˆã€‚# è¡¥å……è¯´æ˜ï¼šç”Ÿæˆæ–°çš„kibanaæ³¨å†Œä»¤ç‰Œï¼šbin/elasticsearch-create-enrollment-token -s kibanaâ€¢ Copy the following enrollment token and paste it into Kibana in your browser (valid for the next 30 minutes): eyJ2ZXIiOiI4LjE0LjAiLCJhZHIiOlsiMTAuMjUwLjAuMjM5OjkyMDAiXSwiZmdyIjoiM2YxNDFjMTZkZmM2ZTE2NTg5NGJjMTY3MjA4NGIyMjBkY2RkMjJmZmUwMjExNmQ1MWFjMTgwMDNjZmFhNWExZCIsImtleSI6ImFSWFBzcFVCTVVmc1d5aUJnbjBtOmRzbVBLQV95UXhDZkJpXzQyWDNEMVEifQ==# æä¾›äº†å°†æ–°çš„ Elasticsearch èŠ‚ç‚¹åŠ å…¥ç°æœ‰é›†ç¾¤çš„æ­¥éª¤ã€‚â„¹ï¸ Configure other nodes to join this cluster:# ä½¿ç”¨ bin/elasticsearch --enrollment-token &lt;token&gt; å‘½ä»¤å¯åŠ¨æ–°çš„ Elasticsearch èŠ‚ç‚¹ã€‚ä»¤ç‰Œåœ¨æ¥ä¸‹æ¥çš„ 30 åˆ†é’Ÿå†…æœ‰æ•ˆã€‚# è¡¥å……è¯´æ˜ï¼šç”Ÿæˆæ–°çš„èŠ‚ç‚¹æ³¨å†Œä»¤ç‰Œï¼šbin/elasticsearch-create-enrollment-token -s nodeâ€¢ Copy the following enrollment token and start new Elasticsearch nodes with `bin/elasticsearch --enrollment-token &lt;token&gt;` (valid for the next 30 minutes): eyJ2ZXIiOiI4LjE0LjAiLCJhZHIiOlsiMTAuMjUwLjAuMjM5OjkyMDAiXSwiZmdyIjoiM2YxNDFjMTZkZmM2ZTE2NTg5NGJjMTY3MjA4NGIyMjBkY2RkMjJmZmUwMjExNmQ1MWFjMTgwMDNjZmFhNWExZCIsImtleSI6ImF4WFBzcFVCTVVmc1d5aUJnbjFtOkFEallPdnpzUzh1MGJqOFpfVFE4a3cifQ==# å¦‚æœä½ åœ¨ Docker ä¸­è¿è¡Œ Elasticsearchï¼Œå¯ä»¥ä½¿ç”¨ docker run -e &quot;ENROLLMENT_TOKEN=&lt;token&gt;&quot; docker.elastic.co/elasticsearch/elasticsearch:8.17.3 å‘½ä»¤å¯åŠ¨æ–°èŠ‚ç‚¹ã€‚ If you&#x27;re running in Docker, copy the enrollment token and run: `docker run -e &quot;ENROLLMENT_TOKEN=&lt;token&gt;&quot; docker.elastic.co/elasticsearch/elasticsearch:8.17.3`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” tokenä¿¡æ¯æœ‰æ•ˆæ—¶é—´åªæœ‰30åˆ†é’Ÿï¼Œè¶…æ—¶åå¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤é‡æ–°ç”Ÿæˆæ–°çš„token 123# è¿›å…¥node-1èŠ‚ç‚¹çš„ESå®‰è£…ç›®å½•ï¼Œæ­¤å‘½ä»¤ä¼šç”Ÿæˆæ–°çš„èŠ‚ç‚¹æ³¨å†Œä»¤ç‰Œbin/elasticsearch-create-enrollment-token -s nodeeyJ2ZXIiOiI4LjE0LjAiLCJhZHIiOlsiMTAuMjUwLjAuMjM5OjkyMDAiXSwiZmdyIjoiM2YxNDFjMTZkZmM2ZTE2NTg5NGJjMTY3MjA4NGIyMjBkY2RkMjJmZmUwMjExNmQ1MWFjMTgwMDNjZmFhNWExZCIsImtleSI6IlpoRVZ4NVVCeXRPajdLeTBqb3BvOmdHRW44ZW5mU0RDZHA2Yy1uSDF4eGcifQ== å¯åŠ¨node-2èŠ‚ç‚¹ï¼Œå¯åŠ¨æ—¶è¦å¸¦ä¸Štokenä¿¡æ¯ï¼Œnode-3ä¸æ­¤ä¸€æ ·ã€‚è¿™é‡Œè¦æ³¨æ„ï¼Œåªæœ‰ç¬¬ä¸€æ¬¡åŠ å…¥é›†ç¾¤æ—¶å¯åŠ¨æ‰éœ€è¦å¸¦ä¸Šæ³¨å†Œä»¤ç‰Œï¼Œåç»­å¯åŠ¨ä¸éœ€è¦tokenä¿¡æ¯ 123# è¿›å…¥node-2èŠ‚ç‚¹çš„ESå®‰è£…ç›®å½•ï¼Œæ­¤å‘½ä»¤ä¼šå¯åŠ¨ESèŠ‚ç‚¹ï¼Œå¹¶åŠ å…¥åˆ°é›†ç¾¤ä¸­# bin/elasticsearch --enrollment-token &lt;token&gt;bin/elasticsearch --enrollment-token eyJ2ZXIiOiI4LjE0LjAiLCJhZHIiOlsiMTAuMjUwLjAuMjM5OjkyMDAiXSwiZmdyIjoiM2YxNDFjMTZkZmM2ZTE2NTg5NGJjMTY3MjA4NGIyMjBkY2RkMjJmZmUwMjExNmQ1MWFjMTgwMDNjZmFhNWExZCIsImtleSI6IlpoRVZ4NVVCeXRPajdLeTBqb3BvOmdHRW44ZW5mU0RDZHA2Yy1uSDF4eGcifQ== åŠ å…¥é›†ç¾¤å¤±è´¥ åœ¨æ‰§è¡Œbin/elasticsearch --enrollment-token &lt;token&gt;æ—¶æœ‰å¯èƒ½ä¼šé‡åˆ°å¦‚ä¸‹å¼‚å¸¸ï¼š 1ERROR: Aborting auto configuration because the node keystore contains password settings already, with exit code 78 è¿™é€šå¸¸æ„å‘³ç€èŠ‚ç‚¹çš„ keystore å·²ç»åŒ…å«äº†å¯†ç è®¾ç½®ï¼Œå› æ­¤è‡ªåŠ¨é…ç½®è¿‡ç¨‹è¢«ä¸­æ­¢ã€‚ äº§ç”Ÿè¿™ç§é”™è¯¯çš„åŸå› å¤§æ¦‚ç‡æ˜¯å½“å‰ESæ˜¯ä»å·²ç»å®‰è£…å¥½çš„æœåŠ¡å™¨ä¸Šæ‹·è´è¿‡æ¥çš„ï¼Œè€Œä¸æ˜¯å…¨æ–°å®‰è£…çš„ï¼Œæ­¤æ—¶æˆ‘ä»¬é™¤äº†éœ€è¦æ¸…ç©ºdataç›®å½•å¤–ï¼Œè¿˜éœ€è¦åˆ é™¤ keystore ä¸­çš„å¯†ç  1234567891011# æŸ¥çœ‹keystoreä¸­çš„å¯†ç $ bin/elasticsearch-keystore listkeystore.seedxpack.security.http.ssl.keystore.secure_passwordxpack.security.transport.ssl.keystore.secure_passwordxpack.security.transport.ssl.truststore.secure_password# åˆ é™¤keystoreä¸­çš„å¯†ç $ bin/elasticsearch-keystore remove xpack.security.http.ssl.keystore.secure_password$ bin/elasticsearch-keystore remove xpack.security.transport.ssl.keystore.secure_password$ bin/elasticsearch-keystore remove xpack.security.transport.ssl.truststore.secure_password å†æ¬¡æ‰§è¡Œbin/elasticsearch --enrollment-token &lt;token&gt;å³å¯ã€‚ å¦å¤–è¿˜å¯èƒ½é‡åˆ°å¦‚ä¸‹æŠ¥é”™ï¼š 1ERROR: Aborting enrolling to cluster. Could not communicate with the node on any of the addresses from the enrollment token. All of [10.250.0.239:9200] were attempted., with exit code 69 è¿™æ˜¯ç”±äºtokenè¿‡æœŸäº†ï¼Œé‡æ–°ç”Ÿæˆæ–°çš„tokenå³å¯ å¯åŠ¨æˆåŠŸåä¼šåœ¨node-2çš„é…ç½®æ–‡ä»¶ä¸­çœ‹åˆ°å¦‚ä¸‹é…ç½®ä¿¡æ¯ 123456789101112131415161718192021222324252627282930#----------------------- BEGIN SECURITY AUTO CONFIGURATION -----------------------## The following settings, TLS certificates, and keys have been automatically# generated to configure Elasticsearch security features on 24-03-2025 07:45:11## --------------------------------------------------------------------------------# Enable security featuresxpack.security.enabled: truexpack.security.enrollment.enabled: true# Enable encryption for HTTP API client connections, such as Kibana, Logstash, and Agentsxpack.security.http.ssl: enabled: true keystore.path: certs/http.p12# Enable encryption and mutual authentication between cluster nodesxpack.security.transport.ssl: enabled: true verification_mode: certificate keystore.path: certs/transport.p12 truststore.path: certs/transport.p12# Discover existing nodes in the clusterdiscovery.seed_hosts: [&quot;10.250.0.239:9300&quot;] # è¿™é‡Œæ˜¯node-1èŠ‚ç‚¹çš„IPåœ°å€å’Œç«¯å£å·## è€Œnode-3è¿™é‡Œä¼šæ˜¾ç¤ºå¦‚ä¸‹ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯è¶Šæ˜¯åæ¥åŠ å…¥è¿›æ¥çš„ï¼Œè¿™é‡Œå°±ä¼šåŠ ä¸Šä¹‹å‰æ‰€æœ‰èŠ‚ç‚¹çš„IPåœ°å€å’Œç«¯å£å·discovery.seed_hosts: [&quot;10.250.0.239:9300&quot;, &quot;10.250.0.17:9300&quot;] # è¿™é‡Œæ˜¯node-1å’Œnode-2èŠ‚ç‚¹çš„IPåœ°å€å’Œç«¯å£å·#----------------------- END SECURITY AUTO CONFIGURATION ------------------------- éªŒè¯é›†ç¾¤çŠ¶æ€ å¯åŠ¨å®Œæˆåï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹é›†ç¾¤çŠ¶æ€ï¼š 1234567891011121314151617181920212223242526# æŸ¥çœ‹é›†ç¾¤çŠ¶æ€$ curl -u elastic:123456 --cacert /usr/local/elasticsearch/elasticsearch-8.17.3/config/certs/http_ca.crt https://127.0.0.1:9200/_cluster/health?pretty&#123; &quot;cluster_name&quot; : &quot;test-elk&quot;, &quot;status&quot; : &quot;green&quot;, &quot;timed_out&quot; : false, &quot;number_of_nodes&quot; : 3, &quot;number_of_data_nodes&quot; : 3, &quot;active_primary_shards&quot; : 31, &quot;active_shards&quot; : 62, &quot;relocating_shards&quot; : 0, &quot;initializing_shards&quot; : 0, &quot;unassigned_shards&quot; : 0, &quot;unassigned_primary_shards&quot; : 0, &quot;delayed_unassigned_shards&quot; : 0, &quot;number_of_pending_tasks&quot; : 0, &quot;number_of_in_flight_fetch&quot; : 0, &quot;task_max_waiting_in_queue_millis&quot; : 0, &quot;active_shards_percent_as_number&quot; : 100.0&#125;# æŸ¥çœ‹èŠ‚ç‚¹ä¿¡æ¯ï¼Œå…¶ä¸­ * è¡¨ç¤ºå½“å‰èŠ‚ç‚¹ä¸ºmasterèŠ‚ç‚¹$ curl -u elastic:123456 --cacert /usr/local/elasticsearch/elasticsearch-8.17.3/config/certs/http_ca.crt https://127.0.0.1:9200/_cat/nodes?vip heap.percent ram.percent cpu load_1m load_5m load_15m node.role master name10.250.0.17 8 63 28 1.03 0.38 0.14 cdfhilmrstw - node-210.250.0.173 9 63 22 0.86 0.37 0.19 cdfhilmrstw - node-310.250.0.239 9 78 6 0.38 0.22 0.16 cdfhilmrstw * node-1 é‡è¦è¯´æ˜ é›†ç¾¤ä¸€æ—¦åˆ›å»ºå®Œæˆï¼Œåˆ™è‡³å°‘éœ€è¦ä¸¤ä¸ªèŠ‚ç‚¹è¿è¡Œæ‰èƒ½ä¿è¯é›†ç¾¤å¯ç”¨æ€§ï¼Œå¦åˆ™é›†ç¾¤å°†æ— æ³•è¿è¡Œã€‚ å¦‚æœnode-1èŠ‚ç‚¹æŒ‚äº†ï¼Œé›†ç¾¤ä¸­å‰©ä¸‹çš„ä¸¤ä¸ªèŠ‚ç‚¹ä¼šé‡æ–°é€‰æ‹©ä¸€ä¸ªæ–°çš„masterèŠ‚ç‚¹ï¼Œä¸ä¼šå½±å“é›†ç¾¤çš„å¯ç”¨æ€§ã€‚ ä¸€æ—¦å…³é—­node-1ï¼Œåˆ™é‡æ–°å¯åŠ¨node-1èŠ‚ç‚¹å‰è¦ä¿®æ”¹å…¶é…ç½®æ–‡ä»¶ï¼Œå¦åˆ™æ— æ³•å¯åŠ¨æˆåŠŸã€‚ 1234# æ³¨é‡Šæ‰è¯¥é…ç½®# cluster.initial_master_nodes: [&quot;node-1&quot;]# åŠ å…¥è¯¥é…ç½®ï¼Œå®é™…ä¸Šæœ€å¥½åœ¨é‡å¯æ¯ä¸ªèŠ‚ç‚¹å‰ï¼Œå°†æ¯ä¸ªèŠ‚ç‚¹éƒ½é…ç½®ä¸ºè¿™æ ·discovery.seed_hosts: [&quot;10.250.0.239:9300&quot;, &quot;10.250.0.17:9300&quot;, &quot;10.250.0.173:9300&quot;] Kibanaå…³è”ESé›†ç¾¤ Kibana å…³è”å•èŠ‚ç‚¹ESå‚è€ƒ linuxä¸‹å®‰è£…Kibanaï¼Œåœ¨æ­¤åŸºç¡€ä¸Šå¯¹é…ç½®æ–‡ä»¶è¿›è¡Œå¦‚ä¸‹ä¿®æ”¹ï¼š 1234# å…³è”é›†ç¾¤çš„èŠ‚ç‚¹åœ°å€ï¼Œå°†é›†ç¾¤å†…æ‰€æœ‰èŠ‚ç‚¹çš„åœ°å€éƒ½é…ç½®åˆ°è¯¥å­—æ®µä¸­elasticsearch.hosts: [&#x27;https://10.250.0.239:9200&#x27;, &#x27;https://10.250.0.173:9200&#x27;, &#x27;https://10.250.0.17:9200&#x27;]# å…³è”é›†ç¾¤çš„è¾“å‡ºåœ°å€ï¼Œå°†é›†ç¾¤å†…æ‰€æœ‰èŠ‚ç‚¹çš„åœ°å€éƒ½é…ç½®åˆ°è¯¥å­—æ®µä¸­xpack.fleet.outputs: [&#123;id: fleet-default-output, name: default, is_default: true, is_default_monitoring: true, type: elasticsearch, hosts: [&#x27;https://10.250.0.239:9200&#x27;, &#x27;https://10.250.0.173:9200&#x27;, &#x27;https://10.250.0.17:9200&#x27;], ca_trusted_fingerprint: 3f141c16dfc6e165894bc1672084b220dcdd22ffe02116d51ac18003cfaa5a1d&#125;] é‡å¯Kibana åªè¦ä¿è¯é›†ç¾¤å†…è‡³å°‘æœ‰ä¸¤ä¸ªESèŠ‚ç‚¹å·¥ä½œæ­£å¸¸ï¼Œå³å¯æ­£å¸¸è®¿é—®Kibana nginxåå‘ä»£ç†ESé›†ç¾¤ 123456789101112131415161718192021222324252627282930313233343536373839vim /etc/nginx/conf.d/es.conf # æ·»åŠ å¦‚ä¸‹å†…å®¹upstream es &#123; server 10.250.0.239:9200; server 10.250.0.173:9200; server 10.250.0.17:9200;&#125;server &#123; listen 8888; server_name localhost es.domain; location / &#123; proxy_pass https://es; #è¿™ä¸ªåç§°å’Œè¦ä¸Šé¢ upstream es å¯¹åº”ï¼Œæ³¨æ„è¿™é‡Œæ˜¯ https åè®® proxy_redirect default; proxy_http_version 1.1; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; proxy_max_temp_file_size 0; #this is the maximum upload size client_max_body_size 10m; client_body_buffer_size 128k; proxy_connect_timeout 90; proxy_send_timeout 90; proxy_read_timeout 90; proxy_buffering off; proxy_request_buffering off; # Required for HTTP CLI commands proxy_set_header Connection &quot;&quot;; # Clear for keepalive &#125;&#125;# é‡å¯nginxsystemctl restart nginx# è®¿é—®ESé›†ç¾¤curl -u elastic:123456 http://127.0.0.1:8888/_cluster/health?pretty","summary":"æ‘˜è¦ æœ¬æ–‡ä»‹ç»å¦‚ä½•åœ¨linuxä¸‹å®‰è£…Elasticsearché›†ç¾¤(ä¸‰èŠ‚ç‚¹) Elasticsearchç‰ˆæœ¬8.17.3 å•èŠ‚ç‚¹å®‰è£…å‚è€ƒlinuxä¸‹å®‰è£…Elasticsearchï¼Œæœ¬æ–‡åœ¨æ­¤åŸºç¡€ä¸Šå®Œæˆé›†ç¾¤å®‰è£…","date_published":"2025-03-24T13:30:05.000Z","tags":["æŠ€æœ¯","elastic","elasticsearch","elasticsearch"]}]}