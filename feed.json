{"version":"https://jsonfeed.org/version/1","name":"飘逸峰的博客","home_page_url":"https://blog.hanqunfeng.com","feed_url":"https://blog.hanqunfeng.com/feed.json","author":{"name":"飘逸峰"},"items":[{"id":"https://blog.hanqunfeng.com/2022/09/06/redis5-config/","url":"https://blog.hanqunfeng.com/2022/09/06/redis5-config/","title":"redis5配置文件","content_html":"<h2 id=\"摘要\"><a href=\"#摘要\" class=\"headerlink\" title=\"摘要\"></a>摘要</h2><ul>\n<li>redis单节点、主从、哨兵、集群，配置文件的配置方式<span id=\"more\"></span></li>\n</ul>\n<h2 id=\"redis安装\"><a href=\"#redis安装\" class=\"headerlink\" title=\"redis安装\"></a>redis安装</h2><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 下载</span></span><br><span class=\"line\">wget https://download.redis.io/releases/redis-5.0.14.tar.gz</span><br><span class=\"line\"><span class=\"meta\"></span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 解压</span></span><br><span class=\"line\">tar -zxvf redis-5.0.14.tar.gz</span><br><span class=\"line\"><span class=\"meta\"></span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 编译</span></span><br><span class=\"line\">sudo yum install gcc</span><br><span class=\"line\">cd redis-5.0.14</span><br><span class=\"line\">make</span><br><span class=\"line\"><span class=\"meta\"></span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 编辑配置文件</span></span><br><span class=\"line\">mv redis.conf redis-6379.conf</span><br><span class=\"line\">vim redis-6379.conf #见下面的配置信息</span><br><span class=\"line\"><span class=\"meta\"></span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 启动redis</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 启动前要先创建好相关目录结构</span></span><br><span class=\"line\">mkdir -p /usr/local/soft/dir-redis5/6379</span><br><span class=\"line\">src/redis-server redis-6379.conf</span><br><span class=\"line\"><span class=\"meta\"></span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 加入环境变量 /etc/bashrc</span></span><br><span class=\"line\">export PATH=$PATH:/usr/local/soft/redis-5.0.14/src</span><br><span class=\"line\"><span class=\"meta\"></span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 快捷命令</span></span><br><span class=\"line\">alias redis-start=&quot;redis-server /usr/local/soft/redis-5.0.14/redis-6379.conf&quot;</span><br><span class=\"line\">alias redis-stop=&quot;pkill redis-server&quot;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"config命令设置\"><a href=\"#config命令设置\" class=\"headerlink\" title=\"config命令设置\"></a>config命令设置</h2><ul>\n<li>对于已经启动的redis服务，如果不想修改配置文件重启服务的话，也可以通过命令对部分参数进行设置，比如慢查询日志设置<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 查询</span></span><br><span class=\"line\">127.0.0.1:6379&gt; config get slow*</span><br><span class=\"line\">1) &quot;slowlog-log-slower-than&quot;</span><br><span class=\"line\">2) &quot;10000&quot;</span><br><span class=\"line\">3) &quot;slowlog-max-len&quot;</span><br><span class=\"line\">4) &quot;128&quot;</span><br><span class=\"line\"><span class=\"meta\"></span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 设置</span></span><br><span class=\"line\">127.0.0.1:6379&gt; config set slowlog-max-len 1024</span><br><span class=\"line\">OK</span><br><span class=\"line\"><span class=\"meta\"></span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 写入redis.conf</span></span><br><span class=\"line\">127.0.0.1:6379&gt; config rewrite</span><br><span class=\"line\">OK</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h2 id=\"单节点\"><a href=\"#单节点\" class=\"headerlink\" title=\"单节点\"></a>单节点</h2><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 后台启动</span></span><br><span class=\"line\">daemonize yes</span><br><span class=\"line\"><span class=\"meta\"></span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 如果不设置密码，需要关闭保护模式，开启的话只有本机能够访问，建议开启密码保护</span></span><br><span class=\"line\">protected-mode no</span><br><span class=\"line\"><span class=\"meta\"></span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 注释掉<span class=\"built_in\">bind</span>，绑定的是自己机器网卡的ip，如果有多块网卡可以配多个ip,代表允许客户端通过机器的哪些网卡ip去访问，内网一般可以不配置</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"><span class=\"built_in\">bind</span> 127.0.0.1</span></span><br><span class=\"line\"><span class=\"meta\"></span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 注释掉，因为会启用混合持久化，所以不需要开启rdb快照</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> save xx xxx</span></span><br><span class=\"line\"><span class=\"meta\"></span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 设置dir路径，redis日志、aof和rdb文件都会生成在这个路径下</span></span><br><span class=\"line\">dir /usr/local/soft/dir-redis5/6379</span><br><span class=\"line\"><span class=\"meta\"></span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 开启aof，实际上只需要开启这个配置，以下aof相关配置默认即可</span></span><br><span class=\"line\">appendonly yes</span><br><span class=\"line\"><span class=\"meta\"></span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> aof文件名称</span></span><br><span class=\"line\">appendfilename &quot;6379-appendonly.aof&quot;</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> aof将数据fsync到磁盘的策略，默认即可，表示每秒一次，故障时最多会丢失一秒的数据</span></span><br><span class=\"line\">appendfsync everysec</span><br><span class=\"line\"><span class=\"meta\"></span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> aof文件至少要达到64M才会自动重写，文件太小恢复速度本来就很快，重写的意义不大，默认即可</span></span><br><span class=\"line\">auto-aof-rewrite-min-size 64mb</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> aof文件自上一次重写后文件大小增长了100%则再次触发重写，默认即可</span></span><br><span class=\"line\">auto-aof-rewrite-percentage 100</span><br><span class=\"line\"><span class=\"meta\"></span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 开启混合持久化，4.0以后版本支持，需要先开启aof</span></span><br><span class=\"line\">aof-use-rdb-preamble yes</span><br><span class=\"line\"><span class=\"meta\"></span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> pid文件路径</span></span><br><span class=\"line\">pidfile /usr/local/soft/dir-redis5/6379/redis_6379.pid</span><br><span class=\"line\"><span class=\"meta\"></span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 日志文件名称</span></span><br><span class=\"line\">logfile &quot;6379.log&quot;</span><br><span class=\"line\"><span class=\"meta\"></span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 指定最大内存，单位bytes，这里设置4G</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 如果不设置最大内存，redis会默认为物理内存，达到上限时会频繁与磁盘发生交换，使redis性能急剧下降</span></span><br><span class=\"line\">maxmemory 4294967296</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 达到最大内存时的清除策略，推荐volatile-lru，淘汰很久没被访问过的数据，基于最近一次的访问时间</span></span><br><span class=\"line\">maxmemory-policy volatile-lru</span><br><span class=\"line\"><span class=\"meta\"></span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 慢查询日志</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 单位微妙，这里表示10毫秒，即超过10毫秒的操作都会记录下来</span></span><br><span class=\"line\">slowlog-log-slower-than 10000</span><br><span class=\"line\"><span class=\"meta\"></span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 设置慢查询日志记录保存数量，如果数量已满会删除最早的记录</span></span><br><span class=\"line\">slowlog-max-len 1024</span><br><span class=\"line\"><span class=\"meta\"></span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 开启密码</span></span><br><span class=\"line\">requirepass &quot;password&quot;</span><br></pre></td></tr></table></figure>\n\n","content_text":"摘要 redis单节点、主从、哨兵、集群，配置文件的配置方式 redis安装1234567891011121314151617181920212223242526# 下载wget https://download.redis.io/releases/redis-5.0.14.tar.gz# 解压tar -zxvf redis-5.0.14.tar.gz# 编译sudo yum install gcccd redis-5.0.14make# 编辑配置文件mv redis.conf redis-6379.confvim redis-6379.conf #见下面的配置信息# 启动redis# 启动前要先创建好相关目录结构mkdir -p /usr/local/soft/dir-redis5/6379src/redis-server redis-6379.conf# 加入环境变量 /etc/bashrcexport PATH=$PATH:/usr/local/soft/redis-5.0.14/src# 快捷命令alias redis-start=&quot;redis-server /usr/local/soft/redis-5.0.14/redis-6379.conf&quot;alias redis-stop=&quot;pkill redis-server&quot; config命令设置 对于已经启动的redis服务，如果不想修改配置文件重启服务的话，也可以通过命令对部分参数进行设置，比如慢查询日志设置123456789101112131415# 查询127.0.0.1:6379&gt; config get slow*1) &quot;slowlog-log-slower-than&quot;2) &quot;10000&quot;3) &quot;slowlog-max-len&quot;4) &quot;128&quot;# 设置127.0.0.1:6379&gt; config set slowlog-max-len 1024OK# 写入redis.conf127.0.0.1:6379&gt; config rewriteOK 单节点12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152# 后台启动daemonize yes# 如果不设置密码，需要关闭保护模式，开启的话只有本机能够访问，建议开启密码保护protected-mode no# 注释掉bind，绑定的是自己机器网卡的ip，如果有多块网卡可以配多个ip,代表允许客户端通过机器的哪些网卡ip去访问，内网一般可以不配置#bind 127.0.0.1# 注释掉，因为会启用混合持久化，所以不需要开启rdb快照# save xx xxx# 设置dir路径，redis日志、aof和rdb文件都会生成在这个路径下dir /usr/local/soft/dir-redis5/6379# 开启aof，实际上只需要开启这个配置，以下aof相关配置默认即可appendonly yes# aof文件名称appendfilename &quot;6379-appendonly.aof&quot;# aof将数据fsync到磁盘的策略，默认即可，表示每秒一次，故障时最多会丢失一秒的数据appendfsync everysec# aof文件至少要达到64M才会自动重写，文件太小恢复速度本来就很快，重写的意义不大，默认即可auto-aof-rewrite-min-size 64mb# aof文件自上一次重写后文件大小增长了100%则再次触发重写，默认即可auto-aof-rewrite-percentage 100# 开启混合持久化，4.0以后版本支持，需要先开启aofaof-use-rdb-preamble yes# pid文件路径pidfile /usr/local/soft/dir-redis5/6379/redis_6379.pid# 日志文件名称logfile &quot;6379.log&quot;# 指定最大内存，单位bytes，这里设置4G# 如果不设置最大内存，redis会默认为物理内存，达到上限时会频繁与磁盘发生交换，使redis性能急剧下降maxmemory 4294967296# 达到最大内存时的清除策略，推荐volatile-lru，淘汰很久没被访问过的数据，基于最近一次的访问时间maxmemory-policy volatile-lru# 慢查询日志# 单位微妙，这里表示10毫秒，即超过10毫秒的操作都会记录下来slowlog-log-slower-than 10000# 设置慢查询日志记录保存数量，如果数量已满会删除最早的记录slowlog-max-len 1024# 开启密码requirepass &quot;password&quot;","summary":"摘要 redis单节点、主从、哨兵、集群，配置文件的配置方式","date_published":"2022-09-06T13:30:05.000Z","tags":["技术","redis"]},{"id":"https://blog.hanqunfeng.com/2022/05/19/thymeleaf_study/","url":"https://blog.hanqunfeng.com/2022/05/19/thymeleaf_study/","title":"Spring Boot2学习笔记--thymeleaf","content_html":"<h2 id=\"摘要\"><a href=\"#摘要\" class=\"headerlink\" title=\"摘要\"></a>摘要</h2><p>看完本文你将掌握如下知识点：</p>\n<ul>\n<li>Spring Boot(2.4.4)中使用<a href=\"https://www.thymeleaf.org/\">thymeleaf(3.0.12)</a>的常用语法</li>\n</ul>\n<span id=\"more\"></span>\n\n<h2 id=\"项目准备\"><a href=\"#项目准备\" class=\"headerlink\" title=\"项目准备\"></a>项目准备</h2><h3 id=\"依赖\"><a href=\"#依赖\" class=\"headerlink\" title=\"依赖\"></a>依赖</h3><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!--spring对thymeleaf的支持--&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.boot<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"开启spring-boot对thymeleaf的支持\"><a href=\"#开启spring-boot对thymeleaf的支持\" class=\"headerlink\" title=\"开启spring boot对thymeleaf的支持\"></a>开启spring boot对thymeleaf的支持</h3><figure class=\"highlight properties\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">##thymeleaf</span></span><br><span class=\"line\"><span class=\"meta\">spring.thymeleaf.enabled</span>=<span class=\"string\">true</span></span><br><span class=\"line\"><span class=\"meta\">spring.thymeleaf.prefix</span>=<span class=\"string\">classpath:/templates/</span></span><br><span class=\"line\"><span class=\"meta\">spring.thymeleaf.suffix</span>=<span class=\"string\">.html</span></span><br><span class=\"line\"><span class=\"meta\">spring.thymeleaf.encoding</span>=<span class=\"string\">UTF-8</span></span><br><span class=\"line\"><span class=\"meta\">spring.thymeleaf.mode</span>=<span class=\"string\">HTML</span></span><br><span class=\"line\"><span class=\"comment\">#关闭页面缓存</span></span><br><span class=\"line\"><span class=\"meta\">spring.thymeleaf.cache</span>=<span class=\"string\">false</span></span><br><span class=\"line\"><span class=\"meta\">spring.thymeleaf.servlet.content-type</span>=<span class=\"string\">text/html</span></span><br></pre></td></tr></table></figure>\n\n<p>也可以通过@Bean的方式开启支持</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Bean</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> ThymeleafViewResolver <span class=\"title\">thymeleafViewResolver</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">    log.info(<span class=\"string\">&quot;thymeleafViewResolver&quot;</span>);</span><br><span class=\"line\">    ThymeleafViewResolver viewResolver = <span class=\"keyword\">new</span> ThymeleafViewResolver();</span><br><span class=\"line\">    viewResolver.setTemplateEngine(templateEngine());</span><br><span class=\"line\">    viewResolver.setOrder(<span class=\"number\">1</span>);</span><br><span class=\"line\">    viewResolver.setCharacterEncoding(<span class=\"string\">&quot;UTF-8&quot;</span>);</span><br><span class=\"line\">    viewResolver.setContentType(<span class=\"string\">&quot;text/html&quot;</span>);</span><br><span class=\"line\">    viewResolver.setCache(<span class=\"keyword\">false</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> viewResolver;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Bean</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> SpringResourceTemplateResolver <span class=\"title\">templateResolver</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">    SpringResourceTemplateResolver templateResolver = <span class=\"keyword\">new</span> SpringResourceTemplateResolver();</span><br><span class=\"line\">    templateResolver.setApplicationContext(<span class=\"keyword\">this</span>.applicationContext);</span><br><span class=\"line\">    templateResolver.setPrefix(<span class=\"string\">&quot;classpath:/templates/&quot;</span>);</span><br><span class=\"line\">    templateResolver.setSuffix(<span class=\"string\">&quot;.html&quot;</span>);</span><br><span class=\"line\">    templateResolver.setTemplateMode(TemplateMode.HTML);</span><br><span class=\"line\">    templateResolver.setCacheable(<span class=\"keyword\">false</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> templateResolver;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Bean</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> SpringTemplateEngine <span class=\"title\">templateEngine</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">    SpringTemplateEngine templateEngine = <span class=\"keyword\">new</span> SpringTemplateEngine();</span><br><span class=\"line\">    templateEngine.setTemplateResolver(templateResolver());</span><br><span class=\"line\">    templateEngine.setEnableSpringELCompiler(<span class=\"keyword\">true</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> templateEngine;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"开启html页面对thymeleaf语法的支持\"><a href=\"#开启html页面对thymeleaf语法的支持\" class=\"headerlink\" title=\"开启html页面对thymeleaf语法的支持\"></a>开启html页面对thymeleaf语法的支持</h3><figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE <span class=\"meta-keyword\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span> <span class=\"attr\">xmlns:th</span>=<span class=\"string\">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"语法\"><a href=\"#语法\" class=\"headerlink\" title=\"语法\"></a>语法</h2><h3 id=\"各种表达式语法\"><a href=\"#各种表达式语法\" class=\"headerlink\" title=\"各种表达式语法\"></a>各种表达式语法</h3><ol>\n<li>${…} 变量表达式，用于展示后台传递过来的变量（request和session中的值）<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text&quot;</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;modify&quot;</span> <span class=\"attr\">th:value</span>=<span class=\"string\">&quot;$&#123;modify&#125;&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text&quot;</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;id&quot;</span> <span class=\"attr\">th:value</span>=<span class=\"string\">&quot;$&#123;dataObj.id&#125;&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">textarea</span>  <span class=\"attr\">name</span>=<span class=\"string\">&quot;logParamData&quot;</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;logParamData&quot;</span> <span class=\"attr\">th:text</span>=<span class=\"string\">&quot;$&#123;dataObj.logParamData&#125;&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">textarea</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">以下两种方式效果一致</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">span</span> <span class=\"attr\">th:text</span>=<span class=\"string\">&quot;$&#123;dataObj.name&#125;&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">span</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">span</span>&gt;</span>[[$&#123;dataObj.name&#125;]]<span class=\"tag\">&lt;/<span class=\"name\">span</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">字符串拼接，可以使用加号，也可以使用竖线，以下两种方式效果一致</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;checkbox&quot;</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;accessTypes&quot;</span> <span class=\"attr\">th:value</span>=<span class=\"string\">&quot;$&#123;item.id&#125;+&#x27;_&#x27;+$&#123;type.id&#125;&quot;</span> <span class=\"attr\">checked</span>=<span class=\"string\">&quot;checked&quot;</span>&gt;</span> [[$&#123;type.name&#125;]</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;checkbox&quot;</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;accessTypes&quot;</span> <span class=\"attr\">th:value</span>=<span class=\"string\">&quot;$&#123;|$&#123;item.id&#125;_$&#123;type.id&#125;|&#125;&quot;</span> <span class=\"attr\">checked</span>=<span class=\"string\">&quot;checked&quot;</span>&gt;</span> [[$&#123;type.name&#125;]</span><br><span class=\"line\"></span><br><span class=\"line\">#dates与java.util.Date对象的方法对应，格式化、日期组件抽取等等</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">td</span> <span class=\"attr\">th:text</span>=<span class=\"string\">&quot;$&#123;#dates.format(item.logTime, &#x27;yyyy-MM-dd&#x27;)&#125;&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">td</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">td</span>&gt;</span>[[$&#123;#dates.format(item.logTime, &#x27;yyyy-MM-dd&#x27;)&#125;]]<span class=\"tag\">&lt;/<span class=\"name\">td</span>&gt;</span></span><br></pre></td></tr></table></figure></li>\n<li>#{…} 国际化消息表达式，用于展示message.properties等国际化资源文件中的内容<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;checkbox&quot;</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;selectAll&quot;</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;selectAll&quot;</span> <span class=\"attr\">th:text</span>=<span class=\"string\">&quot;#&#123;common.choose&#125;&quot;</span>/&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">消息中需要传递变量的情况，多个变量逗号分割</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">strong</span> <span class=\"attr\">th:text</span>=<span class=\"string\">&quot;#&#123;common.page.summary($&#123;_pageBean.pageCount&#125;,$&#123;_pageBean.total&#125;)&#125;&quot;</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">以下两种方式效果一致</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">td</span> <span class=\"attr\">th:text</span>=<span class=\"string\">&quot;#&#123;common.operate&#125;&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">td</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">td</span>&gt;</span>[[#&#123;common.operate&#125;]]<span class=\"tag\">&lt;/<span class=\"name\">td</span>&gt;</span></span><br></pre></td></tr></table></figure></li>\n<li>@{…} 链接url表达式，用于封装url，如contextPath补全<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">link</span> <span class=\"attr\">th:href</span>=<span class=\"string\">&quot;@&#123;/resource/css/netqin.css&#125;&quot;</span> <span class=\"attr\">rel</span>=<span class=\"string\">&quot;stylesheet&quot;</span>/&gt;</span></span><br><span class=\"line\">用两个竖线来拼接带表达式的字符串</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text/javascript&quot;</span> <span class=\"attr\">th:src</span>=<span class=\"string\">&quot;@&#123;|/resource/js/i18n/list.#&#123;locale&#125;.js|&#125;&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">带请求参数的url，多个用逗号分割</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">a</span> <span class=\"attr\">th:href</span>=<span class=\"string\">&quot;@&#123;/auth/systemLogger/edit.do(id=$&#123;item.id&#125;,flag=$&#123;flag&#125;)&#125;&quot;</span> <span class=\"attr\">th:text</span>=<span class=\"string\">&quot;#&#123;common.edit&#125;&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">a</span>&gt;</span></span><br></pre></td></tr></table></figure></li>\n<li>js和css中用到表达式时使用双中括号的方式<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 获取服务器完整地址</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> systemAddress = <span class=\"string\">&quot;[[$&#123;#httpServletRequest.getScheme() + &#x27;://&#x27; + #httpServletRequest.getServerName() + &#x27;:&#x27; + #request.getServerPort()&#125;]]&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 获取contextPath</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> ctxPath  = <span class=\"string\">&quot;[[@&#123;/&#125;]]&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 完整的请求路径前缀，注意后面跟的地址不要以`/`开头</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> serverPath = systemAddress + ctxPath;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 获取变量</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> modify = <span class=\"string\">&quot;[[$&#123;modify&#125;]]&quot;</span>;</span><br><span class=\"line\"><span class=\"keyword\">if</span>(modify != <span class=\"string\">&quot;add&quot;</span>)&#123;</span><br><span class=\"line\">    $(<span class=\"string\">&quot;#password&quot;</span>).attr(<span class=\"string\">&quot;placeholder&quot;</span>,<span class=\"string\">&quot;[[#&#123;user.detail.changeNotice&#125;]]&quot;</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n</ol>\n<ol start=\"5\">\n<li><p>*{…} 选择变量表达式，用于简写变量名称，需要配合th:object一起使用</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">th:object</span>=<span class=\"string\">&quot;$&#123;user&#125;&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">p</span>&gt;</span>firstName: <span class=\"tag\">&lt;<span class=\"name\">span</span> <span class=\"attr\">th:text</span>=<span class=\"string\">&quot;*&#123;firstName&#125;&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">span</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">p</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">p</span>&gt;</span>lastName: <span class=\"tag\">&lt;<span class=\"name\">span</span> <span class=\"attr\">th:text</span>=<span class=\"string\">&quot;*&#123;lastName&#125;&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">span</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">p</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">相当于</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">p</span>&gt;</span>firstName: <span class=\"tag\">&lt;<span class=\"name\">span</span> <span class=\"attr\">th:text</span>=<span class=\"string\">&quot;$&#123;user.firstName&#125;&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">span</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">p</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">p</span>&gt;</span>lastName: <span class=\"tag\">&lt;<span class=\"name\">span</span> <span class=\"attr\">th:text</span>=<span class=\"string\">&quot;$&#123;user.lastName&#125;&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">span</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">p</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br></pre></td></tr></table></figure></li>\n<li><p><code>~&#123;...&#125;</code> 代码块表达式，用于在html中复用相同的结构<br>语法：<code>~&#123;templatename::fragmentname&#125;</code><br>示例：<br>common/model.html，<code>th:fragment=&quot;header&quot;</code>指定代码块名称</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE <span class=\"meta-keyword\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span> <span class=\"attr\">xmlns:th</span>=<span class=\"string\">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">head</span> <span class=\"attr\">th:fragment</span>=<span class=\"string\">&quot;header&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">meta</span> <span class=\"attr\">http-equiv</span>=<span class=\"string\">&quot;Content-Type&quot;</span> <span class=\"attr\">content</span>=<span class=\"string\">&quot;text/html; charset=UTF-8&quot;</span> /&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">META</span> <span class=\"attr\">http-equiv</span>=<span class=\"string\">&quot;Pragma&quot;</span> <span class=\"attr\">content</span>=<span class=\"string\">&quot;no-cache&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">META</span> <span class=\"attr\">http-equiv</span>=<span class=\"string\">&quot;Cache-Control&quot;</span> <span class=\"attr\">content</span>=<span class=\"string\">&quot;no-cache&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">META</span> <span class=\"attr\">http-equiv</span>=<span class=\"string\">&quot;Expire&quot;</span> <span class=\"attr\">content</span>=<span class=\"string\">&quot;0&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">link</span> <span class=\"attr\">th:href</span>=<span class=\"string\">&quot;@&#123;/resource/css/bootstrap.min.css&#125;&quot;</span> <span class=\"attr\">rel</span>=<span class=\"string\">&quot;stylesheet&quot;</span> /&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">link</span> <span class=\"attr\">th:href</span>=<span class=\"string\">&quot;@&#123;/resource/css/ace.min.css&#125;&quot;</span> <span class=\"attr\">rel</span>=<span class=\"string\">&quot;stylesheet&quot;</span> /&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">link</span> <span class=\"attr\">rel</span>=<span class=\"string\">&quot;stylesheet&quot;</span> <span class=\"attr\">th:href</span>=<span class=\"string\">&quot;@&#123;/resource/css/font-awesome.min.css&#125;&quot;</span> /&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">th:src</span>=<span class=\"string\">&quot;@&#123;/resource/js/jquery-1.11.0.min.js&#125;&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure></li>\n</ol>\n<p>demo.html，<code>th:replace=&quot;common/model::header&quot;</code>，模板名称::代码块名称</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE <span class=\"meta-keyword\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span> <span class=\"attr\">xmlns:th</span>=<span class=\"string\">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">header</span> <span class=\"attr\">th:replace</span>=<span class=\"string\">&quot;common/model::header&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">header</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>说明：代码块表达式需要配合th属性（th:insert，th:replace，th:include）一起使用。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">th:insert：将代码块片段整个插入到使用了th:insert的HTML标签中，</span><br><span class=\"line\">th:replace：将代码块片段整个替换使用了th:replace的HTML标签中，</span><br><span class=\"line\">th:include：将代码块片段包含的内容插入到使用了th:include的HTML标签中，</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"遍历\"><a href=\"#遍历\" class=\"headerlink\" title=\"遍历\"></a>遍历</h3><h4 id=\"简单示例\"><a href=\"#简单示例\" class=\"headerlink\" title=\"简单示例\"></a>简单示例</h4><figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">tr</span> <span class=\"attr\">th:each</span>=<span class=\"string\">&quot;item:$&#123;results&#125;&quot;</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">td</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;checkbox&quot;</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;ids&quot;</span> <span class=\"attr\">th:value</span>=<span class=\"string\">&quot;$&#123;item.id&#125;&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;noborder&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">td</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">td</span> <span class=\"attr\">th:text</span>=<span class=\"string\">&quot;$&#123;item.id&#125;&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">td</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">td</span>&gt;</span></span><br><span class=\"line\">    [[$&#123;#dates.format(item.logTime, &#x27;yyyy-MM-dd&#x27;)&#125;]]</span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">td</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">td</span> <span class=\"attr\">th:text</span>=<span class=\"string\">&quot;$&#123;item.logDesc&#125;&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">td</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">td</span> <span class=\"attr\">th:text</span>=<span class=\"string\">&quot;$&#123;item.logUser&#125;&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">td</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">tr</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"带遍历状态的示例\"><a href=\"#带遍历状态的示例\" class=\"headerlink\" title=\"带遍历状态的示例\"></a>带遍历状态的示例</h4><figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">tr</span> <span class=\"attr\">th:each</span>=<span class=\"string\">&quot;item,status:$&#123;results&#125;&quot;</span> <span class=\"attr\">th:class</span>=<span class=\"string\">&quot;$&#123;status.odd&#125;? &#x27;odd&#x27;:&#x27;even&#x27;&quot;</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">td</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;checkbox&quot;</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;ids&quot;</span> <span class=\"attr\">th:value</span>=<span class=\"string\">&quot;$&#123;item.id&#125;&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;noborder&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">td</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">td</span> <span class=\"attr\">th:text</span>=<span class=\"string\">&quot;$&#123;item.id&#125;&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">td</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">td</span>&gt;</span></span><br><span class=\"line\">    [[$&#123;#dates.format(item.logTime, &#x27;yyyy-MM-dd&#x27;)&#125;]]</span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">td</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">td</span> <span class=\"attr\">th:text</span>=<span class=\"string\">&quot;$&#123;item.logDesc&#125;&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">td</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">td</span> <span class=\"attr\">th:text</span>=<span class=\"string\">&quot;$&#123;item.logUser&#125;&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">td</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">tr</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li>状态说明<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">index：当前遍历索引，从0开始</span><br><span class=\"line\">count：当前遍历索引，从1开始</span><br><span class=\"line\">size：总元素数量</span><br><span class=\"line\">current：每一次遍历的iter变量</span><br><span class=\"line\">even/odd：当前遍历是even还是odd，布尔属性</span><br><span class=\"line\">first：当前遍历是第一个，布尔属性</span><br><span class=\"line\">last：当前遍历是最后一个，布尔属性</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h4 id=\"遍历时可以自定义变量\"><a href=\"#遍历时可以自定义变量\" class=\"headerlink\" title=\"遍历时可以自定义变量\"></a>遍历时可以自定义变量</h4><figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">th:with：用于定义变量，多个使用逗号分割</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">span</span> <span class=\"attr\">th:each</span>=<span class=\"string\">&quot;type,status:$&#123;accessTypes&#125;&quot;</span> <span class=\"attr\">th:with</span>=<span class=\"string\">&quot;shwoName=$&#123;item.id&#125;+&#x27;_&#x27;+$&#123;item.name&#125;&quot;</span>&gt;</span></span><br><span class=\"line\">[[$&#123;shwoName&#125;]]</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">span</span> <span class=\"attr\">th:if</span>=<span class=\"string\">&quot;$&#123;not status.last&#125;&quot;</span>&gt;</span>,<span class=\"tag\">&lt;/<span class=\"name\">span</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">span</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"条件判断\"><a href=\"#条件判断\" class=\"headerlink\" title=\"条件判断\"></a>条件判断</h3><h4 id=\"th-if\"><a href=\"#th-if\" class=\"headerlink\" title=\"th:if\"></a>th:if</h4><figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">判断为true时才会显示div，authorities为Set类型，所以判断是否包含时可以使用#sets.contains()方法，测试时发现使用#arrays.contains()方法时也可以</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">th:if</span>=<span class=\"string\">&quot;$&#123;dataObj.reserved&#125;&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">li</span> <span class=\"attr\">th:each</span>=<span class=\"string\">&quot;item:$&#123;dataObj.authorities&#125;&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;checkbox&quot;</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;authorities&quot;</span> <span class=\"attr\">th:value</span>=<span class=\"string\">&quot;$&#123;item.id&#125;&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">              <span class=\"attr\">th:if</span>=<span class=\"string\">&quot;$&#123;dataObj.authorities ==null or not #sets.contains(dataObj.authorities,item)&#125;&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;checkbox&quot;</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;authorities&quot;</span> <span class=\"attr\">th:value</span>=<span class=\"string\">&quot;$&#123;item.id&#125;&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">              <span class=\"attr\">checked</span>=<span class=\"string\">&quot;checked&quot;</span> <span class=\"attr\">th:if</span>=<span class=\"string\">&quot;$&#123;dataObj.authorities !=null and #sets.contains(dataObj.authorities,item)&#125;&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">span</span> <span class=\"attr\">th:text</span>=<span class=\"string\">&quot;$&#123;item.showNameRole&#125;&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">span</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">li</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">如果要判断为false时才会显示div，可以判断值是否等于false，或者使用th:unless</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">th:if</span>=<span class=\"string\">&quot;$&#123;dataObj.reserved==false&#125;&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">li</span> <span class=\"attr\">th:each</span>=<span class=\"string\">&quot;item:$&#123;dataObj.authorities&#125;&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;checkbox&quot;</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;authorities&quot;</span> <span class=\"attr\">th:value</span>=<span class=\"string\">&quot;$&#123;item.id&#125;&quot;</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">span</span> <span class=\"attr\">th:text</span>=<span class=\"string\">&quot;$&#123;item.showNameRole&#125;&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">span</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">li</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">th:unless</span>=<span class=\"string\">&quot;$&#123;dataObj.reserved&#125;&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">li</span> <span class=\"attr\">th:each</span>=<span class=\"string\">&quot;item:$&#123;dataObj.authorities&#125;&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;checkbox&quot;</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;authorities&quot;</span> <span class=\"attr\">th:value</span>=<span class=\"string\">&quot;$&#123;item.id&#125;&quot;</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">span</span> <span class=\"attr\">th:text</span>=<span class=\"string\">&quot;$&#123;item.showNameRole&#125;&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">span</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">li</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<ul>\n<li>th:if 以下情况运算为true<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">值不为null</span><br><span class=\"line\">值为boolean且为true</span><br><span class=\"line\">值为数字且非0</span><br><span class=\"line\">值为字符且非0</span><br><span class=\"line\">值是字符串且不是：“false”，“off”，“no”</span><br><span class=\"line\">值是object,但不为null</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h4 id=\"th-switch-和-th-case\"><a href=\"#th-switch-和-th-case\" class=\"headerlink\" title=\"th:switch 和 th:case\"></a>th:switch 和 th:case</h4><figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bool匹配</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">th:switch</span>=<span class=\"string\">&quot;$&#123;dataObj.reserved&#125;&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">p</span> <span class=\"attr\">th:case</span>=<span class=\"string\">&quot;true&quot;</span>&gt;</span>true<span class=\"tag\">&lt;/<span class=\"name\">p</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">p</span> <span class=\"attr\">th:case</span>=<span class=\"string\">&quot;false&quot;</span>&gt;</span>false<span class=\"tag\">&lt;/<span class=\"name\">p</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">字符串匹配，要加单引号</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">th:switch</span>=<span class=\"string\">&quot;$&#123;item.showNameRole&#125;&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">p</span> <span class=\"attr\">th:case</span>=<span class=\"string\">&quot;&#x27;admin&#x27;&quot;</span>&gt;</span>administrator<span class=\"tag\">&lt;/<span class=\"name\">p</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">p</span> <span class=\"attr\">th:case</span>=<span class=\"string\">&quot;&#x27;manager&#x27;&quot;</span>&gt;</span>manager<span class=\"tag\">&lt;/<span class=\"name\">p</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">th:switch</span>=<span class=\"string\">&quot;$&#123;item.showNameRole&#125;&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">p</span> <span class=\"attr\">th:case</span>=<span class=\"string\">&quot;&#x27;admin&#x27;&quot;</span>&gt;</span>administrator<span class=\"tag\">&lt;/<span class=\"name\">p</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">p</span> <span class=\"attr\">th:case</span>=<span class=\"string\">&quot;&#x27;manager&#x27;&quot;</span>&gt;</span>manager<span class=\"tag\">&lt;/<span class=\"name\">p</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">p</span> <span class=\"attr\">th:case</span>=<span class=\"string\">&quot;*&quot;</span>&gt;</span>unknow<span class=\"tag\">&lt;/<span class=\"name\">p</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<ul>\n<li>说明：th:case=”*” 表示没有匹配成功时显示的内容</li>\n</ul>\n<h3 id=\"运算符\"><a href=\"#运算符\" class=\"headerlink\" title=\"运算符\"></a>运算符</h3><ul>\n<li>字符串连接<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">　　+ : $&#123;item.id&#125;+&#x27;_&#x27;+$&#123;type.id&#125;</span><br><span class=\"line\">　　|xxxx| : |The name is $&#123;name&#125;|</span><br></pre></td></tr></table></figure></li>\n<li>算术运算<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">　　+ , - , * , / , %  (二元运算符)</span><br><span class=\"line\">　　-  :负号（一元运算符）</span><br></pre></td></tr></table></figure></li>\n<li>布尔操作<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">　　and :且,or :或 (二元运算符)</span><br><span class=\"line\">　　!,not :非（一元操作符）</span><br></pre></td></tr></table></figure></li>\n<li>关系操作符<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">　　&gt; , &lt; , &gt;= , &lt;= (gt , lt , ge , le)</span><br><span class=\"line\">　　== , != (eq, ne)</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"表达式工具对象\"><a href=\"#表达式工具对象\" class=\"headerlink\" title=\"表达式工具对象\"></a>表达式工具对象</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#dates 与java.util.Date对象的方法对应，格式化、日期组件抽取等等，如：$&#123;#dates.format(item.lastupdate, &#x27;yyyy-MM-dd HH:mm:ss&#x27;)&#125;</span><br><span class=\"line\">#temporals 支持jdk8中新增的LocalDate,LocalDateTime的格式化，如：$&#123;#temporals.format(item.updateTime, &#x27;yyyy-MM-dd HH:mm:ss&#x27;)&#125;，新版本的spring-boot-starter-thymeleaf中已经默认加入了thymeleaf-extras-java8time依赖</span><br><span class=\"line\">#calendars 类似#dates，与java.util.Calendar对象对应</span><br><span class=\"line\">#numbers 格式化数字对象的工具方法</span><br><span class=\"line\">#strings 与java.lang.String对应的工具方法：contains、startsWith、prepending/appending等等</span><br><span class=\"line\">#objects 用于对象的工具方法</span><br><span class=\"line\">#bools 用于布尔运算的工具方法</span><br><span class=\"line\">#arrays 用于数组的工具方法</span><br><span class=\"line\">#lists 用于列表的工具方法</span><br><span class=\"line\">#sets 用于set的工具方法</span><br><span class=\"line\">#maps 用于map的工具方法</span><br><span class=\"line\">#aggregates 用于创建数组或集合的聚合的工具方法</span><br><span class=\"line\">#messages 用于在变量表达式内部获取外化消息的工具方法，与#&#123;…&#125;语法获取的方式相同</span><br><span class=\"line\">#ids 用于处理可能重复出现（例如，作为遍历的结果）的id属性的工具方法</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"获取环境变量和application-properties中的值\"><a href=\"#获取环境变量和application-properties中的值\" class=\"headerlink\" title=\"获取环境变量和application.properties中的值\"></a>获取环境变量和application.properties中的值</h2><figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- @environment可以获取环境变量中的属性 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">th:src</span>=<span class=\"string\">&quot;$&#123;@environment.getProperty(&#x27;image.path&#x27;) + item.path&#125;&quot;</span> <span class=\"attr\">width</span>=<span class=\"string\">&quot;60px&quot;</span> <span class=\"attr\">height</span>=<span class=\"string\">&quot;90px&quot;</span> <span class=\"attr\">style</span>=<span class=\"string\">&quot;cursor: pointer&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"使用springsecurity权限标签的方法\"><a href=\"#使用springsecurity权限标签的方法\" class=\"headerlink\" title=\"使用springsecurity权限标签的方法\"></a>使用springsecurity权限标签的方法</h2><p>添加依赖</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!--如果项目中使用到了springsecurity， 则要加入下面的依赖来使用权限标签--&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.thymeleaf.extras<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>thymeleaf-extras-springsecurity5<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>开启命名空间支持</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span> <span class=\"attr\">xmlns:th</span>=<span class=\"string\">&quot;http://www.thymeleaf.org&quot;</span> <span class=\"attr\">xmlns:sec</span>=<span class=\"string\">&quot;http://www.thymeleaf.org/thymeleaf-extras-springsecurity4&quot;</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">使用方式与jsp标签类似：</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">a</span> <span class=\"attr\">th:href</span>=<span class=\"string\">&quot;@&#123;/auth/systemLogger/edit.do&#125;&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;btn btn-success btn-xs no-hover&quot;</span> <span class=\"attr\">th:text</span>=<span class=\"string\">&quot;#&#123;common.create&#125;&quot;</span> <span class=\"attr\">sec:authorize</span>=<span class=\"string\">&quot;hasRole(&#x27;LOGGER_ADD&#x27;)&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">a</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">button</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;btn btn-danger btn-xs&quot;</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;delete&quot;</span> <span class=\"attr\">th:text</span>=<span class=\"string\">&quot;#&#123;common.delete&#125;&quot;</span> <span class=\"attr\">sec:authorize</span>=<span class=\"string\">&quot;hasRole(&#x27;LOGGER_DELETE&#x27;)&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">button</span>&gt;</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"调用spring管理的bean的方法，以及获取HttpSession对象和HttpServletRequest对象\"><a href=\"#调用spring管理的bean的方法，以及获取HttpSession对象和HttpServletRequest对象\" class=\"headerlink\" title=\"调用spring管理的bean的方法，以及获取HttpSession对象和HttpServletRequest对象\"></a>调用spring管理的bean的方法，以及获取HttpSession对象和HttpServletRequest对象</h2><p>语法：${@beanName.methodName(param,…)}<br>说明：beanName就是注册时的名称<br>示例：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#httpSession就是javax.servlet.http.HttpSession对象，可以简写为session</span><br><span class=\"line\">#httpServletRequest就是javax.servlet.http.HttpServletRequest对象，可以简写为request</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">span</span> <span class=\"attr\">th:text</span>=<span class=\"string\">&quot;$&#123;@commonService.clearSessionMessage(#httpServletRequest)&#125;&quot;</span> <span class=\"attr\">style</span>=<span class=\"string\">&quot;display: none&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">span</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"调用类的静态方法\"><a href=\"#调用类的静态方法\" class=\"headerlink\" title=\"调用类的静态方法\"></a>调用类的静态方法</h2><figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">th:with</span>=<span class=\"string\">&quot;authoritysString=$&#123;T(com.example.function.auth.util.AuthUtil).getAuthoritysHtmlString(dataObj.authorities)&#125;&quot;</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"参考资料\"><a href=\"#参考资料\" class=\"headerlink\" title=\"参考资料\"></a>参考资料</h2><ul>\n<li><a href=\"https://www.cnblogs.com/itdragon/archive/2018/04/13/8724291.html\">https://www.cnblogs.com/itdragon/archive/2018/04/13/8724291.html</a></li>\n<li><a href=\"https://blog.csdn.net/abap_brave/article/details/53009149\">https://blog.csdn.net/abap_brave/article/details/53009149</a></li>\n<li><a href=\"https://blog.csdn.net/u014748504/article/details/108691712\">https://blog.csdn.net/u014748504/article/details/108691712</a></li>\n</ul>\n","content_text":"摘要看完本文你将掌握如下知识点： Spring Boot(2.4.4)中使用thymeleaf(3.0.12)的常用语法 项目准备依赖123456&lt;!--spring对thymeleaf的支持--&gt;&lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-thymeleaf&lt;/artifactId&gt;&lt;/dependency&gt; 开启spring boot对thymeleaf的支持123456789##thymeleafspring.thymeleaf.enabled=truespring.thymeleaf.prefix=classpath:/templates/spring.thymeleaf.suffix=.htmlspring.thymeleaf.encoding=UTF-8spring.thymeleaf.mode=HTML#关闭页面缓存spring.thymeleaf.cache=falsespring.thymeleaf.servlet.content-type=text/html 也可以通过@Bean的方式开启支持 123456789101112131415161718192021222324252627282930@Beanpublic ThymeleafViewResolver thymeleafViewResolver()&#123; log.info(&quot;thymeleafViewResolver&quot;); ThymeleafViewResolver viewResolver = new ThymeleafViewResolver(); viewResolver.setTemplateEngine(templateEngine()); viewResolver.setOrder(1); viewResolver.setCharacterEncoding(&quot;UTF-8&quot;); viewResolver.setContentType(&quot;text/html&quot;); viewResolver.setCache(false); return viewResolver;&#125;@Beanpublic SpringResourceTemplateResolver templateResolver()&#123; SpringResourceTemplateResolver templateResolver = new SpringResourceTemplateResolver(); templateResolver.setApplicationContext(this.applicationContext); templateResolver.setPrefix(&quot;classpath:/templates/&quot;); templateResolver.setSuffix(&quot;.html&quot;); templateResolver.setTemplateMode(TemplateMode.HTML); templateResolver.setCacheable(false); return templateResolver;&#125;@Beanpublic SpringTemplateEngine templateEngine()&#123; SpringTemplateEngine templateEngine = new SpringTemplateEngine(); templateEngine.setTemplateResolver(templateResolver()); templateEngine.setEnableSpringELCompiler(true); return templateEngine;&#125; 开启html页面对thymeleaf语法的支持123&lt;!DOCTYPE html&gt;&lt;html xmlns:th=&quot;http://www.thymeleaf.org&quot;&gt;&lt;/html&gt; 语法各种表达式语法 ${…} 变量表达式，用于展示后台传递过来的变量（request和session中的值）123456789101112131415&lt;input type=&quot;text&quot; name=&quot;modify&quot; th:value=&quot;$&#123;modify&#125;&quot;/&gt;&lt;input type=&quot;text&quot; name=&quot;id&quot; th:value=&quot;$&#123;dataObj.id&#125;&quot;/&gt;&lt;textarea name=&quot;logParamData&quot; id=&quot;logParamData&quot; th:text=&quot;$&#123;dataObj.logParamData&#125;&quot;&gt;&lt;/textarea&gt;以下两种方式效果一致&lt;span th:text=&quot;$&#123;dataObj.name&#125;&quot;&gt;&lt;/span&gt;&lt;span&gt;[[$&#123;dataObj.name&#125;]]&lt;/span&gt;字符串拼接，可以使用加号，也可以使用竖线，以下两种方式效果一致&lt;input type=&quot;checkbox&quot; name=&quot;accessTypes&quot; th:value=&quot;$&#123;item.id&#125;+&#x27;_&#x27;+$&#123;type.id&#125;&quot; checked=&quot;checked&quot;&gt; [[$&#123;type.name&#125;]&lt;input type=&quot;checkbox&quot; name=&quot;accessTypes&quot; th:value=&quot;$&#123;|$&#123;item.id&#125;_$&#123;type.id&#125;|&#125;&quot; checked=&quot;checked&quot;&gt; [[$&#123;type.name&#125;]#dates与java.util.Date对象的方法对应，格式化、日期组件抽取等等&lt;td th:text=&quot;$&#123;#dates.format(item.logTime, &#x27;yyyy-MM-dd&#x27;)&#125;&quot;&gt;&lt;/td&gt;&lt;td&gt;[[$&#123;#dates.format(item.logTime, &#x27;yyyy-MM-dd&#x27;)&#125;]]&lt;/td&gt; #{…} 国际化消息表达式，用于展示message.properties等国际化资源文件中的内容12345678&lt;input type=&quot;checkbox&quot; name=&quot;selectAll&quot; id=&quot;selectAll&quot; th:text=&quot;#&#123;common.choose&#125;&quot;/&gt;消息中需要传递变量的情况，多个变量逗号分割&lt;strong th:text=&quot;#&#123;common.page.summary($&#123;_pageBean.pageCount&#125;,$&#123;_pageBean.total&#125;)&#125;&quot;&gt;以下两种方式效果一致&lt;td th:text=&quot;#&#123;common.operate&#125;&quot;&gt;&lt;/td&gt;&lt;td&gt;[[#&#123;common.operate&#125;]]&lt;/td&gt; @{…} 链接url表达式，用于封装url，如contextPath补全12345&lt;link th:href=&quot;@&#123;/resource/css/netqin.css&#125;&quot; rel=&quot;stylesheet&quot;/&gt;用两个竖线来拼接带表达式的字符串&lt;script type=&quot;text/javascript&quot; th:src=&quot;@&#123;|/resource/js/i18n/list.#&#123;locale&#125;.js|&#125;&quot;&gt;&lt;/script&gt;带请求参数的url，多个用逗号分割&lt;a th:href=&quot;@&#123;/auth/systemLogger/edit.do(id=$&#123;item.id&#125;,flag=$&#123;flag&#125;)&#125;&quot; th:text=&quot;#&#123;common.edit&#125;&quot;&gt;&lt;/a&gt; js和css中用到表达式时使用双中括号的方式1234567891011121314// 获取服务器完整地址var systemAddress = &quot;[[$&#123;#httpServletRequest.getScheme() + &#x27;://&#x27; + #httpServletRequest.getServerName() + &#x27;:&#x27; + #request.getServerPort()&#125;]]&quot;// 获取contextPathvar ctxPath = &quot;[[@&#123;/&#125;]]&quot;;// 完整的请求路径前缀，注意后面跟的地址不要以`/`开头var serverPath = systemAddress + ctxPath;// 获取变量var modify = &quot;[[$&#123;modify&#125;]]&quot;;if(modify != &quot;add&quot;)&#123; $(&quot;#password&quot;).attr(&quot;placeholder&quot;,&quot;[[#&#123;user.detail.changeNotice&#125;]]&quot;);&#125; *{…} 选择变量表达式，用于简写变量名称，需要配合th:object一起使用 123456789&lt;div th:object=&quot;$&#123;user&#125;&quot;&gt; &lt;p&gt;firstName: &lt;span th:text=&quot;*&#123;firstName&#125;&quot;&gt;&lt;/span&gt;&lt;/p&gt; &lt;p&gt;lastName: &lt;span th:text=&quot;*&#123;lastName&#125;&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;/div&gt;相当于&lt;div&gt; &lt;p&gt;firstName: &lt;span th:text=&quot;$&#123;user.firstName&#125;&quot;&gt;&lt;/span&gt;&lt;/p&gt; &lt;p&gt;lastName: &lt;span th:text=&quot;$&#123;user.lastName&#125;&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;/div&gt; ~&#123;...&#125; 代码块表达式，用于在html中复用相同的结构语法：~&#123;templatename::fragmentname&#125;示例：common/model.html，th:fragment=&quot;header&quot;指定代码块名称 123456789101112131415&lt;!DOCTYPE html&gt;&lt;html xmlns:th=&quot;http://www.thymeleaf.org&quot;&gt; &lt;head th:fragment=&quot;header&quot;&gt; &lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=UTF-8&quot; /&gt; &lt;META http-equiv=&quot;Pragma&quot; content=&quot;no-cache&quot;&gt; &lt;META http-equiv=&quot;Cache-Control&quot; content=&quot;no-cache&quot;&gt; &lt;META http-equiv=&quot;Expire&quot; content=&quot;0&quot;&gt; &lt;link th:href=&quot;@&#123;/resource/css/bootstrap.min.css&#125;&quot; rel=&quot;stylesheet&quot; /&gt; &lt;link th:href=&quot;@&#123;/resource/css/ace.min.css&#125;&quot; rel=&quot;stylesheet&quot; /&gt; &lt;link rel=&quot;stylesheet&quot; th:href=&quot;@&#123;/resource/css/font-awesome.min.css&#125;&quot; /&gt; &lt;script th:src=&quot;@&#123;/resource/js/jquery-1.11.0.min.js&#125;&quot;&gt;&lt;/script&gt; &lt;/head&gt; &lt;body&gt; &lt;/body&gt;&lt;/html&gt; demo.html，th:replace=&quot;common/model::header&quot;，模板名称::代码块名称 1234567&lt;!DOCTYPE html&gt;&lt;html xmlns:th=&quot;http://www.thymeleaf.org&quot;&gt; &lt;header th:replace=&quot;common/model::header&quot;&gt;&lt;/header&gt; &lt;body&gt; &lt;/body&gt;&lt;/html&gt; 说明：代码块表达式需要配合th属性（th:insert，th:replace，th:include）一起使用。 123th:insert：将代码块片段整个插入到使用了th:insert的HTML标签中，th:replace：将代码块片段整个替换使用了th:replace的HTML标签中，th:include：将代码块片段包含的内容插入到使用了th:include的HTML标签中， 遍历简单示例1234567891011&lt;tr th:each=&quot;item:$&#123;results&#125;&quot;&gt;&lt;td&gt; &lt;input type=&quot;checkbox&quot; name=&quot;ids&quot; th:value=&quot;$&#123;item.id&#125;&quot; class=&quot;noborder&quot;/&gt;&lt;/td&gt;&lt;td th:text=&quot;$&#123;item.id&#125;&quot;&gt;&lt;/td&gt;&lt;td&gt; [[$&#123;#dates.format(item.logTime, &#x27;yyyy-MM-dd&#x27;)&#125;]]&lt;/td&gt;&lt;td th:text=&quot;$&#123;item.logDesc&#125;&quot;&gt;&lt;/td&gt;&lt;td th:text=&quot;$&#123;item.logUser&#125;&quot;&gt;&lt;/td&gt;&lt;/tr&gt; 带遍历状态的示例1234567891011&lt;tr th:each=&quot;item,status:$&#123;results&#125;&quot; th:class=&quot;$&#123;status.odd&#125;? &#x27;odd&#x27;:&#x27;even&#x27;&quot;&gt;&lt;td&gt; &lt;input type=&quot;checkbox&quot; name=&quot;ids&quot; th:value=&quot;$&#123;item.id&#125;&quot; class=&quot;noborder&quot;/&gt;&lt;/td&gt;&lt;td th:text=&quot;$&#123;item.id&#125;&quot;&gt;&lt;/td&gt;&lt;td&gt; [[$&#123;#dates.format(item.logTime, &#x27;yyyy-MM-dd&#x27;)&#125;]]&lt;/td&gt;&lt;td th:text=&quot;$&#123;item.logDesc&#125;&quot;&gt;&lt;/td&gt;&lt;td th:text=&quot;$&#123;item.logUser&#125;&quot;&gt;&lt;/td&gt;&lt;/tr&gt; 状态说明1234567index：当前遍历索引，从0开始count：当前遍历索引，从1开始size：总元素数量current：每一次遍历的iter变量even/odd：当前遍历是even还是odd，布尔属性first：当前遍历是第一个，布尔属性last：当前遍历是最后一个，布尔属性 遍历时可以自定义变量12345th:with：用于定义变量，多个使用逗号分割&lt;span th:each=&quot;type,status:$&#123;accessTypes&#125;&quot; th:with=&quot;shwoName=$&#123;item.id&#125;+&#x27;_&#x27;+$&#123;item.name&#125;&quot;&gt;[[$&#123;shwoName&#125;]]&lt;span th:if=&quot;$&#123;not status.last&#125;&quot;&gt;,&lt;/span&gt;&lt;/span&gt; 条件判断th:if123456789101112131415161718192021222324判断为true时才会显示div，authorities为Set类型，所以判断是否包含时可以使用#sets.contains()方法，测试时发现使用#arrays.contains()方法时也可以&lt;div th:if=&quot;$&#123;dataObj.reserved&#125;&quot;&gt; &lt;li th:each=&quot;item:$&#123;dataObj.authorities&#125;&quot;&gt; &lt;input type=&quot;checkbox&quot; name=&quot;authorities&quot; th:value=&quot;$&#123;item.id&#125;&quot; th:if=&quot;$&#123;dataObj.authorities ==null or not #sets.contains(dataObj.authorities,item)&#125;&quot;&gt; &lt;input type=&quot;checkbox&quot; name=&quot;authorities&quot; th:value=&quot;$&#123;item.id&#125;&quot; checked=&quot;checked&quot; th:if=&quot;$&#123;dataObj.authorities !=null and #sets.contains(dataObj.authorities,item)&#125;&quot;&gt; &lt;span th:text=&quot;$&#123;item.showNameRole&#125;&quot;&gt;&lt;/span&gt; &lt;/li&gt;&lt;/div&gt;如果要判断为false时才会显示div，可以判断值是否等于false，或者使用th:unless&lt;div th:if=&quot;$&#123;dataObj.reserved==false&#125;&quot;&gt; &lt;li th:each=&quot;item:$&#123;dataObj.authorities&#125;&quot;&gt; &lt;input type=&quot;checkbox&quot; name=&quot;authorities&quot; th:value=&quot;$&#123;item.id&#125;&quot;&gt;&lt;span th:text=&quot;$&#123;item.showNameRole&#125;&quot;&gt;&lt;/span&gt; &lt;/li&gt;&lt;/div&gt;&lt;div th:unless=&quot;$&#123;dataObj.reserved&#125;&quot;&gt; &lt;li th:each=&quot;item:$&#123;dataObj.authorities&#125;&quot;&gt; &lt;input type=&quot;checkbox&quot; name=&quot;authorities&quot; th:value=&quot;$&#123;item.id&#125;&quot;&gt;&lt;span th:text=&quot;$&#123;item.showNameRole&#125;&quot;&gt;&lt;/span&gt; &lt;/li&gt;&lt;/div&gt; th:if 以下情况运算为true123456值不为null值为boolean且为true值为数字且非0值为字符且非0值是字符串且不是：“false”，“off”，“no”值是object,但不为null th:switch 和 th:case12345678910111213141516171819bool匹配&lt;div th:switch=&quot;$&#123;dataObj.reserved&#125;&quot;&gt; &lt;p th:case=&quot;true&quot;&gt;true&lt;/p&gt; &lt;p th:case=&quot;false&quot;&gt;false&lt;/p&gt;&lt;/div&gt;字符串匹配，要加单引号&lt;div th:switch=&quot;$&#123;item.showNameRole&#125;&quot;&gt; &lt;p th:case=&quot;&#x27;admin&#x27;&quot;&gt;administrator&lt;/p&gt; &lt;p th:case=&quot;&#x27;manager&#x27;&quot;&gt;manager&lt;/p&gt;&lt;/div&gt;&lt;div th:switch=&quot;$&#123;item.showNameRole&#125;&quot;&gt; &lt;p th:case=&quot;&#x27;admin&#x27;&quot;&gt;administrator&lt;/p&gt; &lt;p th:case=&quot;&#x27;manager&#x27;&quot;&gt;manager&lt;/p&gt; &lt;p th:case=&quot;*&quot;&gt;unknow&lt;/p&gt;&lt;/div&gt; 说明：th:case=”*” 表示没有匹配成功时显示的内容 运算符 字符串连接12 + : $&#123;item.id&#125;+&#x27;_&#x27;+$&#123;type.id&#125; |xxxx| : |The name is $&#123;name&#125;| 算术运算12 + , - , * , / , % (二元运算符) - :负号（一元运算符） 布尔操作12 and :且,or :或 (二元运算符) !,not :非（一元操作符） 关系操作符12 &gt; , &lt; , &gt;= , &lt;= (gt , lt , ge , le) == , != (eq, ne) 表达式工具对象1234567891011121314#dates 与java.util.Date对象的方法对应，格式化、日期组件抽取等等，如：$&#123;#dates.format(item.lastupdate, &#x27;yyyy-MM-dd HH:mm:ss&#x27;)&#125;#temporals 支持jdk8中新增的LocalDate,LocalDateTime的格式化，如：$&#123;#temporals.format(item.updateTime, &#x27;yyyy-MM-dd HH:mm:ss&#x27;)&#125;，新版本的spring-boot-starter-thymeleaf中已经默认加入了thymeleaf-extras-java8time依赖#calendars 类似#dates，与java.util.Calendar对象对应#numbers 格式化数字对象的工具方法#strings 与java.lang.String对应的工具方法：contains、startsWith、prepending/appending等等#objects 用于对象的工具方法#bools 用于布尔运算的工具方法#arrays 用于数组的工具方法#lists 用于列表的工具方法#sets 用于set的工具方法#maps 用于map的工具方法#aggregates 用于创建数组或集合的聚合的工具方法#messages 用于在变量表达式内部获取外化消息的工具方法，与#&#123;…&#125;语法获取的方式相同#ids 用于处理可能重复出现（例如，作为遍历的结果）的id属性的工具方法 获取环境变量和application.properties中的值12&lt;!-- @environment可以获取环境变量中的属性 --&gt;&lt;img th:src=&quot;$&#123;@environment.getProperty(&#x27;image.path&#x27;) + item.path&#125;&quot; width=&quot;60px&quot; height=&quot;90px&quot; style=&quot;cursor: pointer&quot;&gt; 使用springsecurity权限标签的方法添加依赖 12345&lt;!--如果项目中使用到了springsecurity， 则要加入下面的依赖来使用权限标签--&gt;&lt;dependency&gt; &lt;groupId&gt;org.thymeleaf.extras&lt;/groupId&gt; &lt;artifactId&gt;thymeleaf-extras-springsecurity5&lt;/artifactId&gt;&lt;/dependency&gt; 开启命名空间支持 1234567&lt;html xmlns:th=&quot;http://www.thymeleaf.org&quot; xmlns:sec=&quot;http://www.thymeleaf.org/thymeleaf-extras-springsecurity4&quot;&gt;&lt;/html&gt;使用方式与jsp标签类似：&lt;a th:href=&quot;@&#123;/auth/systemLogger/edit.do&#125;&quot; class=&quot;btn btn-success btn-xs no-hover&quot; th:text=&quot;#&#123;common.create&#125;&quot; sec:authorize=&quot;hasRole(&#x27;LOGGER_ADD&#x27;)&quot;&gt;&lt;/a&gt;&lt;button class=&quot;btn btn-danger btn-xs&quot; id=&quot;delete&quot; th:text=&quot;#&#123;common.delete&#125;&quot; sec:authorize=&quot;hasRole(&#x27;LOGGER_DELETE&#x27;)&quot;&gt;&lt;/button&gt; 调用spring管理的bean的方法，以及获取HttpSession对象和HttpServletRequest对象语法：${@beanName.methodName(param,…)}说明：beanName就是注册时的名称示例： 123#httpSession就是javax.servlet.http.HttpSession对象，可以简写为session#httpServletRequest就是javax.servlet.http.HttpServletRequest对象，可以简写为request&lt;span th:text=&quot;$&#123;@commonService.clearSessionMessage(#httpServletRequest)&#125;&quot; style=&quot;display: none&quot;&gt;&lt;/span&gt; 调用类的静态方法12&lt;div th:with=&quot;authoritysString=$&#123;T(com.example.function.auth.util.AuthUtil).getAuthoritysHtmlString(dataObj.authorities)&#125;&quot;&gt;&lt;/div&gt; 参考资料 https://www.cnblogs.com/itdragon/archive/2018/04/13/8724291.html https://blog.csdn.net/abap_brave/article/details/53009149 https://blog.csdn.net/u014748504/article/details/108691712","summary":"摘要看完本文你将掌握如下知识点： Spring Boot(2.4.4)中使用thymeleaf(3.0.12)的常用语法","date_published":"2022-05-19T06:24:04.000Z","tags":["技术","springboot2","Java","Spring Boot"]},{"id":"https://blog.hanqunfeng.com/2021/12/02/maven-setting/","url":"https://blog.hanqunfeng.com/2021/12/02/maven-setting/","title":"Maven仓库及镜像配置","content_html":"<h2 id=\"摘要\"><a href=\"#摘要\" class=\"headerlink\" title=\"摘要\"></a>摘要</h2><ul>\n<li>maven仓库和镜像的配置及其关联方式</li>\n</ul>\n<span id=\"more\"></span>\n\n\n<h2 id=\"依赖查找顺序-按优先级排序，由高到低\"><a href=\"#依赖查找顺序-按优先级排序，由高到低\" class=\"headerlink\" title=\"依赖查找顺序(按优先级排序，由高到低)\"></a>依赖查找顺序(按优先级排序，由高到低)</h2><ul>\n<li>本地仓库，setting.xml中<code>settings.localRepository</code>的配置地址</li>\n<li>settings.xml中profile.repositories配置的仓库，<code>settings.profiles.profile.repositories.repository</code>，注意要激活对应的profile</li>\n<li>pom.xml中profile.repositories配置的仓库，<code>project.profiles.profile.repositories.repository</code>,注意要在settings.xml中激活对应的profile</li>\n<li>pom.xml中repositories配置的仓库，<code>project.repositories.repository</code></li>\n<li>maven默认的中央仓库:<a href=\"https://repo.maven.apache.org/maven2\">https://repo.maven.apache.org/maven2</a></li>\n</ul>\n<h3 id=\"说明，仓库的查找顺序实际上就是最终的pom-xml中仓库的声明顺序，所以可以通过如下命令导出最终的pom信息进行查看\"><a href=\"#说明，仓库的查找顺序实际上就是最终的pom-xml中仓库的声明顺序，所以可以通过如下命令导出最终的pom信息进行查看\" class=\"headerlink\" title=\"说明，仓库的查找顺序实际上就是最终的pom.xml中仓库的声明顺序，所以可以通过如下命令导出最终的pom信息进行查看\"></a>说明，仓库的查找顺序实际上就是最终的pom.xml中仓库的声明顺序，所以可以通过如下命令导出最终的pom信息进行查看</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mvn help:effective-pom -Doutput=EffectivePom.xml</span><br></pre></td></tr></table></figure>\n\n\n<h2 id=\"仓库配置–repository\"><a href=\"#仓库配置–repository\" class=\"headerlink\" title=\"仓库配置–repository\"></a>仓库配置–repository</h2><ul>\n<li>可以将仓库信息配置在<code>settings.xml</code>或<code>pom.xml</code>中，如下可以配置多个，按顺序依次查找，注意这里的id必须唯一，<code>repository</code>和<code>pluginRepository</code>的id可以相同:<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">repositories</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">repository</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">id</span>&gt;</span>nexus<span class=\"tag\">&lt;/<span class=\"name\">id</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">url</span>&gt;</span>http://nexus.my.local:8080/repository/maven-public/<span class=\"tag\">&lt;/<span class=\"name\">url</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">releases</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">enabled</span>&gt;</span>true<span class=\"tag\">&lt;/<span class=\"name\">enabled</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">releases</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">snapshots</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">enabled</span>&gt;</span>true<span class=\"tag\">&lt;/<span class=\"name\">enabled</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">snapshots</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">repository</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">repository</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">id</span>&gt;</span>aliyun<span class=\"tag\">&lt;/<span class=\"name\">id</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">url</span>&gt;</span>https://maven.aliyun.com/repository/public<span class=\"tag\">&lt;/<span class=\"name\">url</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">releases</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">enabled</span>&gt;</span>true<span class=\"tag\">&lt;/<span class=\"name\">enabled</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">releases</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">snapshots</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">enabled</span>&gt;</span>true<span class=\"tag\">&lt;/<span class=\"name\">enabled</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">snapshots</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">repository</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">repositories</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">pluginRepositories</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">pluginRepository</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">id</span>&gt;</span>nexus<span class=\"tag\">&lt;/<span class=\"name\">id</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">url</span>&gt;</span>http://nexus.my.local:8080/repository/maven-public/<span class=\"tag\">&lt;/<span class=\"name\">url</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">releases</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">enabled</span>&gt;</span>true<span class=\"tag\">&lt;/<span class=\"name\">enabled</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">releases</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">snapshots</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">enabled</span>&gt;</span>true<span class=\"tag\">&lt;/<span class=\"name\">enabled</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">snapshots</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">pluginRepository</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">pluginRepository</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">id</span>&gt;</span>aliyun<span class=\"tag\">&lt;/<span class=\"name\">id</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">url</span>&gt;</span>https://maven.aliyun.com/repository/public<span class=\"tag\">&lt;/<span class=\"name\">url</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">releases</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">enabled</span>&gt;</span>true<span class=\"tag\">&lt;/<span class=\"name\">enabled</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">releases</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">snapshots</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">enabled</span>&gt;</span>true<span class=\"tag\">&lt;/<span class=\"name\">enabled</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">snapshots</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">pluginRepository</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">pluginRepositories</span>&gt;</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h2 id=\"镜像代理–mirror\"><a href=\"#镜像代理–mirror\" class=\"headerlink\" title=\"镜像代理–mirror\"></a>镜像代理–mirror</h2><h3 id=\"说明\"><a href=\"#说明\" class=\"headerlink\" title=\"说明\"></a>说明</h3><ul>\n<li>由于网络等原因导致我们不能很顺利的从仓库下载到对应的依赖，此时我们可以为仓库配置镜像代理，加快下载速度，国内一般会使用阿里云作为镜像代理</li>\n<li>mirror镜像可以配置多个，每个mirrorOf里可以配置如下内容：</li>\n</ul>\n<ol>\n<li><code>*</code> : 匹配所有仓库，一般我们搭建了自己的私服时推荐这样设置</li>\n<li><code>repo1Id</code>  : 匹配仓库id为repo1Id的仓库</li>\n<li><code>repo1Id,repo2Id</code>  : 匹配仓库id为repo1Id和repo2Id的仓库</li>\n<li><code>*,!repo1Id</code>  : 匹配所有仓库，但不包含repo1Id</li>\n<li><code>external:*</code> : 匹配所有不在本机上的远程仓库，也就是说，如果仓库的url里配置的是<code>localhost</code>或者<code>file://</code>则不进行代理</li>\n</ol>\n<h3 id=\"镜像代理需要配置在setting-xml中\"><a href=\"#镜像代理需要配置在setting-xml中\" class=\"headerlink\" title=\"镜像代理需要配置在setting.xml中\"></a>镜像代理需要配置在setting.xml中</h3><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">mirrors</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">mirror</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">id</span>&gt;</span>aliyun-mirror<span class=\"tag\">&lt;/<span class=\"name\">id</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>aliyun-mirror<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- mirrorOf 里配置要代理的仓库id，这样当请求该仓库时就会走这个镜像代理 --&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- maven默认配置的仓库id就是central，此时就是使用阿里云作为默认仓库的代理 --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">mirrorOf</span>&gt;</span>central<span class=\"tag\">&lt;/<span class=\"name\">mirrorOf</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">url</span>&gt;</span>https://maven.aliyun.com/repository/public<span class=\"tag\">&lt;/<span class=\"name\">url</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">mirror</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">mirror</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">id</span>&gt;</span>nexus-mirror<span class=\"tag\">&lt;/<span class=\"name\">id</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>nexus-mirror<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- mirrorOf 里配置要代理的仓库id，这样当请求该仓库时就会走这个镜像代理 --&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- 此时就是使用nexus私服代理所有仓库 --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">mirrorOf</span>&gt;</span>*<span class=\"tag\">&lt;/<span class=\"name\">mirrorOf</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">url</span>&gt;</span>http://nexus.my.local:8080/repository/maven-public/<span class=\"tag\">&lt;/<span class=\"name\">url</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">mirror</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">mirrors</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"maven3-8-1以后的配置中会禁止http协议的仓库地址，该如何处理？\"><a href=\"#maven3-8-1以后的配置中会禁止http协议的仓库地址，该如何处理？\" class=\"headerlink\" title=\"maven3.8.1以后的配置中会禁止http协议的仓库地址，该如何处理？\"></a>maven3.8.1以后的配置中会禁止http协议的仓库地址，该如何处理？</h3><ul>\n<li><p>我们可以看到setting.xml中的镜像配置里默认增加了如下配置，其会禁止所有http协议的仓库被请求，目的是推荐使用https协议</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">mirror</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">id</span>&gt;</span>maven-default-http-blocker<span class=\"tag\">&lt;/<span class=\"name\">id</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">mirrorOf</span>&gt;</span>external:http:*<span class=\"tag\">&lt;/<span class=\"name\">mirrorOf</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>Pseudo repository to mirror external repositories initially using HTTP.<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">url</span>&gt;</span>http://0.0.0.0/<span class=\"tag\">&lt;/<span class=\"name\">url</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">blocked</span>&gt;</span>true<span class=\"tag\">&lt;/<span class=\"name\">blocked</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">mirror</span>&gt;</span></span><br></pre></td></tr></table></figure></li>\n<li><p>此时执行mvn时会报告如下错误：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">maven-default-http-blocker (http://0.0.0.0/): Blocked mirror for repositories</span><br></pre></td></tr></table></figure></li>\n<li><p>但是很多公司的私服都没有配置证书，我们可以修改其配置如下，即可解决</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">mirror</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">id</span>&gt;</span>nexus<span class=\"tag\">&lt;/<span class=\"name\">id</span>&gt;</span></span><br><span class=\"line\">  <span class=\"comment\">&lt;!-- &lt;mirrorOf&gt;external:*&lt;/mirrorOf&gt; --&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">mirrorOf</span>&gt;</span>external:http:*<span class=\"tag\">&lt;/<span class=\"name\">mirrorOf</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">url</span>&gt;</span>http://nexus.my.local:8081/repository/maven-public/<span class=\"tag\">&lt;/<span class=\"name\">url</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">blocked</span>&gt;</span>false<span class=\"tag\">&lt;/<span class=\"name\">blocked</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">mirror</span>&gt;</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n","content_text":"摘要 maven仓库和镜像的配置及其关联方式 依赖查找顺序(按优先级排序，由高到低) 本地仓库，setting.xml中settings.localRepository的配置地址 settings.xml中profile.repositories配置的仓库，settings.profiles.profile.repositories.repository，注意要激活对应的profile pom.xml中profile.repositories配置的仓库，project.profiles.profile.repositories.repository,注意要在settings.xml中激活对应的profile pom.xml中repositories配置的仓库，project.repositories.repository maven默认的中央仓库:https://repo.maven.apache.org/maven2 说明，仓库的查找顺序实际上就是最终的pom.xml中仓库的声明顺序，所以可以通过如下命令导出最终的pom信息进行查看1mvn help:effective-pom -Doutput=EffectivePom.xml 仓库配置–repository 可以将仓库信息配置在settings.xml或pom.xml中，如下可以配置多个，按顺序依次查找，注意这里的id必须唯一，repository和pluginRepository的id可以相同:123456789101112131415161718192021222324252627282930313233343536373839404142434445464748&lt;repositories&gt; &lt;repository&gt; &lt;id&gt;nexus&lt;/id&gt; &lt;url&gt;http://nexus.my.local:8080/repository/maven-public/&lt;/url&gt; &lt;releases&gt; &lt;enabled&gt;true&lt;/enabled&gt; &lt;/releases&gt; &lt;snapshots&gt; &lt;enabled&gt;true&lt;/enabled&gt; &lt;/snapshots&gt; &lt;/repository&gt; &lt;repository&gt; &lt;id&gt;aliyun&lt;/id&gt; &lt;url&gt;https://maven.aliyun.com/repository/public&lt;/url&gt; &lt;releases&gt; &lt;enabled&gt;true&lt;/enabled&gt; &lt;/releases&gt; &lt;snapshots&gt; &lt;enabled&gt;true&lt;/enabled&gt; &lt;/snapshots&gt; &lt;/repository&gt;&lt;/repositories&gt;&lt;pluginRepositories&gt; &lt;pluginRepository&gt; &lt;id&gt;nexus&lt;/id&gt; &lt;url&gt;http://nexus.my.local:8080/repository/maven-public/&lt;/url&gt; &lt;releases&gt; &lt;enabled&gt;true&lt;/enabled&gt; &lt;/releases&gt; &lt;snapshots&gt; &lt;enabled&gt;true&lt;/enabled&gt; &lt;/snapshots&gt; &lt;/pluginRepository&gt; &lt;pluginRepository&gt; &lt;id&gt;aliyun&lt;/id&gt; &lt;url&gt;https://maven.aliyun.com/repository/public&lt;/url&gt; &lt;releases&gt; &lt;enabled&gt;true&lt;/enabled&gt; &lt;/releases&gt; &lt;snapshots&gt; &lt;enabled&gt;true&lt;/enabled&gt; &lt;/snapshots&gt; &lt;/pluginRepository&gt;&lt;/pluginRepositories&gt; 镜像代理–mirror说明 由于网络等原因导致我们不能很顺利的从仓库下载到对应的依赖，此时我们可以为仓库配置镜像代理，加快下载速度，国内一般会使用阿里云作为镜像代理 mirror镜像可以配置多个，每个mirrorOf里可以配置如下内容： * : 匹配所有仓库，一般我们搭建了自己的私服时推荐这样设置 repo1Id : 匹配仓库id为repo1Id的仓库 repo1Id,repo2Id : 匹配仓库id为repo1Id和repo2Id的仓库 *,!repo1Id : 匹配所有仓库，但不包含repo1Id external:* : 匹配所有不在本机上的远程仓库，也就是说，如果仓库的url里配置的是localhost或者file://则不进行代理 镜像代理需要配置在setting.xml中12345678910111213141516171819&lt;mirrors&gt; &lt;mirror&gt; &lt;id&gt;aliyun-mirror&lt;/id&gt; &lt;name&gt;aliyun-mirror&lt;/name&gt; &lt;!-- mirrorOf 里配置要代理的仓库id，这样当请求该仓库时就会走这个镜像代理 --&gt; &lt;!-- maven默认配置的仓库id就是central，此时就是使用阿里云作为默认仓库的代理 --&gt; &lt;mirrorOf&gt;central&lt;/mirrorOf&gt; &lt;url&gt;https://maven.aliyun.com/repository/public&lt;/url&gt; &lt;/mirror&gt; &lt;mirror&gt; &lt;id&gt;nexus-mirror&lt;/id&gt; &lt;name&gt;nexus-mirror&lt;/name&gt; &lt;!-- mirrorOf 里配置要代理的仓库id，这样当请求该仓库时就会走这个镜像代理 --&gt; &lt;!-- 此时就是使用nexus私服代理所有仓库 --&gt; &lt;mirrorOf&gt;*&lt;/mirrorOf&gt; &lt;url&gt;http://nexus.my.local:8080/repository/maven-public/&lt;/url&gt;&lt;/mirror&gt;&lt;/mirrors&gt; maven3.8.1以后的配置中会禁止http协议的仓库地址，该如何处理？ 我们可以看到setting.xml中的镜像配置里默认增加了如下配置，其会禁止所有http协议的仓库被请求，目的是推荐使用https协议 1234567&lt;mirror&gt; &lt;id&gt;maven-default-http-blocker&lt;/id&gt; &lt;mirrorOf&gt;external:http:*&lt;/mirrorOf&gt; &lt;name&gt;Pseudo repository to mirror external repositories initially using HTTP.&lt;/name&gt; &lt;url&gt;http://0.0.0.0/&lt;/url&gt; &lt;blocked&gt;true&lt;/blocked&gt;&lt;/mirror&gt; 此时执行mvn时会报告如下错误： 1maven-default-http-blocker (http://0.0.0.0/): Blocked mirror for repositories 但是很多公司的私服都没有配置证书，我们可以修改其配置如下，即可解决 1234567&lt;mirror&gt; &lt;id&gt;nexus&lt;/id&gt; &lt;!-- &lt;mirrorOf&gt;external:*&lt;/mirrorOf&gt; --&gt; &lt;mirrorOf&gt;external:http:*&lt;/mirrorOf&gt; &lt;url&gt;http://nexus.my.local:8081/repository/maven-public/&lt;/url&gt; &lt;blocked&gt;false&lt;/blocked&gt;&lt;/mirror&gt;","summary":"摘要 maven仓库和镜像的配置及其关联方式","date_published":"2021-12-02T10:30:05.000Z","tags":["技术","maven","maven","mvn"]},{"id":"https://blog.hanqunfeng.com/2021/10/29/git-command/","url":"https://blog.hanqunfeng.com/2021/10/29/git-command/","title":"Git常用命令","content_html":"<h2 id=\"摘要\"><a href=\"#摘要\" class=\"headerlink\" title=\"摘要\"></a>摘要</h2><ul>\n<li>一起来了解一些git常用命令吧</li>\n<li>推荐一个学习git命令的网站：<a href=\"https://learngitbranching.js.org/?locale=zh_CN\">https://learngitbranching.js.org/?locale=zh_CN</a><br><img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/git.png\"></li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"基本概念\"><a href=\"#基本概念\" class=\"headerlink\" title=\"基本概念\"></a>基本概念</h2><h3 id=\"Git的5种工作区域\"><a href=\"#Git的5种工作区域\" class=\"headerlink\" title=\"Git的5种工作区域\"></a>Git的5种工作区域</h3><ul>\n<li>工作目录：用于新增、修改、删除文件，实际我们用于编写代码的目录</li>\n<li>暂存区：执行<code>add</code>命令可以将工作目录对应的文件提交到暂存区，只有加入到暂存区的文件才会参与版本控制，其实际为一堆索引文件，保存在<code>.git/objects</code>目录下，记录每个文件的快照（hash）</li>\n<li>本地版本库：执行<code>commit</code>命令可以将暂存区的文件提交到本地版本库，每一次提交都会记录版本日志，其实际保存位置也是<code>.git/objects</code>目录下的快照文件，每一次<code>commit</code>如果文件发生变化都会生成新的快照，<code>.git/refs/heads/</code>下记录每个分支的最新一次commit的版本号</li>\n<li>远程跟踪区：<code>.git/refs/remotes/origin/</code>下记录每个分支的最新一次更新后的远程版本号，执行<code>fetch\\pull\\push</code>时都会更新为最新的远程版本号。如果只执行<code>fetch</code>仅仅会更新远程跟踪区，并不会更新本地目录，执行<code>pull</code>命令会同时更新远程跟踪区和本地目录</li>\n<li>远程版本库：例如github</li>\n</ul>\n<h3 id=\"文件的状态\"><a href=\"#文件的状态\" class=\"headerlink\" title=\"文件的状态\"></a>文件的状态</h3><ul>\n<li><p>Untracked:未跟踪的文件，尚未加入过暂存区的文件</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  git:(release) touch a.txt</span><br><span class=\"line\">➜  git:(release) ✗ git status</span><br><span class=\"line\">位于分支 release</span><br><span class=\"line\">您的分支与上游分支 <span class=\"string\">&#x27;origin/release&#x27;</span> 一致。</span><br><span class=\"line\"></span><br><span class=\"line\">未跟踪的文件:</span><br><span class=\"line\">  （使用 <span class=\"string\">&quot;git add &lt;文件&gt;...&quot;</span> 以包含要提交的内容）</span><br><span class=\"line\">\ta.txt</span><br><span class=\"line\"></span><br><span class=\"line\">提交为空，但是存在尚未跟踪的文件（使用 <span class=\"string\">&quot;git add&quot;</span> 建立跟踪）</span><br></pre></td></tr></table></figure></li>\n<li><p>要提交的变更[新增]，加入暂存区</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  git:(release) ✗ git add .</span><br><span class=\"line\">➜  git:(release) ✗ git status</span><br><span class=\"line\">位于分支 release</span><br><span class=\"line\">您的分支与上游分支 <span class=\"string\">&#x27;origin/release&#x27;</span> 一致。</span><br><span class=\"line\"></span><br><span class=\"line\">要提交的变更：</span><br><span class=\"line\">  （使用 <span class=\"string\">&quot;git restore --staged &lt;文件&gt;...&quot;</span> 以取消暂存）</span><br><span class=\"line\">\t新文件：   a.txt</span><br></pre></td></tr></table></figure></li>\n<li><p>已提交版本库待发布到远端，将暂存区的文件加入本地版本库</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  git:(release) ✗ git commit -m <span class=\"string\">&#x27;add a.txt&#x27;</span></span><br><span class=\"line\">[release 9292bb2] add a.txt</span><br><span class=\"line\"> 1 file changed, 0 insertions(+), 0 deletions(-)</span><br><span class=\"line\"> create mode 100644 a.txt</span><br><span class=\"line\">➜  git:(release) git status</span><br><span class=\"line\">位于分支 release</span><br><span class=\"line\">您的分支领先 <span class=\"string\">&#x27;origin/release&#x27;</span> 共 1 个提交。</span><br><span class=\"line\">  （使用 <span class=\"string\">&quot;git push&quot;</span> 来发布您的本地提交）</span><br><span class=\"line\"></span><br><span class=\"line\">无文件要提交，干净的工作区</span><br></pre></td></tr></table></figure></li>\n<li><p>尚未暂存以备提交的变更，加入过暂存区的文件发生修改</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  git:(release) <span class=\"built_in\">echo</span> <span class=\"string\">&quot;hello&quot;</span> &gt;&gt; a.txt</span><br><span class=\"line\">➜  git:(release) ✗ git status</span><br><span class=\"line\">位于分支 release</span><br><span class=\"line\">您的分支领先 <span class=\"string\">&#x27;origin/release&#x27;</span> 共 1 个提交。</span><br><span class=\"line\">  （使用 <span class=\"string\">&quot;git push&quot;</span> 来发布您的本地提交）</span><br><span class=\"line\"></span><br><span class=\"line\">尚未暂存以备提交的变更：</span><br><span class=\"line\">  （使用 <span class=\"string\">&quot;git add &lt;文件&gt;...&quot;</span> 更新要提交的内容）</span><br><span class=\"line\">  （使用 <span class=\"string\">&quot;git restore &lt;文件&gt;...&quot;</span> 丢弃工作区的改动）</span><br><span class=\"line\">\t修改：     a.txt</span><br><span class=\"line\"></span><br><span class=\"line\">修改尚未加入提交（使用 <span class=\"string\">&quot;git add&quot;</span> 和/或 <span class=\"string\">&quot;git commit -a&quot;</span>）</span><br></pre></td></tr></table></figure></li>\n<li><p>要提交的变更[修改]，加入过暂存区的文件重新加入暂存区</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  git:(release) ✗ git add .</span><br><span class=\"line\">➜  git:(release) ✗ git status</span><br><span class=\"line\">位于分支 release</span><br><span class=\"line\">您的分支领先 <span class=\"string\">&#x27;origin/release&#x27;</span> 共 1 个提交。</span><br><span class=\"line\">  （使用 <span class=\"string\">&quot;git push&quot;</span> 来发布您的本地提交）</span><br><span class=\"line\"></span><br><span class=\"line\">要提交的变更：</span><br><span class=\"line\">  （使用 <span class=\"string\">&quot;git restore --staged &lt;文件&gt;...&quot;</span> 以取消暂存）</span><br><span class=\"line\">\t修改：     a.txt</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"切换分支时值得注意的地方\"><a href=\"#切换分支时值得注意的地方\" class=\"headerlink\" title=\"切换分支时值得注意的地方\"></a>切换分支时值得注意的地方</h3><ul>\n<li>只要文件没有被commit，无论是新增还是修改，切换分支时，文件的状态都会被带到切换后的分支</li>\n<li>所以切换分支前，一定要执行commit</li>\n</ul>\n<h3 id=\"HEAD指针和分支指针\"><a href=\"#HEAD指针和分支指针\" class=\"headerlink\" title=\"HEAD指针和分支指针\"></a>HEAD指针和分支指针</h3><ul>\n<li>我们在查看git的log时会看到类似于<code>* 6d93a15 (HEAD -&gt; master) message</code>这样的信息，6d93a15就是commit时的版本号，master是分支名称，HEAD就是<code>HEAD指针</code>，实际上这里的master也是一个指针，他就是<code>分支指针</code></li>\n<li><code>分支指针</code>永远指向当前分支最新的一次提交版本，分支指针对应版本号保存在<code>.git/refs/heads/</code>目录下对应的分支文件中</li>\n<li><code>HEAD指针</code>表示我们当前的工作目录是基于哪个版本checkout出来的，通常情况下<code>HEAD指针</code>指向<code>分支指针</code>，但当我们通过命令<code>git checkout &lt;commit号&gt;</code>切换到某个版本时，<code>HEAD指针</code>就不再指向<code>分支指针</code>，这个情况有个名字叫作<code>detached HEAD(头分离)</code>，<code>HEAD指针</code>对应的版本号保存在<code>.git/HEAD</code>文件中，这也是为什么我们每次进入项目，git都知道我们当前所在分支或版本号是什么。</li>\n<li>参考资料：<a href=\"https://www.zsythink.net/archives/3412/\">https://www.zsythink.net/archives/3412/</a></li>\n</ul>\n<h2 id=\"问题与方法\"><a href=\"#问题与方法\" class=\"headerlink\" title=\"问题与方法\"></a>问题与方法</h2><h3 id=\"1-别人在远程仓库中创建了新的branch，我本地执行git-branch-a却看不到，如何才能看到并checkout呢？\"><a href=\"#1-别人在远程仓库中创建了新的branch，我本地执行git-branch-a却看不到，如何才能看到并checkout呢？\" class=\"headerlink\" title=\"1.别人在远程仓库中创建了新的branch，我本地执行git branch -a却看不到，如何才能看到并checkout呢？\"></a>1.别人在远程仓库中创建了新的branch，我本地执行<code>git branch -a</code>却看不到，如何才能看到并checkout呢？</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.先要获取远端全部信息</span></span><br><span class=\"line\">git fetch origin</span><br><span class=\"line\"><span class=\"comment\"># git fetch 远程名称，通过git remote查看，一般就是origin。</span></span><br><span class=\"line\">git fetch <span class=\"comment\"># 也可以不加远程名称</span></span><br><span class=\"line\"><span class=\"comment\"># 该命令无论在哪个分支上执行，都会更新本地所有的远程分支</span></span><br><span class=\"line\"><span class=\"comment\"># git fetch 完成了仅有的但是很重要的两步:</span></span><br><span class=\"line\"><span class=\"comment\"># 1.从远程仓库下载本地仓库中缺失的提交记录</span></span><br><span class=\"line\"><span class=\"comment\"># 2.更新远程分支指针(如 o/master)</span></span><br><span class=\"line\"><span class=\"comment\"># git fetch 实际上将本地仓库中的远程分支更新成了远程仓库相应分支最新的状态。</span></span><br><span class=\"line\"><span class=\"comment\"># git fetch 并不会改变你本地仓库的状态。它不会更新你的 本地 分支，也不会修改你磁盘上的文件。</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.再查看分支信息</span></span><br><span class=\"line\">git branch -a</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3.checkout到本地并切换到新创建的分支</span></span><br><span class=\"line\">git checkout -b release（本地分支名） origin/release（远程分支名）</span><br><span class=\"line\">控制台输出：</span><br><span class=\"line\">分支 <span class=\"string\">&#x27;release&#x27;</span> 设置为跟踪来自 <span class=\"string\">&#x27;origin&#x27;</span> 的远程分支 <span class=\"string\">&#x27;release&#x27;</span>。</span><br><span class=\"line\">切换到一个新分支 <span class=\"string\">&#x27;release&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 4.查看当前分支跟踪的远程分支</span></span><br><span class=\"line\">git rev-parse --abbrev-ref --symbolic-full-name @&#123;u&#125;  <span class=\"comment\"># @&#123;u&#125; 是 @&#123;upstream&#125; 的简写</span></span><br><span class=\"line\">控制台输出：</span><br><span class=\"line\">origin/release</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-如何查看本地分支与远程分支的区别？\"><a href=\"#2-如何查看本地分支与远程分支的区别？\" class=\"headerlink\" title=\"2.如何查看本地分支与远程分支的区别？\"></a>2.如何查看本地分支与远程分支的区别？</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.先要获取远端全部信息</span></span><br><span class=\"line\">git fetch origin</span><br><span class=\"line\"><span class=\"comment\"># 或者</span></span><br><span class=\"line\">git fetch</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.切换到待比较的本地分支，如master</span></span><br><span class=\"line\">git checkout master</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3.比较当前分支与origin/master之间的不同，--stat只显示哪些文件有不同，如果要查看每个文件不同的详细信息就去掉--stat</span></span><br><span class=\"line\">git diff origin/master --<span class=\"built_in\">stat</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 4.比较任意两个分支的不同，--stat只显示哪些文件有不同，如果要查看每个文件不同的详细信息就去掉--stat</span></span><br><span class=\"line\">git diff origin/master..master --<span class=\"built_in\">stat</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"3-如何查看本地两个分支之间的区别？\"><a href=\"#3-如何查看本地两个分支之间的区别？\" class=\"headerlink\" title=\"3.如何查看本地两个分支之间的区别？\"></a>3.如何查看本地两个分支之间的区别？</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.比较任意两个分支的区别</span></span><br><span class=\"line\">git diff master..dev --<span class=\"built_in\">stat</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.比较当前分支与master分支的区别</span></span><br><span class=\"line\">git diff master --<span class=\"built_in\">stat</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"4-如何查看本地的发生了哪些更改？\"><a href=\"#4-如何查看本地的发生了哪些更改？\" class=\"headerlink\" title=\"4.如何查看本地的发生了哪些更改？\"></a>4.如何查看本地的发生了哪些更改？</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 当前工作目录的索引和上次提交索引之间的差异，只有已经被commit过的文件才会被比较，如果是新增的文件则看不到</span></span><br><span class=\"line\">git diff --<span class=\"built_in\">stat</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 可以通过`git status`命令查看本地都有哪些变化，包含新增未加入暂存区的，新增已加入暂存区的，已提交过但有改动的，等等</span></span><br><span class=\"line\">git status</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看下次执行`git commit`时会被提交的文件</span></span><br><span class=\"line\">git diff --cached --<span class=\"built_in\">stat</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看下次执行`git commit -a` 时会被提交的文件，-a表示先add再commit</span></span><br><span class=\"line\">git diff HEAD --<span class=\"built_in\">stat</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"5-如何提交本地仓库？\"><a href=\"#5-如何提交本地仓库？\" class=\"headerlink\" title=\"5.如何提交本地仓库？\"></a>5.如何提交本地仓库？</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 本地无论是新增文件或修改文件，都要add后才能commit</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 1.先add再commit</span></span><br><span class=\"line\">git add .</span><br><span class=\"line\">git commit -m <span class=\"string\">&#x27;message&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.add同时commit，注意，如果存在尚未跟踪的文件，需要使用 &quot;git add&quot; 建立跟踪</span></span><br><span class=\"line\"> git commit -a -m <span class=\"string\">&#x27;message&#x27;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"6-git-reset–如何回滚到指定版本或分支\"><a href=\"#6-git-reset–如何回滚到指定版本或分支\" class=\"headerlink\" title=\"6.git reset–如何回滚到指定版本或分支?\"></a>6.<code>git reset</code>–如何回滚到指定版本或分支?</h3><ul>\n<li>git reset的作用是修改HEAD的位置，即将HEAD指向的位置改变为之前存在的某个版本，如果想恢复到之前某个提交的版本，且那个版本之后提交的版本我们都不要了，就可以用这种方法。</li>\n<li>注意，如果reset包含了已经发布（<code>git push</code>）的的版本，此时如果用<code>git push</code>会报错，因为我们本地库HEAD指向的版本比远程库的要旧，需要执行命令<code>git push -f</code>强制更新远程</li>\n<li>注意参数<code>--hard</code>有和没有的区别，有–hard，则完全回退到上一版本，丢弃所有其它修改，清空暂存区，同步工作目录到指定版本。没有–hard，则该版本之后的变化会变为Modified状态保留在工作目录，只清空暂存区。</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.回滚到上一个版本</span></span><br><span class=\"line\">git reset --hard HEAD^ <span class=\"comment\"># 完全回退到上一个版本，丢弃所有其它修改，清空暂存区，同步工作目录到指定版本，也就是说，上一次提交之后新增或修改的文件内容都没有了</span></span><br><span class=\"line\">git reset HEAD~1 <span class=\"comment\"># 则该版本之后的变化会变为Modified状态保留在工作目录，只清空暂存区，也就是说，上一次提交之后新增或修改的文件内容得以保留</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.回滚到上上个版本</span></span><br><span class=\"line\">git reset --hard HEAD^^</span><br><span class=\"line\">git reset HEAD~2</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3.回滚到指定版本的分支</span></span><br><span class=\"line\">git reset --hard 版本号</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3.1 查看版本号</span></span><br><span class=\"line\">git <span class=\"built_in\">log</span> --oneline</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 4.回滚到指定分支</span></span><br><span class=\"line\">git reset --hard 分支名称</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 4.1 回滚到与本地远程分支一样的状态，一般本地仓库搞坏了会这么做</span></span><br><span class=\"line\">git reset --hard origin/master</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 5. `git log`看不到reset的历史，可以通过如下命令查看</span></span><br><span class=\"line\">git reflog</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"7-gitignore–在git中如果想忽略掉某个文件，不让这个文件提交到版本库中，要怎么做呢？\"><a href=\"#7-gitignore–在git中如果想忽略掉某个文件，不让这个文件提交到版本库中，要怎么做呢？\" class=\"headerlink\" title=\"7..gitignore–在git中如果想忽略掉某个文件，不让这个文件提交到版本库中，要怎么做呢？\"></a>7.<code>.gitignore</code>–在git中如果想忽略掉某个文件，不让这个文件提交到版本库中，要怎么做呢？</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 在工作目录下创建 .gitignore 文件</span></span><br><span class=\"line\"><span class=\"comment\"># 其格式为：</span></span><br><span class=\"line\"><span class=\"comment\"># 此为注释 – 将被 Git 忽略</span></span><br><span class=\"line\">*.a       <span class=\"comment\"># 忽略所有 .a 结尾的文件</span></span><br><span class=\"line\">!lib.a    <span class=\"comment\"># 但 lib.a 除外</span></span><br><span class=\"line\">/TODO     <span class=\"comment\"># 仅仅忽略项目根目录下的 TODO 文件，不包括 subdir/TODO</span></span><br><span class=\"line\">build/    <span class=\"comment\"># 忽略 build/ 目录下的所有文件</span></span><br><span class=\"line\">doc/*.txt <span class=\"comment\"># 会忽略 doc/notes.txt 但不包括 doc/server/arch.txt</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 忽略文件默认为当前项目目录下的.gitignore文件，也可以通过如下命令指定文件路径和名称</span></span><br><span class=\"line\">git config core.excludesfile .gitignore_dev</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 也可配置为全局文件，这样就不需要为每个项目都创建.gitignore 文件</span></span><br><span class=\"line\">git config --global core.excludesfile ~/.gitignore_global</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># .gitignore 文件 只对git add起作用，如果有文件在被加入到.gitignore 文件前就已经被commit了可以使用如下方法</span></span><br><span class=\"line\"><span class=\"comment\"># 1.删除暂存区、分支上内容，本地保留。解除该文件的追踪关系，脱离版本控制。</span></span><br><span class=\"line\">git rm --cached 文件名   <span class=\"comment\"># 删除文件</span></span><br><span class=\"line\">git rm -r --cached 文件夹   <span class=\"comment\"># 删除文件夹  -r 表示允许递归删除</span></span><br><span class=\"line\">git rm -r --cached .  <span class=\"comment\"># 删除当前目录下全部文件的暂存区</span></span><br><span class=\"line\"></span><br><span class=\"line\">git rm -r 文件夹/文件名  <span class=\"comment\">#删除本地、暂存区、分支上内容，如果该文件不需要在本地保留，就可以测底删除</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.重新加入暂存区</span></span><br><span class=\"line\">git add . <span class=\"comment\"># 将当前目录下所有文件加入暂存区</span></span><br><span class=\"line\">git add file/dir <span class=\"comment\">#将指定文件或目录加入暂存区，支持通配符</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3.查看暂存区内容</span></span><br><span class=\"line\">git diff --cached</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 4.提交</span></span><br><span class=\"line\">git commit -m <span class=\"string\">&quot;message&quot;</span> <span class=\"comment\"># 将暂存区内容提交到本地版本库</span></span><br><span class=\"line\">git commit -am <span class=\"string\">&quot;message&quot;</span> <span class=\"comment\"># 先提交暂存区再提交到本地版本库</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"8-git-commit-amend–commit后发现有内容要修改或者注释写错了，但是不想创建新的一次commit，要怎么办呢？\"><a href=\"#8-git-commit-amend–commit后发现有内容要修改或者注释写错了，但是不想创建新的一次commit，要怎么办呢？\" class=\"headerlink\" title=\"8.git commit --amend–commit后发现有内容要修改或者注释写错了，但是不想创建新的一次commit，要怎么办呢？\"></a>8.<code>git commit --amend</code>–commit后发现有内容要修改或者注释写错了，但是不想创建新的一次commit，要怎么办呢？</h3><ul>\n<li>以下命令如果直接合并到已经push过的版本，再次git push时会提示”更新被拒绝，因为您当前分支的最新提交落后于其对应的远程分支”，此时可以执行<code>git push -f</code>强行发布即可。<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 覆盖上一次提交，这样不会产生新的提交</span></span><br><span class=\"line\">git commit --amend  -am <span class=\"string\">&quot;注释&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 在上次提交中附加一些内容，保持提交日志不变</span></span><br><span class=\"line\">git commit -a --amend --no-edit</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"9-git-log–如何查看提交日志\"><a href=\"#9-git-log–如何查看提交日志\" class=\"headerlink\" title=\"9.git log–如何查看提交日志?\"></a>9.<code>git log</code>–如何查看提交日志?</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 显示版本历史，如果有用git reset --hard xxxxx回退操作，则只会显示到xxx之前的历史</span></span><br><span class=\"line\">git <span class=\"built_in\">log</span>  <span class=\"comment\"># 显示当前分支之前的全部日志</span></span><br><span class=\"line\">git <span class=\"built_in\">log</span>  --all <span class=\"comment\">#  --all 显示全部分支</span></span><br><span class=\"line\">git <span class=\"built_in\">log</span> --oneline <span class=\"comment\"># 单行显示</span></span><br><span class=\"line\"></span><br><span class=\"line\">git <span class=\"built_in\">log</span> --oneline --all --graph <span class=\"comment\"># 图形化显示全部分支log</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 在所有提交日志中搜索包含「homepage」的提交</span></span><br><span class=\"line\">git <span class=\"built_in\">log</span> --all --grep=<span class=\"string\">&#x27;homepage&#x27;</span> <span class=\"comment\">#模糊匹配</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 获取某人的提交日志</span></span><br><span class=\"line\">git <span class=\"built_in\">log</span> --author=<span class=\"string\">&quot;hanqf&quot;</span>  <span class=\"comment\">#模糊匹配</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看完整版本历史，也就是说即便有git reset也会显示</span></span><br><span class=\"line\">git reflog</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"10-如何创建本地仓库并绑定到远程仓库\"><a href=\"#10-如何创建本地仓库并绑定到远程仓库\" class=\"headerlink\" title=\"10.如何创建本地仓库并绑定到远程仓库?\"></a>10.如何创建本地仓库并绑定到远程仓库?</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.首先要在对应的git服务器创建一个新的仓库，一般的git服务器创建新仓库后都会提示你如何绑定该仓库的</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2. 创建本地仓库</span></span><br><span class=\"line\">git init <span class=\"comment\">#将当前目录加入版本控制</span></span><br><span class=\"line\">git init dir <span class=\"comment\">#将dir加入版本控制</span></span><br><span class=\"line\"><span class=\"comment\"># 默认使用 &#x27;master&#x27; 作为初始分支的名称，如果要修改分支名称，可以执行如下命令：</span></span><br><span class=\"line\">git branch -m &lt;name&gt;</span><br><span class=\"line\"><span class=\"comment\"># 也可以通过设置git config来配置默认的名称，除了 &#x27;master&#x27; 之外，通常选定的名字有 &#x27;main&#x27;、&#x27;trunk&#x27; 和 &#x27;development&#x27;。</span></span><br><span class=\"line\">git config --global init.defaultBranch &lt;名称&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3. 创建新的文件后提交到本地仓库</span></span><br><span class=\"line\">git add . &amp;&amp; git commit -m <span class=\"string\">&#x27;message&#x27;</span></span><br><span class=\"line\">git commit -am <span class=\"string\">&quot;备注&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 4.绑定远程仓库</span></span><br><span class=\"line\">git remote add origin https://xxxxx (远程仓库地址)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 5.提交本地仓库的变更到远程仓库，这里要注意github的主分支名称已经变更为main，所以提交github时要将master替换为main</span></span><br><span class=\"line\">git pull --rebase origin master <span class=\"comment\">#获取远程库与本地同步合并（如果远程库不为空必须做这一步，否则后面的提交会失败）</span></span><br><span class=\"line\">git push -u origin master <span class=\"comment\">#提交master到其远程仓库，第一次提交加上-u，以后就不用了</span></span><br><span class=\"line\">git push origin master</span><br><span class=\"line\"><span class=\"comment\"># 或者</span></span><br><span class=\"line\">git push <span class=\"comment\"># 将当前分支提交到其对应的远程仓库</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"11-远程仓库地址变更后如何更新？\"><a href=\"#11-远程仓库地址变更后如何更新？\" class=\"headerlink\" title=\"11.远程仓库地址变更后如何更新？\"></a>11.远程仓库地址变更后如何更新？</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.命令行修改</span></span><br><span class=\"line\">git remote set-url origin [NEW_URL]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.手工编辑.git目录下的config文件</span></span><br><span class=\"line\">[remote <span class=\"string\">&quot;origin&quot;</span>]</span><br><span class=\"line\">    url = https://xxxxxx (修改为新的地址)</span><br><span class=\"line\">    fetch = +refs/heads/*:refs/remotes/origin/*</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3.查看修改后的地址</span></span><br><span class=\"line\">git remote get-url origin   <span class=\"comment\">#只会显示可以fetch的地址</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 4.查看远程仓库地址</span></span><br><span class=\"line\">git remote -v  <span class=\"comment\"># 会显示push和fetch的地址</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"12-如何将本地仓库同时绑定到多个远程仓库？\"><a href=\"#12-如何将本地仓库同时绑定到多个远程仓库？\" class=\"headerlink\" title=\"12.如何将本地仓库同时绑定到多个远程仓库？\"></a>12.如何将本地仓库同时绑定到多个远程仓库？</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.按照`10.如何创建本地仓库并绑定到远程仓库?`中的步骤完成第一个仓库的绑定</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.手工编辑.git目录下的config文件</span></span><br><span class=\"line\">[remote <span class=\"string\">&quot;origin&quot;</span>]</span><br><span class=\"line\">    url = https://xxxxxxxx1  <span class=\"comment\"># 此处为第一个远程仓库的地址，即可以push又可以fetch</span></span><br><span class=\"line\">    url = https://xxxxxxxx2  <span class=\"comment\"># 在此添加第二个仓库的地址，以此类推，可以添加多个，只可以push，只能备份使用</span></span><br><span class=\"line\">    fetch = +refs/heads/*:refs/remotes/origin/*</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3.保存后再次执行，这里要注意github的主分支名称已经变更为main，所以提交github时要将master替换为main</span></span><br><span class=\"line\">git push -u origin master  <span class=\"comment\"># 提交master到其远程仓库，只有第一次执行时需要加上 -u ，以后只需要：git push  origin master</span></span><br><span class=\"line\"><span class=\"comment\"># 或者</span></span><br><span class=\"line\">git push <span class=\"comment\"># 将当前分支提交到其对应的远程仓库</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 4.查看远程仓库地址</span></span><br><span class=\"line\">git remote -v</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"13-如何在git-pull时不用每次都输入密码？\"><a href=\"#13-如何在git-pull时不用每次都输入密码？\" class=\"headerlink\" title=\"13.如何在git pull时不用每次都输入密码？\"></a>13.如何在<code>git pull</code>时不用每次都输入密码？</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 进入项目目录</span></span><br><span class=\"line\">git config --global credential.helper store</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 执行 git pull 并输入密码，此时当前项目就会记住密码了，下次再执行时就不用密码了</span></span><br><span class=\"line\">git pull</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"14-如果文件已经git-add到暂存区，但是尚未commit，此时如何将文件从暂存区中移除？\"><a href=\"#14-如果文件已经git-add到暂存区，但是尚未commit，此时如何将文件从暂存区中移除？\" class=\"headerlink\" title=\"14.如果文件已经git add到暂存区，但是尚未commit，此时如何将文件从暂存区中移除？\"></a>14.如果文件已经<code>git add</code>到暂存区，但是尚未commit，此时如何将文件从暂存区中移除？</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 如果文件还没有放入暂存区</span></span><br><span class=\"line\">git checkout -- &lt;文件名&gt; <span class=\"comment\">#放弃对某一个文件已经做出的修改，回到head版本的该文件</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 如果文件已经`git add`到暂存区，但是尚未commit</span></span><br><span class=\"line\"><span class=\"comment\"># 移出单个文件</span></span><br><span class=\"line\">git restore --staged &lt;文件路径&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 移出本次全都add到暂存区的文件</span></span><br><span class=\"line\">git reset .  <span class=\"comment\"># 重置本次全部索引，.代表当前目录</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 可以通过git status查看文件路径</span></span><br><span class=\"line\">git status</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 如果已经commit，可以通过如下方式移除</span></span><br><span class=\"line\"><span class=\"comment\"># 删除暂存区、分支上内容，本地保留。解除该文件的追踪关系，脱离版本控制。</span></span><br><span class=\"line\">git rm --cached &lt;文件名&gt;   <span class=\"comment\"># 删除文件</span></span><br><span class=\"line\">git rm -r --cached &lt;文件夹&gt;   <span class=\"comment\"># 删除文件夹  -r 表示允许递归删除</span></span><br><span class=\"line\">git rm -r --cached .  <span class=\"comment\"># 删除当前目录下全部文件的暂存区，.代表当前目录</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"15-git-config–如何设置和查看git配置信息？\"><a href=\"#15-git-config–如何设置和查看git配置信息？\" class=\"headerlink\" title=\"15.git config–如何设置和查看git配置信息？\"></a>15.<code>git config</code>–如何设置和查看git配置信息？</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 使用git config命令进行设置和查看</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 全局设置用户名和邮箱，全局配置是保存在 ~/.gitconfig中的</span></span><br><span class=\"line\">git config --global user.name <span class=\"string\">&quot;你的用户名&quot;</span></span><br><span class=\"line\">git config --global user.email <span class=\"string\">&quot;你的邮箱&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 只对当前项目有效，项目根目录下执行，去掉--global，项目配置优先级更高，项目配置保存在.git/config中，可以直接修改</span></span><br><span class=\"line\">git config user.name <span class=\"string\">&quot;你的用户名&quot;</span></span><br><span class=\"line\">git config user.email <span class=\"string\">&quot;你的邮箱&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 修改你的用户名和邮箱</span></span><br><span class=\"line\">git config --global --replace-all user.name <span class=\"string\">&quot;你的用户名&quot;</span></span><br><span class=\"line\">git config --global --replace-all user.email <span class=\"string\">&quot;你的邮箱&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看配置</span></span><br><span class=\"line\">git config --list  <span class=\"comment\"># 此时项目配置和全局配置都会显示</span></span><br><span class=\"line\"></span><br><span class=\"line\">git config --global --list <span class=\"comment\"># 只显示全局配置，全局配置是保存在 ~/.gitconfig中的</span></span><br><span class=\"line\"></span><br><span class=\"line\">git config user.name <span class=\"comment\"># 查看某个配置的值</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 修改全局配置的值，--replace-all会匹配所有行，也可以直接在~/.gitconfig中修改</span></span><br><span class=\"line\">git config --global --replace-all user.name <span class=\"string\">&quot;你的用户名&quot;</span></span><br><span class=\"line\">git config --global --replace-all user.email <span class=\"string\">&quot;你的邮箱&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 修改项目配置的值，--replace-all会匹配所有行，也可以直接在.git/config中修改</span></span><br><span class=\"line\">git config --replace-all user.name <span class=\"string\">&quot;你的用户名&quot;</span></span><br><span class=\"line\">git config --replace-all user.email <span class=\"string\">&quot;你的邮箱&quot;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"16-提交的文件太大-默认是1M-，导致push失败怎么办？\"><a href=\"#16-提交的文件太大-默认是1M-，导致push失败怎么办？\" class=\"headerlink\" title=\"16.提交的文件太大(默认是1M)，导致push失败怎么办？\"></a>16.提交的文件太大(默认是1M)，导致push失败怎么办？</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 加大缓冲区大小（http.postBuffer的参数）</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 524288000 的单位代表 B，524288000B 也就是 500MB。</span></span><br><span class=\"line\">git config http.postBuffer 524288000</span><br><span class=\"line\"><span class=\"comment\"># 或全局设置</span></span><br><span class=\"line\">git config --global http.postBuffer 524288000</span><br></pre></td></tr></table></figure>\n\n\n<h3 id=\"17-clone代码最简单的方式是通过https的形式，不过一般这样做需要输入用户名和密码，如果不想输入用户名和密码可以使用git-xxxx的形式，如何实现呢？\"><a href=\"#17-clone代码最简单的方式是通过https的形式，不过一般这样做需要输入用户名和密码，如果不想输入用户名和密码可以使用git-xxxx的形式，如何实现呢？\" class=\"headerlink\" title=\"17.clone代码最简单的方式是通过https的形式，不过一般这样做需要输入用户名和密码，如果不想输入用户名和密码可以使用git@xxxx的形式，如何实现呢？\"></a>17.clone代码最简单的方式是通过https的形式，不过一般这样做需要输入用户名和密码，如果不想输入用户名和密码可以使用<code>git@xxxx</code>的形式，如何实现呢？</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 这种方式就是基于ssh的密钥证书来实现</span></span><br><span class=\"line\"><span class=\"comment\"># 生成本地ssh密钥对，按照提示完成三次回车，即可生成 ssh key。此时会在~/.ssh/下创建id_rsa.pub(公钥)和id_rsa(私钥)</span></span><br><span class=\"line\">ssh-keygen -b 4096 -t rsa <span class=\"comment\"># -t 指定生成密钥的算法类型，生成的文件名称就是以其开头的，如这里就是id_rsa</span></span><br><span class=\"line\"><span class=\"comment\"># 支持的密钥算法类型包含：rsa,ed25519,等等，具体参见各个git服务器的配置说明</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 此时cat id_rsa.pub 可以看到公钥的内容</span></span><br><span class=\"line\"><span class=\"comment\"># 形式为:sshkey的算法+密文+sshkey的标签，此时sshkey算法为ssh-rsa，sshkey标签为机器名称，若要指定sshkey标签可以通过-C指定</span></span><br><span class=\"line\">ssh-keygen -b 4096 -t rsa -C <span class=\"string\">&quot;xxxxxxx&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># 注意这里-C可以指定任意值，网上说必须指定邮箱其初衷仅仅是为了便于辨识</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 将公钥文件内容复制到对应的git服务器配置ssh-key的地方，具体使用方式可以参见各个git服务器的说明。</span></span><br><span class=\"line\"><span class=\"comment\"># Github: settings--SSH and GPG keys--SSH keys--New SSH key</span></span><br><span class=\"line\"><span class=\"comment\"># 测试连接是否正常</span></span><br><span class=\"line\">ssh -T git@github.com</span><br><span class=\"line\"><span class=\"comment\"># Coding: 个人帐号设置--个人设置--SSH 公钥--新增公钥</span></span><br><span class=\"line\"><span class=\"comment\"># 测试连接是否正常</span></span><br><span class=\"line\">ssh -T git@e.coding.net</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Gitee: 设置--安全设置--SSH公钥</span></span><br><span class=\"line\"><span class=\"comment\"># 测试连接是否正常</span></span><br><span class=\"line\">ssh -T git@gitee.com</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># clone代码示例</span></span><br><span class=\"line\">git <span class=\"built_in\">clone</span> git@github.com:hanqunfeng/reactive-redis-cache-annotation-spring-boot-starter.git</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"18-git-branch–如何创建分支-切换分支-查看分支-删除分支-发布分支？\"><a href=\"#18-git-branch–如何创建分支-切换分支-查看分支-删除分支-发布分支？\" class=\"headerlink\" title=\"18.git branch–如何创建分支\\切换分支\\查看分支\\删除分支\\发布分支？\"></a>18.<code>git branch</code>–如何创建分支\\切换分支\\查看分支\\删除分支\\发布分支？</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 从当前分支创建release分支，但是不切换</span></span><br><span class=\"line\">git branch release</span><br><span class=\"line\"></span><br><span class=\"line\">git checkout release <span class=\"comment\"># 从当前分支切换到release分支</span></span><br><span class=\"line\">git checkout &lt;commit号&gt; <span class=\"comment\"># 从当前分支切换到commit号对应的版本</span></span><br><span class=\"line\"><span class=\"comment\"># 注意，当切换到某个版本号对应的版本时就会发生“头分离”，即HEAD指针不会再指向分支指针，而是指向了那个版本</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 从当前分支创建并切换到release分支，相当于执行git branch release &amp;&amp; git checkout release两个命令</span></span><br><span class=\"line\">git checkout -b release</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 从dev分支创建release分支，但是不切换</span></span><br><span class=\"line\">git branch release dev</span><br><span class=\"line\"><span class=\"comment\"># 从dev分支创建release分支,并切换</span></span><br><span class=\"line\">git checkout -b release dev</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 从指定版本创建release分支，版本号通过git log --oneline查看</span></span><br><span class=\"line\">git branch release 799fb04</span><br><span class=\"line\">git checkout -b release 799fb04</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 从远程分支origin/release创建release分支，并切换</span></span><br><span class=\"line\">git checkout -b release origin/release</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#跳到上一个分支，比如当前是master分支，是从dev分支通过git checkout master命令切换过来的，那么该命令会重新回到dev分支</span></span><br><span class=\"line\">git checkout -</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看分支</span></span><br><span class=\"line\">git branch  <span class=\"comment\">#列出所有本地分支，标*的就是当前所在的分支，.git/HEAD 文件中存放的就是当前分支信息</span></span><br><span class=\"line\">git branch --remote   <span class=\"comment\">#列出远程仓库中的所有分支</span></span><br><span class=\"line\">git branch -a  <span class=\"comment\">#同时显示本地和远程的所有分支</span></span><br><span class=\"line\"></span><br><span class=\"line\">cat .git/HEAD  <span class=\"comment\">#查看当前所在分支</span></span><br><span class=\"line\">git symbolic-ref HEAD <span class=\"comment\">#查看当前所在分支，本地分支</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 删除分支</span></span><br><span class=\"line\"><span class=\"comment\"># 删除release分支，不能在release下删除自己</span></span><br><span class=\"line\">git branch -d release</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 假设我们通过master创建了release分支，此时release分支发生了变更并执行了commit，但是并没有将更改merge回master，此时删除release分支需要执行如下命令</span></span><br><span class=\"line\">git branch -D release  <span class=\"comment\"># -D 强制删除</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 发布分支</span></span><br><span class=\"line\">git push --set-upstream origin &lt;new branch name&gt; <span class=\"comment\">#推新分支到远程仓库并在本地分支和远程分支之间建立关联</span></span><br><span class=\"line\"><span class=\"comment\"># 也可以分两步完成，但推荐上面的方式</span></span><br><span class=\"line\">git push origin &lt;new branch name&gt; <span class=\"comment\">#推新分支到远程仓库</span></span><br><span class=\"line\">git branch --set-upstream-to=origin/&lt;new branch name&gt; &lt;new branch name&gt; <span class=\"comment\">#关联本地分支到远程分支，否则每一次pull或push的时候都需要明确指定本地和远端分支。</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看当前分支跟踪的远程分支</span></span><br><span class=\"line\">git rev-parse --abbrev-ref --symbolic-full-name @&#123;u&#125;  <span class=\"comment\"># @&#123;u&#125; 是 @&#123;upstream&#125; 的简写</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"19-merge还是rebase-如何合并分支\"><a href=\"#19-merge还是rebase-如何合并分支\" class=\"headerlink\" title=\"19.merge还是rebase? 如何合并分支?\"></a>19.merge还是rebase? 如何合并分支?</h3><p>一般开发流程：</p>\n<ol>\n<li>更新主分支 git pull</li>\n<li>从主分支创建一个开发分支 git checkout -b dev，每个开发人员都会创建一个自己的开发分支</li>\n<li>开发分支完成测试后合并回主分支，这里推荐使用git rebase，开发分支的log会被移动到主分支的顶端，这样主分支始终是一条线</li>\n<li>这样主分支在保持干净的同时还保留了每一次commit的log，便于开发人员追溯历史</li>\n<li>也可以使用<code>git merge --no-ff</code>，其也会保留每次的log到主分支上</li>\n</ol>\n<p>一般发布流程：</p>\n<ol>\n<li>将主分支测试完成后合并到发布分支，一般都是由一个专门的人员进行合并，此时推荐使用git merge，这样每次一发布的版本都会产生一个新的节点，而主分支上的多次commit的log不会被记录到发布分支上</li>\n<li>这样发布分支看起来就是每一次大的发布才会合并一次并记录log，log中可以编辑本次发布的内容。</li>\n</ol>\n<h4 id=\"示例准备，初始化一个待合并的目录\"><a href=\"#示例准备，初始化一个待合并的目录\" class=\"headerlink\" title=\"示例准备，初始化一个待合并的目录\"></a>示例准备，初始化一个待合并的目录</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜ mkdir git_test</span><br><span class=\"line\">➜ <span class=\"built_in\">cd</span> git_test</span><br><span class=\"line\">➜ touch 1.txt</span><br><span class=\"line\">➜ git init</span><br><span class=\"line\">[master（根提交） 5b91fc1] init...</span><br><span class=\"line\"> 1 files changed, 0 insertions(+), 0 deletions(-)</span><br><span class=\"line\"> create mode 100644 1.txt</span><br><span class=\"line\">➜ git:(master) git add . &amp;&amp; git commit -m <span class=\"string\">&#x27;init...&#x27;</span></span><br><span class=\"line\">➜ git:(master) git checkout -b dev</span><br><span class=\"line\">➜ git:(dev) <span class=\"built_in\">echo</span> <span class=\"string\">&quot;dev1&quot;</span> &gt;&gt; a.txt</span><br><span class=\"line\">➜ git:(dev) ✗ git add . &amp;&amp; git commit -m <span class=\"string\">&#x27;dev1&#x27;</span></span><br><span class=\"line\">[dev 8d57739] dev1</span><br><span class=\"line\"> 1 file changed, 1 insertion(+)</span><br><span class=\"line\"> create mode 100644 a.txt</span><br><span class=\"line\">➜ git:(dev) ✗ git checkout master</span><br><span class=\"line\">切换到分支 <span class=\"string\">&#x27;master&#x27;</span></span><br><span class=\"line\">➜ git:(master) ✗ <span class=\"built_in\">echo</span> <span class=\"string\">&quot;master1&quot;</span> &gt;&gt; a.txt</span><br><span class=\"line\">➜ git:(master) ✗ git add . &amp;&amp; git commit -m <span class=\"string\">&#x27;master1&#x27;</span></span><br><span class=\"line\">[master fa2400a] master1</span><br><span class=\"line\"> 1 file changed, 1 insertion(+)</span><br><span class=\"line\"> create mode 100644 a.txt</span><br><span class=\"line\">➜ git:(master) ✗ git checkout dev</span><br><span class=\"line\">切换到分支 <span class=\"string\">&#x27;dev&#x27;</span></span><br><span class=\"line\">➜ git:(dev) ✗ <span class=\"built_in\">echo</span> <span class=\"string\">&quot;dev2&quot;</span> &gt;&gt; a.txt</span><br><span class=\"line\">➜ git:(dev) ✗ git add . &amp;&amp; git commit -m <span class=\"string\">&#x27;dev2&#x27;</span></span><br><span class=\"line\">[dev 0006560] dev2</span><br><span class=\"line\"> 1 file changed, 1 insertion(+)</span><br><span class=\"line\">➜ git:(dev) ✗ git checkout master</span><br><span class=\"line\">切换到分支 <span class=\"string\">&#x27;master&#x27;</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"merge\"><a href=\"#merge\" class=\"headerlink\" title=\"merge\"></a>merge</h4><p>将dev分支merge到当前分支</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git merge dev</span><br></pre></td></tr></table></figure>\n<ul>\n<li>merge会将dev分支和当前分支合并后创建一个新的节点放到当前分支最顶端，所以解决完冲突，需要执行如下命令创建一个新的commit<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git add . &amp;&amp; git commit -m <span class=\"string\">&#x27;merge dev&#x27;</span></span><br></pre></td></tr></table></figure></li>\n<li>merge的log会按照时间顺序显示</li>\n<li>merge后如果删除了dev分支，则在log中就看不到这个分支信息了，但是日志内容还在</li>\n</ul>\n<h5 id=\"merge示例\"><a href=\"#merge示例\" class=\"headerlink\" title=\"merge示例\"></a>merge示例</h5><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜ git:(master) ✗ git merge dev</span><br><span class=\"line\">冲突（add/add）：合并冲突于 a.txt</span><br><span class=\"line\">自动合并 a.txt</span><br><span class=\"line\">自动合并失败，修正冲突然后提交修正的结果。</span><br><span class=\"line\">➜ git:(master) ✗ vim a.txt</span><br><span class=\"line\">➜ git:(master) ✗ git add . &amp;&amp; git commit -m <span class=\"string\">&#x27;master merge release&#x27;</span></span><br><span class=\"line\">➜ git:(master) git <span class=\"built_in\">log</span> --oneline   <span class=\"comment\"># 此时才能看到日志</span></span><br><span class=\"line\">➜ git:(master) git branch -D dev</span><br><span class=\"line\">已删除分支 dev（曾为 0006560）。</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/merge1.png\"><br>删除dev分支后<br><img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/merge2.png\"></p>\n<h4 id=\"rebase\"><a href=\"#rebase\" class=\"headerlink\" title=\"rebase\"></a>rebase</h4><p>将dev分支rebase到当前分支</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git rebase dev</span><br></pre></td></tr></table></figure>\n<ul>\n<li>rebase会将dev分支的每一个节点转移到当前分支最顶端，而不会产生一个新的节点，这样rebase后的分支节点看起来就是一条线</li>\n<li>解决完冲突，执行<code>git add .</code>和<code>git rebase --continue</code>，不会产生额外的commit</li>\n<li>rebase后如果删除了dev分支，则在log中就看不到这个分支信息了，但是日志内容还在，这样看起来就是主分支自己的节点，没有产生过新的分支</li>\n<li>如果要放弃本次合并，可以运行<code>git rebase --abort</code></li>\n</ul>\n<h5 id=\"rebase示例\"><a href=\"#rebase示例\" class=\"headerlink\" title=\"rebase示例\"></a>rebase示例</h5><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  git:(master) git rebase dev</span><br><span class=\"line\">冲突（add/add）：合并冲突于 a.txt</span><br><span class=\"line\">自动合并 a.txt</span><br><span class=\"line\">error: 不能应用 0657382... master1</span><br><span class=\"line\">Resolve all conflicts manually, mark them as resolved with</span><br><span class=\"line\"><span class=\"string\">&quot;git add/rm &lt;conflicted_files&gt;&quot;</span>, <span class=\"keyword\">then</span> run <span class=\"string\">&quot;git rebase --continue&quot;</span>.</span><br><span class=\"line\">You can instead skip this commit: run <span class=\"string\">&quot;git rebase --skip&quot;</span>.</span><br><span class=\"line\">To abort and get back to the state before <span class=\"string\">&quot;git rebase&quot;</span>, run <span class=\"string\">&quot;git rebase --abort&quot;</span>.</span><br><span class=\"line\">不能应用 0657382... master1</span><br><span class=\"line\">➜  git:(e4410b4) ✗ vim a.txt</span><br><span class=\"line\">➜  git:(e4410b4) ✗ git add .</span><br><span class=\"line\">➜  git:(e4410b4) ✗ git rebase --<span class=\"built_in\">continue</span></span><br><span class=\"line\">[分离头指针 bd01ea0] master1</span><br><span class=\"line\"> 1 file changed, 1 insertion(+)</span><br><span class=\"line\">成功变基并更新 refs/heads/master。</span><br><span class=\"line\">➜  git:(master) git <span class=\"built_in\">log</span> --oneline</span><br><span class=\"line\">➜  git:(master) git branch -D dev</span><br><span class=\"line\">已删除分支 dev（曾为 e4410b4）。</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/rebase1.png\"><br>删除dev分支后<br><img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/rebase2.png\"></p>\n<h3 id=\"20-git-rebase-i–我commit了很多次，发现都是干的一件事，此时如果直接rebase到主分支会有很多没必要的log，是否可以合并这些commit为一个呢？\"><a href=\"#20-git-rebase-i–我commit了很多次，发现都是干的一件事，此时如果直接rebase到主分支会有很多没必要的log，是否可以合并这些commit为一个呢？\" class=\"headerlink\" title=\"20.git rebase -i–我commit了很多次，发现都是干的一件事，此时如果直接rebase到主分支会有很多没必要的log，是否可以合并这些commit为一个呢？\"></a>20.<code>git rebase -i</code>–我commit了很多次，发现都是干的一件事，此时如果直接rebase到主分支会有很多没必要的log，是否可以合并这些commit为一个呢？</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># git rebase -i 即可以合并多次提交，也可以合并分支，-i表示可以编辑提交过程，编辑过程中将后面的提交命令修改为s即可，保存后会提示你是否重新编辑log内容，按需编写即可。</span></span><br><span class=\"line\">git rebase -i  commit号 <span class=\"comment\">#将commit号到最新的提交合并为一个提交，需要在弹出的交互页面中编辑合并过程</span></span><br><span class=\"line\">git rebase -i  start_commit号 end_commit号  <span class=\"comment\">#合并指定commit号之间的的提交</span></span><br><span class=\"line\">git rebase -i HEAD~3   <span class=\"comment\">#合并最新的三次提交，编辑页面将后两次命令修改为s，wq后编辑新的commit</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 该命令也可以合并分支</span></span><br><span class=\"line\">git rebase -i  分支名称 <span class=\"comment\">#将指定分支合并到当前分支，合并时将指定分支的多个提交合并为一次提交，需要在弹出的交互页面中编辑合并过程</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>如果修改的提交节点距离结束的提交节点中间有多个节点，而上一次和下一次都需要合并文件，这个过程就要进行多次。个人感觉这个过程虽然可以重新整理提交节点，使节点更准确清晰，但是如果修改的点比较远，文件内容变化复杂，这个多次合并的过程还是比较痛苦的，不推荐在这种情况下使用。</li>\n<li>推荐的使用场景为，针对同一个功能进行修改，在commit后尚未进行pushsa时发现有些内容需要变化，如果此时没有进行commit，可以执行<code>git commit --amend  -am &quot;注释&quot;</code>,如果已经执行了commit，则可以执行<code>git rebase -i HEAD~2</code>。</li>\n</ul>\n<h4 id=\"示例\"><a href=\"#示例\" class=\"headerlink\" title=\"示例\"></a>示例</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git rebase -i HEAD~3</span><br></pre></td></tr></table></figure>\n<ul>\n<li><p>注意这里会进入两次编辑页面，一次是多个提交的处理方式，按提示进行修改即可，一般保留第一行的命令pick，后面的行命令修改为s，然后wq保存。</p>\n</li>\n<li><p>注意合并多个分支时如果包含已经发布过的分支，就要调整顺序，将已经发布的最后一个分支放到第一行，否则再次发布时会提示需要先执行<code>git pull</code>，这是因为按照上面的逻辑只有第一行的是提交操作，后面的不会产生新的提交，所以版本号就会落后于远端分支，但是即便调整顺序，也会提示版本偏离，还是要先执行<code>git pull</code>，待手工合并冲突后再次提交一个新的commit，所以，最好的方法就是不要包含已经发布过的分支，只针对未发布的分支进行合并。<br>编辑后的：<br><img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/rebase3.png\"></p>\n</li>\n<li><p>第二个页面是要求你编辑本次合并的log说明，此时每次的log都会显示在这个页面，去掉不需要的，重新编辑一下保存即可。<br><img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/rebase4.png\"><br>编辑后的：<br><img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/rebase5.png\"></p>\n<!-- <div>\n<img src=\"/images_glob/git-command/rebase5.png\" width=\"60%\">\n</div> -->\n<p>查看日志：git log –oneline<br><img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/rebase6.png\"></p>\n</li>\n</ul>\n<h3 id=\"21-git-revert–如何撤销指定的提交呢，就是把这次提交回滚到其前一次提交的状态，但是又不影响其之后的提交？\"><a href=\"#21-git-revert–如何撤销指定的提交呢，就是把这次提交回滚到其前一次提交的状态，但是又不影响其之后的提交？\" class=\"headerlink\" title=\"21.git revert–如何撤销指定的提交呢，就是把这次提交回滚到其前一次提交的状态，但是又不影响其之后的提交？\"></a>21.<code>git revert</code>–如何撤销指定的提交呢，就是把这次提交回滚到其前一次提交的状态，但是又不影响其之后的提交？</h3><ul>\n<li><code>git revert</code> 是回滚某个commit ，不是回滚“到”某个</li>\n<li><code>git revert</code>是用一次新的commit来回滚之前的commit，<code>git reset</code>是直接删除指定的commit。</li>\n<li><code>git reset</code> 撤销到某次提交, <code>git revert</code> 撤销某次提交，撤销并不意味着删除本次提交，其log里仍然会有这次提交，只不过revert后会产生一个新的节点用于提交，而reset是会删除之前的log。</li>\n<li>需要回滚到上一个版本时，可以通过<code>git reset HEAD~1</code>实现，也可以通过执行<code>git revert HEAD</code>实现。区别就是reset后再次发布需要<code>git push -f</code>，而revert不需要-f参数，因为revert时会在顶端产生一个新的节点，其版本号一定比远端新的。</li>\n<li>还有一点需要注意，例如dev是从 master checkout出来的分支，然后针对dev执行reset时，如果reset的版本master里也包含，此时再将dev merge 回 master时，则master里会保留本应该被reset的内容，而执行revert则不会出现这个问题，因为revert是用一次逆向的commit“中和”之前的提交。</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 撤销并commit一次新的提交</span></span><br><span class=\"line\">git revert HEAD        <span class=\"comment\">#撤销前一次 commit</span></span><br><span class=\"line\">git revert HEAD^       <span class=\"comment\">#撤销前前一次 commit</span></span><br><span class=\"line\">git revert HEAD~3      <span class=\"comment\">#撤销倒数第四次提交</span></span><br><span class=\"line\">git revert commit号    <span class=\"comment\">#撤销指定的版本，撤销也会作为一次提交进行保存。</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 如果只撤销，即只改变本地目录和索引，但不执行commit，可以加上-n参数，然后手工执行commit操作</span></span><br><span class=\"line\">git revert -n HEAD~3</span><br><span class=\"line\">git revert -n &lt;commit1&gt;..&lt;commit2&gt; <span class=\"comment\"># 撤销多个版本，commit1 &gt; x &gt;= commit2，此时要加上-n参数，否则每个撤销都会创建一个新的commit号</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"22-如何打tag\"><a href=\"#22-如何打tag\" class=\"headerlink\" title=\"22.如何打tag\"></a>22.如何打tag</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git tag -a <span class=\"string\">&quot;prod_x.x.x&quot;</span> -m <span class=\"string\">&quot;message&quot;</span> <span class=\"comment\">#打标签, -a是标签名 -m注释</span></span><br><span class=\"line\">git push origin <span class=\"string\">&quot;prod_x.x.x&quot;</span> <span class=\"comment\">#将这个新标签推送到远程仓库</span></span><br><span class=\"line\"></span><br><span class=\"line\">git tag <span class=\"comment\">#查看标签信息</span></span><br><span class=\"line\">git show prod_x.x.x <span class=\"comment\">#显示被打标签的commit的详细信息</span></span><br><span class=\"line\"></span><br><span class=\"line\">git checkout -b hotfix_x.x.x prod_x.x.x <span class=\"comment\">#从prod_x.x.x标签的版本上开一个新的修复分支</span></span><br><span class=\"line\">git push origin hotfix_x.x.x <span class=\"comment\">#将hotfix_x.x.x分支推送到远程仓库</span></span><br><span class=\"line\">git branch --set-upstream-to=origin/hotfix_x.x.x hotfix_x.x.x <span class=\"comment\">#关联本地分支到远程分支</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"23-git-pull-git-fetch-git-merge这种说法对吗？\"><a href=\"#23-git-pull-git-fetch-git-merge这种说法对吗？\" class=\"headerlink\" title=\"23.git pull = git fetch + git merge这种说法对吗？\"></a>23.<code>git pull</code> = <code>git fetch</code> + <code>git merge</code>这种说法对吗？</h3><ul>\n<li>先说答案，<code>git pull</code> != <code>git fetch</code> + <code>git merge</code>，但是确实很像。</li>\n<li>其实更好的比较是<code>git pull --rebase</code> 与 <code>git fetch</code> + <code>git merge</code>的区别，其相当于<code>git fetch</code> + <code>git rebase</code></li>\n</ul>\n<p>为了说清楚这个问题，我们需要先明白git的三个仓库：</p>\n<ol>\n<li>本地仓库：如master，修改代码，提交暂存区，然后commit到的就是本地仓库</li>\n<li>本地远程跟踪仓库：如orign/master，这个仓库不能用来直接提交代码，其用来保存上一次从远程仓库拉取到的最新版本，如果不主动执行git fetch，git pull，git push等，是不会更新这个版本的。</li>\n<li>远程仓库：git服务器，如github。执行git push时会将本地仓库的版本发布到远程仓库。</li>\n</ol>\n<ul>\n<li><code>git fetch</code>的作用是将远程仓库(如github)的版本与本地远程跟踪仓库(如orign/master)的版本保持一致。之后我们在master分支下执行<code>git merge orign/master</code>就会将远程仓库的代码合并到本地仓库，所以合并后会产出一个新的版本，我们可以发布这个版本到远程仓库。</li>\n<li><code>git pull</code>的作用很像<code>git fetch</code> + <code>git merge</code>，区别就是，<code>git pull</code>时如果没有冲突，就不会产生新的版本。</li>\n</ul>\n<h3 id=\"24-如何确定开发–-gt-测试–-gt-发布流程？\"><a href=\"#24-如何确定开发–-gt-测试–-gt-发布流程？\" class=\"headerlink\" title=\"24.如何确定开发–&gt;测试–&gt;发布流程？\"></a>24.如何确定开发–&gt;测试–&gt;发布流程？</h3><h4 id=\"开发A模型：基于master的主分支开发模型\"><a href=\"#开发A模型：基于master的主分支开发模型\" class=\"headerlink\" title=\"开发A模型：基于master的主分支开发模型\"></a>开发A模型：基于master的主分支开发模型</h4><p><img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/A-git-dev.png\"></p>\n<ul>\n<li>使用git rebase orign将远程分支内容合并到当前master主分支，保证本地master始终是一条线</li>\n<li>模型结构简单，始终记住使用<code>git fetch</code> + <code>git rebase</code>或者<code>git pull --rebase</code>更新主分支版本</li>\n</ul>\n<h4 id=\"开发B模型：基于dev的子分支开发模型\"><a href=\"#开发B模型：基于dev的子分支开发模型\" class=\"headerlink\" title=\"开发B模型：基于dev的子分支开发模型\"></a>开发B模型：基于dev的子分支开发模型</h4><p><img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/B-git-dev.png\"></p>\n<ul>\n<li>增加了一个dev子分支，合并回master主分支时可以通过<code>git rebase -i</code>的方式合并多个commit为一个commit，减少版本号数量</li>\n<li>每次开发时要创建新的分支，开发完成后删除该分支，虽略显反锁，但也更加灵活，比如上一次的开发任务还没有完成，有一个紧急的任务需要马上处理，此时只需要从master分支checkout出一个子分支进行开发即可。</li>\n<li>使用<code>git pull --rebase</code>更新远程版本，使用<code>git rebase dev</code>合并子分支，总的目标依旧是保证本地master始终是一条线</li>\n</ul>\n<h4 id=\"测试模型：基于A-B模型的master的主分支\"><a href=\"#测试模型：基于A-B模型的master的主分支\" class=\"headerlink\" title=\"测试模型：基于A\\B模型的master的主分支\"></a>测试模型：基于A\\B模型的master的主分支</h4><ul>\n<li>开发完成后，从master分支中checkout出一个release分支用于测试</li>\n<li>测试过程中如果有bug，则由开发人员通过开发模型进行修复，修复后merge到release中</li>\n<li>测试通过后，将release分支内容merge到prod分支中（prod表示生产分支，第一次时从release中checkout创建）</li>\n<li>release分支仅仅为了本次发布内容而创建的测试分支，所以发布后可以删除release分支</li>\n</ul>\n<h4 id=\"发布模型\"><a href=\"#发布模型\" class=\"headerlink\" title=\"发布模型\"></a>发布模型</h4><ul>\n<li>release分支测试通过够会merge到prod生产分支，此时代码可以发布上线，上线前需要为prod打tag</li>\n<li>只有打了tag的代码才能部署上线，如果线上代码发现bug，则从对应的tag中checkout一个hotfix分支，用于bug修复</li>\n<li>bug修复后从hotfix分支checkout出hotfix_release分支进行测试，测试过程按照<code>测试模型</code>进行</li>\n<li>测试通过后按照<code>发布模型</code>进行</li>\n<li>发布后需要将hotfix_release分支merge到master开发主分支，之后可以删除本次hotfix分支和hotfix_release分支</li>\n</ul>\n<h4 id=\"说明\"><a href=\"#说明\" class=\"headerlink\" title=\"说明\"></a>说明</h4><ul>\n<li>本地和远程始终存在的分支是master开发主分支和prod发布主分支</li>\n<li>每次上线前一定要打tag，tag对应的就是当前生产环境</li>\n<li>测试分支和修复分支根据需要进行创建，用后可以删除。</li>\n</ul>\n","content_text":"摘要 一起来了解一些git常用命令吧 推荐一个学习git命令的网站：https://learngitbranching.js.org/?locale=zh_CN 基本概念Git的5种工作区域 工作目录：用于新增、修改、删除文件，实际我们用于编写代码的目录 暂存区：执行add命令可以将工作目录对应的文件提交到暂存区，只有加入到暂存区的文件才会参与版本控制，其实际为一堆索引文件，保存在.git/objects目录下，记录每个文件的快照（hash） 本地版本库：执行commit命令可以将暂存区的文件提交到本地版本库，每一次提交都会记录版本日志，其实际保存位置也是.git/objects目录下的快照文件，每一次commit如果文件发生变化都会生成新的快照，.git/refs/heads/下记录每个分支的最新一次commit的版本号 远程跟踪区：.git/refs/remotes/origin/下记录每个分支的最新一次更新后的远程版本号，执行fetch\\pull\\push时都会更新为最新的远程版本号。如果只执行fetch仅仅会更新远程跟踪区，并不会更新本地目录，执行pull命令会同时更新远程跟踪区和本地目录 远程版本库：例如github 文件的状态 Untracked:未跟踪的文件，尚未加入过暂存区的文件 12345678910➜ git:(release) touch a.txt➜ git:(release) ✗ git status位于分支 release您的分支与上游分支 &#x27;origin/release&#x27; 一致。未跟踪的文件: （使用 &quot;git add &lt;文件&gt;...&quot; 以包含要提交的内容） a.txt提交为空，但是存在尚未跟踪的文件（使用 &quot;git add&quot; 建立跟踪） 要提交的变更[新增]，加入暂存区 12345678➜ git:(release) ✗ git add .➜ git:(release) ✗ git status位于分支 release您的分支与上游分支 &#x27;origin/release&#x27; 一致。要提交的变更： （使用 &quot;git restore --staged &lt;文件&gt;...&quot; 以取消暂存） 新文件： a.txt 已提交版本库待发布到远端，将暂存区的文件加入本地版本库 12345678910➜ git:(release) ✗ git commit -m &#x27;add a.txt&#x27;[release 9292bb2] add a.txt 1 file changed, 0 insertions(+), 0 deletions(-) create mode 100644 a.txt➜ git:(release) git status位于分支 release您的分支领先 &#x27;origin/release&#x27; 共 1 个提交。 （使用 &quot;git push&quot; 来发布您的本地提交）无文件要提交，干净的工作区 尚未暂存以备提交的变更，加入过暂存区的文件发生修改 123456789101112➜ git:(release) echo &quot;hello&quot; &gt;&gt; a.txt➜ git:(release) ✗ git status位于分支 release您的分支领先 &#x27;origin/release&#x27; 共 1 个提交。 （使用 &quot;git push&quot; 来发布您的本地提交）尚未暂存以备提交的变更： （使用 &quot;git add &lt;文件&gt;...&quot; 更新要提交的内容） （使用 &quot;git restore &lt;文件&gt;...&quot; 丢弃工作区的改动） 修改： a.txt修改尚未加入提交（使用 &quot;git add&quot; 和/或 &quot;git commit -a&quot;） 要提交的变更[修改]，加入过暂存区的文件重新加入暂存区 123456789➜ git:(release) ✗ git add .➜ git:(release) ✗ git status位于分支 release您的分支领先 &#x27;origin/release&#x27; 共 1 个提交。 （使用 &quot;git push&quot; 来发布您的本地提交）要提交的变更： （使用 &quot;git restore --staged &lt;文件&gt;...&quot; 以取消暂存） 修改： a.txt 切换分支时值得注意的地方 只要文件没有被commit，无论是新增还是修改，切换分支时，文件的状态都会被带到切换后的分支 所以切换分支前，一定要执行commit HEAD指针和分支指针 我们在查看git的log时会看到类似于* 6d93a15 (HEAD -&gt; master) message这样的信息，6d93a15就是commit时的版本号，master是分支名称，HEAD就是HEAD指针，实际上这里的master也是一个指针，他就是分支指针 分支指针永远指向当前分支最新的一次提交版本，分支指针对应版本号保存在.git/refs/heads/目录下对应的分支文件中 HEAD指针表示我们当前的工作目录是基于哪个版本checkout出来的，通常情况下HEAD指针指向分支指针，但当我们通过命令git checkout &lt;commit号&gt;切换到某个版本时，HEAD指针就不再指向分支指针，这个情况有个名字叫作detached HEAD(头分离)，HEAD指针对应的版本号保存在.git/HEAD文件中，这也是为什么我们每次进入项目，git都知道我们当前所在分支或版本号是什么。 参考资料：https://www.zsythink.net/archives/3412/ 问题与方法1.别人在远程仓库中创建了新的branch，我本地执行git branch -a却看不到，如何才能看到并checkout呢？123456789101112131415161718192021222324# 1.先要获取远端全部信息git fetch origin# git fetch 远程名称，通过git remote查看，一般就是origin。git fetch # 也可以不加远程名称# 该命令无论在哪个分支上执行，都会更新本地所有的远程分支# git fetch 完成了仅有的但是很重要的两步:# 1.从远程仓库下载本地仓库中缺失的提交记录# 2.更新远程分支指针(如 o/master)# git fetch 实际上将本地仓库中的远程分支更新成了远程仓库相应分支最新的状态。# git fetch 并不会改变你本地仓库的状态。它不会更新你的 本地 分支，也不会修改你磁盘上的文件。# 2.再查看分支信息git branch -a# 3.checkout到本地并切换到新创建的分支git checkout -b release（本地分支名） origin/release（远程分支名）控制台输出：分支 &#x27;release&#x27; 设置为跟踪来自 &#x27;origin&#x27; 的远程分支 &#x27;release&#x27;。切换到一个新分支 &#x27;release&#x27;# 4.查看当前分支跟踪的远程分支git rev-parse --abbrev-ref --symbolic-full-name @&#123;u&#125; # @&#123;u&#125; 是 @&#123;upstream&#125; 的简写控制台输出：origin/release 2.如何查看本地分支与远程分支的区别？1234567891011121314# 1.先要获取远端全部信息git fetch origin# 或者git fetch# 2.切换到待比较的本地分支，如mastergit checkout master# 3.比较当前分支与origin/master之间的不同，--stat只显示哪些文件有不同，如果要查看每个文件不同的详细信息就去掉--statgit diff origin/master --stat# 4.比较任意两个分支的不同，--stat只显示哪些文件有不同，如果要查看每个文件不同的详细信息就去掉--statgit diff origin/master..master --stat 3.如何查看本地两个分支之间的区别？12345# 1.比较任意两个分支的区别git diff master..dev --stat# 2.比较当前分支与master分支的区别git diff master --stat 4.如何查看本地的发生了哪些更改？1234567891011# 当前工作目录的索引和上次提交索引之间的差异，只有已经被commit过的文件才会被比较，如果是新增的文件则看不到git diff --stat# 可以通过`git status`命令查看本地都有哪些变化，包含新增未加入暂存区的，新增已加入暂存区的，已提交过但有改动的，等等git status# 查看下次执行`git commit`时会被提交的文件git diff --cached --stat# 查看下次执行`git commit -a` 时会被提交的文件，-a表示先add再commitgit diff HEAD --stat 5.如何提交本地仓库？12345678# 本地无论是新增文件或修改文件，都要add后才能commit# 1.先add再commitgit add .git commit -m &#x27;message&#x27;# 2.add同时commit，注意，如果存在尚未跟踪的文件，需要使用 &quot;git add&quot; 建立跟踪 git commit -a -m &#x27;message&#x27; 6.git reset–如何回滚到指定版本或分支? git reset的作用是修改HEAD的位置，即将HEAD指向的位置改变为之前存在的某个版本，如果想恢复到之前某个提交的版本，且那个版本之后提交的版本我们都不要了，就可以用这种方法。 注意，如果reset包含了已经发布（git push）的的版本，此时如果用git push会报错，因为我们本地库HEAD指向的版本比远程库的要旧，需要执行命令git push -f强制更新远程 注意参数--hard有和没有的区别，有–hard，则完全回退到上一版本，丢弃所有其它修改，清空暂存区，同步工作目录到指定版本。没有–hard，则该版本之后的变化会变为Modified状态保留在工作目录，只清空暂存区。 12345678910111213141516171819202122# 1.回滚到上一个版本git reset --hard HEAD^ # 完全回退到上一个版本，丢弃所有其它修改，清空暂存区，同步工作目录到指定版本，也就是说，上一次提交之后新增或修改的文件内容都没有了git reset HEAD~1 # 则该版本之后的变化会变为Modified状态保留在工作目录，只清空暂存区，也就是说，上一次提交之后新增或修改的文件内容得以保留# 2.回滚到上上个版本git reset --hard HEAD^^git reset HEAD~2# 3.回滚到指定版本的分支git reset --hard 版本号# 3.1 查看版本号git log --oneline# 4.回滚到指定分支git reset --hard 分支名称# 4.1 回滚到与本地远程分支一样的状态，一般本地仓库搞坏了会这么做git reset --hard origin/master# 5. `git log`看不到reset的历史，可以通过如下命令查看git reflog 7..gitignore–在git中如果想忽略掉某个文件，不让这个文件提交到版本库中，要怎么做呢？12345678910111213141516171819202122232425262728293031323334# 在工作目录下创建 .gitignore 文件# 其格式为：# 此为注释 – 将被 Git 忽略*.a # 忽略所有 .a 结尾的文件!lib.a # 但 lib.a 除外/TODO # 仅仅忽略项目根目录下的 TODO 文件，不包括 subdir/TODObuild/ # 忽略 build/ 目录下的所有文件doc/*.txt # 会忽略 doc/notes.txt 但不包括 doc/server/arch.txt# 忽略文件默认为当前项目目录下的.gitignore文件，也可以通过如下命令指定文件路径和名称git config core.excludesfile .gitignore_dev# 也可配置为全局文件，这样就不需要为每个项目都创建.gitignore 文件git config --global core.excludesfile ~/.gitignore_global# .gitignore 文件 只对git add起作用，如果有文件在被加入到.gitignore 文件前就已经被commit了可以使用如下方法# 1.删除暂存区、分支上内容，本地保留。解除该文件的追踪关系，脱离版本控制。git rm --cached 文件名 # 删除文件git rm -r --cached 文件夹 # 删除文件夹 -r 表示允许递归删除git rm -r --cached . # 删除当前目录下全部文件的暂存区git rm -r 文件夹/文件名 #删除本地、暂存区、分支上内容，如果该文件不需要在本地保留，就可以测底删除# 2.重新加入暂存区git add . # 将当前目录下所有文件加入暂存区git add file/dir #将指定文件或目录加入暂存区，支持通配符# 3.查看暂存区内容git diff --cached# 4.提交git commit -m &quot;message&quot; # 将暂存区内容提交到本地版本库git commit -am &quot;message&quot; # 先提交暂存区再提交到本地版本库 8.git commit --amend–commit后发现有内容要修改或者注释写错了，但是不想创建新的一次commit，要怎么办呢？ 以下命令如果直接合并到已经push过的版本，再次git push时会提示”更新被拒绝，因为您当前分支的最新提交落后于其对应的远程分支”，此时可以执行git push -f强行发布即可。12345# 覆盖上一次提交，这样不会产生新的提交git commit --amend -am &quot;注释&quot;# 在上次提交中附加一些内容，保持提交日志不变git commit -a --amend --no-edit 9.git log–如何查看提交日志?123456789101112131415# 显示版本历史，如果有用git reset --hard xxxxx回退操作，则只会显示到xxx之前的历史git log # 显示当前分支之前的全部日志git log --all # --all 显示全部分支git log --oneline # 单行显示git log --oneline --all --graph # 图形化显示全部分支log# 在所有提交日志中搜索包含「homepage」的提交git log --all --grep=&#x27;homepage&#x27; #模糊匹配# 获取某人的提交日志git log --author=&quot;hanqf&quot; #模糊匹配# 查看完整版本历史，也就是说即便有git reset也会显示git reflog 10.如何创建本地仓库并绑定到远程仓库?1234567891011121314151617181920212223# 1.首先要在对应的git服务器创建一个新的仓库，一般的git服务器创建新仓库后都会提示你如何绑定该仓库的# 2. 创建本地仓库git init #将当前目录加入版本控制git init dir #将dir加入版本控制# 默认使用 &#x27;master&#x27; 作为初始分支的名称，如果要修改分支名称，可以执行如下命令：git branch -m &lt;name&gt;# 也可以通过设置git config来配置默认的名称，除了 &#x27;master&#x27; 之外，通常选定的名字有 &#x27;main&#x27;、&#x27;trunk&#x27; 和 &#x27;development&#x27;。git config --global init.defaultBranch &lt;名称&gt;# 3. 创建新的文件后提交到本地仓库git add . &amp;&amp; git commit -m &#x27;message&#x27;git commit -am &quot;备注&quot;# 4.绑定远程仓库git remote add origin https://xxxxx (远程仓库地址)# 5.提交本地仓库的变更到远程仓库，这里要注意github的主分支名称已经变更为main，所以提交github时要将master替换为maingit pull --rebase origin master #获取远程库与本地同步合并（如果远程库不为空必须做这一步，否则后面的提交会失败）git push -u origin master #提交master到其远程仓库，第一次提交加上-u，以后就不用了git push origin master# 或者git push # 将当前分支提交到其对应的远程仓库 11.远程仓库地址变更后如何更新？12345678910111213# 1.命令行修改git remote set-url origin [NEW_URL]# 2.手工编辑.git目录下的config文件[remote &quot;origin&quot;] url = https://xxxxxx (修改为新的地址) fetch = +refs/heads/*:refs/remotes/origin/*# 3.查看修改后的地址git remote get-url origin #只会显示可以fetch的地址# 4.查看远程仓库地址git remote -v # 会显示push和fetch的地址 12.如何将本地仓库同时绑定到多个远程仓库？123456789101112131415# 1.按照`10.如何创建本地仓库并绑定到远程仓库?`中的步骤完成第一个仓库的绑定# 2.手工编辑.git目录下的config文件[remote &quot;origin&quot;] url = https://xxxxxxxx1 # 此处为第一个远程仓库的地址，即可以push又可以fetch url = https://xxxxxxxx2 # 在此添加第二个仓库的地址，以此类推，可以添加多个，只可以push，只能备份使用 fetch = +refs/heads/*:refs/remotes/origin/*# 3.保存后再次执行，这里要注意github的主分支名称已经变更为main，所以提交github时要将master替换为maingit push -u origin master # 提交master到其远程仓库，只有第一次执行时需要加上 -u ，以后只需要：git push origin master# 或者git push # 将当前分支提交到其对应的远程仓库# 4.查看远程仓库地址git remote -v 13.如何在git pull时不用每次都输入密码？12345# 进入项目目录git config --global credential.helper store# 执行 git pull 并输入密码，此时当前项目就会记住密码了，下次再执行时就不用密码了git pull 14.如果文件已经git add到暂存区，但是尚未commit，此时如何将文件从暂存区中移除？12345678910111213141516171819# 如果文件还没有放入暂存区git checkout -- &lt;文件名&gt; #放弃对某一个文件已经做出的修改，回到head版本的该文件# 如果文件已经`git add`到暂存区，但是尚未commit# 移出单个文件git restore --staged &lt;文件路径&gt;# 移出本次全都add到暂存区的文件git reset . # 重置本次全部索引，.代表当前目录# 可以通过git status查看文件路径git status# 如果已经commit，可以通过如下方式移除# 删除暂存区、分支上内容，本地保留。解除该文件的追踪关系，脱离版本控制。git rm --cached &lt;文件名&gt; # 删除文件git rm -r --cached &lt;文件夹&gt; # 删除文件夹 -r 表示允许递归删除git rm -r --cached . # 删除当前目录下全部文件的暂存区，.代表当前目录 15.git config–如何设置和查看git配置信息？12345678910111213141516171819202122232425262728# 使用git config命令进行设置和查看# 全局设置用户名和邮箱，全局配置是保存在 ~/.gitconfig中的git config --global user.name &quot;你的用户名&quot;git config --global user.email &quot;你的邮箱&quot;# 只对当前项目有效，项目根目录下执行，去掉--global，项目配置优先级更高，项目配置保存在.git/config中，可以直接修改git config user.name &quot;你的用户名&quot;git config user.email &quot;你的邮箱&quot;# 修改你的用户名和邮箱git config --global --replace-all user.name &quot;你的用户名&quot;git config --global --replace-all user.email &quot;你的邮箱&quot;# 查看配置git config --list # 此时项目配置和全局配置都会显示git config --global --list # 只显示全局配置，全局配置是保存在 ~/.gitconfig中的git config user.name # 查看某个配置的值# 修改全局配置的值，--replace-all会匹配所有行，也可以直接在~/.gitconfig中修改git config --global --replace-all user.name &quot;你的用户名&quot;git config --global --replace-all user.email &quot;你的邮箱&quot;# 修改项目配置的值，--replace-all会匹配所有行，也可以直接在.git/config中修改git config --replace-all user.name &quot;你的用户名&quot;git config --replace-all user.email &quot;你的邮箱&quot; 16.提交的文件太大(默认是1M)，导致push失败怎么办？123456# 加大缓冲区大小（http.postBuffer的参数）# 524288000 的单位代表 B，524288000B 也就是 500MB。git config http.postBuffer 524288000# 或全局设置git config --global http.postBuffer 524288000 17.clone代码最简单的方式是通过https的形式，不过一般这样做需要输入用户名和密码，如果不想输入用户名和密码可以使用git@xxxx的形式，如何实现呢？123456789101112131415161718192021222324# 这种方式就是基于ssh的密钥证书来实现# 生成本地ssh密钥对，按照提示完成三次回车，即可生成 ssh key。此时会在~/.ssh/下创建id_rsa.pub(公钥)和id_rsa(私钥)ssh-keygen -b 4096 -t rsa # -t 指定生成密钥的算法类型，生成的文件名称就是以其开头的，如这里就是id_rsa# 支持的密钥算法类型包含：rsa,ed25519,等等，具体参见各个git服务器的配置说明# 此时cat id_rsa.pub 可以看到公钥的内容# 形式为:sshkey的算法+密文+sshkey的标签，此时sshkey算法为ssh-rsa，sshkey标签为机器名称，若要指定sshkey标签可以通过-C指定ssh-keygen -b 4096 -t rsa -C &quot;xxxxxxx&quot;# 注意这里-C可以指定任意值，网上说必须指定邮箱其初衷仅仅是为了便于辨识# 将公钥文件内容复制到对应的git服务器配置ssh-key的地方，具体使用方式可以参见各个git服务器的说明。# Github: settings--SSH and GPG keys--SSH keys--New SSH key# 测试连接是否正常ssh -T git@github.com# Coding: 个人帐号设置--个人设置--SSH 公钥--新增公钥# 测试连接是否正常ssh -T git@e.coding.net# Gitee: 设置--安全设置--SSH公钥# 测试连接是否正常ssh -T git@gitee.com# clone代码示例git clone git@github.com:hanqunfeng/reactive-redis-cache-annotation-spring-boot-starter.git 18.git branch–如何创建分支\\切换分支\\查看分支\\删除分支\\发布分支？1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950# 从当前分支创建release分支，但是不切换git branch releasegit checkout release # 从当前分支切换到release分支git checkout &lt;commit号&gt; # 从当前分支切换到commit号对应的版本# 注意，当切换到某个版本号对应的版本时就会发生“头分离”，即HEAD指针不会再指向分支指针，而是指向了那个版本# 从当前分支创建并切换到release分支，相当于执行git branch release &amp;&amp; git checkout release两个命令git checkout -b release# 从dev分支创建release分支，但是不切换git branch release dev# 从dev分支创建release分支,并切换git checkout -b release dev# 从指定版本创建release分支，版本号通过git log --oneline查看git branch release 799fb04git checkout -b release 799fb04# 从远程分支origin/release创建release分支，并切换git checkout -b release origin/release#跳到上一个分支，比如当前是master分支，是从dev分支通过git checkout master命令切换过来的，那么该命令会重新回到dev分支git checkout -# 查看分支git branch #列出所有本地分支，标*的就是当前所在的分支，.git/HEAD 文件中存放的就是当前分支信息git branch --remote #列出远程仓库中的所有分支git branch -a #同时显示本地和远程的所有分支cat .git/HEAD #查看当前所在分支git symbolic-ref HEAD #查看当前所在分支，本地分支# 删除分支# 删除release分支，不能在release下删除自己git branch -d release# 假设我们通过master创建了release分支，此时release分支发生了变更并执行了commit，但是并没有将更改merge回master，此时删除release分支需要执行如下命令git branch -D release # -D 强制删除# 发布分支git push --set-upstream origin &lt;new branch name&gt; #推新分支到远程仓库并在本地分支和远程分支之间建立关联# 也可以分两步完成，但推荐上面的方式git push origin &lt;new branch name&gt; #推新分支到远程仓库git branch --set-upstream-to=origin/&lt;new branch name&gt; &lt;new branch name&gt; #关联本地分支到远程分支，否则每一次pull或push的时候都需要明确指定本地和远端分支。# 查看当前分支跟踪的远程分支git rev-parse --abbrev-ref --symbolic-full-name @&#123;u&#125; # @&#123;u&#125; 是 @&#123;upstream&#125; 的简写 19.merge还是rebase? 如何合并分支?一般开发流程： 更新主分支 git pull 从主分支创建一个开发分支 git checkout -b dev，每个开发人员都会创建一个自己的开发分支 开发分支完成测试后合并回主分支，这里推荐使用git rebase，开发分支的log会被移动到主分支的顶端，这样主分支始终是一条线 这样主分支在保持干净的同时还保留了每一次commit的log，便于开发人员追溯历史 也可以使用git merge --no-ff，其也会保留每次的log到主分支上 一般发布流程： 将主分支测试完成后合并到发布分支，一般都是由一个专门的人员进行合并，此时推荐使用git merge，这样每次一发布的版本都会产生一个新的节点，而主分支上的多次commit的log不会被记录到发布分支上 这样发布分支看起来就是每一次大的发布才会合并一次并记录log，log中可以编辑本次发布的内容。 示例准备，初始化一个待合并的目录1234567891011121314151617181920212223242526272829➜ mkdir git_test➜ cd git_test➜ touch 1.txt➜ git init[master（根提交） 5b91fc1] init... 1 files changed, 0 insertions(+), 0 deletions(-) create mode 100644 1.txt➜ git:(master) git add . &amp;&amp; git commit -m &#x27;init...&#x27;➜ git:(master) git checkout -b dev➜ git:(dev) echo &quot;dev1&quot; &gt;&gt; a.txt➜ git:(dev) ✗ git add . &amp;&amp; git commit -m &#x27;dev1&#x27;[dev 8d57739] dev1 1 file changed, 1 insertion(+) create mode 100644 a.txt➜ git:(dev) ✗ git checkout master切换到分支 &#x27;master&#x27;➜ git:(master) ✗ echo &quot;master1&quot; &gt;&gt; a.txt➜ git:(master) ✗ git add . &amp;&amp; git commit -m &#x27;master1&#x27;[master fa2400a] master1 1 file changed, 1 insertion(+) create mode 100644 a.txt➜ git:(master) ✗ git checkout dev切换到分支 &#x27;dev&#x27;➜ git:(dev) ✗ echo &quot;dev2&quot; &gt;&gt; a.txt➜ git:(dev) ✗ git add . &amp;&amp; git commit -m &#x27;dev2&#x27;[dev 0006560] dev2 1 file changed, 1 insertion(+)➜ git:(dev) ✗ git checkout master切换到分支 &#x27;master&#x27; merge将dev分支merge到当前分支 1git merge dev merge会将dev分支和当前分支合并后创建一个新的节点放到当前分支最顶端，所以解决完冲突，需要执行如下命令创建一个新的commit1git add . &amp;&amp; git commit -m &#x27;merge dev&#x27; merge的log会按照时间顺序显示 merge后如果删除了dev分支，则在log中就看不到这个分支信息了，但是日志内容还在 merge示例123456789➜ git:(master) ✗ git merge dev冲突（add/add）：合并冲突于 a.txt自动合并 a.txt自动合并失败，修正冲突然后提交修正的结果。➜ git:(master) ✗ vim a.txt➜ git:(master) ✗ git add . &amp;&amp; git commit -m &#x27;master merge release&#x27;➜ git:(master) git log --oneline # 此时才能看到日志➜ git:(master) git branch -D dev已删除分支 dev（曾为 0006560）。 删除dev分支后 rebase将dev分支rebase到当前分支 1git rebase dev rebase会将dev分支的每一个节点转移到当前分支最顶端，而不会产生一个新的节点，这样rebase后的分支节点看起来就是一条线 解决完冲突，执行git add .和git rebase --continue，不会产生额外的commit rebase后如果删除了dev分支，则在log中就看不到这个分支信息了，但是日志内容还在，这样看起来就是主分支自己的节点，没有产生过新的分支 如果要放弃本次合并，可以运行git rebase --abort rebase示例123456789101112131415161718➜ git:(master) git rebase dev冲突（add/add）：合并冲突于 a.txt自动合并 a.txterror: 不能应用 0657382... master1Resolve all conflicts manually, mark them as resolved with&quot;git add/rm &lt;conflicted_files&gt;&quot;, then run &quot;git rebase --continue&quot;.You can instead skip this commit: run &quot;git rebase --skip&quot;.To abort and get back to the state before &quot;git rebase&quot;, run &quot;git rebase --abort&quot;.不能应用 0657382... master1➜ git:(e4410b4) ✗ vim a.txt➜ git:(e4410b4) ✗ git add .➜ git:(e4410b4) ✗ git rebase --continue[分离头指针 bd01ea0] master1 1 file changed, 1 insertion(+)成功变基并更新 refs/heads/master。➜ git:(master) git log --oneline➜ git:(master) git branch -D dev已删除分支 dev（曾为 e4410b4）。 删除dev分支后 20.git rebase -i–我commit了很多次，发现都是干的一件事，此时如果直接rebase到主分支会有很多没必要的log，是否可以合并这些commit为一个呢？1234567# git rebase -i 即可以合并多次提交，也可以合并分支，-i表示可以编辑提交过程，编辑过程中将后面的提交命令修改为s即可，保存后会提示你是否重新编辑log内容，按需编写即可。git rebase -i commit号 #将commit号到最新的提交合并为一个提交，需要在弹出的交互页面中编辑合并过程git rebase -i start_commit号 end_commit号 #合并指定commit号之间的的提交git rebase -i HEAD~3 #合并最新的三次提交，编辑页面将后两次命令修改为s，wq后编辑新的commit# 该命令也可以合并分支git rebase -i 分支名称 #将指定分支合并到当前分支，合并时将指定分支的多个提交合并为一次提交，需要在弹出的交互页面中编辑合并过程 如果修改的提交节点距离结束的提交节点中间有多个节点，而上一次和下一次都需要合并文件，这个过程就要进行多次。个人感觉这个过程虽然可以重新整理提交节点，使节点更准确清晰，但是如果修改的点比较远，文件内容变化复杂，这个多次合并的过程还是比较痛苦的，不推荐在这种情况下使用。 推荐的使用场景为，针对同一个功能进行修改，在commit后尚未进行pushsa时发现有些内容需要变化，如果此时没有进行commit，可以执行git commit --amend -am &quot;注释&quot;,如果已经执行了commit，则可以执行git rebase -i HEAD~2。 示例1git rebase -i HEAD~3 注意这里会进入两次编辑页面，一次是多个提交的处理方式，按提示进行修改即可，一般保留第一行的命令pick，后面的行命令修改为s，然后wq保存。 注意合并多个分支时如果包含已经发布过的分支，就要调整顺序，将已经发布的最后一个分支放到第一行，否则再次发布时会提示需要先执行git pull，这是因为按照上面的逻辑只有第一行的是提交操作，后面的不会产生新的提交，所以版本号就会落后于远端分支，但是即便调整顺序，也会提示版本偏离，还是要先执行git pull，待手工合并冲突后再次提交一个新的commit，所以，最好的方法就是不要包含已经发布过的分支，只针对未发布的分支进行合并。编辑后的： 第二个页面是要求你编辑本次合并的log说明，此时每次的log都会显示在这个页面，去掉不需要的，重新编辑一下保存即可。编辑后的： 查看日志：git log –oneline 21.git revert–如何撤销指定的提交呢，就是把这次提交回滚到其前一次提交的状态，但是又不影响其之后的提交？ git revert 是回滚某个commit ，不是回滚“到”某个 git revert是用一次新的commit来回滚之前的commit，git reset是直接删除指定的commit。 git reset 撤销到某次提交, git revert 撤销某次提交，撤销并不意味着删除本次提交，其log里仍然会有这次提交，只不过revert后会产生一个新的节点用于提交，而reset是会删除之前的log。 需要回滚到上一个版本时，可以通过git reset HEAD~1实现，也可以通过执行git revert HEAD实现。区别就是reset后再次发布需要git push -f，而revert不需要-f参数，因为revert时会在顶端产生一个新的节点，其版本号一定比远端新的。 还有一点需要注意，例如dev是从 master checkout出来的分支，然后针对dev执行reset时，如果reset的版本master里也包含，此时再将dev merge 回 master时，则master里会保留本应该被reset的内容，而执行revert则不会出现这个问题，因为revert是用一次逆向的commit“中和”之前的提交。 123456789# 撤销并commit一次新的提交git revert HEAD #撤销前一次 commitgit revert HEAD^ #撤销前前一次 commitgit revert HEAD~3 #撤销倒数第四次提交git revert commit号 #撤销指定的版本，撤销也会作为一次提交进行保存。# 如果只撤销，即只改变本地目录和索引，但不执行commit，可以加上-n参数，然后手工执行commit操作git revert -n HEAD~3git revert -n &lt;commit1&gt;..&lt;commit2&gt; # 撤销多个版本，commit1 &gt; x &gt;= commit2，此时要加上-n参数，否则每个撤销都会创建一个新的commit号 22.如何打tag123456789git tag -a &quot;prod_x.x.x&quot; -m &quot;message&quot; #打标签, -a是标签名 -m注释git push origin &quot;prod_x.x.x&quot; #将这个新标签推送到远程仓库git tag #查看标签信息git show prod_x.x.x #显示被打标签的commit的详细信息git checkout -b hotfix_x.x.x prod_x.x.x #从prod_x.x.x标签的版本上开一个新的修复分支git push origin hotfix_x.x.x #将hotfix_x.x.x分支推送到远程仓库git branch --set-upstream-to=origin/hotfix_x.x.x hotfix_x.x.x #关联本地分支到远程分支 23.git pull = git fetch + git merge这种说法对吗？ 先说答案，git pull != git fetch + git merge，但是确实很像。 其实更好的比较是git pull --rebase 与 git fetch + git merge的区别，其相当于git fetch + git rebase 为了说清楚这个问题，我们需要先明白git的三个仓库： 本地仓库：如master，修改代码，提交暂存区，然后commit到的就是本地仓库 本地远程跟踪仓库：如orign/master，这个仓库不能用来直接提交代码，其用来保存上一次从远程仓库拉取到的最新版本，如果不主动执行git fetch，git pull，git push等，是不会更新这个版本的。 远程仓库：git服务器，如github。执行git push时会将本地仓库的版本发布到远程仓库。 git fetch的作用是将远程仓库(如github)的版本与本地远程跟踪仓库(如orign/master)的版本保持一致。之后我们在master分支下执行git merge orign/master就会将远程仓库的代码合并到本地仓库，所以合并后会产出一个新的版本，我们可以发布这个版本到远程仓库。 git pull的作用很像git fetch + git merge，区别就是，git pull时如果没有冲突，就不会产生新的版本。 24.如何确定开发–&gt;测试–&gt;发布流程？开发A模型：基于master的主分支开发模型 使用git rebase orign将远程分支内容合并到当前master主分支，保证本地master始终是一条线 模型结构简单，始终记住使用git fetch + git rebase或者git pull --rebase更新主分支版本 开发B模型：基于dev的子分支开发模型 增加了一个dev子分支，合并回master主分支时可以通过git rebase -i的方式合并多个commit为一个commit，减少版本号数量 每次开发时要创建新的分支，开发完成后删除该分支，虽略显反锁，但也更加灵活，比如上一次的开发任务还没有完成，有一个紧急的任务需要马上处理，此时只需要从master分支checkout出一个子分支进行开发即可。 使用git pull --rebase更新远程版本，使用git rebase dev合并子分支，总的目标依旧是保证本地master始终是一条线 测试模型：基于A\\B模型的master的主分支 开发完成后，从master分支中checkout出一个release分支用于测试 测试过程中如果有bug，则由开发人员通过开发模型进行修复，修复后merge到release中 测试通过后，将release分支内容merge到prod分支中（prod表示生产分支，第一次时从release中checkout创建） release分支仅仅为了本次发布内容而创建的测试分支，所以发布后可以删除release分支 发布模型 release分支测试通过够会merge到prod生产分支，此时代码可以发布上线，上线前需要为prod打tag 只有打了tag的代码才能部署上线，如果线上代码发现bug，则从对应的tag中checkout一个hotfix分支，用于bug修复 bug修复后从hotfix分支checkout出hotfix_release分支进行测试，测试过程按照测试模型进行 测试通过后按照发布模型进行 发布后需要将hotfix_release分支merge到master开发主分支，之后可以删除本次hotfix分支和hotfix_release分支 说明 本地和远程始终存在的分支是master开发主分支和prod发布主分支 每次上线前一定要打tag，tag对应的就是当前生产环境 测试分支和修复分支根据需要进行创建，用后可以删除。","summary":"摘要 一起来了解一些git常用命令吧 推荐一个学习git命令的网站：https://learngitbranching.js.org/?locale=zh_CN","date_published":"2021-10-29T13:30:05.000Z","tags":["技术","git"]},{"id":"https://blog.hanqunfeng.com/2021/09/08/springboot-query/","url":"https://blog.hanqunfeng.com/2021/09/08/springboot-query/","title":"Spring Boot的@Query注解","content_html":"<h2 id=\"摘要\"><a href=\"#摘要\" class=\"headerlink\" title=\"摘要\"></a>摘要</h2><ul>\n<li>聊聊Spring Boot的@Query注解</li>\n<li>参考：<a href=\"/2021/09/06/spring-boot-JpaRepository/\" title=\"Spring Boot自定义JpaRepository基类\">Spring Boot自定义JpaRepository基类</a></li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"Query说明\"><a href=\"#Query说明\" class=\"headerlink\" title=\"@Query说明\"></a>@Query说明</h2><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class=\"line\"><span class=\"meta\">@Target(&#123;ElementType.METHOD, ElementType.ANNOTATION_TYPE&#125;)</span></span><br><span class=\"line\"><span class=\"meta\">@QueryAnnotation</span></span><br><span class=\"line\"><span class=\"meta\">@Documented</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"meta\">@interface</span> Query &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 指定JPA Query语句,当nativeQuery=true时是原生的sql语句</span></span><br><span class=\"line\">    <span class=\"function\">String <span class=\"title\">value</span><span class=\"params\">()</span> <span class=\"keyword\">default</span> &quot;&quot;</span>;</span><br><span class=\"line\">    <span class=\"comment\">//指定count的JPA Query语句,不指定则自动生成,当nativeQuery=true时是原生的sql语句,countQuery主要用来配合 value实现分页功能</span></span><br><span class=\"line\">    <span class=\"function\">String <span class=\"title\">countQuery</span><span class=\"params\">()</span> <span class=\"keyword\">default</span> &quot;&quot;</span>;</span><br><span class=\"line\">    <span class=\"comment\">//依据哪个字段来count,如果未配置countQuery（）或countProjection（），将从原始查询派生count查询</span></span><br><span class=\"line\">    <span class=\"function\">String <span class=\"title\">countProjection</span><span class=\"params\">()</span> <span class=\"keyword\">default</span> &quot;&quot;</span>;</span><br><span class=\"line\">    <span class=\"comment\">// 默认是false，表示value 里面是不是原生的Sql 语句</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">nativeQuery</span><span class=\"params\">()</span> <span class=\"keyword\">default</span> <span class=\"keyword\">false</span></span>;</span><br><span class=\"line\">    <span class=\"comment\">//指定一个query 的名字，必须是唯一的。 如果不指定，默认的生成规则是：&#123;$domainClass&#125;.$&#123;queryMethodName&#125;。使用命名查询时会用到。</span></span><br><span class=\"line\">    <span class=\"function\">String <span class=\"title\">name</span><span class=\"params\">()</span> <span class=\"keyword\">default</span> &quot;&quot;</span>;</span><br><span class=\"line\">    <span class=\"comment\">//指定一个count 的query 名字，必须是唯一的。如果不指定，默认的生成规则是：&#123;$domainClass&#125;.$&#123;queryMethodName&#125;.count</span></span><br><span class=\"line\">    <span class=\"function\">String <span class=\"title\">countName</span><span class=\"params\">()</span> <span class=\"keyword\">default</span> &quot;&quot;</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"基本用法示例\"><a href=\"#基本用法示例\" class=\"headerlink\" title=\"基本用法示例\"></a>基本用法示例</h2><ul>\n<li><p>@Entity</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Data</span></span><br><span class=\"line\"><span class=\"meta\">@Entity</span></span><br><span class=\"line\"><span class=\"meta\">@Table(name = &quot;tbl_country&quot;)</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Country</span> <span class=\"keyword\">implements</span> <span class=\"title\">Serializable</span></span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> serialVersionUID = <span class=\"number\">1L</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">\t * 主键自增</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"meta\">@Id</span></span><br><span class=\"line\">    <span class=\"meta\">@GeneratedValue(strategy = GenerationType.IDENTITY)</span></span><br><span class=\"line\">\t<span class=\"meta\">@Column(name=&quot;id&quot;)</span></span><br><span class=\"line\">\t<span class=\"keyword\">private</span> Long id;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">\t * 中文简称</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"meta\">@Column(name=&quot;name_zh&quot;)</span></span><br><span class=\"line\">\t<span class=\"keyword\">private</span> String nameZh;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">\t * 英文简称</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"meta\">@Column(name=&quot;name_en&quot;)</span></span><br><span class=\"line\">\t<span class=\"keyword\">private</span> String nameEn;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">\t * 英文全称</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"meta\">@Column(name=&quot;name_en_full&quot;)</span></span><br><span class=\"line\">\t<span class=\"keyword\">private</span> String nameEnFull;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">\t * 两字母代码</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"meta\">@Column(name=&quot;code_two&quot;)</span></span><br><span class=\"line\">\t<span class=\"keyword\">private</span> String codeTwo;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">\t * 三字母代码</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"meta\">@Column(name=&quot;code_three&quot;)</span></span><br><span class=\"line\">\t<span class=\"keyword\">private</span> String codeThree;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">\t * 数字代码</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"meta\">@Column(name=&quot;num_code&quot;)</span></span><br><span class=\"line\">\t<span class=\"keyword\">private</span> String numCode;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">\t * 备注</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"meta\">@Column(name=&quot;remark&quot;)</span></span><br><span class=\"line\">\t<span class=\"keyword\">private</span> String remark;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">Country</span><span class=\"params\">(Long id, String nameZh, String nameEn)</span> </span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">this</span>.id = id;</span><br><span class=\"line\">\t\t<span class=\"keyword\">this</span>.nameZh = nameZh;</span><br><span class=\"line\">\t\t<span class=\"keyword\">this</span>.nameEn = nameEn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">Country</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure></li>\n<li><p>Dto</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Data</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">CountryDto</span> <span class=\"keyword\">implements</span> <span class=\"title\">Serializable</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> serialVersionUID = <span class=\"number\">1L</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">     * 主键自增</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> Long id;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">     * 中文简称</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> String nameZh;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">     * 英文简称</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> String nameEn;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">     * 英文全称</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> String nameEnFull;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">     * 两字母代码</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> String codeTwo;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">     * 三字母代码</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> String codeThree;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">     * 数字代码</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> String numCode;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">     * 备注</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> String remark;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">CountryDto</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">CountryDto</span><span class=\"params\">(Long id, String nameZh, String nameEn)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.id = id;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.nameZh = nameZh;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.nameEn = nameEn;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n<li><p>Jpa</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">CountryJpaRepository</span> <span class=\"keyword\">extends</span> <span class=\"title\">BaseJpaRepository</span>&lt;<span class=\"title\">Country</span>, <span class=\"title\">Long</span>&gt; </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//sql查询，只有SELECT * 时才可以直接返回@Entity对象，但要有无参构造方法，page要指定countQuery</span></span><br><span class=\"line\">    <span class=\"meta\">@Query(value = &quot;SELECT * FROM tbl_country WHERE id &gt; ?1&quot;, countQuery = &quot;SELECT count(*) FROM tbl_country WHERE id &gt; ?1&quot;, nativeQuery = true)</span></span><br><span class=\"line\">    <span class=\"function\">Page&lt;Country&gt; <span class=\"title\">findByIdAfter</span><span class=\"params\">(Long id, Pageable pageable)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//sql查询，只有SELECT * 时才可以直接返回@Entity对象</span></span><br><span class=\"line\">    <span class=\"meta\">@Query(value = &quot;SELECT * FROM tbl_country  WHERE name_zh = ?1&quot;,nativeQuery = true)</span></span><br><span class=\"line\">    <span class=\"function\">Country <span class=\"title\">findCountrySqlByName</span><span class=\"params\">(String name)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//hql查询部分属性时，返回@Entity对象，要在@Entity中创建对应的构造方法</span></span><br><span class=\"line\">    <span class=\"meta\">@Query(value = &quot;SELECT new Country(id,nameZh,nameEn) FROM Country WHERE nameZh = ?1&quot;)</span></span><br><span class=\"line\">    <span class=\"function\">Country <span class=\"title\">findCountryHqlByName</span><span class=\"params\">(String name)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//hql查询部分属性时，返回非@Entity对象，要创建对应的构造方法，且必须使用全路径</span></span><br><span class=\"line\">    <span class=\"meta\">@Query(value = &quot;SELECT new com.example.demo.CountryDto(id,nameZh,nameEn) FROM Country WHERE nameZh = ?1&quot;)</span></span><br><span class=\"line\">    <span class=\"function\">CountryDto <span class=\"title\">findCountryDtoNewHqlByName</span><span class=\"params\">(String name)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"说明\"><a href=\"#说明\" class=\"headerlink\" title=\"说明\"></a>说明</h3><ul>\n<li>返回@Entity对象，查询全部属性时，sql和hql都支持直接转换</li>\n<li>返回@Entity对象，查询部分属性时，sql不支持直接转换，hql时，实体要有对应的构造方法</li>\n<li>hql也可以返回Dto对象，查询部分属性时，同样需要Dto有对应的构造方法，注意Dto必须使用全路径</li>\n</ul>\n<h3 id=\"sql查询部分属性直接转换成对象的方法\"><a href=\"#sql查询部分属性直接转换成对象的方法\" class=\"headerlink\" title=\"sql查询部分属性直接转换成对象的方法\"></a>sql查询部分属性直接转换成对象的方法</h3><ul>\n<li>方法1，前一篇文章<a href=\"/2021/09/06/spring-boot-JpaRepository/\" title=\"Spring Boot自定义JpaRepository基类\">Spring Boot自定义JpaRepository基类</a>中通过自定义JpaRepository基类，转换@Entity对象和Dto对象都支持</li>\n<li>方法2，注入自定义的结果转换器，只能转换为Dto对象，下面说明如何实现</li>\n</ul>\n<h2 id=\"注入自定义的结果转换器\"><a href=\"#注入自定义的结果转换器\" class=\"headerlink\" title=\"注入自定义的结果转换器\"></a>注入自定义的结果转换器</h2><ul>\n<li>无论是sql还是hql，查询部分属性时，jpa输出的结果都会被转化为Map对象，我们只需要注入一个能将Map转换为指定对象的转换器就可以了</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * &lt;h1&gt;注入自定义查询结果转换器&lt;/h1&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"meta\">@Slf4j</span></span><br><span class=\"line\"><span class=\"meta\">@Configuration</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">JpaDtoConfig</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> ApplicationContext applicationContext;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//这里用到了上文“Spring Boot自定义JpaRepository基类”中介绍过的JpaUtil，通过json作为中间媒介</span></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> JpaUtil jpaUtil;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 初始化注入<span class=\"doctag\">@JpaDto</span>对应的Converter</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@PostConstruct</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">init</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        Map&lt;String, Object&gt; map = applicationContext.getBeansWithAnnotation(JpaDto.class);</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (Object o : map.values()) &#123;</span><br><span class=\"line\">            Class c = o.getClass();</span><br><span class=\"line\">            log.info(<span class=\"string\">&quot;Jpa添加Converter,class=&#123;&#125;&quot;</span>, c.getName());</span><br><span class=\"line\">            DefaultConversionService defaultConversionService = ((DefaultConversionService) DefaultConversionService.getSharedInstance());</span><br><span class=\"line\">            <span class=\"comment\">//添加Map对象的转换器，将Map对象转换为指定的对象类型</span></span><br><span class=\"line\">            defaultConversionService.addConverter(Map.class, c, m -&gt; &#123;</span><br><span class=\"line\">                <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">return</span> jpaUtil.mapToObject(m, c, <span class=\"keyword\">false</span>);</span><br><span class=\"line\">                &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> FatalBeanException(<span class=\"string\">&quot;Jpa结果转换出错,class=&quot;</span> + c.getName(), e);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li><p>定义标记注解</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * &lt;h1&gt;注解标记，声明在Dto对象上，表示该对象作为结果对象时，可以被自定义结果转换器转化&lt;/h1&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"meta\">@Documented</span></span><br><span class=\"line\"><span class=\"meta\">@Component</span></span><br><span class=\"line\"><span class=\"meta\">@Target(value = &#123;ElementType.TYPE&#125;)</span></span><br><span class=\"line\"><span class=\"meta\">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"meta\">@interface</span> JpaDto &#123;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n<li><p>此时Dto对象上要加上@JpaDto注解</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@JpaDto</span></span><br><span class=\"line\"><span class=\"meta\">@Data</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">CountryDto</span> <span class=\"keyword\">implements</span> <span class=\"title\">Serializable</span> </span>&#123;</span><br><span class=\"line\">    …………………………</span><br><span class=\"line\">    …………………………</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n<li><p>JpaRepository示例</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">CountryJpaRepository</span> <span class=\"keyword\">extends</span> <span class=\"title\">BaseJpaRepository</span>&lt;<span class=\"title\">Country</span>, <span class=\"title\">Long</span>&gt; </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//hql查询部分属性时，一定有使用as别名，这里返回值不能是@Entity，并且其要标注@JpaDto注解</span></span><br><span class=\"line\">    <span class=\"meta\">@Query(value = &quot;SELECT id as id,nameZh as nameZh,nameEn as nameEn FROM Country WHERE nameZh = ?1&quot;)</span></span><br><span class=\"line\">    <span class=\"function\">CountryDto <span class=\"title\">findCountryDtoHqlByName</span><span class=\"params\">(String name)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//sql查询部分属性时，一定有使用as别名，这里返回值不能是@Entity，并且其要标注@JpaDto注解</span></span><br><span class=\"line\">    <span class=\"meta\">@Query(value = &quot;SELECT id,name_zh as nameZh,name_en as nameEn FROM tbl_country WHERE name_zh = ?1&quot;,nativeQuery = true)</span></span><br><span class=\"line\">    <span class=\"function\">CountryDto <span class=\"title\">findCountryDtoSqlByName</span><span class=\"params\">(String name)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//sql查询部分属性时，一定有使用as别名，这里返回值不能是@Entity，并且其要标注@JpaDto注解，page要指定countQuery</span></span><br><span class=\"line\">    <span class=\"meta\">@Query(value = &quot;SELECT id,name_zh as nameZh,name_en as nameEn FROM tbl_country WHERE id &gt; ?1&quot;, countQuery = &quot;SELECT count(*) FROM tbl_country WHERE id &gt; ?1&quot;, nativeQuery = true)</span></span><br><span class=\"line\">    <span class=\"function\">Page&lt;CountryDto&gt; <span class=\"title\">findByIdAfterDto</span><span class=\"params\">(Long id, Pageable pageable)</span></span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"说明-1\"><a href=\"#说明-1\" class=\"headerlink\" title=\"说明\"></a>说明</h3><ul>\n<li>返回注解了@JpaDto注解的对象时，hql和sql都支持部分字段查询，但要注意字段要加as别名，别名与Dto对象属性名称要一致；</li>\n<li>部分字段查询时，Dto对象中不必创建对应的构造方法；</li>\n<li>查询部分属性时，不支持返回@Entity对象，即使在@Entity类上增加@JpaDto注解也不好使，说明其返回的不是Map对象</li>\n<li>hql返回部分属性时，如果直接返回@Entity对象，会抛异常<code>Failed to convert from type [java.lang.Object[]] to type [com.example.demo.Country]</code>，提示类型转换失败，因其返回类型是java.lang.Object[]，所以也说明为什么要用构造方法的形式接收返回数据，就是要与数组位置一一对应上，所以hql返回部分属性，就要使用构造方法的形式；  <figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//错误</span></span><br><span class=\"line\"><span class=\"meta\">@Query(value = &quot;SELECT id as id,nameZh as nameZh,nameEn as nameEn FROM Country WHERE nameZh = ?1&quot;)</span></span><br><span class=\"line\"><span class=\"function\">Country <span class=\"title\">findCountryHqlByNameError</span><span class=\"params\">(String name)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//正确</span></span><br><span class=\"line\"><span class=\"meta\">@Query(value = &quot;SELECT new Country(id,nameZh,nameEn) FROM Country WHERE nameZh = ?1&quot;)</span></span><br><span class=\"line\"><span class=\"function\">Country <span class=\"title\">findCountryHqlByNameOk</span><span class=\"params\">(String name)</span></span>;</span><br></pre></td></tr></table></figure></li>\n<li>sql返回部分属性时，如果直接返回@Entity对象，会抛异常<code>No such column: &#39;code_three&#39;.</code>，提示缺少字段。说明该形式在封装@Entity对象时需要遍历其所有@Column字段并为其赋值，此时可以返回Dto或者Map，也可以使用自定义JpaRepository的方式，还有一种方法就是使用命名查询，就是@NamedNativeQuery和@SqlResultSetMapping；  <figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//错误</span></span><br><span class=\"line\"><span class=\"meta\">@Query(value = &quot;SELECT id,name_zh as nameZh,name_en as nameEn FROM tbl_country WHERE name_zh = ?1&quot;,nativeQuery = true)</span></span><br><span class=\"line\"><span class=\"function\">Country <span class=\"title\">findCountrySqlByNameError</span><span class=\"params\">(String name)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//正确，之后可以将map转换为@Entity对象，如通过json的方式</span></span><br><span class=\"line\"><span class=\"meta\">@Query(value = &quot;SELECT id,name_zh as nameZh,name_en as nameEn FROM tbl_country WHERE name_zh = ?1&quot;,nativeQuery = true)</span></span><br><span class=\"line\"><span class=\"function\">Map <span class=\"title\">findCountrySqlByNameOk</span><span class=\"params\">(String name)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//正确</span></span><br><span class=\"line\"><span class=\"meta\">@Query(value = &quot;SELECT id,name_zh as nameZh,name_en as nameEn FROM tbl_country WHERE name_zh = ?1&quot;,nativeQuery = true)</span></span><br><span class=\"line\">Object[] findCountrySqlByNameOk2(String name);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//正确，CountryDto要加上@JpaDto注解</span></span><br><span class=\"line\"><span class=\"meta\">@Query(value = &quot;SELECT id,name_zh as nameZh,name_en as nameEn FROM tbl_country WHERE name_zh = ?1&quot;,nativeQuery = true)</span></span><br><span class=\"line\"><span class=\"function\">CountryDto <span class=\"title\">findCountrySqlByNameOk3</span><span class=\"params\">(String name)</span></span>;</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h2 id=\"命名查询\"><a href=\"#命名查询\" class=\"headerlink\" title=\"命名查询\"></a>命名查询</h2><ul>\n<li><p>@NamedQuery，用于执行hql</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@NamedQueries(&#123;</span></span><br><span class=\"line\"><span class=\"meta\">        @NamedQuery(</span></span><br><span class=\"line\"><span class=\"meta\">                //指定名称，必须全局唯一</span></span><br><span class=\"line\"><span class=\"meta\">                name = &quot;HQL_FIND_ALL_COUNTRY&quot;,</span></span><br><span class=\"line\"><span class=\"meta\">                //要指定的hql</span></span><br><span class=\"line\"><span class=\"meta\">                query = &quot;from Country&quot;</span></span><br><span class=\"line\"><span class=\"meta\">        )</span></span><br><span class=\"line\"><span class=\"meta\">&#125;)</span></span><br><span class=\"line\"><span class=\"meta\">@Data</span></span><br><span class=\"line\"><span class=\"meta\">@Entity</span></span><br><span class=\"line\"><span class=\"meta\">@Table(name = &quot;tbl_country&quot;)</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Country</span> <span class=\"keyword\">implements</span> <span class=\"title\">Serializable</span> </span>&#123;</span><br><span class=\"line\">    …………</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n<li><p>@NamedNativeQuery和@SqlResultSetMapping，用于执行sql，可以指定结果类型，不指定结果类型时返回java.lang.Object[]</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@NamedNativeQueries(&#123;</span></span><br><span class=\"line\"><span class=\"meta\">        @NamedNativeQuery(</span></span><br><span class=\"line\"><span class=\"meta\">                //指定名称，必须全局唯一</span></span><br><span class=\"line\"><span class=\"meta\">                name = &quot;SQL_FIND_ALL_COUNTRY&quot;,</span></span><br><span class=\"line\"><span class=\"meta\">                //要指定的sql</span></span><br><span class=\"line\"><span class=\"meta\">                query = &quot;select * from tbl_country&quot;,</span></span><br><span class=\"line\"><span class=\"meta\">                //指定返回类型</span></span><br><span class=\"line\"><span class=\"meta\">                resultClass = Country.class</span></span><br><span class=\"line\"><span class=\"meta\">        ),</span></span><br><span class=\"line\"><span class=\"meta\">        @NamedNativeQuery(</span></span><br><span class=\"line\"><span class=\"meta\">                //指定名称，必须全局唯一</span></span><br><span class=\"line\"><span class=\"meta\">                name = &quot;SQL_FIND_ALL_COUNTRY2&quot;,</span></span><br><span class=\"line\"><span class=\"meta\">                //要指定的sql</span></span><br><span class=\"line\"><span class=\"meta\">                query = &quot;select * from tbl_country&quot;,</span></span><br><span class=\"line\"><span class=\"meta\">                //通过@SqlResultSetMapping封装返回类型，这里是@SqlResultSetMapping的名称</span></span><br><span class=\"line\"><span class=\"meta\">                resultSetMapping = &quot;SQL_RESULT_COUNTRY_ALL&quot;</span></span><br><span class=\"line\"><span class=\"meta\">        ),</span></span><br><span class=\"line\"><span class=\"meta\">        @NamedNativeQuery(</span></span><br><span class=\"line\"><span class=\"meta\">                //指定名称，必须全局唯一</span></span><br><span class=\"line\"><span class=\"meta\">                name = &quot;SQL_FIND_SOME_FIELD_COUNTRY&quot;,</span></span><br><span class=\"line\"><span class=\"meta\">                //要指定的sql</span></span><br><span class=\"line\"><span class=\"meta\">                query = &quot;select id,name_zh as nameZh,name_en as nameEn from tbl_country&quot;,</span></span><br><span class=\"line\"><span class=\"meta\">                //通过@SqlResultSetMapping封装返回类型，这里是@SqlResultSetMapping的名称</span></span><br><span class=\"line\"><span class=\"meta\">                resultSetMapping = &quot;SQL_RESULT_COUNTRY_SOME_FIELD&quot;</span></span><br><span class=\"line\"><span class=\"meta\">        )</span></span><br><span class=\"line\"><span class=\"meta\">&#125;)</span></span><br><span class=\"line\"><span class=\"meta\">@SqlResultSetMappings(&#123;</span></span><br><span class=\"line\"><span class=\"meta\">        @SqlResultSetMapping(</span></span><br><span class=\"line\"><span class=\"meta\">                //指定名称，必须全局唯一</span></span><br><span class=\"line\"><span class=\"meta\">                name = &quot;SQL_RESULT_COUNTRY_ALL&quot;,</span></span><br><span class=\"line\"><span class=\"meta\">                //指定返回类的@Entity类型</span></span><br><span class=\"line\"><span class=\"meta\">                entities = &#123;</span></span><br><span class=\"line\"><span class=\"meta\">                        @EntityResult(</span></span><br><span class=\"line\"><span class=\"meta\">                                //指定返回类的@Entity类型</span></span><br><span class=\"line\"><span class=\"meta\">                                entityClass = Country.class</span></span><br><span class=\"line\"><span class=\"meta\">                        )</span></span><br><span class=\"line\"><span class=\"meta\">                &#125;</span></span><br><span class=\"line\"><span class=\"meta\"></span></span><br><span class=\"line\"><span class=\"meta\">        ),</span></span><br><span class=\"line\"><span class=\"meta\">        @SqlResultSetMapping(</span></span><br><span class=\"line\"><span class=\"meta\">                //指定名称，必须全局唯一</span></span><br><span class=\"line\"><span class=\"meta\">                name = &quot;SQL_RESULT_COUNTRY_SOME_FIELD&quot;,</span></span><br><span class=\"line\"><span class=\"meta\">                //查询部分属性时，可以通过构造方法封装结果数据</span></span><br><span class=\"line\"><span class=\"meta\">                classes = &#123;</span></span><br><span class=\"line\"><span class=\"meta\">                        @ConstructorResult(</span></span><br><span class=\"line\"><span class=\"meta\">                                //指定返回类的@Entity类型</span></span><br><span class=\"line\"><span class=\"meta\">                                targetClass = Country.class,</span></span><br><span class=\"line\"><span class=\"meta\">                                //指定调用的构造方法</span></span><br><span class=\"line\"><span class=\"meta\">                                columns = &#123;</span></span><br><span class=\"line\"><span class=\"meta\">                                        @ColumnResult(name = &quot;id&quot;, type = Long.class),</span></span><br><span class=\"line\"><span class=\"meta\">                                        @ColumnResult(name = &quot;nameZh&quot;),</span></span><br><span class=\"line\"><span class=\"meta\">                                        @ColumnResult(name = &quot;nameEn&quot;)</span></span><br><span class=\"line\"><span class=\"meta\">                                &#125;</span></span><br><span class=\"line\"><span class=\"meta\">                        )</span></span><br><span class=\"line\"><span class=\"meta\">                &#125;</span></span><br><span class=\"line\"><span class=\"meta\">        )</span></span><br><span class=\"line\"><span class=\"meta\">&#125;)</span></span><br><span class=\"line\"><span class=\"meta\">@Data</span></span><br><span class=\"line\"><span class=\"meta\">@Entity</span></span><br><span class=\"line\"><span class=\"meta\">@Table(name = &quot;tbl_country&quot;)</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Country</span> <span class=\"keyword\">implements</span> <span class=\"title\">Serializable</span> </span>&#123;</span><br><span class=\"line\">    …………</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">Country</span><span class=\"params\">(Long id, String nameZh, String nameEn)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.id = id;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.nameZh = nameZh;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.nameEn = nameEn;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">Country</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"说明-2\"><a href=\"#说明-2\" class=\"headerlink\" title=\"说明\"></a>说明</h3><ul>\n<li>命名查询的注解只能声明在对应的@Entity类型上</li>\n<li>@NamedNativeQuery名称必须全局唯一，可以通过<code>entityManager.createNamedQuery(String queryName)</code>进行调用</li>\n<li>sql查询部分字段时@Entity一定要有对应的构造方法</li>\n<li>返回类型必须是@Entity对象</li>\n<li>@SqlResultSetMapping可以单独使用，其功能就是将sql的查询结果转换为指定的类型,<code>entityManager.createNativeQuery(String sqlString, String resultSetMapping)</code></li>\n</ul>\n<h3 id=\"使用方法\"><a href=\"#使用方法\" class=\"headerlink\" title=\"使用方法\"></a>使用方法</h3><ul>\n<li><p>通过entityManager的方法进行调用</p>\n  <figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">List list = entityManager.createNamedQuery(<span class=\"string\">&quot;SQL_FIND_ALL_COUNTRY&quot;</span>).getResultList();</span><br><span class=\"line\"></span><br><span class=\"line\">List list = entityManager.createNativeQuery(<span class=\"string\">&quot;select id,name_zh as nameZh,name_en as nameEn from tbl_country&quot;</span>,<span class=\"string\">&quot;SQL_RESULT_COUNTRY_SOME_FIELD&quot;</span>).getResultList();</span><br></pre></td></tr></table></figure></li>\n<li><p>通过在JpaRepository声明指定的@Query方法，并指定其name属性为对应的@NamedNativeQuery的name值</p>\n  <figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">CountryJpaRepository</span> <span class=\"keyword\">extends</span> <span class=\"title\">BaseJpaRepository</span>&lt;<span class=\"title\">Country</span>, <span class=\"title\">Long</span>&gt; </span>&#123;</span><br><span class=\"line\">    <span class=\"meta\">@Query(name = &quot;HQL_FIND_ALL_COUNTRY&quot;)</span></span><br><span class=\"line\">    <span class=\"function\">List&lt;Country&gt; <span class=\"title\">nameHqlFindAll</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Query(name = &quot;SQL_FIND_ALL_COUNTRY&quot;)</span></span><br><span class=\"line\">    <span class=\"function\">List&lt;Country&gt; <span class=\"title\">nameSqlFindAll</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Query(name = &quot;SQL_FIND_ALL_COUNTRY2&quot;)</span></span><br><span class=\"line\">    <span class=\"function\">List&lt;Country&gt; <span class=\"title\">nameSqlFindAll2</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Query(name = &quot;SQL_FIND_SOME_FIELD_COUNTRY&quot;)</span></span><br><span class=\"line\">    <span class=\"function\">List&lt;Country&gt; <span class=\"title\">nameSqlFindSomeField</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h2 id=\"关于在-Query注解中使用Mysql的原生sql时的一些小技巧\"><a href=\"#关于在-Query注解中使用Mysql的原生sql时的一些小技巧\" class=\"headerlink\" title=\"关于在@Query注解中使用Mysql的原生sql时的一些小技巧\"></a>关于在@Query注解中使用Mysql的原生sql时的一些小技巧</h2><ul>\n<li><p>动态sql通过mysql的if语句实现</p>\n  <figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Query(value = &quot;SELECT * FROM tbl_country WHERE if(?1!=&#x27;&#x27;, name_zh = ?1, 1=1)&quot;,nativeQuery = true)</span></span><br><span class=\"line\"><span class=\"function\">Country <span class=\"title\">findCountrySqlByName</span><span class=\"params\">(String name)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Query(value = &quot;SELECT * FROM tbl_country WHERE if(:name!=&#x27;&#x27;, name_zh = :name, 1=1)&quot;,nativeQuery = true)</span></span><br><span class=\"line\"><span class=\"function\">Country <span class=\"title\">findCountrySqlByName</span><span class=\"params\">(<span class=\"meta\">@Param(&quot;name&quot;)</span> String name)</span></span>;</span><br></pre></td></tr></table></figure></li>\n<li><p>拼接like使用mysql的CONCAT语句</p>\n  <figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Query(value = &quot;SELECT * FROM tbl_country WHERE name like CONCAT(&#x27;%&#x27;,?1,&#x27;%&#x27;))</span><span class=\"string\">&quot;,nativeQuery = true)</span></span><br><span class=\"line\"><span class=\"string\">Country findCountrySqlByName(String name);</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">@Query(value = &quot;</span>SELECT * <span class=\"function\">FROM tbl_country WHERE name like <span class=\"title\">CONCAT</span><span class=\"params\">(<span class=\"string\">&#x27;%&#x27;</span>,:name,<span class=\"string\">&#x27;%&#x27;</span>)</span>&quot;,nativeQuery </span>= <span class=\"keyword\">true</span>)</span><br><span class=\"line\"><span class=\"function\">Country <span class=\"title\">findCountrySqlByName</span><span class=\"params\">(<span class=\"meta\">@Param(&quot;name&quot;)</span> String name)</span></span>;</span><br></pre></td></tr></table></figure></li>\n<li><p>日期比较时可以直接使用<code>&gt;</code>和<code>&lt;</code>等比较符号，参数为Date、LocalDate和LocalDateTime</p>\n  <figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Query(value = &quot;SELECT count(*) from tbl_country r where r.update_time &gt; :lastTime&quot;, nativeQuery = true)</span></span><br><span class=\"line\"><span class=\"function\">Long <span class=\"title\">countCountryByDate</span><span class=\"params\">(<span class=\"meta\">@Param(&quot;lastTime&quot;)</span> LocalDateTime lastTime)</span></span>;</span><br></pre></td></tr></table></figure></li>\n</ul>\n","content_text":"摘要 聊聊Spring Boot的@Query注解 参考：Spring Boot自定义JpaRepository基类 @Query说明123456789101112131415161718@Retention(RetentionPolicy.RUNTIME)@Target(&#123;ElementType.METHOD, ElementType.ANNOTATION_TYPE&#125;)@QueryAnnotation@Documentedpublic @interface Query &#123; // 指定JPA Query语句,当nativeQuery=true时是原生的sql语句 String value() default &quot;&quot;; //指定count的JPA Query语句,不指定则自动生成,当nativeQuery=true时是原生的sql语句,countQuery主要用来配合 value实现分页功能 String countQuery() default &quot;&quot;; //依据哪个字段来count,如果未配置countQuery（）或countProjection（），将从原始查询派生count查询 String countProjection() default &quot;&quot;; // 默认是false，表示value 里面是不是原生的Sql 语句 boolean nativeQuery() default false; //指定一个query 的名字，必须是唯一的。 如果不指定，默认的生成规则是：&#123;$domainClass&#125;.$&#123;queryMethodName&#125;。使用命名查询时会用到。 String name() default &quot;&quot;; //指定一个count 的query 名字，必须是唯一的。如果不指定，默认的生成规则是：&#123;$domainClass&#125;.$&#123;queryMethodName&#125;.count String countName() default &quot;&quot;;&#125; 基本用法示例 @Entity 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566@Data@Entity@Table(name = &quot;tbl_country&quot;)public class Country implements Serializable&#123; private static final long serialVersionUID = 1L; /* * 主键自增 */ @Id @GeneratedValue(strategy = GenerationType.IDENTITY) @Column(name=&quot;id&quot;) private Long id; /* * 中文简称 */ @Column(name=&quot;name_zh&quot;) private String nameZh; /* * 英文简称 */ @Column(name=&quot;name_en&quot;) private String nameEn; /* * 英文全称 */ @Column(name=&quot;name_en_full&quot;) private String nameEnFull; /* * 两字母代码 */ @Column(name=&quot;code_two&quot;) private String codeTwo; /* * 三字母代码 */ @Column(name=&quot;code_three&quot;) private String codeThree; /* * 数字代码 */ @Column(name=&quot;num_code&quot;) private String numCode; /* * 备注 */ @Column(name=&quot;remark&quot;) private String remark; public Country(Long id, String nameZh, String nameEn) &#123; this.id = id; this.nameZh = nameZh; this.nameEn = nameEn; &#125; public Country() &#123; &#125; Dto 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455@Datapublic class CountryDto implements Serializable &#123; private static final long serialVersionUID = 1L; /* * 主键自增 */ private Long id; /* * 中文简称 */ private String nameZh; /* * 英文简称 */ private String nameEn; /* * 英文全称 */ private String nameEnFull; /* * 两字母代码 */ private String codeTwo; /* * 三字母代码 */ private String codeThree; /* * 数字代码 */ private String numCode; /* * 备注 */ private String remark; public CountryDto() &#123; &#125; public CountryDto(Long id, String nameZh, String nameEn) &#123; this.id = id; this.nameZh = nameZh; this.nameEn = nameEn; &#125;&#125; Jpa 12345678910111213141516171819public interface CountryJpaRepository extends BaseJpaRepository&lt;Country, Long&gt; &#123; //sql查询，只有SELECT * 时才可以直接返回@Entity对象，但要有无参构造方法，page要指定countQuery @Query(value = &quot;SELECT * FROM tbl_country WHERE id &gt; ?1&quot;, countQuery = &quot;SELECT count(*) FROM tbl_country WHERE id &gt; ?1&quot;, nativeQuery = true) Page&lt;Country&gt; findByIdAfter(Long id, Pageable pageable); //sql查询，只有SELECT * 时才可以直接返回@Entity对象 @Query(value = &quot;SELECT * FROM tbl_country WHERE name_zh = ?1&quot;,nativeQuery = true) Country findCountrySqlByName(String name); //hql查询部分属性时，返回@Entity对象，要在@Entity中创建对应的构造方法 @Query(value = &quot;SELECT new Country(id,nameZh,nameEn) FROM Country WHERE nameZh = ?1&quot;) Country findCountryHqlByName(String name); //hql查询部分属性时，返回非@Entity对象，要创建对应的构造方法，且必须使用全路径 @Query(value = &quot;SELECT new com.example.demo.CountryDto(id,nameZh,nameEn) FROM Country WHERE nameZh = ?1&quot;) CountryDto findCountryDtoNewHqlByName(String name);&#125; 说明 返回@Entity对象，查询全部属性时，sql和hql都支持直接转换 返回@Entity对象，查询部分属性时，sql不支持直接转换，hql时，实体要有对应的构造方法 hql也可以返回Dto对象，查询部分属性时，同样需要Dto有对应的构造方法，注意Dto必须使用全路径 sql查询部分属性直接转换成对象的方法 方法1，前一篇文章Spring Boot自定义JpaRepository基类中通过自定义JpaRepository基类，转换@Entity对象和Dto对象都支持 方法2，注入自定义的结果转换器，只能转换为Dto对象，下面说明如何实现 注入自定义的结果转换器 无论是sql还是hql，查询部分属性时，jpa输出的结果都会被转化为Map对象，我们只需要注入一个能将Map转换为指定对象的转换器就可以了 1234567891011121314151617181920212223242526272829303132333435363738/** * &lt;h1&gt;注入自定义查询结果转换器&lt;/h1&gt; */@Slf4j@Configurationpublic class JpaDtoConfig &#123; @Autowired private ApplicationContext applicationContext; //这里用到了上文“Spring Boot自定义JpaRepository基类”中介绍过的JpaUtil，通过json作为中间媒介 @Autowired private JpaUtil jpaUtil; /** * 初始化注入@JpaDto对应的Converter */ @PostConstruct public void init() &#123; Map&lt;String, Object&gt; map = applicationContext.getBeansWithAnnotation(JpaDto.class); for (Object o : map.values()) &#123; Class c = o.getClass(); log.info(&quot;Jpa添加Converter,class=&#123;&#125;&quot;, c.getName()); DefaultConversionService defaultConversionService = ((DefaultConversionService) DefaultConversionService.getSharedInstance()); //添加Map对象的转换器，将Map对象转换为指定的对象类型 defaultConversionService.addConverter(Map.class, c, m -&gt; &#123; try &#123; return jpaUtil.mapToObject(m, c, false); &#125; catch (Exception e) &#123; throw new FatalBeanException(&quot;Jpa结果转换出错,class=&quot; + c.getName(), e); &#125; &#125;); &#125; &#125;&#125; 定义标记注解 123456789/** * &lt;h1&gt;注解标记，声明在Dto对象上，表示该对象作为结果对象时，可以被自定义结果转换器转化&lt;/h1&gt; */@Documented@Component@Target(value = &#123;ElementType.TYPE&#125;)@Retention(RetentionPolicy.RUNTIME)public @interface JpaDto &#123;&#125; 此时Dto对象上要加上@JpaDto注解 123456@JpaDto@Datapublic class CountryDto implements Serializable &#123; ………………………… …………………………&#125; JpaRepository示例 12345678910111213public interface CountryJpaRepository extends BaseJpaRepository&lt;Country, Long&gt; &#123; //hql查询部分属性时，一定有使用as别名，这里返回值不能是@Entity，并且其要标注@JpaDto注解 @Query(value = &quot;SELECT id as id,nameZh as nameZh,nameEn as nameEn FROM Country WHERE nameZh = ?1&quot;) CountryDto findCountryDtoHqlByName(String name); //sql查询部分属性时，一定有使用as别名，这里返回值不能是@Entity，并且其要标注@JpaDto注解 @Query(value = &quot;SELECT id,name_zh as nameZh,name_en as nameEn FROM tbl_country WHERE name_zh = ?1&quot;,nativeQuery = true) CountryDto findCountryDtoSqlByName(String name); //sql查询部分属性时，一定有使用as别名，这里返回值不能是@Entity，并且其要标注@JpaDto注解，page要指定countQuery @Query(value = &quot;SELECT id,name_zh as nameZh,name_en as nameEn FROM tbl_country WHERE id &gt; ?1&quot;, countQuery = &quot;SELECT count(*) FROM tbl_country WHERE id &gt; ?1&quot;, nativeQuery = true) Page&lt;CountryDto&gt; findByIdAfterDto(Long id, Pageable pageable);&#125; 说明 返回注解了@JpaDto注解的对象时，hql和sql都支持部分字段查询，但要注意字段要加as别名，别名与Dto对象属性名称要一致； 部分字段查询时，Dto对象中不必创建对应的构造方法； 查询部分属性时，不支持返回@Entity对象，即使在@Entity类上增加@JpaDto注解也不好使，说明其返回的不是Map对象 hql返回部分属性时，如果直接返回@Entity对象，会抛异常Failed to convert from type [java.lang.Object[]] to type [com.example.demo.Country]，提示类型转换失败，因其返回类型是java.lang.Object[]，所以也说明为什么要用构造方法的形式接收返回数据，就是要与数组位置一一对应上，所以hql返回部分属性，就要使用构造方法的形式； 1234567//错误@Query(value = &quot;SELECT id as id,nameZh as nameZh,nameEn as nameEn FROM Country WHERE nameZh = ?1&quot;)Country findCountryHqlByNameError(String name);//正确@Query(value = &quot;SELECT new Country(id,nameZh,nameEn) FROM Country WHERE nameZh = ?1&quot;)Country findCountryHqlByNameOk(String name); sql返回部分属性时，如果直接返回@Entity对象，会抛异常No such column: &#39;code_three&#39;.，提示缺少字段。说明该形式在封装@Entity对象时需要遍历其所有@Column字段并为其赋值，此时可以返回Dto或者Map，也可以使用自定义JpaRepository的方式，还有一种方法就是使用命名查询，就是@NamedNativeQuery和@SqlResultSetMapping； 123456789101112131415//错误@Query(value = &quot;SELECT id,name_zh as nameZh,name_en as nameEn FROM tbl_country WHERE name_zh = ?1&quot;,nativeQuery = true)Country findCountrySqlByNameError(String name);//正确，之后可以将map转换为@Entity对象，如通过json的方式@Query(value = &quot;SELECT id,name_zh as nameZh,name_en as nameEn FROM tbl_country WHERE name_zh = ?1&quot;,nativeQuery = true)Map findCountrySqlByNameOk(String name);//正确@Query(value = &quot;SELECT id,name_zh as nameZh,name_en as nameEn FROM tbl_country WHERE name_zh = ?1&quot;,nativeQuery = true)Object[] findCountrySqlByNameOk2(String name);//正确，CountryDto要加上@JpaDto注解@Query(value = &quot;SELECT id,name_zh as nameZh,name_en as nameEn FROM tbl_country WHERE name_zh = ?1&quot;,nativeQuery = true)CountryDto findCountrySqlByNameOk3(String name); 命名查询 @NamedQuery，用于执行hql 1234567891011121314@NamedQueries(&#123; @NamedQuery( //指定名称，必须全局唯一 name = &quot;HQL_FIND_ALL_COUNTRY&quot;, //要指定的hql query = &quot;from Country&quot; )&#125;)@Data@Entity@Table(name = &quot;tbl_country&quot;)public class Country implements Serializable &#123; …………&#125; @NamedNativeQuery和@SqlResultSetMapping，用于执行sql，可以指定结果类型，不指定结果类型时返回java.lang.Object[] 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071@NamedNativeQueries(&#123; @NamedNativeQuery( //指定名称，必须全局唯一 name = &quot;SQL_FIND_ALL_COUNTRY&quot;, //要指定的sql query = &quot;select * from tbl_country&quot;, //指定返回类型 resultClass = Country.class ), @NamedNativeQuery( //指定名称，必须全局唯一 name = &quot;SQL_FIND_ALL_COUNTRY2&quot;, //要指定的sql query = &quot;select * from tbl_country&quot;, //通过@SqlResultSetMapping封装返回类型，这里是@SqlResultSetMapping的名称 resultSetMapping = &quot;SQL_RESULT_COUNTRY_ALL&quot; ), @NamedNativeQuery( //指定名称，必须全局唯一 name = &quot;SQL_FIND_SOME_FIELD_COUNTRY&quot;, //要指定的sql query = &quot;select id,name_zh as nameZh,name_en as nameEn from tbl_country&quot;, //通过@SqlResultSetMapping封装返回类型，这里是@SqlResultSetMapping的名称 resultSetMapping = &quot;SQL_RESULT_COUNTRY_SOME_FIELD&quot; )&#125;)@SqlResultSetMappings(&#123; @SqlResultSetMapping( //指定名称，必须全局唯一 name = &quot;SQL_RESULT_COUNTRY_ALL&quot;, //指定返回类的@Entity类型 entities = &#123; @EntityResult( //指定返回类的@Entity类型 entityClass = Country.class ) &#125; ), @SqlResultSetMapping( //指定名称，必须全局唯一 name = &quot;SQL_RESULT_COUNTRY_SOME_FIELD&quot;, //查询部分属性时，可以通过构造方法封装结果数据 classes = &#123; @ConstructorResult( //指定返回类的@Entity类型 targetClass = Country.class, //指定调用的构造方法 columns = &#123; @ColumnResult(name = &quot;id&quot;, type = Long.class), @ColumnResult(name = &quot;nameZh&quot;), @ColumnResult(name = &quot;nameEn&quot;) &#125; ) &#125; )&#125;)@Data@Entity@Table(name = &quot;tbl_country&quot;)public class Country implements Serializable &#123; ………… public Country(Long id, String nameZh, String nameEn) &#123; this.id = id; this.nameZh = nameZh; this.nameEn = nameEn; &#125; public Country() &#123; &#125;&#125; 说明 命名查询的注解只能声明在对应的@Entity类型上 @NamedNativeQuery名称必须全局唯一，可以通过entityManager.createNamedQuery(String queryName)进行调用 sql查询部分字段时@Entity一定要有对应的构造方法 返回类型必须是@Entity对象 @SqlResultSetMapping可以单独使用，其功能就是将sql的查询结果转换为指定的类型,entityManager.createNativeQuery(String sqlString, String resultSetMapping) 使用方法 通过entityManager的方法进行调用 123List list = entityManager.createNamedQuery(&quot;SQL_FIND_ALL_COUNTRY&quot;).getResultList();List list = entityManager.createNativeQuery(&quot;select id,name_zh as nameZh,name_en as nameEn from tbl_country&quot;,&quot;SQL_RESULT_COUNTRY_SOME_FIELD&quot;).getResultList(); 通过在JpaRepository声明指定的@Query方法，并指定其name属性为对应的@NamedNativeQuery的name值 12345678910111213public interface CountryJpaRepository extends BaseJpaRepository&lt;Country, Long&gt; &#123; @Query(name = &quot;HQL_FIND_ALL_COUNTRY&quot;) List&lt;Country&gt; nameHqlFindAll(); @Query(name = &quot;SQL_FIND_ALL_COUNTRY&quot;) List&lt;Country&gt; nameSqlFindAll(); @Query(name = &quot;SQL_FIND_ALL_COUNTRY2&quot;) List&lt;Country&gt; nameSqlFindAll2(); @Query(name = &quot;SQL_FIND_SOME_FIELD_COUNTRY&quot;) List&lt;Country&gt; nameSqlFindSomeField();&#125; 关于在@Query注解中使用Mysql的原生sql时的一些小技巧 动态sql通过mysql的if语句实现 12345@Query(value = &quot;SELECT * FROM tbl_country WHERE if(?1!=&#x27;&#x27;, name_zh = ?1, 1=1)&quot;,nativeQuery = true)Country findCountrySqlByName(String name);@Query(value = &quot;SELECT * FROM tbl_country WHERE if(:name!=&#x27;&#x27;, name_zh = :name, 1=1)&quot;,nativeQuery = true)Country findCountrySqlByName(@Param(&quot;name&quot;) String name); 拼接like使用mysql的CONCAT语句 12345@Query(value = &quot;SELECT * FROM tbl_country WHERE name like CONCAT(&#x27;%&#x27;,?1,&#x27;%&#x27;))&quot;,nativeQuery = true)Country findCountrySqlByName(String name);@Query(value = &quot;SELECT * FROM tbl_country WHERE name like CONCAT(&#x27;%&#x27;,:name,&#x27;%&#x27;)&quot;,nativeQuery = true)Country findCountrySqlByName(@Param(&quot;name&quot;) String name); 日期比较时可以直接使用&gt;和&lt;等比较符号，参数为Date、LocalDate和LocalDateTime 12@Query(value = &quot;SELECT count(*) from tbl_country r where r.update_time &gt; :lastTime&quot;, nativeQuery = true)Long countCountryByDate(@Param(&quot;lastTime&quot;) LocalDateTime lastTime);","summary":"摘要 聊聊Spring Boot的@Query注解 参考：Spring Boot自定义JpaRepository基类","date_published":"2021-09-08T12:33:15.000Z","tags":["技术","Java","springboot","Spring Boot"]},{"id":"https://blog.hanqunfeng.com/2021/09/06/spring-boot-JpaRepository/","url":"https://blog.hanqunfeng.com/2021/09/06/spring-boot-JpaRepository/","title":"Spring Boot自定义JpaRepository基类","content_html":"<h2 id=\"摘要\"><a href=\"#摘要\" class=\"headerlink\" title=\"摘要\"></a>摘要</h2><ul>\n<li>SpringBoot基于JPA的数据操作非常方便，我们只需继承JpaRepository就可以拥有强大的数据操控能力，但是偶尔我们需要进行复杂的操作，比如批量插入与更新，或者是复杂sql等等，此时就需要我们对JpaRepository进行一些扩展。</li>\n<li>@Query注解也可以直接执行sql，但是其有一些局限，比如只有<code>select * </code>时才能直接封装为对象，只查询部分属性时就只能封装为Object[]或Map。如果希望@Query查询部分属性时也可以直接转换为对象，可以查看下一篇内容 <a href=\"/2021/09/08/springboot-query/\" title=\"Spring Boot的@Query注解\">Spring Boot的@Query注解</a></li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"自定义JpaRepository接口\"><a href=\"#自定义JpaRepository接口\" class=\"headerlink\" title=\"自定义JpaRepository接口\"></a>自定义JpaRepository接口</h2><ul>\n<li>包含一些常用操作，可以按需扩展</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.example.jpa;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.data.domain.Page;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.data.domain.Pageable;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.data.jpa.repository.JpaRepository;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.data.jpa.repository.JpaSpecificationExecutor;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.data.repository.NoRepositoryBean;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> javax.persistence.EntityManager;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.Serializable;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.List;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Map;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@NoRepositoryBean</span> <span class=\"comment\">//接口不参与jpa的代理</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">BaseJpaRepository</span>&lt;<span class=\"title\">T</span>, <span class=\"title\">ID</span> <span class=\"keyword\">extends</span> <span class=\"title\">Serializable</span>&gt; <span class=\"keyword\">extends</span> <span class=\"title\">JpaRepository</span>&lt;<span class=\"title\">T</span>, <span class=\"title\">ID</span>&gt;, <span class=\"title\">JpaSpecificationExecutor</span>&lt;<span class=\"title\">T</span>&gt;, <span class=\"title\">Serializable</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\">EntityManager <span class=\"title\">getEntityManager</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    &lt;E&gt; <span class=\"function\">List&lt;E&gt; <span class=\"title\">findByHql</span><span class=\"params\">(String hql)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\">List&lt;Map&gt; <span class=\"title\">findBySql</span><span class=\"params\">(String sql)</span></span>;</span><br><span class=\"line\">    <span class=\"function\">List&lt;Map&gt; <span class=\"title\">findBySql</span><span class=\"params\">(String sql, Object[] params)</span></span>;</span><br><span class=\"line\">    <span class=\"function\">List&lt;Map&gt; <span class=\"title\">findBySql</span><span class=\"params\">(String sql, Map&lt;String, Object&gt; params)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\">Map <span class=\"title\">findBySqlFirst</span><span class=\"params\">(String sql)</span></span>;</span><br><span class=\"line\">    <span class=\"function\">Map <span class=\"title\">findBySqlFirst</span><span class=\"params\">(String sql, Object[] params)</span></span>;</span><br><span class=\"line\">    <span class=\"function\">Map <span class=\"title\">findBySqlFirst</span><span class=\"params\">(String sql, Map&lt;String, Object&gt; params)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * basic == true 表示基本数据类型</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    &lt;E&gt; <span class=\"function\">List&lt;E&gt; <span class=\"title\">findBySql</span><span class=\"params\">(String sql, Class clazz, <span class=\"keyword\">boolean</span> basic)</span></span>;</span><br><span class=\"line\">    &lt;E&gt; <span class=\"function\">List&lt;E&gt; <span class=\"title\">findBySql</span><span class=\"params\">(String sql, Class clazz, <span class=\"keyword\">boolean</span> basic, Object[] params)</span></span>;</span><br><span class=\"line\">    &lt;E&gt; <span class=\"function\">List&lt;E&gt; <span class=\"title\">findBySql</span><span class=\"params\">(String sql, Class clazz, <span class=\"keyword\">boolean</span> basic, Map&lt;String, Object&gt; params)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 分页查询</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    &lt;E&gt; <span class=\"function\">Page&lt;E&gt; <span class=\"title\">findPageBySql</span><span class=\"params\">(String sql, Pageable pageable, Class clazz, <span class=\"keyword\">boolean</span> basic)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    &lt;E&gt; <span class=\"function\">Page&lt;E&gt; <span class=\"title\">findPageBySql</span><span class=\"params\">(String sql, String countSql, Pageable pageable, Class clazz, <span class=\"keyword\">boolean</span> basic)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    &lt;E&gt; <span class=\"function\">Page&lt;E&gt; <span class=\"title\">findPageBySql</span><span class=\"params\">(String sql, Pageable pageable, Class clazz, <span class=\"keyword\">boolean</span> basic, Object[] params)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    &lt;E&gt; <span class=\"function\">Page&lt;E&gt; <span class=\"title\">findPageBySql</span><span class=\"params\">(String sql, String countSql, Pageable pageable, Class clazz, <span class=\"keyword\">boolean</span> basic, Object[] params)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    &lt;E&gt; <span class=\"function\">Page&lt;E&gt; <span class=\"title\">findPageBySql</span><span class=\"params\">(String sql, Pageable pageable, Class clazz, <span class=\"keyword\">boolean</span> basic, Map&lt;String, Object&gt; params)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    &lt;E&gt; <span class=\"function\">Page&lt;E&gt; <span class=\"title\">findPageBySql</span><span class=\"params\">(String sql, String countSql, Pageable pageable, Class clazz, <span class=\"keyword\">boolean</span> basic, Map&lt;String, Object&gt; params)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * basic == true 表示基本数据类型</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    &lt;E&gt; <span class=\"function\">E <span class=\"title\">findBySqlFirst</span><span class=\"params\">(String sql, Class clazz, <span class=\"keyword\">boolean</span> basic)</span></span>;</span><br><span class=\"line\">    &lt;E&gt; <span class=\"function\">E <span class=\"title\">findBySqlFirst</span><span class=\"params\">(String sql, Class clazz, <span class=\"keyword\">boolean</span> basic, Object[] params)</span></span>;</span><br><span class=\"line\">    &lt;E&gt; <span class=\"function\">E <span class=\"title\">findBySqlFirst</span><span class=\"params\">(String sql, Class clazz, <span class=\"keyword\">boolean</span> basic, Map&lt;String, Object&gt; params)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\">T <span class=\"title\">findByIdNew</span><span class=\"params\">(ID id)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 批量插入</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    &lt;S extends T&gt; <span class=\"function\">Iterable&lt;S&gt; <span class=\"title\">batchSave</span><span class=\"params\">(Iterable&lt;S&gt; iterable)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 批量更新</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    &lt;S extends T&gt; <span class=\"function\">Iterable&lt;S&gt; <span class=\"title\">batchUpdate</span><span class=\"params\">(Iterable&lt;S&gt; iterable)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"自定义JpaRepository接口的实现类\"><a href=\"#自定义JpaRepository接口的实现类\" class=\"headerlink\" title=\"自定义JpaRepository接口的实现类\"></a>自定义JpaRepository接口的实现类</h2><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br><span class=\"line\">280</span><br><span class=\"line\">281</span><br><span class=\"line\">282</span><br><span class=\"line\">283</span><br><span class=\"line\">284</span><br><span class=\"line\">285</span><br><span class=\"line\">286</span><br><span class=\"line\">287</span><br><span class=\"line\">288</span><br><span class=\"line\">289</span><br><span class=\"line\">290</span><br><span class=\"line\">291</span><br><span class=\"line\">292</span><br><span class=\"line\">293</span><br><span class=\"line\">294</span><br><span class=\"line\">295</span><br><span class=\"line\">296</span><br><span class=\"line\">297</span><br><span class=\"line\">298</span><br><span class=\"line\">299</span><br><span class=\"line\">300</span><br><span class=\"line\">301</span><br><span class=\"line\">302</span><br><span class=\"line\">303</span><br><span class=\"line\">304</span><br><span class=\"line\">305</span><br><span class=\"line\">306</span><br><span class=\"line\">307</span><br><span class=\"line\">308</span><br><span class=\"line\">309</span><br><span class=\"line\">310</span><br><span class=\"line\">311</span><br><span class=\"line\">312</span><br><span class=\"line\">313</span><br><span class=\"line\">314</span><br><span class=\"line\">315</span><br><span class=\"line\">316</span><br><span class=\"line\">317</span><br><span class=\"line\">318</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.example.jpa;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> com.example.context.ApplicationContextProvider;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.hibernate.query.internal.NativeQueryImpl;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.hibernate.transform.Transformers;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.data.domain.Page;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.data.domain.PageImpl;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.data.domain.Pageable;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.data.domain.Sort;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.data.jpa.repository.support.JpaEntityInformation;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.data.jpa.repository.support.SimpleJpaRepository;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> javax.persistence.EntityManager;</span><br><span class=\"line\"><span class=\"keyword\">import</span> javax.persistence.Query;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.Serializable;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.math.BigInteger;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.*;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">BaseJpaRepositoryImpl</span>&lt;<span class=\"title\">T</span>, <span class=\"title\">ID</span> <span class=\"keyword\">extends</span> <span class=\"title\">Serializable</span>&gt; <span class=\"keyword\">extends</span> <span class=\"title\">SimpleJpaRepository</span>&lt;<span class=\"title\">T</span>, <span class=\"title\">ID</span>&gt; <span class=\"keyword\">implements</span> <span class=\"title\">BaseJpaRepository</span>&lt;<span class=\"title\">T</span>, <span class=\"title\">ID</span>&gt; </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//批量更新时的阀值，每500条数据commit一次</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> Integer BATCH_SIZE = <span class=\"number\">500</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//通过构造方法初始化EntityManager</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> EntityManager entityManager;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">BaseJpaRepositoryImpl</span><span class=\"params\">(JpaEntityInformation&lt;T, ID&gt; entityInformation, EntityManager entityManager)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">super</span>(entityInformation, entityManager);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.entityManager = entityManager;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> EntityManager <span class=\"title\">getEntityManager</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> entityManager;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> &lt;E&gt; <span class=\"function\">List&lt;E&gt; <span class=\"title\">findByHql</span><span class=\"params\">(String hql)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> (List&lt;E&gt;) entityManager.createQuery(hql)</span><br><span class=\"line\">                .getResultList();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> List&lt;Map&gt; <span class=\"title\">findBySql</span><span class=\"params\">(String sql)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> findBySql(sql, <span class=\"keyword\">new</span> HashMap&lt;&gt;());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> List&lt;Map&gt; <span class=\"title\">findBySql</span><span class=\"params\">(String sql, Object[] params)</span> </span>&#123;</span><br><span class=\"line\">        Query nativeQuery = entityManager.createNativeQuery(sql);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (params != <span class=\"keyword\">null</span> &amp;&amp; params.length &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; params.length; i++) &#123;</span><br><span class=\"line\">                nativeQuery.setParameter(i + <span class=\"number\">1</span>, params[i]);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> nativeQuery.unwrap(NativeQueryImpl.class)</span><br><span class=\"line\">                .setResultTransformer(Transformers.ALIAS_TO_ENTITY_MAP)</span><br><span class=\"line\">                .getResultList();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> List&lt;Map&gt; <span class=\"title\">findBySql</span><span class=\"params\">(String sql, Map&lt;String, Object&gt; params)</span> </span>&#123;</span><br><span class=\"line\">        Query nativeQuery = entityManager.createNativeQuery(sql);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (params != <span class=\"keyword\">null</span> &amp;&amp; params.size() &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">for</span> (String key : params.keySet()) &#123;</span><br><span class=\"line\">                nativeQuery.setParameter(key, params.get(key));</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> nativeQuery.unwrap(NativeQueryImpl.class)</span><br><span class=\"line\">                .setResultTransformer(Transformers.ALIAS_TO_ENTITY_MAP)</span><br><span class=\"line\">                .getResultList();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> &lt;E&gt; <span class=\"function\">List&lt;E&gt; <span class=\"title\">findBySql</span><span class=\"params\">(String sql, Class clazz, <span class=\"keyword\">boolean</span> basic)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> findBySql(sql, clazz, basic, <span class=\"keyword\">new</span> HashMap&lt;&gt;());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> &lt;E&gt; <span class=\"function\">List&lt;E&gt; <span class=\"title\">findBySql</span><span class=\"params\">(String sql, Class clazz, <span class=\"keyword\">boolean</span> basic, Object[] params)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> getJpaUtil().mapListToObjectList(findBySql(sql, params), clazz, basic);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> &lt;E&gt; <span class=\"function\">List&lt;E&gt; <span class=\"title\">findBySql</span><span class=\"params\">(String sql, Class clazz, <span class=\"keyword\">boolean</span> basic, Map&lt;String, Object&gt; params)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> getJpaUtil().mapListToObjectList(findBySql(sql, params), clazz, basic);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> &lt;E&gt; <span class=\"function\">Page&lt;E&gt; <span class=\"title\">findPageBySql</span><span class=\"params\">(String sql, Pageable pageable, Class clazz, <span class=\"keyword\">boolean</span> basic)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> findPageBySql(sql, pageable, clazz, basic, <span class=\"keyword\">new</span> HashMap&lt;&gt;());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> &lt;E&gt; <span class=\"function\">Page&lt;E&gt; <span class=\"title\">findPageBySql</span><span class=\"params\">(String sql, String countSql, Pageable pageable, Class clazz, <span class=\"keyword\">boolean</span> basic)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> findPageBySql(sql, countSql, pageable, clazz, basic, <span class=\"keyword\">new</span> HashMap&lt;&gt;());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> &lt;E&gt; <span class=\"function\">Page&lt;E&gt; <span class=\"title\">findPageBySql</span><span class=\"params\">(String sql, Pageable pageable, Class clazz, <span class=\"keyword\">boolean</span> basic, Object[] params)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> findPageBySql(sql, <span class=\"keyword\">null</span>, pageable, clazz, basic, params);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> &lt;E&gt; <span class=\"function\">Page&lt;E&gt; <span class=\"title\">findPageBySql</span><span class=\"params\">(String sql, String countSql, Pageable pageable, Class clazz, <span class=\"keyword\">boolean</span> basic, Object[] params)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!sql.toLowerCase().contains(<span class=\"string\">&quot;order by&quot;</span>)) &#123;</span><br><span class=\"line\">            StringBuilder stringBuilder = <span class=\"keyword\">new</span> StringBuilder(sql);</span><br><span class=\"line\">            stringBuilder.append(<span class=\"string\">&quot; order by &quot;</span>);</span><br><span class=\"line\">            <span class=\"keyword\">final</span> Sort sort = pageable.getSort();</span><br><span class=\"line\">            <span class=\"keyword\">final</span> List&lt;Sort.Order&gt; orders = sort.toList();</span><br><span class=\"line\">            <span class=\"keyword\">for</span> (Sort.Order order : orders) &#123;</span><br><span class=\"line\">                stringBuilder.append(order.getProperty())</span><br><span class=\"line\">                        .append(<span class=\"string\">&quot; &quot;</span>)</span><br><span class=\"line\">                        .append(order.getDirection().name())</span><br><span class=\"line\">                        .append(<span class=\"string\">&quot;,&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            sql = stringBuilder.toString();</span><br><span class=\"line\">            sql = sql.substring(<span class=\"number\">0</span>, sql.length() - <span class=\"number\">1</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">final</span> Query nativeQuery = entityManager.createNativeQuery(sql);</span><br><span class=\"line\">        nativeQuery.setFirstResult(pageable.getPageNumber() * pageable.getPageSize());</span><br><span class=\"line\">        nativeQuery.setMaxResults(pageable.getPageSize());</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (params != <span class=\"keyword\">null</span> &amp;&amp; params.length &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; params.length; i++) &#123;</span><br><span class=\"line\">                nativeQuery.setParameter(i + <span class=\"number\">1</span>, params[i]);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">        List&lt;Map&gt; resultList = nativeQuery.unwrap(NativeQueryImpl.class)</span><br><span class=\"line\">                .setResultTransformer(Transformers.ALIAS_TO_ENTITY_MAP).getResultList();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">final</span> List&lt;E&gt; objectList = getJpaUtil().mapListToObjectList(resultList, clazz, basic);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!StringUtils.hasText(countSql)) &#123;</span><br><span class=\"line\">            countSql = <span class=\"string\">&quot;select count(*) from ( &quot;</span> + sql + <span class=\"string\">&quot; ) a&quot;</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">final</span> BigInteger count = findBySqlFirst(countSql, BigInteger.class, <span class=\"keyword\">true</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        Page&lt;E&gt; page = <span class=\"keyword\">new</span> PageImpl&lt;&gt;(objectList, pageable, count.longValue());</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> page;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> &lt;E&gt; <span class=\"function\">Page&lt;E&gt; <span class=\"title\">findPageBySql</span><span class=\"params\">(String sql, Pageable pageable, Class clazz, <span class=\"keyword\">boolean</span> basic, Map&lt;String, Object&gt; params)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> findPageBySql(sql, <span class=\"keyword\">null</span>, pageable, clazz, basic, params);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> &lt;E&gt; <span class=\"function\">Page&lt;E&gt; <span class=\"title\">findPageBySql</span><span class=\"params\">(String sql, String countSql, Pageable pageable, Class clazz, <span class=\"keyword\">boolean</span> basic, Map&lt;String, Object&gt; params)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!sql.toLowerCase().contains(<span class=\"string\">&quot;order by&quot;</span>)) &#123;</span><br><span class=\"line\">            StringBuilder stringBuilder = <span class=\"keyword\">new</span> StringBuilder(sql);</span><br><span class=\"line\">            stringBuilder.append(<span class=\"string\">&quot; order by &quot;</span>);</span><br><span class=\"line\">            <span class=\"keyword\">final</span> Sort sort = pageable.getSort();</span><br><span class=\"line\">            <span class=\"keyword\">final</span> List&lt;Sort.Order&gt; orders = sort.toList();</span><br><span class=\"line\">            <span class=\"keyword\">for</span> (Sort.Order order : orders) &#123;</span><br><span class=\"line\">                stringBuilder.append(order.getProperty())</span><br><span class=\"line\">                        .append(<span class=\"string\">&quot; &quot;</span>)</span><br><span class=\"line\">                        .append(order.getDirection().name())</span><br><span class=\"line\">                        .append(<span class=\"string\">&quot;,&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            sql = stringBuilder.toString();</span><br><span class=\"line\">            sql = sql.substring(<span class=\"number\">0</span>, sql.length() - <span class=\"number\">1</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">final</span> Query nativeQuery = entityManager.createNativeQuery(sql);</span><br><span class=\"line\">        nativeQuery.setFirstResult(pageable.getPageNumber() * pageable.getPageSize());</span><br><span class=\"line\">        nativeQuery.setMaxResults(pageable.getPageSize());</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (params != <span class=\"keyword\">null</span> &amp;&amp; params.size() &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">for</span> (String key : params.keySet()) &#123;</span><br><span class=\"line\">                nativeQuery.setParameter(key, params.get(key));</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">        List&lt;Map&gt; resultList = nativeQuery.unwrap(NativeQueryImpl.class)</span><br><span class=\"line\">                .setResultTransformer(Transformers.ALIAS_TO_ENTITY_MAP).getResultList();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">final</span> List&lt;E&gt; objectList = getJpaUtil().mapListToObjectList(resultList, clazz, basic);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!StringUtils.hasText(countSql)) &#123;</span><br><span class=\"line\">            countSql = <span class=\"string\">&quot;select count(*) from ( &quot;</span> + sql + <span class=\"string\">&quot; ) a&quot;</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">final</span> BigInteger count = findBySqlFirst(countSql, BigInteger.class, <span class=\"keyword\">true</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        Page&lt;E&gt; page = <span class=\"keyword\">new</span> PageImpl&lt;&gt;(objectList, pageable, count.longValue());</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> page;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Map <span class=\"title\">findBySqlFirst</span><span class=\"params\">(String sql)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> findBySqlFirst(sql, <span class=\"keyword\">new</span> HashMap&lt;&gt;());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Map <span class=\"title\">findBySqlFirst</span><span class=\"params\">(String sql, Object[] params)</span> </span>&#123;</span><br><span class=\"line\">        Query nativeQuery = entityManager.createNativeQuery(sql);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (params != <span class=\"keyword\">null</span> &amp;&amp; params.length &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; params.length; i++) &#123;</span><br><span class=\"line\">                nativeQuery.setParameter(i + <span class=\"number\">1</span>, params[i]);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">final</span> Optional first = nativeQuery.unwrap(NativeQueryImpl.class)</span><br><span class=\"line\">                .setResultTransformer(Transformers.ALIAS_TO_ENTITY_MAP)</span><br><span class=\"line\">                .stream().findFirst();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (first.isPresent()) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> (Map) first.get();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Map <span class=\"title\">findBySqlFirst</span><span class=\"params\">(String sql, Map&lt;String, Object&gt; params)</span> </span>&#123;</span><br><span class=\"line\">        Query nativeQuery = entityManager.createNativeQuery(sql);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (params != <span class=\"keyword\">null</span> &amp;&amp; params.size() &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">for</span> (String key : params.keySet()) &#123;</span><br><span class=\"line\">                nativeQuery.setParameter(key, params.get(key));</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">final</span> Optional first = nativeQuery.unwrap(NativeQueryImpl.class)</span><br><span class=\"line\">                .setResultTransformer(Transformers.ALIAS_TO_ENTITY_MAP)</span><br><span class=\"line\">                .stream().findFirst();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (first.isPresent()) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> (Map) first.get();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> &lt;E&gt; <span class=\"function\">E <span class=\"title\">findBySqlFirst</span><span class=\"params\">(String sql, Class clazz, <span class=\"keyword\">boolean</span> basic)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> findBySqlFirst(sql, clazz, basic, <span class=\"keyword\">new</span> HashMap&lt;&gt;());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> &lt;E&gt; <span class=\"function\">E <span class=\"title\">findBySqlFirst</span><span class=\"params\">(String sql, Class clazz, <span class=\"keyword\">boolean</span> basic, Object[] params)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> getJpaUtil().mapToObject(findBySqlFirst(sql, params), clazz, basic);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> &lt;E&gt; <span class=\"function\">E <span class=\"title\">findBySqlFirst</span><span class=\"params\">(String sql, Class clazz, <span class=\"keyword\">boolean</span> basic, Map&lt;String, Object&gt; params)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> getJpaUtil().mapToObject(findBySqlFirst(sql, params), clazz, basic);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> T <span class=\"title\">findByIdNew</span><span class=\"params\">(ID id)</span> </span>&#123;</span><br><span class=\"line\">        T t = <span class=\"keyword\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        Optional&lt;T&gt; optional = <span class=\"keyword\">this</span>.findById(id);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (optional.isPresent()) &#123;</span><br><span class=\"line\">            t = optional.get();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> t;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"meta\">@Transactional</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> &lt;S extends T&gt; <span class=\"function\">Iterable&lt;S&gt; <span class=\"title\">batchSave</span><span class=\"params\">(Iterable&lt;S&gt; iterable)</span> </span>&#123;</span><br><span class=\"line\">        Iterator&lt;S&gt; iterator = iterable.iterator();</span><br><span class=\"line\">        <span class=\"keyword\">int</span> index = <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"keyword\">while</span> (iterator.hasNext()) &#123;</span><br><span class=\"line\">            entityManager.persist(iterator.next());</span><br><span class=\"line\">            index++;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (index % BATCH_SIZE == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                entityManager.flush();</span><br><span class=\"line\">                entityManager.clear();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (index % BATCH_SIZE != <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            entityManager.flush();</span><br><span class=\"line\">            entityManager.clear();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> iterable;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"meta\">@Transactional</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> &lt;S extends T&gt; <span class=\"function\">Iterable&lt;S&gt; <span class=\"title\">batchUpdate</span><span class=\"params\">(Iterable&lt;S&gt; iterable)</span> </span>&#123;</span><br><span class=\"line\">        Iterator&lt;S&gt; iterator = iterable.iterator();</span><br><span class=\"line\">        <span class=\"keyword\">int</span> index = <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"keyword\">while</span> (iterator.hasNext()) &#123;</span><br><span class=\"line\">            entityManager.merge(iterator.next());</span><br><span class=\"line\">            index++;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (index % BATCH_SIZE == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                entityManager.flush();</span><br><span class=\"line\">                entityManager.clear();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (index % BATCH_SIZE != <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            entityManager.flush();</span><br><span class=\"line\">            entityManager.clear();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> iterable;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> JpaUtil <span class=\"title\">getJpaUtil</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        JpaUtil objectUtil = (JpaUtil) ApplicationContextProvider.getBean(<span class=\"string\">&quot;jpaUtil&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> objectUtil;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"工具类JpaUtil\"><a href=\"#工具类JpaUtil\" class=\"headerlink\" title=\"工具类JpaUtil\"></a>工具类JpaUtil</h2><ul>\n<li>其功能就是将Map对象通过json转换成指定对象</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.example.jpa;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> com.fasterxml.jackson.core.JsonProcessingException;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.stereotype.Component;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.ArrayList;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.List;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Map;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Component(&quot;jpaUtil&quot;)</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">JpaUtil</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    ObjectMapper objectMapper;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 查询结果为List&lt;Map&gt;时，可以通过该方法转换为对象List，注意Map中key要与对象属性匹配，或者对象属性标注了<span class=\"doctag\">@JsonProperty</span></span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> &lt;E&gt; <span class=\"function\">List&lt;E&gt; <span class=\"title\">mapListToObjectList</span><span class=\"params\">(List&lt;Map&gt; mapList, Class clazz, <span class=\"keyword\">boolean</span> basic)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        List&lt;E&gt; list = <span class=\"keyword\">new</span> ArrayList&lt;&gt;();</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (Map map : mapList) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (basic) &#123;</span><br><span class=\"line\">                list.add((E) map.values().stream().findFirst().get());</span><br><span class=\"line\"></span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">final</span> String valueAsString = objectMapper.writeValueAsString(map);</span><br><span class=\"line\">                    E newInstance = (E) objectMapper.readValue(valueAsString, clazz);</span><br><span class=\"line\">                    list.add(newInstance);</span><br><span class=\"line\">                &#125; <span class=\"keyword\">catch</span> (JsonProcessingException e) &#123;</span><br><span class=\"line\">                    e.printStackTrace();</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> list;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 查询结果为Map时，可以通过该方法转换为对象，注意Map中key要与对象属性匹配，或者对象属性标注了<span class=\"doctag\">@JsonProperty</span></span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> &lt;E&gt; <span class=\"function\">E <span class=\"title\">mapToObject</span><span class=\"params\">(Map map, Class clazz, <span class=\"keyword\">boolean</span> basic)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(map == <span class=\"keyword\">null</span>)&#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        E newInstance = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        <span class=\"comment\">//基本类型，说明返回值只有一列</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (basic) &#123;</span><br><span class=\"line\">            newInstance = (E) map.values().stream().findFirst().get();</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">final</span> String valueAsString = objectMapper.writeValueAsString(map);</span><br><span class=\"line\">                newInstance = (E) objectMapper.readValue(valueAsString, clazz);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (JsonProcessingException e) &#123;</span><br><span class=\"line\">                e.printStackTrace();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> newInstance;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ApplicationContextProvider\"><a href=\"#ApplicationContextProvider\" class=\"headerlink\" title=\"ApplicationContextProvider\"></a>ApplicationContextProvider</h2><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.example.common.support;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.beans.BeansException;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.ApplicationContext;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.ApplicationContextAware;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.i18n.LocaleContextHolder;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.stereotype.Component;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Component</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ApplicationContextProvider</span></span></span><br><span class=\"line\"><span class=\"class\">        <span class=\"keyword\">implements</span> <span class=\"title\">ApplicationContextAware</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 上下文对象实例</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> ApplicationContext applicationContext;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 获取applicationContext</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span></span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> ApplicationContext <span class=\"title\">getApplicationContext</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> applicationContext;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setApplicationContext</span><span class=\"params\">(ApplicationContext applicationContext)</span> <span class=\"keyword\">throws</span> BeansException </span>&#123;</span><br><span class=\"line\">        ApplicationContextProvider.applicationContext = applicationContext;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 通过name获取 Bean.</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> name</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span></span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> Object <span class=\"title\">getBean</span><span class=\"params\">(String name)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> getApplicationContext().getBean(name);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 通过class获取Bean.</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> clazz</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> &lt;T&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span></span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> &lt;T&gt; <span class=\"function\">T <span class=\"title\">getBean</span><span class=\"params\">(Class&lt;T&gt; clazz)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> getApplicationContext().getBean(clazz);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 通过name,以及Clazz返回指定的Bean</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> name</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> clazz</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> &lt;T&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span></span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> &lt;T&gt; <span class=\"function\">T <span class=\"title\">getBean</span><span class=\"params\">(String name, Class&lt;T&gt; clazz)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> getApplicationContext().getBean(name, clazz);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 描述 : &lt;获得多语言的资源内容&gt;. &lt;br&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;p&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;使用方法说明&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> code</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> args</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span></span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> String <span class=\"title\">getMessage</span><span class=\"params\">(String code, Object[] args)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> getApplicationContext().getMessage(code, args, LocaleContextHolder.getLocale());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 描述 : &lt;获得多语言的资源内容&gt;. &lt;br&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;p&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;使用方法说明&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> code</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> args</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> defaultMessage</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span></span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> String <span class=\"title\">getMessage</span><span class=\"params\">(String code, Object[] args,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">                                    String defaultMessage)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> getApplicationContext().getMessage(code, args, defaultMessage,</span><br><span class=\"line\">                LocaleContextHolder.getLocale());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"配置类上增加-EnableJpaRepositories-repositoryBaseClass-BaseJpaRepositoryImpl-class\"><a href=\"#配置类上增加-EnableJpaRepositories-repositoryBaseClass-BaseJpaRepositoryImpl-class\" class=\"headerlink\" title=\"配置类上增加 @EnableJpaRepositories(repositoryBaseClass = BaseJpaRepositoryImpl.class)\"></a>配置类上增加 @EnableJpaRepositories(repositoryBaseClass = BaseJpaRepositoryImpl.class)</h2><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Configuration</span></span><br><span class=\"line\"><span class=\"meta\">@EnableJpaRepositories(repositoryBaseClass = BaseJpaRepositoryImpl.class, basePackages = &quot;com.example.demo&quot;)</span></span><br><span class=\"line\"><span class=\"meta\">@EntityScan(basePackages = &quot;com.example.demo&quot;)</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">JpaConfig</span> </span>&#123;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"业务Jpa对象继承BaseJpaRepository\"><a href=\"#业务Jpa对象继承BaseJpaRepository\" class=\"headerlink\" title=\"业务Jpa对象继承BaseJpaRepository\"></a>业务Jpa对象继承BaseJpaRepository</h2><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">CountryJpaRepository</span> <span class=\"keyword\">extends</span> <span class=\"title\">BaseJpaRepository</span>&lt;<span class=\"title\">Country</span>, <span class=\"title\">Long</span>&gt; </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//这种SELECT * 的形式也可以转换成对象，但是如果只查询某几个属性时，就会转换失败</span></span><br><span class=\"line\">    <span class=\"meta\">@Query(value = &quot;SELECT * FROM tbl_country&quot;, countQuery = &quot;SELECT count(*) FROM tbl_country&quot;, nativeQuery = true)</span></span><br><span class=\"line\">    <span class=\"function\">Page&lt;Country&gt; <span class=\"title\">findAll</span><span class=\"params\">(Pageable pageable)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//失败</span></span><br><span class=\"line\">    <span class=\"meta\">@Query(value = &quot;SELECT id,name_zh FROM tbl_country WHERE name_zh = ?1&quot;,nativeQuery = true)</span></span><br><span class=\"line\">    <span class=\"function\">Country <span class=\"title\">findByName</span><span class=\"params\">(String name)</span></span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"示例\"><a href=\"#示例\" class=\"headerlink\" title=\"示例\"></a>示例</h2><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@GetMapping(&quot;/&quot;)</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Map <span class=\"title\">index</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        Map&lt;String, Object&gt; map = <span class=\"keyword\">new</span> HashMap&lt;&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//查询总数，注意count求和返回的对象是BigInteger类型</span></span><br><span class=\"line\">        <span class=\"keyword\">final</span> BigInteger size = countryJpaRepository.findBySqlFirst(<span class=\"string\">&quot;SELECT count(*) as count FROM tbl_country&quot;</span>, BigInteger.class, <span class=\"keyword\">true</span>);</span><br><span class=\"line\">        map.put(<span class=\"string\">&quot;size&quot;</span>, size);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//分页查询</span></span><br><span class=\"line\">        Pageable pageable = PageRequest.of(<span class=\"number\">1</span>, <span class=\"number\">20</span>, Sort.by(Sort.Direction.DESC, <span class=\"string\">&quot;id&quot;</span>).and(Sort.by(Sort.Direction.ASC, <span class=\"string\">&quot;name_zh&quot;</span>)));</span><br><span class=\"line\">        <span class=\"keyword\">final</span> Page&lt;Country&gt; pages = countryJpaRepository.findPageBySql(<span class=\"string\">&quot;SELECT id,name_zh as nameZh ,name_en as nameEn FROM tbl_country&quot;</span>, pageable, Country.class, <span class=\"keyword\">false</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        map.put(<span class=\"string\">&quot;pages&quot;</span>, pages);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//批量新增</span></span><br><span class=\"line\">        List&lt;DemoEntity&gt; entityList = <span class=\"keyword\">new</span> ArrayList&lt;&gt;();</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">1000</span>; i++) &#123;</span><br><span class=\"line\">            DemoEntity demoEntity = <span class=\"keyword\">new</span> DemoEntity();</span><br><span class=\"line\">            demoEntity.setName(<span class=\"string\">&quot;测试&quot;</span> + i);</span><br><span class=\"line\">            demoEntity.initInsert();</span><br><span class=\"line\">            entityList.add(demoEntity);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        demoEntityJpaRepository.batchSave(entityList);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">final</span> Page&lt;DemoEntity&gt; demoEntities = demoEntityJpaRepository.findAll(PageRequest.of(<span class=\"number\">1</span>, <span class=\"number\">100</span>, Sort.by(Sort.Direction.DESC, <span class=\"string\">&quot;name&quot;</span>)));</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//批量删除</span></span><br><span class=\"line\">        demoEntityJpaRepository.deleteAllInBatch(demoEntities.getContent());</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> map;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>","content_text":"摘要 SpringBoot基于JPA的数据操作非常方便，我们只需继承JpaRepository就可以拥有强大的数据操控能力，但是偶尔我们需要进行复杂的操作，比如批量插入与更新，或者是复杂sql等等，此时就需要我们对JpaRepository进行一些扩展。 @Query注解也可以直接执行sql，但是其有一些局限，比如只有select * 时才能直接封装为对象，只查询部分属性时就只能封装为Object[]或Map。如果希望@Query查询部分属性时也可以直接转换为对象，可以查看下一篇内容 Spring Boot的@Query注解 自定义JpaRepository接口 包含一些常用操作，可以按需扩展 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273package com.example.jpa;import org.springframework.data.domain.Page;import org.springframework.data.domain.Pageable;import org.springframework.data.jpa.repository.JpaRepository;import org.springframework.data.jpa.repository.JpaSpecificationExecutor;import org.springframework.data.repository.NoRepositoryBean;import javax.persistence.EntityManager;import java.io.Serializable;import java.util.List;import java.util.Map;@NoRepositoryBean //接口不参与jpa的代理public interface BaseJpaRepository&lt;T, ID extends Serializable&gt; extends JpaRepository&lt;T, ID&gt;, JpaSpecificationExecutor&lt;T&gt;, Serializable &#123; EntityManager getEntityManager(); &lt;E&gt; List&lt;E&gt; findByHql(String hql); List&lt;Map&gt; findBySql(String sql); List&lt;Map&gt; findBySql(String sql, Object[] params); List&lt;Map&gt; findBySql(String sql, Map&lt;String, Object&gt; params); Map findBySqlFirst(String sql); Map findBySqlFirst(String sql, Object[] params); Map findBySqlFirst(String sql, Map&lt;String, Object&gt; params); /** * basic == true 表示基本数据类型 */ &lt;E&gt; List&lt;E&gt; findBySql(String sql, Class clazz, boolean basic); &lt;E&gt; List&lt;E&gt; findBySql(String sql, Class clazz, boolean basic, Object[] params); &lt;E&gt; List&lt;E&gt; findBySql(String sql, Class clazz, boolean basic, Map&lt;String, Object&gt; params); /** * 分页查询 */ &lt;E&gt; Page&lt;E&gt; findPageBySql(String sql, Pageable pageable, Class clazz, boolean basic); &lt;E&gt; Page&lt;E&gt; findPageBySql(String sql, String countSql, Pageable pageable, Class clazz, boolean basic); &lt;E&gt; Page&lt;E&gt; findPageBySql(String sql, Pageable pageable, Class clazz, boolean basic, Object[] params); &lt;E&gt; Page&lt;E&gt; findPageBySql(String sql, String countSql, Pageable pageable, Class clazz, boolean basic, Object[] params); &lt;E&gt; Page&lt;E&gt; findPageBySql(String sql, Pageable pageable, Class clazz, boolean basic, Map&lt;String, Object&gt; params); &lt;E&gt; Page&lt;E&gt; findPageBySql(String sql, String countSql, Pageable pageable, Class clazz, boolean basic, Map&lt;String, Object&gt; params); /** * basic == true 表示基本数据类型 */ &lt;E&gt; E findBySqlFirst(String sql, Class clazz, boolean basic); &lt;E&gt; E findBySqlFirst(String sql, Class clazz, boolean basic, Object[] params); &lt;E&gt; E findBySqlFirst(String sql, Class clazz, boolean basic, Map&lt;String, Object&gt; params); T findByIdNew(ID id); /** * 批量插入 */ &lt;S extends T&gt; Iterable&lt;S&gt; batchSave(Iterable&lt;S&gt; iterable); /** * 批量更新 */ &lt;S extends T&gt; Iterable&lt;S&gt; batchUpdate(Iterable&lt;S&gt; iterable);&#125; 自定义JpaRepository接口的实现类123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318package com.example.jpa;import com.example.context.ApplicationContextProvider;import org.hibernate.query.internal.NativeQueryImpl;import org.hibernate.transform.Transformers;import org.springframework.data.domain.Page;import org.springframework.data.domain.PageImpl;import org.springframework.data.domain.Pageable;import org.springframework.data.domain.Sort;import org.springframework.data.jpa.repository.support.JpaEntityInformation;import org.springframework.data.jpa.repository.support.SimpleJpaRepository;import org.springframework.transaction.annotation.Transactional;import javax.persistence.EntityManager;import javax.persistence.Query;import java.io.Serializable;import java.math.BigInteger;import java.util.*;public class BaseJpaRepositoryImpl&lt;T, ID extends Serializable&gt; extends SimpleJpaRepository&lt;T, ID&gt; implements BaseJpaRepository&lt;T, ID&gt; &#123; //批量更新时的阀值，每500条数据commit一次 private static final Integer BATCH_SIZE = 500; //通过构造方法初始化EntityManager private final EntityManager entityManager; public BaseJpaRepositoryImpl(JpaEntityInformation&lt;T, ID&gt; entityInformation, EntityManager entityManager) &#123; super(entityInformation, entityManager); this.entityManager = entityManager; &#125; @Override public EntityManager getEntityManager() &#123; return entityManager; &#125; @Override public &lt;E&gt; List&lt;E&gt; findByHql(String hql) &#123; return (List&lt;E&gt;) entityManager.createQuery(hql) .getResultList(); &#125; @Override public List&lt;Map&gt; findBySql(String sql) &#123; return findBySql(sql, new HashMap&lt;&gt;()); &#125; @Override public List&lt;Map&gt; findBySql(String sql, Object[] params) &#123; Query nativeQuery = entityManager.createNativeQuery(sql); if (params != null &amp;&amp; params.length &gt; 0) &#123; for (int i = 0; i &lt; params.length; i++) &#123; nativeQuery.setParameter(i + 1, params[i]); &#125; &#125; return nativeQuery.unwrap(NativeQueryImpl.class) .setResultTransformer(Transformers.ALIAS_TO_ENTITY_MAP) .getResultList(); &#125; @Override public List&lt;Map&gt; findBySql(String sql, Map&lt;String, Object&gt; params) &#123; Query nativeQuery = entityManager.createNativeQuery(sql); if (params != null &amp;&amp; params.size() &gt; 0) &#123; for (String key : params.keySet()) &#123; nativeQuery.setParameter(key, params.get(key)); &#125; &#125; return nativeQuery.unwrap(NativeQueryImpl.class) .setResultTransformer(Transformers.ALIAS_TO_ENTITY_MAP) .getResultList(); &#125; @Override public &lt;E&gt; List&lt;E&gt; findBySql(String sql, Class clazz, boolean basic) &#123; return findBySql(sql, clazz, basic, new HashMap&lt;&gt;()); &#125; @Override public &lt;E&gt; List&lt;E&gt; findBySql(String sql, Class clazz, boolean basic, Object[] params) &#123; return getJpaUtil().mapListToObjectList(findBySql(sql, params), clazz, basic); &#125; @Override public &lt;E&gt; List&lt;E&gt; findBySql(String sql, Class clazz, boolean basic, Map&lt;String, Object&gt; params) &#123; return getJpaUtil().mapListToObjectList(findBySql(sql, params), clazz, basic); &#125; @Override public &lt;E&gt; Page&lt;E&gt; findPageBySql(String sql, Pageable pageable, Class clazz, boolean basic) &#123; return findPageBySql(sql, pageable, clazz, basic, new HashMap&lt;&gt;()); &#125; @Override public &lt;E&gt; Page&lt;E&gt; findPageBySql(String sql, String countSql, Pageable pageable, Class clazz, boolean basic) &#123; return findPageBySql(sql, countSql, pageable, clazz, basic, new HashMap&lt;&gt;()); &#125; @Override public &lt;E&gt; Page&lt;E&gt; findPageBySql(String sql, Pageable pageable, Class clazz, boolean basic, Object[] params) &#123; return findPageBySql(sql, null, pageable, clazz, basic, params); &#125; @Override public &lt;E&gt; Page&lt;E&gt; findPageBySql(String sql, String countSql, Pageable pageable, Class clazz, boolean basic, Object[] params) &#123; if (!sql.toLowerCase().contains(&quot;order by&quot;)) &#123; StringBuilder stringBuilder = new StringBuilder(sql); stringBuilder.append(&quot; order by &quot;); final Sort sort = pageable.getSort(); final List&lt;Sort.Order&gt; orders = sort.toList(); for (Sort.Order order : orders) &#123; stringBuilder.append(order.getProperty()) .append(&quot; &quot;) .append(order.getDirection().name()) .append(&quot;,&quot;); &#125; sql = stringBuilder.toString(); sql = sql.substring(0, sql.length() - 1); &#125; final Query nativeQuery = entityManager.createNativeQuery(sql); nativeQuery.setFirstResult(pageable.getPageNumber() * pageable.getPageSize()); nativeQuery.setMaxResults(pageable.getPageSize()); if (params != null &amp;&amp; params.length &gt; 0) &#123; for (int i = 0; i &lt; params.length; i++) &#123; nativeQuery.setParameter(i + 1, params[i]); &#125; &#125; List&lt;Map&gt; resultList = nativeQuery.unwrap(NativeQueryImpl.class) .setResultTransformer(Transformers.ALIAS_TO_ENTITY_MAP).getResultList(); final List&lt;E&gt; objectList = getJpaUtil().mapListToObjectList(resultList, clazz, basic); if (!StringUtils.hasText(countSql)) &#123; countSql = &quot;select count(*) from ( &quot; + sql + &quot; ) a&quot;; &#125; final BigInteger count = findBySqlFirst(countSql, BigInteger.class, true); Page&lt;E&gt; page = new PageImpl&lt;&gt;(objectList, pageable, count.longValue()); return page; &#125; @Override public &lt;E&gt; Page&lt;E&gt; findPageBySql(String sql, Pageable pageable, Class clazz, boolean basic, Map&lt;String, Object&gt; params) &#123; return findPageBySql(sql, null, pageable, clazz, basic, params); &#125; @Override public &lt;E&gt; Page&lt;E&gt; findPageBySql(String sql, String countSql, Pageable pageable, Class clazz, boolean basic, Map&lt;String, Object&gt; params) &#123; if (!sql.toLowerCase().contains(&quot;order by&quot;)) &#123; StringBuilder stringBuilder = new StringBuilder(sql); stringBuilder.append(&quot; order by &quot;); final Sort sort = pageable.getSort(); final List&lt;Sort.Order&gt; orders = sort.toList(); for (Sort.Order order : orders) &#123; stringBuilder.append(order.getProperty()) .append(&quot; &quot;) .append(order.getDirection().name()) .append(&quot;,&quot;); &#125; sql = stringBuilder.toString(); sql = sql.substring(0, sql.length() - 1); &#125; final Query nativeQuery = entityManager.createNativeQuery(sql); nativeQuery.setFirstResult(pageable.getPageNumber() * pageable.getPageSize()); nativeQuery.setMaxResults(pageable.getPageSize()); if (params != null &amp;&amp; params.size() &gt; 0) &#123; for (String key : params.keySet()) &#123; nativeQuery.setParameter(key, params.get(key)); &#125; &#125; List&lt;Map&gt; resultList = nativeQuery.unwrap(NativeQueryImpl.class) .setResultTransformer(Transformers.ALIAS_TO_ENTITY_MAP).getResultList(); final List&lt;E&gt; objectList = getJpaUtil().mapListToObjectList(resultList, clazz, basic); if (!StringUtils.hasText(countSql)) &#123; countSql = &quot;select count(*) from ( &quot; + sql + &quot; ) a&quot;; &#125; final BigInteger count = findBySqlFirst(countSql, BigInteger.class, true); Page&lt;E&gt; page = new PageImpl&lt;&gt;(objectList, pageable, count.longValue()); return page; &#125; @Override public Map findBySqlFirst(String sql) &#123; return findBySqlFirst(sql, new HashMap&lt;&gt;()); &#125; @Override public Map findBySqlFirst(String sql, Object[] params) &#123; Query nativeQuery = entityManager.createNativeQuery(sql); if (params != null &amp;&amp; params.length &gt; 0) &#123; for (int i = 0; i &lt; params.length; i++) &#123; nativeQuery.setParameter(i + 1, params[i]); &#125; &#125; final Optional first = nativeQuery.unwrap(NativeQueryImpl.class) .setResultTransformer(Transformers.ALIAS_TO_ENTITY_MAP) .stream().findFirst(); if (first.isPresent()) &#123; return (Map) first.get(); &#125; return null; &#125; @Override public Map findBySqlFirst(String sql, Map&lt;String, Object&gt; params) &#123; Query nativeQuery = entityManager.createNativeQuery(sql); if (params != null &amp;&amp; params.size() &gt; 0) &#123; for (String key : params.keySet()) &#123; nativeQuery.setParameter(key, params.get(key)); &#125; &#125; final Optional first = nativeQuery.unwrap(NativeQueryImpl.class) .setResultTransformer(Transformers.ALIAS_TO_ENTITY_MAP) .stream().findFirst(); if (first.isPresent()) &#123; return (Map) first.get(); &#125; return null; &#125; @Override public &lt;E&gt; E findBySqlFirst(String sql, Class clazz, boolean basic) &#123; return findBySqlFirst(sql, clazz, basic, new HashMap&lt;&gt;()); &#125; @Override public &lt;E&gt; E findBySqlFirst(String sql, Class clazz, boolean basic, Object[] params) &#123; return getJpaUtil().mapToObject(findBySqlFirst(sql, params), clazz, basic); &#125; @Override public &lt;E&gt; E findBySqlFirst(String sql, Class clazz, boolean basic, Map&lt;String, Object&gt; params) &#123; return getJpaUtil().mapToObject(findBySqlFirst(sql, params), clazz, basic); &#125; @Override public T findByIdNew(ID id) &#123; T t = null; Optional&lt;T&gt; optional = this.findById(id); if (optional.isPresent()) &#123; t = optional.get(); &#125; return t; &#125; @Override @Transactional public &lt;S extends T&gt; Iterable&lt;S&gt; batchSave(Iterable&lt;S&gt; iterable) &#123; Iterator&lt;S&gt; iterator = iterable.iterator(); int index = 0; while (iterator.hasNext()) &#123; entityManager.persist(iterator.next()); index++; if (index % BATCH_SIZE == 0) &#123; entityManager.flush(); entityManager.clear(); &#125; &#125; if (index % BATCH_SIZE != 0) &#123; entityManager.flush(); entityManager.clear(); &#125; return iterable; &#125; @Override @Transactional public &lt;S extends T&gt; Iterable&lt;S&gt; batchUpdate(Iterable&lt;S&gt; iterable) &#123; Iterator&lt;S&gt; iterator = iterable.iterator(); int index = 0; while (iterator.hasNext()) &#123; entityManager.merge(iterator.next()); index++; if (index % BATCH_SIZE == 0) &#123; entityManager.flush(); entityManager.clear(); &#125; &#125; if (index % BATCH_SIZE != 0) &#123; entityManager.flush(); entityManager.clear(); &#125; return iterable; &#125; private JpaUtil getJpaUtil() &#123; JpaUtil objectUtil = (JpaUtil) ApplicationContextProvider.getBean(&quot;jpaUtil&quot;); return objectUtil; &#125;&#125; 工具类JpaUtil 其功能就是将Map对象通过json转换成指定对象 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364package com.example.jpa;import com.fasterxml.jackson.core.JsonProcessingException;import com.fasterxml.jackson.databind.ObjectMapper;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.stereotype.Component;import java.util.ArrayList;import java.util.List;import java.util.Map;@Component(&quot;jpaUtil&quot;)public class JpaUtil &#123; @Autowired ObjectMapper objectMapper; /** * 查询结果为List&lt;Map&gt;时，可以通过该方法转换为对象List，注意Map中key要与对象属性匹配，或者对象属性标注了@JsonProperty */ public &lt;E&gt; List&lt;E&gt; mapListToObjectList(List&lt;Map&gt; mapList, Class clazz, boolean basic) &#123; List&lt;E&gt; list = new ArrayList&lt;&gt;(); for (Map map : mapList) &#123; if (basic) &#123; list.add((E) map.values().stream().findFirst().get()); &#125; else &#123; try &#123; final String valueAsString = objectMapper.writeValueAsString(map); E newInstance = (E) objectMapper.readValue(valueAsString, clazz); list.add(newInstance); &#125; catch (JsonProcessingException e) &#123; e.printStackTrace(); &#125; &#125; &#125; return list; &#125; /** * 查询结果为Map时，可以通过该方法转换为对象，注意Map中key要与对象属性匹配，或者对象属性标注了@JsonProperty */ public &lt;E&gt; E mapToObject(Map map, Class clazz, boolean basic) &#123; if(map == null)&#123; return null; &#125; E newInstance = null; //基本类型，说明返回值只有一列 if (basic) &#123; newInstance = (E) map.values().stream().findFirst().get(); &#125; else &#123; try &#123; final String valueAsString = objectMapper.writeValueAsString(map); newInstance = (E) objectMapper.readValue(valueAsString, clazz); &#125; catch (JsonProcessingException e) &#123; e.printStackTrace(); &#125; &#125; return newInstance; &#125;&#125; ApplicationContextProvider123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596package com.example.common.support;import org.springframework.beans.BeansException;import org.springframework.context.ApplicationContext;import org.springframework.context.ApplicationContextAware;import org.springframework.context.i18n.LocaleContextHolder;import org.springframework.stereotype.Component;@Componentpublic class ApplicationContextProvider implements ApplicationContextAware &#123; /** * 上下文对象实例 */ private static ApplicationContext applicationContext; /** * 获取applicationContext * * @return */ public static ApplicationContext getApplicationContext() &#123; return applicationContext; &#125; @Override public void setApplicationContext(ApplicationContext applicationContext) throws BeansException &#123; ApplicationContextProvider.applicationContext = applicationContext; &#125; /** * 通过name获取 Bean. * * @param name * @return */ public static Object getBean(String name) &#123; return getApplicationContext().getBean(name); &#125; /** * 通过class获取Bean. * * @param clazz * @param &lt;T&gt; * @return */ public static &lt;T&gt; T getBean(Class&lt;T&gt; clazz) &#123; return getApplicationContext().getBean(clazz); &#125; /** * 通过name,以及Clazz返回指定的Bean * * @param name * @param clazz * @param &lt;T&gt; * @return */ public static &lt;T&gt; T getBean(String name, Class&lt;T&gt; clazz) &#123; return getApplicationContext().getBean(name, clazz); &#125; /** * 描述 : &lt;获得多语言的资源内容&gt;. &lt;br&gt; * &lt;p&gt; * &lt;使用方法说明&gt; * &lt;/p&gt; * * @param code * @param args * @return */ public static String getMessage(String code, Object[] args) &#123; return getApplicationContext().getMessage(code, args, LocaleContextHolder.getLocale()); &#125; /** * 描述 : &lt;获得多语言的资源内容&gt;. &lt;br&gt; * &lt;p&gt; * &lt;使用方法说明&gt; * &lt;/p&gt; * * @param code * @param args * @param defaultMessage * @return */ public static String getMessage(String code, Object[] args, String defaultMessage) &#123; return getApplicationContext().getMessage(code, args, defaultMessage, LocaleContextHolder.getLocale()); &#125;&#125; 配置类上增加 @EnableJpaRepositories(repositoryBaseClass = BaseJpaRepositoryImpl.class)12345@Configuration@EnableJpaRepositories(repositoryBaseClass = BaseJpaRepositoryImpl.class, basePackages = &quot;com.example.demo&quot;)@EntityScan(basePackages = &quot;com.example.demo&quot;)public class JpaConfig &#123;&#125; 业务Jpa对象继承BaseJpaRepository123456789public interface CountryJpaRepository extends BaseJpaRepository&lt;Country, Long&gt; &#123; //这种SELECT * 的形式也可以转换成对象，但是如果只查询某几个属性时，就会转换失败 @Query(value = &quot;SELECT * FROM tbl_country&quot;, countQuery = &quot;SELECT count(*) FROM tbl_country&quot;, nativeQuery = true) Page&lt;Country&gt; findAll(Pageable pageable); //失败 @Query(value = &quot;SELECT id,name_zh FROM tbl_country WHERE name_zh = ?1&quot;,nativeQuery = true) Country findByName(String name);&#125; 示例123456789101112131415161718192021222324252627282930313233@GetMapping(&quot;/&quot;) public Map index() &#123; Map&lt;String, Object&gt; map = new HashMap&lt;&gt;(); //查询总数，注意count求和返回的对象是BigInteger类型 final BigInteger size = countryJpaRepository.findBySqlFirst(&quot;SELECT count(*) as count FROM tbl_country&quot;, BigInteger.class, true); map.put(&quot;size&quot;, size); //分页查询 Pageable pageable = PageRequest.of(1, 20, Sort.by(Sort.Direction.DESC, &quot;id&quot;).and(Sort.by(Sort.Direction.ASC, &quot;name_zh&quot;))); final Page&lt;Country&gt; pages = countryJpaRepository.findPageBySql(&quot;SELECT id,name_zh as nameZh ,name_en as nameEn FROM tbl_country&quot;, pageable, Country.class, false); map.put(&quot;pages&quot;, pages); //批量新增 List&lt;DemoEntity&gt; entityList = new ArrayList&lt;&gt;(); for (int i = 0; i &lt; 1000; i++) &#123; DemoEntity demoEntity = new DemoEntity(); demoEntity.setName(&quot;测试&quot; + i); demoEntity.initInsert(); entityList.add(demoEntity); &#125; demoEntityJpaRepository.batchSave(entityList); final Page&lt;DemoEntity&gt; demoEntities = demoEntityJpaRepository.findAll(PageRequest.of(1, 100, Sort.by(Sort.Direction.DESC, &quot;name&quot;))); //批量删除 demoEntityJpaRepository.deleteAllInBatch(demoEntities.getContent()); return map; &#125;","summary":"摘要 SpringBoot基于JPA的数据操作非常方便，我们只需继承JpaRepository就可以拥有强大的数据操控能力，但是偶尔我们需要进行复杂的操作，比如批量插入与更新，或者是复杂sql等等，此时就需要我们对JpaRepository进行一些扩展。 @Query注解也可以直接执行sql，但是其有一些局限，比如只有select * 时才能直接封装为对象，只查询部分属性时就只能封装为Object[]或Map。如果希望@Query查询部分属性时也可以直接转换为对象，可以查看下一篇内容 Spring Boot的@Query注解","date_published":"2021-09-06T12:33:15.000Z","tags":["技术","Java","springboot","Spring Boot"]},{"id":"https://blog.hanqunfeng.com/2021/06/24/rocketmq-docker/","url":"https://blog.hanqunfeng.com/2021/06/24/rocketmq-docker/","title":"RocketMQ Docker安装方式","content_html":"<h2 id=\"摘要\"><a href=\"#摘要\" class=\"headerlink\" title=\"摘要\"></a>摘要</h2><p>看完本文你将掌握如下知识点：</p>\n<ul>\n<li>docker[20.10.7]安装rocketmq[4.8.0]的方法</li>\n</ul>\n<span id=\"more\"></span>\n\n<h3 id=\"server-有日志目录映射\"><a href=\"#server-有日志目录映射\" class=\"headerlink\" title=\"server 有日志目录映射\"></a>server 有日志目录映射</h3><ul>\n<li>设置目录权限<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">chmod 777 $(pwd)/logs</span><br></pre></td></tr></table></figure></li>\n<li>启动<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run -d -v $(pwd)/logs:/home/rocketmq/logs \\</span><br><span class=\"line\">-v $(pwd)/logs:/home/rocketmq/logs \\</span><br><span class=\"line\">--name rmqnamesrv \\</span><br><span class=\"line\">-e &quot;JAVA_OPT_EXT=-Xms512M -Xmx512M -Xmn128m&quot; \\</span><br><span class=\"line\">-p 9876:9876 \\</span><br><span class=\"line\">foxiswho/rocketmq:4.8.0 \\</span><br><span class=\"line\">sh mqnamesrv</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"broker-目录映射\"><a href=\"#broker-目录映射\" class=\"headerlink\" title=\"broker 目录映射\"></a>broker 目录映射</h3><ul>\n<li><p>设置目录权限</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">chmod 777 $(pwd)/logs</span><br><span class=\"line\">chmod 777 $(pwd)/store</span><br><span class=\"line\">chmod 777 $(pwd)/conf</span><br></pre></td></tr></table></figure></li>\n<li><p>添加文件：$(pwd)/conf/broker.conf</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">brokerClusterName = DefaultCluster</span><br><span class=\"line\">brokerName = broker-a</span><br><span class=\"line\">brokerId = 0</span><br><span class=\"line\">deleteWhen = 04</span><br><span class=\"line\">fileReservedTime = 48</span><br><span class=\"line\">brokerRole = ASYNC_MASTER</span><br><span class=\"line\">flushDiskType = ASYNC_FLUSH</span><br><span class=\"line\">brokerIP1 = &#123;宿主机 IP&#125;</span><br></pre></td></tr></table></figure></li>\n<li><p>启动</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run -d</span><br><span class=\"line\">-v $(pwd)/logs:/home/rocketmq/logs</span><br><span class=\"line\">-v $(pwd)/store:/home/rocketmq/store \\</span><br><span class=\"line\">-v $(pwd)/conf:/home/rocketmq/conf \\</span><br><span class=\"line\">--name rmqbroker --link rmqnamesrv:rmqnamesrv \\</span><br><span class=\"line\">-e &quot;NAMESRV_ADDR=rmqnamesrv:9876&quot; \\</span><br><span class=\"line\">-e &quot;JAVA_OPT_EXT=-Xms512M -Xmx512M -Xmn128m&quot; \\</span><br><span class=\"line\">-p 10911:10911 -p 10912:10912 -p 10909:10909 \\</span><br><span class=\"line\">foxiswho/rocketmq:4.8.0 \\</span><br><span class=\"line\">sh mqbroker -c /home/rocketmq/conf/broker.conf</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"console\"><a href=\"#console\" class=\"headerlink\" title=\"console\"></a>console</h3><ul>\n<li><p>启动</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run --name rmqconsole --link rmqnamesrv:rmqnamesrv \\</span><br><span class=\"line\">-e &quot;JAVA_OPTS=-Drocketmq.namesrv.addr=rmqnamesrv:9876 -Dcom.rocketmq.sendMessageWithVIPChannel=false&quot; \\</span><br><span class=\"line\">-p 8180:8080 -t styletang/rocketmq-console-ng</span><br></pre></td></tr></table></figure></li>\n<li><p>访问地址<br><a href=\"http://localhost:8180/\">http://localhost:8180/</a></p>\n</li>\n</ul>\n","content_text":"摘要看完本文你将掌握如下知识点： docker[20.10.7]安装rocketmq[4.8.0]的方法 server 有日志目录映射 设置目录权限1chmod 777 $(pwd)/logs 启动1234567docker run -d -v $(pwd)/logs:/home/rocketmq/logs \\-v $(pwd)/logs:/home/rocketmq/logs \\--name rmqnamesrv \\-e &quot;JAVA_OPT_EXT=-Xms512M -Xmx512M -Xmn128m&quot; \\-p 9876:9876 \\foxiswho/rocketmq:4.8.0 \\sh mqnamesrv broker 目录映射 设置目录权限 123chmod 777 $(pwd)/logschmod 777 $(pwd)/storechmod 777 $(pwd)/conf 添加文件：$(pwd)/conf/broker.conf 12345678brokerClusterName = DefaultClusterbrokerName = broker-abrokerId = 0deleteWhen = 04fileReservedTime = 48brokerRole = ASYNC_MASTERflushDiskType = ASYNC_FLUSHbrokerIP1 = &#123;宿主机 IP&#125; 启动 12345678910docker run -d-v $(pwd)/logs:/home/rocketmq/logs-v $(pwd)/store:/home/rocketmq/store \\-v $(pwd)/conf:/home/rocketmq/conf \\--name rmqbroker --link rmqnamesrv:rmqnamesrv \\-e &quot;NAMESRV_ADDR=rmqnamesrv:9876&quot; \\-e &quot;JAVA_OPT_EXT=-Xms512M -Xmx512M -Xmn128m&quot; \\-p 10911:10911 -p 10912:10912 -p 10909:10909 \\foxiswho/rocketmq:4.8.0 \\sh mqbroker -c /home/rocketmq/conf/broker.conf console 启动 123docker run --name rmqconsole --link rmqnamesrv:rmqnamesrv \\-e &quot;JAVA_OPTS=-Drocketmq.namesrv.addr=rmqnamesrv:9876 -Dcom.rocketmq.sendMessageWithVIPChannel=false&quot; \\-p 8180:8080 -t styletang/rocketmq-console-ng 访问地址http://localhost:8180/","summary":"摘要看完本文你将掌握如下知识点： docker[20.10.7]安装rocketmq[4.8.0]的方法","date_published":"2021-06-24T10:24:04.000Z","tags":["技术","Docker","rocketmq","docker"]},{"id":"https://blog.hanqunfeng.com/2021/01/23/vimrc/","url":"https://blog.hanqunfeng.com/2021/01/23/vimrc/","title":"vim配置","content_html":"<h2 id=\"摘要\"><a href=\"#摘要\" class=\"headerlink\" title=\"摘要\"></a>摘要</h2><ul>\n<li>vim常用配置</li>\n<li>基于<a href=\"https://github.com/junegunn/vim-plug\">vim-plug</a>进行插件管理<span id=\"more\"></span></li>\n</ul>\n<h2 id=\"vimrc\"><a href=\"#vimrc\" class=\"headerlink\" title=\".vimrc\"></a>.vimrc</h2><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br><span class=\"line\">280</span><br><span class=\"line\">281</span><br><span class=\"line\">282</span><br><span class=\"line\">283</span><br><span class=\"line\">284</span><br><span class=\"line\">285</span><br><span class=\"line\">286</span><br><span class=\"line\">287</span><br><span class=\"line\">288</span><br><span class=\"line\">289</span><br><span class=\"line\">290</span><br><span class=\"line\">291</span><br><span class=\"line\">292</span><br><span class=\"line\">293</span><br><span class=\"line\">294</span><br><span class=\"line\">295</span><br><span class=\"line\">296</span><br><span class=\"line\">297</span><br><span class=\"line\">298</span><br><span class=\"line\">299</span><br><span class=\"line\">300</span><br><span class=\"line\">301</span><br><span class=\"line\">302</span><br><span class=\"line\">303</span><br><span class=\"line\">304</span><br><span class=\"line\">305</span><br><span class=\"line\">306</span><br><span class=\"line\">307</span><br><span class=\"line\">308</span><br><span class=\"line\">309</span><br><span class=\"line\">310</span><br><span class=\"line\">311</span><br><span class=\"line\">312</span><br><span class=\"line\">313</span><br><span class=\"line\">314</span><br><span class=\"line\">315</span><br><span class=\"line\">316</span><br><span class=\"line\">317</span><br><span class=\"line\">318</span><br><span class=\"line\">319</span><br><span class=\"line\">320</span><br><span class=\"line\">321</span><br><span class=\"line\">322</span><br><span class=\"line\">323</span><br><span class=\"line\">324</span><br><span class=\"line\">325</span><br><span class=\"line\">326</span><br><span class=\"line\">327</span><br><span class=\"line\">328</span><br><span class=\"line\">329</span><br><span class=\"line\">330</span><br><span class=\"line\">331</span><br><span class=\"line\">332</span><br><span class=\"line\">333</span><br><span class=\"line\">334</span><br><span class=\"line\">335</span><br><span class=\"line\">336</span><br><span class=\"line\">337</span><br><span class=\"line\">338</span><br><span class=\"line\">339</span><br><span class=\"line\">340</span><br><span class=\"line\">341</span><br><span class=\"line\">342</span><br><span class=\"line\">343</span><br><span class=\"line\">344</span><br><span class=\"line\">345</span><br><span class=\"line\">346</span><br><span class=\"line\">347</span><br><span class=\"line\">348</span><br><span class=\"line\">349</span><br><span class=\"line\">350</span><br><span class=\"line\">351</span><br><span class=\"line\">352</span><br><span class=\"line\">353</span><br><span class=\"line\">354</span><br><span class=\"line\">355</span><br><span class=\"line\">356</span><br><span class=\"line\">357</span><br><span class=\"line\">358</span><br><span class=\"line\">359</span><br><span class=\"line\">360</span><br><span class=\"line\">361</span><br><span class=\"line\">362</span><br><span class=\"line\">363</span><br><span class=\"line\">364</span><br><span class=\"line\">365</span><br><span class=\"line\">366</span><br><span class=\"line\">367</span><br><span class=\"line\">368</span><br><span class=\"line\">369</span><br><span class=\"line\">370</span><br><span class=\"line\">371</span><br><span class=\"line\">372</span><br><span class=\"line\">373</span><br><span class=\"line\">374</span><br><span class=\"line\">375</span><br><span class=\"line\">376</span><br><span class=\"line\">377</span><br><span class=\"line\">378</span><br><span class=\"line\">379</span><br><span class=\"line\">380</span><br><span class=\"line\">381</span><br><span class=\"line\">382</span><br><span class=\"line\">383</span><br><span class=\"line\">384</span><br><span class=\"line\">385</span><br><span class=\"line\">386</span><br><span class=\"line\">387</span><br><span class=\"line\">388</span><br><span class=\"line\">389</span><br><span class=\"line\">390</span><br><span class=\"line\">391</span><br><span class=\"line\">392</span><br><span class=\"line\">393</span><br><span class=\"line\">394</span><br><span class=\"line\">395</span><br><span class=\"line\">396</span><br><span class=\"line\">397</span><br><span class=\"line\">398</span><br><span class=\"line\">399</span><br><span class=\"line\">400</span><br><span class=\"line\">401</span><br><span class=\"line\">402</span><br><span class=\"line\">403</span><br><span class=\"line\">404</span><br><span class=\"line\">405</span><br><span class=\"line\">406</span><br><span class=\"line\">407</span><br><span class=\"line\">408</span><br><span class=\"line\">409</span><br><span class=\"line\">410</span><br><span class=\"line\">411</span><br><span class=\"line\">412</span><br><span class=\"line\">413</span><br><span class=\"line\">414</span><br><span class=\"line\">415</span><br><span class=\"line\">416</span><br><span class=\"line\">417</span><br><span class=\"line\">418</span><br><span class=\"line\">419</span><br><span class=\"line\">420</span><br><span class=\"line\">421</span><br><span class=\"line\">422</span><br><span class=\"line\">423</span><br><span class=\"line\">424</span><br><span class=\"line\">425</span><br><span class=\"line\">426</span><br><span class=\"line\">427</span><br><span class=\"line\">428</span><br><span class=\"line\">429</span><br><span class=\"line\">430</span><br><span class=\"line\">431</span><br><span class=\"line\">432</span><br><span class=\"line\">433</span><br><span class=\"line\">434</span><br><span class=\"line\">435</span><br><span class=\"line\">436</span><br><span class=\"line\">437</span><br><span class=\"line\">438</span><br><span class=\"line\">439</span><br><span class=\"line\">440</span><br><span class=\"line\">441</span><br><span class=\"line\">442</span><br><span class=\"line\">443</span><br><span class=\"line\">444</span><br><span class=\"line\">445</span><br><span class=\"line\">446</span><br><span class=\"line\">447</span><br><span class=\"line\">448</span><br><span class=\"line\">449</span><br><span class=\"line\">450</span><br><span class=\"line\">451</span><br><span class=\"line\">452</span><br><span class=\"line\">453</span><br><span class=\"line\">454</span><br><span class=\"line\">455</span><br><span class=\"line\">456</span><br><span class=\"line\">457</span><br><span class=\"line\">458</span><br><span class=\"line\">459</span><br><span class=\"line\">460</span><br><span class=\"line\">461</span><br><span class=\"line\">462</span><br><span class=\"line\">463</span><br><span class=\"line\">464</span><br><span class=\"line\">465</span><br><span class=\"line\">466</span><br><span class=\"line\">467</span><br><span class=\"line\">468</span><br><span class=\"line\">469</span><br><span class=\"line\">470</span><br><span class=\"line\">471</span><br><span class=\"line\">472</span><br><span class=\"line\">473</span><br><span class=\"line\">474</span><br><span class=\"line\">475</span><br><span class=\"line\">476</span><br><span class=\"line\">477</span><br><span class=\"line\">478</span><br><span class=\"line\">479</span><br><span class=\"line\">480</span><br><span class=\"line\">481</span><br><span class=\"line\">482</span><br><span class=\"line\">483</span><br><span class=\"line\">484</span><br><span class=\"line\">485</span><br><span class=\"line\">486</span><br><span class=\"line\">487</span><br><span class=\"line\">488</span><br><span class=\"line\">489</span><br><span class=\"line\">490</span><br><span class=\"line\">491</span><br><span class=\"line\">492</span><br><span class=\"line\">493</span><br><span class=\"line\">494</span><br><span class=\"line\">495</span><br><span class=\"line\">496</span><br><span class=\"line\">497</span><br><span class=\"line\">498</span><br><span class=\"line\">499</span><br><span class=\"line\">500</span><br><span class=\"line\">501</span><br><span class=\"line\">502</span><br><span class=\"line\">503</span><br><span class=\"line\">504</span><br><span class=\"line\">505</span><br><span class=\"line\">506</span><br><span class=\"line\">507</span><br><span class=\"line\">508</span><br><span class=\"line\">509</span><br><span class=\"line\">510</span><br><span class=\"line\">511</span><br><span class=\"line\">512</span><br><span class=\"line\">513</span><br><span class=\"line\">514</span><br><span class=\"line\">515</span><br><span class=\"line\">516</span><br><span class=\"line\">517</span><br><span class=\"line\">518</span><br><span class=\"line\">519</span><br><span class=\"line\">520</span><br><span class=\"line\">521</span><br><span class=\"line\">522</span><br><span class=\"line\">523</span><br><span class=\"line\">524</span><br><span class=\"line\">525</span><br><span class=\"line\">526</span><br><span class=\"line\">527</span><br><span class=\"line\">528</span><br><span class=\"line\">529</span><br><span class=\"line\">530</span><br><span class=\"line\">531</span><br><span class=\"line\">532</span><br><span class=\"line\">533</span><br><span class=\"line\">534</span><br><span class=\"line\">535</span><br><span class=\"line\">536</span><br><span class=\"line\">537</span><br><span class=\"line\">538</span><br><span class=\"line\">539</span><br><span class=\"line\">540</span><br><span class=\"line\">541</span><br><span class=\"line\">542</span><br><span class=\"line\">543</span><br><span class=\"line\">544</span><br><span class=\"line\">545</span><br><span class=\"line\">546</span><br><span class=\"line\">547</span><br><span class=\"line\">548</span><br><span class=\"line\">549</span><br><span class=\"line\">550</span><br><span class=\"line\">551</span><br><span class=\"line\">552</span><br><span class=\"line\">553</span><br><span class=\"line\">554</span><br><span class=\"line\">555</span><br><span class=\"line\">556</span><br><span class=\"line\">557</span><br><span class=\"line\">558</span><br><span class=\"line\">559</span><br><span class=\"line\">560</span><br><span class=\"line\">561</span><br><span class=\"line\">562</span><br><span class=\"line\">563</span><br><span class=\"line\">564</span><br><span class=\"line\">565</span><br><span class=\"line\">566</span><br><span class=\"line\">567</span><br><span class=\"line\">568</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&quot; =============================================================</span></span><br><span class=\"line\"><span class=\"comment\">&quot; :set all  查看所有可以设置的命令</span></span><br><span class=\"line\"><span class=\"comment\">&quot; :set command?  查看该命令当前状态，比如:set nu?</span></span><br><span class=\"line\"><span class=\"comment\">&quot;</span></span><br><span class=\"line\"><span class=\"comment\">&quot; :map      查看所有键盘映射，参考：http://yyq123.github.io/learn-vim/learn-vi-51-KeyMapping.html</span></span><br><span class=\"line\"><span class=\"comment\">&quot; :autocmd  查看所有自动命令，参考：http://yyq123.github.io/learn-vim/learn-vi-49-01-autocmd.html</span></span><br><span class=\"line\"><span class=\"comment\">&quot; =============================================================</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&quot; 开启行号</span></span><br><span class=\"line\"><span class=\"keyword\">set</span> <span class=\"keyword\">nu</span></span><br><span class=\"line\"><span class=\"comment\">&quot; 语法高亮</span></span><br><span class=\"line\"><span class=\"keyword\">syntax</span> <span class=\"keyword\">on</span></span><br><span class=\"line\"><span class=\"comment\">&quot; 设置自动缩进的宽度为4个空格</span></span><br><span class=\"line\"><span class=\"keyword\">set</span> <span class=\"keyword\">ts</span>=<span class=\"number\">4</span></span><br><span class=\"line\"><span class=\"keyword\">set</span> <span class=\"keyword\">sw</span>=<span class=\"number\">4</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&quot; 设置vim编码，默认就是utf-8</span></span><br><span class=\"line\"><span class=\"keyword\">set</span> encoding=utf-<span class=\"number\">8</span></span><br><span class=\"line\"><span class=\"comment\">&quot; 设置vim自动识别的文件编码列表，按顺序进行匹配</span></span><br><span class=\"line\"><span class=\"keyword\">set</span> fileencodings=utf-<span class=\"number\">8</span>,ucs-bom,shift-jis,gb18030,gbk,gb2312,cp936,utf-<span class=\"number\">16</span>,big5,euc-jp,latin1</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&quot; 搜索时忽略大小写，默认是精确匹配，noignorecase</span></span><br><span class=\"line\"><span class=\"comment\">&quot; 如果想在搜索时精确匹配，可以加上&#x27;\\C&#x27;前缀，比如搜索plug，:/\\Cplug</span></span><br><span class=\"line\"><span class=\"comment\">&quot; &#x27;\\c&#x27;就是忽略大小写</span></span><br><span class=\"line\"><span class=\"keyword\">set</span> ignorecase</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&quot; =============================================================</span></span><br><span class=\"line\"><span class=\"comment\">&quot; 翻页</span></span><br><span class=\"line\"><span class=\"comment\">&quot; Ctrl + f         向下翻整页</span></span><br><span class=\"line\"><span class=\"comment\">&quot; Ctrl + b         向上翻整页</span></span><br><span class=\"line\"><span class=\"comment\">&quot;</span></span><br><span class=\"line\"><span class=\"comment\">&quot; Ctrl + d         向下翻半页</span></span><br><span class=\"line\"><span class=\"comment\">&quot; Ctrl + u         向上翻半页</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&quot; =============================================================</span></span><br><span class=\"line\"><span class=\"comment\">&quot; 窗口</span></span><br><span class=\"line\"><span class=\"comment\">&quot; Ctrl + w + w          光标在 nerdtree 和 vim 编辑窗口 之间切换</span></span><br><span class=\"line\"><span class=\"comment\">&quot; Ctrl + w + (h/j/k/l)  即h左、j下、k上、l右，表示窗口切换的方向</span></span><br><span class=\"line\"><span class=\"comment\">&quot; Ctrl + w + n          新建水平窗口并开始编辑新文件，上方</span></span><br><span class=\"line\"><span class=\"comment\">&quot; :vnew                 新建垂直窗口并开始编辑新文件，右侧</span></span><br><span class=\"line\"><span class=\"comment\">&quot; Ctrl + w + s          新建水平窗口并显示当前文件，右侧</span></span><br><span class=\"line\"><span class=\"comment\">&quot; Ctrl + w + v          新建垂直窗口并显示当前文件，上方</span></span><br><span class=\"line\"><span class=\"comment\">&quot; :term                 新建终端窗口，上方，关闭使用exit</span></span><br><span class=\"line\"><span class=\"comment\">&quot;</span></span><br><span class=\"line\"><span class=\"comment\">&quot; vim -o file1 file2 file3   水平分割窗口</span></span><br><span class=\"line\"><span class=\"comment\">&quot; vim -O file1 file2 file3   垂直分割窗口</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&quot; =============================================================</span></span><br><span class=\"line\"><span class=\"comment\">&quot; Tab页，标签页，注意：tab不适buffer</span></span><br><span class=\"line\"><span class=\"comment\">&quot; :tabnew               新建tab页，打开一个新的为文件</span></span><br><span class=\"line\"><span class=\"comment\">&quot; :tabedit file         新建tab页，打开指定的文件</span></span><br><span class=\"line\"><span class=\"comment\">&quot; gt/gT                 向后/向前切换tab页，可以循环</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&quot; =============================================================</span></span><br><span class=\"line\"><span class=\"comment\">&quot;</span></span><br><span class=\"line\"><span class=\"comment\">&quot; 标记marks</span></span><br><span class=\"line\"><span class=\"comment\">&quot; :marks         查看全部可以跳转到的标记</span></span><br><span class=\"line\"><span class=\"comment\">&quot; 快捷键：m/     这个快捷键只会列出当前文件的标记</span></span><br><span class=\"line\"><span class=\"comment\">&quot;</span></span><br><span class=\"line\"><span class=\"comment\">&quot; 为当前行添加一个标记: 同一行可以添加多个标记</span></span><br><span class=\"line\"><span class=\"comment\">&quot; m+英文字母</span></span><br><span class=\"line\"><span class=\"comment\">&quot; 小写字母只能在当前文件内部跳转，大写字母可以在其它文件中跳转，如：ma，mA</span></span><br><span class=\"line\"><span class=\"comment\">&quot;</span></span><br><span class=\"line\"><span class=\"comment\">&quot; 跳转到指定标记:</span></span><br><span class=\"line\"><span class=\"comment\">&quot; &#x27;+英文字母     移动到标记的文本行首，如：&#x27;a，&#x27;A</span></span><br><span class=\"line\"><span class=\"comment\">&quot; `+英文字母     移动到标记的光标位置，如：`a，`A</span></span><br><span class=\"line\"><span class=\"comment\">&quot;</span></span><br><span class=\"line\"><span class=\"comment\">&quot; 删除标记:</span></span><br><span class=\"line\"><span class=\"comment\">&quot; :delmarks a A  删除一个或多个指定标记，快捷键：dmx :x is a-zA-Z</span></span><br><span class=\"line\"><span class=\"comment\">&quot; :delmarks!     删除所有标记    快捷键：m&lt;Space&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&quot; =============================================================</span></span><br><span class=\"line\"><span class=\"comment\">&quot; 不生产wrap文件,warp文件是vim意外退出时用于恢复文件时使用的</span></span><br><span class=\"line\"><span class=\"comment\">&quot; set nowrap</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&quot; 不生产备份文件</span></span><br><span class=\"line\"><span class=\"comment\">&quot; set nobackup</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&quot; =============================================================</span></span><br><span class=\"line\"><span class=\"comment\">&quot; 快速跳转到指定行</span></span><br><span class=\"line\"><span class=\"comment\">&quot; 1.查看模式下numgg，比如30gg，跳转到30行</span></span><br><span class=\"line\"><span class=\"comment\">&quot; 2.命令行模式下:num，比如:30，跳转到30行</span></span><br><span class=\"line\"><span class=\"comment\">&quot; =============================================================</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&quot; 撤销：u       :undo</span></span><br><span class=\"line\"><span class=\"comment\">&quot; 恢复：ctrl-r  :redo</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&quot; =============================================================</span></span><br><span class=\"line\"><span class=\"comment\">&quot; 命令行模式下，通过上下方向键就可以显示历史命令</span></span><br><span class=\"line\"><span class=\"comment\">&quot; 命令行模式下，ctrl-f，会打开历史命令窗口，上下方向键选择</span></span><br><span class=\"line\"><span class=\"comment\">&quot; 普通模式下，q: ，也可以打开历史命令窗口</span></span><br><span class=\"line\"><span class=\"comment\">&quot; 打开历史命令行窗口后，可以像在普通窗口一样键入&#x27;\\key&#x27;进行关键字搜索</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&quot; =============================================================</span></span><br><span class=\"line\"><span class=\"comment\">&quot; 大小写转换:</span></span><br><span class=\"line\"><span class=\"comment\">&quot; gUU：将整行转换为大写</span></span><br><span class=\"line\"><span class=\"comment\">&quot; guu：将整行转换为小写</span></span><br><span class=\"line\"><span class=\"comment\">&quot;</span></span><br><span class=\"line\"><span class=\"comment\">&quot; v模式下，选择要转换的字符，然后按 ~，则会进行大小写间的转换</span></span><br><span class=\"line\"><span class=\"comment\">&quot; 这里要注意，~ 转换时，原先是大写就转小写，小写就转大写，</span></span><br><span class=\"line\"><span class=\"comment\">&quot; 所以如果单词中是大小写混合时，要全部转为大写或小写可以使用：U(大写)、u(小写)</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&quot;==============================================================</span></span><br><span class=\"line\"><span class=\"comment\">&quot; 代码格式化整个文档：</span></span><br><span class=\"line\"><span class=\"comment\">&quot; (1) 按两下小写g，即gg，定位光标到第一行。</span></span><br><span class=\"line\"><span class=\"comment\">&quot; (2) 按住Shift+v，即大写V，进入可视化编辑的行编辑模式。</span></span><br><span class=\"line\"><span class=\"comment\">&quot; (3) Shift+g，即大写G，选中整个代码。</span></span><br><span class=\"line\"><span class=\"comment\">&quot; (4) 按下等号=，格式化所有代码。</span></span><br><span class=\"line\"><span class=\"comment\">&quot;</span></span><br><span class=\"line\"><span class=\"comment\">&quot; 也可以在normal模式下，连续输入 gg=G ，也可以格式化整个文档</span></span><br><span class=\"line\"><span class=\"comment\">&quot;</span></span><br><span class=\"line\"><span class=\"comment\">&quot; 代码格式化部分行：</span></span><br><span class=\"line\"><span class=\"comment\">&quot; (1) 光标定位到开始的行；</span></span><br><span class=\"line\"><span class=\"comment\">&quot; (2) 按住Shift+v，即大写V，进入可视化编辑的行编辑模式。</span></span><br><span class=\"line\"><span class=\"comment\">&quot; (3) 按向下方向键选择要参与格式化的行。</span></span><br><span class=\"line\"><span class=\"comment\">&quot; (4) 按下等号=，格式化所选行代码。</span></span><br><span class=\"line\"><span class=\"comment\">&quot;</span></span><br><span class=\"line\"><span class=\"comment\">&quot; 也可以在normal模式下，连续输入 5gg=8G ，也可以格式化5~8行的文档</span></span><br><span class=\"line\"><span class=\"comment\">&quot;==============================================================</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&quot; 当我们并不知道确切的命令名称时，可以只输入开头的几个字母，然后按下Tab键，就将在底部显示可能匹配的命令。</span></span><br><span class=\"line\"><span class=\"comment\">&quot; 继续按Tab键，可以在这些命令列表间移动，左右方向键也可以移动，没有找到命令时可以按esc退出选择窗口</span></span><br><span class=\"line\"><span class=\"keyword\">set</span> wildmenu</span><br><span class=\"line\"><span class=\"comment\">&quot; 第一次按tab键时会先打印所有匹配的命令名称，再次按tab才会在命令中进行</span></span><br><span class=\"line\"><span class=\"keyword\">set</span> wildmode=lis<span class=\"variable\">t:longest</span>,full</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&quot; autocmd 自动执行指令，参考：http://yyq123.github.io/learn-vim/learn-vi-49-01-autocmd.html</span></span><br><span class=\"line\"><span class=\"comment\">&quot; 快速跳转到上次退出时光标所在行: &#x27;0 不好用啊，会打开buffer</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> <span class=\"built_in\">has</span>(<span class=\"string\">&quot;autocmd&quot;</span>)</span><br><span class=\"line\">  <span class=\"comment\">&quot; autocmd可以简写为au</span></span><br><span class=\"line\">  <span class=\"keyword\">au</span> BufReadPost * <span class=\"keyword\">if</span> <span class=\"built_in\">line</span>(<span class=\"string\">&quot;&#x27;\\&quot;&quot;</span>) &gt; <span class=\"number\">1</span> &amp;&amp; <span class=\"built_in\">line</span>(<span class=\"string\">&quot;&#x27;\\&quot;&quot;</span>) &lt;= <span class=\"built_in\">line</span>(<span class=\"string\">&quot;$&quot;</span>) | <span class=\"keyword\">exe</span> <span class=\"string\">&quot;normal! g&#x27;\\&quot;&quot;</span> | <span class=\"keyword\">endif</span></span><br><span class=\"line\"><span class=\"keyword\">endif</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&quot; 查看用&lt;&gt;括起来的快捷键的含义  :help keycodes</span></span><br><span class=\"line\"><span class=\"keyword\">nmap</span> <span class=\"symbol\">&lt;leader&gt;</span>kk :<span class=\"keyword\">help</span> keycodes<span class=\"symbol\">&lt;CR&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&quot; 设置&lt;leader&gt;的字符，默认为: \\</span></span><br><span class=\"line\"><span class=\"string\">&quot; let mapleader=&quot;</span>,<span class=\"comment\">&quot;</span></span><br><span class=\"line\"><span class=\"comment\">&quot; 按\\w保存文件</span></span><br><span class=\"line\"><span class=\"keyword\">nmap</span> <span class=\"symbol\">&lt;leader&gt;</span><span class=\"keyword\">w</span> :<span class=\"keyword\">w</span><span class=\"symbol\">&lt;CR&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&quot; 按\\wq保存退出</span></span><br><span class=\"line\"><span class=\"keyword\">nmap</span> <span class=\"symbol\">&lt;leader&gt;</span><span class=\"keyword\">wq</span> :<span class=\"keyword\">wq</span><span class=\"symbol\">&lt;CR&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&quot; 按\\qq不保存退出</span></span><br><span class=\"line\"><span class=\"keyword\">nmap</span> <span class=\"symbol\">&lt;leader&gt;</span>qq :q!<span class=\"symbol\">&lt;CR&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&quot; \\ev，在新tab中打开vimrc配置文件，按\\tn在多个tab中切换,按\\tc关闭当前tab</span></span><br><span class=\"line\"><span class=\"keyword\">nmap</span> <span class=\"symbol\">&lt;leader&gt;</span>ev :<span class=\"keyword\">tabe</span><span class=\"symbol\">&lt;Space&gt;</span>$MYVIMRC<span class=\"symbol\">&lt;CR&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&quot; 让配置变更保存时就立即生效，:w，这里只针对.vimrc文件保存时生效，其它文件需要重新打开才生效</span></span><br><span class=\"line\"><span class=\"keyword\">autocmd</span> BufWritePost $MYVIMRC <span class=\"keyword\">source</span> $MYVIMRC</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&quot;高亮显示当前行</span></span><br><span class=\"line\"><span class=\"keyword\">set</span> cursorline</span><br><span class=\"line\"><span class=\"comment\">&quot;高亮显示当前列</span></span><br><span class=\"line\"><span class=\"keyword\">set</span> cursorcolumn</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&quot; 颜色模式</span></span><br><span class=\"line\"><span class=\"comment\">&quot;https://github.com/tomasr/molokai</span></span><br><span class=\"line\"><span class=\"keyword\">colorscheme</span> molokai</span><br><span class=\"line\"><span class=\"comment\">&quot;-----------------molokai setting---------</span></span><br><span class=\"line\"><span class=\"keyword\">let</span> <span class=\"variable\">g:molokai_original</span> = <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"keyword\">let</span> <span class=\"variable\">g:rehash256</span> = <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"comment\">&quot;-----------------------------------------</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&quot;https://github.com/altercation/vim-colors-solarized</span></span><br><span class=\"line\"><span class=\"comment\">&quot;colorscheme solarized</span></span><br><span class=\"line\"><span class=\"comment\">&quot;--------------solarizded setting---------</span></span><br><span class=\"line\"><span class=\"comment\">&quot; 使用 termnal 背景</span></span><br><span class=\"line\"><span class=\"comment\">&quot;let g:solarized_termtrans  = 1</span></span><br><span class=\"line\"><span class=\"comment\">&quot;let g:solarized_termcolors=256</span></span><br><span class=\"line\"><span class=\"comment\">&quot; 使用 :set list 显示特殊字符时的高亮级别</span></span><br><span class=\"line\"><span class=\"comment\">&quot;let g:solarized_visibility = &#x27;high&#x27;</span></span><br><span class=\"line\"><span class=\"comment\">&quot;-----------------------------------------</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&quot;https://github.com/morhetz/gruvbox</span></span><br><span class=\"line\"><span class=\"comment\">&quot;colorscheme gruvbox</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&quot;https://github.com/rakr/vim-one</span></span><br><span class=\"line\"><span class=\"comment\">&quot;colorscheme one</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&quot;macos 自带</span></span><br><span class=\"line\"><span class=\"comment\">&quot; colorscheme desert</span></span><br><span class=\"line\"><span class=\"comment\">&quot;colorscheme pablo</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">set</span> background=dark</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&quot; 高亮搜索结果</span></span><br><span class=\"line\"><span class=\"keyword\">set</span> hlsearch</span><br><span class=\"line\"><span class=\"comment\">&quot;取消搜索后高亮 &lt;silent&gt;表示静默执行，就是不打印命令</span></span><br><span class=\"line\"><span class=\"keyword\">nnoremap</span> <span class=\"symbol\">&lt;silent&gt;</span><span class=\"symbol\">&lt;leader&gt;</span>h :<span class=\"keyword\">noh</span><span class=\"symbol\">&lt;CR&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&quot; 取消自动折行，一行内容超出屏幕时不进行折行显示</span></span><br><span class=\"line\"><span class=\"keyword\">set</span> nowrap</span><br><span class=\"line\"><span class=\"comment\">&quot; set wrap</span></span><br><span class=\"line\"><span class=\"comment\">&quot; 一行内容超出屏幕时，实现更加平滑的逐个字符扩展显示</span></span><br><span class=\"line\"><span class=\"keyword\">set</span> sidescroll=<span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&quot; 解决插入模式下delete/backspce键失效问题</span></span><br><span class=\"line\"><span class=\"comment\">&quot; https://www.cnblogs.com/shengulong/p/10530188.html</span></span><br><span class=\"line\"><span class=\"keyword\">set</span> backspace=<span class=\"number\">2</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&quot; 括号和引号的自动补全</span></span><br><span class=\"line\"><span class=\"keyword\">inoremap</span> ( ()<span class=\"symbol\">&lt;ESC&gt;</span>i</span><br><span class=\"line\"><span class=\"keyword\">inoremap</span> [ []<span class=\"symbol\">&lt;ESC&gt;</span>i</span><br><span class=\"line\"><span class=\"keyword\">inoremap</span> &#123; &#123;&#125;<span class=\"symbol\">&lt;ESC&gt;</span>i</span><br><span class=\"line\"><span class=\"keyword\">inoremap</span> <span class=\"string\">&#x27; &#x27;</span><span class=\"string\">&#x27;&lt;ESC&gt;i</span></span><br><span class=\"line\"><span class=\"string\">inoremap &quot; &quot;&quot;&lt;ESC&gt;i</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">&quot; 针对不同的文件类型采用不同的缩进格式</span></span><br><span class=\"line\"><span class=\"string\">filetype indent on</span></span><br><span class=\"line\"><span class=\"string\">&quot; 针对不同的文件类型加载对应的插件</span></span><br><span class=\"line\"><span class=\"string\">filetype plugin on</span></span><br><span class=\"line\"><span class=\"string\">&quot; 启用自动补全</span></span><br><span class=\"line\"><span class=\"string\">&quot;filetype plugin indent on</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">&quot; set rtp+=/usr/local/opt/fzf</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">&quot;---------------------------------vim-plug setting------------------------------</span></span><br><span class=\"line\"><span class=\"string\">&quot; vim-plug插件管理器的声明及配置，具体配置参考： https://github.com/junegunn/vim-plug</span></span><br><span class=\"line\"><span class=\"string\">call plug#begin(&#x27;</span>~/.<span class=\"keyword\">vim</span>/plugged<span class=\"string\">&#x27;)</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">&quot; If installed using Homebrew</span></span><br><span class=\"line\"><span class=\"string\">&quot; 文件搜索</span></span><br><span class=\"line\"><span class=\"string\">Plug &#x27;</span>/usr/local/<span class=\"keyword\">opt</span>/fzf<span class=\"string\">&#x27;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">&quot; https://github.com/junegunn/vim-easy-align</span></span><br><span class=\"line\"><span class=\"string\">&quot; 文本对其</span></span><br><span class=\"line\"><span class=\"string\">Plug &#x27;</span>junegunn/<span class=\"keyword\">vim</span>-easy-align<span class=\"string\">&#x27;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">&quot; https://github.com/vim-airline/vim-airline</span></span><br><span class=\"line\"><span class=\"string\">&quot; 状态栏设置</span></span><br><span class=\"line\"><span class=\"string\">Plug &#x27;</span><span class=\"keyword\">vim</span>-airline/<span class=\"keyword\">vim</span>-airline<span class=\"string\">&#x27;</span></span><br><span class=\"line\"><span class=\"string\">&quot; Plug &#x27;</span><span class=\"keyword\">vim</span>-airline/<span class=\"keyword\">vim</span>-airline-themes<span class=\"string\">&#x27;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">&quot; https://github.com/ycm-core/YouCompleteMe#installation</span></span><br><span class=\"line\"><span class=\"string\">&quot; 代码提示</span></span><br><span class=\"line\"><span class=\"string\">Plug &#x27;</span>Valloric/YouCompleteMe<span class=\"string\">&#x27;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">&quot;https://github.com/preservim/nerdtree</span></span><br><span class=\"line\"><span class=\"string\">&quot;目录树</span></span><br><span class=\"line\"><span class=\"string\">Plug &#x27;</span>preservim/nerdtree<span class=\"string\">&#x27;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">&quot;https://github.com/preservim/tagbar</span></span><br><span class=\"line\"><span class=\"string\">&quot;将当前文件的内容分类展示，比如java代码中的package\\method\\field等等</span></span><br><span class=\"line\"><span class=\"string\">Plug &#x27;</span>preservim/tagbar<span class=\"string\">&#x27;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">&quot;https://github.com/SirVer/ultisnips</span></span><br><span class=\"line\"><span class=\"string\">&quot;代码片段补全</span></span><br><span class=\"line\"><span class=\"string\">Plug &#x27;</span>SirVer/ultisnips<span class=\"string\">&#x27;</span></span><br><span class=\"line\"><span class=\"string\">&quot; 网友贡献的补全片段</span></span><br><span class=\"line\"><span class=\"string\">Plug &#x27;</span>honza/<span class=\"keyword\">vim</span>-snippets<span class=\"string\">&#x27;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">&quot;https://github.com/preservim/nerdcommenter</span></span><br><span class=\"line\"><span class=\"string\">&quot;注释插件</span></span><br><span class=\"line\"><span class=\"string\">Plug &#x27;</span>preservim/nerdcommenter<span class=\"string\">&#x27;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">&quot;https://github.com/tpope/vim-surround</span></span><br><span class=\"line\"><span class=\"string\">&quot;引号、括号等的替换和删除</span></span><br><span class=\"line\"><span class=\"string\">Plug &#x27;</span>tpope/<span class=\"keyword\">vim</span>-surround<span class=\"string\">&#x27;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">&quot; https://github.com/mhinz/vim-signify</span></span><br><span class=\"line\"><span class=\"string\">&quot; svn\\git插件，修改文件时状态栏会有记录</span></span><br><span class=\"line\"><span class=\"string\">if has(&#x27;</span>nvim<span class=\"string\">&#x27;) || has(&#x27;</span>patch-<span class=\"number\">8.0</span>.<span class=\"number\">902</span><span class=\"string\">&#x27;)</span></span><br><span class=\"line\"><span class=\"string\">  Plug &#x27;</span>mhinz/<span class=\"keyword\">vim</span>-signify<span class=\"string\">&#x27;</span></span><br><span class=\"line\"><span class=\"string\">else</span></span><br><span class=\"line\"><span class=\"string\">  Plug &#x27;</span>mhinz/<span class=\"keyword\">vim</span>-signify<span class=\"string\">&#x27;, &#123; &#x27;</span>branch<span class=\"string\">&#x27;: &#x27;</span>legacy<span class=\"string\">&#x27; &#125;</span></span><br><span class=\"line\"><span class=\"string\">endif</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">&quot; https://github.com/kshenoy/vim-signature</span></span><br><span class=\"line\"><span class=\"string\">&quot; 窗口左侧显示标记</span></span><br><span class=\"line\"><span class=\"string\">Plug &#x27;</span>kshenoy/<span class=\"keyword\">vim</span>-signature<span class=\"string\">&#x27;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">call plug#end()</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">&quot;---------------------------------vim-plug setting------------------------------</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">&quot;###############以下是单个插件的特殊配置项#########################&quot;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">&quot;----------------------vim-easy-align setting--------------------</span></span><br><span class=\"line\"><span class=\"string\">&quot; Start interactive EasyAlign in visual mode (e.g. vipga)</span></span><br><span class=\"line\"><span class=\"string\">&quot; vipga</span></span><br><span class=\"line\"><span class=\"string\">xmap ga &lt;Plug&gt;(EasyAlign)</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">&quot; Start interactive EasyAlign for a motion/text object (e.g. gaip)</span></span><br><span class=\"line\"><span class=\"string\">&quot; gaip</span></span><br><span class=\"line\"><span class=\"string\">nmap ga &lt;Plug&gt;(EasyAlign)</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">&quot;----------------------vim-easy-align setting--------------------</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">&quot;----------------------vim-airline setting-----------------------</span></span><br><span class=\"line\"><span class=\"string\">if !exists(&#x27;</span><span class=\"variable\">g:airline_symbols</span><span class=\"string\">&#x27;)</span></span><br><span class=\"line\"><span class=\"string\">  let g:airline_symbols = &#123;&#125;</span></span><br><span class=\"line\"><span class=\"string\">endif</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">&quot; default theme is dark</span></span><br><span class=\"line\"><span class=\"string\">&quot; let g:airline_theme = &#x27;</span>dark<span class=\"string\">&#x27;</span></span><br><span class=\"line\"><span class=\"string\">&quot; let g:airline_theme = &#x27;</span>luna<span class=\"string\">&#x27;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">let g:airline_left_sep = &#x27;</span>▶<span class=\"string\">&#x27;</span></span><br><span class=\"line\"><span class=\"string\">let g:airline_left_alt_sep = &#x27;</span>❯<span class=\"string\">&#x27;</span></span><br><span class=\"line\"><span class=\"string\">let g:airline_right_sep = &#x27;</span>◀<span class=\"string\">&#x27;</span></span><br><span class=\"line\"><span class=\"string\">let g:airline_right_alt_sep = &#x27;</span>❮<span class=\"string\">&#x27;</span></span><br><span class=\"line\"><span class=\"string\">&quot; let g:airline_symbols.linenr = &#x27;</span>¶<span class=\"string\">&#x27;</span></span><br><span class=\"line\"><span class=\"string\">let g:airline_symbols.branch = &#x27;</span>⎇<span class=\"string\">&#x27;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">&quot; 缓冲区：http://yyq123.blogspot.com/2009/07/vim-buffer.html</span></span><br><span class=\"line\"><span class=\"string\">&quot; 是否打开tabline,打开后，tabline和tmuxline都可以得到增强</span></span><br><span class=\"line\"><span class=\"string\">&quot; let g:airline#extensions#tabline#enabled = 1</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">&quot; tabline中当前buffer两端的分隔字符</span></span><br><span class=\"line\"><span class=\"string\">let g:airline#extensions#tabline#left_sep = &#x27;</span> <span class=\"string\">&#x27;</span></span><br><span class=\"line\"><span class=\"string\">&quot; tabline中未激活buffer两端的分隔字符</span></span><br><span class=\"line\"><span class=\"string\">let g:airline#extensions#tabline#left_alt_sep = &#x27;</span>|<span class=\"string\">&#x27;</span></span><br><span class=\"line\"><span class=\"string\">&quot; tabline中buffer显示编号</span></span><br><span class=\"line\"><span class=\"string\">let g:airline#extensions#tabline#buffer_nr_show = 1</span></span><br><span class=\"line\"><span class=\"string\">&quot; 映射切换buffer的键位</span></span><br><span class=\"line\"><span class=\"string\">nnoremap [b :bp&lt;CR&gt;</span></span><br><span class=\"line\"><span class=\"string\">nnoremap ]b :bn&lt;CR&gt;</span></span><br><span class=\"line\"><span class=\"string\">&quot; 映射&lt;leader&gt;num到num buffer</span></span><br><span class=\"line\"><span class=\"string\">map &lt;leader&gt;1 :b 1&lt;CR&gt;</span></span><br><span class=\"line\"><span class=\"string\">map &lt;leader&gt;2 :b 2&lt;CR&gt;</span></span><br><span class=\"line\"><span class=\"string\">map &lt;leader&gt;3 :b 3&lt;CR&gt;</span></span><br><span class=\"line\"><span class=\"string\">map &lt;leader&gt;4 :b 4&lt;CR&gt;</span></span><br><span class=\"line\"><span class=\"string\">map &lt;leader&gt;5 :b 5&lt;CR&gt;</span></span><br><span class=\"line\"><span class=\"string\">map &lt;leader&gt;6 :b 6&lt;CR&gt;</span></span><br><span class=\"line\"><span class=\"string\">map &lt;leader&gt;7 :b 7&lt;CR&gt;</span></span><br><span class=\"line\"><span class=\"string\">map &lt;leader&gt;8 :b 8&lt;CR&gt;</span></span><br><span class=\"line\"><span class=\"string\">map &lt;leader&gt;9 :b 9&lt;CR&gt;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">&quot; let g:airline#extensions#hunks#enabled=0</span></span><br><span class=\"line\"><span class=\"string\">&quot; let g:airline#extensions#branch#enabled=1</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">&quot;----------------------vim-airline setting-----------------------</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">&quot;----------------------YouCompleteMe setting---------------------</span></span><br><span class=\"line\"><span class=\"string\">&quot;---------------------简称：YCM--------------------</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">&quot;打开vim时不再询问是否加载ycm_extra_conf.py配置</span></span><br><span class=\"line\"><span class=\"string\">let g:ycm_confirm_extra_conf=0</span></span><br><span class=\"line\"><span class=\"string\">&quot;让Vim的补全菜单行为与一般IDE一致(参考VimTip1228)</span></span><br><span class=\"line\"><span class=\"string\">set completeopt=longest,menu</span></span><br><span class=\"line\"><span class=\"string\">&quot;python解释器路径</span></span><br><span class=\"line\"><span class=\"string\">&quot;let g:ycm_path_to_python_interpreter=&#x27;</span>/usr/bin/<span class=\"keyword\">python</span><span class=\"string\">&#x27;</span></span><br><span class=\"line\"><span class=\"string\">&quot;是否开启语义补全</span></span><br><span class=\"line\"><span class=\"string\">let g:ycm_seed_identifiers_with_syntax=1</span></span><br><span class=\"line\"><span class=\"string\">&quot;是否在注释中也开启补全</span></span><br><span class=\"line\"><span class=\"string\">let g:ycm_complete_in_comments=1</span></span><br><span class=\"line\"><span class=\"string\">let g:ycm_collect_identifiers_from_comments_and_strings = 0</span></span><br><span class=\"line\"><span class=\"string\">&quot;开始补全的字符数</span></span><br><span class=\"line\"><span class=\"string\">let g:ycm_min_num_of_chars_for_completion=2</span></span><br><span class=\"line\"><span class=\"string\">&quot;补全后自动关闭预览窗口</span></span><br><span class=\"line\"><span class=\"string\">let g:ycm_autoclose_preview_window_after_completion=1</span></span><br><span class=\"line\"><span class=\"string\">let g:ycm_autoclose_preview_window_after_insertion=1</span></span><br><span class=\"line\"><span class=\"string\">&quot; 禁止缓存匹配项,每次都重新生成匹配项</span></span><br><span class=\"line\"><span class=\"string\">let g:ycm_cache_omnifunc=0</span></span><br><span class=\"line\"><span class=\"string\">&quot;字符串中也开启补全</span></span><br><span class=\"line\"><span class=\"string\">let g:ycm_complete_in_strings = 1</span></span><br><span class=\"line\"><span class=\"string\">&quot;离开插入模式后自动关闭预览窗口</span></span><br><span class=\"line\"><span class=\"string\">autocmd InsertLeave * if pumvisible() == 0|pclose|endif</span></span><br><span class=\"line\"><span class=\"string\">&quot; 空格键用于关闭补全窗口</span></span><br><span class=\"line\"><span class=\"string\">let g:ycm_key_list_stop_completion = [&#x27;</span><span class=\"symbol\">&lt;space&gt;</span><span class=\"string\">&#x27;]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">&quot;默认关闭代码自动提示，目前只安装了c和python语言的代码提示，所以需要代码提示时，可以在NORMAL模式下输入&#x27;</span>\\+<span class=\"keyword\">y</span><span class=\"string\">&#x27;开启代码提示</span></span><br><span class=\"line\"><span class=\"string\">let g:ycm_auto_trigger=0</span></span><br><span class=\"line\"><span class=\"string\">&quot;turn on YCM：</span></span><br><span class=\"line\"><span class=\"string\">&quot;\\+y一起按，看到命令输出后回车即可，这里&lt;leader&gt;代表命令前缀，默认为\\</span></span><br><span class=\"line\"><span class=\"string\">nnoremap &lt;leader&gt;y :let g:ycm_auto_trigger=1&lt;CR&gt;</span></span><br><span class=\"line\"><span class=\"string\">&quot;turn off YCM：\\+y+y一起按</span></span><br><span class=\"line\"><span class=\"string\">nnoremap &lt;leader&gt;yy :let g:ycm_auto_trigger=0&lt;CR&gt;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">&quot;----------------------YouCompleteMe setting---------------------</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">&quot;-------------NERDTree setting-----------------------</span></span><br><span class=\"line\"><span class=\"string\">&quot;######常用快捷键说明########</span></span><br><span class=\"line\"><span class=\"string\">&quot;Ctrl + t 打开/关闭nerdtree</span></span><br><span class=\"line\"><span class=\"string\">&quot;Ctrl + n 打开、回到最开始打开的文件目录</span></span><br><span class=\"line\"><span class=\"string\">&quot;Shift + f 打开上级目录</span></span><br><span class=\"line\"><span class=\"string\">&quot;</span></span><br><span class=\"line\"><span class=\"string\">&quot;Ctrl + w + w\t光标在 nerdtree 和 vim 编辑窗口 之间切换</span></span><br><span class=\"line\"><span class=\"string\">&quot;Ctrl + w + (h/j/k/l)  即h左、j下、k上、l右，表示窗口切换的方向</span></span><br><span class=\"line\"><span class=\"string\">&quot;</span></span><br><span class=\"line\"><span class=\"string\">&quot;q\t关闭 nerdtree</span></span><br><span class=\"line\"><span class=\"string\">&quot;o\t打开选中的文件； 折叠/展开选中的目录</span></span><br><span class=\"line\"><span class=\"string\">&quot;i\t打开选中的文件，与已打开文件纵向排布窗口，并跳转至该窗口</span></span><br><span class=\"line\"><span class=\"string\">&quot;gi\t打开选中的文件，与已打开文件纵向排布窗口，但不跳转至该窗口</span></span><br><span class=\"line\"><span class=\"string\">&quot;s\t打开选中的文件，与已打开文件横向排布窗口，并跳转至该窗口</span></span><br><span class=\"line\"><span class=\"string\">&quot;gs\t打开选中的文件，与已打开文件横向排布窗口，但不跳转至该窗口</span></span><br><span class=\"line\"><span class=\"string\">&quot;t\t在新 Tab 中打开选中文件/书签，并跳到新 Tab</span></span><br><span class=\"line\"><span class=\"string\">&quot;T\t在新 Tab 中打开选中文件/书签，但不跳到新 Tab</span></span><br><span class=\"line\"><span class=\"string\">&quot;x\t折叠选中结点的父目录</span></span><br><span class=\"line\"><span class=\"string\">&quot;X\t递归折叠选中结点下的所有目录</span></span><br><span class=\"line\"><span class=\"string\">&quot;k / j\t光标在 Neadtree 上下移动</span></span><br><span class=\"line\"><span class=\"string\">&quot;</span></span><br><span class=\"line\"><span class=\"string\">&quot;&lt;leader&gt;tc\t:tabc   关闭当前的 tab</span></span><br><span class=\"line\"><span class=\"string\">&quot;&lt;leader&gt;to\t:tabo   关闭所有其他 tab</span></span><br><span class=\"line\"><span class=\"string\">&quot;&lt;leader&gt;ts\t:tabs   查看所有打开的 tab</span></span><br><span class=\"line\"><span class=\"string\">&quot;&lt;leader&gt;tp\t:tabp   前一个 tab</span></span><br><span class=\"line\"><span class=\"string\">&quot;&lt;leader&gt;tn\t:tabn   后一个 tab</span></span><br><span class=\"line\"><span class=\"string\">&quot;?\t显示菜单</span></span><br><span class=\"line\"><span class=\"string\">&quot;######常用快捷键说明########</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">&quot; 高亮当前行</span></span><br><span class=\"line\"><span class=\"string\">let NERDTreeHighlightCursorline = 1</span></span><br><span class=\"line\"><span class=\"string\">&quot; 显示行号</span></span><br><span class=\"line\"><span class=\"string\">let NERDTreeShowLineNumbers     = 1</span></span><br><span class=\"line\"><span class=\"string\">&quot; 忽略列表中的文件</span></span><br><span class=\"line\"><span class=\"string\">let NERDTreeIgnore = [ &#x27;</span>\\.pyc$<span class=\"string\">&#x27;, &#x27;</span>\\.pyo$<span class=\"string\">&#x27;, &#x27;</span>\\.obj$<span class=\"string\">&#x27;, &#x27;</span>\\.<span class=\"keyword\">o</span>$<span class=\"string\">&#x27;, &#x27;</span>\\.egg$<span class=\"string\">&#x27;, &#x27;</span>^\\.git$<span class=\"string\">&#x27;, &#x27;</span>^\\.repo$<span class=\"string\">&#x27;, &#x27;</span>^\\.svn$<span class=\"string\">&#x27;, &#x27;</span>^\\.hg$<span class=\"string\">&#x27; ]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">nnoremap &lt;leader&gt;n :NERDTreeFocus&lt;CR&gt;</span></span><br><span class=\"line\"><span class=\"string\">&quot;打开、回到最开始打开的文件目录</span></span><br><span class=\"line\"><span class=\"string\">nnoremap &lt;C-n&gt; :NERDTree&lt;CR&gt;</span></span><br><span class=\"line\"><span class=\"string\">&quot;打开、关闭目录</span></span><br><span class=\"line\"><span class=\"string\">nnoremap &lt;C-t&gt; :NERDTreeToggle&lt;CR&gt;</span></span><br><span class=\"line\"><span class=\"string\">&quot;打开上级目录</span></span><br><span class=\"line\"><span class=\"string\">nnoremap &lt;S-f&gt; :NERDTreeFind&lt;CR&gt;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">&quot; \\tc 关闭当前的 tab</span></span><br><span class=\"line\"><span class=\"string\">map &lt;leader&gt;tc :tabc&lt;CR&gt;</span></span><br><span class=\"line\"><span class=\"string\">&quot; \\to 关闭所有其他的 tab</span></span><br><span class=\"line\"><span class=\"string\">map &lt;leader&gt;to :tabo&lt;CR&gt;</span></span><br><span class=\"line\"><span class=\"string\">&quot; \\ts 查看所有打开的 tab</span></span><br><span class=\"line\"><span class=\"string\">map &lt;leader&gt;ts :tabs&lt;CR&gt;</span></span><br><span class=\"line\"><span class=\"string\">&quot; \\tp 前一个 tab</span></span><br><span class=\"line\"><span class=\"string\">map &lt;leader&gt;tp :tabp&lt;CR&gt;</span></span><br><span class=\"line\"><span class=\"string\">&quot; \\tn 后一个 tab</span></span><br><span class=\"line\"><span class=\"string\">map &lt;leader&gt;tn :tabn&lt;CR&gt;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">&quot; Exit Vim if NERDTree is the only window left.</span></span><br><span class=\"line\"><span class=\"string\">&quot; 关闭 NERDTree，当没有文件打开的时候</span></span><br><span class=\"line\"><span class=\"string\">autocmd BufEnter * if tabpagenr(&#x27;</span>$<span class=\"string\">&#x27;) == 1 &amp;&amp; winnr(&#x27;</span>$<span class=\"string\">&#x27;) == 1 &amp;&amp; exists(&#x27;</span><span class=\"variable\">b:NERDTree</span><span class=\"string\">&#x27;) &amp;&amp; b:NERDTree.isTabTree() |</span></span><br><span class=\"line\"><span class=\"string\">    \\ quit | endif</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">&quot; 启动 vim 时打开 NERDTree</span></span><br><span class=\"line\"><span class=\"string\">&quot;autocmd vimenter * NERDTree</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">&quot; 当打开 VIM，没有指定文件时和打开一个目录时，打开 NERDTree</span></span><br><span class=\"line\"><span class=\"string\">autocmd StdinReadPre * let s:std_in=1</span></span><br><span class=\"line\"><span class=\"string\">autocmd VimEnter * if argc() == 1 &amp;&amp; isdirectory(argv()[0]) &amp;&amp; !exists(&#x27;</span><span class=\"variable\">s:std_in</span><span class=\"string\">&#x27;) |</span></span><br><span class=\"line\"><span class=\"string\">    \\ execute &#x27;</span>NERDTree<span class=\"string\">&#x27; argv()[0] | wincmd p | enew | execute &#x27;</span><span class=\"keyword\">cd</span> <span class=\"string\">&#x27;.argv()[0] | endif</span></span><br><span class=\"line\"><span class=\"string\">autocmd VimEnter * if argc() == 0 &amp;&amp; !exists(&#x27;</span><span class=\"variable\">s:std_in</span><span class=\"string\">&#x27;) | NERDTree | endif</span></span><br><span class=\"line\"><span class=\"string\">&quot;-------------NERDTree setting-----------------------</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">&quot;-----------tagbar setting---------------------------</span></span><br><span class=\"line\"><span class=\"string\">&quot;Ctrl - w - w\t光标在 Tagbar 和 vim 编辑窗口 之间切换</span></span><br><span class=\"line\"><span class=\"string\">&quot;&lt;leader&gt;tb\t打开 tagbar</span></span><br><span class=\"line\"><span class=\"string\">&quot;q\t关闭 tagbar</span></span><br><span class=\"line\"><span class=\"string\">&quot;o（+/-）\t折叠 / 展开标签集合</span></span><br><span class=\"line\"><span class=\"string\">&quot;p\t跳转到选中的标签，但光标仍停留在 Tagbar</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">&quot; tagbar 依赖 ctags 插件 brew install ctags</span></span><br><span class=\"line\"><span class=\"string\">let g:tagbar_ctags_bin = &#x27;</span>ctags<span class=\"string\">&#x27;</span></span><br><span class=\"line\"><span class=\"string\">&quot; 设置 tagbar 的宽度为 30 列，默认 40 列</span></span><br><span class=\"line\"><span class=\"string\">let g:tagbar_width     = 30</span></span><br><span class=\"line\"><span class=\"string\">&quot; 打开 tagbar 时光标在 tagbar 页面内，默认在 vim 打开的文件内</span></span><br><span class=\"line\"><span class=\"string\">let g:tagbar_autofocus = 1</span></span><br><span class=\"line\"><span class=\"string\">&quot; 让 tagbar 在页面左侧显示，默认右边</span></span><br><span class=\"line\"><span class=\"string\">let g:tagbar_left      = 1</span></span><br><span class=\"line\"><span class=\"string\">&quot; 标签不排序，默认排序</span></span><br><span class=\"line\"><span class=\"string\">&quot;let g:tagbar_sort      = 0</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">&quot; &lt;leader&gt;tb 打开 tagbar 窗口，在左侧栏显示</span></span><br><span class=\"line\"><span class=\"string\">nmap &lt;leader&gt;tb :TagbarToggle&lt;CR&gt;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">&quot;-----------tagbar setting---------------------------</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">&quot;----------ultisnips setting-------------------------</span></span><br><span class=\"line\"><span class=\"string\">&quot;:UltiSnipsEdit 显示帮助信息&quot;</span></span><br><span class=\"line\"><span class=\"string\">&quot; 片段信息寻找的文件夹名称，默认UltiSnips，多个逗号分隔</span></span><br><span class=\"line\"><span class=\"string\">&quot;let g:UltiSnipsSnippetDirectories = [&#x27;</span>UltiSnips<span class=\"string\">&#x27;]</span></span><br><span class=\"line\"><span class=\"string\">&quot; :UltiSnipsEdit 显示帮助信的目录路径，默认~/.vim/UltiSnips</span></span><br><span class=\"line\"><span class=\"string\">let g:UltiSnipsSnippetStorageDirectoryForUltiSnipsEdit = &#x27;</span>~/.<span class=\"keyword\">vim</span>/plugged/<span class=\"keyword\">vim</span>-snippets/UltiSnips<span class=\"string\">&#x27;</span></span><br><span class=\"line\"><span class=\"string\">&quot; 代码片段补全触发，需要在编辑模式</span></span><br><span class=\"line\"><span class=\"string\">let g:UltiSnipsExpandTrigger       = &#x27;</span><span class=\"symbol\">&lt;c-w&gt;</span><span class=\"string\">&#x27;</span></span><br><span class=\"line\"><span class=\"string\">&quot; 列出补全可选列表，需要在编辑模式，可以在输入一些字符后调用，显示当前字符的代码片段提示</span></span><br><span class=\"line\"><span class=\"string\">let g:UltiSnipsListSnippets        = &#x27;</span>&lt;<span class=\"keyword\">c</span>-\\&gt;<span class=\"string\">&#x27;</span></span><br><span class=\"line\"><span class=\"string\">&quot; 下一条补全，需要在编辑模式，不好使</span></span><br><span class=\"line\"><span class=\"string\">let g:UltiSnipsJumpForwardTrigger  = &#x27;</span><span class=\"symbol\">&lt;c-b&gt;</span><span class=\"string\">&#x27;</span></span><br><span class=\"line\"><span class=\"string\">&quot; 上一条补全，需要在编辑模式，不好使</span></span><br><span class=\"line\"><span class=\"string\">let g:UltiSnipsJumpBackwardTrigger = &#x27;</span><span class=\"symbol\">&lt;c-z&gt;</span><span class=\"string\">&#x27;</span></span><br><span class=\"line\"><span class=\"string\">&quot; 帮助信息水平显示</span></span><br><span class=\"line\"><span class=\"string\">let g:UltiSnipsEditSplit           = &#x27;</span>horizontal<span class=\"string\">&#x27;</span></span><br><span class=\"line\"><span class=\"string\">&quot; 帮助信息垂直显示</span></span><br><span class=\"line\"><span class=\"string\">&quot;let g:UltiSnipsEditSplit           = &#x27;</span><span class=\"keyword\">vertical</span><span class=\"string\">&#x27;</span></span><br><span class=\"line\"><span class=\"string\">&quot; python3</span></span><br><span class=\"line\"><span class=\"string\">&quot;let g:UltiSnipsUsePythonVersion = 3</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">&quot;----------ultisnips setting--------------------------</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">&quot;------------nerdcommenter setting--------------------</span></span><br><span class=\"line\"><span class=\"string\">&quot; \\c+空格</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">&quot;[count]&lt;leader&gt;cc\t注释当前行起始的 [count]行 或者 注释 visual mode 选中的文本</span></span><br><span class=\"line\"><span class=\"string\">&quot;[count]&lt;leader&gt;cn\t注释方式同 &lt;leader&gt;cc，但是强制嵌套</span></span><br><span class=\"line\"><span class=\"string\">&quot;[count]&lt;leader&gt;c&lt;space&gt;\t这个是最重要的，记住这一个就行了。切换所选行的注释状态。 如果注释了最上面的选定行，则取消注释所有选定行，反之亦然。</span></span><br><span class=\"line\"><span class=\"string\">&quot;[count]&lt;leader&gt;cm\t使用一组多行注释符注释选定行</span></span><br><span class=\"line\"><span class=\"string\">&quot;[count]&lt;leader&gt;ci\t单独切换所选行的各行注释状态</span></span><br><span class=\"line\"><span class=\"string\">&quot;[count]&lt;leader&gt;cs\t使用块格式布局注释掉选定的行。</span></span><br><span class=\"line\"><span class=\"string\">&quot;&lt;leader&gt;c$\t注释从光标到行尾的当前行。</span></span><br><span class=\"line\"><span class=\"string\">&quot;&lt;leader&gt;cA\t在行尾添加注释，并切换至插入模式，光标停留在注释符中间</span></span><br><span class=\"line\"><span class=\"string\">&quot;[count]&lt;leader&gt;cl</span></span><br><span class=\"line\"><span class=\"string\">&quot;[count]&lt;leader&gt;cb\t注释方式同 &lt;leader&gt;cc，注释符左对齐（&lt;leader&gt;cl）或者两边对齐（&lt;leader&gt;cb）</span></span><br><span class=\"line\"><span class=\"string\">&quot;[count]&lt;leader&gt;cu\t取消选定行的注释</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">&quot; 在注释符号后加一个空格</span></span><br><span class=\"line\"><span class=\"string\">let g:NERDSpaceDelims            = 1</span></span><br><span class=\"line\"><span class=\"string\">&quot; 紧凑排布多行注释</span></span><br><span class=\"line\"><span class=\"string\">let g:NERDCompactSexyComs        = 1</span></span><br><span class=\"line\"><span class=\"string\">&quot; 逐行注释左对齐</span></span><br><span class=\"line\"><span class=\"string\">let g:NERDDefaultAlign           = &#x27;</span><span class=\"keyword\">left</span><span class=\"string\">&#x27;</span></span><br><span class=\"line\"><span class=\"string\">&quot; JAVA 语言使用默认的注释符号</span></span><br><span class=\"line\"><span class=\"string\">let g:NERDAltDelims_java         = 1</span></span><br><span class=\"line\"><span class=\"string\">&quot; C 语言注释符号</span></span><br><span class=\"line\"><span class=\"string\">let g:NERDCustomDelimiters       = &#123;&#x27;</span><span class=\"keyword\">c</span><span class=\"string\">&#x27;: &#123;&#x27;</span><span class=\"keyword\">left</span><span class=\"string\">&#x27;: &#x27;</span>/**<span class=\"string\">&#x27;, &#x27;</span><span class=\"keyword\">right</span><span class=\"string\">&#x27;: &#x27;</span>*/<span class=\"string\">&#x27;&#125;&#125;</span></span><br><span class=\"line\"><span class=\"string\">&quot; 允许空行注释</span></span><br><span class=\"line\"><span class=\"string\">let g:NERDCommentEmptyLines      = 1</span></span><br><span class=\"line\"><span class=\"string\">&quot; 取消注释时删除行尾空格</span></span><br><span class=\"line\"><span class=\"string\">let g:NERDTrimTrailingWhitespace = 1</span></span><br><span class=\"line\"><span class=\"string\">&quot; 检查选中的行操作是否成功</span></span><br><span class=\"line\"><span class=\"string\">let g:NERDToggleCheckAllLines    = 1</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">&quot;------------nerdcommenter setting--------------------</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">&quot;------------fzf setting------------------------------</span></span><br><span class=\"line\"><span class=\"string\">&quot; 在当前目录搜索文件</span></span><br><span class=\"line\"><span class=\"string\">nnoremap &lt;Leader&gt;f :FZF&lt;CR&gt;</span></span><br><span class=\"line\"><span class=\"string\">&quot;------------fzf setting------------------------------</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">&quot; ----------tpope/vim-surround setting---------------</span></span><br><span class=\"line\"><span class=\"string\">&quot; normal模式下，光标所在航</span></span><br><span class=\"line\"><span class=\"string\">&quot; 替换：</span></span><br><span class=\"line\"><span class=\"string\">&quot; cs&quot;&#x27;</span>  : 将光标所在行中成对出现的双引号替换为单引号</span><br><span class=\"line\"><span class=\"comment\">&quot; cs([  : 将小括号替换为中括号</span></span><br><span class=\"line\"><span class=\"string\">&quot; cst&quot;</span>  : 将当前文本两边成对出现的引号或括号替换为双引号</span><br><span class=\"line\"><span class=\"comment\">&quot; 删除:</span></span><br><span class=\"line\"><span class=\"string\">&quot; ds&quot;</span>   : 删除双引号</span><br><span class=\"line\"><span class=\"comment\">&quot; 添加：</span></span><br><span class=\"line\"><span class=\"string\">&quot; ysiw&quot;</span>  : 将光标所在单词添加上双引号</span><br><span class=\"line\"><span class=\"string\">&quot; yss&quot;</span>   : 将当前行添加上双引号</span><br><span class=\"line\"><span class=\"comment\">&quot; ----------tpope/vim-surround setting---------------</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&quot; ----------mhinz/vim-signify setting----------------</span></span><br><span class=\"line\"><span class=\"comment\">&quot; default updatetime 4000ms is not good for async update</span></span><br><span class=\"line\"><span class=\"keyword\">set</span> updatetime=<span class=\"number\">100</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&quot; ----------mhinz/vim-signify setting----------------</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>","content_text":"摘要 vim常用配置 基于vim-plug进行插件管理 .vimrc123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424425426427428429430431432433434435436437438439440441442443444445446447448449450451452453454455456457458459460461462463464465466467468469470471472473474475476477478479480481482483484485486487488489490491492493494495496497498499500501502503504505506507508509510511512513514515516517518519520521522523524525526527528529530531532533534535536537538539540541542543544545546547548549550551552553554555556557558559560561562563564565566567568&quot; =============================================================&quot; :set all 查看所有可以设置的命令&quot; :set command? 查看该命令当前状态，比如:set nu?&quot;&quot; :map 查看所有键盘映射，参考：http://yyq123.github.io/learn-vim/learn-vi-51-KeyMapping.html&quot; :autocmd 查看所有自动命令，参考：http://yyq123.github.io/learn-vim/learn-vi-49-01-autocmd.html&quot; =============================================================&quot; 开启行号set nu&quot; 语法高亮syntax on&quot; 设置自动缩进的宽度为4个空格set ts=4set sw=4&quot; 设置vim编码，默认就是utf-8set encoding=utf-8&quot; 设置vim自动识别的文件编码列表，按顺序进行匹配set fileencodings=utf-8,ucs-bom,shift-jis,gb18030,gbk,gb2312,cp936,utf-16,big5,euc-jp,latin1&quot; 搜索时忽略大小写，默认是精确匹配，noignorecase&quot; 如果想在搜索时精确匹配，可以加上&#x27;\\C&#x27;前缀，比如搜索plug，:/\\Cplug&quot; &#x27;\\c&#x27;就是忽略大小写set ignorecase&quot; =============================================================&quot; 翻页&quot; Ctrl + f 向下翻整页&quot; Ctrl + b 向上翻整页&quot;&quot; Ctrl + d 向下翻半页&quot; Ctrl + u 向上翻半页&quot; =============================================================&quot; 窗口&quot; Ctrl + w + w 光标在 nerdtree 和 vim 编辑窗口 之间切换&quot; Ctrl + w + (h/j/k/l) 即h左、j下、k上、l右，表示窗口切换的方向&quot; Ctrl + w + n 新建水平窗口并开始编辑新文件，上方&quot; :vnew 新建垂直窗口并开始编辑新文件，右侧&quot; Ctrl + w + s 新建水平窗口并显示当前文件，右侧&quot; Ctrl + w + v 新建垂直窗口并显示当前文件，上方&quot; :term 新建终端窗口，上方，关闭使用exit&quot;&quot; vim -o file1 file2 file3 水平分割窗口&quot; vim -O file1 file2 file3 垂直分割窗口&quot; =============================================================&quot; Tab页，标签页，注意：tab不适buffer&quot; :tabnew 新建tab页，打开一个新的为文件&quot; :tabedit file 新建tab页，打开指定的文件&quot; gt/gT 向后/向前切换tab页，可以循环&quot; =============================================================&quot;&quot; 标记marks&quot; :marks 查看全部可以跳转到的标记&quot; 快捷键：m/ 这个快捷键只会列出当前文件的标记&quot;&quot; 为当前行添加一个标记: 同一行可以添加多个标记&quot; m+英文字母&quot; 小写字母只能在当前文件内部跳转，大写字母可以在其它文件中跳转，如：ma，mA&quot;&quot; 跳转到指定标记:&quot; &#x27;+英文字母 移动到标记的文本行首，如：&#x27;a，&#x27;A&quot; `+英文字母 移动到标记的光标位置，如：`a，`A&quot;&quot; 删除标记:&quot; :delmarks a A 删除一个或多个指定标记，快捷键：dmx :x is a-zA-Z&quot; :delmarks! 删除所有标记 快捷键：m&lt;Space&gt;&quot; =============================================================&quot; 不生产wrap文件,warp文件是vim意外退出时用于恢复文件时使用的&quot; set nowrap&quot; 不生产备份文件&quot; set nobackup&quot; =============================================================&quot; 快速跳转到指定行&quot; 1.查看模式下numgg，比如30gg，跳转到30行&quot; 2.命令行模式下:num，比如:30，跳转到30行&quot; =============================================================&quot; 撤销：u :undo&quot; 恢复：ctrl-r :redo&quot; =============================================================&quot; 命令行模式下，通过上下方向键就可以显示历史命令&quot; 命令行模式下，ctrl-f，会打开历史命令窗口，上下方向键选择&quot; 普通模式下，q: ，也可以打开历史命令窗口&quot; 打开历史命令行窗口后，可以像在普通窗口一样键入&#x27;\\key&#x27;进行关键字搜索&quot; =============================================================&quot; 大小写转换:&quot; gUU：将整行转换为大写&quot; guu：将整行转换为小写&quot;&quot; v模式下，选择要转换的字符，然后按 ~，则会进行大小写间的转换&quot; 这里要注意，~ 转换时，原先是大写就转小写，小写就转大写，&quot; 所以如果单词中是大小写混合时，要全部转为大写或小写可以使用：U(大写)、u(小写)&quot;==============================================================&quot; 代码格式化整个文档：&quot; (1) 按两下小写g，即gg，定位光标到第一行。&quot; (2) 按住Shift+v，即大写V，进入可视化编辑的行编辑模式。&quot; (3) Shift+g，即大写G，选中整个代码。&quot; (4) 按下等号=，格式化所有代码。&quot;&quot; 也可以在normal模式下，连续输入 gg=G ，也可以格式化整个文档&quot;&quot; 代码格式化部分行：&quot; (1) 光标定位到开始的行；&quot; (2) 按住Shift+v，即大写V，进入可视化编辑的行编辑模式。&quot; (3) 按向下方向键选择要参与格式化的行。&quot; (4) 按下等号=，格式化所选行代码。&quot;&quot; 也可以在normal模式下，连续输入 5gg=8G ，也可以格式化5~8行的文档&quot;==============================================================&quot; 当我们并不知道确切的命令名称时，可以只输入开头的几个字母，然后按下Tab键，就将在底部显示可能匹配的命令。&quot; 继续按Tab键，可以在这些命令列表间移动，左右方向键也可以移动，没有找到命令时可以按esc退出选择窗口set wildmenu&quot; 第一次按tab键时会先打印所有匹配的命令名称，再次按tab才会在命令中进行set wildmode=list:longest,full&quot; autocmd 自动执行指令，参考：http://yyq123.github.io/learn-vim/learn-vi-49-01-autocmd.html&quot; 快速跳转到上次退出时光标所在行: &#x27;0 不好用啊，会打开bufferif has(&quot;autocmd&quot;) &quot; autocmd可以简写为au au BufReadPost * if line(&quot;&#x27;\\&quot;&quot;) &gt; 1 &amp;&amp; line(&quot;&#x27;\\&quot;&quot;) &lt;= line(&quot;$&quot;) | exe &quot;normal! g&#x27;\\&quot;&quot; | endifendif&quot; 查看用&lt;&gt;括起来的快捷键的含义 :help keycodesnmap &lt;leader&gt;kk :help keycodes&lt;CR&gt;&quot; 设置&lt;leader&gt;的字符，默认为: \\&quot; let mapleader=&quot;,&quot;&quot; 按\\w保存文件nmap &lt;leader&gt;w :w&lt;CR&gt;&quot; 按\\wq保存退出nmap &lt;leader&gt;wq :wq&lt;CR&gt;&quot; 按\\qq不保存退出nmap &lt;leader&gt;qq :q!&lt;CR&gt;&quot; \\ev，在新tab中打开vimrc配置文件，按\\tn在多个tab中切换,按\\tc关闭当前tabnmap &lt;leader&gt;ev :tabe&lt;Space&gt;$MYVIMRC&lt;CR&gt;&quot; 让配置变更保存时就立即生效，:w，这里只针对.vimrc文件保存时生效，其它文件需要重新打开才生效autocmd BufWritePost $MYVIMRC source $MYVIMRC&quot;高亮显示当前行set cursorline&quot;高亮显示当前列set cursorcolumn&quot; 颜色模式&quot;https://github.com/tomasr/molokaicolorscheme molokai&quot;-----------------molokai setting---------let g:molokai_original = 1let g:rehash256 = 1&quot;-----------------------------------------&quot;https://github.com/altercation/vim-colors-solarized&quot;colorscheme solarized&quot;--------------solarizded setting---------&quot; 使用 termnal 背景&quot;let g:solarized_termtrans = 1&quot;let g:solarized_termcolors=256&quot; 使用 :set list 显示特殊字符时的高亮级别&quot;let g:solarized_visibility = &#x27;high&#x27;&quot;-----------------------------------------&quot;https://github.com/morhetz/gruvbox&quot;colorscheme gruvbox&quot;https://github.com/rakr/vim-one&quot;colorscheme one&quot;macos 自带&quot; colorscheme desert&quot;colorscheme pabloset background=dark&quot; 高亮搜索结果set hlsearch&quot;取消搜索后高亮 &lt;silent&gt;表示静默执行，就是不打印命令nnoremap &lt;silent&gt;&lt;leader&gt;h :noh&lt;CR&gt;&quot; 取消自动折行，一行内容超出屏幕时不进行折行显示set nowrap&quot; set wrap&quot; 一行内容超出屏幕时，实现更加平滑的逐个字符扩展显示set sidescroll=1&quot; 解决插入模式下delete/backspce键失效问题&quot; https://www.cnblogs.com/shengulong/p/10530188.htmlset backspace=2&quot; 括号和引号的自动补全inoremap ( ()&lt;ESC&gt;iinoremap [ []&lt;ESC&gt;iinoremap &#123; &#123;&#125;&lt;ESC&gt;iinoremap &#x27; &#x27;&#x27;&lt;ESC&gt;iinoremap &quot; &quot;&quot;&lt;ESC&gt;i&quot; 针对不同的文件类型采用不同的缩进格式filetype indent on&quot; 针对不同的文件类型加载对应的插件filetype plugin on&quot; 启用自动补全&quot;filetype plugin indent on&quot; set rtp+=/usr/local/opt/fzf&quot;---------------------------------vim-plug setting------------------------------&quot; vim-plug插件管理器的声明及配置，具体配置参考： https://github.com/junegunn/vim-plugcall plug#begin(&#x27;~/.vim/plugged&#x27;)&quot; If installed using Homebrew&quot; 文件搜索Plug &#x27;/usr/local/opt/fzf&#x27;&quot; https://github.com/junegunn/vim-easy-align&quot; 文本对其Plug &#x27;junegunn/vim-easy-align&#x27;&quot; https://github.com/vim-airline/vim-airline&quot; 状态栏设置Plug &#x27;vim-airline/vim-airline&#x27;&quot; Plug &#x27;vim-airline/vim-airline-themes&#x27;&quot; https://github.com/ycm-core/YouCompleteMe#installation&quot; 代码提示Plug &#x27;Valloric/YouCompleteMe&#x27;&quot;https://github.com/preservim/nerdtree&quot;目录树Plug &#x27;preservim/nerdtree&#x27;&quot;https://github.com/preservim/tagbar&quot;将当前文件的内容分类展示，比如java代码中的package\\method\\field等等Plug &#x27;preservim/tagbar&#x27;&quot;https://github.com/SirVer/ultisnips&quot;代码片段补全Plug &#x27;SirVer/ultisnips&#x27;&quot; 网友贡献的补全片段Plug &#x27;honza/vim-snippets&#x27;&quot;https://github.com/preservim/nerdcommenter&quot;注释插件Plug &#x27;preservim/nerdcommenter&#x27;&quot;https://github.com/tpope/vim-surround&quot;引号、括号等的替换和删除Plug &#x27;tpope/vim-surround&#x27;&quot; https://github.com/mhinz/vim-signify&quot; svn\\git插件，修改文件时状态栏会有记录if has(&#x27;nvim&#x27;) || has(&#x27;patch-8.0.902&#x27;) Plug &#x27;mhinz/vim-signify&#x27;else Plug &#x27;mhinz/vim-signify&#x27;, &#123; &#x27;branch&#x27;: &#x27;legacy&#x27; &#125;endif&quot; https://github.com/kshenoy/vim-signature&quot; 窗口左侧显示标记Plug &#x27;kshenoy/vim-signature&#x27;call plug#end()&quot;---------------------------------vim-plug setting------------------------------&quot;###############以下是单个插件的特殊配置项#########################&quot;&quot;----------------------vim-easy-align setting--------------------&quot; Start interactive EasyAlign in visual mode (e.g. vipga)&quot; vipgaxmap ga &lt;Plug&gt;(EasyAlign)&quot; Start interactive EasyAlign for a motion/text object (e.g. gaip)&quot; gaipnmap ga &lt;Plug&gt;(EasyAlign)&quot;----------------------vim-easy-align setting--------------------&quot;----------------------vim-airline setting-----------------------if !exists(&#x27;g:airline_symbols&#x27;) let g:airline_symbols = &#123;&#125;endif&quot; default theme is dark&quot; let g:airline_theme = &#x27;dark&#x27;&quot; let g:airline_theme = &#x27;luna&#x27;let g:airline_left_sep = &#x27;▶&#x27;let g:airline_left_alt_sep = &#x27;❯&#x27;let g:airline_right_sep = &#x27;◀&#x27;let g:airline_right_alt_sep = &#x27;❮&#x27;&quot; let g:airline_symbols.linenr = &#x27;¶&#x27;let g:airline_symbols.branch = &#x27;⎇&#x27;&quot; 缓冲区：http://yyq123.blogspot.com/2009/07/vim-buffer.html&quot; 是否打开tabline,打开后，tabline和tmuxline都可以得到增强&quot; let g:airline#extensions#tabline#enabled = 1&quot; tabline中当前buffer两端的分隔字符let g:airline#extensions#tabline#left_sep = &#x27; &#x27;&quot; tabline中未激活buffer两端的分隔字符let g:airline#extensions#tabline#left_alt_sep = &#x27;|&#x27;&quot; tabline中buffer显示编号let g:airline#extensions#tabline#buffer_nr_show = 1&quot; 映射切换buffer的键位nnoremap [b :bp&lt;CR&gt;nnoremap ]b :bn&lt;CR&gt;&quot; 映射&lt;leader&gt;num到num buffermap &lt;leader&gt;1 :b 1&lt;CR&gt;map &lt;leader&gt;2 :b 2&lt;CR&gt;map &lt;leader&gt;3 :b 3&lt;CR&gt;map &lt;leader&gt;4 :b 4&lt;CR&gt;map &lt;leader&gt;5 :b 5&lt;CR&gt;map &lt;leader&gt;6 :b 6&lt;CR&gt;map &lt;leader&gt;7 :b 7&lt;CR&gt;map &lt;leader&gt;8 :b 8&lt;CR&gt;map &lt;leader&gt;9 :b 9&lt;CR&gt;&quot; let g:airline#extensions#hunks#enabled=0&quot; let g:airline#extensions#branch#enabled=1&quot;----------------------vim-airline setting-----------------------&quot;----------------------YouCompleteMe setting---------------------&quot;---------------------简称：YCM--------------------&quot;打开vim时不再询问是否加载ycm_extra_conf.py配置let g:ycm_confirm_extra_conf=0&quot;让Vim的补全菜单行为与一般IDE一致(参考VimTip1228)set completeopt=longest,menu&quot;python解释器路径&quot;let g:ycm_path_to_python_interpreter=&#x27;/usr/bin/python&#x27;&quot;是否开启语义补全let g:ycm_seed_identifiers_with_syntax=1&quot;是否在注释中也开启补全let g:ycm_complete_in_comments=1let g:ycm_collect_identifiers_from_comments_and_strings = 0&quot;开始补全的字符数let g:ycm_min_num_of_chars_for_completion=2&quot;补全后自动关闭预览窗口let g:ycm_autoclose_preview_window_after_completion=1let g:ycm_autoclose_preview_window_after_insertion=1&quot; 禁止缓存匹配项,每次都重新生成匹配项let g:ycm_cache_omnifunc=0&quot;字符串中也开启补全let g:ycm_complete_in_strings = 1&quot;离开插入模式后自动关闭预览窗口autocmd InsertLeave * if pumvisible() == 0|pclose|endif&quot; 空格键用于关闭补全窗口let g:ycm_key_list_stop_completion = [&#x27;&lt;space&gt;&#x27;]&quot;默认关闭代码自动提示，目前只安装了c和python语言的代码提示，所以需要代码提示时，可以在NORMAL模式下输入&#x27;\\+y&#x27;开启代码提示let g:ycm_auto_trigger=0&quot;turn on YCM：&quot;\\+y一起按，看到命令输出后回车即可，这里&lt;leader&gt;代表命令前缀，默认为\\nnoremap &lt;leader&gt;y :let g:ycm_auto_trigger=1&lt;CR&gt;&quot;turn off YCM：\\+y+y一起按nnoremap &lt;leader&gt;yy :let g:ycm_auto_trigger=0&lt;CR&gt;&quot;----------------------YouCompleteMe setting---------------------&quot;-------------NERDTree setting-----------------------&quot;######常用快捷键说明########&quot;Ctrl + t 打开/关闭nerdtree&quot;Ctrl + n 打开、回到最开始打开的文件目录&quot;Shift + f 打开上级目录&quot;&quot;Ctrl + w + w 光标在 nerdtree 和 vim 编辑窗口 之间切换&quot;Ctrl + w + (h/j/k/l) 即h左、j下、k上、l右，表示窗口切换的方向&quot;&quot;q 关闭 nerdtree&quot;o 打开选中的文件； 折叠/展开选中的目录&quot;i 打开选中的文件，与已打开文件纵向排布窗口，并跳转至该窗口&quot;gi 打开选中的文件，与已打开文件纵向排布窗口，但不跳转至该窗口&quot;s 打开选中的文件，与已打开文件横向排布窗口，并跳转至该窗口&quot;gs 打开选中的文件，与已打开文件横向排布窗口，但不跳转至该窗口&quot;t 在新 Tab 中打开选中文件/书签，并跳到新 Tab&quot;T 在新 Tab 中打开选中文件/书签，但不跳到新 Tab&quot;x 折叠选中结点的父目录&quot;X 递归折叠选中结点下的所有目录&quot;k / j 光标在 Neadtree 上下移动&quot;&quot;&lt;leader&gt;tc :tabc 关闭当前的 tab&quot;&lt;leader&gt;to :tabo 关闭所有其他 tab&quot;&lt;leader&gt;ts :tabs 查看所有打开的 tab&quot;&lt;leader&gt;tp :tabp 前一个 tab&quot;&lt;leader&gt;tn :tabn 后一个 tab&quot;? 显示菜单&quot;######常用快捷键说明########&quot; 高亮当前行let NERDTreeHighlightCursorline = 1&quot; 显示行号let NERDTreeShowLineNumbers = 1&quot; 忽略列表中的文件let NERDTreeIgnore = [ &#x27;\\.pyc$&#x27;, &#x27;\\.pyo$&#x27;, &#x27;\\.obj$&#x27;, &#x27;\\.o$&#x27;, &#x27;\\.egg$&#x27;, &#x27;^\\.git$&#x27;, &#x27;^\\.repo$&#x27;, &#x27;^\\.svn$&#x27;, &#x27;^\\.hg$&#x27; ]nnoremap &lt;leader&gt;n :NERDTreeFocus&lt;CR&gt;&quot;打开、回到最开始打开的文件目录nnoremap &lt;C-n&gt; :NERDTree&lt;CR&gt;&quot;打开、关闭目录nnoremap &lt;C-t&gt; :NERDTreeToggle&lt;CR&gt;&quot;打开上级目录nnoremap &lt;S-f&gt; :NERDTreeFind&lt;CR&gt;&quot; \\tc 关闭当前的 tabmap &lt;leader&gt;tc :tabc&lt;CR&gt;&quot; \\to 关闭所有其他的 tabmap &lt;leader&gt;to :tabo&lt;CR&gt;&quot; \\ts 查看所有打开的 tabmap &lt;leader&gt;ts :tabs&lt;CR&gt;&quot; \\tp 前一个 tabmap &lt;leader&gt;tp :tabp&lt;CR&gt;&quot; \\tn 后一个 tabmap &lt;leader&gt;tn :tabn&lt;CR&gt;&quot; Exit Vim if NERDTree is the only window left.&quot; 关闭 NERDTree，当没有文件打开的时候autocmd BufEnter * if tabpagenr(&#x27;$&#x27;) == 1 &amp;&amp; winnr(&#x27;$&#x27;) == 1 &amp;&amp; exists(&#x27;b:NERDTree&#x27;) &amp;&amp; b:NERDTree.isTabTree() | \\ quit | endif&quot; 启动 vim 时打开 NERDTree&quot;autocmd vimenter * NERDTree&quot; 当打开 VIM，没有指定文件时和打开一个目录时，打开 NERDTreeautocmd StdinReadPre * let s:std_in=1autocmd VimEnter * if argc() == 1 &amp;&amp; isdirectory(argv()[0]) &amp;&amp; !exists(&#x27;s:std_in&#x27;) | \\ execute &#x27;NERDTree&#x27; argv()[0] | wincmd p | enew | execute &#x27;cd &#x27;.argv()[0] | endifautocmd VimEnter * if argc() == 0 &amp;&amp; !exists(&#x27;s:std_in&#x27;) | NERDTree | endif&quot;-------------NERDTree setting-----------------------&quot;-----------tagbar setting---------------------------&quot;Ctrl - w - w 光标在 Tagbar 和 vim 编辑窗口 之间切换&quot;&lt;leader&gt;tb 打开 tagbar&quot;q 关闭 tagbar&quot;o（+/-） 折叠 / 展开标签集合&quot;p 跳转到选中的标签，但光标仍停留在 Tagbar&quot; tagbar 依赖 ctags 插件 brew install ctagslet g:tagbar_ctags_bin = &#x27;ctags&#x27;&quot; 设置 tagbar 的宽度为 30 列，默认 40 列let g:tagbar_width = 30&quot; 打开 tagbar 时光标在 tagbar 页面内，默认在 vim 打开的文件内let g:tagbar_autofocus = 1&quot; 让 tagbar 在页面左侧显示，默认右边let g:tagbar_left = 1&quot; 标签不排序，默认排序&quot;let g:tagbar_sort = 0&quot; &lt;leader&gt;tb 打开 tagbar 窗口，在左侧栏显示nmap &lt;leader&gt;tb :TagbarToggle&lt;CR&gt;&quot;-----------tagbar setting---------------------------&quot;----------ultisnips setting-------------------------&quot;:UltiSnipsEdit 显示帮助信息&quot;&quot; 片段信息寻找的文件夹名称，默认UltiSnips，多个逗号分隔&quot;let g:UltiSnipsSnippetDirectories = [&#x27;UltiSnips&#x27;]&quot; :UltiSnipsEdit 显示帮助信的目录路径，默认~/.vim/UltiSnipslet g:UltiSnipsSnippetStorageDirectoryForUltiSnipsEdit = &#x27;~/.vim/plugged/vim-snippets/UltiSnips&#x27;&quot; 代码片段补全触发，需要在编辑模式let g:UltiSnipsExpandTrigger = &#x27;&lt;c-w&gt;&#x27;&quot; 列出补全可选列表，需要在编辑模式，可以在输入一些字符后调用，显示当前字符的代码片段提示let g:UltiSnipsListSnippets = &#x27;&lt;c-\\&gt;&#x27;&quot; 下一条补全，需要在编辑模式，不好使let g:UltiSnipsJumpForwardTrigger = &#x27;&lt;c-b&gt;&#x27;&quot; 上一条补全，需要在编辑模式，不好使let g:UltiSnipsJumpBackwardTrigger = &#x27;&lt;c-z&gt;&#x27;&quot; 帮助信息水平显示let g:UltiSnipsEditSplit = &#x27;horizontal&#x27;&quot; 帮助信息垂直显示&quot;let g:UltiSnipsEditSplit = &#x27;vertical&#x27;&quot; python3&quot;let g:UltiSnipsUsePythonVersion = 3&quot;----------ultisnips setting--------------------------&quot;------------nerdcommenter setting--------------------&quot; \\c+空格&quot;[count]&lt;leader&gt;cc 注释当前行起始的 [count]行 或者 注释 visual mode 选中的文本&quot;[count]&lt;leader&gt;cn 注释方式同 &lt;leader&gt;cc，但是强制嵌套&quot;[count]&lt;leader&gt;c&lt;space&gt; 这个是最重要的，记住这一个就行了。切换所选行的注释状态。 如果注释了最上面的选定行，则取消注释所有选定行，反之亦然。&quot;[count]&lt;leader&gt;cm 使用一组多行注释符注释选定行&quot;[count]&lt;leader&gt;ci 单独切换所选行的各行注释状态&quot;[count]&lt;leader&gt;cs 使用块格式布局注释掉选定的行。&quot;&lt;leader&gt;c$ 注释从光标到行尾的当前行。&quot;&lt;leader&gt;cA 在行尾添加注释，并切换至插入模式，光标停留在注释符中间&quot;[count]&lt;leader&gt;cl&quot;[count]&lt;leader&gt;cb 注释方式同 &lt;leader&gt;cc，注释符左对齐（&lt;leader&gt;cl）或者两边对齐（&lt;leader&gt;cb）&quot;[count]&lt;leader&gt;cu 取消选定行的注释&quot; 在注释符号后加一个空格let g:NERDSpaceDelims = 1&quot; 紧凑排布多行注释let g:NERDCompactSexyComs = 1&quot; 逐行注释左对齐let g:NERDDefaultAlign = &#x27;left&#x27;&quot; JAVA 语言使用默认的注释符号let g:NERDAltDelims_java = 1&quot; C 语言注释符号let g:NERDCustomDelimiters = &#123;&#x27;c&#x27;: &#123;&#x27;left&#x27;: &#x27;/**&#x27;, &#x27;right&#x27;: &#x27;*/&#x27;&#125;&#125;&quot; 允许空行注释let g:NERDCommentEmptyLines = 1&quot; 取消注释时删除行尾空格let g:NERDTrimTrailingWhitespace = 1&quot; 检查选中的行操作是否成功let g:NERDToggleCheckAllLines = 1&quot;------------nerdcommenter setting--------------------&quot;------------fzf setting------------------------------&quot; 在当前目录搜索文件nnoremap &lt;Leader&gt;f :FZF&lt;CR&gt;&quot;------------fzf setting------------------------------&quot; ----------tpope/vim-surround setting---------------&quot; normal模式下，光标所在航&quot; 替换：&quot; cs&quot;&#x27; : 将光标所在行中成对出现的双引号替换为单引号&quot; cs([ : 将小括号替换为中括号&quot; cst&quot; : 将当前文本两边成对出现的引号或括号替换为双引号&quot; 删除:&quot; ds&quot; : 删除双引号&quot; 添加：&quot; ysiw&quot; : 将光标所在单词添加上双引号&quot; yss&quot; : 将当前行添加上双引号&quot; ----------tpope/vim-surround setting---------------&quot; ----------mhinz/vim-signify setting----------------&quot; default updatetime 4000ms is not good for async updateset updatetime=100&quot; ----------mhinz/vim-signify setting----------------","summary":"摘要 vim常用配置 基于vim-plug进行插件管理","date_published":"2021-01-23T14:30:05.000Z","tags":["技术","vim","vim-plug"]},{"id":"https://blog.hanqunfeng.com/2020/12/02/springboot-oauth2-jwt-webflux-clientserver/","url":"https://blog.hanqunfeng.com/2020/12/02/springboot-oauth2-jwt-webflux-clientserver/","title":"SpringBoot-OAuth2-JWT-WebFlux-ClientServer","content_html":"<h2 id=\"摘要\"><a href=\"#摘要\" class=\"headerlink\" title=\"摘要\"></a>摘要</h2><ul>\n<li>通过本文，你将知道如何搭建一个基于SpringBoot-OAuth2-JWT-WebFlux的客户端服务器</li>\n<li>本文基于springboot:2.4.0，项目基于Gradle-6.6.1构建</li>\n<li>本文基于<a href=\"https://blog.hanqunfeng.com/2020/11/15/springboot-oauth2-jwt-clientserver/\">SpringBoot-OAuth2-JWT-ClientServer</a>并实现其功能，可以参考对比</li>\n<li>代码地址:<a href=\"https://github.com/hanqunfeng/springbootchapter/tree/master/chapter48\">https://github.com/hanqunfeng/springbootchapter/tree/master/chapter48</a></li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"依赖\"><a href=\"#依赖\" class=\"headerlink\" title=\"依赖\"></a>依赖</h2><ul>\n<li>springboot官方提供了支持<figure class=\"highlight gradle\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//webflux</span></span><br><span class=\"line\">implementation <span class=\"string\">&#x27;org.springframework.boot:spring-boot-starter-webflux&#x27;</span></span><br><span class=\"line\">implementation <span class=\"string\">&#x27;org.springframework.boot:spring-boot-starter-oauth2-client&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//本项目使用了自定义授权页面，所以引入视图模板依赖和基于webjar的bootstrap，jquery</span></span><br><span class=\"line\">implementation <span class=\"string\">&#x27;org.springframework.boot:spring-boot-starter-thymeleaf&#x27;</span></span><br><span class=\"line\"><span class=\"comment\">//webjars https://www.webjars.org</span></span><br><span class=\"line\">implementation <span class=\"string\">&#x27;org.webjars:bootstrap:4.5.3&#x27;</span></span><br><span class=\"line\">implementation <span class=\"string\">&#x27;org.webjars.bower:jquery:3.5.1&#x27;</span></span><br><span class=\"line\"><span class=\"comment\">// 可以在html中去掉webjars的版本号，这样升级的时候直接修改上面引入的webjars中的版本号即可，页面中不需要修改</span></span><br><span class=\"line\">implementation <span class=\"string\">&#x27;org.webjars:webjars-locator:0.40&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//r2dbc mysql 库</span></span><br><span class=\"line\">implementation <span class=\"string\">&#x27;dev.miku:r2dbc-mysql&#x27;</span></span><br><span class=\"line\"><span class=\"comment\">//Spring r2dbc 抽象层</span></span><br><span class=\"line\">implementation <span class=\"string\">&#x27;org.springframework.boot:spring-boot-starter-data-r2dbc&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//本项目中使用了lombok减少代码量，非必须依赖</span></span><br><span class=\"line\">compileOnly <span class=\"string\">&#x27;org.projectlombok:lombok&#x27;</span></span><br><span class=\"line\">annotationProcessor <span class=\"string\">&#x27;org.projectlombok:lombok&#x27;</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h2 id=\"ReactiveSecurityConfig\"><a href=\"#ReactiveSecurityConfig\" class=\"headerlink\" title=\"ReactiveSecurityConfig\"></a>ReactiveSecurityConfig</h2><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.example.oauth2clientwebfluxdemo.config;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> com.example.oauth2clientwebfluxdemo.security.CustomReactiveAuthorizationManager;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.example.oauth2clientwebfluxdemo.security.CustomServerAccessDeniedHandler;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.example.oauth2clientwebfluxdemo.security.CustomServerAuthenticationEntryPoint;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.example.oauth2clientwebfluxdemo.security.CustomServerOAuth2AuthorizedClientRepository;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Bean;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Configuration;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.config.annotation.method.configuration.EnableReactiveMethodSecurity;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.config.annotation.web.reactive.EnableWebFluxSecurity;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.config.web.server.ServerHttpSecurity;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.web.server.SecurityWebFilterChain;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.web.server.authentication.logout.RedirectServerLogoutSuccessHandler;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.web.server.authentication.logout.ServerLogoutSuccessHandler;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.net.URI;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * &lt;h1&gt;安全认证配置&lt;/h1&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> * Created by hanqf on 2020/11/19 10:26.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Configuration</span></span><br><span class=\"line\"><span class=\"meta\">@EnableWebFluxSecurity</span> <span class=\"comment\">//必要</span></span><br><span class=\"line\"><span class=\"meta\">@EnableReactiveMethodSecurity</span> <span class=\"comment\">//启用@PreAuthorize注解配置</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ReactiveSecurityConfig</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Value(&quot;$&#123;oauth2.server.logout&#125;&quot;)</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> String oauth2_server_logout;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> CustomServerAccessDeniedHandler customServerAccessDeniedHandler;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> CustomServerAuthenticationEntryPoint customServerAuthenticationEntryPoint;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> CustomReactiveAuthorizationManager customReactiveAuthorizationManager;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> CustomServerOAuth2AuthorizedClientRepository customServerOAuth2AuthorizedClientRepository;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 注册安全验证规则</span></span><br><span class=\"line\"><span class=\"comment\">     * 配置方式与HttpSecurity基本一致</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@Bean</span></span><br><span class=\"line\">    <span class=\"function\">SecurityWebFilterChain <span class=\"title\">springSecurityFilterChain</span><span class=\"params\">(ServerHttpSecurity http)</span> </span>&#123; <span class=\"comment\">//定义SecurityWebFilterChain对安全进行控制，使用ServerHttpSecurity构造过滤器链；</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> http.authorizeExchange()</span><br><span class=\"line\">                <span class=\"comment\">//.anyExchange().authenticated() //所有请求都需要通过认证</span></span><br><span class=\"line\">                .pathMatchers(<span class=\"string\">&quot;/&quot;</span>).authenticated()</span><br><span class=\"line\">                <span class=\"comment\">//需要具备相应的角色才能访问</span></span><br><span class=\"line\">                .pathMatchers(<span class=\"string\">&quot;/user/**&quot;</span>, <span class=\"string\">&quot;/user2/**&quot;</span>).hasAuthority(<span class=\"string\">&quot;SCOPE_any&quot;</span>)</span><br><span class=\"line\">                <span class=\"comment\">//不需要登录就可以访问</span></span><br><span class=\"line\">                .pathMatchers(<span class=\"string\">&quot;/login&quot;</span>,<span class=\"string\">&quot;/webjars/**&quot;</span>).permitAll()</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"comment\">//其它路径需要根据指定的方法判断是否有权限访问，基于权限管理模型认证</span></span><br><span class=\"line\">                .anyExchange().access(customReactiveAuthorizationManager)</span><br><span class=\"line\">                <span class=\"comment\">//.anyExchange().permitAll()</span></span><br><span class=\"line\">                .and()</span><br><span class=\"line\">                .csrf().disable() <span class=\"comment\">//关闭CSRF（Cross-site request forgery）跨站请求伪造</span></span><br><span class=\"line\">                <span class=\"comment\">//必须post访问</span></span><br><span class=\"line\">                .logout().logoutUrl(<span class=\"string\">&quot;/logout&quot;</span>).logoutSuccessHandler(serverLogoutSuccessHandler())</span><br><span class=\"line\">                .and()</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"comment\">//开启oauth2登录认证</span></span><br><span class=\"line\">                .oauth2Login()</span><br><span class=\"line\">                .and()</span><br><span class=\"line\">                <span class=\"comment\">//开启基于oauth2的客户端信息</span></span><br><span class=\"line\">                .oauth2Client()</span><br><span class=\"line\">                <span class=\"comment\">//客户端信息基于数据库，基于内存去掉下面配置即可</span></span><br><span class=\"line\">                .authorizedClientRepository(customServerOAuth2AuthorizedClientRepository)</span><br><span class=\"line\">                .and().exceptionHandling()</span><br><span class=\"line\">                .accessDeniedHandler(customServerAccessDeniedHandler)</span><br><span class=\"line\">                .authenticationEntryPoint(customServerAuthenticationEntryPoint)</span><br><span class=\"line\">                .and()</span><br><span class=\"line\">                .build();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 退出重定向到认证登录页面，默认&quot;/login?logout&quot;</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> ServerLogoutSuccessHandler <span class=\"title\">serverLogoutSuccessHandler</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        RedirectServerLogoutSuccessHandler redirectServerLogoutSuccessHandler = <span class=\"keyword\">new</span> RedirectServerLogoutSuccessHandler();</span><br><span class=\"line\">        redirectServerLogoutSuccessHandler.setLogoutSuccessUrl(URI.create(oauth2_server_logout));</span><br><span class=\"line\">        <span class=\"keyword\">return</span> redirectServerLogoutSuccessHandler;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"CustomReactiveAuthorizationManager\"><a href=\"#CustomReactiveAuthorizationManager\" class=\"headerlink\" title=\"CustomReactiveAuthorizationManager\"></a>CustomReactiveAuthorizationManager</h2><p>基于RBAC权限认证管理模型的认证方式</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.example.oauth2resourceserverwebfluxdemo.security;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.http.server.reactive.ServerHttpRequest;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.authorization.AuthorizationDecision;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.authorization.ReactiveAuthorizationManager;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.core.Authentication;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.oauth2.jwt.Jwt;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.web.server.authorization.AuthorizationContext;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.stereotype.Component;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.util.AntPathMatcher;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.util.StringUtils;</span><br><span class=\"line\"><span class=\"keyword\">import</span> reactor.core.publisher.Mono;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.HashSet;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Set;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * &lt;h1&gt;ReactiveAuthorizationManager&lt;/h1&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> * Created by hanqf on 2020/11/30 12:05.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Component</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">CustomReactiveAuthorizationManager</span> <span class=\"keyword\">implements</span> <span class=\"title\">ReactiveAuthorizationManager</span>&lt;<span class=\"title\">AuthorizationContext</span>&gt; </span>&#123;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Mono&lt;AuthorizationDecision&gt; <span class=\"title\">check</span><span class=\"params\">(Mono&lt;Authentication&gt; authentication, AuthorizationContext object)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> authentication.map(auth -&gt; &#123;</span><br><span class=\"line\">            ServerHttpRequest request = object.getExchange().getRequest();</span><br><span class=\"line\">            Object principal = auth.getPrincipal();</span><br><span class=\"line\">            String username;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (principal <span class=\"keyword\">instanceof</span> Jwt) &#123;</span><br><span class=\"line\">                username = ((Jwt) principal).getClaimAsString(<span class=\"string\">&quot;user_name&quot;</span>);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                username = principal.toString();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">boolean</span> hasPerssion = <span class=\"keyword\">false</span>;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (StringUtils.hasText(username) &amp;&amp; !<span class=\"string\">&quot;anonymousUser&quot;</span>.equals(username)) &#123;</span><br><span class=\"line\">                <span class=\"comment\">//根据用户名查询用户资源权限，这里应该访问数据库查询</span></span><br><span class=\"line\">                Set&lt;String&gt; uris = <span class=\"keyword\">new</span> HashSet&lt;&gt;();</span><br><span class=\"line\">                <span class=\"keyword\">for</span> (String uri : uris) &#123;</span><br><span class=\"line\">                    <span class=\"comment\">//验证用户拥有的资源权限是否与请求的资源相匹配</span></span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (<span class=\"keyword\">new</span> AntPathMatcher().match(uri, request.getURI().toString())) &#123;</span><br><span class=\"line\">                        hasPerssion = <span class=\"keyword\">true</span>;</span><br><span class=\"line\">                        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//暂时全部返回true</span></span><br><span class=\"line\">            hasPerssion = <span class=\"keyword\">true</span>;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> AuthorizationDecision(hasPerssion);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"CustomServerAccessDeniedHandler\"><a href=\"#CustomServerAccessDeniedHandler\" class=\"headerlink\" title=\"CustomServerAccessDeniedHandler\"></a>CustomServerAccessDeniedHandler</h2><p>没有权限时的处理方式</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.example.oauth2resourceserverwebfluxdemo.security;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> com.example.oauth2resourceserverwebfluxdemo.exception.AjaxResponse;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.example.oauth2resourceserverwebfluxdemo.exception.CustomException;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.example.oauth2resourceserverwebfluxdemo.exception.CustomExceptionType;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.fasterxml.jackson.core.JsonProcessingException;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class=\"line\"><span class=\"keyword\">import</span> lombok.SneakyThrows;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.http.MediaType;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.http.server.reactive.ServerHttpResponse;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.access.AccessDeniedException;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.web.server.authorization.ServerAccessDeniedHandler;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.stereotype.Component;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.server.ServerWebExchange;</span><br><span class=\"line\"><span class=\"keyword\">import</span> reactor.core.publisher.Mono;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * &lt;h1&gt;没有权限时的处理方式&lt;/h1&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> * Created by hanqf on 2020/11/20 11:56.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Component</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">CustomServerAccessDeniedHandler</span> <span class=\"keyword\">implements</span> <span class=\"title\">ServerAccessDeniedHandler</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"meta\">@SneakyThrows</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Mono&lt;Void&gt; <span class=\"title\">handle</span><span class=\"params\">(ServerWebExchange serverWebExchange, AccessDeniedException e)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> setErrorResponse(serverWebExchange.getResponse(),e.getMessage());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> Mono&lt;Void&gt; <span class=\"title\">setErrorResponse</span><span class=\"params\">(ServerHttpResponse response, String message)</span> <span class=\"keyword\">throws</span> JsonProcessingException </span>&#123;</span><br><span class=\"line\">        response.getHeaders().setContentType(MediaType.APPLICATION_JSON);</span><br><span class=\"line\">        ObjectMapper objectMapper = <span class=\"keyword\">new</span> ObjectMapper();</span><br><span class=\"line\">        AjaxResponse ajaxResponse = AjaxResponse.error(<span class=\"keyword\">new</span> CustomException(CustomExceptionType.USER_INPUT_ERROR, message));</span><br><span class=\"line\">        <span class=\"keyword\">return</span> response.writeWith(Mono.just(response.bufferFactory().wrap(objectMapper.writeValueAsBytes(ajaxResponse))));</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"CustomServerAuthenticationEntryPoint\"><a href=\"#CustomServerAuthenticationEntryPoint\" class=\"headerlink\" title=\"CustomServerAuthenticationEntryPoint\"></a>CustomServerAuthenticationEntryPoint</h2><p>token格式错误或过期时的处理方式</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.example.oauth2resourceserverwebfluxdemo.security;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> com.example.oauth2resourceserverwebfluxdemo.exception.AjaxResponse;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.example.oauth2resourceserverwebfluxdemo.exception.CustomException;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.example.oauth2resourceserverwebfluxdemo.exception.CustomExceptionType;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.fasterxml.jackson.core.JsonProcessingException;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class=\"line\"><span class=\"keyword\">import</span> lombok.SneakyThrows;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.http.MediaType;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.http.server.reactive.ServerHttpResponse;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.core.AuthenticationException;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.web.server.ServerAuthenticationEntryPoint;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.stereotype.Component;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.server.ServerWebExchange;</span><br><span class=\"line\"><span class=\"keyword\">import</span> reactor.core.publisher.Mono;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * &lt;h1&gt;ServerAuthenticationEntryPoint&lt;/h1&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> * Created by hanqf on 2020/11/20 12:01.</span></span><br><span class=\"line\"><span class=\"comment\"> * &lt;p&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> * token格式错误或过期时的处理方式</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"meta\">@Component</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">CustomServerAuthenticationEntryPoint</span> <span class=\"keyword\">implements</span> <span class=\"title\">ServerAuthenticationEntryPoint</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"meta\">@SneakyThrows</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Mono&lt;Void&gt; <span class=\"title\">commence</span><span class=\"params\">(ServerWebExchange serverWebExchange, AuthenticationException e)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> setErrorResponse(serverWebExchange.getResponse(), e.getMessage());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> Mono&lt;Void&gt; <span class=\"title\">setErrorResponse</span><span class=\"params\">(ServerHttpResponse response, String message)</span> <span class=\"keyword\">throws</span> JsonProcessingException </span>&#123;</span><br><span class=\"line\">        response.getHeaders().setContentType(MediaType.APPLICATION_JSON);</span><br><span class=\"line\">        ObjectMapper objectMapper = <span class=\"keyword\">new</span> ObjectMapper();</span><br><span class=\"line\">        AjaxResponse ajaxResponse = AjaxResponse.error(<span class=\"keyword\">new</span> CustomException(CustomExceptionType.USER_INPUT_ERROR, message));</span><br><span class=\"line\">        <span class=\"keyword\">return</span> response.writeWith(Mono.just(response.bufferFactory().wrap(objectMapper.writeValueAsBytes(ajaxResponse))));</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"WebFluxConfig\"><a href=\"#WebFluxConfig\" class=\"headerlink\" title=\"WebFluxConfig\"></a>WebFluxConfig</h2><p>配置跨域</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.example.oauth2resourceserverwebfluxdemo.config;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Configuration;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.reactive.config.CorsRegistry;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.reactive.config.WebFluxConfigurer;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * &lt;h1&gt;WebFlux配置类&lt;/h1&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> * Created by hanqf on 2020/11/18 17:43.</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> * 我们若需要配置Spring WebFlux只需让配置配实现接口WebFluxConfigurer，</span></span><br><span class=\"line\"><span class=\"comment\"> * 这样我们既能保留Spring Boot给WebFlux配置又能添加我们的定制配置。</span></span><br><span class=\"line\"><span class=\"comment\"> * 若我们向完全控制WebFlux，则在配置类添加注解<span class=\"doctag\">@EnableWebFlux</span></span></span><br><span class=\"line\"><span class=\"comment\"> * 配置方式和Spring MVC类似</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Configuration</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">WebFluxConfig</span> <span class=\"keyword\">implements</span> <span class=\"title\">WebFluxConfigurer</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//跨域设置</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">addCorsMappings</span><span class=\"params\">(CorsRegistry registry)</span> </span>&#123;</span><br><span class=\"line\">        registry.addMapping(<span class=\"string\">&quot;/**&quot;</span>) <span class=\"comment\">//添加映射路径，“/**”表示对所有的路径实行全局跨域访问权限的设置</span></span><br><span class=\"line\">                .allowedMethods(<span class=\"string\">&quot;GET&quot;</span>,<span class=\"string\">&quot;POST&quot;</span>, <span class=\"string\">&quot;PUT&quot;</span>, <span class=\"string\">&quot;DELETE&quot;</span>) <span class=\"comment\">//开放哪些Http方法，允许跨域访问</span></span><br><span class=\"line\">                .allowedHeaders(<span class=\"string\">&quot;*&quot;</span>) <span class=\"comment\">//允许HTTP请求中的携带哪些Header信息</span></span><br><span class=\"line\">                <span class=\"comment\">//When allowCredentials is true, allowedOrigins cannot contain the special value &quot;*&quot;since that cannot be set on the &quot;Access-Control-Allow-Origin&quot; response header.</span></span><br><span class=\"line\">                <span class=\"comment\">// To allow credentials to a set of origins, list them explicitly or consider using &quot;allowedOriginPatterns&quot; instead.</span></span><br><span class=\"line\">                <span class=\"comment\">//.allowedOrigins(&quot;*&quot;) //开放哪些ip、端口、域名的访问权限</span></span><br><span class=\"line\">                .allowedOriginPatterns(<span class=\"string\">&quot;*&quot;</span>)</span><br><span class=\"line\">                .allowCredentials(<span class=\"keyword\">true</span>); <span class=\"comment\">//是否允许发送Cookie信息</span></span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"CustomServerOAuth2AuthorizedClientRepository\"><a href=\"#CustomServerOAuth2AuthorizedClientRepository\" class=\"headerlink\" title=\"CustomServerOAuth2AuthorizedClientRepository\"></a>CustomServerOAuth2AuthorizedClientRepository</h2><p>基于jdbc存储token信。</p>\n<p>这里有一个注意事项：查询时不要使用.fetch()方法，其会按照字段名称的字母排序进行赋值，导致结果中key和value匹配混乱</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.example.oauth2clientwebfluxdemo.security;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.dao.DataRetrievalFailureException;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.r2dbc.core.DatabaseClient;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.core.Authentication;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.oauth2.client.OAuth2AuthorizedClient;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.oauth2.client.registration.ClientRegistration;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.oauth2.client.registration.ReactiveClientRegistrationRepository;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.oauth2.client.web.server.ServerOAuth2AuthorizedClientRepository;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.oauth2.core.OAuth2AccessToken;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.oauth2.core.OAuth2RefreshToken;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.stereotype.Component;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.util.Assert;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.util.StringUtils;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.server.ServerWebExchange;</span><br><span class=\"line\"><span class=\"keyword\">import</span> reactor.core.publisher.Mono;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> javax.annotation.Resource;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.nio.charset.StandardCharsets;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.time.Instant;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.time.LocalDateTime;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.time.ZoneId;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.time.format.DateTimeFormatter;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Collections;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Optional;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Set;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.function.Function;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * &lt;h1&gt;ServerOAuth2AuthorizedClientRepository&lt;/h1&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> * Created by hanqf on 2020/12/1 09:58.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Component</span></span><br><span class=\"line\"><span class=\"meta\">@Slf4j</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">CustomServerOAuth2AuthorizedClientRepository</span> <span class=\"keyword\">implements</span> <span class=\"title\">ServerOAuth2AuthorizedClientRepository</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// @formatter:off</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String COLUMN_NAMES = <span class=\"string\">&quot;client_registration_id, &quot;</span></span><br><span class=\"line\">            + <span class=\"string\">&quot;principal_name, &quot;</span></span><br><span class=\"line\">            + <span class=\"string\">&quot;access_token_type, &quot;</span></span><br><span class=\"line\">            + <span class=\"string\">&quot;access_token_value, &quot;</span></span><br><span class=\"line\">            + <span class=\"string\">&quot;access_token_issued_at, &quot;</span></span><br><span class=\"line\">            + <span class=\"string\">&quot;access_token_expires_at, &quot;</span></span><br><span class=\"line\">            + <span class=\"string\">&quot;access_token_scopes, &quot;</span></span><br><span class=\"line\">            + <span class=\"string\">&quot;refresh_token_value, &quot;</span></span><br><span class=\"line\">            + <span class=\"string\">&quot;refresh_token_issued_at&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String TABLE_NAME = <span class=\"string\">&quot;oauth2_authorized_client&quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String PK_FILTER = <span class=\"string\">&quot;client_registration_id = ? AND principal_name = ?&quot;</span>;</span><br><span class=\"line\">    <span class=\"comment\">// @formatter:on</span></span><br><span class=\"line\">    <span class=\"comment\">// @formatter:off</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String LOAD_AUTHORIZED_CLIENT_SQL = <span class=\"string\">&quot;SELECT &quot;</span> + COLUMN_NAMES</span><br><span class=\"line\">            + <span class=\"string\">&quot; FROM &quot;</span> + TABLE_NAME</span><br><span class=\"line\">            + <span class=\"string\">&quot; WHERE &quot;</span> + PK_FILTER;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// @formatter:off</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String SAVE_AUTHORIZED_CLIENT_SQL = <span class=\"string\">&quot;INSERT INTO &quot;</span> + TABLE_NAME</span><br><span class=\"line\">            + <span class=\"string\">&quot; (&quot;</span> + COLUMN_NAMES + <span class=\"string\">&quot;) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)&quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String REMOVE_AUTHORIZED_CLIENT_SQL = <span class=\"string\">&quot;DELETE FROM &quot;</span> + TABLE_NAME + <span class=\"string\">&quot; WHERE &quot;</span> + PK_FILTER;</span><br><span class=\"line\">    <span class=\"comment\">// @formatter:on</span></span><br><span class=\"line\">    <span class=\"comment\">// @formatter:off</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String UPDATE_AUTHORIZED_CLIENT_SQL = <span class=\"string\">&quot;UPDATE &quot;</span> + TABLE_NAME</span><br><span class=\"line\">            + <span class=\"string\">&quot; SET access_token_type = ?, access_token_value = ?, access_token_issued_at = ?,&quot;</span></span><br><span class=\"line\">            + <span class=\"string\">&quot; access_token_expires_at = ?, access_token_scopes = ?,&quot;</span></span><br><span class=\"line\">            + <span class=\"string\">&quot; refresh_token_value = ?, refresh_token_issued_at = ?&quot;</span></span><br><span class=\"line\">            + <span class=\"string\">&quot; WHERE &quot;</span> + PK_FILTER;</span><br><span class=\"line\">    <span class=\"comment\">// @formatter:on</span></span><br><span class=\"line\">    <span class=\"meta\">@Resource</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> DatabaseClient databaseClient;</span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> ReactiveClientRegistrationRepository reactiveClientRegistrationRepository;</span><br><span class=\"line\">    <span class=\"comment\">// @formatter:on</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 这里有一个注意事项：查询时不要使用.fetch()方法，其会按照字段名称的字母排序进行赋值，导致结果中key和value匹配混乱</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> &lt;T extends OAuth2AuthorizedClient&gt; <span class=\"function\">Mono&lt;T&gt; <span class=\"title\">loadAuthorizedClient</span><span class=\"params\">(String clientRegistrationId, Authentication principal, ServerWebExchange exchange)</span> </span>&#123;</span><br><span class=\"line\">        Assert.hasText(clientRegistrationId, <span class=\"string\">&quot;clientRegistrationId cannot be empty&quot;</span>);</span><br><span class=\"line\">        Assert.hasText(principal.getName(), <span class=\"string\">&quot;principalName cannot be empty&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        Mono&lt;OAuth2AuthorizedClient&gt; oAuth2AuthorizedClientMono = databaseClient.sql(LOAD_AUTHORIZED_CLIENT_SQL)</span><br><span class=\"line\">                .bind(<span class=\"number\">0</span>, clientRegistrationId)</span><br><span class=\"line\">                .bind(<span class=\"number\">1</span>, principal.getName())</span><br><span class=\"line\">                .map(row -&gt; &#123;</span><br><span class=\"line\">                    String clientRegistrationId1 = row.get(<span class=\"string\">&quot;client_registration_id&quot;</span>, String.class);</span><br><span class=\"line\">                    String access_token_type = row.get(<span class=\"string\">&quot;access_token_type&quot;</span>, String.class);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">                    OAuth2AccessToken.TokenType tokenType = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (OAuth2AccessToken.TokenType.BEARER.getValue().equalsIgnoreCase(access_token_type)) &#123;</span><br><span class=\"line\">                        tokenType = OAuth2AccessToken.TokenType.BEARER;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                    String tokenValue = <span class=\"keyword\">new</span> String(row.get(<span class=\"string\">&quot;access_token_value&quot;</span>, <span class=\"keyword\">byte</span>[].class), StandardCharsets.UTF_8);</span><br><span class=\"line\">                    Instant issuedAt = row.get(<span class=\"string\">&quot;access_token_issued_at&quot;</span>, LocalDateTime.class).atZone(ZoneId.systemDefault()).toInstant();</span><br><span class=\"line\">                    Instant expiresAt = row.get(<span class=\"string\">&quot;access_token_expires_at&quot;</span>, LocalDateTime.class).atZone(ZoneId.systemDefault()).toInstant();</span><br><span class=\"line\">                    Set&lt;String&gt; scopes = Collections.emptySet();</span><br><span class=\"line\">                    String accessTokenScopes = row.get(<span class=\"string\">&quot;access_token_scopes&quot;</span>, String.class);</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (accessTokenScopes != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                        scopes = StringUtils.commaDelimitedListToSet(accessTokenScopes);</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                    OAuth2AccessToken accessToken = <span class=\"keyword\">new</span> OAuth2AccessToken(tokenType, tokenValue, issuedAt, expiresAt, scopes);</span><br><span class=\"line\">                    OAuth2RefreshToken refreshToken = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">                    <span class=\"keyword\">byte</span>[] refreshTokenValue = row.get(<span class=\"string\">&quot;refresh_token_value&quot;</span>, <span class=\"keyword\">byte</span>[].class);</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (refreshTokenValue != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                        tokenValue = <span class=\"keyword\">new</span> String(refreshTokenValue, StandardCharsets.UTF_8);</span><br><span class=\"line\">                        issuedAt = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">                        LocalDateTime refreshTokenIssuedAt = row.get(<span class=\"string\">&quot;refresh_token_issued_at&quot;</span>, LocalDateTime.class);</span><br><span class=\"line\">                        <span class=\"keyword\">if</span> (refreshTokenIssuedAt != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                            issuedAt = refreshTokenIssuedAt.atZone(ZoneId.systemDefault()).toInstant();</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                        refreshToken = <span class=\"keyword\">new</span> OAuth2RefreshToken(tokenValue, issuedAt);</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                    String principalName = row.get(<span class=\"string\">&quot;principal_name&quot;</span>, String.class);</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"keyword\">final</span> OAuth2RefreshToken refreshToken1 = refreshToken;</span><br><span class=\"line\"></span><br><span class=\"line\">                    Mono&lt;ClientRegistration&gt; clientRegistrationMono = reactiveClientRegistrationRepository</span><br><span class=\"line\">                            .findByRegistrationId(clientRegistrationId1);</span><br><span class=\"line\">                    <span class=\"keyword\">return</span> clientRegistrationMono</span><br><span class=\"line\">                            .switchIfEmpty(Mono.error(<span class=\"keyword\">new</span> DataRetrievalFailureException(</span><br><span class=\"line\">                                    <span class=\"string\">&quot;The ClientRegistration with id &#x27;&quot;</span> + clientRegistrationId1 + <span class=\"string\">&quot;&#x27; exists in the data source, &quot;</span></span><br><span class=\"line\">                                            + <span class=\"string\">&quot;however, it was not found in the ClientRegistrationRepository.&quot;</span>)))</span><br><span class=\"line\">                            .map(clientRegistration -&gt; <span class=\"keyword\">new</span> OAuth2AuthorizedClient(clientRegistration, principalName, accessToken, refreshToken1));</span><br><span class=\"line\">                &#125;).first().flatMap(oAuth2AuthorizedClientMono1 -&gt; oAuth2AuthorizedClientMono1);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> (Mono&lt;T&gt;) oAuth2AuthorizedClientMono.doOnNext(unused -&gt; log.info(<span class=\"string\">&quot;select client token info success!&quot;</span>));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Mono&lt;Void&gt; <span class=\"title\">saveAuthorizedClient</span><span class=\"params\">(OAuth2AuthorizedClient authorizedClient, Authentication principal, ServerWebExchange exchange)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        Assert.notNull(authorizedClient, <span class=\"string\">&quot;authorizedClient cannot be null&quot;</span>);</span><br><span class=\"line\">        Assert.notNull(principal, <span class=\"string\">&quot;principal cannot be null&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.loadAuthorizedClient(authorizedClient.getClientRegistration().getRegistrationId(), principal, exchange)</span><br><span class=\"line\">                 .flatMap((Function&lt;OAuth2AuthorizedClient, Mono&lt;Optional&lt;OAuth2AuthorizedClient&gt;&gt;&gt;) oAuth2AuthorizedClient -&gt; Mono.just(Optional.of(oAuth2AuthorizedClient)))</span><br><span class=\"line\">                 .defaultIfEmpty(Optional.empty())</span><br><span class=\"line\">                 .flatMap((Function&lt;Optional&lt;OAuth2AuthorizedClient&gt;, Mono&lt;Void&gt;&gt;) oAuth2AuthorizedClient -&gt; &#123;</span><br><span class=\"line\">                     <span class=\"keyword\">if</span>(!oAuth2AuthorizedClient.isPresent())&#123;</span><br><span class=\"line\">                         <span class=\"keyword\">return</span> insertAuthorizedClient(authorizedClient,principal);</span><br><span class=\"line\">                     &#125;<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                         <span class=\"keyword\">return</span> updateAuthorizedClient(authorizedClient, principal);</span><br><span class=\"line\">                     &#125;</span><br><span class=\"line\">                 &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> Mono&lt;Void&gt; <span class=\"title\">updateAuthorizedClient</span><span class=\"params\">(OAuth2AuthorizedClient authorizedClient, Authentication principal)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> databaseClient.sql(UPDATE_AUTHORIZED_CLIENT_SQL)</span><br><span class=\"line\">                .bind(<span class=\"number\">0</span>, authorizedClient.getAccessToken().getTokenType().getValue())</span><br><span class=\"line\">                .bind(<span class=\"number\">1</span>, authorizedClient.getAccessToken().getTokenValue().getBytes(StandardCharsets.UTF_8))</span><br><span class=\"line\">                .bind(<span class=\"number\">2</span>, timeFromInstant(authorizedClient.getAccessToken().getIssuedAt()))</span><br><span class=\"line\">                .bind(<span class=\"number\">3</span>, timeFromInstant(authorizedClient.getAccessToken().getExpiresAt()))</span><br><span class=\"line\">                .bind(<span class=\"number\">4</span>, StringUtils.collectionToCommaDelimitedString(authorizedClient.getAccessToken().getScopes()))</span><br><span class=\"line\">                .bind(<span class=\"number\">5</span>, authorizedClient.getRefreshToken().getTokenValue().getBytes(StandardCharsets.UTF_8))</span><br><span class=\"line\">                .bind(<span class=\"number\">6</span>, timeFromInstant(authorizedClient.getRefreshToken().getIssuedAt()))</span><br><span class=\"line\">                .bind(<span class=\"number\">7</span>, authorizedClient.getClientRegistration().getRegistrationId())</span><br><span class=\"line\">                .bind(<span class=\"number\">8</span>, principal.getName())</span><br><span class=\"line\">                .then()</span><br><span class=\"line\">                .doOnNext(unused -&gt; log.info(<span class=\"string\">&quot;update client token info success!&quot;</span>));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> Mono&lt;Void&gt; <span class=\"title\">insertAuthorizedClient</span><span class=\"params\">(OAuth2AuthorizedClient authorizedClient, Authentication principal)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> databaseClient.sql(SAVE_AUTHORIZED_CLIENT_SQL)</span><br><span class=\"line\">                .bind(<span class=\"number\">0</span>, authorizedClient.getClientRegistration().getRegistrationId())</span><br><span class=\"line\">                .bind(<span class=\"number\">1</span>, principal.getName())</span><br><span class=\"line\">                .bind(<span class=\"number\">2</span>, authorizedClient.getAccessToken().getTokenType().getValue())</span><br><span class=\"line\">                .bind(<span class=\"number\">3</span>, authorizedClient.getAccessToken().getTokenValue().getBytes(StandardCharsets.UTF_8))</span><br><span class=\"line\">                .bind(<span class=\"number\">4</span>, timeFromInstant(authorizedClient.getAccessToken().getIssuedAt()))</span><br><span class=\"line\">                .bind(<span class=\"number\">5</span>, timeFromInstant(authorizedClient.getAccessToken().getExpiresAt()))</span><br><span class=\"line\">                .bind(<span class=\"number\">6</span>, StringUtils.collectionToCommaDelimitedString(authorizedClient.getAccessToken().getScopes()))</span><br><span class=\"line\">                .bind(<span class=\"number\">7</span>, authorizedClient.getRefreshToken().getTokenValue().getBytes(StandardCharsets.UTF_8))</span><br><span class=\"line\">                .bind(<span class=\"number\">8</span>, timeFromInstant(authorizedClient.getRefreshToken().getIssuedAt()))</span><br><span class=\"line\">                .then()</span><br><span class=\"line\">                .doOnNext(unused -&gt; log.info(<span class=\"string\">&quot;insert client token info success!&quot;</span>));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Mono&lt;Void&gt; <span class=\"title\">removeAuthorizedClient</span><span class=\"params\">(String clientRegistrationId, Authentication principal, ServerWebExchange exchange)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        Assert.hasText(clientRegistrationId, <span class=\"string\">&quot;clientRegistrationId cannot be empty&quot;</span>);</span><br><span class=\"line\">        Assert.hasText(principal.getName(), <span class=\"string\">&quot;principalName cannot be empty&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> databaseClient.sql(REMOVE_AUTHORIZED_CLIENT_SQL)</span><br><span class=\"line\">                .bind(<span class=\"number\">0</span>, clientRegistrationId)</span><br><span class=\"line\">                .bind(<span class=\"number\">1</span>, principal.getName())</span><br><span class=\"line\">                .then()</span><br><span class=\"line\">                .doOnNext(unused -&gt; log.info(<span class=\"string\">&quot;remove client token info success!&quot;</span>));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> String <span class=\"title\">timeFromInstant</span><span class=\"params\">(Instant instant)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> DateTimeFormatter.ofPattern(<span class=\"string\">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>).format(LocalDateTime.ofInstant(instant, ZoneId.systemDefault()));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"AuthController\"><a href=\"#AuthController\" class=\"headerlink\" title=\"AuthController\"></a>AuthController</h2><p>自定义登录跳转页面</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.example.oauth2clientwebfluxdemo.controller;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> com.example.oauth2clientwebfluxdemo.security.CustomServerOAuth2AuthorizedClientRepository;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.oauth2.client.registration.InMemoryReactiveClientRegistrationRepository;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.oauth2.client.registration.ReactiveClientRegistrationRepository;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.stereotype.Controller;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.ui.Model;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.HashMap;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Map;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * &lt;h1&gt;login&lt;/h1&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> * Created by hanqf on 2020/11/30 18:02.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Controller</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">AuthController</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    ReactiveClientRegistrationRepository reactiveClientRegistrationRepository;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@GetMapping(&quot;/login&quot;)</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">login</span><span class=\"params\">(Model model)</span> </span>&#123;</span><br><span class=\"line\">        Map&lt;String, String&gt; map = <span class=\"keyword\">new</span> HashMap&lt;&gt;();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (reactiveClientRegistrationRepository <span class=\"keyword\">instanceof</span> InMemoryReactiveClientRegistrationRepository) &#123;</span><br><span class=\"line\">            ((InMemoryReactiveClientRegistrationRepository) reactiveClientRegistrationRepository).forEach(registrations -&gt; &#123;</span><br><span class=\"line\">                String registrationId = registrations.getRegistrationId();</span><br><span class=\"line\">                String clientName = registrations.getClientName();</span><br><span class=\"line\">                System.out.println(registrationId + <span class=\"string\">&quot;---&quot;</span> + clientName);</span><br><span class=\"line\">                map.put(registrationId, clientName);</span><br><span class=\"line\">            &#125;);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        model.addAttribute(<span class=\"string\">&quot;registrations&quot;</span>, map);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">&quot;oauth2/login&quot;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"login-html\"><a href=\"#login-html\" class=\"headerlink\" title=\"login.html\"></a>login.html</h2><p>自定义登录页面</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE <span class=\"meta-keyword\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span> <span class=\"attr\">lang</span>=<span class=\"string\">&quot;en&quot;</span> <span class=\"attr\">xmlns:th</span>=<span class=\"string\">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">meta</span> <span class=\"attr\">charset</span>=<span class=\"string\">&quot;UTF-8&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">meta</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;viewport&quot;</span> <span class=\"attr\">content</span>=<span class=\"string\">&quot;width=device-width, initial-scale=1, shrink-to-fit=no&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span>登录<span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">link</span> <span class=\"attr\">rel</span>=<span class=\"string\">&quot;stylesheet&quot;</span> <span class=\"attr\">th:href</span>=<span class=\"string\">&quot;@&#123;/webjars/bootstrap/css/bootstrap.min.css&#125;&quot;</span>/&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">th:src</span>=<span class=\"string\">&quot;@&#123;/webjars/jquery/jquery.min.js&#125;&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">th:src</span>=<span class=\"string\">&quot;@&#123;/webjars/bootstrap/js/bootstrap.min.js&#125;&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;container&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">h2</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;form-signin-heading&quot;</span>&gt;</span>Login with OAuth 2.0<span class=\"tag\">&lt;/<span class=\"name\">h2</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">table</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;table table-striped&quot;</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">tr</span> <span class=\"attr\">th:each</span>=<span class=\"string\">&quot;registration: $&#123;registrations&#125;&quot;</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">td</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">a</span> <span class=\"attr\">th:href</span>=<span class=\"string\">&quot;@&#123;&#x27;/oauth2/authorization/&#x27;+$&#123;registration.key&#125;&#125;&quot;</span> <span class=\"attr\">th:text</span>=<span class=\"string\">&quot;$&#123;registration.value&#125;&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">a</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">td</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">tr</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">table</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">form</span> <span class=\"attr\">th:action</span>=<span class=\"string\">&quot;@&#123;/logout&#125;&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;container&quot;</span> <span class=\"attr\">method</span>=<span class=\"string\">&quot;post&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">button</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;submit&quot;</span>&gt;</span>Logout<span class=\"tag\">&lt;/<span class=\"name\">button</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">form</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"application-yml\"><a href=\"#application-yml\" class=\"headerlink\" title=\"application.yml\"></a>application.yml</h2><figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">server:</span></span><br><span class=\"line\">  <span class=\"attr\">port:</span> <span class=\"number\">8099</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">oauth2:</span></span><br><span class=\"line\">  <span class=\"attr\">server:</span></span><br><span class=\"line\">    <span class=\"attr\">url:</span> <span class=\"string\">http://localhost:8080</span></span><br><span class=\"line\">    <span class=\"attr\">logout:</span> <span class=\"string\">$&#123;oauth2.server.url&#125;/logout</span> <span class=\"comment\">#认证服务器logout地址</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">spring:</span></span><br><span class=\"line\">  <span class=\"attr\">application:</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">oauth2-client-webflux</span></span><br><span class=\"line\">  <span class=\"comment\">#资源国际化</span></span><br><span class=\"line\">  <span class=\"attr\">messages:</span></span><br><span class=\"line\">    <span class=\"attr\">basename:</span> <span class=\"string\">static/i18n/messages</span></span><br><span class=\"line\">    <span class=\"attr\">encoding:</span> <span class=\"string\">utf-8</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">#thymeleaf</span></span><br><span class=\"line\">  <span class=\"attr\">thymeleaf:</span></span><br><span class=\"line\">    <span class=\"attr\">cache:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">    <span class=\"attr\">enabled:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">    <span class=\"attr\">encoding:</span> <span class=\"string\">UTF-8</span></span><br><span class=\"line\">    <span class=\"attr\">mode:</span> <span class=\"string\">HTML</span></span><br><span class=\"line\">    <span class=\"attr\">prefix:</span> <span class=\"string\">classpath:/templates/</span></span><br><span class=\"line\">    <span class=\"attr\">servlet:</span></span><br><span class=\"line\">      <span class=\"attr\">content-type:</span> <span class=\"string\">text/html</span></span><br><span class=\"line\">    <span class=\"attr\">suffix:</span> <span class=\"string\">.html</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">#r2dbc mysql</span></span><br><span class=\"line\">  <span class=\"attr\">r2dbc:</span></span><br><span class=\"line\">    <span class=\"attr\">url:</span> <span class=\"string\">r2dbc:mysql://localhost:3306/springboot?useUnicode=true&amp;characterEncoding=utf-8&amp;useTimezone=true&amp;serverTimezone=GMT%2B8</span></span><br><span class=\"line\">    <span class=\"attr\">username:</span> <span class=\"string\">root</span></span><br><span class=\"line\">    <span class=\"attr\">password:</span> <span class=\"string\">newpwd</span></span><br><span class=\"line\">    <span class=\"attr\">pool:</span></span><br><span class=\"line\">      <span class=\"attr\">enabled:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">      <span class=\"attr\">initial-size:</span> <span class=\"number\">5</span></span><br><span class=\"line\">      <span class=\"attr\">max-size:</span> <span class=\"number\">20</span></span><br><span class=\"line\">      <span class=\"attr\">max-idle-time:</span> <span class=\"string\">30m</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">#oauth2</span></span><br><span class=\"line\">  <span class=\"comment\"># 支持多客户端认证方式</span></span><br><span class=\"line\">  <span class=\"attr\">security:</span></span><br><span class=\"line\">    <span class=\"attr\">oauth2:</span></span><br><span class=\"line\">      <span class=\"attr\">client:</span></span><br><span class=\"line\">        <span class=\"attr\">registration:</span></span><br><span class=\"line\">          <span class=\"comment\"># /oauth2/authorization/flux-client # 认证地址</span></span><br><span class=\"line\">          <span class=\"attr\">flux-client:</span> <span class=\"comment\"># 注册名称</span></span><br><span class=\"line\">            <span class=\"attr\">client-id:</span> <span class=\"string\">postman</span> <span class=\"comment\"># 客户端登录用户名称</span></span><br><span class=\"line\">            <span class=\"attr\">client-secret:</span> <span class=\"string\">postman</span> <span class=\"comment\"># 客户端登录密码</span></span><br><span class=\"line\">            <span class=\"attr\">authorization-grant-type:</span> <span class=\"string\">authorization_code</span> <span class=\"comment\">#认证方式为code</span></span><br><span class=\"line\">            <span class=\"comment\">#回调地址，需要配置到认证服务器中</span></span><br><span class=\"line\">            <span class=\"attr\">redirect-uri:</span> <span class=\"string\">http://localhost:8099/login/oauth2/code/flux-client</span></span><br><span class=\"line\">            <span class=\"attr\">scope:</span> <span class=\"string\">any</span> <span class=\"comment\">#授权范围</span></span><br><span class=\"line\">            <span class=\"attr\">client-name:</span> <span class=\"string\">客户端1</span> <span class=\"comment\">#显示名称</span></span><br><span class=\"line\"><span class=\"comment\">#          # /oauth2/authorization/flux-client2</span></span><br><span class=\"line\">          <span class=\"attr\">flux-client2:</span></span><br><span class=\"line\">            <span class=\"attr\">client-id:</span> <span class=\"string\">demo-client</span></span><br><span class=\"line\">            <span class=\"attr\">client-secret:</span> <span class=\"string\">demo-client</span></span><br><span class=\"line\">            <span class=\"attr\">authorization-grant-type:</span> <span class=\"string\">authorization_code</span></span><br><span class=\"line\">            <span class=\"attr\">redirect-uri:</span> <span class=\"string\">http://localhost:8099/login/oauth2/code/flux-client2</span></span><br><span class=\"line\">            <span class=\"attr\">scope:</span> <span class=\"string\">any</span></span><br><span class=\"line\">            <span class=\"attr\">client-name:</span> <span class=\"string\">客户端2</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">          <span class=\"attr\">google:</span> <span class=\"comment\"># google</span></span><br><span class=\"line\">            <span class=\"attr\">client-id:</span> <span class=\"string\">xxxxxxxxx</span></span><br><span class=\"line\">            <span class=\"attr\">client-secret:</span> <span class=\"string\">xxxxxxx</span></span><br><span class=\"line\">            <span class=\"attr\">client-name:</span> <span class=\"string\">Google认证</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">          <span class=\"attr\">facebook:</span> <span class=\"comment\"># facebook</span></span><br><span class=\"line\">            <span class=\"attr\">client-id:</span> <span class=\"string\">xxxxxxxxx</span></span><br><span class=\"line\">            <span class=\"attr\">client-secret:</span> <span class=\"string\">xxxxxxx</span></span><br><span class=\"line\">            <span class=\"attr\">client-name:</span> <span class=\"string\">Facebook认证</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">          <span class=\"attr\">github:</span> <span class=\"comment\"># github</span></span><br><span class=\"line\">            <span class=\"attr\">client-id:</span> <span class=\"string\">xxxxxxxxx</span></span><br><span class=\"line\">            <span class=\"attr\">client-secret:</span> <span class=\"string\">xxxxxxx</span></span><br><span class=\"line\">            <span class=\"attr\">client-name:</span> <span class=\"string\">Github认证</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"attr\">provider:</span></span><br><span class=\"line\">          <span class=\"attr\">flux-client:</span> <span class=\"comment\"># 注册客户端的认证信息</span></span><br><span class=\"line\">            <span class=\"attr\">authorization-uri:</span> <span class=\"string\">$&#123;oauth2.server.url&#125;/oauth/authorize</span> <span class=\"comment\"># 认证服务器授权地址</span></span><br><span class=\"line\">            <span class=\"attr\">token-uri:</span> <span class=\"string\">$&#123;oauth2.server.url&#125;/oauth/token</span> <span class=\"comment\"># 认证服务器token地址</span></span><br><span class=\"line\">            <span class=\"attr\">user-info-uri:</span> <span class=\"string\">http://localhost:8080/userInfo</span> <span class=\"comment\"># 认证服务器用户信息地址</span></span><br><span class=\"line\">            <span class=\"attr\">userNameAttribute:</span> <span class=\"string\">username</span> <span class=\"comment\"># 指定user-info-uri返回map中的属性名称用于表示用户名</span></span><br><span class=\"line\">          <span class=\"attr\">flux-client2:</span></span><br><span class=\"line\">            <span class=\"attr\">authorization-uri:</span> <span class=\"string\">$&#123;oauth2.server.url&#125;/oauth/authorize</span></span><br><span class=\"line\">            <span class=\"attr\">token-uri:</span> <span class=\"string\">$&#123;oauth2.server.url&#125;/oauth/token</span></span><br><span class=\"line\">            <span class=\"attr\">user-info-uri:</span> <span class=\"string\">http://localhost:8080/userInfo</span></span><br><span class=\"line\">            <span class=\"attr\">userNameAttribute:</span> <span class=\"string\">username</span></span><br><span class=\"line\"><span class=\"attr\">debug:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 可以打印sql</span></span><br><span class=\"line\"><span class=\"attr\">logging:</span></span><br><span class=\"line\">  <span class=\"attr\">level:</span></span><br><span class=\"line\">    <span class=\"attr\">org.springframework.data.r2dbc:</span> <span class=\"string\">DEBUG</span></span><br></pre></td></tr></table></figure>\n\n\n<h2 id=\"ResController\"><a href=\"#ResController\" class=\"headerlink\" title=\"ResController\"></a>ResController</h2><p>请求资源服务示例</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.example.oauth2clientwebfluxdemo.controller;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> com.example.oauth2clientwebfluxdemo.exception.AjaxResponse;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.example.oauth2clientwebfluxdemo.exception.CustomException;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.example.oauth2clientwebfluxdemo.exception.CustomExceptionType;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.example.oauth2clientwebfluxdemo.security.CustomServerOAuth2AuthorizedClientRepository;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.http.HttpHeaders;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.core.Authentication;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.oauth2.client.OAuth2AuthorizedClient;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.oauth2.client.authentication.OAuth2AuthenticationToken;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.reactive.function.client.WebClient;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.server.ServerWebExchange;</span><br><span class=\"line\"><span class=\"keyword\">import</span> reactor.core.publisher.Mono;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.HashMap;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Map;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * &lt;h1&gt;获取资源服务器数据&lt;/h1&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> * Created by hanqf on 2020/11/7 22:47.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@RestController</span></span><br><span class=\"line\"><span class=\"meta\">@RequestMapping(&quot;/res&quot;)</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ResController</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> WebClient CLIENT = WebClient.create(<span class=\"string\">&quot;http://localhost:8083&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> CustomServerOAuth2AuthorizedClientRepository customServerOAuth2AuthorizedClientRepository;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 获取资源服务器的数据</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@RequestMapping(&quot;/res1&quot;)</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Mono&lt;AjaxResponse&gt; <span class=\"title\">getRes</span><span class=\"params\">(Authentication principal, ServerWebExchange exchange)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (principal <span class=\"keyword\">instanceof</span> OAuth2AuthenticationToken) &#123;</span><br><span class=\"line\">            String authorizedClientRegistrationId = ((OAuth2AuthenticationToken) principal).getAuthorizedClientRegistrationId();</span><br><span class=\"line\">            Mono&lt;OAuth2AuthorizedClient&gt; oAuth2AuthorizedClientMono = customServerOAuth2AuthorizedClientRepository.loadAuthorizedClient(authorizedClientRegistrationId, principal, exchange);</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">return</span> oAuth2AuthorizedClientMono.flatMap(client -&gt; &#123;</span><br><span class=\"line\">                String tokenValue = client.getAccessToken().getTokenValue();</span><br><span class=\"line\">                String tokenType = client.getAccessToken().getTokenType().getValue();</span><br><span class=\"line\">                <span class=\"keyword\">return</span> CLIENT.get()</span><br><span class=\"line\">                        .uri(<span class=\"string\">&quot;/res/res1&quot;</span>)</span><br><span class=\"line\">                        <span class=\"comment\">//增加了Bearer安全认证，所以这里需要传递header认证信息</span></span><br><span class=\"line\">                        .header(HttpHeaders.AUTHORIZATION,</span><br><span class=\"line\">                                tokenType + <span class=\"string\">&quot; &quot;</span> + tokenValue)</span><br><span class=\"line\">                        .retrieve()<span class=\"comment\">//异步接收服务端响应</span></span><br><span class=\"line\">                        .bodyToMono(AjaxResponse.class)</span><br><span class=\"line\">                        .retry(<span class=\"number\">3</span>)</span><br><span class=\"line\">                        .defaultIfEmpty(AjaxResponse.success(<span class=\"string\">&quot;返回结果为Null&quot;</span>));</span><br><span class=\"line\">            &#125;);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> Mono.just(AjaxResponse.error(<span class=\"keyword\">new</span> CustomException(CustomExceptionType.SYSTEM_ERROR,<span class=\"string\">&quot;Authentication类型转换异常&quot;</span>)));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@RequestMapping(&quot;/user&quot;)</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Mono&lt;AjaxResponse&gt; <span class=\"title\">getUser</span><span class=\"params\">(Authentication principal, ServerWebExchange exchange)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (principal <span class=\"keyword\">instanceof</span> OAuth2AuthenticationToken) &#123;</span><br><span class=\"line\">            String authorizedClientRegistrationId = ((OAuth2AuthenticationToken) principal).getAuthorizedClientRegistrationId();</span><br><span class=\"line\">            Mono&lt;OAuth2AuthorizedClient&gt; oAuth2AuthorizedClientMono = customServerOAuth2AuthorizedClientRepository.loadAuthorizedClient(authorizedClientRegistrationId, principal, exchange);</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">return</span> oAuth2AuthorizedClientMono.flatMap(client -&gt; &#123;</span><br><span class=\"line\">                String tokenValue = client.getAccessToken().getTokenValue();</span><br><span class=\"line\">                String tokenType = client.getAccessToken().getTokenType().getValue();</span><br><span class=\"line\">                <span class=\"keyword\">return</span> CLIENT.post()</span><br><span class=\"line\">                        .uri(<span class=\"string\">&quot;/user&quot;</span>)</span><br><span class=\"line\">                        <span class=\"comment\">//增加了Bearer安全认证，所以这里需要传递header认证信息</span></span><br><span class=\"line\">                        .header(HttpHeaders.AUTHORIZATION,</span><br><span class=\"line\">                                tokenType + <span class=\"string\">&quot; &quot;</span> + tokenValue)</span><br><span class=\"line\">                        .retrieve()<span class=\"comment\">//异步接收服务端响应</span></span><br><span class=\"line\">                        .bodyToMono(AjaxResponse.class)</span><br><span class=\"line\">                        .retry(<span class=\"number\">3</span>)</span><br><span class=\"line\">                        .defaultIfEmpty(AjaxResponse.success(<span class=\"string\">&quot;返回结果为Null&quot;</span>));</span><br><span class=\"line\">            &#125;);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> Mono.just(AjaxResponse.error(<span class=\"keyword\">new</span> CustomException(CustomExceptionType.SYSTEM_ERROR,<span class=\"string\">&quot;Authentication类型转换异常&quot;</span>)));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@RequestMapping(&quot;/rbac&quot;)</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Mono&lt;AjaxResponse&gt; <span class=\"title\">getRbac</span><span class=\"params\">(Authentication principal, ServerWebExchange exchange)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (principal <span class=\"keyword\">instanceof</span> OAuth2AuthenticationToken) &#123;</span><br><span class=\"line\">            String authorizedClientRegistrationId = ((OAuth2AuthenticationToken) principal).getAuthorizedClientRegistrationId();</span><br><span class=\"line\">            Mono&lt;OAuth2AuthorizedClient&gt; oAuth2AuthorizedClientMono = customServerOAuth2AuthorizedClientRepository.loadAuthorizedClient(authorizedClientRegistrationId, principal, exchange);</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">return</span> oAuth2AuthorizedClientMono.flatMap(client -&gt; &#123;</span><br><span class=\"line\">                String tokenValue = client.getAccessToken().getTokenValue();</span><br><span class=\"line\">                String tokenType = client.getAccessToken().getTokenType().getValue();</span><br><span class=\"line\">                <span class=\"keyword\">return</span> CLIENT.get()</span><br><span class=\"line\">                        .uri(<span class=\"string\">&quot;/rbac&quot;</span>)</span><br><span class=\"line\">                        <span class=\"comment\">//增加了Bearer安全认证，所以这里需要传递header认证信息</span></span><br><span class=\"line\">                        .header(HttpHeaders.AUTHORIZATION,</span><br><span class=\"line\">                                tokenType + <span class=\"string\">&quot; &quot;</span> + tokenValue)</span><br><span class=\"line\">                        .retrieve()<span class=\"comment\">//异步接收服务端响应</span></span><br><span class=\"line\">                        .bodyToMono(AjaxResponse.class)</span><br><span class=\"line\">                        .retry(<span class=\"number\">3</span>)</span><br><span class=\"line\">                        .defaultIfEmpty(AjaxResponse.success(<span class=\"string\">&quot;返回结果为Null&quot;</span>));</span><br><span class=\"line\">            &#125;);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> Mono.just(AjaxResponse.error(<span class=\"keyword\">new</span> CustomException(CustomExceptionType.SYSTEM_ERROR,<span class=\"string\">&quot;Authentication类型转换异常&quot;</span>)));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@RequestMapping(&quot;/userInfo&quot;)</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Mono&lt;Map&gt; <span class=\"title\">getuserInfo</span><span class=\"params\">(Authentication principal, ServerWebExchange exchange)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (principal <span class=\"keyword\">instanceof</span> OAuth2AuthenticationToken) &#123;</span><br><span class=\"line\">            String authorizedClientRegistrationId = ((OAuth2AuthenticationToken) principal).getAuthorizedClientRegistrationId();</span><br><span class=\"line\">            Mono&lt;OAuth2AuthorizedClient&gt; oAuth2AuthorizedClientMono = customServerOAuth2AuthorizedClientRepository.loadAuthorizedClient(authorizedClientRegistrationId, principal, exchange);</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">return</span> oAuth2AuthorizedClientMono.flatMap(client -&gt; &#123;</span><br><span class=\"line\">                String tokenValue = client.getAccessToken().getTokenValue();</span><br><span class=\"line\">                String tokenType = client.getAccessToken().getTokenType().getValue();</span><br><span class=\"line\">                <span class=\"keyword\">return</span> CLIENT.get()</span><br><span class=\"line\">                        .uri(<span class=\"string\">&quot;/userInfo&quot;</span>)</span><br><span class=\"line\">                        <span class=\"comment\">//增加了Bearer安全认证，所以这里需要传递header认证信息</span></span><br><span class=\"line\">                        .header(HttpHeaders.AUTHORIZATION,</span><br><span class=\"line\">                                tokenType + <span class=\"string\">&quot; &quot;</span> + tokenValue)</span><br><span class=\"line\">                        .retrieve()<span class=\"comment\">//异步接收服务端响应</span></span><br><span class=\"line\">                        .bodyToMono(Map.class)</span><br><span class=\"line\">                        .retry(<span class=\"number\">3</span>)</span><br><span class=\"line\">                        .defaultIfEmpty(<span class=\"keyword\">new</span> HashMap());</span><br><span class=\"line\">            &#125;);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> Mono.error(<span class=\"keyword\">new</span> CustomException(CustomExceptionType.SYSTEM_ERROR,<span class=\"string\">&quot;Authentication类型转换异常&quot;</span>));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>","content_text":"摘要 通过本文，你将知道如何搭建一个基于SpringBoot-OAuth2-JWT-WebFlux的客户端服务器 本文基于springboot:2.4.0，项目基于Gradle-6.6.1构建 本文基于SpringBoot-OAuth2-JWT-ClientServer并实现其功能，可以参考对比 代码地址:https://github.com/hanqunfeng/springbootchapter/tree/master/chapter48 依赖 springboot官方提供了支持12345678910111213141516171819202122//webfluximplementation &#x27;org.springframework.boot:spring-boot-starter-webflux&#x27;implementation &#x27;org.springframework.boot:spring-boot-starter-oauth2-client&#x27;//本项目使用了自定义授权页面，所以引入视图模板依赖和基于webjar的bootstrap，jqueryimplementation &#x27;org.springframework.boot:spring-boot-starter-thymeleaf&#x27;//webjars https://www.webjars.orgimplementation &#x27;org.webjars:bootstrap:4.5.3&#x27;implementation &#x27;org.webjars.bower:jquery:3.5.1&#x27;// 可以在html中去掉webjars的版本号，这样升级的时候直接修改上面引入的webjars中的版本号即可，页面中不需要修改implementation &#x27;org.webjars:webjars-locator:0.40&#x27;//r2dbc mysql 库implementation &#x27;dev.miku:r2dbc-mysql&#x27;//Spring r2dbc 抽象层implementation &#x27;org.springframework.boot:spring-boot-starter-data-r2dbc&#x27;//本项目中使用了lombok减少代码量，非必须依赖compileOnly &#x27;org.projectlombok:lombok&#x27;annotationProcessor &#x27;org.projectlombok:lombok&#x27; ReactiveSecurityConfig123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293package com.example.oauth2clientwebfluxdemo.config;import com.example.oauth2clientwebfluxdemo.security.CustomReactiveAuthorizationManager;import com.example.oauth2clientwebfluxdemo.security.CustomServerAccessDeniedHandler;import com.example.oauth2clientwebfluxdemo.security.CustomServerAuthenticationEntryPoint;import com.example.oauth2clientwebfluxdemo.security.CustomServerOAuth2AuthorizedClientRepository;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.beans.factory.annotation.Value;import org.springframework.context.annotation.Bean;import org.springframework.context.annotation.Configuration;import org.springframework.security.config.annotation.method.configuration.EnableReactiveMethodSecurity;import org.springframework.security.config.annotation.web.reactive.EnableWebFluxSecurity;import org.springframework.security.config.web.server.ServerHttpSecurity;import org.springframework.security.web.server.SecurityWebFilterChain;import org.springframework.security.web.server.authentication.logout.RedirectServerLogoutSuccessHandler;import org.springframework.security.web.server.authentication.logout.ServerLogoutSuccessHandler;import java.net.URI;/** * &lt;h1&gt;安全认证配置&lt;/h1&gt; * Created by hanqf on 2020/11/19 10:26. */@Configuration@EnableWebFluxSecurity //必要@EnableReactiveMethodSecurity //启用@PreAuthorize注解配置public class ReactiveSecurityConfig &#123; @Value(&quot;$&#123;oauth2.server.logout&#125;&quot;) private String oauth2_server_logout; @Autowired private CustomServerAccessDeniedHandler customServerAccessDeniedHandler; @Autowired private CustomServerAuthenticationEntryPoint customServerAuthenticationEntryPoint; @Autowired private CustomReactiveAuthorizationManager customReactiveAuthorizationManager; @Autowired private CustomServerOAuth2AuthorizedClientRepository customServerOAuth2AuthorizedClientRepository; /** * 注册安全验证规则 * 配置方式与HttpSecurity基本一致 */ @Bean SecurityWebFilterChain springSecurityFilterChain(ServerHttpSecurity http) &#123; //定义SecurityWebFilterChain对安全进行控制，使用ServerHttpSecurity构造过滤器链； return http.authorizeExchange() //.anyExchange().authenticated() //所有请求都需要通过认证 .pathMatchers(&quot;/&quot;).authenticated() //需要具备相应的角色才能访问 .pathMatchers(&quot;/user/**&quot;, &quot;/user2/**&quot;).hasAuthority(&quot;SCOPE_any&quot;) //不需要登录就可以访问 .pathMatchers(&quot;/login&quot;,&quot;/webjars/**&quot;).permitAll() //其它路径需要根据指定的方法判断是否有权限访问，基于权限管理模型认证 .anyExchange().access(customReactiveAuthorizationManager) //.anyExchange().permitAll() .and() .csrf().disable() //关闭CSRF（Cross-site request forgery）跨站请求伪造 //必须post访问 .logout().logoutUrl(&quot;/logout&quot;).logoutSuccessHandler(serverLogoutSuccessHandler()) .and() //开启oauth2登录认证 .oauth2Login() .and() //开启基于oauth2的客户端信息 .oauth2Client() //客户端信息基于数据库，基于内存去掉下面配置即可 .authorizedClientRepository(customServerOAuth2AuthorizedClientRepository) .and().exceptionHandling() .accessDeniedHandler(customServerAccessDeniedHandler) .authenticationEntryPoint(customServerAuthenticationEntryPoint) .and() .build(); &#125; /** * 退出重定向到认证登录页面，默认&quot;/login?logout&quot; */ public ServerLogoutSuccessHandler serverLogoutSuccessHandler()&#123; RedirectServerLogoutSuccessHandler redirectServerLogoutSuccessHandler = new RedirectServerLogoutSuccessHandler(); redirectServerLogoutSuccessHandler.setLogoutSuccessUrl(URI.create(oauth2_server_logout)); return redirectServerLogoutSuccessHandler; &#125;&#125; CustomReactiveAuthorizationManager基于RBAC权限认证管理模型的认证方式 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253package com.example.oauth2resourceserverwebfluxdemo.security;import org.springframework.http.server.reactive.ServerHttpRequest;import org.springframework.security.authorization.AuthorizationDecision;import org.springframework.security.authorization.ReactiveAuthorizationManager;import org.springframework.security.core.Authentication;import org.springframework.security.oauth2.jwt.Jwt;import org.springframework.security.web.server.authorization.AuthorizationContext;import org.springframework.stereotype.Component;import org.springframework.util.AntPathMatcher;import org.springframework.util.StringUtils;import reactor.core.publisher.Mono;import java.util.HashSet;import java.util.Set;/** * &lt;h1&gt;ReactiveAuthorizationManager&lt;/h1&gt; * Created by hanqf on 2020/11/30 12:05. */@Componentpublic class CustomReactiveAuthorizationManager implements ReactiveAuthorizationManager&lt;AuthorizationContext&gt; &#123; @Override public Mono&lt;AuthorizationDecision&gt; check(Mono&lt;Authentication&gt; authentication, AuthorizationContext object) &#123; return authentication.map(auth -&gt; &#123; ServerHttpRequest request = object.getExchange().getRequest(); Object principal = auth.getPrincipal(); String username; if (principal instanceof Jwt) &#123; username = ((Jwt) principal).getClaimAsString(&quot;user_name&quot;); &#125; else &#123; username = principal.toString(); &#125; boolean hasPerssion = false; if (StringUtils.hasText(username) &amp;&amp; !&quot;anonymousUser&quot;.equals(username)) &#123; //根据用户名查询用户资源权限，这里应该访问数据库查询 Set&lt;String&gt; uris = new HashSet&lt;&gt;(); for (String uri : uris) &#123; //验证用户拥有的资源权限是否与请求的资源相匹配 if (new AntPathMatcher().match(uri, request.getURI().toString())) &#123; hasPerssion = true; break; &#125; &#125; &#125; //暂时全部返回true hasPerssion = true; return new AuthorizationDecision(hasPerssion); &#125;); &#125;&#125; CustomServerAccessDeniedHandler没有权限时的处理方式 1234567891011121314151617181920212223242526272829303132333435363738package com.example.oauth2resourceserverwebfluxdemo.security;import com.example.oauth2resourceserverwebfluxdemo.exception.AjaxResponse;import com.example.oauth2resourceserverwebfluxdemo.exception.CustomException;import com.example.oauth2resourceserverwebfluxdemo.exception.CustomExceptionType;import com.fasterxml.jackson.core.JsonProcessingException;import com.fasterxml.jackson.databind.ObjectMapper;import lombok.SneakyThrows;import org.springframework.http.MediaType;import org.springframework.http.server.reactive.ServerHttpResponse;import org.springframework.security.access.AccessDeniedException;import org.springframework.security.web.server.authorization.ServerAccessDeniedHandler;import org.springframework.stereotype.Component;import org.springframework.web.server.ServerWebExchange;import reactor.core.publisher.Mono;/** * &lt;h1&gt;没有权限时的处理方式&lt;/h1&gt; * Created by hanqf on 2020/11/20 11:56. */@Componentpublic class CustomServerAccessDeniedHandler implements ServerAccessDeniedHandler &#123; @SneakyThrows @Override public Mono&lt;Void&gt; handle(ServerWebExchange serverWebExchange, AccessDeniedException e) &#123; return setErrorResponse(serverWebExchange.getResponse(),e.getMessage()); &#125; protected Mono&lt;Void&gt; setErrorResponse(ServerHttpResponse response, String message) throws JsonProcessingException &#123; response.getHeaders().setContentType(MediaType.APPLICATION_JSON); ObjectMapper objectMapper = new ObjectMapper(); AjaxResponse ajaxResponse = AjaxResponse.error(new CustomException(CustomExceptionType.USER_INPUT_ERROR, message)); return response.writeWith(Mono.just(response.bufferFactory().wrap(objectMapper.writeValueAsBytes(ajaxResponse)))); &#125;&#125; CustomServerAuthenticationEntryPointtoken格式错误或过期时的处理方式 123456789101112131415161718192021222324252627282930313233343536373839package com.example.oauth2resourceserverwebfluxdemo.security;import com.example.oauth2resourceserverwebfluxdemo.exception.AjaxResponse;import com.example.oauth2resourceserverwebfluxdemo.exception.CustomException;import com.example.oauth2resourceserverwebfluxdemo.exception.CustomExceptionType;import com.fasterxml.jackson.core.JsonProcessingException;import com.fasterxml.jackson.databind.ObjectMapper;import lombok.SneakyThrows;import org.springframework.http.MediaType;import org.springframework.http.server.reactive.ServerHttpResponse;import org.springframework.security.core.AuthenticationException;import org.springframework.security.web.server.ServerAuthenticationEntryPoint;import org.springframework.stereotype.Component;import org.springframework.web.server.ServerWebExchange;import reactor.core.publisher.Mono;/** * &lt;h1&gt;ServerAuthenticationEntryPoint&lt;/h1&gt; * Created by hanqf on 2020/11/20 12:01. * &lt;p&gt; * token格式错误或过期时的处理方式 */@Componentpublic class CustomServerAuthenticationEntryPoint implements ServerAuthenticationEntryPoint &#123; @SneakyThrows @Override public Mono&lt;Void&gt; commence(ServerWebExchange serverWebExchange, AuthenticationException e) &#123; return setErrorResponse(serverWebExchange.getResponse(), e.getMessage()); &#125; protected Mono&lt;Void&gt; setErrorResponse(ServerHttpResponse response, String message) throws JsonProcessingException &#123; response.getHeaders().setContentType(MediaType.APPLICATION_JSON); ObjectMapper objectMapper = new ObjectMapper(); AjaxResponse ajaxResponse = AjaxResponse.error(new CustomException(CustomExceptionType.USER_INPUT_ERROR, message)); return response.writeWith(Mono.just(response.bufferFactory().wrap(objectMapper.writeValueAsBytes(ajaxResponse)))); &#125;&#125; WebFluxConfig配置跨域 123456789101112131415161718192021222324252627282930313233package com.example.oauth2resourceserverwebfluxdemo.config;import org.springframework.context.annotation.Configuration;import org.springframework.web.reactive.config.CorsRegistry;import org.springframework.web.reactive.config.WebFluxConfigurer;/** * &lt;h1&gt;WebFlux配置类&lt;/h1&gt; * Created by hanqf on 2020/11/18 17:43. * * 我们若需要配置Spring WebFlux只需让配置配实现接口WebFluxConfigurer， * 这样我们既能保留Spring Boot给WebFlux配置又能添加我们的定制配置。 * 若我们向完全控制WebFlux，则在配置类添加注解@EnableWebFlux * 配置方式和Spring MVC类似 */@Configurationpublic class WebFluxConfig implements WebFluxConfigurer &#123; //跨域设置 @Override public void addCorsMappings(CorsRegistry registry) &#123; registry.addMapping(&quot;/**&quot;) //添加映射路径，“/**”表示对所有的路径实行全局跨域访问权限的设置 .allowedMethods(&quot;GET&quot;,&quot;POST&quot;, &quot;PUT&quot;, &quot;DELETE&quot;) //开放哪些Http方法，允许跨域访问 .allowedHeaders(&quot;*&quot;) //允许HTTP请求中的携带哪些Header信息 //When allowCredentials is true, allowedOrigins cannot contain the special value &quot;*&quot;since that cannot be set on the &quot;Access-Control-Allow-Origin&quot; response header. // To allow credentials to a set of origins, list them explicitly or consider using &quot;allowedOriginPatterns&quot; instead. //.allowedOrigins(&quot;*&quot;) //开放哪些ip、端口、域名的访问权限 .allowedOriginPatterns(&quot;*&quot;) .allowCredentials(true); //是否允许发送Cookie信息 &#125;&#125; CustomServerOAuth2AuthorizedClientRepository基于jdbc存储token信。 这里有一个注意事项：查询时不要使用.fetch()方法，其会按照字段名称的字母排序进行赋值，导致结果中key和value匹配混乱 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200package com.example.oauth2clientwebfluxdemo.security;import lombok.extern.slf4j.Slf4j;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.dao.DataRetrievalFailureException;import org.springframework.r2dbc.core.DatabaseClient;import org.springframework.security.core.Authentication;import org.springframework.security.oauth2.client.OAuth2AuthorizedClient;import org.springframework.security.oauth2.client.registration.ClientRegistration;import org.springframework.security.oauth2.client.registration.ReactiveClientRegistrationRepository;import org.springframework.security.oauth2.client.web.server.ServerOAuth2AuthorizedClientRepository;import org.springframework.security.oauth2.core.OAuth2AccessToken;import org.springframework.security.oauth2.core.OAuth2RefreshToken;import org.springframework.stereotype.Component;import org.springframework.util.Assert;import org.springframework.util.StringUtils;import org.springframework.web.server.ServerWebExchange;import reactor.core.publisher.Mono;import javax.annotation.Resource;import java.nio.charset.StandardCharsets;import java.time.Instant;import java.time.LocalDateTime;import java.time.ZoneId;import java.time.format.DateTimeFormatter;import java.util.Collections;import java.util.Optional;import java.util.Set;import java.util.function.Function;/** * &lt;h1&gt;ServerOAuth2AuthorizedClientRepository&lt;/h1&gt; * Created by hanqf on 2020/12/1 09:58. */@Component@Slf4jpublic class CustomServerOAuth2AuthorizedClientRepository implements ServerOAuth2AuthorizedClientRepository &#123; // @formatter:off private static final String COLUMN_NAMES = &quot;client_registration_id, &quot; + &quot;principal_name, &quot; + &quot;access_token_type, &quot; + &quot;access_token_value, &quot; + &quot;access_token_issued_at, &quot; + &quot;access_token_expires_at, &quot; + &quot;access_token_scopes, &quot; + &quot;refresh_token_value, &quot; + &quot;refresh_token_issued_at&quot;; private static final String TABLE_NAME = &quot;oauth2_authorized_client&quot;; private static final String PK_FILTER = &quot;client_registration_id = ? AND principal_name = ?&quot;; // @formatter:on // @formatter:off private static final String LOAD_AUTHORIZED_CLIENT_SQL = &quot;SELECT &quot; + COLUMN_NAMES + &quot; FROM &quot; + TABLE_NAME + &quot; WHERE &quot; + PK_FILTER; // @formatter:off private static final String SAVE_AUTHORIZED_CLIENT_SQL = &quot;INSERT INTO &quot; + TABLE_NAME + &quot; (&quot; + COLUMN_NAMES + &quot;) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)&quot;; private static final String REMOVE_AUTHORIZED_CLIENT_SQL = &quot;DELETE FROM &quot; + TABLE_NAME + &quot; WHERE &quot; + PK_FILTER; // @formatter:on // @formatter:off private static final String UPDATE_AUTHORIZED_CLIENT_SQL = &quot;UPDATE &quot; + TABLE_NAME + &quot; SET access_token_type = ?, access_token_value = ?, access_token_issued_at = ?,&quot; + &quot; access_token_expires_at = ?, access_token_scopes = ?,&quot; + &quot; refresh_token_value = ?, refresh_token_issued_at = ?&quot; + &quot; WHERE &quot; + PK_FILTER; // @formatter:on @Resource private DatabaseClient databaseClient; @Autowired private ReactiveClientRegistrationRepository reactiveClientRegistrationRepository; // @formatter:on /** * 这里有一个注意事项：查询时不要使用.fetch()方法，其会按照字段名称的字母排序进行赋值，导致结果中key和value匹配混乱 */ @Override public &lt;T extends OAuth2AuthorizedClient&gt; Mono&lt;T&gt; loadAuthorizedClient(String clientRegistrationId, Authentication principal, ServerWebExchange exchange) &#123; Assert.hasText(clientRegistrationId, &quot;clientRegistrationId cannot be empty&quot;); Assert.hasText(principal.getName(), &quot;principalName cannot be empty&quot;); Mono&lt;OAuth2AuthorizedClient&gt; oAuth2AuthorizedClientMono = databaseClient.sql(LOAD_AUTHORIZED_CLIENT_SQL) .bind(0, clientRegistrationId) .bind(1, principal.getName()) .map(row -&gt; &#123; String clientRegistrationId1 = row.get(&quot;client_registration_id&quot;, String.class); String access_token_type = row.get(&quot;access_token_type&quot;, String.class); OAuth2AccessToken.TokenType tokenType = null; if (OAuth2AccessToken.TokenType.BEARER.getValue().equalsIgnoreCase(access_token_type)) &#123; tokenType = OAuth2AccessToken.TokenType.BEARER; &#125; String tokenValue = new String(row.get(&quot;access_token_value&quot;, byte[].class), StandardCharsets.UTF_8); Instant issuedAt = row.get(&quot;access_token_issued_at&quot;, LocalDateTime.class).atZone(ZoneId.systemDefault()).toInstant(); Instant expiresAt = row.get(&quot;access_token_expires_at&quot;, LocalDateTime.class).atZone(ZoneId.systemDefault()).toInstant(); Set&lt;String&gt; scopes = Collections.emptySet(); String accessTokenScopes = row.get(&quot;access_token_scopes&quot;, String.class); if (accessTokenScopes != null) &#123; scopes = StringUtils.commaDelimitedListToSet(accessTokenScopes); &#125; OAuth2AccessToken accessToken = new OAuth2AccessToken(tokenType, tokenValue, issuedAt, expiresAt, scopes); OAuth2RefreshToken refreshToken = null; byte[] refreshTokenValue = row.get(&quot;refresh_token_value&quot;, byte[].class); if (refreshTokenValue != null) &#123; tokenValue = new String(refreshTokenValue, StandardCharsets.UTF_8); issuedAt = null; LocalDateTime refreshTokenIssuedAt = row.get(&quot;refresh_token_issued_at&quot;, LocalDateTime.class); if (refreshTokenIssuedAt != null) &#123; issuedAt = refreshTokenIssuedAt.atZone(ZoneId.systemDefault()).toInstant(); &#125; refreshToken = new OAuth2RefreshToken(tokenValue, issuedAt); &#125; String principalName = row.get(&quot;principal_name&quot;, String.class); final OAuth2RefreshToken refreshToken1 = refreshToken; Mono&lt;ClientRegistration&gt; clientRegistrationMono = reactiveClientRegistrationRepository .findByRegistrationId(clientRegistrationId1); return clientRegistrationMono .switchIfEmpty(Mono.error(new DataRetrievalFailureException( &quot;The ClientRegistration with id &#x27;&quot; + clientRegistrationId1 + &quot;&#x27; exists in the data source, &quot; + &quot;however, it was not found in the ClientRegistrationRepository.&quot;))) .map(clientRegistration -&gt; new OAuth2AuthorizedClient(clientRegistration, principalName, accessToken, refreshToken1)); &#125;).first().flatMap(oAuth2AuthorizedClientMono1 -&gt; oAuth2AuthorizedClientMono1); return (Mono&lt;T&gt;) oAuth2AuthorizedClientMono.doOnNext(unused -&gt; log.info(&quot;select client token info success!&quot;)); &#125; @Override public Mono&lt;Void&gt; saveAuthorizedClient(OAuth2AuthorizedClient authorizedClient, Authentication principal, ServerWebExchange exchange) &#123; Assert.notNull(authorizedClient, &quot;authorizedClient cannot be null&quot;); Assert.notNull(principal, &quot;principal cannot be null&quot;); return this.loadAuthorizedClient(authorizedClient.getClientRegistration().getRegistrationId(), principal, exchange) .flatMap((Function&lt;OAuth2AuthorizedClient, Mono&lt;Optional&lt;OAuth2AuthorizedClient&gt;&gt;&gt;) oAuth2AuthorizedClient -&gt; Mono.just(Optional.of(oAuth2AuthorizedClient))) .defaultIfEmpty(Optional.empty()) .flatMap((Function&lt;Optional&lt;OAuth2AuthorizedClient&gt;, Mono&lt;Void&gt;&gt;) oAuth2AuthorizedClient -&gt; &#123; if(!oAuth2AuthorizedClient.isPresent())&#123; return insertAuthorizedClient(authorizedClient,principal); &#125;else &#123; return updateAuthorizedClient(authorizedClient, principal); &#125; &#125;); &#125; private Mono&lt;Void&gt; updateAuthorizedClient(OAuth2AuthorizedClient authorizedClient, Authentication principal) &#123; return databaseClient.sql(UPDATE_AUTHORIZED_CLIENT_SQL) .bind(0, authorizedClient.getAccessToken().getTokenType().getValue()) .bind(1, authorizedClient.getAccessToken().getTokenValue().getBytes(StandardCharsets.UTF_8)) .bind(2, timeFromInstant(authorizedClient.getAccessToken().getIssuedAt())) .bind(3, timeFromInstant(authorizedClient.getAccessToken().getExpiresAt())) .bind(4, StringUtils.collectionToCommaDelimitedString(authorizedClient.getAccessToken().getScopes())) .bind(5, authorizedClient.getRefreshToken().getTokenValue().getBytes(StandardCharsets.UTF_8)) .bind(6, timeFromInstant(authorizedClient.getRefreshToken().getIssuedAt())) .bind(7, authorizedClient.getClientRegistration().getRegistrationId()) .bind(8, principal.getName()) .then() .doOnNext(unused -&gt; log.info(&quot;update client token info success!&quot;)); &#125; private Mono&lt;Void&gt; insertAuthorizedClient(OAuth2AuthorizedClient authorizedClient, Authentication principal) &#123; return databaseClient.sql(SAVE_AUTHORIZED_CLIENT_SQL) .bind(0, authorizedClient.getClientRegistration().getRegistrationId()) .bind(1, principal.getName()) .bind(2, authorizedClient.getAccessToken().getTokenType().getValue()) .bind(3, authorizedClient.getAccessToken().getTokenValue().getBytes(StandardCharsets.UTF_8)) .bind(4, timeFromInstant(authorizedClient.getAccessToken().getIssuedAt())) .bind(5, timeFromInstant(authorizedClient.getAccessToken().getExpiresAt())) .bind(6, StringUtils.collectionToCommaDelimitedString(authorizedClient.getAccessToken().getScopes())) .bind(7, authorizedClient.getRefreshToken().getTokenValue().getBytes(StandardCharsets.UTF_8)) .bind(8, timeFromInstant(authorizedClient.getRefreshToken().getIssuedAt())) .then() .doOnNext(unused -&gt; log.info(&quot;insert client token info success!&quot;)); &#125; @Override public Mono&lt;Void&gt; removeAuthorizedClient(String clientRegistrationId, Authentication principal, ServerWebExchange exchange) &#123; Assert.hasText(clientRegistrationId, &quot;clientRegistrationId cannot be empty&quot;); Assert.hasText(principal.getName(), &quot;principalName cannot be empty&quot;); return databaseClient.sql(REMOVE_AUTHORIZED_CLIENT_SQL) .bind(0, clientRegistrationId) .bind(1, principal.getName()) .then() .doOnNext(unused -&gt; log.info(&quot;remove client token info success!&quot;)); &#125; private String timeFromInstant(Instant instant) &#123; return DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd HH:mm:ss&quot;).format(LocalDateTime.ofInstant(instant, ZoneId.systemDefault())); &#125;&#125; AuthController自定义登录跳转页面 123456789101112131415161718192021222324252627282930313233343536373839404142package com.example.oauth2clientwebfluxdemo.controller;import com.example.oauth2clientwebfluxdemo.security.CustomServerOAuth2AuthorizedClientRepository;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.security.oauth2.client.registration.InMemoryReactiveClientRegistrationRepository;import org.springframework.security.oauth2.client.registration.ReactiveClientRegistrationRepository;import org.springframework.stereotype.Controller;import org.springframework.ui.Model;import org.springframework.web.bind.annotation.GetMapping;import java.util.HashMap;import java.util.Map;/** * &lt;h1&gt;login&lt;/h1&gt; * Created by hanqf on 2020/11/30 18:02. */@Controllerpublic class AuthController &#123; @Autowired ReactiveClientRegistrationRepository reactiveClientRegistrationRepository; @GetMapping(&quot;/login&quot;) public String login(Model model) &#123; Map&lt;String, String&gt; map = new HashMap&lt;&gt;(); if (reactiveClientRegistrationRepository instanceof InMemoryReactiveClientRegistrationRepository) &#123; ((InMemoryReactiveClientRegistrationRepository) reactiveClientRegistrationRepository).forEach(registrations -&gt; &#123; String registrationId = registrations.getRegistrationId(); String clientName = registrations.getClientName(); System.out.println(registrationId + &quot;---&quot; + clientName); map.put(registrationId, clientName); &#125;); &#125; model.addAttribute(&quot;registrations&quot;, map); return &quot;oauth2/login&quot;; &#125;&#125; login.html自定义登录页面 12345678910111213141516171819202122232425262728293031&lt;!DOCTYPE html&gt;&lt;html lang=&quot;en&quot; xmlns:th=&quot;http://www.thymeleaf.org&quot;&gt;&lt;head&gt; &lt;meta charset=&quot;UTF-8&quot;/&gt; &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1, shrink-to-fit=no&quot;&gt; &lt;title&gt;登录&lt;/title&gt; &lt;link rel=&quot;stylesheet&quot; th:href=&quot;@&#123;/webjars/bootstrap/css/bootstrap.min.css&#125;&quot;/&gt; &lt;script th:src=&quot;@&#123;/webjars/jquery/jquery.min.js&#125;&quot;&gt;&lt;/script&gt; &lt;script th:src=&quot;@&#123;/webjars/bootstrap/js/bootstrap.min.js&#125;&quot;&gt;&lt;/script&gt;&lt;/head&gt;&lt;body&gt;&lt;div class=&quot;container&quot;&gt; &lt;h2 class=&quot;form-signin-heading&quot;&gt;Login with OAuth 2.0&lt;/h2&gt; &lt;table class=&quot;table table-striped&quot;&gt; &lt;tr th:each=&quot;registration: $&#123;registrations&#125;&quot;&gt; &lt;td&gt;&lt;a th:href=&quot;@&#123;&#x27;/oauth2/authorization/&#x27;+$&#123;registration.key&#125;&#125;&quot; th:text=&quot;$&#123;registration.value&#125;&quot;&gt;&lt;/a&gt;&lt;/td&gt; &lt;/tr&gt; &lt;/table&gt;&lt;/div&gt;&lt;form th:action=&quot;@&#123;/logout&#125;&quot; class=&quot;container&quot; method=&quot;post&quot;&gt; &lt;button type=&quot;submit&quot;&gt;Logout&lt;/button&gt;&lt;/form&gt;&lt;/body&gt;&lt;/html&gt; application.yml123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102server: port: 8099oauth2: server: url: http://localhost:8080 logout: $&#123;oauth2.server.url&#125;/logout #认证服务器logout地址spring: application: name: oauth2-client-webflux #资源国际化 messages: basename: static/i18n/messages encoding: utf-8 #thymeleaf thymeleaf: cache: false enabled: true encoding: UTF-8 mode: HTML prefix: classpath:/templates/ servlet: content-type: text/html suffix: .html #r2dbc mysql r2dbc: url: r2dbc:mysql://localhost:3306/springboot?useUnicode=true&amp;characterEncoding=utf-8&amp;useTimezone=true&amp;serverTimezone=GMT%2B8 username: root password: newpwd pool: enabled: true initial-size: 5 max-size: 20 max-idle-time: 30m #oauth2 # 支持多客户端认证方式 security: oauth2: client: registration: # /oauth2/authorization/flux-client # 认证地址 flux-client: # 注册名称 client-id: postman # 客户端登录用户名称 client-secret: postman # 客户端登录密码 authorization-grant-type: authorization_code #认证方式为code #回调地址，需要配置到认证服务器中 redirect-uri: http://localhost:8099/login/oauth2/code/flux-client scope: any #授权范围 client-name: 客户端1 #显示名称# # /oauth2/authorization/flux-client2 flux-client2: client-id: demo-client client-secret: demo-client authorization-grant-type: authorization_code redirect-uri: http://localhost:8099/login/oauth2/code/flux-client2 scope: any client-name: 客户端2 google: # google client-id: xxxxxxxxx client-secret: xxxxxxx client-name: Google认证 facebook: # facebook client-id: xxxxxxxxx client-secret: xxxxxxx client-name: Facebook认证 github: # github client-id: xxxxxxxxx client-secret: xxxxxxx client-name: Github认证 provider: flux-client: # 注册客户端的认证信息 authorization-uri: $&#123;oauth2.server.url&#125;/oauth/authorize # 认证服务器授权地址 token-uri: $&#123;oauth2.server.url&#125;/oauth/token # 认证服务器token地址 user-info-uri: http://localhost:8080/userInfo # 认证服务器用户信息地址 userNameAttribute: username # 指定user-info-uri返回map中的属性名称用于表示用户名 flux-client2: authorization-uri: $&#123;oauth2.server.url&#125;/oauth/authorize token-uri: $&#123;oauth2.server.url&#125;/oauth/token user-info-uri: http://localhost:8080/userInfo userNameAttribute: usernamedebug: true# 可以打印sqllogging: level: org.springframework.data.r2dbc: DEBUG ResController请求资源服务示例 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135package com.example.oauth2clientwebfluxdemo.controller;import com.example.oauth2clientwebfluxdemo.exception.AjaxResponse;import com.example.oauth2clientwebfluxdemo.exception.CustomException;import com.example.oauth2clientwebfluxdemo.exception.CustomExceptionType;import com.example.oauth2clientwebfluxdemo.security.CustomServerOAuth2AuthorizedClientRepository;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.http.HttpHeaders;import org.springframework.security.core.Authentication;import org.springframework.security.oauth2.client.OAuth2AuthorizedClient;import org.springframework.security.oauth2.client.authentication.OAuth2AuthenticationToken;import org.springframework.web.bind.annotation.RequestMapping;import org.springframework.web.bind.annotation.RestController;import org.springframework.web.reactive.function.client.WebClient;import org.springframework.web.server.ServerWebExchange;import reactor.core.publisher.Mono;import java.util.HashMap;import java.util.Map;/** * &lt;h1&gt;获取资源服务器数据&lt;/h1&gt; * Created by hanqf on 2020/11/7 22:47. */@RestController@RequestMapping(&quot;/res&quot;)public class ResController &#123; private static final WebClient CLIENT = WebClient.create(&quot;http://localhost:8083&quot;); @Autowired private CustomServerOAuth2AuthorizedClientRepository customServerOAuth2AuthorizedClientRepository; /** * 获取资源服务器的数据 */ @RequestMapping(&quot;/res1&quot;) public Mono&lt;AjaxResponse&gt; getRes(Authentication principal, ServerWebExchange exchange) &#123; if (principal instanceof OAuth2AuthenticationToken) &#123; String authorizedClientRegistrationId = ((OAuth2AuthenticationToken) principal).getAuthorizedClientRegistrationId(); Mono&lt;OAuth2AuthorizedClient&gt; oAuth2AuthorizedClientMono = customServerOAuth2AuthorizedClientRepository.loadAuthorizedClient(authorizedClientRegistrationId, principal, exchange); return oAuth2AuthorizedClientMono.flatMap(client -&gt; &#123; String tokenValue = client.getAccessToken().getTokenValue(); String tokenType = client.getAccessToken().getTokenType().getValue(); return CLIENT.get() .uri(&quot;/res/res1&quot;) //增加了Bearer安全认证，所以这里需要传递header认证信息 .header(HttpHeaders.AUTHORIZATION, tokenType + &quot; &quot; + tokenValue) .retrieve()//异步接收服务端响应 .bodyToMono(AjaxResponse.class) .retry(3) .defaultIfEmpty(AjaxResponse.success(&quot;返回结果为Null&quot;)); &#125;); &#125; else &#123; return Mono.just(AjaxResponse.error(new CustomException(CustomExceptionType.SYSTEM_ERROR,&quot;Authentication类型转换异常&quot;))); &#125; &#125; @RequestMapping(&quot;/user&quot;) public Mono&lt;AjaxResponse&gt; getUser(Authentication principal, ServerWebExchange exchange) &#123; if (principal instanceof OAuth2AuthenticationToken) &#123; String authorizedClientRegistrationId = ((OAuth2AuthenticationToken) principal).getAuthorizedClientRegistrationId(); Mono&lt;OAuth2AuthorizedClient&gt; oAuth2AuthorizedClientMono = customServerOAuth2AuthorizedClientRepository.loadAuthorizedClient(authorizedClientRegistrationId, principal, exchange); return oAuth2AuthorizedClientMono.flatMap(client -&gt; &#123; String tokenValue = client.getAccessToken().getTokenValue(); String tokenType = client.getAccessToken().getTokenType().getValue(); return CLIENT.post() .uri(&quot;/user&quot;) //增加了Bearer安全认证，所以这里需要传递header认证信息 .header(HttpHeaders.AUTHORIZATION, tokenType + &quot; &quot; + tokenValue) .retrieve()//异步接收服务端响应 .bodyToMono(AjaxResponse.class) .retry(3) .defaultIfEmpty(AjaxResponse.success(&quot;返回结果为Null&quot;)); &#125;); &#125; else &#123; return Mono.just(AjaxResponse.error(new CustomException(CustomExceptionType.SYSTEM_ERROR,&quot;Authentication类型转换异常&quot;))); &#125; &#125; @RequestMapping(&quot;/rbac&quot;) public Mono&lt;AjaxResponse&gt; getRbac(Authentication principal, ServerWebExchange exchange) &#123; if (principal instanceof OAuth2AuthenticationToken) &#123; String authorizedClientRegistrationId = ((OAuth2AuthenticationToken) principal).getAuthorizedClientRegistrationId(); Mono&lt;OAuth2AuthorizedClient&gt; oAuth2AuthorizedClientMono = customServerOAuth2AuthorizedClientRepository.loadAuthorizedClient(authorizedClientRegistrationId, principal, exchange); return oAuth2AuthorizedClientMono.flatMap(client -&gt; &#123; String tokenValue = client.getAccessToken().getTokenValue(); String tokenType = client.getAccessToken().getTokenType().getValue(); return CLIENT.get() .uri(&quot;/rbac&quot;) //增加了Bearer安全认证，所以这里需要传递header认证信息 .header(HttpHeaders.AUTHORIZATION, tokenType + &quot; &quot; + tokenValue) .retrieve()//异步接收服务端响应 .bodyToMono(AjaxResponse.class) .retry(3) .defaultIfEmpty(AjaxResponse.success(&quot;返回结果为Null&quot;)); &#125;); &#125; else &#123; return Mono.just(AjaxResponse.error(new CustomException(CustomExceptionType.SYSTEM_ERROR,&quot;Authentication类型转换异常&quot;))); &#125; &#125; @RequestMapping(&quot;/userInfo&quot;) public Mono&lt;Map&gt; getuserInfo(Authentication principal, ServerWebExchange exchange) &#123; if (principal instanceof OAuth2AuthenticationToken) &#123; String authorizedClientRegistrationId = ((OAuth2AuthenticationToken) principal).getAuthorizedClientRegistrationId(); Mono&lt;OAuth2AuthorizedClient&gt; oAuth2AuthorizedClientMono = customServerOAuth2AuthorizedClientRepository.loadAuthorizedClient(authorizedClientRegistrationId, principal, exchange); return oAuth2AuthorizedClientMono.flatMap(client -&gt; &#123; String tokenValue = client.getAccessToken().getTokenValue(); String tokenType = client.getAccessToken().getTokenType().getValue(); return CLIENT.get() .uri(&quot;/userInfo&quot;) //增加了Bearer安全认证，所以这里需要传递header认证信息 .header(HttpHeaders.AUTHORIZATION, tokenType + &quot; &quot; + tokenValue) .retrieve()//异步接收服务端响应 .bodyToMono(Map.class) .retry(3) .defaultIfEmpty(new HashMap()); &#125;); &#125; else &#123; return Mono.error(new CustomException(CustomExceptionType.SYSTEM_ERROR,&quot;Authentication类型转换异常&quot;)); &#125; &#125;&#125;","summary":"摘要 通过本文，你将知道如何搭建一个基于SpringBoot-OAuth2-JWT-WebFlux的客户端服务器 本文基于springboot:2.4.0，项目基于Gradle-6.6.1构建 本文基于SpringBoot-OAuth2-JWT-ClientServer并实现其功能，可以参考对比 代码地址:https://github.com/hanqunfeng/springbootchapter/tree/master/chapter48","date_published":"2020-12-02T13:30:05.000Z","tags":["技术","springboot2","Java","springboot","oauth2","springsecurity","jwt","webflux"]},{"id":"https://blog.hanqunfeng.com/2020/12/02/springboot-oauth2-jwt-webflux-resourceserver/","url":"https://blog.hanqunfeng.com/2020/12/02/springboot-oauth2-jwt-webflux-resourceserver/","title":"SpringBoot-OAuth2-JWT-WebFlux-ResourceServer","content_html":"<h2 id=\"摘要\"><a href=\"#摘要\" class=\"headerlink\" title=\"摘要\"></a>摘要</h2><ul>\n<li>通过本文，你将知道如何搭建一个基于SpringBoot-OAuth2-JWT-WebFlux的资源服务器</li>\n<li>本文基于springboot:2.4.0，项目基于Gradle-6.6.1构建</li>\n<li>本文基于<a href=\"https://blog.hanqunfeng.com/2020/11/15/springBoot-oauth2-jwt-resourcceserver/\">SpringBoot-OAuth2-JWT-ResourceServer</a>并实现其功能，可以参考对比</li>\n<li>代码地址:<a href=\"https://github.com/hanqunfeng/springbootchapter/tree/master/chapter48\">https://github.com/hanqunfeng/springbootchapter/tree/master/chapter48</a></li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"依赖\"><a href=\"#依赖\" class=\"headerlink\" title=\"依赖\"></a>依赖</h2><ul>\n<li>springboot官方提供了支持<figure class=\"highlight gradle\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//webflux</span></span><br><span class=\"line\">implementation <span class=\"string\">&#x27;org.springframework.boot:spring-boot-starter-webflux&#x27;</span></span><br><span class=\"line\">implementation <span class=\"string\">&#x27;org.springframework.boot:spring-boot-starter-oauth2-resource-server&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//本项目中使用了lombok减少代码量，非必须依赖</span></span><br><span class=\"line\">compileOnly <span class=\"string\">&#x27;org.projectlombok:lombok&#x27;</span></span><br><span class=\"line\">annotationProcessor <span class=\"string\">&#x27;org.projectlombok:lombok&#x27;</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h2 id=\"ReactiveSecurityConfig\"><a href=\"#ReactiveSecurityConfig\" class=\"headerlink\" title=\"ReactiveSecurityConfig\"></a>ReactiveSecurityConfig</h2><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.example.oauth2resourceserverwebfluxdemo.config;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> com.example.oauth2resourceserverwebfluxdemo.security.CustomReactiveAuthorizationManager;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.example.oauth2resourceserverwebfluxdemo.security.CustomServerAccessDeniedHandler;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.example.oauth2resourceserverwebfluxdemo.security.CustomServerAuthenticationEntryPoint;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Bean;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Configuration;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.config.annotation.method.configuration.EnableReactiveMethodSecurity;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.config.web.server.ServerHttpSecurity;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.core.authority.SimpleGrantedAuthority;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.oauth2.server.resource.authentication.JwtAuthenticationToken;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.web.server.SecurityWebFilterChain;</span><br><span class=\"line\"><span class=\"keyword\">import</span> reactor.core.publisher.Mono;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Collection;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.stream.Collectors;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * &lt;h1&gt;安全认证配置&lt;/h1&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> * Created by hanqf on 2020/11/19 10:26.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Configuration</span></span><br><span class=\"line\"><span class=\"comment\">//@EnableWebFluxSecurity //非必要</span></span><br><span class=\"line\"><span class=\"meta\">@EnableReactiveMethodSecurity</span> <span class=\"comment\">//启用@PreAuthorize注解配置</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ReactiveSecurityConfig</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> CustomServerAccessDeniedHandler customServerAccessDeniedHandler;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> CustomServerAuthenticationEntryPoint customServerAuthenticationEntryPoint;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> CustomReactiveAuthorizationManager customReactiveAuthorizationManager;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 注册安全验证规则</span></span><br><span class=\"line\"><span class=\"comment\">     * 配置方式与HttpSecurity基本一致</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@Bean</span></span><br><span class=\"line\">    <span class=\"function\">SecurityWebFilterChain <span class=\"title\">springSecurityFilterChain</span><span class=\"params\">(ServerHttpSecurity http)</span> </span>&#123; <span class=\"comment\">//定义SecurityWebFilterChain对安全进行控制，使用ServerHttpSecurity构造过滤器链；</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> http.authorizeExchange()</span><br><span class=\"line\">                <span class=\"comment\">//.anyExchange().authenticated() //所有请求都需要通过认证</span></span><br><span class=\"line\">                .pathMatchers(<span class=\"string\">&quot;/res/**&quot;</span>, <span class=\"string\">&quot;/userInfo/**&quot;</span>).authenticated()</span><br><span class=\"line\">                <span class=\"comment\">//需要具备相应的角色才能访问</span></span><br><span class=\"line\">                .pathMatchers(<span class=\"string\">&quot;/user/**&quot;</span>).hasAnyRole(<span class=\"string\">&quot;admin&quot;</span>, <span class=\"string\">&quot;user&quot;</span>)</span><br><span class=\"line\">                <span class=\"comment\">//不需要登录就可以访问</span></span><br><span class=\"line\">                .pathMatchers(<span class=\"string\">&quot;/swagger-ui/**&quot;</span>, <span class=\"string\">&quot;/v3/api-docs**&quot;</span>).permitAll()</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"comment\">//其它路径需要根据指定的方法判断是否有权限访问，基于权限管理模型认证</span></span><br><span class=\"line\">                .anyExchange().access(customReactiveAuthorizationManager)</span><br><span class=\"line\">                .and()</span><br><span class=\"line\">                .csrf().disable() <span class=\"comment\">//关闭CSRF（Cross-site request forgery）跨站请求伪造</span></span><br><span class=\"line\">                .httpBasic().disable() <span class=\"comment\">//不支持HTTP Basic方式登录</span></span><br><span class=\"line\">                .formLogin().disable()<span class=\"comment\">//不支持login页面登录</span></span><br><span class=\"line\">                .cors() <span class=\"comment\">//开启跨域支持</span></span><br><span class=\"line\">                .and()</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"comment\">//鉴权时只支持Bearer Token的形式，不支持url后加参数access_token</span></span><br><span class=\"line\">                .oauth2ResourceServer()<span class=\"comment\">//开启oauth2资源认证</span></span><br><span class=\"line\">                .jwt() <span class=\"comment\">//token为jwt</span></span><br><span class=\"line\">                <span class=\"comment\">//默认情况下，权限是scope，而我们希望使用的是用户的角色，所以这里需要通过转换器进行处理</span></span><br><span class=\"line\">                .jwtAuthenticationConverter(jwt -&gt; &#123; <span class=\"comment\">//通过自定义Converter来指定权限，Converter是函数接口，当前上下问参数为JWT对象</span></span><br><span class=\"line\">                    Collection&lt;SimpleGrantedAuthority&gt; authorities =</span><br><span class=\"line\">                            ((Collection&lt;String&gt;) jwt.getClaims()</span><br><span class=\"line\">                                    .get(<span class=\"string\">&quot;authorities&quot;</span>)).stream() <span class=\"comment\">//获取JWT中的authorities</span></span><br><span class=\"line\">                                    .map(SimpleGrantedAuthority::<span class=\"keyword\">new</span>)</span><br><span class=\"line\">                                    .collect(Collectors.toSet());</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"comment\">//如果希望保留scope的权限，可以取出scope数据然后合并到一起，这样因为不是以ROLE_开头，所以需要使用hasAuthority(&#x27;SCOPE_any&#x27;)的形式</span></span><br><span class=\"line\">                    Collection&lt;SimpleGrantedAuthority&gt; scopes = ((Collection&lt;String&gt;) jwt.getClaims()</span><br><span class=\"line\">                            .get(<span class=\"string\">&quot;scope&quot;</span>)).stream().map(scope -&gt; <span class=\"keyword\">new</span> SimpleGrantedAuthority(<span class=\"string\">&quot;SCOPE_&quot;</span> + scope))</span><br><span class=\"line\">                            .collect(Collectors.toSet());</span><br><span class=\"line\">                    <span class=\"comment\">//合并权限</span></span><br><span class=\"line\">                    authorities.addAll(scopes);</span><br><span class=\"line\">                    <span class=\"keyword\">return</span> Mono.just(<span class=\"keyword\">new</span> JwtAuthenticationToken(jwt, authorities));</span><br><span class=\"line\">                &#125;)</span><br><span class=\"line\">                .and()</span><br><span class=\"line\">                .accessDeniedHandler(customServerAccessDeniedHandler)</span><br><span class=\"line\">                .authenticationEntryPoint(customServerAuthenticationEntryPoint)</span><br><span class=\"line\">                .and().build();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"CustomReactiveAuthorizationManager\"><a href=\"#CustomReactiveAuthorizationManager\" class=\"headerlink\" title=\"CustomReactiveAuthorizationManager\"></a>CustomReactiveAuthorizationManager</h2><p>基于RBAC权限认证管理模型的认证方式</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.example.oauth2resourceserverwebfluxdemo.security;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.http.server.reactive.ServerHttpRequest;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.authorization.AuthorizationDecision;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.authorization.ReactiveAuthorizationManager;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.core.Authentication;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.oauth2.jwt.Jwt;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.web.server.authorization.AuthorizationContext;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.stereotype.Component;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.util.AntPathMatcher;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.util.StringUtils;</span><br><span class=\"line\"><span class=\"keyword\">import</span> reactor.core.publisher.Mono;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.HashSet;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Set;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * &lt;h1&gt;ReactiveAuthorizationManager&lt;/h1&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> * Created by hanqf on 2020/11/30 12:05.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Component</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">CustomReactiveAuthorizationManager</span> <span class=\"keyword\">implements</span> <span class=\"title\">ReactiveAuthorizationManager</span>&lt;<span class=\"title\">AuthorizationContext</span>&gt; </span>&#123;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Mono&lt;AuthorizationDecision&gt; <span class=\"title\">check</span><span class=\"params\">(Mono&lt;Authentication&gt; authentication, AuthorizationContext object)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> authentication.map(auth -&gt; &#123;</span><br><span class=\"line\">            ServerHttpRequest request = object.getExchange().getRequest();</span><br><span class=\"line\">            Object principal = auth.getPrincipal();</span><br><span class=\"line\">            String username;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (principal <span class=\"keyword\">instanceof</span> Jwt) &#123;</span><br><span class=\"line\">                username = ((Jwt) principal).getClaimAsString(<span class=\"string\">&quot;user_name&quot;</span>);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                username = principal.toString();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">boolean</span> hasPerssion = <span class=\"keyword\">false</span>;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (StringUtils.hasText(username) &amp;&amp; !<span class=\"string\">&quot;anonymousUser&quot;</span>.equals(username)) &#123;</span><br><span class=\"line\">                <span class=\"comment\">//根据用户名查询用户资源权限，这里应该访问数据库查询</span></span><br><span class=\"line\">                Set&lt;String&gt; uris = <span class=\"keyword\">new</span> HashSet&lt;&gt;();</span><br><span class=\"line\">                <span class=\"keyword\">for</span> (String uri : uris) &#123;</span><br><span class=\"line\">                    <span class=\"comment\">//验证用户拥有的资源权限是否与请求的资源相匹配</span></span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (<span class=\"keyword\">new</span> AntPathMatcher().match(uri, request.getURI().toString())) &#123;</span><br><span class=\"line\">                        hasPerssion = <span class=\"keyword\">true</span>;</span><br><span class=\"line\">                        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//暂时全部返回true</span></span><br><span class=\"line\">            hasPerssion = <span class=\"keyword\">true</span>;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> AuthorizationDecision(hasPerssion);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"CustomServerAccessDeniedHandler\"><a href=\"#CustomServerAccessDeniedHandler\" class=\"headerlink\" title=\"CustomServerAccessDeniedHandler\"></a>CustomServerAccessDeniedHandler</h2><p>没有权限时的处理方式</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.example.oauth2resourceserverwebfluxdemo.security;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> com.example.oauth2resourceserverwebfluxdemo.exception.AjaxResponse;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.example.oauth2resourceserverwebfluxdemo.exception.CustomException;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.example.oauth2resourceserverwebfluxdemo.exception.CustomExceptionType;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.fasterxml.jackson.core.JsonProcessingException;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class=\"line\"><span class=\"keyword\">import</span> lombok.SneakyThrows;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.http.MediaType;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.http.server.reactive.ServerHttpResponse;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.access.AccessDeniedException;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.web.server.authorization.ServerAccessDeniedHandler;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.stereotype.Component;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.server.ServerWebExchange;</span><br><span class=\"line\"><span class=\"keyword\">import</span> reactor.core.publisher.Mono;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * &lt;h1&gt;没有权限时的处理方式&lt;/h1&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> * Created by hanqf on 2020/11/20 11:56.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Component</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">CustomServerAccessDeniedHandler</span> <span class=\"keyword\">implements</span> <span class=\"title\">ServerAccessDeniedHandler</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"meta\">@SneakyThrows</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Mono&lt;Void&gt; <span class=\"title\">handle</span><span class=\"params\">(ServerWebExchange serverWebExchange, AccessDeniedException e)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> setErrorResponse(serverWebExchange.getResponse(),e.getMessage());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> Mono&lt;Void&gt; <span class=\"title\">setErrorResponse</span><span class=\"params\">(ServerHttpResponse response, String message)</span> <span class=\"keyword\">throws</span> JsonProcessingException </span>&#123;</span><br><span class=\"line\">        response.getHeaders().setContentType(MediaType.APPLICATION_JSON);</span><br><span class=\"line\">        ObjectMapper objectMapper = <span class=\"keyword\">new</span> ObjectMapper();</span><br><span class=\"line\">        AjaxResponse ajaxResponse = AjaxResponse.error(<span class=\"keyword\">new</span> CustomException(CustomExceptionType.USER_INPUT_ERROR, message));</span><br><span class=\"line\">        <span class=\"keyword\">return</span> response.writeWith(Mono.just(response.bufferFactory().wrap(objectMapper.writeValueAsBytes(ajaxResponse))));</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"CustomServerAuthenticationEntryPoint\"><a href=\"#CustomServerAuthenticationEntryPoint\" class=\"headerlink\" title=\"CustomServerAuthenticationEntryPoint\"></a>CustomServerAuthenticationEntryPoint</h2><p>token格式错误或过期时的处理方式</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.example.oauth2resourceserverwebfluxdemo.security;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> com.example.oauth2resourceserverwebfluxdemo.exception.AjaxResponse;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.example.oauth2resourceserverwebfluxdemo.exception.CustomException;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.example.oauth2resourceserverwebfluxdemo.exception.CustomExceptionType;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.fasterxml.jackson.core.JsonProcessingException;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class=\"line\"><span class=\"keyword\">import</span> lombok.SneakyThrows;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.http.MediaType;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.http.server.reactive.ServerHttpResponse;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.core.AuthenticationException;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.web.server.ServerAuthenticationEntryPoint;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.stereotype.Component;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.server.ServerWebExchange;</span><br><span class=\"line\"><span class=\"keyword\">import</span> reactor.core.publisher.Mono;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * &lt;h1&gt;ServerAuthenticationEntryPoint&lt;/h1&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> * Created by hanqf on 2020/11/20 12:01.</span></span><br><span class=\"line\"><span class=\"comment\"> * &lt;p&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> * token格式错误或过期时的处理方式</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"meta\">@Component</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">CustomServerAuthenticationEntryPoint</span> <span class=\"keyword\">implements</span> <span class=\"title\">ServerAuthenticationEntryPoint</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"meta\">@SneakyThrows</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Mono&lt;Void&gt; <span class=\"title\">commence</span><span class=\"params\">(ServerWebExchange serverWebExchange, AuthenticationException e)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> setErrorResponse(serverWebExchange.getResponse(), e.getMessage());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> Mono&lt;Void&gt; <span class=\"title\">setErrorResponse</span><span class=\"params\">(ServerHttpResponse response, String message)</span> <span class=\"keyword\">throws</span> JsonProcessingException </span>&#123;</span><br><span class=\"line\">        response.getHeaders().setContentType(MediaType.APPLICATION_JSON);</span><br><span class=\"line\">        ObjectMapper objectMapper = <span class=\"keyword\">new</span> ObjectMapper();</span><br><span class=\"line\">        AjaxResponse ajaxResponse = AjaxResponse.error(<span class=\"keyword\">new</span> CustomException(CustomExceptionType.USER_INPUT_ERROR, message));</span><br><span class=\"line\">        <span class=\"keyword\">return</span> response.writeWith(Mono.just(response.bufferFactory().wrap(objectMapper.writeValueAsBytes(ajaxResponse))));</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"WebFluxConfig\"><a href=\"#WebFluxConfig\" class=\"headerlink\" title=\"WebFluxConfig\"></a>WebFluxConfig</h2><p>配置跨域</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.example.oauth2resourceserverwebfluxdemo.config;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Configuration;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.reactive.config.CorsRegistry;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.reactive.config.WebFluxConfigurer;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * &lt;h1&gt;WebFlux配置类&lt;/h1&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> * Created by hanqf on 2020/11/18 17:43.</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> * 我们若需要配置Spring WebFlux只需让配置配实现接口WebFluxConfigurer，</span></span><br><span class=\"line\"><span class=\"comment\"> * 这样我们既能保留Spring Boot给WebFlux配置又能添加我们的定制配置。</span></span><br><span class=\"line\"><span class=\"comment\"> * 若我们向完全控制WebFlux，则在配置类添加注解<span class=\"doctag\">@EnableWebFlux</span></span></span><br><span class=\"line\"><span class=\"comment\"> * 配置方式和Spring MVC类似</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Configuration</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">WebFluxConfig</span> <span class=\"keyword\">implements</span> <span class=\"title\">WebFluxConfigurer</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//跨域设置</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">addCorsMappings</span><span class=\"params\">(CorsRegistry registry)</span> </span>&#123;</span><br><span class=\"line\">        registry.addMapping(<span class=\"string\">&quot;/**&quot;</span>) <span class=\"comment\">//添加映射路径，“/**”表示对所有的路径实行全局跨域访问权限的设置</span></span><br><span class=\"line\">                .allowedMethods(<span class=\"string\">&quot;GET&quot;</span>,<span class=\"string\">&quot;POST&quot;</span>, <span class=\"string\">&quot;PUT&quot;</span>, <span class=\"string\">&quot;DELETE&quot;</span>) <span class=\"comment\">//开放哪些Http方法，允许跨域访问</span></span><br><span class=\"line\">                .allowedHeaders(<span class=\"string\">&quot;*&quot;</span>) <span class=\"comment\">//允许HTTP请求中的携带哪些Header信息</span></span><br><span class=\"line\">                <span class=\"comment\">//When allowCredentials is true, allowedOrigins cannot contain the special value &quot;*&quot;since that cannot be set on the &quot;Access-Control-Allow-Origin&quot; response header.</span></span><br><span class=\"line\">                <span class=\"comment\">// To allow credentials to a set of origins, list them explicitly or consider using &quot;allowedOriginPatterns&quot; instead.</span></span><br><span class=\"line\">                <span class=\"comment\">//.allowedOrigins(&quot;*&quot;) //开放哪些ip、端口、域名的访问权限</span></span><br><span class=\"line\">                .allowedOriginPatterns(<span class=\"string\">&quot;*&quot;</span>)</span><br><span class=\"line\">                .allowCredentials(<span class=\"keyword\">true</span>); <span class=\"comment\">//是否允许发送Cookie信息</span></span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n<h2 id=\"application-yml\"><a href=\"#application-yml\" class=\"headerlink\" title=\"application.yml\"></a>application.yml</h2><figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#资源服务器端口号</span></span><br><span class=\"line\"><span class=\"attr\">server:</span></span><br><span class=\"line\">  <span class=\"attr\">port:</span> <span class=\"number\">8083</span></span><br><span class=\"line\"><span class=\"attr\">spring:</span></span><br><span class=\"line\">  <span class=\"attr\">application:</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">oauth2-resource-server-webflux</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">#oauth2 配置</span></span><br><span class=\"line\">  <span class=\"attr\">security:</span></span><br><span class=\"line\">    <span class=\"attr\">oauth2:</span></span><br><span class=\"line\">      <span class=\"attr\">resourceserver:</span></span><br><span class=\"line\">        <span class=\"attr\">jwt:</span></span><br><span class=\"line\">          <span class=\"comment\"># 公钥文件路径</span></span><br><span class=\"line\">          <span class=\"comment\"># public-key-location: classpath:oauth2_key.pub</span></span><br><span class=\"line\"></span><br><span class=\"line\">          <span class=\"comment\"># 认证服务器提供的密钥验证路径，这种方式每次验证access_token都需要访问认证服务器</span></span><br><span class=\"line\">          <span class=\"attr\">jwk-set-uri:</span> <span class=\"string\">http://localhost:8080/.well-known/jwks.json</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"资源接口示例\"><a href=\"#资源接口示例\" class=\"headerlink\" title=\"资源接口示例\"></a>资源接口示例</h2><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.example.oauth2resourceserverwebfluxdemo.controller;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> com.example.oauth2resourceserverwebfluxdemo.exception.AjaxResponse;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.access.prepost.PreAuthorize;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.core.Authentication;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.oauth2.jwt.Jwt;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class=\"line\"><span class=\"keyword\">import</span> reactor.core.publisher.Mono;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.security.Principal;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.HashMap;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Map;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * &lt;h1&gt;res&lt;/h1&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> * Created by hanqf on 2020/11/6 17:22.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@RestController</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">UserController</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//注意权限区分大小写</span></span><br><span class=\"line\">    <span class=\"meta\">@PreAuthorize(&quot;hasRole(&#x27;admin&#x27;) or hasRole(&#x27;user&#x27;)&quot;)</span></span><br><span class=\"line\">    <span class=\"comment\">//@PreAuthorize(&quot;#oauth2.hasScope(&#x27;any&#x27;)&quot;) //不支持oauth2表达式</span></span><br><span class=\"line\">    <span class=\"meta\">@RequestMapping(value = &quot;/user&quot;)</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Mono&lt;AjaxResponse&gt; <span class=\"title\">user</span><span class=\"params\">(Principal principal)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">//principal在经过security拦截后，是org.springframework.security.authentication.UsernamePasswordAuthenticationToken</span></span><br><span class=\"line\">        <span class=\"comment\">//在经OAuth2拦截后，是OAuth2Authentication</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> Mono.just(AjaxResponse.success(principal));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//注意权限区分大小写</span></span><br><span class=\"line\">    <span class=\"meta\">@PreAuthorize(&quot;hasAuthority(&#x27;SCOPE_any&#x27;)&quot;)</span></span><br><span class=\"line\">    <span class=\"meta\">@RequestMapping(value = &quot;/user2&quot;)</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Mono&lt;AjaxResponse&gt; <span class=\"title\">user2</span><span class=\"params\">(Principal principal)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">//principal在经过security拦截后，是org.springframework.security.authentication.UsernamePasswordAuthenticationToken</span></span><br><span class=\"line\">        <span class=\"comment\">//在经OAuth2拦截后，是OAuth2Authentication</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> Mono.just(AjaxResponse.success(principal));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 获取用户的claim信息</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">    <span class=\"meta\">@RequestMapping(&quot;/userInfo&quot;)</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> Mono&lt;Map&lt;String, Object&gt;&gt; userInfo(Authentication authentication)&#123;</span><br><span class=\"line\">        Map&lt;String,Object&gt; map = <span class=\"keyword\">new</span> HashMap&lt;&gt;();</span><br><span class=\"line\">        Object principal = authentication.getPrincipal();</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(principal <span class=\"keyword\">instanceof</span> Jwt)&#123;</span><br><span class=\"line\">            map.put(<span class=\"string\">&quot;username&quot;</span>, ((Jwt) principal).getClaim(<span class=\"string\">&quot;user_name&quot;</span>));</span><br><span class=\"line\">            map.putAll(((Jwt) principal).getClaims());</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> Mono.just(map);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>","content_text":"摘要 通过本文，你将知道如何搭建一个基于SpringBoot-OAuth2-JWT-WebFlux的资源服务器 本文基于springboot:2.4.0，项目基于Gradle-6.6.1构建 本文基于SpringBoot-OAuth2-JWT-ResourceServer并实现其功能，可以参考对比 代码地址:https://github.com/hanqunfeng/springbootchapter/tree/master/chapter48 依赖 springboot官方提供了支持1234567//webfluximplementation &#x27;org.springframework.boot:spring-boot-starter-webflux&#x27;implementation &#x27;org.springframework.boot:spring-boot-starter-oauth2-resource-server&#x27;//本项目中使用了lombok减少代码量，非必须依赖compileOnly &#x27;org.projectlombok:lombok&#x27;annotationProcessor &#x27;org.projectlombok:lombok&#x27; ReactiveSecurityConfig12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788package com.example.oauth2resourceserverwebfluxdemo.config;import com.example.oauth2resourceserverwebfluxdemo.security.CustomReactiveAuthorizationManager;import com.example.oauth2resourceserverwebfluxdemo.security.CustomServerAccessDeniedHandler;import com.example.oauth2resourceserverwebfluxdemo.security.CustomServerAuthenticationEntryPoint;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.context.annotation.Bean;import org.springframework.context.annotation.Configuration;import org.springframework.security.config.annotation.method.configuration.EnableReactiveMethodSecurity;import org.springframework.security.config.web.server.ServerHttpSecurity;import org.springframework.security.core.authority.SimpleGrantedAuthority;import org.springframework.security.oauth2.server.resource.authentication.JwtAuthenticationToken;import org.springframework.security.web.server.SecurityWebFilterChain;import reactor.core.publisher.Mono;import java.util.Collection;import java.util.stream.Collectors;/** * &lt;h1&gt;安全认证配置&lt;/h1&gt; * Created by hanqf on 2020/11/19 10:26. */@Configuration//@EnableWebFluxSecurity //非必要@EnableReactiveMethodSecurity //启用@PreAuthorize注解配置public class ReactiveSecurityConfig &#123; @Autowired private CustomServerAccessDeniedHandler customServerAccessDeniedHandler; @Autowired private CustomServerAuthenticationEntryPoint customServerAuthenticationEntryPoint; @Autowired private CustomReactiveAuthorizationManager customReactiveAuthorizationManager; /** * 注册安全验证规则 * 配置方式与HttpSecurity基本一致 */ @Bean SecurityWebFilterChain springSecurityFilterChain(ServerHttpSecurity http) &#123; //定义SecurityWebFilterChain对安全进行控制，使用ServerHttpSecurity构造过滤器链； return http.authorizeExchange() //.anyExchange().authenticated() //所有请求都需要通过认证 .pathMatchers(&quot;/res/**&quot;, &quot;/userInfo/**&quot;).authenticated() //需要具备相应的角色才能访问 .pathMatchers(&quot;/user/**&quot;).hasAnyRole(&quot;admin&quot;, &quot;user&quot;) //不需要登录就可以访问 .pathMatchers(&quot;/swagger-ui/**&quot;, &quot;/v3/api-docs**&quot;).permitAll() //其它路径需要根据指定的方法判断是否有权限访问，基于权限管理模型认证 .anyExchange().access(customReactiveAuthorizationManager) .and() .csrf().disable() //关闭CSRF（Cross-site request forgery）跨站请求伪造 .httpBasic().disable() //不支持HTTP Basic方式登录 .formLogin().disable()//不支持login页面登录 .cors() //开启跨域支持 .and() //鉴权时只支持Bearer Token的形式，不支持url后加参数access_token .oauth2ResourceServer()//开启oauth2资源认证 .jwt() //token为jwt //默认情况下，权限是scope，而我们希望使用的是用户的角色，所以这里需要通过转换器进行处理 .jwtAuthenticationConverter(jwt -&gt; &#123; //通过自定义Converter来指定权限，Converter是函数接口，当前上下问参数为JWT对象 Collection&lt;SimpleGrantedAuthority&gt; authorities = ((Collection&lt;String&gt;) jwt.getClaims() .get(&quot;authorities&quot;)).stream() //获取JWT中的authorities .map(SimpleGrantedAuthority::new) .collect(Collectors.toSet()); //如果希望保留scope的权限，可以取出scope数据然后合并到一起，这样因为不是以ROLE_开头，所以需要使用hasAuthority(&#x27;SCOPE_any&#x27;)的形式 Collection&lt;SimpleGrantedAuthority&gt; scopes = ((Collection&lt;String&gt;) jwt.getClaims() .get(&quot;scope&quot;)).stream().map(scope -&gt; new SimpleGrantedAuthority(&quot;SCOPE_&quot; + scope)) .collect(Collectors.toSet()); //合并权限 authorities.addAll(scopes); return Mono.just(new JwtAuthenticationToken(jwt, authorities)); &#125;) .and() .accessDeniedHandler(customServerAccessDeniedHandler) .authenticationEntryPoint(customServerAuthenticationEntryPoint) .and().build(); &#125;&#125; CustomReactiveAuthorizationManager基于RBAC权限认证管理模型的认证方式 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253package com.example.oauth2resourceserverwebfluxdemo.security;import org.springframework.http.server.reactive.ServerHttpRequest;import org.springframework.security.authorization.AuthorizationDecision;import org.springframework.security.authorization.ReactiveAuthorizationManager;import org.springframework.security.core.Authentication;import org.springframework.security.oauth2.jwt.Jwt;import org.springframework.security.web.server.authorization.AuthorizationContext;import org.springframework.stereotype.Component;import org.springframework.util.AntPathMatcher;import org.springframework.util.StringUtils;import reactor.core.publisher.Mono;import java.util.HashSet;import java.util.Set;/** * &lt;h1&gt;ReactiveAuthorizationManager&lt;/h1&gt; * Created by hanqf on 2020/11/30 12:05. */@Componentpublic class CustomReactiveAuthorizationManager implements ReactiveAuthorizationManager&lt;AuthorizationContext&gt; &#123; @Override public Mono&lt;AuthorizationDecision&gt; check(Mono&lt;Authentication&gt; authentication, AuthorizationContext object) &#123; return authentication.map(auth -&gt; &#123; ServerHttpRequest request = object.getExchange().getRequest(); Object principal = auth.getPrincipal(); String username; if (principal instanceof Jwt) &#123; username = ((Jwt) principal).getClaimAsString(&quot;user_name&quot;); &#125; else &#123; username = principal.toString(); &#125; boolean hasPerssion = false; if (StringUtils.hasText(username) &amp;&amp; !&quot;anonymousUser&quot;.equals(username)) &#123; //根据用户名查询用户资源权限，这里应该访问数据库查询 Set&lt;String&gt; uris = new HashSet&lt;&gt;(); for (String uri : uris) &#123; //验证用户拥有的资源权限是否与请求的资源相匹配 if (new AntPathMatcher().match(uri, request.getURI().toString())) &#123; hasPerssion = true; break; &#125; &#125; &#125; //暂时全部返回true hasPerssion = true; return new AuthorizationDecision(hasPerssion); &#125;); &#125;&#125; CustomServerAccessDeniedHandler没有权限时的处理方式 1234567891011121314151617181920212223242526272829303132333435363738package com.example.oauth2resourceserverwebfluxdemo.security;import com.example.oauth2resourceserverwebfluxdemo.exception.AjaxResponse;import com.example.oauth2resourceserverwebfluxdemo.exception.CustomException;import com.example.oauth2resourceserverwebfluxdemo.exception.CustomExceptionType;import com.fasterxml.jackson.core.JsonProcessingException;import com.fasterxml.jackson.databind.ObjectMapper;import lombok.SneakyThrows;import org.springframework.http.MediaType;import org.springframework.http.server.reactive.ServerHttpResponse;import org.springframework.security.access.AccessDeniedException;import org.springframework.security.web.server.authorization.ServerAccessDeniedHandler;import org.springframework.stereotype.Component;import org.springframework.web.server.ServerWebExchange;import reactor.core.publisher.Mono;/** * &lt;h1&gt;没有权限时的处理方式&lt;/h1&gt; * Created by hanqf on 2020/11/20 11:56. */@Componentpublic class CustomServerAccessDeniedHandler implements ServerAccessDeniedHandler &#123; @SneakyThrows @Override public Mono&lt;Void&gt; handle(ServerWebExchange serverWebExchange, AccessDeniedException e) &#123; return setErrorResponse(serverWebExchange.getResponse(),e.getMessage()); &#125; protected Mono&lt;Void&gt; setErrorResponse(ServerHttpResponse response, String message) throws JsonProcessingException &#123; response.getHeaders().setContentType(MediaType.APPLICATION_JSON); ObjectMapper objectMapper = new ObjectMapper(); AjaxResponse ajaxResponse = AjaxResponse.error(new CustomException(CustomExceptionType.USER_INPUT_ERROR, message)); return response.writeWith(Mono.just(response.bufferFactory().wrap(objectMapper.writeValueAsBytes(ajaxResponse)))); &#125;&#125; CustomServerAuthenticationEntryPointtoken格式错误或过期时的处理方式 123456789101112131415161718192021222324252627282930313233343536373839package com.example.oauth2resourceserverwebfluxdemo.security;import com.example.oauth2resourceserverwebfluxdemo.exception.AjaxResponse;import com.example.oauth2resourceserverwebfluxdemo.exception.CustomException;import com.example.oauth2resourceserverwebfluxdemo.exception.CustomExceptionType;import com.fasterxml.jackson.core.JsonProcessingException;import com.fasterxml.jackson.databind.ObjectMapper;import lombok.SneakyThrows;import org.springframework.http.MediaType;import org.springframework.http.server.reactive.ServerHttpResponse;import org.springframework.security.core.AuthenticationException;import org.springframework.security.web.server.ServerAuthenticationEntryPoint;import org.springframework.stereotype.Component;import org.springframework.web.server.ServerWebExchange;import reactor.core.publisher.Mono;/** * &lt;h1&gt;ServerAuthenticationEntryPoint&lt;/h1&gt; * Created by hanqf on 2020/11/20 12:01. * &lt;p&gt; * token格式错误或过期时的处理方式 */@Componentpublic class CustomServerAuthenticationEntryPoint implements ServerAuthenticationEntryPoint &#123; @SneakyThrows @Override public Mono&lt;Void&gt; commence(ServerWebExchange serverWebExchange, AuthenticationException e) &#123; return setErrorResponse(serverWebExchange.getResponse(), e.getMessage()); &#125; protected Mono&lt;Void&gt; setErrorResponse(ServerHttpResponse response, String message) throws JsonProcessingException &#123; response.getHeaders().setContentType(MediaType.APPLICATION_JSON); ObjectMapper objectMapper = new ObjectMapper(); AjaxResponse ajaxResponse = AjaxResponse.error(new CustomException(CustomExceptionType.USER_INPUT_ERROR, message)); return response.writeWith(Mono.just(response.bufferFactory().wrap(objectMapper.writeValueAsBytes(ajaxResponse)))); &#125;&#125; WebFluxConfig配置跨域 123456789101112131415161718192021222324252627282930313233package com.example.oauth2resourceserverwebfluxdemo.config;import org.springframework.context.annotation.Configuration;import org.springframework.web.reactive.config.CorsRegistry;import org.springframework.web.reactive.config.WebFluxConfigurer;/** * &lt;h1&gt;WebFlux配置类&lt;/h1&gt; * Created by hanqf on 2020/11/18 17:43. * * 我们若需要配置Spring WebFlux只需让配置配实现接口WebFluxConfigurer， * 这样我们既能保留Spring Boot给WebFlux配置又能添加我们的定制配置。 * 若我们向完全控制WebFlux，则在配置类添加注解@EnableWebFlux * 配置方式和Spring MVC类似 */@Configurationpublic class WebFluxConfig implements WebFluxConfigurer &#123; //跨域设置 @Override public void addCorsMappings(CorsRegistry registry) &#123; registry.addMapping(&quot;/**&quot;) //添加映射路径，“/**”表示对所有的路径实行全局跨域访问权限的设置 .allowedMethods(&quot;GET&quot;,&quot;POST&quot;, &quot;PUT&quot;, &quot;DELETE&quot;) //开放哪些Http方法，允许跨域访问 .allowedHeaders(&quot;*&quot;) //允许HTTP请求中的携带哪些Header信息 //When allowCredentials is true, allowedOrigins cannot contain the special value &quot;*&quot;since that cannot be set on the &quot;Access-Control-Allow-Origin&quot; response header. // To allow credentials to a set of origins, list them explicitly or consider using &quot;allowedOriginPatterns&quot; instead. //.allowedOrigins(&quot;*&quot;) //开放哪些ip、端口、域名的访问权限 .allowedOriginPatterns(&quot;*&quot;) .allowCredentials(true); //是否允许发送Cookie信息 &#125;&#125; application.yml12345678910111213141516171819#资源服务器端口号server: port: 8083spring: application: name: oauth2-resource-server-webflux #oauth2 配置 security: oauth2: resourceserver: jwt: # 公钥文件路径 # public-key-location: classpath:oauth2_key.pub # 认证服务器提供的密钥验证路径，这种方式每次验证access_token都需要访问认证服务器 jwk-set-uri: http://localhost:8080/.well-known/jwks.json 资源接口示例12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758package com.example.oauth2resourceserverwebfluxdemo.controller;import com.example.oauth2resourceserverwebfluxdemo.exception.AjaxResponse;import org.springframework.security.access.prepost.PreAuthorize;import org.springframework.security.core.Authentication;import org.springframework.security.oauth2.jwt.Jwt;import org.springframework.web.bind.annotation.RequestMapping;import org.springframework.web.bind.annotation.RestController;import reactor.core.publisher.Mono;import java.security.Principal;import java.util.HashMap;import java.util.Map;/** * &lt;h1&gt;res&lt;/h1&gt; * Created by hanqf on 2020/11/6 17:22. */@RestControllerpublic class UserController &#123; //注意权限区分大小写 @PreAuthorize(&quot;hasRole(&#x27;admin&#x27;) or hasRole(&#x27;user&#x27;)&quot;) //@PreAuthorize(&quot;#oauth2.hasScope(&#x27;any&#x27;)&quot;) //不支持oauth2表达式 @RequestMapping(value = &quot;/user&quot;) public Mono&lt;AjaxResponse&gt; user(Principal principal) &#123; //principal在经过security拦截后，是org.springframework.security.authentication.UsernamePasswordAuthenticationToken //在经OAuth2拦截后，是OAuth2Authentication return Mono.just(AjaxResponse.success(principal)); &#125; //注意权限区分大小写 @PreAuthorize(&quot;hasAuthority(&#x27;SCOPE_any&#x27;)&quot;) @RequestMapping(value = &quot;/user2&quot;) public Mono&lt;AjaxResponse&gt; user2(Principal principal) &#123; //principal在经过security拦截后，是org.springframework.security.authentication.UsernamePasswordAuthenticationToken //在经OAuth2拦截后，是OAuth2Authentication return Mono.just(AjaxResponse.success(principal)); &#125; /** * 获取用户的claim信息 */ @RequestMapping(&quot;/userInfo&quot;) public Mono&lt;Map&lt;String, Object&gt;&gt; userInfo(Authentication authentication)&#123; Map&lt;String,Object&gt; map = new HashMap&lt;&gt;(); Object principal = authentication.getPrincipal(); if(principal instanceof Jwt)&#123; map.put(&quot;username&quot;, ((Jwt) principal).getClaim(&quot;user_name&quot;)); map.putAll(((Jwt) principal).getClaims()); &#125; return Mono.just(map); &#125;&#125;","summary":"摘要 通过本文，你将知道如何搭建一个基于SpringBoot-OAuth2-JWT-WebFlux的资源服务器 本文基于springboot:2.4.0，项目基于Gradle-6.6.1构建 本文基于SpringBoot-OAuth2-JWT-ResourceServer并实现其功能，可以参考对比 代码地址:https://github.com/hanqunfeng/springbootchapter/tree/master/chapter48","date_published":"2020-12-02T12:30:05.000Z","tags":["技术","springboot2","Java","springboot","oauth2","springsecurity","jwt","webflux"]},{"id":"https://blog.hanqunfeng.com/2020/11/27/gradle-depoly-maven-center-repository/","url":"https://blog.hanqunfeng.com/2020/11/27/gradle-depoly-maven-center-repository/","title":"发布Jar到Maven中央仓库--gradle","content_html":"<h2 id=\"摘要\"><a href=\"#摘要\" class=\"headerlink\" title=\"摘要\"></a>摘要</h2><ul>\n<li>通过本文，你将知道如何将gradle构建的项目发布到Maven中央仓库</li>\n<li>maven构建请看<a href=\"https://blog.hanqunfeng.com/2020/11/26/mvn-depoly-maven-center-repository/#more\">发布Jar到Maven中央仓库–mvn</a>。</li>\n<li>前三个步骤与<a href=\"https://blog.hanqunfeng.com/2020/11/26/mvn-depoly-maven-center-repository/#more\">发布Jar到Maven中央仓库–mvn</a>相同，不在赘述。</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"一、将项目推送到远程仓库，如-Github或者Gitee\"><a href=\"#一、将项目推送到远程仓库，如-Github或者Gitee\" class=\"headerlink\" title=\"一、将项目推送到远程仓库，如 Github或者Gitee\"></a>一、将项目推送到远程仓库，如 Github或者Gitee</h2><h2 id=\"二、注册-Sonatype-账户–就是一个JIRA\"><a href=\"#二、注册-Sonatype-账户–就是一个JIRA\" class=\"headerlink\" title=\"二、注册 Sonatype 账户–就是一个JIRA\"></a>二、注册 Sonatype 账户–就是一个JIRA</h2><h2 id=\"三、登录-Sonatype-创建工单–每部署一个新项目就创建一个工单\"><a href=\"#三、登录-Sonatype-创建工单–每部署一个新项目就创建一个工单\" class=\"headerlink\" title=\"三、登录 Sonatype 创建工单–每部署一个新项目就创建一个工单\"></a>三、登录 Sonatype 创建工单–每部署一个新项目就创建一个工单</h2><p>前三个步骤与<a href=\"https://blog.hanqunfeng.com/2020/11/26/mvn-depoly-maven-center-repository/#more\">发布Jar到Maven中央仓库–mvn</a>相同，不在赘述。</p>\n<h2 id=\"四、发布\"><a href=\"#四、发布\" class=\"headerlink\" title=\"四、发布\"></a>四、发布</h2><ul>\n<li><p>1.签名<br>  我是mac电脑，于是签名工具使用的是<a href=\"https://gpgtools.org/\">https://gpgtools.org</a>，gradle签名时需要使用到<code>.gpg</code>证书文件，这个工具不支持直接导出gpg，其导出的证书文件是<code>.asc</code>格式的，asc其实就是字符串，可以用记事本打开查看。</p>\n<p>  使用如下命令导出gpg格式的私钥证书：</p>\n  <figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> qunfeng_han@126.com是创建证书时使用的邮箱，会要求你输入创建证书时的密码</span></span><br><span class=\"line\">gpg --export-secret-keys qunfeng_han@126.com &gt; secret.gpg</span><br><span class=\"line\"><span class=\"meta\"></span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 也可以使用创建证书的用户名，会要求你输入创建证书时的密码</span></span><br><span class=\"line\">gpg --export-secret-keys hanqunfeng &gt; secret.gpg</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 导出私钥明文</span></span><br><span class=\"line\">gpg --export-secret-keys --armor hanqunfeng &gt; secret.asc</span><br><span class=\"line\"><span class=\"meta\"></span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 列出当前全部证书</span></span><br><span class=\"line\">gpg -k</span><br><span class=\"line\"><span class=\"meta\"></span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 导出公钥</span></span><br><span class=\"line\">gpg --export hanqunfeng &gt; public.gpg</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 导出公钥明文</span></span><br><span class=\"line\">gpg --export --armor hanqunfeng &gt; public.asc</span><br><span class=\"line\"><span class=\"meta\"></span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 导入公钥或私钥，区别就是导入公钥不需要创建证书的密码</span></span><br><span class=\"line\">gpg --import public.gpg</span><br><span class=\"line\">gpg --import --armor secret.asc</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>  也可以使用windows系统下载的<a href=\"https://www.gpg4win.org/\">https://www.gpg4win.org/</a>Kleopatra，将gpgtools导出的证书（勾选密码才是私钥证书，看生成文件的名称就可以，公开就是公钥，私密就是私钥）导入到Kleopatra中，然后右键选择–&gt;Backup secret keys,记得后缀一定是gpg，该工具支持三种格式，asc、gpg、pgp，默认也是acs，手工将文件后缀修改为gpg即可。</p>\n<p>  也可以重新生成了一个密钥对，打开软件，菜单–&gt;文件–&gt;新建密钥对–&gt;创建个人penPGP密钥对，创建好后记得点击“保存密钥副本”，以导出gpg证书文件，该工具支持三种格式，asc、gpg、pgp，默认也是acs，手工将文件后缀修改为gpg即可，如果此时忘记点击保留副本，也可以在证书列表页右键选择–&gt;Backup secret keys,记得后缀一定是gpg。</p>\n</li>\n</ul>\n<ul>\n<li><p>build.gradle<br>重点还是<code>io.codearte.nexus-staging</code>这个自动发布插件，不需要手工操作oss-sonatype的UI进行发布。</p>\n<figure class=\"highlight gradle\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">plugins &#123;</span><br><span class=\"line\">    id <span class=\"string\">&#x27;io.spring.dependency-management&#x27;</span> version <span class=\"string\">&#x27;1.0.10.RELEASE&#x27;</span></span><br><span class=\"line\">    <span class=\"comment\">//此处必须是java-library，如果是java则api方法不可用，api可以理解为就是compile，支持传递依赖</span></span><br><span class=\"line\">    id <span class=\"string\">&#x27;java-library&#x27;</span></span><br><span class=\"line\">    <span class=\"comment\">//发布插件</span></span><br><span class=\"line\">    id <span class=\"string\">&#x27;maven-publish&#x27;</span></span><br><span class=\"line\">    <span class=\"comment\">//签名插件</span></span><br><span class=\"line\">    id <span class=\"string\">&#x27;signing&#x27;</span></span><br><span class=\"line\">    <span class=\"comment\">//自动发布到maven中央仓库插件</span></span><br><span class=\"line\">    <span class=\"comment\">//https://github.com/Codearte/gradle-nexus-staging-plugin</span></span><br><span class=\"line\">    id <span class=\"string\">&#x27;io.codearte.nexus-staging&#x27;</span> version <span class=\"string\">&#x27;0.22.0&#x27;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">group</span> = <span class=\"string\">&#x27;com.hanqunfeng&#x27;</span></span><br><span class=\"line\"><span class=\"comment\">//SNAPSHOT版本是不支持发布到Maven中央仓库</span></span><br><span class=\"line\">version = <span class=\"string\">&#x27;1.0.3&#x27;</span></span><br><span class=\"line\"><span class=\"keyword\">sourceCompatibility</span> = <span class=\"string\">&#x27;1.8&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">java &#123;</span><br><span class=\"line\">    withJavadocJar()</span><br><span class=\"line\">    withSourcesJar()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">repositories</span> &#123;</span><br><span class=\"line\">    maven &#123; url <span class=\"string\">&#x27;https://maven.aliyun.com/repository/public/&#x27;</span> &#125;</span><br><span class=\"line\">    mavenLocal()</span><br><span class=\"line\">    mavenCentral()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">dependencyManagement &#123;</span><br><span class=\"line\">    imports &#123; mavenBom(<span class=\"string\">&quot;org.springframework.boot:spring-boot-dependencies:2.4.0&quot;</span>) &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">dependencies</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">//lombok</span></span><br><span class=\"line\">    compileOnly <span class=\"string\">&#x27;org.projectlombok:lombok&#x27;</span></span><br><span class=\"line\">    annotationProcessor <span class=\"string\">&#x27;org.projectlombok:lombok&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//如果不希望传递依赖，则使用implementation，传递依赖则使用compile或者api，gradle7后将不再支持compile</span></span><br><span class=\"line\">    <span class=\"comment\">//注解相关</span></span><br><span class=\"line\">    api <span class=\"string\">&#x27;org.springframework.boot:spring-boot-autoconfigure&#x27;</span></span><br><span class=\"line\">    api <span class=\"string\">&#x27;org.springframework.boot:spring-boot-configuration-processor&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//json-jackson</span></span><br><span class=\"line\">    api <span class=\"string\">&#x27;com.fasterxml.jackson.core:jackson-databind&#x27;</span></span><br><span class=\"line\">    api <span class=\"string\">&#x27;com.fasterxml.jackson.datatype:jackson-datatype-jdk8&#x27;</span></span><br><span class=\"line\">    api <span class=\"string\">&#x27;com.fasterxml.jackson.datatype:jackson-datatype-jsr310&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//@Aspect</span></span><br><span class=\"line\">    api <span class=\"string\">&#x27;org.aspectj:aspectjweaver&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//Mono Flux</span></span><br><span class=\"line\">    api <span class=\"string\">&#x27;io.projectreactor:reactor-core&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//redis-template</span></span><br><span class=\"line\">    api <span class=\"string\">&#x27;org.springframework.data:spring-data-redis&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">test &#123;</span><br><span class=\"line\">    useJUnitPlatform()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// java编译的时候缺省状态下会因为中文字符而失败</span></span><br><span class=\"line\">[compileJava, compileTestJava]*.<span class=\"keyword\">options</span>*.encoding = <span class=\"string\">&#x27;UTF-8&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 发布插件</span></span><br><span class=\"line\"><span class=\"comment\"> * 参考：https://docs.gradle.org/6.6.1/userguide/publishing_maven.html#publishing_maven:resolved_dependencies</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\">publishing &#123;</span><br><span class=\"line\">    publications &#123;</span><br><span class=\"line\">        mavenJava(MavenPublication) &#123;</span><br><span class=\"line\">            groupId = <span class=\"keyword\">project</span>.<span class=\"keyword\">group</span></span><br><span class=\"line\">            artifactId = <span class=\"keyword\">project</span>.name</span><br><span class=\"line\">            version = <span class=\"keyword\">project</span>.version</span><br><span class=\"line\">            <span class=\"comment\">//如果不定义，则会按照以上默认值执行</span></span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">from</span> components.java</span><br><span class=\"line\"></span><br><span class=\"line\">            pom &#123;</span><br><span class=\"line\">                name = <span class=\"string\">&#x27;redis-cache-annotation-reactive&#x27;</span></span><br><span class=\"line\">                <span class=\"keyword\">description</span> = <span class=\"string\">&#x27;redis cache function annotation for webflux&#x27;</span></span><br><span class=\"line\">                url = <span class=\"string\">&#x27;https://blog.hanqunfeng.com&#x27;</span></span><br><span class=\"line\">                licenses &#123;</span><br><span class=\"line\">                    license &#123;</span><br><span class=\"line\">                        name = <span class=\"string\">&#x27;The Apache License, Version 2.0&#x27;</span></span><br><span class=\"line\">                        url = <span class=\"string\">&#x27;http://www.apache.org/licenses/LICENSE-2.0.txt&#x27;</span></span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                developers &#123;</span><br><span class=\"line\">                    developer &#123;</span><br><span class=\"line\">                        id = <span class=\"string\">&#x27;hanqf&#x27;</span></span><br><span class=\"line\">                        name = <span class=\"string\">&#x27;han qunfeng&#x27;</span></span><br><span class=\"line\">                        email = <span class=\"string\">&#x27;qunfeng_han@126.com&#x27;</span></span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                scm &#123;</span><br><span class=\"line\">                    connection = <span class=\"string\">&#x27;scm:git:https://github.com/hanqunfeng/reactive-redis-cache-annotation-spring-boot-starter.git&#x27;</span></span><br><span class=\"line\">                    developerConnection = <span class=\"string\">&#x27;scm:git:https://github.com:hanqunfeng/reactive-redis-cache-annotation-spring-boot-starter.git&#x27;</span></span><br><span class=\"line\">                    url = <span class=\"string\">&#x27;https://github.com/hanqunfeng/reactive-redis-cache-annotation-spring-boot-starter&#x27;</span></span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            versionMapping &#123;</span><br><span class=\"line\">                usage(<span class=\"string\">&#x27;java-api&#x27;</span>) &#123;</span><br><span class=\"line\">                    fromResolutionOf(<span class=\"string\">&#x27;runtimeClasspath&#x27;</span>)</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                usage(<span class=\"string\">&#x27;java-runtime&#x27;</span>) &#123;</span><br><span class=\"line\">                    fromResolutionResult()</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">repositories</span> &#123;</span><br><span class=\"line\">        maven &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 发布仓库配置，这里基于version后缀是否为SNAPSHOT来区分发布到release库还是snapshots库</span></span><br><span class=\"line\">           <span class=\"comment\">// def releasesRepoUrl = &quot;http://nexus.cxzh.ltd:8081/repository/maven-releases/&quot;</span></span><br><span class=\"line\">           <span class=\"comment\">// def snapshotsRepoUrl = &quot;http://nexus.cxzh.ltd:8081/repository/maven-snapshots/&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">def</span> releasesRepoUrl = <span class=\"string\">&quot;https://oss.sonatype.org/service/local/staging/deploy/maven2/&quot;</span></span><br><span class=\"line\">            <span class=\"keyword\">def</span> snapshotsRepoUrl = <span class=\"string\">&quot;https://oss.sonatype.org/content/repositories/snapshots/&quot;</span></span><br><span class=\"line\">            url = version.endsWith(<span class=\"string\">&#x27;SNAPSHOT&#x27;</span>) ? snapshotsRepoUrl : releasesRepoUrl</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//认证用户和密码，在配置文件gradle.properties中配置</span></span><br><span class=\"line\">            <span class=\"comment\">//oss-sonatype的登录用户名和密码</span></span><br><span class=\"line\">            credentials &#123;</span><br><span class=\"line\">                username nexusUser</span><br><span class=\"line\">                password nexusPassword</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">tasks.withType(JavaCompile) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">options</span>.encoding = <span class=\"string\">&#x27;UTF-8&#x27;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//javadoc，如果用jdk11，默认就支持中文</span></span><br><span class=\"line\"><span class=\"comment\">//查看可以配置的属性：https://docs.gradle.org/current/javadoc/org/gradle/external/javadoc/StandardJavadocDocletOptions.html</span></span><br><span class=\"line\">tasks.withType(Javadoc) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">options</span>.version = <span class=\"keyword\">true</span></span><br><span class=\"line\">    <span class=\"keyword\">options</span>.author = <span class=\"keyword\">true</span></span><br><span class=\"line\">    <span class=\"keyword\">options</span>.encoding = <span class=\"string\">&quot;UTF-8&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">options</span>.charSet = <span class=\"string\">&quot;UTF-8&quot;</span>  <span class=\"comment\">//解决中文乱码</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">javadoc &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(JavaVersion.current().isJava9Compatible()) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">options</span>.addBooleanOption(<span class=\"string\">&#x27;html5&#x27;</span>, <span class=\"keyword\">true</span>)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (JavaVersion.current().isJava8Compatible()) &#123;</span><br><span class=\"line\">        tasks.withType(Javadoc) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// disable the crazy super-strict doclint tool in Java 8</span></span><br><span class=\"line\">            <span class=\"comment\">// noinspection SpellCheckingInspection</span></span><br><span class=\"line\">            <span class=\"keyword\">options</span>.addStringOption(<span class=\"string\">&#x27;Xdoclint:none&#x27;</span>, <span class=\"string\">&#x27;-quiet&#x27;</span>)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//签名，发布时会先执行签名</span></span><br><span class=\"line\"><span class=\"comment\">//参考：https://docs.gradle.org/current/userguide/signing_plugin.html</span></span><br><span class=\"line\">signing &#123;</span><br><span class=\"line\">    sign publishing.publications.mavenJava</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//自动发布到maven中央仓库插件的配置信息</span></span><br><span class=\"line\"><span class=\"comment\">//参考：https://github.com/Codearte/gradle-nexus-staging-plugin</span></span><br><span class=\"line\">nexusStaging &#123;</span><br><span class=\"line\">    <span class=\"comment\">//oss-sonatype的登录用户名和密码</span></span><br><span class=\"line\">    username nexusUser</span><br><span class=\"line\">    password nexusPassword</span><br><span class=\"line\">    <span class=\"comment\">//重试次数，默认是60次</span></span><br><span class=\"line\">    numberOfRetries <span class=\"number\">10</span></span><br><span class=\"line\">    <span class=\"comment\">//每次重试的间隔时间，单位毫秒，默认2000，按照官网的说明，执行发布时有延迟，需要等待响应，所以建议调整间隔时间，可以减少重试次数，我这里间隔20秒，大约重试1~2次即可完成</span></span><br><span class=\"line\">    delayBetweenRetriesInMillis <span class=\"number\">20000</span></span><br><span class=\"line\"><span class=\"comment\">//    packageGroup = &quot;com.hanqunfeng&quot; //optional if packageGroup == project.getGroup()</span></span><br><span class=\"line\"><span class=\"comment\">//    stagingProfileId = &quot;yourStagingProfileId&quot; //when not defined will be got from server using &quot;packageGroup&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure></li>\n<li><p>gradle.properties</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#gradle -PnexusUser=developer -PnexusPassword=developer clean publish</span><br><span class=\"line\"># 注意参数要放到命令前面</span><br><span class=\"line\"># 这里替换为自己的oss-sonatype的用户名和密码</span><br><span class=\"line\">nexusUser=developer</span><br><span class=\"line\">nexusPassword=developer</span><br><span class=\"line\"></span><br><span class=\"line\">#Disable maven-metadata.xml SHA256 and SHA512 upload warnings to Nexus</span><br><span class=\"line\">#参考：https://github.com/gradle/gradle/issues/12355</span><br><span class=\"line\">systemProp.org.gradle.internal.publish.checksums.insecure=true</span><br><span class=\"line\"></span><br><span class=\"line\">#签名信息。或者执行命令时携带参数，如：gradle -Psigning.secretKeyRingFile=/SECRET.gpg -Psigning.password=xxxxxxxx -Psigning.keyId=xxxxxxxx clean publish</span><br><span class=\"line\"># 这里替换自己的签名信息</span><br><span class=\"line\">signing.keyId=xxxxxxxx</span><br><span class=\"line\">signing.password=xxxxxxxx</span><br><span class=\"line\">signing.secretKeyRingFile=/SECRET.gpg</span><br></pre></td></tr></table></figure></li>\n<li><p>执行命令</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./gradlew clean publish closeAndReleaseRepository # 部署到maven中央仓库，参数都配置在gradle.properties中</span><br><span class=\"line\">./gradlew -PnexusUser=developer -PnexusPassword=developer -Psigning.secretKeyRingFile=/SECRET.gpg -Psigning.password=xxxxxxxx -Psigning.keyId=xxxxxxxx clean publish closeAndReleaseRepository # 命令行携带参数</span><br></pre></td></tr></table></figure></li>\n</ul>\n","content_text":"摘要 通过本文，你将知道如何将gradle构建的项目发布到Maven中央仓库 maven构建请看发布Jar到Maven中央仓库–mvn。 前三个步骤与发布Jar到Maven中央仓库–mvn相同，不在赘述。 一、将项目推送到远程仓库，如 Github或者Gitee二、注册 Sonatype 账户–就是一个JIRA三、登录 Sonatype 创建工单–每部署一个新项目就创建一个工单前三个步骤与发布Jar到Maven中央仓库–mvn相同，不在赘述。 四、发布 1.签名 我是mac电脑，于是签名工具使用的是https://gpgtools.org，gradle签名时需要使用到.gpg证书文件，这个工具不支持直接导出gpg，其导出的证书文件是.asc格式的，asc其实就是字符串，可以用记事本打开查看。 使用如下命令导出gpg格式的私钥证书： 1234567891011121314151617181920# qunfeng_han@126.com是创建证书时使用的邮箱，会要求你输入创建证书时的密码gpg --export-secret-keys qunfeng_han@126.com &gt; secret.gpg# 也可以使用创建证书的用户名，会要求你输入创建证书时的密码gpg --export-secret-keys hanqunfeng &gt; secret.gpg# 导出私钥明文gpg --export-secret-keys --armor hanqunfeng &gt; secret.asc# 列出当前全部证书gpg -k# 导出公钥gpg --export hanqunfeng &gt; public.gpg# 导出公钥明文gpg --export --armor hanqunfeng &gt; public.asc# 导入公钥或私钥，区别就是导入公钥不需要创建证书的密码gpg --import public.gpggpg --import --armor secret.asc 也可以使用windows系统下载的https://www.gpg4win.org/Kleopatra，将gpgtools导出的证书（勾选密码才是私钥证书，看生成文件的名称就可以，公开就是公钥，私密就是私钥）导入到Kleopatra中，然后右键选择–&gt;Backup secret keys,记得后缀一定是gpg，该工具支持三种格式，asc、gpg、pgp，默认也是acs，手工将文件后缀修改为gpg即可。 也可以重新生成了一个密钥对，打开软件，菜单–&gt;文件–&gt;新建密钥对–&gt;创建个人penPGP密钥对，创建好后记得点击“保存密钥副本”，以导出gpg证书文件，该工具支持三种格式，asc、gpg、pgp，默认也是acs，手工将文件后缀修改为gpg即可，如果此时忘记点击保留副本，也可以在证书列表页右键选择–&gt;Backup secret keys,记得后缀一定是gpg。 build.gradle重点还是io.codearte.nexus-staging这个自动发布插件，不需要手工操作oss-sonatype的UI进行发布。 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186plugins &#123; id &#x27;io.spring.dependency-management&#x27; version &#x27;1.0.10.RELEASE&#x27; //此处必须是java-library，如果是java则api方法不可用，api可以理解为就是compile，支持传递依赖 id &#x27;java-library&#x27; //发布插件 id &#x27;maven-publish&#x27; //签名插件 id &#x27;signing&#x27; //自动发布到maven中央仓库插件 //https://github.com/Codearte/gradle-nexus-staging-plugin id &#x27;io.codearte.nexus-staging&#x27; version &#x27;0.22.0&#x27;&#125;group = &#x27;com.hanqunfeng&#x27;//SNAPSHOT版本是不支持发布到Maven中央仓库version = &#x27;1.0.3&#x27;sourceCompatibility = &#x27;1.8&#x27;java &#123; withJavadocJar() withSourcesJar()&#125;repositories &#123; maven &#123; url &#x27;https://maven.aliyun.com/repository/public/&#x27; &#125; mavenLocal() mavenCentral()&#125;dependencyManagement &#123; imports &#123; mavenBom(&quot;org.springframework.boot:spring-boot-dependencies:2.4.0&quot;) &#125;&#125;dependencies &#123; //lombok compileOnly &#x27;org.projectlombok:lombok&#x27; annotationProcessor &#x27;org.projectlombok:lombok&#x27; //如果不希望传递依赖，则使用implementation，传递依赖则使用compile或者api，gradle7后将不再支持compile //注解相关 api &#x27;org.springframework.boot:spring-boot-autoconfigure&#x27; api &#x27;org.springframework.boot:spring-boot-configuration-processor&#x27; //json-jackson api &#x27;com.fasterxml.jackson.core:jackson-databind&#x27; api &#x27;com.fasterxml.jackson.datatype:jackson-datatype-jdk8&#x27; api &#x27;com.fasterxml.jackson.datatype:jackson-datatype-jsr310&#x27; //@Aspect api &#x27;org.aspectj:aspectjweaver&#x27; //Mono Flux api &#x27;io.projectreactor:reactor-core&#x27; //redis-template api &#x27;org.springframework.data:spring-data-redis&#x27;&#125;test &#123; useJUnitPlatform()&#125;// java编译的时候缺省状态下会因为中文字符而失败[compileJava, compileTestJava]*.options*.encoding = &#x27;UTF-8&#x27;/** * 发布插件 * 参考：https://docs.gradle.org/6.6.1/userguide/publishing_maven.html#publishing_maven:resolved_dependencies */publishing &#123; publications &#123; mavenJava(MavenPublication) &#123; groupId = project.group artifactId = project.name version = project.version //如果不定义，则会按照以上默认值执行 from components.java pom &#123; name = &#x27;redis-cache-annotation-reactive&#x27; description = &#x27;redis cache function annotation for webflux&#x27; url = &#x27;https://blog.hanqunfeng.com&#x27; licenses &#123; license &#123; name = &#x27;The Apache License, Version 2.0&#x27; url = &#x27;http://www.apache.org/licenses/LICENSE-2.0.txt&#x27; &#125; &#125; developers &#123; developer &#123; id = &#x27;hanqf&#x27; name = &#x27;han qunfeng&#x27; email = &#x27;qunfeng_han@126.com&#x27; &#125; &#125; scm &#123; connection = &#x27;scm:git:https://github.com/hanqunfeng/reactive-redis-cache-annotation-spring-boot-starter.git&#x27; developerConnection = &#x27;scm:git:https://github.com:hanqunfeng/reactive-redis-cache-annotation-spring-boot-starter.git&#x27; url = &#x27;https://github.com/hanqunfeng/reactive-redis-cache-annotation-spring-boot-starter&#x27; &#125; &#125; versionMapping &#123; usage(&#x27;java-api&#x27;) &#123; fromResolutionOf(&#x27;runtimeClasspath&#x27;) &#125; usage(&#x27;java-runtime&#x27;) &#123; fromResolutionResult() &#125; &#125; &#125; &#125; repositories &#123; maven &#123; // 发布仓库配置，这里基于version后缀是否为SNAPSHOT来区分发布到release库还是snapshots库 // def releasesRepoUrl = &quot;http://nexus.cxzh.ltd:8081/repository/maven-releases/&quot; // def snapshotsRepoUrl = &quot;http://nexus.cxzh.ltd:8081/repository/maven-snapshots/&quot; def releasesRepoUrl = &quot;https://oss.sonatype.org/service/local/staging/deploy/maven2/&quot; def snapshotsRepoUrl = &quot;https://oss.sonatype.org/content/repositories/snapshots/&quot; url = version.endsWith(&#x27;SNAPSHOT&#x27;) ? snapshotsRepoUrl : releasesRepoUrl //认证用户和密码，在配置文件gradle.properties中配置 //oss-sonatype的登录用户名和密码 credentials &#123; username nexusUser password nexusPassword &#125; &#125; &#125;&#125;tasks.withType(JavaCompile) &#123; options.encoding = &#x27;UTF-8&#x27;&#125;//javadoc，如果用jdk11，默认就支持中文//查看可以配置的属性：https://docs.gradle.org/current/javadoc/org/gradle/external/javadoc/StandardJavadocDocletOptions.htmltasks.withType(Javadoc) &#123; options.version = true options.author = true options.encoding = &quot;UTF-8&quot; options.charSet = &quot;UTF-8&quot; //解决中文乱码&#125;javadoc &#123; if(JavaVersion.current().isJava9Compatible()) &#123; options.addBooleanOption(&#x27;html5&#x27;, true) &#125; if (JavaVersion.current().isJava8Compatible()) &#123; tasks.withType(Javadoc) &#123; // disable the crazy super-strict doclint tool in Java 8 // noinspection SpellCheckingInspection options.addStringOption(&#x27;Xdoclint:none&#x27;, &#x27;-quiet&#x27;) &#125; &#125;&#125;//签名，发布时会先执行签名//参考：https://docs.gradle.org/current/userguide/signing_plugin.htmlsigning &#123; sign publishing.publications.mavenJava&#125;//自动发布到maven中央仓库插件的配置信息//参考：https://github.com/Codearte/gradle-nexus-staging-pluginnexusStaging &#123; //oss-sonatype的登录用户名和密码 username nexusUser password nexusPassword //重试次数，默认是60次 numberOfRetries 10 //每次重试的间隔时间，单位毫秒，默认2000，按照官网的说明，执行发布时有延迟，需要等待响应，所以建议调整间隔时间，可以减少重试次数，我这里间隔20秒，大约重试1~2次即可完成 delayBetweenRetriesInMillis 20000// packageGroup = &quot;com.hanqunfeng&quot; //optional if packageGroup == project.getGroup()// stagingProfileId = &quot;yourStagingProfileId&quot; //when not defined will be got from server using &quot;packageGroup&quot;&#125; gradle.properties 123456789101112131415#gradle -PnexusUser=developer -PnexusPassword=developer clean publish# 注意参数要放到命令前面# 这里替换为自己的oss-sonatype的用户名和密码nexusUser=developernexusPassword=developer#Disable maven-metadata.xml SHA256 and SHA512 upload warnings to Nexus#参考：https://github.com/gradle/gradle/issues/12355systemProp.org.gradle.internal.publish.checksums.insecure=true#签名信息。或者执行命令时携带参数，如：gradle -Psigning.secretKeyRingFile=/SECRET.gpg -Psigning.password=xxxxxxxx -Psigning.keyId=xxxxxxxx clean publish# 这里替换自己的签名信息signing.keyId=xxxxxxxxsigning.password=xxxxxxxxsigning.secretKeyRingFile=/SECRET.gpg 执行命令 12./gradlew clean publish closeAndReleaseRepository # 部署到maven中央仓库，参数都配置在gradle.properties中./gradlew -PnexusUser=developer -PnexusPassword=developer -Psigning.secretKeyRingFile=/SECRET.gpg -Psigning.password=xxxxxxxx -Psigning.keyId=xxxxxxxx clean publish closeAndReleaseRepository # 命令行携带参数","summary":"摘要 通过本文，你将知道如何将gradle构建的项目发布到Maven中央仓库 maven构建请看发布Jar到Maven中央仓库–mvn。 前三个步骤与发布Jar到Maven中央仓库–mvn相同，不在赘述。","date_published":"2020-11-27T13:30:05.000Z","tags":["技术","maven","gradle"]},{"id":"https://blog.hanqunfeng.com/2020/11/26/mvn-depoly-maven-center-repository/","url":"https://blog.hanqunfeng.com/2020/11/26/mvn-depoly-maven-center-repository/","title":"发布Jar到Maven中央仓库--mvn","content_html":"<h2 id=\"摘要\"><a href=\"#摘要\" class=\"headerlink\" title=\"摘要\"></a>摘要</h2><ul>\n<li>通过本文，你将知道如何将maven构建的项目发布到Maven中央仓库</li>\n<li>gradle构建请看<a href=\"https://blog.hanqunfeng.com/2020/11/27/gradle-depoly-maven-center-repository/\">发布Jar到Maven中央仓库–gradle</a></li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"一、将项目推送到远程仓库，如-Github或者Gitee\"><a href=\"#一、将项目推送到远程仓库，如-Github或者Gitee\" class=\"headerlink\" title=\"一、将项目推送到远程仓库，如 Github或者Gitee\"></a>一、将项目推送到远程仓库，如 Github或者Gitee</h2><h2 id=\"二、注册-Sonatype-账户–就是一个JIRA\"><a href=\"#二、注册-Sonatype-账户–就是一个JIRA\" class=\"headerlink\" title=\"二、注册 Sonatype 账户–就是一个JIRA\"></a>二、注册 Sonatype 账户–就是一个JIRA</h2><p>进入 <a href=\"https://issues.sonatype.org/secure/Dashboard.jspa\">https://issues.sonatype.org/secure/Dashboard.jspa</a> 注册一个账号，邮箱要真实。</p>\n<h2 id=\"三、登录-Sonatype-创建工单–每部署一个新项目就创建一个工单\"><a href=\"#三、登录-Sonatype-创建工单–每部署一个新项目就创建一个工单\" class=\"headerlink\" title=\"三、登录 Sonatype 创建工单–每部署一个新项目就创建一个工单\"></a>三、登录 Sonatype 创建工单–每部署一个新项目就创建一个工单</h2><ul>\n<li>登录后点击“新建”创建工单，如果没有显示“新建”菜单，可以直接请求“<a href=\"https://issues.sonatype.org/secure/CreateIssue.jspa?issuetype=21&amp;pid=10134%E2%80%9D\">https://issues.sonatype.org/secure/CreateIssue.jspa?issuetype=21&amp;pid=10134”</a></li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Summary：工单摘要，随便给个名称</span><br><span class=\"line\">Group Id：填写项目的Group Id</span><br><span class=\"line\">Project URL：填写远程仓库的浏览器地址</span><br><span class=\"line\">SCM url：填写下载项目的git地址</span><br></pre></td></tr></table></figure>\n<ul>\n<li><p>注意：Group Id：最好填写你拥有的域名，比如我的域名是hanqunfeng.com，这里就填写com.hanqunfeng，这样后面验证domain时会方便一些。我第一次就是不知道这个事情，所以随便填的hanqf.org。</p>\n</li>\n<li><p>创建好工单后会收到两封邮件：</p>\n<ul>\n<li><p>第一封，通知你创建工单成功。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">hanqunfeng created OSSRH-62247:</span><br><span class=\"line\">----------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\">            Summary: reactive-redis-cache-annotation</span><br><span class=\"line\">                Key: OSSRH-62247</span><br><span class=\"line\">                URL: https://issues.sonatype.org/browse/OSSRH-62247</span><br><span class=\"line\">            Project: Community Support - Open Source Project Repository Hosting</span><br><span class=\"line\">        Issue Type: New Project</span><br><span class=\"line\">            Reporter: hanqunfeng</span><br><span class=\"line\">            Assignee: Joel Orlina</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">reactive-redis-cache-annotation-spring-boot-starter</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">--</span><br><span class=\"line\">This message was sent by Atlassian Jira</span><br><span class=\"line\">(v8.5.7#805007)</span><br></pre></td></tr></table></figure></li>\n<li><p>第二封邮件，要求你验证domain，两封邮件间隔大约5分钟。同时你在工单的注释中也能看到系统回复的同样的信息。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[ https://issues.sonatype.org/browse/OSSRH-62247?page=com.atlassian.jira.plugin.system.issuetabpanels:all-tabpanel ]</span><br><span class=\"line\"></span><br><span class=\"line\">Central OSSRH updated OSSRH-62247:</span><br><span class=\"line\">----------------------------------</span><br><span class=\"line\">    Status: Waiting for Response  (was: Open)</span><br><span class=\"line\"></span><br><span class=\"line\">Do you own the domain hanqf.org? If so, please verify ownership via one of the following methods:</span><br><span class=\"line\">* Add a TXT record to your DNS referencing this JIRA ticket: OSSRH-62247 (Fastest)</span><br><span class=\"line\">* Setup a redirect to your Github page (if it does not already exist)</span><br><span class=\"line\"></span><br><span class=\"line\">If you do not own this domain, please read:</span><br><span class=\"line\">http://central.sonatype.org/pages/choosing-your-coordinates.html</span><br><span class=\"line\">You may also choose a groupId that reflects your project hosting, in this case, something like io.github.hanqunfeng or com.github.hanqunfeng</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">&gt; reactive-redis-cache-annotation</span><br><span class=\"line\">&gt; -------------------------------</span><br><span class=\"line\">&gt;</span><br><span class=\"line\">&gt;                 Key: OSSRH-62247</span><br><span class=\"line\">&gt;                 URL: https://issues.sonatype.org/browse/OSSRH-62247</span><br><span class=\"line\">&gt;             Project: Community Support - Open Source Project Repository Hosting</span><br><span class=\"line\">&gt;          Issue Type: New Project</span><br><span class=\"line\">&gt;            Reporter: hanqunfeng</span><br><span class=\"line\">&gt;            Assignee: Joel Orlina</span><br><span class=\"line\">&gt;            Priority: Major</span><br><span class=\"line\">&gt;</span><br><span class=\"line\">&gt; reactive-redis-cache-annotation-spring-boot-starter</span><br></pre></td></tr></table></figure></li>\n</ul>\n</li>\n</ul>\n<ul>\n<li><p>看邮件说明，如果是自己的域名，添加一条TXT record 是最快速的验证方式，刚好我有一个域名，于是修改了工单的Group Id，修改工单时需要填写注释，随便填就行。</p>\n</li>\n<li><p>然后去设置了DNS，一条TXT记录，key是工单号，我这里就是OSSRH-62247，值是工单地址，这里就是<a href=\"https://issues.sonatype.org/browse/OSSRH-62247%EF%BC%8C%E5%88%9B%E5%BB%BA%E5%A5%BD%E5%90%8E%EF%BC%8C%E5%9C%A8%E5%B7%A5%E5%8D%95%E4%B8%AD%E6%B7%BB%E5%8A%A0%E4%B8%80%E6%9D%A1%E6%B3%A8%E9%87%8A\">https://issues.sonatype.org/browse/OSSRH-62247，创建好后，在工单中添加一条注释</a></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">I have change the group Id to com.hanqunfeng,and I own the domain hanqunfeng.com,and I have added a dns record TXT.</span><br></pre></td></tr></table></figure>\n<p>其它验证方式我并未尝试。</p>\n</li>\n<li><p>过一会你就会收到回复邮件，通知你验证完成，可以发布了，并且给出了发布地址。</p>\n<ul>\n<li>注意这里是先发布到<a href=\"https://oss.sonatype.org,而不是maven中央仓库的地址./\">https://oss.sonatype.org，而不是maven中央仓库的地址。</a><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[ https://issues.sonatype.org/browse/OSSRH-62247?page=com.atlassian.jira.plugin.system.issuetabpanels:all-tabpanel ]</span><br><span class=\"line\"></span><br><span class=\"line\">Central OSSRH resolved OSSRH-62247.</span><br><span class=\"line\">-----------------------------------</span><br><span class=\"line\">    Resolution: Fixed</span><br><span class=\"line\"></span><br><span class=\"line\">com.hanqunfeng has been prepared, now user(s) hanqf can:</span><br><span class=\"line\">* Deploy snapshot artifacts into repository https://oss.sonatype.org/content/repositories/snapshots</span><br><span class=\"line\">* Deploy release artifacts into the staging repository https://oss.sonatype.org/service/local/staging/deploy/maven2</span><br><span class=\"line\">* Release staged artifacts into repository &#x27;Releases&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\">please comment on this ticket when you promoted your first release, thanks</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; reactive-redis-cache-annotation</span><br><span class=\"line\">&gt; -------------------------------</span><br><span class=\"line\">&gt;</span><br><span class=\"line\">&gt;                 Key: OSSRH-62247</span><br><span class=\"line\">&gt;                 URL: https://issues.sonatype.org/browse/OSSRH-62247</span><br><span class=\"line\">&gt;             Project: Community Support - Open Source Project Repository Hosting</span><br><span class=\"line\">&gt;          Issue Type: New Project</span><br><span class=\"line\">&gt;            Reporter: hanqunfeng</span><br><span class=\"line\">&gt;            Assignee: Joel Orlina</span><br><span class=\"line\">&gt;            Priority: Major</span><br><span class=\"line\">&gt;</span><br><span class=\"line\">&gt; reactive-redis-cache-annotation-spring-boot-starter</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">--</span><br><span class=\"line\">This message was sent by Atlassian Jira</span><br><span class=\"line\">(v8.5.7#805007)</span><br></pre></td></tr></table></figure></li>\n</ul>\n</li>\n</ul>\n<h2 id=\"四、发布\"><a href=\"#四、发布\" class=\"headerlink\" title=\"四、发布\"></a>四、发布</h2><ul>\n<li><p>1.准备签名</p>\n<ul>\n<li>可以使用工具创建密钥对<br>需要下载一个签名工具，我是mac电脑，下载的是<a href=\"https://gpgtools.org/\">https://gpgtools.org</a>。<br>安装后点击新建，按照提示创建一个密钥对即可，注意高级选项里有个过期时间，默认是3年。创建好后会主动提示你是否将公钥发布到key server，点击Upload Public key即可。也可以在创建后的证书列表页面邮件选择证书–&gt;Send Public Key To Key Server。</li>\n</ul>\n<p>  导出证书时，勾选密码并设置密码就是私钥和公钥证书，不勾选密码就是公钥，看生成文件的名称就可以，公开就是公钥，私密就是私钥，格式都是asc，其实就是字符串，可以用记事本打开查看。</p>\n<p>  如果windows系统，可以下载<a href=\"https://www.gpg4win.org/\">https://www.gpg4win.org/</a> ，使用方式差不多，最后点击“将公钥上传的目录服务”。</p>\n<p>  公钥发布到key server后要稍微等一会，大约10分钟吧，因为key server有多个，同步需要一些时间。<br>  记住你创建密钥对时的密码，发布项目时要使用。</p>\n<ul>\n<li>也可以使用命令行创建密钥对，版本[gpg (GnuPG/MacGPG2) 2.2.24]  <figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 创建密钥对，按提示输入用户名称和邮箱地址</span></span><br><span class=\"line\">gpg --generate-key</span><br><span class=\"line\"><span class=\"meta\"></span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 列出密钥，hanqunfeng就是创建密钥对是的用户名，此处也可以使用邮箱</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 结果中第二行一长串的后8位就是keyId，比如：30FF8D58，gradle构建时会用到</span></span><br><span class=\"line\">gpg --list-keys hanqunfeng</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 也可以直接通过id查询</span></span><br><span class=\"line\">gpg --list-keys 30FF8D58</span><br><span class=\"line\"><span class=\"meta\"></span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 上传公钥到server key，默认上传到hkps://keys.openpgp.org，但是提示上传失败</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 看到网上的示例可以通过--keyserver指定上传的服务器地址，但是我这个版本[gpg (GnuPG/MacGPG2) 2.2.24]没有这个参数</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 使用 https://gpgtools.org 上传公钥就会成功</span></span><br><span class=\"line\">gpg --send-keys 30FF8D58</span><br><span class=\"line\"><span class=\"meta\"></span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 查看指纹</span></span><br><span class=\"line\">gpg --fingerprint 30FF8D58</span><br><span class=\"line\"><span class=\"meta\"></span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 删除私钥，这里也可以使用用户名称或者邮箱，如果唯一的话</span></span><br><span class=\"line\">gpg --delete-secret-keys 30FF8D58</span><br><span class=\"line\"><span class=\"meta\"></span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 删除公钥</span></span><br><span class=\"line\">gpg --delete-keys 30FF8D58</span><br></pre></td></tr></table></figure></li>\n</ul>\n</li>\n<li><p>2.settings.xml<br>配置 maven 的 settings.xml 文件，设置一个 server，里面添加 Sonatype 的账号和密码。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;settings&gt;</span><br><span class=\"line\">    [...]</span><br><span class=\"line\">    &lt;servers&gt;</span><br><span class=\"line\">       [...]</span><br><span class=\"line\">       &lt;server&gt;</span><br><span class=\"line\">          &lt;id&gt;ossrh&lt;/id&gt;</span><br><span class=\"line\">          &lt;username&gt;Sonatype账号&lt;/username&gt;</span><br><span class=\"line\">          &lt;password&gt;Sonatype密码&lt;/password&gt;</span><br><span class=\"line\">       &lt;/server&gt;</span><br><span class=\"line\">    &lt;/servers&gt;</span><br><span class=\"line\">&lt;/settings&gt;</span><br></pre></td></tr></table></figure></li>\n<li><p>3.pom.xml，重点是后面几个plugin<br>这里重点说一下“nexus-staging-maven-plugin”这个插件，该插件会将我们发布到<a href=\"https://oss.sonatype.org的jar自动发布到maven中央仓库,如果没有这个插件,我们需要登录https//oss.sonatype.org%EF%BC%8C%E7%84%B6%E5%90%8E%E6%89%8B%E5%B7%A5%E7%82%B9%E5%87%BBStaging\">https://oss.sonatype.org的jar自动发布到maven中央仓库，如果没有这个插件，我们需要登录https://oss.sonatype.org，然后手工点击Staging</a> Repositories ，找到你发布的包（GroupId开头的），然后点击close，再点击release。有说这种方式容易失败（我没有测试），推荐使用插件自动发布。</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">project</span> <span class=\"attr\">xmlns</span>=<span class=\"string\">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">         <span class=\"attr\">xmlns:xsi</span>=<span class=\"string\">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">         <span class=\"attr\">xsi:schemaLocation</span>=<span class=\"string\">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">modelVersion</span>&gt;</span>4.0.0<span class=\"tag\">&lt;/<span class=\"name\">modelVersion</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>com.hanqunfeng<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>reactive-redis-cache-annotation-spring-boot-starter<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>1.0.1<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>redis-cache-annotation-reactive<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">description</span>&gt;</span>redis cache function annotation for webflux<span class=\"tag\">&lt;/<span class=\"name\">description</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">url</span>&gt;</span>https://blog.hanqunfeng.com<span class=\"tag\">&lt;/<span class=\"name\">url</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">licenses</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">license</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>The Apache License, Version 2.0<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">url</span>&gt;</span>http://www.apache.org/licenses/LICENSE-2.0.txt<span class=\"tag\">&lt;/<span class=\"name\">url</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">license</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">licenses</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">developers</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">developer</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">id</span>&gt;</span>hanqf<span class=\"tag\">&lt;/<span class=\"name\">id</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>hanqunfeng<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">email</span>&gt;</span>qunfeng_han@126.com<span class=\"tag\">&lt;/<span class=\"name\">email</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">developer</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">developers</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">scm</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">connection</span>&gt;</span>scm:git:https://github.com/hanqunfeng/reactive-redis-cache-annotation-spring-boot-starter.git<span class=\"tag\">&lt;/<span class=\"name\">connection</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">developerConnection</span>&gt;</span>scm:git:https://github.com:hanqunfeng/reactive-redis-cache-annotation-spring-boot-starter.git<span class=\"tag\">&lt;/<span class=\"name\">developerConnection</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">url</span>&gt;</span>https://github.com/hanqunfeng/reactive-redis-cache-annotation-spring-boot-starter<span class=\"tag\">&lt;/<span class=\"name\">url</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">scm</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">properties</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">java.version</span>&gt;</span>1.8<span class=\"tag\">&lt;/<span class=\"name\">java.version</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">maven.compiler.encoding</span>&gt;</span>UTF-8<span class=\"tag\">&lt;/<span class=\"name\">maven.compiler.encoding</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class=\"tag\">&lt;/<span class=\"name\">project.build.sourceEncoding</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">properties</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">dependencies</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.boot<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-boot-autoconfigure<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.boot<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>jackson-databind<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>com.fasterxml.jackson.datatype<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>jackson-datatype-jdk8<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>com.fasterxml.jackson.datatype<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>jackson-datatype-jsr310<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.aspectj<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>aspectjweaver<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>io.projectreactor<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>reactor-core<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.data<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-data-redis<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.projectlombok<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>lombok<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">optional</span>&gt;</span>true<span class=\"tag\">&lt;/<span class=\"name\">optional</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">dependencies</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">dependencyManagement</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dependencies</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.boot<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-boot-dependencies<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>2.4.0<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">scope</span>&gt;</span>import<span class=\"tag\">&lt;/<span class=\"name\">scope</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">type</span>&gt;</span>pom<span class=\"tag\">&lt;/<span class=\"name\">type</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">dependencies</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">dependencyManagement</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">build</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">plugins</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">plugin</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.apache.maven.plugins<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>maven-compiler-plugin<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>3.8.1<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">configuration</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;<span class=\"name\">source</span>&gt;</span>$&#123;java.version&#125;<span class=\"tag\">&lt;/<span class=\"name\">source</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;<span class=\"name\">target</span>&gt;</span>$&#123;java.version&#125;<span class=\"tag\">&lt;/<span class=\"name\">target</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;/<span class=\"name\">configuration</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">plugin</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">plugin</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.apache.maven.plugins<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>maven-source-plugin<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>3.2.1<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">executions</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;<span class=\"name\">execution</span>&gt;</span></span><br><span class=\"line\">                        <span class=\"tag\">&lt;<span class=\"name\">id</span>&gt;</span>attach-source<span class=\"tag\">&lt;/<span class=\"name\">id</span>&gt;</span></span><br><span class=\"line\">                        <span class=\"tag\">&lt;<span class=\"name\">phase</span>&gt;</span>verify<span class=\"tag\">&lt;/<span class=\"name\">phase</span>&gt;</span></span><br><span class=\"line\">                        <span class=\"tag\">&lt;<span class=\"name\">goals</span>&gt;</span></span><br><span class=\"line\">                            <span class=\"comment\">&lt;!--生成源代码的jar --&gt;</span></span><br><span class=\"line\">                            <span class=\"tag\">&lt;<span class=\"name\">goal</span>&gt;</span>jar<span class=\"tag\">&lt;/<span class=\"name\">goal</span>&gt;</span></span><br><span class=\"line\">                        <span class=\"tag\">&lt;/<span class=\"name\">goals</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;/<span class=\"name\">execution</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;/<span class=\"name\">executions</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">plugin</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">plugin</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.apache.maven.plugins<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>maven-javadoc-plugin<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>3.2.0<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">executions</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;<span class=\"name\">execution</span>&gt;</span></span><br><span class=\"line\">                        <span class=\"tag\">&lt;<span class=\"name\">id</span>&gt;</span>attach-javadoc<span class=\"tag\">&lt;/<span class=\"name\">id</span>&gt;</span></span><br><span class=\"line\">                        <span class=\"tag\">&lt;<span class=\"name\">phase</span>&gt;</span>verify<span class=\"tag\">&lt;/<span class=\"name\">phase</span>&gt;</span></span><br><span class=\"line\">                        <span class=\"tag\">&lt;<span class=\"name\">goals</span>&gt;</span></span><br><span class=\"line\">                            <span class=\"comment\">&lt;!--生成javadoc的jar --&gt;</span></span><br><span class=\"line\">                            <span class=\"tag\">&lt;<span class=\"name\">goal</span>&gt;</span>jar<span class=\"tag\">&lt;/<span class=\"name\">goal</span>&gt;</span></span><br><span class=\"line\">                            <span class=\"comment\">&lt;!--生成javadoc的html --&gt;</span></span><br><span class=\"line\">                            <span class=\"tag\">&lt;<span class=\"name\">goal</span>&gt;</span>javadoc<span class=\"tag\">&lt;/<span class=\"name\">goal</span>&gt;</span></span><br><span class=\"line\">                        <span class=\"tag\">&lt;/<span class=\"name\">goals</span>&gt;</span></span><br><span class=\"line\">                        <span class=\"tag\">&lt;<span class=\"name\">configuration</span>&gt;</span></span><br><span class=\"line\">                            <span class=\"comment\">&lt;!--不显示javadoc警告--&gt;</span></span><br><span class=\"line\">                            <span class=\"tag\">&lt;<span class=\"name\">additionalOptions</span>&gt;</span>-Xdoclint:none<span class=\"tag\">&lt;/<span class=\"name\">additionalOptions</span>&gt;</span></span><br><span class=\"line\">                            <span class=\"tag\">&lt;<span class=\"name\">additionalJOption</span>&gt;</span>-Xdoclint:none<span class=\"tag\">&lt;/<span class=\"name\">additionalJOption</span>&gt;</span></span><br><span class=\"line\">                        <span class=\"tag\">&lt;/<span class=\"name\">configuration</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;/<span class=\"name\">execution</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;/<span class=\"name\">executions</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">plugin</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">&lt;!-- gpg plugin,用于签名认证 --&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">plugin</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.apache.maven.plugins<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>maven-gpg-plugin<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>1.6<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">executions</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;<span class=\"name\">execution</span>&gt;</span></span><br><span class=\"line\">                        <span class=\"tag\">&lt;<span class=\"name\">id</span>&gt;</span>sign-artifacts<span class=\"tag\">&lt;/<span class=\"name\">id</span>&gt;</span></span><br><span class=\"line\">                        <span class=\"tag\">&lt;<span class=\"name\">phase</span>&gt;</span>verify<span class=\"tag\">&lt;/<span class=\"name\">phase</span>&gt;</span></span><br><span class=\"line\">                        <span class=\"tag\">&lt;<span class=\"name\">goals</span>&gt;</span></span><br><span class=\"line\">                            <span class=\"tag\">&lt;<span class=\"name\">goal</span>&gt;</span>sign<span class=\"tag\">&lt;/<span class=\"name\">goal</span>&gt;</span></span><br><span class=\"line\">                        <span class=\"tag\">&lt;/<span class=\"name\">goals</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;/<span class=\"name\">execution</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;/<span class=\"name\">executions</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">plugin</span>&gt;</span></span><br><span class=\"line\">            <span class=\"comment\">&lt;!--staging puglin,用于自动执行发布阶段(免手动)--&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">plugin</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.sonatype.plugins<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>nexus-staging-maven-plugin<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>1.6.8<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">extensions</span>&gt;</span>true<span class=\"tag\">&lt;/<span class=\"name\">extensions</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">configuration</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;<span class=\"name\">serverId</span>&gt;</span>ossrh<span class=\"tag\">&lt;/<span class=\"name\">serverId</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;<span class=\"name\">nexusUrl</span>&gt;</span>https://oss.sonatype.org/<span class=\"tag\">&lt;/<span class=\"name\">nexusUrl</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;<span class=\"name\">autoReleaseAfterClose</span>&gt;</span>true<span class=\"tag\">&lt;/<span class=\"name\">autoReleaseAfterClose</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;/<span class=\"name\">configuration</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">plugin</span>&gt;</span></span><br><span class=\"line\">            <span class=\"comment\">&lt;!-- release plugin,用于发布到release仓库部署插件 --&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">plugin</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.apache.maven.plugins<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>maven-release-plugin<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>2.5.3<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">plugin</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">plugins</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">build</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">distributionManagement</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">snapshotRepository</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">id</span>&gt;</span>ossrh<span class=\"tag\">&lt;/<span class=\"name\">id</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">url</span>&gt;</span>https://oss.sonatype.org/content/repositories/snapshots/<span class=\"tag\">&lt;/<span class=\"name\">url</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">snapshotRepository</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">repository</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">id</span>&gt;</span>ossrh<span class=\"tag\">&lt;/<span class=\"name\">id</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">url</span>&gt;</span>https://oss.sonatype.org/service/local/staging/deploy/maven2/<span class=\"tag\">&lt;/<span class=\"name\">url</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">repository</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">distributionManagement</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">project</span>&gt;</span></span><br></pre></td></tr></table></figure></li>\n<li><p>4.执行命令</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mvn clean package # 完成打包和测试</span><br><span class=\"line\">mvn clean verify  # 完成源码打包和javadoc打包，同时完成签名</span><br><span class=\"line\">mvn clean deploy  # 完成本地部署和maven中央仓库部署</span><br></pre></td></tr></table></figure>\n\n<p>  执行过程中会提示你输入创建密钥对时的密码，</p>\n<p>  如果不想人工参与，也可以使用如下方式（参考：<a href=\"http://maven.apache.org/plugins/maven-gpg-plugin/usage.html%EF%BC%89\">http://maven.apache.org/plugins/maven-gpg-plugin/usage.html）</a></p>\n<ul>\n<li><p>a.在执行命令时指定密码：</p>\n  <figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mvn clean deploy -Dgpg.passphrase=thephrase</span><br></pre></td></tr></table></figure></li>\n<li><p>b.setting.xml中创建一个server</p>\n  <figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;settings&gt;</span><br><span class=\"line\">[...]</span><br><span class=\"line\">&lt;servers&gt;</span><br><span class=\"line\">    [...]</span><br><span class=\"line\">    &lt;server&gt;</span><br><span class=\"line\">    &lt;id&gt;gpg.passphrase&lt;/id&gt;</span><br><span class=\"line\">    &lt;passphrase&gt;clear or encrypted text&lt;/passphrase&gt;</span><br><span class=\"line\">    &lt;/server&gt;</span><br><span class=\"line\">&lt;/servers&gt;</span><br><span class=\"line\">&lt;/settings&gt;</span><br></pre></td></tr></table></figure></li>\n</ul>\n</li>\n<li><p>5.执行成功后即说明发布到maven中央仓库成功了，过一会就会收到邮件</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[ https://issues.sonatype.org/browse/OSSRH-62247?page=com.atlassian.jira.plugin.system.issuetabpanels:all-tabpanel ]</span><br><span class=\"line\"></span><br><span class=\"line\">Central OSSRH 更新了 OSSRH-62247:</span><br><span class=\"line\">------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\">Central sync is activated for com.hanqunfeng. After you successfully release, your component will be published to Central, typically within 10 minutes, though updates to search.maven.org can take up to two hours.</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; reactive-redis-cache-annotation</span><br><span class=\"line\">&gt; -------------------------------</span><br><span class=\"line\">&gt;</span><br><span class=\"line\">&gt;                 关键字: OSSRH-62247</span><br><span class=\"line\">&gt;                 URL: https://issues.sonatype.org/browse/OSSRH-62247</span><br><span class=\"line\">&gt;                  项目: Community Support - Open Source Project Repository Hosting</span><br><span class=\"line\">&gt;                问题类型: New Project</span><br><span class=\"line\">&gt;                 报告人: hanqunfeng</span><br><span class=\"line\">&gt;                 经办人: Joel Orlina</span><br><span class=\"line\">&gt;                 优先级: 重要</span><br><span class=\"line\">&gt;</span><br><span class=\"line\">&gt; reactive-redis-cache-annotation-spring-boot-starter</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">--</span><br><span class=\"line\">这条信息是由Atlassian Jira发送的</span><br><span class=\"line\">(v8.5.7#805007)</span><br></pre></td></tr></table></figure>\n\n<p>  提示你，大约10分钟后你就可以将依赖添加到项目中进行下载了，不过要通过search.maven.org检索到需要等待两个小时，毕竟更新索引也是需要时间的。<br>  另外，如果你确认发布是成功的，记得要回到工单添加个注释，如</p>\n  <figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">I&#x27;ve released Releases successfully.Thank you!</span><br></pre></td></tr></table></figure></li>\n</ul>\n<ul>\n<li>6.更新部署<br>修改pom.xml中的版本号，重新执行mvn clean deploy即可。此时不会再收到sonatype发的邮件，依旧等待大约10分钟后你就可以将依赖添加到项目中进行下载了，同样search.maven.org检索到需要等待两个小时。</li>\n</ul>\n","content_text":"摘要 通过本文，你将知道如何将maven构建的项目发布到Maven中央仓库 gradle构建请看发布Jar到Maven中央仓库–gradle 一、将项目推送到远程仓库，如 Github或者Gitee二、注册 Sonatype 账户–就是一个JIRA进入 https://issues.sonatype.org/secure/Dashboard.jspa 注册一个账号，邮箱要真实。 三、登录 Sonatype 创建工单–每部署一个新项目就创建一个工单 登录后点击“新建”创建工单，如果没有显示“新建”菜单，可以直接请求“https://issues.sonatype.org/secure/CreateIssue.jspa?issuetype=21&amp;pid=10134” 1234Summary：工单摘要，随便给个名称Group Id：填写项目的Group IdProject URL：填写远程仓库的浏览器地址SCM url：填写下载项目的git地址 注意：Group Id：最好填写你拥有的域名，比如我的域名是hanqunfeng.com，这里就填写com.hanqunfeng，这样后面验证domain时会方便一些。我第一次就是不知道这个事情，所以随便填的hanqf.org。 创建好工单后会收到两封邮件： 第一封，通知你创建工单成功。 12345678910111213141516171819hanqunfeng created OSSRH-62247:---------------------------------- Summary: reactive-redis-cache-annotation Key: OSSRH-62247 URL: https://issues.sonatype.org/browse/OSSRH-62247 Project: Community Support - Open Source Project Repository Hosting Issue Type: New Project Reporter: hanqunfeng Assignee: Joel Orlinareactive-redis-cache-annotation-spring-boot-starter--This message was sent by Atlassian Jira(v8.5.7#805007) 第二封邮件，要求你验证domain，两封邮件间隔大约5分钟。同时你在工单的注释中也能看到系统回复的同样的信息。 123456789101112131415161718192021222324252627[ https://issues.sonatype.org/browse/OSSRH-62247?page=com.atlassian.jira.plugin.system.issuetabpanels:all-tabpanel ]Central OSSRH updated OSSRH-62247:---------------------------------- Status: Waiting for Response (was: Open)Do you own the domain hanqf.org? If so, please verify ownership via one of the following methods:* Add a TXT record to your DNS referencing this JIRA ticket: OSSRH-62247 (Fastest)* Setup a redirect to your Github page (if it does not already exist)If you do not own this domain, please read:http://central.sonatype.org/pages/choosing-your-coordinates.htmlYou may also choose a groupId that reflects your project hosting, in this case, something like io.github.hanqunfeng or com.github.hanqunfeng&gt; reactive-redis-cache-annotation&gt; -------------------------------&gt;&gt; Key: OSSRH-62247&gt; URL: https://issues.sonatype.org/browse/OSSRH-62247&gt; Project: Community Support - Open Source Project Repository Hosting&gt; Issue Type: New Project&gt; Reporter: hanqunfeng&gt; Assignee: Joel Orlina&gt; Priority: Major&gt;&gt; reactive-redis-cache-annotation-spring-boot-starter 看邮件说明，如果是自己的域名，添加一条TXT record 是最快速的验证方式，刚好我有一个域名，于是修改了工单的Group Id，修改工单时需要填写注释，随便填就行。 然后去设置了DNS，一条TXT记录，key是工单号，我这里就是OSSRH-62247，值是工单地址，这里就是https://issues.sonatype.org/browse/OSSRH-62247，创建好后，在工单中添加一条注释 1I have change the group Id to com.hanqunfeng,and I own the domain hanqunfeng.com,and I have added a dns record TXT. 其它验证方式我并未尝试。 过一会你就会收到回复邮件，通知你验证完成，可以发布了，并且给出了发布地址。 注意这里是先发布到https://oss.sonatype.org，而不是maven中央仓库的地址。12345678910111213141516171819202122232425262728293031[ https://issues.sonatype.org/browse/OSSRH-62247?page=com.atlassian.jira.plugin.system.issuetabpanels:all-tabpanel ]Central OSSRH resolved OSSRH-62247.----------------------------------- Resolution: Fixedcom.hanqunfeng has been prepared, now user(s) hanqf can:* Deploy snapshot artifacts into repository https://oss.sonatype.org/content/repositories/snapshots* Deploy release artifacts into the staging repository https://oss.sonatype.org/service/local/staging/deploy/maven2* Release staged artifacts into repository &#x27;Releases&#x27;please comment on this ticket when you promoted your first release, thanks&gt; reactive-redis-cache-annotation&gt; -------------------------------&gt;&gt; Key: OSSRH-62247&gt; URL: https://issues.sonatype.org/browse/OSSRH-62247&gt; Project: Community Support - Open Source Project Repository Hosting&gt; Issue Type: New Project&gt; Reporter: hanqunfeng&gt; Assignee: Joel Orlina&gt; Priority: Major&gt;&gt; reactive-redis-cache-annotation-spring-boot-starter--This message was sent by Atlassian Jira(v8.5.7#805007) 四、发布 1.准备签名 可以使用工具创建密钥对需要下载一个签名工具，我是mac电脑，下载的是https://gpgtools.org。安装后点击新建，按照提示创建一个密钥对即可，注意高级选项里有个过期时间，默认是3年。创建好后会主动提示你是否将公钥发布到key server，点击Upload Public key即可。也可以在创建后的证书列表页面邮件选择证书–&gt;Send Public Key To Key Server。 导出证书时，勾选密码并设置密码就是私钥和公钥证书，不勾选密码就是公钥，看生成文件的名称就可以，公开就是公钥，私密就是私钥，格式都是asc，其实就是字符串，可以用记事本打开查看。 如果windows系统，可以下载https://www.gpg4win.org/ ，使用方式差不多，最后点击“将公钥上传的目录服务”。 公钥发布到key server后要稍微等一会，大约10分钟吧，因为key server有多个，同步需要一些时间。 记住你创建密钥对时的密码，发布项目时要使用。 也可以使用命令行创建密钥对，版本[gpg (GnuPG/MacGPG2) 2.2.24] 12345678910111213141516171819202122# 创建密钥对，按提示输入用户名称和邮箱地址gpg --generate-key# 列出密钥，hanqunfeng就是创建密钥对是的用户名，此处也可以使用邮箱# 结果中第二行一长串的后8位就是keyId，比如：30FF8D58，gradle构建时会用到gpg --list-keys hanqunfeng# 也可以直接通过id查询gpg --list-keys 30FF8D58# 上传公钥到server key，默认上传到hkps://keys.openpgp.org，但是提示上传失败# 看到网上的示例可以通过--keyserver指定上传的服务器地址，但是我这个版本[gpg (GnuPG/MacGPG2) 2.2.24]没有这个参数# 使用 https://gpgtools.org 上传公钥就会成功gpg --send-keys 30FF8D58# 查看指纹gpg --fingerprint 30FF8D58# 删除私钥，这里也可以使用用户名称或者邮箱，如果唯一的话gpg --delete-secret-keys 30FF8D58# 删除公钥gpg --delete-keys 30FF8D58 2.settings.xml配置 maven 的 settings.xml 文件，设置一个 server，里面添加 Sonatype 的账号和密码。 1234567891011&lt;settings&gt; [...] &lt;servers&gt; [...] &lt;server&gt; &lt;id&gt;ossrh&lt;/id&gt; &lt;username&gt;Sonatype账号&lt;/username&gt; &lt;password&gt;Sonatype密码&lt;/password&gt; &lt;/server&gt; &lt;/servers&gt;&lt;/settings&gt; 3.pom.xml，重点是后面几个plugin这里重点说一下“nexus-staging-maven-plugin”这个插件，该插件会将我们发布到https://oss.sonatype.org的jar自动发布到maven中央仓库，如果没有这个插件，我们需要登录https://oss.sonatype.org，然后手工点击Staging Repositories ，找到你发布的包（GroupId开头的），然后点击close，再点击release。有说这种方式容易失败（我没有测试），推荐使用插件自动发布。 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt; &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt; &lt;groupId&gt;com.hanqunfeng&lt;/groupId&gt; &lt;artifactId&gt;reactive-redis-cache-annotation-spring-boot-starter&lt;/artifactId&gt; &lt;version&gt;1.0.1&lt;/version&gt; &lt;name&gt;redis-cache-annotation-reactive&lt;/name&gt; &lt;description&gt;redis cache function annotation for webflux&lt;/description&gt; &lt;url&gt;https://blog.hanqunfeng.com&lt;/url&gt; &lt;licenses&gt; &lt;license&gt; &lt;name&gt;The Apache License, Version 2.0&lt;/name&gt; &lt;url&gt;http://www.apache.org/licenses/LICENSE-2.0.txt&lt;/url&gt; &lt;/license&gt; &lt;/licenses&gt; &lt;developers&gt; &lt;developer&gt; &lt;id&gt;hanqf&lt;/id&gt; &lt;name&gt;hanqunfeng&lt;/name&gt; &lt;email&gt;qunfeng_han@126.com&lt;/email&gt; &lt;/developer&gt; &lt;/developers&gt; &lt;scm&gt; &lt;connection&gt;scm:git:https://github.com/hanqunfeng/reactive-redis-cache-annotation-spring-boot-starter.git&lt;/connection&gt; &lt;developerConnection&gt;scm:git:https://github.com:hanqunfeng/reactive-redis-cache-annotation-spring-boot-starter.git&lt;/developerConnection&gt; &lt;url&gt;https://github.com/hanqunfeng/reactive-redis-cache-annotation-spring-boot-starter&lt;/url&gt; &lt;/scm&gt; &lt;properties&gt; &lt;java.version&gt;1.8&lt;/java.version&gt; &lt;maven.compiler.encoding&gt;UTF-8&lt;/maven.compiler.encoding&gt; &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt; &lt;/properties&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-autoconfigure&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-configuration-processor&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt; &lt;artifactId&gt;jackson-databind&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;com.fasterxml.jackson.datatype&lt;/groupId&gt; &lt;artifactId&gt;jackson-datatype-jdk8&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;com.fasterxml.jackson.datatype&lt;/groupId&gt; &lt;artifactId&gt;jackson-datatype-jsr310&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.aspectj&lt;/groupId&gt; &lt;artifactId&gt;aspectjweaver&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;io.projectreactor&lt;/groupId&gt; &lt;artifactId&gt;reactor-core&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.data&lt;/groupId&gt; &lt;artifactId&gt;spring-data-redis&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.projectlombok&lt;/groupId&gt; &lt;artifactId&gt;lombok&lt;/artifactId&gt; &lt;optional&gt;true&lt;/optional&gt; &lt;/dependency&gt; &lt;/dependencies&gt; &lt;dependencyManagement&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-dependencies&lt;/artifactId&gt; &lt;version&gt;2.4.0&lt;/version&gt; &lt;scope&gt;import&lt;/scope&gt; &lt;type&gt;pom&lt;/type&gt; &lt;/dependency&gt; &lt;/dependencies&gt; &lt;/dependencyManagement&gt; &lt;build&gt; &lt;plugins&gt; &lt;plugin&gt; &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt; &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt; &lt;version&gt;3.8.1&lt;/version&gt; &lt;configuration&gt; &lt;source&gt;$&#123;java.version&#125;&lt;/source&gt; &lt;target&gt;$&#123;java.version&#125;&lt;/target&gt; &lt;/configuration&gt; &lt;/plugin&gt; &lt;plugin&gt; &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt; &lt;artifactId&gt;maven-source-plugin&lt;/artifactId&gt; &lt;version&gt;3.2.1&lt;/version&gt; &lt;executions&gt; &lt;execution&gt; &lt;id&gt;attach-source&lt;/id&gt; &lt;phase&gt;verify&lt;/phase&gt; &lt;goals&gt; &lt;!--生成源代码的jar --&gt; &lt;goal&gt;jar&lt;/goal&gt; &lt;/goals&gt; &lt;/execution&gt; &lt;/executions&gt; &lt;/plugin&gt; &lt;plugin&gt; &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt; &lt;artifactId&gt;maven-javadoc-plugin&lt;/artifactId&gt; &lt;version&gt;3.2.0&lt;/version&gt; &lt;executions&gt; &lt;execution&gt; &lt;id&gt;attach-javadoc&lt;/id&gt; &lt;phase&gt;verify&lt;/phase&gt; &lt;goals&gt; &lt;!--生成javadoc的jar --&gt; &lt;goal&gt;jar&lt;/goal&gt; &lt;!--生成javadoc的html --&gt; &lt;goal&gt;javadoc&lt;/goal&gt; &lt;/goals&gt; &lt;configuration&gt; &lt;!--不显示javadoc警告--&gt; &lt;additionalOptions&gt;-Xdoclint:none&lt;/additionalOptions&gt; &lt;additionalJOption&gt;-Xdoclint:none&lt;/additionalJOption&gt; &lt;/configuration&gt; &lt;/execution&gt; &lt;/executions&gt; &lt;/plugin&gt; &lt;!-- gpg plugin,用于签名认证 --&gt; &lt;plugin&gt; &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt; &lt;artifactId&gt;maven-gpg-plugin&lt;/artifactId&gt; &lt;version&gt;1.6&lt;/version&gt; &lt;executions&gt; &lt;execution&gt; &lt;id&gt;sign-artifacts&lt;/id&gt; &lt;phase&gt;verify&lt;/phase&gt; &lt;goals&gt; &lt;goal&gt;sign&lt;/goal&gt; &lt;/goals&gt; &lt;/execution&gt; &lt;/executions&gt; &lt;/plugin&gt; &lt;!--staging puglin,用于自动执行发布阶段(免手动)--&gt; &lt;plugin&gt; &lt;groupId&gt;org.sonatype.plugins&lt;/groupId&gt; &lt;artifactId&gt;nexus-staging-maven-plugin&lt;/artifactId&gt; &lt;version&gt;1.6.8&lt;/version&gt; &lt;extensions&gt;true&lt;/extensions&gt; &lt;configuration&gt; &lt;serverId&gt;ossrh&lt;/serverId&gt; &lt;nexusUrl&gt;https://oss.sonatype.org/&lt;/nexusUrl&gt; &lt;autoReleaseAfterClose&gt;true&lt;/autoReleaseAfterClose&gt; &lt;/configuration&gt; &lt;/plugin&gt; &lt;!-- release plugin,用于发布到release仓库部署插件 --&gt; &lt;plugin&gt; &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt; &lt;artifactId&gt;maven-release-plugin&lt;/artifactId&gt; &lt;version&gt;2.5.3&lt;/version&gt; &lt;/plugin&gt; &lt;/plugins&gt; &lt;/build&gt; &lt;distributionManagement&gt; &lt;snapshotRepository&gt; &lt;id&gt;ossrh&lt;/id&gt; &lt;url&gt;https://oss.sonatype.org/content/repositories/snapshots/&lt;/url&gt; &lt;/snapshotRepository&gt; &lt;repository&gt; &lt;id&gt;ossrh&lt;/id&gt; &lt;url&gt;https://oss.sonatype.org/service/local/staging/deploy/maven2/&lt;/url&gt; &lt;/repository&gt; &lt;/distributionManagement&gt;&lt;/project&gt; 4.执行命令 123mvn clean package # 完成打包和测试mvn clean verify # 完成源码打包和javadoc打包，同时完成签名mvn clean deploy # 完成本地部署和maven中央仓库部署 执行过程中会提示你输入创建密钥对时的密码， 如果不想人工参与，也可以使用如下方式（参考：http://maven.apache.org/plugins/maven-gpg-plugin/usage.html） a.在执行命令时指定密码： 1mvn clean deploy -Dgpg.passphrase=thephrase b.setting.xml中创建一个server 12345678910&lt;settings&gt;[...]&lt;servers&gt; [...] &lt;server&gt; &lt;id&gt;gpg.passphrase&lt;/id&gt; &lt;passphrase&gt;clear or encrypted text&lt;/passphrase&gt; &lt;/server&gt;&lt;/servers&gt;&lt;/settings&gt; 5.执行成功后即说明发布到maven中央仓库成功了，过一会就会收到邮件 12345678910111213141516171819202122232425[ https://issues.sonatype.org/browse/OSSRH-62247?page=com.atlassian.jira.plugin.system.issuetabpanels:all-tabpanel ]Central OSSRH 更新了 OSSRH-62247:------------------------------Central sync is activated for com.hanqunfeng. After you successfully release, your component will be published to Central, typically within 10 minutes, though updates to search.maven.org can take up to two hours.&gt; reactive-redis-cache-annotation&gt; -------------------------------&gt;&gt; 关键字: OSSRH-62247&gt; URL: https://issues.sonatype.org/browse/OSSRH-62247&gt; 项目: Community Support - Open Source Project Repository Hosting&gt; 问题类型: New Project&gt; 报告人: hanqunfeng&gt; 经办人: Joel Orlina&gt; 优先级: 重要&gt;&gt; reactive-redis-cache-annotation-spring-boot-starter--这条信息是由Atlassian Jira发送的(v8.5.7#805007) 提示你，大约10分钟后你就可以将依赖添加到项目中进行下载了，不过要通过search.maven.org检索到需要等待两个小时，毕竟更新索引也是需要时间的。 另外，如果你确认发布是成功的，记得要回到工单添加个注释，如 1I&#x27;ve released Releases successfully.Thank you! 6.更新部署修改pom.xml中的版本号，重新执行mvn clean deploy即可。此时不会再收到sonatype发的邮件，依旧等待大约10分钟后你就可以将依赖添加到项目中进行下载了，同样search.maven.org检索到需要等待两个小时。","summary":"摘要 通过本文，你将知道如何将maven构建的项目发布到Maven中央仓库 gradle构建请看发布Jar到Maven中央仓库–gradle","date_published":"2020-11-26T13:30:05.000Z","tags":["技术","maven"]},{"id":"https://blog.hanqunfeng.com/2020/11/22/springboot-webflux-redis-annotation/","url":"https://blog.hanqunfeng.com/2020/11/22/springboot-webflux-redis-annotation/","title":"SpringBoot-WebFlux-Redis缓存注解","content_html":"<h2 id=\"摘要\"><a href=\"#摘要\" class=\"headerlink\" title=\"摘要\"></a>摘要</h2><ul>\n<li>通过本文，你将知道如何在WebFlux项目中通过redis注解缓存方法的返回值;</li>\n<li>本项目基于springboot:2.4.0，jdk1.8，并使用Maven构建;</li>\n<li>代码地址:<a href=\"https://github.com/hanqunfeng/reactive-redis-cache-annotation-spring-boot-starter\">https://github.com/hanqunfeng/reactive-redis-cache-annotation-spring-boot-starter</a></li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>最近在使用WebFlux时发现，SpringBoot提供的@Cacheable，@CachePut，@CacheEvict和@Caching注解不支持响应式方法，SpringBoot官方也没有提供响应式方法的缓存注解，看到网上的一些解决方案都是直接在方法代码中加入缓存数据的代码逻辑，这样虽然可以解决问题，但是代码侵入并不优雅，于是萌生自己写一个基于redis的响应式方法缓存注解的想法，本项目参考SpringBoot提供的@Cacheable，@CachePut，@CacheEvict和@Caching注解声明，但是只是实现了一些基本功能，可以满足绝大部分使用场景的要求，因为SpringBoot早晚会给出官方解决方案，在此之前，不妨一试。</p>\n<h2 id=\"使用示例\"><a href=\"#使用示例\" class=\"headerlink\" title=\"使用示例\"></a>使用示例</h2><ul>\n<li><p>本项目已经发布到maven中央仓库，直接在项目中添加依赖即可。</p>\n</li>\n<li><p>本项目虽然基于springboot:2.4.0构建，但实际上springboot2.0+都可以使用。</p>\n</li>\n<li><p>maven依赖</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>com.hanqunfeng<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>reactive-redis-cache-annotation-spring-boot-starter<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>1.1.0<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li>\n<li><p>gradle依赖</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">implementation <span class=\"string\">&#x27;com.hanqunfeng:reactive-redis-cache-annotation-spring-boot-starter:1.1.0&#x27;</span></span><br></pre></td></tr></table></figure></li>\n<li><p>此时项目中可能还要添加其它依赖，以gradle举例</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//webflux，非必须，主要是面向响应式编程的，所以使用springboot大概率会使用webflux</span></span><br><span class=\"line\">implementation <span class=\"string\">&#x27;org.springframework.boot:spring-boot-starter-webflux&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//Spring Boot Redis 依赖，或者spring-boot-starter-data-redis-reactive，任选其一即可，注意要在配置文件中加入redis的配置</span></span><br><span class=\"line\">implementation <span class=\"string\">&#x27;org.springframework.boot:spring-boot-starter-data-redis&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//redis lettuce连接池依赖，也可以使用jedis连接池，非必须，正式环境建议开启连接池</span></span><br><span class=\"line\">implementation <span class=\"string\">&#x27;org.apache.commons:commons-pool2&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//aop 面向方面编程 支持@Aspect，非必须</span></span><br><span class=\"line\">implementation <span class=\"string\">&#x27;org.springframework.boot:spring-boot-starter-aop&#x27;</span></span><br></pre></td></tr></table></figure></li>\n<li><p>方法返回值必须是Mono或者Flux类型，使用方式与springboot提供的Cacheable等注解类似</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* 缓存 cacheName和key支持EL表达式，实际key的名称是&quot;cacheName_key&quot;</span></span><br><span class=\"line\"><span class=\"comment\">* 缓存结果</span></span><br><span class=\"line\"><span class=\"comment\">* key:sysuser_find_lisi</span></span><br><span class=\"line\"><span class=\"comment\">* value:</span></span><br><span class=\"line\"><span class=\"comment\">* [</span></span><br><span class=\"line\"><span class=\"comment\">* &quot;com.example.model.SysUser&quot;</span></span><br><span class=\"line\"><span class=\"comment\">* &#123;</span></span><br><span class=\"line\"><span class=\"comment\">*    id:&quot;5c74a4e4-c4f2-4570-8735-761d7a570d36&quot;</span></span><br><span class=\"line\"><span class=\"comment\">*    username:&quot;lisi&quot;</span></span><br><span class=\"line\"><span class=\"comment\">*    password:&quot;$2a$10$PXoGXLwg05.5YO.QtZa46ONypBmiK59yfefvO1OGO8kYFwzOB.Os6&quot;</span></span><br><span class=\"line\"><span class=\"comment\">*    enable:true</span></span><br><span class=\"line\"><span class=\"comment\">* &#125;</span></span><br><span class=\"line\"><span class=\"comment\">* ]</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"meta\">@ReactiveRedisCacheable(cacheName = &quot;sysuser&quot;, key = &quot;&#x27;find_&#x27; + #username&quot;)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> Mono&lt;SysUser&gt; <span class=\"title\">findUserByUsername</span><span class=\"params\">(String username)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> sysUserRepository.findByUsername(username);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@ReactiveRedisCacheable(cacheName = &quot;sysuser&quot;, key = &quot;all&quot;)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> Flux&lt;SysUser&gt; <span class=\"title\">findAll</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> sysUserRepository.findAll();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* 删除缓存，allEntries = true 表示删除全部以&quot;cacheName_&quot;开头的缓存</span></span><br><span class=\"line\"><span class=\"comment\">* allEntries 默认false，此时需要指定key的值，表示删除指定的&quot;cacheName_key&quot;</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"meta\">@ReactiveRedisCacheEvict(cacheName = &quot;sysuser&quot;, allEntries = true)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> Mono&lt;SysUser&gt; <span class=\"title\">add</span><span class=\"params\">(SysUser sysUser)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> sysUserRepository.addSysUser(sysUser.getId(), sysUser.getUsername(), sysUser.getPassword(), sysUser.getEnable()).flatMap(data -&gt; sysUserRepository.findById(sysUser.getId()));</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* 组合注解，用法与<span class=\"doctag\">@Caching</span>类似</span></span><br><span class=\"line\"><span class=\"comment\">* 规则：</span></span><br><span class=\"line\"><span class=\"comment\">* 1.cacheables不能与cacheEvicts或者cachePuts同时存在，因为后者一定会执行方法主体，达不到调用缓存的目的，所以当cacheables存在时，后者即便指定也不执行</span></span><br><span class=\"line\"><span class=\"comment\">* 2.先执行cacheEvicts，再执行cachePuts</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"meta\">@ReactiveRedisCaching(</span></span><br><span class=\"line\"><span class=\"meta\">        evict = &#123;@ReactiveRedisCacheEvict(cacheName = &quot;sysuser&quot;, key = &quot;all&quot;)&#125;,</span></span><br><span class=\"line\"><span class=\"meta\">        put = &#123;@ReactiveRedisCachePut(cacheName = &quot;sysuser&quot;, key = &quot;&#x27;find_&#x27; + #sysUser.username&quot;)&#125;</span></span><br><span class=\"line\"><span class=\"meta\">)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> Mono&lt;SysUser&gt; <span class=\"title\">update</span><span class=\"params\">(SysUser sysUser)</span> </span>&#123;</span><br><span class=\"line\">    Mono&lt;SysUser&gt; save = sysUserRepository.save(sysUser);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> save;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* 删除指定的&quot;cacheName_key&quot;</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"meta\">@ReactiveRedisCacheEvict(cacheName = &quot;sysuser&quot;, key=&quot;&#x27;find_&#x27; + #username&quot;)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> Mono&lt;Boolean&gt; <span class=\"title\">deleteByUserName</span><span class=\"params\">(String username)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> sysUserRepository.deleteByUsername(username);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"RedisTemplate\"><a href=\"#RedisTemplate\" class=\"headerlink\" title=\"RedisTemplate\"></a>RedisTemplate</h3></li>\n<li><p>如果使用时没有创建RedisTemplate，本项目中提供了一个默认的RedisTemplate，基于jackson序列化，支持jdk8的LocalDate和LocalDateTime</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Bean</span></span><br><span class=\"line\"><span class=\"meta\">@ConditionalOnMissingBean(value = RedisTemplate.class)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> RedisTemplate&lt;String, Object&gt; <span class=\"title\">redisTemplate</span><span class=\"params\">(RedisConnectionFactory redisConnectionFactory)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    log.debug(<span class=\"string\">&quot;ReactiveRedisConfig RedisTemplate&quot;</span>);</span><br><span class=\"line\">    ObjectMapper objectMapper = <span class=\"keyword\">new</span> ObjectMapper();</span><br><span class=\"line\">    objectMapper.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);</span><br><span class=\"line\">    <span class=\"comment\">//objectMapper.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);</span></span><br><span class=\"line\">    objectMapper.activateDefaultTyping(objectMapper.getPolymorphicTypeValidator(), ObjectMapper.DefaultTyping.NON_FINAL, JsonTypeInfo.As.WRAPPER_ARRAY);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//LocalDateTime系列序列化和反序列化模块，继承自jsr310，我们在这里修改了日期格式</span></span><br><span class=\"line\">    JavaTimeModule javaTimeModule = <span class=\"keyword\">new</span> JavaTimeModule();</span><br><span class=\"line\">    <span class=\"comment\">//序列化</span></span><br><span class=\"line\">    javaTimeModule.addSerializer(LocalDateTime.class, <span class=\"keyword\">new</span> LocalDateTimeSerializer(</span><br><span class=\"line\">            DateTimeFormatter.ofPattern(DEFAULT_DATE_TIME_FORMAT)));</span><br><span class=\"line\">    javaTimeModule.addSerializer(LocalDate.class,</span><br><span class=\"line\">            <span class=\"keyword\">new</span> LocalDateSerializer(DateTimeFormatter.ofPattern(DEFAULT_DATE_FORMAT)));</span><br><span class=\"line\">    javaTimeModule.addSerializer(LocalTime.class,</span><br><span class=\"line\">            <span class=\"keyword\">new</span> LocalTimeSerializer(DateTimeFormatter.ofPattern(DEFAULT_TIME_FORMAT)));</span><br><span class=\"line\">    <span class=\"comment\">//反序列化</span></span><br><span class=\"line\">    javaTimeModule.addDeserializer(LocalDateTime.class, <span class=\"keyword\">new</span> LocalDateTimeDeserializer(</span><br><span class=\"line\">            DateTimeFormatter.ofPattern(DEFAULT_DATE_TIME_FORMAT)));</span><br><span class=\"line\">    javaTimeModule.addDeserializer(LocalDate.class,</span><br><span class=\"line\">            <span class=\"keyword\">new</span> LocalDateDeserializer(DateTimeFormatter.ofPattern(DEFAULT_DATE_FORMAT)));</span><br><span class=\"line\">    javaTimeModule.addDeserializer(LocalTime.class,</span><br><span class=\"line\">            <span class=\"keyword\">new</span> LocalTimeDeserializer(DateTimeFormatter.ofPattern(DEFAULT_TIME_FORMAT)));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//注册模块</span></span><br><span class=\"line\">    objectMapper.registerModule(javaTimeModule);</span><br><span class=\"line\"></span><br><span class=\"line\">    Jackson2JsonRedisSerializer&lt;Object&gt; serializer = <span class=\"keyword\">new</span> Jackson2JsonRedisSerializer&lt;&gt;(Object.class);</span><br><span class=\"line\">    serializer.setObjectMapper(objectMapper);</span><br><span class=\"line\"></span><br><span class=\"line\">    RedisTemplate&lt;String, Object&gt; redisTemplate = <span class=\"keyword\">new</span> RedisTemplate&lt;&gt;();</span><br><span class=\"line\">    redisTemplate.setConnectionFactory(redisConnectionFactory);</span><br><span class=\"line\">    redisTemplate.setKeySerializer(<span class=\"keyword\">new</span> StringRedisSerializer());</span><br><span class=\"line\">    redisTemplate.setValueSerializer(serializer);</span><br><span class=\"line\">    redisTemplate.setHashKeySerializer(<span class=\"keyword\">new</span> StringRedisSerializer());</span><br><span class=\"line\">    redisTemplate.setHashValueSerializer(serializer);</span><br><span class=\"line\">    redisTemplate.afterPropertiesSet();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> redisTemplate;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h1 id=\"以下为源码说明\"><a href=\"#以下为源码说明\" class=\"headerlink\" title=\"以下为源码说明\"></a>以下为源码说明</h1><h2 id=\"源码依赖\"><a href=\"#源码依赖\" class=\"headerlink\" title=\"源码依赖\"></a>源码依赖</h2><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.boot<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-boot-autoconfigure<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.boot<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>jackson-databind<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>com.fasterxml.jackson.datatype<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>jackson-datatype-jdk8<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>com.fasterxml.jackson.datatype<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>jackson-datatype-jsr310<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.aspectj<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>aspectjweaver<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>io.projectreactor<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>reactor-core<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.data<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-data-redis<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.projectlombok<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>lombok<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">optional</span>&gt;</span>true<span class=\"tag\">&lt;/<span class=\"name\">optional</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"自定义Redis缓存相关注解\"><a href=\"#自定义Redis缓存相关注解\" class=\"headerlink\" title=\"自定义Redis缓存相关注解\"></a>自定义Redis缓存相关注解</h2><ul>\n<li>只支持方法返回类型为Mono或者Flux</li>\n<li>其它返回类型时请使用springboot提供的Cacheable，CachePut，CacheEvict和Caching</li>\n<li>使用方式与springboot提供的Cacheable，CachePut，CacheEvict和Caching类似，具体看本文上面的示例</li>\n</ul>\n<h3 id=\"ReactiveRedisCacheable\"><a href=\"#ReactiveRedisCacheable\" class=\"headerlink\" title=\"ReactiveRedisCacheable\"></a>ReactiveRedisCacheable</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.hanqunfeng.reactive.redis.cache.aop;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.lang.annotation.*;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * &lt;h1&gt;redis方法缓存注解&lt;/h1&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> * Created by hanqf on 2020/11/21 18:28.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Target(&#123;ElementType.METHOD&#125;)</span></span><br><span class=\"line\"><span class=\"meta\">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class=\"line\"><span class=\"meta\">@Documented</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"meta\">@interface</span> ReactiveRedisCacheable &#123;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 缓存key，key为cacheName+&quot;_&quot;+key</span></span><br><span class=\"line\"><span class=\"comment\">     * 支持EL表达式</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">    <span class=\"function\">String <span class=\"title\">key</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 缓存key分组，会做为缓存key的前缀+&quot;_&quot;</span></span><br><span class=\"line\"><span class=\"comment\">     * 支持EL表达式</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">    <span class=\"function\">String <span class=\"title\">cacheName</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 缓存过期时间，单位秒，默认24小时</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">long</span> <span class=\"title\">timeout</span><span class=\"params\">()</span> <span class=\"keyword\">default</span> 24 * 3600L</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"ReactiveRedisCacheEvict\"><a href=\"#ReactiveRedisCacheEvict\" class=\"headerlink\" title=\"ReactiveRedisCacheEvict\"></a>ReactiveRedisCacheEvict</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.hanqunfeng.reactive.redis.cache.aop;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.lang.annotation.*;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * &lt;h1&gt;redis清除缓存注解&lt;/h1&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> * Created by hanqf on 2020/11/21 22:26.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Target(&#123;ElementType.METHOD&#125;)</span></span><br><span class=\"line\"><span class=\"meta\">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class=\"line\"><span class=\"meta\">@Documented</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"meta\">@interface</span> ReactiveRedisCacheEvict &#123;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 缓存key，如果cacheName不为空，则key为cacheName+&quot;_&quot;+key</span></span><br><span class=\"line\"><span class=\"comment\">     * 支持EL表达式</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\">String <span class=\"title\">key</span><span class=\"params\">()</span> <span class=\"keyword\">default</span> &quot;&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 缓存key分组，会做为缓存key的前缀+&quot;_&quot;</span></span><br><span class=\"line\"><span class=\"comment\">     * 支持EL表达式</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\">String <span class=\"title\">cacheName</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 是否删除cacheName下全部缓存数据，</span></span><br><span class=\"line\"><span class=\"comment\">     * true时cacheName不能为空，此时即便指定了key值，也会删除cacheName下全部缓存</span></span><br><span class=\"line\"><span class=\"comment\">     * false时key值不能为空</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">allEntries</span><span class=\"params\">()</span> <span class=\"keyword\">default</span> <span class=\"keyword\">false</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 调用清除缓存的时机，true:执行方法前，false:执行方法后</span></span><br><span class=\"line\"><span class=\"comment\">     * 如果是false，则方法执行过程中发生异常，则不会清除缓存</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">beforeInvocation</span><span class=\"params\">()</span> <span class=\"keyword\">default</span> <span class=\"keyword\">false</span></span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"ReactiveRedisCachePut\"><a href=\"#ReactiveRedisCachePut\" class=\"headerlink\" title=\"ReactiveRedisCachePut\"></a>ReactiveRedisCachePut</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.hanqunfeng.reactive.redis.cache.aop;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.lang.annotation.*;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * &lt;h1&gt;执行完方法更新缓存&lt;/h1&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> * Created by hanqf on 2020/11/21 23:15.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Target(&#123;ElementType.METHOD&#125;)</span></span><br><span class=\"line\"><span class=\"meta\">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class=\"line\"><span class=\"meta\">@Documented</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"meta\">@interface</span> ReactiveRedisCachePut &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 缓存key，key为cacheName+&quot;_&quot;+key</span></span><br><span class=\"line\"><span class=\"comment\">     * 支持EL表达式</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\">String <span class=\"title\">key</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 缓存key分组，会做为缓存key的前缀+&quot;_&quot;</span></span><br><span class=\"line\"><span class=\"comment\">     * 支持EL表达式</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\">String <span class=\"title\">cacheName</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 缓存过期时间，单位秒，默认24小时</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">long</span> <span class=\"title\">timeout</span><span class=\"params\">()</span> <span class=\"keyword\">default</span> 24 * 3600L</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"ReactiveRedisCaching\"><a href=\"#ReactiveRedisCaching\" class=\"headerlink\" title=\"ReactiveRedisCaching\"></a>ReactiveRedisCaching</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.hanqunfeng.reactive.redis.cache.aop;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.lang.annotation.*;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * &lt;h1&gt;组合&lt;/h1&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> * Created by hanqf on 2020/11/21 23:24.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Target(&#123;ElementType.METHOD&#125;)</span></span><br><span class=\"line\"><span class=\"meta\">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class=\"line\"><span class=\"meta\">@Documented</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"meta\">@interface</span> ReactiveRedisCaching &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    ReactiveRedisCacheable[] cacheable() <span class=\"keyword\">default</span> &#123;&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    ReactiveRedisCachePut[] put() <span class=\"keyword\">default</span> &#123;&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    ReactiveRedisCacheEvict[] evict() <span class=\"keyword\">default</span> &#123;&#125;;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"AOP–ReactiveRedisCacheAspect\"><a href=\"#AOP–ReactiveRedisCacheAspect\" class=\"headerlink\" title=\"AOP–ReactiveRedisCacheAspect\"></a>AOP–ReactiveRedisCacheAspect</h2><ul>\n<li>支持方法返回类型为Mono或者Flux</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br><span class=\"line\">280</span><br><span class=\"line\">281</span><br><span class=\"line\">282</span><br><span class=\"line\">283</span><br><span class=\"line\">284</span><br><span class=\"line\">285</span><br><span class=\"line\">286</span><br><span class=\"line\">287</span><br><span class=\"line\">288</span><br><span class=\"line\">289</span><br><span class=\"line\">290</span><br><span class=\"line\">291</span><br><span class=\"line\">292</span><br><span class=\"line\">293</span><br><span class=\"line\">294</span><br><span class=\"line\">295</span><br><span class=\"line\">296</span><br><span class=\"line\">297</span><br><span class=\"line\">298</span><br><span class=\"line\">299</span><br><span class=\"line\">300</span><br><span class=\"line\">301</span><br><span class=\"line\">302</span><br><span class=\"line\">303</span><br><span class=\"line\">304</span><br><span class=\"line\">305</span><br><span class=\"line\">306</span><br><span class=\"line\">307</span><br><span class=\"line\">308</span><br><span class=\"line\">309</span><br><span class=\"line\">310</span><br><span class=\"line\">311</span><br><span class=\"line\">312</span><br><span class=\"line\">313</span><br><span class=\"line\">314</span><br><span class=\"line\">315</span><br><span class=\"line\">316</span><br><span class=\"line\">317</span><br><span class=\"line\">318</span><br><span class=\"line\">319</span><br><span class=\"line\">320</span><br><span class=\"line\">321</span><br><span class=\"line\">322</span><br><span class=\"line\">323</span><br><span class=\"line\">324</span><br><span class=\"line\">325</span><br><span class=\"line\">326</span><br><span class=\"line\">327</span><br><span class=\"line\">328</span><br><span class=\"line\">329</span><br><span class=\"line\">330</span><br><span class=\"line\">331</span><br><span class=\"line\">332</span><br><span class=\"line\">333</span><br><span class=\"line\">334</span><br><span class=\"line\">335</span><br><span class=\"line\">336</span><br><span class=\"line\">337</span><br><span class=\"line\">338</span><br><span class=\"line\">339</span><br><span class=\"line\">340</span><br><span class=\"line\">341</span><br><span class=\"line\">342</span><br><span class=\"line\">343</span><br><span class=\"line\">344</span><br><span class=\"line\">345</span><br><span class=\"line\">346</span><br><span class=\"line\">347</span><br><span class=\"line\">348</span><br><span class=\"line\">349</span><br><span class=\"line\">350</span><br><span class=\"line\">351</span><br><span class=\"line\">352</span><br><span class=\"line\">353</span><br><span class=\"line\">354</span><br><span class=\"line\">355</span><br><span class=\"line\">356</span><br><span class=\"line\">357</span><br><span class=\"line\">358</span><br><span class=\"line\">359</span><br><span class=\"line\">360</span><br><span class=\"line\">361</span><br><span class=\"line\">362</span><br><span class=\"line\">363</span><br><span class=\"line\">364</span><br><span class=\"line\">365</span><br><span class=\"line\">366</span><br><span class=\"line\">367</span><br><span class=\"line\">368</span><br><span class=\"line\">369</span><br><span class=\"line\">370</span><br><span class=\"line\">371</span><br><span class=\"line\">372</span><br><span class=\"line\">373</span><br><span class=\"line\">374</span><br><span class=\"line\">375</span><br><span class=\"line\">376</span><br><span class=\"line\">377</span><br><span class=\"line\">378</span><br><span class=\"line\">379</span><br><span class=\"line\">380</span><br><span class=\"line\">381</span><br><span class=\"line\">382</span><br><span class=\"line\">383</span><br><span class=\"line\">384</span><br><span class=\"line\">385</span><br><span class=\"line\">386</span><br><span class=\"line\">387</span><br><span class=\"line\">388</span><br><span class=\"line\">389</span><br><span class=\"line\">390</span><br><span class=\"line\">391</span><br><span class=\"line\">392</span><br><span class=\"line\">393</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.hanqunfeng.reactive.redis.cache.aop;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.aspectj.lang.ProceedingJoinPoint;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.aspectj.lang.annotation.Around;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.aspectj.lang.annotation.Pointcut;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.aspectj.lang.reflect.MethodSignature;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.stereotype.Component;</span><br><span class=\"line\"><span class=\"keyword\">import</span> reactor.core.publisher.Flux;</span><br><span class=\"line\"><span class=\"keyword\">import</span> reactor.core.publisher.Mono;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.lang.reflect.Method;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.*;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.concurrent.TimeUnit;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.concurrent.atomic.AtomicBoolean;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * &lt;h1&gt;redis缓存aop&lt;/h1&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> * Created by hanqf on 2020/11/21 16:16.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Component</span></span><br><span class=\"line\"><span class=\"comment\">//标识是一个Aspect代理类</span></span><br><span class=\"line\"><span class=\"meta\">@Aspect</span></span><br><span class=\"line\"><span class=\"comment\">//如果有多个切面拦截相同的切点，可以用@Order指定执行顺序</span></span><br><span class=\"line\"><span class=\"comment\">//@Order(1)</span></span><br><span class=\"line\"><span class=\"meta\">@Slf4j</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ReactiveRedisCacheAspect</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> RedisTemplate redisTemplate;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Pointcut(&quot;@annotation(com.hanqunfeng.reactive.redis.cache.aop.ReactiveRedisCacheable)&quot;)</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">cacheablePointCut</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Pointcut(&quot;@annotation(com.hanqunfeng.reactive.redis.cache.aop.ReactiveRedisCacheEvict)&quot;)</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">cacheEvictPointCut</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Pointcut(&quot;@annotation(com.hanqunfeng.reactive.redis.cache.aop.ReactiveRedisCachePut)&quot;)</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">cachePutPointCut</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Pointcut(&quot;@annotation(com.hanqunfeng.reactive.redis.cache.aop.ReactiveRedisCaching)&quot;)</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">cachingPointCut</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//环绕通知,一般不建议使用，可以通过@Before和@AfterReturning实现</span></span><br><span class=\"line\">    <span class=\"comment\">//但是响应式方法只能通过环绕通知实现aop，因为其它通知会导致不再同一个线程执行</span></span><br><span class=\"line\">    <span class=\"meta\">@Around(&quot;cacheablePointCut()&quot;)</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">cacheableAround</span><span class=\"params\">(ProceedingJoinPoint proceedingJoinPoint)</span> <span class=\"keyword\">throws</span> Throwable </span>&#123;</span><br><span class=\"line\">        log.debug(<span class=\"string\">&quot;ReactiveRedisCacheAspect cacheableAround....&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        MethodSignature methodSignature = (MethodSignature) proceedingJoinPoint.getSignature();</span><br><span class=\"line\">        Method method = methodSignature.getMethod();</span><br><span class=\"line\">        String returnTypeName = method.getReturnType().getSimpleName();</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">        ReactiveRedisCacheable annotation = method.getAnnotation(ReactiveRedisCacheable.class);</span><br><span class=\"line\">        String cacheName = annotation.cacheName();</span><br><span class=\"line\">        String key = annotation.key();</span><br><span class=\"line\">        <span class=\"keyword\">long</span> timeout = annotation.timeout();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//转换EL表达式</span></span><br><span class=\"line\">        cacheName = (String) AspectSupportUtils.getKeyValue(proceedingJoinPoint, cacheName);</span><br><span class=\"line\">        key = (String) AspectSupportUtils.getKeyValue(proceedingJoinPoint, key);</span><br><span class=\"line\"></span><br><span class=\"line\">        String redis_key = cacheName + <span class=\"string\">&quot;_&quot;</span> + key;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">boolean</span> hasKey = redisTemplate.hasKey(redis_key);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (hasKey) &#123;</span><br><span class=\"line\">            Object o = redisTemplate.opsForValue().get(redis_key);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (returnTypeName.equals(<span class=\"string\">&quot;Flux&quot;</span>)) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> Flux.fromIterable((List) o);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (returnTypeName.equals(<span class=\"string\">&quot;Mono&quot;</span>)) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> Mono.just(o);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> o;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">//实际执行的方法</span></span><br><span class=\"line\">            Object proceed = proceedingJoinPoint.proceed();</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (returnTypeName.equals(<span class=\"string\">&quot;Flux&quot;</span>)) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> ((Flux) proceed).collectList().doOnNext(list -&gt; redisTemplate.opsForValue().set(redis_key, list, timeout, TimeUnit.SECONDS)).flatMapMany(list -&gt; Flux.fromIterable((List) list));</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (returnTypeName.equals(<span class=\"string\">&quot;Mono&quot;</span>)) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> ((Mono) proceed).doOnNext(obj -&gt; redisTemplate.opsForValue().set(redis_key, obj, timeout, TimeUnit.SECONDS));</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> proceed;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Around(&quot;cacheEvictPointCut()&quot;)</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">cacheEvictAround</span><span class=\"params\">(ProceedingJoinPoint proceedingJoinPoint)</span> <span class=\"keyword\">throws</span> Throwable </span>&#123;</span><br><span class=\"line\">        log.debug(<span class=\"string\">&quot;ReactiveRedisCacheAspect cacheEvictAround....&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        MethodSignature methodSignature = (MethodSignature) proceedingJoinPoint.getSignature();</span><br><span class=\"line\">        Method method = methodSignature.getMethod();</span><br><span class=\"line\">        String returnTypeName = method.getReturnType().getSimpleName();</span><br><span class=\"line\"></span><br><span class=\"line\">        ReactiveRedisCacheEvict annotation = method.getAnnotation(ReactiveRedisCacheEvict.class);</span><br><span class=\"line\">        String cacheName = annotation.cacheName();</span><br><span class=\"line\">        String key = annotation.key();</span><br><span class=\"line\">        <span class=\"keyword\">boolean</span> allEntries = annotation.allEntries();</span><br><span class=\"line\">        <span class=\"keyword\">boolean</span> beforeInvocation = annotation.beforeInvocation();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//转换EL表达式</span></span><br><span class=\"line\">        cacheName = (String) AspectSupportUtils.getKeyValue(proceedingJoinPoint, cacheName);</span><br><span class=\"line\">        key = (String) AspectSupportUtils.getKeyValue(proceedingJoinPoint, key);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//执行方法前清除缓存</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (beforeInvocation) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//清除全部缓存</span></span><br><span class=\"line\">            deleteRedisCache(cacheName, key, allEntries);</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//实际执行的方法</span></span><br><span class=\"line\">            Object proceed = proceedingJoinPoint.proceed();</span><br><span class=\"line\">            <span class=\"keyword\">return</span> proceed;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;<span class=\"comment\">//成功执行方法后清除缓存</span></span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//实际执行的方法</span></span><br><span class=\"line\">            Object proceed = proceedingJoinPoint.proceed();</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">final</span> String cacheNameTemp = cacheName;</span><br><span class=\"line\">            <span class=\"keyword\">final</span> String keyTemp = key;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (returnTypeName.equals(<span class=\"string\">&quot;Flux&quot;</span>)) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> ((Flux) proceed).collectList().doOnNext(list -&gt; &#123;</span><br><span class=\"line\">                    <span class=\"comment\">//清除全部缓存</span></span><br><span class=\"line\">                    deleteRedisCache(cacheNameTemp, keyTemp, allEntries);</span><br><span class=\"line\">                &#125;).flatMapMany(list -&gt; Flux.fromIterable((List) list));</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (returnTypeName.equals(<span class=\"string\">&quot;Mono&quot;</span>)) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> ((Mono) proceed).doOnNext(obj -&gt; &#123;</span><br><span class=\"line\">                    <span class=\"comment\">//清除全部缓存</span></span><br><span class=\"line\">                    deleteRedisCache(cacheNameTemp, keyTemp, allEntries);</span><br><span class=\"line\">                &#125;);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> proceed;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Around(&quot;cachePutPointCut()&quot;)</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">cachePutAround</span><span class=\"params\">(ProceedingJoinPoint proceedingJoinPoint)</span> <span class=\"keyword\">throws</span> Throwable </span>&#123;</span><br><span class=\"line\">        log.debug(<span class=\"string\">&quot;ReactiveRedisCacheAspect cachePutAround....&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        MethodSignature methodSignature = (MethodSignature) proceedingJoinPoint.getSignature();</span><br><span class=\"line\">        Method method = methodSignature.getMethod();</span><br><span class=\"line\">        String returnTypeName = method.getReturnType().getSimpleName();</span><br><span class=\"line\"></span><br><span class=\"line\">        ReactiveRedisCachePut annotation = method.getAnnotation(ReactiveRedisCachePut.class);</span><br><span class=\"line\">        String cacheName = annotation.cacheName();</span><br><span class=\"line\">        String key = annotation.key();</span><br><span class=\"line\">        <span class=\"keyword\">long</span> timeout = annotation.timeout();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//转换EL表达式</span></span><br><span class=\"line\">        cacheName = (String) AspectSupportUtils.getKeyValue(proceedingJoinPoint, cacheName);</span><br><span class=\"line\">        key = (String) AspectSupportUtils.getKeyValue(proceedingJoinPoint, key);</span><br><span class=\"line\"></span><br><span class=\"line\">        String redis_key = cacheName + <span class=\"string\">&quot;_&quot;</span> + key;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">boolean</span> hasKey = redisTemplate.hasKey(redis_key);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (hasKey) &#123;</span><br><span class=\"line\">            redisTemplate.delete(redis_key);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//实际执行的方法</span></span><br><span class=\"line\">        Object proceed = proceedingJoinPoint.proceed();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (returnTypeName.equals(<span class=\"string\">&quot;Flux&quot;</span>)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> ((Flux) proceed).collectList().doOnNext(list -&gt; redisTemplate.opsForValue().set(redis_key, list, timeout, TimeUnit.SECONDS)).flatMapMany(list -&gt; Flux.fromIterable((List) list));</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (returnTypeName.equals(<span class=\"string\">&quot;Mono&quot;</span>)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> ((Mono) proceed).doOnNext(obj -&gt; redisTemplate.opsForValue().set(redis_key, obj, timeout, TimeUnit.SECONDS));</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> proceed;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Around(&quot;cachingPointCut()&quot;)</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">cachingAround</span><span class=\"params\">(ProceedingJoinPoint proceedingJoinPoint)</span> <span class=\"keyword\">throws</span> Throwable </span>&#123;</span><br><span class=\"line\">        log.debug(<span class=\"string\">&quot;ReactiveRedisCacheAspect cachingAround....&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        MethodSignature methodSignature = (MethodSignature) proceedingJoinPoint.getSignature();</span><br><span class=\"line\">        Method method = methodSignature.getMethod();</span><br><span class=\"line\">        String returnTypeName = method.getReturnType().getSimpleName();</span><br><span class=\"line\"></span><br><span class=\"line\">        ReactiveRedisCaching annotation = method.getAnnotation(ReactiveRedisCaching.class);</span><br><span class=\"line\"></span><br><span class=\"line\">        ReactiveRedisCacheEvict[] cacheEvicts = annotation.evict();</span><br><span class=\"line\">        ReactiveRedisCachePut[] cachePuts = annotation.put();</span><br><span class=\"line\">        ReactiveRedisCacheable[] cacheables = annotation.cacheable();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//规则：</span></span><br><span class=\"line\">        <span class=\"comment\">//1.cacheables不能与cacheEvicts或者cachePuts同时存在，因为后者一定会执行方法主体，达不到调用缓存的目的，所以当cacheables存在时，后者即便指定也不执行</span></span><br><span class=\"line\">        <span class=\"comment\">//2.先执行cacheEvicts，再执行cachePuts</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (cacheables.length &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            Map&lt;String, Long&gt; key_map = <span class=\"keyword\">new</span> HashMap&lt;&gt;();</span><br><span class=\"line\">            List&lt;String&gt; key_list = <span class=\"keyword\">new</span> ArrayList&lt;&gt;();</span><br><span class=\"line\">            Arrays.stream(cacheables).forEach(cacheable -&gt; &#123;</span><br><span class=\"line\">                String cacheName = cacheable.cacheName();</span><br><span class=\"line\">                String key = cacheable.key();</span><br><span class=\"line\">                <span class=\"keyword\">long</span> timeout = cacheable.timeout();</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"comment\">//转换EL表达式</span></span><br><span class=\"line\">                cacheName = (String) AspectSupportUtils.getKeyValue(proceedingJoinPoint, cacheName);</span><br><span class=\"line\">                key = (String) AspectSupportUtils.getKeyValue(proceedingJoinPoint, key);</span><br><span class=\"line\"></span><br><span class=\"line\">                String redis_key = cacheName + <span class=\"string\">&quot;_&quot;</span> + key;</span><br><span class=\"line\"></span><br><span class=\"line\">                key_map.put(redis_key, timeout);</span><br><span class=\"line\">                key_list.add(redis_key);</span><br><span class=\"line\">            &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">            AtomicBoolean isAllKeyHas = <span class=\"keyword\">new</span> AtomicBoolean(<span class=\"keyword\">true</span>);</span><br><span class=\"line\">            key_list.forEach(key -&gt; &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (!redisTemplate.hasKey(key)) &#123;</span><br><span class=\"line\">                    isAllKeyHas.set(<span class=\"keyword\">false</span>);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//全部key都有值，则直接返回缓存</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (isAllKeyHas.get()) &#123;</span><br><span class=\"line\">                Object o = redisTemplate.opsForValue().get(key_list.get(<span class=\"number\">0</span>));</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (returnTypeName.equals(<span class=\"string\">&quot;Flux&quot;</span>)) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">return</span> Flux.fromIterable((List) o);</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (returnTypeName.equals(<span class=\"string\">&quot;Mono&quot;</span>)) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">return</span> Mono.just(o);</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">return</span> o;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                <span class=\"comment\">//实际执行的方法</span></span><br><span class=\"line\">                Object proceed = proceedingJoinPoint.proceed();</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (returnTypeName.equals(<span class=\"string\">&quot;Flux&quot;</span>)) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">return</span> ((Flux) proceed).collectList()</span><br><span class=\"line\">                            .doOnNext(list -&gt; key_map.forEach((key, val) -&gt; redisTemplate.opsForValue().set(key, list, val, TimeUnit.SECONDS)))</span><br><span class=\"line\">                            .flatMapMany(list -&gt; Flux.fromIterable((List) list));</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (returnTypeName.equals(<span class=\"string\">&quot;Mono&quot;</span>)) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">return</span> ((Mono) proceed)</span><br><span class=\"line\">                            .doOnNext(obj -&gt; key_map.forEach((key, val) -&gt; redisTemplate.opsForValue().set(key, obj, val, TimeUnit.SECONDS)));</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">return</span> proceed;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">            Map&lt;String, Boolean&gt; map = <span class=\"keyword\">new</span> HashMap&lt;&gt;();</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (cacheEvicts.length &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                Arrays.stream(cacheEvicts).forEach(cacheEvict -&gt; &#123;</span><br><span class=\"line\">                    String cacheName = cacheEvict.cacheName();</span><br><span class=\"line\">                    String key = cacheEvict.key();</span><br><span class=\"line\">                    <span class=\"keyword\">boolean</span> allEntries = cacheEvict.allEntries();</span><br><span class=\"line\">                    <span class=\"keyword\">boolean</span> beforeInvocation = cacheEvict.beforeInvocation();</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"comment\">//转换EL表达式</span></span><br><span class=\"line\">                    cacheName = (String) AspectSupportUtils.getKeyValue(proceedingJoinPoint, cacheName);</span><br><span class=\"line\">                    key = (String) AspectSupportUtils.getKeyValue(proceedingJoinPoint, key);</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (beforeInvocation) &#123; <span class=\"comment\">//执行方法前清除缓存</span></span><br><span class=\"line\">                        <span class=\"comment\">//清除全部缓存</span></span><br><span class=\"line\">                        deleteRedisCache(cacheName, key, allEntries);</span><br><span class=\"line\">                    &#125; <span class=\"keyword\">else</span> &#123; <span class=\"comment\">//成功执行方法后清除缓存，先保存到map中</span></span><br><span class=\"line\">                        <span class=\"comment\">//清除全部缓存</span></span><br><span class=\"line\">                        <span class=\"keyword\">if</span> (allEntries) &#123;</span><br><span class=\"line\">                            map.put(cacheName, <span class=\"keyword\">true</span>);</span><br><span class=\"line\">                        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                            map.put(cacheName + <span class=\"string\">&quot;_&quot;</span> + key, <span class=\"keyword\">false</span>);</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//实际执行的方法</span></span><br><span class=\"line\">            Object proceed = proceedingJoinPoint.proceed();</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (cachePuts.length &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                Map&lt;String, Long&gt; key_map = <span class=\"keyword\">new</span> HashMap&lt;&gt;();</span><br><span class=\"line\">                Arrays.stream(cachePuts).forEach(cachePut -&gt; &#123;</span><br><span class=\"line\">                    String cacheName = cachePut.cacheName();</span><br><span class=\"line\">                    String key = cachePut.key();</span><br><span class=\"line\">                    <span class=\"keyword\">long</span> timeout = cachePut.timeout();</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"comment\">//转换EL表达式</span></span><br><span class=\"line\">                    cacheName = (String) AspectSupportUtils.getKeyValue(proceedingJoinPoint, cacheName);</span><br><span class=\"line\">                    key = (String) AspectSupportUtils.getKeyValue(proceedingJoinPoint, key);</span><br><span class=\"line\"></span><br><span class=\"line\">                    String redis_key = cacheName + <span class=\"string\">&quot;_&quot;</span> + key;</span><br><span class=\"line\"></span><br><span class=\"line\">                    key_map.put(redis_key, timeout);</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"keyword\">boolean</span> hasKey = redisTemplate.hasKey(redis_key);</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (hasKey) &#123;</span><br><span class=\"line\">                        redisTemplate.delete(redis_key);</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (returnTypeName.equals(<span class=\"string\">&quot;Flux&quot;</span>)) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">return</span> ((Flux) proceed).collectList()</span><br><span class=\"line\">                            .doOnNext(list -&gt; &#123;</span><br><span class=\"line\">                                <span class=\"comment\">//执行方法后清除缓存</span></span><br><span class=\"line\">                                <span class=\"keyword\">if</span> (map.size() &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                                    map.forEach((key, val) -&gt; &#123;</span><br><span class=\"line\">                                        deleteRedisCache(key, val);</span><br><span class=\"line\">                                    &#125;);</span><br><span class=\"line\">                                &#125;</span><br><span class=\"line\">                                key_map.forEach((key, val) -&gt; redisTemplate.opsForValue().set(key, list, val, TimeUnit.SECONDS));</span><br><span class=\"line\">                            &#125;)</span><br><span class=\"line\">                            .flatMapMany(list -&gt; Flux.fromIterable((List) list));</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (returnTypeName.equals(<span class=\"string\">&quot;Mono&quot;</span>)) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">return</span> ((Mono) proceed)</span><br><span class=\"line\">                            .doOnNext(obj -&gt; &#123;</span><br><span class=\"line\">                                <span class=\"comment\">//执行方法后清除缓存</span></span><br><span class=\"line\">                                <span class=\"keyword\">if</span> (map.size() &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                                    map.forEach((key, val) -&gt; &#123;</span><br><span class=\"line\">                                        deleteRedisCache(key, val);</span><br><span class=\"line\">                                    &#125;);</span><br><span class=\"line\">                                &#125;</span><br><span class=\"line\">                                key_map.forEach((key, val) -&gt; redisTemplate.opsForValue().set(key, obj, val, TimeUnit.SECONDS));</span><br><span class=\"line\">                            &#125;);</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">return</span> proceed;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (returnTypeName.equals(<span class=\"string\">&quot;Flux&quot;</span>)) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">return</span> ((Flux) proceed).collectList().doOnNext(list -&gt; &#123;</span><br><span class=\"line\">                        <span class=\"comment\">//执行方法后清除缓存</span></span><br><span class=\"line\">                        <span class=\"keyword\">if</span> (map.size() &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                            map.forEach((key, val) -&gt; &#123;</span><br><span class=\"line\">                                deleteRedisCache(key, val);</span><br><span class=\"line\">                            &#125;);</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125;).flatMapMany(list -&gt; Flux.fromIterable((List) list));</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (returnTypeName.equals(<span class=\"string\">&quot;Mono&quot;</span>)) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">return</span> ((Mono) proceed).doOnNext(obj -&gt; &#123;</span><br><span class=\"line\">                        <span class=\"comment\">//执行方法后清除缓存</span></span><br><span class=\"line\">                        <span class=\"keyword\">if</span> (map.size() &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                            map.forEach((key, val) -&gt; &#123;</span><br><span class=\"line\">                                deleteRedisCache(key, val);</span><br><span class=\"line\">                            &#125;);</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125;);</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">return</span> proceed;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">deleteRedisCache</span><span class=\"params\">(String key, <span class=\"keyword\">boolean</span> clearAll)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (clearAll) &#123;</span><br><span class=\"line\">            Set keys = redisTemplate.keys(key + <span class=\"string\">&quot;_*&quot;</span>);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!keys.isEmpty()) &#123;</span><br><span class=\"line\">                redisTemplate.delete(keys);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (redisTemplate.hasKey(key)) &#123;</span><br><span class=\"line\">                redisTemplate.delete(key);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">deleteRedisCache</span><span class=\"params\">(String cacheName, String key, <span class=\"keyword\">boolean</span> clearAll)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        String redis_key = <span class=\"string\">&quot;&quot;</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (clearAll) &#123;</span><br><span class=\"line\">            redis_key = cacheName + <span class=\"string\">&quot;_*&quot;</span>;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            redis_key = cacheName + <span class=\"string\">&quot;_&quot;</span> + key;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        deleteRedisCache(redis_key, clearAll);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"注解属性支持EL表达式的工具类\"><a href=\"#注解属性支持EL表达式的工具类\" class=\"headerlink\" title=\"注解属性支持EL表达式的工具类\"></a>注解属性支持EL表达式的工具类</h2><h3 id=\"AspectSupportUtils\"><a href=\"#AspectSupportUtils\" class=\"headerlink\" title=\"AspectSupportUtils\"></a>AspectSupportUtils</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.hanqunfeng.reactive.redis.cache.aop;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> org.aspectj.lang.JoinPoint;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.aspectj.lang.reflect.MethodSignature;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.cache.interceptor.SimpleKeyGenerator;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.expression.AnnotatedElementKey;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.expression.EvaluationContext;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.util.StringUtils;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.lang.reflect.Method;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">AspectSupportUtils</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> ExpressionEvaluator evaluator = <span class=\"keyword\">new</span> ExpressionEvaluator();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> Object <span class=\"title\">getKeyValue</span><span class=\"params\">(JoinPoint joinPoint, String keyExpression)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(keyExpression.contains(<span class=\"string\">&quot;#&quot;</span>) || keyExpression.contains(<span class=\"string\">&quot;&#x27;&quot;</span>)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> getKeyValue(joinPoint.getTarget(), joinPoint.getArgs(), joinPoint.getTarget().getClass(),</span><br><span class=\"line\">                    ((MethodSignature) joinPoint.getSignature()).getMethod(), keyExpression);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> keyExpression;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> Object <span class=\"title\">getKeyValue</span><span class=\"params\">(Object object, Object[] args, Class&lt;?&gt; clazz, Method method,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">                                      String keyExpression)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (StringUtils.hasText(keyExpression)) &#123;</span><br><span class=\"line\">            EvaluationContext evaluationContext = evaluator.createEvaluationContext(object, clazz, method, args);</span><br><span class=\"line\">            AnnotatedElementKey methodKey = <span class=\"keyword\">new</span> AnnotatedElementKey(method, clazz);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> evaluator.key(keyExpression, methodKey, evaluationContext);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> SimpleKeyGenerator.generateKey(args);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"ExpressionEvaluator\"><a href=\"#ExpressionEvaluator\" class=\"headerlink\" title=\"ExpressionEvaluator\"></a>ExpressionEvaluator</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.hanqunfeng.reactive.redis.cache.aop;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.aop.support.AopUtils;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.expression.AnnotatedElementKey;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.expression.CachedExpressionEvaluator;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.expression.MethodBasedEvaluationContext;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.core.DefaultParameterNameDiscoverer;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.core.ParameterNameDiscoverer;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.expression.EvaluationContext;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.expression.Expression;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.lang.reflect.Method;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Map;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.concurrent.ConcurrentHashMap;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ExpressionEvaluator</span> <span class=\"keyword\">extends</span> <span class=\"title\">CachedExpressionEvaluator</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> ParameterNameDiscoverer paramNameDiscoverer = <span class=\"keyword\">new</span> DefaultParameterNameDiscoverer();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Map&lt;ExpressionKey, Expression&gt; conditionCache = <span class=\"keyword\">new</span> ConcurrentHashMap&lt;&gt;(<span class=\"number\">64</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Map&lt;AnnotatedElementKey, Method&gt; targetMethodCache = <span class=\"keyword\">new</span> ConcurrentHashMap&lt;&gt;(<span class=\"number\">64</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> EvaluationContext <span class=\"title\">createEvaluationContext</span><span class=\"params\">(Object object, Class&lt;?&gt; targetClass, Method method,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">                                                     Object[] args)</span> </span>&#123;</span><br><span class=\"line\">        Method targetMethod = getTargetMethod(targetClass, method);</span><br><span class=\"line\">        ExpressionRootObject root = <span class=\"keyword\">new</span> ExpressionRootObject(object, args);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> MethodBasedEvaluationContext(root, targetMethod, args, <span class=\"keyword\">this</span>.paramNameDiscoverer);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">key</span><span class=\"params\">(String conditionExpression, AnnotatedElementKey elementKey, EvaluationContext evalContext)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> getExpression(<span class=\"keyword\">this</span>.conditionCache, elementKey, conditionExpression).getValue(evalContext);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> Method <span class=\"title\">getTargetMethod</span><span class=\"params\">(Class&lt;?&gt; targetClass, Method method)</span> </span>&#123;</span><br><span class=\"line\">        AnnotatedElementKey methodKey = <span class=\"keyword\">new</span> AnnotatedElementKey(method, targetClass);</span><br><span class=\"line\">        Method targetMethod = <span class=\"keyword\">this</span>.targetMethodCache.get(methodKey);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (targetMethod == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            targetMethod = AopUtils.getMostSpecificMethod(method, targetClass);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (targetMethod == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                targetMethod = method;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.targetMethodCache.put(methodKey, targetMethod);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> targetMethod;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ExpressionRootObject</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Object object;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Object[] args;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ExpressionRootObject</span><span class=\"params\">(Object object, Object[] args)</span> </span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.object = object;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.args = args;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">getobject</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> object;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">public</span> Object[] getArgs() &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> args;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"本项目提供了自动配置类，开启Aspect支持同时提供RedisTemplate\"><a href=\"#本项目提供了自动配置类，开启Aspect支持同时提供RedisTemplate\" class=\"headerlink\" title=\"本项目提供了自动配置类，开启Aspect支持同时提供RedisTemplate\"></a>本项目提供了自动配置类，开启Aspect支持同时提供RedisTemplate</h2><ul>\n<li>支持LocalDate和LocalDateTime的序列化和反序列化</li>\n<li>存储key为字符串，值为json<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.hanqunfeng.reactive.redis.cache.config;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.fasterxml.jackson.annotation.JsonAutoDetect;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.fasterxml.jackson.annotation.JsonTypeInfo;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.fasterxml.jackson.annotation.PropertyAccessor;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.fasterxml.jackson.datatype.jsr310.JavaTimeModule;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.fasterxml.jackson.datatype.jsr310.deser.LocalDateDeserializer;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.fasterxml.jackson.datatype.jsr310.deser.LocalDateTimeDeserializer;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.fasterxml.jackson.datatype.jsr310.deser.LocalTimeDeserializer;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.fasterxml.jackson.datatype.jsr310.ser.LocalDateSerializer;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.fasterxml.jackson.datatype.jsr310.ser.LocalDateTimeSerializer;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.fasterxml.jackson.datatype.jsr310.ser.LocalTimeSerializer;</span><br><span class=\"line\"><span class=\"keyword\">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Bean;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.ComponentScan;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Configuration;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.EnableAspectJAutoProxy;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.data.redis.connection.RedisConnectionFactory;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.data.redis.serializer.Jackson2JsonRedisSerializer;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.data.redis.serializer.StringRedisSerializer;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.time.LocalDate;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.time.LocalDateTime;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.time.LocalTime;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.time.format.DateTimeFormatter;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@author</span> hanqf</span></span><br><span class=\"line\"><span class=\"comment\"> * Created by hanqf on 2020/11/22 15:38</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"meta\">@Configuration</span></span><br><span class=\"line\"><span class=\"meta\">@ComponentScan(basePackages = &quot;org.hanqf.reactive.redis.cache&quot;)</span></span><br><span class=\"line\"><span class=\"meta\">@EnableAspectJAutoProxy</span></span><br><span class=\"line\"><span class=\"meta\">@Slf4j</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ReactiveRedisConfig</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 默认日期时间格式</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String DEFAULT_DATE_TIME_FORMAT = <span class=\"string\">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 默认日期格式</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String DEFAULT_DATE_FORMAT = <span class=\"string\">&quot;yyyy-MM-dd&quot;</span>;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 默认时间格式</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String DEFAULT_TIME_FORMAT = <span class=\"string\">&quot;HH:mm:ss&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Bean</span></span><br><span class=\"line\">    <span class=\"meta\">@ConditionalOnMissingBean(value = RedisTemplate.class)</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> RedisTemplate&lt;String, Object&gt; <span class=\"title\">redisTemplate</span><span class=\"params\">(RedisConnectionFactory redisConnectionFactory)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        log.debug(<span class=\"string\">&quot;ReactiveRedisConfig RedisTemplate&quot;</span>);</span><br><span class=\"line\">        ObjectMapper objectMapper = <span class=\"keyword\">new</span> ObjectMapper();</span><br><span class=\"line\">        objectMapper.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);</span><br><span class=\"line\">        <span class=\"comment\">//objectMapper.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);</span></span><br><span class=\"line\">        objectMapper.activateDefaultTyping(objectMapper.getPolymorphicTypeValidator(), ObjectMapper.DefaultTyping.NON_FINAL, JsonTypeInfo.As.WRAPPER_ARRAY);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//LocalDateTime系列序列化和反序列化模块，继承自jsr310，我们在这里修改了日期格式</span></span><br><span class=\"line\">        JavaTimeModule javaTimeModule = <span class=\"keyword\">new</span> JavaTimeModule();</span><br><span class=\"line\">        <span class=\"comment\">//序列化</span></span><br><span class=\"line\">        javaTimeModule.addSerializer(LocalDateTime.class, <span class=\"keyword\">new</span> LocalDateTimeSerializer(</span><br><span class=\"line\">                DateTimeFormatter.ofPattern(DEFAULT_DATE_TIME_FORMAT)));</span><br><span class=\"line\">        javaTimeModule.addSerializer(LocalDate.class,</span><br><span class=\"line\">                <span class=\"keyword\">new</span> LocalDateSerializer(DateTimeFormatter.ofPattern(DEFAULT_DATE_FORMAT)));</span><br><span class=\"line\">        javaTimeModule.addSerializer(LocalTime.class,</span><br><span class=\"line\">                <span class=\"keyword\">new</span> LocalTimeSerializer(DateTimeFormatter.ofPattern(DEFAULT_TIME_FORMAT)));</span><br><span class=\"line\">        <span class=\"comment\">//反序列化</span></span><br><span class=\"line\">        javaTimeModule.addDeserializer(LocalDateTime.class, <span class=\"keyword\">new</span> LocalDateTimeDeserializer(</span><br><span class=\"line\">                DateTimeFormatter.ofPattern(DEFAULT_DATE_TIME_FORMAT)));</span><br><span class=\"line\">        javaTimeModule.addDeserializer(LocalDate.class,</span><br><span class=\"line\">                <span class=\"keyword\">new</span> LocalDateDeserializer(DateTimeFormatter.ofPattern(DEFAULT_DATE_FORMAT)));</span><br><span class=\"line\">        javaTimeModule.addDeserializer(LocalTime.class,</span><br><span class=\"line\">                <span class=\"keyword\">new</span> LocalTimeDeserializer(DateTimeFormatter.ofPattern(DEFAULT_TIME_FORMAT)));</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//注册模块</span></span><br><span class=\"line\">        objectMapper.registerModule(javaTimeModule);</span><br><span class=\"line\"></span><br><span class=\"line\">        Jackson2JsonRedisSerializer&lt;Object&gt; serializer = <span class=\"keyword\">new</span> Jackson2JsonRedisSerializer&lt;&gt;(Object.class);</span><br><span class=\"line\">        serializer.setObjectMapper(objectMapper);</span><br><span class=\"line\"></span><br><span class=\"line\">        RedisTemplate&lt;String, Object&gt; redisTemplate = <span class=\"keyword\">new</span> RedisTemplate&lt;&gt;();</span><br><span class=\"line\">        redisTemplate.setConnectionFactory(redisConnectionFactory);</span><br><span class=\"line\">        redisTemplate.setKeySerializer(<span class=\"keyword\">new</span> StringRedisSerializer());</span><br><span class=\"line\">        redisTemplate.setValueSerializer(serializer);</span><br><span class=\"line\">        redisTemplate.setHashKeySerializer(<span class=\"keyword\">new</span> StringRedisSerializer());</span><br><span class=\"line\">        redisTemplate.setHashValueSerializer(serializer);</span><br><span class=\"line\">        redisTemplate.afterPropertiesSet();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> redisTemplate;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n</ul>\n","content_text":"摘要 通过本文，你将知道如何在WebFlux项目中通过redis注解缓存方法的返回值; 本项目基于springboot:2.4.0，jdk1.8，并使用Maven构建; 代码地址:https://github.com/hanqunfeng/reactive-redis-cache-annotation-spring-boot-starter 前言最近在使用WebFlux时发现，SpringBoot提供的@Cacheable，@CachePut，@CacheEvict和@Caching注解不支持响应式方法，SpringBoot官方也没有提供响应式方法的缓存注解，看到网上的一些解决方案都是直接在方法代码中加入缓存数据的代码逻辑，这样虽然可以解决问题，但是代码侵入并不优雅，于是萌生自己写一个基于redis的响应式方法缓存注解的想法，本项目参考SpringBoot提供的@Cacheable，@CachePut，@CacheEvict和@Caching注解声明，但是只是实现了一些基本功能，可以满足绝大部分使用场景的要求，因为SpringBoot早晚会给出官方解决方案，在此之前，不妨一试。 使用示例 本项目已经发布到maven中央仓库，直接在项目中添加依赖即可。 本项目虽然基于springboot:2.4.0构建，但实际上springboot2.0+都可以使用。 maven依赖 12345&lt;dependency&gt; &lt;groupId&gt;com.hanqunfeng&lt;/groupId&gt; &lt;artifactId&gt;reactive-redis-cache-annotation-spring-boot-starter&lt;/artifactId&gt; &lt;version&gt;1.1.0&lt;/version&gt;&lt;/dependency&gt; gradle依赖 1implementation &#x27;com.hanqunfeng:reactive-redis-cache-annotation-spring-boot-starter:1.1.0&#x27; 此时项目中可能还要添加其它依赖，以gradle举例 1234567891011//webflux，非必须，主要是面向响应式编程的，所以使用springboot大概率会使用webfluximplementation &#x27;org.springframework.boot:spring-boot-starter-webflux&#x27;//Spring Boot Redis 依赖，或者spring-boot-starter-data-redis-reactive，任选其一即可，注意要在配置文件中加入redis的配置implementation &#x27;org.springframework.boot:spring-boot-starter-data-redis&#x27;//redis lettuce连接池依赖，也可以使用jedis连接池，非必须，正式环境建议开启连接池implementation &#x27;org.apache.commons:commons-pool2&#x27;//aop 面向方面编程 支持@Aspect，非必须implementation &#x27;org.springframework.boot:spring-boot-starter-aop&#x27; 方法返回值必须是Mono或者Flux类型，使用方式与springboot提供的Cacheable等注解类似 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657/*** 缓存 cacheName和key支持EL表达式，实际key的名称是&quot;cacheName_key&quot;* 缓存结果* key:sysuser_find_lisi* value:* [* &quot;com.example.model.SysUser&quot;* &#123;* id:&quot;5c74a4e4-c4f2-4570-8735-761d7a570d36&quot;* username:&quot;lisi&quot;* password:&quot;$2a$10$PXoGXLwg05.5YO.QtZa46ONypBmiK59yfefvO1OGO8kYFwzOB.Os6&quot;* enable:true* &#125;* ]*/@ReactiveRedisCacheable(cacheName = &quot;sysuser&quot;, key = &quot;&#x27;find_&#x27; + #username&quot;)public Mono&lt;SysUser&gt; findUserByUsername(String username) &#123; return sysUserRepository.findByUsername(username);&#125;@ReactiveRedisCacheable(cacheName = &quot;sysuser&quot;, key = &quot;all&quot;)public Flux&lt;SysUser&gt; findAll() &#123; return sysUserRepository.findAll();&#125;/*** 删除缓存，allEntries = true 表示删除全部以&quot;cacheName_&quot;开头的缓存* allEntries 默认false，此时需要指定key的值，表示删除指定的&quot;cacheName_key&quot;*/@ReactiveRedisCacheEvict(cacheName = &quot;sysuser&quot;, allEntries = true)public Mono&lt;SysUser&gt; add(SysUser sysUser) &#123; return sysUserRepository.addSysUser(sysUser.getId(), sysUser.getUsername(), sysUser.getPassword(), sysUser.getEnable()).flatMap(data -&gt; sysUserRepository.findById(sysUser.getId()));&#125;/*** 组合注解，用法与@Caching类似* 规则：* 1.cacheables不能与cacheEvicts或者cachePuts同时存在，因为后者一定会执行方法主体，达不到调用缓存的目的，所以当cacheables存在时，后者即便指定也不执行* 2.先执行cacheEvicts，再执行cachePuts*/@ReactiveRedisCaching( evict = &#123;@ReactiveRedisCacheEvict(cacheName = &quot;sysuser&quot;, key = &quot;all&quot;)&#125;, put = &#123;@ReactiveRedisCachePut(cacheName = &quot;sysuser&quot;, key = &quot;&#x27;find_&#x27; + #sysUser.username&quot;)&#125;)public Mono&lt;SysUser&gt; update(SysUser sysUser) &#123; Mono&lt;SysUser&gt; save = sysUserRepository.save(sysUser); return save;&#125;/*** 删除指定的&quot;cacheName_key&quot;*/@ReactiveRedisCacheEvict(cacheName = &quot;sysuser&quot;, key=&quot;&#x27;find_&#x27; + #username&quot;)public Mono&lt;Boolean&gt; deleteByUserName(String username) &#123; return sysUserRepository.deleteByUsername(username);&#125; RedisTemplate 如果使用时没有创建RedisTemplate，本项目中提供了一个默认的RedisTemplate，基于jackson序列化，支持jdk8的LocalDate和LocalDateTime 1234567891011121314151617181920212223242526272829303132333435363738394041424344@Bean@ConditionalOnMissingBean(value = RedisTemplate.class)public RedisTemplate&lt;String, Object&gt; redisTemplate(RedisConnectionFactory redisConnectionFactory) &#123; log.debug(&quot;ReactiveRedisConfig RedisTemplate&quot;); ObjectMapper objectMapper = new ObjectMapper(); objectMapper.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY); //objectMapper.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL); objectMapper.activateDefaultTyping(objectMapper.getPolymorphicTypeValidator(), ObjectMapper.DefaultTyping.NON_FINAL, JsonTypeInfo.As.WRAPPER_ARRAY); //LocalDateTime系列序列化和反序列化模块，继承自jsr310，我们在这里修改了日期格式 JavaTimeModule javaTimeModule = new JavaTimeModule(); //序列化 javaTimeModule.addSerializer(LocalDateTime.class, new LocalDateTimeSerializer( DateTimeFormatter.ofPattern(DEFAULT_DATE_TIME_FORMAT))); javaTimeModule.addSerializer(LocalDate.class, new LocalDateSerializer(DateTimeFormatter.ofPattern(DEFAULT_DATE_FORMAT))); javaTimeModule.addSerializer(LocalTime.class, new LocalTimeSerializer(DateTimeFormatter.ofPattern(DEFAULT_TIME_FORMAT))); //反序列化 javaTimeModule.addDeserializer(LocalDateTime.class, new LocalDateTimeDeserializer( DateTimeFormatter.ofPattern(DEFAULT_DATE_TIME_FORMAT))); javaTimeModule.addDeserializer(LocalDate.class, new LocalDateDeserializer(DateTimeFormatter.ofPattern(DEFAULT_DATE_FORMAT))); javaTimeModule.addDeserializer(LocalTime.class, new LocalTimeDeserializer(DateTimeFormatter.ofPattern(DEFAULT_TIME_FORMAT))); //注册模块 objectMapper.registerModule(javaTimeModule); Jackson2JsonRedisSerializer&lt;Object&gt; serializer = new Jackson2JsonRedisSerializer&lt;&gt;(Object.class); serializer.setObjectMapper(objectMapper); RedisTemplate&lt;String, Object&gt; redisTemplate = new RedisTemplate&lt;&gt;(); redisTemplate.setConnectionFactory(redisConnectionFactory); redisTemplate.setKeySerializer(new StringRedisSerializer()); redisTemplate.setValueSerializer(serializer); redisTemplate.setHashKeySerializer(new StringRedisSerializer()); redisTemplate.setHashValueSerializer(serializer); redisTemplate.afterPropertiesSet(); return redisTemplate;&#125; 以下为源码说明源码依赖1234567891011121314151617181920212223242526272829303132333435363738&lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-autoconfigure&lt;/artifactId&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-configuration-processor&lt;/artifactId&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt; &lt;artifactId&gt;jackson-databind&lt;/artifactId&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;com.fasterxml.jackson.datatype&lt;/groupId&gt; &lt;artifactId&gt;jackson-datatype-jdk8&lt;/artifactId&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;com.fasterxml.jackson.datatype&lt;/groupId&gt; &lt;artifactId&gt;jackson-datatype-jsr310&lt;/artifactId&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;org.aspectj&lt;/groupId&gt; &lt;artifactId&gt;aspectjweaver&lt;/artifactId&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;io.projectreactor&lt;/groupId&gt; &lt;artifactId&gt;reactor-core&lt;/artifactId&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;org.springframework.data&lt;/groupId&gt; &lt;artifactId&gt;spring-data-redis&lt;/artifactId&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;org.projectlombok&lt;/groupId&gt; &lt;artifactId&gt;lombok&lt;/artifactId&gt; &lt;optional&gt;true&lt;/optional&gt;&lt;/dependency&gt; 自定义Redis缓存相关注解 只支持方法返回类型为Mono或者Flux 其它返回类型时请使用springboot提供的Cacheable，CachePut，CacheEvict和Caching 使用方式与springboot提供的Cacheable，CachePut，CacheEvict和Caching类似，具体看本文上面的示例 ReactiveRedisCacheable12345678910111213141516171819202122232425262728293031package com.hanqunfeng.reactive.redis.cache.aop;import java.lang.annotation.*;/** * &lt;h1&gt;redis方法缓存注解&lt;/h1&gt; * Created by hanqf on 2020/11/21 18:28. */@Target(&#123;ElementType.METHOD&#125;)@Retention(RetentionPolicy.RUNTIME)@Documentedpublic @interface ReactiveRedisCacheable &#123; /** * 缓存key，key为cacheName+&quot;_&quot;+key * 支持EL表达式 */ String key(); /** * 缓存key分组，会做为缓存key的前缀+&quot;_&quot; * 支持EL表达式 */ String cacheName(); /** * 缓存过期时间，单位秒，默认24小时 */ long timeout() default 24 * 3600L;&#125; ReactiveRedisCacheEvict1234567891011121314151617181920212223242526272829303132333435363738package com.hanqunfeng.reactive.redis.cache.aop;import java.lang.annotation.*;/** * &lt;h1&gt;redis清除缓存注解&lt;/h1&gt; * Created by hanqf on 2020/11/21 22:26. */@Target(&#123;ElementType.METHOD&#125;)@Retention(RetentionPolicy.RUNTIME)@Documentedpublic @interface ReactiveRedisCacheEvict &#123; /** * 缓存key，如果cacheName不为空，则key为cacheName+&quot;_&quot;+key * 支持EL表达式 */ String key() default &quot;&quot;; /** * 缓存key分组，会做为缓存key的前缀+&quot;_&quot; * 支持EL表达式 */ String cacheName(); /** * 是否删除cacheName下全部缓存数据， * true时cacheName不能为空，此时即便指定了key值，也会删除cacheName下全部缓存 * false时key值不能为空 */ boolean allEntries() default false; /** * 调用清除缓存的时机，true:执行方法前，false:执行方法后 * 如果是false，则方法执行过程中发生异常，则不会清除缓存 */ boolean beforeInvocation() default false;&#125; ReactiveRedisCachePut1234567891011121314151617181920212223242526272829303132package com.hanqunfeng.reactive.redis.cache.aop;import java.lang.annotation.*;/** * &lt;h1&gt;执行完方法更新缓存&lt;/h1&gt; * Created by hanqf on 2020/11/21 23:15. */@Target(&#123;ElementType.METHOD&#125;)@Retention(RetentionPolicy.RUNTIME)@Documentedpublic @interface ReactiveRedisCachePut &#123; /** * 缓存key，key为cacheName+&quot;_&quot;+key * 支持EL表达式 */ String key(); /** * 缓存key分组，会做为缓存key的前缀+&quot;_&quot; * 支持EL表达式 */ String cacheName(); /** * 缓存过期时间，单位秒，默认24小时 */ long timeout() default 24 * 3600L;&#125; ReactiveRedisCaching123456789101112131415161718192021package com.hanqunfeng.reactive.redis.cache.aop;import java.lang.annotation.*;/** * &lt;h1&gt;组合&lt;/h1&gt; * Created by hanqf on 2020/11/21 23:24. */@Target(&#123;ElementType.METHOD&#125;)@Retention(RetentionPolicy.RUNTIME)@Documentedpublic @interface ReactiveRedisCaching &#123; ReactiveRedisCacheable[] cacheable() default &#123;&#125;; ReactiveRedisCachePut[] put() default &#123;&#125;; ReactiveRedisCacheEvict[] evict() default &#123;&#125;;&#125; AOP–ReactiveRedisCacheAspect 支持方法返回类型为Mono或者Flux 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393package com.hanqunfeng.reactive.redis.cache.aop;import lombok.extern.slf4j.Slf4j;import org.aspectj.lang.ProceedingJoinPoint;import org.aspectj.lang.annotation.Around;import org.aspectj.lang.annotation.Aspect;import org.aspectj.lang.annotation.Pointcut;import org.aspectj.lang.reflect.MethodSignature;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.data.redis.core.RedisTemplate;import org.springframework.stereotype.Component;import reactor.core.publisher.Flux;import reactor.core.publisher.Mono;import java.lang.reflect.Method;import java.util.*;import java.util.concurrent.TimeUnit;import java.util.concurrent.atomic.AtomicBoolean;/** * &lt;h1&gt;redis缓存aop&lt;/h1&gt; * Created by hanqf on 2020/11/21 16:16. */@Component//标识是一个Aspect代理类@Aspect//如果有多个切面拦截相同的切点，可以用@Order指定执行顺序//@Order(1)@Slf4jpublic class ReactiveRedisCacheAspect &#123; @Autowired private RedisTemplate redisTemplate; @Pointcut(&quot;@annotation(com.hanqunfeng.reactive.redis.cache.aop.ReactiveRedisCacheable)&quot;) public void cacheablePointCut() &#123; &#125; @Pointcut(&quot;@annotation(com.hanqunfeng.reactive.redis.cache.aop.ReactiveRedisCacheEvict)&quot;) public void cacheEvictPointCut() &#123; &#125; @Pointcut(&quot;@annotation(com.hanqunfeng.reactive.redis.cache.aop.ReactiveRedisCachePut)&quot;) public void cachePutPointCut() &#123; &#125; @Pointcut(&quot;@annotation(com.hanqunfeng.reactive.redis.cache.aop.ReactiveRedisCaching)&quot;) public void cachingPointCut() &#123; &#125; //环绕通知,一般不建议使用，可以通过@Before和@AfterReturning实现 //但是响应式方法只能通过环绕通知实现aop，因为其它通知会导致不再同一个线程执行 @Around(&quot;cacheablePointCut()&quot;) public Object cacheableAround(ProceedingJoinPoint proceedingJoinPoint) throws Throwable &#123; log.debug(&quot;ReactiveRedisCacheAspect cacheableAround....&quot;); MethodSignature methodSignature = (MethodSignature) proceedingJoinPoint.getSignature(); Method method = methodSignature.getMethod(); String returnTypeName = method.getReturnType().getSimpleName(); ReactiveRedisCacheable annotation = method.getAnnotation(ReactiveRedisCacheable.class); String cacheName = annotation.cacheName(); String key = annotation.key(); long timeout = annotation.timeout(); //转换EL表达式 cacheName = (String) AspectSupportUtils.getKeyValue(proceedingJoinPoint, cacheName); key = (String) AspectSupportUtils.getKeyValue(proceedingJoinPoint, key); String redis_key = cacheName + &quot;_&quot; + key; boolean hasKey = redisTemplate.hasKey(redis_key); if (hasKey) &#123; Object o = redisTemplate.opsForValue().get(redis_key); if (returnTypeName.equals(&quot;Flux&quot;)) &#123; return Flux.fromIterable((List) o); &#125; else if (returnTypeName.equals(&quot;Mono&quot;)) &#123; return Mono.just(o); &#125; else &#123; return o; &#125; &#125; else &#123; //实际执行的方法 Object proceed = proceedingJoinPoint.proceed(); if (returnTypeName.equals(&quot;Flux&quot;)) &#123; return ((Flux) proceed).collectList().doOnNext(list -&gt; redisTemplate.opsForValue().set(redis_key, list, timeout, TimeUnit.SECONDS)).flatMapMany(list -&gt; Flux.fromIterable((List) list)); &#125; else if (returnTypeName.equals(&quot;Mono&quot;)) &#123; return ((Mono) proceed).doOnNext(obj -&gt; redisTemplate.opsForValue().set(redis_key, obj, timeout, TimeUnit.SECONDS)); &#125; else &#123; return proceed; &#125; &#125; &#125; @Around(&quot;cacheEvictPointCut()&quot;) public Object cacheEvictAround(ProceedingJoinPoint proceedingJoinPoint) throws Throwable &#123; log.debug(&quot;ReactiveRedisCacheAspect cacheEvictAround....&quot;); MethodSignature methodSignature = (MethodSignature) proceedingJoinPoint.getSignature(); Method method = methodSignature.getMethod(); String returnTypeName = method.getReturnType().getSimpleName(); ReactiveRedisCacheEvict annotation = method.getAnnotation(ReactiveRedisCacheEvict.class); String cacheName = annotation.cacheName(); String key = annotation.key(); boolean allEntries = annotation.allEntries(); boolean beforeInvocation = annotation.beforeInvocation(); //转换EL表达式 cacheName = (String) AspectSupportUtils.getKeyValue(proceedingJoinPoint, cacheName); key = (String) AspectSupportUtils.getKeyValue(proceedingJoinPoint, key); //执行方法前清除缓存 if (beforeInvocation) &#123; //清除全部缓存 deleteRedisCache(cacheName, key, allEntries); //实际执行的方法 Object proceed = proceedingJoinPoint.proceed(); return proceed; &#125; else &#123;//成功执行方法后清除缓存 //实际执行的方法 Object proceed = proceedingJoinPoint.proceed(); final String cacheNameTemp = cacheName; final String keyTemp = key; if (returnTypeName.equals(&quot;Flux&quot;)) &#123; return ((Flux) proceed).collectList().doOnNext(list -&gt; &#123; //清除全部缓存 deleteRedisCache(cacheNameTemp, keyTemp, allEntries); &#125;).flatMapMany(list -&gt; Flux.fromIterable((List) list)); &#125; else if (returnTypeName.equals(&quot;Mono&quot;)) &#123; return ((Mono) proceed).doOnNext(obj -&gt; &#123; //清除全部缓存 deleteRedisCache(cacheNameTemp, keyTemp, allEntries); &#125;); &#125; else &#123; return proceed; &#125; &#125; &#125; @Around(&quot;cachePutPointCut()&quot;) public Object cachePutAround(ProceedingJoinPoint proceedingJoinPoint) throws Throwable &#123; log.debug(&quot;ReactiveRedisCacheAspect cachePutAround....&quot;); MethodSignature methodSignature = (MethodSignature) proceedingJoinPoint.getSignature(); Method method = methodSignature.getMethod(); String returnTypeName = method.getReturnType().getSimpleName(); ReactiveRedisCachePut annotation = method.getAnnotation(ReactiveRedisCachePut.class); String cacheName = annotation.cacheName(); String key = annotation.key(); long timeout = annotation.timeout(); //转换EL表达式 cacheName = (String) AspectSupportUtils.getKeyValue(proceedingJoinPoint, cacheName); key = (String) AspectSupportUtils.getKeyValue(proceedingJoinPoint, key); String redis_key = cacheName + &quot;_&quot; + key; boolean hasKey = redisTemplate.hasKey(redis_key); if (hasKey) &#123; redisTemplate.delete(redis_key); &#125; //实际执行的方法 Object proceed = proceedingJoinPoint.proceed(); if (returnTypeName.equals(&quot;Flux&quot;)) &#123; return ((Flux) proceed).collectList().doOnNext(list -&gt; redisTemplate.opsForValue().set(redis_key, list, timeout, TimeUnit.SECONDS)).flatMapMany(list -&gt; Flux.fromIterable((List) list)); &#125; else if (returnTypeName.equals(&quot;Mono&quot;)) &#123; return ((Mono) proceed).doOnNext(obj -&gt; redisTemplate.opsForValue().set(redis_key, obj, timeout, TimeUnit.SECONDS)); &#125; else &#123; return proceed; &#125; &#125; @Around(&quot;cachingPointCut()&quot;) public Object cachingAround(ProceedingJoinPoint proceedingJoinPoint) throws Throwable &#123; log.debug(&quot;ReactiveRedisCacheAspect cachingAround....&quot;); MethodSignature methodSignature = (MethodSignature) proceedingJoinPoint.getSignature(); Method method = methodSignature.getMethod(); String returnTypeName = method.getReturnType().getSimpleName(); ReactiveRedisCaching annotation = method.getAnnotation(ReactiveRedisCaching.class); ReactiveRedisCacheEvict[] cacheEvicts = annotation.evict(); ReactiveRedisCachePut[] cachePuts = annotation.put(); ReactiveRedisCacheable[] cacheables = annotation.cacheable(); //规则： //1.cacheables不能与cacheEvicts或者cachePuts同时存在，因为后者一定会执行方法主体，达不到调用缓存的目的，所以当cacheables存在时，后者即便指定也不执行 //2.先执行cacheEvicts，再执行cachePuts if (cacheables.length &gt; 0) &#123; Map&lt;String, Long&gt; key_map = new HashMap&lt;&gt;(); List&lt;String&gt; key_list = new ArrayList&lt;&gt;(); Arrays.stream(cacheables).forEach(cacheable -&gt; &#123; String cacheName = cacheable.cacheName(); String key = cacheable.key(); long timeout = cacheable.timeout(); //转换EL表达式 cacheName = (String) AspectSupportUtils.getKeyValue(proceedingJoinPoint, cacheName); key = (String) AspectSupportUtils.getKeyValue(proceedingJoinPoint, key); String redis_key = cacheName + &quot;_&quot; + key; key_map.put(redis_key, timeout); key_list.add(redis_key); &#125;); AtomicBoolean isAllKeyHas = new AtomicBoolean(true); key_list.forEach(key -&gt; &#123; if (!redisTemplate.hasKey(key)) &#123; isAllKeyHas.set(false); &#125; &#125;); //全部key都有值，则直接返回缓存 if (isAllKeyHas.get()) &#123; Object o = redisTemplate.opsForValue().get(key_list.get(0)); if (returnTypeName.equals(&quot;Flux&quot;)) &#123; return Flux.fromIterable((List) o); &#125; else if (returnTypeName.equals(&quot;Mono&quot;)) &#123; return Mono.just(o); &#125; else &#123; return o; &#125; &#125; else &#123; //实际执行的方法 Object proceed = proceedingJoinPoint.proceed(); if (returnTypeName.equals(&quot;Flux&quot;)) &#123; return ((Flux) proceed).collectList() .doOnNext(list -&gt; key_map.forEach((key, val) -&gt; redisTemplate.opsForValue().set(key, list, val, TimeUnit.SECONDS))) .flatMapMany(list -&gt; Flux.fromIterable((List) list)); &#125; else if (returnTypeName.equals(&quot;Mono&quot;)) &#123; return ((Mono) proceed) .doOnNext(obj -&gt; key_map.forEach((key, val) -&gt; redisTemplate.opsForValue().set(key, obj, val, TimeUnit.SECONDS))); &#125; else &#123; return proceed; &#125; &#125; &#125; else &#123; Map&lt;String, Boolean&gt; map = new HashMap&lt;&gt;(); if (cacheEvicts.length &gt; 0) &#123; Arrays.stream(cacheEvicts).forEach(cacheEvict -&gt; &#123; String cacheName = cacheEvict.cacheName(); String key = cacheEvict.key(); boolean allEntries = cacheEvict.allEntries(); boolean beforeInvocation = cacheEvict.beforeInvocation(); //转换EL表达式 cacheName = (String) AspectSupportUtils.getKeyValue(proceedingJoinPoint, cacheName); key = (String) AspectSupportUtils.getKeyValue(proceedingJoinPoint, key); if (beforeInvocation) &#123; //执行方法前清除缓存 //清除全部缓存 deleteRedisCache(cacheName, key, allEntries); &#125; else &#123; //成功执行方法后清除缓存，先保存到map中 //清除全部缓存 if (allEntries) &#123; map.put(cacheName, true); &#125; else &#123; map.put(cacheName + &quot;_&quot; + key, false); &#125; &#125; &#125;); &#125; //实际执行的方法 Object proceed = proceedingJoinPoint.proceed(); if (cachePuts.length &gt; 0) &#123; Map&lt;String, Long&gt; key_map = new HashMap&lt;&gt;(); Arrays.stream(cachePuts).forEach(cachePut -&gt; &#123; String cacheName = cachePut.cacheName(); String key = cachePut.key(); long timeout = cachePut.timeout(); //转换EL表达式 cacheName = (String) AspectSupportUtils.getKeyValue(proceedingJoinPoint, cacheName); key = (String) AspectSupportUtils.getKeyValue(proceedingJoinPoint, key); String redis_key = cacheName + &quot;_&quot; + key; key_map.put(redis_key, timeout); boolean hasKey = redisTemplate.hasKey(redis_key); if (hasKey) &#123; redisTemplate.delete(redis_key); &#125; &#125;); if (returnTypeName.equals(&quot;Flux&quot;)) &#123; return ((Flux) proceed).collectList() .doOnNext(list -&gt; &#123; //执行方法后清除缓存 if (map.size() &gt; 0) &#123; map.forEach((key, val) -&gt; &#123; deleteRedisCache(key, val); &#125;); &#125; key_map.forEach((key, val) -&gt; redisTemplate.opsForValue().set(key, list, val, TimeUnit.SECONDS)); &#125;) .flatMapMany(list -&gt; Flux.fromIterable((List) list)); &#125; else if (returnTypeName.equals(&quot;Mono&quot;)) &#123; return ((Mono) proceed) .doOnNext(obj -&gt; &#123; //执行方法后清除缓存 if (map.size() &gt; 0) &#123; map.forEach((key, val) -&gt; &#123; deleteRedisCache(key, val); &#125;); &#125; key_map.forEach((key, val) -&gt; redisTemplate.opsForValue().set(key, obj, val, TimeUnit.SECONDS)); &#125;); &#125; else &#123; return proceed; &#125; &#125; else &#123; if (returnTypeName.equals(&quot;Flux&quot;)) &#123; return ((Flux) proceed).collectList().doOnNext(list -&gt; &#123; //执行方法后清除缓存 if (map.size() &gt; 0) &#123; map.forEach((key, val) -&gt; &#123; deleteRedisCache(key, val); &#125;); &#125; &#125;).flatMapMany(list -&gt; Flux.fromIterable((List) list)); &#125; else if (returnTypeName.equals(&quot;Mono&quot;)) &#123; return ((Mono) proceed).doOnNext(obj -&gt; &#123; //执行方法后清除缓存 if (map.size() &gt; 0) &#123; map.forEach((key, val) -&gt; &#123; deleteRedisCache(key, val); &#125;); &#125; &#125;); &#125; else &#123; return proceed; &#125; &#125; &#125; &#125; private void deleteRedisCache(String key, boolean clearAll) &#123; if (clearAll) &#123; Set keys = redisTemplate.keys(key + &quot;_*&quot;); if (!keys.isEmpty()) &#123; redisTemplate.delete(keys); &#125; &#125; else &#123; if (redisTemplate.hasKey(key)) &#123; redisTemplate.delete(key); &#125; &#125; &#125; private void deleteRedisCache(String cacheName, String key, boolean clearAll) &#123; String redis_key = &quot;&quot;; if (clearAll) &#123; redis_key = cacheName + &quot;_*&quot;; &#125; else &#123; redis_key = cacheName + &quot;_&quot; + key; &#125; deleteRedisCache(redis_key, clearAll); &#125;&#125; 注解属性支持EL表达式的工具类AspectSupportUtils123456789101112131415161718192021222324252627282930313233343536package com.hanqunfeng.reactive.redis.cache.aop;import org.aspectj.lang.JoinPoint;import org.aspectj.lang.reflect.MethodSignature;import org.springframework.cache.interceptor.SimpleKeyGenerator;import org.springframework.context.expression.AnnotatedElementKey;import org.springframework.expression.EvaluationContext;import org.springframework.util.StringUtils;import java.lang.reflect.Method;public class AspectSupportUtils &#123; private static ExpressionEvaluator evaluator = new ExpressionEvaluator(); public static Object getKeyValue(JoinPoint joinPoint, String keyExpression) &#123; if(keyExpression.contains(&quot;#&quot;) || keyExpression.contains(&quot;&#x27;&quot;)) &#123; return getKeyValue(joinPoint.getTarget(), joinPoint.getArgs(), joinPoint.getTarget().getClass(), ((MethodSignature) joinPoint.getSignature()).getMethod(), keyExpression); &#125; return keyExpression; &#125; private static Object getKeyValue(Object object, Object[] args, Class&lt;?&gt; clazz, Method method, String keyExpression) &#123; if (StringUtils.hasText(keyExpression)) &#123; EvaluationContext evaluationContext = evaluator.createEvaluationContext(object, clazz, method, args); AnnotatedElementKey methodKey = new AnnotatedElementKey(method, clazz); return evaluator.key(keyExpression, methodKey, evaluationContext); &#125; return SimpleKeyGenerator.generateKey(args); &#125;&#125; ExpressionEvaluator12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970package com.hanqunfeng.reactive.redis.cache.aop;import org.springframework.aop.support.AopUtils;import org.springframework.context.expression.AnnotatedElementKey;import org.springframework.context.expression.CachedExpressionEvaluator;import org.springframework.context.expression.MethodBasedEvaluationContext;import org.springframework.core.DefaultParameterNameDiscoverer;import org.springframework.core.ParameterNameDiscoverer;import org.springframework.expression.EvaluationContext;import org.springframework.expression.Expression;import java.lang.reflect.Method;import java.util.Map;import java.util.concurrent.ConcurrentHashMap;public class ExpressionEvaluator extends CachedExpressionEvaluator &#123; private final ParameterNameDiscoverer paramNameDiscoverer = new DefaultParameterNameDiscoverer(); private final Map&lt;ExpressionKey, Expression&gt; conditionCache = new ConcurrentHashMap&lt;&gt;(64); private final Map&lt;AnnotatedElementKey, Method&gt; targetMethodCache = new ConcurrentHashMap&lt;&gt;(64); public EvaluationContext createEvaluationContext(Object object, Class&lt;?&gt; targetClass, Method method, Object[] args) &#123; Method targetMethod = getTargetMethod(targetClass, method); ExpressionRootObject root = new ExpressionRootObject(object, args); return new MethodBasedEvaluationContext(root, targetMethod, args, this.paramNameDiscoverer); &#125; public Object key(String conditionExpression, AnnotatedElementKey elementKey, EvaluationContext evalContext) &#123; return getExpression(this.conditionCache, elementKey, conditionExpression).getValue(evalContext); &#125; private Method getTargetMethod(Class&lt;?&gt; targetClass, Method method) &#123; AnnotatedElementKey methodKey = new AnnotatedElementKey(method, targetClass); Method targetMethod = this.targetMethodCache.get(methodKey); if (targetMethod == null) &#123; targetMethod = AopUtils.getMostSpecificMethod(method, targetClass); if (targetMethod == null) &#123; targetMethod = method; &#125; this.targetMethodCache.put(methodKey, targetMethod); &#125; return targetMethod; &#125; private class ExpressionRootObject &#123; private final Object object; private final Object[] args; public ExpressionRootObject(Object object, Object[] args) &#123; this.object = object; this.args = args; &#125; public Object getobject() &#123; return object; &#125; public Object[] getArgs() &#123; return args; &#125; &#125;&#125; 本项目提供了自动配置类，开启Aspect支持同时提供RedisTemplate 支持LocalDate和LocalDateTime的序列化和反序列化 存储key为字符串，值为json12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394959697package com.hanqunfeng.reactive.redis.cache.config;import com.fasterxml.jackson.annotation.JsonAutoDetect;import com.fasterxml.jackson.annotation.JsonTypeInfo;import com.fasterxml.jackson.annotation.PropertyAccessor;import com.fasterxml.jackson.databind.ObjectMapper;import com.fasterxml.jackson.datatype.jsr310.JavaTimeModule;import com.fasterxml.jackson.datatype.jsr310.deser.LocalDateDeserializer;import com.fasterxml.jackson.datatype.jsr310.deser.LocalDateTimeDeserializer;import com.fasterxml.jackson.datatype.jsr310.deser.LocalTimeDeserializer;import com.fasterxml.jackson.datatype.jsr310.ser.LocalDateSerializer;import com.fasterxml.jackson.datatype.jsr310.ser.LocalDateTimeSerializer;import com.fasterxml.jackson.datatype.jsr310.ser.LocalTimeSerializer;import lombok.extern.slf4j.Slf4j;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;import org.springframework.context.annotation.Bean;import org.springframework.context.annotation.ComponentScan;import org.springframework.context.annotation.Configuration;import org.springframework.context.annotation.EnableAspectJAutoProxy;import org.springframework.data.redis.connection.RedisConnectionFactory;import org.springframework.data.redis.core.RedisTemplate;import org.springframework.data.redis.serializer.Jackson2JsonRedisSerializer;import org.springframework.data.redis.serializer.StringRedisSerializer;import java.time.LocalDate;import java.time.LocalDateTime;import java.time.LocalTime;import java.time.format.DateTimeFormatter;/** * @author hanqf * Created by hanqf on 2020/11/22 15:38 */@Configuration@ComponentScan(basePackages = &quot;org.hanqf.reactive.redis.cache&quot;)@EnableAspectJAutoProxy@Slf4jpublic class ReactiveRedisConfig &#123; /** * 默认日期时间格式 */ public static final String DEFAULT_DATE_TIME_FORMAT = &quot;yyyy-MM-dd HH:mm:ss&quot;; /** * 默认日期格式 */ public static final String DEFAULT_DATE_FORMAT = &quot;yyyy-MM-dd&quot;; /** * 默认时间格式 */ public static final String DEFAULT_TIME_FORMAT = &quot;HH:mm:ss&quot;; @Bean @ConditionalOnMissingBean(value = RedisTemplate.class) public RedisTemplate&lt;String, Object&gt; redisTemplate(RedisConnectionFactory redisConnectionFactory) &#123; log.debug(&quot;ReactiveRedisConfig RedisTemplate&quot;); ObjectMapper objectMapper = new ObjectMapper(); objectMapper.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY); //objectMapper.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL); objectMapper.activateDefaultTyping(objectMapper.getPolymorphicTypeValidator(), ObjectMapper.DefaultTyping.NON_FINAL, JsonTypeInfo.As.WRAPPER_ARRAY); //LocalDateTime系列序列化和反序列化模块，继承自jsr310，我们在这里修改了日期格式 JavaTimeModule javaTimeModule = new JavaTimeModule(); //序列化 javaTimeModule.addSerializer(LocalDateTime.class, new LocalDateTimeSerializer( DateTimeFormatter.ofPattern(DEFAULT_DATE_TIME_FORMAT))); javaTimeModule.addSerializer(LocalDate.class, new LocalDateSerializer(DateTimeFormatter.ofPattern(DEFAULT_DATE_FORMAT))); javaTimeModule.addSerializer(LocalTime.class, new LocalTimeSerializer(DateTimeFormatter.ofPattern(DEFAULT_TIME_FORMAT))); //反序列化 javaTimeModule.addDeserializer(LocalDateTime.class, new LocalDateTimeDeserializer( DateTimeFormatter.ofPattern(DEFAULT_DATE_TIME_FORMAT))); javaTimeModule.addDeserializer(LocalDate.class, new LocalDateDeserializer(DateTimeFormatter.ofPattern(DEFAULT_DATE_FORMAT))); javaTimeModule.addDeserializer(LocalTime.class, new LocalTimeDeserializer(DateTimeFormatter.ofPattern(DEFAULT_TIME_FORMAT))); //注册模块 objectMapper.registerModule(javaTimeModule); Jackson2JsonRedisSerializer&lt;Object&gt; serializer = new Jackson2JsonRedisSerializer&lt;&gt;(Object.class); serializer.setObjectMapper(objectMapper); RedisTemplate&lt;String, Object&gt; redisTemplate = new RedisTemplate&lt;&gt;(); redisTemplate.setConnectionFactory(redisConnectionFactory); redisTemplate.setKeySerializer(new StringRedisSerializer()); redisTemplate.setValueSerializer(serializer); redisTemplate.setHashKeySerializer(new StringRedisSerializer()); redisTemplate.setHashValueSerializer(serializer); redisTemplate.afterPropertiesSet(); return redisTemplate; &#125;&#125;","summary":"摘要 通过本文，你将知道如何在WebFlux项目中通过redis注解缓存方法的返回值; 本项目基于springboot:2.4.0，jdk1.8，并使用Maven构建; 代码地址:https://github.com/hanqunfeng/reactive-redis-cache-annotation-spring-boot-starter","date_published":"2020-11-22T13:30:05.000Z","tags":["技术","springboot2","Java","springboot","redis","webflux","reactive"]},{"id":"https://blog.hanqunfeng.com/2020/11/15/springboot-oauth2-jwt-clientserver/","url":"https://blog.hanqunfeng.com/2020/11/15/springboot-oauth2-jwt-clientserver/","title":"SpringBoot-OAuth2-JWT-ClientServer","content_html":"<h2 id=\"摘要\"><a href=\"#摘要\" class=\"headerlink\" title=\"摘要\"></a>摘要</h2><ul>\n<li>通过本文，你将知道如何搭建一个基于SpringBoot-OAuth2-JWT的客户端服务器</li>\n<li>本文基于springboot:2.4.0，项目基于Gradle-6.6.1构建</li>\n<li>代码地址:<a href=\"https://github.com/hanqunfeng/springbootchapter/tree/master/chapter48\">https://github.com/hanqunfeng/springbootchapter/tree/master/chapter48</a></li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"依赖\"><a href=\"#依赖\" class=\"headerlink\" title=\"依赖\"></a>依赖</h2><ul>\n<li>springboot官方提供了支持<figure class=\"highlight gradle\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">implementation <span class=\"string\">&#x27;org.springframework.boot:spring-boot-starter-web&#x27;</span></span><br><span class=\"line\">implementation <span class=\"string\">&#x27;org.springframework.boot:spring-boot-starter-oauth2-client&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//本项目中使用了lombok简少代码量，非必须依赖</span></span><br><span class=\"line\">compileOnly <span class=\"string\">&#x27;org.projectlombok:lombok&#x27;</span></span><br><span class=\"line\">annotationProcessor <span class=\"string\">&#x27;org.projectlombok:lombok&#x27;</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h2 id=\"WebSecurityConfig\"><a href=\"#WebSecurityConfig\" class=\"headerlink\" title=\"WebSecurityConfig\"></a>WebSecurityConfig</h2><ul>\n<li>springboot没有为client-server设置独立的注解和配置类，而是把这部分功能整合到了spring-security中<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.example.oauth2clientdemo2.config;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> com.example.oauth2clientdemo2.exception.CustomException;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.example.oauth2clientdemo2.security.CustomAccessDeniedHandler;</span><br><span class=\"line\"><span class=\"keyword\">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.boot.web.client.RestTemplateCustomizer;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Bean;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Configuration;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.http.HttpStatus;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.http.client.ClientHttpRequestInterceptor;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.http.client.ClientHttpResponse;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.jdbc.core.JdbcOperations;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.config.annotation.web.builders.WebSecurity;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.core.context.SecurityContextHolder;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.oauth2.client.JdbcOAuth2AuthorizedClientService;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.oauth2.client.OAuth2AuthorizedClient;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.oauth2.client.OAuth2AuthorizedClientService;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.oauth2.client.authentication.OAuth2AuthenticationToken;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.oauth2.client.registration.ClientRegistrationRepository;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.util.CollectionUtils;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.ArrayList;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.List;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * &lt;h1&gt;&lt;/h1&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> * Created by hanqf on 2020/11/9 18:11.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"meta\">@EnableWebSecurity</span></span><br><span class=\"line\"><span class=\"meta\">@Configuration</span></span><br><span class=\"line\"><span class=\"meta\">@Slf4j</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">WebSecurityConfig</span> <span class=\"keyword\">extends</span> <span class=\"title\">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Value(&quot;$&#123;oauth2.server.logout&#125;&quot;)</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> String oauth2_server_logout;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> CustomAccessDeniedHandler customAccessDeniedHandler;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 指定不拦截的路径规则</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">configure</span><span class=\"params\">(WebSecurity web)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">//设置不需要拦截的路径，也就是不需要认证的路径</span></span><br><span class=\"line\">        web.ignoring().antMatchers(<span class=\"string\">&quot;/webjars/**&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">configure</span><span class=\"params\">(HttpSecurity http)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">//logout跳转到认证服务器的logout</span></span><br><span class=\"line\">        http.logout().logoutSuccessUrl(oauth2_server_logout);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//配置认证规则</span></span><br><span class=\"line\">        http.authorizeRequests()</span><br><span class=\"line\">                .mvcMatchers(<span class=\"string\">&quot;/oauth/login&quot;</span>).permitAll()</span><br><span class=\"line\">                <span class=\"comment\">////所有路径都需要登录</span></span><br><span class=\"line\">                .antMatchers(<span class=\"string\">&quot;/&quot;</span>).authenticated()</span><br><span class=\"line\">                <span class=\"comment\">////需要具备相应的角色才能访问，这里返回的权限是scope，所以还是使用rbac验证吧</span></span><br><span class=\"line\">                .antMatchers(<span class=\"string\">&quot;/user/**&quot;</span>, <span class=\"string\">&quot;/user2/**&quot;</span>).hasAuthority(<span class=\"string\">&quot;SCOPE_any&quot;</span>)</span><br><span class=\"line\">                .anyRequest().access(<span class=\"string\">&quot;@rbacService.hasPerssion(request,authentication)&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//开启oauth2登录认证</span></span><br><span class=\"line\">        http.oauth2Login();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//开启基于oauth2的客户端信息</span></span><br><span class=\"line\">        http.oauth2Client();</span><br><span class=\"line\"></span><br><span class=\"line\">        http.csrf().disable();</span><br><span class=\"line\"></span><br><span class=\"line\">        http.exceptionHandling().accessDeniedHandler(customAccessDeniedHandler);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"WebSecurityConfig说明\"><a href=\"#WebSecurityConfig说明\" class=\"headerlink\" title=\"WebSecurityConfig说明\"></a>WebSecurityConfig说明</h3><p>与oauth2-client相关的代码就如下两行</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> <span class=\"comment\">//开启oauth2登录认证</span></span><br><span class=\"line\">http.oauth2Login();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//开启基于oauth2的客户端信息</span></span><br><span class=\"line\">http.oauth2Client();</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"配置文件\"><a href=\"#配置文件\" class=\"headerlink\" title=\"配置文件\"></a>配置文件</h2><figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">oauth2:</span></span><br><span class=\"line\">  <span class=\"attr\">server:</span></span><br><span class=\"line\">    <span class=\"attr\">url:</span> <span class=\"string\">http://localhost:8080</span></span><br><span class=\"line\">    <span class=\"attr\">logout:</span> <span class=\"string\">$&#123;oauth2.server.url&#125;/logout</span> <span class=\"comment\">#可以实现单点登录，不能实现单点登出</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">spring:</span></span><br><span class=\"line\">  <span class=\"comment\">#oauth2客户端配置，默认基于内存，如果基于数据库，需要在config配置类进行相应的配置</span></span><br><span class=\"line\">  <span class=\"attr\">security:</span></span><br><span class=\"line\">    <span class=\"attr\">oauth2:</span></span><br><span class=\"line\">      <span class=\"attr\">client:</span></span><br><span class=\"line\">        <span class=\"attr\">registration:</span> <span class=\"comment\">#支持多租户</span></span><br><span class=\"line\">          <span class=\"comment\"># /postman/oauth2/authorization/my-client</span></span><br><span class=\"line\">          <span class=\"attr\">my-client:</span> <span class=\"comment\"># 1 注册客户端名称，随意指定，但是要与provider的配置相一致</span></span><br><span class=\"line\">            <span class=\"attr\">client-id:</span> <span class=\"string\">postman</span> <span class=\"comment\"># 2 客户端ID</span></span><br><span class=\"line\">            <span class=\"attr\">client-secret:</span> <span class=\"string\">postman</span> <span class=\"comment\"># 3 客户端密码</span></span><br><span class=\"line\">            <span class=\"attr\">authorization-grant-type:</span> <span class=\"string\">authorization_code</span> <span class=\"comment\"># 4 认证类型</span></span><br><span class=\"line\">            <span class=\"comment\">#默认重定向URI模板是&#123;baseUrl&#125;/login/oauth2/code/&#123;registrationId&#125;。</span></span><br><span class=\"line\">            <span class=\"comment\">#registrationId是ClientRegistration的唯一标识符。</span></span><br><span class=\"line\">            <span class=\"attr\">redirect-uri:</span> <span class=\"string\">http://localhost:8088/postman/login/oauth2/code/my-client</span>  <span class=\"comment\"># 5 回调地址，需要配置到数据表中，默认写法，注意最后的路径是注册客户端名称</span></span><br><span class=\"line\">            <span class=\"attr\">scope:</span> <span class=\"string\">any</span> <span class=\"comment\">#请求范围</span></span><br><span class=\"line\">            <span class=\"attr\">client-name:</span> <span class=\"string\">客户端1</span></span><br><span class=\"line\">          <span class=\"comment\"># /postman/oauth2/authorization/my-client2</span></span><br><span class=\"line\">          <span class=\"attr\">my-client2:</span> <span class=\"comment\"># 1 注册客户端名称，随意指定，但是要与provider的配置相一致</span></span><br><span class=\"line\">            <span class=\"attr\">client-id:</span> <span class=\"string\">postman</span> <span class=\"comment\"># 2 客户端ID</span></span><br><span class=\"line\">            <span class=\"attr\">client-secret:</span> <span class=\"string\">postman</span> <span class=\"comment\"># 3 客户端密码</span></span><br><span class=\"line\">            <span class=\"attr\">authorization-grant-type:</span> <span class=\"string\">authorization_code</span> <span class=\"comment\"># 4 认证类型</span></span><br><span class=\"line\">            <span class=\"attr\">redirect-uri:</span> <span class=\"string\">http://localhost:8088/postman/login/oauth2/code/my-client2</span>  <span class=\"comment\"># 5 回调地址，需要配置到数据表中，默认写法，注意最后的路径是注册客户端名称</span></span><br><span class=\"line\">            <span class=\"attr\">scope:</span> <span class=\"string\">any</span> <span class=\"comment\">#请求范围</span></span><br><span class=\"line\">            <span class=\"attr\">client-name:</span> <span class=\"string\">客户端2</span></span><br><span class=\"line\"></span><br><span class=\"line\">          <span class=\"comment\"># CommonOAuth2Provider 中定义了google,facebook,github,okta的默认provider信息，所以这里不需要为其配置provider信息</span></span><br><span class=\"line\">          <span class=\"comment\"># /postman/oauth2/authorization/google</span></span><br><span class=\"line\">          <span class=\"comment\"># 重定向后：https://accounts.google.com/o/oauth2/v2/auth?response_type=code&amp;client_id=xxxxxxxxx&amp;scope=openid%20profile%20email&amp;state=jO3PpuX2IzwOFemdd7FHBIHeeSPcxDwiP-mqDBTjdfw%3D&amp;redirect_uri=http://localhost:8088/postman/login/oauth2/code/google&amp;nonce=-sxhj2hjgrc7krSHSjL3qz_W90xPEX9nlP6SYzAfktY</span></span><br><span class=\"line\">          <span class=\"attr\">google:</span> <span class=\"comment\"># google帐号认证，跳转到google登录页面</span></span><br><span class=\"line\">            <span class=\"attr\">client-id:</span> <span class=\"string\">xxxxxxxxx</span> <span class=\"comment\">#  客户端ID</span></span><br><span class=\"line\">            <span class=\"attr\">client-secret:</span> <span class=\"string\">xxxxxxx</span> <span class=\"comment\">#  客户端密码</span></span><br><span class=\"line\">            <span class=\"attr\">client-name:</span> <span class=\"string\">Google认证</span></span><br><span class=\"line\"></span><br><span class=\"line\">          <span class=\"comment\"># /postman/oauth2/authorization/facebook</span></span><br><span class=\"line\">          <span class=\"comment\"># https://www.facebook.com/v2.8/dialog/oauth?response_type=code&amp;client_id=xxxxxxxxx&amp;scope=public_profile%20email&amp;state=BVZM3OW2EUS82pbjJdpQfXvtXbFbMwaUe_lRMOt4BW4%3D&amp;redirect_uri=http://localhost:8088/postman/login/oauth2/code/facebook</span></span><br><span class=\"line\">          <span class=\"attr\">facebook:</span> <span class=\"comment\"># facebook帐号登录，跳转到facebook登录页面</span></span><br><span class=\"line\">            <span class=\"attr\">client-id:</span> <span class=\"string\">xxxxxxxxx</span> <span class=\"comment\">#  客户端ID</span></span><br><span class=\"line\">            <span class=\"attr\">client-secret:</span> <span class=\"string\">xxxxxxx</span> <span class=\"comment\">#  客户端密码</span></span><br><span class=\"line\">            <span class=\"attr\">client-name:</span> <span class=\"string\">Facebook认证</span></span><br><span class=\"line\"></span><br><span class=\"line\">          <span class=\"comment\"># /postman/oauth2/authorization/github</span></span><br><span class=\"line\">          <span class=\"comment\"># 重定向后：https://github.com/login?client_id=xxxxxxxxx&amp;return_to=%2Flogin%2Foauth%2Fauthorize%3Fclient_id%3Dxxxxxxxxx%26redirect_uri%3Dhttp%253A%252F%252Flocalhost%253A8088%252Fpostman%252Flogin%252Foauth2%252Fcode%252Fgithub%26response_type%3Dcode%26scope%3Dread%253Auser%26state%3DmXtRWMQy8NaqVsFiie-NyYuy2z8OErrdq_VsuejDOPE%253D</span></span><br><span class=\"line\">          <span class=\"comment\"># api文档：https://docs.github.com/cn/free-pro-team@latest/rest</span></span><br><span class=\"line\">          <span class=\"attr\">github:</span> <span class=\"comment\"># github帐号登录，跳转到github登录页面</span></span><br><span class=\"line\">            <span class=\"attr\">client-id:</span> <span class=\"string\">xxxxxxxxx</span> <span class=\"comment\">#  客户端ID</span></span><br><span class=\"line\">            <span class=\"attr\">client-secret:</span> <span class=\"string\">xxxxxxx</span> <span class=\"comment\">#  客户端密码</span></span><br><span class=\"line\">            <span class=\"attr\">client-name:</span> <span class=\"string\">Github认证</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"attr\">provider:</span></span><br><span class=\"line\">          <span class=\"attr\">my-client:</span> <span class=\"comment\"># 6 注册客户端名称</span></span><br><span class=\"line\">            <span class=\"attr\">authorization-uri:</span> <span class=\"string\">$&#123;oauth2.server.url&#125;/oauth/authorize</span> <span class=\"comment\"># 7 认证地址</span></span><br><span class=\"line\">            <span class=\"attr\">token-uri:</span> <span class=\"string\">$&#123;oauth2.server.url&#125;/oauth/token</span> <span class=\"comment\"># 8 获取token地址</span></span><br><span class=\"line\">            <span class=\"attr\">user-info-uri:</span> <span class=\"string\">http://localhost:8080/userInfo</span> <span class=\"comment\"># 9 获取用户信息地址，必须配置</span></span><br><span class=\"line\">            <span class=\"attr\">userNameAttribute:</span> <span class=\"string\">username</span> <span class=\"comment\"># 10 指定用户信息中哪个属性是用户名称</span></span><br><span class=\"line\">          <span class=\"attr\">my-client2:</span> <span class=\"comment\"># 6 注册客户端名称</span></span><br><span class=\"line\">            <span class=\"attr\">authorization-uri:</span> <span class=\"string\">$&#123;oauth2.server.url&#125;/oauth/authorize</span> <span class=\"comment\"># 7 认证地址</span></span><br><span class=\"line\">            <span class=\"attr\">token-uri:</span> <span class=\"string\">$&#123;oauth2.server.url&#125;/oauth/token</span> <span class=\"comment\"># 8 获取token地址</span></span><br><span class=\"line\">            <span class=\"attr\">user-info-uri:</span> <span class=\"string\">http://localhost:8080/userInfo</span> <span class=\"comment\"># 9 获取用户信息地址，必须配置</span></span><br><span class=\"line\">            <span class=\"attr\">userNameAttribute:</span> <span class=\"string\">username</span> <span class=\"comment\"># 10 指定用户信息中哪个属性是用户名称</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"配置文件说明\"><a href=\"#配置文件说明\" class=\"headerlink\" title=\"配置文件说明\"></a>配置文件说明</h3><ul>\n<li>springboot默认实现了google,facebook,github,okta的provider，但是其它认证服务器就需要自己指定provider信息。</li>\n<li>这里需要为其指定user-info-uri，这个url提供认证用户的信息，需要认证服务端提供(也可以配置到受认证服务保护的资源服务中)，所以我们需要对认证服务进行改造</li>\n<li>userNameAttribute表示从user-info-uri接口返回的信息中哪个属性名称表示用户名称</li>\n<li>如果客户端信息只有一个，则访问当前客户端服务就会直接跳转到认证服务器的登录页面</li>\n<li>如果客户端配置了多个，则会先跳转到login页面，需要选择要访问的认证服务器，后文有介绍如何自定义login页面</li>\n</ul>\n<h2 id=\"AuthServer改造\"><a href=\"#AuthServer改造\" class=\"headerlink\" title=\"AuthServer改造\"></a>AuthServer改造</h2><h3 id=\"UserController\"><a href=\"#UserController\" class=\"headerlink\" title=\"UserController\"></a>UserController</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.example.oauth2authserverdemo.controller;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.core.Authentication;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.oauth2.jwt.Jwt;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.HashMap;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Map;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@RestController</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">UserController</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@RequestMapping(&quot;/userInfo&quot;)</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Map&lt;String, Object&gt; <span class=\"title\">userInfo</span><span class=\"params\">(Authentication authentication)</span></span>&#123;</span><br><span class=\"line\">        Map&lt;String,Object&gt; map = <span class=\"keyword\">new</span> HashMap&lt;&gt;();</span><br><span class=\"line\">        Object principal = authentication.getPrincipal();</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(principal <span class=\"keyword\">instanceof</span> Jwt)&#123;</span><br><span class=\"line\">            map.put(<span class=\"string\">&quot;username&quot;</span>, ((Jwt) principal).getClaim(<span class=\"string\">&quot;user_name&quot;</span>));</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//客户端获取用户信息时，将附加信息一块返回给客户端</span></span><br><span class=\"line\">            map.putAll(((Jwt) principal).getClaims());</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> map;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"UserController说明\"><a href=\"#UserController说明\" class=\"headerlink\" title=\"UserController说明\"></a>UserController说明</h4><ul>\n<li>这个接口就是普通的controller接口，其返回一个map信息，里面至少包含一个用户名称信息。</li>\n<li>因为client-server与auth-server之间是通过基于JWT的access-token进行访问的，所以这个接口实际上也是一个资源接口，需要为认证服务器配置资源服务。</li>\n</ul>\n<h3 id=\"SecurityConfig\"><a href=\"#SecurityConfig\" class=\"headerlink\" title=\"SecurityConfig\"></a>SecurityConfig</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//认证服务器同时作为资源服务器，其目的是可以对外提供访问的资源，比如&quot;客户端认证获取用户信息&quot;</span></span><br><span class=\"line\"><span class=\"comment\">//鉴权时只支持Bearer Token的形式，不支持url后加参数access_token</span></span><br><span class=\"line\">http.oauth2ResourceServer().jwt() <span class=\"comment\">//开启oauth2资源认证</span></span><br><span class=\"line\">        <span class=\"comment\">//默认情况下，权限是scope，而我们希望使用的是用户的角色，所以这里需要通过转换器进行处理</span></span><br><span class=\"line\">        .jwtAuthenticationConverter(jwt -&gt; &#123; <span class=\"comment\">//通过自定义Converter来指定权限，Converter是函数接口，当前上下问参数为JWT对象</span></span><br><span class=\"line\">            Collection&lt;SimpleGrantedAuthority&gt; authorities =</span><br><span class=\"line\">                    ((Collection&lt;String&gt;) jwt.getClaims()</span><br><span class=\"line\">                            .get(<span class=\"string\">&quot;authorities&quot;</span>)).stream() <span class=\"comment\">//获取JWT中的authorities</span></span><br><span class=\"line\">                            .map(SimpleGrantedAuthority::<span class=\"keyword\">new</span>)</span><br><span class=\"line\">                            .collect(Collectors.toSet());</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//如果希望保留scope的权限，可以取出scope数据然后合并到一起，这样因为不是以ROLE_开头，所以需要使用hasAuthority(&#x27;SCOPE_any&#x27;)的形式</span></span><br><span class=\"line\">            Collection&lt;SimpleGrantedAuthority&gt; scopes = ((Collection&lt;String&gt;) jwt.getClaims()</span><br><span class=\"line\">                    .get(<span class=\"string\">&quot;scope&quot;</span>)).stream().map(scope -&gt; <span class=\"keyword\">new</span> SimpleGrantedAuthority(<span class=\"string\">&quot;SCOPE_&quot;</span> + scope))</span><br><span class=\"line\">                    .collect(Collectors.toSet());</span><br><span class=\"line\">            <span class=\"comment\">//合并权限</span></span><br><span class=\"line\">            authorities.addAll(scopes);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> JwtAuthenticationToken(jwt, authorities);</span><br><span class=\"line\">        &#125;);</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"SecurityConfig说明\"><a href=\"#SecurityConfig说明\" class=\"headerlink\" title=\"SecurityConfig说明\"></a>SecurityConfig说明</h4><ul>\n<li>如果该接口是登录后就可以访问，只需要按如下配置即可：<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http.oauth2ResourceServer().jwt();</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"配置文件-1\"><a href=\"#配置文件-1\" class=\"headerlink\" title=\"配置文件\"></a>配置文件</h3><figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">spring:</span></span><br><span class=\"line\">  <span class=\"comment\">#oauth2 配置</span></span><br><span class=\"line\">  <span class=\"attr\">security:</span></span><br><span class=\"line\">    <span class=\"attr\">oauth2:</span></span><br><span class=\"line\">      <span class=\"attr\">resourceserver:</span></span><br><span class=\"line\">        <span class=\"attr\">jwt:</span></span><br><span class=\"line\">          <span class=\"attr\">public-key-location:</span> <span class=\"string\">classpath:oauth2_key.pub</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li>将公钥文件放到对应的路径下即可</li>\n</ul>\n<h2 id=\"自定义login页面\"><a href=\"#自定义login页面\" class=\"headerlink\" title=\"自定义login页面\"></a>自定义login页面</h2><ul>\n<li>当客户端配置信息中指定了多个client时，访问当前服务时会先跳转到login页面，需要选择要访问哪个认证服务器。</li>\n</ul>\n<h3 id=\"依赖-1\"><a href=\"#依赖-1\" class=\"headerlink\" title=\"依赖\"></a>依赖</h3><figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">implementation</span> <span class=\"string\">&#x27;org.springframework.boot:spring-boot-starter-thymeleaf&#x27;</span></span><br><span class=\"line\"><span class=\"string\">//webjars</span> <span class=\"string\">https://www.webjars.org</span></span><br><span class=\"line\"><span class=\"string\">implementation</span> <span class=\"string\">&#x27;org.webjars:bootstrap:4.5.3&#x27;</span></span><br><span class=\"line\"><span class=\"string\">implementation</span> <span class=\"string\">&#x27;org.webjars.bower:jquery:3.5.1&#x27;</span></span><br><span class=\"line\"><span class=\"string\">//</span> <span class=\"string\">可以在html中去掉webjars的版本号，这样升级的时候直接修改上面引入的webjars中的版本号即可，页面中不需要修改</span></span><br><span class=\"line\"><span class=\"string\">implementation</span> <span class=\"string\">&#x27;org.webjars:webjars-locator:0.40&#x27;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"LoginController\"><a href=\"#LoginController\" class=\"headerlink\" title=\"LoginController\"></a>LoginController</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.example.oauth2clientdemo2.controller;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> lombok.extern.log4j.Log4j2;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.oauth2.client.registration.ClientRegistrationRepository;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.oauth2.client.registration.InMemoryClientRegistrationRepository;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.stereotype.Controller;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.ui.Model;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.HashMap;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Map;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * &lt;h1&gt;LoginController&lt;/h1&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> * Created by hanqf on 2020/11/14 00:19.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Controller</span></span><br><span class=\"line\"><span class=\"meta\">@Log4j2</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">LoginController</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> ClientRegistrationRepository clientRegistrationRepository;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">LoginController</span><span class=\"params\">(ClientRegistrationRepository clientRegistrationRepository)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.clientRegistrationRepository = clientRegistrationRepository;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 自定义登录页面，多租户登录时先显示该页面，由用户选择要使用的认证服务</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> model</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span></span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@RequestMapping(&quot;/oauth/login&quot;)</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">login</span><span class=\"params\">(Model model)</span></span>&#123;</span><br><span class=\"line\">        Map&lt;String,String&gt; map = <span class=\"keyword\">new</span> HashMap&lt;&gt;();</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(clientRegistrationRepository <span class=\"keyword\">instanceof</span> InMemoryClientRegistrationRepository)&#123;</span><br><span class=\"line\">            ((InMemoryClientRegistrationRepository)clientRegistrationRepository).forEach(registrations-&gt;&#123;</span><br><span class=\"line\">                String registrationId = registrations.getRegistrationId();</span><br><span class=\"line\">                String clientName = registrations.getClientName();</span><br><span class=\"line\">                map.put(registrationId,clientName);</span><br><span class=\"line\">            &#125;);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        model.addAttribute(<span class=\"string\">&quot;registrations&quot;</span>, map);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">&quot;oauth2/login&quot;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"login-html\"><a href=\"#login-html\" class=\"headerlink\" title=\"login.html\"></a>login.html</h3><figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE <span class=\"meta-keyword\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span> <span class=\"attr\">lang</span>=<span class=\"string\">&quot;en&quot;</span> <span class=\"attr\">xmlns:th</span>=<span class=\"string\">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">meta</span> <span class=\"attr\">charset</span>=<span class=\"string\">&quot;UTF-8&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">meta</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;viewport&quot;</span> <span class=\"attr\">content</span>=<span class=\"string\">&quot;width=device-width, initial-scale=1, shrink-to-fit=no&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span>登录<span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">link</span> <span class=\"attr\">rel</span>=<span class=\"string\">&quot;stylesheet&quot;</span> <span class=\"attr\">th:href</span>=<span class=\"string\">&quot;@&#123;/webjars/bootstrap/css/bootstrap.min.css&#125;&quot;</span>/&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">th:src</span>=<span class=\"string\">&quot;@&#123;/webjars/jquery/jquery.min.js&#125;&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">th:src</span>=<span class=\"string\">&quot;@&#123;/webjars/bootstrap/js/bootstrap.min.js&#125;&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;container&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">h2</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;form-signin-heading&quot;</span>&gt;</span>Login with OAuth 2.0<span class=\"tag\">&lt;/<span class=\"name\">h2</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">table</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;table table-striped&quot;</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">tr</span> <span class=\"attr\">th:each</span>=<span class=\"string\">&quot;registration: $&#123;registrations&#125;&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">td</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">a</span> <span class=\"attr\">th:href</span>=<span class=\"string\">&quot;@&#123;&#x27;/oauth2/authorization/&#x27;+$&#123;registration.key&#125;&#125;&quot;</span> <span class=\"attr\">th:text</span>=<span class=\"string\">&quot;$&#123;registration.value&#125;&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">a</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">td</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">tr</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">table</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"WebSecurityConfig-1\"><a href=\"#WebSecurityConfig-1\" class=\"headerlink\" title=\"WebSecurityConfig\"></a>WebSecurityConfig</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//开启oauth2登录认证</span></span><br><span class=\"line\">http.oauth2Login()</span><br><span class=\"line\">        <span class=\"comment\">//自定义登录页面</span></span><br><span class=\"line\">        .loginPage(<span class=\"string\">&quot;/oauth/login&quot;</span>);</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"OAuth2AuthorizedClientService\"><a href=\"#OAuth2AuthorizedClientService\" class=\"headerlink\" title=\"OAuth2AuthorizedClientService\"></a>OAuth2AuthorizedClientService</h2><ul>\n<li>默认每次客户端获取到的token信息都是存储在内存中的，如果服务器重启则token就会失效，可以将token保存到数据库中</li>\n</ul>\n<h3 id=\"创建数据表\"><a href=\"#创建数据表\" class=\"headerlink\" title=\"创建数据表\"></a>创建数据表</h3><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 客户端认证信息表，只需建表，数据会自动创建</span><br><span class=\"line\"><span class=\"keyword\">CREATE</span> <span class=\"keyword\">TABLE</span> `oauth2_authorized_client` (</span><br><span class=\"line\">    `client_registration_id` <span class=\"type\">varchar</span>(<span class=\"number\">100</span>) <span class=\"keyword\">COLLATE</span> utf8mb4_bin <span class=\"keyword\">NOT</span> <span class=\"keyword\">NULL</span> COMMENT <span class=\"string\">&#x27;客户端注册Id&#x27;</span>,</span><br><span class=\"line\">    `principal_name` <span class=\"type\">varchar</span>(<span class=\"number\">200</span>) <span class=\"keyword\">COLLATE</span> utf8mb4_bin <span class=\"keyword\">NOT</span> <span class=\"keyword\">NULL</span> COMMENT <span class=\"string\">&#x27;登录用户名称&#x27;</span>,</span><br><span class=\"line\">    `access_token_type` <span class=\"type\">varchar</span>(<span class=\"number\">100</span>) <span class=\"keyword\">COLLATE</span> utf8mb4_bin <span class=\"keyword\">DEFAULT</span> <span class=\"keyword\">NULL</span> COMMENT <span class=\"string\">&#x27;验证类型，这里是bear&#x27;</span>,</span><br><span class=\"line\">    `access_token_value` <span class=\"type\">blob</span> <span class=\"keyword\">DEFAULT</span> <span class=\"keyword\">NULL</span> COMMENT <span class=\"string\">&#x27;access_token的值&#x27;</span>,</span><br><span class=\"line\">    `access_token_issued_at` <span class=\"type\">timestamp</span> <span class=\"keyword\">NOT</span> <span class=\"keyword\">NULL</span> <span class=\"keyword\">DEFAULT</span> <span class=\"built_in\">current_timestamp</span>() <span class=\"keyword\">ON</span> UPDATE <span class=\"built_in\">current_timestamp</span>() COMMENT <span class=\"string\">&#x27;access_token的创建时间&#x27;</span>,</span><br><span class=\"line\">    `access_token_expires_at` <span class=\"type\">timestamp</span> <span class=\"keyword\">NOT</span> <span class=\"keyword\">NULL</span> <span class=\"keyword\">DEFAULT</span> <span class=\"string\">&#x27;0000-00-00 00:00:00&#x27;</span> COMMENT <span class=\"string\">&#x27;access_token的过期时间&#x27;</span>,</span><br><span class=\"line\">    `access_token_scopes` <span class=\"type\">varchar</span>(<span class=\"number\">1000</span>) <span class=\"keyword\">COLLATE</span> utf8mb4_bin <span class=\"keyword\">DEFAULT</span> <span class=\"keyword\">NULL</span> COMMENT <span class=\"string\">&#x27;授权范围&#x27;</span>,</span><br><span class=\"line\">    `refresh_token_value` <span class=\"type\">blob</span> <span class=\"keyword\">DEFAULT</span> <span class=\"keyword\">NULL</span> COMMENT <span class=\"string\">&#x27;refresh_token的值&#x27;</span>,</span><br><span class=\"line\">    `refresh_token_issued_at` <span class=\"type\">timestamp</span> <span class=\"keyword\">NOT</span> <span class=\"keyword\">NULL</span> <span class=\"keyword\">DEFAULT</span> <span class=\"string\">&#x27;0000-00-00 00:00:00&#x27;</span> COMMENT <span class=\"string\">&#x27;refresh_token创建时间&#x27;</span>,</span><br><span class=\"line\">    `created_at` <span class=\"type\">timestamp</span> <span class=\"keyword\">NOT</span> <span class=\"keyword\">NULL</span> <span class=\"keyword\">DEFAULT</span> <span class=\"built_in\">current_timestamp</span>() COMMENT <span class=\"string\">&#x27;数据创建时间&#x27;</span>,</span><br><span class=\"line\">    `update_at` <span class=\"type\">timestamp</span> <span class=\"keyword\">NOT</span> <span class=\"keyword\">NULL</span> <span class=\"keyword\">DEFAULT</span> <span class=\"built_in\">current_timestamp</span>() <span class=\"keyword\">ON</span> UPDATE <span class=\"built_in\">current_timestamp</span>() COMMENT <span class=\"string\">&#x27;数据最后更新时间&#x27;</span>,</span><br><span class=\"line\">    <span class=\"keyword\">PRIMARY</span> KEY (`client_registration_id`,`principal_name`) <span class=\"keyword\">USING</span> BTREE</span><br><span class=\"line\">) ENGINE<span class=\"operator\">=</span>InnoDB <span class=\"keyword\">DEFAULT</span> CHARSET<span class=\"operator\">=</span>utf8mb4 <span class=\"keyword\">COLLATE</span><span class=\"operator\">=</span>utf8mb4_bin;</span><br></pre></td></tr></table></figure>\n<h3 id=\"添加数据库依赖\"><a href=\"#添加数据库依赖\" class=\"headerlink\" title=\"添加数据库依赖\"></a>添加数据库依赖</h3><figure class=\"highlight gradle\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//mysql</span></span><br><span class=\"line\">runtimeOnly <span class=\"string\">&#x27;mysql:mysql-connector-java&#x27;</span></span><br><span class=\"line\"><span class=\"comment\">//为了使用datasource</span></span><br><span class=\"line\">implementation <span class=\"string\">&#x27;org.springframework.boot:spring-boot-starter-jdbc&#x27;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"配置文件添加数据库的配置\"><a href=\"#配置文件添加数据库的配置\" class=\"headerlink\" title=\"配置文件添加数据库的配置\"></a>配置文件添加数据库的配置</h3><figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">spring:</span></span><br><span class=\"line\">  <span class=\"comment\">#数据源配置</span></span><br><span class=\"line\">  <span class=\"attr\">datasource:</span></span><br><span class=\"line\">    <span class=\"attr\">url:</span> <span class=\"string\">jdbc:mysql://localhost:3306/springboot?useUnicode=true&amp;characterEncoding=utf-8&amp;useTimezone=true&amp;serverTimezone=GMT%2B8</span></span><br><span class=\"line\">    <span class=\"attr\">username:</span> <span class=\"string\">root</span></span><br><span class=\"line\">    <span class=\"attr\">password:</span> <span class=\"string\">newpwd</span></span><br><span class=\"line\">    <span class=\"attr\">driver-class-name:</span> <span class=\"string\">com.mysql.cj.jdbc.Driver</span></span><br><span class=\"line\">    <span class=\"attr\">hikari:</span></span><br><span class=\"line\">      <span class=\"attr\">connection-timeout:</span> <span class=\"number\">30000</span> <span class=\"comment\">#毫秒，默认30秒</span></span><br><span class=\"line\">      <span class=\"attr\">idle-timeout:</span> <span class=\"number\">600000</span>      <span class=\"comment\">#毫秒，默认10分钟</span></span><br><span class=\"line\">      <span class=\"attr\">max-lifetime:</span> <span class=\"number\">1800000</span>     <span class=\"comment\">#毫秒，默认30分钟</span></span><br><span class=\"line\">      <span class=\"attr\">maximum-pool-size:</span> <span class=\"number\">10</span>     <span class=\"comment\">#默认10</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"WebSecurityConfig增加JdbcOAuth2AuthorizedClientService的配置\"><a href=\"#WebSecurityConfig增加JdbcOAuth2AuthorizedClientService的配置\" class=\"headerlink\" title=\"WebSecurityConfig增加JdbcOAuth2AuthorizedClientService的配置\"></a>WebSecurityConfig增加JdbcOAuth2AuthorizedClientService的配置</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* 基于数据库的客户端信息配置，认证数据会自动创建到数据表中</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"meta\">@Bean</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> OAuth2AuthorizedClientService <span class=\"title\">authorizedClientService</span><span class=\"params\">(JdbcOperations jdbcOperations, ClientRegistrationRepository clientRegistrationRepository)</span> </span>&#123;</span><br><span class=\"line\">    JdbcOAuth2AuthorizedClientService authorizedClientService =</span><br><span class=\"line\">            <span class=\"keyword\">new</span> JdbcOAuth2AuthorizedClientService(jdbcOperations, clientRegistrationRepository);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> authorizedClientService;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Autowired</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> OAuth2AuthorizedClientService oAuth2AuthorizedClientService;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//开启基于oauth2的客户端信息</span></span><br><span class=\"line\">http.oauth2Client()</span><br><span class=\"line\">        <span class=\"comment\">//客户端信息基于数据库，基于内存去掉下面配置即可</span></span><br><span class=\"line\">        .authorizedClientService(oAuth2AuthorizedClientService);</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n<h2 id=\"访问资源服务\"><a href=\"#访问资源服务\" class=\"headerlink\" title=\"访问资源服务\"></a>访问资源服务</h2><ul>\n<li>WebSecurityConfig配置类增加如下配置</li>\n<li>其目的就是在使用RestTemplate访问资源服务时，在请求头中增加Bearer Token<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 调用Resource Server服务使用RestTemplate，当调用的Resource Server时候我们时需要使用Bearer Token在头部传递Access Token；</span></span><br><span class=\"line\"><span class=\"comment\"> * RestTemplateAutoConfiguration已经给我们自动配置了RestTemplateBuilder来配置RestTemplate，我们需要通过RestTemplateCustomizer来对RestTemplate来定制</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"meta\">@Bean</span></span><br><span class=\"line\"><span class=\"function\">RestTemplateCustomizer <span class=\"title\">restTemplateCustomizer</span><span class=\"params\">(OAuth2AuthorizedClientService clientService)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> restTemplate -&gt; &#123; <span class=\"comment\">//1 RestTemplateCustomizer时函数接口，入参是RestTemplate</span></span><br><span class=\"line\">        List&lt;ClientHttpRequestInterceptor&gt; interceptors = restTemplate.getInterceptors();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (CollectionUtils.isEmpty(interceptors)) &#123;</span><br><span class=\"line\">            interceptors = <span class=\"keyword\">new</span> ArrayList&lt;&gt;();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        interceptors.add((request, body, execution) -&gt; &#123; <span class=\"comment\">//2 通过增加RestTemplate拦截器，让每次请求添加Bearer Token（Access Token）；ClientHttpRequestInterceptor是函数接口，可用Lambda表达式来实现</span></span><br><span class=\"line\">            OAuth2AuthenticationToken auth = (OAuth2AuthenticationToken)</span><br><span class=\"line\">                    SecurityContextHolder.getContext().getAuthentication();</span><br><span class=\"line\">            String clientRegistrationId = auth.getAuthorizedClientRegistrationId();</span><br><span class=\"line\">            String principalName = auth.getName();</span><br><span class=\"line\">            OAuth2AuthorizedClient client =</span><br><span class=\"line\">                    clientService.loadAuthorizedClient(clientRegistrationId, principalName); <span class=\"comment\">//3 OAuth2AuthorizedClientService可获得用户的OAuth2AuthorizedClient</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (client == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                <span class=\"comment\">//如果客户端信息使用的是基于内存的InMemoryOAuth2AuthorizedClientService，则重启服务器就会失效，需要重新登录才能恢复，</span></span><br><span class=\"line\">                <span class=\"comment\">// 建议使用基于数据库的JdbcOAuth2AuthorizedClientService，本例使用的就是JdbcOAuth2AuthorizedClientService</span></span><br><span class=\"line\">                <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> CustomException(HttpStatus.NOT_ACCEPTABLE, <span class=\"string\">&quot;用户状态异常，请重新登录&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            String accessToken = client.getAccessToken().getTokenValue(); <span class=\"comment\">//4 OAuth2AuthorizedClient可获得用户Access Token</span></span><br><span class=\"line\">            request.getHeaders().add(<span class=\"string\">&quot;Authorization&quot;</span>, <span class=\"string\">&quot;Bearer &quot;</span> + accessToken); <span class=\"comment\">//5 将Access Token通过头部的Bearer Token中访问Resource Server</span></span><br><span class=\"line\"></span><br><span class=\"line\">            log.info(String.format(<span class=\"string\">&quot;请求地址: %s&quot;</span>, request.getURI()));</span><br><span class=\"line\">            log.info(String.format(<span class=\"string\">&quot;请求头信息: %s&quot;</span>, request.getHeaders()));</span><br><span class=\"line\"></span><br><span class=\"line\">            ClientHttpResponse response = execution.execute(request, body);</span><br><span class=\"line\">            log.info(String.format(<span class=\"string\">&quot;响应头信息: %s&quot;</span>, response.getHeaders()));</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">return</span> response;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        restTemplate.setInterceptors(interceptors);</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"以ResController举例如何访问资源服务\"><a href=\"#以ResController举例如何访问资源服务\" class=\"headerlink\" title=\"以ResController举例如何访问资源服务\"></a>以ResController举例如何访问资源服务</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.example.oauth2clientdemo2.controller;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> com.example.oauth2clientdemo2.exception.AjaxResponse;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.boot.web.client.RestTemplateBuilder;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.client.RestTemplate;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Map;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * &lt;h1&gt;获取资源服务器数据&lt;/h1&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> * Created by hanqf on 2020/11/7 22:47.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@RestController</span></span><br><span class=\"line\"><span class=\"meta\">@RequestMapping(&quot;/res&quot;)</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ResController</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> RestTemplate restTemplate;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ResController</span><span class=\"params\">(RestTemplateBuilder restTemplateBuilder)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.restTemplate = restTemplateBuilder.build();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 获取资源服务器的数据</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">    <span class=\"meta\">@RequestMapping(&quot;/res1&quot;)</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> AjaxResponse <span class=\"title\">getRes</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> restTemplate.getForObject(<span class=\"string\">&quot;http://localhost:8082/res/res1&quot;</span>, AjaxResponse.class);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@RequestMapping(&quot;/user&quot;)</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> AjaxResponse <span class=\"title\">getUser</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> restTemplate.postForObject(<span class=\"string\">&quot;http://localhost:8082/user&quot;</span>,<span class=\"keyword\">null</span>, AjaxResponse.class);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@RequestMapping(&quot;/rbac&quot;)</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> AjaxResponse <span class=\"title\">getRbac</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> restTemplate.getForObject(<span class=\"string\">&quot;http://localhost:8082/rbac&quot;</span>, AjaxResponse.class);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@RequestMapping(&quot;/userInfo&quot;)</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Map&lt;String, Object&gt; <span class=\"title\">getuserInfo</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> restTemplate.getForObject(<span class=\"string\">&quot;http://localhost:8082/userInfo&quot;</span>, Map.class);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>","content_text":"摘要 通过本文，你将知道如何搭建一个基于SpringBoot-OAuth2-JWT的客户端服务器 本文基于springboot:2.4.0，项目基于Gradle-6.6.1构建 代码地址:https://github.com/hanqunfeng/springbootchapter/tree/master/chapter48 依赖 springboot官方提供了支持123456implementation &#x27;org.springframework.boot:spring-boot-starter-web&#x27;implementation &#x27;org.springframework.boot:spring-boot-starter-oauth2-client&#x27;//本项目中使用了lombok简少代码量，非必须依赖compileOnly &#x27;org.projectlombok:lombok&#x27;annotationProcessor &#x27;org.projectlombok:lombok&#x27; WebSecurityConfig springboot没有为client-server设置独立的注解和配置类，而是把这部分功能整合到了spring-security中1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980package com.example.oauth2clientdemo2.config;import com.example.oauth2clientdemo2.exception.CustomException;import com.example.oauth2clientdemo2.security.CustomAccessDeniedHandler;import lombok.extern.slf4j.Slf4j;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.beans.factory.annotation.Value;import org.springframework.boot.web.client.RestTemplateCustomizer;import org.springframework.context.annotation.Bean;import org.springframework.context.annotation.Configuration;import org.springframework.http.HttpStatus;import org.springframework.http.client.ClientHttpRequestInterceptor;import org.springframework.http.client.ClientHttpResponse;import org.springframework.jdbc.core.JdbcOperations;import org.springframework.security.config.annotation.web.builders.HttpSecurity;import org.springframework.security.config.annotation.web.builders.WebSecurity;import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;import org.springframework.security.core.context.SecurityContextHolder;import org.springframework.security.oauth2.client.JdbcOAuth2AuthorizedClientService;import org.springframework.security.oauth2.client.OAuth2AuthorizedClient;import org.springframework.security.oauth2.client.OAuth2AuthorizedClientService;import org.springframework.security.oauth2.client.authentication.OAuth2AuthenticationToken;import org.springframework.security.oauth2.client.registration.ClientRegistrationRepository;import org.springframework.util.CollectionUtils;import java.util.ArrayList;import java.util.List;/** * &lt;h1&gt;&lt;/h1&gt; * Created by hanqf on 2020/11/9 18:11. */@EnableWebSecurity@Configuration@Slf4jpublic class WebSecurityConfig extends WebSecurityConfigurerAdapter &#123; @Value(&quot;$&#123;oauth2.server.logout&#125;&quot;) private String oauth2_server_logout; @Autowired private CustomAccessDeniedHandler customAccessDeniedHandler; /** * 指定不拦截的路径规则 */ @Override public void configure(WebSecurity web) throws Exception &#123; //设置不需要拦截的路径，也就是不需要认证的路径 web.ignoring().antMatchers(&quot;/webjars/**&quot;); &#125; @Override protected void configure(HttpSecurity http) throws Exception &#123; //logout跳转到认证服务器的logout http.logout().logoutSuccessUrl(oauth2_server_logout); //配置认证规则 http.authorizeRequests() .mvcMatchers(&quot;/oauth/login&quot;).permitAll() ////所有路径都需要登录 .antMatchers(&quot;/&quot;).authenticated() ////需要具备相应的角色才能访问，这里返回的权限是scope，所以还是使用rbac验证吧 .antMatchers(&quot;/user/**&quot;, &quot;/user2/**&quot;).hasAuthority(&quot;SCOPE_any&quot;) .anyRequest().access(&quot;@rbacService.hasPerssion(request,authentication)&quot;); //开启oauth2登录认证 http.oauth2Login(); //开启基于oauth2的客户端信息 http.oauth2Client(); http.csrf().disable(); http.exceptionHandling().accessDeniedHandler(customAccessDeniedHandler); &#125;&#125; WebSecurityConfig说明与oauth2-client相关的代码就如下两行 12345 //开启oauth2登录认证http.oauth2Login();//开启基于oauth2的客户端信息http.oauth2Client(); 配置文件12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364oauth2: server: url: http://localhost:8080 logout: $&#123;oauth2.server.url&#125;/logout #可以实现单点登录，不能实现单点登出spring: #oauth2客户端配置，默认基于内存，如果基于数据库，需要在config配置类进行相应的配置 security: oauth2: client: registration: #支持多租户 # /postman/oauth2/authorization/my-client my-client: # 1 注册客户端名称，随意指定，但是要与provider的配置相一致 client-id: postman # 2 客户端ID client-secret: postman # 3 客户端密码 authorization-grant-type: authorization_code # 4 认证类型 #默认重定向URI模板是&#123;baseUrl&#125;/login/oauth2/code/&#123;registrationId&#125;。 #registrationId是ClientRegistration的唯一标识符。 redirect-uri: http://localhost:8088/postman/login/oauth2/code/my-client # 5 回调地址，需要配置到数据表中，默认写法，注意最后的路径是注册客户端名称 scope: any #请求范围 client-name: 客户端1 # /postman/oauth2/authorization/my-client2 my-client2: # 1 注册客户端名称，随意指定，但是要与provider的配置相一致 client-id: postman # 2 客户端ID client-secret: postman # 3 客户端密码 authorization-grant-type: authorization_code # 4 认证类型 redirect-uri: http://localhost:8088/postman/login/oauth2/code/my-client2 # 5 回调地址，需要配置到数据表中，默认写法，注意最后的路径是注册客户端名称 scope: any #请求范围 client-name: 客户端2 # CommonOAuth2Provider 中定义了google,facebook,github,okta的默认provider信息，所以这里不需要为其配置provider信息 # /postman/oauth2/authorization/google # 重定向后：https://accounts.google.com/o/oauth2/v2/auth?response_type=code&amp;client_id=xxxxxxxxx&amp;scope=openid%20profile%20email&amp;state=jO3PpuX2IzwOFemdd7FHBIHeeSPcxDwiP-mqDBTjdfw%3D&amp;redirect_uri=http://localhost:8088/postman/login/oauth2/code/google&amp;nonce=-sxhj2hjgrc7krSHSjL3qz_W90xPEX9nlP6SYzAfktY google: # google帐号认证，跳转到google登录页面 client-id: xxxxxxxxx # 客户端ID client-secret: xxxxxxx # 客户端密码 client-name: Google认证 # /postman/oauth2/authorization/facebook # https://www.facebook.com/v2.8/dialog/oauth?response_type=code&amp;client_id=xxxxxxxxx&amp;scope=public_profile%20email&amp;state=BVZM3OW2EUS82pbjJdpQfXvtXbFbMwaUe_lRMOt4BW4%3D&amp;redirect_uri=http://localhost:8088/postman/login/oauth2/code/facebook facebook: # facebook帐号登录，跳转到facebook登录页面 client-id: xxxxxxxxx # 客户端ID client-secret: xxxxxxx # 客户端密码 client-name: Facebook认证 # /postman/oauth2/authorization/github # 重定向后：https://github.com/login?client_id=xxxxxxxxx&amp;return_to=%2Flogin%2Foauth%2Fauthorize%3Fclient_id%3Dxxxxxxxxx%26redirect_uri%3Dhttp%253A%252F%252Flocalhost%253A8088%252Fpostman%252Flogin%252Foauth2%252Fcode%252Fgithub%26response_type%3Dcode%26scope%3Dread%253Auser%26state%3DmXtRWMQy8NaqVsFiie-NyYuy2z8OErrdq_VsuejDOPE%253D # api文档：https://docs.github.com/cn/free-pro-team@latest/rest github: # github帐号登录，跳转到github登录页面 client-id: xxxxxxxxx # 客户端ID client-secret: xxxxxxx # 客户端密码 client-name: Github认证 provider: my-client: # 6 注册客户端名称 authorization-uri: $&#123;oauth2.server.url&#125;/oauth/authorize # 7 认证地址 token-uri: $&#123;oauth2.server.url&#125;/oauth/token # 8 获取token地址 user-info-uri: http://localhost:8080/userInfo # 9 获取用户信息地址，必须配置 userNameAttribute: username # 10 指定用户信息中哪个属性是用户名称 my-client2: # 6 注册客户端名称 authorization-uri: $&#123;oauth2.server.url&#125;/oauth/authorize # 7 认证地址 token-uri: $&#123;oauth2.server.url&#125;/oauth/token # 8 获取token地址 user-info-uri: http://localhost:8080/userInfo # 9 获取用户信息地址，必须配置 userNameAttribute: username # 10 指定用户信息中哪个属性是用户名称 配置文件说明 springboot默认实现了google,facebook,github,okta的provider，但是其它认证服务器就需要自己指定provider信息。 这里需要为其指定user-info-uri，这个url提供认证用户的信息，需要认证服务端提供(也可以配置到受认证服务保护的资源服务中)，所以我们需要对认证服务进行改造 userNameAttribute表示从user-info-uri接口返回的信息中哪个属性名称表示用户名称 如果客户端信息只有一个，则访问当前客户端服务就会直接跳转到认证服务器的登录页面 如果客户端配置了多个，则会先跳转到login页面，需要选择要访问的认证服务器，后文有介绍如何自定义login页面 AuthServer改造UserController123456789101112131415161718192021222324252627package com.example.oauth2authserverdemo.controller;import org.springframework.security.core.Authentication;import org.springframework.security.oauth2.jwt.Jwt;import org.springframework.web.bind.annotation.RequestMapping;import org.springframework.web.bind.annotation.RestController;import java.util.HashMap;import java.util.Map;@RestControllerpublic class UserController &#123; @RequestMapping(&quot;/userInfo&quot;) public Map&lt;String, Object&gt; userInfo(Authentication authentication)&#123; Map&lt;String,Object&gt; map = new HashMap&lt;&gt;(); Object principal = authentication.getPrincipal(); if(principal instanceof Jwt)&#123; map.put(&quot;username&quot;, ((Jwt) principal).getClaim(&quot;user_name&quot;)); //客户端获取用户信息时，将附加信息一块返回给客户端 map.putAll(((Jwt) principal).getClaims()); &#125; return map; &#125;&#125; UserController说明 这个接口就是普通的controller接口，其返回一个map信息，里面至少包含一个用户名称信息。 因为client-server与auth-server之间是通过基于JWT的access-token进行访问的，所以这个接口实际上也是一个资源接口，需要为认证服务器配置资源服务。 SecurityConfig12345678910111213141516171819//认证服务器同时作为资源服务器，其目的是可以对外提供访问的资源，比如&quot;客户端认证获取用户信息&quot;//鉴权时只支持Bearer Token的形式，不支持url后加参数access_tokenhttp.oauth2ResourceServer().jwt() //开启oauth2资源认证 //默认情况下，权限是scope，而我们希望使用的是用户的角色，所以这里需要通过转换器进行处理 .jwtAuthenticationConverter(jwt -&gt; &#123; //通过自定义Converter来指定权限，Converter是函数接口，当前上下问参数为JWT对象 Collection&lt;SimpleGrantedAuthority&gt; authorities = ((Collection&lt;String&gt;) jwt.getClaims() .get(&quot;authorities&quot;)).stream() //获取JWT中的authorities .map(SimpleGrantedAuthority::new) .collect(Collectors.toSet()); //如果希望保留scope的权限，可以取出scope数据然后合并到一起，这样因为不是以ROLE_开头，所以需要使用hasAuthority(&#x27;SCOPE_any&#x27;)的形式 Collection&lt;SimpleGrantedAuthority&gt; scopes = ((Collection&lt;String&gt;) jwt.getClaims() .get(&quot;scope&quot;)).stream().map(scope -&gt; new SimpleGrantedAuthority(&quot;SCOPE_&quot; + scope)) .collect(Collectors.toSet()); //合并权限 authorities.addAll(scopes); return new JwtAuthenticationToken(jwt, authorities); &#125;); SecurityConfig说明 如果该接口是登录后就可以访问，只需要按如下配置即可：1http.oauth2ResourceServer().jwt(); 配置文件1234567spring: #oauth2 配置 security: oauth2: resourceserver: jwt: public-key-location: classpath:oauth2_key.pub 将公钥文件放到对应的路径下即可 自定义login页面 当客户端配置信息中指定了多个client时，访问当前服务时会先跳转到login页面，需要选择要访问哪个认证服务器。 依赖123456implementation &#x27;org.springframework.boot:spring-boot-starter-thymeleaf&#x27;//webjars https://www.webjars.orgimplementation &#x27;org.webjars:bootstrap:4.5.3&#x27;implementation &#x27;org.webjars.bower:jquery:3.5.1&#x27;// 可以在html中去掉webjars的版本号，这样升级的时候直接修改上面引入的webjars中的版本号即可，页面中不需要修改implementation &#x27;org.webjars:webjars-locator:0.40&#x27; LoginController12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849package com.example.oauth2clientdemo2.controller;import lombok.extern.log4j.Log4j2;import org.springframework.security.oauth2.client.registration.ClientRegistrationRepository;import org.springframework.security.oauth2.client.registration.InMemoryClientRegistrationRepository;import org.springframework.stereotype.Controller;import org.springframework.ui.Model;import org.springframework.web.bind.annotation.RequestMapping;import java.util.HashMap;import java.util.Map;/** * &lt;h1&gt;LoginController&lt;/h1&gt; * Created by hanqf on 2020/11/14 00:19. */@Controller@Log4j2public class LoginController &#123; private final ClientRegistrationRepository clientRegistrationRepository; public LoginController(ClientRegistrationRepository clientRegistrationRepository) &#123; this.clientRegistrationRepository = clientRegistrationRepository; &#125; /** * 自定义登录页面，多租户登录时先显示该页面，由用户选择要使用的认证服务 * @param model * @return */ @RequestMapping(&quot;/oauth/login&quot;) public String login(Model model)&#123; Map&lt;String,String&gt; map = new HashMap&lt;&gt;(); if(clientRegistrationRepository instanceof InMemoryClientRegistrationRepository)&#123; ((InMemoryClientRegistrationRepository)clientRegistrationRepository).forEach(registrations-&gt;&#123; String registrationId = registrations.getRegistrationId(); String clientName = registrations.getClientName(); map.put(registrationId,clientName); &#125;); &#125; model.addAttribute(&quot;registrations&quot;, map); return &quot;oauth2/login&quot;; &#125;&#125; login.html123456789101112131415161718192021222324252627&lt;!DOCTYPE html&gt;&lt;html lang=&quot;en&quot; xmlns:th=&quot;http://www.thymeleaf.org&quot;&gt;&lt;head&gt; &lt;meta charset=&quot;UTF-8&quot;/&gt; &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1, shrink-to-fit=no&quot;&gt; &lt;title&gt;登录&lt;/title&gt; &lt;link rel=&quot;stylesheet&quot; th:href=&quot;@&#123;/webjars/bootstrap/css/bootstrap.min.css&#125;&quot;/&gt; &lt;script th:src=&quot;@&#123;/webjars/jquery/jquery.min.js&#125;&quot;&gt;&lt;/script&gt; &lt;script th:src=&quot;@&#123;/webjars/bootstrap/js/bootstrap.min.js&#125;&quot;&gt;&lt;/script&gt;&lt;/head&gt;&lt;body&gt;&lt;div class=&quot;container&quot;&gt; &lt;h2 class=&quot;form-signin-heading&quot;&gt;Login with OAuth 2.0&lt;/h2&gt;&lt;table class=&quot;table table-striped&quot;&gt; &lt;tr th:each=&quot;registration: $&#123;registrations&#125;&quot;&gt; &lt;td&gt;&lt;a th:href=&quot;@&#123;&#x27;/oauth2/authorization/&#x27;+$&#123;registration.key&#125;&#125;&quot; th:text=&quot;$&#123;registration.value&#125;&quot;&gt;&lt;/a&gt;&lt;/td&gt; &lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt; WebSecurityConfig1234//开启oauth2登录认证http.oauth2Login() //自定义登录页面 .loginPage(&quot;/oauth/login&quot;); OAuth2AuthorizedClientService 默认每次客户端获取到的token信息都是存储在内存中的，如果服务器重启则token就会失效，可以将token保存到数据库中 创建数据表123456789101112131415# 客户端认证信息表，只需建表，数据会自动创建CREATE TABLE `oauth2_authorized_client` ( `client_registration_id` varchar(100) COLLATE utf8mb4_bin NOT NULL COMMENT &#x27;客户端注册Id&#x27;, `principal_name` varchar(200) COLLATE utf8mb4_bin NOT NULL COMMENT &#x27;登录用户名称&#x27;, `access_token_type` varchar(100) COLLATE utf8mb4_bin DEFAULT NULL COMMENT &#x27;验证类型，这里是bear&#x27;, `access_token_value` blob DEFAULT NULL COMMENT &#x27;access_token的值&#x27;, `access_token_issued_at` timestamp NOT NULL DEFAULT current_timestamp() ON UPDATE current_timestamp() COMMENT &#x27;access_token的创建时间&#x27;, `access_token_expires_at` timestamp NOT NULL DEFAULT &#x27;0000-00-00 00:00:00&#x27; COMMENT &#x27;access_token的过期时间&#x27;, `access_token_scopes` varchar(1000) COLLATE utf8mb4_bin DEFAULT NULL COMMENT &#x27;授权范围&#x27;, `refresh_token_value` blob DEFAULT NULL COMMENT &#x27;refresh_token的值&#x27;, `refresh_token_issued_at` timestamp NOT NULL DEFAULT &#x27;0000-00-00 00:00:00&#x27; COMMENT &#x27;refresh_token创建时间&#x27;, `created_at` timestamp NOT NULL DEFAULT current_timestamp() COMMENT &#x27;数据创建时间&#x27;, `update_at` timestamp NOT NULL DEFAULT current_timestamp() ON UPDATE current_timestamp() COMMENT &#x27;数据最后更新时间&#x27;, PRIMARY KEY (`client_registration_id`,`principal_name`) USING BTREE) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin; 添加数据库依赖1234//mysqlruntimeOnly &#x27;mysql:mysql-connector-java&#x27;//为了使用datasourceimplementation &#x27;org.springframework.boot:spring-boot-starter-jdbc&#x27; 配置文件添加数据库的配置123456789101112spring: #数据源配置 datasource: url: jdbc:mysql://localhost:3306/springboot?useUnicode=true&amp;characterEncoding=utf-8&amp;useTimezone=true&amp;serverTimezone=GMT%2B8 username: root password: newpwd driver-class-name: com.mysql.cj.jdbc.Driver hikari: connection-timeout: 30000 #毫秒，默认30秒 idle-timeout: 600000 #毫秒，默认10分钟 max-lifetime: 1800000 #毫秒，默认30分钟 maximum-pool-size: 10 #默认10 WebSecurityConfig增加JdbcOAuth2AuthorizedClientService的配置12345678910111213141516171819/*** 基于数据库的客户端信息配置，认证数据会自动创建到数据表中*/@Beanpublic OAuth2AuthorizedClientService authorizedClientService(JdbcOperations jdbcOperations, ClientRegistrationRepository clientRegistrationRepository) &#123; JdbcOAuth2AuthorizedClientService authorizedClientService = new JdbcOAuth2AuthorizedClientService(jdbcOperations, clientRegistrationRepository); return authorizedClientService;&#125;@Autowiredprivate OAuth2AuthorizedClientService oAuth2AuthorizedClientService;//开启基于oauth2的客户端信息http.oauth2Client() //客户端信息基于数据库，基于内存去掉下面配置即可 .authorizedClientService(oAuth2AuthorizedClientService); 访问资源服务 WebSecurityConfig配置类增加如下配置 其目的就是在使用RestTemplate访问资源服务时，在请求头中增加Bearer Token12345678910111213141516171819202122232425262728293031323334353637/** * 调用Resource Server服务使用RestTemplate，当调用的Resource Server时候我们时需要使用Bearer Token在头部传递Access Token； * RestTemplateAutoConfiguration已经给我们自动配置了RestTemplateBuilder来配置RestTemplate，我们需要通过RestTemplateCustomizer来对RestTemplate来定制 */@BeanRestTemplateCustomizer restTemplateCustomizer(OAuth2AuthorizedClientService clientService) &#123; return restTemplate -&gt; &#123; //1 RestTemplateCustomizer时函数接口，入参是RestTemplate List&lt;ClientHttpRequestInterceptor&gt; interceptors = restTemplate.getInterceptors(); if (CollectionUtils.isEmpty(interceptors)) &#123; interceptors = new ArrayList&lt;&gt;(); &#125; interceptors.add((request, body, execution) -&gt; &#123; //2 通过增加RestTemplate拦截器，让每次请求添加Bearer Token（Access Token）；ClientHttpRequestInterceptor是函数接口，可用Lambda表达式来实现 OAuth2AuthenticationToken auth = (OAuth2AuthenticationToken) SecurityContextHolder.getContext().getAuthentication(); String clientRegistrationId = auth.getAuthorizedClientRegistrationId(); String principalName = auth.getName(); OAuth2AuthorizedClient client = clientService.loadAuthorizedClient(clientRegistrationId, principalName); //3 OAuth2AuthorizedClientService可获得用户的OAuth2AuthorizedClient if (client == null) &#123; //如果客户端信息使用的是基于内存的InMemoryOAuth2AuthorizedClientService，则重启服务器就会失效，需要重新登录才能恢复， // 建议使用基于数据库的JdbcOAuth2AuthorizedClientService，本例使用的就是JdbcOAuth2AuthorizedClientService throw new CustomException(HttpStatus.NOT_ACCEPTABLE, &quot;用户状态异常，请重新登录&quot;); &#125; String accessToken = client.getAccessToken().getTokenValue(); //4 OAuth2AuthorizedClient可获得用户Access Token request.getHeaders().add(&quot;Authorization&quot;, &quot;Bearer &quot; + accessToken); //5 将Access Token通过头部的Bearer Token中访问Resource Server log.info(String.format(&quot;请求地址: %s&quot;, request.getURI())); log.info(String.format(&quot;请求头信息: %s&quot;, request.getHeaders())); ClientHttpResponse response = execution.execute(request, body); log.info(String.format(&quot;响应头信息: %s&quot;, response.getHeaders())); return response; &#125;); restTemplate.setInterceptors(interceptors); &#125;;&#125; 以ResController举例如何访问资源服务12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849package com.example.oauth2clientdemo2.controller;import com.example.oauth2clientdemo2.exception.AjaxResponse;import org.springframework.boot.web.client.RestTemplateBuilder;import org.springframework.web.bind.annotation.RequestMapping;import org.springframework.web.bind.annotation.RestController;import org.springframework.web.client.RestTemplate;import java.util.Map;/** * &lt;h1&gt;获取资源服务器数据&lt;/h1&gt; * Created by hanqf on 2020/11/7 22:47. */@RestController@RequestMapping(&quot;/res&quot;)public class ResController &#123; private RestTemplate restTemplate; public ResController(RestTemplateBuilder restTemplateBuilder) &#123; this.restTemplate = restTemplateBuilder.build(); &#125; /** * 获取资源服务器的数据 */ @RequestMapping(&quot;/res1&quot;) public AjaxResponse getRes()&#123; return restTemplate.getForObject(&quot;http://localhost:8082/res/res1&quot;, AjaxResponse.class); &#125; @RequestMapping(&quot;/user&quot;) public AjaxResponse getUser()&#123; return restTemplate.postForObject(&quot;http://localhost:8082/user&quot;,null, AjaxResponse.class); &#125; @RequestMapping(&quot;/rbac&quot;) public AjaxResponse getRbac()&#123; return restTemplate.getForObject(&quot;http://localhost:8082/rbac&quot;, AjaxResponse.class); &#125; @RequestMapping(&quot;/userInfo&quot;) public Map&lt;String, Object&gt; getuserInfo()&#123; return restTemplate.getForObject(&quot;http://localhost:8082/userInfo&quot;, Map.class); &#125;&#125;","summary":"摘要 通过本文，你将知道如何搭建一个基于SpringBoot-OAuth2-JWT的客户端服务器 本文基于springboot:2.4.0，项目基于Gradle-6.6.1构建 代码地址:https://github.com/hanqunfeng/springbootchapter/tree/master/chapter48","date_published":"2020-11-15T13:30:05.000Z","tags":["技术","springboot2","Java","springboot","oauth2","springsecurity","jwt"]},{"id":"https://blog.hanqunfeng.com/2020/11/15/springBoot-oauth2-jwt-resourcceserver/","url":"https://blog.hanqunfeng.com/2020/11/15/springBoot-oauth2-jwt-resourcceserver/","title":"SpringBoot-OAuth2-JWT-ResourceServer","content_html":"<h2 id=\"摘要\"><a href=\"#摘要\" class=\"headerlink\" title=\"摘要\"></a>摘要</h2><ul>\n<li>通过本文，你将知道如何搭建一个基于SpringBoot-OAuth2-JWT的资源服务器</li>\n<li>本文基于springboot:2.4.0，项目基于Gradle-6.6.1构建</li>\n<li>代码地址:<a href=\"https://github.com/hanqunfeng/springbootchapter/tree/master/chapter48\">https://github.com/hanqunfeng/springbootchapter/tree/master/chapter48</a></li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"依赖\"><a href=\"#依赖\" class=\"headerlink\" title=\"依赖\"></a>依赖</h2><ul>\n<li>springboot官方提供了支持<figure class=\"highlight gradle\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">implementation <span class=\"string\">&#x27;org.springframework.boot:spring-boot-starter-web&#x27;</span></span><br><span class=\"line\">implementation <span class=\"string\">&#x27;org.springframework.boot:spring-boot-starter-oauth2-resource-server&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//本项目中使用了lombok减代码量，非必须依赖</span></span><br><span class=\"line\">compileOnly <span class=\"string\">&#x27;org.projectlombok:lombok&#x27;</span></span><br><span class=\"line\">annotationProcessor <span class=\"string\">&#x27;org.projectlombok:lombok&#x27;</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h2 id=\"WebSecurityConfig\"><a href=\"#WebSecurityConfig\" class=\"headerlink\" title=\"WebSecurityConfig\"></a>WebSecurityConfig</h2><ul>\n<li>springboot没有为resource-server设置独立的注解和配置类，而是把这部分功能整合到了spring-security中<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.example.oauth2resourceserverdemo2.config;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> com.example.oauth2resourceserverdemo2.security.CustomAccessDeniedHandler;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.example.oauth2resourceserverdemo2.security.CustomAuthExceptionEntryPoint;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Bean;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.config.http.SessionCreationPolicy;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.core.authority.SimpleGrantedAuthority;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.oauth2.server.resource.authentication.JwtAuthenticationToken;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.cors.CorsConfiguration;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.cors.CorsConfigurationSource;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.cors.UrlBasedCorsConfigurationSource;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Collection;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.stream.Collectors;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * &lt;h1&gt;WebSecurityConfig&lt;/h1&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> * Created by hanqf on 2020/11/11 17:01.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@EnableGlobalMethodSecurity(prePostEnabled = true)</span></span><br><span class=\"line\"><span class=\"meta\">@EnableWebSecurity</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">WebSecurityConfig</span> <span class=\"keyword\">extends</span> <span class=\"title\">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> CustomAccessDeniedHandler customAccessDeniedHandler;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> CustomAuthExceptionEntryPoint customAuthExceptionEntryPoint;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">configure</span><span class=\"params\">(HttpSecurity http)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//开启跨域</span></span><br><span class=\"line\">        http.cors();</span><br><span class=\"line\">        http.sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//权限控制</span></span><br><span class=\"line\">        http.authorizeRequests()<span class=\"comment\">//登录成功就可以访问</span></span><br><span class=\"line\">                .antMatchers(<span class=\"string\">&quot;/res/**&quot;</span>, <span class=\"string\">&quot;/userInfo/**&quot;</span>).authenticated()</span><br><span class=\"line\">                <span class=\"comment\">//需要具备相应的角色才能访问</span></span><br><span class=\"line\">                .antMatchers(<span class=\"string\">&quot;/user/**&quot;</span>).hasAnyRole(<span class=\"string\">&quot;admin&quot;</span>, <span class=\"string\">&quot;user&quot;</span>)</span><br><span class=\"line\">                <span class=\"comment\">//不需要登录就可以访问</span></span><br><span class=\"line\">                .antMatchers(<span class=\"string\">&quot;/swagger-ui/**&quot;</span>, <span class=\"string\">&quot;/v3/api-docs**&quot;</span>).permitAll()</span><br><span class=\"line\">                <span class=\"comment\">//其它路径需要根据指定的方法判断是否有权限访问，基于权限管理模型认证</span></span><br><span class=\"line\">                .anyRequest().access(<span class=\"string\">&quot;@rbacService.hasPerssion(request,authentication)&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//鉴权时只支持Bearer Token的形式，不支持url后加参数access_token</span></span><br><span class=\"line\">        http.oauth2ResourceServer()<span class=\"comment\">//开启oauth2资源认证</span></span><br><span class=\"line\">                .jwt() <span class=\"comment\">//token为jwt</span></span><br><span class=\"line\">                <span class=\"comment\">//默认情况下，权限是scope，而我们希望使用的是用户的角色，所以这里需要通过转换器进行处理</span></span><br><span class=\"line\">                .jwtAuthenticationConverter(jwt -&gt; &#123; <span class=\"comment\">//通过自定义Converter来指定权限，Converter是函数接口，当前上下问参数为JWT对象</span></span><br><span class=\"line\">                    Collection&lt;SimpleGrantedAuthority&gt; authorities =</span><br><span class=\"line\">                            ((Collection&lt;String&gt;) jwt.getClaims()</span><br><span class=\"line\">                                    .get(<span class=\"string\">&quot;authorities&quot;</span>)).stream() <span class=\"comment\">//获取JWT中的authorities</span></span><br><span class=\"line\">                                    .map(SimpleGrantedAuthority::<span class=\"keyword\">new</span>)</span><br><span class=\"line\">                                    .collect(Collectors.toSet());</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"comment\">//如果希望保留scope的权限，可以取出scope数据然后合并到一起，这样因为不是以ROLE_开头，所以需要使用hasAuthority(&#x27;SCOPE_any&#x27;)的形式</span></span><br><span class=\"line\">                    Collection&lt;SimpleGrantedAuthority&gt; scopes = ((Collection&lt;String&gt;) jwt.getClaims()</span><br><span class=\"line\">                            .get(<span class=\"string\">&quot;scope&quot;</span>)).stream().map(scope -&gt; <span class=\"keyword\">new</span> SimpleGrantedAuthority(<span class=\"string\">&quot;SCOPE_&quot;</span> + scope))</span><br><span class=\"line\">                            .collect(Collectors.toSet());</span><br><span class=\"line\">                    <span class=\"comment\">//合并权限</span></span><br><span class=\"line\">                    authorities.addAll(scopes);</span><br><span class=\"line\">                    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> JwtAuthenticationToken(jwt, authorities);</span><br><span class=\"line\">                &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//这部分看代码吧，没啥可说的</span></span><br><span class=\"line\">        http.exceptionHandling()</span><br><span class=\"line\">                <span class=\"comment\">//access_token无效或过期时的处理方式</span></span><br><span class=\"line\">                .authenticationEntryPoint(customAuthExceptionEntryPoint)</span><br><span class=\"line\">                <span class=\"comment\">//access_token认证后没有对应的权限时的处理方式</span></span><br><span class=\"line\">                .accessDeniedHandler(customAccessDeniedHandler);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 跨域配置类</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@Bean</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> CorsConfigurationSource <span class=\"title\">corsConfigurationSource</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        CorsConfiguration corsConfiguration = <span class=\"keyword\">new</span> CorsConfiguration().applyPermitDefaultValues();</span><br><span class=\"line\">        <span class=\"comment\">//开放哪些ip、端口、域名的访问权限，星号表示开放所有域</span></span><br><span class=\"line\">        corsConfiguration.addAllowedOrigin(<span class=\"string\">&quot;*&quot;</span>);</span><br><span class=\"line\">        <span class=\"comment\">//corsConfiguration.setAllowedOrigins(Arrays.asList(&quot;http://localhost:8080&quot;,&quot;http://localhost:8081&quot;));</span></span><br><span class=\"line\">        <span class=\"comment\">//开放哪些Http方法，允许跨域访问</span></span><br><span class=\"line\">        corsConfiguration.addAllowedMethod(<span class=\"string\">&quot;*&quot;</span>);</span><br><span class=\"line\">        <span class=\"comment\">//corsConfiguration.setAllowedMethods(Arrays.asList(&quot;GET&quot;,&quot;POST&quot;, &quot;PUT&quot;, &quot;DELETE&quot;));</span></span><br><span class=\"line\">        <span class=\"comment\">//允许HTTP请求中的携带哪些Header信息</span></span><br><span class=\"line\">        corsConfiguration.addAllowedHeader(<span class=\"string\">&quot;*&quot;</span>);</span><br><span class=\"line\">        <span class=\"comment\">//是否允许发送Cookie信息</span></span><br><span class=\"line\">        corsConfiguration.setAllowCredentials(<span class=\"keyword\">true</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//添加映射路径，“/**”表示对所有的路径实行全局跨域访问权限的设置</span></span><br><span class=\"line\">        UrlBasedCorsConfigurationSource configSource = <span class=\"keyword\">new</span> UrlBasedCorsConfigurationSource();</span><br><span class=\"line\">        configSource.registerCorsConfiguration(<span class=\"string\">&quot;/**&quot;</span>, corsConfiguration);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> configSource;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"WebSecurityConfig说明\"><a href=\"#WebSecurityConfig说明\" class=\"headerlink\" title=\"WebSecurityConfig说明\"></a>WebSecurityConfig说明</h3><p>整体配置方式就是spring-security的配置方式，这里唯一的不同就是如下这部分代码：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//鉴权时只支持Bearer Token的形式，不支持url后加参数access_token</span></span><br><span class=\"line\">http.oauth2ResourceServer()<span class=\"comment\">//开启oauth2资源认证</span></span><br><span class=\"line\">        .jwt() <span class=\"comment\">//token为jwt</span></span><br><span class=\"line\">        <span class=\"comment\">//默认情况下，权限是scope，而我们希望使用的是用户的角色，所以这里需要通过转换器进行处理</span></span><br><span class=\"line\">        .jwtAuthenticationConverter(jwt -&gt; &#123; <span class=\"comment\">//通过自定义Converter来指定权限，Converter是函数接口，当前上下问参数为JWT对象</span></span><br><span class=\"line\">            Collection&lt;SimpleGrantedAuthority&gt; authorities =</span><br><span class=\"line\">                    ((Collection&lt;String&gt;) jwt.getClaims()</span><br><span class=\"line\">                            .get(<span class=\"string\">&quot;authorities&quot;</span>)).stream() <span class=\"comment\">//获取JWT中的authorities</span></span><br><span class=\"line\">                            .map(SimpleGrantedAuthority::<span class=\"keyword\">new</span>)</span><br><span class=\"line\">                            .collect(Collectors.toSet());</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//如果希望保留scope的权限，可以取出scope数据然后合并到一起，这样因为不是以ROLE_开头，所以需要使用hasAuthority(&#x27;SCOPE_any&#x27;)的形式</span></span><br><span class=\"line\">            Collection&lt;SimpleGrantedAuthority&gt; scopes = ((Collection&lt;String&gt;) jwt.getClaims()</span><br><span class=\"line\">                    .get(<span class=\"string\">&quot;scope&quot;</span>)).stream().map(scope -&gt; <span class=\"keyword\">new</span> SimpleGrantedAuthority(<span class=\"string\">&quot;SCOPE_&quot;</span> + scope))</span><br><span class=\"line\">                    .collect(Collectors.toSet());</span><br><span class=\"line\">            <span class=\"comment\">//合并权限</span></span><br><span class=\"line\">            authorities.addAll(scopes);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> JwtAuthenticationToken(jwt, authorities);</span><br><span class=\"line\">        &#125;);</span><br></pre></td></tr></table></figure>\n<ul>\n<li>一般情况下，我们只需要这样配置<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http.oauth2ResourceServer().jwt();</span><br></pre></td></tr></table></figure>\n此时就已经开启的oauth2资源服务器的支持，但是此时我们鉴权后获取到的权限是scope，这可能并不是我们希望的，所以我们可以为其指定一个转换器，从access_token的payload中获取<code>authorities</code>属性，并将其设置为用户的权限，如果我们还希望同时得到scope，则也可以再次取出<code>scope</code>的值放入用户的权限列表中。</li>\n</ul>\n<h2 id=\"配置文件\"><a href=\"#配置文件\" class=\"headerlink\" title=\"配置文件\"></a>配置文件</h2><figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">spring:</span></span><br><span class=\"line\">  <span class=\"comment\">#oauth2 配置</span></span><br><span class=\"line\">  <span class=\"attr\">security:</span></span><br><span class=\"line\">    <span class=\"attr\">oauth2:</span></span><br><span class=\"line\">      <span class=\"attr\">resourceserver:</span></span><br><span class=\"line\">        <span class=\"attr\">jwt:</span></span><br><span class=\"line\">          <span class=\"comment\"># 公钥文件路径</span></span><br><span class=\"line\">          <span class=\"comment\"># public-key-location: classpath:oauth2_key.pub</span></span><br><span class=\"line\"></span><br><span class=\"line\">          <span class=\"comment\"># 认证服务器提供的密钥验证路径，这种方式每次验证access_token都需要访问认证服务器</span></span><br><span class=\"line\">          <span class=\"attr\">jwk-set-uri:</span> <span class=\"string\">http://localhost:8080/.well-known/jwks.json</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"说明\"><a href=\"#说明\" class=\"headerlink\" title=\"说明\"></a>说明</h3><ul>\n<li>本项目基于jks等非对称密钥的方式</li>\n<li>密钥配置方式支持本地配置和认证服务器远程获取</li>\n<li>如果是基于本地配置的方式，则认证服务器什么都不需要做，但是如果是基于认证服务器远程获取的方式，则需要为认证服务器添加对应的功能。</li>\n</ul>\n<h2 id=\"AuthServer改造\"><a href=\"#AuthServer改造\" class=\"headerlink\" title=\"AuthServer改造\"></a>AuthServer改造</h2><h3 id=\"JwkSetEndpoint\"><a href=\"#JwkSetEndpoint\" class=\"headerlink\" title=\"JwkSetEndpoint\"></a>JwkSetEndpoint</h3><ul>\n<li>增加jwk-set验证端点，该功能就是为了获取公钥<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.example.oauth2authserverdemo.controller;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> com.example.oauth2authserverdemo.security.jwt.JwtTokenProperties;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.nimbusds.jose.jwk.JWKSet;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.nimbusds.jose.jwk.RSAKey;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.oauth2.provider.endpoint.FrameworkEndpoint;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.oauth2.provider.token.store.KeyStoreKeyFactory;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.security.KeyPair;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.security.interfaces.RSAPublicKey;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Map;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@FrameworkEndpoint</span> <span class=\"comment\">//@FrameworkEndpoint和@Controller相同功能，只用于框架提供的端点</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">JwkSetEndpoint</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> JwtTokenProperties jwtTokenProperties;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@GetMapping(&quot;/.well-known/jwks.json&quot;)</span></span><br><span class=\"line\">    <span class=\"meta\">@ResponseBody</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Map&lt;String, Object&gt; <span class=\"title\">getKey</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        KeyStoreKeyFactory keyStoreKeyFactory =</span><br><span class=\"line\">                <span class=\"keyword\">new</span> KeyStoreKeyFactory(jwtTokenProperties.getJksKeyFileResource(), jwtTokenProperties.getJksStorePassword().toCharArray());</span><br><span class=\"line\">        KeyPair keyPair = keyStoreKeyFactory.getKeyPair(jwtTokenProperties.getJksKeyAlias(), jwtTokenProperties.getJksKeyPassword().toCharArray());</span><br><span class=\"line\">        RSAPublicKey publicKey = (RSAPublicKey) keyPair.getPublic();</span><br><span class=\"line\">        RSAKey key = <span class=\"keyword\">new</span> RSAKey.Builder(publicKey).build();</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> JWKSet(key).toJSONObject();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"SecurityConfig开发对应的权限\"><a href=\"#SecurityConfig开发对应的权限\" class=\"headerlink\" title=\"SecurityConfig开发对应的权限\"></a>SecurityConfig开发对应的权限</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http.authorizeRequests()</span><br><span class=\"line\">       .antMatchers(customSecurityProperties.getPermitAll()).permitAll() <span class=\"comment\">//不用身份认证可以访问</span></span><br><span class=\"line\">       .mvcMatchers(<span class=\"string\">&quot;/.well-known/jwks.json&quot;</span>).permitAll() <span class=\"comment\">//开放JWK SET端点，提供给资源服务器访问获取公钥信息</span></span><br><span class=\"line\">       .anyRequest().authenticated(); <span class=\"comment\">//其它的请求要求必须有身份认证</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"资源，这里以UserController举例\"><a href=\"#资源，这里以UserController举例\" class=\"headerlink\" title=\"资源，这里以UserController举例\"></a>资源，这里以UserController举例</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.example.oauth2resourceserverdemo2.controller;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> com.example.oauth2resourceserverdemo2.exception.AjaxResponse;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.access.prepost.PreAuthorize;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.core.Authentication;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.oauth2.jwt.Jwt;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.security.Principal;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.HashMap;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Map;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@RestController</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">UserController</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//注意权限区分大小写</span></span><br><span class=\"line\">    <span class=\"meta\">@PreAuthorize(&quot;hasRole(&#x27;admin&#x27;) or hasRole(&#x27;user&#x27;)&quot;)</span></span><br><span class=\"line\">    <span class=\"comment\">//@PreAuthorize(&quot;#oauth2.hasScope(&#x27;any&#x27;)&quot;) //不支持oauth2表达式</span></span><br><span class=\"line\">    <span class=\"meta\">@RequestMapping(value = &quot;/user&quot;)</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> AjaxResponse <span class=\"title\">user</span><span class=\"params\">(Principal principal)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">//principal在经过security拦截后，是org.springframework.security.authentication.UsernamePasswordAuthenticationToken</span></span><br><span class=\"line\">        <span class=\"comment\">//在经OAuth2拦截后，是OAuth2Authentication</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> AjaxResponse.success(principal);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//注意权限区分大小写</span></span><br><span class=\"line\">    <span class=\"meta\">@PreAuthorize(&quot;hasAuthority(&#x27;SCOPE_any&#x27;)&quot;)</span></span><br><span class=\"line\">    <span class=\"meta\">@RequestMapping(value = &quot;/user2&quot;)</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> AjaxResponse <span class=\"title\">user2</span><span class=\"params\">(Principal principal)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">//principal在经过security拦截后，是org.springframework.security.authentication.UsernamePasswordAuthenticationToken</span></span><br><span class=\"line\">        <span class=\"comment\">//在经OAuth2拦截后，是OAuth2Authentication</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> AjaxResponse.success(principal);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 获取用户的claim信息</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">    <span class=\"meta\">@RequestMapping(&quot;/userInfo&quot;)</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Map&lt;String, Object&gt; <span class=\"title\">userInfo</span><span class=\"params\">(Authentication authentication)</span></span>&#123;</span><br><span class=\"line\">        Map&lt;String,Object&gt; map = <span class=\"keyword\">new</span> HashMap&lt;&gt;();</span><br><span class=\"line\">        Object principal = authentication.getPrincipal();</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(principal <span class=\"keyword\">instanceof</span> Jwt)&#123;</span><br><span class=\"line\">            map.put(<span class=\"string\">&quot;username&quot;</span>, ((Jwt) principal).getClaim(<span class=\"string\">&quot;user_name&quot;</span>));</span><br><span class=\"line\">            map.putAll(((Jwt) principal).getClaims());</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> map;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"资源服务器访问方式\"><a href=\"#资源服务器访问方式\" class=\"headerlink\" title=\"资源服务器访问方式\"></a>资源服务器访问方式</h2><ul>\n<li>通过access_token访问受保护的资源</li>\n</ul>\n<h3 id=\"只支持Bearer-Token\"><a href=\"#只支持Bearer-Token\" class=\"headerlink\" title=\"只支持Bearer Token\"></a>只支持Bearer Token</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://localhost:8082/user</span><br><span class=\"line\"></span><br><span class=\"line\"># 在请求的header中设置参数：参数名称：Authorization，值是`[grant_type] [access_token]`，grant_type值与access_token值之间用空格分开。例如：</span><br><span class=\"line\"></span><br><span class=\"line\">bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX25hbWUiOiJhZG1pbiIsImp3dC1leHQiOiJKV1Qg5omp5bGV5L-h5oGvIiwic2NvcGUiOlsiYW55Il0sImV4cCI6MTYwNDY1ODc4NiwiYXV0aG9yaXRpZXMiOlsiUk9MRV9hZG1pbiJdLCJqdGkiOiJjYjEzZjhmZC03NWRiLTRmODItOTkxOC00YzFjZGI3MDEwMGMiLCJjbGllbnRfaWQiOiJwb3N0bWFuIn0.W78nue0rPxB-Te7ZsxfzmTUYTasHHfQT0lMgAMG_i5g</span><br></pre></td></tr></table></figure>\n<p>使用Postman接口测试工具时，也可以使用其提供的认证功能[Authorization–&gt;TYPE–&gt; Bearer Token]，然后将access_token填入</p>\n","content_text":"摘要 通过本文，你将知道如何搭建一个基于SpringBoot-OAuth2-JWT的资源服务器 本文基于springboot:2.4.0，项目基于Gradle-6.6.1构建 代码地址:https://github.com/hanqunfeng/springbootchapter/tree/master/chapter48 依赖 springboot官方提供了支持123456implementation &#x27;org.springframework.boot:spring-boot-starter-web&#x27;implementation &#x27;org.springframework.boot:spring-boot-starter-oauth2-resource-server&#x27;//本项目中使用了lombok减代码量，非必须依赖compileOnly &#x27;org.projectlombok:lombok&#x27;annotationProcessor &#x27;org.projectlombok:lombok&#x27; WebSecurityConfig springboot没有为resource-server设置独立的注解和配置类，而是把这部分功能整合到了spring-security中123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107package com.example.oauth2resourceserverdemo2.config;import com.example.oauth2resourceserverdemo2.security.CustomAccessDeniedHandler;import com.example.oauth2resourceserverdemo2.security.CustomAuthExceptionEntryPoint;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.context.annotation.Bean;import org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;import org.springframework.security.config.annotation.web.builders.HttpSecurity;import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;import org.springframework.security.config.http.SessionCreationPolicy;import org.springframework.security.core.authority.SimpleGrantedAuthority;import org.springframework.security.oauth2.server.resource.authentication.JwtAuthenticationToken;import org.springframework.web.cors.CorsConfiguration;import org.springframework.web.cors.CorsConfigurationSource;import org.springframework.web.cors.UrlBasedCorsConfigurationSource;import java.util.Collection;import java.util.stream.Collectors;/** * &lt;h1&gt;WebSecurityConfig&lt;/h1&gt; * Created by hanqf on 2020/11/11 17:01. */@EnableGlobalMethodSecurity(prePostEnabled = true)@EnableWebSecuritypublic class WebSecurityConfig extends WebSecurityConfigurerAdapter &#123; @Autowired private CustomAccessDeniedHandler customAccessDeniedHandler; @Autowired private CustomAuthExceptionEntryPoint customAuthExceptionEntryPoint; @Override protected void configure(HttpSecurity http) throws Exception &#123; //开启跨域 http.cors(); http.sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS); //权限控制 http.authorizeRequests()//登录成功就可以访问 .antMatchers(&quot;/res/**&quot;, &quot;/userInfo/**&quot;).authenticated() //需要具备相应的角色才能访问 .antMatchers(&quot;/user/**&quot;).hasAnyRole(&quot;admin&quot;, &quot;user&quot;) //不需要登录就可以访问 .antMatchers(&quot;/swagger-ui/**&quot;, &quot;/v3/api-docs**&quot;).permitAll() //其它路径需要根据指定的方法判断是否有权限访问，基于权限管理模型认证 .anyRequest().access(&quot;@rbacService.hasPerssion(request,authentication)&quot;); //鉴权时只支持Bearer Token的形式，不支持url后加参数access_token http.oauth2ResourceServer()//开启oauth2资源认证 .jwt() //token为jwt //默认情况下，权限是scope，而我们希望使用的是用户的角色，所以这里需要通过转换器进行处理 .jwtAuthenticationConverter(jwt -&gt; &#123; //通过自定义Converter来指定权限，Converter是函数接口，当前上下问参数为JWT对象 Collection&lt;SimpleGrantedAuthority&gt; authorities = ((Collection&lt;String&gt;) jwt.getClaims() .get(&quot;authorities&quot;)).stream() //获取JWT中的authorities .map(SimpleGrantedAuthority::new) .collect(Collectors.toSet()); //如果希望保留scope的权限，可以取出scope数据然后合并到一起，这样因为不是以ROLE_开头，所以需要使用hasAuthority(&#x27;SCOPE_any&#x27;)的形式 Collection&lt;SimpleGrantedAuthority&gt; scopes = ((Collection&lt;String&gt;) jwt.getClaims() .get(&quot;scope&quot;)).stream().map(scope -&gt; new SimpleGrantedAuthority(&quot;SCOPE_&quot; + scope)) .collect(Collectors.toSet()); //合并权限 authorities.addAll(scopes); return new JwtAuthenticationToken(jwt, authorities); &#125;); //这部分看代码吧，没啥可说的 http.exceptionHandling() //access_token无效或过期时的处理方式 .authenticationEntryPoint(customAuthExceptionEntryPoint) //access_token认证后没有对应的权限时的处理方式 .accessDeniedHandler(customAccessDeniedHandler); &#125; /** * 跨域配置类 */ @Bean public CorsConfigurationSource corsConfigurationSource() &#123; CorsConfiguration corsConfiguration = new CorsConfiguration().applyPermitDefaultValues(); //开放哪些ip、端口、域名的访问权限，星号表示开放所有域 corsConfiguration.addAllowedOrigin(&quot;*&quot;); //corsConfiguration.setAllowedOrigins(Arrays.asList(&quot;http://localhost:8080&quot;,&quot;http://localhost:8081&quot;)); //开放哪些Http方法，允许跨域访问 corsConfiguration.addAllowedMethod(&quot;*&quot;); //corsConfiguration.setAllowedMethods(Arrays.asList(&quot;GET&quot;,&quot;POST&quot;, &quot;PUT&quot;, &quot;DELETE&quot;)); //允许HTTP请求中的携带哪些Header信息 corsConfiguration.addAllowedHeader(&quot;*&quot;); //是否允许发送Cookie信息 corsConfiguration.setAllowCredentials(true); //添加映射路径，“/**”表示对所有的路径实行全局跨域访问权限的设置 UrlBasedCorsConfigurationSource configSource = new UrlBasedCorsConfigurationSource(); configSource.registerCorsConfiguration(&quot;/**&quot;, corsConfiguration); return configSource; &#125;&#125; WebSecurityConfig说明整体配置方式就是spring-security的配置方式，这里唯一的不同就是如下这部分代码： 12345678910111213141516171819//鉴权时只支持Bearer Token的形式，不支持url后加参数access_tokenhttp.oauth2ResourceServer()//开启oauth2资源认证 .jwt() //token为jwt //默认情况下，权限是scope，而我们希望使用的是用户的角色，所以这里需要通过转换器进行处理 .jwtAuthenticationConverter(jwt -&gt; &#123; //通过自定义Converter来指定权限，Converter是函数接口，当前上下问参数为JWT对象 Collection&lt;SimpleGrantedAuthority&gt; authorities = ((Collection&lt;String&gt;) jwt.getClaims() .get(&quot;authorities&quot;)).stream() //获取JWT中的authorities .map(SimpleGrantedAuthority::new) .collect(Collectors.toSet()); //如果希望保留scope的权限，可以取出scope数据然后合并到一起，这样因为不是以ROLE_开头，所以需要使用hasAuthority(&#x27;SCOPE_any&#x27;)的形式 Collection&lt;SimpleGrantedAuthority&gt; scopes = ((Collection&lt;String&gt;) jwt.getClaims() .get(&quot;scope&quot;)).stream().map(scope -&gt; new SimpleGrantedAuthority(&quot;SCOPE_&quot; + scope)) .collect(Collectors.toSet()); //合并权限 authorities.addAll(scopes); return new JwtAuthenticationToken(jwt, authorities); &#125;); 一般情况下，我们只需要这样配置1http.oauth2ResourceServer().jwt(); 此时就已经开启的oauth2资源服务器的支持，但是此时我们鉴权后获取到的权限是scope，这可能并不是我们希望的，所以我们可以为其指定一个转换器，从access_token的payload中获取authorities属性，并将其设置为用户的权限，如果我们还希望同时得到scope，则也可以再次取出scope的值放入用户的权限列表中。 配置文件123456789101112spring: #oauth2 配置 security: oauth2: resourceserver: jwt: # 公钥文件路径 # public-key-location: classpath:oauth2_key.pub # 认证服务器提供的密钥验证路径，这种方式每次验证access_token都需要访问认证服务器 jwk-set-uri: http://localhost:8080/.well-known/jwks.json 说明 本项目基于jks等非对称密钥的方式 密钥配置方式支持本地配置和认证服务器远程获取 如果是基于本地配置的方式，则认证服务器什么都不需要做，但是如果是基于认证服务器远程获取的方式，则需要为认证服务器添加对应的功能。 AuthServer改造JwkSetEndpoint 增加jwk-set验证端点，该功能就是为了获取公钥12345678910111213141516171819202122232425262728293031323334package com.example.oauth2authserverdemo.controller;import com.example.oauth2authserverdemo.security.jwt.JwtTokenProperties;import com.nimbusds.jose.jwk.JWKSet;import com.nimbusds.jose.jwk.RSAKey;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.security.oauth2.provider.endpoint.FrameworkEndpoint;import org.springframework.security.oauth2.provider.token.store.KeyStoreKeyFactory;import org.springframework.web.bind.annotation.GetMapping;import org.springframework.web.bind.annotation.ResponseBody;import java.security.KeyPair;import java.security.interfaces.RSAPublicKey;import java.util.Map;@FrameworkEndpoint //@FrameworkEndpoint和@Controller相同功能，只用于框架提供的端点public class JwkSetEndpoint &#123; @Autowired private JwtTokenProperties jwtTokenProperties; @GetMapping(&quot;/.well-known/jwks.json&quot;) @ResponseBody public Map&lt;String, Object&gt; getKey() &#123; KeyStoreKeyFactory keyStoreKeyFactory = new KeyStoreKeyFactory(jwtTokenProperties.getJksKeyFileResource(), jwtTokenProperties.getJksStorePassword().toCharArray()); KeyPair keyPair = keyStoreKeyFactory.getKeyPair(jwtTokenProperties.getJksKeyAlias(), jwtTokenProperties.getJksKeyPassword().toCharArray()); RSAPublicKey publicKey = (RSAPublicKey) keyPair.getPublic(); RSAKey key = new RSAKey.Builder(publicKey).build(); return new JWKSet(key).toJSONObject(); &#125;&#125; SecurityConfig开发对应的权限1234http.authorizeRequests() .antMatchers(customSecurityProperties.getPermitAll()).permitAll() //不用身份认证可以访问 .mvcMatchers(&quot;/.well-known/jwks.json&quot;).permitAll() //开放JWK SET端点，提供给资源服务器访问获取公钥信息 .anyRequest().authenticated(); //其它的请求要求必须有身份认证 资源，这里以UserController举例123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051package com.example.oauth2resourceserverdemo2.controller;import com.example.oauth2resourceserverdemo2.exception.AjaxResponse;import org.springframework.security.access.prepost.PreAuthorize;import org.springframework.security.core.Authentication;import org.springframework.security.oauth2.jwt.Jwt;import org.springframework.web.bind.annotation.RequestMapping;import org.springframework.web.bind.annotation.RestController;import java.security.Principal;import java.util.HashMap;import java.util.Map;@RestControllerpublic class UserController &#123; //注意权限区分大小写 @PreAuthorize(&quot;hasRole(&#x27;admin&#x27;) or hasRole(&#x27;user&#x27;)&quot;) //@PreAuthorize(&quot;#oauth2.hasScope(&#x27;any&#x27;)&quot;) //不支持oauth2表达式 @RequestMapping(value = &quot;/user&quot;) public AjaxResponse user(Principal principal) &#123; //principal在经过security拦截后，是org.springframework.security.authentication.UsernamePasswordAuthenticationToken //在经OAuth2拦截后，是OAuth2Authentication return AjaxResponse.success(principal); &#125; //注意权限区分大小写 @PreAuthorize(&quot;hasAuthority(&#x27;SCOPE_any&#x27;)&quot;) @RequestMapping(value = &quot;/user2&quot;) public AjaxResponse user2(Principal principal) &#123; //principal在经过security拦截后，是org.springframework.security.authentication.UsernamePasswordAuthenticationToken //在经OAuth2拦截后，是OAuth2Authentication return AjaxResponse.success(principal); &#125; /** * 获取用户的claim信息 */ @RequestMapping(&quot;/userInfo&quot;) public Map&lt;String, Object&gt; userInfo(Authentication authentication)&#123; Map&lt;String,Object&gt; map = new HashMap&lt;&gt;(); Object principal = authentication.getPrincipal(); if(principal instanceof Jwt)&#123; map.put(&quot;username&quot;, ((Jwt) principal).getClaim(&quot;user_name&quot;)); map.putAll(((Jwt) principal).getClaims()); &#125; return map; &#125;&#125; 资源服务器访问方式 通过access_token访问受保护的资源 只支持Bearer Token12345http://localhost:8082/user# 在请求的header中设置参数：参数名称：Authorization，值是`[grant_type] [access_token]`，grant_type值与access_token值之间用空格分开。例如：bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX25hbWUiOiJhZG1pbiIsImp3dC1leHQiOiJKV1Qg5omp5bGV5L-h5oGvIiwic2NvcGUiOlsiYW55Il0sImV4cCI6MTYwNDY1ODc4NiwiYXV0aG9yaXRpZXMiOlsiUk9MRV9hZG1pbiJdLCJqdGkiOiJjYjEzZjhmZC03NWRiLTRmODItOTkxOC00YzFjZGI3MDEwMGMiLCJjbGllbnRfaWQiOiJwb3N0bWFuIn0.W78nue0rPxB-Te7ZsxfzmTUYTasHHfQT0lMgAMG_i5g 使用Postman接口测试工具时，也可以使用其提供的认证功能[Authorization–&gt;TYPE–&gt; Bearer Token]，然后将access_token填入","summary":"摘要 通过本文，你将知道如何搭建一个基于SpringBoot-OAuth2-JWT的资源服务器 本文基于springboot:2.4.0，项目基于Gradle-6.6.1构建 代码地址:https://github.com/hanqunfeng/springbootchapter/tree/master/chapter48","date_published":"2020-11-15T12:30:05.000Z","tags":["技术","springboot2","Java","springboot","oauth2","springsecurity","jwt"]},{"id":"https://blog.hanqunfeng.com/2020/11/15/springboot-oauth2-jwt-authserver/","url":"https://blog.hanqunfeng.com/2020/11/15/springboot-oauth2-jwt-authserver/","title":"SpringBoot-OAuth2-JWT-AuthServer","content_html":"<h2 id=\"摘要\"><a href=\"#摘要\" class=\"headerlink\" title=\"摘要\"></a>摘要</h2><ul>\n<li>通过本文，你将知道如何搭建一个基于SpringBoot-OAuth2-JWT的认证服务器</li>\n<li>本文基于springboot:2.4.0，项目基于Gradle-6.6.1构建</li>\n<li>代码地址:<a href=\"https://github.com/hanqunfeng/springbootchapter/tree/master/chapter48\">https://github.com/hanqunfeng/springbootchapter/tree/master/chapter48</a></li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"依赖\"><a href=\"#依赖\" class=\"headerlink\" title=\"依赖\"></a>依赖</h2><figure class=\"highlight gradle\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">implementation <span class=\"string\">&#x27;org.springframework.boot:spring-boot-starter-web&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//SpringBoot官方没有提供对认证服务的支持，需要自己搭建，</span></span><br><span class=\"line\"><span class=\"comment\">//我们可以使用SpringSecurity提供的spring-security-oauth2-autoconfigure进行搭建，</span></span><br><span class=\"line\"><span class=\"comment\">//不过SpringSecurity OAuth2项目目前已被弃用，SpringSecurity团队已决定不再为授权服务器提供支持,</span></span><br><span class=\"line\"><span class=\"comment\">//所以，在这个版本里你会看到很多弃用的类，如果不想看到类名称上出现烦人的横线，可以使用2.2.10这个版本，测试过程也没发现什么问题的。</span></span><br><span class=\"line\">implementation <span class=\"string\">&#x27;org.springframework.security.oauth.boot:spring-security-oauth2-autoconfigure:2.3.4.RELEASE&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//本项目中使用了lombok简少代码量，非必须依赖</span></span><br><span class=\"line\">compileOnly <span class=\"string\">&#x27;org.projectlombok:lombok&#x27;</span></span><br><span class=\"line\">annotationProcessor <span class=\"string\">&#x27;org.projectlombok:lombok&#x27;</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"代码说明\"><a href=\"#代码说明\" class=\"headerlink\" title=\"代码说明\"></a>代码说明</h2><h3 id=\"SecurityConfig\"><a href=\"#SecurityConfig\" class=\"headerlink\" title=\"SecurityConfig\"></a>SecurityConfig</h3><ul>\n<li><p>用于配置可以登录系统的用户及其权限，也就是认证服务器的用户</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.example.oauth2authserverdemo.config;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> com.example.oauth2authserverdemo.security.CustomSecurityProperties;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Bean;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Configuration;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.authentication.AuthenticationManager;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.config.BeanIds;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.config.annotation.web.builders.WebSecurity;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.config.http.SessionCreationPolicy;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.core.authority.SimpleGrantedAuthority;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.core.userdetails.User;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.crypto.password.PasswordEncoder;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.oauth2.server.resource.authentication.JwtAuthenticationToken;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.provisioning.InMemoryUserDetailsManager;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.cors.CorsConfiguration;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.cors.CorsConfigurationSource;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.cors.UrlBasedCorsConfigurationSource;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Collection;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.stream.Collectors;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Spring-Security配置类,继承WebSecurityConfigurerAdapter</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"meta\">@Configuration</span></span><br><span class=\"line\"><span class=\"meta\">@EnableWebSecurity</span></span><br><span class=\"line\"><span class=\"meta\">@EnableGlobalMethodSecurity(prePostEnabled = true)</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">SecurityConfig</span> <span class=\"keyword\">extends</span> <span class=\"title\">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> CustomSecurityProperties customSecurityProperties;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 引入密码加密类</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span></span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@Bean</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> PasswordEncoder <span class=\"title\">passwordEncoder</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> BCryptPasswordEncoder();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 为了测试方便，这里使用内存用户模型，真实系统请使用基于RBAC的权限模型</span></span><br><span class=\"line\"><span class=\"comment\">     * 用户策略设置，这里使用内存用户策略，自定义策略需要实现UserDetailsService接口</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"meta\">@Bean</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> UserDetailsService <span class=\"title\">userDetailsService</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        InMemoryUserDetailsManager inMemoryUserDetailsManager = <span class=\"keyword\">new</span> InMemoryUserDetailsManager();</span><br><span class=\"line\">        User.UserBuilder builder = User.builder().passwordEncoder(passwordEncoder()::encode);</span><br><span class=\"line\">        inMemoryUserDetailsManager.createUser(builder.username(<span class=\"string\">&quot;admin&quot;</span>).password(<span class=\"string\">&quot;123456&quot;</span>).roles(<span class=\"string\">&quot;admin&quot;</span>).build());</span><br><span class=\"line\">        inMemoryUserDetailsManager.createUser(builder.username(<span class=\"string\">&quot;guest&quot;</span>).password(<span class=\"string\">&quot;123456&quot;</span>).roles(<span class=\"string\">&quot;guest&quot;</span>).build());</span><br><span class=\"line\">        inMemoryUserDetailsManager.createUser(builder.username(<span class=\"string\">&quot;user&quot;</span>).password(<span class=\"string\">&quot;123456&quot;</span>).roles(<span class=\"string\">&quot;user&quot;</span>).build());</span><br><span class=\"line\">        <span class=\"keyword\">return</span> inMemoryUserDetailsManager;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 指定不拦截的路径规则</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">configure</span><span class=\"params\">(WebSecurity web)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">//设置不需要拦截的路径，也就是不需要认证的路径</span></span><br><span class=\"line\">        web.ignoring().antMatchers(customSecurityProperties.getIgnoring());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 配置URL访问授权,必须配置authorizeRequests(),否则启动报错,说是没有启用security技术。</span></span><br><span class=\"line\"><span class=\"comment\">     * 注意:在这里的身份进行认证与授权没有涉及到OAuth的技术：当访问要授权的URL时,请求会被DelegatingFilterProxy拦截,</span></span><br><span class=\"line\"><span class=\"comment\">     * 如果还没有授权,请求就会被重定向到登录界面。在登录成功(身份认证并授权)后,请求被重定向至之前访问的URL。</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> http</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@throws</span> Exception</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">configure</span><span class=\"params\">(HttpSecurity http)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\">        http.formLogin()</span><br><span class=\"line\">                .permitAll(); <span class=\"comment\">//登记界面，默认是permitAll</span></span><br><span class=\"line\"></span><br><span class=\"line\">        http.authorizeRequests()</span><br><span class=\"line\">                .antMatchers(customSecurityProperties.getPermitAll()).permitAll() <span class=\"comment\">//不用身份认证可以访问</span></span><br><span class=\"line\">                .anyRequest().authenticated(); <span class=\"comment\">//其它的请求要求必须有身份认证</span></span><br><span class=\"line\"></span><br><span class=\"line\">        http.csrf().disable();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//开启跨域</span></span><br><span class=\"line\">        http.cors();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// session管理</span></span><br><span class=\"line\">        http.sessionManagement()</span><br><span class=\"line\">                .sessionCreationPolicy(SessionCreationPolicy.IF_REQUIRED);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 支持 password 模式(配置)</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span></span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@throws</span> Exception</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@Bean(name = BeanIds.AUTHENTICATION_MANAGER)</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> AuthenticationManager <span class=\"title\">authenticationManagerBean</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">super</span>.authenticationManagerBean();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 跨域配置类</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@Bean</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> CorsConfigurationSource <span class=\"title\">corsConfigurationSource</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        CorsConfiguration corsConfiguration = <span class=\"keyword\">new</span> CorsConfiguration().applyPermitDefaultValues();</span><br><span class=\"line\">        <span class=\"comment\">//开放哪些ip、端口、域名的访问权限，星号表示开放所有域</span></span><br><span class=\"line\">        corsConfiguration.addAllowedOrigin(<span class=\"string\">&quot;*&quot;</span>);</span><br><span class=\"line\">        <span class=\"comment\">//corsConfiguration.setAllowedOrigins(Arrays.asList(&quot;http://localhost:8080&quot;,&quot;http://localhost:8081&quot;));</span></span><br><span class=\"line\">        <span class=\"comment\">//开放哪些Http方法，允许跨域访问</span></span><br><span class=\"line\">        corsConfiguration.addAllowedMethod(<span class=\"string\">&quot;*&quot;</span>);</span><br><span class=\"line\">        <span class=\"comment\">//corsConfiguration.setAllowedMethods(Arrays.asList(&quot;GET&quot;,&quot;POST&quot;, &quot;PUT&quot;, &quot;DELETE&quot;));</span></span><br><span class=\"line\">        <span class=\"comment\">//允许HTTP请求中的携带哪些Header信息</span></span><br><span class=\"line\">        corsConfiguration.addAllowedHeader(<span class=\"string\">&quot;*&quot;</span>);</span><br><span class=\"line\">        <span class=\"comment\">//是否允许发送Cookie信息</span></span><br><span class=\"line\">        corsConfiguration.setAllowCredentials(<span class=\"keyword\">true</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//添加映射路径，“/**”表示对所有的路径实行全局跨域访问权限的设置</span></span><br><span class=\"line\">        UrlBasedCorsConfigurationSource configSource = <span class=\"keyword\">new</span> UrlBasedCorsConfigurationSource();</span><br><span class=\"line\">        configSource.registerCorsConfiguration(<span class=\"string\">&quot;/**&quot;</span>, corsConfiguration);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> configSource;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"CustomSecurityProperties\"><a href=\"#CustomSecurityProperties\" class=\"headerlink\" title=\"CustomSecurityProperties\"></a>CustomSecurityProperties</h3></li>\n<li><p>自定义属性配置类</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Data</span></span><br><span class=\"line\"><span class=\"meta\">@ConfigurationProperties(prefix = &quot;security&quot;)</span></span><br><span class=\"line\"><span class=\"meta\">@Component</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">CustomSecurityProperties</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 不需要验证的路径数组</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> String[] permitAll;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 不需要拦截的路径数组</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> String[] ignoring;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n<li><p>配置文件：</p>\n<figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#springsecurity 自定义属性</span></span><br><span class=\"line\"><span class=\"attr\">security:</span></span><br><span class=\"line\">  <span class=\"comment\">#不需要验证的路径</span></span><br><span class=\"line\">  <span class=\"attr\">permitAll:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">/redirect/**</span></span><br><span class=\"line\">  <span class=\"attr\">ignoring:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">/webjars/**</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">/**/*.js/</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">/**/*.css</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">/static/**</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"AuthServerConfig\"><a href=\"#AuthServerConfig\" class=\"headerlink\" title=\"AuthServerConfig\"></a>AuthServerConfig</h3><ul>\n<li>认证服务器的token关联，本例基于jwt</li>\n<li>注意这里定义的是抽象类，还没有声明客户端的配置，具体参加下文说明<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.example.oauth2authserverdemo.config;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.http.HttpMethod;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.authentication.AuthenticationManager;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.crypto.password.PasswordEncoder;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.AuthorizationServerConfigurerAdapter;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.oauth2.config.annotation.web.configurers.AuthorizationServerEndpointsConfigurer;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.oauth2.config.annotation.web.configurers.AuthorizationServerSecurityConfigurer;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.oauth2.provider.token.TokenEnhancer;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.oauth2.provider.token.TokenEnhancerChain;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.oauth2.provider.token.TokenStore;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.oauth2.provider.token.store.JwtAccessTokenConverter;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.ArrayList;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.List;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">abstract</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">AuthServerConfig</span> <span class=\"keyword\">extends</span> <span class=\"title\">AuthorizationServerConfigurerAdapter</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> UserDetailsService userDetailsService;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> AuthenticationManager authenticationManager;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> TokenStore jwtTokenStore;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> JwtAccessTokenConverter jwtAccessTokenConverter;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> TokenEnhancer jwtTokenEnhancer;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> PasswordEncoder passwordEncoder;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 1.增加jwt 增强模式</span></span><br><span class=\"line\"><span class=\"comment\">     * 2.调用userDetailsService实现UserDetailsService接口,对客户端信息进行认证与授权</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> endpoints</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@throws</span> Exception</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">configure</span><span class=\"params\">(AuthorizationServerEndpointsConfigurer endpoints)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">//   jwt 增强模式</span></span><br><span class=\"line\">        <span class=\"comment\">//   对令牌的增强操作就在enhance方法中</span></span><br><span class=\"line\">        <span class=\"comment\">//   面在配置类中,将TokenEnhancer和JwtAccessConverter加到一个enhancerChain中</span></span><br><span class=\"line\">        <span class=\"comment\">//</span></span><br><span class=\"line\">        <span class=\"comment\">//   通俗点讲它做了两件事：</span></span><br><span class=\"line\">        <span class=\"comment\">//   给JWT令牌中设置附加信息和jti：jwt的唯一身份标识,主要用来作为一次性token,从而回避重放攻击</span></span><br><span class=\"line\">        <span class=\"comment\">//   判断请求中是否有refreshToken,如果有,就重新设置refreshToken并加入附加信息</span></span><br><span class=\"line\">        TokenEnhancerChain enhancerChain = <span class=\"keyword\">new</span> TokenEnhancerChain();</span><br><span class=\"line\">        List&lt;TokenEnhancer&gt; enhancerList = <span class=\"keyword\">new</span> ArrayList&lt;TokenEnhancer&gt;();</span><br><span class=\"line\">        enhancerList.add(jwtTokenEnhancer);</span><br><span class=\"line\">        enhancerList.add(jwtAccessTokenConverter);</span><br><span class=\"line\">        enhancerChain.setTokenEnhancers(enhancerList); <span class=\"comment\">//将自定义Enhancer加入EnhancerChain的delegates数组中</span></span><br><span class=\"line\"></span><br><span class=\"line\">        endpoints</span><br><span class=\"line\">                <span class=\"comment\">//设置tokenStore</span></span><br><span class=\"line\">                .tokenStore(jwtTokenStore)</span><br><span class=\"line\">                <span class=\"comment\">//支持 refresh_token 模式</span></span><br><span class=\"line\">                .userDetailsService(userDetailsService)</span><br><span class=\"line\">                <span class=\"comment\">//支持 password 模式</span></span><br><span class=\"line\">                .authenticationManager(authenticationManager)</span><br><span class=\"line\">                <span class=\"comment\">//token扩展属性</span></span><br><span class=\"line\">                .tokenEnhancer(enhancerChain)</span><br><span class=\"line\">                <span class=\"comment\">//设置token转换器</span></span><br><span class=\"line\">                .accessTokenConverter(jwtAccessTokenConverter)</span><br><span class=\"line\">                <span class=\"comment\">//设置每次通过refresh_token获取新的access_token时，是否重新生成一个新的refresh_token。</span></span><br><span class=\"line\">                <span class=\"comment\">//默认true，不重新生成</span></span><br><span class=\"line\">                <span class=\"comment\">//.reuseRefreshTokens(true)</span></span><br><span class=\"line\">                <span class=\"comment\">//设置允许处理的请求类型</span></span><br><span class=\"line\">                .allowedTokenEndpointRequestMethods(HttpMethod.GET,HttpMethod.POST);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">configure</span><span class=\"params\">(AuthorizationServerSecurityConfigurer security)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\">        security</span><br><span class=\"line\">                <span class=\"comment\">//获取公钥的请求全部允许</span></span><br><span class=\"line\">                .tokenKeyAccess(<span class=\"string\">&quot;permitAll()&quot;</span>)</span><br><span class=\"line\">                <span class=\"comment\">//验证token有效性的请求需要先登录认证</span></span><br><span class=\"line\">                .checkTokenAccess(<span class=\"string\">&quot;isAuthenticated()&quot;</span>)</span><br><span class=\"line\">                <span class=\"comment\">//允许客户端form表单认证，就是可以将client_id和client_secret放到form中提交，否则必须使用Basic认证</span></span><br><span class=\"line\">                .allowFormAuthenticationForClients();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"JwtTokenConfig\"><a href=\"#JwtTokenConfig\" class=\"headerlink\" title=\"JwtTokenConfig\"></a>JwtTokenConfig</h3><ul>\n<li>本例基于JWTToken</li>\n<li>支持两种密钥策略，对称密钥和基于jks证书的非对称密钥<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.example.oauth2authserverdemo.config;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> com.example.oauth2authserverdemo.security.jwt.JWTokenEnhancer;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.example.oauth2authserverdemo.security.jwt.JwtTokenProperties;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Bean;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Configuration;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.oauth2.provider.token.TokenEnhancer;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.oauth2.provider.token.TokenStore;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.oauth2.provider.token.store.JwtAccessTokenConverter;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.oauth2.provider.token.store.JwtTokenStore;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.oauth2.provider.token.store.KeyStoreKeyFactory;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * JwtTokenConfig配置类</span></span><br><span class=\"line\"><span class=\"comment\"> * 使用TokenStore将引入JwtTokenStore</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> * 注：Spring-Sceurity使用TokenEnhancer和JwtAccessConverter增强jwt令牌</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"meta\">@Configuration</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">JwtTokenConfig</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> JwtTokenProperties jwtTokenProperties;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Bean</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> TokenStore <span class=\"title\">jwtTokenStore</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> JwtTokenStore(jwtAccessTokenConverter());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * JwtAccessTokenConverter：TokenEnhancer的子类,帮助程序在JWT编码的令牌值和OAuth身份验证信息之间进行转换(在两个方向上),同时充当TokenEnhancer授予令牌的时间。</span></span><br><span class=\"line\"><span class=\"comment\">     * 自定义的JwtAccessTokenConverter：把自己设置的jwt签名加入accessTokenConverter中(这里设置&#x27;demo&#x27;,项目可将此在配置文件设置)</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span></span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@Bean</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> JwtAccessTokenConverter <span class=\"title\">jwtAccessTokenConverter</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        JwtAccessTokenConverter accessTokenConverter = <span class=\"keyword\">new</span> JwtAccessTokenConverter();</span><br><span class=\"line\"></span><br><span class=\"line\">        String type = jwtTokenProperties.getType();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">switch</span> (type)&#123;</span><br><span class=\"line\">            <span class=\"keyword\">case</span> <span class=\"string\">&quot;secret&quot;</span>:</span><br><span class=\"line\">                <span class=\"comment\">//设置加密token的密码</span></span><br><span class=\"line\">                accessTokenConverter.setSigningKey(jwtTokenProperties.getSecret());</span><br><span class=\"line\">                <span class=\"comment\">//实际上资源服务器只需要设置验证token的密码</span></span><br><span class=\"line\">                accessTokenConverter.setVerifierKey(jwtTokenProperties.getSecret());</span><br><span class=\"line\">                <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            <span class=\"keyword\">case</span> <span class=\"string\">&quot;jks&quot;</span>:</span><br><span class=\"line\">                <span class=\"comment\">//非对称加密,jks证书</span></span><br><span class=\"line\">                KeyStoreKeyFactory keyStoreKeyFactory =</span><br><span class=\"line\">                        <span class=\"keyword\">new</span> KeyStoreKeyFactory(jwtTokenProperties.getJksKeyFileResource(), jwtTokenProperties.getJksStorePassword().toCharArray());</span><br><span class=\"line\">                accessTokenConverter.setKeyPair(keyStoreKeyFactory.getKeyPair(jwtTokenProperties.getJksKeyAlias(),jwtTokenProperties.getJksKeyPassword().toCharArray()));</span><br><span class=\"line\">                <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            <span class=\"keyword\">default</span>:</span><br><span class=\"line\">                <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> RuntimeException(<span class=\"string\">&quot;请正确配置密钥类型:secret,jks&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> accessTokenConverter;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 引入自定义JWTokenEnhancer:</span></span><br><span class=\"line\"><span class=\"comment\">     * 自定义JWTokenEnhancer实现TokenEnhancer并重写enhance方法,将附加信息加入oAuth2AccessToken中</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span></span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@Bean</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> TokenEnhancer <span class=\"title\">jwtTokenEnhancer</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">       <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> JWTokenEnhancer();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"JWTokenEnhancer\"><a href=\"#JWTokenEnhancer\" class=\"headerlink\" title=\"JWTokenEnhancer\"></a>JWTokenEnhancer</h3><ul>\n<li>jwt自定义属性<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.example.oauth2authserverdemo.security.jwt;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.core.userdetails.User;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.oauth2.common.DefaultOAuth2AccessToken;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.oauth2.common.OAuth2AccessToken;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.oauth2.provider.OAuth2Authentication;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.oauth2.provider.token.TokenEnhancer;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.HashMap;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Map;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * TokenEnhancer：在AuthorizationServerTokenServices 实现存储访问令牌之前增强访问令牌的策略。</span></span><br><span class=\"line\"><span class=\"comment\"> * 自定义TokenEnhancer的代码：把附加信息加入oAuth2AccessToken中</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">JWTokenEnhancer</span> <span class=\"keyword\">implements</span> <span class=\"title\">TokenEnhancer</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 重写enhance方法,将附加信息加入oAuth2AccessToken中</span></span><br><span class=\"line\"><span class=\"comment\">     * 这里只是提供附加信息的方式，没需要可以不配置这个类</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> oAuth2AccessToken</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> oAuth2Authentication</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span></span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> OAuth2AccessToken <span class=\"title\">enhance</span><span class=\"params\">(OAuth2AccessToken oAuth2AccessToken, OAuth2Authentication oAuth2Authentication)</span> </span>&#123;</span><br><span class=\"line\">        Map&lt;String, Object&gt; map = <span class=\"keyword\">new</span> HashMap&lt;String, Object&gt;();</span><br><span class=\"line\">        User user = (User) oAuth2Authentication.getUserAuthentication().getPrincipal();</span><br><span class=\"line\">        map.put(<span class=\"string\">&quot;_username&quot;</span>, user.getUsername());</span><br><span class=\"line\">        map.put(<span class=\"string\">&quot;_authorities&quot;</span>, user.getAuthorities());</span><br><span class=\"line\">        map.put(<span class=\"string\">&quot;_jwt-ext&quot;</span>, <span class=\"string\">&quot;JWT 扩展信息&quot;</span>);</span><br><span class=\"line\">        ((DefaultOAuth2AccessToken) oAuth2AccessToken).setAdditionalInformation(map);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> oAuth2AccessToken;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"JwtTokenProperties\"><a href=\"#JwtTokenProperties\" class=\"headerlink\" title=\"JwtTokenProperties\"></a>JwtTokenProperties</h3><ul>\n<li><p>自定义的jwt相关属性类</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.example.oauth2authserverdemo.security.jwt;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> lombok.Data;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.core.io.ClassPathResource;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.core.io.PathResource;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.core.io.Resource;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.stereotype.Component;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.nio.file.Paths;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Jwt工具类</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"meta\">@Data</span></span><br><span class=\"line\"><span class=\"meta\">@ConfigurationProperties(prefix = &quot;jwt&quot;)</span></span><br><span class=\"line\"><span class=\"meta\">@Component</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">JwtTokenProperties</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 密钥类型:secret，jks</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> String type;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 密钥</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> String secret;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * accessToken过期时间，单位秒</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> Integer accessTokenValiditySeconds;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * refreshToken过期时间，单位秒</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> Integer refreshTokenValiditySeconds;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * jks证书文件路径</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> String jksKeyFile;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * jks证书密钥库密码</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> String jksStorePassword;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * jks证书密码</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> String jksKeyPassword;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * jks证书别名</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> String jksKeyAlias;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 获取jks证书Resource</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Resource <span class=\"title\">getJksKeyFileResource</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        Resource resource;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (jksKeyFile.startsWith(<span class=\"string\">&quot;classpath:&quot;</span>)) &#123;</span><br><span class=\"line\">            resource = <span class=\"keyword\">new</span> ClassPathResource(jksKeyFile.replace(<span class=\"string\">&quot;classpath:&quot;</span>, <span class=\"string\">&quot;&quot;</span>));</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            resource = <span class=\"keyword\">new</span> PathResource(Paths.get(jksKeyFile));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> resource;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n<li><p>配置文件：</p>\n<figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#自定义jwt属性信息</span></span><br><span class=\"line\"><span class=\"attr\">jwt:</span></span><br><span class=\"line\">  <span class=\"attr\">type:</span> <span class=\"string\">jks</span> <span class=\"comment\"># 密钥类型：secret，jks</span></span><br><span class=\"line\">  <span class=\"comment\">#  SECRET 是签名密钥，只生成一次即可，生成方法：</span></span><br><span class=\"line\">  <span class=\"comment\">#  Key key = Keys.secretKeyFor(SignatureAlgorithm.HS512);</span></span><br><span class=\"line\">  <span class=\"comment\">#  String secretString = Encoders.BASE64.encode(key.getEncoded()); # 使用 BASE64 编码</span></span><br><span class=\"line\">  <span class=\"attr\">secret:</span> <span class=\"string\">Ayl7bn+aFwxlakekKCJiqUYguKS80bEVb7OZtd2qfZjdCbAwKxDmM6PWezGy5JIkiJfemtHNPc7Av1l+OWQSqQ==</span> <span class=\"comment\"># 秘钥</span></span><br><span class=\"line\">  <span class=\"attr\">accessTokenValiditySeconds:</span> <span class=\"number\">43200</span>   <span class=\"comment\"># access_token过期时间 (秒) ,默认值12小时</span></span><br><span class=\"line\">  <span class=\"attr\">refreshTokenValiditySeconds:</span> <span class=\"number\">2592000</span> <span class=\"comment\"># refresh_token过期时间 (秒) ,默认值30天</span></span><br><span class=\"line\">  <span class=\"attr\">jksKeyFile:</span> <span class=\"string\">classpath:oauth2_key.jks</span></span><br><span class=\"line\">  <span class=\"attr\">jksStorePassword:</span> <span class=\"number\">123456</span></span><br><span class=\"line\">  <span class=\"attr\">jksKeyAlias:</span> <span class=\"string\">oauth2</span></span><br><span class=\"line\">  <span class=\"attr\">jksKeyPassword:</span> <span class=\"number\">123456</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"客户端配置\"><a href=\"#客户端配置\" class=\"headerlink\" title=\"客户端配置\"></a>客户端配置</h3><ul>\n<li>Oauth2支持两种客户端配置方式，基于内存和基于数据库<h4 id=\"AuthServerConfigByMemory\"><a href=\"#AuthServerConfigByMemory\" class=\"headerlink\" title=\"AuthServerConfigByMemory\"></a>AuthServerConfigByMemory</h4></li>\n<li>基于内存<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.example.oauth2authserverdemo.config;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> com.example.oauth2authserverdemo.security.jwt.JwtTokenProperties;</span><br><span class=\"line\"><span class=\"keyword\">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Configuration;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.oauth2.config.annotation.configurers.ClientDetailsServiceConfigurer;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.EnableAuthorizationServer;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Configuration</span></span><br><span class=\"line\"><span class=\"meta\">@EnableAuthorizationServer</span></span><br><span class=\"line\"><span class=\"meta\">@ConditionalOnProperty(prefix = &quot;oauth2.clients.config&quot;,name = &quot;jdbc&quot;,havingValue = &quot;false&quot;,matchIfMissing = true)</span></span><br><span class=\"line\"><span class=\"meta\">@Slf4j</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">AuthServerConfigByMemory</span> <span class=\"keyword\">extends</span> <span class=\"title\">AuthServerConfig</span></span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> JwtTokenProperties jwtTokenProperties;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 配置OAuth2的客户端信息：clientId、client_secret、authorization_type、redirect_url等。</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> clients</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@throws</span> Exception</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">configure</span><span class=\"params\">(ClientDetailsServiceConfigurer clients)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\">        clients.inMemory()</span><br><span class=\"line\">                .withClient(<span class=\"string\">&quot;postman&quot;</span>)</span><br><span class=\"line\">                .secret(passwordEncoder.encode(<span class=\"string\">&quot;postman&quot;</span>))</span><br><span class=\"line\">                .scopes(<span class=\"string\">&quot;any&quot;</span>,<span class=\"string\">&quot;all&quot;</span>) <span class=\"comment\">//指定用户的访问范围</span></span><br><span class=\"line\">                <span class=\"comment\">//.autoApprove(true) //设置true跳过用户确认授权操作页面直接同意，默认false，必须设置scopes</span></span><br><span class=\"line\">                .autoApprove(<span class=\"string\">&quot;any&quot;</span>) <span class=\"comment\">//指定客户端访问哪些范围时，跳过用户确认授权操作页面直接同意，必须设置scopes，请求参数必须加上&amp;scope=any</span></span><br><span class=\"line\">                .authorizedGrantTypes(<span class=\"string\">&quot;password&quot;</span>, <span class=\"string\">&quot;authorization_code&quot;</span>, <span class=\"string\">&quot;refresh_token&quot;</span>,<span class=\"string\">&quot;implicit&quot;</span>,<span class=\"string\">&quot;client_credentials&quot;</span>)</span><br><span class=\"line\">                .redirectUris(<span class=\"string\">&quot;http://localhost:8080/redirect&quot;</span>)</span><br><span class=\"line\">                .accessTokenValiditySeconds(jwtTokenProperties.getAccessTokenValiditySeconds()) <span class=\"comment\">//默认12小时</span></span><br><span class=\"line\">                .refreshTokenValiditySeconds(jwtTokenProperties.getRefreshTokenValiditySeconds()) <span class=\"comment\">//默认30天</span></span><br><span class=\"line\">                .and()</span><br><span class=\"line\">                .withClient(<span class=\"string\">&quot;demo-client&quot;</span>)</span><br><span class=\"line\">                .secret(passwordEncoder.encode(<span class=\"string\">&quot;demo-client&quot;</span>))</span><br><span class=\"line\">                .scopes(<span class=\"string\">&quot;any&quot;</span>)</span><br><span class=\"line\">                .authorizedGrantTypes(<span class=\"string\">&quot;password&quot;</span>, <span class=\"string\">&quot;authorization_code&quot;</span>, <span class=\"string\">&quot;refresh_token&quot;</span>,<span class=\"string\">&quot;implicit&quot;</span>)</span><br><span class=\"line\">                .redirectUris(<span class=\"string\">&quot;http://localhost:8080/redirect&quot;</span>);</span><br><span class=\"line\">        log.info(<span class=\"string\">&quot;OAuth2的client信息基于内存&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h4 id=\"AuthServerConfigByJDBC\"><a href=\"#AuthServerConfigByJDBC\" class=\"headerlink\" title=\"AuthServerConfigByJDBC\"></a>AuthServerConfigByJDBC</h4><ul>\n<li><p>基于数据库</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.example.oauth2authserverdemo.config;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Configuration;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.oauth2.config.annotation.configurers.ClientDetailsServiceConfigurer;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.EnableAuthorizationServer;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> javax.sql.DataSource;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Slf4j</span></span><br><span class=\"line\"><span class=\"meta\">@Configuration</span></span><br><span class=\"line\"><span class=\"meta\">@EnableAuthorizationServer</span></span><br><span class=\"line\"><span class=\"meta\">@ConditionalOnProperty(prefix = &quot;oauth2.clients.config&quot;, name = &quot;jdbc&quot;, havingValue = &quot;true&quot;)</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">AuthServerConfigByJDBC</span> <span class=\"keyword\">extends</span> <span class=\"title\">AuthServerConfig</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> DataSource dataSource;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 配置OAuth2的客户端信息：clientId、client_secret、authorization_type、redirect_url等。</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> clients</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@throws</span> Exception</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">configure</span><span class=\"params\">(ClientDetailsServiceConfigurer clients)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">//方式1 也可以自定义ClientDetailsService的实现类</span></span><br><span class=\"line\">        <span class=\"comment\">//JdbcClientDetailsService detailsService = new JdbcClientDetailsService(dataSource);</span></span><br><span class=\"line\">        <span class=\"comment\">//detailsService.setPasswordEncoder(passwordEncoder);</span></span><br><span class=\"line\">        <span class=\"comment\">//clients.withClientDetails(detailsService);</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//方式2 等价于方式1</span></span><br><span class=\"line\">        clients.jdbc(dataSource)</span><br><span class=\"line\">                <span class=\"comment\">//指定密码的加密算法</span></span><br><span class=\"line\">                .passwordEncoder(passwordEncoder);</span><br><span class=\"line\">        log.info(<span class=\"string\">&quot;OAuth2的client信息基于数据库&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure></li>\n<li><p>为了支持jdbc需要引入依赖</p>\n<figure class=\"highlight gradle\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//mysql</span></span><br><span class=\"line\">runtimeOnly <span class=\"string\">&#x27;mysql:mysql-connector-java&#x27;</span></span><br><span class=\"line\"><span class=\"comment\">//为了使用datasource</span></span><br><span class=\"line\">implementation <span class=\"string\">&#x27;org.springframework.boot:spring-boot-starter-jdbc&#x27;</span></span><br></pre></td></tr></table></figure></li>\n<li><p>配置文件</p>\n<figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">spring:</span></span><br><span class=\"line\">  <span class=\"comment\">#数据源配置</span></span><br><span class=\"line\">  <span class=\"attr\">datasource:</span></span><br><span class=\"line\">    <span class=\"attr\">url:</span> <span class=\"string\">jdbc:mysql://localhost:3306/springboot?useUnicode=true&amp;characterEncoding=utf-8&amp;useTimezone=true&amp;serverTimezone=GMT%2B8</span></span><br><span class=\"line\">    <span class=\"attr\">username:</span> <span class=\"string\">root</span></span><br><span class=\"line\">    <span class=\"attr\">password:</span> <span class=\"string\">newpwd</span></span><br><span class=\"line\">    <span class=\"attr\">driver-class-name:</span> <span class=\"string\">com.mysql.cj.jdbc.Driver</span></span><br><span class=\"line\">    <span class=\"attr\">hikari:</span></span><br><span class=\"line\">      <span class=\"attr\">connection-timeout:</span> <span class=\"number\">30000</span> <span class=\"comment\">#毫秒，默认30秒</span></span><br><span class=\"line\">      <span class=\"attr\">idle-timeout:</span> <span class=\"number\">600000</span>      <span class=\"comment\">#毫秒，默认10分钟</span></span><br><span class=\"line\">      <span class=\"attr\">max-lifetime:</span> <span class=\"number\">1800000</span>     <span class=\"comment\">#毫秒，默认30分钟</span></span><br><span class=\"line\">      <span class=\"attr\">maximum-pool-size:</span> <span class=\"number\">10</span>     <span class=\"comment\">#默认10</span></span><br></pre></td></tr></table></figure></li>\n<li><p>数据表</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">-- oauth2中规定的数据表,需要手动创建,一般项目中提供服务接口插入,参数由用户定义,在请求时会自动查询服务器中对应的参数数据匹配认证</span></span><br><span class=\"line\"># 客户端注册信息表</span><br><span class=\"line\"><span class=\"keyword\">CREATE</span> <span class=\"keyword\">TABLE</span> `oauth_client_details` (</span><br><span class=\"line\">    `client_id` <span class=\"type\">varchar</span>(<span class=\"number\">256</span>) <span class=\"keyword\">NOT</span> <span class=\"keyword\">NULL</span> COMMENT <span class=\"string\">&#x27;客户端的id&#x27;</span>,</span><br><span class=\"line\">    `resource_ids` <span class=\"type\">varchar</span>(<span class=\"number\">256</span>) <span class=\"keyword\">DEFAULT</span> <span class=\"keyword\">NULL</span> COMMENT <span class=\"string\">&#x27;资源服务器的id，多个用，(逗号)隔开&#x27;</span>,</span><br><span class=\"line\">    `client_secret` <span class=\"type\">varchar</span>(<span class=\"number\">256</span>) <span class=\"keyword\">DEFAULT</span> <span class=\"keyword\">NULL</span> COMMENT <span class=\"string\">&#x27;客户端的秘钥，需要PasswordEncoder加密&#x27;</span>,</span><br><span class=\"line\">    `<span class=\"keyword\">scope</span>` <span class=\"type\">varchar</span>(<span class=\"number\">256</span>) <span class=\"keyword\">DEFAULT</span> <span class=\"keyword\">NULL</span> COMMENT <span class=\"string\">&#x27;客户端的访问范围，多个逗号分隔&#x27;</span>,</span><br><span class=\"line\">    `authorized_grant_types` <span class=\"type\">varchar</span>(<span class=\"number\">256</span>) <span class=\"keyword\">DEFAULT</span> <span class=\"keyword\">NULL</span> COMMENT <span class=\"string\">&#x27;认证的方式，可选值 授权码模式:authorization_code,密码模式:password,刷新token: refresh_token, 隐式模式: implicit: 客户端模式: client_credentials。支持多个用逗号分隔&#x27;</span>,</span><br><span class=\"line\">    `web_server_redirect_uri` <span class=\"type\">varchar</span>(<span class=\"number\">256</span>) <span class=\"keyword\">DEFAULT</span> <span class=\"keyword\">NULL</span> COMMENT <span class=\"string\">&#x27;授权码模式认证成功跳转的地址。authorization_code和implicit需要该值进行校验，注册时填写，多个逗号分隔&#x27;</span>,</span><br><span class=\"line\">    `authorities` <span class=\"type\">varchar</span>(<span class=\"number\">256</span>) <span class=\"keyword\">DEFAULT</span> <span class=\"keyword\">NULL</span>,</span><br><span class=\"line\">    `access_token_validity` <span class=\"type\">int</span>(<span class=\"number\">11</span>) <span class=\"keyword\">DEFAULT</span> <span class=\"keyword\">NULL</span> COMMENT <span class=\"string\">&#x27;access_token的有效时间(秒),默认(60 * 60 * 12,12小时)&#x27;</span>,</span><br><span class=\"line\">    `refresh_token_validity` <span class=\"type\">int</span>(<span class=\"number\">11</span>) <span class=\"keyword\">DEFAULT</span> <span class=\"keyword\">NULL</span> COMMENT <span class=\"string\">&#x27;refresh_token有效期(秒)，默认(60 *60 * 24 * 30, 30天)&#x27;</span>,</span><br><span class=\"line\">    `additional_information` <span class=\"type\">varchar</span>(<span class=\"number\">4096</span>) <span class=\"keyword\">DEFAULT</span> <span class=\"keyword\">NULL</span> COMMENT <span class=\"string\">&#x27;附加信息，值必须是json格式&#x27;</span>,</span><br><span class=\"line\">    `autoapprove` <span class=\"type\">varchar</span>(<span class=\"number\">256</span>) <span class=\"keyword\">DEFAULT</span> <span class=\"keyword\">NULL</span> COMMENT <span class=\"string\">&#x27;默认false,适用于authorization_code模式,设置用户是否自动approval操作,设置true跳过用户确认授权操作页面，直接跳到redirect_uri，也可以这只scope中设置的值，表示只有这个scope会跳过授权页面，多个scope逗号分隔&#x27;</span>,</span><br><span class=\"line\">    <span class=\"keyword\">PRIMARY</span> KEY (`client_id`) <span class=\"keyword\">USING</span> BTREE</span><br><span class=\"line\">) ENGINE<span class=\"operator\">=</span>InnoDB <span class=\"keyword\">DEFAULT</span> CHARSET<span class=\"operator\">=</span>utf8mb4 ROW_FORMAT<span class=\"operator\">=</span><span class=\"keyword\">DYNAMIC</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"># 初始化数据，密码要经过PasswordEncoder加密</span><br><span class=\"line\"><span class=\"keyword\">INSERT</span> <span class=\"keyword\">INTO</span> `oauth_client_details` <span class=\"keyword\">VALUES</span> (<span class=\"string\">&#x27;postman&#x27;</span>, <span class=\"keyword\">NULL</span>, <span class=\"string\">&#x27;$2a$10$Owubqs9VaN.vmskZ2B0UTe0GmOMwgTmhGtlIFBjrfCz2glBqISHSu&#x27;</span>, <span class=\"string\">&#x27;any,all&#x27;</span>, <span class=\"string\">&#x27;authorization_code,refresh_token,implicit,password,client_credentials&#x27;</span>, <span class=\"string\">&#x27;http://localhost:8080/redirect,http://localhost:8088/postman/login&#x27;</span>, <span class=\"keyword\">NULL</span>, <span class=\"number\">42300</span>, <span class=\"number\">2592000</span>, <span class=\"keyword\">NULL</span>, <span class=\"string\">&#x27;any&#x27;</span>);</span><br><span class=\"line\"><span class=\"keyword\">INSERT</span> <span class=\"keyword\">INTO</span> `oauth_client_details` <span class=\"keyword\">VALUES</span> (<span class=\"string\">&#x27;demo-client&#x27;</span>, <span class=\"keyword\">NULL</span>, <span class=\"string\">&#x27;$2a$10$v/B9.6c9NUXFbJDHqc28he6VWeyJNOBOD1UI7bwBDfBZTwY4zzcda&#x27;</span>, <span class=\"string\">&#x27;any&#x27;</span>, <span class=\"string\">&#x27;authorization_code,refresh_token,password&#x27;</span>, <span class=\"string\">&#x27;http://localhost:8080/redirect&#x27;</span>, <span class=\"keyword\">NULL</span>, <span class=\"number\">42300</span>, <span class=\"number\">2592000</span>, <span class=\"keyword\">NULL</span>, <span class=\"string\">&#x27;&#x27;</span>);</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure></li>\n<li><p>为了方便在内存和jdbc中切换，增加了自定义属性</p>\n<figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#oauth2的client信息是基于内存还是基于数据库，如果不配置，默认为基于内存</span></span><br><span class=\"line\"><span class=\"attr\">oauth2:</span></span><br><span class=\"line\">  <span class=\"attr\">clients:</span></span><br><span class=\"line\">    <span class=\"attr\">config:</span></span><br><span class=\"line\">      <span class=\"attr\">jdbc:</span> <span class=\"literal\">true</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"jks证书创建\"><a href=\"#jks证书创建\" class=\"headerlink\" title=\"jks证书创建\"></a>jks证书创建</h3><h4 id=\"生成jks证书\"><a href=\"#生成jks证书\" class=\"headerlink\" title=\"生成jks证书\"></a>生成jks证书</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 默认证书有效期3个月</span></span><br><span class=\"line\"><span class=\"meta\">$</span><span class=\"bash\"> keytool -genkeypair -<span class=\"built_in\">alias</span> oauth2 -keyalg RSA -keysize 2048 -keypass 123456 -keystore oauth2_key.jks -storepass 123456</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 指定证书有效期，这里设置有效期大约10年</span></span><br><span class=\"line\"><span class=\"meta\">$</span><span class=\"bash\"> keytool -genkeypair -<span class=\"built_in\">alias</span> oauth2 -keyalg RSA -keysize 2048 -validity 36500 -keypass 123456 -keystore oauth2_key.jks -storepass 123456</span></span><br><span class=\"line\"></span><br><span class=\"line\">您的名字与姓氏是什么?</span><br><span class=\"line\">  [Unknown]:  han</span><br><span class=\"line\">您的组织单位名称是什么?</span><br><span class=\"line\">  [Unknown]:  han</span><br><span class=\"line\">您的组织名称是什么?</span><br><span class=\"line\">  [Unknown]:  han</span><br><span class=\"line\">您所在的城市或区域名称是什么?</span><br><span class=\"line\">  [Unknown]:  bj</span><br><span class=\"line\">您所在的省/市/自治区名称是什么?</span><br><span class=\"line\">  [Unknown]:  bj</span><br><span class=\"line\">该单位的双字母国家/地区代码是什么?</span><br><span class=\"line\">  [Unknown]:  zh</span><br><span class=\"line\">CN=han, OU=han, O=han, L=bj, ST=bj, C=zh是否正确?</span><br><span class=\"line\">  [否]:  y</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">Warning:</span><br><span class=\"line\">JKS 密钥库使用专用格式。建议使用 &quot;keytool -importkeystore -srckeystore oauth2_key.jks -destkeystore oauth2_key.jks -deststoretype pkcs12&quot; 迁移到行业标准格式 PKCS12。</span><br><span class=\"line\"><span class=\"meta\"></span></span><br><span class=\"line\"><span class=\"meta\"></span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 按照警告执行如下命令</span></span><br><span class=\"line\"><span class=\"meta\">$</span><span class=\"bash\"> keytool -importkeystore -srckeystore oauth2_key.jks -destkeystore oauth2_key.jks -deststoretype pkcs12</span></span><br><span class=\"line\">输入源密钥库口令:</span><br><span class=\"line\">已成功导入别名 oauth2 的条目。</span><br><span class=\"line\">已完成导入命令: 1 个条目成功导入, 0 个条目失败或取消</span><br><span class=\"line\"></span><br><span class=\"line\">Warning:</span><br><span class=\"line\">已将 &quot;oauth2_key.jks&quot; 迁移到 Non JKS/JCEKS。将 JKS 密钥库作为 &quot;oauth2_key.jks.old&quot; 进行了备份。</span><br></pre></td></tr></table></figure>\n\n\n<h4 id=\"导出公钥\"><a href=\"#导出公钥\" class=\"headerlink\" title=\"导出公钥\"></a>导出公钥</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">$</span><span class=\"bash\"> keytool -list -rfc --keystore oauth2_key.jks | openssl x509 -inform pem -pubkey</span></span><br><span class=\"line\">输入密钥库口令:  123456</span><br><span class=\"line\">-----BEGIN PUBLIC KEY-----</span><br><span class=\"line\">MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAmVdbw3XtFamdasjItlko</span><br><span class=\"line\">m8SyJiH0DnSUm1tqJDHY9orHA+0oa+VAlvxiHHBegKMX6FmCX3HAoVzHuAlWAZp0</span><br><span class=\"line\">FyV0SUR4/tuOKOw/N7HbKGa/JZJSfaNdJAEobRxzd8woaLNlCRLelzDPhMy9kGtp</span><br><span class=\"line\">x+Kc60smeo6XpC7RT25Mf5DRvKRJo4RGbPQNj18hWKZtY/TFZYySpa57eI9VOM5u</span><br><span class=\"line\">fvWJkh3Jm5cOXHiHScmF4mdNATR3XQTHXD+TDu0rLgn7H4ap9uYDRTNVGVJ/JfYu</span><br><span class=\"line\">aCrzszMFt4b+JNxz1UL42tTgbtKj8TxUrTRGTI/7KiwD5wjtpISSxlqoK1c0qgCh</span><br><span class=\"line\">KQIDAQAB</span><br><span class=\"line\">-----END PUBLIC KEY-----</span><br><span class=\"line\">-----BEGIN CERTIFICATE-----</span><br><span class=\"line\">MIIDQTCCAimgAwIBAgIEZ0BO+jANBgkqhkiG9w0BAQsFADBRMQswCQYDVQQGEwJ6</span><br><span class=\"line\">aDELMAkGA1UECBMCYmoxCzAJBgNVBAcTAmJqMQwwCgYDVQQKEwNoYW4xDDAKBgNV</span><br><span class=\"line\">BAsTA2hhbjEMMAoGA1UEAxMDaGFuMB4XDTIwMTEwODEyNDI0M1oXDTIxMDIwNjEy</span><br><span class=\"line\">NDI0M1owUTELMAkGA1UEBhMCemgxCzAJBgNVBAgTAmJqMQswCQYDVQQHEwJiajEM</span><br><span class=\"line\">MAoGA1UEChMDaGFuMQwwCgYDVQQLEwNoYW4xDDAKBgNVBAMTA2hhbjCCASIwDQYJ</span><br><span class=\"line\">KoZIhvcNAQEBBQADggEPADCCAQoCggEBAJlXW8N17RWpnWrIyLZZKJvEsiYh9A50</span><br><span class=\"line\">lJtbaiQx2PaKxwPtKGvlQJb8YhxwXoCjF+hZgl9xwKFcx7gJVgGadBcldElEeP7b</span><br><span class=\"line\">jijsPzex2yhmvyWSUn2jXSQBKG0cc3fMKGizZQkS3pcwz4TMvZBracfinOtLJnqO</span><br><span class=\"line\">l6Qu0U9uTH+Q0bykSaOERmz0DY9fIVimbWP0xWWMkqWue3iPVTjObn71iZIdyZuX</span><br><span class=\"line\">Dlx4h0nJheJnTQE0d10Ex1w/kw7tKy4J+x+GqfbmA0UzVRlSfyX2Lmgq87MzBbeG</span><br><span class=\"line\">/iTcc9VC+NrU4G7So/E8VK00RkyP+yosA+cI7aSEksZaqCtXNKoAoSkCAwEAAaMh</span><br><span class=\"line\">MB8wHQYDVR0OBBYEFKM+xW8pT4EHc+5/svExkEKw8c3CMA0GCSqGSIb3DQEBCwUA</span><br><span class=\"line\">A4IBAQB3OHZ1BrT+2hUFxhAk7K/7hC8tHVF8iRXhGBdnZWHNz2GRfzxOeyS4Amkp</span><br><span class=\"line\">wCixoKg9GPhUL1fxBya7Z7wjn4jS5f9b5q40c/fP23zIrmbJ3rsqlMnx3vqrcnJB</span><br><span class=\"line\">KF1l9i9h4iLDoTSS1HC42CuPSCSV/4/g2zXrZPWMVMHPHM9Ul8q+aTE7VaRzRsf8</span><br><span class=\"line\">h7xCeqZXRg2z+wFHH4B1LMcfOHwpGWVJ46xgNqt3cx4IovVTcuXbcQGKgd2+/UuQ</span><br><span class=\"line\">vugI0kWUCOH+CME9wbncIEJlDT1510GJIyt4EWyU3nio+vsLnlKz2jRP7QSE5dxY</span><br><span class=\"line\">ps3Y1u9/nrBl1yK4+KEFAguUikbp</span><br><span class=\"line\">-----END CERTIFICATE-----</span><br></pre></td></tr></table></figure>\n\n\n<ul>\n<li>这段就是公钥，保存到文件即可<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-----BEGIN PUBLIC KEY-----</span><br><span class=\"line\">MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAmVdbw3XtFamdasjItlko</span><br><span class=\"line\">m8SyJiH0DnSUm1tqJDHY9orHA+0oa+VAlvxiHHBegKMX6FmCX3HAoVzHuAlWAZp0</span><br><span class=\"line\">FyV0SUR4/tuOKOw/N7HbKGa/JZJSfaNdJAEobRxzd8woaLNlCRLelzDPhMy9kGtp</span><br><span class=\"line\">x+Kc60smeo6XpC7RT25Mf5DRvKRJo4RGbPQNj18hWKZtY/TFZYySpa57eI9VOM5u</span><br><span class=\"line\">fvWJkh3Jm5cOXHiHScmF4mdNATR3XQTHXD+TDu0rLgn7H4ap9uYDRTNVGVJ/JfYu</span><br><span class=\"line\">aCrzszMFt4b+JNxz1UL42tTgbtKj8TxUrTRGTI/7KiwD5wjtpISSxlqoK1c0qgCh</span><br><span class=\"line\">KQIDAQAB</span><br><span class=\"line\">-----END PUBLIC KEY-----</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h4 id=\"查看密钥信息\"><a href=\"#查看密钥信息\" class=\"headerlink\" title=\"查看密钥信息\"></a>查看密钥信息</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">$</span><span class=\"bash\"> keytool -list -v -keystore oauth2_key.jks</span></span><br><span class=\"line\">输入密钥库口令:</span><br><span class=\"line\">密钥库类型: PKCS12</span><br><span class=\"line\">密钥库提供方: SUN</span><br><span class=\"line\"></span><br><span class=\"line\">您的密钥库包含 1 个条目</span><br><span class=\"line\"></span><br><span class=\"line\">别名: oauth2</span><br><span class=\"line\">创建日期: 2020-11-9</span><br><span class=\"line\">条目类型: PrivateKeyEntry</span><br><span class=\"line\">证书链长度: 1</span><br><span class=\"line\">证书[1]:</span><br><span class=\"line\">所有者: CN=han, OU=han, O=han, L=bj, ST=bj, C=zh</span><br><span class=\"line\">发布者: CN=han, OU=han, O=han, L=bj, ST=bj, C=zh</span><br><span class=\"line\">序列号: 67404efa</span><br><span class=\"line\">有效期为 Sun Nov 08 20:42:43 CST 2020 至 Sat Feb 06 20:42:43 CST 2021</span><br><span class=\"line\">证书指纹:</span><br><span class=\"line\">         MD5:  3E:15:19:80:91:10:00:A8:63:A6:5E:19:5A:0E:A9:E5</span><br><span class=\"line\">         SHA1: E8:BB:68:99:7E:33:6D:51:40:EF:C0:AC:91:A6:93:15:ED:FE:F8:3A</span><br><span class=\"line\">         SHA256: CE:C7:C3:BF:BB:94:28:64:1B:EC:1C:F3:A9:DC:40:C5:53:AD:F2:27:01:83:8D:37:90:E0:EB:DB:C9:73:A5:5C</span><br><span class=\"line\">签名算法名称: SHA256withRSA</span><br><span class=\"line\">主体公共密钥算法: 2048 位 RSA 密钥</span><br><span class=\"line\">版本: 3</span><br><span class=\"line\"></span><br><span class=\"line\">扩展:</span><br><span class=\"line\"><span class=\"meta\"></span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">1: ObjectId: 2.5.29.14 Criticality=<span class=\"literal\">false</span></span></span><br><span class=\"line\">SubjectKeyIdentifier [</span><br><span class=\"line\">KeyIdentifier [</span><br><span class=\"line\">0000: A3 3E C5 6F 29 4F 81 07   73 EE 7F B2 F1 31 90 42  .&gt;.o)O..s....1.B</span><br><span class=\"line\">0010: B0 F1 CD C2                                        ....</span><br><span class=\"line\">]</span><br><span class=\"line\">]</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">*******************************************</span><br><span class=\"line\">*******************************************</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"OAuth2支持获取access-token的方式\"><a href=\"#OAuth2支持获取access-token的方式\" class=\"headerlink\" title=\"OAuth2支持获取access_token的方式\"></a>OAuth2支持获取access_token的方式</h2><ul>\n<li>authorization_code 验证码模式</li>\n<li>implicit 隐式模式</li>\n<li>password 密码模式</li>\n<li>client_credentials 客户端模式</li>\n<li>refresh_token 刷新token模式</li>\n</ul>\n<h3 id=\"Oauth2提供的默认端点（endpoints）\"><a href=\"#Oauth2提供的默认端点（endpoints）\" class=\"headerlink\" title=\"Oauth2提供的默认端点（endpoints）\"></a>Oauth2提供的默认端点（endpoints）</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/oauth/authorize：授权端点 AuthorizationEndpoint 按照OAuth 2.0规范的授权实现</span><br><span class=\"line\">/oauth/token：令牌端点 TokenEndpoint 按照OAuth 2.0规范请求Token</span><br><span class=\"line\">/oauth/confirm_access：用户确认授权提交端点</span><br><span class=\"line\">/oauth/error：授权服务错误信息端点</span><br><span class=\"line\">/oauth/check_token：用于资源服务访问的令牌解析端点 CheckTokenEndpoint 解码Client的Access Token用来检查和确认生成的Token</span><br><span class=\"line\">/oauth/token_key：提供公有密匙的端点，如果使用JWT令牌的话 TokenKeyEndpoint 提供JWT编码的Token</span><br></pre></td></tr></table></figure>\n\n\n<h3 id=\"验证码模式–authorization-code，最常用的模式\"><a href=\"#验证码模式–authorization-code，最常用的模式\" class=\"headerlink\" title=\"验证码模式–authorization_code，最常用的模式\"></a>验证码模式–authorization_code，最常用的模式</h3><ol>\n<li><p>获取验证码</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">浏览器GET</span><br><span class=\"line\">http://localhost:8080/oauth/authorize?client_id=postman&amp;response_type=code&amp;redirect_uri=http://localhost:8080/redirect</span><br></pre></td></tr></table></figure>\n<ul>\n<li>1.1 参数说明<figure class=\"highlight properties\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">response_type</span>=<span class=\"string\">code #授权码认证，固定值</span></span><br><span class=\"line\"><span class=\"attr\">client_id</span>=<span class=\"string\">postman #客户端id</span></span><br><span class=\"line\"><span class=\"attr\">redirect_uri</span>=<span class=\"string\">http://localhost:8080/redirect #重定向url，这个值要与配置的值一致，配置这个值时可以配置一个不存在的路径</span></span><br><span class=\"line\"><span class=\"attr\">scope</span>=<span class=\"string\">any 可选参数，指定请求范围，如果不希望跳转到确认页面而是直接通过，需要在代码中配置autoApprove(true)或者autoApprove(&quot;any&quot;)</span></span><br></pre></td></tr></table></figure></li>\n<li>1.2 跳转到登录页面，使用<code>admin/123456</code>登录</li>\n<li>1.3 登录成功后跳转到认证确认页面(如果不希望跳转到确认页面而是直接通过，需要在代码中配置autoApprove(true))，点击<code>Authorize</code>按钮，页面会跳转到<code>http://localhost:8080/redirect?code=7ak4gI</code></li>\n<li>1.4 复制code的值进入第二步</li>\n</ul>\n</li>\n<li><p>获取access_token和refresh_token</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST</span><br><span class=\"line\">http://localhost:8080/oauth/token?grant_type=authorization_code&amp;client_id=postman&amp;client_secret=postman&amp;redirect_uri=http://localhost:8080/redirect&amp;code=7ak4gI</span><br></pre></td></tr></table></figure>\n<ul>\n<li>2.1 code存在有效期，且只能使用一次，所以这个请求只能使用一次，参数说明<figure class=\"highlight properties\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">grant_type</span>=<span class=\"string\">authorization_code #验证code并获取access_token，固定值</span></span><br><span class=\"line\"><span class=\"attr\">client_id</span>=<span class=\"string\">postman #客户端id</span></span><br><span class=\"line\"><span class=\"attr\">client_secret</span>=<span class=\"string\">postman #客户端密码</span></span><br><span class=\"line\"><span class=\"attr\">redirect_uri</span>=<span class=\"string\">http://localhost:8080/redirect #重定向url</span></span><br><span class=\"line\"><span class=\"attr\">code</span>=<span class=\"string\">7ak4gI #上一步中获取到的code值</span></span><br></pre></td></tr></table></figure></li>\n<li>2.2 响应结果如下，默认access_token有效期12小时，refresh_token有效期30天<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"attr\">&quot;access_token&quot;</span>: <span class=\"string\">&quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX25hbWUiOiJhZG1pbiIsImp3dC1leHQiOiJKV1Qg5omp5bGV5L-h5oGvIiwic2NvcGUiOlsiYW55Il0sImV4cCI6MTYwNDYxMzI3MywiYXV0aG9yaXRpZXMiOlsiUk9MRV9hZG1pbiJdLCJqdGkiOiJhNzFhMDJhYy02NzgyLTRiODEtOGJiMi1mMGI3ZWVkODk2YTgiLCJjbGllbnRfaWQiOiJwb3N0bWFuIn0.SKl-0KbdVvv3acqLlXre66PX-fFIruTLwOkCO3peby0&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;token_type&quot;</span>: <span class=\"string\">&quot;bearer&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;refresh_token&quot;</span>: <span class=\"string\">&quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX25hbWUiOiJhZG1pbiIsImp3dC1leHQiOiJKV1Qg5omp5bGV5L-h5oGvIiwic2NvcGUiOlsiYW55Il0sImF0aSI6ImE3MWEwMmFjLTY3ODItNGI4MS04YmIyLWYwYjdlZWQ4OTZhOCIsImV4cCI6MTYwNzE2MjA3MywiYXV0aG9yaXRpZXMiOlsiUk9MRV9hZG1pbiJdLCJqdGkiOiI5NzRjMDRkOS03NTQ0LTRjZTEtODMzZS05NjlmODMyNmRiNmQiLCJjbGllbnRfaWQiOiJwb3N0bWFuIn0.vy16MpRikSFFz_n2zJEgI5Cfy1APNDrvnuP7Sj1jqJU&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;expires_in&quot;</span>: <span class=\"number\">43199</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;scope&quot;</span>: <span class=\"string\">&quot;any&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;jwt-ext&quot;</span>: <span class=\"string\">&quot;JWT 扩展信息&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;jti&quot;</span>: <span class=\"string\">&quot;a71a02ac-6782-4b81-8bb2-f0b7eed896a8&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n<li>2.3 复制refresh_token的值进入第三步</li>\n<li>2.4 请求时支持base认证方式，详见3.3</li>\n</ul>\n</li>\n<li><p>通过refresh_token获取新的access_token</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST</span><br><span class=\"line\">http://localhost:8080/oauth/token?grant_type=refresh_token&amp;client_id=postman&amp;client_secret=postman&amp;refresh_token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX25hbWUiOiJhZG1pbiIsImp3dC1leHQiOiJKV1Qg5omp5bGV5L-h5oGvIiwic2NvcGUiOlsiYW55Il0sImF0aSI6ImE3MWEwMmFjLTY3ODItNGI4MS04YmIyLWYwYjdlZWQ4OTZhOCIsImV4cCI6MTYwNzE2MjA3MywiYXV0aG9yaXRpZXMiOlsiUk9MRV9hZG1pbiJdLCJqdGkiOiI5NzRjMDRkOS03NTQ0LTRjZTEtODMzZS05NjlmODMyNmRiNmQiLCJjbGllbnRfaWQiOiJwb3N0bWFuIn0.vy16MpRikSFFz_n2zJEgI5Cfy1APNDrvnuP7Sj1jqJU</span><br></pre></td></tr></table></figure>\n<ul>\n<li>3.1 参数说明，这个就是refresh_token模式，需要先获取到上一次的refresh_token<figure class=\"highlight properties\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">grant_type</span>=<span class=\"string\">refresh_token #刷新token的参数，固定值</span></span><br><span class=\"line\"><span class=\"attr\">client_id</span>=<span class=\"string\">postman #客户端id</span></span><br><span class=\"line\"><span class=\"attr\">client_secret</span>=<span class=\"string\">postman #客户端密码</span></span><br><span class=\"line\"><span class=\"attr\">refresh_token</span>=<span class=\"string\">xxx #上一步中获取的refresh_token值</span></span><br></pre></td></tr></table></figure></li>\n<li>3.2 响应结果如下，获取到新的access_token和refresh_token，注意保存，access_token过期时，可以通过该请求重新获得新的access_token<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"attr\">&quot;access_token&quot;</span>: <span class=\"string\">&quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX25hbWUiOiJhZG1pbiIsImp3dC1leHQiOiJKV1Qg5omp5bGV5L-h5oGvIiwic2NvcGUiOlsiYW55Il0sImV4cCI6MTYwNDYxMzc4NSwiYXV0aG9yaXRpZXMiOlsiUk9MRV9hZG1pbiJdLCJqdGkiOiI5YWQ1MTBhNy00MzQyLTQ5M2UtYjQyMS1iNzNmMDU2NmU3OWYiLCJjbGllbnRfaWQiOiJwb3N0bWFuIn0.L0TPZ-NDzT4hSSivQ0WR-5rPz6xoLbC_HmdvvKOzP_Y&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;token_type&quot;</span>: <span class=\"string\">&quot;bearer&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;refresh_token&quot;</span>: <span class=\"string\">&quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX25hbWUiOiJhZG1pbiIsImp3dC1leHQiOiJKV1Qg5omp5bGV5L-h5oGvIiwic2NvcGUiOlsiYW55Il0sImF0aSI6IjlhZDUxMGE3LTQzNDItNDkzZS1iNDIxLWI3M2YwNTY2ZTc5ZiIsImV4cCI6MTYwNzE2MjA3MywiYXV0aG9yaXRpZXMiOlsiUk9MRV9hZG1pbiJdLCJqdGkiOiI5NzRjMDRkOS03NTQ0LTRjZTEtODMzZS05NjlmODMyNmRiNmQiLCJjbGllbnRfaWQiOiJwb3N0bWFuIn0.ekAST3MRc0PqW3FZgnFQv1g-HykCqA4_TuzLRTplCIM&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;expires_in&quot;</span>: <span class=\"number\">43199</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;scope&quot;</span>: <span class=\"string\">&quot;any&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;jwt-ext&quot;</span>: <span class=\"string\">&quot;JWT 扩展信息&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;jti&quot;</span>: <span class=\"string\">&quot;9ad510a7-4342-493e-b421-b73f0566e79f&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n<li>3.3 请求时支持base认证方式</li>\n</ul>\n <figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 将client_id和client_secret放到url的前面</span></span><br><span class=\"line\">POST http://postman:postman@localhost:8080/oauth/token?grant_type=refresh_token&amp;refresh_token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX25hbWUiOiJhZG1pbiIsImp3dC1leHQiOiJKV1Qg5omp5bGV5L-h5oGvIiwic2NvcGUiOlsiYW55Il0sImF0aSI6ImM4NWM0YjJlLTBlNTktNDJhYy05M2RlLWI2N2I0OWI1ZDU5OSIsImV4cCI6MTYwNzIyMDAxMiwiYXV0aG9yaXRpZXMiOlsiUk9MRV9hZG1pbiJdLCJqdGkiOiI2M2U2MGYxOS1iOTU1LTRlMmUtODk2Yy1mYWUxN2IyODUzMzkiLCJjbGllbnRfaWQiOiJwb3N0bWFuIn0.jVZWYRjr4VwTYwbKXP-sav_08vwc8iAxzEbg0I_jVTw</span><br></pre></td></tr></table></figure>\n<p> 或者在header中增加<code>Authorization</code>请求头，值为<code>Basic xxxxxxxxx</code>，<code>xxxxxxxxx</code>是通过<code>base64.encode(client_id + 空格 + client_secret)</code>得到。<br> 使用Postman接口测试工具时，也可以使用其提供的认证功能[Authorization–&gt;TYPE–&gt;Basic Auth]，直接填写用户名和密码就可以方便进行测试，注意这里用户名和密码是client_id 和 client_secret。</p>\n <figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"attr\">&quot;access_token&quot;</span>: <span class=\"string\">&quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX25hbWUiOiJhZG1pbiIsImp3dC1leHQiOiJKV1Qg5omp5bGV5L-h5oGvIiwic2NvcGUiOlsiYW55Il0sImV4cCI6MTYwNDY4NTE3NiwiYXV0aG9yaXRpZXMiOlsiUk9MRV9hZG1pbiJdLCJqdGkiOiJhNDhiNzZhNC1kNWM0LTRkNTYtYmQ2Yy0zOWYxODQ0MGYwNTMiLCJjbGllbnRfaWQiOiJwb3N0bWFuIn0.mhNUhWk1M9p267bOsv3fYXnLGeXitvnny6mUT9FyNdw&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;token_type&quot;</span>: <span class=\"string\">&quot;bearer&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;refresh_token&quot;</span>: <span class=\"string\">&quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX25hbWUiOiJhZG1pbiIsImp3dC1leHQiOiJKV1Qg5omp5bGV5L-h5oGvIiwic2NvcGUiOlsiYW55Il0sImF0aSI6ImE0OGI3NmE0LWQ1YzQtNGQ1Ni1iZDZjLTM5ZjE4NDQwZjA1MyIsImV4cCI6MTYwNzIyMDAxMiwiYXV0aG9yaXRpZXMiOlsiUk9MRV9hZG1pbiJdLCJqdGkiOiI2M2U2MGYxOS1iOTU1LTRlMmUtODk2Yy1mYWUxN2IyODUzMzkiLCJjbGllbnRfaWQiOiJwb3N0bWFuIn0.DT_cBdcow7pDv_S9RTHknKLHxZAIT45Byw1Rdw93K8U&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;expires_in&quot;</span>: <span class=\"number\">43199</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;scope&quot;</span>: <span class=\"string\">&quot;any&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;jwt-ext&quot;</span>: <span class=\"string\">&quot;JWT 扩展信息&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;jti&quot;</span>: <span class=\"string\">&quot;a48b76a4-d5c4-4d56-bd6c-39f18440f053&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>3.4 access_token信息<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//HEADER</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"attr\">&quot;alg&quot;</span>: <span class=\"string\">&quot;HS256&quot;</span>,</span><br><span class=\"line\">  <span class=\"attr\">&quot;typ&quot;</span>: <span class=\"string\">&quot;JWT&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">//PAYLOAD</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"attr\">&quot;user_name&quot;</span>: <span class=\"string\">&quot;admin&quot;</span>,</span><br><span class=\"line\">  <span class=\"attr\">&quot;jwt-ext&quot;</span>: <span class=\"string\">&quot;JWT 扩展信息&quot;</span>,</span><br><span class=\"line\">  <span class=\"attr\">&quot;scope&quot;</span>: [</span><br><span class=\"line\">    <span class=\"string\">&quot;any&quot;</span></span><br><span class=\"line\">  ],</span><br><span class=\"line\">  <span class=\"attr\">&quot;exp&quot;</span>: <span class=\"number\">1604613785</span>,</span><br><span class=\"line\">  <span class=\"attr\">&quot;authorities&quot;</span>: [</span><br><span class=\"line\">    <span class=\"string\">&quot;ROLE_admin&quot;</span></span><br><span class=\"line\">  ],</span><br><span class=\"line\">  <span class=\"attr\">&quot;jti&quot;</span>: <span class=\"string\">&quot;9ad510a7-4342-493e-b421-b73f0566e79f&quot;</span>,</span><br><span class=\"line\">  <span class=\"attr\">&quot;client_id&quot;</span>: <span class=\"string\">&quot;postman&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n</ul>\n</li>\n</ol>\n<h3 id=\"implicit模式\"><a href=\"#implicit模式\" class=\"headerlink\" title=\"implicit模式\"></a>implicit模式</h3><ul>\n<li>仅可获取access_token，不能获取refresh_token</li>\n<li>跳转到登录页面<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">浏览器GET</span><br><span class=\"line\">http://localhost:8080/oauth/authorize?client_id=postman&amp;response_type=token&amp;redirect_uri=http://localhost:8080/redirect</span><br></pre></td></tr></table></figure></li>\n<li>然后登录，然后同意授权</li>\n<li>返回结果直接拼接在redirect_uri的后面，因为是以<code>#</code>开头，所以服务器端无法收到数据，只能从浏览器中获取了  <figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://localhost:8080/redirect#access_token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX25hbWUiOiJhZG1pbiIsImp3dC1leHQiOiJKV1Qg5omp5bGV5L-h5oGvIiwic2NvcGUiOlsiYW55Il0sImV4cCI6MTYwNDY3NTMwNSwiYXV0aG9yaXRpZXMiOlsiUk9MRV9hZG1pbiJdLCJqdGkiOiI4ZDcyODM5NC0zODhjLTRiMjAtYjgwYy1jNTk4OWJjZmJlM2IiLCJjbGllbnRfaWQiOiJwb3N0bWFuIn0.OStAhkT6fBoNLdF7vTaztwhfNV5J8K1MpE1A7pxbyCs&amp;token_type=bearer&amp;expires_in=43199&amp;scope=any&amp;jwt-ext=JWT%20%E6%89%A9%E5%B1%95%E4%BF%A1%E6%81%AF&amp;jti=8d728394-388c-4b20-b80c-c5989bcfbe3b</span><br></pre></td></tr></table></figure></li>\n<li>access_token信息<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//HEADER</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"attr\">&quot;alg&quot;</span>: <span class=\"string\">&quot;HS256&quot;</span>,</span><br><span class=\"line\">  <span class=\"attr\">&quot;typ&quot;</span>: <span class=\"string\">&quot;JWT&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">//PAYLOAD</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"attr\">&quot;user_name&quot;</span>: <span class=\"string\">&quot;admin&quot;</span>,</span><br><span class=\"line\">  <span class=\"attr\">&quot;jwt-ext&quot;</span>: <span class=\"string\">&quot;JWT 扩展信息&quot;</span>,</span><br><span class=\"line\">  <span class=\"attr\">&quot;scope&quot;</span>: [</span><br><span class=\"line\">    <span class=\"string\">&quot;any&quot;</span></span><br><span class=\"line\">  ],</span><br><span class=\"line\">  <span class=\"attr\">&quot;exp&quot;</span>: <span class=\"number\">1604675305</span>,</span><br><span class=\"line\">  <span class=\"attr\">&quot;authorities&quot;</span>: [</span><br><span class=\"line\">    <span class=\"string\">&quot;ROLE_admin&quot;</span></span><br><span class=\"line\">  ],</span><br><span class=\"line\">  <span class=\"attr\">&quot;jti&quot;</span>: <span class=\"string\">&quot;8d728394-388c-4b20-b80c-c5989bcfbe3b&quot;</span>,</span><br><span class=\"line\">  <span class=\"attr\">&quot;client_id&quot;</span>: <span class=\"string\">&quot;postman&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"password-模式\"><a href=\"#password-模式\" class=\"headerlink\" title=\"password 模式\"></a>password 模式</h3><ul>\n<li>密码模式（Resource Owner Password Credentials Grant）中，用户向客户端提供自己的用户名和密码。客户端使用这些信息，向”服务商提供商”索要授权。</li>\n<li>在这种模式中，用户必须把自己的密码给客户端，但是客户端不得储存密码。这通常用在用户对客户端高度信任的情况下，比如客户端是操作系统的一部分，或者由一个著名公司出品。而认证服务器只有在其他授权模式无法执行的情况下，才能考虑使用这种模式。</li>\n<li>获取access_token和refresh_token<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST</span><br><span class=\"line\">http://localhost:8080/oauth/token?username=admin&amp;password=123456&amp;grant_type=password&amp;client_id=postman&amp;client_secret=postman</span><br></pre></td></tr></table></figure></li>\n<li>请求时支持base认证方式，认证用户名和密码是client_id 和 client_secret</li>\n<li>grant_type=password，需要携带用户的用户名和密码</li>\n<li>返回结果<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;access_token&quot;: &quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX25hbWUiOiJhZG1pbiIsImp3dC1leHQiOiJKV1Qg5omp5bGV5L-h5oGvIiwic2NvcGUiOlsiYW55Il0sImV4cCI6MTYwNDY3NzU1MiwiYXV0aG9yaXRpZXMiOlsiUk9MRV9hZG1pbiJdLCJqdGkiOiJlNjZiMWFjOS04M2RmLTRiNTMtYjNmYS1mMTQyYzA2MTYzMjkiLCJjbGllbnRfaWQiOiJwb3N0bWFuIn0.jfBeoA-AeNaMUSWHKBktN8IOFbGJHtQSIQUgxP8zzg0&quot;,</span><br><span class=\"line\">    &quot;token_type&quot;: &quot;bearer&quot;,</span><br><span class=\"line\">    &quot;refresh_token&quot;: &quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX25hbWUiOiJhZG1pbiIsImp3dC1leHQiOiJKV1Qg5omp5bGV5L-h5oGvIiwic2NvcGUiOlsiYW55Il0sImF0aSI6ImU2NmIxYWM5LTgzZGYtNGI1My1iM2ZhLWYxNDJjMDYxNjMyOSIsImV4cCI6MTYwNzIyNjM1MiwiYXV0aG9yaXRpZXMiOlsiUk9MRV9hZG1pbiJdLCJqdGkiOiI5MDUwNTQ0Yi00OGVmLTQ2OWMtYjM3OS1lMWQyZDViOTcyYjkiLCJjbGllbnRfaWQiOiJwb3N0bWFuIn0.fGDixRXD68cYdRTjprH3TM7gAGmFqDAaKxs3RTxphMs&quot;,</span><br><span class=\"line\">    &quot;expires_in&quot;: 43199,</span><br><span class=\"line\">    &quot;scope&quot;: &quot;any&quot;,</span><br><span class=\"line\">    &quot;jwt-ext&quot;: &quot;JWT 扩展信息&quot;,</span><br><span class=\"line\">    &quot;jti&quot;: &quot;e66b1ac9-83df-4b53-b3fa-f142c0616329&quot;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n<li>access_token信息<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//HEADER</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"attr\">&quot;alg&quot;</span>: <span class=\"string\">&quot;HS256&quot;</span>,</span><br><span class=\"line\">  <span class=\"attr\">&quot;typ&quot;</span>: <span class=\"string\">&quot;JWT&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">//PAYLOAD</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"attr\">&quot;user_name&quot;</span>: <span class=\"string\">&quot;admin&quot;</span>,</span><br><span class=\"line\">  <span class=\"attr\">&quot;jwt-ext&quot;</span>: <span class=\"string\">&quot;JWT 扩展信息&quot;</span>,</span><br><span class=\"line\">  <span class=\"attr\">&quot;scope&quot;</span>: [</span><br><span class=\"line\">    <span class=\"string\">&quot;any&quot;</span></span><br><span class=\"line\">  ],</span><br><span class=\"line\">  <span class=\"attr\">&quot;exp&quot;</span>: <span class=\"number\">1604677552</span>,</span><br><span class=\"line\">  <span class=\"attr\">&quot;authorities&quot;</span>: [</span><br><span class=\"line\">    <span class=\"string\">&quot;ROLE_admin&quot;</span></span><br><span class=\"line\">  ],</span><br><span class=\"line\">  <span class=\"attr\">&quot;jti&quot;</span>: <span class=\"string\">&quot;e66b1ac9-83df-4b53-b3fa-f142c0616329&quot;</span>,</span><br><span class=\"line\">  <span class=\"attr\">&quot;client_id&quot;</span>: <span class=\"string\">&quot;postman&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"client-credentials-客户端模式\"><a href=\"#client-credentials-客户端模式\" class=\"headerlink\" title=\"client_credentials 客户端模式\"></a>client_credentials 客户端模式</h3><ul>\n<li>客户端模式（Client Credentials Grant）指客户端以自己的名义，而不是以用户的名义，向”服务提供商”进行认证。严格地说，客户端模式并不属于OAuth框架所要解决的问题。在这种模式中，用户直接向客户端注册，客户端以自己的名义要求”服务提供商”提供服务，其实不存在授权问题。</li>\n<li>获取access_token<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST</span><br><span class=\"line\">http://localhost:8080/oauth/token?grant_type=client_credentials&amp;client_id=postman&amp;client_secret=postman</span><br></pre></td></tr></table></figure></li>\n<li>不需要用户的用户名和密码，只是认证客户端是否有效，返回的access_token的payload中也不包含任何用户信息(user_name,authorities)</li>\n<li>没有refresh_token</li>\n<li>返回结果<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;access_token&quot;: &quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqd3QtZXh0IjoiSldUIOaJqeWxleS_oeaBryIsInNjb3BlIjpbImFueSJdLCJleHAiOjE2MDQ2Nzc4NjksImp0aSI6ImU3ZjJhYTEyLTFhMWUtNGFmMC04MjJkLTkxNzg5NmYyMGMwMyIsImNsaWVudF9pZCI6InBvc3RtYW4ifQ.OHy0IUGf9KSmCDKlqq1IZ8bICAhBHFtpazwK1gcbCOI&quot;,</span><br><span class=\"line\">    &quot;token_type&quot;: &quot;bearer&quot;,</span><br><span class=\"line\">    &quot;expires_in&quot;: 43199,</span><br><span class=\"line\">    &quot;scope&quot;: &quot;any&quot;,</span><br><span class=\"line\">    &quot;jwt-ext&quot;: &quot;JWT 扩展信息&quot;,</span><br><span class=\"line\">    &quot;jti&quot;: &quot;e7f2aa12-1a1e-4af0-822d-917896f20c03&quot;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n<li>access_token信息<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//HEADER</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"attr\">&quot;alg&quot;</span>: <span class=\"string\">&quot;HS256&quot;</span>,</span><br><span class=\"line\">  <span class=\"attr\">&quot;typ&quot;</span>: <span class=\"string\">&quot;JWT&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">//PAYLOAD</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"attr\">&quot;jwt-ext&quot;</span>: <span class=\"string\">&quot;JWT 扩展信息&quot;</span>,</span><br><span class=\"line\">  <span class=\"attr\">&quot;scope&quot;</span>: [</span><br><span class=\"line\">    <span class=\"string\">&quot;any&quot;</span></span><br><span class=\"line\">  ],</span><br><span class=\"line\">  <span class=\"attr\">&quot;exp&quot;</span>: <span class=\"number\">1604677869</span>,</span><br><span class=\"line\">  <span class=\"attr\">&quot;jti&quot;</span>: <span class=\"string\">&quot;e7f2aa12-1a1e-4af0-822d-917896f20c03&quot;</span>,</span><br><span class=\"line\">  <span class=\"attr\">&quot;client_id&quot;</span>: <span class=\"string\">&quot;postman&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"refresh-token模式，见验证码模式第3部分\"><a href=\"#refresh-token模式，见验证码模式第3部分\" class=\"headerlink\" title=\"refresh_token模式，见验证码模式第3部分\"></a>refresh_token模式，见验证码模式第3部分</h3><p>通过已有的refresh_token获取新的access_token和refresh_token</p>\n<h3 id=\"验证token有效性–Basic-Auth\"><a href=\"#验证token有效性–Basic-Auth\" class=\"headerlink\" title=\"验证token有效性–Basic Auth\"></a>验证token有效性–Basic Auth</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST http://postman:postman@localhost:8080/oauth/check_token?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX25hbWUiOiJhZG1pbiIsImp3dC1leHQiOiJKV1Qg5omp5bGV5L-h5oGvIiwic2NvcGUiOlsiYW55IiwiYWxsIl0sImV4cCI6MTYwNDcxNjMyMCwiYXV0aG9yaXRpZXMiOlsiUk9MRV9hZG1pbiJdLCJqdGkiOiIxNjc4ZTNhYy0yYmNjLTQ4NGUtOTBkMy02ZWFjYTVkNzkyM2IiLCJjbGllbnRfaWQiOiJwb3N0bWFuIn0.8piTJdoAf-4lB0Tn-yeSFWoV3WpkJkqBs7AsoNPoohw</span><br></pre></td></tr></table></figure>\n<p>或者加上Header参数<code>Authorization</code> 值为 <code>Basic cG9zdG1hbjpwb3N0bWFu</code></p>\n<p>返回值</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"attr\">&quot;user_name&quot;</span>: <span class=\"string\">&quot;admin&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;jwt-ext&quot;</span>: <span class=\"string\">&quot;JWT 扩展信息&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;scope&quot;</span>: [</span><br><span class=\"line\">        <span class=\"string\">&quot;any&quot;</span></span><br><span class=\"line\">    ],</span><br><span class=\"line\">    <span class=\"attr\">&quot;active&quot;</span>: <span class=\"literal\">true</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;exp&quot;</span>: <span class=\"number\">1604767911</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;authorities&quot;</span>: [</span><br><span class=\"line\">        <span class=\"string\">&quot;ROLE_admin&quot;</span></span><br><span class=\"line\">    ],</span><br><span class=\"line\">    <span class=\"attr\">&quot;jti&quot;</span>: <span class=\"string\">&quot;5597b675-a617-4e02-959f-86d62024a237&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;client_id&quot;</span>: <span class=\"string\">&quot;postman&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"获取公钥，比如JWT的密钥\"><a href=\"#获取公钥，比如JWT的密钥\" class=\"headerlink\" title=\"获取公钥，比如JWT的密钥\"></a>获取公钥，比如JWT的密钥</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET http://postman:postman@localhost:8080/oauth/token_key</span><br></pre></td></tr></table></figure>\n<p>或者加上Header参数<code>Authorization</code> 值为 <code>Basic cG9zdG1hbjpwb3N0bWFu</code></p>\n<p>返回值</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"attr\">&quot;alg&quot;</span>: <span class=\"string\">&quot;HMACSHA256&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;value&quot;</span>: <span class=\"string\">&quot;Ayl7bn+aFwxlakekKCJiqUYguKS80bEVb7OZtd2qfZjdCbAwKxDmM6PWezGy5JIkiJfemtHNPc7Av1l+OWQSqQ==&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"自定义登录和授权页面\"><a href=\"#自定义登录和授权页面\" class=\"headerlink\" title=\"自定义登录和授权页面\"></a>自定义登录和授权页面</h2><h3 id=\"依赖-1\"><a href=\"#依赖-1\" class=\"headerlink\" title=\"依赖\"></a>依赖</h3><figure class=\"highlight gradle\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">implementation <span class=\"string\">&#x27;org.springframework.boot:spring-boot-starter-thymeleaf&#x27;</span></span><br><span class=\"line\"><span class=\"comment\">//webjars https://www.webjars.org</span></span><br><span class=\"line\">implementation <span class=\"string\">&#x27;org.webjars:bootstrap:4.5.3&#x27;</span></span><br><span class=\"line\">implementation <span class=\"string\">&#x27;org.webjars.bower:jquery:3.5.1&#x27;</span></span><br><span class=\"line\"><span class=\"comment\">// 可以在html中去掉webjars的版本号，这样升级的时候直接修改上面引入的webjars中的版本号即可，页面中不需要修改</span></span><br><span class=\"line\">implementation <span class=\"string\">&#x27;org.webjars:webjars-locator:0.40&#x27;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"OAuth2Controller\"><a href=\"#OAuth2Controller\" class=\"headerlink\" title=\"OAuth2Controller\"></a>OAuth2Controller</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.example.oauth2authserverdemo.controller;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> com.sun.istack.internal.Nullable;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.stereotype.Controller;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.ui.Model;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.bind.annotation.SessionAttributes;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.ArrayList;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.List;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Map;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Controller</span></span><br><span class=\"line\"><span class=\"meta\">@SessionAttributes(&#123;&quot;authorizationRequest&quot;&#125;)</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">OAuth2Controller</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 自定义授权页面，注意：一定要在类上加<span class=\"doctag\">@SessionAttributes</span>(&#123;&quot;authorizationRequest&quot;&#125;)</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> model   model</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> request request</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> String</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@throws</span> Exception Exception</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@RequestMapping(&quot;/oauth/confirm_access&quot;)</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getAccessConfirmation</span><span class=\"params\">(Map&lt;String, Object&gt; model, HttpServletRequest request)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        List&lt;String&gt; scopeList = <span class=\"keyword\">new</span> ArrayList&lt;&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">        String scope = request.getParameter(<span class=\"string\">&quot;scope&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (scope != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            String[] split = scope.split(<span class=\"string\">&quot; &quot;</span>);</span><br><span class=\"line\">            <span class=\"keyword\">for</span>(String s:split) &#123;</span><br><span class=\"line\">                scopeList.add(s);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">        model.put(<span class=\"string\">&quot;scopeList&quot;</span>, scopeList);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">&quot;oauth2/confirm_access&quot;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;h2&gt;自定义登录&lt;/h2&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     * Created by hanqf on 2020/11/13 10:13. &lt;br&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> java.lang.String</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@author</span> hanqf</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@RequestMapping(&quot;/oauth/login&quot;)</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">login</span><span class=\"params\">(Model model,<span class=\"meta\">@Nullable</span> Boolean error,HttpServletRequest request)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(error!=<span class=\"keyword\">null</span>)&#123;</span><br><span class=\"line\">            model.addAttribute(<span class=\"string\">&quot;error&quot;</span>,error);</span><br><span class=\"line\">        &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">            <span class=\"comment\">//从客户端logout后，第一次重新登录会不成功，这里加一个处理逻辑，如果发现其queryString的值为logout就重定向到首页</span></span><br><span class=\"line\">            <span class=\"comment\">//暂时不清楚客户端登出后该如何设置才能直接重新登录客户端，可以在认证服务器首页增加客户端入口</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span>(<span class=\"string\">&quot;logout&quot;</span>.equals(request.getQueryString()))&#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"string\">&quot;redirect:/&quot;</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">&quot;oauth2/login&quot;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"login-html\"><a href=\"#login-html\" class=\"headerlink\" title=\"login.html\"></a>login.html</h3><ul>\n<li>登录页面<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE <span class=\"meta-keyword\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span> <span class=\"attr\">lang</span>=<span class=\"string\">&quot;en&quot;</span> <span class=\"attr\">xmlns:th</span>=<span class=\"string\">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">meta</span> <span class=\"attr\">charset</span>=<span class=\"string\">&quot;UTF-8&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">meta</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;viewport&quot;</span> <span class=\"attr\">content</span>=<span class=\"string\">&quot;width=device-width, initial-scale=1, shrink-to-fit=no&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span>登录<span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">link</span> <span class=\"attr\">rel</span>=<span class=\"string\">&quot;stylesheet&quot;</span> <span class=\"attr\">th:href</span>=<span class=\"string\">&quot;@&#123;/webjars/bootstrap/css/bootstrap.min.css&#125;&quot;</span>/&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">th:src</span>=<span class=\"string\">&quot;@&#123;/webjars/jquery/jquery.min.js&#125;&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">th:src</span>=<span class=\"string\">&quot;@&#123;/webjars/bootstrap/js/bootstrap.min.js&#125;&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;container&quot;</span> <span class=\"attr\">style</span>=<span class=\"string\">&quot;width: 320px;margin-top: 100px;&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">h3</span> <span class=\"attr\">align</span>=<span class=\"string\">&quot;center&quot;</span>&gt;</span>OAuth2登录<span class=\"tag\">&lt;/<span class=\"name\">h3</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">p</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;alert-danger&quot;</span> <span class=\"attr\">style</span>=<span class=\"string\">&quot;text-align: center&quot;</span> <span class=\"attr\">th:if</span>=<span class=\"string\">&quot;$&#123;error&#125;&quot;</span>&gt;</span>用户名或密码错误!<span class=\"tag\">&lt;/<span class=\"name\">p</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">p</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;notice_null&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;alert-danger&quot;</span> <span class=\"attr\">style</span>=<span class=\"string\">&quot;text-align: center;&quot;</span>&gt;</span>用户名或密码不能为空!<span class=\"tag\">&lt;/<span class=\"name\">p</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">form</span> <span class=\"attr\">th:action</span>=<span class=\"string\">&quot;@&#123;/login&#125;&quot;</span> <span class=\"attr\">method</span>=<span class=\"string\">&quot;post&quot;</span> <span class=\"attr\">onsubmit</span>=<span class=\"string\">&quot;return onsubmitCheck()&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">table</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;table&quot;</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">tr</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">td</span>&gt;</span>用户名:<span class=\"tag\">&lt;/<span class=\"name\">td</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">td</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;<span class=\"name\">label</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text&quot;</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;username&quot;</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;username&quot;</span>/&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">label</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;/<span class=\"name\">td</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">tr</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">tr</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">td</span>&gt;</span>密码:<span class=\"tag\">&lt;/<span class=\"name\">td</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">td</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;<span class=\"name\">label</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;password&quot;</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;password&quot;</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;password&quot;</span>/&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">label</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;/<span class=\"name\">td</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">tr</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">tr</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">td</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">td</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">td</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;<span class=\"name\">button</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;btn-success&quot;</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;submit&quot;</span>&gt;</span>登录<span class=\"tag\">&lt;/<span class=\"name\">button</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;/<span class=\"name\">td</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">tr</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">table</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">form</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text/javascript&quot;</span>&gt;</span><span class=\"javascript\"></span></span><br><span class=\"line\"><span class=\"javascript\">    $(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"comment\">//默认不显示错误提醒</span></span></span><br><span class=\"line\"><span class=\"javascript\">        $(<span class=\"string\">&quot;#notice_null&quot;</span>).hide();</span></span><br><span class=\"line\"><span class=\"javascript\">    &#125;);</span></span><br><span class=\"line\"><span class=\"javascript\"></span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">onsubmitCheck</span>(<span class=\"params\"></span>)</span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"keyword\">var</span> username = $(<span class=\"string\">&quot;#username&quot;</span>).val();</span></span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"keyword\">var</span> password = $(<span class=\"string\">&quot;#password&quot;</span>).val();</span></span><br><span class=\"line\"><span class=\"javascript\"></span></span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"keyword\">if</span>(username == <span class=\"string\">&quot;&quot;</span> || password == <span class=\"string\">&quot;&quot;</span>)&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">            $(<span class=\"string\">&quot;#notice_null&quot;</span>).show();</span></span><br><span class=\"line\"><span class=\"javascript\">            <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span></span><br><span class=\"line\"><span class=\"javascript\">        &#125;</span></span><br><span class=\"line\"><span class=\"javascript\"></span></span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span></span><br><span class=\"line\"><span class=\"javascript\">    &#125;</span></span><br><span class=\"line\"><span class=\"javascript\"></span></span><br><span class=\"line\"><span class=\"javascript\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"confirm-access-html\"><a href=\"#confirm-access-html\" class=\"headerlink\" title=\"confirm_access.html\"></a>confirm_access.html</h3><ul>\n<li>授权页面<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE <span class=\"meta-keyword\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span> <span class=\"attr\">lang</span>=<span class=\"string\">&quot;en&quot;</span> <span class=\"attr\">xmlns:th</span>=<span class=\"string\">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">meta</span> <span class=\"attr\">charset</span>=<span class=\"string\">&quot;UTF-8&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">meta</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;viewport&quot;</span> <span class=\"attr\">content</span>=<span class=\"string\">&quot;width=device-width, initial-scale=1, shrink-to-fit=no&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span>确认授权页面<span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">META</span> <span class=\"attr\">http-equiv</span>=<span class=\"string\">&quot;Pragma&quot;</span> <span class=\"attr\">content</span>=<span class=\"string\">&quot;no-cache&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">META</span> <span class=\"attr\">http-equiv</span>=<span class=\"string\">&quot;Cache-Control&quot;</span> <span class=\"attr\">content</span>=<span class=\"string\">&quot;no-cache&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">META</span> <span class=\"attr\">http-equiv</span>=<span class=\"string\">&quot;Expire&quot;</span> <span class=\"attr\">content</span>=<span class=\"string\">&quot;0&quot;</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">link</span> <span class=\"attr\">rel</span>=<span class=\"string\">&quot;stylesheet&quot;</span> <span class=\"attr\">th:href</span>=<span class=\"string\">&quot;@&#123;/webjars/bootstrap/css/bootstrap.min.css&#125;&quot;</span> /&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">th:src</span>=<span class=\"string\">&quot;@&#123;/webjars/jquery/jquery.min.js&#125;&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">th:src</span>=<span class=\"string\">&quot;@&#123;/webjars/bootstrap/js/bootstrap.min.js&#125;&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;container&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">section</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;alert alert-warning&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">p</span>&gt;</span>是否授权[ <span class=\"tag\">&lt;<span class=\"name\">span</span> <span class=\"attr\">th:text</span>=<span class=\"string\">&quot;$&#123;session.authorizationRequest.clientId&#125;&quot;</span>&gt;</span>clientId<span class=\"tag\">&lt;/<span class=\"name\">span</span>&gt;</span> ]的访问您的资源：<span class=\"tag\">&lt;/<span class=\"name\">p</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;alert alert-info&quot;</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">form</span> <span class=\"attr\">id</span>=<span class=\"string\">&#x27;confirmationForm&#x27;</span> <span class=\"attr\">name</span>=<span class=\"string\">&#x27;confirmationForm&#x27;</span> <span class=\"attr\">action</span>=<span class=\"string\">&quot;/oauth/authorize&quot;</span> <span class=\"attr\">method</span>=<span class=\"string\">&#x27;post&#x27;</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;user_oauth_approval&quot;</span> <span class=\"attr\">name</span>=<span class=\"string\">&#x27;user_oauth_approval&#x27;</span> <span class=\"attr\">value</span>=<span class=\"string\">&#x27;true&#x27;</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;hidden&#x27;</span>/&gt;</span></span><br><span class=\"line\">                <span class=\"comment\">&lt;!--授权访问领域--&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">span</span> <span class=\"attr\">th:text</span>=<span class=\"string\">&quot;$&#123;&#x27;[&#x27;+s+&#x27;]&#x27;&#125;&quot;</span>  <span class=\"attr\">th:each</span>=<span class=\"string\">&quot;s : $&#123;scopeList&#125;&quot;</span>/&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;btn-success&quot;</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;authorize&quot;</span> <span class=\"attr\">name</span>=<span class=\"string\">&#x27;authorize&#x27;</span> <span class=\"attr\">value</span>=<span class=\"string\">&#x27;授权&#x27;</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;submit&#x27;</span>/&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;btn-primary&quot;</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;refuse&quot;</span> <span class=\"attr\">name</span>=<span class=\"string\">&#x27;refuse&#x27;</span> <span class=\"attr\">value</span>=<span class=\"string\">&#x27;拒绝&#x27;</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;button&#x27;</span>/&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">form</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">section</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text/javascript&quot;</span>&gt;</span><span class=\"javascript\"></span></span><br><span class=\"line\"><span class=\"javascript\">    $(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">        $(<span class=\"string\">&quot;#refuse&quot;</span>).click(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">            $(<span class=\"string\">&quot;#user_oauth_approval&quot;</span>).val(<span class=\"string\">&#x27;false&#x27;</span>);</span></span><br><span class=\"line\"><span class=\"javascript\">            $(<span class=\"string\">&quot;#confirmationForm&quot;</span>).submit();</span></span><br><span class=\"line\"><span class=\"javascript\">        &#125;);</span></span><br><span class=\"line\"><span class=\"javascript\">    &#125;);</span></span><br><span class=\"line\"><span class=\"javascript\"></span></span><br><span class=\"line\"><span class=\"javascript\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"SecurityConfig中开启自定义登录页配置\"><a href=\"#SecurityConfig中开启自定义登录页配置\" class=\"headerlink\" title=\"SecurityConfig中开启自定义登录页配置\"></a>SecurityConfig中开启自定义登录页配置</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http.formLogin()</span><br><span class=\"line\">        .loginPage(<span class=\"string\">&quot;/oauth/login&quot;</span>)</span><br><span class=\"line\">        .loginProcessingUrl(<span class=\"string\">&quot;/login&quot;</span>)</span><br><span class=\"line\">        <span class=\"comment\">//.defaultSuccessUrl(&quot;/&quot;)</span></span><br><span class=\"line\">        .failureForwardUrl(<span class=\"string\">&quot;/oauth/login?error=true&quot;</span>)</span><br><span class=\"line\">        .permitAll(); <span class=\"comment\">//登记界面，默认是permitAll</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"后记\"><a href=\"#后记\" class=\"headerlink\" title=\"后记\"></a>后记</h2>至此，一个基于SpringBoot-OAuth2-JWT的认证服务器就搭建好了，如果client-server和resource-server都是基于spring-security-oauth2搭建的，则认证服务器就不需要其它配置了，client-server和resource-server的代码可以参考<br><a href=\"https://github.com/hanqunfeng/springbootchapter/tree/master/chapter48/oauth2-client-demo\">oauth2-client-demo</a>和<a href=\"https://github.com/hanqunfeng/springbootchapter/tree/master/chapter48/oauth2-resource-server-demo\">oauth2-resource-server-demo</a>，不过spring-security-oauth2已经不再维护了，所以建议搭建client-server和resource-server的时候，还是使用springboot官方提供的<code>spring-boot-starter-oauth2-client</code>和<code>spring-boot-starter-oauth2-resource-server</code>，此时还需要为认证服务增加一些功能，这部分留到后面讲解client-server和resource-server的搭建的时候再说。</li>\n</ul>\n","content_text":"摘要 通过本文，你将知道如何搭建一个基于SpringBoot-OAuth2-JWT的认证服务器 本文基于springboot:2.4.0，项目基于Gradle-6.6.1构建 代码地址:https://github.com/hanqunfeng/springbootchapter/tree/master/chapter48 依赖1234567891011implementation &#x27;org.springframework.boot:spring-boot-starter-web&#x27;//SpringBoot官方没有提供对认证服务的支持，需要自己搭建，//我们可以使用SpringSecurity提供的spring-security-oauth2-autoconfigure进行搭建，//不过SpringSecurity OAuth2项目目前已被弃用，SpringSecurity团队已决定不再为授权服务器提供支持,//所以，在这个版本里你会看到很多弃用的类，如果不想看到类名称上出现烦人的横线，可以使用2.2.10这个版本，测试过程也没发现什么问题的。implementation &#x27;org.springframework.security.oauth.boot:spring-security-oauth2-autoconfigure:2.3.4.RELEASE&#x27;//本项目中使用了lombok简少代码量，非必须依赖compileOnly &#x27;org.projectlombok:lombok&#x27;annotationProcessor &#x27;org.projectlombok:lombok&#x27; 代码说明SecurityConfig 用于配置可以登录系统的用户及其权限，也就是认证服务器的用户 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146package com.example.oauth2authserverdemo.config;import com.example.oauth2authserverdemo.security.CustomSecurityProperties;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.context.annotation.Bean;import org.springframework.context.annotation.Configuration;import org.springframework.security.authentication.AuthenticationManager;import org.springframework.security.config.BeanIds;import org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;import org.springframework.security.config.annotation.web.builders.HttpSecurity;import org.springframework.security.config.annotation.web.builders.WebSecurity;import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;import org.springframework.security.config.http.SessionCreationPolicy;import org.springframework.security.core.authority.SimpleGrantedAuthority;import org.springframework.security.core.userdetails.User;import org.springframework.security.core.userdetails.UserDetailsService;import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;import org.springframework.security.crypto.password.PasswordEncoder;import org.springframework.security.oauth2.server.resource.authentication.JwtAuthenticationToken;import org.springframework.security.provisioning.InMemoryUserDetailsManager;import org.springframework.web.cors.CorsConfiguration;import org.springframework.web.cors.CorsConfigurationSource;import org.springframework.web.cors.UrlBasedCorsConfigurationSource;import java.util.Collection;import java.util.stream.Collectors;/** * Spring-Security配置类,继承WebSecurityConfigurerAdapter * */@Configuration@EnableWebSecurity@EnableGlobalMethodSecurity(prePostEnabled = true)public class SecurityConfig extends WebSecurityConfigurerAdapter &#123; @Autowired private CustomSecurityProperties customSecurityProperties; /** * 引入密码加密类 * * @return */ @Bean public PasswordEncoder passwordEncoder() &#123; return new BCryptPasswordEncoder(); &#125; /** * 为了测试方便，这里使用内存用户模型，真实系统请使用基于RBAC的权限模型 * 用户策略设置，这里使用内存用户策略，自定义策略需要实现UserDetailsService接口 */ @Override @Bean public UserDetailsService userDetailsService() &#123; InMemoryUserDetailsManager inMemoryUserDetailsManager = new InMemoryUserDetailsManager(); User.UserBuilder builder = User.builder().passwordEncoder(passwordEncoder()::encode); inMemoryUserDetailsManager.createUser(builder.username(&quot;admin&quot;).password(&quot;123456&quot;).roles(&quot;admin&quot;).build()); inMemoryUserDetailsManager.createUser(builder.username(&quot;guest&quot;).password(&quot;123456&quot;).roles(&quot;guest&quot;).build()); inMemoryUserDetailsManager.createUser(builder.username(&quot;user&quot;).password(&quot;123456&quot;).roles(&quot;user&quot;).build()); return inMemoryUserDetailsManager; &#125; /** * 指定不拦截的路径规则 */ @Override public void configure(WebSecurity web) throws Exception &#123; //设置不需要拦截的路径，也就是不需要认证的路径 web.ignoring().antMatchers(customSecurityProperties.getIgnoring()); &#125; /** * 配置URL访问授权,必须配置authorizeRequests(),否则启动报错,说是没有启用security技术。 * 注意:在这里的身份进行认证与授权没有涉及到OAuth的技术：当访问要授权的URL时,请求会被DelegatingFilterProxy拦截, * 如果还没有授权,请求就会被重定向到登录界面。在登录成功(身份认证并授权)后,请求被重定向至之前访问的URL。 * * @param http * @throws Exception */ @Override protected void configure(HttpSecurity http) throws Exception &#123; http.formLogin() .permitAll(); //登记界面，默认是permitAll http.authorizeRequests() .antMatchers(customSecurityProperties.getPermitAll()).permitAll() //不用身份认证可以访问 .anyRequest().authenticated(); //其它的请求要求必须有身份认证 http.csrf().disable(); //开启跨域 http.cors(); // session管理 http.sessionManagement() .sessionCreationPolicy(SessionCreationPolicy.IF_REQUIRED); &#125; /** * 支持 password 模式(配置) * * @return * @throws Exception */ @Bean(name = BeanIds.AUTHENTICATION_MANAGER) @Override public AuthenticationManager authenticationManagerBean() throws Exception &#123; return super.authenticationManagerBean(); &#125; /** * 跨域配置类 */ @Bean public CorsConfigurationSource corsConfigurationSource() &#123; CorsConfiguration corsConfiguration = new CorsConfiguration().applyPermitDefaultValues(); //开放哪些ip、端口、域名的访问权限，星号表示开放所有域 corsConfiguration.addAllowedOrigin(&quot;*&quot;); //corsConfiguration.setAllowedOrigins(Arrays.asList(&quot;http://localhost:8080&quot;,&quot;http://localhost:8081&quot;)); //开放哪些Http方法，允许跨域访问 corsConfiguration.addAllowedMethod(&quot;*&quot;); //corsConfiguration.setAllowedMethods(Arrays.asList(&quot;GET&quot;,&quot;POST&quot;, &quot;PUT&quot;, &quot;DELETE&quot;)); //允许HTTP请求中的携带哪些Header信息 corsConfiguration.addAllowedHeader(&quot;*&quot;); //是否允许发送Cookie信息 corsConfiguration.setAllowCredentials(true); //添加映射路径，“/**”表示对所有的路径实行全局跨域访问权限的设置 UrlBasedCorsConfigurationSource configSource = new UrlBasedCorsConfigurationSource(); configSource.registerCorsConfiguration(&quot;/**&quot;, corsConfiguration); return configSource; &#125;&#125; CustomSecurityProperties 自定义属性配置类 12345678910111213@Data@ConfigurationProperties(prefix = &quot;security&quot;)@Componentpublic class CustomSecurityProperties &#123; /** * 不需要验证的路径数组 */ private String[] permitAll; /** * 不需要拦截的路径数组 */ private String[] ignoring;&#125; 配置文件： 1234567891011#springsecurity 自定义属性security: #不需要验证的路径 permitAll: - /redirect/** ignoring: - /webjars/** - /**/*.js/ - /**/*.css - /static/** AuthServerConfig 认证服务器的token关联，本例基于jwt 注意这里定义的是抽象类，还没有声明客户端的配置，具体参加下文说明12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394package com.example.oauth2authserverdemo.config;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.http.HttpMethod;import org.springframework.security.authentication.AuthenticationManager;import org.springframework.security.core.userdetails.UserDetailsService;import org.springframework.security.crypto.password.PasswordEncoder;import org.springframework.security.oauth2.config.annotation.web.configuration.AuthorizationServerConfigurerAdapter;import org.springframework.security.oauth2.config.annotation.web.configurers.AuthorizationServerEndpointsConfigurer;import org.springframework.security.oauth2.config.annotation.web.configurers.AuthorizationServerSecurityConfigurer;import org.springframework.security.oauth2.provider.token.TokenEnhancer;import org.springframework.security.oauth2.provider.token.TokenEnhancerChain;import org.springframework.security.oauth2.provider.token.TokenStore;import org.springframework.security.oauth2.provider.token.store.JwtAccessTokenConverter;import java.util.ArrayList;import java.util.List;public abstract class AuthServerConfig extends AuthorizationServerConfigurerAdapter &#123; @Autowired protected UserDetailsService userDetailsService; @Autowired protected AuthenticationManager authenticationManager; @Autowired protected TokenStore jwtTokenStore; @Autowired protected JwtAccessTokenConverter jwtAccessTokenConverter; @Autowired protected TokenEnhancer jwtTokenEnhancer; @Autowired protected PasswordEncoder passwordEncoder; /** * 1.增加jwt 增强模式 * 2.调用userDetailsService实现UserDetailsService接口,对客户端信息进行认证与授权 * * @param endpoints * @throws Exception */ @Override public void configure(AuthorizationServerEndpointsConfigurer endpoints) throws Exception &#123; // jwt 增强模式 // 对令牌的增强操作就在enhance方法中 // 面在配置类中,将TokenEnhancer和JwtAccessConverter加到一个enhancerChain中 // // 通俗点讲它做了两件事： // 给JWT令牌中设置附加信息和jti：jwt的唯一身份标识,主要用来作为一次性token,从而回避重放攻击 // 判断请求中是否有refreshToken,如果有,就重新设置refreshToken并加入附加信息 TokenEnhancerChain enhancerChain = new TokenEnhancerChain(); List&lt;TokenEnhancer&gt; enhancerList = new ArrayList&lt;TokenEnhancer&gt;(); enhancerList.add(jwtTokenEnhancer); enhancerList.add(jwtAccessTokenConverter); enhancerChain.setTokenEnhancers(enhancerList); //将自定义Enhancer加入EnhancerChain的delegates数组中 endpoints //设置tokenStore .tokenStore(jwtTokenStore) //支持 refresh_token 模式 .userDetailsService(userDetailsService) //支持 password 模式 .authenticationManager(authenticationManager) //token扩展属性 .tokenEnhancer(enhancerChain) //设置token转换器 .accessTokenConverter(jwtAccessTokenConverter) //设置每次通过refresh_token获取新的access_token时，是否重新生成一个新的refresh_token。 //默认true，不重新生成 //.reuseRefreshTokens(true) //设置允许处理的请求类型 .allowedTokenEndpointRequestMethods(HttpMethod.GET,HttpMethod.POST); &#125; @Override public void configure(AuthorizationServerSecurityConfigurer security) throws Exception &#123; security //获取公钥的请求全部允许 .tokenKeyAccess(&quot;permitAll()&quot;) //验证token有效性的请求需要先登录认证 .checkTokenAccess(&quot;isAuthenticated()&quot;) //允许客户端form表单认证，就是可以将client_id和client_secret放到form中提交，否则必须使用Basic认证 .allowFormAuthenticationForClients(); &#125;&#125; JwtTokenConfig 本例基于JWTToken 支持两种密钥策略，对称密钥和基于jks证书的非对称密钥123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172package com.example.oauth2authserverdemo.config;import com.example.oauth2authserverdemo.security.jwt.JWTokenEnhancer;import com.example.oauth2authserverdemo.security.jwt.JwtTokenProperties;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.context.annotation.Bean;import org.springframework.context.annotation.Configuration;import org.springframework.security.oauth2.provider.token.TokenEnhancer;import org.springframework.security.oauth2.provider.token.TokenStore;import org.springframework.security.oauth2.provider.token.store.JwtAccessTokenConverter;import org.springframework.security.oauth2.provider.token.store.JwtTokenStore;import org.springframework.security.oauth2.provider.token.store.KeyStoreKeyFactory;/** * JwtTokenConfig配置类 * 使用TokenStore将引入JwtTokenStore * * 注：Spring-Sceurity使用TokenEnhancer和JwtAccessConverter增强jwt令牌 */@Configurationpublic class JwtTokenConfig &#123; @Autowired private JwtTokenProperties jwtTokenProperties; @Bean public TokenStore jwtTokenStore() &#123; return new JwtTokenStore(jwtAccessTokenConverter()); &#125; /** * JwtAccessTokenConverter：TokenEnhancer的子类,帮助程序在JWT编码的令牌值和OAuth身份验证信息之间进行转换(在两个方向上),同时充当TokenEnhancer授予令牌的时间。 * 自定义的JwtAccessTokenConverter：把自己设置的jwt签名加入accessTokenConverter中(这里设置&#x27;demo&#x27;,项目可将此在配置文件设置) * @return */ @Bean public JwtAccessTokenConverter jwtAccessTokenConverter() &#123; JwtAccessTokenConverter accessTokenConverter = new JwtAccessTokenConverter(); String type = jwtTokenProperties.getType(); switch (type)&#123; case &quot;secret&quot;: //设置加密token的密码 accessTokenConverter.setSigningKey(jwtTokenProperties.getSecret()); //实际上资源服务器只需要设置验证token的密码 accessTokenConverter.setVerifierKey(jwtTokenProperties.getSecret()); break; case &quot;jks&quot;: //非对称加密,jks证书 KeyStoreKeyFactory keyStoreKeyFactory = new KeyStoreKeyFactory(jwtTokenProperties.getJksKeyFileResource(), jwtTokenProperties.getJksStorePassword().toCharArray()); accessTokenConverter.setKeyPair(keyStoreKeyFactory.getKeyPair(jwtTokenProperties.getJksKeyAlias(),jwtTokenProperties.getJksKeyPassword().toCharArray())); break; default: throw new RuntimeException(&quot;请正确配置密钥类型:secret,jks&quot;); &#125; return accessTokenConverter; &#125; /** * 引入自定义JWTokenEnhancer: * 自定义JWTokenEnhancer实现TokenEnhancer并重写enhance方法,将附加信息加入oAuth2AccessToken中 * @return */ @Bean public TokenEnhancer jwtTokenEnhancer()&#123; return new JWTokenEnhancer(); &#125;&#125; JWTokenEnhancer jwt自定义属性123456789101112131415161718192021222324252627282930313233343536package com.example.oauth2authserverdemo.security.jwt;import org.springframework.security.core.userdetails.User;import org.springframework.security.oauth2.common.DefaultOAuth2AccessToken;import org.springframework.security.oauth2.common.OAuth2AccessToken;import org.springframework.security.oauth2.provider.OAuth2Authentication;import org.springframework.security.oauth2.provider.token.TokenEnhancer;import java.util.HashMap;import java.util.Map;/** * TokenEnhancer：在AuthorizationServerTokenServices 实现存储访问令牌之前增强访问令牌的策略。 * 自定义TokenEnhancer的代码：把附加信息加入oAuth2AccessToken中 * */public class JWTokenEnhancer implements TokenEnhancer &#123; /** * 重写enhance方法,将附加信息加入oAuth2AccessToken中 * 这里只是提供附加信息的方式，没需要可以不配置这个类 * @param oAuth2AccessToken * @param oAuth2Authentication * @return */ @Override public OAuth2AccessToken enhance(OAuth2AccessToken oAuth2AccessToken, OAuth2Authentication oAuth2Authentication) &#123; Map&lt;String, Object&gt; map = new HashMap&lt;String, Object&gt;(); User user = (User) oAuth2Authentication.getUserAuthentication().getPrincipal(); map.put(&quot;_username&quot;, user.getUsername()); map.put(&quot;_authorities&quot;, user.getAuthorities()); map.put(&quot;_jwt-ext&quot;, &quot;JWT 扩展信息&quot;); ((DefaultOAuth2AccessToken) oAuth2AccessToken).setAdditionalInformation(map); return oAuth2AccessToken; &#125;&#125; JwtTokenProperties 自定义的jwt相关属性类 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071package com.example.oauth2authserverdemo.security.jwt;import lombok.Data;import org.springframework.boot.context.properties.ConfigurationProperties;import org.springframework.core.io.ClassPathResource;import org.springframework.core.io.PathResource;import org.springframework.core.io.Resource;import org.springframework.stereotype.Component;import java.nio.file.Paths;/** * Jwt工具类*/@Data@ConfigurationProperties(prefix = &quot;jwt&quot;)@Componentpublic class JwtTokenProperties &#123; /** * 密钥类型:secret，jks */ private String type; /** * 密钥 */ private String secret; /** * accessToken过期时间，单位秒 */ private Integer accessTokenValiditySeconds; /** * refreshToken过期时间，单位秒 */ private Integer refreshTokenValiditySeconds; /** * jks证书文件路径 */ private String jksKeyFile; /** * jks证书密钥库密码 */ private String jksStorePassword; /** * jks证书密码 */ private String jksKeyPassword; /** * jks证书别名 */ private String jksKeyAlias; /** * 获取jks证书Resource */ public Resource getJksKeyFileResource()&#123; Resource resource; if (jksKeyFile.startsWith(&quot;classpath:&quot;)) &#123; resource = new ClassPathResource(jksKeyFile.replace(&quot;classpath:&quot;, &quot;&quot;)); &#125; else &#123; resource = new PathResource(Paths.get(jksKeyFile)); &#125; return resource; &#125;&#125; 配置文件： 12345678910111213#自定义jwt属性信息jwt: type: jks # 密钥类型：secret，jks # SECRET 是签名密钥，只生成一次即可，生成方法： # Key key = Keys.secretKeyFor(SignatureAlgorithm.HS512); # String secretString = Encoders.BASE64.encode(key.getEncoded()); # 使用 BASE64 编码 secret: Ayl7bn+aFwxlakekKCJiqUYguKS80bEVb7OZtd2qfZjdCbAwKxDmM6PWezGy5JIkiJfemtHNPc7Av1l+OWQSqQ== # 秘钥 accessTokenValiditySeconds: 43200 # access_token过期时间 (秒) ,默认值12小时 refreshTokenValiditySeconds: 2592000 # refresh_token过期时间 (秒) ,默认值30天 jksKeyFile: classpath:oauth2_key.jks jksStorePassword: 123456 jksKeyAlias: oauth2 jksKeyPassword: 123456 客户端配置 Oauth2支持两种客户端配置方式，基于内存和基于数据库AuthServerConfigByMemory 基于内存12345678910111213141516171819202122232425262728293031323334353637383940414243444546package com.example.oauth2authserverdemo.config;import com.example.oauth2authserverdemo.security.jwt.JwtTokenProperties;import lombok.extern.slf4j.Slf4j;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;import org.springframework.context.annotation.Configuration;import org.springframework.security.oauth2.config.annotation.configurers.ClientDetailsServiceConfigurer;import org.springframework.security.oauth2.config.annotation.web.configuration.EnableAuthorizationServer;@Configuration@EnableAuthorizationServer@ConditionalOnProperty(prefix = &quot;oauth2.clients.config&quot;,name = &quot;jdbc&quot;,havingValue = &quot;false&quot;,matchIfMissing = true)@Slf4jpublic class AuthServerConfigByMemory extends AuthServerConfig&#123; @Autowired private JwtTokenProperties jwtTokenProperties; /** * 配置OAuth2的客户端信息：clientId、client_secret、authorization_type、redirect_url等。 * * @param clients * @throws Exception */ @Override public void configure(ClientDetailsServiceConfigurer clients) throws Exception &#123; clients.inMemory() .withClient(&quot;postman&quot;) .secret(passwordEncoder.encode(&quot;postman&quot;)) .scopes(&quot;any&quot;,&quot;all&quot;) //指定用户的访问范围 //.autoApprove(true) //设置true跳过用户确认授权操作页面直接同意，默认false，必须设置scopes .autoApprove(&quot;any&quot;) //指定客户端访问哪些范围时，跳过用户确认授权操作页面直接同意，必须设置scopes，请求参数必须加上&amp;scope=any .authorizedGrantTypes(&quot;password&quot;, &quot;authorization_code&quot;, &quot;refresh_token&quot;,&quot;implicit&quot;,&quot;client_credentials&quot;) .redirectUris(&quot;http://localhost:8080/redirect&quot;) .accessTokenValiditySeconds(jwtTokenProperties.getAccessTokenValiditySeconds()) //默认12小时 .refreshTokenValiditySeconds(jwtTokenProperties.getRefreshTokenValiditySeconds()) //默认30天 .and() .withClient(&quot;demo-client&quot;) .secret(passwordEncoder.encode(&quot;demo-client&quot;)) .scopes(&quot;any&quot;) .authorizedGrantTypes(&quot;password&quot;, &quot;authorization_code&quot;, &quot;refresh_token&quot;,&quot;implicit&quot;) .redirectUris(&quot;http://localhost:8080/redirect&quot;); log.info(&quot;OAuth2的client信息基于内存&quot;); &#125;&#125; AuthServerConfigByJDBC 基于数据库 1234567891011121314151617181920212223242526272829303132333435363738394041package com.example.oauth2authserverdemo.config;import lombok.extern.slf4j.Slf4j;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;import org.springframework.context.annotation.Configuration;import org.springframework.security.oauth2.config.annotation.configurers.ClientDetailsServiceConfigurer;import org.springframework.security.oauth2.config.annotation.web.configuration.EnableAuthorizationServer;import javax.sql.DataSource;@Slf4j@Configuration@EnableAuthorizationServer@ConditionalOnProperty(prefix = &quot;oauth2.clients.config&quot;, name = &quot;jdbc&quot;, havingValue = &quot;true&quot;)public class AuthServerConfigByJDBC extends AuthServerConfig &#123; @Autowired private DataSource dataSource; /** * 配置OAuth2的客户端信息：clientId、client_secret、authorization_type、redirect_url等。 * * @param clients * @throws Exception */ @Override public void configure(ClientDetailsServiceConfigurer clients) throws Exception &#123; //方式1 也可以自定义ClientDetailsService的实现类 //JdbcClientDetailsService detailsService = new JdbcClientDetailsService(dataSource); //detailsService.setPasswordEncoder(passwordEncoder); //clients.withClientDetails(detailsService); //方式2 等价于方式1 clients.jdbc(dataSource) //指定密码的加密算法 .passwordEncoder(passwordEncoder); log.info(&quot;OAuth2的client信息基于数据库&quot;); &#125;&#125; 为了支持jdbc需要引入依赖 1234//mysqlruntimeOnly &#x27;mysql:mysql-connector-java&#x27;//为了使用datasourceimplementation &#x27;org.springframework.boot:spring-boot-starter-jdbc&#x27; 配置文件 123456789101112spring: #数据源配置 datasource: url: jdbc:mysql://localhost:3306/springboot?useUnicode=true&amp;characterEncoding=utf-8&amp;useTimezone=true&amp;serverTimezone=GMT%2B8 username: root password: newpwd driver-class-name: com.mysql.cj.jdbc.Driver hikari: connection-timeout: 30000 #毫秒，默认30秒 idle-timeout: 600000 #毫秒，默认10分钟 max-lifetime: 1800000 #毫秒，默认30分钟 maximum-pool-size: 10 #默认10 数据表 123456789101112131415161718192021-- oauth2中规定的数据表,需要手动创建,一般项目中提供服务接口插入,参数由用户定义,在请求时会自动查询服务器中对应的参数数据匹配认证# 客户端注册信息表CREATE TABLE `oauth_client_details` ( `client_id` varchar(256) NOT NULL COMMENT &#x27;客户端的id&#x27;, `resource_ids` varchar(256) DEFAULT NULL COMMENT &#x27;资源服务器的id，多个用，(逗号)隔开&#x27;, `client_secret` varchar(256) DEFAULT NULL COMMENT &#x27;客户端的秘钥，需要PasswordEncoder加密&#x27;, `scope` varchar(256) DEFAULT NULL COMMENT &#x27;客户端的访问范围，多个逗号分隔&#x27;, `authorized_grant_types` varchar(256) DEFAULT NULL COMMENT &#x27;认证的方式，可选值 授权码模式:authorization_code,密码模式:password,刷新token: refresh_token, 隐式模式: implicit: 客户端模式: client_credentials。支持多个用逗号分隔&#x27;, `web_server_redirect_uri` varchar(256) DEFAULT NULL COMMENT &#x27;授权码模式认证成功跳转的地址。authorization_code和implicit需要该值进行校验，注册时填写，多个逗号分隔&#x27;, `authorities` varchar(256) DEFAULT NULL, `access_token_validity` int(11) DEFAULT NULL COMMENT &#x27;access_token的有效时间(秒),默认(60 * 60 * 12,12小时)&#x27;, `refresh_token_validity` int(11) DEFAULT NULL COMMENT &#x27;refresh_token有效期(秒)，默认(60 *60 * 24 * 30, 30天)&#x27;, `additional_information` varchar(4096) DEFAULT NULL COMMENT &#x27;附加信息，值必须是json格式&#x27;, `autoapprove` varchar(256) DEFAULT NULL COMMENT &#x27;默认false,适用于authorization_code模式,设置用户是否自动approval操作,设置true跳过用户确认授权操作页面，直接跳到redirect_uri，也可以这只scope中设置的值，表示只有这个scope会跳过授权页面，多个scope逗号分隔&#x27;, PRIMARY KEY (`client_id`) USING BTREE) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC;# 初始化数据，密码要经过PasswordEncoder加密INSERT INTO `oauth_client_details` VALUES (&#x27;postman&#x27;, NULL, &#x27;$2a$10$Owubqs9VaN.vmskZ2B0UTe0GmOMwgTmhGtlIFBjrfCz2glBqISHSu&#x27;, &#x27;any,all&#x27;, &#x27;authorization_code,refresh_token,implicit,password,client_credentials&#x27;, &#x27;http://localhost:8080/redirect,http://localhost:8088/postman/login&#x27;, NULL, 42300, 2592000, NULL, &#x27;any&#x27;);INSERT INTO `oauth_client_details` VALUES (&#x27;demo-client&#x27;, NULL, &#x27;$2a$10$v/B9.6c9NUXFbJDHqc28he6VWeyJNOBOD1UI7bwBDfBZTwY4zzcda&#x27;, &#x27;any&#x27;, &#x27;authorization_code,refresh_token,password&#x27;, &#x27;http://localhost:8080/redirect&#x27;, NULL, 42300, 2592000, NULL, &#x27;&#x27;); 为了方便在内存和jdbc中切换，增加了自定义属性 12345#oauth2的client信息是基于内存还是基于数据库，如果不配置，默认为基于内存oauth2: clients: config: jdbc: true jks证书创建生成jks证书123456789101112131415161718192021222324252627282930313233# 默认证书有效期3个月$ keytool -genkeypair -alias oauth2 -keyalg RSA -keysize 2048 -keypass 123456 -keystore oauth2_key.jks -storepass 123456# 指定证书有效期，这里设置有效期大约10年$ keytool -genkeypair -alias oauth2 -keyalg RSA -keysize 2048 -validity 36500 -keypass 123456 -keystore oauth2_key.jks -storepass 123456您的名字与姓氏是什么? [Unknown]: han您的组织单位名称是什么? [Unknown]: han您的组织名称是什么? [Unknown]: han您所在的城市或区域名称是什么? [Unknown]: bj您所在的省/市/自治区名称是什么? [Unknown]: bj该单位的双字母国家/地区代码是什么? [Unknown]: zhCN=han, OU=han, O=han, L=bj, ST=bj, C=zh是否正确? [否]: yWarning:JKS 密钥库使用专用格式。建议使用 &quot;keytool -importkeystore -srckeystore oauth2_key.jks -destkeystore oauth2_key.jks -deststoretype pkcs12&quot; 迁移到行业标准格式 PKCS12。# 按照警告执行如下命令$ keytool -importkeystore -srckeystore oauth2_key.jks -destkeystore oauth2_key.jks -deststoretype pkcs12输入源密钥库口令:已成功导入别名 oauth2 的条目。已完成导入命令: 1 个条目成功导入, 0 个条目失败或取消Warning:已将 &quot;oauth2_key.jks&quot; 迁移到 Non JKS/JCEKS。将 JKS 密钥库作为 &quot;oauth2_key.jks.old&quot; 进行了备份。 导出公钥12345678910111213141516171819202122232425262728293031$ keytool -list -rfc --keystore oauth2_key.jks | openssl x509 -inform pem -pubkey输入密钥库口令: 123456-----BEGIN PUBLIC KEY-----MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAmVdbw3XtFamdasjItlkom8SyJiH0DnSUm1tqJDHY9orHA+0oa+VAlvxiHHBegKMX6FmCX3HAoVzHuAlWAZp0FyV0SUR4/tuOKOw/N7HbKGa/JZJSfaNdJAEobRxzd8woaLNlCRLelzDPhMy9kGtpx+Kc60smeo6XpC7RT25Mf5DRvKRJo4RGbPQNj18hWKZtY/TFZYySpa57eI9VOM5ufvWJkh3Jm5cOXHiHScmF4mdNATR3XQTHXD+TDu0rLgn7H4ap9uYDRTNVGVJ/JfYuaCrzszMFt4b+JNxz1UL42tTgbtKj8TxUrTRGTI/7KiwD5wjtpISSxlqoK1c0qgChKQIDAQAB-----END PUBLIC KEY----------BEGIN CERTIFICATE-----MIIDQTCCAimgAwIBAgIEZ0BO+jANBgkqhkiG9w0BAQsFADBRMQswCQYDVQQGEwJ6aDELMAkGA1UECBMCYmoxCzAJBgNVBAcTAmJqMQwwCgYDVQQKEwNoYW4xDDAKBgNVBAsTA2hhbjEMMAoGA1UEAxMDaGFuMB4XDTIwMTEwODEyNDI0M1oXDTIxMDIwNjEyNDI0M1owUTELMAkGA1UEBhMCemgxCzAJBgNVBAgTAmJqMQswCQYDVQQHEwJiajEMMAoGA1UEChMDaGFuMQwwCgYDVQQLEwNoYW4xDDAKBgNVBAMTA2hhbjCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAJlXW8N17RWpnWrIyLZZKJvEsiYh9A50lJtbaiQx2PaKxwPtKGvlQJb8YhxwXoCjF+hZgl9xwKFcx7gJVgGadBcldElEeP7bjijsPzex2yhmvyWSUn2jXSQBKG0cc3fMKGizZQkS3pcwz4TMvZBracfinOtLJnqOl6Qu0U9uTH+Q0bykSaOERmz0DY9fIVimbWP0xWWMkqWue3iPVTjObn71iZIdyZuXDlx4h0nJheJnTQE0d10Ex1w/kw7tKy4J+x+GqfbmA0UzVRlSfyX2Lmgq87MzBbeG/iTcc9VC+NrU4G7So/E8VK00RkyP+yosA+cI7aSEksZaqCtXNKoAoSkCAwEAAaMhMB8wHQYDVR0OBBYEFKM+xW8pT4EHc+5/svExkEKw8c3CMA0GCSqGSIb3DQEBCwUAA4IBAQB3OHZ1BrT+2hUFxhAk7K/7hC8tHVF8iRXhGBdnZWHNz2GRfzxOeyS4AmkpwCixoKg9GPhUL1fxBya7Z7wjn4jS5f9b5q40c/fP23zIrmbJ3rsqlMnx3vqrcnJBKF1l9i9h4iLDoTSS1HC42CuPSCSV/4/g2zXrZPWMVMHPHM9Ul8q+aTE7VaRzRsf8h7xCeqZXRg2z+wFHH4B1LMcfOHwpGWVJ46xgNqt3cx4IovVTcuXbcQGKgd2+/UuQvugI0kWUCOH+CME9wbncIEJlDT1510GJIyt4EWyU3nio+vsLnlKz2jRP7QSE5dxYps3Y1u9/nrBl1yK4+KEFAguUikbp-----END CERTIFICATE----- 这段就是公钥，保存到文件即可123456789-----BEGIN PUBLIC KEY-----MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAmVdbw3XtFamdasjItlkom8SyJiH0DnSUm1tqJDHY9orHA+0oa+VAlvxiHHBegKMX6FmCX3HAoVzHuAlWAZp0FyV0SUR4/tuOKOw/N7HbKGa/JZJSfaNdJAEobRxzd8woaLNlCRLelzDPhMy9kGtpx+Kc60smeo6XpC7RT25Mf5DRvKRJo4RGbPQNj18hWKZtY/TFZYySpa57eI9VOM5ufvWJkh3Jm5cOXHiHScmF4mdNATR3XQTHXD+TDu0rLgn7H4ap9uYDRTNVGVJ/JfYuaCrzszMFt4b+JNxz1UL42tTgbtKj8TxUrTRGTI/7KiwD5wjtpISSxlqoK1c0qgChKQIDAQAB-----END PUBLIC KEY----- 查看密钥信息123456789101112131415161718192021222324252627282930313233343536373839$ keytool -list -v -keystore oauth2_key.jks输入密钥库口令:密钥库类型: PKCS12密钥库提供方: SUN您的密钥库包含 1 个条目别名: oauth2创建日期: 2020-11-9条目类型: PrivateKeyEntry证书链长度: 1证书[1]:所有者: CN=han, OU=han, O=han, L=bj, ST=bj, C=zh发布者: CN=han, OU=han, O=han, L=bj, ST=bj, C=zh序列号: 67404efa有效期为 Sun Nov 08 20:42:43 CST 2020 至 Sat Feb 06 20:42:43 CST 2021证书指纹: MD5: 3E:15:19:80:91:10:00:A8:63:A6:5E:19:5A:0E:A9:E5 SHA1: E8:BB:68:99:7E:33:6D:51:40:EF:C0:AC:91:A6:93:15:ED:FE:F8:3A SHA256: CE:C7:C3:BF:BB:94:28:64:1B:EC:1C:F3:A9:DC:40:C5:53:AD:F2:27:01:83:8D:37:90:E0:EB:DB:C9:73:A5:5C签名算法名称: SHA256withRSA主体公共密钥算法: 2048 位 RSA 密钥版本: 3扩展:#1: ObjectId: 2.5.29.14 Criticality=falseSubjectKeyIdentifier [KeyIdentifier [0000: A3 3E C5 6F 29 4F 81 07 73 EE 7F B2 F1 31 90 42 .&gt;.o)O..s....1.B0010: B0 F1 CD C2 ....]]************************************************************************************** OAuth2支持获取access_token的方式 authorization_code 验证码模式 implicit 隐式模式 password 密码模式 client_credentials 客户端模式 refresh_token 刷新token模式 Oauth2提供的默认端点（endpoints）123456/oauth/authorize：授权端点 AuthorizationEndpoint 按照OAuth 2.0规范的授权实现/oauth/token：令牌端点 TokenEndpoint 按照OAuth 2.0规范请求Token/oauth/confirm_access：用户确认授权提交端点/oauth/error：授权服务错误信息端点/oauth/check_token：用于资源服务访问的令牌解析端点 CheckTokenEndpoint 解码Client的Access Token用来检查和确认生成的Token/oauth/token_key：提供公有密匙的端点，如果使用JWT令牌的话 TokenKeyEndpoint 提供JWT编码的Token 验证码模式–authorization_code，最常用的模式 获取验证码 12浏览器GEThttp://localhost:8080/oauth/authorize?client_id=postman&amp;response_type=code&amp;redirect_uri=http://localhost:8080/redirect 1.1 参数说明1234response_type=code #授权码认证，固定值client_id=postman #客户端idredirect_uri=http://localhost:8080/redirect #重定向url，这个值要与配置的值一致，配置这个值时可以配置一个不存在的路径scope=any 可选参数，指定请求范围，如果不希望跳转到确认页面而是直接通过，需要在代码中配置autoApprove(true)或者autoApprove(&quot;any&quot;) 1.2 跳转到登录页面，使用admin/123456登录 1.3 登录成功后跳转到认证确认页面(如果不希望跳转到确认页面而是直接通过，需要在代码中配置autoApprove(true))，点击Authorize按钮，页面会跳转到http://localhost:8080/redirect?code=7ak4gI 1.4 复制code的值进入第二步 获取access_token和refresh_token 12POSThttp://localhost:8080/oauth/token?grant_type=authorization_code&amp;client_id=postman&amp;client_secret=postman&amp;redirect_uri=http://localhost:8080/redirect&amp;code=7ak4gI 2.1 code存在有效期，且只能使用一次，所以这个请求只能使用一次，参数说明12345grant_type=authorization_code #验证code并获取access_token，固定值client_id=postman #客户端idclient_secret=postman #客户端密码redirect_uri=http://localhost:8080/redirect #重定向urlcode=7ak4gI #上一步中获取到的code值 2.2 响应结果如下，默认access_token有效期12小时，refresh_token有效期30天123456789&#123; &quot;access_token&quot;: &quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX25hbWUiOiJhZG1pbiIsImp3dC1leHQiOiJKV1Qg5omp5bGV5L-h5oGvIiwic2NvcGUiOlsiYW55Il0sImV4cCI6MTYwNDYxMzI3MywiYXV0aG9yaXRpZXMiOlsiUk9MRV9hZG1pbiJdLCJqdGkiOiJhNzFhMDJhYy02NzgyLTRiODEtOGJiMi1mMGI3ZWVkODk2YTgiLCJjbGllbnRfaWQiOiJwb3N0bWFuIn0.SKl-0KbdVvv3acqLlXre66PX-fFIruTLwOkCO3peby0&quot;, &quot;token_type&quot;: &quot;bearer&quot;, &quot;refresh_token&quot;: &quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX25hbWUiOiJhZG1pbiIsImp3dC1leHQiOiJKV1Qg5omp5bGV5L-h5oGvIiwic2NvcGUiOlsiYW55Il0sImF0aSI6ImE3MWEwMmFjLTY3ODItNGI4MS04YmIyLWYwYjdlZWQ4OTZhOCIsImV4cCI6MTYwNzE2MjA3MywiYXV0aG9yaXRpZXMiOlsiUk9MRV9hZG1pbiJdLCJqdGkiOiI5NzRjMDRkOS03NTQ0LTRjZTEtODMzZS05NjlmODMyNmRiNmQiLCJjbGllbnRfaWQiOiJwb3N0bWFuIn0.vy16MpRikSFFz_n2zJEgI5Cfy1APNDrvnuP7Sj1jqJU&quot;, &quot;expires_in&quot;: 43199, &quot;scope&quot;: &quot;any&quot;, &quot;jwt-ext&quot;: &quot;JWT 扩展信息&quot;, &quot;jti&quot;: &quot;a71a02ac-6782-4b81-8bb2-f0b7eed896a8&quot;&#125; 2.3 复制refresh_token的值进入第三步 2.4 请求时支持base认证方式，详见3.3 通过refresh_token获取新的access_token 12POSThttp://localhost:8080/oauth/token?grant_type=refresh_token&amp;client_id=postman&amp;client_secret=postman&amp;refresh_token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX25hbWUiOiJhZG1pbiIsImp3dC1leHQiOiJKV1Qg5omp5bGV5L-h5oGvIiwic2NvcGUiOlsiYW55Il0sImF0aSI6ImE3MWEwMmFjLTY3ODItNGI4MS04YmIyLWYwYjdlZWQ4OTZhOCIsImV4cCI6MTYwNzE2MjA3MywiYXV0aG9yaXRpZXMiOlsiUk9MRV9hZG1pbiJdLCJqdGkiOiI5NzRjMDRkOS03NTQ0LTRjZTEtODMzZS05NjlmODMyNmRiNmQiLCJjbGllbnRfaWQiOiJwb3N0bWFuIn0.vy16MpRikSFFz_n2zJEgI5Cfy1APNDrvnuP7Sj1jqJU 3.1 参数说明，这个就是refresh_token模式，需要先获取到上一次的refresh_token1234grant_type=refresh_token #刷新token的参数，固定值client_id=postman #客户端idclient_secret=postman #客户端密码refresh_token=xxx #上一步中获取的refresh_token值 3.2 响应结果如下，获取到新的access_token和refresh_token，注意保存，access_token过期时，可以通过该请求重新获得新的access_token123456789&#123; &quot;access_token&quot;: &quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX25hbWUiOiJhZG1pbiIsImp3dC1leHQiOiJKV1Qg5omp5bGV5L-h5oGvIiwic2NvcGUiOlsiYW55Il0sImV4cCI6MTYwNDYxMzc4NSwiYXV0aG9yaXRpZXMiOlsiUk9MRV9hZG1pbiJdLCJqdGkiOiI5YWQ1MTBhNy00MzQyLTQ5M2UtYjQyMS1iNzNmMDU2NmU3OWYiLCJjbGllbnRfaWQiOiJwb3N0bWFuIn0.L0TPZ-NDzT4hSSivQ0WR-5rPz6xoLbC_HmdvvKOzP_Y&quot;, &quot;token_type&quot;: &quot;bearer&quot;, &quot;refresh_token&quot;: &quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX25hbWUiOiJhZG1pbiIsImp3dC1leHQiOiJKV1Qg5omp5bGV5L-h5oGvIiwic2NvcGUiOlsiYW55Il0sImF0aSI6IjlhZDUxMGE3LTQzNDItNDkzZS1iNDIxLWI3M2YwNTY2ZTc5ZiIsImV4cCI6MTYwNzE2MjA3MywiYXV0aG9yaXRpZXMiOlsiUk9MRV9hZG1pbiJdLCJqdGkiOiI5NzRjMDRkOS03NTQ0LTRjZTEtODMzZS05NjlmODMyNmRiNmQiLCJjbGllbnRfaWQiOiJwb3N0bWFuIn0.ekAST3MRc0PqW3FZgnFQv1g-HykCqA4_TuzLRTplCIM&quot;, &quot;expires_in&quot;: 43199, &quot;scope&quot;: &quot;any&quot;, &quot;jwt-ext&quot;: &quot;JWT 扩展信息&quot;, &quot;jti&quot;: &quot;9ad510a7-4342-493e-b421-b73f0566e79f&quot;&#125; 3.3 请求时支持base认证方式 12# 将client_id和client_secret放到url的前面POST http://postman:postman@localhost:8080/oauth/token?grant_type=refresh_token&amp;refresh_token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX25hbWUiOiJhZG1pbiIsImp3dC1leHQiOiJKV1Qg5omp5bGV5L-h5oGvIiwic2NvcGUiOlsiYW55Il0sImF0aSI6ImM4NWM0YjJlLTBlNTktNDJhYy05M2RlLWI2N2I0OWI1ZDU5OSIsImV4cCI6MTYwNzIyMDAxMiwiYXV0aG9yaXRpZXMiOlsiUk9MRV9hZG1pbiJdLCJqdGkiOiI2M2U2MGYxOS1iOTU1LTRlMmUtODk2Yy1mYWUxN2IyODUzMzkiLCJjbGllbnRfaWQiOiJwb3N0bWFuIn0.jVZWYRjr4VwTYwbKXP-sav_08vwc8iAxzEbg0I_jVTw 或者在header中增加Authorization请求头，值为Basic xxxxxxxxx，xxxxxxxxx是通过base64.encode(client_id + 空格 + client_secret)得到。 使用Postman接口测试工具时，也可以使用其提供的认证功能[Authorization–&gt;TYPE–&gt;Basic Auth]，直接填写用户名和密码就可以方便进行测试，注意这里用户名和密码是client_id 和 client_secret。 123456789&#123; &quot;access_token&quot;: &quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX25hbWUiOiJhZG1pbiIsImp3dC1leHQiOiJKV1Qg5omp5bGV5L-h5oGvIiwic2NvcGUiOlsiYW55Il0sImV4cCI6MTYwNDY4NTE3NiwiYXV0aG9yaXRpZXMiOlsiUk9MRV9hZG1pbiJdLCJqdGkiOiJhNDhiNzZhNC1kNWM0LTRkNTYtYmQ2Yy0zOWYxODQ0MGYwNTMiLCJjbGllbnRfaWQiOiJwb3N0bWFuIn0.mhNUhWk1M9p267bOsv3fYXnLGeXitvnny6mUT9FyNdw&quot;, &quot;token_type&quot;: &quot;bearer&quot;, &quot;refresh_token&quot;: &quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX25hbWUiOiJhZG1pbiIsImp3dC1leHQiOiJKV1Qg5omp5bGV5L-h5oGvIiwic2NvcGUiOlsiYW55Il0sImF0aSI6ImE0OGI3NmE0LWQ1YzQtNGQ1Ni1iZDZjLTM5ZjE4NDQwZjA1MyIsImV4cCI6MTYwNzIyMDAxMiwiYXV0aG9yaXRpZXMiOlsiUk9MRV9hZG1pbiJdLCJqdGkiOiI2M2U2MGYxOS1iOTU1LTRlMmUtODk2Yy1mYWUxN2IyODUzMzkiLCJjbGllbnRfaWQiOiJwb3N0bWFuIn0.DT_cBdcow7pDv_S9RTHknKLHxZAIT45Byw1Rdw93K8U&quot;, &quot;expires_in&quot;: 43199, &quot;scope&quot;: &quot;any&quot;, &quot;jwt-ext&quot;: &quot;JWT 扩展信息&quot;, &quot;jti&quot;: &quot;a48b76a4-d5c4-4d56-bd6c-39f18440f053&quot;&#125; 3.4 access_token信息12345678910111213141516171819//HEADER&#123; &quot;alg&quot;: &quot;HS256&quot;, &quot;typ&quot;: &quot;JWT&quot;&#125;//PAYLOAD&#123; &quot;user_name&quot;: &quot;admin&quot;, &quot;jwt-ext&quot;: &quot;JWT 扩展信息&quot;, &quot;scope&quot;: [ &quot;any&quot; ], &quot;exp&quot;: 1604613785, &quot;authorities&quot;: [ &quot;ROLE_admin&quot; ], &quot;jti&quot;: &quot;9ad510a7-4342-493e-b421-b73f0566e79f&quot;, &quot;client_id&quot;: &quot;postman&quot;&#125; implicit模式 仅可获取access_token，不能获取refresh_token 跳转到登录页面12浏览器GEThttp://localhost:8080/oauth/authorize?client_id=postman&amp;response_type=token&amp;redirect_uri=http://localhost:8080/redirect 然后登录，然后同意授权 返回结果直接拼接在redirect_uri的后面，因为是以#开头，所以服务器端无法收到数据，只能从浏览器中获取了 1http://localhost:8080/redirect#access_token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX25hbWUiOiJhZG1pbiIsImp3dC1leHQiOiJKV1Qg5omp5bGV5L-h5oGvIiwic2NvcGUiOlsiYW55Il0sImV4cCI6MTYwNDY3NTMwNSwiYXV0aG9yaXRpZXMiOlsiUk9MRV9hZG1pbiJdLCJqdGkiOiI4ZDcyODM5NC0zODhjLTRiMjAtYjgwYy1jNTk4OWJjZmJlM2IiLCJjbGllbnRfaWQiOiJwb3N0bWFuIn0.OStAhkT6fBoNLdF7vTaztwhfNV5J8K1MpE1A7pxbyCs&amp;token_type=bearer&amp;expires_in=43199&amp;scope=any&amp;jwt-ext=JWT%20%E6%89%A9%E5%B1%95%E4%BF%A1%E6%81%AF&amp;jti=8d728394-388c-4b20-b80c-c5989bcfbe3b access_token信息12345678910111213141516171819//HEADER&#123; &quot;alg&quot;: &quot;HS256&quot;, &quot;typ&quot;: &quot;JWT&quot;&#125;//PAYLOAD&#123; &quot;user_name&quot;: &quot;admin&quot;, &quot;jwt-ext&quot;: &quot;JWT 扩展信息&quot;, &quot;scope&quot;: [ &quot;any&quot; ], &quot;exp&quot;: 1604675305, &quot;authorities&quot;: [ &quot;ROLE_admin&quot; ], &quot;jti&quot;: &quot;8d728394-388c-4b20-b80c-c5989bcfbe3b&quot;, &quot;client_id&quot;: &quot;postman&quot;&#125; password 模式 密码模式（Resource Owner Password Credentials Grant）中，用户向客户端提供自己的用户名和密码。客户端使用这些信息，向”服务商提供商”索要授权。 在这种模式中，用户必须把自己的密码给客户端，但是客户端不得储存密码。这通常用在用户对客户端高度信任的情况下，比如客户端是操作系统的一部分，或者由一个著名公司出品。而认证服务器只有在其他授权模式无法执行的情况下，才能考虑使用这种模式。 获取access_token和refresh_token12POSThttp://localhost:8080/oauth/token?username=admin&amp;password=123456&amp;grant_type=password&amp;client_id=postman&amp;client_secret=postman 请求时支持base认证方式，认证用户名和密码是client_id 和 client_secret grant_type=password，需要携带用户的用户名和密码 返回结果123456789&#123; &quot;access_token&quot;: &quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX25hbWUiOiJhZG1pbiIsImp3dC1leHQiOiJKV1Qg5omp5bGV5L-h5oGvIiwic2NvcGUiOlsiYW55Il0sImV4cCI6MTYwNDY3NzU1MiwiYXV0aG9yaXRpZXMiOlsiUk9MRV9hZG1pbiJdLCJqdGkiOiJlNjZiMWFjOS04M2RmLTRiNTMtYjNmYS1mMTQyYzA2MTYzMjkiLCJjbGllbnRfaWQiOiJwb3N0bWFuIn0.jfBeoA-AeNaMUSWHKBktN8IOFbGJHtQSIQUgxP8zzg0&quot;, &quot;token_type&quot;: &quot;bearer&quot;, &quot;refresh_token&quot;: &quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX25hbWUiOiJhZG1pbiIsImp3dC1leHQiOiJKV1Qg5omp5bGV5L-h5oGvIiwic2NvcGUiOlsiYW55Il0sImF0aSI6ImU2NmIxYWM5LTgzZGYtNGI1My1iM2ZhLWYxNDJjMDYxNjMyOSIsImV4cCI6MTYwNzIyNjM1MiwiYXV0aG9yaXRpZXMiOlsiUk9MRV9hZG1pbiJdLCJqdGkiOiI5MDUwNTQ0Yi00OGVmLTQ2OWMtYjM3OS1lMWQyZDViOTcyYjkiLCJjbGllbnRfaWQiOiJwb3N0bWFuIn0.fGDixRXD68cYdRTjprH3TM7gAGmFqDAaKxs3RTxphMs&quot;, &quot;expires_in&quot;: 43199, &quot;scope&quot;: &quot;any&quot;, &quot;jwt-ext&quot;: &quot;JWT 扩展信息&quot;, &quot;jti&quot;: &quot;e66b1ac9-83df-4b53-b3fa-f142c0616329&quot;&#125; access_token信息12345678910111213141516171819//HEADER&#123; &quot;alg&quot;: &quot;HS256&quot;, &quot;typ&quot;: &quot;JWT&quot;&#125;//PAYLOAD&#123; &quot;user_name&quot;: &quot;admin&quot;, &quot;jwt-ext&quot;: &quot;JWT 扩展信息&quot;, &quot;scope&quot;: [ &quot;any&quot; ], &quot;exp&quot;: 1604677552, &quot;authorities&quot;: [ &quot;ROLE_admin&quot; ], &quot;jti&quot;: &quot;e66b1ac9-83df-4b53-b3fa-f142c0616329&quot;, &quot;client_id&quot;: &quot;postman&quot;&#125; client_credentials 客户端模式 客户端模式（Client Credentials Grant）指客户端以自己的名义，而不是以用户的名义，向”服务提供商”进行认证。严格地说，客户端模式并不属于OAuth框架所要解决的问题。在这种模式中，用户直接向客户端注册，客户端以自己的名义要求”服务提供商”提供服务，其实不存在授权问题。 获取access_token12POSThttp://localhost:8080/oauth/token?grant_type=client_credentials&amp;client_id=postman&amp;client_secret=postman 不需要用户的用户名和密码，只是认证客户端是否有效，返回的access_token的payload中也不包含任何用户信息(user_name,authorities) 没有refresh_token 返回结果12345678&#123; &quot;access_token&quot;: &quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqd3QtZXh0IjoiSldUIOaJqeWxleS_oeaBryIsInNjb3BlIjpbImFueSJdLCJleHAiOjE2MDQ2Nzc4NjksImp0aSI6ImU3ZjJhYTEyLTFhMWUtNGFmMC04MjJkLTkxNzg5NmYyMGMwMyIsImNsaWVudF9pZCI6InBvc3RtYW4ifQ.OHy0IUGf9KSmCDKlqq1IZ8bICAhBHFtpazwK1gcbCOI&quot;, &quot;token_type&quot;: &quot;bearer&quot;, &quot;expires_in&quot;: 43199, &quot;scope&quot;: &quot;any&quot;, &quot;jwt-ext&quot;: &quot;JWT 扩展信息&quot;, &quot;jti&quot;: &quot;e7f2aa12-1a1e-4af0-822d-917896f20c03&quot;&#125; access_token信息123456789101112131415//HEADER&#123; &quot;alg&quot;: &quot;HS256&quot;, &quot;typ&quot;: &quot;JWT&quot;&#125;//PAYLOAD&#123; &quot;jwt-ext&quot;: &quot;JWT 扩展信息&quot;, &quot;scope&quot;: [ &quot;any&quot; ], &quot;exp&quot;: 1604677869, &quot;jti&quot;: &quot;e7f2aa12-1a1e-4af0-822d-917896f20c03&quot;, &quot;client_id&quot;: &quot;postman&quot;&#125; refresh_token模式，见验证码模式第3部分通过已有的refresh_token获取新的access_token和refresh_token 验证token有效性–Basic Auth1POST http://postman:postman@localhost:8080/oauth/check_token?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX25hbWUiOiJhZG1pbiIsImp3dC1leHQiOiJKV1Qg5omp5bGV5L-h5oGvIiwic2NvcGUiOlsiYW55IiwiYWxsIl0sImV4cCI6MTYwNDcxNjMyMCwiYXV0aG9yaXRpZXMiOlsiUk9MRV9hZG1pbiJdLCJqdGkiOiIxNjc4ZTNhYy0yYmNjLTQ4NGUtOTBkMy02ZWFjYTVkNzkyM2IiLCJjbGllbnRfaWQiOiJwb3N0bWFuIn0.8piTJdoAf-4lB0Tn-yeSFWoV3WpkJkqBs7AsoNPoohw 或者加上Header参数Authorization 值为 Basic cG9zdG1hbjpwb3N0bWFu 返回值 1234567891011121314&#123; &quot;user_name&quot;: &quot;admin&quot;, &quot;jwt-ext&quot;: &quot;JWT 扩展信息&quot;, &quot;scope&quot;: [ &quot;any&quot; ], &quot;active&quot;: true, &quot;exp&quot;: 1604767911, &quot;authorities&quot;: [ &quot;ROLE_admin&quot; ], &quot;jti&quot;: &quot;5597b675-a617-4e02-959f-86d62024a237&quot;, &quot;client_id&quot;: &quot;postman&quot;&#125; 获取公钥，比如JWT的密钥1GET http://postman:postman@localhost:8080/oauth/token_key 或者加上Header参数Authorization 值为 Basic cG9zdG1hbjpwb3N0bWFu 返回值 1234&#123; &quot;alg&quot;: &quot;HMACSHA256&quot;, &quot;value&quot;: &quot;Ayl7bn+aFwxlakekKCJiqUYguKS80bEVb7OZtd2qfZjdCbAwKxDmM6PWezGy5JIkiJfemtHNPc7Av1l+OWQSqQ==&quot;&#125; 自定义登录和授权页面依赖123456implementation &#x27;org.springframework.boot:spring-boot-starter-thymeleaf&#x27;//webjars https://www.webjars.orgimplementation &#x27;org.webjars:bootstrap:4.5.3&#x27;implementation &#x27;org.webjars.bower:jquery:3.5.1&#x27;// 可以在html中去掉webjars的版本号，这样升级的时候直接修改上面引入的webjars中的版本号即可，页面中不需要修改implementation &#x27;org.webjars:webjars-locator:0.40&#x27; OAuth2Controller123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566package com.example.oauth2authserverdemo.controller;import com.sun.istack.internal.Nullable;import org.springframework.stereotype.Controller;import org.springframework.ui.Model;import org.springframework.web.bind.annotation.RequestMapping;import org.springframework.web.bind.annotation.SessionAttributes;import javax.servlet.http.HttpServletRequest;import java.util.ArrayList;import java.util.List;import java.util.Map;@Controller@SessionAttributes(&#123;&quot;authorizationRequest&quot;&#125;)public class OAuth2Controller &#123; /** * 自定义授权页面，注意：一定要在类上加@SessionAttributes(&#123;&quot;authorizationRequest&quot;&#125;) * * @param model model * @param request request * @return String * @throws Exception Exception */ @RequestMapping(&quot;/oauth/confirm_access&quot;) public String getAccessConfirmation(Map&lt;String, Object&gt; model, HttpServletRequest request) &#123; List&lt;String&gt; scopeList = new ArrayList&lt;&gt;(); String scope = request.getParameter(&quot;scope&quot;); if (scope != null) &#123; String[] split = scope.split(&quot; &quot;); for(String s:split) &#123; scopeList.add(s); &#125; &#125; model.put(&quot;scopeList&quot;, scopeList); return &quot;oauth2/confirm_access&quot;; &#125; /** * &lt;h2&gt;自定义登录&lt;/h2&gt; * Created by hanqf on 2020/11/13 10:13. &lt;br&gt; * * @return java.lang.String * @author hanqf */ @RequestMapping(&quot;/oauth/login&quot;) public String login(Model model,@Nullable Boolean error,HttpServletRequest request) &#123; if(error!=null)&#123; model.addAttribute(&quot;error&quot;,error); &#125;else&#123; //从客户端logout后，第一次重新登录会不成功，这里加一个处理逻辑，如果发现其queryString的值为logout就重定向到首页 //暂时不清楚客户端登出后该如何设置才能直接重新登录客户端，可以在认证服务器首页增加客户端入口 if(&quot;logout&quot;.equals(request.getQueryString()))&#123; return &quot;redirect:/&quot;; &#125; &#125; return &quot;oauth2/login&quot;; &#125;&#125; login.html 登录页面12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667&lt;!DOCTYPE html&gt;&lt;html lang=&quot;en&quot; xmlns:th=&quot;http://www.thymeleaf.org&quot;&gt;&lt;head&gt; &lt;meta charset=&quot;UTF-8&quot;/&gt; &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1, shrink-to-fit=no&quot;&gt; &lt;title&gt;登录&lt;/title&gt; &lt;link rel=&quot;stylesheet&quot; th:href=&quot;@&#123;/webjars/bootstrap/css/bootstrap.min.css&#125;&quot;/&gt; &lt;script th:src=&quot;@&#123;/webjars/jquery/jquery.min.js&#125;&quot;&gt;&lt;/script&gt; &lt;script th:src=&quot;@&#123;/webjars/bootstrap/js/bootstrap.min.js&#125;&quot;&gt;&lt;/script&gt;&lt;/head&gt;&lt;body&gt;&lt;div class=&quot;container&quot; style=&quot;width: 320px;margin-top: 100px;&quot;&gt; &lt;h3 align=&quot;center&quot;&gt;OAuth2登录&lt;/h3&gt; &lt;p class=&quot;alert-danger&quot; style=&quot;text-align: center&quot; th:if=&quot;$&#123;error&#125;&quot;&gt;用户名或密码错误!&lt;/p&gt; &lt;p id=&quot;notice_null&quot; class=&quot;alert-danger&quot; style=&quot;text-align: center;&quot;&gt;用户名或密码不能为空!&lt;/p&gt; &lt;form th:action=&quot;@&#123;/login&#125;&quot; method=&quot;post&quot; onsubmit=&quot;return onsubmitCheck()&quot;&gt; &lt;table class=&quot;table&quot;&gt; &lt;tr&gt; &lt;td&gt;用户名:&lt;/td&gt; &lt;td&gt; &lt;label&gt;&lt;input type=&quot;text&quot; id=&quot;username&quot; name=&quot;username&quot;/&gt;&lt;/label&gt; &lt;/td&gt; &lt;/tr&gt; &lt;tr&gt; &lt;td&gt;密码:&lt;/td&gt; &lt;td&gt; &lt;label&gt;&lt;input type=&quot;password&quot; id=&quot;password&quot; name=&quot;password&quot;/&gt;&lt;/label&gt; &lt;/td&gt; &lt;/tr&gt; &lt;tr&gt; &lt;td&gt;&lt;/td&gt; &lt;td&gt; &lt;button class=&quot;btn-success&quot; type=&quot;submit&quot;&gt;登录&lt;/button&gt; &lt;/td&gt; &lt;/tr&gt; &lt;/table&gt; &lt;/form&gt;&lt;/div&gt;&lt;script type=&quot;text/javascript&quot;&gt; $(function()&#123; //默认不显示错误提醒 $(&quot;#notice_null&quot;).hide(); &#125;); function onsubmitCheck()&#123; var username = $(&quot;#username&quot;).val(); var password = $(&quot;#password&quot;).val(); if(username == &quot;&quot; || password == &quot;&quot;)&#123; $(&quot;#notice_null&quot;).show(); return false; &#125; return true; &#125;&lt;/script&gt;&lt;/body&gt;&lt;/html&gt; confirm_access.html 授权页面123456789101112131415161718192021222324252627282930313233343536373839404142434445&lt;!DOCTYPE html&gt;&lt;html lang=&quot;en&quot; xmlns:th=&quot;http://www.thymeleaf.org&quot;&gt;&lt;head&gt; &lt;meta charset=&quot;UTF-8&quot;/&gt; &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1, shrink-to-fit=no&quot;&gt; &lt;title&gt;确认授权页面&lt;/title&gt; &lt;META http-equiv=&quot;Pragma&quot; content=&quot;no-cache&quot;&gt; &lt;META http-equiv=&quot;Cache-Control&quot; content=&quot;no-cache&quot;&gt; &lt;META http-equiv=&quot;Expire&quot; content=&quot;0&quot;&gt; &lt;link rel=&quot;stylesheet&quot; th:href=&quot;@&#123;/webjars/bootstrap/css/bootstrap.min.css&#125;&quot; /&gt; &lt;script th:src=&quot;@&#123;/webjars/jquery/jquery.min.js&#125;&quot;&gt;&lt;/script&gt; &lt;script th:src=&quot;@&#123;/webjars/bootstrap/js/bootstrap.min.js&#125;&quot;&gt;&lt;/script&gt;&lt;/head&gt;&lt;body&gt;&lt;div class=&quot;container&quot;&gt; &lt;section class=&quot;alert alert-warning&quot;&gt; &lt;p&gt;是否授权[ &lt;span th:text=&quot;$&#123;session.authorizationRequest.clientId&#125;&quot;&gt;clientId&lt;/span&gt; ]的访问您的资源：&lt;/p&gt; &lt;div class=&quot;alert alert-info&quot;&gt; &lt;form id=&#x27;confirmationForm&#x27; name=&#x27;confirmationForm&#x27; action=&quot;/oauth/authorize&quot; method=&#x27;post&#x27;&gt; &lt;input id=&quot;user_oauth_approval&quot; name=&#x27;user_oauth_approval&#x27; value=&#x27;true&#x27; type=&#x27;hidden&#x27;/&gt; &lt;!--授权访问领域--&gt; &lt;span th:text=&quot;$&#123;&#x27;[&#x27;+s+&#x27;]&#x27;&#125;&quot; th:each=&quot;s : $&#123;scopeList&#125;&quot;/&gt; &lt;input class=&quot;btn-success&quot; id=&quot;authorize&quot; name=&#x27;authorize&#x27; value=&#x27;授权&#x27; type=&#x27;submit&#x27;/&gt; &lt;input class=&quot;btn-primary&quot; id=&quot;refuse&quot; name=&#x27;refuse&#x27; value=&#x27;拒绝&#x27; type=&#x27;button&#x27;/&gt; &lt;/form&gt; &lt;/div&gt; &lt;/section&gt;&lt;/div&gt;&lt;/body&gt;&lt;script type=&quot;text/javascript&quot;&gt; $(function()&#123; $(&quot;#refuse&quot;).click(function()&#123; $(&quot;#user_oauth_approval&quot;).val(&#x27;false&#x27;); $(&quot;#confirmationForm&quot;).submit(); &#125;); &#125;);&lt;/script&gt;&lt;/html&gt; SecurityConfig中开启自定义登录页配置123456http.formLogin() .loginPage(&quot;/oauth/login&quot;) .loginProcessingUrl(&quot;/login&quot;) //.defaultSuccessUrl(&quot;/&quot;) .failureForwardUrl(&quot;/oauth/login?error=true&quot;) .permitAll(); //登记界面，默认是permitAll 后记至此，一个基于SpringBoot-OAuth2-JWT的认证服务器就搭建好了，如果client-server和resource-server都是基于spring-security-oauth2搭建的，则认证服务器就不需要其它配置了，client-server和resource-server的代码可以参考oauth2-client-demo和oauth2-resource-server-demo，不过spring-security-oauth2已经不再维护了，所以建议搭建client-server和resource-server的时候，还是使用springboot官方提供的spring-boot-starter-oauth2-client和spring-boot-starter-oauth2-resource-server，此时还需要为认证服务增加一些功能，这部分留到后面讲解client-server和resource-server的搭建的时候再说。","summary":"摘要 通过本文，你将知道如何搭建一个基于SpringBoot-OAuth2-JWT的认证服务器 本文基于springboot:2.4.0，项目基于Gradle-6.6.1构建 代码地址:https://github.com/hanqunfeng/springbootchapter/tree/master/chapter48","date_published":"2020-11-15T10:30:05.000Z","tags":["技术","springboot2","Java","springboot","oauth2","springsecurity","jwt"]},{"id":"https://blog.hanqunfeng.com/2020/10/27/jasypt-springboot/","url":"https://blog.hanqunfeng.com/2020/10/27/jasypt-springboot/","title":"SpringBoot配置文件属性加密","content_html":"<h2 id=\"摘要\"><a href=\"#摘要\" class=\"headerlink\" title=\"摘要\"></a>摘要</h2><ul>\n<li><a href=\"https://github.com/ulisesbocchio/jasypt-spring-boot\">jasypt-spring-boot官网</a></li>\n<li>本文使用版本：springboot:2.3.4.RELEASE，jasypt-spring-boot-starter:3.0.3</li>\n</ul>\n<span id=\"more\"></span>\n\n<h2 id=\"添加依赖\"><a href=\"#添加依赖\" class=\"headerlink\" title=\"添加依赖\"></a>添加依赖</h2><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">implementation &#x27;com.github.ulisesbocchio:jasypt-spring-boot-starter:3.0.3&#x27;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"配置文件\"><a href=\"#配置文件\" class=\"headerlink\" title=\"配置文件\"></a>配置文件</h2><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">jasypt:</span></span><br><span class=\"line\">  <span class=\"attr\">encryptor:</span></span><br><span class=\"line\">    <span class=\"comment\">#默认加密算法:PBEWITHHMACSHA512ANDAES_256，sha512+AES算法，安全性更高，但是需要 Java JDK 1.9+</span></span><br><span class=\"line\">    <span class=\"comment\">#本服务使用jdk1.8，所以使用 PBEWithMD5AndDES md5+des算法</span></span><br><span class=\"line\">    <span class=\"comment\">#默认使用 com.ulisesbocchio.jasyptspringboot.encryptor.DefaultLazyEncryptor 进行加解密 ，PooledPBEStringEncryptor可以对其加密的内容进行解密</span></span><br><span class=\"line\">    <span class=\"attr\">algorithm:</span> <span class=\"string\">PBEWithMD5AndDES</span></span><br><span class=\"line\">    <span class=\"comment\"># 加密密钥，使用方式 spring.datasource.password=ENC(密文)，不要设置在配置文件中，建议使用环境变量或者启动参数: --jasypt.encryptor.password=123456</span></span><br><span class=\"line\">    <span class=\"attr\">password:</span> <span class=\"number\">123456</span></span><br><span class=\"line\">    <span class=\"comment\">#设置密文前缀和后缀</span></span><br><span class=\"line\">    <span class=\"attr\">property:</span></span><br><span class=\"line\">      <span class=\"attr\">prefix:</span> <span class=\"string\">ENC(</span></span><br><span class=\"line\">      <span class=\"attr\">suffix:</span> <span class=\"string\">)</span></span><br><span class=\"line\">    <span class=\"attr\">iv-generator-classname:</span> <span class=\"string\">org.jasypt.iv.RandomIvGenerator</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"可用属性\"><a href=\"#可用属性\" class=\"headerlink\" title=\"可用属性\"></a>可用属性</h3><table>\n<thead>\n<tr>\n<th>Key</th>\n<th>Required</th>\n<th>Default Value</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>jasypt.encryptor.password</td>\n<td>True</td>\n<td>-</td>\n</tr>\n<tr>\n<td>jasypt.encryptor.algorithm</td>\n<td>False</td>\n<td>PBEWITHHMACSHA512ANDAES_256</td>\n</tr>\n<tr>\n<td>jasypt.encryptor.key-obtention-iterations</td>\n<td>False</td>\n<td>1000</td>\n</tr>\n<tr>\n<td>jasypt.encryptor.pool-size</td>\n<td>False</td>\n<td>1</td>\n</tr>\n<tr>\n<td>jasypt.encryptor.provider-name</td>\n<td>False</td>\n<td>SunJCE</td>\n</tr>\n<tr>\n<td>jasypt.encryptor.provider-class-name</td>\n<td>False</td>\n<td>null</td>\n</tr>\n<tr>\n<td>jasypt.encryptor.salt-generator-classname</td>\n<td>False</td>\n<td>org.jasypt.salt.RandomSaltGenerator</td>\n</tr>\n<tr>\n<td>jasypt.encryptor.iv-generator-classname</td>\n<td>False</td>\n<td>org.jasypt.iv.RandomIvGenerator</td>\n</tr>\n<tr>\n<td>jasypt.encryptor.string-output-type</td>\n<td>False</td>\n<td>base64</td>\n</tr>\n<tr>\n<td>jasypt.encryptor.proxy-property-sources</td>\n<td>False</td>\n<td>false</td>\n</tr>\n<tr>\n<td>jasypt.encryptor.skip-property-sources</td>\n<td>False</td>\n<td>empty list</td>\n</tr>\n</tbody></table>\n<h2 id=\"生成密文\"><a href=\"#生成密文\" class=\"headerlink\" title=\"生成密文\"></a>生成密文</h2><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> jar下载地址：https://repo1.maven.org/maven2/org/jasypt/jasypt/1.9.3/jasypt-1.9.3.jar</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 实际上使用maven或者gradle配置jasypt-spring-boot-starter依赖后，这个jar就已经下载到本地仓库了，去本地仓库找找吧</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">加密</span></span><br><span class=\"line\">java -cp jasypt-1.9.3.jar org.jasypt.intf.cli.JasyptPBEStringEncryptionCLI password=123456 algorithm=PBEWithMD5AndDES ivGeneratorClassName=org.jasypt.iv.RandomIvGenerator input=newpwd</span><br><span class=\"line\"><span class=\"meta\"></span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">解密</span></span><br><span class=\"line\">java -cp jasypt-1.9.3.jar org.jasypt.intf.cli.JasyptPBEStringDecryptionCLI password=123456 algorithm=PBEWithMD5AndDES ivGeneratorClassName=org.jasypt.iv.RandomIvGenerator input=BwNPdUi+syCTKFj/nlbI5fAtGUKuhN8r</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"属性加密\"><a href=\"#属性加密\" class=\"headerlink\" title=\"属性加密\"></a>属性加密</h2><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">spring:</span></span><br><span class=\"line\"><span class=\"comment\">#数据源配置</span></span><br><span class=\"line\">  <span class=\"attr\">datasource:</span></span><br><span class=\"line\">    <span class=\"attr\">url:</span> <span class=\"string\">jdbc:mysql://localhost:3306/springboot?useUnicode=true&amp;characterEncoding=utf-8&amp;useTimezone=true&amp;serverTimezone=GMT%2B8</span></span><br><span class=\"line\">    <span class=\"attr\">username:</span> <span class=\"string\">root</span></span><br><span class=\"line\">    <span class=\"attr\">password:</span> <span class=\"string\">ENC(BwNPdUi+syCTKFj/nlbI5fAtGUKuhN8r)</span></span><br><span class=\"line\">    <span class=\"attr\">driver-class-name:</span> <span class=\"string\">com.mysql.cj.jdbc.Driver</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">#配置redis连接</span></span><br><span class=\"line\">  <span class=\"attr\">redis:</span></span><br><span class=\"line\">    <span class=\"attr\">host:</span> <span class=\"number\">127.0</span><span class=\"number\">.0</span><span class=\"number\">.1</span></span><br><span class=\"line\">    <span class=\"attr\">password:</span> <span class=\"string\">ENC(FE4cpSc+2u9NFEY+Q5n9kNSxW6BUiNXGNTUPuhoQbPA=)</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"说明\"><a href=\"#说明\" class=\"headerlink\" title=\"说明\"></a>说明</h3><ul>\n<li>配置文件将需要加密的属性使用<code>ENC(密文)</code>的方式进行配置，密文前缀和后缀可以在配置文件中进行配置</li>\n<li>jasypt-spring-boot-starter在服务运行时会自动对密文进行解密处理</li>\n</ul>\n<h2 id=\"密钥传递方式\"><a href=\"#密钥传递方式\" class=\"headerlink\" title=\"密钥传递方式\"></a>密钥传递方式</h2><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">1.启动参数</span></span><br><span class=\"line\">java -jar jasypt-spring-boot-demo.jar --jasypt.encryptor.password=password</span><br><span class=\"line\"><span class=\"meta\"></span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">2.系统属性</span></span><br><span class=\"line\">java -Djasypt.encryptor.password=password -jar jasypt-spring-boot-demo.jar</span><br><span class=\"line\"><span class=\"meta\"></span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">3.环境变量</span></span><br><span class=\"line\">jasypt:</span><br><span class=\"line\">    encryptor:</span><br><span class=\"line\">        password: $&#123;JASYPT_ENCRYPTOR_PASSWORD:&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">JASYPT_ENCRYPTOR_PASSWORD=password java -jar jasypt-spring-boot-demo.jar</span><br><span class=\"line\"><span class=\"meta\"></span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">也可以先设置环境变量</span></span><br><span class=\"line\">export JASYPT_ENCRYPTOR_PASSWORD=password</span><br><span class=\"line\">java -jar jasypt-spring-boot-demo.jar</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"代码中使用Jasypt\"><a href=\"#代码中使用Jasypt\" class=\"headerlink\" title=\"代码中使用Jasypt\"></a>代码中使用Jasypt</h2><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* 引入jasypt-spring-boot-starter就会自动注入</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"meta\">@Resource</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> StringEncryptor stringEncryptor;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">StringEncryptor</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    String encrypt = stringEncryptor.encrypt(<span class=\"string\">&quot;newpwd&quot;</span>);</span><br><span class=\"line\">    System.out.println(encrypt);</span><br><span class=\"line\"></span><br><span class=\"line\">    String decrypt = stringEncryptor.decrypt(encrypt);</span><br><span class=\"line\">    System.out.println(decrypt);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"非springboot项目\"><a href=\"#非springboot项目\" class=\"headerlink\" title=\"非springboot项目\"></a>非springboot项目</h2><h3 id=\"依赖\"><a href=\"#依赖\" class=\"headerlink\" title=\"依赖\"></a>依赖</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">implementation &#x27;org.jasypt:jasypt:1.9.3&#x27;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"工具类\"><a href=\"#工具类\" class=\"headerlink\" title=\"工具类\"></a>工具类</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.example.utils;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> org.jasypt.encryption.pbe.PooledPBEStringEncryptor;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.jasypt.encryption.pbe.StandardPBEStringEncryptor;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.jasypt.encryption.pbe.config.EnvironmentStringPBEConfig;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.jasypt.encryption.pbe.config.SimpleStringPBEConfig;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * &lt;h1&gt;属性加密工具类&lt;/h1&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">JasyptUtil</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> String <span class=\"title\">encrypt</span><span class=\"params\">(String secretKey, String message)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> stringEncryptor(secretKey, message, <span class=\"keyword\">true</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> String <span class=\"title\">decrypt</span><span class=\"params\">(String secretKey, String message)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> stringEncryptor(secretKey, message, <span class=\"keyword\">false</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * &#123;<span class=\"doctag\">@link</span> StringEncryptor&#125; 加解密。</span></span><br><span class=\"line\"><span class=\"comment\">     * 同一个密钥（secretKey）对同一个内容执行加密，生成的密文都是不一样的，但是根据根据这些密文解密成明文都是可以.</span></span><br><span class=\"line\"><span class=\"comment\">     * 1、Jasypt 默认使用 &#123;<span class=\"doctag\">@link</span> StringEncryptor&#125; 来解密全局配置文件中的属性，所以提供密文时，也需要提供 &#123;<span class=\"doctag\">@link</span> StringEncryptor&#125; 加密的密文</span></span><br><span class=\"line\"><span class=\"comment\">     * 2、&#123;<span class=\"doctag\">@link</span> StringEncryptor&#125; 接口有很多的实现类，比如常用的 &#123;<span class=\"doctag\">@link</span> PooledPBEStringEncryptor&#125;</span></span><br><span class=\"line\"><span class=\"comment\">     * 3、setConfig(final PBEConfig config)：为对象设置 &#123;<span class=\"doctag\">@link</span> PBEConfig&#125; 配置对象</span></span><br><span class=\"line\"><span class=\"comment\">     * 4、encrypt(final String message)：加密内容</span></span><br><span class=\"line\"><span class=\"comment\">     * 5、decrypt(final String encryptedMessage)：解密内容</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> secretKey ：密钥。加/解密必须使用同一个密钥</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> message   ：加/解密的内容</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> isEncrypt ：true 表示加密、false 表示解密</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span></span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> String <span class=\"title\">stringEncryptor</span><span class=\"params\">(String secretKey, String message, <span class=\"keyword\">boolean</span> isEncrypt)</span> </span>&#123;</span><br><span class=\"line\">        PooledPBEStringEncryptor pooledPBEStringEncryptor = <span class=\"keyword\">new</span> PooledPBEStringEncryptor();</span><br><span class=\"line\">        pooledPBEStringEncryptor.setConfig(getSimpleStringPBEConfig(secretKey));</span><br><span class=\"line\">        String result = isEncrypt ? pooledPBEStringEncryptor.encrypt(message) : pooledPBEStringEncryptor.decrypt(message);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 设置 &#123;<span class=\"doctag\">@link</span> PBEConfig&#125; 配置对象，SimpleStringPBEConfig 是它的实现类</span></span><br><span class=\"line\"><span class=\"comment\">     * 1、所有的配置项建议与全局配置文件中的配置项保持一致，特别是 password、algorithm 等等选项，如果不一致，则应用启动时解密失败而报错.</span></span><br><span class=\"line\"><span class=\"comment\">     * 2、setPassword(final String password)：设置加密密钥，必须与全局配置文件中配置的保存一致，否则应用启动时会解密失败而报错.</span></span><br><span class=\"line\"><span class=\"comment\">     * 3、setPoolSize(final String poolSize)：设置要创建的加密程序池的大小.</span></span><br><span class=\"line\"><span class=\"comment\">     * 4、setAlgorithm(final String algorithm): 设置加密算法的值， 此算法必须由 JCE 提供程序支持</span></span><br><span class=\"line\"><span class=\"comment\">     * 5、setKeyObtentionIterations: 设置应用于获取加密密钥的哈希迭代次数。</span></span><br><span class=\"line\"><span class=\"comment\">     * 6、setProviderName(final String providerName)：设置要请求加密算法的安全提供程序的名称</span></span><br><span class=\"line\"><span class=\"comment\">     * 7、setSaltGeneratorClassName：设置 Sal 发生器</span></span><br><span class=\"line\"><span class=\"comment\">     * 8、setIvGeneratorClassName：设置 IV 发生器</span></span><br><span class=\"line\"><span class=\"comment\">     * 9、setStringOutputType：设置字符串输出的编码形式。可用的编码类型有 base64、hexadecimal</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> secretKey</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span></span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> SimpleStringPBEConfig <span class=\"title\">getSimpleStringPBEConfig</span><span class=\"params\">(String secretKey)</span> </span>&#123;</span><br><span class=\"line\">        SimpleStringPBEConfig config = <span class=\"keyword\">new</span> SimpleStringPBEConfig();</span><br><span class=\"line\">        config.setPassword(secretKey);</span><br><span class=\"line\">        config.setAlgorithm(<span class=\"string\">&quot;PBEWithMD5AndDES&quot;</span>);</span><br><span class=\"line\">        <span class=\"comment\">//以下都是默认值</span></span><br><span class=\"line\">        config.setPoolSize(<span class=\"string\">&quot;1&quot;</span>);</span><br><span class=\"line\">        config.setKeyObtentionIterations(<span class=\"string\">&quot;1000&quot;</span>);</span><br><span class=\"line\">        config.setProviderName(<span class=\"string\">&quot;SunJCE&quot;</span>);</span><br><span class=\"line\">        config.setSaltGeneratorClassName(<span class=\"string\">&quot;org.jasypt.salt.RandomSaltGenerator&quot;</span>);</span><br><span class=\"line\">        <span class=\"comment\">//命令行执行时要指定这个参数</span></span><br><span class=\"line\">        config.setIvGeneratorClassName(<span class=\"string\">&quot;org.jasypt.iv.RandomIvGenerator&quot;</span>);</span><br><span class=\"line\">        config.setStringOutputType(<span class=\"string\">&quot;base64&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> config;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n","content_text":"摘要 jasypt-spring-boot官网 本文使用版本：springboot:2.3.4.RELEASE，jasypt-spring-boot-starter:3.0.3 添加依赖1implementation &#x27;com.github.ulisesbocchio:jasypt-spring-boot-starter:3.0.3&#x27; 配置文件12345678910111213jasypt: encryptor: #默认加密算法:PBEWITHHMACSHA512ANDAES_256，sha512+AES算法，安全性更高，但是需要 Java JDK 1.9+ #本服务使用jdk1.8，所以使用 PBEWithMD5AndDES md5+des算法 #默认使用 com.ulisesbocchio.jasyptspringboot.encryptor.DefaultLazyEncryptor 进行加解密 ，PooledPBEStringEncryptor可以对其加密的内容进行解密 algorithm: PBEWithMD5AndDES # 加密密钥，使用方式 spring.datasource.password=ENC(密文)，不要设置在配置文件中，建议使用环境变量或者启动参数: --jasypt.encryptor.password=123456 password: 123456 #设置密文前缀和后缀 property: prefix: ENC( suffix: ) iv-generator-classname: org.jasypt.iv.RandomIvGenerator 可用属性 Key Required Default Value jasypt.encryptor.password True - jasypt.encryptor.algorithm False PBEWITHHMACSHA512ANDAES_256 jasypt.encryptor.key-obtention-iterations False 1000 jasypt.encryptor.pool-size False 1 jasypt.encryptor.provider-name False SunJCE jasypt.encryptor.provider-class-name False null jasypt.encryptor.salt-generator-classname False org.jasypt.salt.RandomSaltGenerator jasypt.encryptor.iv-generator-classname False org.jasypt.iv.RandomIvGenerator jasypt.encryptor.string-output-type False base64 jasypt.encryptor.proxy-property-sources False false jasypt.encryptor.skip-property-sources False empty list 生成密文1234567# jar下载地址：https://repo1.maven.org/maven2/org/jasypt/jasypt/1.9.3/jasypt-1.9.3.jar# 实际上使用maven或者gradle配置jasypt-spring-boot-starter依赖后，这个jar就已经下载到本地仓库了，去本地仓库找找吧#加密java -cp jasypt-1.9.3.jar org.jasypt.intf.cli.JasyptPBEStringEncryptionCLI password=123456 algorithm=PBEWithMD5AndDES ivGeneratorClassName=org.jasypt.iv.RandomIvGenerator input=newpwd#解密java -cp jasypt-1.9.3.jar org.jasypt.intf.cli.JasyptPBEStringDecryptionCLI password=123456 algorithm=PBEWithMD5AndDES ivGeneratorClassName=org.jasypt.iv.RandomIvGenerator input=BwNPdUi+syCTKFj/nlbI5fAtGUKuhN8r 属性加密123456789101112spring:#数据源配置 datasource: url: jdbc:mysql://localhost:3306/springboot?useUnicode=true&amp;characterEncoding=utf-8&amp;useTimezone=true&amp;serverTimezone=GMT%2B8 username: root password: ENC(BwNPdUi+syCTKFj/nlbI5fAtGUKuhN8r) driver-class-name: com.mysql.cj.jdbc.Driver #配置redis连接 redis: host: 127.0.0.1 password: ENC(FE4cpSc+2u9NFEY+Q5n9kNSxW6BUiNXGNTUPuhoQbPA=) 说明 配置文件将需要加密的属性使用ENC(密文)的方式进行配置，密文前缀和后缀可以在配置文件中进行配置 jasypt-spring-boot-starter在服务运行时会自动对密文进行解密处理 密钥传递方式12345678910111213141516#1.启动参数java -jar jasypt-spring-boot-demo.jar --jasypt.encryptor.password=password#2.系统属性java -Djasypt.encryptor.password=password -jar jasypt-spring-boot-demo.jar#3.环境变量jasypt: encryptor: password: $&#123;JASYPT_ENCRYPTOR_PASSWORD:&#125;JASYPT_ENCRYPTOR_PASSWORD=password java -jar jasypt-spring-boot-demo.jar#也可以先设置环境变量export JASYPT_ENCRYPTOR_PASSWORD=passwordjava -jar jasypt-spring-boot-demo.jar 代码中使用Jasypt1234567891011121314/*** 引入jasypt-spring-boot-starter就会自动注入*/@Resourceprivate StringEncryptor stringEncryptor;public void StringEncryptor() &#123; String encrypt = stringEncryptor.encrypt(&quot;newpwd&quot;); System.out.println(encrypt); String decrypt = stringEncryptor.decrypt(encrypt); System.out.println(decrypt);&#125; 非springboot项目依赖1implementation &#x27;org.jasypt:jasypt:1.9.3&#x27; 工具类12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273package com.example.utils;import org.jasypt.encryption.pbe.PooledPBEStringEncryptor;import org.jasypt.encryption.pbe.StandardPBEStringEncryptor;import org.jasypt.encryption.pbe.config.EnvironmentStringPBEConfig;import org.jasypt.encryption.pbe.config.SimpleStringPBEConfig;/** * &lt;h1&gt;属性加密工具类&lt;/h1&gt; */public class JasyptUtil &#123; public static String encrypt(String secretKey, String message) &#123; return stringEncryptor(secretKey, message, true); &#125; public static String decrypt(String secretKey, String message) &#123; return stringEncryptor(secretKey, message, false); &#125; /** * &#123;@link StringEncryptor&#125; 加解密。 * 同一个密钥（secretKey）对同一个内容执行加密，生成的密文都是不一样的，但是根据根据这些密文解密成明文都是可以. * 1、Jasypt 默认使用 &#123;@link StringEncryptor&#125; 来解密全局配置文件中的属性，所以提供密文时，也需要提供 &#123;@link StringEncryptor&#125; 加密的密文 * 2、&#123;@link StringEncryptor&#125; 接口有很多的实现类，比如常用的 &#123;@link PooledPBEStringEncryptor&#125; * 3、setConfig(final PBEConfig config)：为对象设置 &#123;@link PBEConfig&#125; 配置对象 * 4、encrypt(final String message)：加密内容 * 5、decrypt(final String encryptedMessage)：解密内容 * * @param secretKey ：密钥。加/解密必须使用同一个密钥 * @param message ：加/解密的内容 * @param isEncrypt ：true 表示加密、false 表示解密 * @return */ private static String stringEncryptor(String secretKey, String message, boolean isEncrypt) &#123; PooledPBEStringEncryptor pooledPBEStringEncryptor = new PooledPBEStringEncryptor(); pooledPBEStringEncryptor.setConfig(getSimpleStringPBEConfig(secretKey)); String result = isEncrypt ? pooledPBEStringEncryptor.encrypt(message) : pooledPBEStringEncryptor.decrypt(message); return result; &#125; /** * 设置 &#123;@link PBEConfig&#125; 配置对象，SimpleStringPBEConfig 是它的实现类 * 1、所有的配置项建议与全局配置文件中的配置项保持一致，特别是 password、algorithm 等等选项，如果不一致，则应用启动时解密失败而报错. * 2、setPassword(final String password)：设置加密密钥，必须与全局配置文件中配置的保存一致，否则应用启动时会解密失败而报错. * 3、setPoolSize(final String poolSize)：设置要创建的加密程序池的大小. * 4、setAlgorithm(final String algorithm): 设置加密算法的值， 此算法必须由 JCE 提供程序支持 * 5、setKeyObtentionIterations: 设置应用于获取加密密钥的哈希迭代次数。 * 6、setProviderName(final String providerName)：设置要请求加密算法的安全提供程序的名称 * 7、setSaltGeneratorClassName：设置 Sal 发生器 * 8、setIvGeneratorClassName：设置 IV 发生器 * 9、setStringOutputType：设置字符串输出的编码形式。可用的编码类型有 base64、hexadecimal * * @param secretKey * @return */ private static SimpleStringPBEConfig getSimpleStringPBEConfig(String secretKey) &#123; SimpleStringPBEConfig config = new SimpleStringPBEConfig(); config.setPassword(secretKey); config.setAlgorithm(&quot;PBEWithMD5AndDES&quot;); //以下都是默认值 config.setPoolSize(&quot;1&quot;); config.setKeyObtentionIterations(&quot;1000&quot;); config.setProviderName(&quot;SunJCE&quot;); config.setSaltGeneratorClassName(&quot;org.jasypt.salt.RandomSaltGenerator&quot;); //命令行执行时要指定这个参数 config.setIvGeneratorClassName(&quot;org.jasypt.iv.RandomIvGenerator&quot;); config.setStringOutputType(&quot;base64&quot;); return config; &#125;&#125;","summary":"摘要 jasypt-spring-boot官网 本文使用版本：springboot:2.3.4.RELEASE，jasypt-spring-boot-starter:3.0.3","date_published":"2020-10-27T10:30:05.000Z","tags":["技术","springboot2","springboot","yasypt"]},{"id":"https://blog.hanqunfeng.com/2020/09/25/springsecurity-cas-attrs/","url":"https://blog.hanqunfeng.com/2020/09/25/springsecurity-cas-attrs/","title":"CAS客户端使用SpringSecurity访问CAS发布的属性","content_html":"<h2 id=\"摘要\"><a href=\"#摘要\" class=\"headerlink\" title=\"摘要\"></a>摘要</h2><ul>\n<li>CAS服务端基于cas-overlay-template-5.3.14，已实现基于jdbc的自定义登录策略、验证码、动态service配置、多属性返回，等等</li>\n<li>CAS客户端基于spring-boot-2.3.3.RELEASE，spring-security-cas-5.3.4.RELEASE</li>\n<li>本文代码地址：<a href=\"https://github.com/hanqunfeng/springbootchapter/tree/master/chapter36\">https://github.com/hanqunfeng/springbootchapter/tree/master/chapter36</a></li>\n<li>其重点是client的UserDetailsService的实现类要继承自AbstractCasAssertionUserDetailsService</li>\n</ul>\n<span id=\"more\"></span>\n\n<h2 id=\"cas服务配置\"><a href=\"#cas服务配置\" class=\"headerlink\" title=\"cas服务配置\"></a>cas服务配置</h2><ul>\n<li>如果是json配置方式：services目录下需要为每个客户端配置一个json文件，如client1-10000005.json</li>\n</ul>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"attr\">&quot;@class&quot;</span> : <span class=\"string\">&quot;org.apereo.cas.services.RegexRegisteredService&quot;</span>,</span><br><span class=\"line\">  <span class=\"attr\">&quot;serviceId&quot;</span> : <span class=\"string\">&quot;^(https|http|imaps)://localhost:8081.*&quot;</span>, #对应客户端的地址匹配路径</span><br><span class=\"line\">  <span class=\"attr\">&quot;name&quot;</span> : <span class=\"string\">&quot;client1&quot;</span>,  #与文件名称对应</span><br><span class=\"line\">  <span class=\"attr\">&quot;id&quot;</span> : <span class=\"number\">10000005</span>,     #与文件名称对应</span><br><span class=\"line\">  <span class=\"attr\">&quot;description&quot;</span> : <span class=\"string\">&quot;This service definition authorizes all application urls that support HTTPS and IMAPS protocols.&quot;</span>,</span><br><span class=\"line\">  <span class=\"attr\">&quot;evaluationOrder&quot;</span> : <span class=\"number\">10</span>, #顺序id不能重复</span><br><span class=\"line\">  <span class=\"attr\">&quot;logoutType&quot;</span> : <span class=\"string\">&quot;BACK_CHANNEL&quot;</span>, #固定写法</span><br><span class=\"line\">  <span class=\"attr\">&quot;logoutUrl&quot;</span> : <span class=\"string\">&quot;http://localhost:8081/&quot;</span>,  #客户端地址，用于单点登出时通知客户端使用</span><br><span class=\"line\">  <span class=\"attr\">&quot;attributeReleasePolicy&quot;</span>: &#123; # 属性返回策略</span><br><span class=\"line\">    <span class=\"attr\">&quot;@class&quot;</span>: <span class=\"string\">&quot;org.apereo.cas.services.ReturnAllAttributeReleasePolicy&quot;</span></span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"attr\">&quot;accessStrategy&quot;</span> : &#123; #是否允许该客户端访问单点登录，肯定是要开启的啊</span><br><span class=\"line\">    <span class=\"attr\">&quot;@class&quot;</span> : <span class=\"string\">&quot;org.apereo.cas.services.DefaultRegisteredServiceAccessStrategy&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;enabled&quot;</span> : <span class=\"literal\">true</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;ssoEnabled&quot;</span> : <span class=\"literal\">true</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"cas多属性返回\"><a href=\"#cas多属性返回\" class=\"headerlink\" title=\"cas多属性返回\"></a>cas多属性返回</h2><ul>\n<li>services的json文件中要增加如下配置<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 返回全部配置属性</span><br><span class=\"line\"><span class=\"string\">&quot;attributeReleasePolicy&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"attr\">&quot;@class&quot;</span>: <span class=\"string\">&quot;org.apereo.cas.services.ReturnAllAttributeReleasePolicy&quot;</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># 返回指定配置属性，这里指定只返回username和email两个属性</span><br><span class=\"line\">  <span class=\"string\">&quot;attributeReleasePolicy&quot;</span> : &#123;</span><br><span class=\"line\">  \t<span class=\"attr\">&quot;@class&quot;</span> : <span class=\"string\">&quot;org.apereo.cas.services.ReturnAllowedAttributeReleasePolicy&quot;</span>,</span><br><span class=\"line\"> \t<span class=\"attr\">&quot;allowedAttributes&quot;</span> : [ <span class=\"string\">&quot;java.util.ArrayList&quot;</span>, [ <span class=\"string\">&quot;username&quot;</span>, <span class=\"string\">&quot;email&quot;</span> ] ]</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h2 id=\"动态service\"><a href=\"#动态service\" class=\"headerlink\" title=\"动态service\"></a>动态service</h2><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">如果使用代码的方式维护service,则也要根据情况来创建返回策略，</span><br><span class=\"line\">参考代码chapter36/cas-overlay-template-5.3.14/src/main/java/com/cas/controller/ServiceController.java</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li><p>配置属性</p>\n<figure class=\"highlight properties\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 动态services配置</span></span><br><span class=\"line\"><span class=\"comment\">################################################</span></span><br><span class=\"line\"><span class=\"comment\"># 开启识别Json文件，默认false</span></span><br><span class=\"line\"><span class=\"comment\"># 这一段表示从json文件里面初始化服务，如果我们配置了这个，就会将这写json里面的数据，都会自动导入到数据库中</span></span><br><span class=\"line\"><span class=\"meta\">cas.serviceRegistry.initFromJson</span>=<span class=\"string\">true</span></span><br><span class=\"line\"><span class=\"meta\">cas.serviceRegistry.watcherEnabled</span>=<span class=\"string\">true</span></span><br><span class=\"line\"><span class=\"comment\">#设置配置的服务，一直都有，不会给清除掉 ， 第一次使用，需要配置为 create-drop</span></span><br><span class=\"line\"><span class=\"comment\">#create-drop 重启cas服务的时候，就会给干掉</span></span><br><span class=\"line\"><span class=\"comment\">#create  没有表就创建，有就不创建</span></span><br><span class=\"line\"><span class=\"comment\">#none 什么也不做</span></span><br><span class=\"line\"><span class=\"comment\">#update 更新</span></span><br><span class=\"line\"><span class=\"comment\">#Unrecognized legacy `hibernate.hbm2ddl.auto` value : create-drops</span></span><br><span class=\"line\"><span class=\"meta\">cas.serviceRegistry.jpa.ddlAuto</span>=<span class=\"string\">update</span></span><br><span class=\"line\"><span class=\"comment\">#配置将service配置到数据库中</span></span><br><span class=\"line\"><span class=\"meta\">cas.serviceRegistry.jpa.isolateInternalQueries</span>=<span class=\"string\">false</span></span><br><span class=\"line\"><span class=\"meta\">cas.serviceRegistry.jpa.url</span>=<span class=\"string\">$&#123;jdbc.url&#125;</span></span><br><span class=\"line\"><span class=\"meta\">cas.serviceRegistry.jpa.user</span>=<span class=\"string\">$&#123;jdbc.username&#125;</span></span><br><span class=\"line\"><span class=\"meta\">cas.serviceRegistry.jpa.password</span>=<span class=\"string\">$&#123;jdbc.password&#125;</span></span><br><span class=\"line\"><span class=\"comment\">#这个必须是org.hibernate.dialect.MySQL5Dialect ,我就是这个问题导致表创建失败</span></span><br><span class=\"line\"><span class=\"meta\">cas.serviceRegistry.jpa.dialect</span>=<span class=\"string\">org.hibernate.dialect.MySQL5Dialect</span></span><br><span class=\"line\"><span class=\"meta\">cas.serviceRegistry.jpa.driverClass</span>=<span class=\"string\">$&#123;jdbc.driver&#125;</span></span><br><span class=\"line\"><span class=\"meta\">cas.serviceRegistry.jpa.leakThreshold</span>=<span class=\"string\">10</span></span><br><span class=\"line\"><span class=\"meta\">cas.serviceRegistry.jpa.batchSize</span>=<span class=\"string\">1</span></span><br><span class=\"line\"><span class=\"meta\">cas.serviceRegistry.jpa.autocommit</span>=<span class=\"string\">true</span></span><br><span class=\"line\"><span class=\"meta\">cas.serviceRegistry.jpa.idleTimeout</span>=<span class=\"string\">5000</span></span><br><span class=\"line\"><span class=\"comment\">#配置结束</span></span><br><span class=\"line\"><span class=\"comment\">################################################</span></span><br></pre></td></tr></table></figure></li>\n<li><p>这里说一下delete异常的问题，可以引入jdbcTemplate直接操作数据表，参考chapter36/cas-overlay-template-5.3.14/src/main/java/com/cas/config/DataSourceConfig.java</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">List&lt;Map&lt;String, Object&gt;&gt; list = jdbcTemplate.queryForList(<span class=\"string\">&quot;select * from regexregisteredservice where serviceId = &#x27;&quot;</span> + serviceId + <span class=\"string\">&quot;&#x27;&quot;</span>);</span><br><span class=\"line\"><span class=\"keyword\">if</span> (list != <span class=\"keyword\">null</span> &amp;&amp; list.size() &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">    has_data = <span class=\"keyword\">true</span>;</span><br><span class=\"line\">    jdbcTemplate.update(<span class=\"string\">&quot;delete from regexregisteredservice where serviceId = &#x27;&quot;</span> + serviceId + <span class=\"string\">&quot;&#x27;&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"comment\">//执行load生效</span></span><br><span class=\"line\"> servicesManager.load();</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h2 id=\"基于配置文件返回属性\"><a href=\"#基于配置文件返回属性\" class=\"headerlink\" title=\"基于配置文件返回属性\"></a>基于配置文件返回属性</h2><figure class=\"highlight properties\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#####################################################</span></span><br><span class=\"line\"><span class=\"comment\">## 属性返回</span></span><br><span class=\"line\"><span class=\"meta\">cas.authn.attributeRepository.jdbc[0].sql</span>=<span class=\"string\">select username,password,email from cas_user where username=?</span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\"># 格式cas.authn.attributeRepository.jdbc[0].attributes.key=value</span></span><br><span class=\"line\"><span class=\"comment\"># 返回上面查询结果的username，属性key名称也为username ,以下雷同</span></span><br><span class=\"line\"><span class=\"meta\">cas.authn.attributeRepository.jdbc[0].attributes.username</span>=<span class=\"string\">username</span></span><br><span class=\"line\"><span class=\"meta\">cas.authn.attributeRepository.jdbc[0].attributes.password</span>=<span class=\"string\">password</span></span><br><span class=\"line\"><span class=\"meta\">cas.authn.attributeRepository.jdbc[0].attributes.email</span>=<span class=\"string\">email</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">cas.authn.attributeRepository.jdbc[0].singleRow</span>=<span class=\"string\">true</span></span><br><span class=\"line\"><span class=\"meta\">cas.authn.attributeRepository.jdbc[0].order</span>=<span class=\"string\">0</span></span><br><span class=\"line\"><span class=\"meta\">cas.authn.attributeRepository.jdbc[0].requireAllAttributes</span>=<span class=\"string\">true</span></span><br><span class=\"line\"><span class=\"comment\"># cas.authn.attributeRepository.jdbc[0].caseCanonicalization=NONE|LOWER|UPPER</span></span><br><span class=\"line\"><span class=\"comment\"># cas.authn.attributeRepository.jdbc[0].queryType=OR|AND</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">cas.authn.attributeRepository.jdbc[0].username</span>=<span class=\"string\">username</span></span><br><span class=\"line\"><span class=\"comment\">#数据库连接</span></span><br><span class=\"line\"><span class=\"meta\">cas.authn.attributeRepository.jdbc[0].url</span>=<span class=\"string\">$&#123;jdbc.url&#125;</span></span><br><span class=\"line\"><span class=\"comment\">#数据库dialect配置</span></span><br><span class=\"line\"><span class=\"meta\">cas.authn.attributeRepository.jdbc[0].dialect</span>=<span class=\"string\">$&#123;jdbc.dialect&#125;</span></span><br><span class=\"line\"><span class=\"comment\">#数据库用户名</span></span><br><span class=\"line\"><span class=\"meta\">cas.authn.attributeRepository.jdbc[0].user</span>=<span class=\"string\">$&#123;jdbc.username&#125;</span></span><br><span class=\"line\"><span class=\"comment\">#数据库用户密码</span></span><br><span class=\"line\"><span class=\"meta\">cas.authn.attributeRepository.jdbc[0].password</span>=<span class=\"string\">$&#123;jdbc.password&#125;</span></span><br><span class=\"line\"><span class=\"comment\">#数据库事务自动提交</span></span><br><span class=\"line\"><span class=\"meta\">cas.authn.attributeRepository.jdbc[0].autocommit</span>=<span class=\"string\">true</span></span><br><span class=\"line\"><span class=\"comment\">#数据库驱动</span></span><br><span class=\"line\"><span class=\"meta\">cas.authn.attributeRepository.jdbc[0].driverClass</span>=<span class=\"string\">$&#123;jdbc.driver&#125;</span></span><br><span class=\"line\"><span class=\"comment\">#超时配置</span></span><br><span class=\"line\"><span class=\"meta\">cas.authn.attributeRepository.jdbc[0].idleTimeout</span>=<span class=\"string\">5000</span></span><br><span class=\"line\"><span class=\"meta\">cas.authn.attributeRepository.jdbc[0].ddlAuto</span>=<span class=\"string\">none</span></span><br><span class=\"line\"><span class=\"meta\">cas.authn.attributeRepository.jdbc[0].leakThreshold</span>=<span class=\"string\">10</span></span><br><span class=\"line\"><span class=\"meta\">cas.authn.attributeRepository.jdbc[0].batchSize</span>=<span class=\"string\">1</span></span><br><span class=\"line\"><span class=\"meta\">cas.authn.attributeRepository.jdbc[0].dataSourceProxy</span>=<span class=\"string\">false</span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\">#####################################################</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"代码实现返回属性内容\"><a href=\"#代码实现返回属性内容\" class=\"headerlink\" title=\"代码实现返回属性内容\"></a>代码实现返回属性内容</h2><ul>\n<li>这个需要结合自定义登录策略来实现，代码参考：chapter36/cas-overlay-template-5.3.14/src/main/java/com/cas/security/CustomerHandlerAuthentication.java，注意要关闭配置文件的登录策略，否则会失效</li>\n<li>注册自定义登录策略，代码参考：chapter36/cas-overlay-template-5.3.14/src/main/java/com/cas/config/CustomAuthenticationConfig.java</li>\n<li>然后将其加入自动配置中,chapter36/cas-overlay-template-5.3.14/src/main/resources/META-INF/spring.factories<figure class=\"highlight properties\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">org.springframework.boot.autoconfigure.EnableAutoConfiguration</span>=<span class=\"string\">\\</span></span><br><span class=\"line\"><span class=\"string\">  org.apereo.cas.config.CasEmbeddedContainerTomcatConfiguration,\\</span></span><br><span class=\"line\"><span class=\"string\">  org.apereo.cas.config.CasEmbeddedContainerTomcatFiltersConfiguration,\\</span></span><br><span class=\"line\"><span class=\"string\">  com.cas.config.MyConfiguration,\\ #自定义的其它需要加入spring上下文的bean</span></span><br><span class=\"line\">  <span class=\"attr\">com.cas.config.DataSourceConfig,\\ #数据源配置，为了引入JdbcTemplate</span></span><br><span class=\"line\">  <span class=\"meta\">com.cas.config.CustomAuthenticationConfig,\\ </span> <span class=\"string\">#自定义登录策略配置</span></span><br><span class=\"line\">  <span class=\"meta\">com.cas.config.CustomerAuthWebflowConfiguration</span> <span class=\"string\">#自定义登录流程配置</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h2 id=\"cas-client-springsecurity\"><a href=\"#cas-client-springsecurity\" class=\"headerlink\" title=\"cas-client-springsecurity\"></a>cas-client-springsecurity</h2><ul>\n<li><p>这里说一下，如果不使用springsecurity，而是直接依赖cas-client，其获取cas返回属性的方式</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Principal principal = request.getUserPrincipal();</span><br><span class=\"line\"><span class=\"keyword\">if</span>(principal <span class=\"keyword\">instanceof</span> AttributePrincipal)&#123;</span><br><span class=\"line\">    <span class=\"comment\">//cas传递过来的数据</span></span><br><span class=\"line\">    Map&lt;String,Object&gt; result =( (AttributePrincipal)principal).getAttributes();</span><br><span class=\"line\">    <span class=\"keyword\">for</span>(Map.Entry&lt;String, Object&gt; entry :result.entrySet()) &#123;</span><br><span class=\"line\">        String key = entry.getKey();</span><br><span class=\"line\">        Object val = entry.getValue();</span><br><span class=\"line\">        System.out.printf(<span class=\"string\">&quot;%s:%s\\r\\n&quot;</span>,key,val);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n<li><p>使用springsecurity的配置类代码参考：chapter36/springsecurity-client-demo/src/main/java/com/example/springsecuritydemo/config/WebSecurityConfigByCASByAttrs.java</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * cas 认证 Provider</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@Bean</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> CasAuthenticationProvider <span class=\"title\">casAuthenticationProvider</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">//创建CAS授权认证器</span></span><br><span class=\"line\">        CasAuthenticationProvider casAuthenticationProvider = <span class=\"keyword\">new</span> CasAuthenticationProvider();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//设置Cas授权认证器相关配置</span></span><br><span class=\"line\">        casAuthenticationProvider.setServiceProperties(serviceProperties());</span><br><span class=\"line\">        <span class=\"comment\">//设置票据校验器</span></span><br><span class=\"line\">        casAuthenticationProvider.setTicketValidator(cas30ServiceTicketValidator());</span><br><span class=\"line\">        casAuthenticationProvider.setKey(<span class=\"string\">&quot;casAuthenticationProviderKey&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//setUserDetailsService和setAuthenticationUserDetailsService只能设置一个，其目的都是为了初始化属性authenticationUserDetailsService</span></span><br><span class=\"line\">        <span class=\"comment\">//setUserDetailsService的类型为UserDetailsService</span></span><br><span class=\"line\">        <span class=\"comment\">//setAuthenticationUserDetailsService的类型为AuthenticationUserDetailsService&lt;CasAssertionAuthenticationToken&gt;</span></span><br><span class=\"line\">        <span class=\"comment\">// 如果使用setUserDetailsService，则其会对UserDetailsService进行封装，new UserDetailsByNameServiceWrapper(userDetailsService)，</span></span><br><span class=\"line\">        <span class=\"comment\">// 将其转换为AuthenticationUserDetailsService&lt;CasAssertionAuthenticationToken&gt;类型</span></span><br><span class=\"line\">        <span class=\"comment\">//这里使用setAuthenticationUserDetailsService是为了接收cas服务端返回的属性，因为CasAssertionAuthenticationToken会接收到返回的属性</span></span><br><span class=\"line\">        casAuthenticationProvider.setAuthenticationUserDetailsService(userDetailsServiceImplByAttrs());</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> casAuthenticationProvider;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Bean</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> UserDetailsServiceImplByAttrs <span class=\"title\">userDetailsServiceImplByAttrs</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        UserDetailsServiceImplByAttrs userDetailsServiceImplByAttrs = <span class=\"keyword\">new</span> UserDetailsServiceImplByAttrs();</span><br><span class=\"line\">        <span class=\"keyword\">return</span> userDetailsServiceImplByAttrs;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure></li>\n<li><p>UserDetailsServiceImplByAttrs的重点就是要继承AbstractCasAssertionUserDetailsService，而不是实现UserDetailsService</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//实际可以接收的属性</span></span><br><span class=\"line\">Map&lt;String, Object&gt; objectMap = assertion.getPrincipal().getAttributes();</span><br></pre></td></tr></table></figure></li>\n<li><p>这里说一下AbstractCasAssertionUserDetailsService，它有一个实现类GrantedAuthorityFromAssertionAttributesUserDetailsService<br>不过其将返回数据都做为用户的权限了，所以其只是用来从服务器端获取用户权限使用</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CasAuthenticationToken principal = (CasAuthenticationToken) request.getUserPrincipal();</span><br><span class=\"line\">UserDetails userDetails = principal.getUserDetails();</span><br><span class=\"line\">Collection&lt;SimpleGrantedAuthority&gt; authorities = (Collection&lt;SimpleGrantedAuthority&gt;) userDetails.getAuthorities();</span><br><span class=\"line\">authorities.stream().forEach(System.out::println);</span><br></pre></td></tr></table></figure></li>\n<li><p>如果希望灵活使用cas返回属性，则需要自定义实现类，笔者这里将获取到的属性map存储到自定义的CustomerUser属性中了</p>\n</li>\n<li><p>代码中使用属性</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#获取登录的用户名称</span><br><span class=\"line\">String username = request.getRemoteUser();</span><br><span class=\"line\">#获取cas返回属性</span><br><span class=\"line\">CasAuthenticationToken principal = (CasAuthenticationToken) request.getUserPrincipal();</span><br><span class=\"line\">UserDetails userDetails = principal.getUserDetails();</span><br><span class=\"line\"><span class=\"keyword\">if</span>(userDetails <span class=\"keyword\">instanceof</span> CustomerUser)&#123;</span><br><span class=\"line\">    Map&lt;String, Object&gt; map = ((CustomerUser) userDetails).getMap();</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (String key : map.keySet()) &#123;</span><br><span class=\"line\">        Object value = map.get(key);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (value != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (value <span class=\"keyword\">instanceof</span> List) &#123;</span><br><span class=\"line\">                List list = (List) value;</span><br><span class=\"line\">                Iterator iterator = list.iterator();</span><br><span class=\"line\">                <span class=\"keyword\">int</span> i = <span class=\"number\">0</span>;</span><br><span class=\"line\">                <span class=\"keyword\">while</span> (iterator.hasNext()) &#123;</span><br><span class=\"line\">                    Object object = iterator.next();</span><br><span class=\"line\">                    System.out.println(<span class=\"string\">&quot;key:&quot;</span> + key + <span class=\"string\">&quot;,values[&quot;</span> + i + <span class=\"string\">&quot;]:&quot;</span> + object.toString());</span><br><span class=\"line\">                    i++;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                System.out.println(<span class=\"string\">&quot;key:&quot;</span> + key + <span class=\"string\">&quot;,value:&quot;</span> + value.toString());</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n</ul>\n","content_text":"摘要 CAS服务端基于cas-overlay-template-5.3.14，已实现基于jdbc的自定义登录策略、验证码、动态service配置、多属性返回，等等 CAS客户端基于spring-boot-2.3.3.RELEASE，spring-security-cas-5.3.4.RELEASE 本文代码地址：https://github.com/hanqunfeng/springbootchapter/tree/master/chapter36 其重点是client的UserDetailsService的实现类要继承自AbstractCasAssertionUserDetailsService cas服务配置 如果是json配置方式：services目录下需要为每个客户端配置一个json文件，如client1-10000005.json 12345678910111213141516171819&#123; &quot;@class&quot; : &quot;org.apereo.cas.services.RegexRegisteredService&quot;, &quot;serviceId&quot; : &quot;^(https|http|imaps)://localhost:8081.*&quot;, #对应客户端的地址匹配路径 &quot;name&quot; : &quot;client1&quot;, #与文件名称对应 &quot;id&quot; : 10000005, #与文件名称对应 &quot;description&quot; : &quot;This service definition authorizes all application urls that support HTTPS and IMAPS protocols.&quot;, &quot;evaluationOrder&quot; : 10, #顺序id不能重复 &quot;logoutType&quot; : &quot;BACK_CHANNEL&quot;, #固定写法 &quot;logoutUrl&quot; : &quot;http://localhost:8081/&quot;, #客户端地址，用于单点登出时通知客户端使用 &quot;attributeReleasePolicy&quot;: &#123; # 属性返回策略 &quot;@class&quot;: &quot;org.apereo.cas.services.ReturnAllAttributeReleasePolicy&quot; &#125;, &quot;accessStrategy&quot; : &#123; #是否允许该客户端访问单点登录，肯定是要开启的啊 &quot;@class&quot; : &quot;org.apereo.cas.services.DefaultRegisteredServiceAccessStrategy&quot;, &quot;enabled&quot; : true, &quot;ssoEnabled&quot; : true &#125;&#125; cas多属性返回 services的json文件中要增加如下配置12345678910# 返回全部配置属性&quot;attributeReleasePolicy&quot;: &#123; &quot;@class&quot;: &quot;org.apereo.cas.services.ReturnAllAttributeReleasePolicy&quot; &#125;# 返回指定配置属性，这里指定只返回username和email两个属性 &quot;attributeReleasePolicy&quot; : &#123; &quot;@class&quot; : &quot;org.apereo.cas.services.ReturnAllowedAttributeReleasePolicy&quot;, &quot;allowedAttributes&quot; : [ &quot;java.util.ArrayList&quot;, [ &quot;username&quot;, &quot;email&quot; ] ] &#125; 动态service12如果使用代码的方式维护service,则也要根据情况来创建返回策略，参考代码chapter36/cas-overlay-template-5.3.14/src/main/java/com/cas/controller/ServiceController.java 配置属性 123456789101112131415161718192021222324252627# 动态services配置################################################# 开启识别Json文件，默认false# 这一段表示从json文件里面初始化服务，如果我们配置了这个，就会将这写json里面的数据，都会自动导入到数据库中cas.serviceRegistry.initFromJson=truecas.serviceRegistry.watcherEnabled=true#设置配置的服务，一直都有，不会给清除掉 ， 第一次使用，需要配置为 create-drop#create-drop 重启cas服务的时候，就会给干掉#create 没有表就创建，有就不创建#none 什么也不做#update 更新#Unrecognized legacy `hibernate.hbm2ddl.auto` value : create-dropscas.serviceRegistry.jpa.ddlAuto=update#配置将service配置到数据库中cas.serviceRegistry.jpa.isolateInternalQueries=falsecas.serviceRegistry.jpa.url=$&#123;jdbc.url&#125;cas.serviceRegistry.jpa.user=$&#123;jdbc.username&#125;cas.serviceRegistry.jpa.password=$&#123;jdbc.password&#125;#这个必须是org.hibernate.dialect.MySQL5Dialect ,我就是这个问题导致表创建失败cas.serviceRegistry.jpa.dialect=org.hibernate.dialect.MySQL5Dialectcas.serviceRegistry.jpa.driverClass=$&#123;jdbc.driver&#125;cas.serviceRegistry.jpa.leakThreshold=10cas.serviceRegistry.jpa.batchSize=1cas.serviceRegistry.jpa.autocommit=truecas.serviceRegistry.jpa.idleTimeout=5000#配置结束################################################ 这里说一下delete异常的问题，可以引入jdbcTemplate直接操作数据表，参考chapter36/cas-overlay-template-5.3.14/src/main/java/com/cas/config/DataSourceConfig.java 12345678List&lt;Map&lt;String, Object&gt;&gt; list = jdbcTemplate.queryForList(&quot;select * from regexregisteredservice where serviceId = &#x27;&quot; + serviceId + &quot;&#x27;&quot;);if (list != null &amp;&amp; list.size() &gt; 0) &#123; has_data = true; jdbcTemplate.update(&quot;delete from regexregisteredservice where serviceId = &#x27;&quot; + serviceId + &quot;&#x27;&quot;);&#125; //执行load生效 servicesManager.load(); 基于配置文件返回属性12345678910111213141516171819202122232425262728293031323334353637####################################################### 属性返回cas.authn.attributeRepository.jdbc[0].sql=select username,password,email from cas_user where username=?# 格式cas.authn.attributeRepository.jdbc[0].attributes.key=value# 返回上面查询结果的username，属性key名称也为username ,以下雷同cas.authn.attributeRepository.jdbc[0].attributes.username=usernamecas.authn.attributeRepository.jdbc[0].attributes.password=passwordcas.authn.attributeRepository.jdbc[0].attributes.email=emailcas.authn.attributeRepository.jdbc[0].singleRow=truecas.authn.attributeRepository.jdbc[0].order=0cas.authn.attributeRepository.jdbc[0].requireAllAttributes=true# cas.authn.attributeRepository.jdbc[0].caseCanonicalization=NONE|LOWER|UPPER# cas.authn.attributeRepository.jdbc[0].queryType=OR|ANDcas.authn.attributeRepository.jdbc[0].username=username#数据库连接cas.authn.attributeRepository.jdbc[0].url=$&#123;jdbc.url&#125;#数据库dialect配置cas.authn.attributeRepository.jdbc[0].dialect=$&#123;jdbc.dialect&#125;#数据库用户名cas.authn.attributeRepository.jdbc[0].user=$&#123;jdbc.username&#125;#数据库用户密码cas.authn.attributeRepository.jdbc[0].password=$&#123;jdbc.password&#125;#数据库事务自动提交cas.authn.attributeRepository.jdbc[0].autocommit=true#数据库驱动cas.authn.attributeRepository.jdbc[0].driverClass=$&#123;jdbc.driver&#125;#超时配置cas.authn.attributeRepository.jdbc[0].idleTimeout=5000cas.authn.attributeRepository.jdbc[0].ddlAuto=nonecas.authn.attributeRepository.jdbc[0].leakThreshold=10cas.authn.attributeRepository.jdbc[0].batchSize=1cas.authn.attributeRepository.jdbc[0].dataSourceProxy=false##################################################### 代码实现返回属性内容 这个需要结合自定义登录策略来实现，代码参考：chapter36/cas-overlay-template-5.3.14/src/main/java/com/cas/security/CustomerHandlerAuthentication.java，注意要关闭配置文件的登录策略，否则会失效 注册自定义登录策略，代码参考：chapter36/cas-overlay-template-5.3.14/src/main/java/com/cas/config/CustomAuthenticationConfig.java 然后将其加入自动配置中,chapter36/cas-overlay-template-5.3.14/src/main/resources/META-INF/spring.factories1234567org.springframework.boot.autoconfigure.EnableAutoConfiguration=\\ org.apereo.cas.config.CasEmbeddedContainerTomcatConfiguration,\\ org.apereo.cas.config.CasEmbeddedContainerTomcatFiltersConfiguration,\\ com.cas.config.MyConfiguration,\\ #自定义的其它需要加入spring上下文的bean com.cas.config.DataSourceConfig,\\ #数据源配置，为了引入JdbcTemplate com.cas.config.CustomAuthenticationConfig,\\ #自定义登录策略配置 com.cas.config.CustomerAuthWebflowConfiguration #自定义登录流程配置 cas-client-springsecurity 这里说一下，如果不使用springsecurity，而是直接依赖cas-client，其获取cas返回属性的方式 12345678910Principal principal = request.getUserPrincipal();if(principal instanceof AttributePrincipal)&#123; //cas传递过来的数据 Map&lt;String,Object&gt; result =( (AttributePrincipal)principal).getAttributes(); for(Map.Entry&lt;String, Object&gt; entry :result.entrySet()) &#123; String key = entry.getKey(); Object val = entry.getValue(); System.out.printf(&quot;%s:%s\\r\\n&quot;,key,val); &#125;&#125; 使用springsecurity的配置类代码参考：chapter36/springsecurity-client-demo/src/main/java/com/example/springsecuritydemo/config/WebSecurityConfigByCASByAttrs.java 1234567891011121314151617181920212223242526272829303132/** * cas 认证 Provider */ @Bean public CasAuthenticationProvider casAuthenticationProvider() &#123; //创建CAS授权认证器 CasAuthenticationProvider casAuthenticationProvider = new CasAuthenticationProvider(); //设置Cas授权认证器相关配置 casAuthenticationProvider.setServiceProperties(serviceProperties()); //设置票据校验器 casAuthenticationProvider.setTicketValidator(cas30ServiceTicketValidator()); casAuthenticationProvider.setKey(&quot;casAuthenticationProviderKey&quot;); //setUserDetailsService和setAuthenticationUserDetailsService只能设置一个，其目的都是为了初始化属性authenticationUserDetailsService //setUserDetailsService的类型为UserDetailsService //setAuthenticationUserDetailsService的类型为AuthenticationUserDetailsService&lt;CasAssertionAuthenticationToken&gt; // 如果使用setUserDetailsService，则其会对UserDetailsService进行封装，new UserDetailsByNameServiceWrapper(userDetailsService)， // 将其转换为AuthenticationUserDetailsService&lt;CasAssertionAuthenticationToken&gt;类型 //这里使用setAuthenticationUserDetailsService是为了接收cas服务端返回的属性，因为CasAssertionAuthenticationToken会接收到返回的属性 casAuthenticationProvider.setAuthenticationUserDetailsService(userDetailsServiceImplByAttrs()); return casAuthenticationProvider; &#125; @Bean public UserDetailsServiceImplByAttrs userDetailsServiceImplByAttrs()&#123; UserDetailsServiceImplByAttrs userDetailsServiceImplByAttrs = new UserDetailsServiceImplByAttrs(); return userDetailsServiceImplByAttrs; &#125; UserDetailsServiceImplByAttrs的重点就是要继承AbstractCasAssertionUserDetailsService，而不是实现UserDetailsService 12//实际可以接收的属性Map&lt;String, Object&gt; objectMap = assertion.getPrincipal().getAttributes(); 这里说一下AbstractCasAssertionUserDetailsService，它有一个实现类GrantedAuthorityFromAssertionAttributesUserDetailsService不过其将返回数据都做为用户的权限了，所以其只是用来从服务器端获取用户权限使用 1234CasAuthenticationToken principal = (CasAuthenticationToken) request.getUserPrincipal();UserDetails userDetails = principal.getUserDetails();Collection&lt;SimpleGrantedAuthority&gt; authorities = (Collection&lt;SimpleGrantedAuthority&gt;) userDetails.getAuthorities();authorities.stream().forEach(System.out::println); 如果希望灵活使用cas返回属性，则需要自定义实现类，笔者这里将获取到的属性map存储到自定义的CustomerUser属性中了 代码中使用属性 12345678910111213141516171819202122232425#获取登录的用户名称String username = request.getRemoteUser();#获取cas返回属性CasAuthenticationToken principal = (CasAuthenticationToken) request.getUserPrincipal();UserDetails userDetails = principal.getUserDetails();if(userDetails instanceof CustomerUser)&#123; Map&lt;String, Object&gt; map = ((CustomerUser) userDetails).getMap(); for (String key : map.keySet()) &#123; Object value = map.get(key); if (value != null) &#123; if (value instanceof List) &#123; List list = (List) value; Iterator iterator = list.iterator(); int i = 0; while (iterator.hasNext()) &#123; Object object = iterator.next(); System.out.println(&quot;key:&quot; + key + &quot;,values[&quot; + i + &quot;]:&quot; + object.toString()); i++; &#125; &#125; else &#123; System.out.println(&quot;key:&quot; + key + &quot;,value:&quot; + value.toString()); &#125; &#125; &#125;&#125;","summary":"摘要 CAS服务端基于cas-overlay-template-5.3.14，已实现基于jdbc的自定义登录策略、验证码、动态service配置、多属性返回，等等 CAS客户端基于spring-boot-2.3.3.RELEASE，spring-security-cas-5.3.4.RELEASE 本文代码地址：https://github.com/hanqunfeng/springbootchapter/tree/master/chapter36 其重点是client的UserDetailsService的实现类要继承自AbstractCasAssertionUserDetailsService","date_published":"2020-09-25T10:30:05.000Z","tags":["技术","springboot2","Java","cas"]},{"id":"https://blog.hanqunfeng.com/2020/09/03/mysql100w-delete2/","url":"https://blog.hanqunfeng.com/2020/09/03/mysql100w-delete2/","title":"AAAAOrder2020-0000001之面试题","content_html":"<h2 id=\"摘要\"><a href=\"#摘要\" class=\"headerlink\" title=\"摘要\"></a>摘要</h2><ul>\n<li>本文内容基于10.4.8-MariaDB</li>\n</ul>\n<div class=\"note info\"><p>Q: 假设一个订单的编号规则是AAAAOrder2020-0000001，AAAAOrder2020-0000002…后面的数字是自增长，如果订单号码达到AAAAOrder2020-1000000(100万)，数据库中应该有100万条数据，此时我随机删除2条数据（物理删除，且不考虑日志和备份），请问怎么找到删掉的数据的编号？给出解题思路即可，答案需要在1秒内运行得到。</p>\n</div>\n<span id=\"more\"></span>\n\n<h2 id=\"思路\"><a href=\"#思路\" class=\"headerlink\" title=\"思路\"></a>思路</h2><div class=\"note info\"><ol>\n<li>其实查找丢失数据方法有很多，不过这里重点强调1秒内运行得到，就限制成了只能在数据库层面完成，实现方法基本上就是sql或者存储过程，而且要尽量减少表的扫描次数和扫描范围、尽可能的使用索引。</li>\n<li>订单编号的序号是自增长，所以可以认为数据是按照编号自增的顺序插入数据表的,如果数据表存在单独的自增主键Id，则可以基于错位法得到缺失的主键Id，这样可以使用主键索引，而且主键自增索引的查询效率是最高的。</li>\n<li>如果没有独立的主键Id，而是使用的orderId作为主键，则需要对orderId截断后进行比较，查询条件一定要使用完整的orderId，以便使用索引，也可以使用行号和截断后的订单编号进行比较的方法。具体实现见下文。</li>\n</ol>\n</div>\n\n<h2 id=\"参考答案，作者水平有限，仅供学习交流\"><a href=\"#参考答案，作者水平有限，仅供学习交流\" class=\"headerlink\" title=\"参考答案，作者水平有限，仅供学习交流\"></a>参考答案，作者水平有限，仅供学习交流</h2><div class=\"note info\"><ol>\n<li>存在自增主键Id，与orderId序号一致，可以通过错位法计算不存在的Id值。<br>运行时间基本符合要求。</li>\n</ol>\n</div>\n\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">select</span> id<span class=\"number\">-1</span> <span class=\"keyword\">as</span> id_del <span class=\"keyword\">from</span> test_order <span class=\"keyword\">where</span> id <span class=\"keyword\">not</span> <span class=\"keyword\">in</span> (<span class=\"keyword\">select</span> id<span class=\"operator\">+</span><span class=\"number\">1</span> <span class=\"keyword\">from</span> test_order);</span><br><span class=\"line\"><span class=\"operator\">+</span><span class=\"comment\">--------+</span></span><br><span class=\"line\"><span class=\"operator\">|</span> id_del <span class=\"operator\">|</span></span><br><span class=\"line\"><span class=\"operator\">+</span><span class=\"comment\">--------+</span></span><br><span class=\"line\"><span class=\"operator\">|</span> <span class=\"number\">233490</span> <span class=\"operator\">|</span></span><br><span class=\"line\"><span class=\"operator\">|</span> <span class=\"number\">943220</span> <span class=\"operator\">|</span></span><br><span class=\"line\"><span class=\"operator\">|</span>      <span class=\"number\">0</span> <span class=\"operator\">|</span>  #这里去除<span class=\"number\">0</span>号记录，因为不存在id为<span class=\"number\">0</span>的记录</span><br><span class=\"line\"><span class=\"operator\">+</span><span class=\"comment\">--------+</span></span><br><span class=\"line\"><span class=\"number\">3</span> <span class=\"keyword\">rows</span> <span class=\"keyword\">in</span> <span class=\"keyword\">set</span> (<span class=\"number\">1.063</span> sec)</span><br></pre></td></tr></table></figure>\n\n\n<div class=\"note info\"><ol start=\"2\">\n<li>如果不存在自增主键ID，而是使用orderId作为主键，则也可以通过错位法计算不存在的Id值，主要比较时一定要用完整的orderId，否则不能使用索引。<br>运行时间超过要求。</li>\n</ol>\n</div>\n\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">SELECT</span> <span class=\"keyword\">RIGHT</span>(orderId, <span class=\"number\">7</span>) <span class=\"operator\">-</span> <span class=\"number\">1</span> <span class=\"keyword\">AS</span> id_del <span class=\"keyword\">FROM</span> test_order</span><br><span class=\"line\">  <span class=\"keyword\">WHERE</span> orderId <span class=\"keyword\">NOT</span> <span class=\"keyword\">in</span>(</span><br><span class=\"line\">    <span class=\"keyword\">SELECT</span> concat( <span class=\"keyword\">left</span>(orderId, <span class=\"number\">14</span>), LPAD( <span class=\"keyword\">RIGHT</span>(orderId, <span class=\"number\">7</span>) <span class=\"operator\">+</span> <span class=\"number\">1</span>, <span class=\"number\">7</span>, <span class=\"number\">0</span>))</span><br><span class=\"line\">    <span class=\"keyword\">FROM</span> test_order);</span><br><span class=\"line\"><span class=\"operator\">+</span><span class=\"comment\">--------+</span></span><br><span class=\"line\"><span class=\"operator\">|</span> id_del <span class=\"operator\">|</span></span><br><span class=\"line\"><span class=\"operator\">+</span><span class=\"comment\">--------+</span></span><br><span class=\"line\"><span class=\"operator\">|</span>      <span class=\"number\">0</span> <span class=\"operator\">|</span>   #这里去除<span class=\"number\">0</span>号记录，因为不存在id为<span class=\"number\">0</span>的记录</span><br><span class=\"line\"><span class=\"operator\">|</span> <span class=\"number\">233490</span> <span class=\"operator\">|</span></span><br><span class=\"line\"><span class=\"operator\">|</span> <span class=\"number\">943220</span> <span class=\"operator\">|</span></span><br><span class=\"line\"><span class=\"operator\">+</span><span class=\"comment\">--------+</span></span><br><span class=\"line\"><span class=\"number\">3</span> <span class=\"keyword\">rows</span> <span class=\"keyword\">in</span> <span class=\"keyword\">set</span> (<span class=\"number\">2.999</span> sec)</span><br></pre></td></tr></table></figure>\n\n\n<div class=\"note info\"><ol start=\"3\">\n<li>如果不存在自增主键ID，而是使用orderId作为主键，也可以比较orderId的序号与行号，获取到不一致的第一条记录，然后在从该记录开始继续比较获得下一条不一致的记录，也可以通过存储过程实现。<br>运行时间符合要求。</li>\n</ol>\n</div>\n\n<h3 id=\"sql示例1\"><a href=\"#sql示例1\" class=\"headerlink\" title=\"sql示例1\"></a>sql示例1</h3><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">-- 查询第一条丢失记录</span></span><br><span class=\"line\"><span class=\"keyword\">select</span> <span class=\"built_in\">substring</span>(a.orderId,<span class=\"number\">15</span>)<span class=\"number\">-1</span> <span class=\"keyword\">as</span> orderId <span class=\"keyword\">from</span> (</span><br><span class=\"line\">     <span class=\"keyword\">SELECT</span> <span class=\"variable\">@rownum</span>:<span class=\"operator\">=</span><span class=\"variable\">@rownum</span><span class=\"operator\">+</span><span class=\"number\">1</span> <span class=\"keyword\">AS</span> rownum, test_order.orderId  <span class=\"keyword\">FROM</span> (<span class=\"keyword\">SELECT</span> <span class=\"variable\">@rownum</span>:<span class=\"operator\">=</span><span class=\"number\">0</span>) r, test_order</span><br><span class=\"line\">     ) a <span class=\"keyword\">where</span> <span class=\"built_in\">substring</span>(a.orderId,<span class=\"number\">15</span>) <span class=\"operator\">!=</span> a.rownum limit <span class=\"number\">1</span>;</span><br><span class=\"line\"><span class=\"operator\">+</span><span class=\"comment\">---------+</span></span><br><span class=\"line\"><span class=\"operator\">|</span> orderId <span class=\"operator\">|</span></span><br><span class=\"line\"><span class=\"operator\">+</span><span class=\"comment\">---------+</span></span><br><span class=\"line\"><span class=\"operator\">|</span>  <span class=\"number\">233490</span> <span class=\"operator\">|</span></span><br><span class=\"line\"><span class=\"operator\">+</span><span class=\"comment\">---------+</span></span><br><span class=\"line\"><span class=\"number\">1</span> <span class=\"type\">row</span> <span class=\"keyword\">in</span> <span class=\"keyword\">set</span> (<span class=\"number\">0.341</span> sec)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">-- 将上面查询结果作为第二条sql的参数，这里上一条查询结果为 233490，所以下面手工填写对应的值，</span></span><br><span class=\"line\"><span class=\"comment\">-- 这里因为limit不能写变量，所以需要手工填写，如果希望一次执行，可以参考后面的sql示例2和存储过程示例</span></span><br><span class=\"line\"><span class=\"keyword\">select</span> <span class=\"built_in\">substring</span>(a.orderId,<span class=\"number\">15</span>)<span class=\"number\">-1</span> <span class=\"keyword\">as</span> orderId <span class=\"keyword\">from</span> (</span><br><span class=\"line\">     <span class=\"keyword\">SELECT</span> <span class=\"variable\">@rownum</span>:<span class=\"operator\">=</span><span class=\"variable\">@rownum</span><span class=\"operator\">+</span><span class=\"number\">1</span> <span class=\"keyword\">AS</span> rownum, test_order.orderId  <span class=\"keyword\">FROM</span> (<span class=\"keyword\">SELECT</span> <span class=\"variable\">@rownum</span>:<span class=\"operator\">=</span><span class=\"number\">0</span>) r, test_order</span><br><span class=\"line\">     limit <span class=\"number\">233489</span>,<span class=\"number\">1000000</span></span><br><span class=\"line\">     ) a <span class=\"keyword\">where</span> <span class=\"built_in\">substring</span>(a.orderId,<span class=\"number\">15</span>)<span class=\"number\">-233490</span> <span class=\"operator\">!=</span> a.rownum limit <span class=\"number\">1</span>;</span><br><span class=\"line\"><span class=\"operator\">+</span><span class=\"comment\">---------+</span></span><br><span class=\"line\"><span class=\"operator\">|</span> orderId <span class=\"operator\">|</span></span><br><span class=\"line\"><span class=\"operator\">+</span><span class=\"comment\">---------+</span></span><br><span class=\"line\"><span class=\"operator\">|</span>  <span class=\"number\">943220</span> <span class=\"operator\">|</span></span><br><span class=\"line\"><span class=\"operator\">+</span><span class=\"comment\">---------+</span></span><br><span class=\"line\"><span class=\"number\">1</span> <span class=\"type\">row</span> <span class=\"keyword\">in</span> <span class=\"keyword\">set</span> (<span class=\"number\">0.372</span> sec)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">-- 验证是否准确</span></span><br><span class=\"line\"><span class=\"keyword\">select</span> orderId <span class=\"keyword\">from</span> test_order limit <span class=\"number\">233488</span>,<span class=\"number\">2</span>;</span><br><span class=\"line\"><span class=\"operator\">+</span><span class=\"comment\">----------------------+</span></span><br><span class=\"line\"><span class=\"operator\">|</span> orderId              <span class=\"operator\">|</span></span><br><span class=\"line\"><span class=\"operator\">+</span><span class=\"comment\">----------------------+</span></span><br><span class=\"line\"><span class=\"operator\">|</span> aaaaorder2020<span class=\"number\">-233489</span> <span class=\"operator\">|</span></span><br><span class=\"line\"><span class=\"operator\">|</span> aaaaorder2020<span class=\"number\">-233491</span> <span class=\"operator\">|</span></span><br><span class=\"line\"><span class=\"operator\">+</span><span class=\"comment\">----------------------+</span></span><br><span class=\"line\"><span class=\"number\">2</span> <span class=\"keyword\">rows</span> <span class=\"keyword\">in</span> <span class=\"keyword\">set</span> (<span class=\"number\">0.036</span> sec)</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"sql示例2\"><a href=\"#sql示例2\" class=\"headerlink\" title=\"sql示例2\"></a>sql示例2</h3><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">-- 可以直接粘贴到mysql终端执行，也可以保存到文件，然后在mysql终端执行source /xx/xx/xx.sql</span></span><br><span class=\"line\"><span class=\"comment\">-- 这里修改定界符，就是为了方便看到一个总的执行时间</span></span><br><span class=\"line\">delimiter ;;</span><br><span class=\"line\"><span class=\"keyword\">select</span> <span class=\"built_in\">substring</span>(a.orderId,<span class=\"number\">15</span>)<span class=\"number\">-1</span> <span class=\"keyword\">as</span> orderId <span class=\"keyword\">into</span> <span class=\"variable\">@first</span>_order_id <span class=\"keyword\">from</span> (</span><br><span class=\"line\">     <span class=\"keyword\">SELECT</span> <span class=\"variable\">@rownum</span>:<span class=\"operator\">=</span><span class=\"variable\">@rownum</span><span class=\"operator\">+</span><span class=\"number\">1</span> <span class=\"keyword\">AS</span> rownum, test_order.orderId  <span class=\"keyword\">FROM</span> (<span class=\"keyword\">SELECT</span> <span class=\"variable\">@rownum</span>:<span class=\"operator\">=</span><span class=\"number\">0</span>) r, test_order</span><br><span class=\"line\">     ) a <span class=\"keyword\">where</span> <span class=\"built_in\">substring</span>(a.orderId,<span class=\"number\">15</span>) <span class=\"operator\">!=</span> a.rownum limit <span class=\"number\">1</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">SET</span> <span class=\"variable\">@second</span>_limit <span class=\"operator\">=</span> <span class=\"variable\">@first</span>_order_id <span class=\"operator\">-</span> <span class=\"number\">1</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">SET</span> <span class=\"variable\">@limitsql</span> <span class=\"operator\">=</span> CONCAT( <span class=\"string\">&#x27;SELECT @rownum:=@rownum+1 AS rownum, test_order.orderId  FROM (SELECT @rownum:=0) r, test_order</span></span><br><span class=\"line\"><span class=\"string\">limit &#x27;</span>, <span class=\"variable\">@second</span>_limit, <span class=\"string\">&#x27;,1000000&#x27;</span> );</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">SET</span> <span class=\"variable\">@SQL</span> <span class=\"operator\">=</span> CONCAT( <span class=\"string\">&#x27;select substring(a.orderId,15)-1 as orderId into @second_order_id from (&#x27;</span>, <span class=\"variable\">@limitsql</span>, <span class=\"string\">&#x27;</span></span><br><span class=\"line\"><span class=\"string\">) a where substring(a.orderId,15)-&#x27;</span>, <span class=\"variable\">@first</span>_order_id, <span class=\"string\">&#x27; != a.rownum limit 1&#x27;</span> );</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">PREPARE</span> stmt <span class=\"keyword\">FROM</span> <span class=\"variable\">@SQL</span>;</span><br><span class=\"line\"><span class=\"keyword\">EXECUTE</span> stmt;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">SET</span> <span class=\"variable\">@del</span>_ids <span class=\"operator\">=</span> concat( <span class=\"variable\">@first</span>_order_id, <span class=\"string\">&#x27;,&#x27;</span>, <span class=\"variable\">@second</span>_order_id );</span><br><span class=\"line\">;;</span><br><span class=\"line\">delimiter ;</span><br><span class=\"line\"><span class=\"keyword\">SELECT</span> <span class=\"variable\">@del</span>_ids;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">source <span class=\"operator\">/</span>Users<span class=\"operator\">/</span>hanqf<span class=\"operator\">/</span>Desktop<span class=\"operator\">/</span>exec.sql</span><br><span class=\"line\">Query OK, <span class=\"number\">1</span> <span class=\"type\">row</span> affected (<span class=\"number\">0.710</span> sec)</span><br><span class=\"line\"></span><br><span class=\"line\">Query OK, <span class=\"number\">0</span> <span class=\"keyword\">rows</span> affected (<span class=\"number\">0.710</span> sec)</span><br><span class=\"line\"></span><br><span class=\"line\">Query OK, <span class=\"number\">0</span> <span class=\"keyword\">rows</span> affected (<span class=\"number\">0.710</span> sec)</span><br><span class=\"line\"></span><br><span class=\"line\">Query OK, <span class=\"number\">0</span> <span class=\"keyword\">rows</span> affected (<span class=\"number\">0.710</span> sec)</span><br><span class=\"line\"></span><br><span class=\"line\">Query OK, <span class=\"number\">0</span> <span class=\"keyword\">rows</span> affected (<span class=\"number\">0.710</span> sec)</span><br><span class=\"line\">Statement prepared</span><br><span class=\"line\"></span><br><span class=\"line\">Query OK, <span class=\"number\">1</span> <span class=\"type\">row</span> affected (<span class=\"number\">0.710</span> sec)</span><br><span class=\"line\"></span><br><span class=\"line\">Query OK, <span class=\"number\">0</span> <span class=\"keyword\">rows</span> affected (<span class=\"number\">0.710</span> sec)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"operator\">+</span><span class=\"comment\">---------------+</span></span><br><span class=\"line\"><span class=\"operator\">|</span> <span class=\"variable\">@del</span>_ids      <span class=\"operator\">|</span></span><br><span class=\"line\"><span class=\"operator\">+</span><span class=\"comment\">---------------+</span></span><br><span class=\"line\"><span class=\"operator\">|</span> <span class=\"number\">233490</span>,<span class=\"number\">943220</span> <span class=\"operator\">|</span></span><br><span class=\"line\"><span class=\"operator\">+</span><span class=\"comment\">---------------+</span></span><br><span class=\"line\"><span class=\"number\">1</span> <span class=\"type\">row</span> <span class=\"keyword\">in</span> <span class=\"keyword\">set</span> (<span class=\"number\">0.000</span> sec)</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"存储过程示例\"><a href=\"#存储过程示例\" class=\"headerlink\" title=\"存储过程示例\"></a>存储过程示例</h3><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">DROP</span> <span class=\"keyword\">PROCEDURE</span> IF <span class=\"keyword\">EXISTS</span> find_delete_order_id;</span><br><span class=\"line\"><span class=\"keyword\">CREATE</span> <span class=\"keyword\">PROCEDURE</span> `find_delete_order_id`(<span class=\"keyword\">OUT</span> del_ids <span class=\"type\">varchar</span>(<span class=\"number\">255</span>))</span><br><span class=\"line\"><span class=\"keyword\">BEGIN</span></span><br><span class=\"line\">  <span class=\"keyword\">DECLARE</span> first_order_id <span class=\"type\">INT</span>;</span><br><span class=\"line\">  <span class=\"keyword\">DECLARE</span> second_order_id <span class=\"type\">INT</span>;</span><br><span class=\"line\">  <span class=\"keyword\">DECLARE</span> second_limit <span class=\"type\">INT</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">select</span> <span class=\"built_in\">substring</span>(a.orderId,<span class=\"number\">15</span>)<span class=\"number\">-1</span> <span class=\"keyword\">as</span> orderId <span class=\"keyword\">into</span> first_order_id <span class=\"keyword\">from</span> (</span><br><span class=\"line\">     <span class=\"keyword\">SELECT</span> <span class=\"variable\">@rownum</span>:<span class=\"operator\">=</span><span class=\"variable\">@rownum</span><span class=\"operator\">+</span><span class=\"number\">1</span> <span class=\"keyword\">AS</span> rownum, test_order.orderId  <span class=\"keyword\">FROM</span> (<span class=\"keyword\">SELECT</span> <span class=\"variable\">@rownum</span>:<span class=\"operator\">=</span><span class=\"number\">0</span>) r, test_order</span><br><span class=\"line\">     ) a <span class=\"keyword\">where</span> <span class=\"built_in\">substring</span>(a.orderId,<span class=\"number\">15</span>) <span class=\"operator\">!=</span> a.rownum limit <span class=\"number\">1</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">set</span> second_limit <span class=\"operator\">=</span> first_order_id<span class=\"number\">-1</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">select</span> <span class=\"built_in\">substring</span>(a.orderId,<span class=\"number\">15</span>)<span class=\"number\">-1</span> <span class=\"keyword\">as</span> orderId <span class=\"keyword\">into</span> second_order_id <span class=\"keyword\">from</span> (</span><br><span class=\"line\">     <span class=\"keyword\">SELECT</span> <span class=\"variable\">@rownum</span>:<span class=\"operator\">=</span><span class=\"variable\">@rownum</span><span class=\"operator\">+</span><span class=\"number\">1</span> <span class=\"keyword\">AS</span> rownum, test_order.orderId  <span class=\"keyword\">FROM</span> (<span class=\"keyword\">SELECT</span> <span class=\"variable\">@rownum</span>:<span class=\"operator\">=</span><span class=\"number\">0</span>) r, test_order</span><br><span class=\"line\">     limit second_limit,<span class=\"number\">1000000</span></span><br><span class=\"line\">     ) a <span class=\"keyword\">where</span> <span class=\"built_in\">substring</span>(a.orderId,<span class=\"number\">15</span>)<span class=\"operator\">-</span>first_order_id <span class=\"operator\">!=</span> a.rownum limit <span class=\"number\">1</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">set</span> del_ids <span class=\"operator\">=</span> concat(first_order_id,<span class=\"string\">&#x27;,&#x27;</span>,second_order_id);</span><br><span class=\"line\">  <span class=\"comment\">-- 此处为了方便测试，所以在存储过程中就打印了结果</span></span><br><span class=\"line\">  <span class=\"keyword\">select</span> del_ids;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">END</span>;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">CALL</span> `find_delete_order_id`(<span class=\"variable\">@del</span>_ids);</span><br><span class=\"line\"><span class=\"operator\">+</span><span class=\"comment\">---------------+</span></span><br><span class=\"line\"><span class=\"operator\">|</span> del_ids       <span class=\"operator\">|</span></span><br><span class=\"line\"><span class=\"operator\">+</span><span class=\"comment\">---------------+</span></span><br><span class=\"line\"><span class=\"operator\">|</span> <span class=\"number\">233490</span>,<span class=\"number\">943220</span> <span class=\"operator\">|</span></span><br><span class=\"line\"><span class=\"operator\">+</span><span class=\"comment\">---------------+</span></span><br><span class=\"line\"><span class=\"number\">1</span> <span class=\"type\">row</span> <span class=\"keyword\">in</span> <span class=\"keyword\">set</span> (<span class=\"number\">0.704</span> sec)</span><br><span class=\"line\"></span><br><span class=\"line\">Query OK, <span class=\"number\">2</span> <span class=\"keyword\">rows</span> affected (<span class=\"number\">0.704</span> sec)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">select</span> <span class=\"variable\">@del</span>_ids;</span><br><span class=\"line\"><span class=\"operator\">+</span><span class=\"comment\">---------------+</span></span><br><span class=\"line\"><span class=\"operator\">|</span> <span class=\"variable\">@del</span>_ids      <span class=\"operator\">|</span></span><br><span class=\"line\"><span class=\"operator\">+</span><span class=\"comment\">---------------+</span></span><br><span class=\"line\"><span class=\"operator\">|</span> <span class=\"number\">233490</span>,<span class=\"number\">943220</span> <span class=\"operator\">|</span></span><br><span class=\"line\"><span class=\"operator\">+</span><span class=\"comment\">---------------+</span></span><br><span class=\"line\"><span class=\"number\">1</span> <span class=\"type\">row</span> <span class=\"keyword\">in</span> <span class=\"keyword\">set</span> (<span class=\"number\">0.000</span> sec)</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"表结构\"><a href=\"#表结构\" class=\"headerlink\" title=\"表结构\"></a>表结构</h2><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">DROP</span> <span class=\"keyword\">TABLE</span> IF <span class=\"keyword\">EXISTS</span> `test_order`;</span><br><span class=\"line\"><span class=\"keyword\">CREATE</span> <span class=\"keyword\">TABLE</span> `test_order` (</span><br><span class=\"line\">  `id` <span class=\"type\">int</span>(<span class=\"number\">11</span>) <span class=\"keyword\">NOT</span> <span class=\"keyword\">NULL</span> AUTO_INCREMENT,</span><br><span class=\"line\">  `orderId` <span class=\"type\">varchar</span>(<span class=\"number\">30</span>) <span class=\"keyword\">DEFAULT</span> <span class=\"keyword\">NULL</span>,</span><br><span class=\"line\">  <span class=\"keyword\">PRIMARY</span> KEY (`id`),</span><br><span class=\"line\">  <span class=\"keyword\">UNIQUE</span> KEY `index_order_id` (`orderId`) <span class=\"keyword\">USING</span> HASH</span><br><span class=\"line\">) ENGINE<span class=\"operator\">=</span>InnoDB AUTO_INCREMENT<span class=\"operator\">=</span><span class=\"number\">1</span> <span class=\"keyword\">DEFAULT</span> CHARSET<span class=\"operator\">=</span>utf8;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"数据初始化\"><a href=\"#数据初始化\" class=\"headerlink\" title=\"数据初始化\"></a>数据初始化</h2><div class=\"note info\"><p>说明：</p>\n<ol>\n<li><p>直接将100w的数据插入数据表有点慢，实测130多秒吧，这里可以先将数据初始化到内存表中，然后再从内存表导入即可，总时间大概只需要12秒左右。</p>\n</li>\n<li><p>因为数据都是写入内存中，所以写入数据时可能会报内存不足，解决方法如下：<br>a.永久修改，在my.cnf中增加如下配置:<br> tmp_table_size=1G<br> max_heap_table_size=1G</p>\n<p>b.临时修改,mysql终端执行：<br> set tmp_table_size = 1073741824;<br> set max_heap_table_size = 1073741824;<br> show variables like “%table_size%”;</p>\n</li>\n</ol>\n</div>\n\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">-- 创建内存表，重启数据库后，内存表中的数据会被清空，但是表结构依旧存在，不需要时可以drop掉</span></span><br><span class=\"line\"><span class=\"keyword\">DROP</span> <span class=\"keyword\">TABLE</span> IF <span class=\"keyword\">EXISTS</span> `test_order_memory`;</span><br><span class=\"line\"><span class=\"keyword\">CREATE</span> <span class=\"keyword\">TABLE</span> `test_order_memory` (</span><br><span class=\"line\">  `id` <span class=\"type\">int</span>(<span class=\"number\">11</span>) <span class=\"keyword\">NOT</span> <span class=\"keyword\">NULL</span> AUTO_INCREMENT,</span><br><span class=\"line\">  `orderId` <span class=\"type\">varchar</span>(<span class=\"number\">30</span>) <span class=\"keyword\">DEFAULT</span> <span class=\"keyword\">NULL</span>,</span><br><span class=\"line\">  <span class=\"keyword\">PRIMARY</span> KEY (`id`),</span><br><span class=\"line\">  <span class=\"keyword\">UNIQUE</span> KEY `index_order_id` (`orderId`) <span class=\"keyword\">USING</span> HASH</span><br><span class=\"line\">) ENGINE<span class=\"operator\">=</span>MEMORY AUTO_INCREMENT<span class=\"operator\">=</span><span class=\"number\">1</span> <span class=\"keyword\">DEFAULT</span> CHARSET<span class=\"operator\">=</span>utf8;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">-- 初始化内存表</span></span><br><span class=\"line\"><span class=\"keyword\">DROP</span> <span class=\"keyword\">PROCEDURE</span> IF <span class=\"keyword\">EXISTS</span> add_test_order_memory;</span><br><span class=\"line\"><span class=\"keyword\">CREATE</span> <span class=\"keyword\">PROCEDURE</span> `add_test_order_memory`(<span class=\"keyword\">IN</span> n <span class=\"type\">int</span>)</span><br><span class=\"line\"><span class=\"keyword\">BEGIN</span></span><br><span class=\"line\">  <span class=\"keyword\">DECLARE</span> i <span class=\"type\">INT</span> <span class=\"keyword\">DEFAULT</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">    WHILE (i <span class=\"operator\">&lt;=</span> n ) DO</span><br><span class=\"line\">      <span class=\"keyword\">INSERT</span> <span class=\"keyword\">INTO</span> test_order_memory (orderId) <span class=\"keyword\">VALUES</span> (concat(<span class=\"string\">&#x27;aaaaorder2020-&#x27;</span>,LPAD(i, <span class=\"number\">7</span>, <span class=\"number\">0</span>)));</span><br><span class=\"line\">      <span class=\"keyword\">set</span> i<span class=\"operator\">=</span>i<span class=\"operator\">+</span><span class=\"number\">1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">END</span> WHILE;</span><br><span class=\"line\"><span class=\"keyword\">END</span>;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">-- 创建1000000条数据</span></span><br><span class=\"line\"><span class=\"keyword\">call</span> add_test_order_memory(<span class=\"number\">1000000</span>);</span><br><span class=\"line\">Query OK, <span class=\"number\">1000000</span> <span class=\"keyword\">rows</span> affected (<span class=\"number\">7.354</span> sec)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">-- 将内存表中数据导入实际表中</span></span><br><span class=\"line\"><span class=\"keyword\">INSERT</span> <span class=\"keyword\">into</span> test_order <span class=\"keyword\">SELECT</span> <span class=\"operator\">*</span> <span class=\"keyword\">from</span>  test_order_memory;</span><br><span class=\"line\">Query OK, <span class=\"number\">1000000</span> <span class=\"keyword\">rows</span> affected (<span class=\"number\">5.035</span> sec)</span><br><span class=\"line\">Records: <span class=\"number\">1000000</span>  Duplicates: <span class=\"number\">0</span>  Warnings: <span class=\"number\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">-- 查看结果</span></span><br><span class=\"line\"><span class=\"keyword\">select</span> <span class=\"operator\">*</span> <span class=\"keyword\">from</span> test_order limit <span class=\"number\">5</span>;</span><br><span class=\"line\"><span class=\"operator\">+</span><span class=\"comment\">----+-----------------------+</span></span><br><span class=\"line\"><span class=\"operator\">|</span> id <span class=\"operator\">|</span> orderId               <span class=\"operator\">|</span></span><br><span class=\"line\"><span class=\"operator\">+</span><span class=\"comment\">----+-----------------------+</span></span><br><span class=\"line\"><span class=\"operator\">|</span>  <span class=\"number\">1</span> <span class=\"operator\">|</span> aaaaorder2020<span class=\"number\">-0000001</span> <span class=\"operator\">|</span></span><br><span class=\"line\"><span class=\"operator\">|</span>  <span class=\"number\">2</span> <span class=\"operator\">|</span> aaaaorder2020<span class=\"number\">-0000002</span> <span class=\"operator\">|</span></span><br><span class=\"line\"><span class=\"operator\">|</span>  <span class=\"number\">3</span> <span class=\"operator\">|</span> aaaaorder2020<span class=\"number\">-0000003</span> <span class=\"operator\">|</span></span><br><span class=\"line\"><span class=\"operator\">|</span>  <span class=\"number\">4</span> <span class=\"operator\">|</span> aaaaorder2020<span class=\"number\">-0000004</span> <span class=\"operator\">|</span></span><br><span class=\"line\"><span class=\"operator\">|</span>  <span class=\"number\">5</span> <span class=\"operator\">|</span> aaaaorder2020<span class=\"number\">-0000005</span> <span class=\"operator\">|</span></span><br><span class=\"line\"><span class=\"operator\">+</span><span class=\"comment\">----+-----------------------+</span></span><br><span class=\"line\"><span class=\"number\">5</span> <span class=\"keyword\">rows</span> <span class=\"keyword\">in</span> <span class=\"keyword\">set</span> (<span class=\"number\">0.000</span> sec)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">-- 删除两条数据，这里就随便填两个id号</span></span><br><span class=\"line\"><span class=\"keyword\">delete</span> <span class=\"keyword\">from</span> test_order <span class=\"keyword\">where</span> id <span class=\"keyword\">in</span> (<span class=\"number\">233490</span>,<span class=\"number\">943220</span>);</span><br><span class=\"line\">Query OK, <span class=\"number\">2</span> <span class=\"keyword\">rows</span> affected (<span class=\"number\">0.001</span> sec)</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>","content_text":"摘要 本文内容基于10.4.8-MariaDB Q: 假设一个订单的编号规则是AAAAOrder2020-0000001，AAAAOrder2020-0000002…后面的数字是自增长，如果订单号码达到AAAAOrder2020-1000000(100万)，数据库中应该有100万条数据，此时我随机删除2条数据（物理删除，且不考虑日志和备份），请问怎么找到删掉的数据的编号？给出解题思路即可，答案需要在1秒内运行得到。 思路 其实查找丢失数据方法有很多，不过这里重点强调1秒内运行得到，就限制成了只能在数据库层面完成，实现方法基本上就是sql或者存储过程，而且要尽量减少表的扫描次数和扫描范围、尽可能的使用索引。 订单编号的序号是自增长，所以可以认为数据是按照编号自增的顺序插入数据表的,如果数据表存在单独的自增主键Id，则可以基于错位法得到缺失的主键Id，这样可以使用主键索引，而且主键自增索引的查询效率是最高的。 如果没有独立的主键Id，而是使用的orderId作为主键，则需要对orderId截断后进行比较，查询条件一定要使用完整的orderId，以便使用索引，也可以使用行号和截断后的订单编号进行比较的方法。具体实现见下文。 参考答案，作者水平有限，仅供学习交流 存在自增主键Id，与orderId序号一致，可以通过错位法计算不存在的Id值。运行时间基本符合要求。 123456789select id-1 as id_del from test_order where id not in (select id+1 from test_order);+--------+| id_del |+--------+| 233490 || 943220 || 0 | #这里去除0号记录，因为不存在id为0的记录+--------+3 rows in set (1.063 sec) 如果不存在自增主键ID，而是使用orderId作为主键，则也可以通过错位法计算不存在的Id值，主要比较时一定要用完整的orderId，否则不能使用索引。运行时间超过要求。 123456789101112SELECT RIGHT(orderId, 7) - 1 AS id_del FROM test_order WHERE orderId NOT in( SELECT concat( left(orderId, 14), LPAD( RIGHT(orderId, 7) + 1, 7, 0)) FROM test_order);+--------+| id_del |+--------+| 0 | #这里去除0号记录，因为不存在id为0的记录| 233490 || 943220 |+--------+3 rows in set (2.999 sec) 如果不存在自增主键ID，而是使用orderId作为主键，也可以比较orderId的序号与行号，获取到不一致的第一条记录，然后在从该记录开始继续比较获得下一条不一致的记录，也可以通过存储过程实现。运行时间符合要求。 sql示例1123456789101112131415161718192021222324252627282930313233-- 查询第一条丢失记录select substring(a.orderId,15)-1 as orderId from ( SELECT @rownum:=@rownum+1 AS rownum, test_order.orderId FROM (SELECT @rownum:=0) r, test_order ) a where substring(a.orderId,15) != a.rownum limit 1;+---------+| orderId |+---------+| 233490 |+---------+1 row in set (0.341 sec)-- 将上面查询结果作为第二条sql的参数，这里上一条查询结果为 233490，所以下面手工填写对应的值，-- 这里因为limit不能写变量，所以需要手工填写，如果希望一次执行，可以参考后面的sql示例2和存储过程示例select substring(a.orderId,15)-1 as orderId from ( SELECT @rownum:=@rownum+1 AS rownum, test_order.orderId FROM (SELECT @rownum:=0) r, test_order limit 233489,1000000 ) a where substring(a.orderId,15)-233490 != a.rownum limit 1;+---------+| orderId |+---------+| 943220 |+---------+1 row in set (0.372 sec)-- 验证是否准确select orderId from test_order limit 233488,2;+----------------------+| orderId |+----------------------+| aaaaorder2020-233489 || aaaaorder2020-233491 |+----------------------+2 rows in set (0.036 sec) sql示例21234567891011121314151617181920212223-- 可以直接粘贴到mysql终端执行，也可以保存到文件，然后在mysql终端执行source /xx/xx/xx.sql-- 这里修改定界符，就是为了方便看到一个总的执行时间delimiter ;;select substring(a.orderId,15)-1 as orderId into @first_order_id from ( SELECT @rownum:=@rownum+1 AS rownum, test_order.orderId FROM (SELECT @rownum:=0) r, test_order ) a where substring(a.orderId,15) != a.rownum limit 1;SET @second_limit = @first_order_id - 1;SET @limitsql = CONCAT( &#x27;SELECT @rownum:=@rownum+1 AS rownum, test_order.orderId FROM (SELECT @rownum:=0) r, test_orderlimit &#x27;, @second_limit, &#x27;,1000000&#x27; );SET @SQL = CONCAT( &#x27;select substring(a.orderId,15)-1 as orderId into @second_order_id from (&#x27;, @limitsql, &#x27;) a where substring(a.orderId,15)-&#x27;, @first_order_id, &#x27; != a.rownum limit 1&#x27; );PREPARE stmt FROM @SQL;EXECUTE stmt;SET @del_ids = concat( @first_order_id, &#x27;,&#x27;, @second_order_id );;;delimiter ;SELECT @del_ids; 12345678910111213141516171819202122source /Users/hanqf/Desktop/exec.sqlQuery OK, 1 row affected (0.710 sec)Query OK, 0 rows affected (0.710 sec)Query OK, 0 rows affected (0.710 sec)Query OK, 0 rows affected (0.710 sec)Query OK, 0 rows affected (0.710 sec)Statement preparedQuery OK, 1 row affected (0.710 sec)Query OK, 0 rows affected (0.710 sec)+---------------+| @del_ids |+---------------+| 233490,943220 |+---------------+1 row in set (0.000 sec) 存储过程示例123456789101112131415161718192021222324DROP PROCEDURE IF EXISTS find_delete_order_id;CREATE PROCEDURE `find_delete_order_id`(OUT del_ids varchar(255))BEGIN DECLARE first_order_id INT; DECLARE second_order_id INT; DECLARE second_limit INT; select substring(a.orderId,15)-1 as orderId into first_order_id from ( SELECT @rownum:=@rownum+1 AS rownum, test_order.orderId FROM (SELECT @rownum:=0) r, test_order ) a where substring(a.orderId,15) != a.rownum limit 1; set second_limit = first_order_id-1; select substring(a.orderId,15)-1 as orderId into second_order_id from ( SELECT @rownum:=@rownum+1 AS rownum, test_order.orderId FROM (SELECT @rownum:=0) r, test_order limit second_limit,1000000 ) a where substring(a.orderId,15)-first_order_id != a.rownum limit 1; set del_ids = concat(first_order_id,&#x27;,&#x27;,second_order_id); -- 此处为了方便测试，所以在存储过程中就打印了结果 select del_ids;END; 1234567891011121314151617CALL `find_delete_order_id`(@del_ids);+---------------+| del_ids |+---------------+| 233490,943220 |+---------------+1 row in set (0.704 sec)Query OK, 2 rows affected (0.704 sec)select @del_ids;+---------------+| @del_ids |+---------------+| 233490,943220 |+---------------+1 row in set (0.000 sec) 表结构1234567DROP TABLE IF EXISTS `test_order`;CREATE TABLE `test_order` ( `id` int(11) NOT NULL AUTO_INCREMENT, `orderId` varchar(30) DEFAULT NULL, PRIMARY KEY (`id`), UNIQUE KEY `index_order_id` (`orderId`) USING HASH) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8; 数据初始化说明： 直接将100w的数据插入数据表有点慢，实测130多秒吧，这里可以先将数据初始化到内存表中，然后再从内存表导入即可，总时间大概只需要12秒左右。 因为数据都是写入内存中，所以写入数据时可能会报内存不足，解决方法如下：a.永久修改，在my.cnf中增加如下配置: tmp_table_size=1G max_heap_table_size=1G b.临时修改,mysql终端执行： set tmp_table_size = 1073741824; set max_heap_table_size = 1073741824; show variables like “%table_size%”; 12345678910111213141516171819-- 创建内存表，重启数据库后，内存表中的数据会被清空，但是表结构依旧存在，不需要时可以drop掉DROP TABLE IF EXISTS `test_order_memory`;CREATE TABLE `test_order_memory` ( `id` int(11) NOT NULL AUTO_INCREMENT, `orderId` varchar(30) DEFAULT NULL, PRIMARY KEY (`id`), UNIQUE KEY `index_order_id` (`orderId`) USING HASH) ENGINE=MEMORY AUTO_INCREMENT=1 DEFAULT CHARSET=utf8;-- 初始化内存表DROP PROCEDURE IF EXISTS add_test_order_memory;CREATE PROCEDURE `add_test_order_memory`(IN n int)BEGIN DECLARE i INT DEFAULT 1; WHILE (i &lt;= n ) DO INSERT INTO test_order_memory (orderId) VALUES (concat(&#x27;aaaaorder2020-&#x27;,LPAD(i, 7, 0))); set i=i+1; END WHILE;END; 1234567891011121314151617181920212223242526-- 创建1000000条数据call add_test_order_memory(1000000);Query OK, 1000000 rows affected (7.354 sec)-- 将内存表中数据导入实际表中INSERT into test_order SELECT * from test_order_memory;Query OK, 1000000 rows affected (5.035 sec)Records: 1000000 Duplicates: 0 Warnings: 0-- 查看结果select * from test_order limit 5;+----+-----------------------+| id | orderId |+----+-----------------------+| 1 | aaaaorder2020-0000001 || 2 | aaaaorder2020-0000002 || 3 | aaaaorder2020-0000003 || 4 | aaaaorder2020-0000004 || 5 | aaaaorder2020-0000005 |+----+-----------------------+5 rows in set (0.000 sec)-- 删除两条数据，这里就随便填两个id号delete from test_order where id in (233490,943220);Query OK, 2 rows affected (0.001 sec)","summary":"摘要 本文内容基于10.4.8-MariaDB Q: 假设一个订单的编号规则是AAAAOrder2020-0000001，AAAAOrder2020-0000002…后面的数字是自增长，如果订单号码达到AAAAOrder2020-1000000(100万)，数据库中应该有100万条数据，此时我随机删除2条数据（物理删除，且不考虑日志和备份），请问怎么找到删掉的数据的编号？给出解题思路即可，答案需要在1秒内运行得到。","date_published":"2020-09-03T10:30:05.000Z","tags":["技术","mysql"]},{"id":"https://blog.hanqunfeng.com/2020/04/18/http-utils/","url":"https://blog.hanqunfeng.com/2020/04/18/http-utils/","title":"HttpClient、OkHttp、RestTemplate、WebClient的基本使用","content_html":"<h2 id=\"摘要\"><a href=\"#摘要\" class=\"headerlink\" title=\"摘要\"></a>摘要</h2><ul>\n<li>本文内容基于org.apache.httpcomponents:httpclient:4.5.12，com.squareup.okhttp3:okhttp:4.5.0，springboot:2.2.6.RELEASE，spring-boot-starter-webflux:2.2.6.RELEASE</li>\n<li>工具类，实现get/post[参数，json，输入流，文件，gzip]等方法</li>\n<li>提供了测试用例及服务端demo</li>\n<li>github：<a href=\"https://github.com/hanqunfeng/springbootchapter/tree/master/chapter26\">https://github.com/hanqunfeng/springbootchapter/tree/master/chapter26</a></li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"HttpClientUtil\"><a href=\"#HttpClientUtil\" class=\"headerlink\" title=\"HttpClientUtil\"></a>HttpClientUtil</h2><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br><span class=\"line\">280</span><br><span class=\"line\">281</span><br><span class=\"line\">282</span><br><span class=\"line\">283</span><br><span class=\"line\">284</span><br><span class=\"line\">285</span><br><span class=\"line\">286</span><br><span class=\"line\">287</span><br><span class=\"line\">288</span><br><span class=\"line\">289</span><br><span class=\"line\">290</span><br><span class=\"line\">291</span><br><span class=\"line\">292</span><br><span class=\"line\">293</span><br><span class=\"line\">294</span><br><span class=\"line\">295</span><br><span class=\"line\">296</span><br><span class=\"line\">297</span><br><span class=\"line\">298</span><br><span class=\"line\">299</span><br><span class=\"line\">300</span><br><span class=\"line\">301</span><br><span class=\"line\">302</span><br><span class=\"line\">303</span><br><span class=\"line\">304</span><br><span class=\"line\">305</span><br><span class=\"line\">306</span><br><span class=\"line\">307</span><br><span class=\"line\">308</span><br><span class=\"line\">309</span><br><span class=\"line\">310</span><br><span class=\"line\">311</span><br><span class=\"line\">312</span><br><span class=\"line\">313</span><br><span class=\"line\">314</span><br><span class=\"line\">315</span><br><span class=\"line\">316</span><br><span class=\"line\">317</span><br><span class=\"line\">318</span><br><span class=\"line\">319</span><br><span class=\"line\">320</span><br><span class=\"line\">321</span><br><span class=\"line\">322</span><br><span class=\"line\">323</span><br><span class=\"line\">324</span><br><span class=\"line\">325</span><br><span class=\"line\">326</span><br><span class=\"line\">327</span><br><span class=\"line\">328</span><br><span class=\"line\">329</span><br><span class=\"line\">330</span><br><span class=\"line\">331</span><br><span class=\"line\">332</span><br><span class=\"line\">333</span><br><span class=\"line\">334</span><br><span class=\"line\">335</span><br><span class=\"line\">336</span><br><span class=\"line\">337</span><br><span class=\"line\">338</span><br><span class=\"line\">339</span><br><span class=\"line\">340</span><br><span class=\"line\">341</span><br><span class=\"line\">342</span><br><span class=\"line\">343</span><br><span class=\"line\">344</span><br><span class=\"line\">345</span><br><span class=\"line\">346</span><br><span class=\"line\">347</span><br><span class=\"line\">348</span><br><span class=\"line\">349</span><br><span class=\"line\">350</span><br><span class=\"line\">351</span><br><span class=\"line\">352</span><br><span class=\"line\">353</span><br><span class=\"line\">354</span><br><span class=\"line\">355</span><br><span class=\"line\">356</span><br><span class=\"line\">357</span><br><span class=\"line\">358</span><br><span class=\"line\">359</span><br><span class=\"line\">360</span><br><span class=\"line\">361</span><br><span class=\"line\">362</span><br><span class=\"line\">363</span><br><span class=\"line\">364</span><br><span class=\"line\">365</span><br><span class=\"line\">366</span><br><span class=\"line\">367</span><br><span class=\"line\">368</span><br><span class=\"line\">369</span><br><span class=\"line\">370</span><br><span class=\"line\">371</span><br><span class=\"line\">372</span><br><span class=\"line\">373</span><br><span class=\"line\">374</span><br><span class=\"line\">375</span><br><span class=\"line\">376</span><br><span class=\"line\">377</span><br><span class=\"line\">378</span><br><span class=\"line\">379</span><br><span class=\"line\">380</span><br><span class=\"line\">381</span><br><span class=\"line\">382</span><br><span class=\"line\">383</span><br><span class=\"line\">384</span><br><span class=\"line\">385</span><br><span class=\"line\">386</span><br><span class=\"line\">387</span><br><span class=\"line\">388</span><br><span class=\"line\">389</span><br><span class=\"line\">390</span><br><span class=\"line\">391</span><br><span class=\"line\">392</span><br><span class=\"line\">393</span><br><span class=\"line\">394</span><br><span class=\"line\">395</span><br><span class=\"line\">396</span><br><span class=\"line\">397</span><br><span class=\"line\">398</span><br><span class=\"line\">399</span><br><span class=\"line\">400</span><br><span class=\"line\">401</span><br><span class=\"line\">402</span><br><span class=\"line\">403</span><br><span class=\"line\">404</span><br><span class=\"line\">405</span><br><span class=\"line\">406</span><br><span class=\"line\">407</span><br><span class=\"line\">408</span><br><span class=\"line\">409</span><br><span class=\"line\">410</span><br><span class=\"line\">411</span><br><span class=\"line\">412</span><br><span class=\"line\">413</span><br><span class=\"line\">414</span><br><span class=\"line\">415</span><br><span class=\"line\">416</span><br><span class=\"line\">417</span><br><span class=\"line\">418</span><br><span class=\"line\">419</span><br><span class=\"line\">420</span><br><span class=\"line\">421</span><br><span class=\"line\">422</span><br><span class=\"line\">423</span><br><span class=\"line\">424</span><br><span class=\"line\">425</span><br><span class=\"line\">426</span><br><span class=\"line\">427</span><br><span class=\"line\">428</span><br><span class=\"line\">429</span><br><span class=\"line\">430</span><br><span class=\"line\">431</span><br><span class=\"line\">432</span><br><span class=\"line\">433</span><br><span class=\"line\">434</span><br><span class=\"line\">435</span><br><span class=\"line\">436</span><br><span class=\"line\">437</span><br><span class=\"line\">438</span><br><span class=\"line\">439</span><br><span class=\"line\">440</span><br><span class=\"line\">441</span><br><span class=\"line\">442</span><br><span class=\"line\">443</span><br><span class=\"line\">444</span><br><span class=\"line\">445</span><br><span class=\"line\">446</span><br><span class=\"line\">447</span><br><span class=\"line\">448</span><br><span class=\"line\">449</span><br><span class=\"line\">450</span><br><span class=\"line\">451</span><br><span class=\"line\">452</span><br><span class=\"line\">453</span><br><span class=\"line\">454</span><br><span class=\"line\">455</span><br><span class=\"line\">456</span><br><span class=\"line\">457</span><br><span class=\"line\">458</span><br><span class=\"line\">459</span><br><span class=\"line\">460</span><br><span class=\"line\">461</span><br><span class=\"line\">462</span><br><span class=\"line\">463</span><br><span class=\"line\">464</span><br><span class=\"line\">465</span><br><span class=\"line\">466</span><br><span class=\"line\">467</span><br><span class=\"line\">468</span><br><span class=\"line\">469</span><br><span class=\"line\">470</span><br><span class=\"line\">471</span><br><span class=\"line\">472</span><br><span class=\"line\">473</span><br><span class=\"line\">474</span><br><span class=\"line\">475</span><br><span class=\"line\">476</span><br><span class=\"line\">477</span><br><span class=\"line\">478</span><br><span class=\"line\">479</span><br><span class=\"line\">480</span><br><span class=\"line\">481</span><br><span class=\"line\">482</span><br><span class=\"line\">483</span><br><span class=\"line\">484</span><br><span class=\"line\">485</span><br><span class=\"line\">486</span><br><span class=\"line\">487</span><br><span class=\"line\">488</span><br><span class=\"line\">489</span><br><span class=\"line\">490</span><br><span class=\"line\">491</span><br><span class=\"line\">492</span><br><span class=\"line\">493</span><br><span class=\"line\">494</span><br><span class=\"line\">495</span><br><span class=\"line\">496</span><br><span class=\"line\">497</span><br><span class=\"line\">498</span><br><span class=\"line\">499</span><br><span class=\"line\">500</span><br><span class=\"line\">501</span><br><span class=\"line\">502</span><br><span class=\"line\">503</span><br><span class=\"line\">504</span><br><span class=\"line\">505</span><br><span class=\"line\">506</span><br><span class=\"line\">507</span><br><span class=\"line\">508</span><br><span class=\"line\">509</span><br><span class=\"line\">510</span><br><span class=\"line\">511</span><br><span class=\"line\">512</span><br><span class=\"line\">513</span><br><span class=\"line\">514</span><br><span class=\"line\">515</span><br><span class=\"line\">516</span><br><span class=\"line\">517</span><br><span class=\"line\">518</span><br><span class=\"line\">519</span><br><span class=\"line\">520</span><br><span class=\"line\">521</span><br><span class=\"line\">522</span><br><span class=\"line\">523</span><br><span class=\"line\">524</span><br><span class=\"line\">525</span><br><span class=\"line\">526</span><br><span class=\"line\">527</span><br><span class=\"line\">528</span><br><span class=\"line\">529</span><br><span class=\"line\">530</span><br><span class=\"line\">531</span><br><span class=\"line\">532</span><br><span class=\"line\">533</span><br><span class=\"line\">534</span><br><span class=\"line\">535</span><br><span class=\"line\">536</span><br><span class=\"line\">537</span><br><span class=\"line\">538</span><br><span class=\"line\">539</span><br><span class=\"line\">540</span><br><span class=\"line\">541</span><br><span class=\"line\">542</span><br><span class=\"line\">543</span><br><span class=\"line\">544</span><br><span class=\"line\">545</span><br><span class=\"line\">546</span><br><span class=\"line\">547</span><br><span class=\"line\">548</span><br><span class=\"line\">549</span><br><span class=\"line\">550</span><br><span class=\"line\">551</span><br><span class=\"line\">552</span><br><span class=\"line\">553</span><br><span class=\"line\">554</span><br><span class=\"line\">555</span><br><span class=\"line\">556</span><br><span class=\"line\">557</span><br><span class=\"line\">558</span><br><span class=\"line\">559</span><br><span class=\"line\">560</span><br><span class=\"line\">561</span><br><span class=\"line\">562</span><br><span class=\"line\">563</span><br><span class=\"line\">564</span><br><span class=\"line\">565</span><br><span class=\"line\">566</span><br><span class=\"line\">567</span><br><span class=\"line\">568</span><br><span class=\"line\">569</span><br><span class=\"line\">570</span><br><span class=\"line\">571</span><br><span class=\"line\">572</span><br><span class=\"line\">573</span><br><span class=\"line\">574</span><br><span class=\"line\">575</span><br><span class=\"line\">576</span><br><span class=\"line\">577</span><br><span class=\"line\">578</span><br><span class=\"line\">579</span><br><span class=\"line\">580</span><br><span class=\"line\">581</span><br><span class=\"line\">582</span><br><span class=\"line\">583</span><br><span class=\"line\">584</span><br><span class=\"line\">585</span><br><span class=\"line\">586</span><br><span class=\"line\">587</span><br><span class=\"line\">588</span><br><span class=\"line\">589</span><br><span class=\"line\">590</span><br><span class=\"line\">591</span><br><span class=\"line\">592</span><br><span class=\"line\">593</span><br><span class=\"line\">594</span><br><span class=\"line\">595</span><br><span class=\"line\">596</span><br><span class=\"line\">597</span><br><span class=\"line\">598</span><br><span class=\"line\">599</span><br><span class=\"line\">600</span><br><span class=\"line\">601</span><br><span class=\"line\">602</span><br><span class=\"line\">603</span><br><span class=\"line\">604</span><br><span class=\"line\">605</span><br><span class=\"line\">606</span><br><span class=\"line\">607</span><br><span class=\"line\">608</span><br><span class=\"line\">609</span><br><span class=\"line\">610</span><br><span class=\"line\">611</span><br><span class=\"line\">612</span><br><span class=\"line\">613</span><br><span class=\"line\">614</span><br><span class=\"line\">615</span><br><span class=\"line\">616</span><br><span class=\"line\">617</span><br><span class=\"line\">618</span><br><span class=\"line\">619</span><br><span class=\"line\">620</span><br><span class=\"line\">621</span><br><span class=\"line\">622</span><br><span class=\"line\">623</span><br><span class=\"line\">624</span><br><span class=\"line\">625</span><br><span class=\"line\">626</span><br><span class=\"line\">627</span><br><span class=\"line\">628</span><br><span class=\"line\">629</span><br><span class=\"line\">630</span><br><span class=\"line\">631</span><br><span class=\"line\">632</span><br><span class=\"line\">633</span><br><span class=\"line\">634</span><br><span class=\"line\">635</span><br><span class=\"line\">636</span><br><span class=\"line\">637</span><br><span class=\"line\">638</span><br><span class=\"line\">639</span><br><span class=\"line\">640</span><br><span class=\"line\">641</span><br><span class=\"line\">642</span><br><span class=\"line\">643</span><br><span class=\"line\">644</span><br><span class=\"line\">645</span><br><span class=\"line\">646</span><br><span class=\"line\">647</span><br><span class=\"line\">648</span><br><span class=\"line\">649</span><br><span class=\"line\">650</span><br><span class=\"line\">651</span><br><span class=\"line\">652</span><br><span class=\"line\">653</span><br><span class=\"line\">654</span><br><span class=\"line\">655</span><br><span class=\"line\">656</span><br><span class=\"line\">657</span><br><span class=\"line\">658</span><br><span class=\"line\">659</span><br><span class=\"line\">660</span><br><span class=\"line\">661</span><br><span class=\"line\">662</span><br><span class=\"line\">663</span><br><span class=\"line\">664</span><br><span class=\"line\">665</span><br><span class=\"line\">666</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> org.example;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> lombok.SneakyThrows;</span><br><span class=\"line\"><span class=\"keyword\">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.http.Header;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.http.HttpEntity;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.http.HttpResponse;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.http.NameValuePair;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.http.client.config.RequestConfig;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.http.client.entity.UrlEncodedFormEntity;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.http.client.methods.CloseableHttpResponse;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.http.client.methods.HttpGet;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.http.client.methods.HttpPost;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.http.client.methods.HttpRequestBase;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.http.client.utils.URIBuilder;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.http.concurrent.FutureCallback;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.http.entity.ByteArrayEntity;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.http.entity.ContentType;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.http.entity.StringEntity;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.http.entity.mime.MultipartEntityBuilder;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.http.impl.client.CloseableHttpClient;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.http.impl.client.DefaultHttpRequestRetryHandler;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.http.impl.client.HttpClientBuilder;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.http.impl.nio.client.CloseableHttpAsyncClient;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.http.impl.nio.client.HttpAsyncClients;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.http.message.BasicNameValuePair;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.http.util.EntityUtils;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.*;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.net.URI;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.net.URLEncoder;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.nio.charset.StandardCharsets;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.ArrayList;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.HashMap;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.List;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Map;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.zip.GZIPInputStream;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.zip.GZIPOutputStream;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * &lt;p&gt;HttpClient工具类&lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> * Created by hanqf on 2020/4/18 14:54.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Slf4j</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">HttpClientUtil</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 配置信息</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> RequestConfig requestConfig = RequestConfig.custom()</span><br><span class=\"line\">            <span class=\"comment\">// 设置连接超时时间(单位毫秒)</span></span><br><span class=\"line\">            .setConnectTimeout(<span class=\"number\">5000</span>)</span><br><span class=\"line\">            <span class=\"comment\">// 设置请求超时时间(单位毫秒)</span></span><br><span class=\"line\">            .setConnectionRequestTimeout(<span class=\"number\">5000</span>)</span><br><span class=\"line\">            <span class=\"comment\">// socket读写超时时间(单位毫秒)</span></span><br><span class=\"line\">            .setSocketTimeout(<span class=\"number\">5000</span>)</span><br><span class=\"line\">            <span class=\"comment\">// 设置是否允许重定向(默认为true)</span></span><br><span class=\"line\">            .setRedirectsEnabled(<span class=\"keyword\">true</span>)</span><br><span class=\"line\">            <span class=\"comment\">//是否启用内容压缩，默认true</span></span><br><span class=\"line\">            .setContentCompressionEnabled(<span class=\"keyword\">true</span>)</span><br><span class=\"line\">            .build();</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 获得Http客户端</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> CloseableHttpClient HTTP_CLIENT = HttpClientBuilder.create()</span><br><span class=\"line\">            .setRetryHandler(<span class=\"keyword\">new</span> DefaultHttpRequestRetryHandler()) <span class=\"comment\">//失败重试，默认3次</span></span><br><span class=\"line\">            .build();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 异步Http客户端</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> CloseableHttpAsyncClient HTTP_ASYNC_CLIENT = HttpAsyncClients.custom()</span><br><span class=\"line\">            .setDefaultRequestConfig(requestConfig)</span><br><span class=\"line\">            .build();</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;p&gt;异步请求&lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> httpRequestBase</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@author</span> hanqf</span></span><br><span class=\"line\"><span class=\"comment\">     * 2020/4/22 21:16</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">executeAsync</span><span class=\"params\">(HttpRequestBase httpRequestBase)</span> </span>&#123;</span><br><span class=\"line\">        HTTP_ASYNC_CLIENT.start();</span><br><span class=\"line\">        HTTP_ASYNC_CLIENT.execute(httpRequestBase, <span class=\"keyword\">new</span> FutureCallback&lt;HttpResponse&gt;() &#123;</span><br><span class=\"line\">            <span class=\"meta\">@SneakyThrows</span></span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">completed</span><span class=\"params\">(HttpResponse httpResponse)</span> </span>&#123;</span><br><span class=\"line\">                log.info(<span class=\"string\">&quot; callback thread id is : &quot;</span> + Thread.currentThread().getId());</span><br><span class=\"line\">                log.info(httpRequestBase.getRequestLine() + <span class=\"string\">&quot;-&gt;&quot;</span> + httpResponse.getStatusLine());</span><br><span class=\"line\"></span><br><span class=\"line\">                StringBuffer stringBuffer = <span class=\"keyword\">new</span> StringBuffer();</span><br><span class=\"line\">                <span class=\"keyword\">for</span> (Header header : httpRequestBase.getAllHeaders()) &#123;</span><br><span class=\"line\">                    stringBuffer.append(header.toString()).append(<span class=\"string\">&quot;,&quot;</span>);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                log.info(String.format(<span class=\"string\">&quot;请求头信息: [%s]&quot;</span>, stringBuffer.toString()));</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">                String responseResult = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">                HttpEntity responseEntity = httpResponse.getEntity();</span><br><span class=\"line\">                log.debug(<span class=\"string\">&quot;响应状态为:&quot;</span> + httpResponse.getStatusLine());</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (responseEntity != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                    responseResult = EntityUtils.toString(responseEntity, StandardCharsets.UTF_8);</span><br><span class=\"line\">                    log.info(<span class=\"string\">&quot;响应内容为:&quot;</span> + responseResult);</span><br><span class=\"line\"></span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                stringBuffer = <span class=\"keyword\">new</span> StringBuffer();</span><br><span class=\"line\">                <span class=\"keyword\">for</span> (Header header : httpResponse.getAllHeaders()) &#123;</span><br><span class=\"line\">                    stringBuffer.append(header.toString()).append(<span class=\"string\">&quot;,&quot;</span>);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                log.info(String.format(<span class=\"string\">&quot;响应头信息: [%s]&quot;</span>, stringBuffer.toString()));</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">failed</span><span class=\"params\">(Exception e)</span> </span>&#123;</span><br><span class=\"line\">                log.info(<span class=\"string\">&quot; callback thread id is : &quot;</span> + Thread.currentThread().getId());</span><br><span class=\"line\">                log.info(<span class=\"string\">&quot;Get responseResult：&quot;</span>, e);</span><br><span class=\"line\">                e.printStackTrace();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">cancelled</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                log.info(httpRequestBase.getRequestLine() + <span class=\"string\">&quot; cancelled&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;p&gt;请求的执行方法，需要提前封装好httpRequestBase对象，如请求url和请求参数&lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> httpRequestBase</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> java.lang.String</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@author</span> hanqf</span></span><br><span class=\"line\"><span class=\"comment\">     * 2020/4/18 22:08</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> String <span class=\"title\">execute</span><span class=\"params\">(HttpRequestBase httpRequestBase)</span> </span>&#123;</span><br><span class=\"line\">        log.info(String.format(<span class=\"string\">&quot;请求地址: [%s]&quot;</span>, httpRequestBase.getURI().toString()));</span><br><span class=\"line\">        log.info(String.format(<span class=\"string\">&quot;请求类型: [%s]&quot;</span>, httpRequestBase.getMethod()));</span><br><span class=\"line\"></span><br><span class=\"line\">        StringBuffer stringBuffer = <span class=\"keyword\">new</span> StringBuffer();</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (Header header : httpRequestBase.getAllHeaders()) &#123;</span><br><span class=\"line\">            stringBuffer.append(header.toString()).append(<span class=\"string\">&quot;,&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        log.info(String.format(<span class=\"string\">&quot;请求头信息: [%s]&quot;</span>, stringBuffer.toString()));</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">        log.info(String.format(<span class=\"string\">&quot;请求参数: [%s]&quot;</span>, httpRequestBase.getURI().getQuery()));</span><br><span class=\"line\"></span><br><span class=\"line\">        String responseResult = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        <span class=\"comment\">// 响应模型</span></span><br><span class=\"line\">        CloseableHttpResponse response = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 将上面的配置信息 运用到这个Get请求里</span></span><br><span class=\"line\">            httpRequestBase.setConfig(requestConfig);</span><br><span class=\"line\">            <span class=\"keyword\">long</span> t1 = System.nanoTime();<span class=\"comment\">//请求发起的时间</span></span><br><span class=\"line\">            response = HTTP_CLIENT.execute(httpRequestBase);</span><br><span class=\"line\">            <span class=\"comment\">// 从响应模型中获取响应实体</span></span><br><span class=\"line\">            HttpEntity responseEntity = response.getEntity();</span><br><span class=\"line\">            log.debug(<span class=\"string\">&quot;响应状态为:&quot;</span> + response.getStatusLine());</span><br><span class=\"line\">            <span class=\"keyword\">long</span> t2 = System.nanoTime();<span class=\"comment\">//收到响应的时间</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (responseEntity != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">                responseResult = EntityUtils.toString(responseEntity, StandardCharsets.UTF_8);</span><br><span class=\"line\"></span><br><span class=\"line\">                log.debug(<span class=\"string\">&quot;响应内容为:&quot;</span> + responseResult);</span><br><span class=\"line\"></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            stringBuffer = <span class=\"keyword\">new</span> StringBuffer();</span><br><span class=\"line\">            <span class=\"keyword\">for</span> (Header header : response.getAllHeaders()) &#123;</span><br><span class=\"line\">                stringBuffer.append(header.toString()).append(<span class=\"string\">&quot;,&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            log.info(String.format(<span class=\"string\">&quot;响应头信息: [%s]&quot;</span>, stringBuffer.toString()));</span><br><span class=\"line\"></span><br><span class=\"line\">            log.info(String.format(<span class=\"string\">&quot;执行时间: [%.1fms]&quot;</span>, (t2 - t1) / <span class=\"number\">1e6d</span>));</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">            log.info(<span class=\"string\">&quot;Get responseResult：&quot;</span>, e);</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (response != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                    response.close();</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</span><br><span class=\"line\">                e.printStackTrace();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> responseResult;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;p&gt;请求的执行方法，需要提前封装好httpRequestBase对象，如请求url和请求参数&lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> httpRequestBase</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> byte[]</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@author</span> hanqf</span></span><br><span class=\"line\"><span class=\"comment\">     * 2020/4/29 13:33</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">byte</span>[] executeBytes(HttpRequestBase httpRequestBase) &#123;</span><br><span class=\"line\">        log.info(String.format(<span class=\"string\">&quot;请求地址: [%s]&quot;</span>, httpRequestBase.getURI().toString()));</span><br><span class=\"line\">        log.info(String.format(<span class=\"string\">&quot;请求类型: [%s]&quot;</span>, httpRequestBase.getMethod()));</span><br><span class=\"line\">        StringBuffer stringBuffer = <span class=\"keyword\">new</span> StringBuffer();</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (Header header : httpRequestBase.getAllHeaders()) &#123;</span><br><span class=\"line\">            stringBuffer.append(header.toString()).append(<span class=\"string\">&quot;,&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        log.info(String.format(<span class=\"string\">&quot;请求头信息: [%s]&quot;</span>, stringBuffer.toString()));</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">        log.info(String.format(<span class=\"string\">&quot;请求参数: [%s]&quot;</span>, httpRequestBase.getURI().getQuery()));</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">byte</span>[] bytes = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        <span class=\"comment\">// 响应模型</span></span><br><span class=\"line\">        CloseableHttpResponse response = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 将上面的配置信息 运用到这个Get请求里</span></span><br><span class=\"line\">            httpRequestBase.setConfig(requestConfig);</span><br><span class=\"line\">            <span class=\"keyword\">long</span> t1 = System.nanoTime();<span class=\"comment\">//请求发起的时间</span></span><br><span class=\"line\">            response = HTTP_CLIENT.execute(httpRequestBase);</span><br><span class=\"line\">            <span class=\"comment\">// 从响应模型中获取响应实体</span></span><br><span class=\"line\">            HttpEntity responseEntity = response.getEntity();</span><br><span class=\"line\">            log.debug(<span class=\"string\">&quot;响应状态为:&quot;</span> + response.getStatusLine());</span><br><span class=\"line\">            <span class=\"keyword\">long</span> t2 = System.nanoTime();<span class=\"comment\">//收到响应的时间</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (responseEntity != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                bytes = EntityUtils.toByteArray(responseEntity);</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"comment\">//判断是否需要解压，即服务器返回是否经过了gzip压缩--start</span></span><br><span class=\"line\">                Header responseHeader = response.getFirstHeader(<span class=\"string\">&quot;Content-Encoding&quot;</span>);</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (responseHeader != <span class=\"keyword\">null</span> &amp;&amp; responseHeader.getValue().contains(<span class=\"string\">&quot;gzip&quot;</span>)) &#123;</span><br><span class=\"line\">                    GZIPInputStream gzipInputStream = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">                    ByteArrayOutputStream out = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">                    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                        gzipInputStream = <span class=\"keyword\">new</span> GZIPInputStream(<span class=\"keyword\">new</span> ByteArrayInputStream(bytes));</span><br><span class=\"line\">                        out = <span class=\"keyword\">new</span> ByteArrayOutputStream();</span><br><span class=\"line\">                        <span class=\"keyword\">byte</span>[] buffer = <span class=\"keyword\">new</span> <span class=\"keyword\">byte</span>[<span class=\"number\">1024</span>];</span><br><span class=\"line\">                        <span class=\"keyword\">int</span> offset = -<span class=\"number\">1</span>;</span><br><span class=\"line\">                        <span class=\"keyword\">while</span> ((offset = gzipInputStream.read(buffer)) != -<span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">                            out.write(buffer, <span class=\"number\">0</span>, offset);</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                        bytes = out.toByteArray();</span><br><span class=\"line\"></span><br><span class=\"line\">                    &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</span><br><span class=\"line\">                        e.printStackTrace();</span><br><span class=\"line\">                    &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">                        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                            gzipInputStream.close();</span><br><span class=\"line\">                            out.close();</span><br><span class=\"line\">                        &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</span><br><span class=\"line\">                            e.printStackTrace();</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                <span class=\"comment\">//判断是否需要解压，即服务器返回是否经过了gzip压缩--end</span></span><br><span class=\"line\"></span><br><span class=\"line\">                log.debug(<span class=\"string\">&quot;响应byte长度:&quot;</span> + bytes.length);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            stringBuffer = <span class=\"keyword\">new</span> StringBuffer();</span><br><span class=\"line\">            <span class=\"keyword\">for</span> (Header header : response.getAllHeaders()) &#123;</span><br><span class=\"line\">                stringBuffer.append(header.toString()).append(<span class=\"string\">&quot;,&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            log.info(String.format(<span class=\"string\">&quot;响应头信息: [%s]&quot;</span>, stringBuffer.toString()));</span><br><span class=\"line\"></span><br><span class=\"line\">            log.info(String.format(<span class=\"string\">&quot;执行时间: [%.1fms]&quot;</span>, (t2 - t1) / <span class=\"number\">1e6d</span>));</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">            log.info(<span class=\"string\">&quot;Get responseResult：&quot;</span>, e);</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (response != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                    response.close();</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</span><br><span class=\"line\">                e.printStackTrace();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> bytes;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;p&gt;get请求&lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> url 请求地址</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> java.lang.String 响应结果</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@author</span> hanqf</span></span><br><span class=\"line\"><span class=\"comment\">     * 2020/4/18 15:57</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> String <span class=\"title\">get</span><span class=\"params\">(String url)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> get(url, <span class=\"keyword\">new</span> HashMap&lt;&gt;());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;p&gt;get请求&lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> url 请求地址</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> java.lang.String 响应结果</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@author</span> hanqf</span></span><br><span class=\"line\"><span class=\"comment\">     * 2020/4/18 15:49</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> String <span class=\"title\">get</span><span class=\"params\">(String url, Map&lt;String, Object&gt; params)</span> </span>&#123;</span><br><span class=\"line\">        HttpGet httpGet = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        List&lt;NameValuePair&gt; list = <span class=\"keyword\">new</span> ArrayList&lt;&gt;();</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (String key : params.keySet()) &#123;</span><br><span class=\"line\">            list.add(<span class=\"keyword\">new</span> BasicNameValuePair(key, params.get(key).toString()));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 由客户端执行(发送)Get请求</span></span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            URI uri = <span class=\"keyword\">new</span> URIBuilder(url).addParameters(list).build();</span><br><span class=\"line\">            <span class=\"comment\">// 创建Get请求</span></span><br><span class=\"line\">            httpGet = <span class=\"keyword\">new</span> HttpGet(uri);</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">            log.info(<span class=\"string\">&quot;Get responseResult：&quot;</span>, e);</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> execute(httpGet);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;p&gt;get请求，返回字节数组&lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> url</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> params</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> byte[]</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@author</span> hanqf</span></span><br><span class=\"line\"><span class=\"comment\">     * 2020/4/29 13:35</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">byte</span>[] getBytes(String url, Map&lt;String, Object&gt; params) &#123;</span><br><span class=\"line\">        HttpGet httpGet = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        List&lt;NameValuePair&gt; list = <span class=\"keyword\">new</span> ArrayList&lt;&gt;();</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (String key : params.keySet()) &#123;</span><br><span class=\"line\">            list.add(<span class=\"keyword\">new</span> BasicNameValuePair(key, params.get(key).toString()));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 由客户端执行(发送)Get请求</span></span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            URI uri = <span class=\"keyword\">new</span> URIBuilder(url).addParameters(list).build();</span><br><span class=\"line\">            <span class=\"comment\">// 创建Get请求</span></span><br><span class=\"line\">            httpGet = <span class=\"keyword\">new</span> HttpGet(uri);</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">            log.info(<span class=\"string\">&quot;Get responseResult：&quot;</span>, e);</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> executeBytes(httpGet);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;p&gt;post请求&lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> url 请求地址</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> java.lang.String 响应结果</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@author</span> hanqf</span></span><br><span class=\"line\"><span class=\"comment\">     * 2020/4/18 15:54</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> String <span class=\"title\">post</span><span class=\"params\">(String url)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> post(url, <span class=\"keyword\">new</span> HashMap&lt;&gt;());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;p&gt;post请求&lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> url    请求地址</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> params 请求参数</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> java.lang.String 响应结果</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@author</span> hanqf</span></span><br><span class=\"line\"><span class=\"comment\">     * 2020/4/18 15:50</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> String <span class=\"title\">post</span><span class=\"params\">(String url, Map&lt;String, Object&gt; params)</span> </span>&#123;</span><br><span class=\"line\">        HttpPost httpPost = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        List&lt;NameValuePair&gt; list = <span class=\"keyword\">new</span> ArrayList&lt;&gt;();</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (String key : params.keySet()) &#123;</span><br><span class=\"line\">            list.add(<span class=\"keyword\">new</span> BasicNameValuePair(key, params.get(key).toString()));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            URI uri = <span class=\"keyword\">new</span> URIBuilder(url).addParameters(list).build();</span><br><span class=\"line\">            httpPost = <span class=\"keyword\">new</span> HttpPost(uri);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">            log.info(<span class=\"string\">&quot;Get responseResult：&quot;</span>, e);</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> execute(httpPost);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;p&gt;post请求，返回字节数组&lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> url</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> params</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> byte[]</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@author</span> hanqf</span></span><br><span class=\"line\"><span class=\"comment\">     * 2020/4/29 13:35</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">byte</span>[] postBytes(String url, Map&lt;String, Object&gt; params) &#123;</span><br><span class=\"line\">        HttpPost httpPost = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        List&lt;NameValuePair&gt; list = <span class=\"keyword\">new</span> ArrayList&lt;&gt;();</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (String key : params.keySet()) &#123;</span><br><span class=\"line\">            list.add(<span class=\"keyword\">new</span> BasicNameValuePair(key, params.get(key).toString()));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            URI uri = <span class=\"keyword\">new</span> URIBuilder(url).addParameters(list).build();</span><br><span class=\"line\">            httpPost = <span class=\"keyword\">new</span> HttpPost(uri);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">            log.info(<span class=\"string\">&quot;Get responseResult：&quot;</span>, e);</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> executeBytes(httpPost);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;p&gt;post请求，请求体为json&lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> url  请求地址</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> json 请求json</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> java.lang.String 响应结果</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@author</span> hanqf</span></span><br><span class=\"line\"><span class=\"comment\">     * 2020/4/18 16:02</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> String <span class=\"title\">postJson</span><span class=\"params\">(String url, String json)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> postJson(url, json, <span class=\"keyword\">false</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;p&gt;post请求，请求体为json&lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> url  请求地址</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> json 请求json</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> gzip 是否开启gzip压缩</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> java.lang.String 响应结果</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@author</span> hanqf</span></span><br><span class=\"line\"><span class=\"comment\">     * 2020/4/18 16:02</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> String <span class=\"title\">postJson</span><span class=\"params\">(String url, String json, <span class=\"keyword\">boolean</span> gzip)</span> </span>&#123;</span><br><span class=\"line\">        HttpPost httpPost = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            URI uri = <span class=\"keyword\">new</span> URIBuilder(url).build();</span><br><span class=\"line\">            httpPost = <span class=\"keyword\">new</span> HttpPost(uri);</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">// post请求是将参数放在请求体里面传过去的,这里将entity放入post请求体中</span></span><br><span class=\"line\"></span><br><span class=\"line\">            httpPost.setHeader(<span class=\"string\">&quot;Content-Type&quot;</span>, <span class=\"string\">&quot;application/json;charset=utf8&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (gzip) &#123;</span><br><span class=\"line\">                httpPost.setHeader(<span class=\"string\">&quot;Content-Encoding&quot;</span>, <span class=\"string\">&quot;gzip&quot;</span>);</span><br><span class=\"line\">                ByteArrayOutputStream originalContent = <span class=\"keyword\">new</span> ByteArrayOutputStream();</span><br><span class=\"line\">                originalContent.write(json.getBytes(StandardCharsets.UTF_8));</span><br><span class=\"line\">                ByteArrayOutputStream baos = <span class=\"keyword\">new</span> ByteArrayOutputStream();</span><br><span class=\"line\">                GZIPOutputStream gzipOut = <span class=\"keyword\">new</span> GZIPOutputStream(baos);</span><br><span class=\"line\">                originalContent.writeTo(gzipOut);</span><br><span class=\"line\">                gzipOut.finish();</span><br><span class=\"line\">                httpPost.setEntity(<span class=\"keyword\">new</span> ByteArrayEntity(baos</span><br><span class=\"line\">                        .toByteArray(), ContentType.create(<span class=\"string\">&quot;text/plain&quot;</span>, <span class=\"string\">&quot;utf-8&quot;</span>)));</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                StringEntity entity = <span class=\"keyword\">new</span> StringEntity(json, <span class=\"string\">&quot;UTF-8&quot;</span>);</span><br><span class=\"line\">                httpPost.setEntity(entity);</span><br><span class=\"line\"></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">            log.info(<span class=\"string\">&quot;Get responseResult：&quot;</span>, e);</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> execute(httpPost);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;p&gt;post请求，请求参数中有中文的话可以使用这个请求&lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> url    请求地址</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> params 请求参数，只可以为中文</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> java.lang.String</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@author</span> hanqf</span></span><br><span class=\"line\"><span class=\"comment\">     * 2020/4/18 16:30</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> String <span class=\"title\">postForm</span><span class=\"params\">(String url, Map&lt;String, Object&gt; params)</span> </span>&#123;</span><br><span class=\"line\">        HttpPost httpPost = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        List&lt;NameValuePair&gt; list = <span class=\"keyword\">new</span> ArrayList&lt;&gt;();</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (String key : params.keySet()) &#123;</span><br><span class=\"line\">            list.add(<span class=\"keyword\">new</span> BasicNameValuePair(key, params.get(key).toString()));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            UrlEncodedFormEntity urlEncodedFormEntity = <span class=\"keyword\">new</span> UrlEncodedFormEntity(list, StandardCharsets.UTF_8);</span><br><span class=\"line\">            URI uri = <span class=\"keyword\">new</span> URIBuilder(url).build();</span><br><span class=\"line\">            httpPost = <span class=\"keyword\">new</span> HttpPost(uri);</span><br><span class=\"line\">            httpPost.setHeader(<span class=\"string\">&quot;Content-Type&quot;</span>, <span class=\"string\">&quot;application/x-www-form-urlencoded&quot;</span>);</span><br><span class=\"line\">            httpPost.setEntity(urlEncodedFormEntity);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">            log.info(<span class=\"string\">&quot;Get responseResult：&quot;</span>, e);</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> execute(httpPost);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;p&gt;post请求，输入流&lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> url   请求地址</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> bytes 请求输入流</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> java.lang.String</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@author</span> hanqf</span></span><br><span class=\"line\"><span class=\"comment\">     * 2020/4/18 16:37</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> String <span class=\"title\">postInputBytes</span><span class=\"params\">(String url, <span class=\"keyword\">byte</span>[] bytes)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> postInputBytes(url, bytes, <span class=\"keyword\">false</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;p&gt;post请求，输入流&lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> url   请求地址</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> bytes 请求输入流</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> gzip  是否开启gzip压缩</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> java.lang.String</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@author</span> hanqf</span></span><br><span class=\"line\"><span class=\"comment\">     * 2020/4/18 16:37</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> String <span class=\"title\">postInputBytes</span><span class=\"params\">(String url, <span class=\"keyword\">byte</span>[] bytes, <span class=\"keyword\">boolean</span> gzip)</span> </span>&#123;</span><br><span class=\"line\">        HttpPost httpPost = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            URI uri = <span class=\"keyword\">new</span> URIBuilder(url).build();</span><br><span class=\"line\">            httpPost = <span class=\"keyword\">new</span> HttpPost(uri);</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">// post请求是将参数放在请求体里面传过去的,这里将entity放入post请求体中</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (gzip) &#123;</span><br><span class=\"line\">                httpPost.setHeader(<span class=\"string\">&quot;Content-Encoding&quot;</span>, <span class=\"string\">&quot;gzip&quot;</span>);</span><br><span class=\"line\">                ByteArrayOutputStream originalContent = <span class=\"keyword\">new</span> ByteArrayOutputStream();</span><br><span class=\"line\">                originalContent.write(bytes);</span><br><span class=\"line\">                ByteArrayOutputStream baos = <span class=\"keyword\">new</span> ByteArrayOutputStream();</span><br><span class=\"line\">                GZIPOutputStream gzipOut = <span class=\"keyword\">new</span> GZIPOutputStream(baos);</span><br><span class=\"line\">                originalContent.writeTo(gzipOut);</span><br><span class=\"line\">                gzipOut.finish();</span><br><span class=\"line\">                httpPost.setEntity(<span class=\"keyword\">new</span> ByteArrayEntity(baos</span><br><span class=\"line\">                        .toByteArray(), ContentType.create(<span class=\"string\">&quot;text/plain&quot;</span>, <span class=\"string\">&quot;utf-8&quot;</span>)));</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                ByteArrayEntity entity = <span class=\"keyword\">new</span> ByteArrayEntity(bytes, ContentType.create(<span class=\"string\">&quot;text/plain&quot;</span>, <span class=\"string\">&quot;utf-8&quot;</span>));</span><br><span class=\"line\">                httpPost.setEntity(entity);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">            log.info(<span class=\"string\">&quot;Get responseResult：&quot;</span>, e);</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> execute(httpPost);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;p&gt;post请求，流&lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> url</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> is</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> java.lang.String</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@author</span> hanqf</span></span><br><span class=\"line\"><span class=\"comment\">     * 2020/4/21 22:24</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> String <span class=\"title\">postInputStream</span><span class=\"params\">(String url, InputStream is)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> postInputStream(url, is, <span class=\"keyword\">false</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;p&gt;post请求，流&lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> url</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> is</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> gzip</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> java.lang.String</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@author</span> hanqf</span></span><br><span class=\"line\"><span class=\"comment\">     * 2020/4/21 22:24</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> String <span class=\"title\">postInputStream</span><span class=\"params\">(String url, InputStream is, <span class=\"keyword\">boolean</span> gzip)</span> </span>&#123;</span><br><span class=\"line\">        ByteArrayOutputStream byteArrayOutputStream = <span class=\"keyword\">new</span> ByteArrayOutputStream();</span><br><span class=\"line\">        <span class=\"keyword\">byte</span>[] buffer = <span class=\"keyword\">new</span> <span class=\"keyword\">byte</span>[<span class=\"number\">1024</span>];</span><br><span class=\"line\">        <span class=\"keyword\">int</span> ch;</span><br><span class=\"line\">        <span class=\"keyword\">byte</span>[] bytes = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">while</span> ((ch = is.read(buffer)) != -<span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">                byteArrayOutputStream.write(buffer, <span class=\"number\">0</span>, ch);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            bytes = byteArrayOutputStream.toByteArray();</span><br><span class=\"line\">            byteArrayOutputStream.close();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> postInputBytes(url, bytes, gzip);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;p&gt;post请求，传输附件&lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> url   请求地址</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> files 文件列表</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> java.lang.String</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@author</span> hanqf</span></span><br><span class=\"line\"><span class=\"comment\">     * 2020/4/18 16:52</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> String <span class=\"title\">postFile</span><span class=\"params\">(String url, File[] files)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> postFile(url, <span class=\"keyword\">new</span> HashMap&lt;&gt;(), files);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;p&gt;post请求，传输附件&lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> url    请求地址</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> params 其它参数</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> files  文件列表</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> java.lang.String</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@author</span> hanqf</span></span><br><span class=\"line\"><span class=\"comment\">     * 2020/4/18 16:50</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> String <span class=\"title\">postFile</span><span class=\"params\">(String url, Map&lt;String, Object&gt; params, File[] files)</span> </span>&#123;</span><br><span class=\"line\">        HttpPost httpPost = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            URI uri = <span class=\"keyword\">new</span> URIBuilder(url).build();</span><br><span class=\"line\">            httpPost = <span class=\"keyword\">new</span> HttpPost(uri);</span><br><span class=\"line\"></span><br><span class=\"line\">            MultipartEntityBuilder multipartEntityBuilder = MultipartEntityBuilder.create();</span><br><span class=\"line\">            String filesKey = <span class=\"string\">&quot;files&quot;</span>;</span><br><span class=\"line\">            <span class=\"keyword\">for</span> (File file : files) &#123;</span><br><span class=\"line\">                <span class=\"comment\">//multipartEntityBuilder.addPart(filesKey,new FileBody(file)); //与下面的语句作用相同</span></span><br><span class=\"line\">                <span class=\"comment\">//multipartEntityBuilder.addBinaryBody(filesKey, file);</span></span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"comment\">// 防止服务端收到的文件名乱码。 我们这里可以先将文件名URLEncode，然后服务端拿到文件名时在URLDecode。就能避免乱码问题。</span></span><br><span class=\"line\">                <span class=\"comment\">// 文件名其实是放在请求头的Content-Disposition里面进行传输的，如其值为form-data; name=&quot;files&quot;; filename=&quot;头像.jpg&quot;</span></span><br><span class=\"line\">                multipartEntityBuilder.addBinaryBody(filesKey, file, ContentType.DEFAULT_BINARY, URLEncoder.encode(file.getName(), <span class=\"string\">&quot;utf-8&quot;</span>));</span><br><span class=\"line\"></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">// 其它参数(注:自定义contentType，设置UTF-8是为了防止服务端拿到的参数出现乱码)</span></span><br><span class=\"line\">            ContentType contentType = ContentType.create(<span class=\"string\">&quot;text/plain&quot;</span>, StandardCharsets.UTF_8);</span><br><span class=\"line\">            <span class=\"keyword\">for</span> (String key : params.keySet()) &#123;</span><br><span class=\"line\">                multipartEntityBuilder.addTextBody(key, params.get(key).toString(), contentType);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            HttpEntity entity = multipartEntityBuilder.build();</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">// post请求是将参数放在请求体里面传过去的,这里将entity放入post请求体中</span></span><br><span class=\"line\">            httpPost.setEntity(entity);</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">            log.info(<span class=\"string\">&quot;Get responseResult：&quot;</span>, e);</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> execute(httpPost);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n<h2 id=\"OkHttpUtil\"><a href=\"#OkHttpUtil\" class=\"headerlink\" title=\"OkHttpUtil\"></a>OkHttpUtil</h2><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br><span class=\"line\">280</span><br><span class=\"line\">281</span><br><span class=\"line\">282</span><br><span class=\"line\">283</span><br><span class=\"line\">284</span><br><span class=\"line\">285</span><br><span class=\"line\">286</span><br><span class=\"line\">287</span><br><span class=\"line\">288</span><br><span class=\"line\">289</span><br><span class=\"line\">290</span><br><span class=\"line\">291</span><br><span class=\"line\">292</span><br><span class=\"line\">293</span><br><span class=\"line\">294</span><br><span class=\"line\">295</span><br><span class=\"line\">296</span><br><span class=\"line\">297</span><br><span class=\"line\">298</span><br><span class=\"line\">299</span><br><span class=\"line\">300</span><br><span class=\"line\">301</span><br><span class=\"line\">302</span><br><span class=\"line\">303</span><br><span class=\"line\">304</span><br><span class=\"line\">305</span><br><span class=\"line\">306</span><br><span class=\"line\">307</span><br><span class=\"line\">308</span><br><span class=\"line\">309</span><br><span class=\"line\">310</span><br><span class=\"line\">311</span><br><span class=\"line\">312</span><br><span class=\"line\">313</span><br><span class=\"line\">314</span><br><span class=\"line\">315</span><br><span class=\"line\">316</span><br><span class=\"line\">317</span><br><span class=\"line\">318</span><br><span class=\"line\">319</span><br><span class=\"line\">320</span><br><span class=\"line\">321</span><br><span class=\"line\">322</span><br><span class=\"line\">323</span><br><span class=\"line\">324</span><br><span class=\"line\">325</span><br><span class=\"line\">326</span><br><span class=\"line\">327</span><br><span class=\"line\">328</span><br><span class=\"line\">329</span><br><span class=\"line\">330</span><br><span class=\"line\">331</span><br><span class=\"line\">332</span><br><span class=\"line\">333</span><br><span class=\"line\">334</span><br><span class=\"line\">335</span><br><span class=\"line\">336</span><br><span class=\"line\">337</span><br><span class=\"line\">338</span><br><span class=\"line\">339</span><br><span class=\"line\">340</span><br><span class=\"line\">341</span><br><span class=\"line\">342</span><br><span class=\"line\">343</span><br><span class=\"line\">344</span><br><span class=\"line\">345</span><br><span class=\"line\">346</span><br><span class=\"line\">347</span><br><span class=\"line\">348</span><br><span class=\"line\">349</span><br><span class=\"line\">350</span><br><span class=\"line\">351</span><br><span class=\"line\">352</span><br><span class=\"line\">353</span><br><span class=\"line\">354</span><br><span class=\"line\">355</span><br><span class=\"line\">356</span><br><span class=\"line\">357</span><br><span class=\"line\">358</span><br><span class=\"line\">359</span><br><span class=\"line\">360</span><br><span class=\"line\">361</span><br><span class=\"line\">362</span><br><span class=\"line\">363</span><br><span class=\"line\">364</span><br><span class=\"line\">365</span><br><span class=\"line\">366</span><br><span class=\"line\">367</span><br><span class=\"line\">368</span><br><span class=\"line\">369</span><br><span class=\"line\">370</span><br><span class=\"line\">371</span><br><span class=\"line\">372</span><br><span class=\"line\">373</span><br><span class=\"line\">374</span><br><span class=\"line\">375</span><br><span class=\"line\">376</span><br><span class=\"line\">377</span><br><span class=\"line\">378</span><br><span class=\"line\">379</span><br><span class=\"line\">380</span><br><span class=\"line\">381</span><br><span class=\"line\">382</span><br><span class=\"line\">383</span><br><span class=\"line\">384</span><br><span class=\"line\">385</span><br><span class=\"line\">386</span><br><span class=\"line\">387</span><br><span class=\"line\">388</span><br><span class=\"line\">389</span><br><span class=\"line\">390</span><br><span class=\"line\">391</span><br><span class=\"line\">392</span><br><span class=\"line\">393</span><br><span class=\"line\">394</span><br><span class=\"line\">395</span><br><span class=\"line\">396</span><br><span class=\"line\">397</span><br><span class=\"line\">398</span><br><span class=\"line\">399</span><br><span class=\"line\">400</span><br><span class=\"line\">401</span><br><span class=\"line\">402</span><br><span class=\"line\">403</span><br><span class=\"line\">404</span><br><span class=\"line\">405</span><br><span class=\"line\">406</span><br><span class=\"line\">407</span><br><span class=\"line\">408</span><br><span class=\"line\">409</span><br><span class=\"line\">410</span><br><span class=\"line\">411</span><br><span class=\"line\">412</span><br><span class=\"line\">413</span><br><span class=\"line\">414</span><br><span class=\"line\">415</span><br><span class=\"line\">416</span><br><span class=\"line\">417</span><br><span class=\"line\">418</span><br><span class=\"line\">419</span><br><span class=\"line\">420</span><br><span class=\"line\">421</span><br><span class=\"line\">422</span><br><span class=\"line\">423</span><br><span class=\"line\">424</span><br><span class=\"line\">425</span><br><span class=\"line\">426</span><br><span class=\"line\">427</span><br><span class=\"line\">428</span><br><span class=\"line\">429</span><br><span class=\"line\">430</span><br><span class=\"line\">431</span><br><span class=\"line\">432</span><br><span class=\"line\">433</span><br><span class=\"line\">434</span><br><span class=\"line\">435</span><br><span class=\"line\">436</span><br><span class=\"line\">437</span><br><span class=\"line\">438</span><br><span class=\"line\">439</span><br><span class=\"line\">440</span><br><span class=\"line\">441</span><br><span class=\"line\">442</span><br><span class=\"line\">443</span><br><span class=\"line\">444</span><br><span class=\"line\">445</span><br><span class=\"line\">446</span><br><span class=\"line\">447</span><br><span class=\"line\">448</span><br><span class=\"line\">449</span><br><span class=\"line\">450</span><br><span class=\"line\">451</span><br><span class=\"line\">452</span><br><span class=\"line\">453</span><br><span class=\"line\">454</span><br><span class=\"line\">455</span><br><span class=\"line\">456</span><br><span class=\"line\">457</span><br><span class=\"line\">458</span><br><span class=\"line\">459</span><br><span class=\"line\">460</span><br><span class=\"line\">461</span><br><span class=\"line\">462</span><br><span class=\"line\">463</span><br><span class=\"line\">464</span><br><span class=\"line\">465</span><br><span class=\"line\">466</span><br><span class=\"line\">467</span><br><span class=\"line\">468</span><br><span class=\"line\">469</span><br><span class=\"line\">470</span><br><span class=\"line\">471</span><br><span class=\"line\">472</span><br><span class=\"line\">473</span><br><span class=\"line\">474</span><br><span class=\"line\">475</span><br><span class=\"line\">476</span><br><span class=\"line\">477</span><br><span class=\"line\">478</span><br><span class=\"line\">479</span><br><span class=\"line\">480</span><br><span class=\"line\">481</span><br><span class=\"line\">482</span><br><span class=\"line\">483</span><br><span class=\"line\">484</span><br><span class=\"line\">485</span><br><span class=\"line\">486</span><br><span class=\"line\">487</span><br><span class=\"line\">488</span><br><span class=\"line\">489</span><br><span class=\"line\">490</span><br><span class=\"line\">491</span><br><span class=\"line\">492</span><br><span class=\"line\">493</span><br><span class=\"line\">494</span><br><span class=\"line\">495</span><br><span class=\"line\">496</span><br><span class=\"line\">497</span><br><span class=\"line\">498</span><br><span class=\"line\">499</span><br><span class=\"line\">500</span><br><span class=\"line\">501</span><br><span class=\"line\">502</span><br><span class=\"line\">503</span><br><span class=\"line\">504</span><br><span class=\"line\">505</span><br><span class=\"line\">506</span><br><span class=\"line\">507</span><br><span class=\"line\">508</span><br><span class=\"line\">509</span><br><span class=\"line\">510</span><br><span class=\"line\">511</span><br><span class=\"line\">512</span><br><span class=\"line\">513</span><br><span class=\"line\">514</span><br><span class=\"line\">515</span><br><span class=\"line\">516</span><br><span class=\"line\">517</span><br><span class=\"line\">518</span><br><span class=\"line\">519</span><br><span class=\"line\">520</span><br><span class=\"line\">521</span><br><span class=\"line\">522</span><br><span class=\"line\">523</span><br><span class=\"line\">524</span><br><span class=\"line\">525</span><br><span class=\"line\">526</span><br><span class=\"line\">527</span><br><span class=\"line\">528</span><br><span class=\"line\">529</span><br><span class=\"line\">530</span><br><span class=\"line\">531</span><br><span class=\"line\">532</span><br><span class=\"line\">533</span><br><span class=\"line\">534</span><br><span class=\"line\">535</span><br><span class=\"line\">536</span><br><span class=\"line\">537</span><br><span class=\"line\">538</span><br><span class=\"line\">539</span><br><span class=\"line\">540</span><br><span class=\"line\">541</span><br><span class=\"line\">542</span><br><span class=\"line\">543</span><br><span class=\"line\">544</span><br><span class=\"line\">545</span><br><span class=\"line\">546</span><br><span class=\"line\">547</span><br><span class=\"line\">548</span><br><span class=\"line\">549</span><br><span class=\"line\">550</span><br><span class=\"line\">551</span><br><span class=\"line\">552</span><br><span class=\"line\">553</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> org.example;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> com.alibaba.fastjson.JSONArray;</span><br><span class=\"line\"><span class=\"keyword\">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class=\"line\"><span class=\"keyword\">import</span> okhttp3.*;</span><br><span class=\"line\"><span class=\"keyword\">import</span> okio.BufferedSink;</span><br><span class=\"line\"><span class=\"keyword\">import</span> okio.GzipSink;</span><br><span class=\"line\"><span class=\"keyword\">import</span> okio.Okio;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.jetbrains.annotations.NotNull;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.*;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.net.URLEncoder;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.HashMap;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Map;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Objects;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.concurrent.TimeUnit;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.zip.GZIPInputStream;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * &lt;p&gt;OkHttp工具类&lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> * Created by hanqf on 2020/4/18 21:54.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Slf4j</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">OkHttpUtil</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 获得OkHttpClient客户端</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> OkHttpClient client = <span class=\"keyword\">new</span> OkHttpClient.Builder()</span><br><span class=\"line\">            .connectTimeout(<span class=\"number\">5L</span>, TimeUnit.SECONDS) <span class=\"comment\">//连接超时时间，5秒</span></span><br><span class=\"line\">            .readTimeout(<span class=\"number\">5L</span>, TimeUnit.SECONDS) <span class=\"comment\">//读超时时间，5秒</span></span><br><span class=\"line\">            .writeTimeout(<span class=\"number\">5L</span>, TimeUnit.SECONDS) <span class=\"comment\">//写超时时间，5秒</span></span><br><span class=\"line\">            .followRedirects(<span class=\"keyword\">true</span>) <span class=\"comment\">//设置是否允许重定向，默认true</span></span><br><span class=\"line\">            <span class=\"comment\">//注意拦截器的顺序</span></span><br><span class=\"line\">            .addInterceptor(<span class=\"keyword\">new</span> GzipRequestInterceptor()) <span class=\"comment\">//开启gzip压缩，支持对流或Json进行gzip压缩，服务端需要支持解压缩</span></span><br><span class=\"line\">            .addInterceptor(<span class=\"keyword\">new</span> RetryIntercepter()) <span class=\"comment\">//重试拦截器，默认3次</span></span><br><span class=\"line\">            .addInterceptor(<span class=\"keyword\">new</span> HeadersLoggingInterceper()) <span class=\"comment\">//header拦截器</span></span><br><span class=\"line\">            .build();</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;p&gt;异步调用&lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@author</span> hanqf</span></span><br><span class=\"line\"><span class=\"comment\">     * 2020/4/22 20:37</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> request</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">executeAsync</span><span class=\"params\">(Request request)</span></span>&#123;</span><br><span class=\"line\">        Call call = client.newCall(request);</span><br><span class=\"line\">        call.enqueue(<span class=\"keyword\">new</span> Callback() &#123;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onFailure</span><span class=\"params\">(<span class=\"meta\">@NotNull</span> Call call, <span class=\"meta\">@NotNull</span> IOException e)</span> </span>&#123;</span><br><span class=\"line\">                log.info(<span class=\"string\">&quot;Get responseResult：&quot;</span>, e);</span><br><span class=\"line\">                e.printStackTrace();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onResponse</span><span class=\"params\">(<span class=\"meta\">@NotNull</span> Call call, <span class=\"meta\">@NotNull</span> Response response)</span> <span class=\"keyword\">throws</span> IOException </span>&#123;</span><br><span class=\"line\">                String responseResult = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (response.isSuccessful()) &#123;</span><br><span class=\"line\">                    responseResult = Objects.requireNonNull(response.body()).string();</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                Headers headers = response.headers();</span><br><span class=\"line\">                StringBuilder stringBuffer = <span class=\"keyword\">new</span> StringBuilder();</span><br><span class=\"line\">                <span class=\"keyword\">for</span>(<span class=\"keyword\">int</span> i=<span class=\"number\">0</span>;i&lt;headers.size();i++)&#123;</span><br><span class=\"line\">                    stringBuffer.append(headers.name(i)).append(<span class=\"string\">&quot;:&quot;</span>).append(headers.value(i)).append(<span class=\"string\">&quot;,&quot;</span>);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                log.info(String.format(<span class=\"string\">&quot;响应头信息: [%s]&quot;</span>, stringBuffer.toString()));</span><br><span class=\"line\">                log.info(String.format(<span class=\"string\">&quot;响应结果：%s&quot;</span>,responseResult));</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;p&gt;请求的执行方法，需要提前封装好Request对象，如请求url和请求参数&lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> request</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> java.lang.String</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@author</span> hanqf</span></span><br><span class=\"line\"><span class=\"comment\">     * 2020/4/18 23:47</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> String <span class=\"title\">execute</span><span class=\"params\">(Request request)</span> </span>&#123;</span><br><span class=\"line\">        String responseResult = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">long</span> t1 = System.nanoTime();<span class=\"comment\">//请求发起的时间</span></span><br><span class=\"line\">            Response response = client.newCall(request).execute();</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (response.isSuccessful()) &#123;</span><br><span class=\"line\">                responseResult = Objects.requireNonNull(response.body()).string();</span><br><span class=\"line\">                <span class=\"comment\">//byte[] bytes = response.body().bytes();</span></span><br><span class=\"line\">                <span class=\"comment\">//responseResult = new String(bytes,&quot;utf-8&quot;);</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">long</span> t2 = System.nanoTime();<span class=\"comment\">//收到响应的时间</span></span><br><span class=\"line\">            Headers headers = response.headers();</span><br><span class=\"line\"></span><br><span class=\"line\">            StringBuilder stringBuffer = <span class=\"keyword\">new</span> StringBuilder();</span><br><span class=\"line\">            <span class=\"keyword\">for</span>(<span class=\"keyword\">int</span> i=<span class=\"number\">0</span>;i&lt;headers.size();i++)&#123;</span><br><span class=\"line\">                stringBuffer.append(headers.name(i)).append(<span class=\"string\">&quot;:&quot;</span>).append(headers.value(i)).append(<span class=\"string\">&quot;,&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            log.info(String.format(<span class=\"string\">&quot;响应头信息: [%s]&quot;</span>, stringBuffer.toString()));</span><br><span class=\"line\"></span><br><span class=\"line\">            log.info(String.format(<span class=\"string\">&quot;执行时间: [%.1fms]&quot;</span>, (t2 - t1) / <span class=\"number\">1e6d</span>));</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</span><br><span class=\"line\">            log.info(<span class=\"string\">&quot;Get responseResult：&quot;</span>, e);</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> responseResult;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">byte</span>[] executeBytes(Request request) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">byte</span>[] bytes = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">long</span> t1 = System.nanoTime();<span class=\"comment\">//请求发起的时间</span></span><br><span class=\"line\">            Response response = client.newCall(request).execute();</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (response.isSuccessful()) &#123;</span><br><span class=\"line\">                bytes = Objects.requireNonNull(response.body()).bytes();</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"comment\">//判断是否需要解压，即服务器返回是否经过了gzip压缩--start</span></span><br><span class=\"line\">                String responseHeader = response.header(<span class=\"string\">&quot;Content-Encoding&quot;</span>);</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (responseHeader != <span class=\"keyword\">null</span> &amp;&amp; responseHeader.contains(<span class=\"string\">&quot;gzip&quot;</span>)) &#123;</span><br><span class=\"line\">                    GZIPInputStream gzipInputStream = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">                    ByteArrayOutputStream out = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">                    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                        gzipInputStream = <span class=\"keyword\">new</span> GZIPInputStream(<span class=\"keyword\">new</span> ByteArrayInputStream(bytes));</span><br><span class=\"line\">                        out = <span class=\"keyword\">new</span> ByteArrayOutputStream();</span><br><span class=\"line\">                        <span class=\"keyword\">byte</span>[] buffer = <span class=\"keyword\">new</span> <span class=\"keyword\">byte</span>[<span class=\"number\">1024</span>];</span><br><span class=\"line\">                        <span class=\"keyword\">int</span> offset = -<span class=\"number\">1</span>;</span><br><span class=\"line\">                        <span class=\"keyword\">while</span> ((offset = gzipInputStream.read(buffer)) != -<span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">                            out.write(buffer, <span class=\"number\">0</span>, offset);</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                        bytes = out.toByteArray();</span><br><span class=\"line\"></span><br><span class=\"line\">                    &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</span><br><span class=\"line\">                        e.printStackTrace();</span><br><span class=\"line\">                    &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">                        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                            gzipInputStream.close();</span><br><span class=\"line\">                            out.close();</span><br><span class=\"line\">                        &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</span><br><span class=\"line\">                            e.printStackTrace();</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                <span class=\"comment\">//判断是否需要解压，即服务器返回是否经过了gzip压缩--end</span></span><br><span class=\"line\"></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">long</span> t2 = System.nanoTime();<span class=\"comment\">//收到响应的时间</span></span><br><span class=\"line\">            Headers headers = response.headers();</span><br><span class=\"line\">            StringBuilder stringBuffer = <span class=\"keyword\">new</span> StringBuilder();</span><br><span class=\"line\">            <span class=\"keyword\">for</span>(<span class=\"keyword\">int</span> i=<span class=\"number\">0</span>;i&lt;headers.size();i++)&#123;</span><br><span class=\"line\">                stringBuffer.append(headers.name(i)).append(<span class=\"string\">&quot;:&quot;</span>).append(headers.value(i)).append(<span class=\"string\">&quot;,&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            log.info(String.format(<span class=\"string\">&quot;响应头信息: [%s]&quot;</span>, stringBuffer.toString()));</span><br><span class=\"line\"></span><br><span class=\"line\">            log.info(String.format(<span class=\"string\">&quot;执行时间: [%.1fms]&quot;</span>, (t2 - t1) / <span class=\"number\">1e6d</span>));</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</span><br><span class=\"line\">            log.info(<span class=\"string\">&quot;Get responseResult：&quot;</span>, e);</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> bytes;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;p&gt;get请求&lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> url 请求url</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> java.lang.String</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@author</span> hanqf</span></span><br><span class=\"line\"><span class=\"comment\">     * 2020/4/18 23:48</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> String <span class=\"title\">get</span><span class=\"params\">(String url)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> get(url, <span class=\"keyword\">new</span> HashMap&lt;&gt;());</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;p&gt;get请求&lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> url</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> params</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> java.lang.String</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@author</span> hanqf</span></span><br><span class=\"line\"><span class=\"comment\">     * 2020/4/20 16:40</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> String <span class=\"title\">get</span><span class=\"params\">(String url, Map&lt;String, Object&gt; params)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (params.size() &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            StringBuilder stringBuffer = <span class=\"keyword\">new</span> StringBuilder();</span><br><span class=\"line\">            stringBuffer.append(url);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (url.contains(<span class=\"string\">&quot;?&quot;</span>)) &#123;</span><br><span class=\"line\">                stringBuffer.append(<span class=\"string\">&quot;&amp;&quot;</span>);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                stringBuffer.append(<span class=\"string\">&quot;?&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">for</span> (String key : params.keySet()) &#123;</span><br><span class=\"line\">                stringBuffer.append(key).append(<span class=\"string\">&quot;=&quot;</span>).append(params.get(key).toString()).append(<span class=\"string\">&quot;&amp;&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            url = stringBuffer.toString();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        Request request = <span class=\"keyword\">new</span> Request.Builder()</span><br><span class=\"line\">                .url(url)</span><br><span class=\"line\">                .get()</span><br><span class=\"line\">                .build();</span><br><span class=\"line\">        log.info(String.format(<span class=\"string\">&quot;请求地址: [%s]&quot;</span>, request.url()));</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (params.size() &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            JSONArray jArray = <span class=\"keyword\">new</span> JSONArray();</span><br><span class=\"line\">            jArray.add(params);</span><br><span class=\"line\">            log.info(String.format(<span class=\"string\">&quot;请求参数: %s&quot;</span>, jArray.toJSONString()));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//executeAsync(request);</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> execute(request);</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">byte</span>[] getBytes(String url, Map&lt;String, Object&gt; params) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (params.size() &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            StringBuilder stringBuffer = <span class=\"keyword\">new</span> StringBuilder();</span><br><span class=\"line\">            stringBuffer.append(url);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (url.contains(<span class=\"string\">&quot;?&quot;</span>)) &#123;</span><br><span class=\"line\">                stringBuffer.append(<span class=\"string\">&quot;&amp;&quot;</span>);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                stringBuffer.append(<span class=\"string\">&quot;?&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">for</span> (String key : params.keySet()) &#123;</span><br><span class=\"line\">                stringBuffer.append(key).append(<span class=\"string\">&quot;=&quot;</span>).append(params.get(key).toString()).append(<span class=\"string\">&quot;&amp;&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            url = stringBuffer.toString();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        Request request = <span class=\"keyword\">new</span> Request.Builder()</span><br><span class=\"line\">                .url(url)</span><br><span class=\"line\">                .get()</span><br><span class=\"line\">                .build();</span><br><span class=\"line\">        log.info(String.format(<span class=\"string\">&quot;请求地址: [%s]&quot;</span>, request.url()));</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (params.size() &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            JSONArray jArray = <span class=\"keyword\">new</span> JSONArray();</span><br><span class=\"line\">            jArray.add(params);</span><br><span class=\"line\">            log.info(String.format(<span class=\"string\">&quot;请求参数: %s&quot;</span>, jArray.toJSONString()));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> executeBytes(request);</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;p&gt;post请求&lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> url 请求url</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> java.lang.String</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@author</span> hanqf</span></span><br><span class=\"line\"><span class=\"comment\">     * 2020/4/18 23:48</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> String <span class=\"title\">post</span><span class=\"params\">(String url)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> post(url, <span class=\"keyword\">new</span> HashMap&lt;&gt;());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;p&gt;post请求&lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     * form请求</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> url    请求url</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> params 请求参数</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> java.lang.String</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@author</span> hanqf</span></span><br><span class=\"line\"><span class=\"comment\">     * 2020/4/18 23:49</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> String <span class=\"title\">post</span><span class=\"params\">(String url, Map&lt;String, Object&gt; params)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">//请求头会加入：application/x-www-form-urlencoded</span></span><br><span class=\"line\">        FormBody.Builder builder = <span class=\"keyword\">new</span> FormBody.Builder();</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (String key : params.keySet()) &#123;</span><br><span class=\"line\">            builder.add(key, params.get(key).toString());</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        RequestBody requestBody = builder.build();</span><br><span class=\"line\">        Request request = <span class=\"keyword\">new</span> Request.Builder()</span><br><span class=\"line\">                .url(url)</span><br><span class=\"line\">                .post(requestBody)</span><br><span class=\"line\">                .build();</span><br><span class=\"line\"></span><br><span class=\"line\">        log.info(String.format(<span class=\"string\">&quot;请求地址: [%s]&quot;</span>, request.url()));</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (params.size() &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            JSONArray jArray = <span class=\"keyword\">new</span> JSONArray();</span><br><span class=\"line\">            jArray.add(params);</span><br><span class=\"line\">            log.info(String.format(<span class=\"string\">&quot;请求参数: %s&quot;</span>, jArray.toJSONString()));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        log.info(String.format(<span class=\"string\">&quot;请求类型: %s&quot;</span>, Objects.requireNonNull(Objects.requireNonNull(request.body()).contentType()).toString()));</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> execute(request);</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">byte</span>[] postBytes(String url, Map&lt;String, Object&gt; params) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//请求头会加入：application/x-www-form-urlencoded</span></span><br><span class=\"line\">        FormBody.Builder builder = <span class=\"keyword\">new</span> FormBody.Builder();</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (String key : params.keySet()) &#123;</span><br><span class=\"line\">            builder.add(key, params.get(key).toString());</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        RequestBody requestBody = builder.build();</span><br><span class=\"line\">        Request request = <span class=\"keyword\">new</span> Request.Builder()</span><br><span class=\"line\">                .url(url)</span><br><span class=\"line\">                .post(requestBody)</span><br><span class=\"line\">                .build();</span><br><span class=\"line\"></span><br><span class=\"line\">        log.info(String.format(<span class=\"string\">&quot;请求地址: [%s]&quot;</span>, request.url()));</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (params.size() &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            JSONArray jArray = <span class=\"keyword\">new</span> JSONArray();</span><br><span class=\"line\">            jArray.add(params);</span><br><span class=\"line\">            log.info(String.format(<span class=\"string\">&quot;请求参数: %s&quot;</span>, jArray.toJSONString()));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        log.info(String.format(<span class=\"string\">&quot;请求类型: %s&quot;</span>, Objects.requireNonNull(Objects.requireNonNull(request.body()).contentType()).toString()));</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> executeBytes(request);</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;p&gt;post请求，json请求&lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> url  请求url</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> json json数据</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> java.lang.String</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@author</span> hanqf</span></span><br><span class=\"line\"><span class=\"comment\">     * 2020/4/18 23:50</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> String <span class=\"title\">post</span><span class=\"params\">(String url, String json)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        MediaType mediaType = MediaType.parse(<span class=\"string\">&quot;application/json; charset=utf8&quot;</span>);</span><br><span class=\"line\">        RequestBody requestBody = RequestBody.create(json, mediaType);</span><br><span class=\"line\">        Request request = <span class=\"keyword\">new</span> Request.Builder()</span><br><span class=\"line\">                .url(url)</span><br><span class=\"line\">                .post(requestBody)</span><br><span class=\"line\">                .build();</span><br><span class=\"line\">        log.info(String.format(<span class=\"string\">&quot;请求地址: [%s]&quot;</span>, request.url()));</span><br><span class=\"line\">        log.info(String.format(<span class=\"string\">&quot;请求参数: %s&quot;</span>, json));</span><br><span class=\"line\">        log.info(String.format(<span class=\"string\">&quot;请求类型: %s&quot;</span>, Objects.requireNonNull(Objects.requireNonNull(request.body()).contentType()).toString()));</span><br><span class=\"line\">        <span class=\"keyword\">return</span> execute(request);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;p&gt;post请求，字节流&lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> url   请求url</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> bytes 字节数组</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> java.lang.String</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@author</span> hanqf</span></span><br><span class=\"line\"><span class=\"comment\">     * 2020/4/18 23:51</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> String <span class=\"title\">post</span><span class=\"params\">(String url, <span class=\"keyword\">byte</span>[] bytes)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        MediaType mediaType = MediaType.parse(<span class=\"string\">&quot;application/octet-stream&quot;</span>);</span><br><span class=\"line\">        RequestBody requestBody = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        requestBody = RequestBody.create(bytes, mediaType);</span><br><span class=\"line\"></span><br><span class=\"line\">        Request request = <span class=\"keyword\">new</span> Request.Builder()</span><br><span class=\"line\">                .url(url)</span><br><span class=\"line\">                .post(requestBody)</span><br><span class=\"line\">                .build();</span><br><span class=\"line\">        log.info(String.format(<span class=\"string\">&quot;请求地址: [%s]&quot;</span>, request.url()));</span><br><span class=\"line\">        log.info(String.format(<span class=\"string\">&quot;请求类型: %s&quot;</span>, Objects.requireNonNull(Objects.requireNonNull(request.body()).contentType()).toString()));</span><br><span class=\"line\">        <span class=\"keyword\">return</span> execute(request);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;p&gt;post请求，字节流&lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> url</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> is</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> java.lang.String</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@author</span> hanqf</span></span><br><span class=\"line\"><span class=\"comment\">     * 2020/4/21 22:45</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> String <span class=\"title\">post</span><span class=\"params\">(String url, InputStream is)</span> </span>&#123;</span><br><span class=\"line\">        ByteArrayOutputStream byteArrayOutputStream = <span class=\"keyword\">new</span> ByteArrayOutputStream();</span><br><span class=\"line\">        <span class=\"keyword\">byte</span>[] buffer = <span class=\"keyword\">new</span> <span class=\"keyword\">byte</span>[<span class=\"number\">1024</span>];</span><br><span class=\"line\">        <span class=\"keyword\">int</span> ch;</span><br><span class=\"line\">        <span class=\"keyword\">byte</span>[] bytes = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">while</span> ((ch = is.read(buffer)) != -<span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">                byteArrayOutputStream.write(buffer, <span class=\"number\">0</span>, ch);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            bytes = byteArrayOutputStream.toByteArray();</span><br><span class=\"line\">            byteArrayOutputStream.close();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> post(url, bytes);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;p&gt;post请求，文件传输&lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> url   请求url</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> files 文件列表</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> java.lang.String</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@author</span> hanqf</span></span><br><span class=\"line\"><span class=\"comment\">     * 2020/4/18 23:52</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> String <span class=\"title\">post</span><span class=\"params\">(String url, File[] files)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> post(url, <span class=\"keyword\">new</span> HashMap&lt;&gt;(), files);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;p&gt;post请求，文件传输&lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> url    请求url</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> params 参数map</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> files  文件列表</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> java.lang.String</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@author</span> hanqf</span></span><br><span class=\"line\"><span class=\"comment\">     * 2020/4/18 23:52</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> String <span class=\"title\">post</span><span class=\"params\">(String url, Map&lt;String, Object&gt; params, File[] files)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        MultipartBody.Builder builder = <span class=\"keyword\">new</span> MultipartBody.Builder()</span><br><span class=\"line\">                .setType(MultipartBody.FORM);</span><br><span class=\"line\">        <span class=\"keyword\">int</span> i = <span class=\"number\">1</span>;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            String filesKey = <span class=\"string\">&quot;files&quot;</span>;</span><br><span class=\"line\">            <span class=\"keyword\">for</span> (File file : files) &#123;</span><br><span class=\"line\">                <span class=\"comment\">//URLEncoder.encode(file.getName(), &quot;utf-8&quot;) //中文文件名使用encode，服务端使用decode解析</span></span><br><span class=\"line\">                builder.addFormDataPart(filesKey, URLEncoder.encode(file.getName(), <span class=\"string\">&quot;utf-8&quot;</span>),</span><br><span class=\"line\">                        RequestBody.create(file, MediaType.parse(<span class=\"string\">&quot;multipart/form-data&quot;</span>)));</span><br><span class=\"line\">                i++;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">for</span> (String key : params.keySet()) &#123;</span><br><span class=\"line\">                builder.addFormDataPart(key, params.get(key).toString());</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        RequestBody requestBody = builder.build();</span><br><span class=\"line\">        Request request = <span class=\"keyword\">new</span> Request.Builder()</span><br><span class=\"line\">                .url(url)</span><br><span class=\"line\">                .post(requestBody)</span><br><span class=\"line\">                .build();</span><br><span class=\"line\"></span><br><span class=\"line\">        log.info(String.format(<span class=\"string\">&quot;请求地址: [%s]&quot;</span>, request.url()));</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (params != <span class=\"keyword\">null</span> &amp;&amp; params.size() &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            JSONArray jArray = <span class=\"keyword\">new</span> JSONArray();</span><br><span class=\"line\">            jArray.add(params);</span><br><span class=\"line\">            log.info(String.format(<span class=\"string\">&quot;请求参数: %s&quot;</span>, jArray.toJSONString()));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (files != <span class=\"keyword\">null</span> &amp;&amp; files.length &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            JSONArray jArray = <span class=\"keyword\">new</span> JSONArray();</span><br><span class=\"line\">            jArray.add(files);</span><br><span class=\"line\">            log.info(String.format(<span class=\"string\">&quot;请求参数: %s&quot;</span>, jArray.toJSONString()));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        log.info(String.format(<span class=\"string\">&quot;请求类型: %s&quot;</span>, Objects.requireNonNull(Objects.requireNonNull(request.body()).contentType()).toString()));</span><br><span class=\"line\">        <span class=\"keyword\">return</span> execute(request);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * This interceptor compresses the HTTP request body. Many webservers can&#x27;t handle this!</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">GzipRequestInterceptor</span> <span class=\"keyword\">implements</span> <span class=\"title\">Interceptor</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"meta\">@NotNull</span></span><br><span class=\"line\">        <span class=\"meta\">@Override</span></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> Response <span class=\"title\">intercept</span><span class=\"params\">(Chain chain)</span> <span class=\"keyword\">throws</span> IOException </span>&#123;</span><br><span class=\"line\">            Request originalRequest = chain.request();</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (originalRequest.body() == <span class=\"keyword\">null</span> || originalRequest.header(<span class=\"string\">&quot;Content-Encoding&quot;</span>) != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> chain.proceed(originalRequest);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            MediaType mediaType = Objects.requireNonNull(originalRequest.body()).contentType();</span><br><span class=\"line\">            <span class=\"comment\">//对流和json开启压缩</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (mediaType != <span class=\"keyword\">null</span> &amp;&amp; (<span class=\"string\">&quot;application/octet-stream&quot;</span>.equals(mediaType.toString()) || <span class=\"string\">&quot;application/json; charset=utf8&quot;</span>.equals(mediaType.toString()))) &#123;</span><br><span class=\"line\">                Request compressedRequest = originalRequest.newBuilder()</span><br><span class=\"line\">                        .header(<span class=\"string\">&quot;Content-Encoding&quot;</span>, <span class=\"string\">&quot;gzip&quot;</span>)</span><br><span class=\"line\">                        .method(originalRequest.method(), gzip(originalRequest.body()))</span><br><span class=\"line\">                        .build();</span><br><span class=\"line\">                <span class=\"keyword\">return</span> chain.proceed(compressedRequest);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> chain.proceed(originalRequest);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">private</span> RequestBody <span class=\"title\">gzip</span><span class=\"params\">(<span class=\"keyword\">final</span> RequestBody body)</span> </span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> RequestBody() &#123;</span><br><span class=\"line\">                <span class=\"meta\">@Override</span></span><br><span class=\"line\">                <span class=\"function\"><span class=\"keyword\">public</span> MediaType <span class=\"title\">contentType</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                    <span class=\"keyword\">return</span> body.contentType();</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"meta\">@Override</span></span><br><span class=\"line\">                <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">long</span> <span class=\"title\">contentLength</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                    <span class=\"keyword\">return</span> -<span class=\"number\">1</span>; <span class=\"comment\">// We don&#x27;t know the compressed length in advance!</span></span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"meta\">@Override</span></span><br><span class=\"line\">                <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">writeTo</span><span class=\"params\">(<span class=\"meta\">@NotNull</span> BufferedSink sink)</span> <span class=\"keyword\">throws</span> IOException </span>&#123;</span><br><span class=\"line\">                    BufferedSink gzipSink = Okio.buffer(<span class=\"keyword\">new</span> GzipSink(sink));</span><br><span class=\"line\">                    body.writeTo(gzipSink);</span><br><span class=\"line\">                    gzipSink.close();</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;p&gt;重试拦截器&lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">RetryIntercepter</span> <span class=\"keyword\">implements</span> <span class=\"title\">Interceptor</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> maxRetry = <span class=\"number\">3</span>;<span class=\"comment\">//最大重试次数，默认3次</span></span><br><span class=\"line\">        <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> retryNum = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">RetryIntercepter</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">RetryIntercepter</span><span class=\"params\">(<span class=\"keyword\">int</span> maxRetry)</span> </span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.maxRetry = maxRetry;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"meta\">@NotNull</span></span><br><span class=\"line\">        <span class=\"meta\">@Override</span></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> Response <span class=\"title\">intercept</span><span class=\"params\">(Chain chain)</span> <span class=\"keyword\">throws</span> IOException </span>&#123;</span><br><span class=\"line\">            Request request = chain.request();</span><br><span class=\"line\">            Response response = chain.proceed(request);</span><br><span class=\"line\">            <span class=\"keyword\">while</span> (!response.isSuccessful() &amp;&amp; retryNum &lt; maxRetry) &#123;</span><br><span class=\"line\">                retryNum++;</span><br><span class=\"line\">                response = chain.proceed(request);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> response;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;p&gt;Headers拦截器&lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">HeadersLoggingInterceper</span> <span class=\"keyword\">implements</span> <span class=\"title\">Interceptor</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"meta\">@NotNull</span></span><br><span class=\"line\">        <span class=\"meta\">@Override</span></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> Response <span class=\"title\">intercept</span><span class=\"params\">(<span class=\"meta\">@NotNull</span> Chain chain)</span> <span class=\"keyword\">throws</span> IOException </span>&#123;</span><br><span class=\"line\">            Request request = chain.request();</span><br><span class=\"line\">            Headers headers = request.headers();</span><br><span class=\"line\">            StringBuilder stringBuffer = <span class=\"keyword\">new</span> StringBuilder();</span><br><span class=\"line\">            <span class=\"keyword\">for</span>(<span class=\"keyword\">int</span> i=<span class=\"number\">0</span>;i&lt;headers.size();i++)&#123;</span><br><span class=\"line\">                stringBuffer.append(headers.name(i)).append(<span class=\"string\">&quot;:&quot;</span>).append(headers.value(i)).append(<span class=\"string\">&quot;,&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            log.info(String.format(<span class=\"string\">&quot;请求头信息: [%s]&quot;</span>, stringBuffer.toString()));</span><br><span class=\"line\">            <span class=\"keyword\">return</span> chain.proceed(request);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"RestTemplateUtil\"><a href=\"#RestTemplateUtil\" class=\"headerlink\" title=\"RestTemplateUtil\"></a>RestTemplateUtil</h2><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br><span class=\"line\">280</span><br><span class=\"line\">281</span><br><span class=\"line\">282</span><br><span class=\"line\">283</span><br><span class=\"line\">284</span><br><span class=\"line\">285</span><br><span class=\"line\">286</span><br><span class=\"line\">287</span><br><span class=\"line\">288</span><br><span class=\"line\">289</span><br><span class=\"line\">290</span><br><span class=\"line\">291</span><br><span class=\"line\">292</span><br><span class=\"line\">293</span><br><span class=\"line\">294</span><br><span class=\"line\">295</span><br><span class=\"line\">296</span><br><span class=\"line\">297</span><br><span class=\"line\">298</span><br><span class=\"line\">299</span><br><span class=\"line\">300</span><br><span class=\"line\">301</span><br><span class=\"line\">302</span><br><span class=\"line\">303</span><br><span class=\"line\">304</span><br><span class=\"line\">305</span><br><span class=\"line\">306</span><br><span class=\"line\">307</span><br><span class=\"line\">308</span><br><span class=\"line\">309</span><br><span class=\"line\">310</span><br><span class=\"line\">311</span><br><span class=\"line\">312</span><br><span class=\"line\">313</span><br><span class=\"line\">314</span><br><span class=\"line\">315</span><br><span class=\"line\">316</span><br><span class=\"line\">317</span><br><span class=\"line\">318</span><br><span class=\"line\">319</span><br><span class=\"line\">320</span><br><span class=\"line\">321</span><br><span class=\"line\">322</span><br><span class=\"line\">323</span><br><span class=\"line\">324</span><br><span class=\"line\">325</span><br><span class=\"line\">326</span><br><span class=\"line\">327</span><br><span class=\"line\">328</span><br><span class=\"line\">329</span><br><span class=\"line\">330</span><br><span class=\"line\">331</span><br><span class=\"line\">332</span><br><span class=\"line\">333</span><br><span class=\"line\">334</span><br><span class=\"line\">335</span><br><span class=\"line\">336</span><br><span class=\"line\">337</span><br><span class=\"line\">338</span><br><span class=\"line\">339</span><br><span class=\"line\">340</span><br><span class=\"line\">341</span><br><span class=\"line\">342</span><br><span class=\"line\">343</span><br><span class=\"line\">344</span><br><span class=\"line\">345</span><br><span class=\"line\">346</span><br><span class=\"line\">347</span><br><span class=\"line\">348</span><br><span class=\"line\">349</span><br><span class=\"line\">350</span><br><span class=\"line\">351</span><br><span class=\"line\">352</span><br><span class=\"line\">353</span><br><span class=\"line\">354</span><br><span class=\"line\">355</span><br><span class=\"line\">356</span><br><span class=\"line\">357</span><br><span class=\"line\">358</span><br><span class=\"line\">359</span><br><span class=\"line\">360</span><br><span class=\"line\">361</span><br><span class=\"line\">362</span><br><span class=\"line\">363</span><br><span class=\"line\">364</span><br><span class=\"line\">365</span><br><span class=\"line\">366</span><br><span class=\"line\">367</span><br><span class=\"line\">368</span><br><span class=\"line\">369</span><br><span class=\"line\">370</span><br><span class=\"line\">371</span><br><span class=\"line\">372</span><br><span class=\"line\">373</span><br><span class=\"line\">374</span><br><span class=\"line\">375</span><br><span class=\"line\">376</span><br><span class=\"line\">377</span><br><span class=\"line\">378</span><br><span class=\"line\">379</span><br><span class=\"line\">380</span><br><span class=\"line\">381</span><br><span class=\"line\">382</span><br><span class=\"line\">383</span><br><span class=\"line\">384</span><br><span class=\"line\">385</span><br><span class=\"line\">386</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> org.example;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.core.io.FileSystemResource;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.http.*;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.http.client.ClientHttpRequestExecution;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.http.client.ClientHttpRequestInterceptor;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.http.client.ClientHttpResponse;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.http.client.SimpleClientHttpRequestFactory;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.util.LinkedMultiValueMap;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.util.MultiValueMap;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.client.RestTemplate;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.*;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.nio.charset.StandardCharsets;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.ArrayList;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.HashMap;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.List;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Map;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.zip.GZIPInputStream;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.zip.GZIPOutputStream;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * &lt;p&gt;RestTemplate工具类&lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> * Created by hanqf on 2020/4/22 16:54.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Slf4j</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">RestTemplateUtil</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> SimpleClientHttpRequestFactory factory = <span class=\"keyword\">new</span> SimpleClientHttpRequestFactory();</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> RestTemplate restTemplate;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">static</span> &#123;</span><br><span class=\"line\">        factory.setReadTimeout(<span class=\"number\">5000</span>);<span class=\"comment\">//单位为ms</span></span><br><span class=\"line\">        factory.setConnectTimeout(<span class=\"number\">5000</span>);<span class=\"comment\">//单位为ms</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//拦截器</span></span><br><span class=\"line\">        List&lt;ClientHttpRequestInterceptor&gt; list = <span class=\"keyword\">new</span> ArrayList&lt;&gt;();</span><br><span class=\"line\">        list.add(<span class=\"keyword\">new</span> RetryIntercepter()); <span class=\"comment\">//重试拦截器</span></span><br><span class=\"line\">        list.add(<span class=\"keyword\">new</span> HeadersLoggingInterceper()); <span class=\"comment\">//header拦截器</span></span><br><span class=\"line\"></span><br><span class=\"line\">        restTemplate = <span class=\"keyword\">new</span> RestTemplate(factory);</span><br><span class=\"line\">        restTemplate.setInterceptors(list);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> String <span class=\"title\">get</span><span class=\"params\">(String url)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> get(url, <span class=\"keyword\">new</span> HashMap&lt;&gt;());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;p&gt;get请求&lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> url</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> map</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> java.lang.String</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@author</span> hanqf</span></span><br><span class=\"line\"><span class=\"comment\">     * 2020/4/22 16:57</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> String <span class=\"title\">get</span><span class=\"params\">(String url, Map&lt;String, Object&gt; map)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (map.size() &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            StringBuilder stringBuffer = <span class=\"keyword\">new</span> StringBuilder();</span><br><span class=\"line\">            stringBuffer.append(url);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (url.contains(<span class=\"string\">&quot;?&quot;</span>)) &#123;</span><br><span class=\"line\">                stringBuffer.append(<span class=\"string\">&quot;&amp;&quot;</span>);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                stringBuffer.append(<span class=\"string\">&quot;?&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">for</span> (String key : map.keySet()) &#123;</span><br><span class=\"line\">                stringBuffer.append(key).append(<span class=\"string\">&quot;=&quot;</span>).append(map.get(key).toString()).append(<span class=\"string\">&quot;&amp;&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            url = stringBuffer.toString();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> restTemplate.getForObject(url, String.class);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">byte</span>[] getBytes(String url, Map&lt;String, Object&gt; map) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (map.size() &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            StringBuilder stringBuffer = <span class=\"keyword\">new</span> StringBuilder();</span><br><span class=\"line\">            stringBuffer.append(url);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (url.contains(<span class=\"string\">&quot;?&quot;</span>)) &#123;</span><br><span class=\"line\">                stringBuffer.append(<span class=\"string\">&quot;&amp;&quot;</span>);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                stringBuffer.append(<span class=\"string\">&quot;?&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">for</span> (String key : map.keySet()) &#123;</span><br><span class=\"line\">                stringBuffer.append(key).append(<span class=\"string\">&quot;=&quot;</span>).append(map.get(key).toString()).append(<span class=\"string\">&quot;&amp;&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            url = stringBuffer.toString();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">//return restTemplate.getForObject(url, byte[].class);</span></span><br><span class=\"line\">        ResponseEntity&lt;<span class=\"keyword\">byte</span>[]&gt; exchange = restTemplate.exchange(url, HttpMethod.GET, <span class=\"keyword\">null</span>, <span class=\"keyword\">byte</span>[].class);</span><br><span class=\"line\">        <span class=\"keyword\">byte</span>[] bytes = exchange.getBody();</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//判断是否需要解压，即服务器返回是否经过了gzip压缩--start</span></span><br><span class=\"line\">        List&lt;String&gt; strings = exchange.getHeaders().get(<span class=\"string\">&quot;Content-Encoding&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (strings != <span class=\"keyword\">null</span> &amp;&amp; strings.contains(<span class=\"string\">&quot;gzip&quot;</span>)) &#123;</span><br><span class=\"line\">            GZIPInputStream gzipInputStream = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">            ByteArrayOutputStream out = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                gzipInputStream = <span class=\"keyword\">new</span> GZIPInputStream(<span class=\"keyword\">new</span> ByteArrayInputStream(bytes));</span><br><span class=\"line\">                out = <span class=\"keyword\">new</span> ByteArrayOutputStream();</span><br><span class=\"line\">                <span class=\"keyword\">byte</span>[] buffer = <span class=\"keyword\">new</span> <span class=\"keyword\">byte</span>[<span class=\"number\">1024</span>];</span><br><span class=\"line\">                <span class=\"keyword\">int</span> offset = -<span class=\"number\">1</span>;</span><br><span class=\"line\">                <span class=\"keyword\">while</span> ((offset = gzipInputStream.read(buffer)) != -<span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">                    out.write(buffer, <span class=\"number\">0</span>, offset);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                bytes = out.toByteArray();</span><br><span class=\"line\"></span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</span><br><span class=\"line\">                e.printStackTrace();</span><br><span class=\"line\">            &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                    gzipInputStream.close();</span><br><span class=\"line\">                    out.close();</span><br><span class=\"line\">                &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</span><br><span class=\"line\">                    e.printStackTrace();</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">//判断是否需要解压，即服务器返回是否经过了gzip压缩--end</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> bytes;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> String <span class=\"title\">post</span><span class=\"params\">(String url)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> post(url, <span class=\"keyword\">new</span> HashMap&lt;&gt;());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;p&gt;post请求&lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> url</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> params</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> java.lang.String</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@author</span> hanqf</span></span><br><span class=\"line\"><span class=\"comment\">     * 2020/4/22 16:59</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> String <span class=\"title\">post</span><span class=\"params\">(String url, Map&lt;String, Object&gt; params)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        MultiValueMap&lt;String, Object&gt; map = <span class=\"keyword\">new</span> LinkedMultiValueMap&lt;&gt;();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (params != <span class=\"keyword\">null</span> &amp;&amp; params.size() &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            map.setAll(params);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        HttpHeaders headers = <span class=\"keyword\">new</span> HttpHeaders();</span><br><span class=\"line\">        headers.setContentType(MediaType.APPLICATION_FORM_URLENCODED);</span><br><span class=\"line\">        HttpEntity&lt;MultiValueMap&lt;String, Object&gt;&gt; httpEntity = <span class=\"keyword\">new</span> HttpEntity&lt;&gt;(map, headers);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> restTemplate.postForObject(url, httpEntity, String.class);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">byte</span>[] postBytes(String url, Map&lt;String, Object&gt; params) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        MultiValueMap&lt;String, Object&gt; map = <span class=\"keyword\">new</span> LinkedMultiValueMap&lt;&gt;();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (params != <span class=\"keyword\">null</span> &amp;&amp; params.size() &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            map.setAll(params);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        HttpHeaders headers = <span class=\"keyword\">new</span> HttpHeaders();</span><br><span class=\"line\">        headers.setContentType(MediaType.APPLICATION_FORM_URLENCODED);</span><br><span class=\"line\">        HttpEntity&lt;MultiValueMap&lt;String, Object&gt;&gt; httpEntity = <span class=\"keyword\">new</span> HttpEntity&lt;&gt;(map, headers);</span><br><span class=\"line\">        <span class=\"comment\">//byte[] bytes = restTemplate.postForObject(url, httpEntity, byte[].class);</span></span><br><span class=\"line\"></span><br><span class=\"line\">        ResponseEntity&lt;<span class=\"keyword\">byte</span>[]&gt; exchange = restTemplate.exchange(url, HttpMethod.POST, httpEntity, <span class=\"keyword\">byte</span>[].class);</span><br><span class=\"line\">        <span class=\"keyword\">byte</span>[] bytes = exchange.getBody();</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//判断是否需要解压，即服务器返回是否经过了gzip压缩--start</span></span><br><span class=\"line\">        List&lt;String&gt; strings = exchange.getHeaders().get(<span class=\"string\">&quot;Content-Encoding&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (strings != <span class=\"keyword\">null</span> &amp;&amp; strings.contains(<span class=\"string\">&quot;gzip&quot;</span>)) &#123;</span><br><span class=\"line\">            GZIPInputStream gzipInputStream = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">            ByteArrayOutputStream out = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                gzipInputStream = <span class=\"keyword\">new</span> GZIPInputStream(<span class=\"keyword\">new</span> ByteArrayInputStream(bytes));</span><br><span class=\"line\">                out = <span class=\"keyword\">new</span> ByteArrayOutputStream();</span><br><span class=\"line\">                <span class=\"keyword\">byte</span>[] buffer = <span class=\"keyword\">new</span> <span class=\"keyword\">byte</span>[<span class=\"number\">1024</span>];</span><br><span class=\"line\">                <span class=\"keyword\">int</span> offset = -<span class=\"number\">1</span>;</span><br><span class=\"line\">                <span class=\"keyword\">while</span> ((offset = gzipInputStream.read(buffer)) != -<span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">                    out.write(buffer, <span class=\"number\">0</span>, offset);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                bytes = out.toByteArray();</span><br><span class=\"line\"></span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</span><br><span class=\"line\">                e.printStackTrace();</span><br><span class=\"line\">            &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                    gzipInputStream.close();</span><br><span class=\"line\">                    out.close();</span><br><span class=\"line\">                &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</span><br><span class=\"line\">                    e.printStackTrace();</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">//判断是否需要解压，即服务器返回是否经过了gzip压缩--end</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> bytes;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> String <span class=\"title\">postJson</span><span class=\"params\">(String url, String json)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> postJson(url, json, <span class=\"keyword\">false</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;p&gt;post请求json&lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> url</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> json</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> java.lang.String</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@author</span> hanqf</span></span><br><span class=\"line\"><span class=\"comment\">     * 2020/4/22 17:04</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> String <span class=\"title\">postJson</span><span class=\"params\">(String url, String json, <span class=\"keyword\">boolean</span> gzip)</span> </span>&#123;</span><br><span class=\"line\">        HttpHeaders headers = <span class=\"keyword\">new</span> HttpHeaders();</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (gzip) &#123;</span><br><span class=\"line\">            headers.setContentType(<span class=\"keyword\">new</span> MediaType(<span class=\"string\">&quot;application&quot;</span>, <span class=\"string\">&quot;octet-stream&quot;</span>));</span><br><span class=\"line\">            HttpEntity&lt;<span class=\"keyword\">byte</span>[]&gt; httpEntity = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                headers.add(<span class=\"string\">&quot;Content-Encoding&quot;</span>, <span class=\"string\">&quot;gzip&quot;</span>);</span><br><span class=\"line\">                ByteArrayOutputStream originalContent = <span class=\"keyword\">new</span> ByteArrayOutputStream();</span><br><span class=\"line\">                originalContent.write(json.getBytes(StandardCharsets.UTF_8));</span><br><span class=\"line\">                ByteArrayOutputStream baos = <span class=\"keyword\">new</span> ByteArrayOutputStream();</span><br><span class=\"line\">                GZIPOutputStream gzipOut = <span class=\"keyword\">new</span> GZIPOutputStream(baos);</span><br><span class=\"line\">                originalContent.writeTo(gzipOut);</span><br><span class=\"line\">                gzipOut.finish();</span><br><span class=\"line\">                httpEntity = <span class=\"keyword\">new</span> HttpEntity&lt;&gt;(baos.toByteArray(), headers);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">                e.printStackTrace();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> restTemplate.postForObject(url, httpEntity, String.class);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            headers.setContentType(<span class=\"keyword\">new</span> MediaType(<span class=\"string\">&quot;application&quot;</span>, <span class=\"string\">&quot;json&quot;</span>, StandardCharsets.UTF_8));</span><br><span class=\"line\">            <span class=\"comment\">//headers.add(&quot;Content-Type&quot;, &quot;application/json;charset=utf8&quot;);</span></span><br><span class=\"line\">            HttpEntity&lt;String&gt; httpEntity = <span class=\"keyword\">new</span> HttpEntity&lt;&gt;(json, headers);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> restTemplate.postForObject(url, httpEntity, String.class);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> String <span class=\"title\">postBytes</span><span class=\"params\">(String url, <span class=\"keyword\">byte</span>[] bytes)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> postBytes(url, bytes, <span class=\"keyword\">false</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;p&gt;post字节流&lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> url</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> bytes</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> gzip</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> java.lang.String</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@author</span> hanqf</span></span><br><span class=\"line\"><span class=\"comment\">     * 2020/4/22 17:10</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> String <span class=\"title\">postBytes</span><span class=\"params\">(String url, <span class=\"keyword\">byte</span>[] bytes, <span class=\"keyword\">boolean</span> gzip)</span> </span>&#123;</span><br><span class=\"line\">        HttpHeaders headers = <span class=\"keyword\">new</span> HttpHeaders();</span><br><span class=\"line\">        headers.setContentType(<span class=\"keyword\">new</span> MediaType(<span class=\"string\">&quot;application&quot;</span>, <span class=\"string\">&quot;octet-stream&quot;</span>));</span><br><span class=\"line\">        HttpEntity&lt;<span class=\"keyword\">byte</span>[]&gt; httpEntity = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (gzip) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                headers.add(<span class=\"string\">&quot;Content-Encoding&quot;</span>, <span class=\"string\">&quot;gzip&quot;</span>);</span><br><span class=\"line\">                ByteArrayOutputStream originalContent = <span class=\"keyword\">new</span> ByteArrayOutputStream();</span><br><span class=\"line\">                originalContent.write(bytes);</span><br><span class=\"line\">                ByteArrayOutputStream baos = <span class=\"keyword\">new</span> ByteArrayOutputStream();</span><br><span class=\"line\">                GZIPOutputStream gzipOut = <span class=\"keyword\">new</span> GZIPOutputStream(baos);</span><br><span class=\"line\">                originalContent.writeTo(gzipOut);</span><br><span class=\"line\">                gzipOut.finish();</span><br><span class=\"line\">                httpEntity = <span class=\"keyword\">new</span> HttpEntity&lt;&gt;(baos.toByteArray(), headers);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">                e.printStackTrace();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            httpEntity = <span class=\"keyword\">new</span> HttpEntity&lt;&gt;(bytes, headers);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> restTemplate.postForObject(url, httpEntity, String.class);</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> String <span class=\"title\">postStream</span><span class=\"params\">(String url, InputStream is)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> postStream(url, is, <span class=\"keyword\">false</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;p&gt;post请求，流&lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> url</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> is</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> gzip</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> java.lang.String</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@author</span> hanqf</span></span><br><span class=\"line\"><span class=\"comment\">     * 2020/4/22 17:12</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> String <span class=\"title\">postStream</span><span class=\"params\">(String url, InputStream is, <span class=\"keyword\">boolean</span> gzip)</span> </span>&#123;</span><br><span class=\"line\">        ByteArrayOutputStream byteArrayOutputStream = <span class=\"keyword\">new</span> ByteArrayOutputStream();</span><br><span class=\"line\">        <span class=\"keyword\">byte</span>[] buffer = <span class=\"keyword\">new</span> <span class=\"keyword\">byte</span>[<span class=\"number\">1024</span>];</span><br><span class=\"line\">        <span class=\"keyword\">int</span> ch;</span><br><span class=\"line\">        <span class=\"keyword\">byte</span>[] bytes = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">while</span> ((ch = is.read(buffer)) != -<span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">                byteArrayOutputStream.write(buffer, <span class=\"number\">0</span>, ch);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            bytes = byteArrayOutputStream.toByteArray();</span><br><span class=\"line\">            byteArrayOutputStream.close();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> postBytes(url, bytes, gzip);</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> String <span class=\"title\">postFiles</span><span class=\"params\">(String url, File[] files)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> postFiles(url, <span class=\"keyword\">new</span> HashMap&lt;&gt;(), files);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;p&gt;post请求，传输文件&lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> url</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> params</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> files</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> java.lang.String</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@author</span> hanqf</span></span><br><span class=\"line\"><span class=\"comment\">     * 2020/4/22 17:16</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> String <span class=\"title\">postFiles</span><span class=\"params\">(String url, Map&lt;String, Object&gt; params, File[] files)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        MultiValueMap&lt;String, Object&gt; map = <span class=\"keyword\">new</span> LinkedMultiValueMap&lt;&gt;();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (params != <span class=\"keyword\">null</span> &amp;&amp; params.size() &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            map.setAll(params);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (File file : files) &#123;</span><br><span class=\"line\">            map.add(<span class=\"string\">&quot;files&quot;</span>, <span class=\"keyword\">new</span> FileSystemResource(file));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> restTemplate.postForObject(url, map, String.class);</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;p&gt;重试拦截器&lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">RetryIntercepter</span> <span class=\"keyword\">implements</span> <span class=\"title\">ClientHttpRequestInterceptor</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> maxRetry = <span class=\"number\">3</span>;<span class=\"comment\">//最大重试次数，默认3次</span></span><br><span class=\"line\">        <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> retryNum = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">RetryIntercepter</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">RetryIntercepter</span><span class=\"params\">(<span class=\"keyword\">int</span> maxRetry)</span> </span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.maxRetry = maxRetry;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"meta\">@Override</span></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> ClientHttpResponse <span class=\"title\">intercept</span><span class=\"params\">(HttpRequest httpRequest, <span class=\"keyword\">byte</span>[] bytes, ClientHttpRequestExecution clientHttpRequestExecution)</span> <span class=\"keyword\">throws</span> IOException </span>&#123;</span><br><span class=\"line\">            ClientHttpResponse response = clientHttpRequestExecution.execute(httpRequest, bytes);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!response.getStatusCode().equals(HttpStatus.OK) &amp;&amp; retryNum &lt; maxRetry) &#123;</span><br><span class=\"line\">                retryNum++;</span><br><span class=\"line\">                response = clientHttpRequestExecution.execute(httpRequest, bytes);</span><br><span class=\"line\"></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> response;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;p&gt;Headers拦截器&lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">HeadersLoggingInterceper</span> <span class=\"keyword\">implements</span> <span class=\"title\">ClientHttpRequestInterceptor</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"meta\">@Override</span></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> ClientHttpResponse <span class=\"title\">intercept</span><span class=\"params\">(HttpRequest httpRequest, <span class=\"keyword\">byte</span>[] bytes, ClientHttpRequestExecution clientHttpRequestExecution)</span> <span class=\"keyword\">throws</span> IOException </span>&#123;</span><br><span class=\"line\">            log.info(String.format(<span class=\"string\">&quot;请求地址: %s&quot;</span>, httpRequest.getURI()));</span><br><span class=\"line\">            log.info(String.format(<span class=\"string\">&quot;请求头信息: %s&quot;</span>, httpRequest.getHeaders()));</span><br><span class=\"line\">            ClientHttpResponse response = clientHttpRequestExecution.execute(httpRequest, bytes);</span><br><span class=\"line\">            log.info(String.format(<span class=\"string\">&quot;响应头信息: %s&quot;</span>, response.getHeaders()));</span><br><span class=\"line\">            <span class=\"keyword\">return</span> response;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"WebClientUtil\"><a href=\"#WebClientUtil\" class=\"headerlink\" title=\"WebClientUtil\"></a>WebClientUtil</h2><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br><span class=\"line\">280</span><br><span class=\"line\">281</span><br><span class=\"line\">282</span><br><span class=\"line\">283</span><br><span class=\"line\">284</span><br><span class=\"line\">285</span><br><span class=\"line\">286</span><br><span class=\"line\">287</span><br><span class=\"line\">288</span><br><span class=\"line\">289</span><br><span class=\"line\">290</span><br><span class=\"line\">291</span><br><span class=\"line\">292</span><br><span class=\"line\">293</span><br><span class=\"line\">294</span><br><span class=\"line\">295</span><br><span class=\"line\">296</span><br><span class=\"line\">297</span><br><span class=\"line\">298</span><br><span class=\"line\">299</span><br><span class=\"line\">300</span><br><span class=\"line\">301</span><br><span class=\"line\">302</span><br><span class=\"line\">303</span><br><span class=\"line\">304</span><br><span class=\"line\">305</span><br><span class=\"line\">306</span><br><span class=\"line\">307</span><br><span class=\"line\">308</span><br><span class=\"line\">309</span><br><span class=\"line\">310</span><br><span class=\"line\">311</span><br><span class=\"line\">312</span><br><span class=\"line\">313</span><br><span class=\"line\">314</span><br><span class=\"line\">315</span><br><span class=\"line\">316</span><br><span class=\"line\">317</span><br><span class=\"line\">318</span><br><span class=\"line\">319</span><br><span class=\"line\">320</span><br><span class=\"line\">321</span><br><span class=\"line\">322</span><br><span class=\"line\">323</span><br><span class=\"line\">324</span><br><span class=\"line\">325</span><br><span class=\"line\">326</span><br><span class=\"line\">327</span><br><span class=\"line\">328</span><br><span class=\"line\">329</span><br><span class=\"line\">330</span><br><span class=\"line\">331</span><br><span class=\"line\">332</span><br><span class=\"line\">333</span><br><span class=\"line\">334</span><br><span class=\"line\">335</span><br><span class=\"line\">336</span><br><span class=\"line\">337</span><br><span class=\"line\">338</span><br><span class=\"line\">339</span><br><span class=\"line\">340</span><br><span class=\"line\">341</span><br><span class=\"line\">342</span><br><span class=\"line\">343</span><br><span class=\"line\">344</span><br><span class=\"line\">345</span><br><span class=\"line\">346</span><br><span class=\"line\">347</span><br><span class=\"line\">348</span><br><span class=\"line\">349</span><br><span class=\"line\">350</span><br><span class=\"line\">351</span><br><span class=\"line\">352</span><br><span class=\"line\">353</span><br><span class=\"line\">354</span><br><span class=\"line\">355</span><br><span class=\"line\">356</span><br><span class=\"line\">357</span><br><span class=\"line\">358</span><br><span class=\"line\">359</span><br><span class=\"line\">360</span><br><span class=\"line\">361</span><br><span class=\"line\">362</span><br><span class=\"line\">363</span><br><span class=\"line\">364</span><br><span class=\"line\">365</span><br><span class=\"line\">366</span><br><span class=\"line\">367</span><br><span class=\"line\">368</span><br><span class=\"line\">369</span><br><span class=\"line\">370</span><br><span class=\"line\">371</span><br><span class=\"line\">372</span><br><span class=\"line\">373</span><br><span class=\"line\">374</span><br><span class=\"line\">375</span><br><span class=\"line\">376</span><br><span class=\"line\">377</span><br><span class=\"line\">378</span><br><span class=\"line\">379</span><br><span class=\"line\">380</span><br><span class=\"line\">381</span><br><span class=\"line\">382</span><br><span class=\"line\">383</span><br><span class=\"line\">384</span><br><span class=\"line\">385</span><br><span class=\"line\">386</span><br><span class=\"line\">387</span><br><span class=\"line\">388</span><br><span class=\"line\">389</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> org.example;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> io.netty.channel.ChannelOption;</span><br><span class=\"line\"><span class=\"keyword\">import</span> io.netty.handler.timeout.ReadTimeoutHandler;</span><br><span class=\"line\"><span class=\"keyword\">import</span> io.netty.handler.timeout.WriteTimeoutHandler;</span><br><span class=\"line\"><span class=\"keyword\">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.core.io.FileSystemResource;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.http.HttpStatus;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.http.MediaType;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.http.client.reactive.ClientHttpConnector;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.http.client.reactive.ReactorClientHttpConnector;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.http.client.reactive.ReactorResourceFactory;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.util.LinkedMultiValueMap;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.util.MultiValueMap;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.reactive.function.client.ClientResponse;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.reactive.function.client.WebClient;</span><br><span class=\"line\"><span class=\"keyword\">import</span> reactor.core.publisher.Mono;</span><br><span class=\"line\"><span class=\"keyword\">import</span> reactor.netty.http.client.HttpClient;</span><br><span class=\"line\"><span class=\"keyword\">import</span> reactor.netty.resources.ConnectionProvider;</span><br><span class=\"line\"><span class=\"keyword\">import</span> reactor.netty.resources.LoopResources;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.*;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.nio.charset.StandardCharsets;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.HashMap;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.List;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Map;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.function.Function;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.zip.GZIPInputStream;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.zip.GZIPOutputStream;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * &lt;p&gt;&lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> * Created by hanqf on 2020/4/23 21:33.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Slf4j</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">WebClientUtil</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> ReactorResourceFactory factory = <span class=\"keyword\">new</span> ReactorResourceFactory();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> WebClient webClient;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">static</span> &#123;</span><br><span class=\"line\">        factory.setUseGlobalResources(<span class=\"keyword\">false</span>);</span><br><span class=\"line\">        factory.setConnectionProvider(ConnectionProvider.create(<span class=\"string\">&quot;httpClient&quot;</span>, <span class=\"number\">50</span>));</span><br><span class=\"line\">        factory.setLoopResources(LoopResources.create(<span class=\"string\">&quot;httpClient&quot;</span>, <span class=\"number\">50</span>, <span class=\"keyword\">true</span>));</span><br><span class=\"line\"></span><br><span class=\"line\">        Function&lt;HttpClient, HttpClient&gt; mapper = client -&gt;</span><br><span class=\"line\">                client.tcpConfiguration(c -&gt;</span><br><span class=\"line\">                        c.option(ChannelOption.CONNECT_TIMEOUT_MILLIS, <span class=\"number\">5000</span>)</span><br><span class=\"line\">                                .option(ChannelOption.TCP_NODELAY, <span class=\"keyword\">true</span>)</span><br><span class=\"line\">                                .doOnConnected(conn -&gt; &#123;</span><br><span class=\"line\">                                    conn.addHandlerLast(<span class=\"keyword\">new</span> ReadTimeoutHandler(<span class=\"number\">10</span>));</span><br><span class=\"line\">                                    conn.addHandlerLast(<span class=\"keyword\">new</span> WriteTimeoutHandler(<span class=\"number\">10</span>));</span><br><span class=\"line\">                                &#125;));</span><br><span class=\"line\"></span><br><span class=\"line\">        ClientHttpConnector connector =</span><br><span class=\"line\">                <span class=\"keyword\">new</span> ReactorClientHttpConnector(factory, mapper);</span><br><span class=\"line\"></span><br><span class=\"line\">        webClient = WebClient.builder()</span><br><span class=\"line\">                .filter((request, next) -&gt; &#123;  <span class=\"comment\">//过滤器，3次重试，header打印</span></span><br><span class=\"line\">                    log.info(String.format(<span class=\"string\">&quot;请求地址: %s&quot;</span>, request.url()));</span><br><span class=\"line\">                    log.info(String.format(<span class=\"string\">&quot;请求头信息: %s&quot;</span>, request.headers()));</span><br><span class=\"line\">                    Mono&lt;ClientResponse&gt; exchange = next.exchange(request).retry(<span class=\"number\">3</span>);</span><br><span class=\"line\">                    ClientResponse clientResponse = exchange.block();</span><br><span class=\"line\">                    log.info(String.format(<span class=\"string\">&quot;响应头信息: %s&quot;</span>, clientResponse.headers().asHttpHeaders()));</span><br><span class=\"line\">                    <span class=\"keyword\">return</span> exchange;</span><br><span class=\"line\">                &#125;)</span><br><span class=\"line\">                .clientConnector(connector).build();</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> String <span class=\"title\">get</span><span class=\"params\">(String url)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> get(url, <span class=\"keyword\">new</span> HashMap&lt;&gt;());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;p&gt;get请求&lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> url</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> map</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> java.lang.String</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@author</span> hanqf</span></span><br><span class=\"line\"><span class=\"comment\">     * 2020/4/24 14:44</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> String <span class=\"title\">get</span><span class=\"params\">(String url, Map&lt;String, Object&gt; map)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (map.size() &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            StringBuilder stringBuffer = <span class=\"keyword\">new</span> StringBuilder();</span><br><span class=\"line\">            stringBuffer.append(url);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (url.contains(<span class=\"string\">&quot;?&quot;</span>)) &#123;</span><br><span class=\"line\">                stringBuffer.append(<span class=\"string\">&quot;&amp;&quot;</span>);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                stringBuffer.append(<span class=\"string\">&quot;?&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">for</span> (String key : map.keySet()) &#123;</span><br><span class=\"line\">                stringBuffer.append(key).append(<span class=\"string\">&quot;=&quot;</span>).append(map.get(key).toString()).append(<span class=\"string\">&quot;&amp;&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            url = stringBuffer.toString();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        String responseResult = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        Mono&lt;String&gt; mono = webClient.get().uri(url).retrieve().bodyToMono(String.class);</span><br><span class=\"line\">        responseResult = mono.block();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> responseResult;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">byte</span>[] getBytes(String url, Map&lt;String, Object&gt; map) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (map.size() &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            StringBuilder stringBuffer = <span class=\"keyword\">new</span> StringBuilder();</span><br><span class=\"line\">            stringBuffer.append(url);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (url.contains(<span class=\"string\">&quot;?&quot;</span>)) &#123;</span><br><span class=\"line\">                stringBuffer.append(<span class=\"string\">&quot;&amp;&quot;</span>);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                stringBuffer.append(<span class=\"string\">&quot;?&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">for</span> (String key : map.keySet()) &#123;</span><br><span class=\"line\">                stringBuffer.append(key).append(<span class=\"string\">&quot;=&quot;</span>).append(map.get(key).toString()).append(<span class=\"string\">&quot;&amp;&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            url = stringBuffer.toString();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">byte</span>[] bytes = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        Mono&lt;ClientResponse&gt; exchange = webClient.get().uri(url).exchange();</span><br><span class=\"line\">        ClientResponse response = exchange.block();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (response.statusCode() == HttpStatus.OK) &#123;</span><br><span class=\"line\">            Mono&lt;<span class=\"keyword\">byte</span>[]&gt; mono =  response.bodyToMono(<span class=\"keyword\">byte</span>[].class);</span><br><span class=\"line\">            bytes = mono.block();</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//判断是否需要解压，即服务器返回是否经过了gzip压缩--start</span></span><br><span class=\"line\">            List&lt;String&gt; header = response.headers().header(<span class=\"string\">&quot;Content-Encoding&quot;</span>);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (header.contains(<span class=\"string\">&quot;gzip&quot;</span>)) &#123;</span><br><span class=\"line\">                GZIPInputStream gzipInputStream = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">                ByteArrayOutputStream out = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">                <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                    gzipInputStream = <span class=\"keyword\">new</span> GZIPInputStream(<span class=\"keyword\">new</span> ByteArrayInputStream(bytes));</span><br><span class=\"line\">                    out = <span class=\"keyword\">new</span> ByteArrayOutputStream();</span><br><span class=\"line\">                    <span class=\"keyword\">byte</span>[] buffer = <span class=\"keyword\">new</span> <span class=\"keyword\">byte</span>[<span class=\"number\">1024</span>];</span><br><span class=\"line\">                    <span class=\"keyword\">int</span> offset = -<span class=\"number\">1</span>;</span><br><span class=\"line\">                    <span class=\"keyword\">while</span> ((offset = gzipInputStream.read(buffer)) != -<span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">                        out.write(buffer, <span class=\"number\">0</span>, offset);</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                    bytes = out.toByteArray();</span><br><span class=\"line\"></span><br><span class=\"line\">                &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</span><br><span class=\"line\">                    e.printStackTrace();</span><br><span class=\"line\">                &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                        gzipInputStream.close();</span><br><span class=\"line\">                        out.close();</span><br><span class=\"line\">                    &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</span><br><span class=\"line\">                        e.printStackTrace();</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"comment\">//判断是否需要解压，即服务器返回是否经过了gzip压缩--end</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> bytes;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> String <span class=\"title\">post</span><span class=\"params\">(String url)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> post(url, <span class=\"keyword\">new</span> HashMap&lt;&gt;());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;p&gt;post请求&lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> url</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> params</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> java.lang.String</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@author</span> hanqf</span></span><br><span class=\"line\"><span class=\"comment\">     * 2020/4/24 14:43</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> String <span class=\"title\">post</span><span class=\"params\">(String url, Map&lt;String, Object&gt; params)</span> </span>&#123;</span><br><span class=\"line\">        MultiValueMap&lt;String, Object&gt; map = <span class=\"keyword\">new</span> LinkedMultiValueMap&lt;&gt;();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (params != <span class=\"keyword\">null</span> &amp;&amp; params.size() &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            map.setAll(params);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        String responseResult = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        Mono&lt;String&gt; mono = webClient.post().uri(url).bodyValue(map).retrieve().bodyToMono(String.class);</span><br><span class=\"line\">        responseResult = mono.block();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> responseResult;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">byte</span>[] postBytes(String url, Map&lt;String, Object&gt; params) &#123;</span><br><span class=\"line\">        MultiValueMap&lt;String, Object&gt; map = <span class=\"keyword\">new</span> LinkedMultiValueMap&lt;&gt;();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (params != <span class=\"keyword\">null</span> &amp;&amp; params.size() &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            map.setAll(params);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">byte</span>[] bytes = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        Mono&lt;ClientResponse&gt; exchange = webClient.post().uri(url).bodyValue(map).exchange();</span><br><span class=\"line\">        ClientResponse response = exchange.block();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (response.statusCode() == HttpStatus.OK) &#123;</span><br><span class=\"line\">            Mono&lt;<span class=\"keyword\">byte</span>[]&gt; mono =  response.bodyToMono(<span class=\"keyword\">byte</span>[].class);</span><br><span class=\"line\">            bytes = mono.block();</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//判断是否需要解压，即服务器返回是否经过了gzip压缩--start</span></span><br><span class=\"line\">            List&lt;String&gt; header = response.headers().header(<span class=\"string\">&quot;Content-Encoding&quot;</span>);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (header.contains(<span class=\"string\">&quot;gzip&quot;</span>)) &#123;</span><br><span class=\"line\">                GZIPInputStream gzipInputStream = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">                ByteArrayOutputStream out = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">                <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                    gzipInputStream = <span class=\"keyword\">new</span> GZIPInputStream(<span class=\"keyword\">new</span> ByteArrayInputStream(bytes));</span><br><span class=\"line\">                    out = <span class=\"keyword\">new</span> ByteArrayOutputStream();</span><br><span class=\"line\">                    <span class=\"keyword\">byte</span>[] buffer = <span class=\"keyword\">new</span> <span class=\"keyword\">byte</span>[<span class=\"number\">1024</span>];</span><br><span class=\"line\">                    <span class=\"keyword\">int</span> offset;</span><br><span class=\"line\">                    <span class=\"keyword\">while</span> ((offset = gzipInputStream.read(buffer)) != -<span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">                        out.write(buffer, <span class=\"number\">0</span>, offset);</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                    bytes = out.toByteArray();</span><br><span class=\"line\"></span><br><span class=\"line\">                &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</span><br><span class=\"line\">                    e.printStackTrace();</span><br><span class=\"line\">                &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                        gzipInputStream.close();</span><br><span class=\"line\">                        out.close();</span><br><span class=\"line\">                    &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</span><br><span class=\"line\">                        e.printStackTrace();</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"comment\">//判断是否需要解压，即服务器返回是否经过了gzip压缩--end</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> bytes;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;p&gt;post请求，form表单提交&lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> url</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> params 这里要注意将参数值转为字符串，否则会报类型错误</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> java.lang.String</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@author</span> hanqf</span></span><br><span class=\"line\"><span class=\"comment\">     * 2020/4/24 14:43</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> String <span class=\"title\">postForm</span><span class=\"params\">(String url, Map&lt;String, Object&gt; params)</span> </span>&#123;</span><br><span class=\"line\">        MultiValueMap&lt;String, Object&gt; map = <span class=\"keyword\">new</span> LinkedMultiValueMap&lt;&gt;();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (params != <span class=\"keyword\">null</span> &amp;&amp; params.size() &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">for</span> (String key : params.keySet()) &#123;</span><br><span class=\"line\">                map.add(key, params.get(key).toString());</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        String responseResult;</span><br><span class=\"line\">        Mono&lt;String&gt; mono = webClient.post().uri(url).contentType(MediaType.APPLICATION_FORM_URLENCODED).bodyValue(map).retrieve().bodyToMono(String.class);</span><br><span class=\"line\">        responseResult = mono.block();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> responseResult;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> String <span class=\"title\">postJson</span><span class=\"params\">(String url, String json)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> postJson(url, json, <span class=\"keyword\">false</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;p&gt;post请求，json&lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> url</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> json</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> gzip</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> java.lang.String</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@author</span> hanqf</span></span><br><span class=\"line\"><span class=\"comment\">     * 2020/4/24 15:45</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> String <span class=\"title\">postJson</span><span class=\"params\">(String url, String json, <span class=\"keyword\">boolean</span> gzip)</span> </span>&#123;</span><br><span class=\"line\">        String responseResult;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (gzip) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">byte</span>[] bytes = json.getBytes(StandardCharsets.UTF_8);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> postBytes(url, bytes, <span class=\"keyword\">true</span>);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            Mono&lt;String&gt; mono = webClient.post().uri(url).contentType(MediaType.APPLICATION_JSON).bodyValue(json).retrieve().bodyToMono(String.class);</span><br><span class=\"line\">            responseResult = mono.block();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> responseResult;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> String <span class=\"title\">postBytes</span><span class=\"params\">(String url, <span class=\"keyword\">byte</span>[] bytes)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> postBytes(url, bytes, <span class=\"keyword\">false</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;p&gt;post请求，字节流&lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> url</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> bytes</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> gzip</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> java.lang.String</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@author</span> hanqf</span></span><br><span class=\"line\"><span class=\"comment\">     * 2020/4/24 15:45</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> String <span class=\"title\">postBytes</span><span class=\"params\">(String url, <span class=\"keyword\">byte</span>[] bytes, <span class=\"keyword\">boolean</span> gzip)</span> </span>&#123;</span><br><span class=\"line\">        String responseResult;</span><br><span class=\"line\">        Mono&lt;String&gt; mono = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        WebClient.RequestBodySpec requestBodySpec = webClient.post().uri(url).contentType(MediaType.APPLICATION_OCTET_STREAM);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (gzip) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                <span class=\"comment\">//headers.add(&quot;Content-Encoding&quot;, &quot;gzip&quot;);</span></span><br><span class=\"line\">                ByteArrayOutputStream originalContent = <span class=\"keyword\">new</span> ByteArrayOutputStream();</span><br><span class=\"line\">                originalContent.write(bytes);</span><br><span class=\"line\">                ByteArrayOutputStream baos = <span class=\"keyword\">new</span> ByteArrayOutputStream();</span><br><span class=\"line\">                GZIPOutputStream gzipOut = <span class=\"keyword\">new</span> GZIPOutputStream(baos);</span><br><span class=\"line\">                originalContent.writeTo(gzipOut);</span><br><span class=\"line\">                gzipOut.finish();</span><br><span class=\"line\">                bytes = baos.toByteArray();</span><br><span class=\"line\">                mono = requestBodySpec.header(<span class=\"string\">&quot;Content-Encoding&quot;</span>, <span class=\"string\">&quot;gzip&quot;</span>).bodyValue(bytes).retrieve().bodyToMono(String.class);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">                e.printStackTrace();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            mono = requestBodySpec.bodyValue(bytes).retrieve().bodyToMono(String.class);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        responseResult = mono.block();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> responseResult;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> String <span class=\"title\">postStream</span><span class=\"params\">(String url, InputStream is)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> postStream(url, is, <span class=\"keyword\">false</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;p&gt;post请求，流&lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> url</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> is</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> gzip</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> java.lang.String</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@author</span> hanqf</span></span><br><span class=\"line\"><span class=\"comment\">     * 2020/4/22 17:12</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> String <span class=\"title\">postStream</span><span class=\"params\">(String url, InputStream is, <span class=\"keyword\">boolean</span> gzip)</span> </span>&#123;</span><br><span class=\"line\">        ByteArrayOutputStream byteArrayOutputStream = <span class=\"keyword\">new</span> ByteArrayOutputStream();</span><br><span class=\"line\">        <span class=\"keyword\">byte</span>[] buffer = <span class=\"keyword\">new</span> <span class=\"keyword\">byte</span>[<span class=\"number\">1024</span>];</span><br><span class=\"line\">        <span class=\"keyword\">int</span> ch;</span><br><span class=\"line\">        <span class=\"keyword\">byte</span>[] bytes = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">while</span> ((ch = is.read(buffer)) != -<span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">                byteArrayOutputStream.write(buffer, <span class=\"number\">0</span>, ch);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            bytes = byteArrayOutputStream.toByteArray();</span><br><span class=\"line\">            byteArrayOutputStream.close();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> postBytes(url, bytes, gzip);</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> String <span class=\"title\">postFiles</span><span class=\"params\">(String url, File[] files)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> postFiles(url, <span class=\"keyword\">new</span> HashMap&lt;&gt;(), files);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;p&gt;post请求，文件&lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> url</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> params</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> files</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> java.lang.String</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@author</span> hanqf</span></span><br><span class=\"line\"><span class=\"comment\">     * 2020/4/24 15:46</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> String <span class=\"title\">postFiles</span><span class=\"params\">(String url, Map&lt;String, Object&gt; params, File[] files)</span> </span>&#123;</span><br><span class=\"line\">        String responseResult;</span><br><span class=\"line\">        MultiValueMap&lt;String, Object&gt; map = <span class=\"keyword\">new</span> LinkedMultiValueMap&lt;&gt;();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (params != <span class=\"keyword\">null</span> &amp;&amp; params.size() &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            map.setAll(params);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (File file : files) &#123;</span><br><span class=\"line\">            map.add(<span class=\"string\">&quot;files&quot;</span>, <span class=\"keyword\">new</span> FileSystemResource(file));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        Mono&lt;String&gt; mono = webClient.post().uri(url).contentType(MediaType.MULTIPART_FORM_DATA).bodyValue(map).retrieve().bodyToMono(String.class);</span><br><span class=\"line\">        responseResult = mono.block();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> responseResult;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n","content_text":"摘要 本文内容基于org.apache.httpcomponents:httpclient:4.5.12，com.squareup.okhttp3:okhttp:4.5.0，springboot:2.2.6.RELEASE，spring-boot-starter-webflux:2.2.6.RELEASE 工具类，实现get/post[参数，json，输入流，文件，gzip]等方法 提供了测试用例及服务端demo github：https://github.com/hanqunfeng/springbootchapter/tree/master/chapter26 HttpClientUtil123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424425426427428429430431432433434435436437438439440441442443444445446447448449450451452453454455456457458459460461462463464465466467468469470471472473474475476477478479480481482483484485486487488489490491492493494495496497498499500501502503504505506507508509510511512513514515516517518519520521522523524525526527528529530531532533534535536537538539540541542543544545546547548549550551552553554555556557558559560561562563564565566567568569570571572573574575576577578579580581582583584585586587588589590591592593594595596597598599600601602603604605606607608609610611612613614615616617618619620621622623624625626627628629630631632633634635636637638639640641642643644645646647648649650651652653654655656657658659660661662663664665666package org.example;import lombok.SneakyThrows;import lombok.extern.slf4j.Slf4j;import org.apache.http.Header;import org.apache.http.HttpEntity;import org.apache.http.HttpResponse;import org.apache.http.NameValuePair;import org.apache.http.client.config.RequestConfig;import org.apache.http.client.entity.UrlEncodedFormEntity;import org.apache.http.client.methods.CloseableHttpResponse;import org.apache.http.client.methods.HttpGet;import org.apache.http.client.methods.HttpPost;import org.apache.http.client.methods.HttpRequestBase;import org.apache.http.client.utils.URIBuilder;import org.apache.http.concurrent.FutureCallback;import org.apache.http.entity.ByteArrayEntity;import org.apache.http.entity.ContentType;import org.apache.http.entity.StringEntity;import org.apache.http.entity.mime.MultipartEntityBuilder;import org.apache.http.impl.client.CloseableHttpClient;import org.apache.http.impl.client.DefaultHttpRequestRetryHandler;import org.apache.http.impl.client.HttpClientBuilder;import org.apache.http.impl.nio.client.CloseableHttpAsyncClient;import org.apache.http.impl.nio.client.HttpAsyncClients;import org.apache.http.message.BasicNameValuePair;import org.apache.http.util.EntityUtils;import java.io.*;import java.net.URI;import java.net.URLEncoder;import java.nio.charset.StandardCharsets;import java.util.ArrayList;import java.util.HashMap;import java.util.List;import java.util.Map;import java.util.zip.GZIPInputStream;import java.util.zip.GZIPOutputStream;/** * &lt;p&gt;HttpClient工具类&lt;/p&gt; * Created by hanqf on 2020/4/18 14:54. */@Slf4jpublic class HttpClientUtil &#123; /** * 配置信息 */ private static final RequestConfig requestConfig = RequestConfig.custom() // 设置连接超时时间(单位毫秒) .setConnectTimeout(5000) // 设置请求超时时间(单位毫秒) .setConnectionRequestTimeout(5000) // socket读写超时时间(单位毫秒) .setSocketTimeout(5000) // 设置是否允许重定向(默认为true) .setRedirectsEnabled(true) //是否启用内容压缩，默认true .setContentCompressionEnabled(true) .build(); /** * 获得Http客户端 */ private static final CloseableHttpClient HTTP_CLIENT = HttpClientBuilder.create() .setRetryHandler(new DefaultHttpRequestRetryHandler()) //失败重试，默认3次 .build(); /** * 异步Http客户端 */ private static final CloseableHttpAsyncClient HTTP_ASYNC_CLIENT = HttpAsyncClients.custom() .setDefaultRequestConfig(requestConfig) .build(); /** * &lt;p&gt;异步请求&lt;/p&gt; * * @param httpRequestBase * @author hanqf * 2020/4/22 21:16 */ private static void executeAsync(HttpRequestBase httpRequestBase) &#123; HTTP_ASYNC_CLIENT.start(); HTTP_ASYNC_CLIENT.execute(httpRequestBase, new FutureCallback&lt;HttpResponse&gt;() &#123; @SneakyThrows @Override public void completed(HttpResponse httpResponse) &#123; log.info(&quot; callback thread id is : &quot; + Thread.currentThread().getId()); log.info(httpRequestBase.getRequestLine() + &quot;-&gt;&quot; + httpResponse.getStatusLine()); StringBuffer stringBuffer = new StringBuffer(); for (Header header : httpRequestBase.getAllHeaders()) &#123; stringBuffer.append(header.toString()).append(&quot;,&quot;); &#125; log.info(String.format(&quot;请求头信息: [%s]&quot;, stringBuffer.toString())); String responseResult = null; HttpEntity responseEntity = httpResponse.getEntity(); log.debug(&quot;响应状态为:&quot; + httpResponse.getStatusLine()); if (responseEntity != null) &#123; responseResult = EntityUtils.toString(responseEntity, StandardCharsets.UTF_8); log.info(&quot;响应内容为:&quot; + responseResult); &#125; stringBuffer = new StringBuffer(); for (Header header : httpResponse.getAllHeaders()) &#123; stringBuffer.append(header.toString()).append(&quot;,&quot;); &#125; log.info(String.format(&quot;响应头信息: [%s]&quot;, stringBuffer.toString())); &#125; @Override public void failed(Exception e) &#123; log.info(&quot; callback thread id is : &quot; + Thread.currentThread().getId()); log.info(&quot;Get responseResult：&quot;, e); e.printStackTrace(); &#125; @Override public void cancelled() &#123; log.info(httpRequestBase.getRequestLine() + &quot; cancelled&quot;); &#125; &#125;); &#125; /** * &lt;p&gt;请求的执行方法，需要提前封装好httpRequestBase对象，如请求url和请求参数&lt;/p&gt; * * @param httpRequestBase * @return java.lang.String * @author hanqf * 2020/4/18 22:08 */ private static String execute(HttpRequestBase httpRequestBase) &#123; log.info(String.format(&quot;请求地址: [%s]&quot;, httpRequestBase.getURI().toString())); log.info(String.format(&quot;请求类型: [%s]&quot;, httpRequestBase.getMethod())); StringBuffer stringBuffer = new StringBuffer(); for (Header header : httpRequestBase.getAllHeaders()) &#123; stringBuffer.append(header.toString()).append(&quot;,&quot;); &#125; log.info(String.format(&quot;请求头信息: [%s]&quot;, stringBuffer.toString())); log.info(String.format(&quot;请求参数: [%s]&quot;, httpRequestBase.getURI().getQuery())); String responseResult = null; // 响应模型 CloseableHttpResponse response = null; try &#123; // 将上面的配置信息 运用到这个Get请求里 httpRequestBase.setConfig(requestConfig); long t1 = System.nanoTime();//请求发起的时间 response = HTTP_CLIENT.execute(httpRequestBase); // 从响应模型中获取响应实体 HttpEntity responseEntity = response.getEntity(); log.debug(&quot;响应状态为:&quot; + response.getStatusLine()); long t2 = System.nanoTime();//收到响应的时间 if (responseEntity != null) &#123; responseResult = EntityUtils.toString(responseEntity, StandardCharsets.UTF_8); log.debug(&quot;响应内容为:&quot; + responseResult); &#125; stringBuffer = new StringBuffer(); for (Header header : response.getAllHeaders()) &#123; stringBuffer.append(header.toString()).append(&quot;,&quot;); &#125; log.info(String.format(&quot;响应头信息: [%s]&quot;, stringBuffer.toString())); log.info(String.format(&quot;执行时间: [%.1fms]&quot;, (t2 - t1) / 1e6d)); &#125; catch (Exception e) &#123; log.info(&quot;Get responseResult：&quot;, e); e.printStackTrace(); &#125; finally &#123; try &#123; if (response != null) &#123; response.close(); &#125; &#125; catch (IOException e) &#123; e.printStackTrace(); &#125; &#125; return responseResult; &#125; /** * &lt;p&gt;请求的执行方法，需要提前封装好httpRequestBase对象，如请求url和请求参数&lt;/p&gt; * * @param httpRequestBase * @return byte[] * @author hanqf * 2020/4/29 13:33 */ private static byte[] executeBytes(HttpRequestBase httpRequestBase) &#123; log.info(String.format(&quot;请求地址: [%s]&quot;, httpRequestBase.getURI().toString())); log.info(String.format(&quot;请求类型: [%s]&quot;, httpRequestBase.getMethod())); StringBuffer stringBuffer = new StringBuffer(); for (Header header : httpRequestBase.getAllHeaders()) &#123; stringBuffer.append(header.toString()).append(&quot;,&quot;); &#125; log.info(String.format(&quot;请求头信息: [%s]&quot;, stringBuffer.toString())); log.info(String.format(&quot;请求参数: [%s]&quot;, httpRequestBase.getURI().getQuery())); byte[] bytes = null; // 响应模型 CloseableHttpResponse response = null; try &#123; // 将上面的配置信息 运用到这个Get请求里 httpRequestBase.setConfig(requestConfig); long t1 = System.nanoTime();//请求发起的时间 response = HTTP_CLIENT.execute(httpRequestBase); // 从响应模型中获取响应实体 HttpEntity responseEntity = response.getEntity(); log.debug(&quot;响应状态为:&quot; + response.getStatusLine()); long t2 = System.nanoTime();//收到响应的时间 if (responseEntity != null) &#123; bytes = EntityUtils.toByteArray(responseEntity); //判断是否需要解压，即服务器返回是否经过了gzip压缩--start Header responseHeader = response.getFirstHeader(&quot;Content-Encoding&quot;); if (responseHeader != null &amp;&amp; responseHeader.getValue().contains(&quot;gzip&quot;)) &#123; GZIPInputStream gzipInputStream = null; ByteArrayOutputStream out = null; try &#123; gzipInputStream = new GZIPInputStream(new ByteArrayInputStream(bytes)); out = new ByteArrayOutputStream(); byte[] buffer = new byte[1024]; int offset = -1; while ((offset = gzipInputStream.read(buffer)) != -1) &#123; out.write(buffer, 0, offset); &#125; bytes = out.toByteArray(); &#125; catch (IOException e) &#123; e.printStackTrace(); &#125; finally &#123; try &#123; gzipInputStream.close(); out.close(); &#125; catch (IOException e) &#123; e.printStackTrace(); &#125; &#125; &#125; //判断是否需要解压，即服务器返回是否经过了gzip压缩--end log.debug(&quot;响应byte长度:&quot; + bytes.length); &#125; stringBuffer = new StringBuffer(); for (Header header : response.getAllHeaders()) &#123; stringBuffer.append(header.toString()).append(&quot;,&quot;); &#125; log.info(String.format(&quot;响应头信息: [%s]&quot;, stringBuffer.toString())); log.info(String.format(&quot;执行时间: [%.1fms]&quot;, (t2 - t1) / 1e6d)); &#125; catch (Exception e) &#123; log.info(&quot;Get responseResult：&quot;, e); e.printStackTrace(); &#125; finally &#123; try &#123; if (response != null) &#123; response.close(); &#125; &#125; catch (IOException e) &#123; e.printStackTrace(); &#125; &#125; return bytes; &#125; /** * &lt;p&gt;get请求&lt;/p&gt; * * @param url 请求地址 * @return java.lang.String 响应结果 * @author hanqf * 2020/4/18 15:57 */ public static String get(String url) &#123; return get(url, new HashMap&lt;&gt;()); &#125; /** * &lt;p&gt;get请求&lt;/p&gt; * * @param url 请求地址 * @return java.lang.String 响应结果 * @author hanqf * 2020/4/18 15:49 */ public static String get(String url, Map&lt;String, Object&gt; params) &#123; HttpGet httpGet = null; List&lt;NameValuePair&gt; list = new ArrayList&lt;&gt;(); for (String key : params.keySet()) &#123; list.add(new BasicNameValuePair(key, params.get(key).toString())); &#125; // 由客户端执行(发送)Get请求 try &#123; URI uri = new URIBuilder(url).addParameters(list).build(); // 创建Get请求 httpGet = new HttpGet(uri); &#125; catch (Exception e) &#123; log.info(&quot;Get responseResult：&quot;, e); e.printStackTrace(); &#125; return execute(httpGet); &#125; /** * &lt;p&gt;get请求，返回字节数组&lt;/p&gt; * * @param url * @param params * @return byte[] * @author hanqf * 2020/4/29 13:35 */ public static byte[] getBytes(String url, Map&lt;String, Object&gt; params) &#123; HttpGet httpGet = null; List&lt;NameValuePair&gt; list = new ArrayList&lt;&gt;(); for (String key : params.keySet()) &#123; list.add(new BasicNameValuePair(key, params.get(key).toString())); &#125; // 由客户端执行(发送)Get请求 try &#123; URI uri = new URIBuilder(url).addParameters(list).build(); // 创建Get请求 httpGet = new HttpGet(uri); &#125; catch (Exception e) &#123; log.info(&quot;Get responseResult：&quot;, e); e.printStackTrace(); &#125; return executeBytes(httpGet); &#125; /** * &lt;p&gt;post请求&lt;/p&gt; * * @param url 请求地址 * @return java.lang.String 响应结果 * @author hanqf * 2020/4/18 15:54 */ public static String post(String url) &#123; return post(url, new HashMap&lt;&gt;()); &#125; /** * &lt;p&gt;post请求&lt;/p&gt; * * @param url 请求地址 * @param params 请求参数 * @return java.lang.String 响应结果 * @author hanqf * 2020/4/18 15:50 */ public static String post(String url, Map&lt;String, Object&gt; params) &#123; HttpPost httpPost = null; List&lt;NameValuePair&gt; list = new ArrayList&lt;&gt;(); for (String key : params.keySet()) &#123; list.add(new BasicNameValuePair(key, params.get(key).toString())); &#125; try &#123; URI uri = new URIBuilder(url).addParameters(list).build(); httpPost = new HttpPost(uri); &#125; catch (Exception e) &#123; log.info(&quot;Get responseResult：&quot;, e); e.printStackTrace(); &#125; return execute(httpPost); &#125; /** * &lt;p&gt;post请求，返回字节数组&lt;/p&gt; * * @param url * @param params * @return byte[] * @author hanqf * 2020/4/29 13:35 */ public static byte[] postBytes(String url, Map&lt;String, Object&gt; params) &#123; HttpPost httpPost = null; List&lt;NameValuePair&gt; list = new ArrayList&lt;&gt;(); for (String key : params.keySet()) &#123; list.add(new BasicNameValuePair(key, params.get(key).toString())); &#125; try &#123; URI uri = new URIBuilder(url).addParameters(list).build(); httpPost = new HttpPost(uri); &#125; catch (Exception e) &#123; log.info(&quot;Get responseResult：&quot;, e); e.printStackTrace(); &#125; return executeBytes(httpPost); &#125; /** * &lt;p&gt;post请求，请求体为json&lt;/p&gt; * * @param url 请求地址 * @param json 请求json * @return java.lang.String 响应结果 * @author hanqf * 2020/4/18 16:02 */ public static String postJson(String url, String json) &#123; return postJson(url, json, false); &#125; /** * &lt;p&gt;post请求，请求体为json&lt;/p&gt; * * @param url 请求地址 * @param json 请求json * @param gzip 是否开启gzip压缩 * @return java.lang.String 响应结果 * @author hanqf * 2020/4/18 16:02 */ public static String postJson(String url, String json, boolean gzip) &#123; HttpPost httpPost = null; try &#123; URI uri = new URIBuilder(url).build(); httpPost = new HttpPost(uri); // post请求是将参数放在请求体里面传过去的,这里将entity放入post请求体中 httpPost.setHeader(&quot;Content-Type&quot;, &quot;application/json;charset=utf8&quot;); if (gzip) &#123; httpPost.setHeader(&quot;Content-Encoding&quot;, &quot;gzip&quot;); ByteArrayOutputStream originalContent = new ByteArrayOutputStream(); originalContent.write(json.getBytes(StandardCharsets.UTF_8)); ByteArrayOutputStream baos = new ByteArrayOutputStream(); GZIPOutputStream gzipOut = new GZIPOutputStream(baos); originalContent.writeTo(gzipOut); gzipOut.finish(); httpPost.setEntity(new ByteArrayEntity(baos .toByteArray(), ContentType.create(&quot;text/plain&quot;, &quot;utf-8&quot;))); &#125; else &#123; StringEntity entity = new StringEntity(json, &quot;UTF-8&quot;); httpPost.setEntity(entity); &#125; &#125; catch (Exception e) &#123; log.info(&quot;Get responseResult：&quot;, e); e.printStackTrace(); &#125; return execute(httpPost); &#125; /** * &lt;p&gt;post请求，请求参数中有中文的话可以使用这个请求&lt;/p&gt; * * @param url 请求地址 * @param params 请求参数，只可以为中文 * @return java.lang.String * @author hanqf * 2020/4/18 16:30 */ public static String postForm(String url, Map&lt;String, Object&gt; params) &#123; HttpPost httpPost = null; List&lt;NameValuePair&gt; list = new ArrayList&lt;&gt;(); for (String key : params.keySet()) &#123; list.add(new BasicNameValuePair(key, params.get(key).toString())); &#125; try &#123; UrlEncodedFormEntity urlEncodedFormEntity = new UrlEncodedFormEntity(list, StandardCharsets.UTF_8); URI uri = new URIBuilder(url).build(); httpPost = new HttpPost(uri); httpPost.setHeader(&quot;Content-Type&quot;, &quot;application/x-www-form-urlencoded&quot;); httpPost.setEntity(urlEncodedFormEntity); &#125; catch (Exception e) &#123; log.info(&quot;Get responseResult：&quot;, e); e.printStackTrace(); &#125; return execute(httpPost); &#125; /** * &lt;p&gt;post请求，输入流&lt;/p&gt; * * @param url 请求地址 * @param bytes 请求输入流 * @return java.lang.String * @author hanqf * 2020/4/18 16:37 */ public static String postInputBytes(String url, byte[] bytes) &#123; return postInputBytes(url, bytes, false); &#125; /** * &lt;p&gt;post请求，输入流&lt;/p&gt; * * @param url 请求地址 * @param bytes 请求输入流 * @param gzip 是否开启gzip压缩 * @return java.lang.String * @author hanqf * 2020/4/18 16:37 */ public static String postInputBytes(String url, byte[] bytes, boolean gzip) &#123; HttpPost httpPost = null; try &#123; URI uri = new URIBuilder(url).build(); httpPost = new HttpPost(uri); // post请求是将参数放在请求体里面传过去的,这里将entity放入post请求体中 if (gzip) &#123; httpPost.setHeader(&quot;Content-Encoding&quot;, &quot;gzip&quot;); ByteArrayOutputStream originalContent = new ByteArrayOutputStream(); originalContent.write(bytes); ByteArrayOutputStream baos = new ByteArrayOutputStream(); GZIPOutputStream gzipOut = new GZIPOutputStream(baos); originalContent.writeTo(gzipOut); gzipOut.finish(); httpPost.setEntity(new ByteArrayEntity(baos .toByteArray(), ContentType.create(&quot;text/plain&quot;, &quot;utf-8&quot;))); &#125; else &#123; ByteArrayEntity entity = new ByteArrayEntity(bytes, ContentType.create(&quot;text/plain&quot;, &quot;utf-8&quot;)); httpPost.setEntity(entity); &#125; &#125; catch (Exception e) &#123; log.info(&quot;Get responseResult：&quot;, e); e.printStackTrace(); &#125; return execute(httpPost); &#125; /** * &lt;p&gt;post请求，流&lt;/p&gt; * * @param url * @param is * @return java.lang.String * @author hanqf * 2020/4/21 22:24 */ public static String postInputStream(String url, InputStream is) &#123; return postInputStream(url, is, false); &#125; /** * &lt;p&gt;post请求，流&lt;/p&gt; * * @param url * @param is * @param gzip * @return java.lang.String * @author hanqf * 2020/4/21 22:24 */ public static String postInputStream(String url, InputStream is, boolean gzip) &#123; ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream(); byte[] buffer = new byte[1024]; int ch; byte[] bytes = null; try &#123; while ((ch = is.read(buffer)) != -1) &#123; byteArrayOutputStream.write(buffer, 0, ch); &#125; bytes = byteArrayOutputStream.toByteArray(); byteArrayOutputStream.close(); &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; return postInputBytes(url, bytes, gzip); &#125; /** * &lt;p&gt;post请求，传输附件&lt;/p&gt; * * @param url 请求地址 * @param files 文件列表 * @return java.lang.String * @author hanqf * 2020/4/18 16:52 */ public static String postFile(String url, File[] files) &#123; return postFile(url, new HashMap&lt;&gt;(), files); &#125; /** * &lt;p&gt;post请求，传输附件&lt;/p&gt; * * @param url 请求地址 * @param params 其它参数 * @param files 文件列表 * @return java.lang.String * @author hanqf * 2020/4/18 16:50 */ public static String postFile(String url, Map&lt;String, Object&gt; params, File[] files) &#123; HttpPost httpPost = null; try &#123; URI uri = new URIBuilder(url).build(); httpPost = new HttpPost(uri); MultipartEntityBuilder multipartEntityBuilder = MultipartEntityBuilder.create(); String filesKey = &quot;files&quot;; for (File file : files) &#123; //multipartEntityBuilder.addPart(filesKey,new FileBody(file)); //与下面的语句作用相同 //multipartEntityBuilder.addBinaryBody(filesKey, file); // 防止服务端收到的文件名乱码。 我们这里可以先将文件名URLEncode，然后服务端拿到文件名时在URLDecode。就能避免乱码问题。 // 文件名其实是放在请求头的Content-Disposition里面进行传输的，如其值为form-data; name=&quot;files&quot;; filename=&quot;头像.jpg&quot; multipartEntityBuilder.addBinaryBody(filesKey, file, ContentType.DEFAULT_BINARY, URLEncoder.encode(file.getName(), &quot;utf-8&quot;)); &#125; // 其它参数(注:自定义contentType，设置UTF-8是为了防止服务端拿到的参数出现乱码) ContentType contentType = ContentType.create(&quot;text/plain&quot;, StandardCharsets.UTF_8); for (String key : params.keySet()) &#123; multipartEntityBuilder.addTextBody(key, params.get(key).toString(), contentType); &#125; HttpEntity entity = multipartEntityBuilder.build(); // post请求是将参数放在请求体里面传过去的,这里将entity放入post请求体中 httpPost.setEntity(entity); &#125; catch (Exception e) &#123; log.info(&quot;Get responseResult：&quot;, e); e.printStackTrace(); &#125; return execute(httpPost); &#125;&#125; OkHttpUtil123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424425426427428429430431432433434435436437438439440441442443444445446447448449450451452453454455456457458459460461462463464465466467468469470471472473474475476477478479480481482483484485486487488489490491492493494495496497498499500501502503504505506507508509510511512513514515516517518519520521522523524525526527528529530531532533534535536537538539540541542543544545546547548549550551552553package org.example;import com.alibaba.fastjson.JSONArray;import lombok.extern.slf4j.Slf4j;import okhttp3.*;import okio.BufferedSink;import okio.GzipSink;import okio.Okio;import org.jetbrains.annotations.NotNull;import java.io.*;import java.net.URLEncoder;import java.util.HashMap;import java.util.Map;import java.util.Objects;import java.util.concurrent.TimeUnit;import java.util.zip.GZIPInputStream;/** * &lt;p&gt;OkHttp工具类&lt;/p&gt; * Created by hanqf on 2020/4/18 21:54. */@Slf4jpublic class OkHttpUtil &#123; /** * 获得OkHttpClient客户端 */ private static final OkHttpClient client = new OkHttpClient.Builder() .connectTimeout(5L, TimeUnit.SECONDS) //连接超时时间，5秒 .readTimeout(5L, TimeUnit.SECONDS) //读超时时间，5秒 .writeTimeout(5L, TimeUnit.SECONDS) //写超时时间，5秒 .followRedirects(true) //设置是否允许重定向，默认true //注意拦截器的顺序 .addInterceptor(new GzipRequestInterceptor()) //开启gzip压缩，支持对流或Json进行gzip压缩，服务端需要支持解压缩 .addInterceptor(new RetryIntercepter()) //重试拦截器，默认3次 .addInterceptor(new HeadersLoggingInterceper()) //header拦截器 .build(); /** * &lt;p&gt;异步调用&lt;/p&gt; * @author hanqf * 2020/4/22 20:37 * @param request */ private static void executeAsync(Request request)&#123; Call call = client.newCall(request); call.enqueue(new Callback() &#123; @Override public void onFailure(@NotNull Call call, @NotNull IOException e) &#123; log.info(&quot;Get responseResult：&quot;, e); e.printStackTrace(); &#125; @Override public void onResponse(@NotNull Call call, @NotNull Response response) throws IOException &#123; String responseResult = null; if (response.isSuccessful()) &#123; responseResult = Objects.requireNonNull(response.body()).string(); &#125; Headers headers = response.headers(); StringBuilder stringBuffer = new StringBuilder(); for(int i=0;i&lt;headers.size();i++)&#123; stringBuffer.append(headers.name(i)).append(&quot;:&quot;).append(headers.value(i)).append(&quot;,&quot;); &#125; log.info(String.format(&quot;响应头信息: [%s]&quot;, stringBuffer.toString())); log.info(String.format(&quot;响应结果：%s&quot;,responseResult)); &#125; &#125;); &#125; /** * &lt;p&gt;请求的执行方法，需要提前封装好Request对象，如请求url和请求参数&lt;/p&gt; * * @param request * @return java.lang.String * @author hanqf * 2020/4/18 23:47 */ private static String execute(Request request) &#123; String responseResult = null; try &#123; long t1 = System.nanoTime();//请求发起的时间 Response response = client.newCall(request).execute(); if (response.isSuccessful()) &#123; responseResult = Objects.requireNonNull(response.body()).string(); //byte[] bytes = response.body().bytes(); //responseResult = new String(bytes,&quot;utf-8&quot;); &#125; long t2 = System.nanoTime();//收到响应的时间 Headers headers = response.headers(); StringBuilder stringBuffer = new StringBuilder(); for(int i=0;i&lt;headers.size();i++)&#123; stringBuffer.append(headers.name(i)).append(&quot;:&quot;).append(headers.value(i)).append(&quot;,&quot;); &#125; log.info(String.format(&quot;响应头信息: [%s]&quot;, stringBuffer.toString())); log.info(String.format(&quot;执行时间: [%.1fms]&quot;, (t2 - t1) / 1e6d)); &#125; catch (IOException e) &#123; log.info(&quot;Get responseResult：&quot;, e); e.printStackTrace(); &#125; return responseResult; &#125; private static byte[] executeBytes(Request request) &#123; byte[] bytes = null; try &#123; long t1 = System.nanoTime();//请求发起的时间 Response response = client.newCall(request).execute(); if (response.isSuccessful()) &#123; bytes = Objects.requireNonNull(response.body()).bytes(); //判断是否需要解压，即服务器返回是否经过了gzip压缩--start String responseHeader = response.header(&quot;Content-Encoding&quot;); if (responseHeader != null &amp;&amp; responseHeader.contains(&quot;gzip&quot;)) &#123; GZIPInputStream gzipInputStream = null; ByteArrayOutputStream out = null; try &#123; gzipInputStream = new GZIPInputStream(new ByteArrayInputStream(bytes)); out = new ByteArrayOutputStream(); byte[] buffer = new byte[1024]; int offset = -1; while ((offset = gzipInputStream.read(buffer)) != -1) &#123; out.write(buffer, 0, offset); &#125; bytes = out.toByteArray(); &#125; catch (IOException e) &#123; e.printStackTrace(); &#125; finally &#123; try &#123; gzipInputStream.close(); out.close(); &#125; catch (IOException e) &#123; e.printStackTrace(); &#125; &#125; &#125; //判断是否需要解压，即服务器返回是否经过了gzip压缩--end &#125; long t2 = System.nanoTime();//收到响应的时间 Headers headers = response.headers(); StringBuilder stringBuffer = new StringBuilder(); for(int i=0;i&lt;headers.size();i++)&#123; stringBuffer.append(headers.name(i)).append(&quot;:&quot;).append(headers.value(i)).append(&quot;,&quot;); &#125; log.info(String.format(&quot;响应头信息: [%s]&quot;, stringBuffer.toString())); log.info(String.format(&quot;执行时间: [%.1fms]&quot;, (t2 - t1) / 1e6d)); &#125; catch (IOException e) &#123; log.info(&quot;Get responseResult：&quot;, e); e.printStackTrace(); &#125; return bytes; &#125; /** * &lt;p&gt;get请求&lt;/p&gt; * * @param url 请求url * @return java.lang.String * @author hanqf * 2020/4/18 23:48 */ public static String get(String url) &#123; return get(url, new HashMap&lt;&gt;()); &#125; /** * &lt;p&gt;get请求&lt;/p&gt; * * @param url * @param params * @return java.lang.String * @author hanqf * 2020/4/20 16:40 */ public static String get(String url, Map&lt;String, Object&gt; params) &#123; if (params.size() &gt; 0) &#123; StringBuilder stringBuffer = new StringBuilder(); stringBuffer.append(url); if (url.contains(&quot;?&quot;)) &#123; stringBuffer.append(&quot;&amp;&quot;); &#125; else &#123; stringBuffer.append(&quot;?&quot;); &#125; for (String key : params.keySet()) &#123; stringBuffer.append(key).append(&quot;=&quot;).append(params.get(key).toString()).append(&quot;&amp;&quot;); &#125; url = stringBuffer.toString(); &#125; Request request = new Request.Builder() .url(url) .get() .build(); log.info(String.format(&quot;请求地址: [%s]&quot;, request.url())); if (params.size() &gt; 0) &#123; JSONArray jArray = new JSONArray(); jArray.add(params); log.info(String.format(&quot;请求参数: %s&quot;, jArray.toJSONString())); &#125; //executeAsync(request); return execute(request); &#125; public static byte[] getBytes(String url, Map&lt;String, Object&gt; params) &#123; if (params.size() &gt; 0) &#123; StringBuilder stringBuffer = new StringBuilder(); stringBuffer.append(url); if (url.contains(&quot;?&quot;)) &#123; stringBuffer.append(&quot;&amp;&quot;); &#125; else &#123; stringBuffer.append(&quot;?&quot;); &#125; for (String key : params.keySet()) &#123; stringBuffer.append(key).append(&quot;=&quot;).append(params.get(key).toString()).append(&quot;&amp;&quot;); &#125; url = stringBuffer.toString(); &#125; Request request = new Request.Builder() .url(url) .get() .build(); log.info(String.format(&quot;请求地址: [%s]&quot;, request.url())); if (params.size() &gt; 0) &#123; JSONArray jArray = new JSONArray(); jArray.add(params); log.info(String.format(&quot;请求参数: %s&quot;, jArray.toJSONString())); &#125; return executeBytes(request); &#125; /** * &lt;p&gt;post请求&lt;/p&gt; * * @param url 请求url * @return java.lang.String * @author hanqf * 2020/4/18 23:48 */ public static String post(String url) &#123; return post(url, new HashMap&lt;&gt;()); &#125; /** * &lt;p&gt;post请求&lt;/p&gt; * form请求 * * @param url 请求url * @param params 请求参数 * @return java.lang.String * @author hanqf * 2020/4/18 23:49 */ public static String post(String url, Map&lt;String, Object&gt; params) &#123; //请求头会加入：application/x-www-form-urlencoded FormBody.Builder builder = new FormBody.Builder(); for (String key : params.keySet()) &#123; builder.add(key, params.get(key).toString()); &#125; RequestBody requestBody = builder.build(); Request request = new Request.Builder() .url(url) .post(requestBody) .build(); log.info(String.format(&quot;请求地址: [%s]&quot;, request.url())); if (params.size() &gt; 0) &#123; JSONArray jArray = new JSONArray(); jArray.add(params); log.info(String.format(&quot;请求参数: %s&quot;, jArray.toJSONString())); &#125; log.info(String.format(&quot;请求类型: %s&quot;, Objects.requireNonNull(Objects.requireNonNull(request.body()).contentType()).toString())); return execute(request); &#125; public static byte[] postBytes(String url, Map&lt;String, Object&gt; params) &#123; //请求头会加入：application/x-www-form-urlencoded FormBody.Builder builder = new FormBody.Builder(); for (String key : params.keySet()) &#123; builder.add(key, params.get(key).toString()); &#125; RequestBody requestBody = builder.build(); Request request = new Request.Builder() .url(url) .post(requestBody) .build(); log.info(String.format(&quot;请求地址: [%s]&quot;, request.url())); if (params.size() &gt; 0) &#123; JSONArray jArray = new JSONArray(); jArray.add(params); log.info(String.format(&quot;请求参数: %s&quot;, jArray.toJSONString())); &#125; log.info(String.format(&quot;请求类型: %s&quot;, Objects.requireNonNull(Objects.requireNonNull(request.body()).contentType()).toString())); return executeBytes(request); &#125; /** * &lt;p&gt;post请求，json请求&lt;/p&gt; * * @param url 请求url * @param json json数据 * @return java.lang.String * @author hanqf * 2020/4/18 23:50 */ public static String post(String url, String json) &#123; MediaType mediaType = MediaType.parse(&quot;application/json; charset=utf8&quot;); RequestBody requestBody = RequestBody.create(json, mediaType); Request request = new Request.Builder() .url(url) .post(requestBody) .build(); log.info(String.format(&quot;请求地址: [%s]&quot;, request.url())); log.info(String.format(&quot;请求参数: %s&quot;, json)); log.info(String.format(&quot;请求类型: %s&quot;, Objects.requireNonNull(Objects.requireNonNull(request.body()).contentType()).toString())); return execute(request); &#125; /** * &lt;p&gt;post请求，字节流&lt;/p&gt; * * @param url 请求url * @param bytes 字节数组 * @return java.lang.String * @author hanqf * 2020/4/18 23:51 */ public static String post(String url, byte[] bytes) &#123; MediaType mediaType = MediaType.parse(&quot;application/octet-stream&quot;); RequestBody requestBody = null; requestBody = RequestBody.create(bytes, mediaType); Request request = new Request.Builder() .url(url) .post(requestBody) .build(); log.info(String.format(&quot;请求地址: [%s]&quot;, request.url())); log.info(String.format(&quot;请求类型: %s&quot;, Objects.requireNonNull(Objects.requireNonNull(request.body()).contentType()).toString())); return execute(request); &#125; /** * &lt;p&gt;post请求，字节流&lt;/p&gt; * * @param url * @param is * @return java.lang.String * @author hanqf * 2020/4/21 22:45 */ public static String post(String url, InputStream is) &#123; ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream(); byte[] buffer = new byte[1024]; int ch; byte[] bytes = null; try &#123; while ((ch = is.read(buffer)) != -1) &#123; byteArrayOutputStream.write(buffer, 0, ch); &#125; bytes = byteArrayOutputStream.toByteArray(); byteArrayOutputStream.close(); &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; return post(url, bytes); &#125; /** * &lt;p&gt;post请求，文件传输&lt;/p&gt; * * @param url 请求url * @param files 文件列表 * @return java.lang.String * @author hanqf * 2020/4/18 23:52 */ public static String post(String url, File[] files) &#123; return post(url, new HashMap&lt;&gt;(), files); &#125; /** * &lt;p&gt;post请求，文件传输&lt;/p&gt; * * @param url 请求url * @param params 参数map * @param files 文件列表 * @return java.lang.String * @author hanqf * 2020/4/18 23:52 */ public static String post(String url, Map&lt;String, Object&gt; params, File[] files) &#123; MultipartBody.Builder builder = new MultipartBody.Builder() .setType(MultipartBody.FORM); int i = 1; try &#123; String filesKey = &quot;files&quot;; for (File file : files) &#123; //URLEncoder.encode(file.getName(), &quot;utf-8&quot;) //中文文件名使用encode，服务端使用decode解析 builder.addFormDataPart(filesKey, URLEncoder.encode(file.getName(), &quot;utf-8&quot;), RequestBody.create(file, MediaType.parse(&quot;multipart/form-data&quot;))); i++; &#125; for (String key : params.keySet()) &#123; builder.addFormDataPart(key, params.get(key).toString()); &#125; &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; RequestBody requestBody = builder.build(); Request request = new Request.Builder() .url(url) .post(requestBody) .build(); log.info(String.format(&quot;请求地址: [%s]&quot;, request.url())); if (params != null &amp;&amp; params.size() &gt; 0) &#123; JSONArray jArray = new JSONArray(); jArray.add(params); log.info(String.format(&quot;请求参数: %s&quot;, jArray.toJSONString())); &#125; if (files != null &amp;&amp; files.length &gt; 0) &#123; JSONArray jArray = new JSONArray(); jArray.add(files); log.info(String.format(&quot;请求参数: %s&quot;, jArray.toJSONString())); &#125; log.info(String.format(&quot;请求类型: %s&quot;, Objects.requireNonNull(Objects.requireNonNull(request.body()).contentType()).toString())); return execute(request); &#125; /** * This interceptor compresses the HTTP request body. Many webservers can&#x27;t handle this! */ private static class GzipRequestInterceptor implements Interceptor &#123; @NotNull @Override public Response intercept(Chain chain) throws IOException &#123; Request originalRequest = chain.request(); if (originalRequest.body() == null || originalRequest.header(&quot;Content-Encoding&quot;) != null) &#123; return chain.proceed(originalRequest); &#125; MediaType mediaType = Objects.requireNonNull(originalRequest.body()).contentType(); //对流和json开启压缩 if (mediaType != null &amp;&amp; (&quot;application/octet-stream&quot;.equals(mediaType.toString()) || &quot;application/json; charset=utf8&quot;.equals(mediaType.toString()))) &#123; Request compressedRequest = originalRequest.newBuilder() .header(&quot;Content-Encoding&quot;, &quot;gzip&quot;) .method(originalRequest.method(), gzip(originalRequest.body())) .build(); return chain.proceed(compressedRequest); &#125; return chain.proceed(originalRequest); &#125; private RequestBody gzip(final RequestBody body) &#123; return new RequestBody() &#123; @Override public MediaType contentType() &#123; return body.contentType(); &#125; @Override public long contentLength() &#123; return -1; // We don&#x27;t know the compressed length in advance! &#125; @Override public void writeTo(@NotNull BufferedSink sink) throws IOException &#123; BufferedSink gzipSink = Okio.buffer(new GzipSink(sink)); body.writeTo(gzipSink); gzipSink.close(); &#125; &#125;; &#125; &#125; /** * &lt;p&gt;重试拦截器&lt;/p&gt; */ private static class RetryIntercepter implements Interceptor &#123; private int maxRetry = 3;//最大重试次数，默认3次 private int retryNum = 0; public RetryIntercepter() &#123; &#125; public RetryIntercepter(int maxRetry) &#123; this.maxRetry = maxRetry; &#125; @NotNull @Override public Response intercept(Chain chain) throws IOException &#123; Request request = chain.request(); Response response = chain.proceed(request); while (!response.isSuccessful() &amp;&amp; retryNum &lt; maxRetry) &#123; retryNum++; response = chain.proceed(request); &#125; return response; &#125; &#125; /** * &lt;p&gt;Headers拦截器&lt;/p&gt; */ private static class HeadersLoggingInterceper implements Interceptor &#123; @NotNull @Override public Response intercept(@NotNull Chain chain) throws IOException &#123; Request request = chain.request(); Headers headers = request.headers(); StringBuilder stringBuffer = new StringBuilder(); for(int i=0;i&lt;headers.size();i++)&#123; stringBuffer.append(headers.name(i)).append(&quot;:&quot;).append(headers.value(i)).append(&quot;,&quot;); &#125; log.info(String.format(&quot;请求头信息: [%s]&quot;, stringBuffer.toString())); return chain.proceed(request); &#125; &#125;&#125; RestTemplateUtil123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386package org.example;import lombok.extern.slf4j.Slf4j;import org.springframework.core.io.FileSystemResource;import org.springframework.http.*;import org.springframework.http.client.ClientHttpRequestExecution;import org.springframework.http.client.ClientHttpRequestInterceptor;import org.springframework.http.client.ClientHttpResponse;import org.springframework.http.client.SimpleClientHttpRequestFactory;import org.springframework.util.LinkedMultiValueMap;import org.springframework.util.MultiValueMap;import org.springframework.web.client.RestTemplate;import java.io.*;import java.nio.charset.StandardCharsets;import java.util.ArrayList;import java.util.HashMap;import java.util.List;import java.util.Map;import java.util.zip.GZIPInputStream;import java.util.zip.GZIPOutputStream;/** * &lt;p&gt;RestTemplate工具类&lt;/p&gt; * Created by hanqf on 2020/4/22 16:54. */@Slf4jpublic class RestTemplateUtil &#123; private static final SimpleClientHttpRequestFactory factory = new SimpleClientHttpRequestFactory(); private static final RestTemplate restTemplate; static &#123; factory.setReadTimeout(5000);//单位为ms factory.setConnectTimeout(5000);//单位为ms //拦截器 List&lt;ClientHttpRequestInterceptor&gt; list = new ArrayList&lt;&gt;(); list.add(new RetryIntercepter()); //重试拦截器 list.add(new HeadersLoggingInterceper()); //header拦截器 restTemplate = new RestTemplate(factory); restTemplate.setInterceptors(list); &#125; public static String get(String url) &#123; return get(url, new HashMap&lt;&gt;()); &#125; /** * &lt;p&gt;get请求&lt;/p&gt; * * @param url * @param map * @return java.lang.String * @author hanqf * 2020/4/22 16:57 */ public static String get(String url, Map&lt;String, Object&gt; map) &#123; if (map.size() &gt; 0) &#123; StringBuilder stringBuffer = new StringBuilder(); stringBuffer.append(url); if (url.contains(&quot;?&quot;)) &#123; stringBuffer.append(&quot;&amp;&quot;); &#125; else &#123; stringBuffer.append(&quot;?&quot;); &#125; for (String key : map.keySet()) &#123; stringBuffer.append(key).append(&quot;=&quot;).append(map.get(key).toString()).append(&quot;&amp;&quot;); &#125; url = stringBuffer.toString(); &#125; return restTemplate.getForObject(url, String.class); &#125; public static byte[] getBytes(String url, Map&lt;String, Object&gt; map) &#123; if (map.size() &gt; 0) &#123; StringBuilder stringBuffer = new StringBuilder(); stringBuffer.append(url); if (url.contains(&quot;?&quot;)) &#123; stringBuffer.append(&quot;&amp;&quot;); &#125; else &#123; stringBuffer.append(&quot;?&quot;); &#125; for (String key : map.keySet()) &#123; stringBuffer.append(key).append(&quot;=&quot;).append(map.get(key).toString()).append(&quot;&amp;&quot;); &#125; url = stringBuffer.toString(); &#125; //return restTemplate.getForObject(url, byte[].class); ResponseEntity&lt;byte[]&gt; exchange = restTemplate.exchange(url, HttpMethod.GET, null, byte[].class); byte[] bytes = exchange.getBody(); //判断是否需要解压，即服务器返回是否经过了gzip压缩--start List&lt;String&gt; strings = exchange.getHeaders().get(&quot;Content-Encoding&quot;); if (strings != null &amp;&amp; strings.contains(&quot;gzip&quot;)) &#123; GZIPInputStream gzipInputStream = null; ByteArrayOutputStream out = null; try &#123; gzipInputStream = new GZIPInputStream(new ByteArrayInputStream(bytes)); out = new ByteArrayOutputStream(); byte[] buffer = new byte[1024]; int offset = -1; while ((offset = gzipInputStream.read(buffer)) != -1) &#123; out.write(buffer, 0, offset); &#125; bytes = out.toByteArray(); &#125; catch (IOException e) &#123; e.printStackTrace(); &#125; finally &#123; try &#123; gzipInputStream.close(); out.close(); &#125; catch (IOException e) &#123; e.printStackTrace(); &#125; &#125; &#125; //判断是否需要解压，即服务器返回是否经过了gzip压缩--end return bytes; &#125; public static String post(String url) &#123; return post(url, new HashMap&lt;&gt;()); &#125; /** * &lt;p&gt;post请求&lt;/p&gt; * * @param url * @param params * @return java.lang.String * @author hanqf * 2020/4/22 16:59 */ public static String post(String url, Map&lt;String, Object&gt; params) &#123; MultiValueMap&lt;String, Object&gt; map = new LinkedMultiValueMap&lt;&gt;(); if (params != null &amp;&amp; params.size() &gt; 0) &#123; map.setAll(params); &#125; HttpHeaders headers = new HttpHeaders(); headers.setContentType(MediaType.APPLICATION_FORM_URLENCODED); HttpEntity&lt;MultiValueMap&lt;String, Object&gt;&gt; httpEntity = new HttpEntity&lt;&gt;(map, headers); return restTemplate.postForObject(url, httpEntity, String.class); &#125; public static byte[] postBytes(String url, Map&lt;String, Object&gt; params) &#123; MultiValueMap&lt;String, Object&gt; map = new LinkedMultiValueMap&lt;&gt;(); if (params != null &amp;&amp; params.size() &gt; 0) &#123; map.setAll(params); &#125; HttpHeaders headers = new HttpHeaders(); headers.setContentType(MediaType.APPLICATION_FORM_URLENCODED); HttpEntity&lt;MultiValueMap&lt;String, Object&gt;&gt; httpEntity = new HttpEntity&lt;&gt;(map, headers); //byte[] bytes = restTemplate.postForObject(url, httpEntity, byte[].class); ResponseEntity&lt;byte[]&gt; exchange = restTemplate.exchange(url, HttpMethod.POST, httpEntity, byte[].class); byte[] bytes = exchange.getBody(); //判断是否需要解压，即服务器返回是否经过了gzip压缩--start List&lt;String&gt; strings = exchange.getHeaders().get(&quot;Content-Encoding&quot;); if (strings != null &amp;&amp; strings.contains(&quot;gzip&quot;)) &#123; GZIPInputStream gzipInputStream = null; ByteArrayOutputStream out = null; try &#123; gzipInputStream = new GZIPInputStream(new ByteArrayInputStream(bytes)); out = new ByteArrayOutputStream(); byte[] buffer = new byte[1024]; int offset = -1; while ((offset = gzipInputStream.read(buffer)) != -1) &#123; out.write(buffer, 0, offset); &#125; bytes = out.toByteArray(); &#125; catch (IOException e) &#123; e.printStackTrace(); &#125; finally &#123; try &#123; gzipInputStream.close(); out.close(); &#125; catch (IOException e) &#123; e.printStackTrace(); &#125; &#125; &#125; //判断是否需要解压，即服务器返回是否经过了gzip压缩--end return bytes; &#125; public static String postJson(String url, String json) &#123; return postJson(url, json, false); &#125; /** * &lt;p&gt;post请求json&lt;/p&gt; * * @param url * @param json * @return java.lang.String * @author hanqf * 2020/4/22 17:04 */ public static String postJson(String url, String json, boolean gzip) &#123; HttpHeaders headers = new HttpHeaders(); if (gzip) &#123; headers.setContentType(new MediaType(&quot;application&quot;, &quot;octet-stream&quot;)); HttpEntity&lt;byte[]&gt; httpEntity = null; try &#123; headers.add(&quot;Content-Encoding&quot;, &quot;gzip&quot;); ByteArrayOutputStream originalContent = new ByteArrayOutputStream(); originalContent.write(json.getBytes(StandardCharsets.UTF_8)); ByteArrayOutputStream baos = new ByteArrayOutputStream(); GZIPOutputStream gzipOut = new GZIPOutputStream(baos); originalContent.writeTo(gzipOut); gzipOut.finish(); httpEntity = new HttpEntity&lt;&gt;(baos.toByteArray(), headers); &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; return restTemplate.postForObject(url, httpEntity, String.class); &#125; else &#123; headers.setContentType(new MediaType(&quot;application&quot;, &quot;json&quot;, StandardCharsets.UTF_8)); //headers.add(&quot;Content-Type&quot;, &quot;application/json;charset=utf8&quot;); HttpEntity&lt;String&gt; httpEntity = new HttpEntity&lt;&gt;(json, headers); return restTemplate.postForObject(url, httpEntity, String.class); &#125; &#125; public static String postBytes(String url, byte[] bytes) &#123; return postBytes(url, bytes, false); &#125; /** * &lt;p&gt;post字节流&lt;/p&gt; * * @param url * @param bytes * @param gzip * @return java.lang.String * @author hanqf * 2020/4/22 17:10 */ public static String postBytes(String url, byte[] bytes, boolean gzip) &#123; HttpHeaders headers = new HttpHeaders(); headers.setContentType(new MediaType(&quot;application&quot;, &quot;octet-stream&quot;)); HttpEntity&lt;byte[]&gt; httpEntity = null; if (gzip) &#123; try &#123; headers.add(&quot;Content-Encoding&quot;, &quot;gzip&quot;); ByteArrayOutputStream originalContent = new ByteArrayOutputStream(); originalContent.write(bytes); ByteArrayOutputStream baos = new ByteArrayOutputStream(); GZIPOutputStream gzipOut = new GZIPOutputStream(baos); originalContent.writeTo(gzipOut); gzipOut.finish(); httpEntity = new HttpEntity&lt;&gt;(baos.toByteArray(), headers); &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; &#125; else &#123; httpEntity = new HttpEntity&lt;&gt;(bytes, headers); &#125; return restTemplate.postForObject(url, httpEntity, String.class); &#125; public static String postStream(String url, InputStream is) &#123; return postStream(url, is, false); &#125; /** * &lt;p&gt;post请求，流&lt;/p&gt; * * @param url * @param is * @param gzip * @return java.lang.String * @author hanqf * 2020/4/22 17:12 */ public static String postStream(String url, InputStream is, boolean gzip) &#123; ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream(); byte[] buffer = new byte[1024]; int ch; byte[] bytes = null; try &#123; while ((ch = is.read(buffer)) != -1) &#123; byteArrayOutputStream.write(buffer, 0, ch); &#125; bytes = byteArrayOutputStream.toByteArray(); byteArrayOutputStream.close(); &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; return postBytes(url, bytes, gzip); &#125; public static String postFiles(String url, File[] files) &#123; return postFiles(url, new HashMap&lt;&gt;(), files); &#125; /** * &lt;p&gt;post请求，传输文件&lt;/p&gt; * * @param url * @param params * @param files * @return java.lang.String * @author hanqf * 2020/4/22 17:16 */ public static String postFiles(String url, Map&lt;String, Object&gt; params, File[] files) &#123; MultiValueMap&lt;String, Object&gt; map = new LinkedMultiValueMap&lt;&gt;(); if (params != null &amp;&amp; params.size() &gt; 0) &#123; map.setAll(params); &#125; for (File file : files) &#123; map.add(&quot;files&quot;, new FileSystemResource(file)); &#125; return restTemplate.postForObject(url, map, String.class); &#125; /** * &lt;p&gt;重试拦截器&lt;/p&gt; */ private static class RetryIntercepter implements ClientHttpRequestInterceptor &#123; private int maxRetry = 3;//最大重试次数，默认3次 private int retryNum = 0; public RetryIntercepter() &#123; &#125; public RetryIntercepter(int maxRetry) &#123; this.maxRetry = maxRetry; &#125; @Override public ClientHttpResponse intercept(HttpRequest httpRequest, byte[] bytes, ClientHttpRequestExecution clientHttpRequestExecution) throws IOException &#123; ClientHttpResponse response = clientHttpRequestExecution.execute(httpRequest, bytes); if (!response.getStatusCode().equals(HttpStatus.OK) &amp;&amp; retryNum &lt; maxRetry) &#123; retryNum++; response = clientHttpRequestExecution.execute(httpRequest, bytes); &#125; return response; &#125; &#125; /** * &lt;p&gt;Headers拦截器&lt;/p&gt; */ private static class HeadersLoggingInterceper implements ClientHttpRequestInterceptor &#123; @Override public ClientHttpResponse intercept(HttpRequest httpRequest, byte[] bytes, ClientHttpRequestExecution clientHttpRequestExecution) throws IOException &#123; log.info(String.format(&quot;请求地址: %s&quot;, httpRequest.getURI())); log.info(String.format(&quot;请求头信息: %s&quot;, httpRequest.getHeaders())); ClientHttpResponse response = clientHttpRequestExecution.execute(httpRequest, bytes); log.info(String.format(&quot;响应头信息: %s&quot;, response.getHeaders())); return response; &#125; &#125;&#125; WebClientUtil123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389package org.example;import io.netty.channel.ChannelOption;import io.netty.handler.timeout.ReadTimeoutHandler;import io.netty.handler.timeout.WriteTimeoutHandler;import lombok.extern.slf4j.Slf4j;import org.springframework.core.io.FileSystemResource;import org.springframework.http.HttpStatus;import org.springframework.http.MediaType;import org.springframework.http.client.reactive.ClientHttpConnector;import org.springframework.http.client.reactive.ReactorClientHttpConnector;import org.springframework.http.client.reactive.ReactorResourceFactory;import org.springframework.util.LinkedMultiValueMap;import org.springframework.util.MultiValueMap;import org.springframework.web.reactive.function.client.ClientResponse;import org.springframework.web.reactive.function.client.WebClient;import reactor.core.publisher.Mono;import reactor.netty.http.client.HttpClient;import reactor.netty.resources.ConnectionProvider;import reactor.netty.resources.LoopResources;import java.io.*;import java.nio.charset.StandardCharsets;import java.util.HashMap;import java.util.List;import java.util.Map;import java.util.function.Function;import java.util.zip.GZIPInputStream;import java.util.zip.GZIPOutputStream;/** * &lt;p&gt;&lt;/p&gt; * Created by hanqf on 2020/4/23 21:33. */@Slf4jpublic class WebClientUtil &#123; private static final ReactorResourceFactory factory = new ReactorResourceFactory(); private static final WebClient webClient; static &#123; factory.setUseGlobalResources(false); factory.setConnectionProvider(ConnectionProvider.create(&quot;httpClient&quot;, 50)); factory.setLoopResources(LoopResources.create(&quot;httpClient&quot;, 50, true)); Function&lt;HttpClient, HttpClient&gt; mapper = client -&gt; client.tcpConfiguration(c -&gt; c.option(ChannelOption.CONNECT_TIMEOUT_MILLIS, 5000) .option(ChannelOption.TCP_NODELAY, true) .doOnConnected(conn -&gt; &#123; conn.addHandlerLast(new ReadTimeoutHandler(10)); conn.addHandlerLast(new WriteTimeoutHandler(10)); &#125;)); ClientHttpConnector connector = new ReactorClientHttpConnector(factory, mapper); webClient = WebClient.builder() .filter((request, next) -&gt; &#123; //过滤器，3次重试，header打印 log.info(String.format(&quot;请求地址: %s&quot;, request.url())); log.info(String.format(&quot;请求头信息: %s&quot;, request.headers())); Mono&lt;ClientResponse&gt; exchange = next.exchange(request).retry(3); ClientResponse clientResponse = exchange.block(); log.info(String.format(&quot;响应头信息: %s&quot;, clientResponse.headers().asHttpHeaders())); return exchange; &#125;) .clientConnector(connector).build(); &#125; public static String get(String url) &#123; return get(url, new HashMap&lt;&gt;()); &#125; /** * &lt;p&gt;get请求&lt;/p&gt; * * @param url * @param map * @return java.lang.String * @author hanqf * 2020/4/24 14:44 */ public static String get(String url, Map&lt;String, Object&gt; map) &#123; if (map.size() &gt; 0) &#123; StringBuilder stringBuffer = new StringBuilder(); stringBuffer.append(url); if (url.contains(&quot;?&quot;)) &#123; stringBuffer.append(&quot;&amp;&quot;); &#125; else &#123; stringBuffer.append(&quot;?&quot;); &#125; for (String key : map.keySet()) &#123; stringBuffer.append(key).append(&quot;=&quot;).append(map.get(key).toString()).append(&quot;&amp;&quot;); &#125; url = stringBuffer.toString(); &#125; String responseResult = null; Mono&lt;String&gt; mono = webClient.get().uri(url).retrieve().bodyToMono(String.class); responseResult = mono.block(); return responseResult; &#125; public static byte[] getBytes(String url, Map&lt;String, Object&gt; map) &#123; if (map.size() &gt; 0) &#123; StringBuilder stringBuffer = new StringBuilder(); stringBuffer.append(url); if (url.contains(&quot;?&quot;)) &#123; stringBuffer.append(&quot;&amp;&quot;); &#125; else &#123; stringBuffer.append(&quot;?&quot;); &#125; for (String key : map.keySet()) &#123; stringBuffer.append(key).append(&quot;=&quot;).append(map.get(key).toString()).append(&quot;&amp;&quot;); &#125; url = stringBuffer.toString(); &#125; byte[] bytes = null; Mono&lt;ClientResponse&gt; exchange = webClient.get().uri(url).exchange(); ClientResponse response = exchange.block(); if (response.statusCode() == HttpStatus.OK) &#123; Mono&lt;byte[]&gt; mono = response.bodyToMono(byte[].class); bytes = mono.block(); //判断是否需要解压，即服务器返回是否经过了gzip压缩--start List&lt;String&gt; header = response.headers().header(&quot;Content-Encoding&quot;); if (header.contains(&quot;gzip&quot;)) &#123; GZIPInputStream gzipInputStream = null; ByteArrayOutputStream out = null; try &#123; gzipInputStream = new GZIPInputStream(new ByteArrayInputStream(bytes)); out = new ByteArrayOutputStream(); byte[] buffer = new byte[1024]; int offset = -1; while ((offset = gzipInputStream.read(buffer)) != -1) &#123; out.write(buffer, 0, offset); &#125; bytes = out.toByteArray(); &#125; catch (IOException e) &#123; e.printStackTrace(); &#125; finally &#123; try &#123; gzipInputStream.close(); out.close(); &#125; catch (IOException e) &#123; e.printStackTrace(); &#125; &#125; &#125; //判断是否需要解压，即服务器返回是否经过了gzip压缩--end &#125; return bytes; &#125; public static String post(String url) &#123; return post(url, new HashMap&lt;&gt;()); &#125; /** * &lt;p&gt;post请求&lt;/p&gt; * * @param url * @param params * @return java.lang.String * @author hanqf * 2020/4/24 14:43 */ public static String post(String url, Map&lt;String, Object&gt; params) &#123; MultiValueMap&lt;String, Object&gt; map = new LinkedMultiValueMap&lt;&gt;(); if (params != null &amp;&amp; params.size() &gt; 0) &#123; map.setAll(params); &#125; String responseResult = null; Mono&lt;String&gt; mono = webClient.post().uri(url).bodyValue(map).retrieve().bodyToMono(String.class); responseResult = mono.block(); return responseResult; &#125; public static byte[] postBytes(String url, Map&lt;String, Object&gt; params) &#123; MultiValueMap&lt;String, Object&gt; map = new LinkedMultiValueMap&lt;&gt;(); if (params != null &amp;&amp; params.size() &gt; 0) &#123; map.setAll(params); &#125; byte[] bytes = null; Mono&lt;ClientResponse&gt; exchange = webClient.post().uri(url).bodyValue(map).exchange(); ClientResponse response = exchange.block(); if (response.statusCode() == HttpStatus.OK) &#123; Mono&lt;byte[]&gt; mono = response.bodyToMono(byte[].class); bytes = mono.block(); //判断是否需要解压，即服务器返回是否经过了gzip压缩--start List&lt;String&gt; header = response.headers().header(&quot;Content-Encoding&quot;); if (header.contains(&quot;gzip&quot;)) &#123; GZIPInputStream gzipInputStream = null; ByteArrayOutputStream out = null; try &#123; gzipInputStream = new GZIPInputStream(new ByteArrayInputStream(bytes)); out = new ByteArrayOutputStream(); byte[] buffer = new byte[1024]; int offset; while ((offset = gzipInputStream.read(buffer)) != -1) &#123; out.write(buffer, 0, offset); &#125; bytes = out.toByteArray(); &#125; catch (IOException e) &#123; e.printStackTrace(); &#125; finally &#123; try &#123; gzipInputStream.close(); out.close(); &#125; catch (IOException e) &#123; e.printStackTrace(); &#125; &#125; &#125; //判断是否需要解压，即服务器返回是否经过了gzip压缩--end &#125; return bytes; &#125; /** * &lt;p&gt;post请求，form表单提交&lt;/p&gt; * * @param url * @param params 这里要注意将参数值转为字符串，否则会报类型错误 * @return java.lang.String * @author hanqf * 2020/4/24 14:43 */ public static String postForm(String url, Map&lt;String, Object&gt; params) &#123; MultiValueMap&lt;String, Object&gt; map = new LinkedMultiValueMap&lt;&gt;(); if (params != null &amp;&amp; params.size() &gt; 0) &#123; for (String key : params.keySet()) &#123; map.add(key, params.get(key).toString()); &#125; &#125; String responseResult; Mono&lt;String&gt; mono = webClient.post().uri(url).contentType(MediaType.APPLICATION_FORM_URLENCODED).bodyValue(map).retrieve().bodyToMono(String.class); responseResult = mono.block(); return responseResult; &#125; public static String postJson(String url, String json) &#123; return postJson(url, json, false); &#125; /** * &lt;p&gt;post请求，json&lt;/p&gt; * * @param url * @param json * @param gzip * @return java.lang.String * @author hanqf * 2020/4/24 15:45 */ public static String postJson(String url, String json, boolean gzip) &#123; String responseResult; if (gzip) &#123; byte[] bytes = json.getBytes(StandardCharsets.UTF_8); return postBytes(url, bytes, true); &#125; else &#123; Mono&lt;String&gt; mono = webClient.post().uri(url).contentType(MediaType.APPLICATION_JSON).bodyValue(json).retrieve().bodyToMono(String.class); responseResult = mono.block(); &#125; return responseResult; &#125; public static String postBytes(String url, byte[] bytes) &#123; return postBytes(url, bytes, false); &#125; /** * &lt;p&gt;post请求，字节流&lt;/p&gt; * * @param url * @param bytes * @param gzip * @return java.lang.String * @author hanqf * 2020/4/24 15:45 */ public static String postBytes(String url, byte[] bytes, boolean gzip) &#123; String responseResult; Mono&lt;String&gt; mono = null; WebClient.RequestBodySpec requestBodySpec = webClient.post().uri(url).contentType(MediaType.APPLICATION_OCTET_STREAM); if (gzip) &#123; try &#123; //headers.add(&quot;Content-Encoding&quot;, &quot;gzip&quot;); ByteArrayOutputStream originalContent = new ByteArrayOutputStream(); originalContent.write(bytes); ByteArrayOutputStream baos = new ByteArrayOutputStream(); GZIPOutputStream gzipOut = new GZIPOutputStream(baos); originalContent.writeTo(gzipOut); gzipOut.finish(); bytes = baos.toByteArray(); mono = requestBodySpec.header(&quot;Content-Encoding&quot;, &quot;gzip&quot;).bodyValue(bytes).retrieve().bodyToMono(String.class); &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; &#125; else &#123; mono = requestBodySpec.bodyValue(bytes).retrieve().bodyToMono(String.class); &#125; responseResult = mono.block(); return responseResult; &#125; public static String postStream(String url, InputStream is) &#123; return postStream(url, is, false); &#125; /** * &lt;p&gt;post请求，流&lt;/p&gt; * * @param url * @param is * @param gzip * @return java.lang.String * @author hanqf * 2020/4/22 17:12 */ public static String postStream(String url, InputStream is, boolean gzip) &#123; ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream(); byte[] buffer = new byte[1024]; int ch; byte[] bytes = null; try &#123; while ((ch = is.read(buffer)) != -1) &#123; byteArrayOutputStream.write(buffer, 0, ch); &#125; bytes = byteArrayOutputStream.toByteArray(); byteArrayOutputStream.close(); &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; return postBytes(url, bytes, gzip); &#125; public static String postFiles(String url, File[] files) &#123; return postFiles(url, new HashMap&lt;&gt;(), files); &#125; /** * &lt;p&gt;post请求，文件&lt;/p&gt; * * @param url * @param params * @param files * @return java.lang.String * @author hanqf * 2020/4/24 15:46 */ public static String postFiles(String url, Map&lt;String, Object&gt; params, File[] files) &#123; String responseResult; MultiValueMap&lt;String, Object&gt; map = new LinkedMultiValueMap&lt;&gt;(); if (params != null &amp;&amp; params.size() &gt; 0) &#123; map.setAll(params); &#125; for (File file : files) &#123; map.add(&quot;files&quot;, new FileSystemResource(file)); &#125; Mono&lt;String&gt; mono = webClient.post().uri(url).contentType(MediaType.MULTIPART_FORM_DATA).bodyValue(map).retrieve().bodyToMono(String.class); responseResult = mono.block(); return responseResult; &#125;&#125;","summary":"摘要 本文内容基于org.apache.httpcomponents:httpclient:4.5.12，com.squareup.okhttp3:okhttp:4.5.0，springboot:2.2.6.RELEASE，spring-boot-starter-webflux:2.2.6.RELEASE 工具类，实现get/post[参数，json，输入流，文件，gzip]等方法 提供了测试用例及服务端demo github：https://github.com/hanqunfeng/springbootchapter/tree/master/chapter26","date_published":"2020-04-18T15:20:15.000Z","tags":["技术","http"]},{"id":"https://blog.hanqunfeng.com/2020/04/17/spring-boot-ExternalPropertiesRefresh/","url":"https://blog.hanqunfeng.com/2020/04/17/spring-boot-ExternalPropertiesRefresh/","title":"SpringBoot动态更新外部属性文件","content_html":"<h2 id=\"摘要\"><a href=\"#摘要\" class=\"headerlink\" title=\"摘要\"></a>摘要</h2><ul>\n<li>本文内容基于springboot2.2.6</li>\n<li>SpringBoot可以通过<code>@PropertySource(value = &quot;file:demo.properties&quot;)</code>的方式加载外部配置文件，这样打好jar包后只要将这个属性文件放到相同路径即可</li>\n<li>如果能够在不重启服务的情况下就可以重新加载这个属性文件，就可以很方便的实现动态更新，那么要怎么做呢？</li>\n<li>github：<a href=\"https://github.com/hanqunfeng/springbootchapter/tree/master/chapter27\">https://github.com/hanqunfeng/springbootchapter/tree/master/chapter27</a></li>\n</ul>\n<span id=\"more\"></span>\n\n<h2 id=\"思路\"><a href=\"#思路\" class=\"headerlink\" title=\"思路\"></a>思路</h2><div class=\"note info\"><p>SpringCloud可以通过config组件实现配置的动态加载，我们也可以将数据存在数据库或者缓存中，可是如果只是一个小项目，不想依赖任何中间件，那么就可以通过如下的方式实现。</p>\n</div>\n\n<ul>\n<li>获取所有注解了<code>@PropertySource</code>的对象，并且获取其value属性数组中是以<code>file:</code>开头的文件路径</li>\n<li>判断是否同时注解了<code>@ConfigurationProperties</code>，并且获取其<code>prefix</code>的值</li>\n<li>对每个属性文件进行遍历，通过反射找到对象的field名称（去除<code>prefix</code>后的名字），并将属性值赋值给该field</li>\n</ul>\n<h2 id=\"代码\"><a href=\"#代码\" class=\"headerlink\" title=\"代码\"></a>代码</h2><div class=\"note info\"><p>这个类要注册到spring上下文，并在需要的地方调用该对象的refresh方法即可重新加载所有外部属性文件。</p>\n</div>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> lombok.SneakyThrows;</span><br><span class=\"line\"><span class=\"keyword\">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.beans.factory.config.ConfigurableListableBeanFactory;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.PropertySource;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.core.io.FileSystemResource;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.core.io.support.PropertiesLoaderUtils;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.stereotype.Component;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.util.StringUtils;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.lang.annotation.Annotation;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.lang.reflect.Method;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.*;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * &lt;p&gt;动态加载外部属性处理类&lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"meta\">@Slf4j</span></span><br><span class=\"line\"><span class=\"meta\">@Component</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ExternalPropertiesRefresh</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> ConfigurableListableBeanFactory configurableListableBeanFactory;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;p&gt;根据属性名获取属性值&lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> fieldName bean的属性名称</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> object    bean对象</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> java.lang.Object get方法返回值</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@author</span> hanqf</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> Object <span class=\"title\">getFieldValueByName</span><span class=\"params\">(String fieldName, Object object)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            String firstLetter = fieldName.substring(<span class=\"number\">0</span>, <span class=\"number\">1</span>).toUpperCase();</span><br><span class=\"line\">            String getter = <span class=\"string\">&quot;get&quot;</span> + firstLetter + fieldName.substring(<span class=\"number\">1</span>);</span><br><span class=\"line\">            Method method = object.getClass().getMethod(getter, <span class=\"keyword\">new</span> Class[]&#123;&#125;);</span><br><span class=\"line\">            Object value = method.invoke(object, <span class=\"keyword\">new</span> Object[]&#123;&#125;);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> value;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">            log.error(e.getMessage(), e);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;p&gt;根据属性名设置属性值&lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> fieldName  bean的属性名称</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> object     bean对象</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> paramTypes set方法参数类型</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> params     set方法参数值</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@author</span> hanqf</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">setFieldValueByName</span><span class=\"params\">(String fieldName, Object object, Class[] paramTypes, Object[] params)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            String firstLetter = fieldName.substring(<span class=\"number\">0</span>, <span class=\"number\">1</span>).toUpperCase();</span><br><span class=\"line\">            String setter = <span class=\"string\">&quot;set&quot;</span> + firstLetter + fieldName.substring(<span class=\"number\">1</span>);</span><br><span class=\"line\">            Method method = object.getClass().getMethod(setter, paramTypes);</span><br><span class=\"line\">            method.invoke(object, params);</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">            log.error(e.getMessage(), e);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;p&gt;获取属性名称，去除前缀&lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> key   属性key</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> prefix 属性key前缀</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> java.lang.String</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@author</span> hanqf</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> String <span class=\"title\">fieldName</span><span class=\"params\">(String key, String prefix)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (StringUtils.hasText(prefix)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> key.replace(prefix + <span class=\"string\">&quot;.&quot;</span>, <span class=\"string\">&quot;&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> key;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;p&gt;将属性文件值绑定到bean对象&lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> bean</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> properties</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> prefix</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@author</span> hanqf</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> Object <span class=\"title\">bind</span><span class=\"params\">(Object bean, Properties[] properties, String prefix)</span> </span>&#123;</span><br><span class=\"line\">        String fieldName = <span class=\"string\">&quot;&quot;</span>;<span class=\"comment\">//属性名称</span></span><br><span class=\"line\">        String pValue = <span class=\"string\">&quot;&quot;</span>;<span class=\"comment\">//属性值</span></span><br><span class=\"line\">        String[] sp = <span class=\"keyword\">null</span>; <span class=\"comment\">//map属性分割key和value</span></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (Properties pro : properties) &#123;</span><br><span class=\"line\">            Map&lt;String, Map&lt;String, String&gt;&gt; fidleMap = <span class=\"keyword\">new</span> HashMap&lt;&gt;();</span><br><span class=\"line\">            Map&lt;String, Set&lt;String&gt;&gt; fidleSet = <span class=\"keyword\">new</span> HashMap&lt;&gt;();</span><br><span class=\"line\">            Map&lt;String, List&lt;String&gt;&gt; fidleList = <span class=\"keyword\">new</span> HashMap&lt;&gt;();</span><br><span class=\"line\">            <span class=\"comment\">//遍历属性</span></span><br><span class=\"line\">            <span class=\"keyword\">for</span> (Object key : pro.keySet()) &#123;</span><br><span class=\"line\">                pValue = (String) (pro.get(key));</span><br><span class=\"line\">                fieldName = fieldName((String) key, prefix);</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"comment\">//map</span></span><br><span class=\"line\">                sp = fieldName.split(<span class=\"string\">&quot;\\\\.&quot;</span>);</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (sp.length == <span class=\"number\">2</span>) &#123;</span><br><span class=\"line\">                    fieldName = sp[<span class=\"number\">0</span>];</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"comment\">//list&amp;&amp;set</span></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (fieldName.indexOf(<span class=\"string\">&quot;[&quot;</span>) &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                    fieldName = fieldName.substring(<span class=\"number\">0</span>, fieldName.indexOf(<span class=\"string\">&quot;[&quot;</span>));</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"comment\">//属性类型</span></span><br><span class=\"line\">                Object object = getFieldValueByName(fieldName, bean);</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"comment\">//类型匹配</span></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (object <span class=\"keyword\">instanceof</span> Map) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (fidleMap.get(fieldName) != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                        object = fidleMap.get(fieldName);</span><br><span class=\"line\">                    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                        object = <span class=\"keyword\">new</span> HashMap&lt;String, String&gt;();</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (sp.length == <span class=\"number\">2</span>) &#123;</span><br><span class=\"line\">                        ((Map) object).put(sp[<span class=\"number\">1</span>], pValue);</span><br><span class=\"line\">                        fidleMap.put(fieldName, (Map&lt;String, String&gt;) object);</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (object <span class=\"keyword\">instanceof</span> Set) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (fidleSet.get(fieldName) != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                        object = fidleSet.get(fieldName);</span><br><span class=\"line\">                    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                        object = <span class=\"keyword\">new</span> HashSet&lt;String&gt;();</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                    ((Set) object).add(pValue);</span><br><span class=\"line\">                    fidleSet.put(fieldName, (Set&lt;String&gt;) object);</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (object <span class=\"keyword\">instanceof</span> List) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (fidleList.get(fieldName) != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                        object = fidleList.get(fieldName);</span><br><span class=\"line\">                    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                        object = <span class=\"keyword\">new</span> ArrayList&lt;String&gt;();</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                    ((List) object).add(pValue);</span><br><span class=\"line\">                    fidleList.put(fieldName, (List&lt;String&gt;) object);</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (object <span class=\"keyword\">instanceof</span> String) &#123;</span><br><span class=\"line\">                    setFieldValueByName(fieldName, bean, <span class=\"keyword\">new</span> Class[]&#123;String.class&#125;, <span class=\"keyword\">new</span> Object[]&#123;pValue&#125;);</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (object <span class=\"keyword\">instanceof</span> Integer) &#123;</span><br><span class=\"line\">                    setFieldValueByName(fieldName, bean, <span class=\"keyword\">new</span> Class[]&#123;Integer.class&#125;, <span class=\"keyword\">new</span> Object[]&#123;Integer.valueOf(pValue)&#125;);</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (object <span class=\"keyword\">instanceof</span> Long) &#123;</span><br><span class=\"line\">                    setFieldValueByName(fieldName, bean, <span class=\"keyword\">new</span> Class[]&#123;Long.class&#125;, <span class=\"keyword\">new</span> Object[]&#123;Long.valueOf(pValue)&#125;);</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (object <span class=\"keyword\">instanceof</span> Double) &#123;</span><br><span class=\"line\">                    setFieldValueByName(fieldName, bean, <span class=\"keyword\">new</span> Class[]&#123;Double.class&#125;, <span class=\"keyword\">new</span> Object[]&#123;Double.valueOf(pValue)&#125;);</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (object <span class=\"keyword\">instanceof</span> Float) &#123;</span><br><span class=\"line\">                    setFieldValueByName(fieldName, bean, <span class=\"keyword\">new</span> Class[]&#123;Float.class&#125;, <span class=\"keyword\">new</span> Object[]&#123;Float.valueOf(pValue)&#125;);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//map类型赋值</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (fidleMap.size() &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">for</span> (String fname : fidleMap.keySet()) &#123;</span><br><span class=\"line\">                    setFieldValueByName(fname, bean, <span class=\"keyword\">new</span> Class[]&#123;Map.class&#125;, <span class=\"keyword\">new</span> Object[]&#123;fidleMap.get(fname)&#125;);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//set类型赋值</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (fidleSet.size() &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">for</span> (String fname : fidleSet.keySet()) &#123;</span><br><span class=\"line\">                    setFieldValueByName(fname, bean, <span class=\"keyword\">new</span> Class[]&#123;Set.class&#125;, <span class=\"keyword\">new</span> Object[]&#123;fidleSet.get(fname)&#125;);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//list类型赋值</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (fidleList.size() &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">for</span> (String fname : fidleList.keySet()) &#123;</span><br><span class=\"line\">                    setFieldValueByName(fname, bean, <span class=\"keyword\">new</span> Class[]&#123;List.class&#125;, <span class=\"keyword\">new</span> Object[]&#123;fidleList.get(fname)&#125;);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> bean;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;p&gt;刷新指定属性类&lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@author</span> hanqf</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> beanName bean的注册名称，默认类名称首字母小写</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@SneakyThrows</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">refresh</span><span class=\"params\">(String beanName)</span></span>&#123;</span><br><span class=\"line\">        Class&lt;?&gt; cls = configurableListableBeanFactory.getType(beanName);</span><br><span class=\"line\">        Object bean = configurableListableBeanFactory.getBean(cls);</span><br><span class=\"line\">        Properties[] propertiesArray = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        String prefix = <span class=\"string\">&quot;&quot;</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (cls.getAnnotations() != <span class=\"keyword\">null</span> &amp;&amp; cls.getAnnotations().length &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">for</span> (Annotation annotation : cls.getAnnotations()) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (annotation <span class=\"keyword\">instanceof</span> PropertySource) &#123;</span><br><span class=\"line\">                    PropertySource propertySource = (PropertySource) annotation;</span><br><span class=\"line\">                    String[] values = propertySource.value();</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (values.length &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                        propertiesArray = <span class=\"keyword\">new</span> Properties[values.length];</span><br><span class=\"line\">                        <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; values.length; i++) &#123;</span><br><span class=\"line\">                            <span class=\"comment\">//如果引用的是外部文件，则重新加载</span></span><br><span class=\"line\">                            <span class=\"keyword\">if</span> (values[i].startsWith(<span class=\"string\">&quot;file:&quot;</span>)) &#123;</span><br><span class=\"line\">                                String path = values[i].replace(<span class=\"string\">&quot;file:&quot;</span>, <span class=\"string\">&quot;&quot;</span>);</span><br><span class=\"line\">                                Properties properties = PropertiesLoaderUtils.loadProperties(<span class=\"keyword\">new</span> FileSystemResource(path));</span><br><span class=\"line\">                                propertiesArray[i] = properties;</span><br><span class=\"line\">                            &#125;</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (annotation <span class=\"keyword\">instanceof</span> ConfigurationProperties) &#123;</span><br><span class=\"line\">                    ConfigurationProperties configurationProperties = (ConfigurationProperties) annotation;</span><br><span class=\"line\">                    prefix = configurationProperties.prefix();</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (propertiesArray != <span class=\"keyword\">null</span> &amp;&amp; propertiesArray.length &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">//将属性绑定到对象</span></span><br><span class=\"line\">            bind(bean, propertiesArray, prefix);</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;p&gt;重新加载属性文件&lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@author</span> hanqf</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@SneakyThrows</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">refresh</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        String[] ary = configurableListableBeanFactory.getBeanNamesForAnnotation(PropertySource.class);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (ary != <span class=\"keyword\">null</span> &amp;&amp; ary.length &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">for</span> (String beanName : ary) &#123;</span><br><span class=\"line\">                <span class=\"comment\">//通过Spring的beanName获取bean的类型</span></span><br><span class=\"line\">                refresh(beanName);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"下面通过http请求刷新配置文件\"><a href=\"#下面通过http请求刷新配置文件\" class=\"headerlink\" title=\"下面通过http请求刷新配置文件\"></a>下面通过http请求刷新配置文件</h2><div class=\"note info\"><p>启动服务器后，任意修改属性文件的值，然后请求/refresh，即可重新加载全部属性文件，然后请求/demo查看是否生效，也可以请求/propertiesDemo/refresh，指定要刷新的对象。</p>\n</div>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@RestController</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">DemoController</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> ExternalPropertiesRefresh externalPropertiesRefresh;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> PropertiesDemo propertiesDemo;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@RequestMapping(&quot;/refresh&quot;)</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">refreshpro</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        externalPropertiesRefresh.refresh();</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">&quot;refresh properties success&quot;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@RequestMapping(&quot;/&#123;beanName&#125;/refresh&quot;)</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">refreshProByBeanName</span><span class=\"params\">(<span class=\"meta\">@PathVariable</span> String beanName)</span> </span>&#123;</span><br><span class=\"line\">        externalPropertiesRefresh.refresh(beanName);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">&quot;refresh properties success for &quot;</span> + beanName;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@RequestMapping(&quot;/demo&quot;)</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> PropertiesDemo <span class=\"title\">demo</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> propertiesDemo;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"PropertiesDemo-java\"><a href=\"#PropertiesDemo-java\" class=\"headerlink\" title=\"PropertiesDemo.java\"></a>PropertiesDemo.java</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Component</span></span><br><span class=\"line\"><span class=\"meta\">@PropertySource(value = &quot;file:demo.properties&quot;,encoding = &quot;utf-8&quot;)</span></span><br><span class=\"line\"><span class=\"meta\">@ConfigurationProperties(prefix = &quot;demo.data&quot;)</span></span><br><span class=\"line\"><span class=\"meta\">@Data</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">PropertiesDemo</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> Map&lt;String, String&gt; map = <span class=\"keyword\">new</span> HashMap&lt;&gt;();</span><br><span class=\"line\">    <span class=\"keyword\">private</span> Map&lt;String, String&gt; map2 = <span class=\"keyword\">new</span> HashMap&lt;&gt;();</span><br><span class=\"line\">    <span class=\"keyword\">private</span> Set&lt;String&gt; set = <span class=\"keyword\">new</span> HashSet&lt;&gt;();</span><br><span class=\"line\">    <span class=\"keyword\">private</span> Set&lt;String&gt; set2 = <span class=\"keyword\">new</span> HashSet&lt;&gt;();</span><br><span class=\"line\">    <span class=\"keyword\">private</span> List&lt;String&gt; list = <span class=\"keyword\">new</span> ArrayList&lt;&gt;();</span><br><span class=\"line\">    <span class=\"keyword\">private</span> List&lt;String&gt; list2 = <span class=\"keyword\">new</span> ArrayList&lt;&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> String name;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> Integer age;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> Double salary;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"demo-properties\"><a href=\"#demo-properties\" class=\"headerlink\" title=\"demo.properties\"></a>demo.properties</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">demo.data.map.client=client</span><br><span class=\"line\">demo.data.map.token=token</span><br><span class=\"line\"></span><br><span class=\"line\">demo.data.map2.client=client</span><br><span class=\"line\">demo.data.map2.token=token</span><br><span class=\"line\"></span><br><span class=\"line\">demo.data.name=张三</span><br><span class=\"line\">demo.data.age=<span class=\"number\">20</span></span><br><span class=\"line\">demo.data.salary=<span class=\"number\">12345.67</span></span><br><span class=\"line\"></span><br><span class=\"line\">demo.data.set[<span class=\"number\">0</span>]=beijing</span><br><span class=\"line\">demo.data.set[<span class=\"number\">1</span>]=shanghai</span><br><span class=\"line\">demo.data.set[<span class=\"number\">2</span>]=tianjin</span><br><span class=\"line\"></span><br><span class=\"line\">demo.data.set2[<span class=\"number\">0</span>]=guangzhou</span><br><span class=\"line\">demo.data.set2[<span class=\"number\">1</span>]=shenzheng</span><br><span class=\"line\">demo.data.set2[<span class=\"number\">2</span>]=hangzhou</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">demo.data.list[<span class=\"number\">0</span>]=南极</span><br><span class=\"line\">demo.data.list[<span class=\"number\">1</span>]=北极</span><br><span class=\"line\">demo.data.list[<span class=\"number\">2</span>]=赤道</span><br><span class=\"line\"></span><br><span class=\"line\">demo.data.list2[<span class=\"number\">0</span>]=喜马拉雅山</span><br><span class=\"line\">demo.data.list2[<span class=\"number\">1</span>]=噶麦斯山</span><br><span class=\"line\">demo.data.list2[<span class=\"number\">2</span>]=阿尔卑斯山</span><br></pre></td></tr></table></figure>\n","content_text":"摘要 本文内容基于springboot2.2.6 SpringBoot可以通过@PropertySource(value = &quot;file:demo.properties&quot;)的方式加载外部配置文件，这样打好jar包后只要将这个属性文件放到相同路径即可 如果能够在不重启服务的情况下就可以重新加载这个属性文件，就可以很方便的实现动态更新，那么要怎么做呢？ github：https://github.com/hanqunfeng/springbootchapter/tree/master/chapter27 思路SpringCloud可以通过config组件实现配置的动态加载，我们也可以将数据存在数据库或者缓存中，可是如果只是一个小项目，不想依赖任何中间件，那么就可以通过如下的方式实现。 获取所有注解了@PropertySource的对象，并且获取其value属性数组中是以file:开头的文件路径 判断是否同时注解了@ConfigurationProperties，并且获取其prefix的值 对每个属性文件进行遍历，通过反射找到对象的field名称（去除prefix后的名字），并将属性值赋值给该field 代码这个类要注册到spring上下文，并在需要的地方调用该对象的refresh方法即可重新加载所有外部属性文件。 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249import lombok.SneakyThrows;import lombok.extern.slf4j.Slf4j;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.beans.factory.config.ConfigurableListableBeanFactory;import org.springframework.boot.context.properties.ConfigurationProperties;import org.springframework.context.annotation.PropertySource;import org.springframework.core.io.FileSystemResource;import org.springframework.core.io.support.PropertiesLoaderUtils;import org.springframework.stereotype.Component;import org.springframework.util.StringUtils;import java.lang.annotation.Annotation;import java.lang.reflect.Method;import java.util.*;/** * &lt;p&gt;动态加载外部属性处理类&lt;/p&gt; */@Slf4j@Componentpublic class ExternalPropertiesRefresh &#123; @Autowired private ConfigurableListableBeanFactory configurableListableBeanFactory; /** * &lt;p&gt;根据属性名获取属性值&lt;/p&gt; * * @param fieldName bean的属性名称 * @param object bean对象 * @return java.lang.Object get方法返回值 * @author hanqf */ private Object getFieldValueByName(String fieldName, Object object) &#123; try &#123; String firstLetter = fieldName.substring(0, 1).toUpperCase(); String getter = &quot;get&quot; + firstLetter + fieldName.substring(1); Method method = object.getClass().getMethod(getter, new Class[]&#123;&#125;); Object value = method.invoke(object, new Object[]&#123;&#125;); return value; &#125; catch (Exception e) &#123; log.error(e.getMessage(), e); return null; &#125; &#125; /** * &lt;p&gt;根据属性名设置属性值&lt;/p&gt; * * @param fieldName bean的属性名称 * @param object bean对象 * @param paramTypes set方法参数类型 * @param params set方法参数值 * @author hanqf */ private void setFieldValueByName(String fieldName, Object object, Class[] paramTypes, Object[] params) &#123; try &#123; String firstLetter = fieldName.substring(0, 1).toUpperCase(); String setter = &quot;set&quot; + firstLetter + fieldName.substring(1); Method method = object.getClass().getMethod(setter, paramTypes); method.invoke(object, params); &#125; catch (Exception e) &#123; log.error(e.getMessage(), e); &#125; &#125; /** * &lt;p&gt;获取属性名称，去除前缀&lt;/p&gt; * * @param key 属性key * @param prefix 属性key前缀 * @return java.lang.String * @author hanqf */ private String fieldName(String key, String prefix) &#123; if (StringUtils.hasText(prefix)) &#123; return key.replace(prefix + &quot;.&quot;, &quot;&quot;); &#125; return key; &#125; /** * &lt;p&gt;将属性文件值绑定到bean对象&lt;/p&gt; * * @param bean * @param properties * @param prefix * @author hanqf */ private Object bind(Object bean, Properties[] properties, String prefix) &#123; String fieldName = &quot;&quot;;//属性名称 String pValue = &quot;&quot;;//属性值 String[] sp = null; //map属性分割key和value for (Properties pro : properties) &#123; Map&lt;String, Map&lt;String, String&gt;&gt; fidleMap = new HashMap&lt;&gt;(); Map&lt;String, Set&lt;String&gt;&gt; fidleSet = new HashMap&lt;&gt;(); Map&lt;String, List&lt;String&gt;&gt; fidleList = new HashMap&lt;&gt;(); //遍历属性 for (Object key : pro.keySet()) &#123; pValue = (String) (pro.get(key)); fieldName = fieldName((String) key, prefix); //map sp = fieldName.split(&quot;\\\\.&quot;); if (sp.length == 2) &#123; fieldName = sp[0]; &#125; //list&amp;&amp;set if (fieldName.indexOf(&quot;[&quot;) &gt; 0) &#123; fieldName = fieldName.substring(0, fieldName.indexOf(&quot;[&quot;)); &#125; //属性类型 Object object = getFieldValueByName(fieldName, bean); //类型匹配 if (object instanceof Map) &#123; if (fidleMap.get(fieldName) != null) &#123; object = fidleMap.get(fieldName); &#125; else &#123; object = new HashMap&lt;String, String&gt;(); &#125; if (sp.length == 2) &#123; ((Map) object).put(sp[1], pValue); fidleMap.put(fieldName, (Map&lt;String, String&gt;) object); &#125; &#125; else if (object instanceof Set) &#123; if (fidleSet.get(fieldName) != null) &#123; object = fidleSet.get(fieldName); &#125; else &#123; object = new HashSet&lt;String&gt;(); &#125; ((Set) object).add(pValue); fidleSet.put(fieldName, (Set&lt;String&gt;) object); &#125; else if (object instanceof List) &#123; if (fidleList.get(fieldName) != null) &#123; object = fidleList.get(fieldName); &#125; else &#123; object = new ArrayList&lt;String&gt;(); &#125; ((List) object).add(pValue); fidleList.put(fieldName, (List&lt;String&gt;) object); &#125; else if (object instanceof String) &#123; setFieldValueByName(fieldName, bean, new Class[]&#123;String.class&#125;, new Object[]&#123;pValue&#125;); &#125; else if (object instanceof Integer) &#123; setFieldValueByName(fieldName, bean, new Class[]&#123;Integer.class&#125;, new Object[]&#123;Integer.valueOf(pValue)&#125;); &#125; else if (object instanceof Long) &#123; setFieldValueByName(fieldName, bean, new Class[]&#123;Long.class&#125;, new Object[]&#123;Long.valueOf(pValue)&#125;); &#125; else if (object instanceof Double) &#123; setFieldValueByName(fieldName, bean, new Class[]&#123;Double.class&#125;, new Object[]&#123;Double.valueOf(pValue)&#125;); &#125; else if (object instanceof Float) &#123; setFieldValueByName(fieldName, bean, new Class[]&#123;Float.class&#125;, new Object[]&#123;Float.valueOf(pValue)&#125;); &#125; &#125; //map类型赋值 if (fidleMap.size() &gt; 0) &#123; for (String fname : fidleMap.keySet()) &#123; setFieldValueByName(fname, bean, new Class[]&#123;Map.class&#125;, new Object[]&#123;fidleMap.get(fname)&#125;); &#125; &#125; //set类型赋值 if (fidleSet.size() &gt; 0) &#123; for (String fname : fidleSet.keySet()) &#123; setFieldValueByName(fname, bean, new Class[]&#123;Set.class&#125;, new Object[]&#123;fidleSet.get(fname)&#125;); &#125; &#125; //list类型赋值 if (fidleList.size() &gt; 0) &#123; for (String fname : fidleList.keySet()) &#123; setFieldValueByName(fname, bean, new Class[]&#123;List.class&#125;, new Object[]&#123;fidleList.get(fname)&#125;); &#125; &#125; &#125; return bean; &#125; /** * &lt;p&gt;刷新指定属性类&lt;/p&gt; * @author hanqf * @param beanName bean的注册名称，默认类名称首字母小写 */ @SneakyThrows public void refresh(String beanName)&#123; Class&lt;?&gt; cls = configurableListableBeanFactory.getType(beanName); Object bean = configurableListableBeanFactory.getBean(cls); Properties[] propertiesArray = null; String prefix = &quot;&quot;; if (cls.getAnnotations() != null &amp;&amp; cls.getAnnotations().length &gt; 0) &#123; for (Annotation annotation : cls.getAnnotations()) &#123; if (annotation instanceof PropertySource) &#123; PropertySource propertySource = (PropertySource) annotation; String[] values = propertySource.value(); if (values.length &gt; 0) &#123; propertiesArray = new Properties[values.length]; for (int i = 0; i &lt; values.length; i++) &#123; //如果引用的是外部文件，则重新加载 if (values[i].startsWith(&quot;file:&quot;)) &#123; String path = values[i].replace(&quot;file:&quot;, &quot;&quot;); Properties properties = PropertiesLoaderUtils.loadProperties(new FileSystemResource(path)); propertiesArray[i] = properties; &#125; &#125; &#125; &#125; if (annotation instanceof ConfigurationProperties) &#123; ConfigurationProperties configurationProperties = (ConfigurationProperties) annotation; prefix = configurationProperties.prefix(); &#125; &#125; &#125; if (propertiesArray != null &amp;&amp; propertiesArray.length &gt; 0) &#123; //将属性绑定到对象 bind(bean, propertiesArray, prefix); &#125; &#125; /** * &lt;p&gt;重新加载属性文件&lt;/p&gt; * * @author hanqf */ @SneakyThrows public void refresh() &#123; String[] ary = configurableListableBeanFactory.getBeanNamesForAnnotation(PropertySource.class); if (ary != null &amp;&amp; ary.length &gt; 0) &#123; for (String beanName : ary) &#123; //通过Spring的beanName获取bean的类型 refresh(beanName); &#125; &#125; &#125;&#125; 下面通过http请求刷新配置文件启动服务器后，任意修改属性文件的值，然后请求/refresh，即可重新加载全部属性文件，然后请求/demo查看是否生效，也可以请求/propertiesDemo/refresh，指定要刷新的对象。 123456789101112131415161718192021222324252627@RestControllerpublic class DemoController &#123; @Autowired private ExternalPropertiesRefresh externalPropertiesRefresh; @Autowired private PropertiesDemo propertiesDemo; @RequestMapping(&quot;/refresh&quot;) public String refreshpro() &#123; externalPropertiesRefresh.refresh(); return &quot;refresh properties success&quot;; &#125; @RequestMapping(&quot;/&#123;beanName&#125;/refresh&quot;) public String refreshProByBeanName(@PathVariable String beanName) &#123; externalPropertiesRefresh.refresh(beanName); return &quot;refresh properties success for &quot; + beanName; &#125; @RequestMapping(&quot;/demo&quot;) public PropertiesDemo demo() &#123; return propertiesDemo; &#125;&#125; PropertiesDemo.java1234567891011121314151617@Component@PropertySource(value = &quot;file:demo.properties&quot;,encoding = &quot;utf-8&quot;)@ConfigurationProperties(prefix = &quot;demo.data&quot;)@Datapublic class PropertiesDemo &#123; private Map&lt;String, String&gt; map = new HashMap&lt;&gt;(); private Map&lt;String, String&gt; map2 = new HashMap&lt;&gt;(); private Set&lt;String&gt; set = new HashSet&lt;&gt;(); private Set&lt;String&gt; set2 = new HashSet&lt;&gt;(); private List&lt;String&gt; list = new ArrayList&lt;&gt;(); private List&lt;String&gt; list2 = new ArrayList&lt;&gt;(); private String name; private Integer age; private Double salary;&#125; demo.properties1234567891011121314151617181920212223242526demo.data.map.client=clientdemo.data.map.token=tokendemo.data.map2.client=clientdemo.data.map2.token=tokendemo.data.name=张三demo.data.age=20demo.data.salary=12345.67demo.data.set[0]=beijingdemo.data.set[1]=shanghaidemo.data.set[2]=tianjindemo.data.set2[0]=guangzhoudemo.data.set2[1]=shenzhengdemo.data.set2[2]=hangzhoudemo.data.list[0]=南极demo.data.list[1]=北极demo.data.list[2]=赤道demo.data.list2[0]=喜马拉雅山demo.data.list2[1]=噶麦斯山demo.data.list2[2]=阿尔卑斯山","summary":"摘要 本文内容基于springboot2.2.6 SpringBoot可以通过@PropertySource(value = &quot;file:demo.properties&quot;)的方式加载外部配置文件，这样打好jar包后只要将这个属性文件放到相同路径即可 如果能够在不重启服务的情况下就可以重新加载这个属性文件，就可以很方便的实现动态更新，那么要怎么做呢？ github：https://github.com/hanqunfeng/springbootchapter/tree/master/chapter27","date_published":"2020-04-17T15:30:05.000Z","tags":["技术","springboot2","Java","springboot"]},{"id":"https://blog.hanqunfeng.com/2020/03/19/mongodb-mongos/","url":"https://blog.hanqunfeng.com/2020/03/19/mongodb-mongos/","title":"MongoDB 分片集群搭建","content_html":"<h2 id=\"摘要\"><a href=\"#摘要\" class=\"headerlink\" title=\"摘要\"></a>摘要</h2><ul>\n<li>本文内容基于mongodb4.2.3</li>\n<li>本文基于本地安装，也就是ip相同，端口不同</li>\n<li>3个shard复制集(3台)，1个config复制集(3台)，2个router</li>\n</ul>\n<span id=\"more\"></span>\n\n<h2 id=\"安装MongoDB\"><a href=\"#安装MongoDB\" class=\"headerlink\" title=\"安装MongoDB\"></a>安装MongoDB</h2><p>下载地址 ： <a href=\"https://www.mongodb.com/download-center\">https://www.mongodb.com/download-center</a></p>\n<p>下载后解压即可，可以将bin目录配置到$PATH中</p>\n<h2 id=\"目录设计\"><a href=\"#目录设计\" class=\"headerlink\" title=\"目录设计\"></a>目录设计</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">├── config</span><br><span class=\"line\">│  ├── node1</span><br><span class=\"line\">│  │  ├── db</span><br><span class=\"line\">│  │  ├── logs</span><br><span class=\"line\">│  │  └── mongod.conf</span><br><span class=\"line\">│  ├── node2</span><br><span class=\"line\">│  │  ├── db</span><br><span class=\"line\">│  │  ├── logs</span><br><span class=\"line\">│  │  └── mongod.conf</span><br><span class=\"line\">│  └── node3</span><br><span class=\"line\">│     ├── db</span><br><span class=\"line\">│     ├── logs</span><br><span class=\"line\">│     └── mongod.conf</span><br><span class=\"line\">├── keyfile.key</span><br><span class=\"line\">├── router</span><br><span class=\"line\">│  ├── node1</span><br><span class=\"line\">│  │  ├── logs</span><br><span class=\"line\">│  │  └── mongos.conf</span><br><span class=\"line\">│  └── node2</span><br><span class=\"line\">│     ├── logs</span><br><span class=\"line\">│     └── mongos.conf</span><br><span class=\"line\">├── shard1</span><br><span class=\"line\">│  ├── node1</span><br><span class=\"line\">│  │  ├── db</span><br><span class=\"line\">│  │  ├── logs</span><br><span class=\"line\">│  │  └── mongod.conf</span><br><span class=\"line\">│  ├── node2</span><br><span class=\"line\">│  │  ├── db</span><br><span class=\"line\">│  │  ├── logs</span><br><span class=\"line\">│  │  └── mongod.conf</span><br><span class=\"line\">│  └── node3</span><br><span class=\"line\">│     ├── db</span><br><span class=\"line\">│     ├── logs</span><br><span class=\"line\">│     └── mongod.conf</span><br><span class=\"line\">├── shard2</span><br><span class=\"line\">│  ├── node1</span><br><span class=\"line\">│  │  ├── db</span><br><span class=\"line\">│  │  ├── logs</span><br><span class=\"line\">│  │  └── mongod.conf</span><br><span class=\"line\">│  ├── node2</span><br><span class=\"line\">│  │  ├── db</span><br><span class=\"line\">│  │  ├── logs</span><br><span class=\"line\">│  │  └── mongod.conf</span><br><span class=\"line\">│  └── node3</span><br><span class=\"line\">│     ├── db</span><br><span class=\"line\">│     ├── logs</span><br><span class=\"line\">│     └── mongod.conf</span><br><span class=\"line\">└── shard3</span><br><span class=\"line\">   ├── node1</span><br><span class=\"line\">   │  ├── db</span><br><span class=\"line\">   │  ├── logs</span><br><span class=\"line\">   │  └── mongod.conf</span><br><span class=\"line\">   ├── node2</span><br><span class=\"line\">   │  ├── db</span><br><span class=\"line\">   │  ├── logs</span><br><span class=\"line\">   │  └── mongod.conf</span><br><span class=\"line\">   └── node3</span><br><span class=\"line\">      ├── db</span><br><span class=\"line\">      ├── logs</span><br><span class=\"line\">      └── mongod.conf</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"端口分配\"><a href=\"#端口分配\" class=\"headerlink\" title=\"端口分配\"></a>端口分配</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">shard1 28011~28013</span><br><span class=\"line\">shard2 28021~28023</span><br><span class=\"line\">shard3 28031~28033</span><br><span class=\"line\">config 29011~29013</span><br><span class=\"line\">router 29021~29022</span><br></pre></td></tr></table></figure>\n<h2 id=\"配置文件\"><a href=\"#配置文件\" class=\"headerlink\" title=\"配置文件\"></a>配置文件</h2><h3 id=\"shard\"><a href=\"#shard\" class=\"headerlink\" title=\"shard\"></a>shard</h3><p>以shard1为例，三个node下都有mongod.conf，要注意替换文件路径和端口</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemLog:</span><br><span class=\"line\">   destination: file</span><br><span class=\"line\">   path: <span class=\"string\">&quot;/Users/hanqf/myservice_dir/mongodb-mongos/shard1/node1/logs/mongo.log&quot;</span> <span class=\"comment\">#注意修改路径</span></span><br><span class=\"line\">   logAppend: <span class=\"literal\">true</span></span><br><span class=\"line\">storage:</span><br><span class=\"line\">   journal:</span><br><span class=\"line\">      enabled: <span class=\"literal\">true</span></span><br><span class=\"line\">   dbPath: <span class=\"string\">&quot;/Users/hanqf/myservice_dir/mongodb-mongos/shard1/node1/db&quot;</span> <span class=\"comment\">#注意修改路径</span></span><br><span class=\"line\">processManagement:</span><br><span class=\"line\">   fork: <span class=\"literal\">true</span></span><br><span class=\"line\">net:</span><br><span class=\"line\">   bindIp: 0.0.0.0</span><br><span class=\"line\">   port: 28011   <span class=\"comment\">#注意修改端口</span></span><br><span class=\"line\">setParameter:</span><br><span class=\"line\">   enableLocalhostAuthBypass: <span class=\"literal\">true</span></span><br><span class=\"line\">replication:</span><br><span class=\"line\">   replSetName: <span class=\"string\">&quot;shard1&quot;</span> <span class=\"comment\">#复制集名称</span></span><br><span class=\"line\">sharding:</span><br><span class=\"line\">   clusterRole: shardsvr <span class=\"comment\">#作为分片服务</span></span><br><span class=\"line\">security:</span><br><span class=\"line\">    authorization: <span class=\"string\">&quot;enabled&quot;</span></span><br><span class=\"line\">    keyFile: /Users/hanqf/myservice_dir/mongodb-mongos/keyFile.key <span class=\"comment\">#密钥文件，用于集群内部认证</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"config\"><a href=\"#config\" class=\"headerlink\" title=\"config\"></a>config</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemLog:</span><br><span class=\"line\">   destination: file</span><br><span class=\"line\">   path: <span class=\"string\">&quot;/Users/hanqf/myservice_dir/mongodb-mongos/config/node1/logs/mongo.log&quot;</span> <span class=\"comment\">#注意修改路径</span></span><br><span class=\"line\">   logAppend: <span class=\"literal\">true</span></span><br><span class=\"line\">storage:</span><br><span class=\"line\">   journal:</span><br><span class=\"line\">      enabled: <span class=\"literal\">true</span></span><br><span class=\"line\">   dbPath: <span class=\"string\">&quot;/Users/hanqf/myservice_dir/mongodb-mongos/config/node1/db&quot;</span> <span class=\"comment\">#注意修改路径</span></span><br><span class=\"line\">processManagement:</span><br><span class=\"line\">   fork: <span class=\"literal\">true</span></span><br><span class=\"line\">net:</span><br><span class=\"line\">   bindIp: 0.0.0.0</span><br><span class=\"line\">   port: 29011  <span class=\"comment\">#注意修改端口</span></span><br><span class=\"line\">setParameter:</span><br><span class=\"line\">   enableLocalhostAuthBypass: <span class=\"literal\">true</span></span><br><span class=\"line\">replication:</span><br><span class=\"line\">   replSetName: <span class=\"string\">&quot;config&quot;</span> <span class=\"comment\">#复制集名称</span></span><br><span class=\"line\">sharding:</span><br><span class=\"line\">   clusterRole: configsvr <span class=\"comment\">#作为配置服务</span></span><br><span class=\"line\">security:</span><br><span class=\"line\">  authorization: <span class=\"string\">&quot;enabled&quot;</span></span><br><span class=\"line\">  keyFile: /Users/hanqf/myservice_dir/mongodb-mongos/keyFile.key <span class=\"comment\">#密钥文件，用于集群内部认证</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"router\"><a href=\"#router\" class=\"headerlink\" title=\"router\"></a>router</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemLog:</span><br><span class=\"line\">   destination: file</span><br><span class=\"line\">   path: <span class=\"string\">&quot;/Users/hanqf/myservice_dir/mongodb-mongos/router/node1/logs/mongos.log&quot;</span> <span class=\"comment\">#注意修改路径</span></span><br><span class=\"line\">   logAppend: <span class=\"literal\">true</span></span><br><span class=\"line\">processManagement:</span><br><span class=\"line\">   fork: <span class=\"literal\">true</span></span><br><span class=\"line\">net:</span><br><span class=\"line\">   bindIp: 0.0.0.0</span><br><span class=\"line\">   port: 29021   <span class=\"comment\">#注意修改端口</span></span><br><span class=\"line\">setParameter:</span><br><span class=\"line\">   enableLocalhostAuthBypass: <span class=\"literal\">true</span></span><br><span class=\"line\">replication:</span><br><span class=\"line\">   localPingThresholdMs: 15</span><br><span class=\"line\">sharding:</span><br><span class=\"line\">   configDB: config/127.0.0.1:29011,127.0.0.1:29012,127.0.0.1:29013 <span class=\"comment\">#关联配置服务</span></span><br><span class=\"line\">security:</span><br><span class=\"line\">    keyFile: /Users/hanqf/myservice_dir/mongodb-mongos/keyFile.key <span class=\"comment\">#密钥文件，用于集群内部认证</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"keyFile\"><a href=\"#keyFile\" class=\"headerlink\" title=\"keyFile\"></a>keyFile</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> /Users/hanqf/myservice_dir/mongodb-mongos</span><br><span class=\"line\">openssl rand -base64 741 &gt; keyFile.key</span><br><span class=\"line\">chmod 400 mongodb-keyfile</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"配置config复制集\"><a href=\"#配置config复制集\" class=\"headerlink\" title=\"配置config复制集\"></a>配置config复制集</h2><h3 id=\"启动\"><a href=\"#启动\" class=\"headerlink\" title=\"启动\"></a>启动</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mongod --config /Users/hanqf/myservice_dir/mongodb-mongos/config/node1/mongod.conf</span><br><span class=\"line\">mongod --config /Users/hanqf/myservice_dir/mongodb-mongos/config/node2/mongod.conf</span><br><span class=\"line\">mongod --config /Users/hanqf/myservice_dir/mongodb-mongos/config/node3/mongod.conf</span><br></pre></td></tr></table></figure>\n<h3 id=\"登录及配置\"><a href=\"#登录及配置\" class=\"headerlink\" title=\"登录及配置\"></a>登录及配置</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#登录任意一台config</span></span><br><span class=\"line\">mongo --host 127.0.0.1:29011</span><br><span class=\"line\"></span><br><span class=\"line\">&gt;rs.initiate(</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    _id: <span class=\"string\">&quot;config&quot;</span>,</span><br><span class=\"line\">    configsvr: <span class=\"literal\">true</span>,</span><br><span class=\"line\">    members: [</span><br><span class=\"line\">      &#123; _id : 0, host : <span class=\"string\">&quot;127.0.0.1:29011&quot;</span> &#125;,</span><br><span class=\"line\">      &#123; _id : 1, host : <span class=\"string\">&quot;127.0.0.1:29012&quot;</span> &#125;,</span><br><span class=\"line\">      &#123; _id : 2, host : <span class=\"string\">&quot;127.0.0.1:29013&quot;</span> &#125;</span><br><span class=\"line\">    ]</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#创建超级管理员，此时要求登录的是主库</span></span><br><span class=\"line\">&gt;rs.isMaster() <span class=\"comment\">#验证是否主库</span></span><br><span class=\"line\">&gt;use admin</span><br><span class=\"line\">&gt;db.createUser(</span><br><span class=\"line\">   &#123;</span><br><span class=\"line\">     user: <span class=\"string\">&quot;root&quot;</span>,</span><br><span class=\"line\">     <span class=\"built_in\">pwd</span>: <span class=\"string\">&quot;password&quot;</span>,</span><br><span class=\"line\">     roles: [ &#123; role: <span class=\"string\">&quot;root&quot;</span>, db: <span class=\"string\">&quot;admin&quot;</span> &#125; ]</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\"> );</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n<p>验证用户是否可以登录</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mongo --host 127.0.0.1:29011</span><br><span class=\"line\">&gt;use admin</span><br><span class=\"line\">&gt;db.auth(<span class=\"string\">&quot;root&quot;</span>,<span class=\"string\">&quot;password&quot;</span>)</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"配置shard复制集\"><a href=\"#配置shard复制集\" class=\"headerlink\" title=\"配置shard复制集\"></a>配置shard复制集</h2><h3 id=\"启动shard1服务\"><a href=\"#启动shard1服务\" class=\"headerlink\" title=\"启动shard1服务\"></a>启动shard1服务</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mongod --config /Users/hanqf/myservice_dir/mongodb-mongos/shard1/node1/mongod.conf</span><br><span class=\"line\">mongod --config /Users/hanqf/myservice_dir/mongodb-mongos/shard1/node2/mongod.conf</span><br><span class=\"line\">mongod --config /Users/hanqf/myservice_dir/mongodb-mongos/shard1/node3/mongod.conf</span><br></pre></td></tr></table></figure>\n<h3 id=\"登录及配置-1\"><a href=\"#登录及配置-1\" class=\"headerlink\" title=\"登录及配置\"></a>登录及配置</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#登录任意一台config</span></span><br><span class=\"line\">mongo --host 127.0.0.1:28011</span><br><span class=\"line\"></span><br><span class=\"line\">&gt;rs.initiate(</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    _id: <span class=\"string\">&quot;shard1&quot;</span>,</span><br><span class=\"line\">    members: [</span><br><span class=\"line\">      &#123; _id : 0, host : <span class=\"string\">&quot;127.0.0.1:28011&quot;</span> &#125;,</span><br><span class=\"line\">      &#123; _id : 1, host : <span class=\"string\">&quot;127.0.0.1:28012&quot;</span> &#125;,</span><br><span class=\"line\">      &#123; _id : 2, host : <span class=\"string\">&quot;127.0.0.1:28013&quot;</span> &#125;</span><br><span class=\"line\">    ]</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#创建超级管理员，此时要求登录的是主库</span></span><br><span class=\"line\">&gt;rs.isMaster() <span class=\"comment\">#验证是否主库</span></span><br><span class=\"line\">&gt;use admin</span><br><span class=\"line\">&gt;db.createUser(</span><br><span class=\"line\">   &#123;</span><br><span class=\"line\">     user: <span class=\"string\">&quot;root&quot;</span>,</span><br><span class=\"line\">     <span class=\"built_in\">pwd</span>: <span class=\"string\">&quot;password&quot;</span>,</span><br><span class=\"line\">     roles: [ &#123; role: <span class=\"string\">&quot;root&quot;</span>, db: <span class=\"string\">&quot;admin&quot;</span> &#125; ]</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\"> );</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"启动shard2服务\"><a href=\"#启动shard2服务\" class=\"headerlink\" title=\"启动shard2服务\"></a>启动shard2服务</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mongod --config /Users/hanqf/myservice_dir/mongodb-mongos/shard2/node1/mongod.conf</span><br><span class=\"line\">mongod --config /Users/hanqf/myservice_dir/mongodb-mongos/shard2/node2/mongod.conf</span><br><span class=\"line\">mongod --config /Users/hanqf/myservice_dir/mongodb-mongos/shard2/node3/mongod.conf</span><br></pre></td></tr></table></figure>\n<h3 id=\"登录及配置-2\"><a href=\"#登录及配置-2\" class=\"headerlink\" title=\"登录及配置\"></a>登录及配置</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#登录任意一台config</span></span><br><span class=\"line\">mongo --host 127.0.0.1:28021</span><br><span class=\"line\"></span><br><span class=\"line\">&gt;rs.initiate(</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    _id: <span class=\"string\">&quot;shard2&quot;</span>,</span><br><span class=\"line\">    members: [</span><br><span class=\"line\">      &#123; _id : 0, host : <span class=\"string\">&quot;127.0.0.1:28021&quot;</span> &#125;,</span><br><span class=\"line\">      &#123; _id : 1, host : <span class=\"string\">&quot;127.0.0.1:28022&quot;</span> &#125;,</span><br><span class=\"line\">      &#123; _id : 2, host : <span class=\"string\">&quot;127.0.0.1:28023&quot;</span> &#125;</span><br><span class=\"line\">    ]</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#创建超级管理员，此时要求登录的是主库</span></span><br><span class=\"line\">&gt;rs.isMaster() <span class=\"comment\">#验证是否主库</span></span><br><span class=\"line\">&gt;use admin</span><br><span class=\"line\">&gt;db.createUser(</span><br><span class=\"line\">   &#123;</span><br><span class=\"line\">     user: <span class=\"string\">&quot;root&quot;</span>,</span><br><span class=\"line\">     <span class=\"built_in\">pwd</span>: <span class=\"string\">&quot;password&quot;</span>,</span><br><span class=\"line\">     roles: [ &#123; role: <span class=\"string\">&quot;root&quot;</span>, db: <span class=\"string\">&quot;admin&quot;</span> &#125; ]</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\"> );</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"启动shard3服务\"><a href=\"#启动shard3服务\" class=\"headerlink\" title=\"启动shard3服务\"></a>启动shard3服务</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mongod --config /Users/hanqf/myservice_dir/mongodb-mongos/shard3/node1/mongod.conf</span><br><span class=\"line\">mongod --config /Users/hanqf/myservice_dir/mongodb-mongos/shard3/node2/mongod.conf</span><br><span class=\"line\">mongod --config /Users/hanqf/myservice_dir/mongodb-mongos/shard3/node3/mongod.conf</span><br></pre></td></tr></table></figure>\n<h3 id=\"登录及配置-3\"><a href=\"#登录及配置-3\" class=\"headerlink\" title=\"登录及配置\"></a>登录及配置</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#登录任意一台config</span></span><br><span class=\"line\">mongo --host 127.0.0.1:28031</span><br><span class=\"line\"></span><br><span class=\"line\">&gt;rs.initiate(</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    _id: <span class=\"string\">&quot;shard3&quot;</span>,</span><br><span class=\"line\">    members: [</span><br><span class=\"line\">      &#123; _id : 0, host : <span class=\"string\">&quot;127.0.0.1:28031&quot;</span> &#125;,</span><br><span class=\"line\">      &#123; _id : 1, host : <span class=\"string\">&quot;127.0.0.1:28032&quot;</span> &#125;,</span><br><span class=\"line\">      &#123; _id : 2, host : <span class=\"string\">&quot;127.0.0.1:28033&quot;</span> &#125;</span><br><span class=\"line\">    ]</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#创建超级管理员，此时要求登录的是主库</span></span><br><span class=\"line\">&gt;rs.isMaster() <span class=\"comment\">#验证是否主库</span></span><br><span class=\"line\">&gt;use admin</span><br><span class=\"line\">&gt;db.createUser(</span><br><span class=\"line\">   &#123;</span><br><span class=\"line\">     user: <span class=\"string\">&quot;root&quot;</span>,</span><br><span class=\"line\">     <span class=\"built_in\">pwd</span>: <span class=\"string\">&quot;password&quot;</span>,</span><br><span class=\"line\">     roles: [ &#123; role: <span class=\"string\">&quot;root&quot;</span>, db: <span class=\"string\">&quot;admin&quot;</span> &#125; ]</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\"> );</span><br></pre></td></tr></table></figure>\n\n\n<h2 id=\"重启router服务\"><a href=\"#重启router服务\" class=\"headerlink\" title=\"重启router服务\"></a>重启router服务</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mongos --config /Users/hanqf/myservice_dir/mongodb-mongos/router/node1/mongos.conf</span><br><span class=\"line\">mongos --config /Users/hanqf/myservice_dir/mongodb-mongos/router/node2/mongos.conf</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"分片配置\"><a href=\"#分片配置\" class=\"headerlink\" title=\"分片配置\"></a>分片配置</h2><p>登录任意router</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mongo --host 127.0.0.1:29021</span><br><span class=\"line\">&gt;use admin</span><br><span class=\"line\">&gt;db.auth(<span class=\"string\">&quot;root&quot;</span>,<span class=\"string\">&quot;password&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">&gt;sh.addShard( <span class=\"string\">&quot;shard1/127.0.0.1:28011,127.0.0.1:28012,127.0.0.1:28013&quot;</span>)</span><br><span class=\"line\">&gt;sh.addShard( <span class=\"string\">&quot;shard2/127.0.0.1:28021,127.0.0.1:28022,127.0.0.1:28023&quot;</span>)</span><br><span class=\"line\">&gt;sh.addShard( <span class=\"string\">&quot;shard3/127.0.0.1:28031,127.0.0.1:28032,127.0.0.1:28033&quot;</span>)</span><br><span class=\"line\"><span class=\"comment\">#查看集群状态</span></span><br><span class=\"line\">&gt;sh.status()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#创建数据库用户，客户端可以使用该用户连接mongo路由</span></span><br><span class=\"line\">&gt;use springboot</span><br><span class=\"line\">&gt;db.createUser(</span><br><span class=\"line\">   &#123;</span><br><span class=\"line\">     user: <span class=\"string\">&quot;springboot&quot;</span>,</span><br><span class=\"line\">     <span class=\"built_in\">pwd</span>: <span class=\"string\">&quot;123456&quot;</span>,</span><br><span class=\"line\">     roles: [ &#123; role: <span class=\"string\">&quot;dbOwner&quot;</span>, db: <span class=\"string\">&quot;springboot&quot;</span> &#125; ]</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">  );</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#指定要分片的数据库</span></span><br><span class=\"line\">&gt;sh.enableSharding(<span class=\"string\">&quot;springboot&quot;</span>)</span><br><span class=\"line\"><span class=\"comment\">#指定集合的分片规则</span></span><br><span class=\"line\"><span class=\"comment\">#这里表示指定springboot库下的user集合的_id字段（也就是主键，每个集合都有这个字段）按hash散列进行分片，&#123; id : 1 &#125;表示按字段id进度范围分片，这里id必须是整型</span></span><br><span class=\"line\"><span class=\"comment\">#要分片存储的集合都需要指定分片规则，分片规则一经创建不可修改，只能删除集合再重新设置</span></span><br><span class=\"line\">&gt;sh.shardCollection(<span class=\"string\">&quot;springboot.user&quot;</span>, &#123; _id : <span class=\"string\">&quot;hashed&quot;</span> &#125; )</span><br><span class=\"line\"></span><br><span class=\"line\">&gt;use springboot</span><br><span class=\"line\"><span class=\"comment\">#查询user的集合状态</span></span><br><span class=\"line\">&gt;db.user.stats()</span><br></pre></td></tr></table></figure>\n<!--\n这是一个注释，可以写很多内容，哈哈\n-->\n<blockquote class=\"blockquote-center\">\n<h3 id=\"小贴士\"><a href=\"#小贴士\" class=\"headerlink\" title=\"小贴士\"></a>小贴士</h3>\n</blockquote>\n\n<div class=\"note info\"><h3 id=\"注意\"><a href=\"#注意\" class=\"headerlink\" title=\"注意\"></a>注意</h3><ul>\n<li>正式环境注意权限控制，使客户端只能连接router</li>\n<li>可以创建任意多个router</li>\n<li>springboot连接方式：<br><code>spring.data.mongodb.uri=mongodb://springboot:123456@127.0.0.1:29021,127.0.0.1:29022/springboot?authSource=springboot</code></li>\n</ul>\n</div>\n","content_text":"摘要 本文内容基于mongodb4.2.3 本文基于本地安装，也就是ip相同，端口不同 3个shard复制集(3台)，1个config复制集(3台)，2个router 安装MongoDB下载地址 ： https://www.mongodb.com/download-center 下载后解压即可，可以将bin目录配置到$PATH中 目录设计123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960├── config│ ├── node1│ │ ├── db│ │ ├── logs│ │ └── mongod.conf│ ├── node2│ │ ├── db│ │ ├── logs│ │ └── mongod.conf│ └── node3│ ├── db│ ├── logs│ └── mongod.conf├── keyfile.key├── router│ ├── node1│ │ ├── logs│ │ └── mongos.conf│ └── node2│ ├── logs│ └── mongos.conf├── shard1│ ├── node1│ │ ├── db│ │ ├── logs│ │ └── mongod.conf│ ├── node2│ │ ├── db│ │ ├── logs│ │ └── mongod.conf│ └── node3│ ├── db│ ├── logs│ └── mongod.conf├── shard2│ ├── node1│ │ ├── db│ │ ├── logs│ │ └── mongod.conf│ ├── node2│ │ ├── db│ │ ├── logs│ │ └── mongod.conf│ └── node3│ ├── db│ ├── logs│ └── mongod.conf└── shard3 ├── node1 │ ├── db │ ├── logs │ └── mongod.conf ├── node2 │ ├── db │ ├── logs │ └── mongod.conf └── node3 ├── db ├── logs └── mongod.conf 端口分配12345shard1 28011~28013shard2 28021~28023shard3 28031~28033config 29011~29013router 29021~29022 配置文件shard以shard1为例，三个node下都有mongod.conf，要注意替换文件路径和端口 12345678910111213141516171819202122systemLog: destination: file path: &quot;/Users/hanqf/myservice_dir/mongodb-mongos/shard1/node1/logs/mongo.log&quot; #注意修改路径 logAppend: truestorage: journal: enabled: true dbPath: &quot;/Users/hanqf/myservice_dir/mongodb-mongos/shard1/node1/db&quot; #注意修改路径processManagement: fork: truenet: bindIp: 0.0.0.0 port: 28011 #注意修改端口setParameter: enableLocalhostAuthBypass: truereplication: replSetName: &quot;shard1&quot; #复制集名称sharding: clusterRole: shardsvr #作为分片服务security: authorization: &quot;enabled&quot; keyFile: /Users/hanqf/myservice_dir/mongodb-mongos/keyFile.key #密钥文件，用于集群内部认证 config12345678910111213141516171819202122systemLog: destination: file path: &quot;/Users/hanqf/myservice_dir/mongodb-mongos/config/node1/logs/mongo.log&quot; #注意修改路径 logAppend: truestorage: journal: enabled: true dbPath: &quot;/Users/hanqf/myservice_dir/mongodb-mongos/config/node1/db&quot; #注意修改路径processManagement: fork: truenet: bindIp: 0.0.0.0 port: 29011 #注意修改端口setParameter: enableLocalhostAuthBypass: truereplication: replSetName: &quot;config&quot; #复制集名称sharding: clusterRole: configsvr #作为配置服务security: authorization: &quot;enabled&quot; keyFile: /Users/hanqf/myservice_dir/mongodb-mongos/keyFile.key #密钥文件，用于集群内部认证 router1234567891011121314151617systemLog: destination: file path: &quot;/Users/hanqf/myservice_dir/mongodb-mongos/router/node1/logs/mongos.log&quot; #注意修改路径 logAppend: trueprocessManagement: fork: truenet: bindIp: 0.0.0.0 port: 29021 #注意修改端口setParameter: enableLocalhostAuthBypass: truereplication: localPingThresholdMs: 15sharding: configDB: config/127.0.0.1:29011,127.0.0.1:29012,127.0.0.1:29013 #关联配置服务security: keyFile: /Users/hanqf/myservice_dir/mongodb-mongos/keyFile.key #密钥文件，用于集群内部认证 keyFile123cd /Users/hanqf/myservice_dir/mongodb-mongosopenssl rand -base64 741 &gt; keyFile.keychmod 400 mongodb-keyfile 配置config复制集启动123mongod --config /Users/hanqf/myservice_dir/mongodb-mongos/config/node1/mongod.confmongod --config /Users/hanqf/myservice_dir/mongodb-mongos/config/node2/mongod.confmongod --config /Users/hanqf/myservice_dir/mongodb-mongos/config/node3/mongod.conf 登录及配置1234567891011121314151617181920212223242526#登录任意一台configmongo --host 127.0.0.1:29011&gt;rs.initiate( &#123; _id: &quot;config&quot;, configsvr: true, members: [ &#123; _id : 0, host : &quot;127.0.0.1:29011&quot; &#125;, &#123; _id : 1, host : &quot;127.0.0.1:29012&quot; &#125;, &#123; _id : 2, host : &quot;127.0.0.1:29013&quot; &#125; ] &#125;);#创建超级管理员，此时要求登录的是主库&gt;rs.isMaster() #验证是否主库&gt;use admin&gt;db.createUser( &#123; user: &quot;root&quot;, pwd: &quot;password&quot;, roles: [ &#123; role: &quot;root&quot;, db: &quot;admin&quot; &#125; ] &#125; ); 验证用户是否可以登录 123mongo --host 127.0.0.1:29011&gt;use admin&gt;db.auth(&quot;root&quot;,&quot;password&quot;) 配置shard复制集启动shard1服务123mongod --config /Users/hanqf/myservice_dir/mongodb-mongos/shard1/node1/mongod.confmongod --config /Users/hanqf/myservice_dir/mongodb-mongos/shard1/node2/mongod.confmongod --config /Users/hanqf/myservice_dir/mongodb-mongos/shard1/node3/mongod.conf 登录及配置123456789101112131415161718192021222324#登录任意一台configmongo --host 127.0.0.1:28011&gt;rs.initiate( &#123; _id: &quot;shard1&quot;, members: [ &#123; _id : 0, host : &quot;127.0.0.1:28011&quot; &#125;, &#123; _id : 1, host : &quot;127.0.0.1:28012&quot; &#125;, &#123; _id : 2, host : &quot;127.0.0.1:28013&quot; &#125; ] &#125;);#创建超级管理员，此时要求登录的是主库&gt;rs.isMaster() #验证是否主库&gt;use admin&gt;db.createUser( &#123; user: &quot;root&quot;, pwd: &quot;password&quot;, roles: [ &#123; role: &quot;root&quot;, db: &quot;admin&quot; &#125; ] &#125; ); 启动shard2服务123mongod --config /Users/hanqf/myservice_dir/mongodb-mongos/shard2/node1/mongod.confmongod --config /Users/hanqf/myservice_dir/mongodb-mongos/shard2/node2/mongod.confmongod --config /Users/hanqf/myservice_dir/mongodb-mongos/shard2/node3/mongod.conf 登录及配置123456789101112131415161718192021222324#登录任意一台configmongo --host 127.0.0.1:28021&gt;rs.initiate( &#123; _id: &quot;shard2&quot;, members: [ &#123; _id : 0, host : &quot;127.0.0.1:28021&quot; &#125;, &#123; _id : 1, host : &quot;127.0.0.1:28022&quot; &#125;, &#123; _id : 2, host : &quot;127.0.0.1:28023&quot; &#125; ] &#125;);#创建超级管理员，此时要求登录的是主库&gt;rs.isMaster() #验证是否主库&gt;use admin&gt;db.createUser( &#123; user: &quot;root&quot;, pwd: &quot;password&quot;, roles: [ &#123; role: &quot;root&quot;, db: &quot;admin&quot; &#125; ] &#125; ); 启动shard3服务123mongod --config /Users/hanqf/myservice_dir/mongodb-mongos/shard3/node1/mongod.confmongod --config /Users/hanqf/myservice_dir/mongodb-mongos/shard3/node2/mongod.confmongod --config /Users/hanqf/myservice_dir/mongodb-mongos/shard3/node3/mongod.conf 登录及配置123456789101112131415161718192021222324#登录任意一台configmongo --host 127.0.0.1:28031&gt;rs.initiate( &#123; _id: &quot;shard3&quot;, members: [ &#123; _id : 0, host : &quot;127.0.0.1:28031&quot; &#125;, &#123; _id : 1, host : &quot;127.0.0.1:28032&quot; &#125;, &#123; _id : 2, host : &quot;127.0.0.1:28033&quot; &#125; ] &#125;);#创建超级管理员，此时要求登录的是主库&gt;rs.isMaster() #验证是否主库&gt;use admin&gt;db.createUser( &#123; user: &quot;root&quot;, pwd: &quot;password&quot;, roles: [ &#123; role: &quot;root&quot;, db: &quot;admin&quot; &#125; ] &#125; ); 重启router服务12mongos --config /Users/hanqf/myservice_dir/mongodb-mongos/router/node1/mongos.confmongos --config /Users/hanqf/myservice_dir/mongodb-mongos/router/node2/mongos.conf 分片配置登录任意router 123456789101112131415161718192021222324252627282930mongo --host 127.0.0.1:29021&gt;use admin&gt;db.auth(&quot;root&quot;,&quot;password&quot;)&gt;sh.addShard( &quot;shard1/127.0.0.1:28011,127.0.0.1:28012,127.0.0.1:28013&quot;)&gt;sh.addShard( &quot;shard2/127.0.0.1:28021,127.0.0.1:28022,127.0.0.1:28023&quot;)&gt;sh.addShard( &quot;shard3/127.0.0.1:28031,127.0.0.1:28032,127.0.0.1:28033&quot;)#查看集群状态&gt;sh.status()#创建数据库用户，客户端可以使用该用户连接mongo路由&gt;use springboot&gt;db.createUser( &#123; user: &quot;springboot&quot;, pwd: &quot;123456&quot;, roles: [ &#123; role: &quot;dbOwner&quot;, db: &quot;springboot&quot; &#125; ] &#125; );#指定要分片的数据库&gt;sh.enableSharding(&quot;springboot&quot;)#指定集合的分片规则#这里表示指定springboot库下的user集合的_id字段（也就是主键，每个集合都有这个字段）按hash散列进行分片，&#123; id : 1 &#125;表示按字段id进度范围分片，这里id必须是整型#要分片存储的集合都需要指定分片规则，分片规则一经创建不可修改，只能删除集合再重新设置&gt;sh.shardCollection(&quot;springboot.user&quot;, &#123; _id : &quot;hashed&quot; &#125; )&gt;use springboot#查询user的集合状态&gt;db.user.stats() 小贴士 注意 正式环境注意权限控制，使客户端只能连接router 可以创建任意多个router springboot连接方式：spring.data.mongodb.uri=mongodb://springboot:123456@127.0.0.1:29021,127.0.0.1:29022/springboot?authSource=springboot","summary":"摘要 本文内容基于mongodb4.2.3 本文基于本地安装，也就是ip相同，端口不同 3个shard复制集(3台)，1个config复制集(3台)，2个router","date_published":"2020-03-19T08:30:05.000Z","tags":["技术","mongo"]},{"id":"https://blog.hanqunfeng.com/2018/12/27/redis-cluster/","url":"https://blog.hanqunfeng.com/2018/12/27/redis-cluster/","title":"Redis集群","content_html":"<h2 id=\"一、摘要\"><a href=\"#一、摘要\" class=\"headerlink\" title=\"一、摘要\"></a>一、摘要</h2><p>看完本文你将掌握如下知识点：</p>\n<ul>\n<li>redis集群的构建方法【redis-5.0.2】</li>\n<li>redis早期的版本中使用基于ruby的<code>redis-trib.rb</code>命令进行集群创建，新版本推荐使用 <code>redis-cli --cluster</code>，本文就是通过<code>redis-cli --cluster</code>命令实现集群构建。</li>\n</ul>\n<span id=\"more\"></span>\n\n<h2 id=\"二、快速创建集群\"><a href=\"#二、快速创建集群\" class=\"headerlink\" title=\"二、快速创建集群\"></a>二、快速创建集群</h2><p>redis为我们提供了快速创建集群的工具，安装好redis后，在其<code>/redis-5.0.2/utils/create-cluster/</code>目录下存在一个<code>create-cluster</code>命令，通过该命令可以快速创建一个基于本机端口30001~30006的三主三从的redis集群，可以通过修改端口号及服务数量来改变集群的配置。<br>1.启动6个redis服务，<code>./create-cluster start</code><br>2.创建集群，<code>./create-cluster create</code><br>3.关闭集群服务，<code>./create-cluster stop</code><br>4.清除数据及日志文件，<code>./create-cluster clean</code></p>\n<h2 id=\"三、源码分析\"><a href=\"#三、源码分析\" class=\"headerlink\" title=\"三、源码分析\"></a>三、源码分析</h2><p>通过看源码可以很清楚其创建过程<br>1.启动6个reids服务，通过参数的方式进行启动，在生产环境中建议通过配置文件启动</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">if [ &quot;$1&quot; == &quot;start&quot; ]</span><br><span class=\"line\">then</span><br><span class=\"line\">    while [ $((PORT &lt; ENDPORT)) != &quot;0&quot; ]; do</span><br><span class=\"line\">        PORT=$((PORT+1))</span><br><span class=\"line\">        echo &quot;Starting $PORT&quot;</span><br><span class=\"line\">        ../../src/redis-server --port $PORT --cluster-enabled yes --cluster-config-file nodes-$&#123;PORT&#125;.conf --cluster-node-timeout $TIMEOUT --appendonly yes --appendfilename appendonly-$&#123;PORT&#125;.aof --dbfilename dump</span><br><span class=\"line\"><span class=\"meta\">-$</span><span class=\"bash\">&#123;PORT&#125;.rdb --logfile <span class=\"variable\">$&#123;PORT&#125;</span>.<span class=\"built_in\">log</span> --daemonize yes</span></span><br><span class=\"line\">    done</span><br><span class=\"line\">    exit 0</span><br><span class=\"line\">fi</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>参数说明：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">端口：</span></span><br><span class=\"line\">port $PORT</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">是否启用集群：</span></span><br><span class=\"line\">cluster-enabled yes</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">集群关联文件路径，创建redis集群时自动创建</span></span><br><span class=\"line\">cluster-config-file nodes-$&#123;PORT&#125;.conf</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">集群节点间通信的超时时间，毫秒，建议2000，默认15000</span></span><br><span class=\"line\">cluster-node-timeout $TIMEOUT</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">开启aof</span></span><br><span class=\"line\">appendonly yes</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">aof文件名称，注意这里只能是文件名称，若要修改路径需要设置dir属性 ，如dir /home/hanqf/redis-dir/redis-5.0.2/cluster-conf/files/</span></span><br><span class=\"line\">appendfilename appendonly-$&#123;PORT&#125;.aof</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">rdb文件名称，同样只能是文件名称，同上路径共用dir属性</span></span><br><span class=\"line\">dbfilename dump-$&#123;PORT&#125;.rdb</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">日志文件路径</span></span><br><span class=\"line\">logfile $&#123;PORT&#125;.log</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">后台运行模式启动</span></span><br><span class=\"line\">daemonize yes</span><br></pre></td></tr></table></figure>\n\n<p>2.构建集群，这里使用的就是<code>redis-cli --cluster</code>命令，可以看出与<code>redis-trib.rb</code>命令类似</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">if [ &quot;$1&quot; == &quot;create&quot; ]</span><br><span class=\"line\">then</span><br><span class=\"line\">    HOSTS=&quot;&quot;</span><br><span class=\"line\">    while [ $((PORT &lt; ENDPORT)) != &quot;0&quot; ]; do</span><br><span class=\"line\">        PORT=$((PORT+1))</span><br><span class=\"line\">        HOSTS=&quot;$HOSTS 127.0.0.1:$PORT&quot;</span><br><span class=\"line\">    done</span><br><span class=\"line\">    ../../src/redis-cli --cluster create $HOSTS --cluster-replicas $REPLICAS</span><br><span class=\"line\">    exit 0</span><br><span class=\"line\">fi</span><br></pre></td></tr></table></figure>\n<p><code>create</code>后根的<code>$HOSTS</code>就是redis服务列表</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:30001 127.0.0.1:30002 127.0.0.1:30003 127.0.0.1:30004 127.0.0.1:30005 127.0.0.1:30006</span><br></pre></td></tr></table></figure>\n<p><code>--cluster-replicas $REPLICAS</code>，这里$REPLICAS值为1，表示为每一个master节点分配一个slave节点</p>\n<h2 id=\"四、实际应用\"><a href=\"#四、实际应用\" class=\"headerlink\" title=\"四、实际应用\"></a>四、实际应用</h2><p>这里我们使用2台服务器，分别启动3个redis服务，来构建一个三主三从的redis集群。</p>\n<h3 id=\"1-服务器IP\"><a href=\"#1-服务器IP\" class=\"headerlink\" title=\"1.服务器IP\"></a>1.服务器IP</h3><ul>\n<li>10.211.55.15</li>\n<li>10.211.55.16</li>\n</ul>\n<h3 id=\"2-端口设置\"><a href=\"#2-端口设置\" class=\"headerlink\" title=\"2.端口设置\"></a>2.端口设置</h3><p>分别开启俩台服务器的如下端口，前面是redis服务端口，后面是集群通信端口（默认服务端口+10000）</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">6379，16379</span><br><span class=\"line\">6380，16380</span><br><span class=\"line\">6381，16381</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"3-redis-port-conf\"><a href=\"#3-redis-port-conf\" class=\"headerlink\" title=\"3.redis-{port}.conf\"></a>3.redis-{port}.conf</h3><p>这里需要按照上面的参数说明进行配置，如我们配置号redis-6379.conf后，可以通过如下命令进行复制</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">more redis-6379.conf | sed &#x27;s/6379/6380/g&#x27; &gt; redis-6380.conf</span><br><span class=\"line\">more redis-6379.conf | sed &#x27;s/6379/6381/g&#x27; &gt; redis-6381.conf</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"4-启动服务\"><a href=\"#4-启动服务\" class=\"headerlink\" title=\"4.启动服务\"></a>4.启动服务</h3><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">10.211.55.15</span></span><br><span class=\"line\">./redis-server redis-6379.conf</span><br><span class=\"line\">./redis-server redis-6380.conf</span><br><span class=\"line\">./redis-server redis-6381.conf</span><br><span class=\"line\"><span class=\"meta\"></span></span><br><span class=\"line\"><span class=\"meta\"></span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">10.211.55.16</span></span><br><span class=\"line\">./redis-server redis-6379.conf</span><br><span class=\"line\">./redis-server redis-6380.conf</span><br><span class=\"line\">./redis-server redis-6381.conf</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"5-构建集群\"><a href=\"#5-构建集群\" class=\"headerlink\" title=\"5.构建集群\"></a>5.构建集群</h3><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./redis-cli --cluster create 10.211.55.15:6379 10.211.55.15:6380 10.211.55.15:6381 10.211.55.16:6379 10.211.55.16:6380 10.211.55.16:6381  --cluster-replicas 1</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"五、集群相关命令\"><a href=\"#五、集群相关命令\" class=\"headerlink\" title=\"五、集群相关命令\"></a>五、集群相关命令</h2><h3 id=\"1-健康检查\"><a href=\"#1-健康检查\" class=\"headerlink\" title=\"1.健康检查\"></a>1.健康检查</h3><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 后面可以是集群中任意节点</span></span><br><span class=\"line\">./redis-cli --cluster check 10.211.55.15:6380</span><br></pre></td></tr></table></figure>\n\n<p>输出如下，可以看到集群中的主从关系，以及每个master中含有key的数量：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">10.211.55.15:6380 (c39c1e8a...) -&gt; 2 keys | 5461 slots | 1 slaves.</span><br><span class=\"line\">10.211.55.16:6380 (3edc1dae...) -&gt; 5 keys | 5461 slots | 1 slaves.</span><br><span class=\"line\">10.211.55.16:6379 (4dd31f17...) -&gt; 2 keys | 5462 slots | 1 slaves.</span><br><span class=\"line\">[OK] 9 keys in 3 masters.</span><br><span class=\"line\">0.00 keys per slot on average.</span><br><span class=\"line\"><span class=\"meta\">&gt;</span><span class=\"bash\">&gt;&gt; Performing Cluster Check (using node 10.211.55.15:6380)</span></span><br><span class=\"line\">M: c39c1e8aa6e07e337aaab03eab3727f739201cd2 10.211.55.15:6380</span><br><span class=\"line\">   slots:[10923-16383] (5461 slots) master</span><br><span class=\"line\">   1 additional replica(s)</span><br><span class=\"line\">S: a83903f50621d7627f3ce59f1210af4938b8acc4 10.211.55.15:6381</span><br><span class=\"line\">   slots: (0 slots) slave</span><br><span class=\"line\">   replicates 4dd31f17e83ef7aa6c7a36474f7f54d842e0ed64</span><br><span class=\"line\">M: 3edc1daeaf3a848156ad8cc601b1374dd0459d9c 10.211.55.16:6380</span><br><span class=\"line\">   slots:[0-5460] (5461 slots) master</span><br><span class=\"line\">   1 additional replica(s)</span><br><span class=\"line\">M: 4dd31f17e83ef7aa6c7a36474f7f54d842e0ed64 10.211.55.16:6379</span><br><span class=\"line\">   slots:[5461-10922] (5462 slots) master</span><br><span class=\"line\">   1 additional replica(s)</span><br><span class=\"line\">S: cb6a94201d6f5a4e016b1549afc8c976a1a3dda4 10.211.55.15:6379</span><br><span class=\"line\">   slots: (0 slots) slave</span><br><span class=\"line\">   replicates 3edc1daeaf3a848156ad8cc601b1374dd0459d9c</span><br><span class=\"line\">S: 3f41a95296cb2681ea599f47aaff9c662b3338ad 10.211.55.16:6381</span><br><span class=\"line\">   slots: (0 slots) slave</span><br><span class=\"line\">   replicates c39c1e8aa6e07e337aaab03eab3727f739201cd2</span><br><span class=\"line\">[OK] All nodes agree about slots configuration.</span><br><span class=\"line\"><span class=\"meta\">&gt;</span><span class=\"bash\">&gt;&gt; Check <span class=\"keyword\">for</span> open slots...</span></span><br><span class=\"line\"><span class=\"meta\">&gt;</span><span class=\"bash\">&gt;&gt; Check slots coverage...</span></span><br><span class=\"line\">[OK] All 16384 slots covered.</span><br></pre></td></tr></table></figure>\n\n<p>说明：此时如果关闭其中一个master节点，那么其对应的从节点就会升级为主节点，当重新启动原master节点后，则该节点会自动加入集群，并作为从节点。</p>\n<h3 id=\"2-集群扩容，即为集群添加新的主机和从机\"><a href=\"#2-集群扩容，即为集群添加新的主机和从机\" class=\"headerlink\" title=\"2.集群扩容，即为集群添加新的主机和从机\"></a>2.集群扩容，即为集群添加新的主机和从机</h3><h4 id=\"2-1通过如下命令添加新的node\"><a href=\"#2-1通过如下命令添加新的node\" class=\"headerlink\" title=\"2.1通过如下命令添加新的node\"></a>2.1通过如下命令添加新的node</h4><p>说明：10.211.55.15:6382 是新的服务地址，10.211.55.16:6380 是集群中任意一个的服务地址,添加后的服务类型为master。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./redis-cli --cluster add-node 10.211.55.15:6382 10.211.55.16:6380</span><br></pre></td></tr></table></figure>\n\n<p>此时我们通过健康检查可以看到新加入的服务没有分配槽点：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./redis-cli --cluster check 10.211.55.15:6380</span><br><span class=\"line\">Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.</span><br><span class=\"line\">Could not connect to Redis at 10.211.55.15:6379: Connection refused</span><br><span class=\"line\">10.211.55.15:6380 (a5f63b8e...) -&gt; 2 keys | 5461 slots | 1 slaves.</span><br><span class=\"line\">10.211.55.16:6379 (15506850...) -&gt; 2 keys | 5462 slots | 1 slaves.</span><br><span class=\"line\">10.211.55.15:6382 (316e068f...) -&gt; 0 keys | 0 slots | 0 slaves.   #注意，这里新添加的主机没有分配槽（slot），需要先进行分配才能使用</span><br><span class=\"line\">10.211.55.16:6380 (d944c0b1...) -&gt; 5 keys | 5461 slots | 0 slaves.</span><br><span class=\"line\">[OK] 9 keys in 4 masters.</span><br><span class=\"line\">0.00 keys per slot on average.</span><br><span class=\"line\"><span class=\"meta\">&gt;</span><span class=\"bash\">&gt;&gt; Performing Cluster Check (using node 10.211.55.15:6380)</span></span><br><span class=\"line\">M: a5f63b8e4f24a73d36da9e0bbf84988d7c5558d3 10.211.55.15:6380</span><br><span class=\"line\">  slots:[10923-16383] (5461 slots) master</span><br><span class=\"line\">  1 additional replica(s)</span><br><span class=\"line\">M: 15506850b235f4277306368533cacf4a5ec1bbd1 10.211.55.16:6379</span><br><span class=\"line\">  slots:[5461-10922] (5462 slots) master</span><br><span class=\"line\">  1 additional replica(s)</span><br><span class=\"line\">M: 316e068fd71ee228299198a271efd839d3493835 10.211.55.15:6382</span><br><span class=\"line\">  slots: (0 slots) master</span><br><span class=\"line\">S: b3c0e06da5b5d694c3a68408fb4c8f7607d7e9e0 10.211.55.16:6381</span><br><span class=\"line\">  slots: (0 slots) slave</span><br><span class=\"line\">  replicates a5f63b8e4f24a73d36da9e0bbf84988d7c5558d3</span><br><span class=\"line\">M: d944c0b19e92af325b882e3a86ff09c2b6b53f47 10.211.55.16:6380</span><br><span class=\"line\">  slots:[0-5460] (5461 slots) master</span><br><span class=\"line\">S: 4bce4c24959bda55d087296e86f58ec03186d3ae 10.211.55.15:6381</span><br><span class=\"line\">  slots: (0 slots) slave</span><br><span class=\"line\">  replicates 15506850b235f4277306368533cacf4a5ec1bbd1</span><br><span class=\"line\">[OK] All nodes agree about slots configuration.</span><br><span class=\"line\"><span class=\"meta\">&gt;</span><span class=\"bash\">&gt;&gt; Check <span class=\"keyword\">for</span> open slots...</span></span><br><span class=\"line\"><span class=\"meta\">&gt;</span><span class=\"bash\">&gt;&gt; Check slots coverage...</span></span><br><span class=\"line\">[OK] All 16384 slots covered.</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"2-2分配槽\"><a href=\"#2-2分配槽\" class=\"headerlink\" title=\"2.2分配槽\"></a>2.2分配槽</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./redis-cli --cluster reshard 10.211.55.15:6382</span><br></pre></td></tr></table></figure>\n<p>执行命令后会有如下设置：<br>  1.问你是否从原有的1-16384个槽中分配多少到新的主节点，我们这里分配4000为例，回车<br>    2：然后紧接着会询问你给id为谁的主节点分配，这里就是新加的节点10.211.55.15:6382，其对应的Id为:316e068fd71ee228299198a271efd839d3493835<br>    3：询问你是从所有的空间去给这个节点分配空间还是从某一个节点分配，我这里输入all  回车继续<br>    4：然后会给你分配出一个分配计划，输入yes开始分配。完成ok</p>\n<p>此时再次运行健康检查可以看到槽点已经分配成功</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./redis-cli --cluster check 10.211.55.15:6380</span><br><span class=\"line\">Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.</span><br><span class=\"line\">localhost:6380 (a5f63b8e...) -&gt; 1 keys | 4128 slots | 1 slaves.</span><br><span class=\"line\">10.211.55.16:6379 (15506850...) -&gt; 2 keys | 4128 slots | 1 slaves.</span><br><span class=\"line\">10.211.55.15:6382 (316e068f...) -&gt; 2 keys | 4000 slots | 0 slaves.</span><br><span class=\"line\">10.211.55.16:6380 (d944c0b1...) -&gt; 4 keys | 4128 slots | 1 slaves.</span><br><span class=\"line\">[OK] 9 keys in 4 masters.</span><br><span class=\"line\">0.00 keys per slot on average.</span><br><span class=\"line\">………………………………</span><br></pre></td></tr></table></figure>\n\n\n<h4 id=\"2-3平衡槽，就是均匀分配集群中的所有槽到所有的节点，该步非必须，只是看着好看点\"><a href=\"#2-3平衡槽，就是均匀分配集群中的所有槽到所有的节点，该步非必须，只是看着好看点\" class=\"headerlink\" title=\"2.3平衡槽，就是均匀分配集群中的所有槽到所有的节点，该步非必须，只是看着好看点\"></a>2.3平衡槽，就是均匀分配集群中的所有槽到所有的节点，该步非必须，只是看着好看点</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./redis-cli --cluster rebalance --cluster-threshold 1 10.211.55.15:6382</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./redis-cli --cluster info 10.211.55.15:6380</span><br><span class=\"line\">Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.</span><br><span class=\"line\">localhost:6380 (a5f63b8e...) -&gt; 1 keys | 4096 slots | 1 slaves.</span><br><span class=\"line\">10.211.55.16:6379 (15506850...) -&gt; 2 keys | 4096 slots | 1 slaves.</span><br><span class=\"line\">10.211.55.15:6382 (316e068f...) -&gt; 2 keys | 4096 slots | 0 slaves.</span><br><span class=\"line\">10.211.55.16:6380 (d944c0b1...) -&gt; 4 keys | 4096 slots | 1 slaves.</span><br><span class=\"line\">[OK] 9 keys in 4 masters.</span><br><span class=\"line\">0.00 keys per slot on average.</span><br></pre></td></tr></table></figure>\n\n\n<h4 id=\"2-4为新加入的master添加slave\"><a href=\"#2-4为新加入的master添加slave\" class=\"headerlink\" title=\"2.4为新加入的master添加slave\"></a>2.4为新加入的master添加slave</h4><p>同样需要先加入集群</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./redis-cli --cluster add-node 10.211.55.16:6382 10.211.55.16:6380</span><br></pre></td></tr></table></figure>\n\n<p>之后不需要做分配和平衡槽的操作<br>登录这个redis， <code>./redis-cli -h 10.211.55.16 -p 6382</code></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6382&gt; cluster replicate 316e068fd71ee228299198a271efd839d3493835 #主节点的id</span><br><span class=\"line\">OK</span><br></pre></td></tr></table></figure>\n\n\n<h3 id=\"3-删除节点\"><a href=\"#3-删除节点\" class=\"headerlink\" title=\"3.删除节点\"></a>3.删除节点</h3><h4 id=\"3-1删除主节点\"><a href=\"#3-1删除主节点\" class=\"headerlink\" title=\"3.1删除主节点\"></a>3.1删除主节点</h4><p>删除节点前，节点上的槽要被清空</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./redis-cli --cluster reshard 10.211.55.15:6382 #集群中任意ip即可</span><br></pre></td></tr></table></figure>\n<p>  1.问你是否从原有的1-16384个槽中分配多少到新的主节点我们这里分配4096，即该节点上的槽数<br>    2：然后紧接着会询问你给id为谁的主节点分配，这里我们分配给10.211.55.16:6379，即15506850b235f4277306368533cacf4a5ec1bbd1<br>    3：询问你是从所有的空间去给这个节点分配空间还是从某一个节点分配<br>    我这里输入要移出的节点ID ,即316e068fd71ee228299198a271efd839d3493835 回车继续 输入 done<br>    4：然后会给你分配出一个分配计划，输入yes开始分配。完成ok</p>\n<p>执行删除节点命令</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./redis-cli --cluster del-node 10.211.55.16:6379 316e068fd71ee228299198a271efd839d3493835</span><br><span class=\"line\">Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.</span><br><span class=\"line\"><span class=\"meta\">&gt;</span><span class=\"bash\">&gt;&gt; Removing node 316e068fd71ee228299198a271efd839d3493835 from cluster 10.211.55.16:6379</span></span><br><span class=\"line\"><span class=\"meta\">&gt;</span><span class=\"bash\">&gt;&gt; Sending CLUSTER FORGET messages to the cluster...</span></span><br><span class=\"line\"><span class=\"meta\">&gt;</span><span class=\"bash\">&gt;&gt; SHUTDOWN the node.</span></span><br></pre></td></tr></table></figure>\n\n<p>说明：<br>删除节点会自动关闭被移出的redis服务，此时，该主节点的从节点会自动转为其它主节点的从节点，而不会升级为主节点</p>\n<h4 id=\"3-2删除从节点\"><a href=\"#3-2删除从节点\" class=\"headerlink\" title=\"3.2删除从节点\"></a>3.2删除从节点</h4><p>直接执行节点删除命令</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./redis-cli --cluster del-node 10.211.55.16:6379 从节点ID</span><br></pre></td></tr></table></figure>\n","content_text":"一、摘要看完本文你将掌握如下知识点： redis集群的构建方法【redis-5.0.2】 redis早期的版本中使用基于ruby的redis-trib.rb命令进行集群创建，新版本推荐使用 redis-cli --cluster，本文就是通过redis-cli --cluster命令实现集群构建。 二、快速创建集群redis为我们提供了快速创建集群的工具，安装好redis后，在其/redis-5.0.2/utils/create-cluster/目录下存在一个create-cluster命令，通过该命令可以快速创建一个基于本机端口30001~30006的三主三从的redis集群，可以通过修改端口号及服务数量来改变集群的配置。1.启动6个redis服务，./create-cluster start2.创建集群，./create-cluster create3.关闭集群服务，./create-cluster stop4.清除数据及日志文件，./create-cluster clean 三、源码分析通过看源码可以很清楚其创建过程1.启动6个reids服务，通过参数的方式进行启动，在生产环境中建议通过配置文件启动 1234567891011if [ &quot;$1&quot; == &quot;start&quot; ]then while [ $((PORT &lt; ENDPORT)) != &quot;0&quot; ]; do PORT=$((PORT+1)) echo &quot;Starting $PORT&quot; ../../src/redis-server --port $PORT --cluster-enabled yes --cluster-config-file nodes-$&#123;PORT&#125;.conf --cluster-node-timeout $TIMEOUT --appendonly yes --appendfilename appendonly-$&#123;PORT&#125;.aof --dbfilename dump-$&#123;PORT&#125;.rdb --logfile $&#123;PORT&#125;.log --daemonize yes done exit 0fi 参数说明： 123456789101112131415161718#端口：port $PORT#是否启用集群：cluster-enabled yes#集群关联文件路径，创建redis集群时自动创建cluster-config-file nodes-$&#123;PORT&#125;.conf#集群节点间通信的超时时间，毫秒，建议2000，默认15000cluster-node-timeout $TIMEOUT#开启aofappendonly yes#aof文件名称，注意这里只能是文件名称，若要修改路径需要设置dir属性 ，如dir /home/hanqf/redis-dir/redis-5.0.2/cluster-conf/files/appendfilename appendonly-$&#123;PORT&#125;.aof#rdb文件名称，同样只能是文件名称，同上路径共用dir属性dbfilename dump-$&#123;PORT&#125;.rdb#日志文件路径logfile $&#123;PORT&#125;.log#后台运行模式启动daemonize yes 2.构建集群，这里使用的就是redis-cli --cluster命令，可以看出与redis-trib.rb命令类似 12345678910if [ &quot;$1&quot; == &quot;create&quot; ]then HOSTS=&quot;&quot; while [ $((PORT &lt; ENDPORT)) != &quot;0&quot; ]; do PORT=$((PORT+1)) HOSTS=&quot;$HOSTS 127.0.0.1:$PORT&quot; done ../../src/redis-cli --cluster create $HOSTS --cluster-replicas $REPLICAS exit 0fi create后根的$HOSTS就是redis服务列表 1127.0.0.1:30001 127.0.0.1:30002 127.0.0.1:30003 127.0.0.1:30004 127.0.0.1:30005 127.0.0.1:30006 --cluster-replicas $REPLICAS，这里$REPLICAS值为1，表示为每一个master节点分配一个slave节点 四、实际应用这里我们使用2台服务器，分别启动3个redis服务，来构建一个三主三从的redis集群。 1.服务器IP 10.211.55.15 10.211.55.16 2.端口设置分别开启俩台服务器的如下端口，前面是redis服务端口，后面是集群通信端口（默认服务端口+10000） 1236379，163796380，163806381，16381 3.redis-{port}.conf这里需要按照上面的参数说明进行配置，如我们配置号redis-6379.conf后，可以通过如下命令进行复制 12more redis-6379.conf | sed &#x27;s/6379/6380/g&#x27; &gt; redis-6380.confmore redis-6379.conf | sed &#x27;s/6379/6381/g&#x27; &gt; redis-6381.conf 4.启动服务12345678910#10.211.55.15./redis-server redis-6379.conf./redis-server redis-6380.conf./redis-server redis-6381.conf#10.211.55.16./redis-server redis-6379.conf./redis-server redis-6380.conf./redis-server redis-6381.conf 5.构建集群1./redis-cli --cluster create 10.211.55.15:6379 10.211.55.15:6380 10.211.55.15:6381 10.211.55.16:6379 10.211.55.16:6380 10.211.55.16:6381 --cluster-replicas 1 五、集群相关命令1.健康检查12# 后面可以是集群中任意节点./redis-cli --cluster check 10.211.55.15:6380 输出如下，可以看到集群中的主从关系，以及每个master中含有key的数量： 1234567891011121314151617181920212223242526272810.211.55.15:6380 (c39c1e8a...) -&gt; 2 keys | 5461 slots | 1 slaves.10.211.55.16:6380 (3edc1dae...) -&gt; 5 keys | 5461 slots | 1 slaves.10.211.55.16:6379 (4dd31f17...) -&gt; 2 keys | 5462 slots | 1 slaves.[OK] 9 keys in 3 masters.0.00 keys per slot on average.&gt;&gt;&gt; Performing Cluster Check (using node 10.211.55.15:6380)M: c39c1e8aa6e07e337aaab03eab3727f739201cd2 10.211.55.15:6380 slots:[10923-16383] (5461 slots) master 1 additional replica(s)S: a83903f50621d7627f3ce59f1210af4938b8acc4 10.211.55.15:6381 slots: (0 slots) slave replicates 4dd31f17e83ef7aa6c7a36474f7f54d842e0ed64M: 3edc1daeaf3a848156ad8cc601b1374dd0459d9c 10.211.55.16:6380 slots:[0-5460] (5461 slots) master 1 additional replica(s)M: 4dd31f17e83ef7aa6c7a36474f7f54d842e0ed64 10.211.55.16:6379 slots:[5461-10922] (5462 slots) master 1 additional replica(s)S: cb6a94201d6f5a4e016b1549afc8c976a1a3dda4 10.211.55.15:6379 slots: (0 slots) slave replicates 3edc1daeaf3a848156ad8cc601b1374dd0459d9cS: 3f41a95296cb2681ea599f47aaff9c662b3338ad 10.211.55.16:6381 slots: (0 slots) slave replicates c39c1e8aa6e07e337aaab03eab3727f739201cd2[OK] All nodes agree about slots configuration.&gt;&gt;&gt; Check for open slots...&gt;&gt;&gt; Check slots coverage...[OK] All 16384 slots covered. 说明：此时如果关闭其中一个master节点，那么其对应的从节点就会升级为主节点，当重新启动原master节点后，则该节点会自动加入集群，并作为从节点。 2.集群扩容，即为集群添加新的主机和从机2.1通过如下命令添加新的node说明：10.211.55.15:6382 是新的服务地址，10.211.55.16:6380 是集群中任意一个的服务地址,添加后的服务类型为master。 1./redis-cli --cluster add-node 10.211.55.15:6382 10.211.55.16:6380 此时我们通过健康检查可以看到新加入的服务没有分配槽点： 123456789101112131415161718192021222324252627282930./redis-cli --cluster check 10.211.55.15:6380Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.Could not connect to Redis at 10.211.55.15:6379: Connection refused10.211.55.15:6380 (a5f63b8e...) -&gt; 2 keys | 5461 slots | 1 slaves.10.211.55.16:6379 (15506850...) -&gt; 2 keys | 5462 slots | 1 slaves.10.211.55.15:6382 (316e068f...) -&gt; 0 keys | 0 slots | 0 slaves. #注意，这里新添加的主机没有分配槽（slot），需要先进行分配才能使用10.211.55.16:6380 (d944c0b1...) -&gt; 5 keys | 5461 slots | 0 slaves.[OK] 9 keys in 4 masters.0.00 keys per slot on average.&gt;&gt;&gt; Performing Cluster Check (using node 10.211.55.15:6380)M: a5f63b8e4f24a73d36da9e0bbf84988d7c5558d3 10.211.55.15:6380 slots:[10923-16383] (5461 slots) master 1 additional replica(s)M: 15506850b235f4277306368533cacf4a5ec1bbd1 10.211.55.16:6379 slots:[5461-10922] (5462 slots) master 1 additional replica(s)M: 316e068fd71ee228299198a271efd839d3493835 10.211.55.15:6382 slots: (0 slots) masterS: b3c0e06da5b5d694c3a68408fb4c8f7607d7e9e0 10.211.55.16:6381 slots: (0 slots) slave replicates a5f63b8e4f24a73d36da9e0bbf84988d7c5558d3M: d944c0b19e92af325b882e3a86ff09c2b6b53f47 10.211.55.16:6380 slots:[0-5460] (5461 slots) masterS: 4bce4c24959bda55d087296e86f58ec03186d3ae 10.211.55.15:6381 slots: (0 slots) slave replicates 15506850b235f4277306368533cacf4a5ec1bbd1[OK] All nodes agree about slots configuration.&gt;&gt;&gt; Check for open slots...&gt;&gt;&gt; Check slots coverage...[OK] All 16384 slots covered. 2.2分配槽1./redis-cli --cluster reshard 10.211.55.15:6382 执行命令后会有如下设置： 1.问你是否从原有的1-16384个槽中分配多少到新的主节点，我们这里分配4000为例，回车 2：然后紧接着会询问你给id为谁的主节点分配，这里就是新加的节点10.211.55.15:6382，其对应的Id为:316e068fd71ee228299198a271efd839d3493835 3：询问你是从所有的空间去给这个节点分配空间还是从某一个节点分配，我这里输入all 回车继续 4：然后会给你分配出一个分配计划，输入yes开始分配。完成ok 此时再次运行健康检查可以看到槽点已经分配成功 123456789./redis-cli --cluster check 10.211.55.15:6380Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.localhost:6380 (a5f63b8e...) -&gt; 1 keys | 4128 slots | 1 slaves.10.211.55.16:6379 (15506850...) -&gt; 2 keys | 4128 slots | 1 slaves.10.211.55.15:6382 (316e068f...) -&gt; 2 keys | 4000 slots | 0 slaves.10.211.55.16:6380 (d944c0b1...) -&gt; 4 keys | 4128 slots | 1 slaves.[OK] 9 keys in 4 masters.0.00 keys per slot on average.……………………………… 2.3平衡槽，就是均匀分配集群中的所有槽到所有的节点，该步非必须，只是看着好看点1./redis-cli --cluster rebalance --cluster-threshold 1 10.211.55.15:6382 12345678./redis-cli --cluster info 10.211.55.15:6380Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.localhost:6380 (a5f63b8e...) -&gt; 1 keys | 4096 slots | 1 slaves.10.211.55.16:6379 (15506850...) -&gt; 2 keys | 4096 slots | 1 slaves.10.211.55.15:6382 (316e068f...) -&gt; 2 keys | 4096 slots | 0 slaves.10.211.55.16:6380 (d944c0b1...) -&gt; 4 keys | 4096 slots | 1 slaves.[OK] 9 keys in 4 masters.0.00 keys per slot on average. 2.4为新加入的master添加slave同样需要先加入集群 1./redis-cli --cluster add-node 10.211.55.16:6382 10.211.55.16:6380 之后不需要做分配和平衡槽的操作登录这个redis， ./redis-cli -h 10.211.55.16 -p 6382 12127.0.0.1:6382&gt; cluster replicate 316e068fd71ee228299198a271efd839d3493835 #主节点的idOK 3.删除节点3.1删除主节点删除节点前，节点上的槽要被清空 1./redis-cli --cluster reshard 10.211.55.15:6382 #集群中任意ip即可 1.问你是否从原有的1-16384个槽中分配多少到新的主节点我们这里分配4096，即该节点上的槽数 2：然后紧接着会询问你给id为谁的主节点分配，这里我们分配给10.211.55.16:6379，即15506850b235f4277306368533cacf4a5ec1bbd1 3：询问你是从所有的空间去给这个节点分配空间还是从某一个节点分配 我这里输入要移出的节点ID ,即316e068fd71ee228299198a271efd839d3493835 回车继续 输入 done 4：然后会给你分配出一个分配计划，输入yes开始分配。完成ok 执行删除节点命令 12345./redis-cli --cluster del-node 10.211.55.16:6379 316e068fd71ee228299198a271efd839d3493835Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.&gt;&gt;&gt; Removing node 316e068fd71ee228299198a271efd839d3493835 from cluster 10.211.55.16:6379&gt;&gt;&gt; Sending CLUSTER FORGET messages to the cluster...&gt;&gt;&gt; SHUTDOWN the node. 说明：删除节点会自动关闭被移出的redis服务，此时，该主节点的从节点会自动转为其它主节点的从节点，而不会升级为主节点 3.2删除从节点直接执行节点删除命令 1./redis-cli --cluster del-node 10.211.55.16:6379 从节点ID","summary":"一、摘要看完本文你将掌握如下知识点： redis集群的构建方法【redis-5.0.2】 redis早期的版本中使用基于ruby的redis-trib.rb命令进行集群创建，新版本推荐使用 redis-cli --cluster，本文就是通过redis-cli --cluster命令实现集群构建。","date_published":"2018-12-27T10:24:04.000Z","tags":["技术","redis"]},{"id":"https://blog.hanqunfeng.com/2018/12/12/activemq-springboot/","url":"https://blog.hanqunfeng.com/2018/12/12/activemq-springboot/","title":"Spring Boot2学习笔记--activemq","content_html":"<h2 id=\"摘要\"><a href=\"#摘要\" class=\"headerlink\" title=\"摘要\"></a>摘要</h2><p>看完本文你将掌握如下知识点：</p>\n<ul>\n<li>Spring Boot(2.1.1.RELEASE)中使用<a href=\"http://activemq.apache.org/\">activemq(5.15.8)</a>的方法</li>\n</ul>\n<span id=\"more\"></span>\n\n<h2 id=\"引入依赖\"><a href=\"#引入依赖\" class=\"headerlink\" title=\"引入依赖\"></a>引入依赖</h2><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- activemq自动配置依赖 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">     <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.boot<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">     <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-boot-starter-activemq<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\"> <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- 连接池依赖 --&gt;</span></span><br><span class=\"line\"> <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">     <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.apache.activemq<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">     <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>activemq-pool<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\"> <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"comment\">&lt;!-- 如果springboot是2.x.x的版本如果启用连接池（spring.activemq.pool.enabled=true），就必须引入这个依赖，否则启动时会报错，提示找不到JmsMessagingTemplate</span></span><br><span class=\"line\"><span class=\"comment\">      springboot是1.5.x的版本就不需要引入，</span></span><br><span class=\"line\"><span class=\"comment\">      这是因为springboot1.5.x使用的是org.apache.activemq.pool.PooledConnectionFactory，</span></span><br><span class=\"line\"><span class=\"comment\">      而springboot2.x.x时候用的org.messaginghub.pooled.jms.JmsPoolConnectionFactory，</span></span><br><span class=\"line\"><span class=\"comment\">      可以通过源码查看：</span></span><br><span class=\"line\"><span class=\"comment\">      org.springframework.boot.autoconfigure.jms.activemq.ActiveMQConnectionFactoryConfiguration : 负责初始化ConnectionFactory</span></span><br><span class=\"line\"><span class=\"comment\">      org.springframework.boot.autoconfigure.jms.JmsAutoConfiguration  : 负责初始化JmsMessagingTemplate --&gt;</span></span><br><span class=\"line\"> <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">     <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.messaginghub<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">     <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>pooled-jms<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">     <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>1.0.3<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\"> <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"配置文件\"><a href=\"#配置文件\" class=\"headerlink\" title=\"配置文件\"></a>配置文件</h2><figure class=\"highlight properties\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">spring.activemq.broker-url</span>=<span class=\"string\">tcp://localhost:61616</span></span><br><span class=\"line\"><span class=\"meta\">spring.activemq.user</span>=<span class=\"string\">admin</span></span><br><span class=\"line\"><span class=\"meta\">spring.activemq.password</span>=<span class=\"string\">admin</span></span><br><span class=\"line\"><span class=\"comment\">#启用连接池</span></span><br><span class=\"line\"><span class=\"meta\">spring.activemq.pool.enabled</span>=<span class=\"string\">true</span></span><br><span class=\"line\"><span class=\"comment\">#最大连接数</span></span><br><span class=\"line\"><span class=\"meta\">spring.activemq.pool.max-connections</span>=<span class=\"string\">100</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"配置类\"><a href=\"#配置类\" class=\"headerlink\" title=\"配置类\"></a>配置类</h2><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Configuration</span></span><br><span class=\"line\"><span class=\"meta\">@EnableJms</span> <span class=\"comment\">//启用jms功能</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ActiveMqConfig</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//如果要使用topic类型的消息，则需要配置该bean</span></span><br><span class=\"line\">    <span class=\"meta\">@Bean(&quot;jmsTopicListenerContainerFactory&quot;)</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> JmsListenerContainerFactory <span class=\"title\">jmsTopicListenerContainerFactory</span><span class=\"params\">(</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">            ConnectionFactory connectionFactory</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">    )</span></span>&#123;</span><br><span class=\"line\">        DefaultJmsListenerContainerFactory factory</span><br><span class=\"line\">                = <span class=\"keyword\">new</span> DefaultJmsListenerContainerFactory();</span><br><span class=\"line\">        factory.setConnectionFactory(connectionFactory);</span><br><span class=\"line\">        factory.setPubSubDomain(<span class=\"keyword\">true</span>); <span class=\"comment\">//这里必须设置为true，false则表示是queue类型</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> factory;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Bean(&quot;springboot.queue&quot;)</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Queue <span class=\"title\">queue</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> ActiveMQQueue(<span class=\"string\">&quot;springboot.queue&quot;</span>) ;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Bean(&quot;springboot.topic&quot;)</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Topic <span class=\"title\">topic</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> ActiveMQTopic(<span class=\"string\">&quot;springboot.topic&quot;</span>) ;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Bean(&quot;springboot.queuereply&quot;)</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Queue <span class=\"title\">queuereply</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> ActiveMQQueue(<span class=\"string\">&quot;springboot.queuereply&quot;</span>) ;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"消费者\"><a href=\"#消费者\" class=\"headerlink\" title=\"消费者\"></a>消费者</h2><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Component</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Consumer</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//监听队列，queue类型</span></span><br><span class=\"line\">    <span class=\"meta\">@JmsListener(destination=&quot;springboot.queue.a&quot;)</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">receiveQueueA</span><span class=\"params\">(String text)</span></span>&#123;</span><br><span class=\"line\">        System.out.println(<span class=\"keyword\">this</span>.getClass().getName()+ <span class=\"string\">&quot;收到的报文为:&quot;</span>+text);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@JmsListener(destination=&quot;springboot.*.b&quot;)</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">receiveQueueB</span><span class=\"params\">(String text)</span></span>&#123;</span><br><span class=\"line\">        System.out.println(<span class=\"keyword\">this</span>.getClass().getName()+ <span class=\"string\">&quot;收到的报文为:&quot;</span>+text);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@JmsListener(destination=&quot;springboot.&gt;&quot;)</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">receiveQueueAll</span><span class=\"params\">(String text)</span></span>&#123;</span><br><span class=\"line\">        System.out.println(<span class=\"keyword\">this</span>.getClass().getName()+ <span class=\"string\">&quot;收到的报文为:&quot;</span>+text);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//监听队列，topic类型，这里containerFactory要配置为jmsTopicListenerContainerFactory</span></span><br><span class=\"line\">    <span class=\"meta\">@JmsListener(destination = &quot;springboot.topic&quot;,</span></span><br><span class=\"line\"><span class=\"meta\">            containerFactory = &quot;jmsTopicListenerContainerFactory&quot;</span></span><br><span class=\"line\"><span class=\"meta\">    )</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">receiveTopic</span><span class=\"params\">(String text)</span> </span>&#123;</span><br><span class=\"line\">        System.out.println(<span class=\"keyword\">this</span>.getClass().getName()+<span class=\"string\">&quot; 收到的报文为:&quot;</span>+text);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@JmsListener(destination=&quot;springboot.queuereply&quot;)</span></span><br><span class=\"line\">    <span class=\"meta\">@SendTo(&quot;out.replyTo.queue&quot;)</span> <span class=\"comment\">//消费者应答后通知生产者</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">receiveQueueReply</span><span class=\"params\">(String text)</span></span>&#123;</span><br><span class=\"line\">        System.out.println(<span class=\"keyword\">this</span>.getClass().getName()+ <span class=\"string\">&quot;收到的报文为:&quot;</span>+text);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">&quot;out.replyTo.queue receiveQueueReply&quot;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"生产者\"><a href=\"#生产者\" class=\"headerlink\" title=\"生产者\"></a>生产者</h2><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Component</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Producer</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Resource(&quot;springboot.queue.a&quot;)</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> Queue queuea;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Resource(&quot;springboot.queue.b&quot;)</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> Queue queueb;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Resource(&quot;springboot.topic&quot;)</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> Topic topic;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Resource(&quot;springboot.queuereply&quot;)</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> Queue queuereply;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> JmsMessagingTemplate jmsTemplate;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 发送消息，destination是发送到的队列，message是待发送的消息</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">sendMessage</span><span class=\"params\">(Destination destination, <span class=\"keyword\">final</span> String message)</span></span>&#123;</span><br><span class=\"line\">        jmsTemplate.convertAndSend(destination, message);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">sendQueueAMessage</span><span class=\"params\">(<span class=\"keyword\">final</span> String message)</span></span>&#123;</span><br><span class=\"line\">        sendMessage(queuea, message);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">sendQueueBMessage</span><span class=\"params\">(<span class=\"keyword\">final</span> String message)</span></span>&#123;</span><br><span class=\"line\">        sendMessage(queueb, message);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">sendTopicMessage</span><span class=\"params\">(<span class=\"keyword\">final</span> String message)</span></span>&#123;</span><br><span class=\"line\">        sendMessage(topic, message);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">sendQueueMessageReply</span><span class=\"params\">(<span class=\"keyword\">final</span> String message)</span></span>&#123;</span><br><span class=\"line\">        sendMessage(queuereply, message);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//生产者监听消费者的应答</span></span><br><span class=\"line\">    <span class=\"meta\">@JmsListener(destination = &quot;out.replyTo.queue&quot;)</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">consumerMessage</span><span class=\"params\">(String text)</span></span>&#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;从out.replyTo.queue收到报文&quot;</span>+text);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n","content_text":"摘要看完本文你将掌握如下知识点： Spring Boot(2.1.1.RELEASE)中使用activemq(5.15.8)的方法 引入依赖12345678910111213141516171819202122232425&lt;!-- activemq自动配置依赖 --&gt;&lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-activemq&lt;/artifactId&gt; &lt;/dependency&gt;&lt;!-- 连接池依赖 --&gt; &lt;dependency&gt; &lt;groupId&gt;org.apache.activemq&lt;/groupId&gt; &lt;artifactId&gt;activemq-pool&lt;/artifactId&gt; &lt;/dependency&gt; &lt;!-- 如果springboot是2.x.x的版本如果启用连接池（spring.activemq.pool.enabled=true），就必须引入这个依赖，否则启动时会报错，提示找不到JmsMessagingTemplate springboot是1.5.x的版本就不需要引入， 这是因为springboot1.5.x使用的是org.apache.activemq.pool.PooledConnectionFactory， 而springboot2.x.x时候用的org.messaginghub.pooled.jms.JmsPoolConnectionFactory， 可以通过源码查看： org.springframework.boot.autoconfigure.jms.activemq.ActiveMQConnectionFactoryConfiguration : 负责初始化ConnectionFactory org.springframework.boot.autoconfigure.jms.JmsAutoConfiguration : 负责初始化JmsMessagingTemplate --&gt; &lt;dependency&gt; &lt;groupId&gt;org.messaginghub&lt;/groupId&gt; &lt;artifactId&gt;pooled-jms&lt;/artifactId&gt; &lt;version&gt;1.0.3&lt;/version&gt; &lt;/dependency&gt; 配置文件1234567spring.activemq.broker-url=tcp://localhost:61616spring.activemq.user=adminspring.activemq.password=admin#启用连接池spring.activemq.pool.enabled=true#最大连接数spring.activemq.pool.max-connections=100 配置类12345678910111213141516171819202122232425262728293031323334@Configuration@EnableJms //启用jms功能public class ActiveMqConfig &#123; //如果要使用topic类型的消息，则需要配置该bean @Bean(&quot;jmsTopicListenerContainerFactory&quot;) public JmsListenerContainerFactory jmsTopicListenerContainerFactory( ConnectionFactory connectionFactory )&#123; DefaultJmsListenerContainerFactory factory = new DefaultJmsListenerContainerFactory(); factory.setConnectionFactory(connectionFactory); factory.setPubSubDomain(true); //这里必须设置为true，false则表示是queue类型 return factory; &#125; @Bean(&quot;springboot.queue&quot;) public Queue queue() &#123; return new ActiveMQQueue(&quot;springboot.queue&quot;) ; &#125; @Bean(&quot;springboot.topic&quot;) public Topic topic() &#123; return new ActiveMQTopic(&quot;springboot.topic&quot;) ; &#125; @Bean(&quot;springboot.queuereply&quot;) public Queue queuereply() &#123; return new ActiveMQQueue(&quot;springboot.queuereply&quot;) ; &#125;&#125; 消费者1234567891011121314151617181920212223242526272829303132333435@Componentpublic class Consumer &#123; //监听队列，queue类型 @JmsListener(destination=&quot;springboot.queue.a&quot;) public void receiveQueueA(String text)&#123; System.out.println(this.getClass().getName()+ &quot;收到的报文为:&quot;+text); &#125; @JmsListener(destination=&quot;springboot.*.b&quot;) public void receiveQueueB(String text)&#123; System.out.println(this.getClass().getName()+ &quot;收到的报文为:&quot;+text); &#125; @JmsListener(destination=&quot;springboot.&gt;&quot;) public void receiveQueueAll(String text)&#123; System.out.println(this.getClass().getName()+ &quot;收到的报文为:&quot;+text); &#125; //监听队列，topic类型，这里containerFactory要配置为jmsTopicListenerContainerFactory @JmsListener(destination = &quot;springboot.topic&quot;, containerFactory = &quot;jmsTopicListenerContainerFactory&quot; ) public void receiveTopic(String text) &#123; System.out.println(this.getClass().getName()+&quot; 收到的报文为:&quot;+text); &#125; @JmsListener(destination=&quot;springboot.queuereply&quot;) @SendTo(&quot;out.replyTo.queue&quot;) //消费者应答后通知生产者 public String receiveQueueReply(String text)&#123; System.out.println(this.getClass().getName()+ &quot;收到的报文为:&quot;+text); return &quot;out.replyTo.queue receiveQueueReply&quot;; &#125;&#125; 生产者123456789101112131415161718192021222324252627282930313233343536373839404142434445@Componentpublic class Producer &#123; @Resource(&quot;springboot.queue.a&quot;) private Queue queuea; @Resource(&quot;springboot.queue.b&quot;) private Queue queueb; @Resource(&quot;springboot.topic&quot;) private Topic topic; @Resource(&quot;springboot.queuereply&quot;) private Queue queuereply; @Autowired private JmsMessagingTemplate jmsTemplate; // 发送消息，destination是发送到的队列，message是待发送的消息 public void sendMessage(Destination destination, final String message)&#123; jmsTemplate.convertAndSend(destination, message); &#125; public void sendQueueAMessage(final String message)&#123; sendMessage(queuea, message); &#125; public void sendQueueBMessage(final String message)&#123; sendMessage(queueb, message); &#125; public void sendTopicMessage(final String message)&#123; sendMessage(topic, message); &#125; public void sendQueueMessageReply(final String message)&#123; sendMessage(queuereply, message); &#125; //生产者监听消费者的应答 @JmsListener(destination = &quot;out.replyTo.queue&quot;) public void consumerMessage(String text)&#123; System.out.println(&quot;从out.replyTo.queue收到报文&quot;+text); &#125;&#125;","summary":"摘要看完本文你将掌握如下知识点： Spring Boot(2.1.1.RELEASE)中使用activemq(5.15.8)的方法","date_published":"2018-12-12T09:24:04.000Z","tags":["技术","springboot2","Java","springboot","activemq"]},{"id":"https://blog.hanqunfeng.com/2018/04/28/python_virtualenv/","url":"https://blog.hanqunfeng.com/2018/04/28/python_virtualenv/","title":"Python--virtualenv","content_html":"<h2 id=\"摘要\"><a href=\"#摘要\" class=\"headerlink\" title=\"摘要\"></a>摘要</h2><p>官方网站：<a href=\"https://virtualenv.pypa.io/en/stable/installation/\">https://virtualenv.pypa.io/en/stable/installation/</a></p>\n<ul>\n<li>执行python项目时都需要为其安装运行环境需要的依赖，比如有些项目需要在python2下运行，有些项目需要在python3下运行，有些项目需要安装mysqlclient依赖，有些项目需要django依赖，如果这些依赖都被安装在统一的系统环境中，势必彼此之间会造成干扰，特别是需要同一个依赖的不同版本时更是难以维护；</li>\n<li>virtualenv可以为python项目创建独立的虚拟运行环境，这样不同的项目可以运行在各自独立的执行环境中而彼此之间不受干扰；</li>\n<li>在使用pycharm创建项目时，需要指定python执行器，此时就是创建的虚拟环境。<span id=\"more\"></span></li>\n</ul>\n<h2 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h2><p><code>pip3 install virtualenv</code></p>\n<ul>\n<li>本文使用python3的pip命令安装virtualenv，所以默认情况下创建虚拟环境时都是python3的执行环境，可以通过<code>--python</code>参数指定python的执行环境，详见下文『创建新的虚拟环境』</li>\n</ul>\n<h2 id=\"创建新的虚拟环境\"><a href=\"#创建新的虚拟环境\" class=\"headerlink\" title=\"创建新的虚拟环境\"></a>创建新的虚拟环境</h2><p><code>virtualenv venv1</code> # 当前目录下创建venv1文件夹，并在其下创建python环境</p>\n<ul>\n<li><p>默认情况下，除了python本身的命令外不包含系统环境下的第三方依赖，比如系统环境已经安装好django、mysqlclient等，都不会带过来，需要重新在当前虚拟环境下安装。</p>\n</li>\n<li><p>如果希望访问系统环境中的某些第三方依赖，可以在创建虚拟环境时执行如下命令：<br><code>virtualenv venv1 --system-site-packages</code> #此时当前虚拟环境就可以访问系统环境了</p>\n</li>\n<li><p>python本身支持python2和python3同时共存，可以指定python命令路径，比如使用python2的环境</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">virtualenv --python=`which python` venv1</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h2 id=\"激活虚拟环境\"><a href=\"#激活虚拟环境\" class=\"headerlink\" title=\"激活虚拟环境\"></a>激活虚拟环境</h2><p><code>source activate</code></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cd venv1/bin</span><br><span class=\"line\">hanqunfengdeMacBook-Pro:bin hanqunfeng$ source activate</span><br><span class=\"line\">(venv1) hanqunfengdeMacBook-Pro:bin hanqunfeng$</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>激活后所有python相关命令都变为venv1下的命令了</li>\n</ul>\n<h2 id=\"退出虚拟环境\"><a href=\"#退出虚拟环境\" class=\"headerlink\" title=\"退出虚拟环境\"></a>退出虚拟环境</h2><p><code>deactivate</code></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">(venv1) hanqunfengdeMacBook-Pro:bin hanqunfeng$ deactivate</span><br><span class=\"line\">hanqunfengdeMacBook-Pro:bin hanqunfeng$</span><br></pre></td></tr></table></figure>\n<h2 id=\"删除虚拟环境\"><a href=\"#删除虚拟环境\" class=\"headerlink\" title=\"删除虚拟环境\"></a>删除虚拟环境</h2><p><code>rm -rf venv1</code> 删除venv1目录即可</p>\n","content_text":"摘要官方网站：https://virtualenv.pypa.io/en/stable/installation/ 执行python项目时都需要为其安装运行环境需要的依赖，比如有些项目需要在python2下运行，有些项目需要在python3下运行，有些项目需要安装mysqlclient依赖，有些项目需要django依赖，如果这些依赖都被安装在统一的系统环境中，势必彼此之间会造成干扰，特别是需要同一个依赖的不同版本时更是难以维护； virtualenv可以为python项目创建独立的虚拟运行环境，这样不同的项目可以运行在各自独立的执行环境中而彼此之间不受干扰； 在使用pycharm创建项目时，需要指定python执行器，此时就是创建的虚拟环境。 安装pip3 install virtualenv 本文使用python3的pip命令安装virtualenv，所以默认情况下创建虚拟环境时都是python3的执行环境，可以通过--python参数指定python的执行环境，详见下文『创建新的虚拟环境』 创建新的虚拟环境virtualenv venv1 # 当前目录下创建venv1文件夹，并在其下创建python环境 默认情况下，除了python本身的命令外不包含系统环境下的第三方依赖，比如系统环境已经安装好django、mysqlclient等，都不会带过来，需要重新在当前虚拟环境下安装。 如果希望访问系统环境中的某些第三方依赖，可以在创建虚拟环境时执行如下命令：virtualenv venv1 --system-site-packages #此时当前虚拟环境就可以访问系统环境了 python本身支持python2和python3同时共存，可以指定python命令路径，比如使用python2的环境 1virtualenv --python=`which python` venv1 激活虚拟环境source activate 123cd venv1/binhanqunfengdeMacBook-Pro:bin hanqunfeng$ source activate(venv1) hanqunfengdeMacBook-Pro:bin hanqunfeng$ 激活后所有python相关命令都变为venv1下的命令了 退出虚拟环境deactivate 12(venv1) hanqunfengdeMacBook-Pro:bin hanqunfeng$ deactivatehanqunfengdeMacBook-Pro:bin hanqunfeng$ 删除虚拟环境rm -rf venv1 删除venv1目录即可","summary":"摘要官方网站：https://virtualenv.pypa.io/en/stable/installation/ 执行python项目时都需要为其安装运行环境需要的依赖，比如有些项目需要在python2下运行，有些项目需要在python3下运行，有些项目需要安装mysqlclient依赖，有些项目需要django依赖，如果这些依赖都被安装在统一的系统环境中，势必彼此之间会造成干扰，特别是需要同一个依赖的不同版本时更是难以维护； virtualenv可以为python项目创建独立的虚拟运行环境，这样不同的项目可以运行在各自独立的执行环境中而彼此之间不受干扰； 在使用pycharm创建项目时，需要指定python执行器，此时就是创建的虚拟环境。","date_published":"2018-04-28T15:33:15.000Z","tags":["技术","Python"]}]}