{"version":"https://jsonfeed.org/version/1","name":"飘逸峰的博客","home_page_url":"https://blog.hanqunfeng.com","feed_url":"https://blog.hanqunfeng.com/feed.json","author":{"name":"飘逸峰"},"items":[{"id":"https://blog.hanqunfeng.com/2025/05/13/jvm-tools-01/","url":"https://blog.hanqunfeng.com/2025/05/13/jvm-tools-01/","title":"JVM 之 命令行工具","content_html":"<!--\n **加粗**\n *斜体*\n ***加粗并斜体***\n ~~删除线~~\n ==突出显示==\n `突出显示(推荐)`\n ++下划线++\n ~下标~\n ^上标^\n 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.\n 图片设置宽度和高度(通过uPic上传后，需要将upic修改过为blog，用于添加水印) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)\n\n +++ **点击折叠**\n 这是被隐藏的内容\n +++\n\n::: tips success warning danger\n这里是容器内的内容\n:::\n\n% note info % success warning danger\n这里是容器内的内容\n% endnote %\n\n引用本地其它文章连接{}\n 大括号开始% post_link 文件名称(不包含.md) %大括号结束\n -->\n<h2 id=\"摘要\">摘要</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>本文介绍JVM的命令行工具</p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://docs.oracle.com/javase/specs/jvms/se8/html/index.html\">The Java® Virtual Machine Specification</a> 版本jdk1.8</p>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"JVM-的参数-三类\">JVM 的参数(三类)</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>标准参数: 以<code>-</code>开头，所有 HotSpot 都⽀持。例如<code>java -version</code>。这类参数可以使⽤<code>java -help</code> 或者<code>java -?</code>全部打印出来</p>\n</li>\n<li class=\"lvl-2\">\n<p>⾮标准参数: 以<code>-X</code>开头，是特定 HotSpot版本⽀持的指令。例如<code>java -Xms200M -Xmx200M</code>。这类指令可以⽤<code>java -X</code> 全部打印出来。</p>\n</li>\n<li class=\"lvl-2\">\n<p>不稳定参数: 这也是 JVM调优的噩梦。以<code>-XX</code> 开头，这些参数是跟特定HotSpot版本对应的，很有可能换个版本就没有了。详细的⽂档资料也特别少。JDK8 中的以下⼏个指令可以帮助开发者了解 JDK8 中的这⼀类不稳定参数。</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">java -XX:+PrintFlagsInitial -version   <span class=\"comment\"># 所有参数的默认值</span></span><br><span class=\"line\">java -XX:+PrintFlagsFinal -version      <span class=\"comment\"># 所有参数最终⽣效的值。</span></span><br><span class=\"line\">java -XX:+UnlockExperimentalVMOptions -XX:+PrintFlagsFinal -version      <span class=\"comment\"># 所有参数最终⽣效的值，包含实验性参数。</span></span><br><span class=\"line\">java -XX:+PrintCommandLineFlags -version <span class=\"comment\"># 当前命令生效的值，可以看到是⽤的哪种GC。 JDK1.8默认⽤的ParallelGC</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"运行-java-XX-UnlockExperimentalVMOptions-XX-PrintFlagsFinal-version-返回值说明\">运行 <code>java -XX:+UnlockExperimentalVMOptions -XX:+PrintFlagsFinal -version</code> 返回值说明</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[Global flags]</span><br><span class=\"line\">     intx ActiveProcessorCount                      = -1                                  &#123;product&#125;</span><br><span class=\"line\">    uintx AdaptiveSizeDecrementScaleFactor          = 4                                   &#123;product&#125;</span><br><span class=\"line\">    uintx AdaptiveSizeMajorGCDecayTimeScale         = 10                                  &#123;product&#125;</span><br><span class=\"line\">    uintx AdaptiveSizePausePolicy                   = 0                                   &#123;product&#125;</span><br><span class=\"line\">    uintx AdaptiveSizePolicyCollectionCostMargin    = 50                                  &#123;product&#125;</span><br><span class=\"line\">    uintx AdaptiveSizePolicyInitializingSteps       = 20                                  &#123;product&#125;</span><br><span class=\"line\">    uintx AdaptiveSizePolicyOutputInterval          = 0                                   &#123;product&#125;</span><br><span class=\"line\">    uintx AdaptiveSizePolicyWeight                  = 10                                  &#123;product&#125;</span><br><span class=\"line\">    uintx AdaptiveSizeThroughPutPolicy              = 0                                   &#123;product&#125;</span><br><span class=\"line\">    uintx AdaptiveTimeWeight                        = 25                                  &#123;product&#125;</span><br><span class=\"line\">     bool AdjustConcurrency                         = <span class=\"literal\">false</span>                               &#123;product&#125;</span><br><span class=\"line\">     bool AggressiveHeap                            = <span class=\"literal\">false</span>                               &#123;product&#125;</span><br><span class=\"line\">     bool AggressiveOpts                            = <span class=\"literal\">false</span>                               &#123;product&#125;</span><br><span class=\"line\">     intx AliasLevel                                = 3                                   &#123;C2 product&#125;</span><br><span class=\"line\">     ………………………………</span><br><span class=\"line\"><span class=\"comment\"># 格式：flag类型，flag名称，flag值，flag来源与作用域修饰符</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>flag类型:</p>\n</li>\n</ul>\n<blockquote>\n<p>jdk8</p>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th>标识符</th>\n<th>含义</th>\n<th>描述说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>intx</code></td>\n<td>有符号整数（int extended）</td>\n<td>用于表示带符号整数型参数</td>\n</tr>\n<tr>\n<td><code>uintx</code></td>\n<td>无符号整数（unsigned int extended）</td>\n<td>表示非负整数型参数</td>\n</tr>\n<tr>\n<td><code>uint64_t</code></td>\n<td>无符号 64 位整数</td>\n<td>适用于需要更大整数值的参数，比如内存大小、纳秒时间戳等</td>\n</tr>\n<tr>\n<td><code>bool</code></td>\n<td>布尔型</td>\n<td><code>true</code> 或 <code>false</code>，表示开关型参数</td>\n</tr>\n<tr>\n<td><code>double</code></td>\n<td>双精度浮点型</td>\n<td>用于表示浮点数值类型的 JVM 参数</td>\n</tr>\n<tr>\n<td><code>ccstr</code></td>\n<td>常量 C 字符串指针</td>\n<td>表示字符串参数（不可变）</td>\n</tr>\n<tr>\n<td><code>ccstrlist</code></td>\n<td>C 字符串列表</td>\n<td>表示以逗号分隔的字符串列表</td>\n</tr>\n</tbody>\n</table>\n<blockquote>\n<p>jdk11后出现更多的类型</p>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th>标识符</th>\n<th>含义</th>\n<th>描述说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>int</code></td>\n<td>有符号整数,通常是 32 位</td>\n<td>JVM 内部使用的普通 int 参数</td>\n</tr>\n<tr>\n<td><code>uint</code></td>\n<td>无符号整数,通常是 32 位</td>\n<td>少量用于特殊场景的参数</td>\n</tr>\n<tr>\n<td><code>size_t</code></td>\n<td>内存大小</td>\n<td>表示内存大小参数（单位一般为字节）,jdk11后出现，原来是 <code>uintx</code></td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>flag来源与作用域修饰符</p>\n</li>\n</ul>\n<blockquote>\n<p>jdk8</p>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th>标记</th>\n<th>含义</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>&#123;product&#125;</code></td>\n<td>正式产品参数（用户可用，可通过 <code>-XX:</code> 进行设置）</td>\n</tr>\n<tr>\n<td><code>&#123;pd product&#125;</code></td>\n<td>平台相关的正式参数（platform-dependent），在某些操作系统/CPU 上可用</td>\n</tr>\n<tr>\n<td><code>&#123;C1 product&#125;</code></td>\n<td>仅在使用 <strong>C1 编译器（优化编译器）</strong> 时有效的参数</td>\n</tr>\n<tr>\n<td><code>&#123;C2 product&#125;</code></td>\n<td>仅在使用 <strong>C2 编译器（优化编译器）</strong> 时有效的参数</td>\n</tr>\n<tr>\n<td><code>&#123;manageable&#125;</code></td>\n<td>可通过 JMX 动态管理的参数（运行时可调整）</td>\n</tr>\n<tr>\n<td><code>&#123;ARCH product&#125;</code></td>\n<td>与 CPU 架构相关的产品参数（如 x86、ARM 等）</td>\n</tr>\n<tr>\n<td><code>&#123;lp64_product&#125;</code></td>\n<td>仅在 64 位 JVM 上才有效的产品参数</td>\n</tr>\n<tr>\n<td><code>&#123;experimental&#125;</code></td>\n<td>实验性的 参数，可能在将来的版本中删除或更改。需要开启 -XX:+UnlockExperimentalVMOptions</td>\n</tr>\n</tbody>\n</table>\n<blockquote>\n<p>jdk11后出现更多的类型</p>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th>标记</th>\n<th>含义</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>&#123;C1 pd product&#125;</code></td>\n<td>平台相关的正式参数,仅在使用 <strong>C1 编译器（优化编译器）</strong> 时有效的参数</td>\n</tr>\n<tr>\n<td><code>&#123;C2 pd product&#125;</code></td>\n<td>平台相关的正式参数,仅在使用 <strong>C2 编译器（优化编译器）</strong> 时有效的参数</td>\n</tr>\n<tr>\n<td><code>&#123;JVMCI product&#125;</code></td>\n<td>此参数适用于 JVMCI 或 Graal 编译器相关功能，jdk21添加</td>\n</tr>\n</tbody>\n</table>\n<blockquote>\n<p>另外，jdk11+ 中，最后还会多出一列，其作用是说明该参数的设置来源</p>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th>来源标识</th>\n<th>含义说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>&#123;default&#125;</code></td>\n<td>使用的是该参数的默认值（没有被用户或系统设置）</td>\n</tr>\n<tr>\n<td><code>&#123;command line&#125;</code></td>\n<td>用户通过命令行显式设置的参数（如 <code>-XX:+UseG1GC</code>）</td>\n</tr>\n<tr>\n<td><code>&#123;ergonomic&#125;</code></td>\n<td>JVM 根据系统环境自动选择的值（自适应设置）</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"jps-查看当前jvm中的进程\">jps: 查看当前jvm中的进程</h2>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看java进程ID</span></span><br><span class=\"line\">jps</span><br><span class=\"line\"><span class=\"comment\"># 查看java进程信息，包括ID和启动类或jar的名称</span></span><br><span class=\"line\">jps -l</span><br><span class=\"line\"><span class=\"comment\"># 查看启动java进程时传递给jvm的参数设置</span></span><br><span class=\"line\">jps -v</span><br><span class=\"line\"><span class=\"comment\"># 查看java进程信息，同时显示启动java进程时传递给jvm的参数设置</span></span><br><span class=\"line\">jps -lv</span><br></pre></td></tr></table></figure>\n<h2 id=\"jinfo-查看JVM参数\">jinfo: 查看JVM参数</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>jinfo 是 JDK 自带的命令行工具之一，用于 查看和修改正在运行中的 Java 进程的配置信息，主要包括 JVM 参数、系统属性等信息。</p>\n</li>\n<li class=\"lvl-2\">\n<p>在 Java 9+ 之后被标记为 deprecated，建议改用 jcmd 替代</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看正在运行的 JVM 参数</span></span><br><span class=\"line\">jinfo &lt;PID&gt;</span><br><span class=\"line\"><span class=\"comment\"># jcmd 命令，分成三个</span></span><br><span class=\"line\">jcmd &lt;pid&gt; VM.flags <span class=\"comment\"># VM Flags</span></span><br><span class=\"line\">jcmd &lt;pid&gt; VM.system_properties <span class=\"comment\"># System Properties</span></span><br><span class=\"line\">jcmd &lt;pid&gt; VM.command_line <span class=\"comment\"># Command Line</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看指定进程的系统属性（-sysprops）</span></span><br><span class=\"line\">jinfo -sysprops &lt;PID&gt;</span><br><span class=\"line\"><span class=\"comment\"># jcmd 命令</span></span><br><span class=\"line\">jcmd &lt;pid&gt; VM.system_properties</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 动态修改 JVM 参数（仅支持部分参数）</span></span><br><span class=\"line\">jinfo -flag [+|-]&lt;flagname&gt; &lt;pid&gt;</span><br><span class=\"line\"><span class=\"comment\">## 例：打开 GC 日志</span></span><br><span class=\"line\">jinfo -flag +PrintGC &lt;pid&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 检查是否开启了某个 JVM 特性（如 UseG1GC）</span></span><br><span class=\"line\">jinfo -flag UseG1GC &lt;pid&gt;</span><br></pre></td></tr></table></figure>\n<h2 id=\"jstat-查看指定JAVA进程的运行状态\">jstat: 查看指定JAVA进程的运行状态</h2>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看运行状态</span></span><br><span class=\"line\">jstat -gc &lt;PID&gt;</span><br><span class=\"line\"><span class=\"comment\"># 查看运行状态，每隔5000毫秒输出一次，共输出20次</span></span><br><span class=\"line\">jstat -gc &lt;PID&gt; 5000 20</span><br><span class=\"line\"><span class=\"comment\"># 输出</span></span><br><span class=\"line\"> S0C    S1C    S0U    S1U      EC       EU        OC         OU       MC     MU    CCSC   CCSU   YGC     YGCT    FGC    FGCT     GCT</span><br><span class=\"line\">512.0  512.0   0.0   224.0  29696.0  27138.2   105984.0   96531.8   122368.0 114450.4 15360.0 14018.9    733    5.099   4      0.833    5.931</span><br><span class=\"line\">512.0  512.0   0.0   224.0  29696.0  27203.9   105984.0   96531.8   122368.0 114450.4 15360.0 14018.9    733    5.099   4      0.833    5.931</span><br><span class=\"line\">512.0  512.0   0.0   224.0  29696.0  27220.4   105984.0   96531.8   122368.0 114450.4 15360.0 14018.9    733    5.099   4      0.833    5.931</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>内存区统计（单位：KB）</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>列名</th>\n<th>含义说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>S0C</strong></td>\n<td>Survivor 0 区的容量（KB）</td>\n</tr>\n<tr>\n<td><strong>S1C</strong></td>\n<td>Survivor 1 区的容量（KB）</td>\n</tr>\n<tr>\n<td><strong>S0U</strong></td>\n<td>Survivor 0 区已使用内存（KB）</td>\n</tr>\n<tr>\n<td><strong>S1U</strong></td>\n<td>Survivor 1 区已使用内存（KB）</td>\n</tr>\n<tr>\n<td><strong>EC</strong></td>\n<td>Eden 区的容量（KB）</td>\n</tr>\n<tr>\n<td><strong>EU</strong></td>\n<td>Eden 区已使用内存（KB）</td>\n</tr>\n<tr>\n<td><strong>OC</strong></td>\n<td>Old Generation（老年代）的容量（KB）</td>\n</tr>\n<tr>\n<td><strong>OU</strong></td>\n<td>Old Generation 已使用内存（KB）</td>\n</tr>\n<tr>\n<td><strong>MC</strong></td>\n<td>Metaspace（元空间）的容量（KB）</td>\n</tr>\n<tr>\n<td><strong>MU</strong></td>\n<td>Metaspace 已使用内存（KB）</td>\n</tr>\n<tr>\n<td><strong>CCSC</strong></td>\n<td>Compressed Class Space 的容量（KB）</td>\n</tr>\n<tr>\n<td><strong>CCSU</strong></td>\n<td>Compressed Class Space 已使用内存（KB）</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>GC 次数与耗时(从应用程序启动到采样时)</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>列名</th>\n<th>含义说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>YGC</strong></td>\n<td>Young GC（Minor GC） 的累计次数</td>\n</tr>\n<tr>\n<td><strong>YGCT</strong></td>\n<td>Young GC 累计耗时（单位：秒）</td>\n</tr>\n<tr>\n<td><strong>FGC</strong></td>\n<td>Full GC 的累计次数</td>\n</tr>\n<tr>\n<td><strong>FGCT</strong></td>\n<td>Full GC 累计耗时（单位：秒）</td>\n</tr>\n<tr>\n<td><strong>GCT</strong></td>\n<td>GC 总耗时（YGCT + FGCT，总和）</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"jstack-查看指定JAVA进程中各线程的调用堆栈\">jstack: 查看指定JAVA进程中各线程的调用堆栈</h2>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 打印线程的标准栈信息（栈帧 + 线程状态）</span></span><br><span class=\"line\">jstack &lt;PID&gt;</span><br><span class=\"line\"><span class=\"comment\"># 在标准输出基础上，额外打印线程拥有的锁（monitor）和 waited on 锁对象信息</span></span><br><span class=\"line\">jstack -l &lt;PID&gt;</span><br><span class=\"line\"><span class=\"comment\"># 输出到文件</span></span><br><span class=\"line\">jstack -l &lt;PID&gt; &gt; jstack.tdump <span class=\"comment\"># 这个文件名后缀只是为了方便 jvisualvm 查看</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 输出</span></span><br><span class=\"line\"><span class=\"string\">&quot;idle-connection-reaper&quot;</span> <span class=\"comment\">#68 daemon prio=5 os_prio=0 tid=0x00007f38b6ae2800 nid=0x62e9 waiting on condition [0x00007f385b0f5000]</span></span><br><span class=\"line\">   java.lang.Thread.State: TIMED_WAITING (sleeping)</span><br><span class=\"line\">\tat java.lang.Thread.<span class=\"built_in\">sleep</span>(Native Method)</span><br><span class=\"line\">\tat software.amazon.awssdk.http.apache.internal.conn.IdleConnectionReaper<span class=\"variable\">$ReaperTask</span>.run(IdleConnectionReaper.java:151)</span><br><span class=\"line\">\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)</span><br><span class=\"line\">\tat java.util.concurrent.ThreadPoolExecutor<span class=\"variable\">$Worker</span>.run(ThreadPoolExecutor.java:624)</span><br><span class=\"line\">\tat java.lang.Thread.run(Thread.java:750)</span><br><span class=\"line\"></span><br><span class=\"line\">   Locked ownable synchronizers:</span><br><span class=\"line\">\t- &lt;0x00000000c561cfd8&gt; (a java.util.concurrent.ThreadPoolExecutor<span class=\"variable\">$Worker</span>)</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>jstack输出内容含义</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>字段</th>\n<th>含义</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>&quot;idle-connection-reaper&quot;</code></td>\n<td>线程名称。这个线程是 AWS SDK 中用于清理空闲连接的后台线程。</td>\n</tr>\n<tr>\n<td><code>#68</code></td>\n<td>线程 ID（Java 层分配的编号）。</td>\n</tr>\n<tr>\n<td><code>daemon</code></td>\n<td>表示这是一个 <strong>守护线程</strong>。JVM 退出时不会等待守护线程运行结束。</td>\n</tr>\n<tr>\n<td><code>prio=5</code></td>\n<td>Java 层的线程优先级（默认 1–10，5 是默认）。</td>\n</tr>\n<tr>\n<td><code>os_prio=0</code></td>\n<td>操作系统层线程优先级（取决于操作系统和 JVM 的实现）。</td>\n</tr>\n<tr>\n<td><code>tid=0x00007f38b6ae2800</code></td>\n<td>线程 ID（Java 层使用的地址标识）。</td>\n</tr>\n<tr>\n<td><code>nid=0x62e9</code></td>\n<td>Native ID，操作系统分配的线程 ID（十六进制表示），可以通过命令<code>printf &quot;%d\\n&quot; 0x62e9</code>转换为10进制。<br>  <code>ps -Lp &lt;PID&gt;</code> 和 <code>top -Hp &lt;PID&gt;</code> 展示的线程id是10进制</td>\n</tr>\n<tr>\n<td><code>waiting on condition</code></td>\n<td>线程状态说明：正在等待某种条件，一般指 <code>sleep()</code> 或 <code>wait()</code> 等。</td>\n</tr>\n<tr>\n<td><code>[0x00007f385b0f5000]</code></td>\n<td>栈帧的内存地址。</td>\n</tr>\n<tr>\n<td><code>java.lang.Thread.State: TIMED_WAITING (sleeping)</code></td>\n<td>线程状态。</td>\n</tr>\n<tr>\n<td><code>at java.lang.Thread.sleep(Native Method)</code> <br> …………………………</td>\n<td>线程调用栈信息，包括调用方法、调用参数、调用栈帧。</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>另外还有如下信息，表示此线程持有的可拥有同步器（例如 ReentrantLock），具体内容如下：</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Locked ownable synchronizers:</span><br><span class=\"line\">\t- &lt;0x00000000c561cfd8&gt; (a java.util.concurrent.ThreadPoolExecutor<span class=\"variable\">$Worker</span>)</span><br></pre></td></tr></table></figure>\n<table>\n<thead>\n<tr>\n<th>内容</th>\n<th>含义</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>&lt;0x00000000c561cfd8&gt;</code></td>\n<td>持有锁的对象地址。可以在其他线程中查找这个地址，以判断死锁等问题。</td>\n</tr>\n<tr>\n<td><code>(a ThreadPoolExecutor$Worker)</code></td>\n<td>表示该锁属于 <code>ThreadPoolExecutor</code> 的某个 <code>Worker</code> 线程（这是线程池的工作线程）。</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>线程状态</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>状态</th>\n<th>含义</th>\n<th>常见原因 / 示例方法</th>\n<th>示例 jstack 输出</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>RUNNABLE</code></td>\n<td>线程正在运行或准备运行，等待 CPU 时间片。</td>\n<td>线程活跃运行中</td>\n<td><code>&quot;Thread-0&quot; #1 prio=5 os_prio=0 tid=0x00007f8d9c001000 nid=0x1a runnable [0x00007f8dbf7fe000]</code></td>\n</tr>\n<tr>\n<td><code>BLOCKED (on object monitor)</code></td>\n<td>等待获取对象的监视器锁（同步锁），即等待进入同步块或方法。</td>\n<td><code>synchronized</code> 同步块或方法</td>\n<td><code>&quot;Thread-1&quot; #2 prio=5 os_prio=0 tid=0x00007f8d9c002000 nid=0x1b waiting for monitor entry [0x00007f8dbeaff000]</code></td>\n</tr>\n<tr>\n<td><code>WAITING (on object monitor)</code></td>\n<td>无限期等待其他线程执行某操作。</td>\n<td><code>Object.wait()</code><br><code>Thread.join()</code><br><code>LockSupport.park()</code><br><code>Condition.await()</code></td>\n<td><code>&quot;Thread-2&quot; #3 prio=5 os_prio=0 tid=0x00007f8d9c003000 nid=0x1c waiting on condition [0x00007f8dbebff000]</code></td>\n</tr>\n<tr>\n<td><code>TIMED_WAITING (on object monitor)</code></td>\n<td>等待固定时间，直到条件满足或超时。</td>\n<td><code>Object.wait(long)</code><br><code>Thread.sleep(long)</code><br><code>Condition.awaitNanos(long)</code><br><code>DelayQueue.take()</code></td>\n<td><code>&quot;Thread-3&quot; #4 prio=5 os_prio=0 tid=0x00007f8d9c004000 nid=0x1d timed_waiting [0x00007f8dbebff000]</code></td>\n</tr>\n<tr>\n<td><code>TERMINATED</code></td>\n<td>线程已运行完毕并退出（通常不在 jstack 中显示）。</td>\n<td>-</td>\n<td>-</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"使用jstack检查死锁\">使用jstack检查死锁</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>死锁是指多个线程互相等待对方释放锁，导致无法继续运行的情况。</p>\n</li>\n</ul>\n<h4 id=\"直接查找-Found-one-Java-level-deadlock-提示\">直接查找 <code>Found one Java-level deadlock</code> 提示</h4>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Found one Java-level deadlock:</span><br><span class=\"line\">=============================</span><br><span class=\"line\"><span class=\"string\">&quot;Thread-1&quot;</span>:</span><br><span class=\"line\">  waiting to lock monitor 0x0000000005c0a098 (object 0x00000000d5c10a70, a java.lang.Object),</span><br><span class=\"line\">  <span class=\"built_in\">which</span> is held by <span class=\"string\">&quot;Thread-2&quot;</span></span><br><span class=\"line\"><span class=\"string\">&quot;Thread-2&quot;</span>:</span><br><span class=\"line\">  waiting to lock monitor 0x0000000005c0a128 (object 0x00000000d5c10aa0, a java.lang.Object),</span><br><span class=\"line\">  <span class=\"built_in\">which</span> is held by <span class=\"string\">&quot;Thread-1&quot;</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>表示两个线程互相等待对方释放锁，造成死锁。</p>\n</li>\n<li class=\"lvl-2\">\n<p>目前只支持找出 <code>synchronized</code> 关键字阻塞住的线程，如果是 <code>java.util.concurrent.Lock</code> 目前还不支持。</p>\n</li>\n</ul>\n<h4 id=\"手动判断死锁的特征（如果没有上面的提示）\">手动判断死锁的特征（如果没有上面的提示）</h4>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>如果 JVM 没有显式提示，你可以通过以下死锁特征进行手动识别：</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>特征</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>线程处于 <code>BLOCKED</code> 状态</td>\n<td>线程被锁阻塞在 <code>monitor</code> 上。</td>\n</tr>\n<tr>\n<td><code>waiting to lock</code> 和 <code>locked</code> 出现交叉</td>\n<td>一个线程正在等待另一个线程持有的锁，而另一个线程也在等待当前线程的锁。</td>\n</tr>\n<tr>\n<td>没有能继续执行的线程</td>\n<td>多个线程都处于 <code>BLOCKED</code> 状态，且相互依赖。</td>\n</tr>\n</tbody>\n</table>\n<div class=\"tips\">\n<p><em><strong>在 Java 8 之后支持获取 JVM 内部线程</strong></em></p>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">VM 内部线程包括下面几种：</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>线程类型</th>\n<th>示例名称</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>JIT（Just-In-Time）编译线程</td>\n<td>C1 CompilerThread0, C2 CompilerThread0</td>\n</tr>\n<tr>\n<td>GC 线程</td>\n<td>GC Thread0, G1 Young RemSet Sampling</td>\n</tr>\n<tr>\n<td>其它内部线程</td>\n<td>VM Periodic Task Thread, VM Thread, Service Thread</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">\n<p>自 JDK 7 及以上版本开始，HotSpot JVM 默认启用了：分层编译（Tiered Compilation），即同时使用 C1 和 C2 编译器。</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>编译器</th>\n<th>特性</th>\n<th>用途</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>C1（Client Compiler）</strong></td>\n<td>编译速度快，优化少</td>\n<td>程序启动时使用，提升启动速度</td>\n</tr>\n<tr>\n<td><strong>C2（Server Compiler）</strong></td>\n<td>编译速度慢，优化强</td>\n<td>热点代码达到一定门槛后使用，提升长期运行性能</td>\n</tr>\n</tbody>\n</table>\n<blockquote>\n<p>JVM 启动后，先解释执行字节码；热点代码首先由 C1 编译器处理；如果进一步变热，交由 C2 编译器优化；整个过程由 JVM 自动管理，不需要手动干预。</p>\n</blockquote>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">\n<p>是否可以指定只用某个编译器？是的，你可以用 JVM 参数控制，但真没必要。</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>参数</th>\n<th>含义</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>-client</code></td>\n<td>使用 C1 编译器（适合启动快）</td>\n</tr>\n<tr>\n<td><code>-server</code></td>\n<td>使用 C2 编译器（适合长时间运行的服务）</td>\n</tr>\n<tr>\n<td><code>-XX:-TieredCompilation</code></td>\n<td>禁用分层编译，仅使用 <code>-client</code> 或 <code>-server</code> 指定的编译器</td>\n</tr>\n</tbody>\n</table>\n</div>\n<h2 id=\"jmap-分析运行中-Java-进程的内存使用情况\">jmap: 分析运行中 Java 进程的内存使用情况</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>jmap 比较消耗内存，所以不推荐生产环境使用。</p>\n</li>\n</ul>\n<h3 id=\"jmap-histo-pid-查看类实例数量及占用内存\"><code>jmap -histo &lt;pid&gt;</code>: 查看类实例数量及占用内存</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ jmap -histo 25238</span><br><span class=\"line\">25238:</span><br><span class=\"line\"></span><br><span class=\"line\"> num     <span class=\"comment\">#instances         #bytes  class name</span></span><br><span class=\"line\">----------------------------------------------</span><br><span class=\"line\">   1:        106175       10838440  [C</span><br><span class=\"line\">   2:         94344        3019008  java.util.concurrent.ConcurrentHashMap<span class=\"variable\">$Node</span></span><br><span class=\"line\">   3:        105529        2532696  java.lang.String</span><br><span class=\"line\">   4:         11203        2496608  [B</span><br><span class=\"line\">   5:         20178        2430136  [Ljava.lang.Object;</span><br><span class=\"line\">   6:         21642        2399904  java.lang.Class</span><br><span class=\"line\">…………………………</span><br><span class=\"line\">Total        857252       51328200</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># num: 序号</span></span><br><span class=\"line\"><span class=\"comment\"># instances: 实例数量</span></span><br><span class=\"line\"><span class=\"comment\"># bytes: 实例字节数</span></span><br><span class=\"line\"><span class=\"comment\"># class name: 类名, [C is a char[]，[S is a short[]，[I is a int[]，[B is a byte[]，[L is a List</span></span><br><span class=\"line\"><span class=\"comment\"># Total: 总数</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"jmap-heap-pid-查看堆使用情况\"><code>jmap -heap &lt;pid&gt;</code>: 查看堆使用情况</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ jmap -heap 25238</span><br><span class=\"line\">Attaching to process ID 25238, please <span class=\"built_in\">wait</span>...</span><br><span class=\"line\">Debugger attached successfully.</span><br><span class=\"line\">Server compiler detected.</span><br><span class=\"line\">JVM version is 25.371-b11</span><br><span class=\"line\"></span><br><span class=\"line\">using thread-local object allocation.</span><br><span class=\"line\">Parallel GC with 2 thread(s)</span><br><span class=\"line\"></span><br><span class=\"line\">Heap Configuration:    <span class=\"comment\"># 堆配置</span></span><br><span class=\"line\">   MinHeapFreeRatio         = 0                     <span class=\"comment\"># 最小空闲百分比</span></span><br><span class=\"line\">   MaxHeapFreeRatio         = 100                     <span class=\"comment\"># 最大空闲百分比</span></span><br><span class=\"line\">   MaxHeapSize              = 1010827264 (964.0MB)    <span class=\"comment\"># 最大堆大小</span></span><br><span class=\"line\">   NewSize                  = 21495808 (20.5MB)       <span class=\"comment\"># 新生代大小</span></span><br><span class=\"line\">   MaxNewSize               = 336592896 (321.0MB)     <span class=\"comment\"># 新生代最大大小</span></span><br><span class=\"line\">   OldSize                  = 43515904 (41.5MB)       <span class=\"comment\"># 老年代大小</span></span><br><span class=\"line\">   NewRatio                 = 2                       <span class=\"comment\"># 新生代与老年代比例</span></span><br><span class=\"line\">   SurvivorRatio            = 8                       <span class=\"comment\"># 幸存者比例</span></span><br><span class=\"line\">   MetaspaceSize            = 21807104 (20.796875MB)   <span class=\"comment\"># 元空间大小</span></span><br><span class=\"line\">   CompressedClassSpaceSize = 1073741824 (1024.0MB)   <span class=\"comment\"># 压缩类空间大小，用于存储所有 类指针（Klass pointer）</span></span><br><span class=\"line\">   MaxMetaspaceSize         = 17592186044415 MB       <span class=\"comment\"># 元空间最大大小</span></span><br><span class=\"line\">   G1HeapRegionSize         = 0 (0.0MB)               <span class=\"comment\"># G1堆大小</span></span><br><span class=\"line\"></span><br><span class=\"line\">Heap Usage:       <span class=\"comment\"># 堆使用情况</span></span><br><span class=\"line\">PS Young Generation <span class=\"comment\"># 年轻生代</span></span><br><span class=\"line\">Eden Space:         <span class=\"comment\"># Eden 区</span></span><br><span class=\"line\">   capacity = 30932992 (29.5MB)    <span class=\"comment\">#  Eden 区大小</span></span><br><span class=\"line\">   used     = 16705104 (15.931228637695312MB) <span class=\"comment\">#  Eden 区使用情况</span></span><br><span class=\"line\">   free     = 14227888 (13.568771362304688MB) <span class=\"comment\">#  Eden 区剩余情况</span></span><br><span class=\"line\">   54.00416487354343% used                    <span class=\"comment\">#  Eden 区使用百分比</span></span><br><span class=\"line\">From Space:                      <span class=\"comment\"># 幸存者区 survivor0</span></span><br><span class=\"line\">   capacity = 524288 (0.5MB)</span><br><span class=\"line\">   used     = 0 (0.0MB)</span><br><span class=\"line\">   free     = 524288 (0.5MB)</span><br><span class=\"line\">   0.0% used</span><br><span class=\"line\">To Space:                       <span class=\"comment\"># 幸存者区 survivor1</span></span><br><span class=\"line\">   capacity = 524288 (0.5MB)</span><br><span class=\"line\">   used     = 0 (0.0MB)</span><br><span class=\"line\">   free     = 524288 (0.5MB)</span><br><span class=\"line\">   0.0% used</span><br><span class=\"line\">PS Old Generation                <span class=\"comment\"># 老年代</span></span><br><span class=\"line\">   capacity = 193462272 (184.5MB)</span><br><span class=\"line\">   used     = 43292112 (41.28657531738281MB)</span><br><span class=\"line\">   free     = 150170160 (143.2134246826172MB)</span><br><span class=\"line\">   22.377547597497458% used</span><br><span class=\"line\"></span><br><span class=\"line\">38722 interned Strings occupying 4184168 bytes. <span class=\"comment\"># 堆中字符串数量及占用内存</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"jmap-dump-live-format-b-file-file-pid-创建一个快照，并保存到文件中\"><code>jmap -dump:live,format=b,file=&lt;file&gt; &lt;pid&gt;</code>: 创建一个快照，并保存到文件中</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 创建一个快照，并保存到当前目录下</span></span><br><span class=\"line\">$ jmap -dump:live,format=b,file=test.hprof 25238</span><br><span class=\"line\">Dumping heap to /tmp/test.hprof ...</span><br><span class=\"line\">Heap dump file created</span><br></pre></td></tr></table></figure>\n<h2 id=\"jcmd-可以替代jmap命令，jdk1-8-推荐使用\">jcmd: 可以替代<code>jmap</code>命令，<code>jdk1.8+</code>推荐使用</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>jcmd</code> 是 <code>JDK</code> 的一个命令行工具，用于管理 <code>JVM</code>，<code>jcmd</code> 可以查看 <code>JVM</code> 的运行状态、查看堆内存信息、触发 GC、查看线程信息、查看类信息等等。</p>\n</li>\n<li class=\"lvl-2\">\n<p>生产环境不建议使用<code>jmap</code>，因其会占用大量内存，推荐使用 <code>jcmd</code>。</p>\n</li>\n</ul>\n<h3 id=\"jcmd-pid-GC-heap-info-查看堆使用情况\"><code>jcmd &lt;pid&gt; GC.heap_info</code>: 查看堆使用情况</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>类似 <code>jmap -heap &lt;pid&gt;</code></p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ jcmd 25238 GC.heap_info</span><br><span class=\"line\">25238:</span><br><span class=\"line\"> PSYoungGen      total 30208K, used 23593K [0x00000000ebf00000, 0x00000000edd80000, 0x0000000100000000)</span><br><span class=\"line\">  eden space 29696K, 78% used [0x00000000ebf00000,0x00000000ed5d2560,0x00000000edc00000)</span><br><span class=\"line\">  from space 512K, 43% used [0x00000000edd00000,0x00000000edd38000,0x00000000edd80000)</span><br><span class=\"line\">  to   space 512K, 0% used [0x00000000edc80000,0x00000000edc80000,0x00000000edd00000)</span><br><span class=\"line\"> ParOldGen       total 105984K, used 96547K [0x00000000c3c00000, 0x00000000ca380000, 0x00000000ebf00000)</span><br><span class=\"line\">  object space 105984K, 91% used [0x00000000c3c00000,0x00000000c9a48f10,0x00000000ca380000)</span><br><span class=\"line\"> Metaspace       used 114450K, capacity 122262K, committed 122368K, reserved 1157120K</span><br><span class=\"line\">  class space    used 14018K, capacity 15294K, committed 15360K, reserved 1048576K</span><br></pre></td></tr></table></figure>\n<h3 id=\"jcmd-pid-GC-class-histogram-查看类加载情况\"><code>jcmd &lt;pid&gt; GC.class_histogram</code>: 查看类加载情况</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>类似 <code>jmap -histo &lt;pid&gt;</code></p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ jcmd 25238 GC.class_histogram</span><br><span class=\"line\">25238:</span><br><span class=\"line\"></span><br><span class=\"line\"> num     <span class=\"comment\">#instances         #bytes  class name</span></span><br><span class=\"line\">----------------------------------------------</span><br><span class=\"line\">   1:        106175       10838440  [C</span><br><span class=\"line\">   2:         94344        3019008  java.util.concurrent.ConcurrentHashMap<span class=\"variable\">$Node</span></span><br><span class=\"line\">   3:        105529        2532696  java.lang.String</span><br><span class=\"line\">   4:         11203        2496608  [B</span><br><span class=\"line\">   5:         20178        2430136  [Ljava.lang.Object;</span><br><span class=\"line\">   6:         21642        2399904  java.lang.Class</span><br><span class=\"line\">…………………………</span><br><span class=\"line\">Total        857252       51328200</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># num: 序号</span></span><br><span class=\"line\"><span class=\"comment\"># instances: 实例数量</span></span><br><span class=\"line\"><span class=\"comment\"># bytes: 实例字节数</span></span><br><span class=\"line\"><span class=\"comment\"># class name: 类名, [C is a char[]，[S is a short[]，[I is a int[]，[B is a byte[]，[L is a List</span></span><br><span class=\"line\"><span class=\"comment\"># Total: 总数</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"jcmd-pid-GC-heap-dump-path-to-heap-hprof-导出-heap-dump\"><code>jcmd &lt;pid&gt; GC.heap_dump /path/to/heap.hprof</code>: 导出 heap dump</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>替代 <code>jmap -dump:format=b,file=heap.hprof &lt;pid&gt;</code>，但仍会有停顿（触发FullGC），dump 过程慢，生产环境慎重使用</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ jcmd 25238 GC.heap_dump ./heap.hprof</span><br><span class=\"line\">25238:</span><br><span class=\"line\">Heap dump file created</span><br><span class=\"line\"><span class=\"comment\"># 注意这里使用的是相对目录，./heap.hprof，但此时 &quot;./&quot; 并不是运行命令时所在的目录，而是指 Java 进程的工作目录，如果你不知道工作目录，可以通过如下命令查看</span></span><br><span class=\"line\">jcmd &lt;pid&gt; VM.system_properties | grep <span class=\"string\">&quot;user.dir&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># linux下也可以通过如下命令查看</span></span><br><span class=\"line\"><span class=\"built_in\">ls</span> -l /proc/&lt;pid&gt;/cwd</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>因为生产环境不推荐使用 <code>jmap</code> 或 <code>jcmd</code> 导出 heap dump，所以我们需要在生产环境中配置如下jvm参数</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-XX:+HeadDumpOnOutOfMemoryError <span class=\"comment\"># 内存溢出（OOM）时会自动保存堆内存快照文件</span></span><br><span class=\"line\">-XX:HeapDumpPath=/path/to/dump.hprof <span class=\"comment\"># 指定堆内存快照文件保存路径，如果不配置，则默认保存在 Java 进程的工作目录下，文件名称默认为 java_&lt;pid&gt;.hprof</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"jhat-分析-Java-Heap-Dump-文件（-hprof）的工具\">jhat: 分析 Java Heap Dump 文件（.hprof）的工具</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>jhat（Java Heap Analysis Tool）是 JDK 附带的一个用于**分析 Java Heap Dump 文件（.hprof）**的工具。它可以将堆快照作为 HTTP 服务加载，并允许你通过浏览器交互式地查看和查询对象信息。</p>\n</li>\n<li class=\"lvl-2\">\n<p>不过需要注意的是：<br>\n🔺 从 JDK 9 起，jhat 已被官方废弃，推荐使用更强大的工具如 <code>VisualVM</code>、<code>Eclipse MAT</code> 或 <code>jcmd + 外部工具</code>。</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 默认端口7000</span></span><br><span class=\"line\">jhat &lt;heap dump file&gt;</span><br><span class=\"line\"><span class=\"comment\"># 指定端口</span></span><br><span class=\"line\">jhat -port 8000 &lt;heap dump file&gt;</span><br></pre></td></tr></table></figure>\n<h2 id=\"jvisualvm-图形化的-JVM-监控与分析工具\">jvisualvm: 图形化的 JVM 监控与分析工具</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>jvisualvm（全称：Java VisualVM）是 Java 官方提供的一款 图形化的 JVM 监控与分析工具，用于观察、分析和调试正在运行的 Java 程序。它非常适合开发和测试环境中进行内存分析、线程分析、GC 行为观察等任务。</p>\n</li>\n<li class=\"lvl-2\">\n<p>功能概览</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>功能</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>进程监控</strong></td>\n<td>查看本地或远程 JVM 进程的内存、CPU、线程等运行状态</td>\n</tr>\n<tr>\n<td><strong>内存使用分析</strong></td>\n<td>查看堆内存使用情况、GC 次数和时间、类实例分布等</td>\n</tr>\n<tr>\n<td><strong>线程分析</strong></td>\n<td>查看线程状态、线程栈、是否存在死锁</td>\n</tr>\n<tr>\n<td><strong>GC 分析</strong></td>\n<td>图形化展示 GC 活动、频率与耗时</td>\n</tr>\n<tr>\n<td><strong>堆转储分析</strong></td>\n<td>导入 <code>.hprof</code> 文件进行对象实例、类、引用关系分析</td>\n</tr>\n<tr>\n<td><strong>CPU 分析</strong></td>\n<td>分析方法调用路径、耗时、热点代码（需手动启用 CPU profiler）</td>\n</tr>\n<tr>\n<td><strong>插件支持</strong></td>\n<td>可以通过插件安装更多功能（如 Visual GC）</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>启动 jvisualvm</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 不要在生产环境使用，如果是分析服务端 .hprof 文件，可以导出到本地后在本地启动</span></span><br><span class=\"line\">$ jvisualvm</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>在 jvisualvm 中导入 .hprof 文件</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ jvisualvm --openfile &lt;heap dump file&gt;</span><br><span class=\"line\"><span class=\"comment\"># 或者 先打开 jvisualvm 后，点击 File -&gt; Open File -&gt; 选择 .hprof 文件</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>⚠️ 注意事项</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>注意点</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>不适用于大规模生产环境监控</td>\n<td>因为其分析过程可能会对 JVM 有轻微影响</td>\n</tr>\n<tr>\n<td><code>.hprof</code> 文件过大时加载缓慢</td>\n<td>可配合 Eclipse MAT 使用</td>\n</tr>\n<tr>\n<td>CPU/Memory Profiler 会增加系统负担</td>\n<td>使用时谨慎，建议只在测试环境启用</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"Eclipse-MAT-Java-Heap-Dump-分析工具\">Eclipse MAT: Java Heap Dump 分析工具</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><a href=\"https://eclipse.dev/mat\">Eclipse MAT</a>（Eclipse Memory Analyzer Tool）是一个用于分析 Java 堆快照的工具，它提供了许多功能来帮助开发人员理解 Java 应用程序中的内存问题。</p>\n</li>\n</ul>\n<div class=\"tips\">\n<p><em><strong>MaxOS系统安装Eclipse MAT后，启动报错，报错信息为：The JVM shared library “/Library/Internet Plug-Ins/JavaAppletPlugin.plugin/Contents/Home/bin/…/lib/server/libjvm.dylib” does not contain the JNI_CreateJavaVM symbol.</strong></em></p>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">解决方法：<br>\n1.在应用列表，找到<code>MemoryAnalyzer.app</code>，然后右键单击后，选择<code>显示包内容</code>,进入Contents目录，找到<code>Info.plist</code>文件<br>\n2.打开<code>Info.plist</code>文件后，可以看到注释<code>&lt;string&gt;-vm&lt;/string&gt;</code>配置项，我们需要做的就是打开这个配置项，并且将其设置为我们系统的Java路径，最新版需要<code>jdk17+</code></li>\n</ul>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">string</span>&gt;</span>-vm<span class=\"tag\">&lt;/<span class=\"name\">string</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">string</span>&gt;</span>/Users/hanqf/develop_soft/jdk17/bin/java<span class=\"tag\">&lt;/<span class=\"name\">string</span>&gt;</span></span><br></pre></td></tr></table></figure>\n</div>\n<h2 id=\"Arthas-推荐\">Arthas : 推荐</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><a href=\"https://arthas.aliyun.com\">Arthas</a> 是阿里巴巴开源的一款 Java 诊断工具，专为线上诊断而设计。它可以帮助开发者在不重启、不修改代码的情况下，排查生产环境中 Java 应用的问题。</p>\n</li>\n<li class=\"lvl-2\">\n<p>Arthas 支持 JDK 6+，支持 Linux/Mac/Windows，采用命令行交互模式，同时提供丰富的 Tab 自动补全功能，进一步方便进行问题的定位和诊断。</p>\n</li>\n<li class=\"lvl-2\">\n<p>这里要注意一点，就是Arthas从<code>4.x</code>版本开始，需要依赖<code>JDK8+</code>，如果是<code>JDK6/7</code>，可以下载最后一个3.x版本 <a href=\"https://github.com/alibaba/arthas/releases/tag/arthas-all-3.7.2\">3.7.2</a>。</p>\n</li>\n<li class=\"lvl-2\">\n<p>为了方便我们学习，Arthas还为我们提供了一个练习场，<a href=\"https://killercoda.com/arthas/course/arthas-tutorials-cn\">Arthas Playground</a>。</p>\n</li>\n</ul>\n<h3 id=\"Arthas-核心特点\">Arthas 核心特点</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>无需重启、侵入性低<br>\nArthas 可以 attach 到正在运行的 JVM 上，不需要重启服务或修改源代码。</p>\n</li>\n<li class=\"lvl-2\">\n<p>命令式交互体验<br>\n类似 Linux shell 的操作方式，支持 tab 补全、上下键历史命令等，非常直观。</p>\n</li>\n<li class=\"lvl-2\">\n<p>实时查看和监控<br>\n可查看方法参数、返回值、调用栈、执行耗时、JVM 线程、内存等实时数据。</p>\n</li>\n<li class=\"lvl-2\">\n<p>多种连接方式<br>\n支持命令行终端、本地 shell、Web 页面、telnet 等多种连接方式。</p>\n</li>\n<li class=\"lvl-2\">\n<p>支持多种 JVM 版本<br>\n支持 Java 6+，包括 OpenJDK、Oracle JDK、Alibaba Dragonwell 等。</p>\n</li>\n</ul>\n<h3 id=\"Arthas-常用命令\">Arthas 常用命令</h3>\n<h4 id=\"启动\">启动</h4>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">java -jar arthas-boot.jar</span><br><span class=\"line\"><span class=\"comment\">## 输出</span></span><br><span class=\"line\">java -jar arthas-boot.jar --target-ip 0.0.0.0</span><br><span class=\"line\">[INFO] JAVA_HOME: /Library/Java/JavaVirtualMachines/jdk1.8.0_271.jdk/Contents/Home/jre</span><br><span class=\"line\">[INFO] arthas-boot version: 4.0.5</span><br><span class=\"line\">[INFO] Process 43959 already using port 3658</span><br><span class=\"line\">[INFO] Process 43959 already using port 8563</span><br><span class=\"line\">[INFO] Found existing java process, please choose one and input the serial number of the process, eg : 1. Then hit ENTER.</span><br><span class=\"line\">* [1]: 43959 demo-arthas-spring-boot.jar</span><br><span class=\"line\">  [2]: 50851 org.jetbrains.idea.maven.server.RemoteMavenServer36</span><br><span class=\"line\">  [3]: 50813 org.sonarsource.sonarlint.core.backend.cli.SonarLintServerCli</span><br><span class=\"line\">  [4]: 50655 com.intellij.idea.Main</span><br><span class=\"line\"><span class=\"comment\"># 启动后，会自动进入交互模式，此时输入要监控的进程序号</span></span><br><span class=\"line\">1 <span class=\"comment\"># 比如这里输入 1 回车</span></span><br><span class=\"line\"><span class=\"comment\">## 输出</span></span><br><span class=\"line\">[INFO] arthas home: /Users/hanqf/.arthas/lib/4.0.5/arthas</span><br><span class=\"line\">[INFO] The target process already listen port 3658, skip attach.</span><br><span class=\"line\">[INFO] arthas-client connect 0.0.0.0 3658</span><br><span class=\"line\">  ,---.  ,------. ,--------.,--.  ,--.  ,---.   ,---.</span><br><span class=\"line\"> /  O  \\ |  .--. <span class=\"string\">&#x27;&#x27;</span>--.  .--<span class=\"string\">&#x27;|  &#x27;</span>--<span class=\"string\">&#x27;  | /  O  \\ &#x27;</span>   .-<span class=\"string\">&#x27;</span></span><br><span class=\"line\"><span class=\"string\">|  .-.  ||  &#x27;</span>--<span class=\"string\">&#x27;.&#x27;</span>   |  |   |  .--.  ||  .-.  |`.  `-.</span><br><span class=\"line\">|  | |  ||  |\\  \\    |  |   |  |  |  ||  | |  |.-<span class=\"string\">&#x27;    |</span></span><br><span class=\"line\"><span class=\"string\">`--&#x27;</span> `--<span class=\"string\">&#x27;`--&#x27;</span> <span class=\"string\">&#x27;--&#x27;</span>   `--<span class=\"string\">&#x27;   `--&#x27;</span>  `--<span class=\"string\">&#x27;`--&#x27;</span> `--<span class=\"string\">&#x27;`-----&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">wiki        https://arthas.aliyun.com/doc</span><br><span class=\"line\">tutorials   https://arthas.aliyun.com/doc/arthas-tutorials.html</span><br><span class=\"line\">version     4.0.5</span><br><span class=\"line\">main_class  demo-arthas-spring-boot.jar</span><br><span class=\"line\">pid         43959</span><br><span class=\"line\">start_time  2025-05-14 14:57:18.031</span><br><span class=\"line\">currnt_time 2025-05-14 14:59:22.004</span><br><span class=\"line\"></span><br><span class=\"line\">[arthas@43959]$ <span class=\"comment\"># 此时进入 arthas 命令行交互状态</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 退出 arthas</span></span><br><span class=\"line\">[arthas@43959]$ stop <span class=\"comment\"># 退出 arthas</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>arthas 命令有很多，当常用的也就几个，另外如果记不住某个命令怎么用了可以通过如下命令查询</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;<span class=\"built_in\">command</span>&gt; -h 或者 <span class=\"built_in\">help</span> &lt;<span class=\"built_in\">command</span>&gt;</span><br></pre></td></tr></table></figure>\n<h4 id=\"dashboard-实时查看-JVM-运行状态\">dashboard :  实时查看 JVM 运行状态</h4>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看 JVM 运行状态， 默认每隔 5 秒刷新 CPU、内存、线程、GC 等信息</span></span><br><span class=\"line\"><span class=\"comment\"># 默认会一直刷新状态，按 `q` 或  `Ctrl+C` 退出</span></span><br><span class=\"line\">dashboard</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 每隔 2 秒刷新一次</span></span><br><span class=\"line\">dashboard -i 2000</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 刷新 10 次后停止</span></span><br><span class=\"line\">dashboard -n 10</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 每隔 2 秒刷新一次，刷新 10 次后停止</span></span><br><span class=\"line\">dashboard -i 2000 -n 10</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/2L73Hi.png\" alt=\"\" width=\"1400\" height=\"900\"></p>\n<h4 id=\"thread-查看当前-JVM-线程信息\">thread : 查看当前 JVM 线程信息</h4>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看当前 JVM 线程信息，按 CPU 使用率倒序</span></span><br><span class=\"line\">thread</span><br><span class=\"line\"><span class=\"comment\"># 查看所有线程信息</span></span><br><span class=\"line\">thread --all</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看指定线程的堆栈信息</span></span><br><span class=\"line\">thread 18</span><br><span class=\"line\"><span class=\"comment\">## 输出</span></span><br><span class=\"line\"><span class=\"string\">&quot;http-nio-80-exec-1&quot;</span> Id=18 WAITING on java.util.concurrent.locks.AbstractQueuedSynchronizer<span class=\"variable\">$ConditionObject</span>@51866c16</span><br><span class=\"line\">    at sun.misc.Unsafe.park(Native Method)</span><br><span class=\"line\">    -  waiting on java.util.concurrent.locks.AbstractQueuedSynchronizer<span class=\"variable\">$ConditionObject</span>@51866c16</span><br><span class=\"line\">    at java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)</span><br><span class=\"line\">    at java.util.concurrent.locks.AbstractQueuedSynchronizer<span class=\"variable\">$ConditionObject</span>.await(AbstractQueuedSynchronizer.java:2039)</span><br><span class=\"line\">    at java.util.concurrent.LinkedBlockingQueue.take(LinkedBlockingQueue.java:442)</span><br><span class=\"line\">    at org.apache.tomcat.util.threads.TaskQueue.take(TaskQueue.java:103)</span><br><span class=\"line\">    at org.apache.tomcat.util.threads.TaskQueue.take(TaskQueue.java:31)</span><br><span class=\"line\">    at java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1074)</span><br><span class=\"line\">    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1134)</span><br><span class=\"line\">    at java.util.concurrent.ThreadPoolExecutor<span class=\"variable\">$Worker</span>.run(ThreadPoolExecutor.java:624)</span><br><span class=\"line\">    at org.apache.tomcat.util.threads.TaskThread<span class=\"variable\">$WrappingRunnable</span>.run(TaskThread.java:61)</span><br><span class=\"line\">    at java.lang.Thread.run(Thread.java:748)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看最忙的前5个线程的堆栈信息</span></span><br><span class=\"line\">thread -n 5</span><br><span class=\"line\"><span class=\"comment\"># 查看全部线程的堆栈信息</span></span><br><span class=\"line\">thread -n -1</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 指定 cpu 使用率统计的采样间隔，单位为毫秒，默认值为 200</span></span><br><span class=\"line\">thread -i 500</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 找出当前阻塞其他线程的线程</span></span><br><span class=\"line\">thread -b</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看指定状态的线程</span></span><br><span class=\"line\">thread --state WAITING</span><br></pre></td></tr></table></figure>\n<h4 id=\"sc-查看-JVM-已加载的类信息\">sc : 查看 JVM 已加载的类信息</h4>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>Search-Class</code> 的简写，这个命令能搜索出所有已经加载到 JVM 中的 Class 信息</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 通配符匹配，打印搜索到的类全名</span></span><br><span class=\"line\">sc *.demo.*</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 打印类的详细信息</span></span><br><span class=\"line\">sc -d com.example.demo.arthas.AdminFilterConfig</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 打印出类的 Field 信息</span></span><br><span class=\"line\">sc -d -f com.example.demo.arthas.AdminFilterConfig</span><br></pre></td></tr></table></figure>\n<h4 id=\"sm-查看已加载类的方法信息\">sm  : 查看已加载类的方法信息</h4>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>Search-Method</code> 的简写，这个命令能搜索出所有已经加载到 JVM 中的 Method 信息</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 打印指定类中的方法</span></span><br><span class=\"line\">sm java.lang.String</span><br><span class=\"line\"><span class=\"comment\"># 展示方法的详细信息</span></span><br><span class=\"line\">sm -d java.lang.String</span><br><span class=\"line\"><span class=\"comment\"># 展示指定方法的详细信息</span></span><br><span class=\"line\">sm -d java.lang.String substring</span><br><span class=\"line\"><span class=\"comment\"># 模糊匹配</span></span><br><span class=\"line\">sm -d java.lang.String eq*</span><br></pre></td></tr></table></figure>\n<h4 id=\"jad-Java源码反编译工具\">jad : Java源码反编译工具</h4>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>验证生产环境下的代码是否与提交的代码一致</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 打印出类的源码，类名</span></span><br><span class=\"line\">jad com.example.demo.arthas.user.UserController</span><br><span class=\"line\"><span class=\"comment\">## 输出</span></span><br><span class=\"line\">jad com.example.demo.arthas.user.UserController</span><br><span class=\"line\"></span><br><span class=\"line\">ClassLoader:</span><br><span class=\"line\">+-org.springframework.boot.loader.LaunchedURLClassLoader@5b2133b1</span><br><span class=\"line\">  +-sun.misc.Launcher<span class=\"variable\">$AppClassLoader</span>@5c647e05</span><br><span class=\"line\">    +-sun.misc.Launcher<span class=\"variable\">$ExtClassLoader</span>@452b3a41</span><br><span class=\"line\"></span><br><span class=\"line\">Location:</span><br><span class=\"line\">file:/Users/hanqf/Desktop/arhtas_dir/demo-arthas-spring-boot.jar!/BOOT-INF/classes!/</span><br><span class=\"line\"></span><br><span class=\"line\">       /*</span><br><span class=\"line\">        * Decompiled with CFR.</span><br><span class=\"line\">        *</span><br><span class=\"line\">        * Could not load the following classes:</span><br><span class=\"line\">        *  com.example.demo.arthas.user.User</span><br><span class=\"line\">        *  org.slf4j.Logger</span><br><span class=\"line\">        *  org.slf4j.LoggerFactory</span><br><span class=\"line\">        *  org.springframework.web.bind.annotation.GetMapping</span><br><span class=\"line\">        *  org.springframework.web.bind.annotation.PathVariable</span><br><span class=\"line\">        *  org.springframework.web.bind.annotation.RestController</span><br><span class=\"line\">        */</span><br><span class=\"line\">       package com.example.demo.arthas.user;</span><br><span class=\"line\"></span><br><span class=\"line\">       import com.example.demo.arthas.user.User;</span><br><span class=\"line\">       import org.slf4j.Logger;</span><br><span class=\"line\">       import org.slf4j.LoggerFactory;</span><br><span class=\"line\">       import org.springframework.web.bind.annotation.GetMapping;</span><br><span class=\"line\">       import org.springframework.web.bind.annotation.PathVariable;</span><br><span class=\"line\">       import org.springframework.web.bind.annotation.RestController;</span><br><span class=\"line\"></span><br><span class=\"line\">       @RestController</span><br><span class=\"line\">       public class UserController &#123;</span><br><span class=\"line\">           private static final Logger logger = LoggerFactory.getLogger(UserController.class);</span><br><span class=\"line\"></span><br><span class=\"line\">           @GetMapping(value=&#123;<span class=\"string\">&quot;/user/&#123;id&#125;&quot;</span>&#125;)</span><br><span class=\"line\">           public User findUserById(@PathVariable Integer <span class=\"built_in\">id</span>) &#123;</span><br><span class=\"line\">/*15*/         logger.info(<span class=\"string\">&quot;id: &#123;&#125;&quot;</span>, (Object)<span class=\"built_in\">id</span>);</span><br><span class=\"line\">/*17*/         <span class=\"keyword\">if</span> (<span class=\"built_in\">id</span> != null &amp;&amp; <span class=\"built_in\">id</span> &lt; 1) &#123;</span><br><span class=\"line\">                   throw new IllegalArgumentException(<span class=\"string\">&quot;id &lt; 1&quot;</span>);</span><br><span class=\"line\">               &#125;</span><br><span class=\"line\">               <span class=\"built_in\">return</span> new User(id.intValue(), <span class=\"string\">&quot;name&quot;</span> + <span class=\"built_in\">id</span>);</span><br><span class=\"line\">           &#125;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">Affect(row-cnt:1) cost <span class=\"keyword\">in</span> 411 ms.</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 反编译后的源码会有类加载器的信息，如果只希望打印源码，可以加上 --source-only</span></span><br><span class=\"line\">jad --source-only com.example.demo.arthas.user.UserController</span><br><span class=\"line\"><span class=\"comment\"># 不显示行号</span></span><br><span class=\"line\">jad --source-only com.example.demo.arthas.user.UserController --lineNumber <span class=\"literal\">false</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 输出到文件</span></span><br><span class=\"line\">jad --source-only com.example.demo.arthas.user.UserController &gt; /tmp/UserController.java</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 打印出类中某个方法的源码，类名 + 方法名</span></span><br><span class=\"line\">jad com.example.demo.arthas.user.UserController findUserById</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 反编译时指定dump class文件目录</span></span><br><span class=\"line\">jad --source-only com.example.demo.arthas.user.UserController --lineNumber <span class=\"literal\">false</span> -d /tmp/jad</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>当有多个 ClassLoader 都加载了这个类时，jad 命令会输出对应 ClassLoader 实例的 hashcode，然后你只需要重新执行 jad 命令，并使用参数 -c <hashcode> 就可以反编译指定 ClassLoader 加载的那个类了；</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ jad org.apache.log4j.Logger</span><br><span class=\"line\"></span><br><span class=\"line\">Found more than one class <span class=\"keyword\">for</span>: org.apache.log4j.Logger, Please use jad -c hashcode org.apache.log4j.Logger</span><br><span class=\"line\">HASHCODE  CLASSLOADER</span><br><span class=\"line\">69dcaba4  +-monitor<span class=\"string\">&#x27;s ModuleClassLoader</span></span><br><span class=\"line\"><span class=\"string\">6e51ad67  +-java.net.URLClassLoader@6e51ad67</span></span><br><span class=\"line\"><span class=\"string\">            +-sun.misc.Launcher$AppClassLoader@6951a712</span></span><br><span class=\"line\"><span class=\"string\">            +-sun.misc.Launcher$ExtClassLoader@6fafc4c2</span></span><br><span class=\"line\"><span class=\"string\">2bdd9114  +-pandora-qos-service&#x27;</span>s ModuleClassLoader</span><br><span class=\"line\">4c0df5f8  +-pandora-framework<span class=\"string\">&#x27;s ModuleClassLoader</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">Affect(row-cnt:0) cost in 38 ms.</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"># 指定类加载器</span></span><br><span class=\"line\"><span class=\"string\">$ jad org.apache.log4j.Logger -c 69dcaba4</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"mc-Memory-Compiler-内存编译器，编译-java文件生成-class\">mc : Memory Compiler/内存编译器，编译<code>.java</code>文件生成<code>.class</code></h4>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 编译，这里一定要指定类加载器，否则会报错，因为你编译的类中可能import其它类，不指定就会提示找不到对应的类。</span></span><br><span class=\"line\"><span class=\"comment\"># 类加载器可以通过 jad 命令获取</span></span><br><span class=\"line\">mc --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader /tmp/UserController.java</span><br><span class=\"line\"><span class=\"comment\"># 指定类加载器的编号</span></span><br><span class=\"line\">mc -c 5b2133b1 /tmp/UserController.java</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 将 UserController.class 文件输出到指定目录， -d 指定输出目录</span></span><br><span class=\"line\">mc --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader /tmp/UserController.java -d /tmp</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>mc 命令有可能失败。如果编译失败可以在本地编译好.class文件，再上传到服务器。</p>\n</li>\n</ul>\n<h4 id=\"retransform-重新加载类-热修改代码\">retransform : 重新加载类(热修改代码)</h4>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">retransform /tmp/com/example/demo/arthas/user/UserController.class</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看 通过 retransform 重新加载的 class</span></span><br><span class=\"line\">retransform -l</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 删除通过 retransform 重新加载的 class，通过 id 删除</span></span><br><span class=\"line\">retransform -d 1</span><br><span class=\"line\"><span class=\"comment\"># 删除所有</span></span><br><span class=\"line\">retransform --deleteAll</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 删除后要重新触发 retransform，否则内存中依旧使用的是删除前的 class</span></span><br><span class=\"line\">retransform --classPattern com.example.demo.arthas.user.UserController</span><br></pre></td></tr></table></figure>\n<h4 id=\"sysprop-查看当前-JVM-的系统属性\">sysprop : 查看当前 JVM 的系统属性</h4>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 打印系统属性</span></span><br><span class=\"line\">sysprop</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 指定单个 key，key支持自动补全</span></span><br><span class=\"line\">sysprop java.version</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 通过grep过滤</span></span><br><span class=\"line\">sysprop | grep user</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 设置 或 修改 系统属性</span></span><br><span class=\"line\">sysprop testKey testValue</span><br></pre></td></tr></table></figure>\n<h4 id=\"sysenv-查看当前-JVM-的环境变量\">sysenv : 查看当前 JVM 的环境变量</h4>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 列出所有环境变量</span></span><br><span class=\"line\">sysenv</span><br><span class=\"line\"><span class=\"comment\"># 指定单个 key，key支持自动补全</span></span><br><span class=\"line\">sysenv PATH</span><br><span class=\"line\"><span class=\"comment\"># 通过grep过滤</span></span><br><span class=\"line\">sysenv | grep PATH</span><br></pre></td></tr></table></figure>\n<h4 id=\"jvm-查看当前-JVM-的信息\">jvm : 查看当前 JVM 的信息</h4>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">jvm</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>THREAD</code> 相关</p>\n</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">COUNT: JVM 当前活跃的线程数</span><br><span class=\"line\">DAEMON-COUNT: JVM 当前活跃的守护线程数</span><br><span class=\"line\">PEAK-COUNT: 从 JVM 启动开始曾经活着的最大线程数</span><br><span class=\"line\">STARTED-COUNT: 从 JVM 启动开始总共启动过的线程次数</span><br><span class=\"line\">DEADLOCK-COUNT: JVM 当前死锁的线程数</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>FILE-DESCRIPTOR</code> 文件描述符相关</p>\n</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">MAX-FILE-DESCRIPTOR-COUNT：JVM 进程最大可以打开的文件描述符数</span><br><span class=\"line\">OPEN-FILE-DESCRIPTOR-COUNT：JVM 当前打开的文件描述符数</span><br></pre></td></tr></table></figure>\n<h4 id=\"watch-函数执行数据观测\">watch : 函数执行数据观测</h4>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>让你能方便的观察到指定函数的调用情况。能观察到的范围为：返回值、抛出异常、入参，通过编写 OGNL 表达式进行对应变量的查看。</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 观察指定类中某个方法的调用情况，className +  methodName + 返回值表达式</span></span><br><span class=\"line\"><span class=\"comment\"># 开启后，当方法被调用时，会按照指定的 `返回值表达式` 输出结果，返回值表达式 可以不指定，默认为 &#123;params, target, returnObj&#125;</span></span><br><span class=\"line\">watch com.example.demo.arthas.user.UserController findUserById <span class=\"string\">&#x27;&#123;params, throwExp&#125;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 观察全部方法，通配符匹配</span></span><br><span class=\"line\">watch com.example.demo.arthas.user.UserController <span class=\"string\">&#x27;*&#x27;</span> <span class=\"string\">&#x27;&#123;params, throwExp&#125;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 默认输出结果没有展开，可以加上 -x 指定输出结果的属性遍历深度，默认为 1，最大值是 4</span></span><br><span class=\"line\">watch com.example.demo.arthas.user.UserController <span class=\"string\">&#x27;*&#x27;</span> <span class=\"string\">&#x27;&#123;params, throwExp&#125;&#x27;</span> -x 2</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 仅当抛出异常时才打印，-e 在函数异常之后观察</span></span><br><span class=\"line\">watch com.example.demo.arthas.user.UserController <span class=\"string\">&#x27;*&#x27;</span> <span class=\"string\">&#x27;&#123;params, throwExp&#125;&#x27;</span> -x 2 -e</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 参数条件过滤，params[0] &gt; 100 表示方法入参中第一个参数的值大于 100 时才触发打印</span></span><br><span class=\"line\">watch com.example.demo.arthas.user.UserController * returnObj <span class=\"string\">&#x27;params[0] &gt; 100&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 按请求耗时进行过滤，#cost&gt;200 表示耗时大于200ms</span></span><br><span class=\"line\">watch com.example.demo.arthas.user.UserController * <span class=\"string\">&#x27;&#123;params, returnObj&#125;&#x27;</span> <span class=\"string\">&#x27;#cost&gt;200&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 退出watch</span></span><br><span class=\"line\">q</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>watch 命令表达式支持变量说明表</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>名称</th>\n<th>类型/说明</th>\n<th>作用/含义</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>loader</code></td>\n<td><code>ClassLoader</code></td>\n<td>方法所在类的类加载器对象</td>\n</tr>\n<tr>\n<td><code>clazz</code></td>\n<td><code>Class&lt;?&gt;</code></td>\n<td>方法所属的类（<code>Class</code> 对象）</td>\n</tr>\n<tr>\n<td><code>method</code></td>\n<td><code>java.lang.reflect.Method</code></td>\n<td>被调用的方法的反射对象</td>\n</tr>\n<tr>\n<td><code>target</code></td>\n<td><code>Object</code></td>\n<td>方法的调用目标对象（即 <code>this</code> 对象），静态方法中为 <code>null</code></td>\n</tr>\n<tr>\n<td><code>params</code></td>\n<td><code>Object[]</code></td>\n<td>方法的入参数组</td>\n</tr>\n<tr>\n<td><code>returnObj</code></td>\n<td><code>Object</code></td>\n<td>方法的返回值</td>\n</tr>\n<tr>\n<td><code>throwExp</code></td>\n<td><code>Throwable</code></td>\n<td>方法抛出的异常</td>\n</tr>\n<tr>\n<td><code>isBefore</code></td>\n<td><code>boolean</code></td>\n<td>当前执行位置是否是方法调用<strong>之前</strong>（<code>BEFORE</code> 阶段）</td>\n</tr>\n<tr>\n<td><code>isThrow</code></td>\n<td><code>boolean</code></td>\n<td>当前方法是否以异常结束（<code>THROWS</code> 阶段）</td>\n</tr>\n<tr>\n<td><code>isReturn</code></td>\n<td><code>boolean</code></td>\n<td>当前方法是否正常返回（<code>RETURN</code> 阶段）</td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"jobs-查看运行中的任务\">jobs : 查看运行中的任务</h4>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 如下命令会转到后台运行 ，与linux命令类似，命令最后加上 `&amp;` 即可</span></span><br><span class=\"line\">watch com.example.demo.arthas.user.UserController * <span class=\"string\">&#x27;&#123;params, throwExp&#125;&#x27;</span> <span class=\"string\">&#x27;throwExp != null&#x27;</span> &gt;&gt; a.log &amp;</span><br><span class=\"line\"><span class=\"comment\"># 查看后台任务</span></span><br><span class=\"line\"><span class=\"built_in\">jobs</span></span><br><span class=\"line\"><span class=\"comment\">## 输出</span></span><br><span class=\"line\">[1]*</span><br><span class=\"line\">       Running           watch com.example.demo.arthas.user.UserController * <span class=\"string\">&#x27;&#123;params, throwExp&#125;&#x27;</span> <span class=\"string\">&#x27;throwExp != null&#x27;</span> &gt;&gt; a.log &amp;</span><br><span class=\"line\">       execution count : 0</span><br><span class=\"line\">       start time      : Thu May 15 15:10:04 CST 2025</span><br><span class=\"line\">       <span class=\"built_in\">timeout</span> <span class=\"built_in\">date</span>    : Fri May 16 15:10:04 CST 2025</span><br><span class=\"line\">       session         : ded56dfd-5683-4427-ac08-792f8fb75e5e (current)</span><br><span class=\"line\"><span class=\"comment\"># 结束任务</span></span><br><span class=\"line\"><span class=\"built_in\">kill</span> 1 <span class=\"comment\"># 1为后台任务id</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 将后台任务转到前台</span></span><br><span class=\"line\"><span class=\"built_in\">fg</span> 1 <span class=\"comment\"># 1为后台任务id</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 暂停任务，但此时会将arthas进程都挂起，所以并不好用</span></span><br><span class=\"line\">ctrl+z</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 将前台任务转到后台继续执行</span></span><br><span class=\"line\"><span class=\"built_in\">bg</span> 1 <span class=\"comment\"># 1为前台任务id</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"logger-查看-logger-信息，更新-logger-level\">logger : 查看 logger 信息，更新 logger level</h4>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看 logger 信息</span></span><br><span class=\"line\">logger</span><br><span class=\"line\"><span class=\"comment\"># 查看指定名字的logger信息</span></span><br><span class=\"line\">logger -n ROOT</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看没有 appender 的 logger 的信息，不加这个参数只会打印有 appender 的 logger 的信息</span></span><br><span class=\"line\">logger --include-no-appender</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 更新 logger level，-c classLoader 的 hashcode</span></span><br><span class=\"line\">logger --name ROOT --level debug -c 5b2133b1</span><br><span class=\"line\">logger --name ROOT --level error --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader</span><br></pre></td></tr></table></figure>\n<h4 id=\"classloader-查看-classloader-的继承树，urls，类加载信息\">classloader : 查看 classloader 的继承树，urls，类加载信息</h4>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看 classloader 的信息，加载class的数量，hashcode，classloader 的 parent</span></span><br><span class=\"line\">classloader -l</span><br><span class=\"line\"><span class=\"comment\"># 树形展示</span></span><br><span class=\"line\">classloader -t</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查找资源，比如查找指定名称的文件</span></span><br><span class=\"line\">classloader -c 5b2133b1 -r application.properties</span><br></pre></td></tr></table></figure>","content_text":"摘要 本文介绍JVM的命令行工具 The Java® Virtual Machine Specification 版本jdk1.8 JVM 的参数(三类) 标准参数: 以-开头，所有 HotSpot 都⽀持。例如java -version。这类参数可以使⽤java -help 或者java -?全部打印出来 ⾮标准参数: 以-X开头，是特定 HotSpot版本⽀持的指令。例如java -Xms200M -Xmx200M。这类指令可以⽤java -X 全部打印出来。 不稳定参数: 这也是 JVM调优的噩梦。以-XX 开头，这些参数是跟特定HotSpot版本对应的，很有可能换个版本就没有了。详细的⽂档资料也特别少。JDK8 中的以下⼏个指令可以帮助开发者了解 JDK8 中的这⼀类不稳定参数。 1234java -XX:+PrintFlagsInitial -version # 所有参数的默认值java -XX:+PrintFlagsFinal -version # 所有参数最终⽣效的值。java -XX:+UnlockExperimentalVMOptions -XX:+PrintFlagsFinal -version # 所有参数最终⽣效的值，包含实验性参数。java -XX:+PrintCommandLineFlags -version # 当前命令生效的值，可以看到是⽤的哪种GC。 JDK1.8默认⽤的ParallelGC 运行 java -XX:+UnlockExperimentalVMOptions -XX:+PrintFlagsFinal -version 返回值说明 1234567891011121314151617[Global flags] intx ActiveProcessorCount = -1 &#123;product&#125; uintx AdaptiveSizeDecrementScaleFactor = 4 &#123;product&#125; uintx AdaptiveSizeMajorGCDecayTimeScale = 10 &#123;product&#125; uintx AdaptiveSizePausePolicy = 0 &#123;product&#125; uintx AdaptiveSizePolicyCollectionCostMargin = 50 &#123;product&#125; uintx AdaptiveSizePolicyInitializingSteps = 20 &#123;product&#125; uintx AdaptiveSizePolicyOutputInterval = 0 &#123;product&#125; uintx AdaptiveSizePolicyWeight = 10 &#123;product&#125; uintx AdaptiveSizeThroughPutPolicy = 0 &#123;product&#125; uintx AdaptiveTimeWeight = 25 &#123;product&#125; bool AdjustConcurrency = false &#123;product&#125; bool AggressiveHeap = false &#123;product&#125; bool AggressiveOpts = false &#123;product&#125; intx AliasLevel = 3 &#123;C2 product&#125; ………………………………# 格式：flag类型，flag名称，flag值，flag来源与作用域修饰符 flag类型: jdk8 标识符 含义 描述说明 intx 有符号整数（int extended） 用于表示带符号整数型参数 uintx 无符号整数（unsigned int extended） 表示非负整数型参数 uint64_t 无符号 64 位整数 适用于需要更大整数值的参数，比如内存大小、纳秒时间戳等 bool 布尔型 true 或 false，表示开关型参数 double 双精度浮点型 用于表示浮点数值类型的 JVM 参数 ccstr 常量 C 字符串指针 表示字符串参数（不可变） ccstrlist C 字符串列表 表示以逗号分隔的字符串列表 jdk11后出现更多的类型 标识符 含义 描述说明 int 有符号整数,通常是 32 位 JVM 内部使用的普通 int 参数 uint 无符号整数,通常是 32 位 少量用于特殊场景的参数 size_t 内存大小 表示内存大小参数（单位一般为字节）,jdk11后出现，原来是 uintx flag来源与作用域修饰符 jdk8 标记 含义 &#123;product&#125; 正式产品参数（用户可用，可通过 -XX: 进行设置） &#123;pd product&#125; 平台相关的正式参数（platform-dependent），在某些操作系统/CPU 上可用 &#123;C1 product&#125; 仅在使用 C1 编译器（优化编译器） 时有效的参数 &#123;C2 product&#125; 仅在使用 C2 编译器（优化编译器） 时有效的参数 &#123;manageable&#125; 可通过 JMX 动态管理的参数（运行时可调整） &#123;ARCH product&#125; 与 CPU 架构相关的产品参数（如 x86、ARM 等） &#123;lp64_product&#125; 仅在 64 位 JVM 上才有效的产品参数 &#123;experimental&#125; 实验性的 参数，可能在将来的版本中删除或更改。需要开启 -XX:+UnlockExperimentalVMOptions jdk11后出现更多的类型 标记 含义 &#123;C1 pd product&#125; 平台相关的正式参数,仅在使用 C1 编译器（优化编译器） 时有效的参数 &#123;C2 pd product&#125; 平台相关的正式参数,仅在使用 C2 编译器（优化编译器） 时有效的参数 &#123;JVMCI product&#125; 此参数适用于 JVMCI 或 Graal 编译器相关功能，jdk21添加 另外，jdk11+ 中，最后还会多出一列，其作用是说明该参数的设置来源 来源标识 含义说明 &#123;default&#125; 使用的是该参数的默认值（没有被用户或系统设置） &#123;command line&#125; 用户通过命令行显式设置的参数（如 -XX:+UseG1GC） &#123;ergonomic&#125; JVM 根据系统环境自动选择的值（自适应设置） jps: 查看当前jvm中的进程 12345678# 查看java进程IDjps# 查看java进程信息，包括ID和启动类或jar的名称jps -l# 查看启动java进程时传递给jvm的参数设置jps -v# 查看java进程信息，同时显示启动java进程时传递给jvm的参数设置jps -lv jinfo: 查看JVM参数 jinfo 是 JDK 自带的命令行工具之一，用于 查看和修改正在运行中的 Java 进程的配置信息，主要包括 JVM 参数、系统属性等信息。 在 Java 9+ 之后被标记为 deprecated，建议改用 jcmd 替代 12345678910111213141516171819# 查看正在运行的 JVM 参数jinfo &lt;PID&gt;# jcmd 命令，分成三个jcmd &lt;pid&gt; VM.flags # VM Flagsjcmd &lt;pid&gt; VM.system_properties # System Propertiesjcmd &lt;pid&gt; VM.command_line # Command Line# 查看指定进程的系统属性（-sysprops）jinfo -sysprops &lt;PID&gt;# jcmd 命令jcmd &lt;pid&gt; VM.system_properties# 动态修改 JVM 参数（仅支持部分参数）jinfo -flag [+|-]&lt;flagname&gt; &lt;pid&gt;## 例：打开 GC 日志jinfo -flag +PrintGC &lt;pid&gt;# 检查是否开启了某个 JVM 特性（如 UseG1GC）jinfo -flag UseG1GC &lt;pid&gt; jstat: 查看指定JAVA进程的运行状态 123456789# 查看运行状态jstat -gc &lt;PID&gt;# 查看运行状态，每隔5000毫秒输出一次，共输出20次jstat -gc &lt;PID&gt; 5000 20# 输出 S0C S1C S0U S1U EC EU OC OU MC MU CCSC CCSU YGC YGCT FGC FGCT GCT512.0 512.0 0.0 224.0 29696.0 27138.2 105984.0 96531.8 122368.0 114450.4 15360.0 14018.9 733 5.099 4 0.833 5.931512.0 512.0 0.0 224.0 29696.0 27203.9 105984.0 96531.8 122368.0 114450.4 15360.0 14018.9 733 5.099 4 0.833 5.931512.0 512.0 0.0 224.0 29696.0 27220.4 105984.0 96531.8 122368.0 114450.4 15360.0 14018.9 733 5.099 4 0.833 5.931 内存区统计（单位：KB） 列名 含义说明 S0C Survivor 0 区的容量（KB） S1C Survivor 1 区的容量（KB） S0U Survivor 0 区已使用内存（KB） S1U Survivor 1 区已使用内存（KB） EC Eden 区的容量（KB） EU Eden 区已使用内存（KB） OC Old Generation（老年代）的容量（KB） OU Old Generation 已使用内存（KB） MC Metaspace（元空间）的容量（KB） MU Metaspace 已使用内存（KB） CCSC Compressed Class Space 的容量（KB） CCSU Compressed Class Space 已使用内存（KB） GC 次数与耗时(从应用程序启动到采样时) 列名 含义说明 YGC Young GC（Minor GC） 的累计次数 YGCT Young GC 累计耗时（单位：秒） FGC Full GC 的累计次数 FGCT Full GC 累计耗时（单位：秒） GCT GC 总耗时（YGCT + FGCT，总和） jstack: 查看指定JAVA进程中各线程的调用堆栈 123456789101112131415161718# 打印线程的标准栈信息（栈帧 + 线程状态）jstack &lt;PID&gt;# 在标准输出基础上，额外打印线程拥有的锁（monitor）和 waited on 锁对象信息jstack -l &lt;PID&gt;# 输出到文件jstack -l &lt;PID&gt; &gt; jstack.tdump # 这个文件名后缀只是为了方便 jvisualvm 查看# 输出&quot;idle-connection-reaper&quot; #68 daemon prio=5 os_prio=0 tid=0x00007f38b6ae2800 nid=0x62e9 waiting on condition [0x00007f385b0f5000] java.lang.Thread.State: TIMED_WAITING (sleeping) at java.lang.Thread.sleep(Native Method) at software.amazon.awssdk.http.apache.internal.conn.IdleConnectionReaper$ReaperTask.run(IdleConnectionReaper.java:151) at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) at java.lang.Thread.run(Thread.java:750) Locked ownable synchronizers: - &lt;0x00000000c561cfd8&gt; (a java.util.concurrent.ThreadPoolExecutor$Worker) jstack输出内容含义 字段 含义 &quot;idle-connection-reaper&quot; 线程名称。这个线程是 AWS SDK 中用于清理空闲连接的后台线程。 #68 线程 ID（Java 层分配的编号）。 daemon 表示这是一个 守护线程。JVM 退出时不会等待守护线程运行结束。 prio=5 Java 层的线程优先级（默认 1–10，5 是默认）。 os_prio=0 操作系统层线程优先级（取决于操作系统和 JVM 的实现）。 tid=0x00007f38b6ae2800 线程 ID（Java 层使用的地址标识）。 nid=0x62e9 Native ID，操作系统分配的线程 ID（十六进制表示），可以通过命令printf &quot;%d\\n&quot; 0x62e9转换为10进制。 ps -Lp &lt;PID&gt; 和 top -Hp &lt;PID&gt; 展示的线程id是10进制 waiting on condition 线程状态说明：正在等待某种条件，一般指 sleep() 或 wait() 等。 [0x00007f385b0f5000] 栈帧的内存地址。 java.lang.Thread.State: TIMED_WAITING (sleeping) 线程状态。 at java.lang.Thread.sleep(Native Method) ………………………… 线程调用栈信息，包括调用方法、调用参数、调用栈帧。 另外还有如下信息，表示此线程持有的可拥有同步器（例如 ReentrantLock），具体内容如下： 12Locked ownable synchronizers: - &lt;0x00000000c561cfd8&gt; (a java.util.concurrent.ThreadPoolExecutor$Worker) 内容 含义 &lt;0x00000000c561cfd8&gt; 持有锁的对象地址。可以在其他线程中查找这个地址，以判断死锁等问题。 (a ThreadPoolExecutor$Worker) 表示该锁属于 ThreadPoolExecutor 的某个 Worker 线程（这是线程池的工作线程）。 线程状态 状态 含义 常见原因 / 示例方法 示例 jstack 输出 RUNNABLE 线程正在运行或准备运行，等待 CPU 时间片。 线程活跃运行中 &quot;Thread-0&quot; #1 prio=5 os_prio=0 tid=0x00007f8d9c001000 nid=0x1a runnable [0x00007f8dbf7fe000] BLOCKED (on object monitor) 等待获取对象的监视器锁（同步锁），即等待进入同步块或方法。 synchronized 同步块或方法 &quot;Thread-1&quot; #2 prio=5 os_prio=0 tid=0x00007f8d9c002000 nid=0x1b waiting for monitor entry [0x00007f8dbeaff000] WAITING (on object monitor) 无限期等待其他线程执行某操作。 Object.wait()Thread.join()LockSupport.park()Condition.await() &quot;Thread-2&quot; #3 prio=5 os_prio=0 tid=0x00007f8d9c003000 nid=0x1c waiting on condition [0x00007f8dbebff000] TIMED_WAITING (on object monitor) 等待固定时间，直到条件满足或超时。 Object.wait(long)Thread.sleep(long)Condition.awaitNanos(long)DelayQueue.take() &quot;Thread-3&quot; #4 prio=5 os_prio=0 tid=0x00007f8d9c004000 nid=0x1d timed_waiting [0x00007f8dbebff000] TERMINATED 线程已运行完毕并退出（通常不在 jstack 中显示）。 - - 使用jstack检查死锁 死锁是指多个线程互相等待对方释放锁，导致无法继续运行的情况。 直接查找 Found one Java-level deadlock 提示 12345678Found one Java-level deadlock:=============================&quot;Thread-1&quot;: waiting to lock monitor 0x0000000005c0a098 (object 0x00000000d5c10a70, a java.lang.Object), which is held by &quot;Thread-2&quot;&quot;Thread-2&quot;: waiting to lock monitor 0x0000000005c0a128 (object 0x00000000d5c10aa0, a java.lang.Object), which is held by &quot;Thread-1&quot; 表示两个线程互相等待对方释放锁，造成死锁。 目前只支持找出 synchronized 关键字阻塞住的线程，如果是 java.util.concurrent.Lock 目前还不支持。 手动判断死锁的特征（如果没有上面的提示） 如果 JVM 没有显式提示，你可以通过以下死锁特征进行手动识别： 特征 描述 线程处于 BLOCKED 状态 线程被锁阻塞在 monitor 上。 waiting to lock 和 locked 出现交叉 一个线程正在等待另一个线程持有的锁，而另一个线程也在等待当前线程的锁。 没有能继续执行的线程 多个线程都处于 BLOCKED 状态，且相互依赖。 在 Java 8 之后支持获取 JVM 内部线程 VM 内部线程包括下面几种： 线程类型 示例名称 JIT（Just-In-Time）编译线程 C1 CompilerThread0, C2 CompilerThread0 GC 线程 GC Thread0, G1 Young RemSet Sampling 其它内部线程 VM Periodic Task Thread, VM Thread, Service Thread 自 JDK 7 及以上版本开始，HotSpot JVM 默认启用了：分层编译（Tiered Compilation），即同时使用 C1 和 C2 编译器。 编译器 特性 用途 C1（Client Compiler） 编译速度快，优化少 程序启动时使用，提升启动速度 C2（Server Compiler） 编译速度慢，优化强 热点代码达到一定门槛后使用，提升长期运行性能 JVM 启动后，先解释执行字节码；热点代码首先由 C1 编译器处理；如果进一步变热，交由 C2 编译器优化；整个过程由 JVM 自动管理，不需要手动干预。 是否可以指定只用某个编译器？是的，你可以用 JVM 参数控制，但真没必要。 参数 含义 -client 使用 C1 编译器（适合启动快） -server 使用 C2 编译器（适合长时间运行的服务） -XX:-TieredCompilation 禁用分层编译，仅使用 -client 或 -server 指定的编译器 jmap: 分析运行中 Java 进程的内存使用情况 jmap 比较消耗内存，所以不推荐生产环境使用。 jmap -histo &lt;pid&gt;: 查看类实例数量及占用内存 12345678910111213141516171819$ jmap -histo 2523825238: num #instances #bytes class name---------------------------------------------- 1: 106175 10838440 [C 2: 94344 3019008 java.util.concurrent.ConcurrentHashMap$Node 3: 105529 2532696 java.lang.String 4: 11203 2496608 [B 5: 20178 2430136 [Ljava.lang.Object; 6: 21642 2399904 java.lang.Class…………………………Total 857252 51328200# num: 序号# instances: 实例数量# bytes: 实例字节数# class name: 类名, [C is a char[]，[S is a short[]，[I is a int[]，[B is a byte[]，[L is a List# Total: 总数 jmap -heap &lt;pid&gt;: 查看堆使用情况 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647$ jmap -heap 25238Attaching to process ID 25238, please wait...Debugger attached successfully.Server compiler detected.JVM version is 25.371-b11using thread-local object allocation.Parallel GC with 2 thread(s)Heap Configuration: # 堆配置 MinHeapFreeRatio = 0 # 最小空闲百分比 MaxHeapFreeRatio = 100 # 最大空闲百分比 MaxHeapSize = 1010827264 (964.0MB) # 最大堆大小 NewSize = 21495808 (20.5MB) # 新生代大小 MaxNewSize = 336592896 (321.0MB) # 新生代最大大小 OldSize = 43515904 (41.5MB) # 老年代大小 NewRatio = 2 # 新生代与老年代比例 SurvivorRatio = 8 # 幸存者比例 MetaspaceSize = 21807104 (20.796875MB) # 元空间大小 CompressedClassSpaceSize = 1073741824 (1024.0MB) # 压缩类空间大小，用于存储所有 类指针（Klass pointer） MaxMetaspaceSize = 17592186044415 MB # 元空间最大大小 G1HeapRegionSize = 0 (0.0MB) # G1堆大小Heap Usage: # 堆使用情况PS Young Generation # 年轻生代Eden Space: # Eden 区 capacity = 30932992 (29.5MB) # Eden 区大小 used = 16705104 (15.931228637695312MB) # Eden 区使用情况 free = 14227888 (13.568771362304688MB) # Eden 区剩余情况 54.00416487354343% used # Eden 区使用百分比From Space: # 幸存者区 survivor0 capacity = 524288 (0.5MB) used = 0 (0.0MB) free = 524288 (0.5MB) 0.0% usedTo Space: # 幸存者区 survivor1 capacity = 524288 (0.5MB) used = 0 (0.0MB) free = 524288 (0.5MB) 0.0% usedPS Old Generation # 老年代 capacity = 193462272 (184.5MB) used = 43292112 (41.28657531738281MB) free = 150170160 (143.2134246826172MB) 22.377547597497458% used38722 interned Strings occupying 4184168 bytes. # 堆中字符串数量及占用内存 jmap -dump:live,format=b,file=&lt;file&gt; &lt;pid&gt;: 创建一个快照，并保存到文件中 1234# 创建一个快照，并保存到当前目录下$ jmap -dump:live,format=b,file=test.hprof 25238Dumping heap to /tmp/test.hprof ...Heap dump file created jcmd: 可以替代jmap命令，jdk1.8+推荐使用 jcmd 是 JDK 的一个命令行工具，用于管理 JVM，jcmd 可以查看 JVM 的运行状态、查看堆内存信息、触发 GC、查看线程信息、查看类信息等等。 生产环境不建议使用jmap，因其会占用大量内存，推荐使用 jcmd。 jcmd &lt;pid&gt; GC.heap_info: 查看堆使用情况 类似 jmap -heap &lt;pid&gt; 12345678910$ jcmd 25238 GC.heap_info25238: PSYoungGen total 30208K, used 23593K [0x00000000ebf00000, 0x00000000edd80000, 0x0000000100000000) eden space 29696K, 78% used [0x00000000ebf00000,0x00000000ed5d2560,0x00000000edc00000) from space 512K, 43% used [0x00000000edd00000,0x00000000edd38000,0x00000000edd80000) to space 512K, 0% used [0x00000000edc80000,0x00000000edc80000,0x00000000edd00000) ParOldGen total 105984K, used 96547K [0x00000000c3c00000, 0x00000000ca380000, 0x00000000ebf00000) object space 105984K, 91% used [0x00000000c3c00000,0x00000000c9a48f10,0x00000000ca380000) Metaspace used 114450K, capacity 122262K, committed 122368K, reserved 1157120K class space used 14018K, capacity 15294K, committed 15360K, reserved 1048576K jcmd &lt;pid&gt; GC.class_histogram: 查看类加载情况 类似 jmap -histo &lt;pid&gt; 12345678910111213141516171819$ jcmd 25238 GC.class_histogram25238: num #instances #bytes class name---------------------------------------------- 1: 106175 10838440 [C 2: 94344 3019008 java.util.concurrent.ConcurrentHashMap$Node 3: 105529 2532696 java.lang.String 4: 11203 2496608 [B 5: 20178 2430136 [Ljava.lang.Object; 6: 21642 2399904 java.lang.Class…………………………Total 857252 51328200# num: 序号# instances: 实例数量# bytes: 实例字节数# class name: 类名, [C is a char[]，[S is a short[]，[I is a int[]，[B is a byte[]，[L is a List# Total: 总数 jcmd &lt;pid&gt; GC.heap_dump /path/to/heap.hprof: 导出 heap dump 替代 jmap -dump:format=b,file=heap.hprof &lt;pid&gt;，但仍会有停顿（触发FullGC），dump 过程慢，生产环境慎重使用 1234567$ jcmd 25238 GC.heap_dump ./heap.hprof25238:Heap dump file created# 注意这里使用的是相对目录，./heap.hprof，但此时 &quot;./&quot; 并不是运行命令时所在的目录，而是指 Java 进程的工作目录，如果你不知道工作目录，可以通过如下命令查看jcmd &lt;pid&gt; VM.system_properties | grep &quot;user.dir&quot;# linux下也可以通过如下命令查看ls -l /proc/&lt;pid&gt;/cwd 因为生产环境不推荐使用 jmap 或 jcmd 导出 heap dump，所以我们需要在生产环境中配置如下jvm参数 12-XX:+HeadDumpOnOutOfMemoryError # 内存溢出（OOM）时会自动保存堆内存快照文件-XX:HeapDumpPath=/path/to/dump.hprof # 指定堆内存快照文件保存路径，如果不配置，则默认保存在 Java 进程的工作目录下，文件名称默认为 java_&lt;pid&gt;.hprof jhat: 分析 Java Heap Dump 文件（.hprof）的工具 jhat（Java Heap Analysis Tool）是 JDK 附带的一个用于**分析 Java Heap Dump 文件（.hprof）**的工具。它可以将堆快照作为 HTTP 服务加载，并允许你通过浏览器交互式地查看和查询对象信息。 不过需要注意的是： 🔺 从 JDK 9 起，jhat 已被官方废弃，推荐使用更强大的工具如 VisualVM、Eclipse MAT 或 jcmd + 外部工具。 1234# 默认端口7000jhat &lt;heap dump file&gt;# 指定端口jhat -port 8000 &lt;heap dump file&gt; jvisualvm: 图形化的 JVM 监控与分析工具 jvisualvm（全称：Java VisualVM）是 Java 官方提供的一款 图形化的 JVM 监控与分析工具，用于观察、分析和调试正在运行的 Java 程序。它非常适合开发和测试环境中进行内存分析、线程分析、GC 行为观察等任务。 功能概览 功能 描述 进程监控 查看本地或远程 JVM 进程的内存、CPU、线程等运行状态 内存使用分析 查看堆内存使用情况、GC 次数和时间、类实例分布等 线程分析 查看线程状态、线程栈、是否存在死锁 GC 分析 图形化展示 GC 活动、频率与耗时 堆转储分析 导入 .hprof 文件进行对象实例、类、引用关系分析 CPU 分析 分析方法调用路径、耗时、热点代码（需手动启用 CPU profiler） 插件支持 可以通过插件安装更多功能（如 Visual GC） 启动 jvisualvm 12# 不要在生产环境使用，如果是分析服务端 .hprof 文件，可以导出到本地后在本地启动$ jvisualvm 在 jvisualvm 中导入 .hprof 文件 12$ jvisualvm --openfile &lt;heap dump file&gt;# 或者 先打开 jvisualvm 后，点击 File -&gt; Open File -&gt; 选择 .hprof 文件 ⚠️ 注意事项 注意点 说明 不适用于大规模生产环境监控 因为其分析过程可能会对 JVM 有轻微影响 .hprof 文件过大时加载缓慢 可配合 Eclipse MAT 使用 CPU/Memory Profiler 会增加系统负担 使用时谨慎，建议只在测试环境启用 Eclipse MAT: Java Heap Dump 分析工具 Eclipse MAT（Eclipse Memory Analyzer Tool）是一个用于分析 Java 堆快照的工具，它提供了许多功能来帮助开发人员理解 Java 应用程序中的内存问题。 MaxOS系统安装Eclipse MAT后，启动报错，报错信息为：The JVM shared library “/Library/Internet Plug-Ins/JavaAppletPlugin.plugin/Contents/Home/bin/…/lib/server/libjvm.dylib” does not contain the JNI_CreateJavaVM symbol. 解决方法： 1.在应用列表，找到MemoryAnalyzer.app，然后右键单击后，选择显示包内容,进入Contents目录，找到Info.plist文件 2.打开Info.plist文件后，可以看到注释&lt;string&gt;-vm&lt;/string&gt;配置项，我们需要做的就是打开这个配置项，并且将其设置为我们系统的Java路径，最新版需要jdk17+ 12&lt;string&gt;-vm&lt;/string&gt;&lt;string&gt;/Users/hanqf/develop_soft/jdk17/bin/java&lt;/string&gt; Arthas : 推荐 Arthas 是阿里巴巴开源的一款 Java 诊断工具，专为线上诊断而设计。它可以帮助开发者在不重启、不修改代码的情况下，排查生产环境中 Java 应用的问题。 Arthas 支持 JDK 6+，支持 Linux/Mac/Windows，采用命令行交互模式，同时提供丰富的 Tab 自动补全功能，进一步方便进行问题的定位和诊断。 这里要注意一点，就是Arthas从4.x版本开始，需要依赖JDK8+，如果是JDK6/7，可以下载最后一个3.x版本 3.7.2。 为了方便我们学习，Arthas还为我们提供了一个练习场，Arthas Playground。 Arthas 核心特点 无需重启、侵入性低 Arthas 可以 attach 到正在运行的 JVM 上，不需要重启服务或修改源代码。 命令式交互体验 类似 Linux shell 的操作方式，支持 tab 补全、上下键历史命令等，非常直观。 实时查看和监控 可查看方法参数、返回值、调用栈、执行耗时、JVM 线程、内存等实时数据。 多种连接方式 支持命令行终端、本地 shell、Web 页面、telnet 等多种连接方式。 支持多种 JVM 版本 支持 Java 6+，包括 OpenJDK、Oracle JDK、Alibaba Dragonwell 等。 Arthas 常用命令 启动 123456789101112131415161718192021222324252627282930313233343536java -jar arthas-boot.jar## 输出java -jar arthas-boot.jar --target-ip 0.0.0.0[INFO] JAVA_HOME: /Library/Java/JavaVirtualMachines/jdk1.8.0_271.jdk/Contents/Home/jre[INFO] arthas-boot version: 4.0.5[INFO] Process 43959 already using port 3658[INFO] Process 43959 already using port 8563[INFO] Found existing java process, please choose one and input the serial number of the process, eg : 1. Then hit ENTER.* [1]: 43959 demo-arthas-spring-boot.jar [2]: 50851 org.jetbrains.idea.maven.server.RemoteMavenServer36 [3]: 50813 org.sonarsource.sonarlint.core.backend.cli.SonarLintServerCli [4]: 50655 com.intellij.idea.Main# 启动后，会自动进入交互模式，此时输入要监控的进程序号1 # 比如这里输入 1 回车## 输出[INFO] arthas home: /Users/hanqf/.arthas/lib/4.0.5/arthas[INFO] The target process already listen port 3658, skip attach.[INFO] arthas-client connect 0.0.0.0 3658 ,---. ,------. ,--------.,--. ,--. ,---. ,---. / O \\ | .--. &#x27;&#x27;--. .--&#x27;| &#x27;--&#x27; | / O \\ &#x27; .-&#x27;| .-. || &#x27;--&#x27;.&#x27; | | | .--. || .-. |`. `-.| | | || |\\ \\ | | | | | || | | |.-&#x27; |`--&#x27; `--&#x27;`--&#x27; &#x27;--&#x27; `--&#x27; `--&#x27; `--&#x27;`--&#x27; `--&#x27;`-----&#x27;wiki https://arthas.aliyun.com/doctutorials https://arthas.aliyun.com/doc/arthas-tutorials.htmlversion 4.0.5main_class demo-arthas-spring-boot.jarpid 43959start_time 2025-05-14 14:57:18.031currnt_time 2025-05-14 14:59:22.004[arthas@43959]$ # 此时进入 arthas 命令行交互状态# 退出 arthas[arthas@43959]$ stop # 退出 arthas arthas 命令有很多，当常用的也就几个，另外如果记不住某个命令怎么用了可以通过如下命令查询 1&lt;command&gt; -h 或者 help &lt;command&gt; dashboard : 实时查看 JVM 运行状态 123456789101112# 查看 JVM 运行状态， 默认每隔 5 秒刷新 CPU、内存、线程、GC 等信息# 默认会一直刷新状态，按 `q` 或 `Ctrl+C` 退出dashboard# 每隔 2 秒刷新一次dashboard -i 2000# 刷新 10 次后停止dashboard -n 10# 每隔 2 秒刷新一次，刷新 10 次后停止dashboard -i 2000 -n 10 thread : 查看当前 JVM 线程信息 1234567891011121314151617181920212223242526272829303132333435# 查看当前 JVM 线程信息，按 CPU 使用率倒序thread# 查看所有线程信息thread --all# 查看指定线程的堆栈信息thread 18## 输出&quot;http-nio-80-exec-1&quot; Id=18 WAITING on java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject@51866c16 at sun.misc.Unsafe.park(Native Method) - waiting on java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject@51866c16 at java.util.concurrent.locks.LockSupport.park(LockSupport.java:175) at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:2039) at java.util.concurrent.LinkedBlockingQueue.take(LinkedBlockingQueue.java:442) at org.apache.tomcat.util.threads.TaskQueue.take(TaskQueue.java:103) at org.apache.tomcat.util.threads.TaskQueue.take(TaskQueue.java:31) at java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1074) at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1134) at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61) at java.lang.Thread.run(Thread.java:748)# 查看最忙的前5个线程的堆栈信息thread -n 5# 查看全部线程的堆栈信息thread -n -1# 指定 cpu 使用率统计的采样间隔，单位为毫秒，默认值为 200thread -i 500# 找出当前阻塞其他线程的线程thread -b# 查看指定状态的线程thread --state WAITING sc : 查看 JVM 已加载的类信息 Search-Class 的简写，这个命令能搜索出所有已经加载到 JVM 中的 Class 信息 12345678# 通配符匹配，打印搜索到的类全名sc *.demo.*# 打印类的详细信息sc -d com.example.demo.arthas.AdminFilterConfig# 打印出类的 Field 信息sc -d -f com.example.demo.arthas.AdminFilterConfig sm : 查看已加载类的方法信息 Search-Method 的简写，这个命令能搜索出所有已经加载到 JVM 中的 Method 信息 12345678# 打印指定类中的方法sm java.lang.String# 展示方法的详细信息sm -d java.lang.String# 展示指定方法的详细信息sm -d java.lang.String substring# 模糊匹配sm -d java.lang.String eq* jad : Java源码反编译工具 验证生产环境下的代码是否与提交的代码一致 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748# 打印出类的源码，类名jad com.example.demo.arthas.user.UserController## 输出jad com.example.demo.arthas.user.UserControllerClassLoader:+-org.springframework.boot.loader.LaunchedURLClassLoader@5b2133b1 +-sun.misc.Launcher$AppClassLoader@5c647e05 +-sun.misc.Launcher$ExtClassLoader@452b3a41Location:file:/Users/hanqf/Desktop/arhtas_dir/demo-arthas-spring-boot.jar!/BOOT-INF/classes!/ /* * Decompiled with CFR. * * Could not load the following classes: * com.example.demo.arthas.user.User * org.slf4j.Logger * org.slf4j.LoggerFactory * org.springframework.web.bind.annotation.GetMapping * org.springframework.web.bind.annotation.PathVariable * org.springframework.web.bind.annotation.RestController */ package com.example.demo.arthas.user; import com.example.demo.arthas.user.User; import org.slf4j.Logger; import org.slf4j.LoggerFactory; import org.springframework.web.bind.annotation.GetMapping; import org.springframework.web.bind.annotation.PathVariable; import org.springframework.web.bind.annotation.RestController; @RestController public class UserController &#123; private static final Logger logger = LoggerFactory.getLogger(UserController.class); @GetMapping(value=&#123;&quot;/user/&#123;id&#125;&quot;&#125;) public User findUserById(@PathVariable Integer id) &#123;/*15*/ logger.info(&quot;id: &#123;&#125;&quot;, (Object)id);/*17*/ if (id != null &amp;&amp; id &lt; 1) &#123; throw new IllegalArgumentException(&quot;id &lt; 1&quot;); &#125; return new User(id.intValue(), &quot;name&quot; + id); &#125; &#125;Affect(row-cnt:1) cost in 411 ms. 12345678910111213# 反编译后的源码会有类加载器的信息，如果只希望打印源码，可以加上 --source-onlyjad --source-only com.example.demo.arthas.user.UserController# 不显示行号jad --source-only com.example.demo.arthas.user.UserController --lineNumber false# 输出到文件jad --source-only com.example.demo.arthas.user.UserController &gt; /tmp/UserController.java# 打印出类中某个方法的源码，类名 + 方法名jad com.example.demo.arthas.user.UserController findUserById# 反编译时指定dump class文件目录jad --source-only com.example.demo.arthas.user.UserController --lineNumber false -d /tmp/jad 当有多个 ClassLoader 都加载了这个类时，jad 命令会输出对应 ClassLoader 实例的 hashcode，然后你只需要重新执行 jad 命令，并使用参数 -c 就可以反编译指定 ClassLoader 加载的那个类了； 123456789101112131415$ jad org.apache.log4j.LoggerFound more than one class for: org.apache.log4j.Logger, Please use jad -c hashcode org.apache.log4j.LoggerHASHCODE CLASSLOADER69dcaba4 +-monitor&#x27;s ModuleClassLoader6e51ad67 +-java.net.URLClassLoader@6e51ad67 +-sun.misc.Launcher$AppClassLoader@6951a712 +-sun.misc.Launcher$ExtClassLoader@6fafc4c22bdd9114 +-pandora-qos-service&#x27;s ModuleClassLoader4c0df5f8 +-pandora-framework&#x27;s ModuleClassLoaderAffect(row-cnt:0) cost in 38 ms.# 指定类加载器$ jad org.apache.log4j.Logger -c 69dcaba4 mc : Memory Compiler/内存编译器，编译.java文件生成.class 12345678# 编译，这里一定要指定类加载器，否则会报错，因为你编译的类中可能import其它类，不指定就会提示找不到对应的类。# 类加载器可以通过 jad 命令获取mc --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader /tmp/UserController.java# 指定类加载器的编号mc -c 5b2133b1 /tmp/UserController.java# 将 UserController.class 文件输出到指定目录， -d 指定输出目录mc --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader /tmp/UserController.java -d /tmp mc 命令有可能失败。如果编译失败可以在本地编译好.class文件，再上传到服务器。 retransform : 重新加载类(热修改代码) 123456789101112retransform /tmp/com/example/demo/arthas/user/UserController.class# 查看 通过 retransform 重新加载的 classretransform -l# 删除通过 retransform 重新加载的 class，通过 id 删除retransform -d 1# 删除所有retransform --deleteAll# 删除后要重新触发 retransform，否则内存中依旧使用的是删除前的 classretransform --classPattern com.example.demo.arthas.user.UserController sysprop : 查看当前 JVM 的系统属性 1234567891011# 打印系统属性sysprop# 指定单个 key，key支持自动补全sysprop java.version# 通过grep过滤sysprop | grep user# 设置 或 修改 系统属性sysprop testKey testValue sysenv : 查看当前 JVM 的环境变量 123456# 列出所有环境变量sysenv# 指定单个 key，key支持自动补全sysenv PATH# 通过grep过滤sysenv | grep PATH jvm : 查看当前 JVM 的信息 1jvm THREAD 相关 12345COUNT: JVM 当前活跃的线程数DAEMON-COUNT: JVM 当前活跃的守护线程数PEAK-COUNT: 从 JVM 启动开始曾经活着的最大线程数STARTED-COUNT: 从 JVM 启动开始总共启动过的线程次数DEADLOCK-COUNT: JVM 当前死锁的线程数 FILE-DESCRIPTOR 文件描述符相关 12MAX-FILE-DESCRIPTOR-COUNT：JVM 进程最大可以打开的文件描述符数OPEN-FILE-DESCRIPTOR-COUNT：JVM 当前打开的文件描述符数 watch : 函数执行数据观测 让你能方便的观察到指定函数的调用情况。能观察到的范围为：返回值、抛出异常、入参，通过编写 OGNL 表达式进行对应变量的查看。 123456789101112131415161718192021# 观察指定类中某个方法的调用情况，className + methodName + 返回值表达式# 开启后，当方法被调用时，会按照指定的 `返回值表达式` 输出结果，返回值表达式 可以不指定，默认为 &#123;params, target, returnObj&#125;watch com.example.demo.arthas.user.UserController findUserById &#x27;&#123;params, throwExp&#125;&#x27;# 观察全部方法，通配符匹配watch com.example.demo.arthas.user.UserController &#x27;*&#x27; &#x27;&#123;params, throwExp&#125;&#x27;# 默认输出结果没有展开，可以加上 -x 指定输出结果的属性遍历深度，默认为 1，最大值是 4watch com.example.demo.arthas.user.UserController &#x27;*&#x27; &#x27;&#123;params, throwExp&#125;&#x27; -x 2# 仅当抛出异常时才打印，-e 在函数异常之后观察watch com.example.demo.arthas.user.UserController &#x27;*&#x27; &#x27;&#123;params, throwExp&#125;&#x27; -x 2 -e# 参数条件过滤，params[0] &gt; 100 表示方法入参中第一个参数的值大于 100 时才触发打印watch com.example.demo.arthas.user.UserController * returnObj &#x27;params[0] &gt; 100&#x27;# 按请求耗时进行过滤，#cost&gt;200 表示耗时大于200mswatch com.example.demo.arthas.user.UserController * &#x27;&#123;params, returnObj&#125;&#x27; &#x27;#cost&gt;200&#x27;# 退出watchq watch 命令表达式支持变量说明表 名称 类型/说明 作用/含义 loader ClassLoader 方法所在类的类加载器对象 clazz Class&lt;?&gt; 方法所属的类（Class 对象） method java.lang.reflect.Method 被调用的方法的反射对象 target Object 方法的调用目标对象（即 this 对象），静态方法中为 null params Object[] 方法的入参数组 returnObj Object 方法的返回值 throwExp Throwable 方法抛出的异常 isBefore boolean 当前执行位置是否是方法调用之前（BEFORE 阶段） isThrow boolean 当前方法是否以异常结束（THROWS 阶段） isReturn boolean 当前方法是否正常返回（RETURN 阶段） jobs : 查看运行中的任务 12345678910111213141516171819202122# 如下命令会转到后台运行 ，与linux命令类似，命令最后加上 `&amp;` 即可watch com.example.demo.arthas.user.UserController * &#x27;&#123;params, throwExp&#125;&#x27; &#x27;throwExp != null&#x27; &gt;&gt; a.log &amp;# 查看后台任务jobs## 输出[1]* Running watch com.example.demo.arthas.user.UserController * &#x27;&#123;params, throwExp&#125;&#x27; &#x27;throwExp != null&#x27; &gt;&gt; a.log &amp; execution count : 0 start time : Thu May 15 15:10:04 CST 2025 timeout date : Fri May 16 15:10:04 CST 2025 session : ded56dfd-5683-4427-ac08-792f8fb75e5e (current)# 结束任务kill 1 # 1为后台任务id# 将后台任务转到前台fg 1 # 1为后台任务id# 暂停任务，但此时会将arthas进程都挂起，所以并不好用ctrl+z# 将前台任务转到后台继续执行bg 1 # 1为前台任务id logger : 查看 logger 信息，更新 logger level 1234567891011# 查看 logger 信息logger# 查看指定名字的logger信息logger -n ROOT# 查看没有 appender 的 logger 的信息，不加这个参数只会打印有 appender 的 logger 的信息logger --include-no-appender# 更新 logger level，-c classLoader 的 hashcodelogger --name ROOT --level debug -c 5b2133b1logger --name ROOT --level error --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader classloader : 查看 classloader 的继承树，urls，类加载信息 1234567# 查看 classloader 的信息，加载class的数量，hashcode，classloader 的 parentclassloader -l# 树形展示classloader -t# 查找资源，比如查找指定名称的文件classloader -c 5b2133b1 -r application.properties","summary":"摘要 本文介绍JVM的命令行工具 The Java® Virtual Machine Specification 版本jdk1.8","date_published":"2025-05-13T13:30:05.000Z","tags":["技术","jvm","jvm"]},{"id":"https://blog.hanqunfeng.com/2025/05/12/jvm-gc-01/","url":"https://blog.hanqunfeng.com/2025/05/12/jvm-gc-01/","title":"JVM 之 内存模型与垃圾回收机制(GC)","content_html":"<!--\n **加粗**\n *斜体*\n ***加粗并斜体***\n ~~删除线~~\n ==突出显示==\n `突出显示(推荐)`\n ++下划线++\n ~下标~\n ^上标^\n 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.\n 图片设置宽度和高度(通过uPic上传后，需要将upic修改过为blog，用于添加水印) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)\n\n +++ **点击折叠**\n 这是被隐藏的内容\n +++\n\n::: tips success warning danger\n这里是容器内的内容\n:::\n\n% note info % success warning danger\n这里是容器内的内容\n% endnote %\n\n引用本地其它文章连接{}\n 大括号开始% post_link 文件名称(不包含.md) %大括号结束\n -->\n<h2 id=\"摘要\">摘要</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>本文介绍JVM的内存模型与垃圾回收机制</p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://docs.oracle.com/javase/specs/jvms/se8/html/index.html\">The Java® Virtual Machine Specification</a> 版本jdk1.8</p>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"JVM虚拟机结构-HotSpot\">JVM虚拟机结构(HotSpot)</h2>\n<p><img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/cGMyEe.png\" alt=\"\"></p>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>设置内存分配示例</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># jdk1.8+</span></span><br><span class=\"line\">java ‐Xms2048M ‐Xmx2048M ‐Xmn1024M ‐Xss512K ‐XX:MetaspaceSize=256M ‐XX:MaxMetaspaceSize=256M ‐jar server.jar</span><br><span class=\"line\"><span class=\"comment\"># jdk1.6/1.7</span></span><br><span class=\"line\">java ‐Xms2048M ‐Xmx2048M ‐Xmn1024M ‐Xss512K ‐XX:PermSize=256M ‐XX:MaxPermSize=256M ‐jar server.jar</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>各参数含义与默认值（针对 JDK 1.8）</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>参数</th>\n<th>含义说明</th>\n<th>默认值（JDK 1.8）</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>-Xms2048M</code></td>\n<td><strong>初始堆大小</strong>，即 JVM 启动时分配的堆内存大小（这里是 2GB）</td>\n<td>物理内存的 1/64（最小 1MB），推荐配置为与 -Xmx 一致</td>\n</tr>\n<tr>\n<td><code>-Xmx2048M</code></td>\n<td><strong>最大堆内存大小</strong>，JVM 允许分配的最大堆内存</td>\n<td>物理内存的 1/4（受限于 32位/64位）</td>\n</tr>\n<tr>\n<td><code>-Xmn1024M</code></td>\n<td><strong>新生代大小</strong>（Eden + Survivor）为 1GB</td>\n<td>未显式指定时，通常占堆的 1/3 左右</td>\n</tr>\n<tr>\n<td><code>-Xss512K</code></td>\n<td><strong>每个线程的栈大小</strong>（Thread Stack Size），这里设置为 512KB</td>\n<td>1MB（64位系统）或 512KB（32位系统）</td>\n</tr>\n<tr>\n<td><code>-XX:MetaspaceSize=256M</code></td>\n<td><strong>元空间初始大小</strong>（用于加载类的元数据，不再使用 PermGen）</td>\n<td>21MB（客户端）或 16MB（服务器端）,推荐配置为与  MaxMetaspaceSize 一致</td>\n</tr>\n<tr>\n<td><code>-XX:MaxMetaspaceSize=256M</code></td>\n<td><strong>元空间最大大小</strong>，超过后触发 Full GC</td>\n<td>无限制（默认只受物理内存约束） ，推荐配置一个合适的数值，比如8G的内存可以配置为256M</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"类装载子系统（Class-Loading-Subsystem）\">类装载子系统（Class Loading Subsystem）</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>类装载子系统负责将 <code>.class</code> 文件加载到 JVM 中，并进行解析、验证、初始化等过程。</p>\n</li>\n<li class=\"lvl-2\">\n<p>加载过程的几个阶段：</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>阶段</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>加载（Loading）</strong></td>\n<td>将 <code>.class</code> 文件读取为二进制数据，构造 <code>Class</code> 对象</td>\n</tr>\n<tr>\n<td><strong>验证（Verification）</strong></td>\n<td>确保字节码文件格式正确、安全合法（防止恶意代码）</td>\n</tr>\n<tr>\n<td><strong>准备（Preparation）</strong></td>\n<td>为类的静态变量分配内存，并设置默认初始值</td>\n</tr>\n<tr>\n<td><strong>解析（Resolution）</strong></td>\n<td>将常量池中的符号引用替换为直接引用（方法、字段等）</td>\n</tr>\n<tr>\n<td><strong>初始化（Initialization）</strong></td>\n<td>执行 <code>&lt;clinit&gt;</code> 静态初始化方法，对静态变量赋初始值</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>类加载器（ClassLoader）体系结构：详细参考 <a href=\"/2025/05/08/jvm-classloader-01/\" title=\"JVM 之 类加载器\">JVM 之 类加载器</a></p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>类加载器名称</th>\n<th>加载内容</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>引导类加载器（Bootstrap ClassLoader）</strong></td>\n<td>Java 核心类库（如 <code>java.lang.*</code>）</td>\n<td>由 JVM 自身实现，用本地代码实现，无法直接访问</td>\n</tr>\n<tr>\n<td><strong>扩展类加载器（Extension ClassLoader）</strong></td>\n<td><code>JAVA_HOME/jre/lib/ext</code> 目录下的类</td>\n<td>加载标准扩展类库</td>\n</tr>\n<tr>\n<td><strong>应用类加载器（Application ClassLoader）</strong></td>\n<td>用户应用类路径（CLASSPATH 指定的目录）</td>\n<td>最常用，加载大多数应用代码</td>\n</tr>\n<tr>\n<td><strong>自定义类加载器（Custom ClassLoader）</strong></td>\n<td>用户手动实现的类加载器</td>\n<td>可以打破双亲委派机制，实现热加载、加密类加载等</td>\n</tr>\n</tbody>\n</table>\n<blockquote>\n<p>类加载采用 双亲委派模型：请求会先向父加载器委托，只有在父加载器加载失败时才尝试自身加载。</p>\n</blockquote>\n<h3 id=\"字节码执行引擎（Execution-Engine）\">字节码执行引擎（Execution Engine）</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>字节码执行引擎负责将 Java 字节码解释或编译为机器代码，并在底层平台上执行。</p>\n</li>\n<li class=\"lvl-2\">\n<p>执行引擎的核心模块</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>组件名称</th>\n<th>作用说明</th>\n<th>关键特性</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>解释器（Interpreter）</strong></td>\n<td>将字节码逐条解释执行</td>\n<td>启动快，适合冷代码（非热点代码），执行效率相对较低</td>\n</tr>\n<tr>\n<td><strong>即时编译器（JIT Compiler）</strong></td>\n<td>将热点代码编译为本地机器码，提高执行效率</td>\n<td>包含 C1（Client）和 C2（Server）两种，支持优化如：方法内联、逃逸分析、循环展开等</td>\n</tr>\n<tr>\n<td><strong>垃圾收集器（Garbage Collector, GC）</strong></td>\n<td>自动内存管理，负责对象生命周期的回收</td>\n<td>常见算法包括：Serial、Parallel、CMS、G1、ZGC（低延迟）等，根据不同场景选择</td>\n</tr>\n<tr>\n<td><strong>本地接口（Native Interface）</strong></td>\n<td>支持 Java 与本地语言（如 C/C++）的互操作</td>\n<td>通过 JNI（Java Native Interface）实现，调用底层操作系统或第三方库功能</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"JVM-内存模型（Java-Memory-Model，JMM）\">JVM 内存模型（Java Memory Model，JMM）</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>JMM 是 Java 虚拟机规范中定义的一种 抽象内存模型，它决定了多线程程序中变量的读写可见性、有序性和原子性。同时，JVM 在物理层也有一个实际的内存结构，称为运行时数据区域（Runtime Data Areas），这两个可以结合理解。</p>\n</li>\n<li class=\"lvl-2\">\n<p>JMM 的主要目标</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">保证多线程环境下的数据一致性</li>\n<li class=\"lvl-6\">指导 JVM 和 CPU 的内存交互行为（如重排序、缓存）</li>\n</ul>\n</li>\n<li class=\"lvl-2\">\n<p>实际运行时内存结构如下：</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>内存区域</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>📌 <strong>程序计数器（PC）</strong></td>\n<td>每个线程私有，记录当前执行的字节码指令地址</td>\n</tr>\n<tr>\n<td>📌 <strong>Java 线程栈</strong></td>\n<td>每个线程私有，方法调用时用于存储局部变量、操作数栈等</td>\n</tr>\n<tr>\n<td>📌 <strong>本地方法栈</strong></td>\n<td>与虚拟机栈类似，用于 native 方法</td>\n</tr>\n<tr>\n<td>📌 <strong>堆（Heap）</strong></td>\n<td>所有线程共享，存储对象实例、数组等，GC 的主要区域</td>\n</tr>\n<tr>\n<td>📌 <strong>方法区（或元空间）</strong></td>\n<td>所有线程共享，存储类信息、静态变量、常量池等（JDK8 后称为 Metaspace）</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"垃圾回收器\">垃圾回收器</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>垃圾回收器负责自动管理内存，回收不再使用的对象，避免内存泄漏和溢出。</p>\n</li>\n</ul>\n<h3 id=\"什么是垃圾\">什么是垃圾</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>内存中没有被（线程栈变量，静态变量，常量池，JNI指针）引用的地址就是垃圾</p>\n</li>\n<li class=\"lvl-2\">\n<p>可达性分析算法：是现代 JVM 判断一个对象是否“还活着”的主要算法。</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">基本思想：</span><br><span class=\"line\">从一组称为 “GC Roots” 的对象出发，沿着对象之间的引用链向下搜索。</span><br><span class=\"line\">如果某个对象 可以从 GC Roots 追踪到，就认为它是 “可达” 的（Alive）。</span><br><span class=\"line\">否则就认为是 “不可达” 的（Garbage），可以被回收。</span><br></pre></td></tr></table></figure>\n<div class=\"tips\">\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">\n<p>在 JVM 中，<code>GC Roots</code> 是一些 始终可用的、不会被垃圾回收的引用起点，主要包括：</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>GC Roots 来源</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>当前线程栈中的引用（局部变量表）</td>\n<td>各个线程正在调用的方法中的局部变量、参数等</td>\n</tr>\n<tr>\n<td>静态字段引用</td>\n<td>类的静态字段引用的对象</td>\n</tr>\n<tr>\n<td>JNI 引用（Native 方法引用）</td>\n<td>Java 本地方法中引用的对象</td>\n</tr>\n<tr>\n<td>常量引用池中的对象</td>\n<td>字符串常量等可能持有对象引用</td>\n</tr>\n<tr>\n<td>活动线程对象</td>\n<td>线程自身在 GC 时不会被回收</td>\n</tr>\n<tr>\n<td>JVM 内部结构（如系统类加载器等）</td>\n<td>JVM 关键系统对象</td>\n</tr>\n</tbody>\n</table>\n</div>\n<h3 id=\"垃圾回收器种类：\">垃圾回收器种类：</h3>\n<p><img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/TEILZ9.png\" alt=\"\"></p>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>左边6种叫分代模型，右边的4种叫分区模型</p>\n</li>\n</ul>\n<div class=\"tips\">\n<p><em><strong>分代模型（Generational Model）</strong></em><br>\n堆内存划分为：<br>\n年轻代（Young Generation）：存放新创建的对象，分为 Eden 和 Survivor 区。<br>\n老年代（Old Generation）：存放经过多次 GC 后仍然存活的对象。</p>\n<p><em><strong>分区模型（Region-based Model）</strong></em><br>\n分区模型（如 G1、ZGC、Shenandoah）不再严格按照代划分内存，而是把堆划分为多个 大小相同的 Region。每个 Region 可以在运行时被动态标记为 Eden、Survivor 或 Old。</p>\n</div>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>分代模型中，上面3个是新生代垃圾回收器，下面3个是老年代垃圾回收器，可以交叉配对（见上图虚线），但最常用是上下两两配对。</p>\n</li>\n<li class=\"lvl-2\">\n<p>CMS即可以作为新生代垃圾回收器，也可以作为老年代垃圾回收器。</p>\n</li>\n<li class=\"lvl-2\">\n<p>EpsilonGC，是一个特殊的垃圾回收器，它不回收任何对象，只负责最终记录，做测试用的。</p>\n</li>\n<li class=\"lvl-2\">\n<p>目前最先进的模型是 <code>ZGC</code>，jkd11开始支持，但直到JDK16才比较完善，目前非默认配置，需要手动配置。其与Redhat出品的 <code>Shenandoah</code> 是竞争关系。</p>\n</li>\n<li class=\"lvl-2\">\n<p>常见垃圾回收器及其分类、JDK版本</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>垃圾回收器</th>\n<th>所属模型</th>\n<th>说明</th>\n<th>首次出现 JDK 版本</th>\n<th>启用命令（JVM 参数）</th>\n<th>适合的堆内存大小</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>Serial</strong></td>\n<td>分代模型</td>\n<td>单线程，新生代和老年代都使用 Serial，适用于小堆内存</td>\n<td>JDK 1.2</td>\n<td><code>-XX:+UseSerialGC</code></td>\n<td>💾 小于 1GB</td>\n</tr>\n<tr>\n<td><strong>ParNew</strong></td>\n<td>分代模型</td>\n<td>Serial 的多线程版本，<strong>仅用于 CMS 新生代</strong></td>\n<td>JDK 1.4</td>\n<td><code>-XX:+UseParNewGC -XX:+UseConcMarkSweepGC</code></td>\n<td>💾 1GB ~ 4GB</td>\n</tr>\n<tr>\n<td><strong>Parallel（吞吐量 GC）</strong></td>\n<td>分代模型</td>\n<td>多线程 GC，适合吞吐量优先的应用场景</td>\n<td>JDK 1.4</td>\n<td><code>-XX:+UseParallelGC</code>（新生代）<br><code>-XX:+UseParallelOldGC</code>（老年代）</td>\n<td>💾 2GB ~ 8GB</td>\n</tr>\n<tr>\n<td><strong>CMS（Concurrent Mark Sweep）</strong></td>\n<td>分代模型</td>\n<td>老年代并发标记-清除，低延迟，但存在碎片，<strong>已弃用</strong></td>\n<td>JDK 1.4</td>\n<td><code>-XX:+UseConcMarkSweepGC</code></td>\n<td>💾 2GB ~ 8GB（已过时）</td>\n</tr>\n<tr>\n<td><strong>G1（Garbage First）</strong></td>\n<td>分区模型</td>\n<td>将堆划分为 Region，逻辑分代，支持并发压缩，平衡延迟与吞吐</td>\n<td>JDK 7u4（正式）</td>\n<td><code>-XX:+UseG1GC</code></td>\n<td>💾 4GB ~ 数十 GB</td>\n</tr>\n<tr>\n<td><strong>ZGC（Z Garbage Collector）</strong></td>\n<td>分区模型</td>\n<td>Region 弹性大小，支持超大堆，低延迟（&lt;10ms 停顿）</td>\n<td>JDK 11（实验），JDK 15（正式）</td>\n<td><code>-XX:+UseZGC</code></td>\n<td>💾 8GB ~ 数 TB（超大堆）</td>\n</tr>\n<tr>\n<td><strong>Shenandoah</strong></td>\n<td>分区模型</td>\n<td>红帽主导，低延迟，并发回收与并发压缩</td>\n<td>JDK 12（实验），JDK 15（正式）</td>\n<td><code>-XX:+UseShenandoahGC</code></td>\n<td>💾 2GB ~ 数十 GB</td>\n</tr>\n</tbody>\n</table>\n<blockquote>\n<p>对于 CMS，启用后会自动使用 ParNew 作为新生代回收器（除非显式禁止）。<br>\nCMS 已在 JDK 9 开始标记为弃用，JDK 14 完全移除，不推荐再使用。<br>\n对于 Parallel GC 启用 <code>-XX:+UseParallelGC</code>（新生代）会自动启用 <code>-XX:+UseParallelOldGC</code>（老年代）。<br>\n对于ZGC，jdk15以前最大支持4T内存，之后最大支持16T内存。</p>\n</blockquote>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>各版本默认垃圾回收器及推荐配置（JDK 1.6 起）</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>JDK 版本</th>\n<th>默认 GC</th>\n<th>建议使用 GC（按场景分类）</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>JDK 1.6</strong></td>\n<td>Serial / Parallel</td>\n<td>- 小型应用（如桌面程序）：<code>-XX:+UseSerialGC</code>  <br> - 中大型应用（吞吐量优先）：<code>-XX:+UseParallelGC</code></td>\n</tr>\n<tr>\n<td><strong>JDK 1.7</strong></td>\n<td>同上</td>\n<td>同 JDK 1.6</td>\n</tr>\n<tr>\n<td><strong>JDK 1.8</strong></td>\n<td>Parallel</td>\n<td>- 吞吐优先：默认 <code>-XX:+UseParallelGC</code> <br> - 响应优先：<code>-XX:+UseConcMarkSweepGC</code>（CMS）<br> - 大堆 + 未来升级考虑：<code>-XX:+UseG1GC</code>（推荐）</td>\n</tr>\n<tr>\n<td><strong>JDK 9-14</strong></td>\n<td>G1 GC</td>\n<td>- 一般默认即可：<code>-XX:+UseG1GC</code>（延迟与吞吐平衡）<br> - 极端低延迟要求：升级到 JDK 11+ 使用 ZGC/Shenandoah</td>\n</tr>\n<tr>\n<td><strong>JDK 15+</strong></td>\n<td>G1 GC（默认），ZGC / Shenandoah 可选</td>\n<td>- 延迟敏感（在线服务、RT系统）：<code>-XX:+UseZGC</code> 或 <code>-XX:+UseShenandoahGC</code><br> - 吞吐为主：<code>-XX:+UseParallelGC</code><br> - 综合平衡：<code>-XX:+UseG1GC</code>（默认）</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>判断默认 GC 的方式</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">java -XX:+PrintCommandLineFlags -version</span><br></pre></td></tr></table></figure>\n<h3 id=\"垃圾回收算法\">垃圾回收算法</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>JVM 中常见垃圾回收算法汇总</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>算法名称</th>\n<th>核心思想</th>\n<th>适用阶段/区域</th>\n<th>优缺点简述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>标记-清除（Mark-Sweep）</strong></td>\n<td>标记出存活对象，清除未标记对象</td>\n<td>老年代</td>\n<td>简单高效，但会产生大量碎片，不适合连续内存分配</td>\n</tr>\n<tr>\n<td><strong>标记-整理（Mark-Compact）</strong></td>\n<td>标记后移动存活对象，整理碎片</td>\n<td>老年代</td>\n<td>消除碎片，代价是移动对象，适用于老年代压缩</td>\n</tr>\n<tr>\n<td><strong>复制算法（Copying）</strong></td>\n<td>将对象复制到另一块内存（如 Eden → Survivor）</td>\n<td>新生代</td>\n<td>高效率，适合回收大多数对象短命的新生代，但需要额外空间</td>\n</tr>\n<tr>\n<td><strong>分代回收（Generational）</strong></td>\n<td>将对象按生命周期划分（新生代/老年代）</td>\n<td>整个堆结构</td>\n<td>实用性强，结合不同算法应用于不同代，现代 GC 基础</td>\n</tr>\n<tr>\n<td><strong>分区回收（Region-based）</strong></td>\n<td>将堆划分为若干等大小的 Region 动态分配</td>\n<td>整个堆（如 G1、ZGC）</td>\n<td>更灵活，支持并发并行，减少 STW 停顿，适用于大堆、低延迟场景</td>\n</tr>\n<tr>\n<td><strong>增量回收（Incremental）</strong></td>\n<td>分阶段小步执行 GC 以减少单次停顿</td>\n<td>某些并发/低延迟 GC</td>\n<td>减少暂停时间，但整体效率可能降低</td>\n</tr>\n<tr>\n<td><strong>并发回收（Concurrent）</strong></td>\n<td>标记、清理等步骤与应用线程并发执行</td>\n<td>CMS、G1、ZGC 等</td>\n<td>停顿时间短，对响应时间要求高的系统友好</td>\n</tr>\n<tr>\n<td><strong>三色标记（Tri-color Marking）</strong></td>\n<td>并发标记算法的一种实现思想</td>\n<td>CMS、G1、ZGC 等</td>\n<td>白（待回收）、灰（已标记未扫描）、黑（已标记已扫描），避免“漏标”问题</td>\n</tr>\n<tr>\n<td><strong>SATB（Snapshot-At-The-Beginning）</strong></td>\n<td>并发标记的快照策略</td>\n<td>G1、ZGC</td>\n<td>保证在并发标记过程中不遗漏新引用，适合高并发场景</td>\n</tr>\n<tr>\n<td><strong>Lazy Compaction（延迟压缩）</strong></td>\n<td>不每次 GC 都压缩，视情况而定</td>\n<td>G1 等</td>\n<td>降低不必要的移动成本</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>对应关系：GC 回收器和底层算法</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>回收器</th>\n<th>使用的算法组合</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>Serial</strong></td>\n<td>新生代：复制算法<br>老年代：标记-整理</td>\n</tr>\n<tr>\n<td><strong>ParNew</strong></td>\n<td>新生代：复制算法（多线程）</td>\n</tr>\n<tr>\n<td><strong>Parallel</strong></td>\n<td>新生代：复制算法<br>老年代：标记-整理</td>\n</tr>\n<tr>\n<td><strong>CMS</strong></td>\n<td>新生代：ParNew（复制）<br>老年代：标记-清除 + 三色标记 + 并发</td>\n</tr>\n<tr>\n<td><strong>G1</strong></td>\n<td>分区回收 + 三色标记 + SATB + Lazy Compaction</td>\n</tr>\n<tr>\n<td><strong>ZGC</strong></td>\n<td>分区回收 + 并发标记 + SATB + Region Remapping</td>\n</tr>\n<tr>\n<td><strong>Shenandoah</strong></td>\n<td>分区回收 + 并发标记 + 并发压缩 + 三色标记</td>\n</tr>\n</tbody>\n</table>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">       ┌────────────────────────┐</span><br><span class=\"line\">       │   常见 GC 算法分类       │</span><br><span class=\"line\">       └────────────────────────┘</span><br><span class=\"line\">                 │</span><br><span class=\"line\">   ┌─────────────┴──────────────┐</span><br><span class=\"line\">   │                            │</span><br><span class=\"line\">分代模型                      分区模型</span><br><span class=\"line\">   │                            │</span><br><span class=\"line\"> ┌─┴─────┐                  ┌───┴─────┐</span><br><span class=\"line\">复制   标记-清除         Region-based 并发</span><br><span class=\"line\">      标记-整理             SATB / 三色标记</span><br></pre></td></tr></table></figure>\n<h4 id=\"什么是-STW（Stop-The-World）\">什么是 STW（Stop-The-World）</h4>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>STW（Stop-The-World） 指的是：在某些垃圾回收阶段，JVM 会暂停所有应用线程（也叫用户线程），让垃圾回收线程独占 CPU 执行 GC 逻辑。</p>\n</li>\n<li class=\"lvl-2\">\n<p>你可以这样理解 STW</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">JVM 会“按下暂停键”暂停所有正在运行的 Java 程序代码；</li>\n<li class=\"lvl-6\">然后 专心进行 GC 的某些阶段（如标记、整理、复制等）；</li>\n<li class=\"lvl-6\">GC 完成后，才会“恢复运行”应用线程。</li>\n</ul>\n</li>\n<li class=\"lvl-2\">\n<p>各 GC 中 STW 的存在情况</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>回收器</th>\n<th>是否存在 STW？</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Serial</td>\n<td>✅ 是，全停顿，全阶段单线程</td>\n<td>堆越大 STW 越长</td>\n</tr>\n<tr>\n<td>Parallel</td>\n<td>✅ 是，全停顿，多线程执行 GC</td>\n<td>提高效率但仍会暂停</td>\n</tr>\n<tr>\n<td>CMS</td>\n<td>✅ 有，初始标记和最终重新标记是 STW</td>\n<td>大部分阶段并发执行</td>\n</tr>\n<tr>\n<td>G1</td>\n<td>✅ 有，但设计为尽可能缩短 STW</td>\n<td>分阶段并发 + 并行处理</td>\n</tr>\n<tr>\n<td>ZGC</td>\n<td>✅ 极短（&lt;10ms）</td>\n<td>仅个别阶段是 STW，几乎感知不到</td>\n</tr>\n<tr>\n<td>Shenandoah</td>\n<td>✅ 极短</td>\n<td>高度并发，STW 时间也极短</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>为什么要关注 STW？</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">在响应时间敏感型系统（如在线交易系统、游戏服务器、API 网关）中，长时间的 STW 会造成用户请求卡顿、超时。</li>\n<li class=\"lvl-6\">因此，选择 低 STW 的 GC（如 G1、ZGC、Shenandoah） 对这类系统至关重要。</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"堆内存结构\">堆内存结构</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>不同的垃圾回收器决定了堆内存的结构不同，但总体上分为两种类型：分代模型和分区模型。</p>\n</li>\n</ul>\n<h3 id=\"分代模型\">分代模型</h3>\n<h4 id=\"Parallel-垃圾回收器\">Parallel 垃圾回收器</h4>\n<p><img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/Apr5aY.png\" alt=\"\"></p>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>堆结构被划分为 <code>Old Generation（老年代）</code> 和 <code>Young Generation（新生代）</code> 两部分。</p>\n</li>\n<li class=\"lvl-2\">\n<p><code>Young Generation</code> 由 <code>Eden</code> 和 两个 <code>Survivor</code> 组成，其中 <code>Eden</code> 是一个连续的内存区域，<code>Survivor</code> 是一个非连续的内存区域。</p>\n</li>\n<li class=\"lvl-2\">\n<p>默认情况下，<code>Young Generation</code>占堆内存的 <code>1/3</code>,  <code>Old Generation</code> 占堆内存的 <code>2/3</code>。</p>\n</li>\n<li class=\"lvl-2\">\n<p>默认情况下，<code>Eden:S0:S1 = 8:1:1</code> ,如果希望为 4:1:1，使用 <code>-XX:SurvivorRatio=4</code>，但实际上这个比例并不是固定的，而是由jvm基于情况自动变化的，因为JVM默认开启了这个参数<code>-XX:+UseAdaptiveSizePolicy</code>，如果希望固定这个比例，可以设置为 <code>-XX:-UseAdaptiveSizePolicy</code>来关闭这个配置。</p>\n</li>\n<li class=\"lvl-2\">\n<p>默认情况下，对象最多经历<code>15次</code>Minor GC后进入老年代，可以通过 <code>-XX:MaxTenuringThreshold=n</code> 设置。</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>区域</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>Eden</strong></td>\n<td>对象首次创建的区域，大部分对象在这里创建并很快被回收</td>\n</tr>\n<tr>\n<td><strong>S0/S1</strong></td>\n<td>Survivor 区域：两个交替使用的缓冲区（From 和 To），用于拷贝存活对象</td>\n</tr>\n<tr>\n<td><strong>Old</strong></td>\n<td>老年代：存活次数多、生命周期长的对象会从新生代晋升到老年代，回收频率低</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>对象内存分配图解(简化)</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">创建对象</span><br><span class=\"line\">   ↓</span><br><span class=\"line\">进入 Eden 区（新生代）</span><br><span class=\"line\">   ↓ Eden 区满</span><br><span class=\"line\">第一次 Minor GC（存活对象[Eden]复制到 S0）</span><br><span class=\"line\">   ↓ Eden 区满 或 S0 区满</span><br><span class=\"line\">第二次 Minor GC（存活对象[Eden和S0]复制到 S1，年龄 +1）</span><br><span class=\"line\">   ↓ Eden 区满 或 S1 区满</span><br><span class=\"line\">第三次 Minor GC（存活对象[Eden和S1]复制到 S0，年龄 +1）</span><br><span class=\"line\">   ↓</span><br><span class=\"line\">……  S0/S1 交替，年龄达到阈值（如 15）</span><br><span class=\"line\">   ↓ 还没有被回收</span><br><span class=\"line\">晋升到 Old 区（老年代），等待Old区满 触发 Full GC</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>大对象直接进入老年代</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">大对象就是需要大量连续内存空间的对象（比如：字符串、数组），如果对象很大（如超过 Eden 区大小，或是超过 Survivor 区大小），可能直接分配到老年代</li>\n<li class=\"lvl-6\">也可以通过 <code>-XX:PretenureSizeThreshold=&lt;大小，单位字节&gt;</code> 控制超过一定大小的对象是否直接分配到老年代（Old Generation），跳过新生代（Eden），以避免大对象频繁在年轻代造成 GC 压力。这个参数只在 Serial 和ParNew两个收集器下有效。</li>\n</ul>\n</li>\n<li class=\"lvl-2\">\n<p>对象动态年龄判断</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">对象在Survivor区来回移动时，如果这批对象的总大小大于这块Survivor区域内存大小的50%(-XX:TargetSurvivorRatio可以指定)，那么此时大于等于这批对象年龄最大值的对象，就可以直接进入老年代了，</li>\n<li class=\"lvl-6\">例如Survivor区域里现在有一批对象，年龄1+年龄2+年龄n的多个年龄对象总和超过了Survivor区域的50%，此时就会把年龄n(含)以上的对象都放入老年代。这个规则其实是希望那些可能是长期存活的对象，尽早进入老年代。</li>\n<li class=\"lvl-6\">对象动态年龄判断机制一般是在minor gc之后触发的。</li>\n</ul>\n</li>\n</ul>\n<div class=\"tips\">\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">\n<p>对象逃逸分析</p>\n<ul class=\"lvl-3\">\n<li class=\"lvl-6\">如果对象很小，且只在方法内部使用，并没有被外部引用，则其有可能直接分配到栈内存，而不进入堆内存</li>\n<li class=\"lvl-6\">JVM对于这种情况可以通过开启逃逸分析参数(-XX:+DoEscapeAnalysis)来优化对象内存分配位置，使其通过<code>标量替换</code>优先分配在栈上(栈上分配)，JDK7之后默认开启逃逸分析，如果要关闭使用参数(-XX:-DoEscapeAnalysis)</li>\n</ul>\n</li>\n<li class=\"lvl-2\">\n<p>标量替换</p>\n<ul class=\"lvl-3\">\n<li class=\"lvl-6\">通过逃逸分析确定该对象不会被外部访问，并且对象可以被进一步分解时，JVM不会创建该对象，而是将该对象成员变量分解若干个被这个方法使用的成员变量所代替，这些代替的成员变量在栈帧或寄存器上分配空间，这样就不会因为没有一大块连续空间导致对象内存不够分配。</li>\n<li class=\"lvl-6\">开启标量替换参数(-XX:+EliminateAllocations)，JDK7之后默认开启。</li>\n</ul>\n</li>\n<li class=\"lvl-2\">\n<p>标量与聚合量</p>\n<ul class=\"lvl-3\">\n<li class=\"lvl-6\">标量即不可被进一步分解的量，而JAVA的基本数据类型就是标量（如：int，long等基本数据类型以及reference类型等），</li>\n<li class=\"lvl-6\">标量的对立就是可以被进一步分解的量，而这种量称之为聚合量。而在JAVA中对象就是可以被进一步分解的聚合量。</li>\n</ul>\n</li>\n</ul>\n</div>\n<h4 id=\"Parallel-垃圾回收器（Parallel-GC）-的工作方式\">Parallel 垃圾回收器（Parallel GC） 的工作方式</h4>\n<p><img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/fo2Egs.png\" alt=\"\" width=\"1200\" height=\"600\"></p>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Parallel GC 是多线程垃圾回收器，可以通过 <code>-XX:ParallelGCThreads</code> 来设置GC线程数量。</p>\n</li>\n<li class=\"lvl-2\">\n<p>当 Parallel GC 被触发（例如 Minor GC 或 Full GC）时，所有用户线程 被完全暂停（Stop-The-World, STW）</p>\n</li>\n</ul>\n<h4 id=\"Parallel-GC-参数配置表（吞吐量优先-GC）\">Parallel GC 参数配置表（吞吐量优先 GC）</h4>\n<table>\n<thead>\n<tr>\n<th>参数名</th>\n<th>说明</th>\n<th>默认值（如未特别说明）</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>-XX:+UseParallelGC</code></td>\n<td>开启 Parallel GC，用于新生代收集</td>\n<td>-</td>\n</tr>\n<tr>\n<td><code>-XX:+UseParallelOldGC</code></td>\n<td>开启老年代并行收集（Parallel Old）</td>\n<td>-</td>\n</tr>\n<tr>\n<td><code>-XX:ParallelGCThreads</code></td>\n<td>垃圾回收时的并行线程数（与 CPU 数量相关）</td>\n<td>根据硬件自动配置</td>\n</tr>\n<tr>\n<td><code>-XX:MaxGCPauseMillis</code></td>\n<td>设置 GC 最大暂停时间目标（影响内存分配策略）</td>\n<td>一个非常大的值，可以认为无限制（建议按需设置）</td>\n</tr>\n<tr>\n<td><code>-XX:GCTimeRatio</code></td>\n<td>设置 GC 时间与应用运行时间的比值（0~100）<br>值越小，GC 越频繁，值越大 GC 越少</td>\n<td>99（表示 1% 用于 GC，99% 用于应用）</td>\n</tr>\n<tr>\n<td><code>-XX:+UseAdaptiveSizePolicy</code></td>\n<td>启用自适应 GC 策略（根据运行状况自动调整各区域大小）</td>\n<td>默认开启</td>\n</tr>\n<tr>\n<td><code>-XX:SurvivorRatio</code></td>\n<td>Eden 与 Survivor 的内存比例（如 8 表示 Eden:S0:S1 = 8:1:1）</td>\n<td>8</td>\n</tr>\n<tr>\n<td><code>-XX:InitialTenuringThreshold</code></td>\n<td>对象晋升到老年代的初始年龄（会随运行动态调整）</td>\n<td>7</td>\n</tr>\n<tr>\n<td><code>-XX:MaxTenuringThreshold</code></td>\n<td>晋升到老年代的最大年龄（对象在 Survivor 区经历几次 GC）</td>\n<td>15</td>\n</tr>\n<tr>\n<td><code>-XX:PretenureSizeThreshold</code></td>\n<td>设置大对象阈值，超过该大小的对象直接分配到老年代</td>\n<td>0（即禁用）</td>\n</tr>\n<tr>\n<td><code>-XX:+ScavengeBeforeFullGC</code></td>\n<td>在 Full GC 之前是否先执行一次 Minor GC</td>\n<td>true启</td>\n</tr>\n<tr>\n<td><code>-XX:+UseFastAccessorMethods</code></td>\n<td>优化原始类型的 get/set 方法性能</td>\n<td>false启</td>\n</tr>\n<tr>\n<td><code>-XX:+AlwaysPreTouch</code></td>\n<td>JVM 启动时立即分配并初始化所有内存页，避免运行时首次分配带来的停顿</td>\n<td>false</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"分区模型\">分区模型</h3>\n<h4 id=\"G1-垃圾回收器\">G1 垃圾回收器</h4>\n<p><img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/AaqBxm.png\" alt=\"\" width=\"900\" height=\"300\"></p>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>G1(Garbage-First) 属于 物理上分区，逻辑上分代，真正的分区模型是 <code>ZGC</code>（jdk21后也支持分代）</p>\n</li>\n<li class=\"lvl-2\">\n<p>G1将Java堆划分为多个大小相等的独立区域（Region），在JDK10以前，JVM最多可以有<code>2048</code>个Region，每个 Region 的大小是 2^n MB，并且落在 1MB 到 32MB 之间，这就导致G1最大支持64G 的堆 (<code>2048 Regions × 32MB = 64GB</code>)，在JDK10以后，G1 支持 更多 Region（最多约 32,768 个），而Region 大小仍是 1MB～32MB 的 2 的幂，使其最大可以支持 1T  的堆。JDK17开始，HotSpot JVM 已改进 G1 的 Region 映射方式（如提升每个Region的大小），可以进一步提升支持的堆大小上限。但堆越大，FullGC就越慢，建议 <code>&gt;1T</code> 的堆使用<code>ZGC</code>或<code>Shenandoah GC</code>。</p>\n</li>\n<li class=\"lvl-2\">\n<p>一般Region大小由JVM自动计算，当然也可以用参数<code>-XX:G1HeapRegionSize</code>手动指定Region大小，但是推荐默认的计算方式。</p>\n</li>\n<li class=\"lvl-2\">\n<p>G1保留了年轻代和老年代的概念，但不再是物理隔阂了，它们都是（可以不连续）Region的集合。</p>\n</li>\n<li class=\"lvl-2\">\n<p>在 G1 GC 中，不要使用 <code>-Xmn</code>，G1 中推荐使用以下更细粒度的控制方式：</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 这是实验性参数，需要开启 `-XX:+UnlockExperimentalVMOptions`，但依旧推荐在生产环境中使用</span></span><br><span class=\"line\">-XX:G1NewSizePercent=5</span><br><span class=\"line\">-XX:G1MaxNewSizePercent=60</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>默认年轻代对堆内存的占比是<code>5%</code>，如果堆大小为4096M，那么年轻代占据200MB左右的内存，对应大概是100个Region，可以通过   <code>-XX:G1NewSizePercent</code>设置新生代初始占比，这是实验性参数，需要开启 <code>-XX:+UnlockExperimentalVMOptions</code>，但依旧推荐在生产环境中使用。</p>\n</li>\n<li class=\"lvl-2\">\n<p>在系统运行中，JVM会不停的给年轻代增加更多的Region，但是最多新生代的占比不会超过<code>60%</code>，可以通过<code>-XX:G1MaxNewSizePercent</code>调整，这是实验性参数，需要开启 <code>-XX:+UnlockExperimentalVMOptions</code>，但依旧推荐在生产环境中使用。</p>\n</li>\n<li class=\"lvl-2\">\n<p>年轻代中的Eden和Survivor对应的region也跟之前一样，默认<code>8:1:1</code>，假设年轻代现在有1000个region，eden区对应800个，s0对应100个，s1对应100个。</p>\n</li>\n<li class=\"lvl-2\">\n<p>一个Region可能之前是年轻代，如果Region进行了垃圾回收，之后可能又会变成老年代，也就是说Region的区域功能可能会动态变化。</p>\n</li>\n<li class=\"lvl-2\">\n<p>G1垃圾收集器对于对象什么时候会转移到老年代跟之前讲过的原则一样，唯一不同的是对大对象的处理，G1有专门分配大对象的Region叫<code>Humongous</code>区，而不是让大对象直接进入老年代的Region中。</p>\n</li>\n<li class=\"lvl-2\">\n<p>在G1中，大对象的判定规则就是一个大对象超过了一个Region大小的<code>50%</code>，比如按照上面算的，每个Region是2M，只要一个大对象超过了1M，就会被放入Humongous中，而且一个大对象如果太大，可能会横跨多个Region来存放。</p>\n</li>\n<li class=\"lvl-2\">\n<p>Humongous区专门存放短期巨型对象，不用直接进老年代，可以节约老年代的空间，避免因为老年代空间不够的GC开销。</p>\n</li>\n<li class=\"lvl-2\">\n<p>Full GC的时候除了收集年轻代和老年代之外，也会将Humongous区一并回收。</p>\n</li>\n</ul>\n<h5 id=\"G1垃圾收集分类\">G1垃圾收集分类</h5>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>YoungGC<br>\nYoungGC并不是说现有的Eden区放满了就会马上触发，G1会计算下现在Eden区回收大概要多久时间，如果回收时间远远小于参数 <code>-XX:MaxGCPauseMills</code> 设定的值，那么增加年轻代的region，继续给新对象存放，不会马上做YoungGC，直到下一次Eden区放满，G1计算回收时间接近参数 <code>-XX:MaxGCPauseMills</code> 设定的值，那么就会触发Young GC</p>\n</li>\n<li class=\"lvl-2\">\n<p>MixedGC<br>\n不是FullGC，老年代的堆占有率达到参数 <code>-XX:InitiatingHeapOccupancyPercent</code> 设定的值则触发，回收所有的Young和部分Old(根据期望的GC停顿时间确定old区垃圾收集的优先顺序)以及大对象区，正常情况G1的垃圾收集是先做MixedGC，主要使用复制算法，需要把各个region中存活的对象拷贝到别的region里去，拷贝过程中如果发现没有足够的空region能够承载拷贝对象就会触发一次Full GC</p>\n</li>\n<li class=\"lvl-2\">\n<p>Full GC<br>\n停止系统程序，然后采用单线程进行标记、清理和压缩整理，好空闲出来一批Region来供下一次MixedGC使用，这个过程是非常耗时的。(Shenandoah优化成多线程收集了)</p>\n</li>\n</ul>\n<h4 id=\"G1-收集器的工作方式\">G1 收集器的工作方式</h4>\n<p><img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/XbkEoh.png\" alt=\"\" width=\"1200\" height=\"400\"></p>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>图中主要展示了一个典型的 G1 GC 的 并发标记周期（Concurrent Mark Cycle） 的过程。</p>\n</li>\n<li class=\"lvl-2\">\n<p>图中的水平箭头表示各线程（用户线程和GC线程）的执行路径。</p>\n</li>\n<li class=\"lvl-2\">\n<p>竖直的<code>Safepoint</code>线表示一次GC过程中会暂停所有用户线程的时刻（Stop-The-World）。</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1️⃣ 初始标记（Initial Mark）</span><br><span class=\"line\">    进入 Safepoint： 所有用户线程在此刻暂停（STW）。</span><br><span class=\"line\">    标记 GC Roots 直接可达对象。</span><br><span class=\"line\">    非常短暂，但属于 Stop-The-World 阶段。</span><br><span class=\"line\">    图中是“初始标记”箭头在 Safepoint 之后立刻执行。</span><br><span class=\"line\"></span><br><span class=\"line\">2️⃣ 并发标记（Concurrent Mark）</span><br><span class=\"line\">    用户线程 恢复运行（图中用户线程继续向右延伸）。</span><br><span class=\"line\">    GC 线程 并发进行标记工作（即在用户线程运行期间进行标记）。</span><br><span class=\"line\">    图中蓝色的“并发标记”箭头与用户线程箭头并行显示，表示并发执行。</span><br><span class=\"line\"></span><br><span class=\"line\">3️⃣ 最终标记（Remark / Final Mark）</span><br><span class=\"line\">    再次进入 Safepoint。</span><br><span class=\"line\">    重新暂停所有用户线程。</span><br><span class=\"line\">    处理并发标记阶段中遗漏的引用更新等信息，保证标记的准确性。</span><br><span class=\"line\"></span><br><span class=\"line\">4️⃣ 筛选回收（Cleanup / Filtered Collection）</span><br><span class=\"line\">    对已标记的对象做清理（回收不可达对象）。</span><br><span class=\"line\">    判断是否需要回收某些 Region。</span><br><span class=\"line\">    图中蓝色箭头标注为“筛选回收”。</span><br><span class=\"line\"></span><br><span class=\"line\">5️⃣ 恢复用户线程</span><br><span class=\"line\">    在最后一个 Safepoint 之后，所有用户线程重新开始执行（图中黄色箭头重新向右延伸）。</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>G1的GC 过程会经历多次<code>Safepoint</code>，但只有 <code>并发标记阶段</code> 是整个周期中最耗时但不会暂停用户线程(STW)的部分。</p>\n</li>\n</ul>\n<div class=\"tips\">\n<p><em><strong>Safepoint（安全点）</strong></em></p>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">在 JVM（Java 虚拟机）中，Safepoint（安全点） 是一个非常重要的概念，它代表 所有线程必须“安全地”暂停的某个时间点，以便 JVM 能够执行某些全局操作，比如：<br>\n垃圾回收（GC）<br>\n栈遍历（例如生成堆快照、做逃逸分析等）<br>\n类卸载<br>\nJIT 编译的一些重写操作等</li>\n<li class=\"lvl-2\">如果线程正在运行、改变堆中对象的数据，那么 GC 就无法准确标记和回收对象。因此 JVM 需要 让所有线程在一个“可控、安全的位置”上暂停，这个位置就叫 Safepoint。</li>\n<li class=\"lvl-2\">Safepoint 是怎么工作的？<br>\n1.JVM 发出“进入 Safepoint”的信号（比如要开始 GC）<br>\n2.所有线程收到信号后，必须等到“最近的 Safepoint”再停下来：<br>\nSafepoint 不是任意位置都可以停，它只出现在字节码中一些特定的指令点（比如方法调用、循环跳转等）<br>\n3.等所有线程都进入 Safepoint 后，JVM 才能开始执行 GC 等全局操作。</li>\n</ul>\n</div>\n<h5 id=\"G1-收集器参数配置表\">G1 收集器参数配置表</h5>\n<table>\n<thead>\n<tr>\n<th>参数名</th>\n<th>说明</th>\n<th>默认值</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>-XX:+UseG1GC</code></td>\n<td>使用 G1 垃圾收集器</td>\n<td>-</td>\n</tr>\n<tr>\n<td><code>-XX:ParallelGCThreads</code></td>\n<td>指定 GC 工作的线程数量</td>\n<td>与 CPU 数量相关</td>\n</tr>\n<tr>\n<td><code>-XX:G1HeapRegionSize</code></td>\n<td>设置堆分区大小（1MB~32MB，2 的幂），堆默认划分为 2048 个 Region</td>\n<td>自动计算</td>\n</tr>\n<tr>\n<td><code>-XX:MaxGCPauseMillis</code></td>\n<td>设置 GC 目标最大暂停时间</td>\n<td>200ms</td>\n</tr>\n<tr>\n<td><code>-XX:G1NewSizePercent</code></td>\n<td>新生代初始占比（占整个堆），实验性参数，-XX:+UnlockExperimentalVMOptions</td>\n<td>5%</td>\n</tr>\n<tr>\n<td><code>-XX:G1MaxNewSizePercent</code></td>\n<td>新生代最大占比（占整个堆），实验性参数，-XX:+UnlockExperimentalVMOptions</td>\n<td>60%</td>\n</tr>\n<tr>\n<td><code>-XX:TargetSurvivorRatio</code></td>\n<td>Survivor 区填充目标（超过该比例，晋升老年代）</td>\n<td>50%</td>\n</tr>\n<tr>\n<td><code>-XX:MaxTenuringThreshold</code></td>\n<td>最大对象年龄阈值（年龄超过将进入老年代）</td>\n<td>15</td>\n</tr>\n<tr>\n<td><code>-XX:InitiatingHeapOccupancyPercent</code></td>\n<td>整个堆的使用率超过该值触发 Mixed GC</td>\n<td>45%</td>\n</tr>\n<tr>\n<td><code>-XX:G1MixedGCLiveThresholdPercent</code></td>\n<td>Mixed GC 中：Region 存活对象占比低于该值才会被回收，实验性参数，-XX:+UnlockExperimentalVMOptions</td>\n<td>85%</td>\n</tr>\n<tr>\n<td><code>-XX:G1MixedGCCountTarget</code></td>\n<td>每次 Mixed GC 的最大回收轮次</td>\n<td>8</td>\n</tr>\n<tr>\n<td><code>-XX:G1HeapWastePercent</code></td>\n<td>Mixed GC 回收目标：空闲 Region 达堆总量该百分比就结束混合回收</td>\n<td>5%</td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"ZGC-垃圾回收器\">ZGC 垃圾回收器</h4>\n<p><img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/bBUAYt.png\" alt=\"\" width=\"700\" height=\"500\"></p>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ZGC(Z Garbage Collector)是一款JDK 11中新加入的具有实验性质的低延迟垃圾收集器，ZGC可以说源自于是Azul System公司开发的C4（Concurrent Continuously Compacting Collector） 收集器</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>Platform</th>\n<th>Supported</th>\n<th>Since</th>\n<th>Comment</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Linux/x64</td>\n<td>✅</td>\n<td>JDK 11</td>\n<td></td>\n</tr>\n<tr>\n<td>Linux/AArch64</td>\n<td>✅</td>\n<td>JDK 13</td>\n<td></td>\n</tr>\n<tr>\n<td>macOS</td>\n<td>✅</td>\n<td>JDK 14</td>\n<td></td>\n</tr>\n<tr>\n<td>Windows</td>\n<td>✅</td>\n<td>JDK 14</td>\n<td>Requires Windows version 1803 (Windows 10 or Windows Server 2019) or later.</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ZGC收集器是一款基于Region内存布局的，暂时不设分代的(jdk21后支持分代)，使用了<code>读屏障</code>、<code>颜色指针</code>等技术来实现可并发的标记-整理算法的，以低延迟为首要目标的一款垃圾收集器。</p>\n</li>\n</ul>\n<div class=\"tips\">\n<p><em><strong>颜色指针</strong></em></p>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">在 ZGC（Z Garbage Collector）中，颜色指针（Colored Pointer）是一种核心机制，把对象的 GC 状态信息直接嵌入到对象的引用（地址）中，用于在不增加对象额外元数据的前提下，跟踪对象在垃圾回收过程中的状态。</li>\n<li class=\"lvl-2\">在传统 GC 中，对象的“颜色”（如白色、灰色、黑色）表示其在 GC 不同阶段的状态，这些信息一般存储在额外的数据结构中（如记忆集合、位图等）。</li>\n<li class=\"lvl-2\">而在 ZGC 中，ZGC 将对象的这些状态信息编码进指针的高位中。所以一个对象引用（pointer）不仅仅是内存地址，还携带了对象在 GC 过程中的“颜色”信息。</li>\n<li class=\"lvl-2\">ZGC 主要运行在 64 位系统上，但当前的操作系统和 CPU 实际上只使用 48～57 位虚拟地址。ZGC 利用未使用的高位进行编码。<br>\n<img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/LD51Zb.png\" alt=\"\" width=\"900\" height=\"300\"></li>\n<li class=\"lvl-2\">每个对象有一个64位指针，这64位被分为：</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>位数</th>\n<th>名称</th>\n<th>含义</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>18 位</td>\n<td>预留</td>\n<td>保留位，未来可能用于扩展功能</td>\n</tr>\n<tr>\n<td>1 位</td>\n<td>Finalizable</td>\n<td>表示对象可终结（即实现了 <code>finalize()</code> 方法）</td>\n</tr>\n<tr>\n<td>1 位</td>\n<td>Remapped</td>\n<td>标识对象是否已被转移(用于标识某个引用是否已经被重定向（更新为新地址）)；为 1 表示该对象未在重定位集（Relocation Set）中，即新地址，为0表示旧地址</td>\n</tr>\n<tr>\n<td>1 位</td>\n<td>Marked1</td>\n<td>标记位之一，用于 GC 过程中的对象标记阶段 ,由于 ZGC 是并发 GC，需要两位来支持颜色切换机制（Color Flip），确保在不同 GC 周期中可以区分新旧标记，需要触发一次读取屏障（load barrier），找到对象的新位置，并更新这个引用。</td>\n</tr>\n<tr>\n<td>1 位</td>\n<td>Marked0</td>\n<td>另一个标记位，与 Marked1 配合用于 GC 标记阶段</td>\n</tr>\n<tr>\n<td>42 位</td>\n<td>对象地址部分</td>\n<td>实际的内存地址部分，最多可表示 2^42 字节（即 4 TB）,jdk15后占用 44位，支持 16TB</td>\n</tr>\n</tbody>\n</table>\n<p><em><strong>读屏障</strong></em></p>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">\n<p>ZGC（Z Garbage Collector）中的**读屏障（Read Barrier）是其核心机制之一，它保证了并发压缩（对象移动）**时程序的正确性，是实现低延迟、高并发垃圾回收的关键。</p>\n</li>\n<li class=\"lvl-2\">\n<p>在传统 GC 中，如果对象在 GC 过程中被移动，程序访问到的对象地址可能就无效了。因此，需要**“停世界”**将所有引用更新。</p>\n</li>\n<li class=\"lvl-2\">\n<p>而 ZGC 的设计目标是 &lt;10ms 的 GC 停顿时间，所以它采用 <code>并发标记 + 并发移动 + 并发引用更新</code> 的模式。在这种模式下，对象可以在程序运行时被移动，但程序访问时必须“知道”这个对象是否已经被移动，并获取其最新地址，这就是读屏障的职责。</p>\n</li>\n<li class=\"lvl-2\">\n<p>读屏障是一种在读取对象引用时自动插入的逻辑，用于检查引用是否有效，并在必要时进行修正（即地址重定向）。</p>\n</li>\n<li class=\"lvl-2\">\n<p>ZGC 是目前唯一在所有对象访问中都使用读屏障的 GC，它在每次对象指针解引用时都进行如下操作：</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>职责</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>检测引用是否是老地址</strong></td>\n<td>利用指针中的元信息（颜色指针，如 Remapped 位）判断引用是否已经被更新</td>\n</tr>\n<tr>\n<td><strong>如果未更新则重定向引用</strong></td>\n<td>如果引用的是旧地址，屏障会通过 forwarding table 找到新地址并更新</td>\n</tr>\n<tr>\n<td><strong>保证最终访问对象的地址正确</strong></td>\n<td>即使在对象移动过程中，程序也总能访问到有效地址，无需停顿所有线程</td>\n</tr>\n</tbody>\n</table>\n<pre>\n<code class=\"mermaid\">\ngraph TD\nA[程序访问对象引用&lt;br&#x2F;&gt;例如：Person p &#x3D; personField] --&gt; B[JVM 插入读屏障逻辑]\nB --&gt; C[读屏障检查颜色指针中的 Remapped 位]\nC --&gt; D{Remapped 位为 0 吗？}\nD -- 是 --&gt; E[检查对象是否已被移动]\nE --&gt; F[更新引用地址为新地址]\nF --&gt; G[设置 Remapped 位为 1]\nG --&gt; H[使用更新后的引用访问对象]\nD -- 否 --&gt; I[直接使用当前引用访问对象]\n</code>\n</pre>\n</div>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ZGC的Region可以具有大、中、小三类容量：</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">小型Region（Small Region） ： 容量固定为2MB，用于放置小于256KB的小对象。</li>\n<li class=\"lvl-6\">中型Region（Medium Region） ： 容量固定为32MB，用于放置大于等于256KB但小于4MB的对象。</li>\n<li class=\"lvl-6\">大型Region（Large Region） ： 容量不固定，可以动态变化，但必须为2MB的整数倍，用于放置4MB或以上的大对象。</li>\n</ul>\n<blockquote>\n<p>每个大型Region中只会存放一个大对象，这也预示着虽然名字叫作“大型Region”，但它的实际容量完全有可能小于中型Region，最小容量可低至4MB。</p>\n</blockquote>\n</li>\n<li class=\"lvl-2\">\n<p>ZGC 特点：</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">支持极大堆（JDK 15 起支持最高 16TB）</li>\n<li class=\"lvl-6\">GC 停顿时间通常低于 1ms（与堆大小基本无关）</li>\n<li class=\"lvl-6\">适合低延迟、高吞吐、高可用的应用场景，如交易系统、广告推荐等</li>\n</ul>\n</li>\n</ul>\n<h5 id=\"ZGC-收集器的工作方式\">ZGC 收集器的工作方式</h5>\n<p><img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/94yKcU.png\" alt=\"\"></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1️⃣ 并发标记（Concurrent Mark）：</span><br><span class=\"line\">   与G1一样，并发标记是遍历对象图做可达性分析的阶段，</span><br><span class=\"line\">   它的初始标记(Mark Start)和最终标记(Mark End)也会出现短暂的停顿，</span><br><span class=\"line\">   与G1不同的是，ZGC的标记是在指针上而不是在对象上进行的，</span><br><span class=\"line\">   标记阶段会更新染色指针中的 Marked 0、 Marked 1 标志位。</span><br><span class=\"line\"></span><br><span class=\"line\">2️⃣ 并发预备重分配（Concurrent Prepare <span class=\"keyword\">for</span> Relocate）：</span><br><span class=\"line\">   这个阶段需要根据特定的查询条件统计得出本次收集过程要清理哪些Region，将这些Region组成重分配集（Relocation Set）。</span><br><span class=\"line\">   ZGC每次回收都会扫描所有的Region，用范围更大的扫描成本换取省去G1中记忆集的维护成本。</span><br><span class=\"line\"></span><br><span class=\"line\">3️⃣ 并发重分配（Concurrent Relocate）：</span><br><span class=\"line\">   重分配是ZGC执行过程中的核心阶段，这个过程要把重分配集中的存活对象复制到新的Region上，</span><br><span class=\"line\">   并为重分配集中的每个Region维护一个转发表（Forward Table），记录从旧对象到新对象的转向关系。</span><br><span class=\"line\">   ZGC收集器能仅从引用上就明确得知一个对象是否处于重分配集之中，如果用户线程此时并发访问了位于重分配集中的对象，</span><br><span class=\"line\">   这次访问将会被预置的内存屏障(读屏障)所截获，然后立即根据Region上的转发表记录将访问转发到新复制的对象上，</span><br><span class=\"line\">   并同时修正更新该引用的值，使其直接指向新对象，ZGC将这种行为称为指针的“自愈”（Self-Healing）能力。</span><br><span class=\"line\"></span><br><span class=\"line\">4️⃣ 并发重映射（Concurrent Remap）：</span><br><span class=\"line\">   重映射所做的就是修正整个堆中指向重分配集中旧对象的所有引用，但是ZGC中对象引用存在“自愈”功能，所以这个重映射操作并不是很迫切。</span><br><span class=\"line\">   ZGC很巧妙地把并发重映射阶段（Concurrent Remap）要做的工作，合并到了下一次垃圾收集循环中的并发标记阶段（Concurrent Mark）里去完成，</span><br><span class=\"line\">   反正它们都是要遍历所有对象的，这样合并就节省了一次遍历对象图的开销。</span><br><span class=\"line\">   一旦所有指针都被修正之后， 原来记录新旧对象关系的转发表就可以释放掉了。</span><br></pre></td></tr></table></figure>\n<h5 id=\"ZGC存在的问题\">ZGC存在的问题</h5>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ZGC最大的问题是<code>浮动垃圾</code>。ZGC的停顿时间是在10ms以下，但是ZGC的执行时间还是远远大于这个时间的。假如ZGC全过程需要执行10分钟，在这个期间由于对象分配速率很高，将创建大量的新对象，这些对象很难进入当次GC，所以只能在下次GC的时候进行回收，这些只能等到下次GC才能回收的对象就是浮动垃圾。</p>\n</li>\n<li class=\"lvl-2\">\n<p>ZGC没有分代概念，每次都需要进行全堆扫描，导致一些“朝生夕死”的对象没能及时的被回收。</p>\n</li>\n<li class=\"lvl-2\">\n<p>目前唯一的办法是增大堆的容量，使得程序得到更多的喘息时间，但是这个也是一个治标不治本的方案。如果需要从根本上解决这个问题，还是需要引入分代收集，让新生对象都在一个专门的区域中创建，然后专门针对这个区域进行更频繁、更快的收集。</p>\n</li>\n<li class=\"lvl-2\">\n<p>JDK21正式引入了分代（jdk17是预览版），可以在生产环境中使用，需要手动开启：<code>-XX:+ZGenerational</code></p>\n</li>\n</ul>\n<h5 id=\"ZGC-收集器参数配置表\">ZGC 收集器参数配置表</h5>\n<table>\n<thead>\n<tr>\n<th>参数名</th>\n<th>说明</th>\n<th>默认值（如未特殊标注）</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>-XX:+UseZGC</code></td>\n<td>启用 ZGC 垃圾收集器</td>\n<td>-</td>\n</tr>\n<tr>\n<td><code>-XX:+UnlockExperimentalVMOptions</code></td>\n<td>解锁实验性参数（JDK 11~14 使用 ZGC 必须）</td>\n<td>-</td>\n</tr>\n<tr>\n<td><code>-XX:+UseLargePages</code></td>\n<td>启用大页内存（性能优化）</td>\n<td>false</td>\n</tr>\n<tr>\n<td><code>-XX:+UseTransparentHugePages</code></td>\n<td>启用透明大页（部分 Linux 上可结合使用）</td>\n<td>false</td>\n</tr>\n<tr>\n<td><code>-Xmx</code> / <code>-Xms</code></td>\n<td>设置最大/初始堆大小</td>\n<td>用户配置</td>\n</tr>\n<tr>\n<td><code>-XX:ZUncommitDelay=&lt;秒&gt;</code></td>\n<td>未使用内存释放回操作系统的延迟时间（ZGC 会自动释放内存）</td>\n<td>300（5分钟）</td>\n</tr>\n<tr>\n<td><code>-XX:SoftMaxHeapSize=&lt;大小&gt;</code></td>\n<td>软最大堆（Soft Heap Limit）：ZGC 尝试将使用的堆控制在该值以内</td>\n<td>默认等于 -Xmx</td>\n</tr>\n<tr>\n<td><code>-XX:MaxHeapFreeRatio</code></td>\n<td>最大堆空闲比例（超过此比例可能触发内存释放）</td>\n<td>70</td>\n</tr>\n<tr>\n<td><code>-XX:MinHeapFreeRatio</code></td>\n<td>最小堆空闲比例（低于此比例可能触发扩容）</td>\n<td>40</td>\n</tr>\n<tr>\n<td><code>-XX:+ZGenerational</code></td>\n<td>启用 ZGC 分代收集（从 JDK 21 起支持，默认关闭）</td>\n<td>false（JDK 21+）</td>\n</tr>\n<tr>\n<td><code>-XX:+PrintGC</code> / <code>-Xlog:gc*</code></td>\n<td>开启 GC 日志输出</td>\n<td>-</td>\n</tr>\n<tr>\n<td><code>-XX:+ZProactive</code></td>\n<td>主动回收策略（在系统空闲时尝试回收）</td>\n<td>true</td>\n</tr>\n<tr>\n<td><code>-XX:ZCollectionInterval=&lt;秒&gt;</code></td>\n<td>主动回收之间的最小时间间隔（配合 ZProactive）</td>\n<td>默认值因版本而异</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"ZGC-vs-G1-GC-vs-Parallel-GC-对比表\">ZGC vs G1 GC vs Parallel GC 对比表</h3>\n<table>\n<thead>\n<tr>\n<th>特性</th>\n<th><strong>ZGC</strong></th>\n<th><strong>G1 GC</strong></th>\n<th><strong>Parallel GC</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>设计目标</strong></td>\n<td><strong>极低延迟</strong>，&lt;1ms 停顿</td>\n<td>平衡 <strong>低延迟</strong> 与 <strong>高吞吐</strong></td>\n<td><strong>高吞吐</strong>，最大化 CPU 使用</td>\n</tr>\n<tr>\n<td><strong>GC 停顿时间</strong></td>\n<td>&lt;1ms，堆大小增加不影响停顿时间</td>\n<td>几十到几百毫秒，堆越大停顿越明显</td>\n<td>停顿时间可能达到秒级，<strong>堆越大越明显</strong></td>\n</tr>\n<tr>\n<td><strong>堆大小支持</strong></td>\n<td>支持高达 <strong>16TB</strong>（JDK 15+）</td>\n<td>支持 <strong>最多 4TB</strong></td>\n<td>支持大堆，但停顿明显</td>\n</tr>\n<tr>\n<td><strong>是否分代</strong></td>\n<td>默认不分代（JDK 21+ 可开启 <code>-XX:+ZGenerational</code>）</td>\n<td>分代（新生代 + 老年代）</td>\n<td>分代（新生代 + 老年代）</td>\n</tr>\n<tr>\n<td><strong>并发回收</strong></td>\n<td>是，<strong>包括标记、压缩、引用处理都并发</strong></td>\n<td>部分并发，仍包含明显 Stop-The-World 阶段</td>\n<td>否，<strong>全部 Stop-The-World</strong></td>\n</tr>\n<tr>\n<td><strong>移动对象时是否停顿</strong></td>\n<td>否，使用读屏障并发转移对象</td>\n<td>是（通过复制区域）</td>\n<td>是</td>\n</tr>\n<tr>\n<td><strong>实现机制</strong></td>\n<td>标记-重定位，基于读屏障</td>\n<td>Region 分区 + 标记-复制 + Mixed GC</td>\n<td>标记-复制（新生代）、标记-整理（老年代）</td>\n</tr>\n<tr>\n<td><strong>吞吐能力</strong></td>\n<td>中高</td>\n<td>高</td>\n<td><strong>最高</strong></td>\n</tr>\n<tr>\n<td><strong>适用场景</strong></td>\n<td>低延迟系统，如金融、交易、推荐等实时应用</td>\n<td>通用后台系统、Web 服务等</td>\n<td>批处理、数据计算、日志分析等不敏感于停顿的系统</td>\n</tr>\n<tr>\n<td><strong>默认启用</strong></td>\n<td>否，需指定 <code>-XX:+UseZGC</code></td>\n<td>JDK 9+ 默认 GC</td>\n<td>JDK 8 及以前默认 GC</td>\n</tr>\n<tr>\n<td><strong>调优复杂度</strong></td>\n<td>低，大多数参数可省略</td>\n<td>中，需要设置目标停顿时间等</td>\n<td>高，需要精细配置 Eden/Survivor 等比例</td>\n</tr>\n<tr>\n<td><strong>GC 日志配置方式</strong></td>\n<td>统一日志格式：<code>-Xlog:gc*</code>（JDK 9+）</td>\n<td>支持传统的 <code>-XX:+PrintGCDetails</code> 和 <code>-Xlog:gc*</code> 日志输出</td>\n<td>主要使用旧参数：<code>-XX:+PrintGCDetails</code> 等</td>\n</tr>\n</tbody>\n</table>\n<div class=\"tips\">\n<p><em><strong>ZGC 吞吐能力较弱的原因</strong></em></p>\n<table>\n<thead>\n<tr>\n<th>原因</th>\n<th>解释</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>1. 并发阶段代价较高</strong></td>\n<td>ZGC 几乎所有的 GC 工作（包括标记、整理、引用处理、转移对象）都在与应用线程并发执行。虽然减少了停顿，但这些 GC 线程与业务线程共享 CPU 资源，<strong>增加了 CPU 上下文切换和缓存竞争</strong>，从而影响业务线程的执行效率。</td>\n</tr>\n<tr>\n<td><strong>2. 读屏障开销</strong></td>\n<td>ZGC 依赖<strong>着色指针和读屏障（load barrier）机制</strong>来跟踪对象引用状态，支持并发转移。虽然非常高效，但仍比传统 GC 的普通读写路径慢一些，在高频访问对象场景下会带来一定 CPU 开销。</td>\n</tr>\n<tr>\n<td><strong>3. 对硬件依赖高，调度保守</strong></td>\n<td>为了实现“&lt;1ms 停顿”的目标，ZGC 会选择更保守的调度策略（如避免并发线程使用过多 CPU），而不会像 Parallel GC 那样“榨干”所有核心资源。</td>\n</tr>\n<tr>\n<td><strong>4. 内存开销更高</strong></td>\n<td>为了支持并发压缩和转移，ZGC 通常需要为每个对象保留元数据和更多的转移空间（即“浮动垃圾”区域），这可能导致<strong>频繁的 GC 周期</strong>，影响吞吐。</td>\n</tr>\n<tr>\n<td><strong>5. 设计目标非吞吐优先</strong></td>\n<td>ZGC 的首要目标是<strong>低延迟而非最大吞吐</strong>。与 Parallel GC（以吞吐为核心）设计目标不同，ZGC 更适合场景为“对延迟敏感但吞吐可接受”的系统。</td>\n</tr>\n</tbody>\n</table>\n<p>最糟糕的情况下吞吐量会降低15%。这都不是事，停顿时间足够优秀。至于吞吐量，通过扩容分分钟解决。<br>\n另外，Oracle官方提到了它最大的优点是：它的停顿时间不会随着堆的增大而增长！<br>\n也就是说，几十G堆的停顿时间是10ms以下，几百G甚至上T堆的停顿时间也是10ms以下。</p>\n<p>ZGC 吞吐弱，不是因为技术落后，而是因为它主动选择在低延迟和高吞吐之间偏向了低延迟。<br>\n在对响应时间要求极高的系统中，它是非常合适的选择。<br>\n但如果你的目标是压榨机器性能跑批处理、日志分析这类吞吐导向型任务，Parallel GC 或 G1 会更合适。</p>\n</div>\n<h2 id=\"内存溢出-OutOfMemoryError，简称-OOM\">内存溢出(OutOfMemoryError，简称 OOM)</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>JVM 常见内存溢出类型汇总表</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>溢出类型</th>\n<th>异常信息</th>\n<th>触发原因/描述</th>\n<th>相关参数和建议配置</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>堆内存溢出</strong></td>\n<td><code>java.lang.OutOfMemoryError: Java heap space</code></td>\n<td>- 创建大量对象，堆空间不足<br>- 内存泄漏：对象不再使用却有强引用<br>- 老年代对象太多无法晋升</td>\n<td><code>-Xms</code> / <code>-Xmx</code> 设置堆大小</td>\n</tr>\n<tr>\n<td><strong>栈溢出（递归）</strong></td>\n<td><code>java.lang.StackOverflowError</code></td>\n<td>- 方法无限递归或递归层级太深</td>\n<td><code>-Xss</code> 设置线程栈大小</td>\n</tr>\n<tr>\n<td><strong>无法创建新线程</strong></td>\n<td><code>java.lang.OutOfMemoryError: unable to create new native thread</code></td>\n<td>- 创建线程过多（如线程池配置过大）<br>- 系统或 JVM native 线程资源耗尽</td>\n<td>控制线程池大小，避免无限新建线程</td>\n</tr>\n<tr>\n<td><strong>元空间溢出</strong></td>\n<td><code>java.lang.OutOfMemoryError: Metaspace</code></td>\n<td>- 动态加载类过多（如使用 CGLIB、JSP 动态生成类）<br>- 类无法卸载（如 ClassLoader 泄漏）</td>\n<td><code>-XX:MetaspaceSize</code> / <code>-XX:MaxMetaspaceSize</code></td>\n</tr>\n<tr>\n<td><strong>直接内存溢出</strong></td>\n<td><code>java.lang.OutOfMemoryError: Direct buffer memory</code></td>\n<td>- 使用 <code>ByteBuffer.allocateDirect()</code> 分配大量直接内存<br>- Netty 等框架默认使用直接内存</td>\n<td><code>-XX:MaxDirectMemorySize</code></td>\n</tr>\n<tr>\n<td><strong>GC 开销过高</strong></td>\n<td><code>java.lang.OutOfMemoryError: GC overhead limit exceeded</code></td>\n<td>- JVM 花费 &gt;98% 的时间 GC 但回收 &lt;2% 的内存，认为进入“GC 死循环”</td>\n<td>分析 GC 日志、优化堆设置</td>\n</tr>\n<tr>\n<td><strong>类卸载失败（内存泄漏）</strong></td>\n<td>（不一定报错，但可能导致 Metaspace OOM）</td>\n<td>- Web 容器频繁部署热更新 WAR 包时，ClassLoader 无法卸载，导致类永久驻留</td>\n<td>优化 ClassLoader 管理，使用内存分析工具</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>堆快照(堆转储)文件分析</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>参数</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>-XX:+HeapDumpOnOutOfMemoryError</code></td>\n<td>OOM 时生成堆转储文件 ,建议生产环境开启</td>\n</tr>\n<tr>\n<td><code>-XX:HeapDumpPath=xxx.hprof</code></td>\n<td>指定堆转储文件保存路径 <br> 默认保存在当前目录</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>常用分析工具与命令</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>工具/命令</th>\n<th>简介与功能</th>\n<th>使用说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>MAT（Memory Analyzer Tool）</strong></td>\n<td>Eclipse 出品的强大图形工具，支持泄漏分析、对象引用链分析、内存占用统计等</td>\n<td>下载地址：<br><a href=\"https://www.eclipse.org/mat/\">https://www.eclipse.org/mat/</a><br>打开后直接导入 <code>.hprof</code> 文件即可分析</td>\n</tr>\n<tr>\n<td><strong>VisualVM</strong></td>\n<td>官方可视化 JVM 监控工具，支持实时分析、GC 查看、线程状态与堆转储查看</td>\n<td>附带于 JDK（或单独安装），打开 <code>.hprof</code> 文件进行可视化分析</td>\n</tr>\n<tr>\n<td><strong>JProfiler</strong></td>\n<td>商业级 Java 性能分析工具，提供堆分析、CPU 分析、线程分析等全套功能</td>\n<td>支持打开 <code>.hprof</code> 文件，也可在运行时配合使用（需付费或试用）</td>\n</tr>\n<tr>\n<td><strong>YourKit</strong></td>\n<td>商业性能分析工具，界面友好，支持丰富的分析功能</td>\n<td>支持堆分析，适合内存泄漏排查</td>\n</tr>\n<tr>\n<td><strong>jhat</strong>（过时）</td>\n<td>JDK 附带的旧工具，用于分析 <code>.hprof</code> 文件，开启 Web 界面查看（已废弃）</td>\n<td>命令：<code>jhat heapdump.hprof</code>，浏览器访问 <code>http://localhost:7000</code>（JDK 8 及以下）</td>\n</tr>\n<tr>\n<td><strong>jmap</strong></td>\n<td>用于生成堆转储文件或查看堆对象统计信息（<strong>不是分析工具本身</strong>）</td>\n<td>命令：<code>jmap -dump:format=b,file=heap.hprof &lt;pid&gt;</code> 生成转储；配合 MAT 使用</td>\n</tr>\n<tr>\n<td><strong>jcmd</strong></td>\n<td>更现代的诊断命令工具，可生成 heap dump、执行 GC、打印 VM 状态等</td>\n<td>命令：<code>jcmd &lt;pid&gt; GC.heap_dump heap.hprof</code></td>\n</tr>\n<tr>\n<td><strong><a href=\"http://GCEasy.io\">GCEasy.io</a></strong></td>\n<td>在线分析工具，支持 <code>.hprof</code> 文件和 GC 日志上传分析</td>\n<td>网站：<a href=\"https://gceasy.io\">https://gceasy.io</a></td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>GC日志相关参数(JDK1.8及以下)</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>参数</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>-XX:+PrintGC</code></td>\n<td>打印基本 GC 信息（建议配合 <code>-XX:+PrintGCDetails</code> 使用）</td>\n</tr>\n<tr>\n<td><code>-XX:+PrintGCDetails</code></td>\n<td>打印详细的 GC 日志信息（如各区域使用情况、对象分配、晋升等）</td>\n</tr>\n<tr>\n<td><code>-XX:+PrintGCDateStamps</code></td>\n<td>在 GC 日志中添加日期时间戳</td>\n</tr>\n<tr>\n<td><code>-XX:+PrintGCTimeStamps</code></td>\n<td>在 GC 日志中添加 JVM 启动以来的时间戳</td>\n</tr>\n<tr>\n<td><code>-Xloggc:/var/log/myapp/gc.log</code></td>\n<td>将 GC 日志输出到指定文件</td>\n</tr>\n<tr>\n<td><code>-XX:+UseGCLogFileRotation</code></td>\n<td>启用 GC 日志文件轮转（适用于大规模系统的 GC 日志管理）</td>\n</tr>\n<tr>\n<td><code>-XX:NumberOfGCLogFiles=5</code></td>\n<td>最多保留 5 个 GC 日志历史文件</td>\n</tr>\n<tr>\n<td><code>-XX:GCLogFileSize=10M</code></td>\n<td>每个 GC 日志文件最大为 10MB</td>\n</tr>\n<tr>\n<td><code>-XX:+PrintGCCause</code></td>\n<td>打印 GC 的触发原因（如 Minor GC、System.gc() 等）</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>GC日志相关参数(JDK9+)</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-Xlog:gc*:file=/var/log/app/gc.log:time,<span class=\"built_in\">uptime</span>,level,tags:filecount=5,filesize=20M</span><br></pre></td></tr></table></figure>\n<table>\n<thead>\n<tr>\n<th>部分</th>\n<th>含义</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>gc*</code></td>\n<td>日志类别</td>\n<td>表示记录所有 GC 相关日志（如 gc、gc+start、gc+heap 等）。<code>*</code> 是通配符。</td>\n</tr>\n<tr>\n<td><code>file=/var/log/app/gc.log</code></td>\n<td>输出路径</td>\n<td>将 GC 日志输出到指定路径，而不是控制台。可以是相对或绝对路径。</td>\n</tr>\n<tr>\n<td><code>time</code></td>\n<td>日志时间戳</td>\n<td>添加格式化时间（如 2025-05-12T10:21:33.123+0800）。便于定位具体时间。</td>\n</tr>\n<tr>\n<td><code>uptime</code></td>\n<td>JVM 启动以来的时间戳</td>\n<td>显示 GC 发生时距离 JVM 启动的毫秒数（例如 <code>3.254s</code>）。有助于调试启动期间的问题。</td>\n</tr>\n<tr>\n<td><code>level</code></td>\n<td>日志级别</td>\n<td>显示日志级别（info、debug、warning 等），默认 info。</td>\n</tr>\n<tr>\n<td><code>tags</code></td>\n<td>日志标签</td>\n<td>显示日志的模块标签，如 <code>[gc,start]</code>，帮助快速定位类别。</td>\n</tr>\n<tr>\n<td><code>filecount=5</code></td>\n<td>文件轮转个数</td>\n<td>最多保留 5 个日志文件（当前日志 + 4 个历史）。</td>\n</tr>\n<tr>\n<td><code>filesize=20M</code></td>\n<td>单文件最大大小</td>\n<td>每个日志文件最大 20MB，超出时自动滚动到下一个文件。</td>\n</tr>\n</tbody>\n</table>\n","content_text":"摘要 本文介绍JVM的内存模型与垃圾回收机制 The Java® Virtual Machine Specification 版本jdk1.8 JVM虚拟机结构(HotSpot) 设置内存分配示例 1234# jdk1.8+java ‐Xms2048M ‐Xmx2048M ‐Xmn1024M ‐Xss512K ‐XX:MetaspaceSize=256M ‐XX:MaxMetaspaceSize=256M ‐jar server.jar# jdk1.6/1.7java ‐Xms2048M ‐Xmx2048M ‐Xmn1024M ‐Xss512K ‐XX:PermSize=256M ‐XX:MaxPermSize=256M ‐jar server.jar 各参数含义与默认值（针对 JDK 1.8） 参数 含义说明 默认值（JDK 1.8） -Xms2048M 初始堆大小，即 JVM 启动时分配的堆内存大小（这里是 2GB） 物理内存的 1/64（最小 1MB），推荐配置为与 -Xmx 一致 -Xmx2048M 最大堆内存大小，JVM 允许分配的最大堆内存 物理内存的 1/4（受限于 32位/64位） -Xmn1024M 新生代大小（Eden + Survivor）为 1GB 未显式指定时，通常占堆的 1/3 左右 -Xss512K 每个线程的栈大小（Thread Stack Size），这里设置为 512KB 1MB（64位系统）或 512KB（32位系统） -XX:MetaspaceSize=256M 元空间初始大小（用于加载类的元数据，不再使用 PermGen） 21MB（客户端）或 16MB（服务器端）,推荐配置为与 MaxMetaspaceSize 一致 -XX:MaxMetaspaceSize=256M 元空间最大大小，超过后触发 Full GC 无限制（默认只受物理内存约束） ，推荐配置一个合适的数值，比如8G的内存可以配置为256M 类装载子系统（Class Loading Subsystem） 类装载子系统负责将 .class 文件加载到 JVM 中，并进行解析、验证、初始化等过程。 加载过程的几个阶段： 阶段 说明 加载（Loading） 将 .class 文件读取为二进制数据，构造 Class 对象 验证（Verification） 确保字节码文件格式正确、安全合法（防止恶意代码） 准备（Preparation） 为类的静态变量分配内存，并设置默认初始值 解析（Resolution） 将常量池中的符号引用替换为直接引用（方法、字段等） 初始化（Initialization） 执行 &lt;clinit&gt; 静态初始化方法，对静态变量赋初始值 类加载器（ClassLoader）体系结构：详细参考 JVM 之 类加载器 类加载器名称 加载内容 说明 引导类加载器（Bootstrap ClassLoader） Java 核心类库（如 java.lang.*） 由 JVM 自身实现，用本地代码实现，无法直接访问 扩展类加载器（Extension ClassLoader） JAVA_HOME/jre/lib/ext 目录下的类 加载标准扩展类库 应用类加载器（Application ClassLoader） 用户应用类路径（CLASSPATH 指定的目录） 最常用，加载大多数应用代码 自定义类加载器（Custom ClassLoader） 用户手动实现的类加载器 可以打破双亲委派机制，实现热加载、加密类加载等 类加载采用 双亲委派模型：请求会先向父加载器委托，只有在父加载器加载失败时才尝试自身加载。 字节码执行引擎（Execution Engine） 字节码执行引擎负责将 Java 字节码解释或编译为机器代码，并在底层平台上执行。 执行引擎的核心模块 组件名称 作用说明 关键特性 解释器（Interpreter） 将字节码逐条解释执行 启动快，适合冷代码（非热点代码），执行效率相对较低 即时编译器（JIT Compiler） 将热点代码编译为本地机器码，提高执行效率 包含 C1（Client）和 C2（Server）两种，支持优化如：方法内联、逃逸分析、循环展开等 垃圾收集器（Garbage Collector, GC） 自动内存管理，负责对象生命周期的回收 常见算法包括：Serial、Parallel、CMS、G1、ZGC（低延迟）等，根据不同场景选择 本地接口（Native Interface） 支持 Java 与本地语言（如 C/C++）的互操作 通过 JNI（Java Native Interface）实现，调用底层操作系统或第三方库功能 JVM 内存模型（Java Memory Model，JMM） JMM 是 Java 虚拟机规范中定义的一种 抽象内存模型，它决定了多线程程序中变量的读写可见性、有序性和原子性。同时，JVM 在物理层也有一个实际的内存结构，称为运行时数据区域（Runtime Data Areas），这两个可以结合理解。 JMM 的主要目标 保证多线程环境下的数据一致性 指导 JVM 和 CPU 的内存交互行为（如重排序、缓存） 实际运行时内存结构如下： 内存区域 说明 📌 程序计数器（PC） 每个线程私有，记录当前执行的字节码指令地址 📌 Java 线程栈 每个线程私有，方法调用时用于存储局部变量、操作数栈等 📌 本地方法栈 与虚拟机栈类似，用于 native 方法 📌 堆（Heap） 所有线程共享，存储对象实例、数组等，GC 的主要区域 📌 方法区（或元空间） 所有线程共享，存储类信息、静态变量、常量池等（JDK8 后称为 Metaspace） 垃圾回收器 垃圾回收器负责自动管理内存，回收不再使用的对象，避免内存泄漏和溢出。 什么是垃圾 内存中没有被（线程栈变量，静态变量，常量池，JNI指针）引用的地址就是垃圾 可达性分析算法：是现代 JVM 判断一个对象是否“还活着”的主要算法。 1234基本思想：从一组称为 “GC Roots” 的对象出发，沿着对象之间的引用链向下搜索。如果某个对象 可以从 GC Roots 追踪到，就认为它是 “可达” 的（Alive）。否则就认为是 “不可达” 的（Garbage），可以被回收。 在 JVM 中，GC Roots 是一些 始终可用的、不会被垃圾回收的引用起点，主要包括： GC Roots 来源 说明 当前线程栈中的引用（局部变量表） 各个线程正在调用的方法中的局部变量、参数等 静态字段引用 类的静态字段引用的对象 JNI 引用（Native 方法引用） Java 本地方法中引用的对象 常量引用池中的对象 字符串常量等可能持有对象引用 活动线程对象 线程自身在 GC 时不会被回收 JVM 内部结构（如系统类加载器等） JVM 关键系统对象 垃圾回收器种类： 左边6种叫分代模型，右边的4种叫分区模型 分代模型（Generational Model） 堆内存划分为： 年轻代（Young Generation）：存放新创建的对象，分为 Eden 和 Survivor 区。 老年代（Old Generation）：存放经过多次 GC 后仍然存活的对象。 分区模型（Region-based Model） 分区模型（如 G1、ZGC、Shenandoah）不再严格按照代划分内存，而是把堆划分为多个 大小相同的 Region。每个 Region 可以在运行时被动态标记为 Eden、Survivor 或 Old。 分代模型中，上面3个是新生代垃圾回收器，下面3个是老年代垃圾回收器，可以交叉配对（见上图虚线），但最常用是上下两两配对。 CMS即可以作为新生代垃圾回收器，也可以作为老年代垃圾回收器。 EpsilonGC，是一个特殊的垃圾回收器，它不回收任何对象，只负责最终记录，做测试用的。 目前最先进的模型是 ZGC，jkd11开始支持，但直到JDK16才比较完善，目前非默认配置，需要手动配置。其与Redhat出品的 Shenandoah 是竞争关系。 常见垃圾回收器及其分类、JDK版本 垃圾回收器 所属模型 说明 首次出现 JDK 版本 启用命令（JVM 参数） 适合的堆内存大小 Serial 分代模型 单线程，新生代和老年代都使用 Serial，适用于小堆内存 JDK 1.2 -XX:+UseSerialGC 💾 小于 1GB ParNew 分代模型 Serial 的多线程版本，仅用于 CMS 新生代 JDK 1.4 -XX:+UseParNewGC -XX:+UseConcMarkSweepGC 💾 1GB ~ 4GB Parallel（吞吐量 GC） 分代模型 多线程 GC，适合吞吐量优先的应用场景 JDK 1.4 -XX:+UseParallelGC（新生代）-XX:+UseParallelOldGC（老年代） 💾 2GB ~ 8GB CMS（Concurrent Mark Sweep） 分代模型 老年代并发标记-清除，低延迟，但存在碎片，已弃用 JDK 1.4 -XX:+UseConcMarkSweepGC 💾 2GB ~ 8GB（已过时） G1（Garbage First） 分区模型 将堆划分为 Region，逻辑分代，支持并发压缩，平衡延迟与吞吐 JDK 7u4（正式） -XX:+UseG1GC 💾 4GB ~ 数十 GB ZGC（Z Garbage Collector） 分区模型 Region 弹性大小，支持超大堆，低延迟（&lt;10ms 停顿） JDK 11（实验），JDK 15（正式） -XX:+UseZGC 💾 8GB ~ 数 TB（超大堆） Shenandoah 分区模型 红帽主导，低延迟，并发回收与并发压缩 JDK 12（实验），JDK 15（正式） -XX:+UseShenandoahGC 💾 2GB ~ 数十 GB 对于 CMS，启用后会自动使用 ParNew 作为新生代回收器（除非显式禁止）。 CMS 已在 JDK 9 开始标记为弃用，JDK 14 完全移除，不推荐再使用。 对于 Parallel GC 启用 -XX:+UseParallelGC（新生代）会自动启用 -XX:+UseParallelOldGC（老年代）。 对于ZGC，jdk15以前最大支持4T内存，之后最大支持16T内存。 各版本默认垃圾回收器及推荐配置（JDK 1.6 起） JDK 版本 默认 GC 建议使用 GC（按场景分类） JDK 1.6 Serial / Parallel - 小型应用（如桌面程序）：-XX:+UseSerialGC - 中大型应用（吞吐量优先）：-XX:+UseParallelGC JDK 1.7 同上 同 JDK 1.6 JDK 1.8 Parallel - 吞吐优先：默认 -XX:+UseParallelGC - 响应优先：-XX:+UseConcMarkSweepGC（CMS） - 大堆 + 未来升级考虑：-XX:+UseG1GC（推荐） JDK 9-14 G1 GC - 一般默认即可：-XX:+UseG1GC（延迟与吞吐平衡） - 极端低延迟要求：升级到 JDK 11+ 使用 ZGC/Shenandoah JDK 15+ G1 GC（默认），ZGC / Shenandoah 可选 - 延迟敏感（在线服务、RT系统）：-XX:+UseZGC 或 -XX:+UseShenandoahGC - 吞吐为主：-XX:+UseParallelGC - 综合平衡：-XX:+UseG1GC（默认） 判断默认 GC 的方式 1java -XX:+PrintCommandLineFlags -version 垃圾回收算法 JVM 中常见垃圾回收算法汇总 算法名称 核心思想 适用阶段/区域 优缺点简述 标记-清除（Mark-Sweep） 标记出存活对象，清除未标记对象 老年代 简单高效，但会产生大量碎片，不适合连续内存分配 标记-整理（Mark-Compact） 标记后移动存活对象，整理碎片 老年代 消除碎片，代价是移动对象，适用于老年代压缩 复制算法（Copying） 将对象复制到另一块内存（如 Eden → Survivor） 新生代 高效率，适合回收大多数对象短命的新生代，但需要额外空间 分代回收（Generational） 将对象按生命周期划分（新生代/老年代） 整个堆结构 实用性强，结合不同算法应用于不同代，现代 GC 基础 分区回收（Region-based） 将堆划分为若干等大小的 Region 动态分配 整个堆（如 G1、ZGC） 更灵活，支持并发并行，减少 STW 停顿，适用于大堆、低延迟场景 增量回收（Incremental） 分阶段小步执行 GC 以减少单次停顿 某些并发/低延迟 GC 减少暂停时间，但整体效率可能降低 并发回收（Concurrent） 标记、清理等步骤与应用线程并发执行 CMS、G1、ZGC 等 停顿时间短，对响应时间要求高的系统友好 三色标记（Tri-color Marking） 并发标记算法的一种实现思想 CMS、G1、ZGC 等 白（待回收）、灰（已标记未扫描）、黑（已标记已扫描），避免“漏标”问题 SATB（Snapshot-At-The-Beginning） 并发标记的快照策略 G1、ZGC 保证在并发标记过程中不遗漏新引用，适合高并发场景 Lazy Compaction（延迟压缩） 不每次 GC 都压缩，视情况而定 G1 等 降低不必要的移动成本 对应关系：GC 回收器和底层算法 回收器 使用的算法组合 Serial 新生代：复制算法老年代：标记-整理 ParNew 新生代：复制算法（多线程） Parallel 新生代：复制算法老年代：标记-整理 CMS 新生代：ParNew（复制）老年代：标记-清除 + 三色标记 + 并发 G1 分区回收 + 三色标记 + SATB + Lazy Compaction ZGC 分区回收 + 并发标记 + SATB + Region Remapping Shenandoah 分区回收 + 并发标记 + 并发压缩 + 三色标记 1234567891011 ┌────────────────────────┐ │ 常见 GC 算法分类 │ └────────────────────────┘ │ ┌─────────────┴──────────────┐ │ │分代模型 分区模型 │ │ ┌─┴─────┐ ┌───┴─────┐复制 标记-清除 Region-based 并发 标记-整理 SATB / 三色标记 什么是 STW（Stop-The-World） STW（Stop-The-World） 指的是：在某些垃圾回收阶段，JVM 会暂停所有应用线程（也叫用户线程），让垃圾回收线程独占 CPU 执行 GC 逻辑。 你可以这样理解 STW JVM 会“按下暂停键”暂停所有正在运行的 Java 程序代码； 然后 专心进行 GC 的某些阶段（如标记、整理、复制等）； GC 完成后，才会“恢复运行”应用线程。 各 GC 中 STW 的存在情况 回收器 是否存在 STW？ 说明 Serial ✅ 是，全停顿，全阶段单线程 堆越大 STW 越长 Parallel ✅ 是，全停顿，多线程执行 GC 提高效率但仍会暂停 CMS ✅ 有，初始标记和最终重新标记是 STW 大部分阶段并发执行 G1 ✅ 有，但设计为尽可能缩短 STW 分阶段并发 + 并行处理 ZGC ✅ 极短（&lt;10ms） 仅个别阶段是 STW，几乎感知不到 Shenandoah ✅ 极短 高度并发，STW 时间也极短 为什么要关注 STW？ 在响应时间敏感型系统（如在线交易系统、游戏服务器、API 网关）中，长时间的 STW 会造成用户请求卡顿、超时。 因此，选择 低 STW 的 GC（如 G1、ZGC、Shenandoah） 对这类系统至关重要。 堆内存结构 不同的垃圾回收器决定了堆内存的结构不同，但总体上分为两种类型：分代模型和分区模型。 分代模型 Parallel 垃圾回收器 堆结构被划分为 Old Generation（老年代） 和 Young Generation（新生代） 两部分。 Young Generation 由 Eden 和 两个 Survivor 组成，其中 Eden 是一个连续的内存区域，Survivor 是一个非连续的内存区域。 默认情况下，Young Generation占堆内存的 1/3, Old Generation 占堆内存的 2/3。 默认情况下，Eden:S0:S1 = 8:1:1 ,如果希望为 4:1:1，使用 -XX:SurvivorRatio=4，但实际上这个比例并不是固定的，而是由jvm基于情况自动变化的，因为JVM默认开启了这个参数-XX:+UseAdaptiveSizePolicy，如果希望固定这个比例，可以设置为 -XX:-UseAdaptiveSizePolicy来关闭这个配置。 默认情况下，对象最多经历15次Minor GC后进入老年代，可以通过 -XX:MaxTenuringThreshold=n 设置。 区域 说明 Eden 对象首次创建的区域，大部分对象在这里创建并很快被回收 S0/S1 Survivor 区域：两个交替使用的缓冲区（From 和 To），用于拷贝存活对象 Old 老年代：存活次数多、生命周期长的对象会从新生代晋升到老年代，回收频率低 对象内存分配图解(简化) 12345678910111213创建对象 ↓进入 Eden 区（新生代） ↓ Eden 区满第一次 Minor GC（存活对象[Eden]复制到 S0） ↓ Eden 区满 或 S0 区满第二次 Minor GC（存活对象[Eden和S0]复制到 S1，年龄 +1） ↓ Eden 区满 或 S1 区满第三次 Minor GC（存活对象[Eden和S1]复制到 S0，年龄 +1） ↓…… S0/S1 交替，年龄达到阈值（如 15） ↓ 还没有被回收晋升到 Old 区（老年代），等待Old区满 触发 Full GC 大对象直接进入老年代 大对象就是需要大量连续内存空间的对象（比如：字符串、数组），如果对象很大（如超过 Eden 区大小，或是超过 Survivor 区大小），可能直接分配到老年代 也可以通过 -XX:PretenureSizeThreshold=&lt;大小，单位字节&gt; 控制超过一定大小的对象是否直接分配到老年代（Old Generation），跳过新生代（Eden），以避免大对象频繁在年轻代造成 GC 压力。这个参数只在 Serial 和ParNew两个收集器下有效。 对象动态年龄判断 对象在Survivor区来回移动时，如果这批对象的总大小大于这块Survivor区域内存大小的50%(-XX:TargetSurvivorRatio可以指定)，那么此时大于等于这批对象年龄最大值的对象，就可以直接进入老年代了， 例如Survivor区域里现在有一批对象，年龄1+年龄2+年龄n的多个年龄对象总和超过了Survivor区域的50%，此时就会把年龄n(含)以上的对象都放入老年代。这个规则其实是希望那些可能是长期存活的对象，尽早进入老年代。 对象动态年龄判断机制一般是在minor gc之后触发的。 对象逃逸分析 如果对象很小，且只在方法内部使用，并没有被外部引用，则其有可能直接分配到栈内存，而不进入堆内存 JVM对于这种情况可以通过开启逃逸分析参数(-XX:+DoEscapeAnalysis)来优化对象内存分配位置，使其通过标量替换优先分配在栈上(栈上分配)，JDK7之后默认开启逃逸分析，如果要关闭使用参数(-XX:-DoEscapeAnalysis) 标量替换 通过逃逸分析确定该对象不会被外部访问，并且对象可以被进一步分解时，JVM不会创建该对象，而是将该对象成员变量分解若干个被这个方法使用的成员变量所代替，这些代替的成员变量在栈帧或寄存器上分配空间，这样就不会因为没有一大块连续空间导致对象内存不够分配。 开启标量替换参数(-XX:+EliminateAllocations)，JDK7之后默认开启。 标量与聚合量 标量即不可被进一步分解的量，而JAVA的基本数据类型就是标量（如：int，long等基本数据类型以及reference类型等）， 标量的对立就是可以被进一步分解的量，而这种量称之为聚合量。而在JAVA中对象就是可以被进一步分解的聚合量。 Parallel 垃圾回收器（Parallel GC） 的工作方式 Parallel GC 是多线程垃圾回收器，可以通过 -XX:ParallelGCThreads 来设置GC线程数量。 当 Parallel GC 被触发（例如 Minor GC 或 Full GC）时，所有用户线程 被完全暂停（Stop-The-World, STW） Parallel GC 参数配置表（吞吐量优先 GC） 参数名 说明 默认值（如未特别说明） -XX:+UseParallelGC 开启 Parallel GC，用于新生代收集 - -XX:+UseParallelOldGC 开启老年代并行收集（Parallel Old） - -XX:ParallelGCThreads 垃圾回收时的并行线程数（与 CPU 数量相关） 根据硬件自动配置 -XX:MaxGCPauseMillis 设置 GC 最大暂停时间目标（影响内存分配策略） 一个非常大的值，可以认为无限制（建议按需设置） -XX:GCTimeRatio 设置 GC 时间与应用运行时间的比值（0~100）值越小，GC 越频繁，值越大 GC 越少 99（表示 1% 用于 GC，99% 用于应用） -XX:+UseAdaptiveSizePolicy 启用自适应 GC 策略（根据运行状况自动调整各区域大小） 默认开启 -XX:SurvivorRatio Eden 与 Survivor 的内存比例（如 8 表示 Eden:S0:S1 = 8:1:1） 8 -XX:InitialTenuringThreshold 对象晋升到老年代的初始年龄（会随运行动态调整） 7 -XX:MaxTenuringThreshold 晋升到老年代的最大年龄（对象在 Survivor 区经历几次 GC） 15 -XX:PretenureSizeThreshold 设置大对象阈值，超过该大小的对象直接分配到老年代 0（即禁用） -XX:+ScavengeBeforeFullGC 在 Full GC 之前是否先执行一次 Minor GC true启 -XX:+UseFastAccessorMethods 优化原始类型的 get/set 方法性能 false启 -XX:+AlwaysPreTouch JVM 启动时立即分配并初始化所有内存页，避免运行时首次分配带来的停顿 false 分区模型 G1 垃圾回收器 G1(Garbage-First) 属于 物理上分区，逻辑上分代，真正的分区模型是 ZGC（jdk21后也支持分代） G1将Java堆划分为多个大小相等的独立区域（Region），在JDK10以前，JVM最多可以有2048个Region，每个 Region 的大小是 2^n MB，并且落在 1MB 到 32MB 之间，这就导致G1最大支持64G 的堆 (2048 Regions × 32MB = 64GB)，在JDK10以后，G1 支持 更多 Region（最多约 32,768 个），而Region 大小仍是 1MB～32MB 的 2 的幂，使其最大可以支持 1T 的堆。JDK17开始，HotSpot JVM 已改进 G1 的 Region 映射方式（如提升每个Region的大小），可以进一步提升支持的堆大小上限。但堆越大，FullGC就越慢，建议 &gt;1T 的堆使用ZGC或Shenandoah GC。 一般Region大小由JVM自动计算，当然也可以用参数-XX:G1HeapRegionSize手动指定Region大小，但是推荐默认的计算方式。 G1保留了年轻代和老年代的概念，但不再是物理隔阂了，它们都是（可以不连续）Region的集合。 在 G1 GC 中，不要使用 -Xmn，G1 中推荐使用以下更细粒度的控制方式： 123# 这是实验性参数，需要开启 `-XX:+UnlockExperimentalVMOptions`，但依旧推荐在生产环境中使用-XX:G1NewSizePercent=5-XX:G1MaxNewSizePercent=60 默认年轻代对堆内存的占比是5%，如果堆大小为4096M，那么年轻代占据200MB左右的内存，对应大概是100个Region，可以通过 -XX:G1NewSizePercent设置新生代初始占比，这是实验性参数，需要开启 -XX:+UnlockExperimentalVMOptions，但依旧推荐在生产环境中使用。 在系统运行中，JVM会不停的给年轻代增加更多的Region，但是最多新生代的占比不会超过60%，可以通过-XX:G1MaxNewSizePercent调整，这是实验性参数，需要开启 -XX:+UnlockExperimentalVMOptions，但依旧推荐在生产环境中使用。 年轻代中的Eden和Survivor对应的region也跟之前一样，默认8:1:1，假设年轻代现在有1000个region，eden区对应800个，s0对应100个，s1对应100个。 一个Region可能之前是年轻代，如果Region进行了垃圾回收，之后可能又会变成老年代，也就是说Region的区域功能可能会动态变化。 G1垃圾收集器对于对象什么时候会转移到老年代跟之前讲过的原则一样，唯一不同的是对大对象的处理，G1有专门分配大对象的Region叫Humongous区，而不是让大对象直接进入老年代的Region中。 在G1中，大对象的判定规则就是一个大对象超过了一个Region大小的50%，比如按照上面算的，每个Region是2M，只要一个大对象超过了1M，就会被放入Humongous中，而且一个大对象如果太大，可能会横跨多个Region来存放。 Humongous区专门存放短期巨型对象，不用直接进老年代，可以节约老年代的空间，避免因为老年代空间不够的GC开销。 Full GC的时候除了收集年轻代和老年代之外，也会将Humongous区一并回收。 G1垃圾收集分类 YoungGC YoungGC并不是说现有的Eden区放满了就会马上触发，G1会计算下现在Eden区回收大概要多久时间，如果回收时间远远小于参数 -XX:MaxGCPauseMills 设定的值，那么增加年轻代的region，继续给新对象存放，不会马上做YoungGC，直到下一次Eden区放满，G1计算回收时间接近参数 -XX:MaxGCPauseMills 设定的值，那么就会触发Young GC MixedGC 不是FullGC，老年代的堆占有率达到参数 -XX:InitiatingHeapOccupancyPercent 设定的值则触发，回收所有的Young和部分Old(根据期望的GC停顿时间确定old区垃圾收集的优先顺序)以及大对象区，正常情况G1的垃圾收集是先做MixedGC，主要使用复制算法，需要把各个region中存活的对象拷贝到别的region里去，拷贝过程中如果发现没有足够的空region能够承载拷贝对象就会触发一次Full GC Full GC 停止系统程序，然后采用单线程进行标记、清理和压缩整理，好空闲出来一批Region来供下一次MixedGC使用，这个过程是非常耗时的。(Shenandoah优化成多线程收集了) G1 收集器的工作方式 图中主要展示了一个典型的 G1 GC 的 并发标记周期（Concurrent Mark Cycle） 的过程。 图中的水平箭头表示各线程（用户线程和GC线程）的执行路径。 竖直的Safepoint线表示一次GC过程中会暂停所有用户线程的时刻（Stop-The-World）。 12345678910111213141516171819202122231️⃣ 初始标记（Initial Mark） 进入 Safepoint： 所有用户线程在此刻暂停（STW）。 标记 GC Roots 直接可达对象。 非常短暂，但属于 Stop-The-World 阶段。 图中是“初始标记”箭头在 Safepoint 之后立刻执行。2️⃣ 并发标记（Concurrent Mark） 用户线程 恢复运行（图中用户线程继续向右延伸）。 GC 线程 并发进行标记工作（即在用户线程运行期间进行标记）。 图中蓝色的“并发标记”箭头与用户线程箭头并行显示，表示并发执行。3️⃣ 最终标记（Remark / Final Mark） 再次进入 Safepoint。 重新暂停所有用户线程。 处理并发标记阶段中遗漏的引用更新等信息，保证标记的准确性。4️⃣ 筛选回收（Cleanup / Filtered Collection） 对已标记的对象做清理（回收不可达对象）。 判断是否需要回收某些 Region。 图中蓝色箭头标注为“筛选回收”。5️⃣ 恢复用户线程 在最后一个 Safepoint 之后，所有用户线程重新开始执行（图中黄色箭头重新向右延伸）。 G1的GC 过程会经历多次Safepoint，但只有 并发标记阶段 是整个周期中最耗时但不会暂停用户线程(STW)的部分。 Safepoint（安全点） 在 JVM（Java 虚拟机）中，Safepoint（安全点） 是一个非常重要的概念，它代表 所有线程必须“安全地”暂停的某个时间点，以便 JVM 能够执行某些全局操作，比如： 垃圾回收（GC） 栈遍历（例如生成堆快照、做逃逸分析等） 类卸载 JIT 编译的一些重写操作等 如果线程正在运行、改变堆中对象的数据，那么 GC 就无法准确标记和回收对象。因此 JVM 需要 让所有线程在一个“可控、安全的位置”上暂停，这个位置就叫 Safepoint。 Safepoint 是怎么工作的？ 1.JVM 发出“进入 Safepoint”的信号（比如要开始 GC） 2.所有线程收到信号后，必须等到“最近的 Safepoint”再停下来： Safepoint 不是任意位置都可以停，它只出现在字节码中一些特定的指令点（比如方法调用、循环跳转等） 3.等所有线程都进入 Safepoint 后，JVM 才能开始执行 GC 等全局操作。 G1 收集器参数配置表 参数名 说明 默认值 -XX:+UseG1GC 使用 G1 垃圾收集器 - -XX:ParallelGCThreads 指定 GC 工作的线程数量 与 CPU 数量相关 -XX:G1HeapRegionSize 设置堆分区大小（1MB~32MB，2 的幂），堆默认划分为 2048 个 Region 自动计算 -XX:MaxGCPauseMillis 设置 GC 目标最大暂停时间 200ms -XX:G1NewSizePercent 新生代初始占比（占整个堆），实验性参数，-XX:+UnlockExperimentalVMOptions 5% -XX:G1MaxNewSizePercent 新生代最大占比（占整个堆），实验性参数，-XX:+UnlockExperimentalVMOptions 60% -XX:TargetSurvivorRatio Survivor 区填充目标（超过该比例，晋升老年代） 50% -XX:MaxTenuringThreshold 最大对象年龄阈值（年龄超过将进入老年代） 15 -XX:InitiatingHeapOccupancyPercent 整个堆的使用率超过该值触发 Mixed GC 45% -XX:G1MixedGCLiveThresholdPercent Mixed GC 中：Region 存活对象占比低于该值才会被回收，实验性参数，-XX:+UnlockExperimentalVMOptions 85% -XX:G1MixedGCCountTarget 每次 Mixed GC 的最大回收轮次 8 -XX:G1HeapWastePercent Mixed GC 回收目标：空闲 Region 达堆总量该百分比就结束混合回收 5% ZGC 垃圾回收器 ZGC(Z Garbage Collector)是一款JDK 11中新加入的具有实验性质的低延迟垃圾收集器，ZGC可以说源自于是Azul System公司开发的C4（Concurrent Continuously Compacting Collector） 收集器 Platform Supported Since Comment Linux/x64 ✅ JDK 11 Linux/AArch64 ✅ JDK 13 macOS ✅ JDK 14 Windows ✅ JDK 14 Requires Windows version 1803 (Windows 10 or Windows Server 2019) or later. ZGC收集器是一款基于Region内存布局的，暂时不设分代的(jdk21后支持分代)，使用了读屏障、颜色指针等技术来实现可并发的标记-整理算法的，以低延迟为首要目标的一款垃圾收集器。 颜色指针 在 ZGC（Z Garbage Collector）中，颜色指针（Colored Pointer）是一种核心机制，把对象的 GC 状态信息直接嵌入到对象的引用（地址）中，用于在不增加对象额外元数据的前提下，跟踪对象在垃圾回收过程中的状态。 在传统 GC 中，对象的“颜色”（如白色、灰色、黑色）表示其在 GC 不同阶段的状态，这些信息一般存储在额外的数据结构中（如记忆集合、位图等）。 而在 ZGC 中，ZGC 将对象的这些状态信息编码进指针的高位中。所以一个对象引用（pointer）不仅仅是内存地址，还携带了对象在 GC 过程中的“颜色”信息。 ZGC 主要运行在 64 位系统上，但当前的操作系统和 CPU 实际上只使用 48～57 位虚拟地址。ZGC 利用未使用的高位进行编码。 每个对象有一个64位指针，这64位被分为： 位数 名称 含义 18 位 预留 保留位，未来可能用于扩展功能 1 位 Finalizable 表示对象可终结（即实现了 finalize() 方法） 1 位 Remapped 标识对象是否已被转移(用于标识某个引用是否已经被重定向（更新为新地址）)；为 1 表示该对象未在重定位集（Relocation Set）中，即新地址，为0表示旧地址 1 位 Marked1 标记位之一，用于 GC 过程中的对象标记阶段 ,由于 ZGC 是并发 GC，需要两位来支持颜色切换机制（Color Flip），确保在不同 GC 周期中可以区分新旧标记，需要触发一次读取屏障（load barrier），找到对象的新位置，并更新这个引用。 1 位 Marked0 另一个标记位，与 Marked1 配合用于 GC 标记阶段 42 位 对象地址部分 实际的内存地址部分，最多可表示 2^42 字节（即 4 TB）,jdk15后占用 44位，支持 16TB 读屏障 ZGC（Z Garbage Collector）中的**读屏障（Read Barrier）是其核心机制之一，它保证了并发压缩（对象移动）**时程序的正确性，是实现低延迟、高并发垃圾回收的关键。 在传统 GC 中，如果对象在 GC 过程中被移动，程序访问到的对象地址可能就无效了。因此，需要**“停世界”**将所有引用更新。 而 ZGC 的设计目标是 &lt;10ms 的 GC 停顿时间，所以它采用 并发标记 + 并发移动 + 并发引用更新 的模式。在这种模式下，对象可以在程序运行时被移动，但程序访问时必须“知道”这个对象是否已经被移动，并获取其最新地址，这就是读屏障的职责。 读屏障是一种在读取对象引用时自动插入的逻辑，用于检查引用是否有效，并在必要时进行修正（即地址重定向）。 ZGC 是目前唯一在所有对象访问中都使用读屏障的 GC，它在每次对象指针解引用时都进行如下操作： 职责 说明 检测引用是否是老地址 利用指针中的元信息（颜色指针，如 Remapped 位）判断引用是否已经被更新 如果未更新则重定向引用 如果引用的是旧地址，屏障会通过 forwarding table 找到新地址并更新 保证最终访问对象的地址正确 即使在对象移动过程中，程序也总能访问到有效地址，无需停顿所有线程 graph TD A[程序访问对象引用&lt;br&#x2F;&gt;例如：Person p &#x3D; personField] --&gt; B[JVM 插入读屏障逻辑] B --&gt; C[读屏障检查颜色指针中的 Remapped 位] C --&gt; D{Remapped 位为 0 吗？} D -- 是 --&gt; E[检查对象是否已被移动] E --&gt; F[更新引用地址为新地址] F --&gt; G[设置 Remapped 位为 1] G --&gt; H[使用更新后的引用访问对象] D -- 否 --&gt; I[直接使用当前引用访问对象] ZGC的Region可以具有大、中、小三类容量： 小型Region（Small Region） ： 容量固定为2MB，用于放置小于256KB的小对象。 中型Region（Medium Region） ： 容量固定为32MB，用于放置大于等于256KB但小于4MB的对象。 大型Region（Large Region） ： 容量不固定，可以动态变化，但必须为2MB的整数倍，用于放置4MB或以上的大对象。 每个大型Region中只会存放一个大对象，这也预示着虽然名字叫作“大型Region”，但它的实际容量完全有可能小于中型Region，最小容量可低至4MB。 ZGC 特点： 支持极大堆（JDK 15 起支持最高 16TB） GC 停顿时间通常低于 1ms（与堆大小基本无关） 适合低延迟、高吞吐、高可用的应用场景，如交易系统、广告推荐等 ZGC 收集器的工作方式 123456789101112131415161718192021221️⃣ 并发标记（Concurrent Mark）： 与G1一样，并发标记是遍历对象图做可达性分析的阶段， 它的初始标记(Mark Start)和最终标记(Mark End)也会出现短暂的停顿， 与G1不同的是，ZGC的标记是在指针上而不是在对象上进行的， 标记阶段会更新染色指针中的 Marked 0、 Marked 1 标志位。2️⃣ 并发预备重分配（Concurrent Prepare for Relocate）： 这个阶段需要根据特定的查询条件统计得出本次收集过程要清理哪些Region，将这些Region组成重分配集（Relocation Set）。 ZGC每次回收都会扫描所有的Region，用范围更大的扫描成本换取省去G1中记忆集的维护成本。3️⃣ 并发重分配（Concurrent Relocate）： 重分配是ZGC执行过程中的核心阶段，这个过程要把重分配集中的存活对象复制到新的Region上， 并为重分配集中的每个Region维护一个转发表（Forward Table），记录从旧对象到新对象的转向关系。 ZGC收集器能仅从引用上就明确得知一个对象是否处于重分配集之中，如果用户线程此时并发访问了位于重分配集中的对象， 这次访问将会被预置的内存屏障(读屏障)所截获，然后立即根据Region上的转发表记录将访问转发到新复制的对象上， 并同时修正更新该引用的值，使其直接指向新对象，ZGC将这种行为称为指针的“自愈”（Self-Healing）能力。4️⃣ 并发重映射（Concurrent Remap）： 重映射所做的就是修正整个堆中指向重分配集中旧对象的所有引用，但是ZGC中对象引用存在“自愈”功能，所以这个重映射操作并不是很迫切。 ZGC很巧妙地把并发重映射阶段（Concurrent Remap）要做的工作，合并到了下一次垃圾收集循环中的并发标记阶段（Concurrent Mark）里去完成， 反正它们都是要遍历所有对象的，这样合并就节省了一次遍历对象图的开销。 一旦所有指针都被修正之后， 原来记录新旧对象关系的转发表就可以释放掉了。 ZGC存在的问题 ZGC最大的问题是浮动垃圾。ZGC的停顿时间是在10ms以下，但是ZGC的执行时间还是远远大于这个时间的。假如ZGC全过程需要执行10分钟，在这个期间由于对象分配速率很高，将创建大量的新对象，这些对象很难进入当次GC，所以只能在下次GC的时候进行回收，这些只能等到下次GC才能回收的对象就是浮动垃圾。 ZGC没有分代概念，每次都需要进行全堆扫描，导致一些“朝生夕死”的对象没能及时的被回收。 目前唯一的办法是增大堆的容量，使得程序得到更多的喘息时间，但是这个也是一个治标不治本的方案。如果需要从根本上解决这个问题，还是需要引入分代收集，让新生对象都在一个专门的区域中创建，然后专门针对这个区域进行更频繁、更快的收集。 JDK21正式引入了分代（jdk17是预览版），可以在生产环境中使用，需要手动开启：-XX:+ZGenerational ZGC 收集器参数配置表 参数名 说明 默认值（如未特殊标注） -XX:+UseZGC 启用 ZGC 垃圾收集器 - -XX:+UnlockExperimentalVMOptions 解锁实验性参数（JDK 11~14 使用 ZGC 必须） - -XX:+UseLargePages 启用大页内存（性能优化） false -XX:+UseTransparentHugePages 启用透明大页（部分 Linux 上可结合使用） false -Xmx / -Xms 设置最大/初始堆大小 用户配置 -XX:ZUncommitDelay=&lt;秒&gt; 未使用内存释放回操作系统的延迟时间（ZGC 会自动释放内存） 300（5分钟） -XX:SoftMaxHeapSize=&lt;大小&gt; 软最大堆（Soft Heap Limit）：ZGC 尝试将使用的堆控制在该值以内 默认等于 -Xmx -XX:MaxHeapFreeRatio 最大堆空闲比例（超过此比例可能触发内存释放） 70 -XX:MinHeapFreeRatio 最小堆空闲比例（低于此比例可能触发扩容） 40 -XX:+ZGenerational 启用 ZGC 分代收集（从 JDK 21 起支持，默认关闭） false（JDK 21+） -XX:+PrintGC / -Xlog:gc* 开启 GC 日志输出 - -XX:+ZProactive 主动回收策略（在系统空闲时尝试回收） true -XX:ZCollectionInterval=&lt;秒&gt; 主动回收之间的最小时间间隔（配合 ZProactive） 默认值因版本而异 ZGC vs G1 GC vs Parallel GC 对比表 特性 ZGC G1 GC Parallel GC 设计目标 极低延迟，&lt;1ms 停顿 平衡 低延迟 与 高吞吐 高吞吐，最大化 CPU 使用 GC 停顿时间 &lt;1ms，堆大小增加不影响停顿时间 几十到几百毫秒，堆越大停顿越明显 停顿时间可能达到秒级，堆越大越明显 堆大小支持 支持高达 16TB（JDK 15+） 支持 最多 4TB 支持大堆，但停顿明显 是否分代 默认不分代（JDK 21+ 可开启 -XX:+ZGenerational） 分代（新生代 + 老年代） 分代（新生代 + 老年代） 并发回收 是，包括标记、压缩、引用处理都并发 部分并发，仍包含明显 Stop-The-World 阶段 否，全部 Stop-The-World 移动对象时是否停顿 否，使用读屏障并发转移对象 是（通过复制区域） 是 实现机制 标记-重定位，基于读屏障 Region 分区 + 标记-复制 + Mixed GC 标记-复制（新生代）、标记-整理（老年代） 吞吐能力 中高 高 最高 适用场景 低延迟系统，如金融、交易、推荐等实时应用 通用后台系统、Web 服务等 批处理、数据计算、日志分析等不敏感于停顿的系统 默认启用 否，需指定 -XX:+UseZGC JDK 9+ 默认 GC JDK 8 及以前默认 GC 调优复杂度 低，大多数参数可省略 中，需要设置目标停顿时间等 高，需要精细配置 Eden/Survivor 等比例 GC 日志配置方式 统一日志格式：-Xlog:gc*（JDK 9+） 支持传统的 -XX:+PrintGCDetails 和 -Xlog:gc* 日志输出 主要使用旧参数：-XX:+PrintGCDetails 等 ZGC 吞吐能力较弱的原因 原因 解释 1. 并发阶段代价较高 ZGC 几乎所有的 GC 工作（包括标记、整理、引用处理、转移对象）都在与应用线程并发执行。虽然减少了停顿，但这些 GC 线程与业务线程共享 CPU 资源，增加了 CPU 上下文切换和缓存竞争，从而影响业务线程的执行效率。 2. 读屏障开销 ZGC 依赖着色指针和读屏障（load barrier）机制来跟踪对象引用状态，支持并发转移。虽然非常高效，但仍比传统 GC 的普通读写路径慢一些，在高频访问对象场景下会带来一定 CPU 开销。 3. 对硬件依赖高，调度保守 为了实现“&lt;1ms 停顿”的目标，ZGC 会选择更保守的调度策略（如避免并发线程使用过多 CPU），而不会像 Parallel GC 那样“榨干”所有核心资源。 4. 内存开销更高 为了支持并发压缩和转移，ZGC 通常需要为每个对象保留元数据和更多的转移空间（即“浮动垃圾”区域），这可能导致频繁的 GC 周期，影响吞吐。 5. 设计目标非吞吐优先 ZGC 的首要目标是低延迟而非最大吞吐。与 Parallel GC（以吞吐为核心）设计目标不同，ZGC 更适合场景为“对延迟敏感但吞吐可接受”的系统。 最糟糕的情况下吞吐量会降低15%。这都不是事，停顿时间足够优秀。至于吞吐量，通过扩容分分钟解决。 另外，Oracle官方提到了它最大的优点是：它的停顿时间不会随着堆的增大而增长！ 也就是说，几十G堆的停顿时间是10ms以下，几百G甚至上T堆的停顿时间也是10ms以下。 ZGC 吞吐弱，不是因为技术落后，而是因为它主动选择在低延迟和高吞吐之间偏向了低延迟。 在对响应时间要求极高的系统中，它是非常合适的选择。 但如果你的目标是压榨机器性能跑批处理、日志分析这类吞吐导向型任务，Parallel GC 或 G1 会更合适。 内存溢出(OutOfMemoryError，简称 OOM) JVM 常见内存溢出类型汇总表 溢出类型 异常信息 触发原因/描述 相关参数和建议配置 堆内存溢出 java.lang.OutOfMemoryError: Java heap space - 创建大量对象，堆空间不足- 内存泄漏：对象不再使用却有强引用- 老年代对象太多无法晋升 -Xms / -Xmx 设置堆大小 栈溢出（递归） java.lang.StackOverflowError - 方法无限递归或递归层级太深 -Xss 设置线程栈大小 无法创建新线程 java.lang.OutOfMemoryError: unable to create new native thread - 创建线程过多（如线程池配置过大）- 系统或 JVM native 线程资源耗尽 控制线程池大小，避免无限新建线程 元空间溢出 java.lang.OutOfMemoryError: Metaspace - 动态加载类过多（如使用 CGLIB、JSP 动态生成类）- 类无法卸载（如 ClassLoader 泄漏） -XX:MetaspaceSize / -XX:MaxMetaspaceSize 直接内存溢出 java.lang.OutOfMemoryError: Direct buffer memory - 使用 ByteBuffer.allocateDirect() 分配大量直接内存- Netty 等框架默认使用直接内存 -XX:MaxDirectMemorySize GC 开销过高 java.lang.OutOfMemoryError: GC overhead limit exceeded - JVM 花费 &gt;98% 的时间 GC 但回收 &lt;2% 的内存，认为进入“GC 死循环” 分析 GC 日志、优化堆设置 类卸载失败（内存泄漏） （不一定报错，但可能导致 Metaspace OOM） - Web 容器频繁部署热更新 WAR 包时，ClassLoader 无法卸载，导致类永久驻留 优化 ClassLoader 管理，使用内存分析工具 堆快照(堆转储)文件分析 参数 说明 -XX:+HeapDumpOnOutOfMemoryError OOM 时生成堆转储文件 ,建议生产环境开启 -XX:HeapDumpPath=xxx.hprof 指定堆转储文件保存路径 默认保存在当前目录 常用分析工具与命令 工具/命令 简介与功能 使用说明 MAT（Memory Analyzer Tool） Eclipse 出品的强大图形工具，支持泄漏分析、对象引用链分析、内存占用统计等 下载地址：https://www.eclipse.org/mat/打开后直接导入 .hprof 文件即可分析 VisualVM 官方可视化 JVM 监控工具，支持实时分析、GC 查看、线程状态与堆转储查看 附带于 JDK（或单独安装），打开 .hprof 文件进行可视化分析 JProfiler 商业级 Java 性能分析工具，提供堆分析、CPU 分析、线程分析等全套功能 支持打开 .hprof 文件，也可在运行时配合使用（需付费或试用） YourKit 商业性能分析工具，界面友好，支持丰富的分析功能 支持堆分析，适合内存泄漏排查 jhat（过时） JDK 附带的旧工具，用于分析 .hprof 文件，开启 Web 界面查看（已废弃） 命令：jhat heapdump.hprof，浏览器访问 http://localhost:7000（JDK 8 及以下） jmap 用于生成堆转储文件或查看堆对象统计信息（不是分析工具本身） 命令：jmap -dump:format=b,file=heap.hprof &lt;pid&gt; 生成转储；配合 MAT 使用 jcmd 更现代的诊断命令工具，可生成 heap dump、执行 GC、打印 VM 状态等 命令：jcmd &lt;pid&gt; GC.heap_dump heap.hprof GCEasy.io 在线分析工具，支持 .hprof 文件和 GC 日志上传分析 网站：https://gceasy.io GC日志相关参数(JDK1.8及以下) 参数 说明 -XX:+PrintGC 打印基本 GC 信息（建议配合 -XX:+PrintGCDetails 使用） -XX:+PrintGCDetails 打印详细的 GC 日志信息（如各区域使用情况、对象分配、晋升等） -XX:+PrintGCDateStamps 在 GC 日志中添加日期时间戳 -XX:+PrintGCTimeStamps 在 GC 日志中添加 JVM 启动以来的时间戳 -Xloggc:/var/log/myapp/gc.log 将 GC 日志输出到指定文件 -XX:+UseGCLogFileRotation 启用 GC 日志文件轮转（适用于大规模系统的 GC 日志管理） -XX:NumberOfGCLogFiles=5 最多保留 5 个 GC 日志历史文件 -XX:GCLogFileSize=10M 每个 GC 日志文件最大为 10MB -XX:+PrintGCCause 打印 GC 的触发原因（如 Minor GC、System.gc() 等） GC日志相关参数(JDK9+) 1-Xlog:gc*:file=/var/log/app/gc.log:time,uptime,level,tags:filecount=5,filesize=20M 部分 含义 说明 gc* 日志类别 表示记录所有 GC 相关日志（如 gc、gc+start、gc+heap 等）。* 是通配符。 file=/var/log/app/gc.log 输出路径 将 GC 日志输出到指定路径，而不是控制台。可以是相对或绝对路径。 time 日志时间戳 添加格式化时间（如 2025-05-12T10:21:33.123+0800）。便于定位具体时间。 uptime JVM 启动以来的时间戳 显示 GC 发生时距离 JVM 启动的毫秒数（例如 3.254s）。有助于调试启动期间的问题。 level 日志级别 显示日志级别（info、debug、warning 等），默认 info。 tags 日志标签 显示日志的模块标签，如 [gc,start]，帮助快速定位类别。 filecount=5 文件轮转个数 最多保留 5 个日志文件（当前日志 + 4 个历史）。 filesize=20M 单文件最大大小 每个日志文件最大 20MB，超出时自动滚动到下一个文件。","summary":"摘要 本文介绍JVM的内存模型与垃圾回收机制 The Java® Virtual Machine Specification 版本jdk1.8","date_published":"2025-05-12T14:30:05.000Z","tags":["技术","jvm","jvm"]},{"id":"https://blog.hanqunfeng.com/2025/05/08/jvm-classloader-01/","url":"https://blog.hanqunfeng.com/2025/05/08/jvm-classloader-01/","title":"JVM 之 类加载器","content_html":"<!--\n **加粗**\n *斜体*\n ***加粗并斜体***\n ~~删除线~~\n ==突出显示==\n `突出显示(推荐)`\n ++下划线++\n ~下标~\n ^上标^\n 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.\n 图片设置宽度和高度(通过uPic上传后，需要将upic修改过为blog，用于添加水印) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)\n\n +++ **点击折叠**\n 这是被隐藏的内容\n +++\n\n::: tips success warning danger\n这里是容器内的内容\n:::\n\n% note info % success warning danger\n这里是容器内的内容\n% endnote %\n\n引用本地其它文章连接{}\n 大括号开始% post_link 文件名称(不包含.md) %大括号结束\n -->\n<h2 id=\"摘要\">摘要</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>本文介绍JVM的类加载器</p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://docs.oracle.com/javase/specs/jvms/se8/html/index.html\">The Java® Virtual Machine Specification</a> 版本jdk1.8</p>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"类加载器\">类加载器</h2>\n<p><img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/weBeGe.png\" alt=\"\" width=\"1200\" height=\"400\"></p>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>左侧是JDK中实现的类加载器，通过<code>parent</code>属性形成⽗⼦关系。应⽤中⾃定义的类加载器的<code>parent</code>都是<br>\n<code>AppClassLoader</code></p>\n</li>\n<li class=\"lvl-2\">\n<p>右侧是JDK中的类加载器实现类。通过类继承的机制形成体系。未来我们就可以通过继承相关的类实现⾃定义类<br>\n加载器。</p>\n</li>\n<li class=\"lvl-2\">\n<p>在代码中查看类加载器关系</p>\n</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">LoaderDemo</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> ClassNotFoundException &#123;</span><br><span class=\"line\">        <span class=\"comment\">// ⽗⼦关系 AppClassLoader &lt;- ExtClassLoader &lt;- BootStrap Classloader</span></span><br><span class=\"line\">        <span class=\"type\">ClassLoader</span> <span class=\"variable\">cl1</span> <span class=\"operator\">=</span> LoaderDemo.class.getClassLoader();</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;cl1 &gt; &quot;</span> + cl1); <span class=\"comment\">// sun.misc.Launcher$AppClassLoader@18b4aac2</span></span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;parent of cl1 &gt; &quot;</span> + cl1.getParent()); <span class=\"comment\">// sun.misc.Launcher$ExtClassLoader@1b6d3586</span></span><br><span class=\"line\">        <span class=\"comment\">// BootStrap Classloader由C++开发，是JVM虚拟机的⼀部分，本身不是JAVA类。</span></span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;grant parent of cl1 &gt; &quot;</span> + cl1.getParent().getParent()); <span class=\"comment\">// null</span></span><br><span class=\"line\">        <span class=\"comment\">// String,Int等基础类由BootStrap Classloader加载。</span></span><br><span class=\"line\">        <span class=\"type\">ClassLoader</span> <span class=\"variable\">cl2</span> <span class=\"operator\">=</span> String.class.getClassLoader();</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;cl2 &gt; &quot;</span> + cl2); <span class=\"comment\">// null</span></span><br><span class=\"line\">        System.out.println(cl1.loadClass(<span class=\"string\">&quot;java.util.List&quot;</span>).getClass().getClassLoader()); <span class=\"comment\">// null</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"双亲委派机制\">双亲委派机制</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>当⼀个类加载器要加载⼀个类时，整体的过程就是通过双亲委派机制向上委托查找，如果没有查找到，就向下委托加载。</p>\n</li>\n<li class=\"lvl-2\">\n<p>Java 类加载机制中的<code>双亲委派模型（Parent Delegation Model）</code>是一种保证了类加载器按照层次结构从上到下来加载类的策略。这种层级化的加载流程确保了应用程序能够安全地加载并使用来自不同来源的类，同时也避免了内存中出现相同类的多个拷贝。</p>\n</li>\n<li class=\"lvl-2\">\n<p>以下是双亲委派机制的工作原理：</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-4\">1.当一个类加载器接收到类加载请求时，它首先不会自行尝试去寻找类文件，而是将这个请求委派给它的父类加载器。</li>\n<li class=\"lvl-4\">2.父类加载器同样遵循此规则，它会继续把请求向上委派给它的父类加载器，直到达到根（bootstrapp）类加载器为止。</li>\n<li class=\"lvl-4\">3.根类加载器一般会直接访问本地文件系统来查找类文件，比如 JDK 自带的核心类库，或者在-Xbootclasspath指定的路径下查找。</li>\n<li class=\"lvl-4\">4.如果根类加载器找到了该类，则进行类的加载；如果找不到，则把这个任务交回给发出请求的子类加载器。</li>\n<li class=\"lvl-4\">5.子类加载器也重复步骤 4，若找到则加载，否则传递给下一个子类加载器，直至原始提出请求的类加载器。</li>\n<li class=\"lvl-4\">6.若所有的类加载器都未能找到所需的类，则最终抛出ClassNotFoundException异常。<br>\n<img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/ftDnCj.png\" alt=\"\" width=\"600\" height=\"800\"></li>\n</ul>\n</li>\n<li class=\"lvl-2\">\n<p>双亲委派有以下几个优点：</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-4\">安全性：由于类加载是从顶层开始，这能防止恶意代码通过加载相同的包名和类名替代系统的关键类。</li>\n<li class=\"lvl-4\">唯一性：每个类都会被特定的类加载器加载一次，即便是在分布式的环境中也能保证类的统一性，避免因为多次加载导致的错误。</li>\n<li class=\"lvl-4\">可靠性：用户自定义的类加载器不用担心基础类已经被加载，它们可以专心于自己需要处理的部分。</li>\n</ul>\n</li>\n<li class=\"lvl-2\">\n<p>例如，当应用程序运行时，应用类加载器（Application ClassLoader）接收到对java.lang.String类的加载请求时，它会首先将请求传递给扩展类加载器（Extension ClassLoader），后者再传递给引导类加载器（Bootstrap ClassLoader）。引导类加载器会在其搜索路径中找到String类，并完成加载过程。如果应用程序试图提供自己的String类，由于双亲委派的存在，应用程序所指定的类并不会被加载，从而保证了平台核心 API 的一致性。</p>\n</li>\n<li class=\"lvl-2\">\n<p>总之，双亲委派机制是 Java 类加载过程中一个非常重要的特性，它不仅维护了类加载的安全性和一致性，也为开发者提供了灵活定制类加载规则的能力。</p>\n</li>\n</ul>\n<h3 id=\"每个类加载器查找类的默认路径\">每个类加载器查找类的默认路径</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>在 Java 中，每个类加载器都有自己的类路径（Classpath）去查找类文件。下面是几个主要的类加载器以及它们的默认查找路径：</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>类加载器名称</th>\n<th>类名 / 别名</th>\n<th>父类加载器</th>\n<th>加载内容描述</th>\n<th>默认查找路径 / 系统属性</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>启动类加载器</strong></td>\n<td>BootstrapClassLoader</td>\n<td>无</td>\n<td>加载 <strong>核心 Java 类库</strong></td>\n<td><code>&lt;JAVA_HOME&gt;/jre/lib/rt.jar</code>（JDK8 及之前）或 <code>sun.boot.class.path</code> 指定路径</td>\n</tr>\n<tr>\n<td><strong>扩展类加载器</strong></td>\n<td>ExtClassLoader</td>\n<td>BootstrapClassLoader</td>\n<td>加载 Java 平台扩展类库</td>\n<td><code>&lt;JAVA_HOME&gt;/jre/lib/ext</code> 或由 <code>java.ext.dirs</code> 系统属性指定</td>\n</tr>\n<tr>\n<td><strong>应用类加载器</strong></td>\n<td>AppClassLoader</td>\n<td>ExtClassLoader</td>\n<td>加载 <strong>应用程序类</strong>（用户编写的代码）</td>\n<td><code>-classpath</code>、<code>-cp</code> 参数、<code>CLASSPATH</code> 环境变量、<code>java.class.path</code> 属性、当前目录 (.)</td>\n</tr>\n<tr>\n<td><strong>自定义类加载器</strong></td>\n<td>用户自定义</td>\n<td>可指定</td>\n<td>可通过继承 <code>ClassLoader</code> 并重写 <code>findClass()</code> 方法实现自定义类加载逻辑，如从网络、数据库等加载类文件</td>\n<td>默认继承父加载器查找路径，也可自定义</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>需要注意的是，除了 Bootstrap ClassLoader 外，其他的所有类加载器最终都是java.lang.ClassLoader的子类，并且每个类加载器实例都有一个直接的父类加载器。如果你创建了一个新的类加载器，它将继承 Application ClassLoader 作为它的父类，除非你在创建时指定了不同的父类加载器。</p>\n</li>\n<li class=\"lvl-2\">\n<p>此外，Java 9 引入了模块化系统后，类加载机制也有了一些变化，对于模块路径上的类加载，会使用新的层次结构来处理，这使得类加载过程更加灵活同时保持了向后的兼容性。不过，对于传统的类路径上的类加载，双亲委派模型仍然适用。<br>\n<img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/50fvA9.png\" alt=\"\" width=\"1200\" height=\"400\"></p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>类加载器名称</th>\n<th>类名 / 别名</th>\n<th>父类加载器</th>\n<th>加载模块范围</th>\n<th>默认查找路径 / 模块来源</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>引导类加载器</strong></td>\n<td><code>BootstrapClassLoader</code></td>\n<td>无</td>\n<td>加载 <code>java.*</code> 模块，例如 <code>java.base</code>（包含 <code>java.lang</code>, <code>java.util</code> 等）</td>\n<td><code>$JAVA_HOME/jmods</code> 中的模块文件，核心模块由 JVM 启动时直接加载</td>\n</tr>\n<tr>\n<td><strong>平台类加载器</strong></td>\n<td><code>PlatformClassLoader</code></td>\n<td>BootstrapClassLoader</td>\n<td>加载 <code>jdk.*</code>、<code>javafx.*</code> 等平台扩展模块</td>\n<td><code>$JAVA_HOME/jmods</code>，模块名为 <code>jdk.*</code>、<code>javafx.*</code> 等；</td>\n</tr>\n<tr>\n<td><strong>应用类加载器</strong></td>\n<td><code>AppClassLoader</code></td>\n<td>PlatformClassLoader</td>\n<td>加载应用模块（用户代码），包括模块路径 <code>--module-path</code> 和类路径 <code>-classpath</code> 下的类</td>\n<td>应用程序编写的模块或类，来自命令行 <code>--module-path</code>、<code>-classpath</code> 参数、<code>CLASSPATH</code> 环境变量等</td>\n</tr>\n<tr>\n<td><strong>自定义类加载器</strong></td>\n<td>用户自定义</td>\n<td>可指定父加载器</td>\n<td>加载非标准位置的类，可用于插件、网络加载、加密类加载等</td>\n<td>默认遵循双亲委派，可重写 <code>findClass()</code> 实现自定义路径查找或其他数据源，如网络、数据库、加密文件等</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>在代码中查看类加载路径</p>\n</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// BootStrap Classloader，加载java基础类。</span></span><br><span class=\"line\">System.out.println(<span class=\"string\">&quot;BootStrap ClassLoader加载⽬录：&quot;</span> + System.getProperty(<span class=\"string\">&quot;sun.boot.class.path&quot;</span>));</span><br><span class=\"line\"><span class=\"comment\">// Extention Classloader 加载⼀些扩展类。 可通过-D java.ext.dirs另⾏指定⽬录</span></span><br><span class=\"line\">System.out.println(<span class=\"string\">&quot;Extention ClassLoader加载⽬录：&quot;</span> + System.getProperty(<span class=\"string\">&quot;java.ext.dirs&quot;</span>));</span><br><span class=\"line\"><span class=\"comment\">// AppClassLoader 加载CLASSPATH，应⽤下的Jar包。可通过-D java.class.path另⾏指定⽬录</span></span><br><span class=\"line\">System.out.println(<span class=\"string\">&quot;AppClassLoader加载⽬录：&quot;</span> + System.getProperty(<span class=\"string\">&quot;java.class.path&quot;</span>));</span><br></pre></td></tr></table></figure>\n<h3 id=\"双亲委派机制的实现原理\">双亲委派机制的实现原理</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>java.lang.ClassLoader 类的 loadClass 方法是双亲委派的核心实现</p>\n</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 加载指定名称的类，并根据 resolve 参数决定是否解析该类。</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> * 该方法实现了类加载的基本逻辑，包括检查类是否已加载、委托父类加载器加载、</span></span><br><span class=\"line\"><span class=\"comment\"> * 自行加载类以及解析类等步骤。该方法是 Java 类加载机制的核心部分之一，</span></span><br><span class=\"line\"><span class=\"comment\"> * 遵循双亲委派模型。</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> name    要加载的类的全限定名</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> resolve 如果为 true，则在加载后解析该类</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@return</span> 加载的 Class 对象</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@throws</span> ClassNotFoundException 如果找不到指定的类</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"comment\">// 这个⽅法是protected声明的，意味着，是可以被⼦类覆盖的，所以，双亲委派机制也是可以被打破的，如Tomcat⼦类重写这个⽅法，并使⽤自己的类加载逻辑。</span></span><br><span class=\"line\"><span class=\"keyword\">protected</span> Class&lt;?&gt; loadClass(String name, <span class=\"type\">boolean</span> resolve)</span><br><span class=\"line\">        <span class=\"keyword\">throws</span> ClassNotFoundException &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 使用 synchronized 确保多线程环境下类加载的同步</span></span><br><span class=\"line\">    <span class=\"keyword\">synchronized</span> (getClassLoadingLock(name)) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// First, check if the class has already been loaded</span></span><br><span class=\"line\">        <span class=\"comment\">// 每个类加载器对他加载过的类都有⼀个缓存，先去缓存中查看有没有加载过</span></span><br><span class=\"line\">        Class&lt;?&gt; c = findLoadedClass(name);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (c == <span class=\"literal\">null</span>) &#123; <span class=\"comment\">//没有加载过，就⾛双亲委派</span></span><br><span class=\"line\">            <span class=\"type\">long</span> <span class=\"variable\">t0</span> <span class=\"operator\">=</span> System.nanoTime();</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                <span class=\"comment\">// 父类存在则让⽗类加载器进⾏加载</span></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (parent != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">                    c = parent.loadClass(name, <span class=\"literal\">false</span>);</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> &#123; <span class=\"comment\">//如果父类不存在，则从引导类加载器进⾏加载</span></span><br><span class=\"line\">                    c = findBootstrapClassOrNull(name);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (ClassNotFoundException e) &#123;</span><br><span class=\"line\">                <span class=\"comment\">// ClassNotFoundException thrown if class not found</span></span><br><span class=\"line\">                <span class=\"comment\">// from the non-null parent class loader</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (c == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">                <span class=\"comment\">// If still not found, then invoke findClass in order</span></span><br><span class=\"line\">                <span class=\"comment\">// to find the class.</span></span><br><span class=\"line\">                <span class=\"type\">long</span> <span class=\"variable\">t1</span> <span class=\"operator\">=</span> System.nanoTime();</span><br><span class=\"line\">                <span class=\"comment\">// findClass 方法是子类实现的，用于加载指定名称的类</span></span><br><span class=\"line\">                <span class=\"comment\">// ⽗类加载器没有加载过，就⾃⾏解析class⽂件加载</span></span><br><span class=\"line\">                c = findClass(name);</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"comment\">// this is the defining class loader; record the stats</span></span><br><span class=\"line\">                <span class=\"comment\">// 性能统计：记录类加载过程中的时间消耗和调用次数，便于监控和优化。</span></span><br><span class=\"line\">                sun.misc.PerfCounter.getParentDelegationTime().addTime(t1 - t0);</span><br><span class=\"line\">                sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1);</span><br><span class=\"line\">                sun.misc.PerfCounter.getFindClasses().increment();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 默认情况下，双亲委派模型只进⾏了验证和准备阶段，⽽不进⾏解析(如链接、初始化)</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (resolve) &#123;</span><br><span class=\"line\">            resolveClass(c);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> c;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>该方法实现了类加载的基本逻辑，包括检查类是否已加载、委托父类加载器加载、自行加载类以及解析类等步骤。该方法是 Java 类加载机制的核心部分之一，遵循双亲委派模型。</p>\n</li>\n<li class=\"lvl-2\">\n<p>这个⽅法是<code>protected</code>声明的，意味着，是可以被⼦类覆盖的，所以，双亲委派机制也是可以被打破的，如Tomcat⼦类重写这个⽅法，并使⽤自己的类加载逻辑。</p>\n</li>\n</ul>\n<h2 id=\"沙箱保护机制\">沙箱保护机制</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>沙箱保护机制是 Java 虚拟机提供的一种安全机制，用于保护应用程序免受恶意代码的攻击。</p>\n</li>\n<li class=\"lvl-2\">\n<p>java.lang.ClassLoader 类的 preDefineClass 方法是沙箱保护机制的核心实现</p>\n</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 这个方法在双亲委派模型之前被调用，用于在加载类之前进行一些预处理操作。</span></span><br><span class=\"line\"><span class=\"comment\">// 参数：</span></span><br><span class=\"line\"><span class=\"comment\">// name: 要加载的类的全限定名。</span></span><br><span class=\"line\"><span class=\"comment\">// pd: 提供的保护域信息，可能为 null。</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> ProtectionDomain <span class=\"title function_\">preDefineClass</span><span class=\"params\">(String name,</span></span><br><span class=\"line\"><span class=\"params\">                                            ProtectionDomain pd)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!checkName(name))</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">NoClassDefFoundError</span>(<span class=\"string\">&quot;IllegalName: &quot;</span> + name);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// Note:  Checking logic in java.lang.invoke.MemberName.checkForTypeAlias</span></span><br><span class=\"line\">        <span class=\"comment\">// relies on the fact that spoofing is impossible if a class has a name</span></span><br><span class=\"line\">        <span class=\"comment\">// of the form &quot;java.*&quot;</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((name != <span class=\"literal\">null</span>) &amp;&amp; name.startsWith(<span class=\"string\">&quot;java.&quot;</span>)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">SecurityException</span></span><br><span class=\"line\">                (<span class=\"string\">&quot;Prohibited package name: &quot;</span> +</span><br><span class=\"line\">                 name.substring(<span class=\"number\">0</span>, name.lastIndexOf(<span class=\"string\">&#x27;.&#x27;</span>)));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (pd == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            pd = defaultDomain;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (name != <span class=\"literal\">null</span>) checkCerts(name, pd.getCodeSource());</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> pd;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>这个方法 <code>preDefineClass</code> 的作用是在类被定义之前进行一些安全检查和准备工作，确保类的合法性与安全性。它通常用于自定义类加载器中，以增强类加载过程中的安全控制。</p>\n</li>\n<li class=\"lvl-2\">\n<p>方法作用详解：</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-4\">1.防止定义非法类名的类（如 java.* 包下的类）：\n<ul class=\"lvl-4\">\n<li class=\"lvl-6\">如果尝试加载的类属于 java. 开头的标准包（如 java.lang, java.util 等），会抛出 SecurityException。</li>\n<li class=\"lvl-6\">这是为了防止用户自定义类伪装成 Java 核心类库中的类，从而造成安全风险。</li>\n</ul>\n</li>\n<li class=\"lvl-4\">2.校验类名合法性：\n<ul class=\"lvl-4\">\n<li class=\"lvl-6\">调用 checkName(name) 检查类名是否合法（例如不能包含 /、非法字符等），若不合法则抛出 NoClassDefFoundError。</li>\n</ul>\n</li>\n<li class=\"lvl-4\">3.证书一致性校验（签名一致性校验）：\n<ul class=\"lvl-4\">\n<li class=\"lvl-6\">如果类有名称且提供了 ProtectionDomain，会调用 checkCerts(name, codeSource) 来确保当前类的签名与其所在包中其他类的签名一致。</li>\n<li class=\"lvl-6\">防止同一包中混入不同签名的类，避免潜在的恶意篡改。</li>\n</ul>\n</li>\n<li class=\"lvl-4\">4.设置默认保护域（ProtectionDomain）：\n<ul class=\"lvl-4\">\n<li class=\"lvl-6\">如果传入的 ProtectionDomain 为 null，则使用类加载器的默认域 defaultDomain。</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"Linking链接过程\">Linking链接过程</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>在ClassLoader的<code>loadClass</code>⽅法中，还有⼀个不起眼的步骤，<code>resolveClass</code>。这是⼀个<code>native</code>⽅法。⽽其实现的过程称为<code>linking-链接</code>。</p>\n</li>\n<li class=\"lvl-2\">\n<p>链接过程的实现功能如下图：<br>\n<img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/9vkhLN.png\" alt=\"\" width=\"900\" height=\"500\"></p>\n</li>\n<li class=\"lvl-2\">\n<p>其中关于半初始化状态就是JDK在处理⼀个类的static静态属性时，会先给这个属性分配⼀个默认值，作⽤是占住内存。然后等连接过程完成后，在后⾯的初始化阶段，再将静态属性从默认值修改为指定的初始值。</p>\n</li>\n<li class=\"lvl-2\">\n<p>符号引⽤和直接引⽤</p>\n</li>\n</ul>\n<blockquote>\n<p>如果A类中有⼀个静态属性，引⽤了另⼀个B类。那么在对类进⾏初始化的过程中，因为A和B这两个类都没有初始化，JVM并不知道A和B这两个类的具体地址。所以这时，在A类中，只能创建⼀个不知道具体地址的引⽤，指向B类。这个引⽤就称为符号引⽤。⽽当A类和B类都完成初始化后，JVM⾃然就需要将这个符号引⽤转⽽指向B类具体的内存地址，这个引⽤就称为直接引⽤。</p>\n</blockquote>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>来看一个有意思的示例</p>\n</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Apple</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 静态变量按声明顺序初始化</span></span><br><span class=\"line\">    <span class=\"comment\">// 构造方法初始化apple对象时，price还没有被初始化，处于链接过程中的准备阶段，即半初始化状态，所以price为默认值0.0</span></span><br><span class=\"line\">    <span class=\"keyword\">static</span> <span class=\"type\">Apple</span> <span class=\"variable\">apple</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Apple</span>(<span class=\"number\">10</span>);</span><br><span class=\"line\">    <span class=\"comment\">// 解决方法是将price声明在apple的上面即可</span></span><br><span class=\"line\">    <span class=\"keyword\">static</span> <span class=\"type\">double</span> <span class=\"variable\">price</span> <span class=\"operator\">=</span> <span class=\"number\">20.00</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"type\">double</span> totalpay;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"title function_\">Apple</span><span class=\"params\">(<span class=\"type\">double</span> discount)</span> &#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;====&quot;</span> + price);</span><br><span class=\"line\">        totalpay = price - discount;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">PriceTest</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> &#123;</span><br><span class=\"line\">        System.out.println(Apple.apple.totalpay); <span class=\"comment\">// -10.0</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>这里有一个有意思的问题，就是只有当<code>loadClass</code>方法中的<code>resolve</code>参数为<code>true</code>时<code>resolveClass</code>方法才会被调用，但是大部分情况下，<code>resolve</code>参数都是<code>false</code>，这不是强制限制而是出于以下原因：</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-4\">\n<ol>\n<li class=\"lvl-7\">避免递归解析中出现错误或死循环<br>\n在类的解析过程中，如果该类引用了另一个还没加载的类，立即解析可能会导致无限递归或加载顺序问题。通过延迟解析，可以更好地控制加载流程。</li>\n</ol>\n</li>\n<li class=\"lvl-4\">\n<ol start=\"2\">\n<li class=\"lvl-7\">提高加载效率<br>\n加载类可能不一定马上就用到所有方法、字段等符号引用，推迟解析可以提高性能，尤其在批量加载很多类时。</li>\n</ol>\n</li>\n<li class=\"lvl-4\">\n<ol start=\"3\">\n<li class=\"lvl-7\">更灵活地处理类的依赖<br>\n开发者可以先加载类，稍后根据需要再解析。例如，在自定义类加载器中，可能先判断类是否已经存在、是否需要被增强（比如字节码增强），再决定是否解析。</li>\n</ol>\n</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"通过类加载器引⼊外部Jar包\">通过类加载器引⼊外部Jar包</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>虽然通常我们会将依赖的 jar 包直接放入项目的 classpath 中（比如通过构建工具如 Maven 或 Gradle 管理），但在某些特定场景下，我们确实需要动态地通过 URLClassLoader 加载外部 jar 包，这是 Java 提供的一种更灵活的类加载机制。</p>\n</li>\n<li class=\"lvl-2\">\n<p>以下是一些必须或推荐使用 URLClassLoader 的典型应用场景：</p>\n</li>\n</ul>\n<h3 id=\"1-插件机制（Plugin-System）\">1. 插件机制（Plugin System）</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>场景说明：<br>\n系统支持用户自定义插件（如 IDE 插件、浏览器扩展、游戏 mod），这些插件在运行时才加载，项目本身在编译期并不知道有哪些插件。</p>\n</li>\n<li class=\"lvl-2\">\n<p>举例：<br>\nEclipse 或 IntelliJ 的插件系统<br>\nMinecraft 的 mod 加载器<br>\nSpring Boot Devtools 重新加载机制</p>\n</li>\n<li class=\"lvl-2\">\n<p>为什么不能直接放入 classpath？<br>\n因为插件是动态发现和加载的，不是编译时确定的。</p>\n</li>\n</ul>\n<h3 id=\"2-热部署-动态加载类\">2. 热部署 / 动态加载类</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>场景说明：<br>\n你想在应用运行过程中加载新的 jar 或类，比如热更新一个模块而无需重启服务。</p>\n</li>\n<li class=\"lvl-2\">\n<p>举例：<br>\nWeb 容器（如 Tomcat）的应用重新部署<br>\n使用 URLClassLoader 加载某个模块的新版本以实现热替换</p>\n</li>\n<li class=\"lvl-2\">\n<p>为什么不能放入 classpath？<br>\nclasspath 在启动时就固定了，不能动态添加；而 URLClassLoader 可以运行时加载新 jar。</p>\n</li>\n</ul>\n<h3 id=\"3-多版本隔离\">3. 多版本隔离</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>场景说明：<br>\n你希望不同的模块使用同一个库的不同版本，但 classpath 无法支持两个版本的同一个类。</p>\n</li>\n<li class=\"lvl-2\">\n<p>举例：<br>\n一个服务器运行多个服务实例，它们分别依赖 log4j 的不同版本<br>\n一个系统的插件 A 使用 fastjson 1.x，插件 B 使用 fastjson 2.x</p>\n</li>\n<li class=\"lvl-2\">\n<p>为什么不能放入 classpath？<br>\nclasspath 是共享的，会发生类冲突。使用多个 URLClassLoader，可实现类隔离。</p>\n</li>\n</ul>\n<h3 id=\"4-脚本或用户上传代码执行\">4. 脚本或用户上传代码执行</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>场景说明：<br>\n系统允许用户上传 jar 或 class 文件，然后在服务端执行其中的类逻辑。</p>\n</li>\n<li class=\"lvl-2\">\n<p>举例：<br>\n在线编程平台（如 LeetCode 后端）<br>\n用户上传算法 jar，平台运行并返回结果</p>\n</li>\n<li class=\"lvl-2\">\n<p>为什么不能放入 classpath？<br>\n用户上传内容是动态的，系统在运行前无法预知。</p>\n</li>\n</ul>\n<h3 id=\"5-实现类的延迟加载（节省资源）\">5. 实现类的延迟加载（节省资源）</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>场景说明：<br>\n某些类/模块体积较大或依赖较多，不希望在程序启动时就加载，只有真正使用时再加载。</p>\n</li>\n<li class=\"lvl-2\">\n<p>举例：<br>\n大型桌面应用（如 IntelliJ）在打开某个功能模块时才加载相应 jar</p>\n</li>\n</ul>\n<h3 id=\"总结\">总结</h3>\n<table>\n<thead>\n<tr>\n<th>场景</th>\n<th>使用 <code>URLClassLoader</code> 的原因</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>插件系统</td>\n<td>插件动态加载，不在项目编译时可知</td>\n</tr>\n<tr>\n<td>热部署</td>\n<td>动态替换模块，无需重启</td>\n</tr>\n<tr>\n<td>多版本共存</td>\n<td>避免类冲突，实现类加载隔离</td>\n</tr>\n<tr>\n<td>用户上传 jar</td>\n<td>内容动态生成，classpath 无法预先配置</td>\n</tr>\n<tr>\n<td>延迟加载模块</td>\n<td>启动更快，节省内存</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>如果你是在做框架设计或需要动态扩展能力的场景，理解并使用 URLClassLoader 会非常有帮助。</p>\n</li>\n</ul>\n<h3 id=\"场景假设\">场景假设</h3>\n<h4 id=\"调用外部jar\">调用外部jar</h4>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>我们有一个外部 jar 文件：hello-plugin.jar，它包含一个类：</p>\n</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 这个类编译后打包进 hello-plugin.jar</span></span><br><span class=\"line\"><span class=\"keyword\">package</span> com.example.plugin;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">HelloPlugin</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">sayHello</span><span class=\"params\">(String name)</span> &#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;Hello from plugin! :&quot;</span> + name);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>主程序使用 URLClassLoader 动态加载这个 jar</p>\n</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> java.io.File;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.lang.reflect.Method;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.net.URL;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.net.URLClassLoader;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">PluginLoader</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 外部 jar 的路径</span></span><br><span class=\"line\">        <span class=\"type\">File</span> <span class=\"variable\">jarFile</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">File</span>(<span class=\"string\">&quot;plugins/hello-plugin.jar&quot;</span>);</span><br><span class=\"line\">        <span class=\"type\">URL</span> <span class=\"variable\">jarUrl</span> <span class=\"operator\">=</span> jarFile.toURI().toURL();</span><br><span class=\"line\">        <span class=\"comment\">// HTTPS jar 的 URL</span></span><br><span class=\"line\">        <span class=\"comment\">// URL jarUrl = new URL(&quot;https://your-domain.com/libs/hello-plugin.jar&quot;);</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 构建 URLClassLoader（也可以设置父加载器）</span></span><br><span class=\"line\">        <span class=\"type\">URLClassLoader</span> <span class=\"variable\">classLoader</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">URLClassLoader</span>(<span class=\"keyword\">new</span> <span class=\"title class_\">URL</span>[]&#123;jarUrl&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 加载插件类</span></span><br><span class=\"line\">        Class&lt;?&gt; clazz = classLoader.loadClass(<span class=\"string\">&quot;com.example.plugin.HelloPlugin&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 创建实例并调用方法</span></span><br><span class=\"line\">        <span class=\"type\">Object</span> <span class=\"variable\">plugin</span> <span class=\"operator\">=</span> clazz.getDeclaredConstructor().newInstance();</span><br><span class=\"line\">        <span class=\"type\">Method</span> <span class=\"variable\">sayHello</span> <span class=\"operator\">=</span> clazz.getMethod(<span class=\"string\">&quot;sayHello&quot;</span>, String.class);</span><br><span class=\"line\">        sayHello.invoke(plugin, <span class=\"string\">&quot;World&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 关闭 ClassLoader（Java 7+ 推荐）</span></span><br><span class=\"line\">        classLoader.close();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"运行时动态编译-Java-源代码\">运行时动态编译 Java 源代码</h4>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>我们有一个 java 代码片段：</p>\n</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> javax.tools.JavaCompiler;</span><br><span class=\"line\"><span class=\"keyword\">import</span> javax.tools.ToolProvider;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.File;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.FileWriter;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.lang.reflect.Method;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.net.URL;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.net.URLClassLoader;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.nio.file.Files;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.nio.file.Path;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">DynamicJavaRunner</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">className</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;com.example.dynamic.Hello&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// Java 源代码</span></span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">sourceCode</span> <span class=\"operator\">=</span></span><br><span class=\"line\">                <span class=\"string\">&quot;package com.example.dynamic;\\n&quot;</span> +</span><br><span class=\"line\">                        <span class=\"string\">&quot;\\n&quot;</span> +</span><br><span class=\"line\">                        <span class=\"string\">&quot;public class Hello &#123;\\n&quot;</span> +</span><br><span class=\"line\">                        <span class=\"string\">&quot;    public void say() &#123;\\n&quot;</span> +</span><br><span class=\"line\">                        <span class=\"string\">&quot;        System.out.println(\\&quot;Hello from dynamic source!\\&quot;);\\n&quot;</span> +</span><br><span class=\"line\">                        <span class=\"string\">&quot;    &#125;\\n&quot;</span> +</span><br><span class=\"line\">                        <span class=\"string\">&quot;&#125;\\n&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 创建临时目录</span></span><br><span class=\"line\">        <span class=\"type\">Path</span> <span class=\"variable\">tempDir</span> <span class=\"operator\">=</span> Files.createTempDirectory(<span class=\"string\">&quot;dynamic-classes&quot;</span>);</span><br><span class=\"line\">        <span class=\"type\">File</span> <span class=\"variable\">outputDir</span> <span class=\"operator\">=</span> tempDir.toFile();</span><br><span class=\"line\">        <span class=\"comment\">// System.out.println(&quot;临时目录：&quot; + outputDir.getAbsolutePath());</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 创建 .java 文件</span></span><br><span class=\"line\">        <span class=\"type\">File</span> <span class=\"variable\">javaFile</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">File</span>(outputDir, <span class=\"string\">&quot;com/example/dynamic/Hello.java&quot;</span>);</span><br><span class=\"line\">        javaFile.getParentFile().mkdirs();</span><br><span class=\"line\">        <span class=\"keyword\">try</span> (<span class=\"type\">FileWriter</span> <span class=\"variable\">writer</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">FileWriter</span>(javaFile)) &#123;</span><br><span class=\"line\">            writer.write(sourceCode);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 编译 Java 文件</span></span><br><span class=\"line\">        <span class=\"type\">JavaCompiler</span> <span class=\"variable\">compiler</span> <span class=\"operator\">=</span> ToolProvider.getSystemJavaCompiler();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (compiler == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            System.err.println(<span class=\"string\">&quot;请用 JDK 而非 JRE 运行！&quot;</span>);</span><br><span class=\"line\">            <span class=\"keyword\">return</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"type\">int</span> <span class=\"variable\">result</span> <span class=\"operator\">=</span> compiler.run(<span class=\"literal\">null</span>, <span class=\"literal\">null</span>, <span class=\"literal\">null</span>, javaFile.getPath());</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (result != <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            System.err.println(<span class=\"string\">&quot;编译失败！&quot;</span>);</span><br><span class=\"line\">            <span class=\"keyword\">return</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 加载类并调用</span></span><br><span class=\"line\">        <span class=\"type\">URLClassLoader</span> <span class=\"variable\">classLoader</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">URLClassLoader</span>(<span class=\"keyword\">new</span> <span class=\"title class_\">URL</span>[]&#123;outputDir.toURI().toURL()&#125;);</span><br><span class=\"line\">        Class&lt;?&gt; clazz = classLoader.loadClass(className);</span><br><span class=\"line\">        <span class=\"type\">Object</span> <span class=\"variable\">instance</span> <span class=\"operator\">=</span> clazz.getDeclaredConstructor().newInstance();</span><br><span class=\"line\">        <span class=\"type\">Method</span> <span class=\"variable\">method</span> <span class=\"operator\">=</span> clazz.getMethod(<span class=\"string\">&quot;say&quot;</span>);</span><br><span class=\"line\">        method.invoke(instance);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 清理（可选）</span></span><br><span class=\"line\">        classLoader.close();</span><br><span class=\"line\">        <span class=\"comment\">// 删除临时目录</span></span><br><span class=\"line\">        Files.walk(outputDir.toPath())</span><br><span class=\"line\">                .sorted(Comparator.reverseOrder()) <span class=\"comment\">// 先删文件，再删目录</span></span><br><span class=\"line\">                .map(Path::toFile)</span><br><span class=\"line\">                .forEach(File::delete);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>关键点说明</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>机制</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>JavaCompiler</code></td>\n<td>JDK 自带的编译器（<code>tools.jar</code>）</td>\n</tr>\n<tr>\n<td><code>ToolProvider.getSystemJavaCompiler()</code></td>\n<td>只能在 JDK 环境中工作，JRE 无法使用</td>\n</tr>\n<tr>\n<td><code>URLClassLoader</code></td>\n<td>用于加载编译后的 .class 文件</td>\n</tr>\n<tr>\n<td><code>FileWriter</code></td>\n<td>保存代码为临时 Java 文件</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"自定义类加载器\">自定义类加载器</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>要自定义 ClassLoader，只需要继承于 <code>ClassLoader</code> 或者 <code>SecureClassLoader</code>，并重写 <code>findClass()</code> 方法即可</p>\n</li>\n<li class=\"lvl-2\">\n<p>示例：我们对上面的代码进行升级，不创建临时文件，而是在内存中编译代码，并从内存中加载字节码，而不依赖磁盘文件，更高效也更适合生产环境中动态类加载（如在线代码执行、脚本引擎等）。</p>\n</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> javax.tools.*;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.*;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.net.URI;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.*;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.lang.reflect.*;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">InMemoryJavaRunner</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">className</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;com.example.dynamic.Hello&quot;</span>;</span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">sourceCode</span> <span class=\"operator\">=</span></span><br><span class=\"line\">                <span class=\"string\">&quot;package com.example.dynamic;\\n&quot;</span> +</span><br><span class=\"line\">                        <span class=\"string\">&quot;public class Hello &#123;\\n&quot;</span> +</span><br><span class=\"line\">                        <span class=\"string\">&quot;    public void say() &#123;\\n&quot;</span> +</span><br><span class=\"line\">                        <span class=\"string\">&quot;        System.out.println(\\&quot;Hello from memory compiled class!\\&quot;);\\n&quot;</span> +</span><br><span class=\"line\">                        <span class=\"string\">&quot;    &#125;\\n&quot;</span> +</span><br><span class=\"line\">                        <span class=\"string\">&quot;&#125;&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 获取系统 Java 编译器</span></span><br><span class=\"line\">        <span class=\"type\">JavaCompiler</span> <span class=\"variable\">compiler</span> <span class=\"operator\">=</span> ToolProvider.getSystemJavaCompiler();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (compiler == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            System.err.println(<span class=\"string\">&quot;请使用 JDK 运行此程序（非 JRE）&quot;</span>);</span><br><span class=\"line\">            <span class=\"keyword\">return</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 准备编译源代码：一个 JavaFileObject 表示源代码</span></span><br><span class=\"line\">        <span class=\"type\">JavaFileObject</span> <span class=\"variable\">sourceFile</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">JavaSourceFromString</span>(className, sourceCode);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 创建自定义的内存文件管理器（替代标准的磁盘管理器）</span></span><br><span class=\"line\">        <span class=\"type\">StandardJavaFileManager</span> <span class=\"variable\">standardFileManager</span> <span class=\"operator\">=</span> compiler.getStandardFileManager(<span class=\"literal\">null</span>, <span class=\"literal\">null</span>, <span class=\"literal\">null</span>);</span><br><span class=\"line\">        <span class=\"type\">MemoryJavaFileManager</span> <span class=\"variable\">fileManager</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">MemoryJavaFileManager</span>(standardFileManager);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 执行编译任务</span></span><br><span class=\"line\">        JavaCompiler.<span class=\"type\">CompilationTask</span> <span class=\"variable\">task</span> <span class=\"operator\">=</span> compiler.getTask(<span class=\"literal\">null</span>, fileManager, <span class=\"literal\">null</span>, <span class=\"literal\">null</span>, <span class=\"literal\">null</span>, Collections.singletonList(sourceFile));</span><br><span class=\"line\">        <span class=\"type\">boolean</span> <span class=\"variable\">success</span> <span class=\"operator\">=</span> task.call();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!success) &#123;</span><br><span class=\"line\">            System.err.println(<span class=\"string\">&quot;编译失败！&quot;</span>);</span><br><span class=\"line\">            <span class=\"keyword\">return</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 加载编译后的类</span></span><br><span class=\"line\">        Map&lt;String, <span class=\"type\">byte</span>[]&gt; classBytes = fileManager.getClassBytes();</span><br><span class=\"line\">        <span class=\"type\">InMemoryClassLoader</span> <span class=\"variable\">classLoader</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">InMemoryClassLoader</span>(classBytes);</span><br><span class=\"line\">        Class&lt;?&gt; clazz = classLoader.loadClass(className);</span><br><span class=\"line\">        <span class=\"type\">Object</span> <span class=\"variable\">instance</span> <span class=\"operator\">=</span> clazz.getDeclaredConstructor().newInstance();</span><br><span class=\"line\">        <span class=\"type\">Method</span> <span class=\"variable\">method</span> <span class=\"operator\">=</span> clazz.getMethod(<span class=\"string\">&quot;say&quot;</span>);</span><br><span class=\"line\">        method.invoke(instance);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 用于表示内存中的 Java 源代码</span></span><br><span class=\"line\">    <span class=\"keyword\">static</span> <span class=\"keyword\">class</span> <span class=\"title class_\">JavaSourceFromString</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">SimpleJavaFileObject</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">final</span> String code;</span><br><span class=\"line\"></span><br><span class=\"line\">        JavaSourceFromString(String className, String code) &#123;</span><br><span class=\"line\">            <span class=\"built_in\">super</span>(URI.create(<span class=\"string\">&quot;string:///&quot;</span> + className.replace(<span class=\"string\">&#x27;.&#x27;</span>, <span class=\"string\">&#x27;/&#x27;</span>) + Kind.SOURCE.extension), Kind.SOURCE);</span><br><span class=\"line\">            <span class=\"built_in\">this</span>.code = code;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">public</span> CharSequence <span class=\"title function_\">getCharContent</span><span class=\"params\">(<span class=\"type\">boolean</span> ignoreEncodingErrors)</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> code;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 将编译的 class 文件保存在内存中（不是文件系统）</span></span><br><span class=\"line\">    <span class=\"keyword\">static</span> <span class=\"keyword\">class</span> <span class=\"title class_\">MemoryJavaFileManager</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">ForwardingJavaFileManager</span>&lt;StandardJavaFileManager&gt; &#123;</span><br><span class=\"line\">        <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Map&lt;String, ByteArrayOutputStream&gt; classOutputBuffers = <span class=\"keyword\">new</span> <span class=\"title class_\">HashMap</span>&lt;&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">        MemoryJavaFileManager(StandardJavaFileManager standardManager) &#123;</span><br><span class=\"line\">            <span class=\"built_in\">super</span>(standardManager);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"meta\">@Override</span></span><br><span class=\"line\">        <span class=\"keyword\">public</span> JavaFileObject <span class=\"title function_\">getJavaFileForOutput</span><span class=\"params\">(Location location, String className,</span></span><br><span class=\"line\"><span class=\"params\">                                                   JavaFileObject.Kind kind, FileObject sibling)</span> &#123;</span><br><span class=\"line\">            <span class=\"type\">ByteArrayOutputStream</span> <span class=\"variable\">outputStream</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ByteArrayOutputStream</span>();</span><br><span class=\"line\">            classOutputBuffers.put(className, outputStream);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">SimpleJavaFileObject</span>(</span><br><span class=\"line\">                    URI.create(<span class=\"string\">&quot;mem:///&quot;</span> + className.replace(<span class=\"string\">&#x27;.&#x27;</span>, <span class=\"string\">&#x27;/&#x27;</span>) + kind.extension), kind) &#123;</span><br><span class=\"line\">                <span class=\"meta\">@Override</span></span><br><span class=\"line\">                <span class=\"keyword\">public</span> OutputStream <span class=\"title function_\">openOutputStream</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">return</span> outputStream;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">public</span> Map&lt;String, <span class=\"type\">byte</span>[]&gt; getClassBytes() &#123;</span><br><span class=\"line\">            Map&lt;String, <span class=\"type\">byte</span>[]&gt; result = <span class=\"keyword\">new</span> <span class=\"title class_\">HashMap</span>&lt;&gt;();</span><br><span class=\"line\">            <span class=\"keyword\">for</span> (Map.Entry&lt;String, ByteArrayOutputStream&gt; entry : classOutputBuffers.entrySet()) &#123;</span><br><span class=\"line\">                result.put(entry.getKey(), entry.getValue().toByteArray());</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 自定义 ClassLoader，用于从内存中加载字节码</span></span><br><span class=\"line\">    <span class=\"keyword\">static</span> <span class=\"keyword\">class</span> <span class=\"title class_\">InMemoryClassLoader</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">ClassLoader</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Map&lt;String, <span class=\"type\">byte</span>[]&gt; classBytes;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">public</span> <span class=\"title function_\">InMemoryClassLoader</span><span class=\"params\">(Map&lt;String, <span class=\"type\">byte</span>[]&gt; classBytes)</span> &#123;</span><br><span class=\"line\">            <span class=\"built_in\">super</span>(ClassLoader.getSystemClassLoader());</span><br><span class=\"line\">            <span class=\"built_in\">this</span>.classBytes = classBytes;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"meta\">@Override</span></span><br><span class=\"line\">        <span class=\"keyword\">protected</span> Class&lt;?&gt; findClass(String name) <span class=\"keyword\">throws</span> ClassNotFoundException &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 从内存中获取字节码</span></span><br><span class=\"line\">            <span class=\"type\">byte</span>[] bytes = classBytes.get(name);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (bytes == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"built_in\">super</span>.findClass(name);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"comment\">// 定义类并返回，一定要使用 defineClass 方法</span></span><br><span class=\"line\">            <span class=\"keyword\">return</span> defineClass(name, bytes, <span class=\"number\">0</span>, bytes.length);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>进一步升级：我们现在将这个系统扩展为支持多个类同时动态编译、内存加载并执行。这对于需要处理多个类（例如接口 + 实现、内部依赖等）非常实用。</p>\n</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> javax.tools.*;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.*;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.net.URI;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.*;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.lang.reflect.*;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 主类</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">MultiClassInMemoryCompiler</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 准备多个类的源代码</span></span><br><span class=\"line\">        Map&lt;String, String&gt; sources = <span class=\"keyword\">new</span> <span class=\"title class_\">HashMap</span>&lt;&gt;();</span><br><span class=\"line\">        sources.put(<span class=\"string\">&quot;com.example.api.Greeter&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;package com.example.api;\\n&quot;</span> +</span><br><span class=\"line\">                        <span class=\"string\">&quot;public interface Greeter &#123;\\n&quot;</span> +</span><br><span class=\"line\">                        <span class=\"string\">&quot;    void greet();\\n&quot;</span> +</span><br><span class=\"line\">                        <span class=\"string\">&quot;&#125;\\n&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        sources.put(<span class=\"string\">&quot;com.example.impl.EnglishGreeter&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;package com.example.impl;\\n&quot;</span> +</span><br><span class=\"line\">                        <span class=\"string\">&quot;import com.example.api.Greeter;\\n&quot;</span> +</span><br><span class=\"line\">                        <span class=\"string\">&quot;public class EnglishGreeter implements Greeter &#123;\\n&quot;</span> +</span><br><span class=\"line\">                        <span class=\"string\">&quot;    public void greet() &#123;\\n&quot;</span> +</span><br><span class=\"line\">                        <span class=\"string\">&quot;        System.out.println(\\&quot;Hello from EnglishGreeter!\\&quot;);\\n&quot;</span> +</span><br><span class=\"line\">                        <span class=\"string\">&quot;    &#125;\\n&quot;</span> +</span><br><span class=\"line\">                        <span class=\"string\">&quot;&#125;\\n&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">entryClassName</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;com.example.impl.EnglishGreeter&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 编译</span></span><br><span class=\"line\">        Map&lt;String, <span class=\"type\">byte</span>[]&gt; compiledClasses = compile(sources);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (compiledClasses == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            System.err.println(<span class=\"string\">&quot;编译失败&quot;</span>);</span><br><span class=\"line\">            <span class=\"keyword\">return</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 加载并执行</span></span><br><span class=\"line\">        <span class=\"type\">InMemoryClassLoader</span> <span class=\"variable\">classLoader</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">InMemoryClassLoader</span>(compiledClasses);</span><br><span class=\"line\">        Class&lt;?&gt; clazz = classLoader.loadClass(entryClassName);</span><br><span class=\"line\">        <span class=\"type\">Object</span> <span class=\"variable\">obj</span> <span class=\"operator\">=</span> clazz.getDeclaredConstructor().newInstance();</span><br><span class=\"line\">        <span class=\"type\">Method</span> <span class=\"variable\">method</span> <span class=\"operator\">=</span> clazz.getMethod(<span class=\"string\">&quot;greet&quot;</span>);</span><br><span class=\"line\">        method.invoke(obj);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 编译器入口，支持多个类</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> Map&lt;String, <span class=\"type\">byte</span>[]&gt; compile(Map&lt;String, String&gt; sources) &#123;</span><br><span class=\"line\">        <span class=\"type\">JavaCompiler</span> <span class=\"variable\">compiler</span> <span class=\"operator\">=</span> ToolProvider.getSystemJavaCompiler();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (compiler == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            System.err.println(<span class=\"string\">&quot;请使用 JDK 运行&quot;</span>);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        List&lt;JavaFileObject&gt; compilationUnits = <span class=\"keyword\">new</span> <span class=\"title class_\">ArrayList</span>&lt;&gt;();</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (Map.Entry&lt;String, String&gt; entry : sources.entrySet()) &#123;</span><br><span class=\"line\">            compilationUnits.add(<span class=\"keyword\">new</span> <span class=\"title class_\">JavaSourceFromString</span>(entry.getKey(), entry.getValue()));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">StandardJavaFileManager</span> <span class=\"variable\">stdManager</span> <span class=\"operator\">=</span> compiler.getStandardFileManager(<span class=\"literal\">null</span>, <span class=\"literal\">null</span>, <span class=\"literal\">null</span>);</span><br><span class=\"line\">        <span class=\"type\">MemoryJavaFileManager</span> <span class=\"variable\">memManager</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">MemoryJavaFileManager</span>(stdManager);</span><br><span class=\"line\"></span><br><span class=\"line\">        JavaCompiler.<span class=\"type\">CompilationTask</span> <span class=\"variable\">task</span> <span class=\"operator\">=</span> compiler.getTask(<span class=\"literal\">null</span>, memManager, <span class=\"literal\">null</span>, <span class=\"literal\">null</span>, <span class=\"literal\">null</span>, compilationUnits);</span><br><span class=\"line\">        <span class=\"type\">boolean</span> <span class=\"variable\">success</span> <span class=\"operator\">=</span> task.call();</span><br><span class=\"line\">        <span class=\"keyword\">return</span> success ? memManager.getClassBytes() : <span class=\"literal\">null</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 源文件表示（Java 代码以字符串提供）</span></span><br><span class=\"line\">    <span class=\"keyword\">static</span> <span class=\"keyword\">class</span> <span class=\"title class_\">JavaSourceFromString</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">SimpleJavaFileObject</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">final</span> String code;</span><br><span class=\"line\"></span><br><span class=\"line\">        JavaSourceFromString(String className, String code) &#123;</span><br><span class=\"line\">            <span class=\"built_in\">super</span>(URI.create(<span class=\"string\">&quot;string:///&quot;</span> + className.replace(<span class=\"string\">&#x27;.&#x27;</span>, <span class=\"string\">&#x27;/&#x27;</span>) + Kind.SOURCE.extension), Kind.SOURCE);</span><br><span class=\"line\">            <span class=\"built_in\">this</span>.code = code;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"meta\">@Override</span></span><br><span class=\"line\">        <span class=\"keyword\">public</span> CharSequence <span class=\"title function_\">getCharContent</span><span class=\"params\">(<span class=\"type\">boolean</span> ignoreEncodingErrors)</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> code;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 内存中的编译输出管理器</span></span><br><span class=\"line\">    <span class=\"keyword\">static</span> <span class=\"keyword\">class</span> <span class=\"title class_\">MemoryJavaFileManager</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">ForwardingJavaFileManager</span>&lt;StandardJavaFileManager&gt; &#123;</span><br><span class=\"line\">        <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Map&lt;String, ByteArrayOutputStream&gt; classOutputBuffers = <span class=\"keyword\">new</span> <span class=\"title class_\">HashMap</span>&lt;&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">        MemoryJavaFileManager(StandardJavaFileManager standardManager) &#123;</span><br><span class=\"line\">            <span class=\"built_in\">super</span>(standardManager);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"meta\">@Override</span></span><br><span class=\"line\">        <span class=\"keyword\">public</span> JavaFileObject <span class=\"title function_\">getJavaFileForOutput</span><span class=\"params\">(Location location, String className,</span></span><br><span class=\"line\"><span class=\"params\">                                                   JavaFileObject.Kind kind, FileObject sibling)</span> &#123;</span><br><span class=\"line\">            <span class=\"type\">ByteArrayOutputStream</span> <span class=\"variable\">outputStream</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ByteArrayOutputStream</span>();</span><br><span class=\"line\">            classOutputBuffers.put(className, outputStream);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">SimpleJavaFileObject</span>(</span><br><span class=\"line\">                    URI.create(<span class=\"string\">&quot;mem:///&quot;</span> + className.replace(<span class=\"string\">&#x27;.&#x27;</span>, <span class=\"string\">&#x27;/&#x27;</span>) + kind.extension), kind) &#123;</span><br><span class=\"line\">                <span class=\"meta\">@Override</span></span><br><span class=\"line\">                <span class=\"keyword\">public</span> OutputStream <span class=\"title function_\">openOutputStream</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">return</span> outputStream;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">public</span> Map&lt;String, <span class=\"type\">byte</span>[]&gt; getClassBytes() &#123;</span><br><span class=\"line\">            Map&lt;String, <span class=\"type\">byte</span>[]&gt; result = <span class=\"keyword\">new</span> <span class=\"title class_\">HashMap</span>&lt;&gt;();</span><br><span class=\"line\">            <span class=\"keyword\">for</span> (Map.Entry&lt;String, ByteArrayOutputStream&gt; entry : classOutputBuffers.entrySet()) &#123;</span><br><span class=\"line\">                result.put(entry.getKey(), entry.getValue().toByteArray());</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 用于加载内存中的 class</span></span><br><span class=\"line\">    <span class=\"keyword\">static</span> <span class=\"keyword\">class</span> <span class=\"title class_\">InMemoryClassLoader</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">ClassLoader</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Map&lt;String, <span class=\"type\">byte</span>[]&gt; classBytes;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">public</span> <span class=\"title function_\">InMemoryClassLoader</span><span class=\"params\">(Map&lt;String, <span class=\"type\">byte</span>[]&gt; classBytes)</span> &#123;</span><br><span class=\"line\">            <span class=\"built_in\">super</span>(ClassLoader.getSystemClassLoader());</span><br><span class=\"line\">            <span class=\"built_in\">this</span>.classBytes = classBytes;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"meta\">@Override</span></span><br><span class=\"line\">        <span class=\"keyword\">protected</span> Class&lt;?&gt; findClass(String name) <span class=\"keyword\">throws</span> ClassNotFoundException &#123;</span><br><span class=\"line\">            <span class=\"type\">byte</span>[] bytes = classBytes.get(name);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (bytes == <span class=\"literal\">null</span>) <span class=\"keyword\">return</span> <span class=\"built_in\">super</span>.findClass(name);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> defineClass(name, bytes, <span class=\"number\">0</span>, bytes.length);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"打破双亲委派，实现同类多版本共存\">打破双亲委派，实现同类多版本共存</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>假设我们有同一个jar包的不同版本，比如：<code>a-1.0.jar</code>和<code>a-2.0.jar</code>，他们具有同名的 <code>DemoClass</code>类 ,系统<code>classpath</code>中引入的是 <code>a-1.0.jar</code>，而此时我们通过⾃定的ClassLoader加载 <code>a-2.0.jar</code>，并调用 <code>DemoClass</code>类 ，我们会发现，⾃定的ClassLoader加载的类依旧是 <code>a-1.0.jar</code> 中的类，而不是 <code>a-2.0.jar</code> 中的类。</p>\n</li>\n<li class=\"lvl-2\">\n<p>为什么会出现这种情况呢？这就是因为JDK的双亲委派机制。⾃定的ClassLoader的<code>parent</code>属性指向的是JDK内的<code>AppClassLoader</code>，⽽ <code>AppClassLoader</code> 会加载系统当中的所有代码，就包括 <code>a-1.0.jar</code>中的 <code>DemoClass</code>类。这时，⾃定的ClassLoader去加载 <code>DemoClass</code>类时，通过双亲委派向上查找，⾃然加载出来的就是APPClassloader中的<code>DemoClass</code>了。</p>\n</li>\n<li class=\"lvl-2\">\n<p>如何打破双亲委派呢？我们可以通过重写 <code>loadClass()</code>方法，来打破双亲委派，实现类⽂件的加载。</p>\n</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> java.io.ByteArrayOutputStream;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.InputStream;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.net.URL;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.net.URLConnection;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.security.SecureClassLoader;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">CustomClassLoader</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">SecureClassLoader</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> URL jarUrl;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"title function_\">CustomClassLoader</span><span class=\"params\">(URL jarUrl)</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 创建一个独立的子类加载器，只加载指定 JAR</span></span><br><span class=\"line\">        <span class=\"built_in\">this</span>.jarUrl = jarUrl;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> Class&lt;?&gt; loadClass(String name, <span class=\"type\">boolean</span> resolve) <span class=\"keyword\">throws</span> ClassNotFoundException &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 把双亲委派机制反过来，先到⼦类加载器中加载，加载不到再去⽗类加载器中加载。</span></span><br><span class=\"line\">        <span class=\"keyword\">synchronized</span> (getClassLoadingLock(name)) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 如果类已加载，则直接返回</span></span><br><span class=\"line\">            Class&lt;?&gt; loadedClass = findLoadedClass(name);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (loadedClass == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">                loadedClass = findClass(name);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                <span class=\"comment\">// 委派给父类加载器</span></span><br><span class=\"line\">                loadedClass = <span class=\"built_in\">super</span>.loadClass(name, resolve);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> loadedClass;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> Class&lt;?&gt; findClass(String name) &#123;</span><br><span class=\"line\">        <span class=\"type\">int</span> code;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 访问jar包的url</span></span><br><span class=\"line\">            <span class=\"type\">URLConnection</span> <span class=\"variable\">urlConnection</span> <span class=\"operator\">=</span> jarUrl.openConnection();</span><br><span class=\"line\">            urlConnection.setUseCaches(<span class=\"literal\">false</span>);</span><br><span class=\"line\">            <span class=\"type\">InputStream</span> <span class=\"variable\">is</span> <span class=\"operator\">=</span> urlConnection.getInputStream();</span><br><span class=\"line\">            <span class=\"type\">ByteArrayOutputStream</span> <span class=\"variable\">bos</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ByteArrayOutputStream</span>();</span><br><span class=\"line\">            <span class=\"keyword\">while</span> ((code = is.read()) != -<span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">                bos.write(code);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"type\">byte</span>[] data = bos.toByteArray();</span><br><span class=\"line\">            is.close();</span><br><span class=\"line\">            bos.close();</span><br><span class=\"line\">            <span class=\"keyword\">return</span> defineClass(name, data, <span class=\"number\">0</span>, data.length);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>测试代码</p>\n</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> java.io.File;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.net.URL;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Test</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        <span class=\"type\">File</span> <span class=\"variable\">jarFile</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">File</span>(<span class=\"string\">&quot;path/to/a-2.0.jar&quot;</span>);</span><br><span class=\"line\">        <span class=\"type\">URL</span> <span class=\"variable\">jarUrl</span> <span class=\"operator\">=</span> jarFile.toURI().toURL();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">CustomClassLoader</span> <span class=\"variable\">loader</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">CustomClassLoader</span>(jarUrl);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 加载 DemoClass</span></span><br><span class=\"line\">        Class&lt;?&gt; clazz = loader.loadClass(<span class=\"string\">&quot;com.example.DemoClass&quot;</span>);</span><br><span class=\"line\">        <span class=\"type\">Object</span> <span class=\"variable\">obj</span> <span class=\"operator\">=</span> clazz.getDeclaredConstructor().newInstance();</span><br><span class=\"line\">        clazz.getMethod(<span class=\"string\">&quot;print&quot;</span>).invoke(obj);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"打破双亲委派机制的典型场景\">打破双亲委派机制的典型场景</h3>\n<h4 id=\"Tomcat类加载器\">Tomcat类加载器</h4>\n<p><img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/eGKhDn.png\" alt=\"\" width=\"550\" height=\"700\"></p>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>CommonClassLoader：Tomcat最基本的类加载器，加载路径中的class可以被Tomcat容器本身以及各个Webapp访问；</p>\n</li>\n<li class=\"lvl-2\">\n<p>CatalinaClassLoader：Tomcat容器私有的类加载器，加载路径中的class对于Webapp不可⻅；</p>\n</li>\n<li class=\"lvl-2\">\n<p>SharedClassLoader：各个Webapp共享的类加载器，加载路径中的class对于所有Webapp可⻅，但是对于Tomcat容器不可⻅；</p>\n</li>\n<li class=\"lvl-2\">\n<p>WebappClassLoader：各个Webapp私有的类加载器，加载路径中的class只对当前Webapp可⻅，⽐如加载war包⾥相关的类，每个war包应⽤都有⾃⼰的WebappClassLoader，实现相互隔离，⽐如不同war包应⽤引⼊了不同的spring版本，这样实现就能加载各⾃的spring版本；</p>\n</li>\n<li class=\"lvl-2\">\n<p>Jsp类加载器：针对每个JSP⻚⾯创建⼀个加载器。这个加载器⽐较轻量级，所以Tomcat还实现了热加载，也就是JSP只要修改了，就创建⼀个新的加载器，从⽽实现了JSP⻚⾯的热更新。</p>\n</li>\n</ul>\n","content_text":"摘要 本文介绍JVM的类加载器 The Java® Virtual Machine Specification 版本jdk1.8 类加载器 左侧是JDK中实现的类加载器，通过parent属性形成⽗⼦关系。应⽤中⾃定义的类加载器的parent都是 AppClassLoader 右侧是JDK中的类加载器实现类。通过类继承的机制形成体系。未来我们就可以通过继承相关的类实现⾃定义类 加载器。 在代码中查看类加载器关系 1234567891011121314public class LoaderDemo &#123; public static void main(String[] args) throws ClassNotFoundException &#123; // ⽗⼦关系 AppClassLoader &lt;- ExtClassLoader &lt;- BootStrap Classloader ClassLoader cl1 = LoaderDemo.class.getClassLoader(); System.out.println(&quot;cl1 &gt; &quot; + cl1); // sun.misc.Launcher$AppClassLoader@18b4aac2 System.out.println(&quot;parent of cl1 &gt; &quot; + cl1.getParent()); // sun.misc.Launcher$ExtClassLoader@1b6d3586 // BootStrap Classloader由C++开发，是JVM虚拟机的⼀部分，本身不是JAVA类。 System.out.println(&quot;grant parent of cl1 &gt; &quot; + cl1.getParent().getParent()); // null // String,Int等基础类由BootStrap Classloader加载。 ClassLoader cl2 = String.class.getClassLoader(); System.out.println(&quot;cl2 &gt; &quot; + cl2); // null System.out.println(cl1.loadClass(&quot;java.util.List&quot;).getClass().getClassLoader()); // null &#125;&#125; 双亲委派机制 当⼀个类加载器要加载⼀个类时，整体的过程就是通过双亲委派机制向上委托查找，如果没有查找到，就向下委托加载。 Java 类加载机制中的双亲委派模型（Parent Delegation Model）是一种保证了类加载器按照层次结构从上到下来加载类的策略。这种层级化的加载流程确保了应用程序能够安全地加载并使用来自不同来源的类，同时也避免了内存中出现相同类的多个拷贝。 以下是双亲委派机制的工作原理： 1.当一个类加载器接收到类加载请求时，它首先不会自行尝试去寻找类文件，而是将这个请求委派给它的父类加载器。 2.父类加载器同样遵循此规则，它会继续把请求向上委派给它的父类加载器，直到达到根（bootstrapp）类加载器为止。 3.根类加载器一般会直接访问本地文件系统来查找类文件，比如 JDK 自带的核心类库，或者在-Xbootclasspath指定的路径下查找。 4.如果根类加载器找到了该类，则进行类的加载；如果找不到，则把这个任务交回给发出请求的子类加载器。 5.子类加载器也重复步骤 4，若找到则加载，否则传递给下一个子类加载器，直至原始提出请求的类加载器。 6.若所有的类加载器都未能找到所需的类，则最终抛出ClassNotFoundException异常。 双亲委派有以下几个优点： 安全性：由于类加载是从顶层开始，这能防止恶意代码通过加载相同的包名和类名替代系统的关键类。 唯一性：每个类都会被特定的类加载器加载一次，即便是在分布式的环境中也能保证类的统一性，避免因为多次加载导致的错误。 可靠性：用户自定义的类加载器不用担心基础类已经被加载，它们可以专心于自己需要处理的部分。 例如，当应用程序运行时，应用类加载器（Application ClassLoader）接收到对java.lang.String类的加载请求时，它会首先将请求传递给扩展类加载器（Extension ClassLoader），后者再传递给引导类加载器（Bootstrap ClassLoader）。引导类加载器会在其搜索路径中找到String类，并完成加载过程。如果应用程序试图提供自己的String类，由于双亲委派的存在，应用程序所指定的类并不会被加载，从而保证了平台核心 API 的一致性。 总之，双亲委派机制是 Java 类加载过程中一个非常重要的特性，它不仅维护了类加载的安全性和一致性，也为开发者提供了灵活定制类加载规则的能力。 每个类加载器查找类的默认路径 在 Java 中，每个类加载器都有自己的类路径（Classpath）去查找类文件。下面是几个主要的类加载器以及它们的默认查找路径： 类加载器名称 类名 / 别名 父类加载器 加载内容描述 默认查找路径 / 系统属性 启动类加载器 BootstrapClassLoader 无 加载 核心 Java 类库 &lt;JAVA_HOME&gt;/jre/lib/rt.jar（JDK8 及之前）或 sun.boot.class.path 指定路径 扩展类加载器 ExtClassLoader BootstrapClassLoader 加载 Java 平台扩展类库 &lt;JAVA_HOME&gt;/jre/lib/ext 或由 java.ext.dirs 系统属性指定 应用类加载器 AppClassLoader ExtClassLoader 加载 应用程序类（用户编写的代码） -classpath、-cp 参数、CLASSPATH 环境变量、java.class.path 属性、当前目录 (.) 自定义类加载器 用户自定义 可指定 可通过继承 ClassLoader 并重写 findClass() 方法实现自定义类加载逻辑，如从网络、数据库等加载类文件 默认继承父加载器查找路径，也可自定义 需要注意的是，除了 Bootstrap ClassLoader 外，其他的所有类加载器最终都是java.lang.ClassLoader的子类，并且每个类加载器实例都有一个直接的父类加载器。如果你创建了一个新的类加载器，它将继承 Application ClassLoader 作为它的父类，除非你在创建时指定了不同的父类加载器。 此外，Java 9 引入了模块化系统后，类加载机制也有了一些变化，对于模块路径上的类加载，会使用新的层次结构来处理，这使得类加载过程更加灵活同时保持了向后的兼容性。不过，对于传统的类路径上的类加载，双亲委派模型仍然适用。 类加载器名称 类名 / 别名 父类加载器 加载模块范围 默认查找路径 / 模块来源 引导类加载器 BootstrapClassLoader 无 加载 java.* 模块，例如 java.base（包含 java.lang, java.util 等） $JAVA_HOME/jmods 中的模块文件，核心模块由 JVM 启动时直接加载 平台类加载器 PlatformClassLoader BootstrapClassLoader 加载 jdk.*、javafx.* 等平台扩展模块 $JAVA_HOME/jmods，模块名为 jdk.*、javafx.* 等； 应用类加载器 AppClassLoader PlatformClassLoader 加载应用模块（用户代码），包括模块路径 --module-path 和类路径 -classpath 下的类 应用程序编写的模块或类，来自命令行 --module-path、-classpath 参数、CLASSPATH 环境变量等 自定义类加载器 用户自定义 可指定父加载器 加载非标准位置的类，可用于插件、网络加载、加密类加载等 默认遵循双亲委派，可重写 findClass() 实现自定义路径查找或其他数据源，如网络、数据库、加密文件等 在代码中查看类加载路径 123456// BootStrap Classloader，加载java基础类。System.out.println(&quot;BootStrap ClassLoader加载⽬录：&quot; + System.getProperty(&quot;sun.boot.class.path&quot;));// Extention Classloader 加载⼀些扩展类。 可通过-D java.ext.dirs另⾏指定⽬录System.out.println(&quot;Extention ClassLoader加载⽬录：&quot; + System.getProperty(&quot;java.ext.dirs&quot;));// AppClassLoader 加载CLASSPATH，应⽤下的Jar包。可通过-D java.class.path另⾏指定⽬录System.out.println(&quot;AppClassLoader加载⽬录：&quot; + System.getProperty(&quot;java.class.path&quot;)); 双亲委派机制的实现原理 java.lang.ClassLoader 类的 loadClass 方法是双亲委派的核心实现 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657/** * 加载指定名称的类，并根据 resolve 参数决定是否解析该类。 * * 该方法实现了类加载的基本逻辑，包括检查类是否已加载、委托父类加载器加载、 * 自行加载类以及解析类等步骤。该方法是 Java 类加载机制的核心部分之一， * 遵循双亲委派模型。 * * @param name 要加载的类的全限定名 * @param resolve 如果为 true，则在加载后解析该类 * @return 加载的 Class 对象 * @throws ClassNotFoundException 如果找不到指定的类 */// 这个⽅法是protected声明的，意味着，是可以被⼦类覆盖的，所以，双亲委派机制也是可以被打破的，如Tomcat⼦类重写这个⽅法，并使⽤自己的类加载逻辑。protected Class&lt;?&gt; loadClass(String name, boolean resolve) throws ClassNotFoundException &#123; // 使用 synchronized 确保多线程环境下类加载的同步 synchronized (getClassLoadingLock(name)) &#123; // First, check if the class has already been loaded // 每个类加载器对他加载过的类都有⼀个缓存，先去缓存中查看有没有加载过 Class&lt;?&gt; c = findLoadedClass(name); if (c == null) &#123; //没有加载过，就⾛双亲委派 long t0 = System.nanoTime(); try &#123; // 父类存在则让⽗类加载器进⾏加载 if (parent != null) &#123; c = parent.loadClass(name, false); &#125; else &#123; //如果父类不存在，则从引导类加载器进⾏加载 c = findBootstrapClassOrNull(name); &#125; &#125; catch (ClassNotFoundException e) &#123; // ClassNotFoundException thrown if class not found // from the non-null parent class loader &#125; if (c == null) &#123; // If still not found, then invoke findClass in order // to find the class. long t1 = System.nanoTime(); // findClass 方法是子类实现的，用于加载指定名称的类 // ⽗类加载器没有加载过，就⾃⾏解析class⽂件加载 c = findClass(name); // this is the defining class loader; record the stats // 性能统计：记录类加载过程中的时间消耗和调用次数，便于监控和优化。 sun.misc.PerfCounter.getParentDelegationTime().addTime(t1 - t0); sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1); sun.misc.PerfCounter.getFindClasses().increment(); &#125; &#125; // 默认情况下，双亲委派模型只进⾏了验证和准备阶段，⽽不进⾏解析(如链接、初始化) if (resolve) &#123; resolveClass(c); &#125; return c; &#125;&#125; 该方法实现了类加载的基本逻辑，包括检查类是否已加载、委托父类加载器加载、自行加载类以及解析类等步骤。该方法是 Java 类加载机制的核心部分之一，遵循双亲委派模型。 这个⽅法是protected声明的，意味着，是可以被⼦类覆盖的，所以，双亲委派机制也是可以被打破的，如Tomcat⼦类重写这个⽅法，并使⽤自己的类加载逻辑。 沙箱保护机制 沙箱保护机制是 Java 虚拟机提供的一种安全机制，用于保护应用程序免受恶意代码的攻击。 java.lang.ClassLoader 类的 preDefineClass 方法是沙箱保护机制的核心实现 1234567891011121314151617181920212223242526// 这个方法在双亲委派模型之前被调用，用于在加载类之前进行一些预处理操作。// 参数：// name: 要加载的类的全限定名。// pd: 提供的保护域信息，可能为 null。private ProtectionDomain preDefineClass(String name, ProtectionDomain pd) &#123; if (!checkName(name)) throw new NoClassDefFoundError(&quot;IllegalName: &quot; + name); // Note: Checking logic in java.lang.invoke.MemberName.checkForTypeAlias // relies on the fact that spoofing is impossible if a class has a name // of the form &quot;java.*&quot; if ((name != null) &amp;&amp; name.startsWith(&quot;java.&quot;)) &#123; throw new SecurityException (&quot;Prohibited package name: &quot; + name.substring(0, name.lastIndexOf(&#x27;.&#x27;))); &#125; if (pd == null) &#123; pd = defaultDomain; &#125; if (name != null) checkCerts(name, pd.getCodeSource()); return pd; &#125; 这个方法 preDefineClass 的作用是在类被定义之前进行一些安全检查和准备工作，确保类的合法性与安全性。它通常用于自定义类加载器中，以增强类加载过程中的安全控制。 方法作用详解： 1.防止定义非法类名的类（如 java.* 包下的类）： 如果尝试加载的类属于 java. 开头的标准包（如 java.lang, java.util 等），会抛出 SecurityException。 这是为了防止用户自定义类伪装成 Java 核心类库中的类，从而造成安全风险。 2.校验类名合法性： 调用 checkName(name) 检查类名是否合法（例如不能包含 /、非法字符等），若不合法则抛出 NoClassDefFoundError。 3.证书一致性校验（签名一致性校验）： 如果类有名称且提供了 ProtectionDomain，会调用 checkCerts(name, codeSource) 来确保当前类的签名与其所在包中其他类的签名一致。 防止同一包中混入不同签名的类，避免潜在的恶意篡改。 4.设置默认保护域（ProtectionDomain）： 如果传入的 ProtectionDomain 为 null，则使用类加载器的默认域 defaultDomain。 Linking链接过程 在ClassLoader的loadClass⽅法中，还有⼀个不起眼的步骤，resolveClass。这是⼀个native⽅法。⽽其实现的过程称为linking-链接。 链接过程的实现功能如下图： 其中关于半初始化状态就是JDK在处理⼀个类的static静态属性时，会先给这个属性分配⼀个默认值，作⽤是占住内存。然后等连接过程完成后，在后⾯的初始化阶段，再将静态属性从默认值修改为指定的初始值。 符号引⽤和直接引⽤ 如果A类中有⼀个静态属性，引⽤了另⼀个B类。那么在对类进⾏初始化的过程中，因为A和B这两个类都没有初始化，JVM并不知道A和B这两个类的具体地址。所以这时，在A类中，只能创建⼀个不知道具体地址的引⽤，指向B类。这个引⽤就称为符号引⽤。⽽当A类和B类都完成初始化后，JVM⾃然就需要将这个符号引⽤转⽽指向B类具体的内存地址，这个引⽤就称为直接引⽤。 来看一个有意思的示例 1234567891011121314151617181920class Apple &#123; // 静态变量按声明顺序初始化 // 构造方法初始化apple对象时，price还没有被初始化，处于链接过程中的准备阶段，即半初始化状态，所以price为默认值0.0 static Apple apple = new Apple(10); // 解决方法是将price声明在apple的上面即可 static double price = 20.00; double totalpay; public Apple(double discount) &#123; System.out.println(&quot;====&quot; + price); totalpay = price - discount; &#125;&#125;public class PriceTest &#123; public static void main(String[] args) &#123; System.out.println(Apple.apple.totalpay); // -10.0 &#125;&#125; 这里有一个有意思的问题，就是只有当loadClass方法中的resolve参数为true时resolveClass方法才会被调用，但是大部分情况下，resolve参数都是false，这不是强制限制而是出于以下原因： 避免递归解析中出现错误或死循环 在类的解析过程中，如果该类引用了另一个还没加载的类，立即解析可能会导致无限递归或加载顺序问题。通过延迟解析，可以更好地控制加载流程。 提高加载效率 加载类可能不一定马上就用到所有方法、字段等符号引用，推迟解析可以提高性能，尤其在批量加载很多类时。 更灵活地处理类的依赖 开发者可以先加载类，稍后根据需要再解析。例如，在自定义类加载器中，可能先判断类是否已经存在、是否需要被增强（比如字节码增强），再决定是否解析。 通过类加载器引⼊外部Jar包 虽然通常我们会将依赖的 jar 包直接放入项目的 classpath 中（比如通过构建工具如 Maven 或 Gradle 管理），但在某些特定场景下，我们确实需要动态地通过 URLClassLoader 加载外部 jar 包，这是 Java 提供的一种更灵活的类加载机制。 以下是一些必须或推荐使用 URLClassLoader 的典型应用场景： 1. 插件机制（Plugin System） 场景说明： 系统支持用户自定义插件（如 IDE 插件、浏览器扩展、游戏 mod），这些插件在运行时才加载，项目本身在编译期并不知道有哪些插件。 举例： Eclipse 或 IntelliJ 的插件系统 Minecraft 的 mod 加载器 Spring Boot Devtools 重新加载机制 为什么不能直接放入 classpath？ 因为插件是动态发现和加载的，不是编译时确定的。 2. 热部署 / 动态加载类 场景说明： 你想在应用运行过程中加载新的 jar 或类，比如热更新一个模块而无需重启服务。 举例： Web 容器（如 Tomcat）的应用重新部署 使用 URLClassLoader 加载某个模块的新版本以实现热替换 为什么不能放入 classpath？ classpath 在启动时就固定了，不能动态添加；而 URLClassLoader 可以运行时加载新 jar。 3. 多版本隔离 场景说明： 你希望不同的模块使用同一个库的不同版本，但 classpath 无法支持两个版本的同一个类。 举例： 一个服务器运行多个服务实例，它们分别依赖 log4j 的不同版本 一个系统的插件 A 使用 fastjson 1.x，插件 B 使用 fastjson 2.x 为什么不能放入 classpath？ classpath 是共享的，会发生类冲突。使用多个 URLClassLoader，可实现类隔离。 4. 脚本或用户上传代码执行 场景说明： 系统允许用户上传 jar 或 class 文件，然后在服务端执行其中的类逻辑。 举例： 在线编程平台（如 LeetCode 后端） 用户上传算法 jar，平台运行并返回结果 为什么不能放入 classpath？ 用户上传内容是动态的，系统在运行前无法预知。 5. 实现类的延迟加载（节省资源） 场景说明： 某些类/模块体积较大或依赖较多，不希望在程序启动时就加载，只有真正使用时再加载。 举例： 大型桌面应用（如 IntelliJ）在打开某个功能模块时才加载相应 jar 总结 场景 使用 URLClassLoader 的原因 插件系统 插件动态加载，不在项目编译时可知 热部署 动态替换模块，无需重启 多版本共存 避免类冲突，实现类加载隔离 用户上传 jar 内容动态生成，classpath 无法预先配置 延迟加载模块 启动更快，节省内存 如果你是在做框架设计或需要动态扩展能力的场景，理解并使用 URLClassLoader 会非常有帮助。 场景假设 调用外部jar 我们有一个外部 jar 文件：hello-plugin.jar，它包含一个类： 12345678// 这个类编译后打包进 hello-plugin.jarpackage com.example.plugin;public class HelloPlugin &#123; public void sayHello(String name) &#123; System.out.println(&quot;Hello from plugin! :&quot; + name); &#125;&#125; 主程序使用 URLClassLoader 动态加载这个 jar 12345678910111213141516171819202122232425262728import java.io.File;import java.lang.reflect.Method;import java.net.URL;import java.net.URLClassLoader;public class PluginLoader &#123; public static void main(String[] args) throws Exception &#123; // 外部 jar 的路径 File jarFile = new File(&quot;plugins/hello-plugin.jar&quot;); URL jarUrl = jarFile.toURI().toURL(); // HTTPS jar 的 URL // URL jarUrl = new URL(&quot;https://your-domain.com/libs/hello-plugin.jar&quot;); // 构建 URLClassLoader（也可以设置父加载器） URLClassLoader classLoader = new URLClassLoader(new URL[]&#123;jarUrl&#125;); // 加载插件类 Class&lt;?&gt; clazz = classLoader.loadClass(&quot;com.example.plugin.HelloPlugin&quot;); // 创建实例并调用方法 Object plugin = clazz.getDeclaredConstructor().newInstance(); Method sayHello = clazz.getMethod(&quot;sayHello&quot;, String.class); sayHello.invoke(plugin, &quot;World&quot;); // 关闭 ClassLoader（Java 7+ 推荐） classLoader.close(); &#125;&#125; 运行时动态编译 Java 源代码 我们有一个 java 代码片段： 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364import javax.tools.JavaCompiler;import javax.tools.ToolProvider;import java.io.File;import java.io.FileWriter;import java.lang.reflect.Method;import java.net.URL;import java.net.URLClassLoader;import java.nio.file.Files;import java.nio.file.Path;public class DynamicJavaRunner &#123; public static void main(String[] args) throws Exception &#123; String className = &quot;com.example.dynamic.Hello&quot;; // Java 源代码 String sourceCode = &quot;package com.example.dynamic;\\n&quot; + &quot;\\n&quot; + &quot;public class Hello &#123;\\n&quot; + &quot; public void say() &#123;\\n&quot; + &quot; System.out.println(\\&quot;Hello from dynamic source!\\&quot;);\\n&quot; + &quot; &#125;\\n&quot; + &quot;&#125;\\n&quot;; // 创建临时目录 Path tempDir = Files.createTempDirectory(&quot;dynamic-classes&quot;); File outputDir = tempDir.toFile(); // System.out.println(&quot;临时目录：&quot; + outputDir.getAbsolutePath()); // 创建 .java 文件 File javaFile = new File(outputDir, &quot;com/example/dynamic/Hello.java&quot;); javaFile.getParentFile().mkdirs(); try (FileWriter writer = new FileWriter(javaFile)) &#123; writer.write(sourceCode); &#125; // 编译 Java 文件 JavaCompiler compiler = ToolProvider.getSystemJavaCompiler(); if (compiler == null) &#123; System.err.println(&quot;请用 JDK 而非 JRE 运行！&quot;); return; &#125; int result = compiler.run(null, null, null, javaFile.getPath()); if (result != 0) &#123; System.err.println(&quot;编译失败！&quot;); return; &#125; // 加载类并调用 URLClassLoader classLoader = new URLClassLoader(new URL[]&#123;outputDir.toURI().toURL()&#125;); Class&lt;?&gt; clazz = classLoader.loadClass(className); Object instance = clazz.getDeclaredConstructor().newInstance(); Method method = clazz.getMethod(&quot;say&quot;); method.invoke(instance); // 清理（可选） classLoader.close(); // 删除临时目录 Files.walk(outputDir.toPath()) .sorted(Comparator.reverseOrder()) // 先删文件，再删目录 .map(Path::toFile) .forEach(File::delete); &#125;&#125; 关键点说明 机制 说明 JavaCompiler JDK 自带的编译器（tools.jar） ToolProvider.getSystemJavaCompiler() 只能在 JDK 环境中工作，JRE 无法使用 URLClassLoader 用于加载编译后的 .class 文件 FileWriter 保存代码为临时 Java 文件 自定义类加载器 要自定义 ClassLoader，只需要继承于 ClassLoader 或者 SecureClassLoader，并重写 findClass() 方法即可 示例：我们对上面的代码进行升级，不创建临时文件，而是在内存中编译代码，并从内存中加载字节码，而不依赖磁盘文件，更高效也更适合生产环境中动态类加载（如在线代码执行、脚本引擎等）。 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114import javax.tools.*;import java.io.*;import java.net.URI;import java.util.*;import java.lang.reflect.*;public class InMemoryJavaRunner &#123; public static void main(String[] args) throws Exception &#123; String className = &quot;com.example.dynamic.Hello&quot;; String sourceCode = &quot;package com.example.dynamic;\\n&quot; + &quot;public class Hello &#123;\\n&quot; + &quot; public void say() &#123;\\n&quot; + &quot; System.out.println(\\&quot;Hello from memory compiled class!\\&quot;);\\n&quot; + &quot; &#125;\\n&quot; + &quot;&#125;&quot;; // 获取系统 Java 编译器 JavaCompiler compiler = ToolProvider.getSystemJavaCompiler(); if (compiler == null) &#123; System.err.println(&quot;请使用 JDK 运行此程序（非 JRE）&quot;); return; &#125; // 准备编译源代码：一个 JavaFileObject 表示源代码 JavaFileObject sourceFile = new JavaSourceFromString(className, sourceCode); // 创建自定义的内存文件管理器（替代标准的磁盘管理器） StandardJavaFileManager standardFileManager = compiler.getStandardFileManager(null, null, null); MemoryJavaFileManager fileManager = new MemoryJavaFileManager(standardFileManager); // 执行编译任务 JavaCompiler.CompilationTask task = compiler.getTask(null, fileManager, null, null, null, Collections.singletonList(sourceFile)); boolean success = task.call(); if (!success) &#123; System.err.println(&quot;编译失败！&quot;); return; &#125; // 加载编译后的类 Map&lt;String, byte[]&gt; classBytes = fileManager.getClassBytes(); InMemoryClassLoader classLoader = new InMemoryClassLoader(classBytes); Class&lt;?&gt; clazz = classLoader.loadClass(className); Object instance = clazz.getDeclaredConstructor().newInstance(); Method method = clazz.getMethod(&quot;say&quot;); method.invoke(instance); &#125; // 用于表示内存中的 Java 源代码 static class JavaSourceFromString extends SimpleJavaFileObject &#123; final String code; JavaSourceFromString(String className, String code) &#123; super(URI.create(&quot;string:///&quot; + className.replace(&#x27;.&#x27;, &#x27;/&#x27;) + Kind.SOURCE.extension), Kind.SOURCE); this.code = code; &#125; public CharSequence getCharContent(boolean ignoreEncodingErrors) &#123; return code; &#125; &#125; // 将编译的 class 文件保存在内存中（不是文件系统） static class MemoryJavaFileManager extends ForwardingJavaFileManager&lt;StandardJavaFileManager&gt; &#123; private final Map&lt;String, ByteArrayOutputStream&gt; classOutputBuffers = new HashMap&lt;&gt;(); MemoryJavaFileManager(StandardJavaFileManager standardManager) &#123; super(standardManager); &#125; @Override public JavaFileObject getJavaFileForOutput(Location location, String className, JavaFileObject.Kind kind, FileObject sibling) &#123; ByteArrayOutputStream outputStream = new ByteArrayOutputStream(); classOutputBuffers.put(className, outputStream); return new SimpleJavaFileObject( URI.create(&quot;mem:///&quot; + className.replace(&#x27;.&#x27;, &#x27;/&#x27;) + kind.extension), kind) &#123; @Override public OutputStream openOutputStream() &#123; return outputStream; &#125; &#125;; &#125; public Map&lt;String, byte[]&gt; getClassBytes() &#123; Map&lt;String, byte[]&gt; result = new HashMap&lt;&gt;(); for (Map.Entry&lt;String, ByteArrayOutputStream&gt; entry : classOutputBuffers.entrySet()) &#123; result.put(entry.getKey(), entry.getValue().toByteArray()); &#125; return result; &#125; &#125; // 自定义 ClassLoader，用于从内存中加载字节码 static class InMemoryClassLoader extends ClassLoader &#123; private final Map&lt;String, byte[]&gt; classBytes; public InMemoryClassLoader(Map&lt;String, byte[]&gt; classBytes) &#123; super(ClassLoader.getSystemClassLoader()); this.classBytes = classBytes; &#125; @Override protected Class&lt;?&gt; findClass(String name) throws ClassNotFoundException &#123; // 从内存中获取字节码 byte[] bytes = classBytes.get(name); if (bytes == null) &#123; return super.findClass(name); &#125; // 定义类并返回，一定要使用 defineClass 方法 return defineClass(name, bytes, 0, bytes.length); &#125; &#125;&#125; 进一步升级：我们现在将这个系统扩展为支持多个类同时动态编译、内存加载并执行。这对于需要处理多个类（例如接口 + 实现、内部依赖等）非常实用。 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127import javax.tools.*;import java.io.*;import java.net.URI;import java.util.*;import java.lang.reflect.*;// 主类public class MultiClassInMemoryCompiler &#123; public static void main(String[] args) throws Exception &#123; // 准备多个类的源代码 Map&lt;String, String&gt; sources = new HashMap&lt;&gt;(); sources.put(&quot;com.example.api.Greeter&quot;, &quot;package com.example.api;\\n&quot; + &quot;public interface Greeter &#123;\\n&quot; + &quot; void greet();\\n&quot; + &quot;&#125;\\n&quot;); sources.put(&quot;com.example.impl.EnglishGreeter&quot;, &quot;package com.example.impl;\\n&quot; + &quot;import com.example.api.Greeter;\\n&quot; + &quot;public class EnglishGreeter implements Greeter &#123;\\n&quot; + &quot; public void greet() &#123;\\n&quot; + &quot; System.out.println(\\&quot;Hello from EnglishGreeter!\\&quot;);\\n&quot; + &quot; &#125;\\n&quot; + &quot;&#125;\\n&quot;); String entryClassName = &quot;com.example.impl.EnglishGreeter&quot;; // 编译 Map&lt;String, byte[]&gt; compiledClasses = compile(sources); if (compiledClasses == null) &#123; System.err.println(&quot;编译失败&quot;); return; &#125; // 加载并执行 InMemoryClassLoader classLoader = new InMemoryClassLoader(compiledClasses); Class&lt;?&gt; clazz = classLoader.loadClass(entryClassName); Object obj = clazz.getDeclaredConstructor().newInstance(); Method method = clazz.getMethod(&quot;greet&quot;); method.invoke(obj); &#125; // 编译器入口，支持多个类 public static Map&lt;String, byte[]&gt; compile(Map&lt;String, String&gt; sources) &#123; JavaCompiler compiler = ToolProvider.getSystemJavaCompiler(); if (compiler == null) &#123; System.err.println(&quot;请使用 JDK 运行&quot;); return null; &#125; List&lt;JavaFileObject&gt; compilationUnits = new ArrayList&lt;&gt;(); for (Map.Entry&lt;String, String&gt; entry : sources.entrySet()) &#123; compilationUnits.add(new JavaSourceFromString(entry.getKey(), entry.getValue())); &#125; StandardJavaFileManager stdManager = compiler.getStandardFileManager(null, null, null); MemoryJavaFileManager memManager = new MemoryJavaFileManager(stdManager); JavaCompiler.CompilationTask task = compiler.getTask(null, memManager, null, null, null, compilationUnits); boolean success = task.call(); return success ? memManager.getClassBytes() : null; &#125; // 源文件表示（Java 代码以字符串提供） static class JavaSourceFromString extends SimpleJavaFileObject &#123; final String code; JavaSourceFromString(String className, String code) &#123; super(URI.create(&quot;string:///&quot; + className.replace(&#x27;.&#x27;, &#x27;/&#x27;) + Kind.SOURCE.extension), Kind.SOURCE); this.code = code; &#125; @Override public CharSequence getCharContent(boolean ignoreEncodingErrors) &#123; return code; &#125; &#125; // 内存中的编译输出管理器 static class MemoryJavaFileManager extends ForwardingJavaFileManager&lt;StandardJavaFileManager&gt; &#123; private final Map&lt;String, ByteArrayOutputStream&gt; classOutputBuffers = new HashMap&lt;&gt;(); MemoryJavaFileManager(StandardJavaFileManager standardManager) &#123; super(standardManager); &#125; @Override public JavaFileObject getJavaFileForOutput(Location location, String className, JavaFileObject.Kind kind, FileObject sibling) &#123; ByteArrayOutputStream outputStream = new ByteArrayOutputStream(); classOutputBuffers.put(className, outputStream); return new SimpleJavaFileObject( URI.create(&quot;mem:///&quot; + className.replace(&#x27;.&#x27;, &#x27;/&#x27;) + kind.extension), kind) &#123; @Override public OutputStream openOutputStream() &#123; return outputStream; &#125; &#125;; &#125; public Map&lt;String, byte[]&gt; getClassBytes() &#123; Map&lt;String, byte[]&gt; result = new HashMap&lt;&gt;(); for (Map.Entry&lt;String, ByteArrayOutputStream&gt; entry : classOutputBuffers.entrySet()) &#123; result.put(entry.getKey(), entry.getValue().toByteArray()); &#125; return result; &#125; &#125; // 用于加载内存中的 class static class InMemoryClassLoader extends ClassLoader &#123; private final Map&lt;String, byte[]&gt; classBytes; public InMemoryClassLoader(Map&lt;String, byte[]&gt; classBytes) &#123; super(ClassLoader.getSystemClassLoader()); this.classBytes = classBytes; &#125; @Override protected Class&lt;?&gt; findClass(String name) throws ClassNotFoundException &#123; byte[] bytes = classBytes.get(name); if (bytes == null) return super.findClass(name); return defineClass(name, bytes, 0, bytes.length); &#125; &#125;&#125; 打破双亲委派，实现同类多版本共存 假设我们有同一个jar包的不同版本，比如：a-1.0.jar和a-2.0.jar，他们具有同名的 DemoClass类 ,系统classpath中引入的是 a-1.0.jar，而此时我们通过⾃定的ClassLoader加载 a-2.0.jar，并调用 DemoClass类 ，我们会发现，⾃定的ClassLoader加载的类依旧是 a-1.0.jar 中的类，而不是 a-2.0.jar 中的类。 为什么会出现这种情况呢？这就是因为JDK的双亲委派机制。⾃定的ClassLoader的parent属性指向的是JDK内的AppClassLoader，⽽ AppClassLoader 会加载系统当中的所有代码，就包括 a-1.0.jar中的 DemoClass类。这时，⾃定的ClassLoader去加载 DemoClass类时，通过双亲委派向上查找，⾃然加载出来的就是APPClassloader中的DemoClass了。 如何打破双亲委派呢？我们可以通过重写 loadClass()方法，来打破双亲委派，实现类⽂件的加载。 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152import java.io.ByteArrayOutputStream;import java.io.InputStream;import java.net.URL;import java.net.URLConnection;import java.security.SecureClassLoader;public class CustomClassLoader extends SecureClassLoader &#123; private URL jarUrl; public CustomClassLoader(URL jarUrl) &#123; // 创建一个独立的子类加载器，只加载指定 JAR this.jarUrl = jarUrl; &#125; @Override public Class&lt;?&gt; loadClass(String name, boolean resolve) throws ClassNotFoundException &#123; // 把双亲委派机制反过来，先到⼦类加载器中加载，加载不到再去⽗类加载器中加载。 synchronized (getClassLoadingLock(name)) &#123; // 如果类已加载，则直接返回 Class&lt;?&gt; loadedClass = findLoadedClass(name); if (loadedClass == null) &#123; loadedClass = findClass(name); &#125; else &#123; // 委派给父类加载器 loadedClass = super.loadClass(name, resolve); &#125; return loadedClass; &#125; &#125; @Override protected Class&lt;?&gt; findClass(String name) &#123; int code; try &#123; // 访问jar包的url URLConnection urlConnection = jarUrl.openConnection(); urlConnection.setUseCaches(false); InputStream is = urlConnection.getInputStream(); ByteArrayOutputStream bos = new ByteArrayOutputStream(); while ((code = is.read()) != -1) &#123; bos.write(code); &#125; byte[] data = bos.toByteArray(); is.close(); bos.close(); return defineClass(name, data, 0, data.length); &#125; catch (Exception e) &#123; return null; &#125; &#125;&#125; 测试代码 12345678910111213141516import java.io.File;import java.net.URL;public class Test &#123; public static void main(String[] args) throws Exception &#123; File jarFile = new File(&quot;path/to/a-2.0.jar&quot;); URL jarUrl = jarFile.toURI().toURL(); CustomClassLoader loader = new CustomClassLoader(jarUrl); // 加载 DemoClass Class&lt;?&gt; clazz = loader.loadClass(&quot;com.example.DemoClass&quot;); Object obj = clazz.getDeclaredConstructor().newInstance(); clazz.getMethod(&quot;print&quot;).invoke(obj); &#125;&#125; 打破双亲委派机制的典型场景 Tomcat类加载器 CommonClassLoader：Tomcat最基本的类加载器，加载路径中的class可以被Tomcat容器本身以及各个Webapp访问； CatalinaClassLoader：Tomcat容器私有的类加载器，加载路径中的class对于Webapp不可⻅； SharedClassLoader：各个Webapp共享的类加载器，加载路径中的class对于所有Webapp可⻅，但是对于Tomcat容器不可⻅； WebappClassLoader：各个Webapp私有的类加载器，加载路径中的class只对当前Webapp可⻅，⽐如加载war包⾥相关的类，每个war包应⽤都有⾃⼰的WebappClassLoader，实现相互隔离，⽐如不同war包应⽤引⼊了不同的spring版本，这样实现就能加载各⾃的spring版本； Jsp类加载器：针对每个JSP⻚⾯创建⼀个加载器。这个加载器⽐较轻量级，所以Tomcat还实现了热加载，也就是JSP只要修改了，就创建⼀个新的加载器，从⽽实现了JSP⻚⾯的热更新。","summary":"摘要 本文介绍JVM的类加载器 The Java® Virtual Machine Specification 版本jdk1.8","date_published":"2025-05-08T13:30:05.000Z","tags":["技术","jvm","jvm"]},{"id":"https://blog.hanqunfeng.com/2025/04/22/elasticsearch-06-api-aggs/","url":"https://blog.hanqunfeng.com/2025/04/22/elasticsearch-06-api-aggs/","title":"Elasticsearch 的 REST APIs:聚合查询","content_html":"<!--\n **加粗**\n *斜体*\n ***加粗并斜体***\n ~~删除线~~\n ==突出显示==\n `突出显示(推荐)`\n ++下划线++\n ~下标~\n ^上标^\n 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.\n 图片设置宽度和高度(通过uPic上传后，需要将upic修改过为blog，用于添加水印) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)\n\n +++ **点击折叠**\n 这是被隐藏的内容\n +++\n\n::: tips success warning danger\n这里是容器内的内容\n:::\n\n% note info % success warning danger\n这里是容器内的内容\n% endnote %\n\n引用本地其它文章连接{}\n 大括号开始% post_link 文件名称(不包含.md) %大括号结束\n -->\n<h2 id=\"摘要\">摘要</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>本文介绍 Elasticsearch 的 REST APIs：聚合查询</p>\n</li>\n<li class=\"lvl-2\">\n<p>Elasticsearch版本8.17.3</p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/8.17/rest-apis.html\">官方文档:REST APIs</a></p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/8.17/search-aggregations.html\">官方文档:Aggregations</a></p>\n</li>\n<li class=\"lvl-2\">\n<a href=\"/2025/04/17/elasticsearch-05-api/\" title=\"Elasticsearch 的 REST APIs\">Elasticsearch 的 REST APIs</a>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"聚合查询\">聚合查询</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations.html\">聚合查询</a>，可以让我们极其方便的实现对索引数据的统计、分析、运算等操作。</p>\n</li>\n<li class=\"lvl-2\">\n<p>基本语法包括以下部分：</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-4\">查询条件：指定需要聚合的文档，可以使用标准的 Elasticsearch 查询语法，如 term、match、range 等等。</li>\n<li class=\"lvl-4\">聚合函数：指定要执行的聚合操作，如 sum、avg、min、max、terms、date_histogram 等等。每个聚合命令都会生成一个聚合结果。</li>\n<li class=\"lvl-4\">聚合嵌套：聚合命令可以嵌套，以便更细粒度地分析数据。</li>\n</ul>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET &lt;index_name&gt;/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;&lt;aggs_name&gt;&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;&lt;agg_type&gt;&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;&lt;field_name&gt;&quot;</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\"># 说明</span></span><br><span class=\"line\">  <span class=\"comment\"># aggs：聚合的根节点，固定写法</span></span><br><span class=\"line\">  <span class=\"comment\"># aggs_name：聚合函数的名称，自己随意定义</span></span><br><span class=\"line\">  <span class=\"comment\"># agg_type：聚合种类，比如是桶聚合（terms）或者是指标聚合（avg、sum、min、max等）</span></span><br><span class=\"line\">  <span class=\"comment\"># field_name：字段名称或者叫域名。</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>聚合的分类</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-4\">Metric Aggregation：—些数学运算，可以对文档字段进行统计分析，类比Mysql中的 min(), max(), sum() 操作。</li>\n<li class=\"lvl-4\">Bucket Aggregation：一些满足特定条件的文档的集合放置到一个桶里，每一个桶关联一个key，类比Mysql中的group by操作。</li>\n<li class=\"lvl-4\">Pipeline Aggregation：对其他的聚合结果进行二次聚合</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"示例数据准备\">示例数据准备</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>我们需要先准备一些数据，才能进行聚合分析。</p>\n</li>\n<li class=\"lvl-2\">\n<p>创建索引</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 如果存在先删除</span></span><br><span class=\"line\">curl -X DELETE -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建索引</span></span><br><span class=\"line\">curl -X PUT -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;settings&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;number_of_shards&quot;:&quot;1&quot;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;number_of_replicas&quot;:&quot;2&quot;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;mappings&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;properties&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;category&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">          &quot;type&quot;:&quot;keyword&quot;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;price&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">          &quot;type&quot;:&quot;double&quot;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;count&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">          &quot;type&quot;:&quot;integer&quot;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;title&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">          &quot;type&quot;:&quot;text&quot;,</span></span><br><span class=\"line\"><span class=\"string\">          &quot;analyzer&quot;:&quot;ik_max_word&quot;,</span></span><br><span class=\"line\"><span class=\"string\">          &quot;search_analyzer&quot;:&quot;ik_smart&quot;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;remark&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;type&quot;:&quot;text&quot;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;analyzer&quot;:&quot;ik_max_word&quot;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;search_analyzer&quot;:&quot;ik_smart&quot;</span></span><br><span class=\"line\"><span class=\"string\">      &#125;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;address&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;type&quot;: &quot;text&quot;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;analyzer&quot;: &quot;ik_max_word&quot;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;fields&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">          &quot;keyword&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">            &quot;type&quot;: &quot;keyword&quot;</span></span><br><span class=\"line\"><span class=\"string\">          &#125;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;</span></span><br><span class=\"line\"><span class=\"string\">      &#125;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;tags&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;type&quot;: &quot;keyword&quot;</span></span><br><span class=\"line\"><span class=\"string\">      &#125;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;created_at&quot;: &#123;&quot;type&quot;: &quot;date&quot;, &quot;format&quot;: &quot;yyyy-MM-dd HH:mm:ss&quot;&#125;</span></span><br><span class=\"line\"><span class=\"string\">      &#125;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">  &#125;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 插入数据</span></span><br><span class=\"line\">curl -X POST -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/_bulk&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123; &quot;index&quot;: &#123; &quot;_index&quot;: &quot;shopping&quot;, &quot;_id&quot;: &quot;1&quot; &#125; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;category&quot;: &quot;electronics&quot;, &quot;price&quot;: 999.99, &quot;count&quot;: 10, &quot;title&quot;: &quot;Smartphone X - 128GB&quot;, &quot;remark&quot;: &quot;This latest Smartphone X comes with a powerful processor and high-resolution camera.&quot;, &quot;address&quot;: &quot;广州天河公园&quot;, &quot;tags&quot;: [&quot;latest&quot;, &quot;smartphone&quot;, &quot;technology&quot;], &quot;created_at&quot;: &quot;2025-04-22 03:30:02&quot; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;index&quot;: &#123; &quot;_index&quot;: &quot;shopping&quot;, &quot;_id&quot;: &quot;2&quot; &#125; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;category&quot;: &quot;fashion&quot;, &quot;price&quot;: 49.99, &quot;count&quot;: 25, &quot;title&quot;: &quot;Designer T-shirt&quot;, &quot;remark&quot;: &quot;Trendy designer T-shirt made with high quality fabric.&quot;, &quot;address&quot;: &quot;广州荔湾大厦&quot;, &quot;tags&quot;: [&quot;clothing&quot;, &quot;designer&quot;, &quot;style&quot;], &quot;created_at&quot;: &quot;2025-04-21 12:15:00&quot; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;index&quot;: &#123; &quot;_index&quot;: &quot;shopping&quot;, &quot;_id&quot;: &quot;3&quot; &#125; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;category&quot;: &quot;home_appliances&quot;, &quot;price&quot;: 299.99, &quot;count&quot;: 5, &quot;title&quot;: &quot;Robot Vacuum Cleaner&quot;, &quot;remark&quot;: &quot;Efficient robot vacuum cleaner with smart navigation.&quot;, &quot;address&quot;: &quot;广州白云山公园&quot;, &quot;tags&quot;: [&quot;appliances&quot;, &quot;vacuum&quot;, &quot;robot&quot;], &quot;created_at&quot;: &quot;2025-04-20 08:45:30&quot; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;index&quot;: &#123; &quot;_index&quot;: &quot;shopping&quot;, &quot;_id&quot;: &quot;4&quot; &#125; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;category&quot;: &quot;books&quot;, &quot;price&quot;: 19.99, &quot;count&quot;: 100, &quot;title&quot;: &quot;Inspirational Novel&quot;, &quot;remark&quot;: &quot;A gripping novel that inspires and motivates.&quot;, &quot;address&quot;: &quot;321 Book Rd, Shenzhen, China&quot;, &quot;tags&quot;: [&quot;book&quot;, &quot;novel&quot;, &quot;inspiration&quot;], &quot;created_at&quot;: &quot;2025-04-19 10:05:00&quot; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;index&quot;: &#123; &quot;_index&quot;: &quot;shopping&quot;, &quot;_id&quot;: &quot;5&quot; &#125; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;category&quot;: &quot;groceries&quot;, &quot;price&quot;: 3.99, &quot;count&quot;: 200, &quot;title&quot;: &quot;Organic Apples&quot;, &quot;remark&quot;: &quot;Fresh and crispy organic apples.&quot;, &quot;address&quot;: &quot;654 Grocery Ln, Chengdu, China&quot;, &quot;tags&quot;: [&quot;fruit&quot;, &quot;organic&quot;, &quot;healthy&quot;], &quot;created_at&quot;: &quot;2025-04-18 14:30:45&quot; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;index&quot;: &#123; &quot;_index&quot;: &quot;shopping&quot;, &quot;_id&quot;: &quot;6&quot; &#125; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;category&quot;: &quot;electronics&quot;, &quot;price&quot;: 1999.99, &quot;count&quot;: 15, &quot;title&quot;: &quot;Smartphone X - 256GB&quot;, &quot;remark&quot;: &quot;This latest Smartphone X comes with a powerful processor and high-resolution camera.&quot;, &quot;address&quot;: &quot;广州天河公园&quot;, &quot;tags&quot;: [&quot;latest&quot;, &quot;smartphone&quot;, &quot;technology&quot;], &quot;created_at&quot;: &quot;2025-04-22 03:30:02&quot; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#x27;</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"Metric-Aggregation-指标聚合\">Metric Aggregation(指标聚合)</h2>\n<h3 id=\"单值分析︰只输出一个分析结果\">单值分析︰只输出一个分析结果</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>min, max, avg, sum</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 最大值、最小值、平均值、总和</span></span><br><span class=\"line\">GET /shopping/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;size&quot;</span>: 0,  <span class=\"comment\"># 不返回文档，只返回聚合结果</span></span><br><span class=\"line\">  <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;max_price&quot;</span>: &#123; <span class=\"comment\"># 自定义名称，这里返回最大值</span></span><br><span class=\"line\">      <span class=\"string\">&quot;max&quot;</span>: &#123;     <span class=\"comment\"># 指标聚合函数名称</span></span><br><span class=\"line\">        <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;price&quot;</span> <span class=\"comment\"># 指标聚合字段</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">&quot;min_price&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;min&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;price&quot;</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">&quot;avg_price&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;avg&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;price&quot;</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">&quot;sum_price&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;sum&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;price&quot;</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Cardinality（类似distinct Count)</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /shopping/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;size&quot;</span>: 0, <span class=\"comment\"># 不返回文档，只返回聚合结果</span></span><br><span class=\"line\">  <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;cardinality_count&quot;</span>: &#123; <span class=\"comment\"># 自定义名称，返回去重后的数量</span></span><br><span class=\"line\">      <span class=\"string\">&quot;cardinality&quot;</span>: &#123;  <span class=\"comment\"># 指标聚合函数名称，cardinality表示去重</span></span><br><span class=\"line\">        <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;category&quot;</span> <span class=\"comment\"># 指标聚合字段，去重的字段</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"多值分析-输出多个分析结果\">多值分析:输出多个分析结果</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>stats（统计）, extended stats</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /shopping/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;size&quot;</span>: 0,</span><br><span class=\"line\">  <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;stats_price&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;stats&quot;</span>: &#123; <span class=\"comment\"># 指标聚合函数名称，stats表示统计，会返回多个指标</span></span><br><span class=\"line\">        <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;price&quot;</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\"># 结果</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;took&quot;</span>: 15,</span><br><span class=\"line\">  <span class=\"string\">&quot;timed_out&quot;</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;_shards&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;total&quot;</span>: 1,</span><br><span class=\"line\">    <span class=\"string\">&quot;successful&quot;</span>: 1,</span><br><span class=\"line\">    <span class=\"string\">&quot;skipped&quot;</span>: 0,</span><br><span class=\"line\">    <span class=\"string\">&quot;failed&quot;</span>: 0</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;hits&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;total&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;value&quot;</span>: 12,</span><br><span class=\"line\">      <span class=\"string\">&quot;relation&quot;</span>: <span class=\"string\">&quot;eq&quot;</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">&quot;max_score&quot;</span>: null,</span><br><span class=\"line\">    <span class=\"string\">&quot;hits&quot;</span>: []     <span class=\"comment\"># 因为设置size 为 0，所以返回的结果为空</span></span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;aggregations&quot;</span>: &#123; <span class=\"comment\"># 聚合结果</span></span><br><span class=\"line\">    <span class=\"string\">&quot;stats_price&quot;</span>: &#123; <span class=\"comment\"># 自定义名称，返回多组聚合结果</span></span><br><span class=\"line\">      <span class=\"string\">&quot;count&quot;</span>: 12,</span><br><span class=\"line\">      <span class=\"string\">&quot;min&quot;</span>: 3.99,</span><br><span class=\"line\">      <span class=\"string\">&quot;max&quot;</span>: 1999.99,</span><br><span class=\"line\">      <span class=\"string\">&quot;avg&quot;</span>: 562.1666666666666,</span><br><span class=\"line\">      <span class=\"string\">&quot;sum&quot;</span>: 6746</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>percentile （百分位）, percentile rank</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /shopping/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;size&quot;</span>: 0,</span><br><span class=\"line\">  <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;percentile_price&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;percentiles&quot;</span>: &#123; <span class=\"comment\"># 指标聚合函数名称，percentiles表示百分位数聚合计算</span></span><br><span class=\"line\">        <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;price&quot;</span>, <span class=\"comment\"># 指标聚合字段</span></span><br><span class=\"line\">        <span class=\"string\">&quot;percents&quot;</span>: [1, 5, 25, 50, 75, 95, 99] <span class=\"comment\"># 需要计算百分位数的数组</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\"># 百分位数是一个统计学概念，用于描述一个给定集合的排序值。例如：</span></span><br><span class=\"line\"><span class=\"comment\"># 第 1 百分位数表示数据中小于这个值的所有数据占总数的 1%。</span></span><br><span class=\"line\"><span class=\"comment\"># 第 50 百分位数（中位数）表示数据中的一半小于这个值，另一半大于这个值。</span></span><br><span class=\"line\"><span class=\"comment\"># 第 99 百分位数表示数据中小于这个值的所有数据占总数的 99%。</span></span><br><span class=\"line\"><span class=\"comment\"># 通过计算这些百分位数，你可以了解 price 字段在整个shopping索引中的分布情况，从而可以用于数据分析、趋势判断等。</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>top hits(排在前面的示例)</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /shopping/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;size&quot;</span>: 0,</span><br><span class=\"line\">  <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;top_hits&quot;</span>: &#123; <span class=\"comment\"># 自定义名称，返回排在前面的示例</span></span><br><span class=\"line\">      <span class=\"string\">&quot;top_hits&quot;</span>: &#123; <span class=\"comment\"># 指标聚合函数名称，top_hits表示返回排在前面的示例</span></span><br><span class=\"line\">        <span class=\"string\">&quot;sort&quot;</span>: [&#123;<span class=\"string\">&quot;price&quot;</span>: &#123;<span class=\"string\">&quot;order&quot;</span>: <span class=\"string\">&quot;desc&quot;</span>&#125;&#125;], <span class=\"comment\"># 排序，按照price字段降序排序</span></span><br><span class=\"line\">        <span class=\"string\">&quot;size&quot;</span>: 3 <span class=\"comment\"># 只返回前3个</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"Bucket-Aggregation-桶聚合\">Bucket Aggregation(桶聚合)</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>按照一定的规则，将文档分配到不同的桶中，从而达到分类的目的。</p>\n</li>\n<li class=\"lvl-2\">\n<p>ES提供的一些常见的 Bucket Aggregation。</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-4\">terms（词条）, range（范围）, date_range（日期范围）, ip_range（IP范围）, missing（缺失）, histogram（直方图）, date_histogram（日期直方图）, geo_distance（地理距离）, significant_terms（重要词条）, composite（组合）</li>\n</ul>\n</li>\n<li class=\"lvl-2\">\n<p>桶聚合可以用于各种场景，例如：</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-4\">对数据进行分组统计，比如按照地区、年龄段、性别等字段进行分组统计。</li>\n<li class=\"lvl-4\">对时间序列数据进行时间段分析，比如按照每小时、每天、每月、每季度、每年等时间段进行分析。</li>\n<li class=\"lvl-4\">对各种标签信息分类，并统计其数量。</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"terms（词条）\">terms（词条）</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>按照字段的值进行分组，并统计每个组的数量。</p>\n</li>\n<li class=\"lvl-2\">\n<p>示例：按照category字段进行分组，并统计每个组的数量。</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /shopping/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;size&quot;</span>: 0,</span><br><span class=\"line\">  <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;category_count&quot;</span>: &#123; <span class=\"comment\"># 自定义名称，返回每个组的数量</span></span><br><span class=\"line\">      <span class=\"string\">&quot;terms&quot;</span>: &#123; <span class=\"comment\"># 桶聚合函数名称，terms表示按照字段的值进行分组</span></span><br><span class=\"line\">        <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;category&quot;</span>, <span class=\"comment\"># 按照category字段进行分组，注意不能是text类型，否则会报错</span></span><br><span class=\"line\">        <span class=\"string\">&quot;size&quot;</span>: 10, <span class=\"comment\"># 只返回前10个，默认是10</span></span><br><span class=\"line\">        <span class=\"string\">&quot;order&quot;</span>: &#123;<span class=\"string\">&quot;_count&quot;</span>: <span class=\"string\">&quot;desc&quot;</span>&#125; <span class=\"comment\"># 按照数量降序排序，默认是desc，Bucket聚合会统计Bucket内的文档数量，记为_count，并且按照_count降序排序</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 结果</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;took&quot;</span>: 15,</span><br><span class=\"line\">  <span class=\"string\">&quot;timed_out&quot;</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;_shards&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;total&quot;</span>: 1,</span><br><span class=\"line\">    <span class=\"string\">&quot;successful&quot;</span>: 1,</span><br><span class=\"line\">    <span class=\"string\">&quot;skipped&quot;</span>: 0,</span><br><span class=\"line\">    <span class=\"string\">&quot;failed&quot;</span>: 0</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;hits&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;total&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;value&quot;</span>: 12,</span><br><span class=\"line\">      <span class=\"string\">&quot;relation&quot;</span>: <span class=\"string\">&quot;eq&quot;</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">&quot;max_score&quot;</span>: null,</span><br><span class=\"line\">    <span class=\"string\">&quot;hits&quot;</span>: []</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;aggregations&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;category_count&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;doc_count_error_upper_bound&quot;</span>: 0,  <span class=\"comment\"># 错误上界，表示在聚合过程中可能存在一些错误，但错误数量不会超过这个值</span></span><br><span class=\"line\">      <span class=\"string\">&quot;sum_other_doc_count&quot;</span>: 0,         <span class=\"comment\"># 表示在聚合过程中，除了返回的10个bucket，还有其他数量，这个数量就是sum_other_doc_count</span></span><br><span class=\"line\">      <span class=\"string\">&quot;buckets&quot;</span>: [                     <span class=\"comment\"># 返回的bucket</span></span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;key&quot;</span>: <span class=\"string\">&quot;electronics&quot;</span>,          <span class=\"comment\"># 分组的key</span></span><br><span class=\"line\">          <span class=\"string\">&quot;doc_count&quot;</span>: 4                 <span class=\"comment\"># 分组的数量</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;key&quot;</span>: <span class=\"string\">&quot;books&quot;</span>,</span><br><span class=\"line\">          <span class=\"string\">&quot;doc_count&quot;</span>: 2</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;key&quot;</span>: <span class=\"string\">&quot;fashion&quot;</span>,</span><br><span class=\"line\">          <span class=\"string\">&quot;doc_count&quot;</span>: 2</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;key&quot;</span>: <span class=\"string\">&quot;groceries&quot;</span>,</span><br><span class=\"line\">          <span class=\"string\">&quot;doc_count&quot;</span>: 2</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;key&quot;</span>: <span class=\"string\">&quot;home_appliances&quot;</span>,</span><br><span class=\"line\">          <span class=\"string\">&quot;doc_count&quot;</span>: 2</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      ]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>限定聚合范围</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /shopping/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;query&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;range&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;price&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;gte&quot;</span>: 100 <span class=\"comment\"># 限定价格范围</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;size&quot;</span>: 0,</span><br><span class=\"line\">  <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;category_count&quot;</span>: &#123; <span class=\"comment\"># 自定义名称，返回每个组的数量</span></span><br><span class=\"line\">      <span class=\"string\">&quot;terms&quot;</span>: &#123; <span class=\"comment\"># 桶聚合函数名称，terms表示按照字段的值进行分组</span></span><br><span class=\"line\">        <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;category&quot;</span>, <span class=\"comment\"># 按照category字段进行分组</span></span><br><span class=\"line\">        <span class=\"string\">&quot;size&quot;</span>: 10, <span class=\"comment\"># 只返回前10个，默认是10</span></span><br><span class=\"line\">        <span class=\"string\">&quot;order&quot;</span>: &#123;<span class=\"string\">&quot;_count&quot;</span>: <span class=\"string\">&quot;desc&quot;</span>&#125; <span class=\"comment\"># 按照数量降序排序，默认是desc，Bucket聚合会统计Bucket内的文档数量，记为_count，并且按照_count降序排序</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"range（范围）\">range（范围）</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>按照字段的值进行分组，并统计每个组的数量。</p>\n</li>\n<li class=\"lvl-2\">\n<p>示例：按照价格范围进行分组，并统计每个组的数量。</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /shopping/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;size&quot;</span>: 0,</span><br><span class=\"line\">  <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;price_range&quot;</span>: &#123; <span class=\"comment\"># 自定义名称，返回每个组的数量</span></span><br><span class=\"line\">      <span class=\"string\">&quot;range&quot;</span>: &#123; <span class=\"comment\"># 桶聚合函数名称，range表示按照字段的值进行分组</span></span><br><span class=\"line\">        <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;price&quot;</span>, <span class=\"comment\"># 按照price字段进行分组</span></span><br><span class=\"line\">        <span class=\"string\">&quot;ranges&quot;</span>: [</span><br><span class=\"line\">          &#123;<span class=\"string\">&quot;to&quot;</span>: 100&#125;, <span class=\"comment\"># 小于100</span></span><br><span class=\"line\">          &#123;<span class=\"string\">&quot;from&quot;</span>: 100, <span class=\"string\">&quot;to&quot;</span>: 200&#125;, <span class=\"comment\"># 100-200，包括100，不包括200</span></span><br><span class=\"line\">          &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;key&quot;</span>:<span class=\"string\">&quot;&gt;=200&quot;</span>, <span class=\"comment\"># 设定键值，用于区分不同范围</span></span><br><span class=\"line\">            <span class=\"string\">&quot;from&quot;</span>:200 <span class=\"comment\"># 大于等于200</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        ]</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\"># 结果</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;took&quot;</span>: 5,</span><br><span class=\"line\">  <span class=\"string\">&quot;timed_out&quot;</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;_shards&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;total&quot;</span>: 1,</span><br><span class=\"line\">    <span class=\"string\">&quot;successful&quot;</span>: 1,</span><br><span class=\"line\">    <span class=\"string\">&quot;skipped&quot;</span>: 0,</span><br><span class=\"line\">    <span class=\"string\">&quot;failed&quot;</span>: 0</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;hits&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;total&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;value&quot;</span>: 12,</span><br><span class=\"line\">      <span class=\"string\">&quot;relation&quot;</span>: <span class=\"string\">&quot;eq&quot;</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">&quot;max_score&quot;</span>: null,</span><br><span class=\"line\">    <span class=\"string\">&quot;hits&quot;</span>: []</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;aggregations&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;price_range&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;buckets&quot;</span>: [</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;key&quot;</span>: <span class=\"string\">&quot;*-100.0&quot;</span>,</span><br><span class=\"line\">          <span class=\"string\">&quot;to&quot;</span>: 100,</span><br><span class=\"line\">          <span class=\"string\">&quot;doc_count&quot;</span>: 6</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;key&quot;</span>: <span class=\"string\">&quot;100.0-200.0&quot;</span>,</span><br><span class=\"line\">          <span class=\"string\">&quot;from&quot;</span>: 100,</span><br><span class=\"line\">          <span class=\"string\">&quot;to&quot;</span>: 200,</span><br><span class=\"line\">          <span class=\"string\">&quot;doc_count&quot;</span>: 0</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;key&quot;</span>: <span class=\"string\">&quot;&gt;=200&quot;</span>,</span><br><span class=\"line\">          <span class=\"string\">&quot;from&quot;</span>: 200,</span><br><span class=\"line\">          <span class=\"string\">&quot;doc_count&quot;</span>: 6</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      ]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"date-range（日期范围）\">date_range（日期范围）</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>按照字段的值进行分组，并统计每个组的数量。</p>\n</li>\n<li class=\"lvl-2\">\n<p>示例：按照日期范围进行分组，并统计每个组的数量。</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /shopping/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;size&quot;</span>: 0,</span><br><span class=\"line\">  <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;date_range&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;date_range&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;created_at&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;ranges&quot;</span>: [</span><br><span class=\"line\">          &#123;<span class=\"string\">&quot;to&quot;</span>: <span class=\"string\">&quot;now-3d&quot;</span>&#125;, <span class=\"comment\"># 小于当前时间减去3天</span></span><br><span class=\"line\">          &#123;<span class=\"string\">&quot;from&quot;</span>: <span class=\"string\">&quot;now-3d&quot;</span>,<span class=\"string\">&quot;to&quot;</span>: <span class=\"string\">&quot;now-1d&quot;</span>&#125;, <span class=\"comment\"># 大于当前时间减去3天（包含），小于当前时间减去1天</span></span><br><span class=\"line\">          &#123;<span class=\"string\">&quot;key&quot;</span>:<span class=\"string\">&quot;now-1d&quot;</span>,<span class=\"string\">&quot;from&quot;</span>: <span class=\"string\">&quot;now-1d&quot;</span>&#125; <span class=\"comment\"># 大于当前时间减去1天（包含），并设置键值</span></span><br><span class=\"line\">        ]</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\"># 结果</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;took&quot;</span>: 3,</span><br><span class=\"line\">  <span class=\"string\">&quot;timed_out&quot;</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;_shards&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;total&quot;</span>: 1,</span><br><span class=\"line\">    <span class=\"string\">&quot;successful&quot;</span>: 1,</span><br><span class=\"line\">    <span class=\"string\">&quot;skipped&quot;</span>: 0,</span><br><span class=\"line\">    <span class=\"string\">&quot;failed&quot;</span>: 0</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;hits&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;total&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;value&quot;</span>: 12,</span><br><span class=\"line\">      <span class=\"string\">&quot;relation&quot;</span>: <span class=\"string\">&quot;eq&quot;</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">&quot;max_score&quot;</span>: null,</span><br><span class=\"line\">    <span class=\"string\">&quot;hits&quot;</span>: []</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;aggregations&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;date_range&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;buckets&quot;</span>: [</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;key&quot;</span>: <span class=\"string\">&quot;*-2025-04-20 03:14:17&quot;</span>,</span><br><span class=\"line\">          <span class=\"string\">&quot;to&quot;</span>: 1745118857610,</span><br><span class=\"line\">          <span class=\"string\">&quot;to_as_string&quot;</span>: <span class=\"string\">&quot;2025-04-20 03:14:17&quot;</span>,</span><br><span class=\"line\">          <span class=\"string\">&quot;doc_count&quot;</span>: 4</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;key&quot;</span>: <span class=\"string\">&quot;2025-04-20 03:14:17-2025-04-22 03:14:17&quot;</span>,</span><br><span class=\"line\">          <span class=\"string\">&quot;from&quot;</span>: 1745118857610,</span><br><span class=\"line\">          <span class=\"string\">&quot;from_as_string&quot;</span>: <span class=\"string\">&quot;2025-04-20 03:14:17&quot;</span>,</span><br><span class=\"line\">          <span class=\"string\">&quot;to&quot;</span>: 1745291657610,</span><br><span class=\"line\">          <span class=\"string\">&quot;to_as_string&quot;</span>: <span class=\"string\">&quot;2025-04-22 03:14:17&quot;</span>,</span><br><span class=\"line\">          <span class=\"string\">&quot;doc_count&quot;</span>: 4</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;key&quot;</span>: <span class=\"string\">&quot;now-1d&quot;</span>,</span><br><span class=\"line\">          <span class=\"string\">&quot;from&quot;</span>: 1745291657610,</span><br><span class=\"line\">          <span class=\"string\">&quot;from_as_string&quot;</span>: <span class=\"string\">&quot;2025-04-22 03:14:17&quot;</span>,</span><br><span class=\"line\">          <span class=\"string\">&quot;doc_count&quot;</span>: 4</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      ]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 日期格式</span></span><br><span class=\"line\">GET /shopping/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;size&quot;</span>: 0,</span><br><span class=\"line\">  <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;date_range&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;date_range&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;created_at&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;ranges&quot;</span>: [</span><br><span class=\"line\">          &#123;<span class=\"string\">&quot;to&quot;</span>: <span class=\"string\">&quot;2025-04-20 00:00:00&quot;</span>&#125;, <span class=\"comment\"># 注意这里的格式必须与字段格式一致</span></span><br><span class=\"line\">          &#123;<span class=\"string\">&quot;from&quot;</span>: <span class=\"string\">&quot;2025-04-20 00:00:00&quot;</span>,<span class=\"string\">&quot;to&quot;</span>: <span class=\"string\">&quot;2025-04-22 00:00:00&quot;</span>&#125;,</span><br><span class=\"line\">          &#123;<span class=\"string\">&quot;key&quot;</span>:<span class=\"string\">&quot;2025-04-22 00:00:00&quot;</span>,<span class=\"string\">&quot;from&quot;</span>: <span class=\"string\">&quot;2025-04-22 00:00:00&quot;</span>&#125;</span><br><span class=\"line\">        ]</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"histogram（直方图）\">histogram（直方图）</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>按照间隔进行分组，并统计每个组的数量。</p>\n</li>\n<li class=\"lvl-2\">\n<p>示例：按照价格的间隔进行分组，并统计每个组的数量。</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /shopping/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;size&quot;</span>: 0,</span><br><span class=\"line\">  <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;price_histogram&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;histogram&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;price&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;interval&quot;</span>: 500, <span class=\"comment\"># 间隔500</span></span><br><span class=\"line\">        <span class=\"string\">&quot;extended_bounds&quot;</span>:&#123; <span class=\"comment\"># 设置边界</span></span><br><span class=\"line\">          <span class=\"string\">&quot;min&quot;</span>:0, <span class=\"comment\"># 最小值0</span></span><br><span class=\"line\">          <span class=\"string\">&quot;max&quot;</span>:2000 <span class=\"comment\"># 最大值2000</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\"># 结果</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;took&quot;</span>: 2,</span><br><span class=\"line\">  <span class=\"string\">&quot;timed_out&quot;</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;_shards&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;total&quot;</span>: 1,</span><br><span class=\"line\">    <span class=\"string\">&quot;successful&quot;</span>: 1,</span><br><span class=\"line\">    <span class=\"string\">&quot;skipped&quot;</span>: 0,</span><br><span class=\"line\">    <span class=\"string\">&quot;failed&quot;</span>: 0</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;hits&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;total&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;value&quot;</span>: 12,</span><br><span class=\"line\">      <span class=\"string\">&quot;relation&quot;</span>: <span class=\"string\">&quot;eq&quot;</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">&quot;max_score&quot;</span>: null,</span><br><span class=\"line\">    <span class=\"string\">&quot;hits&quot;</span>: []</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;aggregations&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;price_histogram&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;buckets&quot;</span>: [</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;key&quot;</span>: 0,</span><br><span class=\"line\">          <span class=\"string\">&quot;doc_count&quot;</span>: 8</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;key&quot;</span>: 500,</span><br><span class=\"line\">          <span class=\"string\">&quot;doc_count&quot;</span>: 1</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;key&quot;</span>: 1000,</span><br><span class=\"line\">          <span class=\"string\">&quot;doc_count&quot;</span>: 1</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;key&quot;</span>: 1500,</span><br><span class=\"line\">          <span class=\"string\">&quot;doc_count&quot;</span>: 2</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;key&quot;</span>: 2000,</span><br><span class=\"line\">          <span class=\"string\">&quot;doc_count&quot;</span>: 0</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      ]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"top-hits（分桶取前N条）\">top_hits（分桶取前N条）</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>按照字段的值进行分组，并返回每个组的前N条数据。</p>\n</li>\n<li class=\"lvl-2\">\n<p>示例：按照category进行分组，并返回每个组的前3条数据。</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /shopping/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;size&quot;</span>: 0,</span><br><span class=\"line\">  <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;price_top_hits&quot;</span>: &#123; <span class=\"comment\"># 自定义名称</span></span><br><span class=\"line\">      <span class=\"string\">&quot;terms&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;category&quot;</span>  <span class=\"comment\"># 按照category字段进行分组</span></span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;top_hits&quot;</span>: &#123; <span class=\"comment\"># 自定义名称</span></span><br><span class=\"line\">          <span class=\"string\">&quot;top_hits&quot;</span>: &#123; <span class=\"comment\"># 返回每个组的前3条数据</span></span><br><span class=\"line\">            <span class=\"string\">&quot;size&quot;</span>: 3, <span class=\"comment\"># 返回前3条数据</span></span><br><span class=\"line\">            <span class=\"string\">&quot;sort&quot;</span>: &#123; <span class=\"comment\"># 按照created_at字段进行排序</span></span><br><span class=\"line\">              <span class=\"string\">&quot;created_at&quot;</span>: &#123;</span><br><span class=\"line\">                <span class=\"string\">&quot;order&quot;</span>: <span class=\"string\">&quot;desc&quot;</span> <span class=\"comment\"># 降序</span></span><br><span class=\"line\">              &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"子聚合\">子聚合</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>子聚合：在聚合函数中，还可以再定义一个聚合函数。</p>\n</li>\n<li class=\"lvl-2\">\n<p>示例：按照category进行分组，并统计价格信息</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /shopping/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;size&quot;</span>: 0,</span><br><span class=\"line\">  <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;category_buckets&quot;</span>: &#123; <span class=\"comment\"># 自定义名称</span></span><br><span class=\"line\">      <span class=\"string\">&quot;terms&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;category&quot;</span>  <span class=\"comment\"># 按照category字段进行分组</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"string\">&quot;aggs&quot;</span>: &#123; <span class=\"comment\"># 定义子聚合</span></span><br><span class=\"line\">        <span class=\"string\">&quot;price_stats&quot;</span>: &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;stats&quot;</span>: &#123; <span class=\"comment\"># 统计价格信息</span></span><br><span class=\"line\">            <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;price&quot;</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 多层嵌套</span></span><br><span class=\"line\"><span class=\"comment\"># 先按照category进行分组，再按照address进行分组，并统计价格信息</span></span><br><span class=\"line\">GET /shopping/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;size&quot;</span>:0,</span><br><span class=\"line\">  <span class=\"string\">&quot;aggs&quot;</span>:&#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;category_buckets&quot;</span>:&#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;terms&quot;</span>:&#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;field&quot;</span>:<span class=\"string\">&quot;category&quot;</span></span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      <span class=\"string\">&quot;aggs&quot;</span>:&#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;address_buckets&quot;</span>:&#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;terms&quot;</span>:&#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;field&quot;</span>:<span class=\"string\">&quot;address.keyword&quot;</span></span><br><span class=\"line\">          &#125;,</span><br><span class=\"line\">          <span class=\"string\">&quot;aggs&quot;</span>:&#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;price_stats&quot;</span>:&#123;</span><br><span class=\"line\">              <span class=\"string\">&quot;stats&quot;</span>:&#123;</span><br><span class=\"line\">                <span class=\"string\">&quot;field&quot;</span>:<span class=\"string\">&quot;price&quot;</span></span><br><span class=\"line\">              &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"Pipeline-Aggregation-管道聚合\">Pipeline Aggregation(管道聚合)</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>支持对聚合分析的结果，再次进行聚合分析。</p>\n</li>\n<li class=\"lvl-2\">\n<p>Pipeline 的分析结果会输出到原结果中，根据位置的不同，分为两类：</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-4\">Sibling - 结果和现有分析结果同级\n<ul class=\"lvl-4\">\n<li class=\"lvl-6\">Max，min，Avg &amp; Sum Bucket</li>\n<li class=\"lvl-6\">Stats，Extended Status Bucket</li>\n<li class=\"lvl-6\">Percentiles Bucket</li>\n</ul>\n</li>\n<li class=\"lvl-4\">Parent -结果内嵌到现有的聚合分析结果之中\n<ul class=\"lvl-4\">\n<li class=\"lvl-6\">Derivative(求导)</li>\n<li class=\"lvl-6\">Cumultive Sum(累计求和)</li>\n<li class=\"lvl-6\">Moving Function(移动平均值)</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"Max，min，Avg-Sum-Bucket\">Max，min，Avg &amp; Sum Bucket</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Max，min，Avg &amp; Sum Bucket：对聚合分析的结果进行最大值、最小值、平均值、求和等操作。</p>\n</li>\n<li class=\"lvl-2\">\n<p>示例：按照category进行分组求出商品的平均价格，并找出平均价格最低的分组</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /shopping/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;size&quot;</span>:0,</span><br><span class=\"line\">  <span class=\"string\">&quot;aggs&quot;</span>:&#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;category_buckets&quot;</span>:&#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;terms&quot;</span>:&#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;field&quot;</span>:<span class=\"string\">&quot;category&quot;</span> <span class=\"comment\"># 按照category字段进行分组</span></span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      <span class=\"string\">&quot;aggs&quot;</span>:&#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;price_avg&quot;</span>:&#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;avg&quot;</span>:&#123; <span class=\"comment\"># 求价格平均值</span></span><br><span class=\"line\">            <span class=\"string\">&quot;field&quot;</span>:<span class=\"string\">&quot;price&quot;</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">&quot;min_price_in_category&quot;</span>:&#123; <span class=\"comment\"># 找出平均价格最低的分组</span></span><br><span class=\"line\">      <span class=\"string\">&quot;min_bucket&quot;</span>:&#123; <span class=\"comment\"># 对聚合结果进行最小值操作</span></span><br><span class=\"line\">        <span class=\"string\">&quot;buckets_path&quot;</span>:<span class=\"string\">&quot;category_buckets&gt;price_avg&quot;</span> <span class=\"comment\"># 指定路径，对category_buckets聚合结果中的price_avg字段进行最小值操作</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"Stats，Extended-Status-Bucket\">Stats，Extended Status Bucket</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Stats，Extended Status Bucket：对聚合分析的结果进行统计操作，包括最大值、最小值、平均值、求和、数量等。</p>\n</li>\n<li class=\"lvl-2\">\n<p>示例：按照category进行分组求出商品的平均价格，并对分组结果进行统计操作</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /shopping/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;size&quot;</span>: 0,</span><br><span class=\"line\">  <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;category_buckets&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;terms&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;category&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;size&quot;</span>: 10 <span class=\"comment\"># 指定分组数量</span></span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;avg_price&quot;</span>: &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;avg&quot;</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;price&quot;</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">&quot;stats_price_by_job&quot;</span>:&#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;stats_bucket&quot;</span>: &#123; <span class=\"comment\"># 对聚合结果进行统计操作</span></span><br><span class=\"line\">        <span class=\"string\">&quot;buckets_path&quot;</span>: <span class=\"string\">&quot;category_buckets&gt;avg_price&quot;</span> <span class=\"comment\"># 指定路径，对category_buckets聚合结果中的avg_price字段进行统计操作</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"Percentiles-Bucket\">Percentiles Bucket</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Percentiles Bucket：对聚合分析的结果进行百分比操作，包括百分比、中位数等。</p>\n</li>\n<li class=\"lvl-2\">\n<p>示例：按照category进行分组求出商品的平均价格，并对分组结果进行百分比操作</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /shopping/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;size&quot;</span>: 0,</span><br><span class=\"line\">  <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;category_buckets&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;terms&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;category&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;size&quot;</span>: 10</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;avg_price&quot;</span>: &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;avg&quot;</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;price&quot;</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">&quot;percentiles_price_by_category&quot;</span>:&#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;percentiles_bucket&quot;</span>: &#123; <span class=\"comment\"># 对聚合结果进行统计操作</span></span><br><span class=\"line\">        <span class=\"string\">&quot;buckets_path&quot;</span>: <span class=\"string\">&quot;category_buckets&gt;avg_price&quot;</span> <span class=\"comment\"># 指定路径，对category_buckets聚合结果中的avg_price字段进行统计操作</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"Cumulative-Sum\">Cumulative Sum</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Cumulative Sum：对聚合分析的结果进行累计求和操作。</p>\n</li>\n<li class=\"lvl-2\">\n<p>示例: 按照价格进行分组，并统计平均价格信息，对分组结果进行累计求和操作。</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /shopping/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;size&quot;</span>: 0,</span><br><span class=\"line\">  <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;price_histogram&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;histogram&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;price&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;interval&quot;</span>: 500, <span class=\"comment\"># 间隔500</span></span><br><span class=\"line\">        <span class=\"string\">&quot;extended_bounds&quot;</span>:&#123; <span class=\"comment\"># 设置边界</span></span><br><span class=\"line\">          <span class=\"string\">&quot;min&quot;</span>:0, <span class=\"comment\"># 最小值0</span></span><br><span class=\"line\">          <span class=\"string\">&quot;max&quot;</span>:2000 <span class=\"comment\"># 最大值2000</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;avg_price&quot;</span>: &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;avg&quot;</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;price&quot;</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;cumulative_sum_price&quot;</span>: &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;cumulative_sum&quot;</span>: &#123; <span class=\"comment\"># 对聚合结果进行累计求和操作</span></span><br><span class=\"line\">            <span class=\"string\">&quot;buckets_path&quot;</span>: <span class=\"string\">&quot;avg_price&quot;</span> <span class=\"comment\"># 指定路径，对avg_price字段进行累计求和操作</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"Derivative\">Derivative</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Derivative：对聚合分析的结果进行求导操作。</p>\n</li>\n<li class=\"lvl-2\">\n<p>Derivative 聚合查询是 Elasticsearch 中的一种高级聚合类型，用于计算某个度量值随时间（或其他顺序字段）变化的速率。它通常用于时间序列分析，以揭示度量值的增减趋势。</p>\n</li>\n<li class=\"lvl-2\">\n<p>示例：显示每天的平均价格以及平均价格的变化趋势</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /shopping/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;size&quot;</span>: 0,</span><br><span class=\"line\">  <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;price_over_time&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;date_histogram&quot;</span>: &#123; <span class=\"comment\"># 按照日期进行分组</span></span><br><span class=\"line\">        <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;created_at&quot;</span>, <span class=\"comment\"># 指定字段</span></span><br><span class=\"line\">        <span class=\"string\">&quot;calendar_interval&quot;</span>: <span class=\"string\">&quot;day&quot;</span> <span class=\"comment\"># 指定时间间隔，可用的值：year、quarter、month、week、day、hour、minute、second</span></span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;average_price&quot;</span>: &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;avg&quot;</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;price&quot;</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;price_derivative&quot;</span>: &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;derivative&quot;</span>: &#123; <span class=\"comment\"># 对聚合结果进行求导操作</span></span><br><span class=\"line\">            <span class=\"string\">&quot;buckets_path&quot;</span>: <span class=\"string\">&quot;average_price&quot;</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"Moving-Function\">Moving Function</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Moving Function：对聚合分析的结果进行移动平均值操作。</p>\n</li>\n<li class=\"lvl-2\">\n<p>Moving Function 聚合查询是 Elasticsearch 中的一种高级聚合类型，用于计算某个度量值在时间窗口内的移动平均值。它通常用于时间序列分析，以了解度量值的变化趋势。</p>\n</li>\n<li class=\"lvl-2\">\n<p>示例：计算 price 字段的 7 天移动平均值</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /shopping/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;size&quot;</span>: 0,</span><br><span class=\"line\">  <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;price_over_time&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;date_histogram&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;created_at&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;calendar_interval&quot;</span>: <span class=\"string\">&quot;day&quot;</span></span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;daily_avg_price&quot;</span>: &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;avg&quot;</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;price&quot;</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;moving_avg_price&quot;</span>: &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;moving_fn&quot;</span>: &#123; <span class=\"comment\"># 对聚合结果进行移动平均值操作</span></span><br><span class=\"line\">            <span class=\"string\">&quot;buckets_path&quot;</span>: <span class=\"string\">&quot;daily_avg_price&quot;</span>, <span class=\"comment\"># 指定路径，对daily_avg_price字段进行移动平均值操作</span></span><br><span class=\"line\">            <span class=\"string\">&quot;script&quot;</span>: <span class=\"string\">&quot;MovingFunctions.unweightedAvg(values)&quot;</span>, <span class=\"comment\"># 指定脚本，计算移动平均值</span></span><br><span class=\"line\">            <span class=\"string\">&quot;window&quot;</span>: 7, <span class=\"comment\"># 窗口大小，默认为 10</span></span><br><span class=\"line\">            <span class=\"string\">&quot;shift&quot;</span>: 0 <span class=\"comment\"># 窗口偏移量，默认为 0</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"ES-聚合性能优化\">ES 聚合性能优化</h2>\n<h3 id=\"索引预排序\">索引预排序</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>如果是 Elasticsearch 6.X 之后版本，可以在插入数据时对索引进行预排序，而不是在查询时再对索引进行排序，这将提高范围查询（range query）和排序操作的性能。</p>\n</li>\n<li class=\"lvl-2\">\n<p>但预排序将增加 Elasticsearch 写入的成本，导致大约 40%-50% 的写性能下降，如果应用场景是更关注写性能的业务，开启索引预排序不是一个很好的选择。</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT /my_index</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;settings&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;index&quot;</span>:&#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;sort.field&quot;</span>: <span class=\"string\">&quot;create_time&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;sort.order&quot;</span>: <span class=\"string\">&quot;desc&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;mappings&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;properties&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;create_time&quot;</span>:&#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;type&quot;</span>: <span class=\"string\">&quot;date&quot;</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"使用分片请求缓存\">使用分片请求缓存</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>聚合语句中，设置：size：0，就会使用分片请求缓存缓存结果。size = 0 的含义是：只返回聚合结果，不返回查询结果。</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /my_index/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;size&quot;</span>: 0,</span><br><span class=\"line\">  <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;remark_agg&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;terms&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;remark.keyword&quot;</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"拆分聚合，使聚合并行化\">拆分聚合，使聚合并行化</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Elasticsearch 查询条件中同时有多个条件聚合，默认情况下聚合不是并行运行的。</p>\n</li>\n<li class=\"lvl-2\">\n<p>当为每个聚合提供自己的查询并执行 msearch 时，性能会有显著提升。</p>\n</li>\n<li class=\"lvl-2\">\n<p>因此，在 CPU 资源不是瓶颈的前提下，如果想缩短响应时间，可以将多个聚合拆分为多个查询，借助：msearch 实现并行聚合。</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#常规的多条件聚合实现</span></span><br><span class=\"line\">GET /employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;size&quot;</span>: 0,</span><br><span class=\"line\">  <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;job_agg&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;terms&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;job.keyword&quot;</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">&quot;max_salary&quot;</span>:&#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;max&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;salary&quot;</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\"># msearch 拆分多个语句的聚合实现</span></span><br><span class=\"line\">GET _msearch</span><br><span class=\"line\">&#123;<span class=\"string\">&quot;index&quot;</span>:<span class=\"string\">&quot;employees&quot;</span>&#125;</span><br><span class=\"line\">&#123;<span class=\"string\">&quot;size&quot;</span>:0,<span class=\"string\">&quot;aggs&quot;</span>:&#123;<span class=\"string\">&quot;job_agg&quot;</span>:&#123;<span class=\"string\">&quot;terms&quot;</span>:&#123;<span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;job.keyword&quot;</span>&#125;&#125;&#125;&#125;</span><br><span class=\"line\">&#123;<span class=\"string\">&quot;index&quot;</span>:<span class=\"string\">&quot;employees&quot;</span>&#125;</span><br><span class=\"line\">&#123;<span class=\"string\">&quot;size&quot;</span>:0,<span class=\"string\">&quot;aggs&quot;</span>:&#123;<span class=\"string\">&quot;max_salary&quot;</span>:&#123;<span class=\"string\">&quot;max&quot;</span>:&#123;<span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;salary&quot;</span>&#125;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>","content_text":"摘要 本文介绍 Elasticsearch 的 REST APIs：聚合查询 Elasticsearch版本8.17.3 官方文档:REST APIs 官方文档:Aggregations Elasticsearch 的 REST APIs 聚合查询 聚合查询，可以让我们极其方便的实现对索引数据的统计、分析、运算等操作。 基本语法包括以下部分： 查询条件：指定需要聚合的文档，可以使用标准的 Elasticsearch 查询语法，如 term、match、range 等等。 聚合函数：指定要执行的聚合操作，如 sum、avg、min、max、terms、date_histogram 等等。每个聚合命令都会生成一个聚合结果。 聚合嵌套：聚合命令可以嵌套，以便更细粒度地分析数据。 123456789101112131415GET &lt;index_name&gt;/_search&#123; &quot;aggs&quot;: &#123; &quot;&lt;aggs_name&gt;&quot;: &#123; &quot;&lt;agg_type&gt;&quot;: &#123; &quot;field&quot;: &quot;&lt;field_name&gt;&quot; &#125; &#125; &#125;&#125;# 说明 # aggs：聚合的根节点，固定写法 # aggs_name：聚合函数的名称，自己随意定义 # agg_type：聚合种类，比如是桶聚合（terms）或者是指标聚合（avg、sum、min、max等） # field_name：字段名称或者叫域名。 聚合的分类 Metric Aggregation：—些数学运算，可以对文档字段进行统计分析，类比Mysql中的 min(), max(), sum() 操作。 Bucket Aggregation：一些满足特定条件的文档的集合放置到一个桶里，每一个桶关联一个key，类比Mysql中的group by操作。 Pipeline Aggregation：对其他的聚合结果进行二次聚合 示例数据准备 我们需要先准备一些数据，才能进行聚合分析。 创建索引 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465# 如果存在先删除curl -X DELETE -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping&#x27;# 创建索引curl -X PUT -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;settings&quot;:&#123; &quot;number_of_shards&quot;:&quot;1&quot;, &quot;number_of_replicas&quot;:&quot;2&quot; &#125;, &quot;mappings&quot;:&#123; &quot;properties&quot;:&#123; &quot;category&quot;:&#123; &quot;type&quot;:&quot;keyword&quot; &#125;, &quot;price&quot;:&#123; &quot;type&quot;:&quot;double&quot; &#125;, &quot;count&quot;:&#123; &quot;type&quot;:&quot;integer&quot; &#125;, &quot;title&quot;:&#123; &quot;type&quot;:&quot;text&quot;, &quot;analyzer&quot;:&quot;ik_max_word&quot;, &quot;search_analyzer&quot;:&quot;ik_smart&quot; &#125;, &quot;remark&quot;:&#123; &quot;type&quot;:&quot;text&quot;, &quot;analyzer&quot;:&quot;ik_max_word&quot;, &quot;search_analyzer&quot;:&quot;ik_smart&quot; &#125;, &quot;address&quot;: &#123; &quot;type&quot;: &quot;text&quot;, &quot;analyzer&quot;: &quot;ik_max_word&quot;, &quot;fields&quot;: &#123; &quot;keyword&quot;: &#123; &quot;type&quot;: &quot;keyword&quot; &#125; &#125; &#125;, &quot;tags&quot;: &#123; &quot;type&quot;: &quot;keyword&quot; &#125;, &quot;created_at&quot;: &#123;&quot;type&quot;: &quot;date&quot;, &quot;format&quot;: &quot;yyyy-MM-dd HH:mm:ss&quot;&#125; &#125; &#125; &#125;&#x27;# 插入数据curl -X POST -u elastic:123456 -k &#x27;https://127.0.0.1:9200/_bulk&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;index&quot;: &#123; &quot;_index&quot;: &quot;shopping&quot;, &quot;_id&quot;: &quot;1&quot; &#125; &#125;&#123; &quot;category&quot;: &quot;electronics&quot;, &quot;price&quot;: 999.99, &quot;count&quot;: 10, &quot;title&quot;: &quot;Smartphone X - 128GB&quot;, &quot;remark&quot;: &quot;This latest Smartphone X comes with a powerful processor and high-resolution camera.&quot;, &quot;address&quot;: &quot;广州天河公园&quot;, &quot;tags&quot;: [&quot;latest&quot;, &quot;smartphone&quot;, &quot;technology&quot;], &quot;created_at&quot;: &quot;2025-04-22 03:30:02&quot; &#125;&#123; &quot;index&quot;: &#123; &quot;_index&quot;: &quot;shopping&quot;, &quot;_id&quot;: &quot;2&quot; &#125; &#125;&#123; &quot;category&quot;: &quot;fashion&quot;, &quot;price&quot;: 49.99, &quot;count&quot;: 25, &quot;title&quot;: &quot;Designer T-shirt&quot;, &quot;remark&quot;: &quot;Trendy designer T-shirt made with high quality fabric.&quot;, &quot;address&quot;: &quot;广州荔湾大厦&quot;, &quot;tags&quot;: [&quot;clothing&quot;, &quot;designer&quot;, &quot;style&quot;], &quot;created_at&quot;: &quot;2025-04-21 12:15:00&quot; &#125;&#123; &quot;index&quot;: &#123; &quot;_index&quot;: &quot;shopping&quot;, &quot;_id&quot;: &quot;3&quot; &#125; &#125;&#123; &quot;category&quot;: &quot;home_appliances&quot;, &quot;price&quot;: 299.99, &quot;count&quot;: 5, &quot;title&quot;: &quot;Robot Vacuum Cleaner&quot;, &quot;remark&quot;: &quot;Efficient robot vacuum cleaner with smart navigation.&quot;, &quot;address&quot;: &quot;广州白云山公园&quot;, &quot;tags&quot;: [&quot;appliances&quot;, &quot;vacuum&quot;, &quot;robot&quot;], &quot;created_at&quot;: &quot;2025-04-20 08:45:30&quot; &#125;&#123; &quot;index&quot;: &#123; &quot;_index&quot;: &quot;shopping&quot;, &quot;_id&quot;: &quot;4&quot; &#125; &#125;&#123; &quot;category&quot;: &quot;books&quot;, &quot;price&quot;: 19.99, &quot;count&quot;: 100, &quot;title&quot;: &quot;Inspirational Novel&quot;, &quot;remark&quot;: &quot;A gripping novel that inspires and motivates.&quot;, &quot;address&quot;: &quot;321 Book Rd, Shenzhen, China&quot;, &quot;tags&quot;: [&quot;book&quot;, &quot;novel&quot;, &quot;inspiration&quot;], &quot;created_at&quot;: &quot;2025-04-19 10:05:00&quot; &#125;&#123; &quot;index&quot;: &#123; &quot;_index&quot;: &quot;shopping&quot;, &quot;_id&quot;: &quot;5&quot; &#125; &#125;&#123; &quot;category&quot;: &quot;groceries&quot;, &quot;price&quot;: 3.99, &quot;count&quot;: 200, &quot;title&quot;: &quot;Organic Apples&quot;, &quot;remark&quot;: &quot;Fresh and crispy organic apples.&quot;, &quot;address&quot;: &quot;654 Grocery Ln, Chengdu, China&quot;, &quot;tags&quot;: [&quot;fruit&quot;, &quot;organic&quot;, &quot;healthy&quot;], &quot;created_at&quot;: &quot;2025-04-18 14:30:45&quot; &#125;&#123; &quot;index&quot;: &#123; &quot;_index&quot;: &quot;shopping&quot;, &quot;_id&quot;: &quot;6&quot; &#125; &#125;&#123; &quot;category&quot;: &quot;electronics&quot;, &quot;price&quot;: 1999.99, &quot;count&quot;: 15, &quot;title&quot;: &quot;Smartphone X - 256GB&quot;, &quot;remark&quot;: &quot;This latest Smartphone X comes with a powerful processor and high-resolution camera.&quot;, &quot;address&quot;: &quot;广州天河公园&quot;, &quot;tags&quot;: [&quot;latest&quot;, &quot;smartphone&quot;, &quot;technology&quot;], &quot;created_at&quot;: &quot;2025-04-22 03:30:02&quot; &#125;&#x27; Metric Aggregation(指标聚合) 单值分析︰只输出一个分析结果 min, max, avg, sum 123456789101112131415161718192021222324252627# 最大值、最小值、平均值、总和GET /shopping/_search&#123; &quot;size&quot;: 0, # 不返回文档，只返回聚合结果 &quot;aggs&quot;: &#123; &quot;max_price&quot;: &#123; # 自定义名称，这里返回最大值 &quot;max&quot;: &#123; # 指标聚合函数名称 &quot;field&quot;: &quot;price&quot; # 指标聚合字段 &#125; &#125;, &quot;min_price&quot;: &#123; &quot;min&quot;: &#123; &quot;field&quot;: &quot;price&quot; &#125; &#125;, &quot;avg_price&quot;: &#123; &quot;avg&quot;: &#123; &quot;field&quot;: &quot;price&quot; &#125; &#125;, &quot;sum_price&quot;: &#123; &quot;sum&quot;: &#123; &quot;field&quot;: &quot;price&quot; &#125; &#125; &#125;&#125; Cardinality（类似distinct Count) 1234567891011GET /shopping/_search&#123; &quot;size&quot;: 0, # 不返回文档，只返回聚合结果 &quot;aggs&quot;: &#123; &quot;cardinality_count&quot;: &#123; # 自定义名称，返回去重后的数量 &quot;cardinality&quot;: &#123; # 指标聚合函数名称，cardinality表示去重 &quot;field&quot;: &quot;category&quot; # 指标聚合字段，去重的字段 &#125; &#125; &#125;&#125; 多值分析:输出多个分析结果 stats（统计）, extended stats 123456789101112131415161718192021222324252627282930313233343536373839GET /shopping/_search&#123; &quot;size&quot;: 0, &quot;aggs&quot;: &#123; &quot;stats_price&quot;: &#123; &quot;stats&quot;: &#123; # 指标聚合函数名称，stats表示统计，会返回多个指标 &quot;field&quot;: &quot;price&quot; &#125; &#125; &#125;&#125;# 结果&#123; &quot;took&quot;: 15, &quot;timed_out&quot;: false, &quot;_shards&quot;: &#123; &quot;total&quot;: 1, &quot;successful&quot;: 1, &quot;skipped&quot;: 0, &quot;failed&quot;: 0 &#125;, &quot;hits&quot;: &#123; &quot;total&quot;: &#123; &quot;value&quot;: 12, &quot;relation&quot;: &quot;eq&quot; &#125;, &quot;max_score&quot;: null, &quot;hits&quot;: [] # 因为设置size 为 0，所以返回的结果为空 &#125;, &quot;aggregations&quot;: &#123; # 聚合结果 &quot;stats_price&quot;: &#123; # 自定义名称，返回多组聚合结果 &quot;count&quot;: 12, &quot;min&quot;: 3.99, &quot;max&quot;: 1999.99, &quot;avg&quot;: 562.1666666666666, &quot;sum&quot;: 6746 &#125; &#125;&#125; percentile （百分位）, percentile rank 1234567891011121314151617GET /shopping/_search&#123; &quot;size&quot;: 0, &quot;aggs&quot;: &#123; &quot;percentile_price&quot;: &#123; &quot;percentiles&quot;: &#123; # 指标聚合函数名称，percentiles表示百分位数聚合计算 &quot;field&quot;: &quot;price&quot;, # 指标聚合字段 &quot;percents&quot;: [1, 5, 25, 50, 75, 95, 99] # 需要计算百分位数的数组 &#125; &#125; &#125;&#125;# 百分位数是一个统计学概念，用于描述一个给定集合的排序值。例如：# 第 1 百分位数表示数据中小于这个值的所有数据占总数的 1%。# 第 50 百分位数（中位数）表示数据中的一半小于这个值，另一半大于这个值。# 第 99 百分位数表示数据中小于这个值的所有数据占总数的 99%。# 通过计算这些百分位数，你可以了解 price 字段在整个shopping索引中的分布情况，从而可以用于数据分析、趋势判断等。 top hits(排在前面的示例) 123456789101112GET /shopping/_search&#123; &quot;size&quot;: 0, &quot;aggs&quot;: &#123; &quot;top_hits&quot;: &#123; # 自定义名称，返回排在前面的示例 &quot;top_hits&quot;: &#123; # 指标聚合函数名称，top_hits表示返回排在前面的示例 &quot;sort&quot;: [&#123;&quot;price&quot;: &#123;&quot;order&quot;: &quot;desc&quot;&#125;&#125;], # 排序，按照price字段降序排序 &quot;size&quot;: 3 # 只返回前3个 &#125; &#125; &#125;&#125; Bucket Aggregation(桶聚合) 按照一定的规则，将文档分配到不同的桶中，从而达到分类的目的。 ES提供的一些常见的 Bucket Aggregation。 terms（词条）, range（范围）, date_range（日期范围）, ip_range（IP范围）, missing（缺失）, histogram（直方图）, date_histogram（日期直方图）, geo_distance（地理距离）, significant_terms（重要词条）, composite（组合） 桶聚合可以用于各种场景，例如： 对数据进行分组统计，比如按照地区、年龄段、性别等字段进行分组统计。 对时间序列数据进行时间段分析，比如按照每小时、每天、每月、每季度、每年等时间段进行分析。 对各种标签信息分类，并统计其数量。 terms（词条） 按照字段的值进行分组，并统计每个组的数量。 示例：按照category字段进行分组，并统计每个组的数量。 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061GET /shopping/_search&#123; &quot;size&quot;: 0, &quot;aggs&quot;: &#123; &quot;category_count&quot;: &#123; # 自定义名称，返回每个组的数量 &quot;terms&quot;: &#123; # 桶聚合函数名称，terms表示按照字段的值进行分组 &quot;field&quot;: &quot;category&quot;, # 按照category字段进行分组，注意不能是text类型，否则会报错 &quot;size&quot;: 10, # 只返回前10个，默认是10 &quot;order&quot;: &#123;&quot;_count&quot;: &quot;desc&quot;&#125; # 按照数量降序排序，默认是desc，Bucket聚合会统计Bucket内的文档数量，记为_count，并且按照_count降序排序 &#125; &#125; &#125;&#125;# 结果&#123; &quot;took&quot;: 15, &quot;timed_out&quot;: false, &quot;_shards&quot;: &#123; &quot;total&quot;: 1, &quot;successful&quot;: 1, &quot;skipped&quot;: 0, &quot;failed&quot;: 0 &#125;, &quot;hits&quot;: &#123; &quot;total&quot;: &#123; &quot;value&quot;: 12, &quot;relation&quot;: &quot;eq&quot; &#125;, &quot;max_score&quot;: null, &quot;hits&quot;: [] &#125;, &quot;aggregations&quot;: &#123; &quot;category_count&quot;: &#123; &quot;doc_count_error_upper_bound&quot;: 0, # 错误上界，表示在聚合过程中可能存在一些错误，但错误数量不会超过这个值 &quot;sum_other_doc_count&quot;: 0, # 表示在聚合过程中，除了返回的10个bucket，还有其他数量，这个数量就是sum_other_doc_count &quot;buckets&quot;: [ # 返回的bucket &#123; &quot;key&quot;: &quot;electronics&quot;, # 分组的key &quot;doc_count&quot;: 4 # 分组的数量 &#125;, &#123; &quot;key&quot;: &quot;books&quot;, &quot;doc_count&quot;: 2 &#125;, &#123; &quot;key&quot;: &quot;fashion&quot;, &quot;doc_count&quot;: 2 &#125;, &#123; &quot;key&quot;: &quot;groceries&quot;, &quot;doc_count&quot;: 2 &#125;, &#123; &quot;key&quot;: &quot;home_appliances&quot;, &quot;doc_count&quot;: 2 &#125; ] &#125; &#125;&#125; 限定聚合范围 1234567891011121314151617181920GET /shopping/_search&#123; &quot;query&quot;: &#123; &quot;range&quot;: &#123; &quot;price&quot;: &#123; &quot;gte&quot;: 100 # 限定价格范围 &#125; &#125; &#125;, &quot;size&quot;: 0, &quot;aggs&quot;: &#123; &quot;category_count&quot;: &#123; # 自定义名称，返回每个组的数量 &quot;terms&quot;: &#123; # 桶聚合函数名称，terms表示按照字段的值进行分组 &quot;field&quot;: &quot;category&quot;, # 按照category字段进行分组 &quot;size&quot;: 10, # 只返回前10个，默认是10 &quot;order&quot;: &#123;&quot;_count&quot;: &quot;desc&quot;&#125; # 按照数量降序排序，默认是desc，Bucket聚合会统计Bucket内的文档数量，记为_count，并且按照_count降序排序 &#125; &#125; &#125;&#125; range（范围） 按照字段的值进行分组，并统计每个组的数量。 示例：按照价格范围进行分组，并统计每个组的数量。 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960GET /shopping/_search&#123; &quot;size&quot;: 0, &quot;aggs&quot;: &#123; &quot;price_range&quot;: &#123; # 自定义名称，返回每个组的数量 &quot;range&quot;: &#123; # 桶聚合函数名称，range表示按照字段的值进行分组 &quot;field&quot;: &quot;price&quot;, # 按照price字段进行分组 &quot;ranges&quot;: [ &#123;&quot;to&quot;: 100&#125;, # 小于100 &#123;&quot;from&quot;: 100, &quot;to&quot;: 200&#125;, # 100-200，包括100，不包括200 &#123; &quot;key&quot;:&quot;&gt;=200&quot;, # 设定键值，用于区分不同范围 &quot;from&quot;:200 # 大于等于200 &#125; ] &#125; &#125; &#125;&#125;# 结果&#123; &quot;took&quot;: 5, &quot;timed_out&quot;: false, &quot;_shards&quot;: &#123; &quot;total&quot;: 1, &quot;successful&quot;: 1, &quot;skipped&quot;: 0, &quot;failed&quot;: 0 &#125;, &quot;hits&quot;: &#123; &quot;total&quot;: &#123; &quot;value&quot;: 12, &quot;relation&quot;: &quot;eq&quot; &#125;, &quot;max_score&quot;: null, &quot;hits&quot;: [] &#125;, &quot;aggregations&quot;: &#123; &quot;price_range&quot;: &#123; &quot;buckets&quot;: [ &#123; &quot;key&quot;: &quot;*-100.0&quot;, &quot;to&quot;: 100, &quot;doc_count&quot;: 6 &#125;, &#123; &quot;key&quot;: &quot;100.0-200.0&quot;, &quot;from&quot;: 100, &quot;to&quot;: 200, &quot;doc_count&quot;: 0 &#125;, &#123; &quot;key&quot;: &quot;&gt;=200&quot;, &quot;from&quot;: 200, &quot;doc_count&quot;: 6 &#125; ] &#125; &#125;&#125; date_range（日期范围） 按照字段的值进行分组，并统计每个组的数量。 示例：按照日期范围进行分组，并统计每个组的数量。 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879GET /shopping/_search&#123; &quot;size&quot;: 0, &quot;aggs&quot;: &#123; &quot;date_range&quot;: &#123; &quot;date_range&quot;: &#123; &quot;field&quot;: &quot;created_at&quot;, &quot;ranges&quot;: [ &#123;&quot;to&quot;: &quot;now-3d&quot;&#125;, # 小于当前时间减去3天 &#123;&quot;from&quot;: &quot;now-3d&quot;,&quot;to&quot;: &quot;now-1d&quot;&#125;, # 大于当前时间减去3天（包含），小于当前时间减去1天 &#123;&quot;key&quot;:&quot;now-1d&quot;,&quot;from&quot;: &quot;now-1d&quot;&#125; # 大于当前时间减去1天（包含），并设置键值 ] &#125; &#125; &#125;&#125;# 结果&#123; &quot;took&quot;: 3, &quot;timed_out&quot;: false, &quot;_shards&quot;: &#123; &quot;total&quot;: 1, &quot;successful&quot;: 1, &quot;skipped&quot;: 0, &quot;failed&quot;: 0 &#125;, &quot;hits&quot;: &#123; &quot;total&quot;: &#123; &quot;value&quot;: 12, &quot;relation&quot;: &quot;eq&quot; &#125;, &quot;max_score&quot;: null, &quot;hits&quot;: [] &#125;, &quot;aggregations&quot;: &#123; &quot;date_range&quot;: &#123; &quot;buckets&quot;: [ &#123; &quot;key&quot;: &quot;*-2025-04-20 03:14:17&quot;, &quot;to&quot;: 1745118857610, &quot;to_as_string&quot;: &quot;2025-04-20 03:14:17&quot;, &quot;doc_count&quot;: 4 &#125;, &#123; &quot;key&quot;: &quot;2025-04-20 03:14:17-2025-04-22 03:14:17&quot;, &quot;from&quot;: 1745118857610, &quot;from_as_string&quot;: &quot;2025-04-20 03:14:17&quot;, &quot;to&quot;: 1745291657610, &quot;to_as_string&quot;: &quot;2025-04-22 03:14:17&quot;, &quot;doc_count&quot;: 4 &#125;, &#123; &quot;key&quot;: &quot;now-1d&quot;, &quot;from&quot;: 1745291657610, &quot;from_as_string&quot;: &quot;2025-04-22 03:14:17&quot;, &quot;doc_count&quot;: 4 &#125; ] &#125; &#125;&#125;# 日期格式GET /shopping/_search&#123; &quot;size&quot;: 0, &quot;aggs&quot;: &#123; &quot;date_range&quot;: &#123; &quot;date_range&quot;: &#123; &quot;field&quot;: &quot;created_at&quot;, &quot;ranges&quot;: [ &#123;&quot;to&quot;: &quot;2025-04-20 00:00:00&quot;&#125;, # 注意这里的格式必须与字段格式一致 &#123;&quot;from&quot;: &quot;2025-04-20 00:00:00&quot;,&quot;to&quot;: &quot;2025-04-22 00:00:00&quot;&#125;, &#123;&quot;key&quot;:&quot;2025-04-22 00:00:00&quot;,&quot;from&quot;: &quot;2025-04-22 00:00:00&quot;&#125; ] &#125; &#125; &#125;&#125; histogram（直方图） 按照间隔进行分组，并统计每个组的数量。 示例：按照价格的间隔进行分组，并统计每个组的数量。 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061GET /shopping/_search&#123; &quot;size&quot;: 0, &quot;aggs&quot;: &#123; &quot;price_histogram&quot;: &#123; &quot;histogram&quot;: &#123; &quot;field&quot;: &quot;price&quot;, &quot;interval&quot;: 500, # 间隔500 &quot;extended_bounds&quot;:&#123; # 设置边界 &quot;min&quot;:0, # 最小值0 &quot;max&quot;:2000 # 最大值2000 &#125; &#125; &#125; &#125;&#125;# 结果&#123; &quot;took&quot;: 2, &quot;timed_out&quot;: false, &quot;_shards&quot;: &#123; &quot;total&quot;: 1, &quot;successful&quot;: 1, &quot;skipped&quot;: 0, &quot;failed&quot;: 0 &#125;, &quot;hits&quot;: &#123; &quot;total&quot;: &#123; &quot;value&quot;: 12, &quot;relation&quot;: &quot;eq&quot; &#125;, &quot;max_score&quot;: null, &quot;hits&quot;: [] &#125;, &quot;aggregations&quot;: &#123; &quot;price_histogram&quot;: &#123; &quot;buckets&quot;: [ &#123; &quot;key&quot;: 0, &quot;doc_count&quot;: 8 &#125;, &#123; &quot;key&quot;: 500, &quot;doc_count&quot;: 1 &#125;, &#123; &quot;key&quot;: 1000, &quot;doc_count&quot;: 1 &#125;, &#123; &quot;key&quot;: 1500, &quot;doc_count&quot;: 2 &#125;, &#123; &quot;key&quot;: 2000, &quot;doc_count&quot;: 0 &#125; ] &#125; &#125;&#125; top_hits（分桶取前N条） 按照字段的值进行分组，并返回每个组的前N条数据。 示例：按照category进行分组，并返回每个组的前3条数据。 1234567891011121314151617181920212223GET /shopping/_search&#123; &quot;size&quot;: 0, &quot;aggs&quot;: &#123; &quot;price_top_hits&quot;: &#123; # 自定义名称 &quot;terms&quot;: &#123; &quot;field&quot;: &quot;category&quot; # 按照category字段进行分组 &#125;, &quot;aggs&quot;: &#123; &quot;top_hits&quot;: &#123; # 自定义名称 &quot;top_hits&quot;: &#123; # 返回每个组的前3条数据 &quot;size&quot;: 3, # 返回前3条数据 &quot;sort&quot;: &#123; # 按照created_at字段进行排序 &quot;created_at&quot;: &#123; &quot;order&quot;: &quot;desc&quot; # 降序 &#125; &#125; &#125; &#125; &#125; &#125; &#125;&#125; 子聚合 子聚合：在聚合函数中，还可以再定义一个聚合函数。 示例：按照category进行分组，并统计价格信息 12345678910111213141516171819202122232425262728293031323334353637383940414243444546GET /shopping/_search&#123; &quot;size&quot;: 0, &quot;aggs&quot;: &#123; &quot;category_buckets&quot;: &#123; # 自定义名称 &quot;terms&quot;: &#123; &quot;field&quot;: &quot;category&quot; # 按照category字段进行分组 &#125; &quot;aggs&quot;: &#123; # 定义子聚合 &quot;price_stats&quot;: &#123; &quot;stats&quot;: &#123; # 统计价格信息 &quot;field&quot;: &quot;price&quot; &#125; &#125; &#125; &#125; &#125;&#125;# 多层嵌套# 先按照category进行分组，再按照address进行分组，并统计价格信息GET /shopping/_search&#123; &quot;size&quot;:0, &quot;aggs&quot;:&#123; &quot;category_buckets&quot;:&#123; &quot;terms&quot;:&#123; &quot;field&quot;:&quot;category&quot; &#125;, &quot;aggs&quot;:&#123; &quot;address_buckets&quot;:&#123; &quot;terms&quot;:&#123; &quot;field&quot;:&quot;address.keyword&quot; &#125;, &quot;aggs&quot;:&#123; &quot;price_stats&quot;:&#123; &quot;stats&quot;:&#123; &quot;field&quot;:&quot;price&quot; &#125; &#125; &#125; &#125; &#125; &#125; &#125;&#125; Pipeline Aggregation(管道聚合) 支持对聚合分析的结果，再次进行聚合分析。 Pipeline 的分析结果会输出到原结果中，根据位置的不同，分为两类： Sibling - 结果和现有分析结果同级 Max，min，Avg &amp; Sum Bucket Stats，Extended Status Bucket Percentiles Bucket Parent -结果内嵌到现有的聚合分析结果之中 Derivative(求导) Cumultive Sum(累计求和) Moving Function(移动平均值) Max，min，Avg &amp; Sum Bucket Max，min，Avg &amp; Sum Bucket：对聚合分析的结果进行最大值、最小值、平均值、求和等操作。 示例：按照category进行分组求出商品的平均价格，并找出平均价格最低的分组 1234567891011121314151617181920212223GET /shopping/_search&#123; &quot;size&quot;:0, &quot;aggs&quot;:&#123; &quot;category_buckets&quot;:&#123; &quot;terms&quot;:&#123; &quot;field&quot;:&quot;category&quot; # 按照category字段进行分组 &#125;, &quot;aggs&quot;:&#123; &quot;price_avg&quot;:&#123; &quot;avg&quot;:&#123; # 求价格平均值 &quot;field&quot;:&quot;price&quot; &#125; &#125; &#125; &#125;, &quot;min_price_in_category&quot;:&#123; # 找出平均价格最低的分组 &quot;min_bucket&quot;:&#123; # 对聚合结果进行最小值操作 &quot;buckets_path&quot;:&quot;category_buckets&gt;price_avg&quot; # 指定路径，对category_buckets聚合结果中的price_avg字段进行最小值操作 &#125; &#125; &#125;&#125; Stats，Extended Status Bucket Stats，Extended Status Bucket：对聚合分析的结果进行统计操作，包括最大值、最小值、平均值、求和、数量等。 示例：按照category进行分组求出商品的平均价格，并对分组结果进行统计操作 123456789101112131415161718192021222324GET /shopping/_search&#123; &quot;size&quot;: 0, &quot;aggs&quot;: &#123; &quot;category_buckets&quot;: &#123; &quot;terms&quot;: &#123; &quot;field&quot;: &quot;category&quot;, &quot;size&quot;: 10 # 指定分组数量 &#125;, &quot;aggs&quot;: &#123; &quot;avg_price&quot;: &#123; &quot;avg&quot;: &#123; &quot;field&quot;: &quot;price&quot; &#125; &#125; &#125; &#125;, &quot;stats_price_by_job&quot;:&#123; &quot;stats_bucket&quot;: &#123; # 对聚合结果进行统计操作 &quot;buckets_path&quot;: &quot;category_buckets&gt;avg_price&quot; # 指定路径，对category_buckets聚合结果中的avg_price字段进行统计操作 &#125; &#125; &#125;&#125; Percentiles Bucket Percentiles Bucket：对聚合分析的结果进行百分比操作，包括百分比、中位数等。 示例：按照category进行分组求出商品的平均价格，并对分组结果进行百分比操作 123456789101112131415161718192021222324GET /shopping/_search&#123; &quot;size&quot;: 0, &quot;aggs&quot;: &#123; &quot;category_buckets&quot;: &#123; &quot;terms&quot;: &#123; &quot;field&quot;: &quot;category&quot;, &quot;size&quot;: 10 &#125;, &quot;aggs&quot;: &#123; &quot;avg_price&quot;: &#123; &quot;avg&quot;: &#123; &quot;field&quot;: &quot;price&quot; &#125; &#125; &#125; &#125;, &quot;percentiles_price_by_category&quot;:&#123; &quot;percentiles_bucket&quot;: &#123; # 对聚合结果进行统计操作 &quot;buckets_path&quot;: &quot;category_buckets&gt;avg_price&quot; # 指定路径，对category_buckets聚合结果中的avg_price字段进行统计操作 &#125; &#125; &#125;&#125; Cumulative Sum Cumulative Sum：对聚合分析的结果进行累计求和操作。 示例: 按照价格进行分组，并统计平均价格信息，对分组结果进行累计求和操作。 12345678910111213141516171819202122232425262728GET /shopping/_search&#123; &quot;size&quot;: 0, &quot;aggs&quot;: &#123; &quot;price_histogram&quot;: &#123; &quot;histogram&quot;: &#123; &quot;field&quot;: &quot;price&quot;, &quot;interval&quot;: 500, # 间隔500 &quot;extended_bounds&quot;:&#123; # 设置边界 &quot;min&quot;:0, # 最小值0 &quot;max&quot;:2000 # 最大值2000 &#125; &#125;, &quot;aggs&quot;: &#123; &quot;avg_price&quot;: &#123; &quot;avg&quot;: &#123; &quot;field&quot;: &quot;price&quot; &#125; &#125;, &quot;cumulative_sum_price&quot;: &#123; &quot;cumulative_sum&quot;: &#123; # 对聚合结果进行累计求和操作 &quot;buckets_path&quot;: &quot;avg_price&quot; # 指定路径，对avg_price字段进行累计求和操作 &#125; &#125; &#125; &#125; &#125;&#125; Derivative Derivative：对聚合分析的结果进行求导操作。 Derivative 聚合查询是 Elasticsearch 中的一种高级聚合类型，用于计算某个度量值随时间（或其他顺序字段）变化的速率。它通常用于时间序列分析，以揭示度量值的增减趋势。 示例：显示每天的平均价格以及平均价格的变化趋势 123456789101112131415161718192021222324GET /shopping/_search&#123; &quot;size&quot;: 0, &quot;aggs&quot;: &#123; &quot;price_over_time&quot;: &#123; &quot;date_histogram&quot;: &#123; # 按照日期进行分组 &quot;field&quot;: &quot;created_at&quot;, # 指定字段 &quot;calendar_interval&quot;: &quot;day&quot; # 指定时间间隔，可用的值：year、quarter、month、week、day、hour、minute、second &#125;, &quot;aggs&quot;: &#123; &quot;average_price&quot;: &#123; &quot;avg&quot;: &#123; &quot;field&quot;: &quot;price&quot; &#125; &#125;, &quot;price_derivative&quot;: &#123; &quot;derivative&quot;: &#123; # 对聚合结果进行求导操作 &quot;buckets_path&quot;: &quot;average_price&quot; &#125; &#125; &#125; &#125; &#125;&#125; Moving Function Moving Function：对聚合分析的结果进行移动平均值操作。 Moving Function 聚合查询是 Elasticsearch 中的一种高级聚合类型，用于计算某个度量值在时间窗口内的移动平均值。它通常用于时间序列分析，以了解度量值的变化趋势。 示例：计算 price 字段的 7 天移动平均值 123456789101112131415161718192021222324252627GET /shopping/_search&#123; &quot;size&quot;: 0, &quot;aggs&quot;: &#123; &quot;price_over_time&quot;: &#123; &quot;date_histogram&quot;: &#123; &quot;field&quot;: &quot;created_at&quot;, &quot;calendar_interval&quot;: &quot;day&quot; &#125;, &quot;aggs&quot;: &#123; &quot;daily_avg_price&quot;: &#123; &quot;avg&quot;: &#123; &quot;field&quot;: &quot;price&quot; &#125; &#125;, &quot;moving_avg_price&quot;: &#123; &quot;moving_fn&quot;: &#123; # 对聚合结果进行移动平均值操作 &quot;buckets_path&quot;: &quot;daily_avg_price&quot;, # 指定路径，对daily_avg_price字段进行移动平均值操作 &quot;script&quot;: &quot;MovingFunctions.unweightedAvg(values)&quot;, # 指定脚本，计算移动平均值 &quot;window&quot;: 7, # 窗口大小，默认为 10 &quot;shift&quot;: 0 # 窗口偏移量，默认为 0 &#125; &#125; &#125; &#125; &#125;&#125; ES 聚合性能优化 索引预排序 如果是 Elasticsearch 6.X 之后版本，可以在插入数据时对索引进行预排序，而不是在查询时再对索引进行排序，这将提高范围查询（range query）和排序操作的性能。 但预排序将增加 Elasticsearch 写入的成本，导致大约 40%-50% 的写性能下降，如果应用场景是更关注写性能的业务，开启索引预排序不是一个很好的选择。 12345678910111213141516PUT /my_index&#123; &quot;settings&quot;: &#123; &quot;index&quot;:&#123; &quot;sort.field&quot;: &quot;create_time&quot;, &quot;sort.order&quot;: &quot;desc&quot; &#125; &#125;, &quot;mappings&quot;: &#123; &quot;properties&quot;: &#123; &quot;create_time&quot;:&#123; &quot;type&quot;: &quot;date&quot; &#125; &#125; &#125;&#125; 使用分片请求缓存 聚合语句中，设置：size：0，就会使用分片请求缓存缓存结果。size = 0 的含义是：只返回聚合结果，不返回查询结果。 1234567891011GET /my_index/_search&#123; &quot;size&quot;: 0, &quot;aggs&quot;: &#123; &quot;remark_agg&quot;: &#123; &quot;terms&quot;: &#123; &quot;field&quot;: &quot;remark.keyword&quot; &#125; &#125; &#125;&#125; 拆分聚合，使聚合并行化 Elasticsearch 查询条件中同时有多个条件聚合，默认情况下聚合不是并行运行的。 当为每个聚合提供自己的查询并执行 msearch 时，性能会有显著提升。 因此，在 CPU 资源不是瓶颈的前提下，如果想缩短响应时间，可以将多个聚合拆分为多个查询，借助：msearch 实现并行聚合。 1234567891011121314151617181920212223#常规的多条件聚合实现GET /employees/_search&#123; &quot;size&quot;: 0, &quot;aggs&quot;: &#123; &quot;job_agg&quot;: &#123; &quot;terms&quot;: &#123; &quot;field&quot;: &quot;job.keyword&quot; &#125; &#125;, &quot;max_salary&quot;:&#123; &quot;max&quot;: &#123; &quot;field&quot;: &quot;salary&quot; &#125; &#125; &#125;&#125;# msearch 拆分多个语句的聚合实现GET _msearch&#123;&quot;index&quot;:&quot;employees&quot;&#125;&#123;&quot;size&quot;:0,&quot;aggs&quot;:&#123;&quot;job_agg&quot;:&#123;&quot;terms&quot;:&#123;&quot;field&quot;: &quot;job.keyword&quot;&#125;&#125;&#125;&#125;&#123;&quot;index&quot;:&quot;employees&quot;&#125;&#123;&quot;size&quot;:0,&quot;aggs&quot;:&#123;&quot;max_salary&quot;:&#123;&quot;max&quot;:&#123;&quot;field&quot;: &quot;salary&quot;&#125;&#125;&#125;&#125;","summary":"摘要 本文介绍 Elasticsearch 的 REST APIs：聚合查询 Elasticsearch版本8.17.3 官方文档:REST APIs 官方文档:Aggregations Elasticsearch 的 REST APIs","date_published":"2025-04-22T13:30:05.000Z","tags":["技术","elastic","elasticsearch","elasticsearch"]},{"id":"https://blog.hanqunfeng.com/2025/04/17/elasticsearch-05-api/","url":"https://blog.hanqunfeng.com/2025/04/17/elasticsearch-05-api/","title":"Elasticsearch 的 REST APIs","content_html":"<!--\n **加粗**\n *斜体*\n ***加粗并斜体***\n ~~删除线~~\n ==突出显示==\n `突出显示(推荐)`\n ++下划线++\n ~下标~\n ^上标^\n 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.\n 图片设置宽度和高度(通过uPic上传后，需要将upic修改过为blog，用于添加水印) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)\n\n +++ **点击折叠**\n 这是被隐藏的内容\n +++\n\n::: tips success warning danger\n这里是容器内的内容\n:::\n\n% note info % success warning danger\n这里是容器内的内容\n% endnote %\n\n引用本地其它文章连接{}\n 大括号开始% post_link 文件名称(不包含.md) %大括号结束\n -->\n<h2 id=\"摘要\">摘要</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>本文介绍 Elasticsearch 的 REST APIs</p>\n</li>\n<li class=\"lvl-2\">\n<p>Elasticsearch版本8.17.3</p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/8.17/rest-apis.html\">官方文档:REST APIs</a></p>\n</li>\n<li class=\"lvl-2\">\n<a href=\"/2025/04/22/elasticsearch-06-api-aggs/\" title=\"Elasticsearch 的 REST APIs:聚合查询\">Elasticsearch 的 REST APIs:聚合查询</a>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"返回内容格式化\">返回内容格式化</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>返回json信息格式: <code>?pretty</code> 输出格式化后的json，比如：<code>curl http://localhost:9200/_cluster/health?pretty</code></p>\n</li>\n<li class=\"lvl-2\">\n<p>返回行信息格式: <code>?v</code> 输出内容上方会加上标题行，比如：<code>curl http://localhost:9200/_cat/health?v</code></p>\n</li>\n</ul>\n<h2 id=\"CAT-APIs\">CAT APIs</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Elasticsearch 提供了 <a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/8.17/cat.html\">CAT APIs</a>，它们提供了一种简单的方式来查看集群状态和集群中的各种资源，比如索引、分片、节点等。</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET     /_cat/health             <span class=\"comment\">#查看集群当前状态：红、黄、绿</span></span><br><span class=\"line\">GET     /_cat/master             <span class=\"comment\">#查看master节点信息</span></span><br><span class=\"line\">GET     /_cat/nodes              <span class=\"comment\">#查看所有节点信息</span></span><br><span class=\"line\">GET     /_cat/plugins            <span class=\"comment\">#查看集群各个节点上的plugin信息</span></span><br><span class=\"line\">GET     /_cat/indices            <span class=\"comment\">#查看集群中所有index的详细信息</span></span><br><span class=\"line\">GET     /_cat/indices/&#123;index&#125;    <span class=\"comment\">#查看集群中指定index的详细信息，index：索引名称</span></span><br><span class=\"line\">GET     /_cat/allocation         <span class=\"comment\">#查看单节点的shard分配整体情况</span></span><br><span class=\"line\">GET     /_cat/shards             <span class=\"comment\">#查看各shard的详细情况</span></span><br><span class=\"line\">GET     /_cat/shards/&#123;index&#125;     <span class=\"comment\">#查看指定分片的详细情况</span></span><br><span class=\"line\">GET     /_cat/segments           <span class=\"comment\">#查看各index的segment详细信息,包括segment名, 所属shard, 内存(磁盘)占用大小, 是否刷盘</span></span><br><span class=\"line\">GET     /_cat/segments/&#123;index&#125;   <span class=\"comment\">#查看指定index的segment详细信息</span></span><br><span class=\"line\">GET     /_cat/count              <span class=\"comment\">#查看当前集群的doc数量</span></span><br><span class=\"line\">GET     /_cat/count/&#123;index&#125;      <span class=\"comment\">#查看指定索引的doc数量</span></span><br><span class=\"line\">GET     /_cat/recovery           <span class=\"comment\">#查看集群内每个shard的recovery过程.调整replica。</span></span><br><span class=\"line\">GET     /_cat/recovery/&#123;index&#125;   <span class=\"comment\">#查看指定索引shard的recovery过程</span></span><br><span class=\"line\">GET     /_cat/pending_tasks      <span class=\"comment\">#查看当前集群的pending task</span></span><br><span class=\"line\">GET     /_cat/aliases            <span class=\"comment\">#查看集群中所有alias信息,路由配置等</span></span><br><span class=\"line\">GET     /_cat/aliases/&#123;<span class=\"built_in\">alias</span>&#125;    <span class=\"comment\">#查看指定索引的alias信息</span></span><br><span class=\"line\">GET     /_cat/thread_pool        <span class=\"comment\">#查看集群各节点内部不同类型的threadpool的统计信息,</span></span><br><span class=\"line\">GET     /_cat/fielddata          <span class=\"comment\">#查看当前集群各个节点的fielddata内存使用情况</span></span><br><span class=\"line\">GET     /_cat/fielddata/&#123;fields&#125; <span class=\"comment\">#查看指定field的内存使用情况,里面传field属性对应的值</span></span><br><span class=\"line\">GET     /_cat/nodeattrs          <span class=\"comment\">#查看单节点的自定义属性</span></span><br><span class=\"line\">GET     /_cat/repositories       <span class=\"comment\">#输出集群中注册快照存储库</span></span><br><span class=\"line\">GET     /_cat/templates          <span class=\"comment\">#输出当前正在存在的模板信息</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"Cluster-APIs\">Cluster APIs</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Elasticsearch 提供了一系列的 <a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/8.17/cluster.html\">Cluster APIs</a>，它们提供了管理和监控集群状态的功能</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET     /_cluster/health            <span class=\"comment\"># 获取集群的健康状态信息，包括了集群总体的状况如status、number_of_nodes等。</span></span><br><span class=\"line\">GET     /_cluster/stats             <span class=\"comment\"># 提供整个集群层面的统计信息，包含索引、节点和其他高级指标。</span></span><br><span class=\"line\">GET     /_cluster/state             <span class=\"comment\"># 显示集群元数据的状态，包括设置、块、路由表及元数据等，允许用户查看集群的当前视图。</span></span><br><span class=\"line\">POST    /_cluster/reroute           <span class=\"comment\"># POST请求，用于手动改变分片分配情况，可以实现如迁移分片、取消分配等操作。</span></span><br><span class=\"line\">GET     /_cluster/nodes/hot_threads <span class=\"comment\"># 返回集群中各个节点“最热”的线程堆栈跟踪，默认显示前三个CPU时间最长的线程。</span></span><br><span class=\"line\">GET     /_cluster/allocation/explain <span class=\"comment\"># 解释为何某个分片被如此分配，并提供如何调整的建议。</span></span><br><span class=\"line\">GET     /_cluster/pending_tasks     <span class=\"comment\"># 列出所有等待执行的任务列表。</span></span><br><span class=\"line\">GET     /_cluster/settings          <span class=\"comment\"># 查看整个集群级别的设置。</span></span><br><span class=\"line\">PUT     /_cluster/settings          <span class=\"comment\"># 更新整个集群级别的设置。</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"Index-APIs\">Index APIs</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Elasticsearch 提供了 <a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/8.17/indices.html\">Index APIs</a>，它们提供了对索引的创建、更新、查询和删除等操作。</p>\n</li>\n<li class=\"lvl-2\">\n<p>创建索引</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># PUT /&lt;target&gt;</span></span><br><span class=\"line\"><span class=\"comment\"># 这里 shopping 为索引名称，但此时没有为索引设置分片策略，也没有设置字段信息</span></span><br><span class=\"line\">curl -X PUT -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># 返回值</span></span><br><span class=\"line\">&#123;<span class=\"string\">&quot;acknowledged&quot;</span>:<span class=\"literal\">true</span>,<span class=\"string\">&quot;shards_acknowledged&quot;</span>:<span class=\"literal\">true</span>,<span class=\"string\">&quot;index&quot;</span>:<span class=\"string\">&quot;shopping&quot;</span>&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>创建索引并设置索引</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># PUT /&lt;target&gt;</span></span><br><span class=\"line\">curl -X PUT -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;&quot;settings&quot;:&#123;&quot;number_of_shards&quot;:&quot;1&quot;,&quot;number_of_replicas&quot;:&quot;2&quot;&#125;&#125;&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># 返回值</span></span><br><span class=\"line\">&#123;<span class=\"string\">&quot;acknowledged&quot;</span>:<span class=\"literal\">true</span>,<span class=\"string\">&quot;shards_acknowledged&quot;</span>:<span class=\"literal\">true</span>,<span class=\"string\">&quot;index&quot;</span>:<span class=\"string\">&quot;shopping&quot;</span>&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>创建并映射索引</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># PUT /&lt;target&gt;</span></span><br><span class=\"line\"><span class=\"comment\"># 这里设置索引分片数量为1，副本数量为2，并设置字段信息</span></span><br><span class=\"line\">curl -X PUT -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;settings&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;number_of_shards&quot;:&quot;1&quot;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;number_of_replicas&quot;:&quot;2&quot;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;mappings&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;properties&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;title&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">          &quot;type&quot;:&quot;text&quot;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;category&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">          &quot;type&quot;:&quot;keyword&quot;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;price&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">          &quot;type&quot;:&quot;double&quot;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;count&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">          &quot;type&quot;:&quot;integer&quot;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;</span></span><br><span class=\"line\"><span class=\"string\">      &#125;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">  &#125;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 参数说明</span></span><br><span class=\"line\"><span class=\"comment\">## settings: 这个参数用于配置索引的设置，包括分片数量和副本数量。</span></span><br><span class=\"line\"><span class=\"comment\">### number_of_shards: 这个参数指定了索引中分片的数量。在这个例子中，number_of_shards 设置为 1，意味着索引将只有一个主分片。</span></span><br><span class=\"line\"><span class=\"comment\">### number_of_replicas: 这个参数指定了每个主分片的副本数量。在这个例子中，number_of_replicas 设置为 2，意味着每个主分片将有两个副本。</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## mappings: 这个参数用于定义索引中的字段和字段类型。</span></span><br><span class=\"line\"><span class=\"comment\">### properties: 这个参数定义了索引中的字段和字段类型。在这个例子中，有四个字段：title、category、images 和 price。</span></span><br><span class=\"line\"><span class=\"comment\">### title: 这个字段的类型是 text，表示它是一个全文检索字段。text 适合存储长文本数据，并支持全文搜索。</span></span><br><span class=\"line\"><span class=\"comment\">### category: 这个字段的类型是 keyword，表示它是一个关键字字段，不支持全文检索。keyword 适合存储不需要分词的短文本数据（如标签、类别等），并且可以用于聚合和过滤。</span></span><br><span class=\"line\"><span class=\"comment\">### price: 这个字段的类型是 double，表示它是一个数字字段。double 表示这是一个双精度浮点数字段，适合存储数值数据，如价格</span></span><br><span class=\"line\"><span class=\"comment\">### count: 这个字段的类型是 integer，表示它是一个整数字段。integer 表示这是一个整数字段，适合存储整数数据，如商品数量等。</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 返回值</span></span><br><span class=\"line\">&#123;<span class=\"string\">&quot;acknowledged&quot;</span>:<span class=\"literal\">true</span>,<span class=\"string\">&quot;shards_acknowledged&quot;</span>:<span class=\"literal\">true</span>,<span class=\"string\">&quot;index&quot;</span>:<span class=\"string\">&quot;shopping&quot;</span>&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>更新索引映射</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># PUT /&lt;target&gt;/_mapping</span></span><br><span class=\"line\"><span class=\"comment\"># 注意该api只能增加新的字段，不能修改已有字段，如果要修改源字段类型或者分词器类型，下文会介绍</span></span><br><span class=\"line\">curl -X PUT -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_mapping&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;properties&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;remark&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;type&quot;:&quot;text&quot;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;analyzer&quot;:&quot;ik_max_word&quot;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;search_analyzer&quot;:&quot;ik_smart&quot;</span></span><br><span class=\"line\"><span class=\"string\">      &#125;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;address&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;type&quot;: &quot;text&quot;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;analyzer&quot;: &quot;ik_max_word&quot;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;fields&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">          &quot;keyword&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">            &quot;type&quot;: &quot;keyword&quot;</span></span><br><span class=\"line\"><span class=\"string\">          &#125;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;</span></span><br><span class=\"line\"><span class=\"string\">      &#125;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;tags&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;type&quot;: &quot;keyword&quot;</span></span><br><span class=\"line\"><span class=\"string\">      &#125;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;created_at&quot;: &#123;&quot;type&quot;: &quot;date&quot;, &quot;format&quot;: &quot;yyyy-MM-dd HH:mm:ss&quot;&#125;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">  &#125;&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># 参数说明</span></span><br><span class=\"line\"><span class=\"comment\"># 这里为索引添加了4个字段</span></span><br><span class=\"line\"><span class=\"comment\"># remark：新增字段，类型为text，分词器为ik_max_word，搜索分词器为ik_smart</span></span><br><span class=\"line\">  <span class=\"comment\"># analyzer: 索引分词器</span></span><br><span class=\"line\">  <span class=\"comment\"># search_analyzer：搜索分词器</span></span><br><span class=\"line\">  <span class=\"comment\"># ik_max_word：中文分词器，将句子拆分为最多词元，适合长句子</span></span><br><span class=\"line\">  <span class=\"comment\"># ik_smart：中文分词器，将句子拆分为最少词元，适合短句子</span></span><br><span class=\"line\"><span class=\"comment\"># address：新增字段，类型为text，分词器为ik_max_word，搜索分词器未指定，默认与分词器同一个，这里还为address添加了keyword字段，用于存储原始数据，以支持精确搜索</span></span><br><span class=\"line\"><span class=\"comment\"># tags：新增字段，类型为keyword，不支持分词，适合存储短文本数据（如标签、类别等），并且可以用于聚合和过滤，可以存储数组</span></span><br><span class=\"line\"><span class=\"comment\"># created_at：新增字段，类型为date，格式为yyyy-MM-dd HH:mm:ss</span></span><br><span class=\"line\"><span class=\"comment\"># 返回值</span></span><br><span class=\"line\">&#123;<span class=\"string\">&quot;acknowledged&quot;</span>:<span class=\"literal\">true</span>&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>更新索引设置</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># PUT /&lt;target&gt;/_settings</span></span><br><span class=\"line\"><span class=\"comment\"># 注意这里不能更新number_of_shards</span></span><br><span class=\"line\">curl -X PUT -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_settings&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;&quot;number_of_replicas&quot;:&quot;1&quot;&#125;&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># 返回值</span></span><br><span class=\"line\">&#123;<span class=\"string\">&quot;acknowledged&quot;</span>:<span class=\"literal\">true</span>&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>查看指定索引</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># GET /&lt;target&gt;</span></span><br><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping?pretty&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># 返回值</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;shopping&quot;</span> : &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;aliases&quot;</span> : &#123; &#125;,</span><br><span class=\"line\">    <span class=\"string\">&quot;mappings&quot;</span> : &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;properties&quot;</span> : &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;address&quot;</span> : &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;text&quot;</span>,</span><br><span class=\"line\">          <span class=\"string\">&quot;fields&quot;</span> : &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;keyword&quot;</span> : &#123;</span><br><span class=\"line\">              <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;keyword&quot;</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;,</span><br><span class=\"line\">          <span class=\"string\">&quot;analyzer&quot;</span> : <span class=\"string\">&quot;ik_max_word&quot;</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;category&quot;</span> : &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;keyword&quot;</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;count&quot;</span> : &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;integer&quot;</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;created_at&quot;</span> : &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;date&quot;</span>,</span><br><span class=\"line\">          <span class=\"string\">&quot;format&quot;</span> : <span class=\"string\">&quot;yyyy-MM-dd HH:mm:ss&quot;</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;price&quot;</span> : &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;double&quot;</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;remark&quot;</span> : &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;text&quot;</span>,</span><br><span class=\"line\">          <span class=\"string\">&quot;analyzer&quot;</span> : <span class=\"string\">&quot;ik_max_word&quot;</span>,</span><br><span class=\"line\">          <span class=\"string\">&quot;search_analyzer&quot;</span> : <span class=\"string\">&quot;ik_smart&quot;</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;tags&quot;</span> : &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;keyword&quot;</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;title&quot;</span> : &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;text&quot;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">&quot;settings&quot;</span> : &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;index&quot;</span> : &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;routing&quot;</span> : &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;allocation&quot;</span> : &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;include&quot;</span> : &#123;</span><br><span class=\"line\">              <span class=\"string\">&quot;_tier_preference&quot;</span> : <span class=\"string\">&quot;data_content&quot;</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;number_of_shards&quot;</span> : <span class=\"string\">&quot;1&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;provided_name&quot;</span> : <span class=\"string\">&quot;shopping&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;creation_date&quot;</span> : <span class=\"string\">&quot;1745291743120&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;number_of_replicas&quot;</span> : <span class=\"string\">&quot;1&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;uuid&quot;</span> : <span class=\"string\">&quot;Y1IWrdlQTUm-CbbIWweSxQ&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;version&quot;</span> : &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;created&quot;</span> : <span class=\"string\">&quot;8525000&quot;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>查看索引设置</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># GET /&lt;target&gt;/_settings</span></span><br><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_settings?pretty&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># 返回值</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;shopping&quot;</span> : &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;mappings&quot;</span> : &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;properties&quot;</span> : &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;address&quot;</span> : &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;text&quot;</span>,</span><br><span class=\"line\">          <span class=\"string\">&quot;fields&quot;</span> : &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;keyword&quot;</span> : &#123;</span><br><span class=\"line\">              <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;keyword&quot;</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;,</span><br><span class=\"line\">          <span class=\"string\">&quot;analyzer&quot;</span> : <span class=\"string\">&quot;ik_max_word&quot;</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;category&quot;</span> : &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;keyword&quot;</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;count&quot;</span> : &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;integer&quot;</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;created_at&quot;</span> : &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;date&quot;</span>,</span><br><span class=\"line\">          <span class=\"string\">&quot;format&quot;</span> : <span class=\"string\">&quot;yyyy-MM-dd HH:mm:ss&quot;</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;price&quot;</span> : &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;double&quot;</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;remark&quot;</span> : &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;text&quot;</span>,</span><br><span class=\"line\">          <span class=\"string\">&quot;analyzer&quot;</span> : <span class=\"string\">&quot;ik_max_word&quot;</span>,</span><br><span class=\"line\">          <span class=\"string\">&quot;search_analyzer&quot;</span> : <span class=\"string\">&quot;ik_smart&quot;</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;tags&quot;</span> : &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;keyword&quot;</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;title&quot;</span> : &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;text&quot;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>查看字段映射</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># GET /&lt;target&gt;/_mapping/field/&lt;field&gt;</span></span><br><span class=\"line\"><span class=\"comment\"># shopping 为索引名称，title 为字段名称</span></span><br><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_mapping/field/title?pretty&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># 返回值</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;shopping&quot;</span> : &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;mappings&quot;</span> : &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;title&quot;</span> : &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;full_name&quot;</span> : <span class=\"string\">&quot;title&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;mapping&quot;</span> : &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;title&quot;</span> : &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;text&quot;</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>判断索引是否存在</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 使用 -I 参数来发送 HEAD 请求，可以获取响应头而不必下载响应体。</span></span><br><span class=\"line\"><span class=\"comment\"># HEAD /&lt;target&gt;</span></span><br><span class=\"line\">curl -I -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># 返回值</span></span><br><span class=\"line\">HTTP/1.1 200 OK</span><br><span class=\"line\">X-elastic-product: Elasticsearch</span><br><span class=\"line\">content-type: application/json</span><br><span class=\"line\">content-length: 603</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 这个命令不会返回响应体，但它的 HTTP 响应代码可以告诉你索引的存在情况：</span></span><br><span class=\"line\">  <span class=\"comment\"># 200 OK 表示索引存在。</span></span><br><span class=\"line\">  <span class=\"comment\"># 404 Not Found 表示索引不存在。</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>删除索引</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># DELETE /&lt;target&gt;</span></span><br><span class=\"line\">curl -X DELETE -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># 返回值</span></span><br><span class=\"line\">&#123;<span class=\"string\">&quot;acknowledged&quot;</span>:<span class=\"literal\">true</span>&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>为索引创建别名</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 注意：不同索引可以有相同名称的别名，所以在数据结构一致的情况下，我们可以为不同的索引创建相同的别名，然后根据别名进行数据查询</span></span><br><span class=\"line\"><span class=\"comment\"># POST /&lt;target&gt;/_alias/&lt;alias&gt;</span></span><br><span class=\"line\">curl -X POST -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_alias/shopping_alias&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># 返回值</span></span><br><span class=\"line\">&#123;<span class=\"string\">&quot;acknowledged&quot;</span>:<span class=\"literal\">true</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 也可以使用如下方法</span></span><br><span class=\"line\">curl -X POST -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/_aliases&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;actions&quot;: [</span></span><br><span class=\"line\"><span class=\"string\">      &#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;add&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">          &quot;index&quot;: &quot;shopping&quot;,</span></span><br><span class=\"line\"><span class=\"string\">          &quot;alias&quot;: &quot;shopping_alias2&quot;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;</span></span><br><span class=\"line\"><span class=\"string\">      &#125;</span></span><br><span class=\"line\"><span class=\"string\">    ]</span></span><br><span class=\"line\"><span class=\"string\">  &#125;&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># 返回值</span></span><br><span class=\"line\">&#123;<span class=\"string\">&quot;acknowledged&quot;</span>:<span class=\"literal\">true</span>&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>查看索引别名</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># GET /&lt;target&gt;/_alias/&lt;alias&gt;</span></span><br><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_alias/shopping_alias?pretty&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># 返回值</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;shopping&quot;</span> : &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;aliases&quot;</span> : &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;shopping_alias&quot;</span> : &#123; &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看当前索引的所有别名</span></span><br><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_alias?pretty&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看所有索引的别名</span></span><br><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/_alias?pretty&#x27;</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>为索引删除别名</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># DELETE /&lt;target&gt;/_alias/&lt;alias&gt;</span></span><br><span class=\"line\">curl -X DELETE -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_alias/shopping_alias&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># 返回值</span></span><br><span class=\"line\">&#123;<span class=\"string\">&quot;acknowledged&quot;</span>:<span class=\"literal\">true</span>&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"如何修改索引字段类型或分词器类型？\">如何修改索引字段类型或分词器类型？</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>创建新的索引</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 这里为title字段增加分词器</span></span><br><span class=\"line\">curl -X PUT -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping_new&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;settings&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;number_of_shards&quot;:&quot;1&quot;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;number_of_replicas&quot;:&quot;2&quot;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;mappings&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;properties&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;category&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">          &quot;type&quot;:&quot;keyword&quot;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;price&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">          &quot;type&quot;:&quot;double&quot;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;count&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">          &quot;type&quot;:&quot;integer&quot;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;title&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">          &quot;type&quot;:&quot;text&quot;,</span></span><br><span class=\"line\"><span class=\"string\">          &quot;analyzer&quot;:&quot;ik_max_word&quot;,</span></span><br><span class=\"line\"><span class=\"string\">          &quot;search_analyzer&quot;:&quot;ik_smart&quot;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;remark&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;type&quot;:&quot;text&quot;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;analyzer&quot;:&quot;ik_max_word&quot;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;search_analyzer&quot;:&quot;ik_smart&quot;</span></span><br><span class=\"line\"><span class=\"string\">      &#125;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;address&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;type&quot;: &quot;text&quot;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;analyzer&quot;: &quot;ik_max_word&quot;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;fields&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">          &quot;keyword&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">            &quot;type&quot;: &quot;keyword&quot;</span></span><br><span class=\"line\"><span class=\"string\">          &#125;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;</span></span><br><span class=\"line\"><span class=\"string\">      &#125;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;tags&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;type&quot;: &quot;keyword&quot;</span></span><br><span class=\"line\"><span class=\"string\">      &#125;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;created_at&quot;: &#123;&quot;type&quot;: &quot;date&quot;, &quot;format&quot;: &quot;yyyy-MM-dd HH:mm:ss&quot;&#125;</span></span><br><span class=\"line\"><span class=\"string\">      &#125;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">  &#125;&#x27;</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>将原索引的数据迁移到新索引</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -X POST -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/_reindex&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">  &quot;source&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;index&quot;: &quot;shopping&quot;</span></span><br><span class=\"line\"><span class=\"string\">  &#125;,</span></span><br><span class=\"line\"><span class=\"string\">  &quot;dest&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;index&quot;: &quot;shopping_new&quot;</span></span><br><span class=\"line\"><span class=\"string\">  &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#125;&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># 返回值</span></span><br><span class=\"line\">&#123;<span class=\"string\">&quot;took&quot;</span>:101,<span class=\"string\">&quot;timed_out&quot;</span>:<span class=\"literal\">false</span>,<span class=\"string\">&quot;total&quot;</span>:2,<span class=\"string\">&quot;updated&quot;</span>:0,<span class=\"string\">&quot;created&quot;</span>:2,<span class=\"string\">&quot;deleted&quot;</span>:0,<span class=\"string\">&quot;batches&quot;</span>:1,<span class=\"string\">&quot;version_conflicts&quot;</span>:0,<span class=\"string\">&quot;noops&quot;</span>:0,<span class=\"string\">&quot;retries&quot;</span>:&#123;<span class=\"string\">&quot;bulk&quot;</span>:0,<span class=\"string\">&quot;search&quot;</span>:0&#125;,<span class=\"string\">&quot;throttled_millis&quot;</span>:0,<span class=\"string\">&quot;requests_per_second&quot;</span>:-1.0,<span class=\"string\">&quot;throttled_until_millis&quot;</span>:0,<span class=\"string\">&quot;failures&quot;</span>:[]&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>删除原索引</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -X DELETE -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># 返回值</span></span><br><span class=\"line\">&#123;<span class=\"string\">&quot;acknowledged&quot;</span>:<span class=\"literal\">true</span>&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>为新索引创建别名</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -X POST -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping_new/_alias/shopping&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># 返回值</span></span><br><span class=\"line\">&#123;<span class=\"string\">&quot;acknowledged&quot;</span>:<span class=\"literal\">true</span>,<span class=\"string\">&quot;errors&quot;</span>:<span class=\"literal\">false</span>&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"数据增删改基本操作\">数据增删改基本操作</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>新增数据</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-4\">1.为指定索引插入一条数据(_doc方式：不指定id默认随机字符串)</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># _doc 的方式创建索引数据时，可以不指定id，默认会创建新的id，id类型为随机字符串</span></span><br><span class=\"line\"><span class=\"comment\"># POST /&lt;target&gt;/_doc</span></span><br><span class=\"line\">curl -X POST -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_doc?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;category&quot;: &quot;electronics&quot;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;price&quot;: 999.99,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;count&quot;: 10,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;title&quot;: &quot;Smartphone X - 128GB&quot;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;remark&quot;: &quot;This latest Smartphone X comes with a powerful processor and high-resolution camera.&quot;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;address&quot;: &quot;123 Electronic Ave, Beijing, China&quot;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;tags&quot;: [&quot;latest&quot;, &quot;smartphone&quot;, &quot;technology&quot;],</span></span><br><span class=\"line\"><span class=\"string\">    &quot;created_at&quot;: &quot;2025-04-22 03:30:02&quot;</span></span><br><span class=\"line\"><span class=\"string\">  &#125;&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># 返回值</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;_index&quot;</span> : <span class=\"string\">&quot;shopping_new&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;_id&quot;</span> : <span class=\"string\">&quot;sImNW5YBmgASmV9McVvI&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;_version&quot;</span> : 1,</span><br><span class=\"line\">  <span class=\"string\">&quot;result&quot;</span> : <span class=\"string\">&quot;created&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;_shards&quot;</span> : &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;total&quot;</span> : 3,</span><br><span class=\"line\">    <span class=\"string\">&quot;successful&quot;</span> : 1,</span><br><span class=\"line\">    <span class=\"string\">&quot;failed&quot;</span> : 0</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;_seq_no&quot;</span> : 1,</span><br><span class=\"line\">  <span class=\"string\">&quot;_primary_term&quot;</span> : 1</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-2\">\n<li class=\"lvl-4\">2.为指定索引插入一条数据(_doc方式：指定id)</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># _doc 的方式创建索引数据时，如果指定id，再次执行时会先删除原数据再创建新数据，所以必须全量更新才行。</span></span><br><span class=\"line\"><span class=\"comment\"># PUT /&lt;target&gt;/_doc</span></span><br><span class=\"line\">curl -X PUT -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_doc/100?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;category&quot;: &quot;electronics&quot;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;price&quot;: 999.99,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;count&quot;: 10,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;title&quot;: &quot;Smartphone X - 128GB&quot;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;remark&quot;: &quot;This latest Smartphone X comes with a powerful processor and high-resolution camera.&quot;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;address&quot;: &quot;123 Electronic Ave, Beijing, China&quot;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;tags&quot;: [&quot;latest&quot;, &quot;smartphone&quot;, &quot;technology&quot;],</span></span><br><span class=\"line\"><span class=\"string\">    &quot;created_at&quot;: &quot;2025-04-22 03:30:02&quot;</span></span><br><span class=\"line\"><span class=\"string\">  &#125;&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># 返回值</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;_index&quot;</span> : <span class=\"string\">&quot;shopping_new&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;_id&quot;</span> : <span class=\"string\">&quot;100&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;_version&quot;</span> : 1,</span><br><span class=\"line\">  <span class=\"string\">&quot;result&quot;</span> : <span class=\"string\">&quot;created&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;_shards&quot;</span> : &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;total&quot;</span> : 3,</span><br><span class=\"line\">    <span class=\"string\">&quot;successful&quot;</span> : 1,</span><br><span class=\"line\">    <span class=\"string\">&quot;failed&quot;</span> : 0</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;_seq_no&quot;</span> : 2,</span><br><span class=\"line\">  <span class=\"string\">&quot;_primary_term&quot;</span> : 1</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-2\">\n<li class=\"lvl-4\">\n<p>3.为指定索引插入一条数据(_create方式：指定id)</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># _create 的方式创建索引数据时，必须指定id,而且只能执行一次，因为执行过一次后指定id的数据就存在了，不能再次创建</span></span><br><span class=\"line\"><span class=\"comment\"># POST /&lt;target&gt;/_create/&lt;id&gt;</span></span><br><span class=\"line\">curl -X POST -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_create/1?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;category&quot;: &quot;electronics&quot;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;price&quot;: 999.99,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;count&quot;: 10,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;title&quot;: &quot;Smartphone X - 128GB&quot;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;remark&quot;: &quot;This latest Smartphone X comes with a powerful processor and high-resolution camera.&quot;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;address&quot;: &quot;123 Electronic Ave, Beijing, China&quot;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;tags&quot;: [&quot;latest&quot;, &quot;smartphone&quot;, &quot;technology&quot;],</span></span><br><span class=\"line\"><span class=\"string\">    &quot;created_at&quot;: &quot;2025-04-22 03:30:02&quot;</span></span><br><span class=\"line\"><span class=\"string\">  &#125;&#x27;</span></span><br></pre></td></tr></table></figure>\n</li>\n<li class=\"lvl-2\">\n<p>修改数据</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-4\">1.修改全部数据</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># POST /&lt;target&gt;/_doc/&lt;id&gt;</span></span><br><span class=\"line\"><span class=\"comment\"># 执行时会先删除原数据再创建新数据，所以必须全量更新才行。</span></span><br><span class=\"line\">curl -X POST -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_doc/sImNW5YBmgASmV9McVvI&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;category&quot;: &quot;electronics&quot;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;price&quot;: 999.99,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;count&quot;: 20,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;title&quot;: &quot;Smartphone X - 128GB&quot;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;remark&quot;: &quot;This latest Smartphone X comes with a powerful processor and high-resolution camera.&quot;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;address&quot;: &quot;123 Electronic Ave, Beijing, China&quot;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;tags&quot;: [&quot;latest&quot;, &quot;smartphone&quot;, &quot;technology&quot;],</span></span><br><span class=\"line\"><span class=\"string\">    &quot;created_at&quot;: &quot;2025-04-22 03:30:02&quot;</span></span><br><span class=\"line\"><span class=\"string\">  &#125;&#x27;</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-2\">\n<li class=\"lvl-4\">2.修改部分数据</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># POST /&lt;target&gt;/_update/&lt;id&gt;</span></span><br><span class=\"line\"><span class=\"comment\"># 执行时只会修改指定字段，不会删除原数据，所以可以部分更新。</span></span><br><span class=\"line\">curl -X POST -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_update/1&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;&quot;doc&quot;:&#123;&quot;count&quot;:100&#125;&#125;&#x27;</span></span><br></pre></td></tr></table></figure>\n</li>\n<li class=\"lvl-2\">\n<p>查询指定索引的指定id的数据</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># GET /&lt;target&gt;/_doc/&lt;id&gt;</span></span><br><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_doc/100?pretty&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># 返回值</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;_index&quot;</span> : <span class=\"string\">&quot;shopping_new&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;_id&quot;</span> : <span class=\"string\">&quot;100&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;_version&quot;</span> : 1,</span><br><span class=\"line\">  <span class=\"string\">&quot;_seq_no&quot;</span> : 2,</span><br><span class=\"line\">  <span class=\"string\">&quot;_primary_term&quot;</span> : 1,</span><br><span class=\"line\">  <span class=\"string\">&quot;found&quot;</span> : <span class=\"literal\">true</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;_source&quot;</span> : &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;category&quot;</span> : <span class=\"string\">&quot;electronics&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;price&quot;</span> : 999.99,</span><br><span class=\"line\">    <span class=\"string\">&quot;count&quot;</span> : 10,</span><br><span class=\"line\">    <span class=\"string\">&quot;title&quot;</span> : <span class=\"string\">&quot;Smartphone X - 128GB&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;remark&quot;</span> : <span class=\"string\">&quot;This latest Smartphone X comes with a powerful processor and high-resolution camera.&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;address&quot;</span> : <span class=\"string\">&quot;123 Electronic Ave, Beijing, China&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;tags&quot;</span> : [</span><br><span class=\"line\">      <span class=\"string\">&quot;latest&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;smartphone&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;technology&quot;</span></span><br><span class=\"line\">    ],</span><br><span class=\"line\">    <span class=\"string\">&quot;created_at&quot;</span> : <span class=\"string\">&quot;2025-04-22 03:30:02&quot;</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>删除指定索引的指定id的数据</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># DELETE /&lt;target&gt;/_doc/&lt;id&gt;</span></span><br><span class=\"line\">curl -X DELETE -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_doc/100&#x27;</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>删除索引全部数据</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -X POST -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_delete_by_query?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;&quot;query&quot;:&#123;&quot;match_all&quot;:&#123;&#125;&#125;&#125;&#x27;</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"批量操作\">批量操作</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>批量新增数据</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 注意数据行要顶行写，前面不要有空格</span></span><br><span class=\"line\"><span class=\"comment\"># POST /_bulk</span></span><br><span class=\"line\">curl -X POST -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/_bulk&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123; &quot;index&quot;: &#123; &quot;_index&quot;: &quot;shopping&quot;, &quot;_id&quot;: &quot;1&quot; &#125; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;category&quot;: &quot;electronics&quot;, &quot;price&quot;: 999.99, &quot;count&quot;: 10, &quot;title&quot;: &quot;Smartphone X - 128GB&quot;, &quot;remark&quot;: &quot;This latest Smartphone X comes with a powerful processor and high-resolution camera.&quot;, &quot;address&quot;: &quot;广州天河公园&quot;, &quot;tags&quot;: [&quot;latest&quot;, &quot;smartphone&quot;, &quot;technology&quot;], &quot;created_at&quot;: &quot;2025-04-22 03:30:02&quot; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;index&quot;: &#123; &quot;_index&quot;: &quot;shopping&quot;, &quot;_id&quot;: &quot;2&quot; &#125; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;category&quot;: &quot;fashion&quot;, &quot;price&quot;: 49.99, &quot;count&quot;: 25, &quot;title&quot;: &quot;Designer T-shirt&quot;, &quot;remark&quot;: &quot;Trendy designer T-shirt made with high quality fabric.&quot;, &quot;address&quot;: &quot;广州荔湾大厦&quot;, &quot;tags&quot;: [&quot;clothing&quot;, &quot;designer&quot;, &quot;style&quot;], &quot;created_at&quot;: &quot;2025-04-21 12:15:00&quot; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;index&quot;: &#123; &quot;_index&quot;: &quot;shopping&quot;, &quot;_id&quot;: &quot;3&quot; &#125; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;category&quot;: &quot;home_appliances&quot;, &quot;price&quot;: 299.99, &quot;count&quot;: 5, &quot;title&quot;: &quot;Robot Vacuum Cleaner&quot;, &quot;remark&quot;: &quot;Efficient robot vacuum cleaner with smart navigation.&quot;, &quot;address&quot;: &quot;广州白云山公园&quot;, &quot;tags&quot;: [&quot;appliances&quot;, &quot;vacuum&quot;, &quot;robot&quot;], &quot;created_at&quot;: &quot;2025-04-20 08:45:30&quot; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;index&quot;: &#123; &quot;_index&quot;: &quot;shopping&quot;, &quot;_id&quot;: &quot;4&quot; &#125; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;category&quot;: &quot;books&quot;, &quot;price&quot;: 19.99, &quot;count&quot;: 100, &quot;title&quot;: &quot;Inspirational Novel&quot;, &quot;remark&quot;: &quot;A gripping novel that inspires and motivates.&quot;, &quot;address&quot;: &quot;321 Book Rd, Shenzhen, China&quot;, &quot;tags&quot;: [&quot;book&quot;, &quot;novel&quot;, &quot;inspiration&quot;], &quot;created_at&quot;: &quot;2025-04-19 10:05:00&quot; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;index&quot;: &#123; &quot;_index&quot;: &quot;shopping&quot;, &quot;_id&quot;: &quot;5&quot; &#125; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;category&quot;: &quot;groceries&quot;, &quot;price&quot;: 3.99, &quot;count&quot;: 200, &quot;title&quot;: &quot;Organic Apples&quot;, &quot;remark&quot;: &quot;Fresh and crispy organic apples.&quot;, &quot;address&quot;: &quot;654 Grocery Ln, Chengdu, China&quot;, &quot;tags&quot;: [&quot;fruit&quot;, &quot;organic&quot;, &quot;healthy&quot;], &quot;created_at&quot;: &quot;2025-04-18 14:30:45&quot; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;index&quot;: &#123; &quot;_index&quot;: &quot;shopping&quot;, &quot;_id&quot;: &quot;6&quot; &#125; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;category&quot;: &quot;electronics&quot;, &quot;price&quot;: 1999.99, &quot;count&quot;: 15, &quot;title&quot;: &quot;Smartphone X - 256GB&quot;, &quot;remark&quot;: &quot;This latest Smartphone X comes with a powerful processor and high-resolution camera.&quot;, &quot;address&quot;: &quot;广州天河公园&quot;, &quot;tags&quot;: [&quot;latest&quot;, &quot;smartphone&quot;, &quot;technology&quot;], &quot;created_at&quot;: &quot;2025-04-22 03:30:02&quot; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># 参数说明</span></span><br><span class=\"line\"><span class=\"comment\"># index: 用于创建新文档或替换已有文档。</span></span><br><span class=\"line\"><span class=\"comment\"># create: 用于创建新文档，如果文档已存在，则返回错误。</span></span><br><span class=\"line\"><span class=\"comment\"># _index: 指定索引名称。</span></span><br><span class=\"line\"><span class=\"comment\"># _id: 指定文档ID。如果不指定则会自动生成一个随机的ID。</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 批量新增数据时也可以在url中指定索引名称</span></span><br><span class=\"line\"><span class=\"comment\"># 此时可以指定id，如果不指定则自动生成一个随机字符串的ID</span></span><br><span class=\"line\"><span class=\"comment\"># POST /&lt;target&gt;/_bulk</span></span><br><span class=\"line\">curl -X POST -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_bulk&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123; &quot;index&quot;: &#123;&#125; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;category&quot;: &quot;electronics&quot;, &quot;price&quot;: 999.99, &quot;count&quot;: 10, &quot;title&quot;: &quot;Smartphone X - 128GB&quot;, &quot;remark&quot;: &quot;This latest Smartphone X comes with a powerful processor and high-resolution camera.&quot;, &quot;address&quot;: &quot;广州天河公园&quot;, &quot;tags&quot;: [&quot;latest&quot;, &quot;smartphone&quot;, &quot;technology&quot;], &quot;created_at&quot;: &quot;2025-04-22 03:30:02&quot; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;index&quot;: &#123;&#125; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;category&quot;: &quot;fashion&quot;, &quot;price&quot;: 49.99, &quot;count&quot;: 25, &quot;title&quot;: &quot;Designer T-shirt&quot;, &quot;remark&quot;: &quot;Trendy designer T-shirt made with high quality fabric.&quot;, &quot;address&quot;: &quot;广州荔湾大厦&quot;, &quot;tags&quot;: [&quot;clothing&quot;, &quot;designer&quot;, &quot;style&quot;], &quot;created_at&quot;: &quot;2025-04-21 12:15:00&quot; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;index&quot;: &#123;&#125; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;category&quot;: &quot;home_appliances&quot;, &quot;price&quot;: 299.99, &quot;count&quot;: 5, &quot;title&quot;: &quot;Robot Vacuum Cleaner&quot;, &quot;remark&quot;: &quot;Efficient robot vacuum cleaner with smart navigation.&quot;, &quot;address&quot;: &quot;广州白云山公园&quot;, &quot;tags&quot;: [&quot;appliances&quot;, &quot;vacuum&quot;, &quot;robot&quot;], &quot;created_at&quot;: &quot;2025-04-20 08:45:30&quot; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;index&quot;: &#123;&#125; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;category&quot;: &quot;books&quot;, &quot;price&quot;: 19.99, &quot;count&quot;: 100, &quot;title&quot;: &quot;Inspirational Novel&quot;, &quot;remark&quot;: &quot;A gripping novel that inspires and motivates.&quot;, &quot;address&quot;: &quot;321 Book Rd, Shenzhen, China&quot;, &quot;tags&quot;: [&quot;book&quot;, &quot;novel&quot;, &quot;inspiration&quot;], &quot;created_at&quot;: &quot;2025-04-19 10:05:00&quot; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;index&quot;: &#123;&#125; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;category&quot;: &quot;groceries&quot;, &quot;price&quot;: 3.99, &quot;count&quot;: 200, &quot;title&quot;: &quot;Organic Apples&quot;, &quot;remark&quot;: &quot;Fresh and crispy organic apples.&quot;, &quot;address&quot;: &quot;654 Grocery Ln, Chengdu, China&quot;, &quot;tags&quot;: [&quot;fruit&quot;, &quot;organic&quot;, &quot;healthy&quot;], &quot;created_at&quot;: &quot;2025-04-18 14:30:45&quot; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;index&quot;: &#123;&#125; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;category&quot;: &quot;electronics&quot;, &quot;price&quot;: 1999.99, &quot;count&quot;: 15, &quot;title&quot;: &quot;Smartphone X - 256GB&quot;, &quot;remark&quot;: &quot;This latest Smartphone X comes with a powerful processor and high-resolution camera.&quot;, &quot;address&quot;: &quot;广州天河公园&quot;, &quot;tags&quot;: [&quot;latest&quot;, &quot;smartphone&quot;, &quot;technology&quot;], &quot;created_at&quot;: &quot;2025-04-22 03:30:02&quot; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#x27;</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>批量修改数据</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 注意数据行要顶行写，前面不要有空格</span></span><br><span class=\"line\">curl -X POST -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/_bulk&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;&quot;update&quot;:&#123;&quot;_index&quot;:&quot;shopping&quot;,&quot;_id&quot;:&quot;1&quot;&#125;&#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123;&quot;doc&quot;:&#123;&quot;title&quot;:&quot;Smartphone X2 - 128GB&quot;,&quot;price&quot;:1000.11&#125;&#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123;&quot;update&quot;:&#123;&quot;_index&quot;:&quot;shopping&quot;,&quot;_id&quot;:&quot;2&quot;&#125;&#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123;&quot;doc&quot;:&#123;&quot;title&quot;:&quot;T-shirt&quot;,&quot;price&quot;:45.99&#125;&#125;</span></span><br><span class=\"line\"><span class=\"string\">&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># 参数说明</span></span><br><span class=\"line\"><span class=\"comment\"># update: 用于更新文档。</span></span><br><span class=\"line\"><span class=\"comment\"># doc: 指定要更新的字段。</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>批量删除数据</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 注意数据行要顶行写，前面不要有空格</span></span><br><span class=\"line\">curl -X POST -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/_bulk&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;&quot;delete&quot;:&#123;&quot;_index&quot;:&quot;shopping&quot;,&quot;_id&quot;:&quot;1&quot;&#125;&#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123;&quot;delete&quot;:&#123;&quot;_index&quot;:&quot;shopping&quot;,&quot;_id&quot;:&quot;2&quot;&#125;&#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123;&quot;delete&quot;:&#123;&quot;_index&quot;:&quot;shopping&quot;,&quot;_id&quot;:&quot;3&quot;&#125;&#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123;&quot;delete&quot;:&#123;&quot;_index&quot;:&quot;shopping&quot;,&quot;_id&quot;:&quot;4&quot;&#125;&#125;</span></span><br><span class=\"line\"><span class=\"string\">&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># 参数说明</span></span><br><span class=\"line\"><span class=\"comment\"># delete: 用于删除文档。</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"条件更新\">条件更新</h2>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># POST /&lt;target&gt;/_update_by_query</span></span><br><span class=\"line\"><span class=\"comment\"># 这里将category为华为的数据价格改为1999</span></span><br><span class=\"line\">curl -X POST -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_update_by_query?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;query&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;match&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;category&quot;: &quot;books&quot;</span></span><br><span class=\"line\"><span class=\"string\">      &#125;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;script&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;source&quot;: &quot;ctx._source.price = 20.99&quot;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;lang&quot;: &quot;painless&quot;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">  &#125;&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># 参数说明</span></span><br><span class=\"line\"><span class=\"comment\">## &quot;query&quot;: &#123;&#125;  查询条件</span></span><br><span class=\"line\"><span class=\"comment\">## &quot;script&quot;: &#123;&#125;  脚本</span></span><br><span class=\"line\"><span class=\"comment\">### source: 脚本内容</span></span><br><span class=\"line\"><span class=\"comment\">### lang: 脚本语言</span></span><br><span class=\"line\"><span class=\"comment\">#### painless 是 Elasticsearch 官方提供的脚本语言，它提供了许多内置函数和变量，可以方便地实现各种复杂的逻辑操作。https://www.elastic.co/guide/en/elasticsearch/painless/current/painless-lang-spec.html</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"条件删除\">条件删除</h2>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># POST /&lt;target&gt;/_delete_by_query</span></span><br><span class=\"line\">curl -X POST -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_delete_by_query?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;&quot;query&quot;:&#123;&quot;match&quot;:&#123;&quot;category&quot;:&quot;books&quot;&#125;&#125;&#125;&#x27;</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"条件查询\">条件查询</h2>\n<h3 id=\"match-all-全部匹配查询\">match_all: 全部匹配查询</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># GET /&lt;target&gt;/_search</span></span><br><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span></span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;&quot;query&quot;:&#123;&quot;match_all&quot;:&#123;&#125;&#125;&#125;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 或者简写为</span></span><br><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"term-精确匹配查询（关键字查询，即不分词）\">term: 精确匹配查询（关键字查询，即不分词）</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;&quot;query&quot;:&#123;&quot;term&quot;:&#123;&quot;category&quot;:&quot;electronics&quot;&#125;&#125;&#125;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 如果字段被额外设置 keyword 类型，则需要加上 .keyword 后缀</span></span><br><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;&quot;query&quot;:&#123;&quot;term&quot;:&#123;&quot;address.keyword&quot;:&quot;广州白云山公园&quot;&#125;&#125;&#125;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># term处理多值字段(数组)时，term查询是包含，不是等于</span></span><br><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;&quot;query&quot;:&#123;&quot;term&quot;:&#123;&quot;tags&quot;:&quot;technology&quot;&#125;&#125;&#125;&#x27;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"terms-多关键字精确匹配查询\">terms: 多关键字精确匹配查询</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;&quot;query&quot;:&#123;&quot;terms&quot;:&#123;&quot;category&quot;:[&quot;electronics&quot;,&quot;books&quot;]&#125;&#125;&#125;&#x27;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"range-范围查询\">range: 范围查询</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;&quot;query&quot;:&#123;&quot;range&quot;:&#123;&quot;price&quot;:&#123;&quot;gte&quot;:20,&quot;lte&quot;:30&#125;&#125;&#125;&#125;&#x27;</span></span><br><span class=\"line\">  <span class=\"comment\"># gte: 大于等于</span></span><br><span class=\"line\">  <span class=\"comment\"># lte: 小于等于</span></span><br><span class=\"line\">  <span class=\"comment\"># gt: 大于</span></span><br><span class=\"line\">  <span class=\"comment\"># lt: 小于</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 时间范围查询</span></span><br><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;&quot;query&quot;:&#123;&quot;range&quot;:&#123;&quot;created_at&quot;:&#123;&quot;gte&quot;:&quot;2025-04-20 00:00:00&quot;,&quot;lte&quot;:&quot;2025-05-20 23:59:59&quot;&#125;&#125;&#125;&#125;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 基于日期数学表达式查询</span></span><br><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;&quot;query&quot;:&#123;&quot;range&quot;:&#123;&quot;created_at&quot;:&#123;&quot;gte&quot;:&quot;now-1y&quot;&#125;&#125;&#125;&#125;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 支持的日期表达式</span></span><br><span class=\"line\"><span class=\"comment\"># - now：当前时间点。</span></span><br><span class=\"line\"><span class=\"comment\"># - now-1d：从当前时间点向前推1天的时间点。</span></span><br><span class=\"line\"><span class=\"comment\"># - now-1w：从当前时间点向前推1周的时间点。</span></span><br><span class=\"line\"><span class=\"comment\"># - now-1M：从当前时间点向前推1个月的时间点。</span></span><br><span class=\"line\"><span class=\"comment\"># - now-1y：从当前时间点向前推1年的时间点。</span></span><br><span class=\"line\"><span class=\"comment\"># - now+1h：从当前时间点向后推1小时的时间点。</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"exists-查询字段存在的数据\">exists: 查询字段存在的数据</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;&quot;query&quot;:&#123;&quot;exists&quot;:&#123;&quot;field&quot;:&quot;title&quot;&#125;&#125;&#125;&#x27;</span></span><br><span class=\"line\">  <span class=\"comment\"># field: 指定要查询的字段</span></span><br><span class=\"line\">  <span class=\"comment\"># 示例：查询 title 字段存在的文档</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"ids-根据一组ID查询\">ids: 根据一组ID查询</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;&quot;query&quot;:&#123;&quot;ids&quot;:&#123;&quot;values&quot;:[&quot;1&quot;,&quot;2&quot;]&#125;&#125;&#125;&#x27;</span></span><br><span class=\"line\">  <span class=\"comment\"># values: 指定要查询的ID列表</span></span><br><span class=\"line\">  <span class=\"comment\"># 示例：查询ID为1和2的文档</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"prefix-前缀查询\">prefix: 前缀查询</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>仅适用于关键字类型(keyword)的字段</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;&quot;query&quot;:&#123;&quot;prefix&quot;:&#123;&quot;category&quot;:&quot;elec&quot;&#125;&#125;&#125;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 仅适用于keyword类型字段，所以下面这个请求查询不到数据</span></span><br><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;&quot;query&quot;:&#123;&quot;prefix&quot;:&#123;&quot;address&quot;:&quot;广州白云山&quot;&#125;&#125;&#125;&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># 因为address被附加了keyword类型，所以需要加上.keyword后缀后可以查询到数据</span></span><br><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;&quot;query&quot;:&#123;&quot;prefix&quot;:&#123;&quot;address.keyword&quot;:&quot;广州白云山&quot;&#125;&#125;&#125;&#x27;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"wildcard-通配符查询\">wildcard: 通配符查询</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>仅适用于关键字类型(keyword)的字段</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;&quot;query&quot;:&#123;&quot;wildcard&quot;:&#123;&quot;category&quot;:&quot;e?e*&quot;&#125;&#125;&#125;&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># ?: 任意单个字符</span></span><br><span class=\"line\"><span class=\"comment\"># *: 任意多个字符</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"regexp-正则表达式查询\">regexp: 正则表达式查询</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>仅适用于关键字类型(keyword)的字段</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;&quot;query&quot;:&#123;&quot;regexp&quot;:&#123;&quot;category&quot;:&quot;e.e.*&quot;&#125;&#125;&#125;&#x27;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"fuzzy-支持编辑距离的模糊查询\">fuzzy: 支持编辑距离的模糊查询</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>仅适用于关键字类型(keyword)的字段</p>\n</li>\n<li class=\"lvl-2\">\n<p>fuzzy检索是一种强大的搜索功能，它能够在用户输入内容存在拼写错误或上下文不一致时，仍然返回与搜索词相似的文档。通过使用编辑距离算法来度量输入词与文档中词条的相似程度，模糊查询在保证搜索结果相关性的同时，有效地提高了搜索容错能力。</p>\n</li>\n<li class=\"lvl-2\">\n<p>编辑距离是指从一个单词转换到另一个单词需要编辑单字符的次数。如中文集团到中威集团编辑距离就是1，只需要修改一个字符；如果fuzziness值在这里设置成2，会把编辑距离为2的东东集团也查出来。</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;query&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;fuzzy&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">          &quot;category&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">            &quot;value&quot;:&quot;beeks&quot;,</span></span><br><span class=\"line\"><span class=\"string\">            &quot;fuzziness&quot;:&quot;2&quot;,</span></span><br><span class=\"line\"><span class=\"string\">            &quot;prefix_length&quot;:1</span></span><br><span class=\"line\"><span class=\"string\">          &#125;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;</span></span><br><span class=\"line\"><span class=\"string\">      &#125;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># fuzziness：用于编辑距离的设置，其默认值为AUTO，支持的数值为[0，1，2]。如果值设置越界会报错。</span></span><br><span class=\"line\"><span class=\"comment\"># prefix_length: 搜索词的前缀长度，在此长度内不会应用模糊匹配。默认是0，即整个词都会被模糊匹配。</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"match-全文检索-即分词\">match: 全文检索(即分词)</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;&quot;query&quot;:&#123;&quot;match&quot;:&#123;&quot;address&quot;:&quot;广州白云山公园&quot;&#125;&#125;&#125;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 因为 desc 的索引分词器是 ik_max_word，查看“广州白云山公园”被分词后的结果</span></span><br><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/_analyze?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;analyzer&quot;: &quot;ik_max_word&quot;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;text&quot;: &quot;广州白云山公园&quot;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># 返回值</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;tokens&quot;</span> : [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;token&quot;</span> : <span class=\"string\">&quot;广州&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;start_offset&quot;</span> : 0,</span><br><span class=\"line\">      <span class=\"string\">&quot;end_offset&quot;</span> : 2,</span><br><span class=\"line\">      <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;CN_WORD&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;position&quot;</span> : 0</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;token&quot;</span> : <span class=\"string\">&quot;白云山&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;start_offset&quot;</span> : 2,</span><br><span class=\"line\">      <span class=\"string\">&quot;end_offset&quot;</span> : 5,</span><br><span class=\"line\">      <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;CN_WORD&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;position&quot;</span> : 1</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;token&quot;</span> : <span class=\"string\">&quot;白云&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;start_offset&quot;</span> : 2,</span><br><span class=\"line\">      <span class=\"string\">&quot;end_offset&quot;</span> : 4,</span><br><span class=\"line\">      <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;CN_WORD&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;position&quot;</span> : 2</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;token&quot;</span> : <span class=\"string\">&quot;云山&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;start_offset&quot;</span> : 3,</span><br><span class=\"line\">      <span class=\"string\">&quot;end_offset&quot;</span> : 5,</span><br><span class=\"line\">      <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;CN_WORD&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;position&quot;</span> : 3</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;token&quot;</span> : <span class=\"string\">&quot;公园&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;start_offset&quot;</span> : 5,</span><br><span class=\"line\">      <span class=\"string\">&quot;end_offset&quot;</span> : 7,</span><br><span class=\"line\">      <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;CN_WORD&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;position&quot;</span> : 4</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\"># 所以只要desc中包含如上这些内容的数据都会被匹配上</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 但是这样匹配的结果就不够精确，如何尽量匹配更多的分词呢，可以增加 minimum_should_match</span></span><br><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;query&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;match&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;address&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">          &quot;query&quot;: &quot;广州白云山公园&quot;,</span></span><br><span class=\"line\"><span class=\"string\">          &quot;minimum_should_match&quot;: 2</span></span><br><span class=\"line\"><span class=\"string\">        &#125;</span></span><br><span class=\"line\"><span class=\"string\">      &#125;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">  &#125;&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># minimum_should_match: 2 表示至少匹配两个</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 如果希望全部都匹配呢</span></span><br><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;query&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;match&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;address&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">          &quot;query&quot;: &quot;广州白云山公园&quot;,</span></span><br><span class=\"line\"><span class=\"string\">          &quot;operator&quot;: &quot;and&quot;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;</span></span><br><span class=\"line\"><span class=\"string\">      &#125;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">  &#125;&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># operator: and 表示全部匹配，此时相当于精确匹配，其默认值是 or</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"multi-match-多字段查询\">multi_match: 多字段查询</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>multi_match查询在Elasticsearch中用于在多个字段上执行相同的搜索操作。它可以接受一个查询字符串，并在指定的字段集合中搜索这个字符串。multi_match查询提供了灵活的匹配类型和操作符选项，以便根据不同的搜索需求调整搜索行为。</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;query&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;multi_match&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;query&quot;: &quot;广州shirt&quot;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;fields&quot;:[&quot;title&quot;,&quot;address&quot;]</span></span><br><span class=\"line\"><span class=\"string\">      &#125;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">  &#125;&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># query: 查询条件</span></span><br><span class=\"line\"><span class=\"comment\"># fields: 指定多个字段进行匹配</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"match-phrase-短语查询\">match_phrase: 短语查询</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>match_phrase查询在Elasticsearch中用于执行短语搜索，它不仅匹配整个短语，而且还考虑了短语中各个词的顺序和位置。这种查询类型对于搜索精确短语非常有用，尤其是在用户输入的查询与文档中的文本表达方式需要严格匹配时。</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">  &quot;query&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;match_phrase&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;address&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">          &quot;query&quot;:&quot;广州白云山&quot;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;</span></span><br><span class=\"line\"><span class=\"string\">      &#125;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">  &#125;&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># 要求查询结果中的数据必须包含&quot;广州白云山&quot;，而且“广州”和“白云山”这两个词是不能分开的，因为 match_phrase 匹配的是相邻词条</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"query-string-支持与或非表达式的查询\">query_string: 支持<code>与或非</code>表达式的查询</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>query_string查询是一种灵活的查询类型，它允许使用Lucene查询语法来构建复杂的搜索查询。这种查询类型支持多种逻辑运算符，包括与（AND）、或（OR）和非（NOT），以及通配符、模糊搜索和正则表达式等功能。query_string查询可以在单个或多个字段上进行搜索，并且可以处理复杂的查询逻辑。</p>\n</li>\n<li class=\"lvl-2\">\n<p>注意: 查询字段分词就将查询条件分词查询，查询字段不分词将查询条件不分词查询</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查询所有字段中包含 &quot;公园&quot;和 &quot;华为&quot; 的文档</span></span><br><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">  &quot;query&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;query_string&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;query&quot;:&quot;公园 AND electronics&quot;</span></span><br><span class=\"line\"><span class=\"string\">      &#125;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">  &#125;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 指定查询的单个字段</span></span><br><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">  &quot;query&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;query_string&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;default_field&quot;:&quot;category&quot;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;query&quot;:&quot;白云山 OR books&quot;</span></span><br><span class=\"line\"><span class=\"string\">      &#125;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">  &#125;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 指定查询的多个字段</span></span><br><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">  &quot;query&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;query_string&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;fields&quot;:[&quot;category&quot;,&quot;address&quot;],</span></span><br><span class=\"line\"><span class=\"string\">        &quot;query&quot;:&quot;白云山 OR (electronics AND shirt)&quot;</span></span><br><span class=\"line\"><span class=\"string\">      &#125;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">  &#125;&#x27;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"simple-query-string-类似-query-string，但是会忽略错误的语法，同时只支持部分查询语法\">simple_query_string: 类似 <code>query_string</code>，但是会忽略错误的语法，同时只支持部分查询语法</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">  &quot;query&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;simple_query_string&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;query&quot;:&quot;广州公园&quot;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;default_operator&quot;:&quot;AND&quot;</span></span><br><span class=\"line\"><span class=\"string\">      &#125;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">  &#125;&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># default_operator: 默认为 OR，设置为 AND 则必须同时匹配</span></span><br></pre></td></tr></table></figure>\n<div class=\"tips\">\n<p><em><strong>ES查询结果属性含义</strong></em></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;took&quot;</span>:16,          <span class=\"comment\"># 表示查询从请求到完成耗时 16 毫秒。</span></span><br><span class=\"line\">  <span class=\"string\">&quot;timed_out&quot;</span>:<span class=\"literal\">false</span>,  <span class=\"comment\"># 表示查询在规定的时间内完成，没有发生超时。如果为 true，则表示查询超时。</span></span><br><span class=\"line\">  <span class=\"string\">&quot;_shards&quot;</span>:&#123;         <span class=\"comment\"># 涉及到查询过程中使用的分片信息</span></span><br><span class=\"line\">    <span class=\"string\">&quot;total&quot;</span>:1,        <span class=\"comment\"># 表示查询涉及到的总分片数为 1</span></span><br><span class=\"line\">    <span class=\"string\">&quot;successful&quot;</span>:1,   <span class=\"comment\"># 表示查询成功完成的分片数为 1</span></span><br><span class=\"line\">    <span class=\"string\">&quot;skipped&quot;</span>:0,      <span class=\"comment\"># 表示查询过程中被跳过的分片数为 0</span></span><br><span class=\"line\">    <span class=\"string\">&quot;failed&quot;</span>:0        <span class=\"comment\"># 表示查询过程中失败的分片数为 0</span></span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;hits&quot;</span>:&#123;            <span class=\"comment\"># 包含查询结果的详细信息</span></span><br><span class=\"line\">    <span class=\"string\">&quot;total&quot;</span>:&#123;         <span class=\"comment\"># 包含查询结果的总数</span></span><br><span class=\"line\">      <span class=\"string\">&quot;value&quot;</span>:4,      <span class=\"comment\"># 表示查询结果的总数为 4</span></span><br><span class=\"line\">      <span class=\"string\">&quot;relation&quot;</span>:<span class=\"string\">&quot;eq&quot;</span> <span class=\"comment\"># 表示返回的总数 value 是确切的（equal）。如果为 gte，则表示返回的总数是一个下限值。</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">&quot;max_score&quot;</span>:0.0,  <span class=\"comment\"># 表示匹配到的文档中最高的得分。如果是排序查询，这个值会有意义。当前结果因为 size: 0，没有实际返回文档，所以得分为 0.0</span></span><br><span class=\"line\">    <span class=\"string\">&quot;hits&quot;</span>:[ ]        <span class=\"comment\"># 包含查询结果的列表，每个结果都是一个对象，包含文档的元数据，如 id、分数等。</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</div>\n<h2 id=\"bool-查询\">bool 查询</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>布尔查询可以按照布尔逻辑条件组织多条查询语句，只有符合整个布尔条件的文档才会被搜索出来。</p>\n</li>\n<li class=\"lvl-2\">\n<p>在布尔条件中，可以包含两种不同的上下文。</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-4\">1.搜索上下文(query context)：使用搜索上下文时，Elasticsearch需要计算每个文档与搜索条件的相关度得分，这个得分的计算需使用一套复杂的计算公式，有一定的性能开销，带文本分析的全文检索的查询语句很适合放在搜索上下文中。</li>\n<li class=\"lvl-4\">2.过滤上下文(filter context)：使用过滤上下文时，Elasticsearch只需要判断搜索条件跟文档数据是否匹配，例如使用<code>Term query</code>判断一个值是否跟搜索内容一致，使用<code>Range query</code>判断某数据是否位于某个区间等。过滤上下文的查询不需要进行相关度得分计算，还可以使用缓存加快响应速度，很多术语级查询语句都适合放在过滤上下文中。</li>\n</ul>\n</li>\n<li class=\"lvl-2\">\n<p>bool 查询包含 must、must_not、should、filter 四种子句。</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>类型</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>must</td>\n<td>可包含多个查询条件，每个条件均满足的文档才能被搜索到，每次查询需要计算相关度得分，属于搜索上下文</td>\n</tr>\n<tr>\n<td>should</td>\n<td>可包含多个查询条件，不存在must和fiter条件时，至少要满足多个查询条件中的一个，文档才能被搜索到，否则需满足的条件数量不受限制,匹配到的查询越多相关度越高，也属于搜索上下文</td>\n</tr>\n<tr>\n<td>filter</td>\n<td>可包含多个过滤条件，每个条件均满足的文档才能被搜索到，每个过滤条件不计算相关度得分，结果在一定条件下会被缓存， 属于过滤上下文</td>\n</tr>\n<tr>\n<td>must_not</td>\n<td>可包含多个过滤条件，每个条件均不满足的文档才能被搜索到，每个过滤条件不计算相关度得分，结果在一定条件下会被缓存， 属于过滤上下文</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"must\">must</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 两个条件都需要满足</span></span><br><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">  &quot;query&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;bool&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;must&quot;:[</span></span><br><span class=\"line\"><span class=\"string\">          &#123;&quot;match&quot;:&#123;&quot;category&quot;:&quot;electronics&quot;&#125;&#125;,</span></span><br><span class=\"line\"><span class=\"string\">          &#123;&quot;match&quot;:&#123;&quot;desc&quot;:&quot;公园&quot;&#125;&#125;</span></span><br><span class=\"line\"><span class=\"string\">        ]</span></span><br><span class=\"line\"><span class=\"string\">      &#125;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">  &#125;&#x27;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"must-not\">must_not</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 两个条件都不满足</span></span><br><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">  &quot;query&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;bool&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;must_not&quot;:[</span></span><br><span class=\"line\"><span class=\"string\">          &#123;&quot;match&quot;:&#123;&quot;category&quot;:&quot;electronics&quot;&#125;&#125;,</span></span><br><span class=\"line\"><span class=\"string\">          &#123;&quot;match&quot;:&#123;&quot;desc&quot;:&quot;公园&quot;&#125;&#125;</span></span><br><span class=\"line\"><span class=\"string\">        ]</span></span><br><span class=\"line\"><span class=\"string\">      &#125;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">  &#125;&#x27;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"should\">should</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 两个条件满足一个即可</span></span><br><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">  &quot;query&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;bool&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;should&quot;:[</span></span><br><span class=\"line\"><span class=\"string\">          &#123;&quot;match&quot;:&#123;&quot;category&quot;:&quot;electronics&quot;&#125;&#125;,</span></span><br><span class=\"line\"><span class=\"string\">          &#123;&quot;match&quot;:&#123;&quot;desc&quot;:&quot;公园&quot;&#125;&#125;</span></span><br><span class=\"line\"><span class=\"string\">        ]</span></span><br><span class=\"line\"><span class=\"string\">      &#125;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">  &#125;&#x27;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"filter\">filter</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># filter中的条件为非 match，即不能是全文检索</span></span><br><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">  &quot;query&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;bool&quot;:&#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;filter&quot;:[</span></span><br><span class=\"line\"><span class=\"string\">          &#123;&quot;term&quot;:&#123;&quot;category&quot;:&quot;electronics&quot;&#125;&#125;,</span></span><br><span class=\"line\"><span class=\"string\">          &#123;&quot;range&quot;:&#123;&quot;price&quot;:&#123;&quot;gte&quot;:20&#125;&#125;&#125;</span></span><br><span class=\"line\"><span class=\"string\">        ]</span></span><br><span class=\"line\"><span class=\"string\">      &#125;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">  &#125;&#x27;</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"分页与排序\">分页与排序</h2>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># from: 从第几条开始，默认0</span></span><br><span class=\"line\"><span class=\"comment\"># size: 取多少条</span></span><br><span class=\"line\"><span class=\"comment\"># sort: 排序，默认为按文档id升序</span></span><br><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">  &quot;query&quot;:&#123;&quot;range&quot;:&#123;&quot;price&quot;:&#123;&quot;gte&quot;:20,&quot;lte&quot;:30&#125;&#125;&#125;,</span></span><br><span class=\"line\"><span class=\"string\">  &quot;sort&quot;:[&#123;&quot;price&quot;:&quot;address&quot;&#125;],</span></span><br><span class=\"line\"><span class=\"string\">  &quot;from&quot;:0,</span></span><br><span class=\"line\"><span class=\"string\">  &quot;size&quot;:5</span></span><br><span class=\"line\"><span class=\"string\">  &#125;&#x27;</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"只返回部分字段\">只返回部分字段</h2>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># _source: 指定要返回的字段列表</span></span><br><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;</span></span><br><span class=\"line\"><span class=\"string\">  &#123;&quot;query&quot;:&#123;&quot;range&quot;:&#123;&quot;price&quot;:&#123;&quot;gte&quot;:20,&quot;lte&quot;:30&#125;&#125;&#125;,</span></span><br><span class=\"line\"><span class=\"string\">  &quot;_source&quot;:[&quot;category&quot;,&quot;title&quot;,&quot;price&quot;]</span></span><br><span class=\"line\"><span class=\"string\">  &#125;&#x27;</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"高亮显示\">高亮显示</h2>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 高亮显示仅支持全文检索字段</span></span><br><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;query&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;multi_match&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;fields&quot;: [&quot;title&quot;,&quot;address&quot;],</span></span><br><span class=\"line\"><span class=\"string\">        &quot;query&quot;: &quot;公园shirt&quot;</span></span><br><span class=\"line\"><span class=\"string\">      &#125;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;highlight&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;post_tags&quot;: [&quot;&lt;/span&gt;&quot;],</span></span><br><span class=\"line\"><span class=\"string\">      &quot;pre_tags&quot;: [&quot;&lt;span style=&#x27;</span>color:red<span class=\"string\">&#x27;&gt;&quot;],</span></span><br><span class=\"line\"><span class=\"string\">      &quot;fields&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;*&quot;:&#123;&#125;</span></span><br><span class=\"line\"><span class=\"string\">      &#125;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">  &#125;&#x27;</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"地理空间位置查询\">地理空间位置查询</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>地理空间位置查询是数据库和搜索系统中的一个重要特性，特别是在地理信息系统（GIS）和位置服务中。它允许用户基于地理位置信息来搜索和过滤数据。在Elasticsearch这样的全文搜索引擎中，地理空间位置查询被广泛应用，例如在旅行、房地产、物流和零售等行业，用于提供基于位置的搜索功能。</p>\n</li>\n<li class=\"lvl-2\">\n<p>在Elasticsearch中，地理空间数据通常存储在<code>geo_point</code>字段类型中。这种字段类型可以存储纬度和经度坐标，用于表示地球上的一个点。</p>\n</li>\n</ul>\n<h3 id=\"示例\">示例</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>创建一个索引，并添加一个<code>geo_point</code>字段：</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -X PUT -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/tourist_spots&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;mappings&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;properties&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;name&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">          &quot;type&quot;: &quot;text&quot;,</span></span><br><span class=\"line\"><span class=\"string\">          &quot;analyzer&quot;: &quot;ik_max_word&quot;,</span></span><br><span class=\"line\"><span class=\"string\">          &quot;search_analyzer&quot;: &quot;ik_max_word&quot;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;location&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">          &quot;type&quot;: &quot;geo_point&quot;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;</span></span><br><span class=\"line\"><span class=\"string\">      &#125;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">  &#125;&#x27;</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>插入数据</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -X POST -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/tourist_spots/_bulk&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;&quot;index&quot;:&#123;&#125;&#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123;&quot;name&quot;:&quot;雷峰塔&quot;,&quot;location&quot;:&#123;&quot;lat&quot;:30.2615,&quot;lon&quot;:120.1480&#125;&#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123;&quot;index&quot;:&#123;&#125;&#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123;&quot;name&quot;:&quot;西湖&quot;,&quot;location&quot;:&#123;&quot;lat&quot;:30.2614,&quot;lon&quot;:120.1479&#125;&#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123;&quot;index&quot;:&#123;&#125;&#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123;&quot;name&quot;:&quot;苏堤春晓&quot;,&quot;location&quot;:&#123;&quot;lat&quot;:30.2624,&quot;lon&quot;:120.1708&#125;&#125;</span></span><br><span class=\"line\"><span class=\"string\">&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># lat: 纬度</span></span><br><span class=\"line\"><span class=\"comment\"># lon: 经度</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>查询数据</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查询杭州西湖5km附近的景点</span></span><br><span class=\"line\"><span class=\"comment\"># 雷峰塔 - 位于西湖附近，距离约2.8公里。</span></span><br><span class=\"line\"><span class=\"comment\"># 苏堤春晓 - 位于西湖边，距离西湖中心约1公里。</span></span><br><span class=\"line\">curl -X GET -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/tourist_spots/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;query&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;bool&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;must&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">          &quot;match_all&quot;: &#123;&#125;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;filter&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">          &quot;geo_distance&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">            &quot;distance&quot;: &quot;5km&quot;,</span></span><br><span class=\"line\"><span class=\"string\">            &quot;distance_type&quot;: &quot;arc&quot;,</span></span><br><span class=\"line\"><span class=\"string\">            &quot;location&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">              &quot;lat&quot;: 30.2614,</span></span><br><span class=\"line\"><span class=\"string\">              &quot;lon&quot;: 120.1479</span></span><br><span class=\"line\"><span class=\"string\">            &#125;</span></span><br><span class=\"line\"><span class=\"string\">          &#125;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;</span></span><br><span class=\"line\"><span class=\"string\">      &#125;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">  &#125;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># distance: 5km 表示距离为5公里</span></span><br><span class=\"line\"><span class=\"comment\"># distance_type: arc, plane, sloppy_arc,</span></span><br><span class=\"line\">  <span class=\"comment\"># arc: 默认值，使用haversine公式计算距离，结果是精确的，但计算速度较慢。</span></span><br><span class=\"line\">  <span class=\"comment\"># plane: 使用平面直角坐标系计算距离，结果是粗略的，但计算速度更快。</span></span><br><span class=\"line\">  <span class=\"comment\"># sloppy_arc: 使用haversine公式计算距离，但允许误差。</span></span><br><span class=\"line\"><span class=\"comment\"># location: 搜索条件</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"向量搜索\">向量搜索</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Elasticsearch 8.x 引入了一个重要的新特性：向量检索（Vector Search），特别是通过KNN（K-Nearest Neighbors）算法支持向量近邻检索。这一特性使得Elasticsearch在机器学习、数据分析和推荐系统等领域的应用变得更加广泛和强大。</p>\n</li>\n<li class=\"lvl-2\">\n<p>向量检索的基本思路是，将文档（或数据项）表示为高维向量，并使用这些向量来执行相似性搜索。在Elasticsearch中，这些向量被存储在<code>dense_vector</code>类型的字段中，然后使用KNN算法来找到与给定向量最相似的其他向量。</p>\n</li>\n</ul>\n<h3 id=\"示例-2\">示例</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>创建索引</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -X PUT -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/image-index&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;mappings&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;properties&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;image-vector&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">          &quot;type&quot;: &quot;dense_vector&quot;,</span></span><br><span class=\"line\"><span class=\"string\">          &quot;dims&quot;: 3</span></span><br><span class=\"line\"><span class=\"string\">        &#125;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;title&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">          &quot;type&quot;: &quot;text&quot;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;file-type&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">          &quot;type&quot;: &quot;keyword&quot;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;my_label&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">          &quot;type&quot;: &quot;text&quot;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;</span></span><br><span class=\"line\"><span class=\"string\">      &#125;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">  &#125;&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># dims: 3  表示3维向量，最高支持2048</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>添加数据</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -X POST -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/image-index/_bulk&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123; &quot;index&quot;: &#123;&#125; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;image-vector&quot;: [-5, 9, -12], &quot;title&quot;: &quot;Image A&quot;, &quot;file-type&quot;: &quot;jpeg&quot;, &quot;my_label&quot;: &quot;red&quot; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;index&quot;: &#123;&#125; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;image-vector&quot;: [10, -2, 3], &quot;title&quot;: &quot;Image B&quot;, &quot;file-type&quot;: &quot;png&quot;, &quot;my_label&quot;: &quot;blue&quot; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;index&quot;: &#123;&#125; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#123; &quot;image-vector&quot;: [4, 0, -1], &quot;title&quot;: &quot;Image C&quot;, &quot;file-type&quot;: &quot;gif&quot;, &quot;my_label&quot;: &quot;red&quot; &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#x27;</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>向量检索</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -X POST -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/image-index/_search?pretty&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;query&quot;:&#123; &quot;match_all&quot;: &#123;&#125; &#125;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;knn&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;field&quot;: &quot;image-vector&quot;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;query_vector&quot;: [-5, 10, -12],</span></span><br><span class=\"line\"><span class=\"string\">      &quot;k&quot;: 10,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;num_candidates&quot;: 100</span></span><br><span class=\"line\"><span class=\"string\">    &#125;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;fields&quot;: [ &quot;title&quot;, &quot;file-type&quot; ]</span></span><br><span class=\"line\"><span class=\"string\">  &#125;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># query: 搜索条件，这里可以不加这个</span></span><br><span class=\"line\"><span class=\"comment\"># knn: 8.8.1 版本开始默认支持</span></span><br><span class=\"line\"><span class=\"comment\"># field: 搜索向量字段</span></span><br><span class=\"line\"><span class=\"comment\"># query_vector: 搜索向量</span></span><br><span class=\"line\"><span class=\"comment\"># k: 搜索结果数量</span></span><br><span class=\"line\"><span class=\"comment\"># num_candidates: 搜索候选数量，用于优化性能</span></span><br><span class=\"line\"><span class=\"comment\"># fields: 搜索结果返回字段</span></span><br></pre></td></tr></table></figure>","content_text":"摘要 本文介绍 Elasticsearch 的 REST APIs Elasticsearch版本8.17.3 官方文档:REST APIs Elasticsearch 的 REST APIs:聚合查询 返回内容格式化 返回json信息格式: ?pretty 输出格式化后的json，比如：curl http://localhost:9200/_cluster/health?pretty 返回行信息格式: ?v 输出内容上方会加上标题行，比如：curl http://localhost:9200/_cat/health?v CAT APIs Elasticsearch 提供了 CAT APIs，它们提供了一种简单的方式来查看集群状态和集群中的各种资源，比如索引、分片、节点等。 123456789101112131415161718192021222324GET /_cat/health #查看集群当前状态：红、黄、绿GET /_cat/master #查看master节点信息GET /_cat/nodes #查看所有节点信息GET /_cat/plugins #查看集群各个节点上的plugin信息GET /_cat/indices #查看集群中所有index的详细信息GET /_cat/indices/&#123;index&#125; #查看集群中指定index的详细信息，index：索引名称GET /_cat/allocation #查看单节点的shard分配整体情况GET /_cat/shards #查看各shard的详细情况GET /_cat/shards/&#123;index&#125; #查看指定分片的详细情况GET /_cat/segments #查看各index的segment详细信息,包括segment名, 所属shard, 内存(磁盘)占用大小, 是否刷盘GET /_cat/segments/&#123;index&#125; #查看指定index的segment详细信息GET /_cat/count #查看当前集群的doc数量GET /_cat/count/&#123;index&#125; #查看指定索引的doc数量GET /_cat/recovery #查看集群内每个shard的recovery过程.调整replica。GET /_cat/recovery/&#123;index&#125; #查看指定索引shard的recovery过程GET /_cat/pending_tasks #查看当前集群的pending taskGET /_cat/aliases #查看集群中所有alias信息,路由配置等GET /_cat/aliases/&#123;alias&#125; #查看指定索引的alias信息GET /_cat/thread_pool #查看集群各节点内部不同类型的threadpool的统计信息,GET /_cat/fielddata #查看当前集群各个节点的fielddata内存使用情况GET /_cat/fielddata/&#123;fields&#125; #查看指定field的内存使用情况,里面传field属性对应的值GET /_cat/nodeattrs #查看单节点的自定义属性GET /_cat/repositories #输出集群中注册快照存储库GET /_cat/templates #输出当前正在存在的模板信息 Cluster APIs Elasticsearch 提供了一系列的 Cluster APIs，它们提供了管理和监控集群状态的功能 123456789GET /_cluster/health # 获取集群的健康状态信息，包括了集群总体的状况如status、number_of_nodes等。GET /_cluster/stats # 提供整个集群层面的统计信息，包含索引、节点和其他高级指标。GET /_cluster/state # 显示集群元数据的状态，包括设置、块、路由表及元数据等，允许用户查看集群的当前视图。POST /_cluster/reroute # POST请求，用于手动改变分片分配情况，可以实现如迁移分片、取消分配等操作。GET /_cluster/nodes/hot_threads # 返回集群中各个节点“最热”的线程堆栈跟踪，默认显示前三个CPU时间最长的线程。GET /_cluster/allocation/explain # 解释为何某个分片被如此分配，并提供如何调整的建议。GET /_cluster/pending_tasks # 列出所有等待执行的任务列表。GET /_cluster/settings # 查看整个集群级别的设置。PUT /_cluster/settings # 更新整个集群级别的设置。 Index APIs Elasticsearch 提供了 Index APIs，它们提供了对索引的创建、更新、查询和删除等操作。 创建索引 12345# PUT /&lt;target&gt;# 这里 shopping 为索引名称，但此时没有为索引设置分片策略，也没有设置字段信息curl -X PUT -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping&#x27;# 返回值&#123;&quot;acknowledged&quot;:true,&quot;shards_acknowledged&quot;:true,&quot;index&quot;:&quot;shopping&quot;&#125; 创建索引并设置索引 123456# PUT /&lt;target&gt;curl -X PUT -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123;&quot;settings&quot;:&#123;&quot;number_of_shards&quot;:&quot;1&quot;,&quot;number_of_replicas&quot;:&quot;2&quot;&#125;&#125;&#x27;# 返回值&#123;&quot;acknowledged&quot;:true,&quot;shards_acknowledged&quot;:true,&quot;index&quot;:&quot;shopping&quot;&#125; 创建并映射索引 1234567891011121314151617181920212223242526272829303132333435363738394041# PUT /&lt;target&gt;# 这里设置索引分片数量为1，副本数量为2，并设置字段信息curl -X PUT -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;settings&quot;:&#123; &quot;number_of_shards&quot;:&quot;1&quot;, &quot;number_of_replicas&quot;:&quot;2&quot; &#125;, &quot;mappings&quot;:&#123; &quot;properties&quot;:&#123; &quot;title&quot;:&#123; &quot;type&quot;:&quot;text&quot; &#125;, &quot;category&quot;:&#123; &quot;type&quot;:&quot;keyword&quot; &#125;, &quot;price&quot;:&#123; &quot;type&quot;:&quot;double&quot; &#125;, &quot;count&quot;:&#123; &quot;type&quot;:&quot;integer&quot; &#125; &#125; &#125; &#125;&#x27;# 参数说明## settings: 这个参数用于配置索引的设置，包括分片数量和副本数量。### number_of_shards: 这个参数指定了索引中分片的数量。在这个例子中，number_of_shards 设置为 1，意味着索引将只有一个主分片。### number_of_replicas: 这个参数指定了每个主分片的副本数量。在这个例子中，number_of_replicas 设置为 2，意味着每个主分片将有两个副本。## mappings: 这个参数用于定义索引中的字段和字段类型。### properties: 这个参数定义了索引中的字段和字段类型。在这个例子中，有四个字段：title、category、images 和 price。### title: 这个字段的类型是 text，表示它是一个全文检索字段。text 适合存储长文本数据，并支持全文搜索。### category: 这个字段的类型是 keyword，表示它是一个关键字字段，不支持全文检索。keyword 适合存储不需要分词的短文本数据（如标签、类别等），并且可以用于聚合和过滤。### price: 这个字段的类型是 double，表示它是一个数字字段。double 表示这是一个双精度浮点数字段，适合存储数值数据，如价格### count: 这个字段的类型是 integer，表示它是一个整数字段。integer 表示这是一个整数字段，适合存储整数数据，如商品数量等。# 返回值&#123;&quot;acknowledged&quot;:true,&quot;shards_acknowledged&quot;:true,&quot;index&quot;:&quot;shopping&quot;&#125; 更新索引映射 1234567891011121314151617181920212223242526272829303132333435363738# PUT /&lt;target&gt;/_mapping# 注意该api只能增加新的字段，不能修改已有字段，如果要修改源字段类型或者分词器类型，下文会介绍curl -X PUT -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_mapping&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;properties&quot;:&#123; &quot;remark&quot;:&#123; &quot;type&quot;:&quot;text&quot;, &quot;analyzer&quot;:&quot;ik_max_word&quot;, &quot;search_analyzer&quot;:&quot;ik_smart&quot; &#125;, &quot;address&quot;: &#123; &quot;type&quot;: &quot;text&quot;, &quot;analyzer&quot;: &quot;ik_max_word&quot;, &quot;fields&quot;: &#123; &quot;keyword&quot;: &#123; &quot;type&quot;: &quot;keyword&quot; &#125; &#125; &#125;, &quot;tags&quot;: &#123; &quot;type&quot;: &quot;keyword&quot; &#125;, &quot;created_at&quot;: &#123;&quot;type&quot;: &quot;date&quot;, &quot;format&quot;: &quot;yyyy-MM-dd HH:mm:ss&quot;&#125; &#125; &#125;&#x27;# 参数说明# 这里为索引添加了4个字段# remark：新增字段，类型为text，分词器为ik_max_word，搜索分词器为ik_smart # analyzer: 索引分词器 # search_analyzer：搜索分词器 # ik_max_word：中文分词器，将句子拆分为最多词元，适合长句子 # ik_smart：中文分词器，将句子拆分为最少词元，适合短句子# address：新增字段，类型为text，分词器为ik_max_word，搜索分词器未指定，默认与分词器同一个，这里还为address添加了keyword字段，用于存储原始数据，以支持精确搜索# tags：新增字段，类型为keyword，不支持分词，适合存储短文本数据（如标签、类别等），并且可以用于聚合和过滤，可以存储数组# created_at：新增字段，类型为date，格式为yyyy-MM-dd HH:mm:ss# 返回值&#123;&quot;acknowledged&quot;:true&#125; 更新索引设置 1234567# PUT /&lt;target&gt;/_settings# 注意这里不能更新number_of_shardscurl -X PUT -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_settings&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123;&quot;number_of_replicas&quot;:&quot;1&quot;&#125;&#x27;# 返回值&#123;&quot;acknowledged&quot;:true&#125; 查看指定索引 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364# GET /&lt;target&gt;curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping?pretty&#x27;# 返回值&#123; &quot;shopping&quot; : &#123; &quot;aliases&quot; : &#123; &#125;, &quot;mappings&quot; : &#123; &quot;properties&quot; : &#123; &quot;address&quot; : &#123; &quot;type&quot; : &quot;text&quot;, &quot;fields&quot; : &#123; &quot;keyword&quot; : &#123; &quot;type&quot; : &quot;keyword&quot; &#125; &#125;, &quot;analyzer&quot; : &quot;ik_max_word&quot; &#125;, &quot;category&quot; : &#123; &quot;type&quot; : &quot;keyword&quot; &#125;, &quot;count&quot; : &#123; &quot;type&quot; : &quot;integer&quot; &#125;, &quot;created_at&quot; : &#123; &quot;type&quot; : &quot;date&quot;, &quot;format&quot; : &quot;yyyy-MM-dd HH:mm:ss&quot; &#125;, &quot;price&quot; : &#123; &quot;type&quot; : &quot;double&quot; &#125;, &quot;remark&quot; : &#123; &quot;type&quot; : &quot;text&quot;, &quot;analyzer&quot; : &quot;ik_max_word&quot;, &quot;search_analyzer&quot; : &quot;ik_smart&quot; &#125;, &quot;tags&quot; : &#123; &quot;type&quot; : &quot;keyword&quot; &#125;, &quot;title&quot; : &#123; &quot;type&quot; : &quot;text&quot; &#125; &#125; &#125;, &quot;settings&quot; : &#123; &quot;index&quot; : &#123; &quot;routing&quot; : &#123; &quot;allocation&quot; : &#123; &quot;include&quot; : &#123; &quot;_tier_preference&quot; : &quot;data_content&quot; &#125; &#125; &#125;, &quot;number_of_shards&quot; : &quot;1&quot;, &quot;provided_name&quot; : &quot;shopping&quot;, &quot;creation_date&quot; : &quot;1745291743120&quot;, &quot;number_of_replicas&quot; : &quot;1&quot;, &quot;uuid&quot; : &quot;Y1IWrdlQTUm-CbbIWweSxQ&quot;, &quot;version&quot; : &#123; &quot;created&quot; : &quot;8525000&quot; &#125; &#125; &#125; &#125;&#125; 查看索引设置 1234567891011121314151617181920212223242526272829303132333435363738394041424344# GET /&lt;target&gt;/_settingscurl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_settings?pretty&#x27;# 返回值&#123; &quot;shopping&quot; : &#123; &quot;mappings&quot; : &#123; &quot;properties&quot; : &#123; &quot;address&quot; : &#123; &quot;type&quot; : &quot;text&quot;, &quot;fields&quot; : &#123; &quot;keyword&quot; : &#123; &quot;type&quot; : &quot;keyword&quot; &#125; &#125;, &quot;analyzer&quot; : &quot;ik_max_word&quot; &#125;, &quot;category&quot; : &#123; &quot;type&quot; : &quot;keyword&quot; &#125;, &quot;count&quot; : &#123; &quot;type&quot; : &quot;integer&quot; &#125;, &quot;created_at&quot; : &#123; &quot;type&quot; : &quot;date&quot;, &quot;format&quot; : &quot;yyyy-MM-dd HH:mm:ss&quot; &#125;, &quot;price&quot; : &#123; &quot;type&quot; : &quot;double&quot; &#125;, &quot;remark&quot; : &#123; &quot;type&quot; : &quot;text&quot;, &quot;analyzer&quot; : &quot;ik_max_word&quot;, &quot;search_analyzer&quot; : &quot;ik_smart&quot; &#125;, &quot;tags&quot; : &#123; &quot;type&quot; : &quot;keyword&quot; &#125;, &quot;title&quot; : &#123; &quot;type&quot; : &quot;text&quot; &#125; &#125; &#125; &#125;&#125; 查看字段映射 123456789101112131415161718# GET /&lt;target&gt;/_mapping/field/&lt;field&gt;# shopping 为索引名称，title 为字段名称curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_mapping/field/title?pretty&#x27;# 返回值&#123; &quot;shopping&quot; : &#123; &quot;mappings&quot; : &#123; &quot;title&quot; : &#123; &quot;full_name&quot; : &quot;title&quot;, &quot;mapping&quot; : &#123; &quot;title&quot; : &#123; &quot;type&quot; : &quot;text&quot; &#125; &#125; &#125; &#125; &#125;&#125; 判断索引是否存在 12345678910111213# 使用 -I 参数来发送 HEAD 请求，可以获取响应头而不必下载响应体。# HEAD /&lt;target&gt;curl -I -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping&#x27;# 返回值HTTP/1.1 200 OKX-elastic-product: Elasticsearchcontent-type: application/jsoncontent-length: 603# 这个命令不会返回响应体，但它的 HTTP 响应代码可以告诉你索引的存在情况： # 200 OK 表示索引存在。 # 404 Not Found 表示索引不存在。 删除索引 1234# DELETE /&lt;target&gt;curl -X DELETE -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping&#x27;# 返回值&#123;&quot;acknowledged&quot;:true&#125; 为索引创建别名 123456789101112131415161718192021# 注意：不同索引可以有相同名称的别名，所以在数据结构一致的情况下，我们可以为不同的索引创建相同的别名，然后根据别名进行数据查询# POST /&lt;target&gt;/_alias/&lt;alias&gt;curl -X POST -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_alias/shopping_alias&#x27;# 返回值&#123;&quot;acknowledged&quot;:true&#125;# 也可以使用如下方法curl -X POST -u elastic:123456 -k &#x27;https://127.0.0.1:9200/_aliases&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;actions&quot;: [ &#123; &quot;add&quot;: &#123; &quot;index&quot;: &quot;shopping&quot;, &quot;alias&quot;: &quot;shopping_alias2&quot; &#125; &#125; ] &#125;&#x27;# 返回值&#123;&quot;acknowledged&quot;:true&#125; 查看索引别名 12345678910111213141516# GET /&lt;target&gt;/_alias/&lt;alias&gt;curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_alias/shopping_alias?pretty&#x27;# 返回值&#123; &quot;shopping&quot; : &#123; &quot;aliases&quot; : &#123; &quot;shopping_alias&quot; : &#123; &#125; &#125; &#125;&#125;# 查看当前索引的所有别名curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_alias?pretty&#x27;# 查看所有索引的别名curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/_alias?pretty&#x27; 为索引删除别名 1234# DELETE /&lt;target&gt;/_alias/&lt;alias&gt;curl -X DELETE -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_alias/shopping_alias&#x27;# 返回值&#123;&quot;acknowledged&quot;:true&#125; 如何修改索引字段类型或分词器类型？ 创建新的索引 123456789101112131415161718192021222324252627282930313233343536373839404142434445# 这里为title字段增加分词器curl -X PUT -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping_new&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;settings&quot;:&#123; &quot;number_of_shards&quot;:&quot;1&quot;, &quot;number_of_replicas&quot;:&quot;2&quot; &#125;, &quot;mappings&quot;:&#123; &quot;properties&quot;:&#123; &quot;category&quot;:&#123; &quot;type&quot;:&quot;keyword&quot; &#125;, &quot;price&quot;:&#123; &quot;type&quot;:&quot;double&quot; &#125;, &quot;count&quot;:&#123; &quot;type&quot;:&quot;integer&quot; &#125;, &quot;title&quot;:&#123; &quot;type&quot;:&quot;text&quot;, &quot;analyzer&quot;:&quot;ik_max_word&quot;, &quot;search_analyzer&quot;:&quot;ik_smart&quot; &#125;, &quot;remark&quot;:&#123; &quot;type&quot;:&quot;text&quot;, &quot;analyzer&quot;:&quot;ik_max_word&quot;, &quot;search_analyzer&quot;:&quot;ik_smart&quot; &#125;, &quot;address&quot;: &#123; &quot;type&quot;: &quot;text&quot;, &quot;analyzer&quot;: &quot;ik_max_word&quot;, &quot;fields&quot;: &#123; &quot;keyword&quot;: &#123; &quot;type&quot;: &quot;keyword&quot; &#125; &#125; &#125;, &quot;tags&quot;: &#123; &quot;type&quot;: &quot;keyword&quot; &#125;, &quot;created_at&quot;: &#123;&quot;type&quot;: &quot;date&quot;, &quot;format&quot;: &quot;yyyy-MM-dd HH:mm:ss&quot;&#125; &#125; &#125; &#125;&#x27; 将原索引的数据迁移到新索引 123456789101112curl -X POST -u elastic:123456 -k &#x27;https://127.0.0.1:9200/_reindex&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;source&quot;: &#123; &quot;index&quot;: &quot;shopping&quot; &#125;, &quot;dest&quot;: &#123; &quot;index&quot;: &quot;shopping_new&quot; &#125;&#125;&#x27;# 返回值&#123;&quot;took&quot;:101,&quot;timed_out&quot;:false,&quot;total&quot;:2,&quot;updated&quot;:0,&quot;created&quot;:2,&quot;deleted&quot;:0,&quot;batches&quot;:1,&quot;version_conflicts&quot;:0,&quot;noops&quot;:0,&quot;retries&quot;:&#123;&quot;bulk&quot;:0,&quot;search&quot;:0&#125;,&quot;throttled_millis&quot;:0,&quot;requests_per_second&quot;:-1.0,&quot;throttled_until_millis&quot;:0,&quot;failures&quot;:[]&#125; 删除原索引 123curl -X DELETE -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping&#x27;# 返回值&#123;&quot;acknowledged&quot;:true&#125; 为新索引创建别名 123curl -X POST -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping_new/_alias/shopping&#x27;# 返回值&#123;&quot;acknowledged&quot;:true,&quot;errors&quot;:false&#125; 数据增删改基本操作 新增数据 1.为指定索引插入一条数据(_doc方式：不指定id默认随机字符串) 12345678910111213141516171819202122232425262728# _doc 的方式创建索引数据时，可以不指定id，默认会创建新的id，id类型为随机字符串# POST /&lt;target&gt;/_doccurl -X POST -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_doc?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;category&quot;: &quot;electronics&quot;, &quot;price&quot;: 999.99, &quot;count&quot;: 10, &quot;title&quot;: &quot;Smartphone X - 128GB&quot;, &quot;remark&quot;: &quot;This latest Smartphone X comes with a powerful processor and high-resolution camera.&quot;, &quot;address&quot;: &quot;123 Electronic Ave, Beijing, China&quot;, &quot;tags&quot;: [&quot;latest&quot;, &quot;smartphone&quot;, &quot;technology&quot;], &quot;created_at&quot;: &quot;2025-04-22 03:30:02&quot; &#125;&#x27;# 返回值&#123; &quot;_index&quot; : &quot;shopping_new&quot;, &quot;_id&quot; : &quot;sImNW5YBmgASmV9McVvI&quot;, &quot;_version&quot; : 1, &quot;result&quot; : &quot;created&quot;, &quot;_shards&quot; : &#123; &quot;total&quot; : 3, &quot;successful&quot; : 1, &quot;failed&quot; : 0 &#125;, &quot;_seq_no&quot; : 1, &quot;_primary_term&quot; : 1&#125; 2.为指定索引插入一条数据(_doc方式：指定id) 12345678910111213141516171819202122232425262728# _doc 的方式创建索引数据时，如果指定id，再次执行时会先删除原数据再创建新数据，所以必须全量更新才行。# PUT /&lt;target&gt;/_doccurl -X PUT -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_doc/100?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;category&quot;: &quot;electronics&quot;, &quot;price&quot;: 999.99, &quot;count&quot;: 10, &quot;title&quot;: &quot;Smartphone X - 128GB&quot;, &quot;remark&quot;: &quot;This latest Smartphone X comes with a powerful processor and high-resolution camera.&quot;, &quot;address&quot;: &quot;123 Electronic Ave, Beijing, China&quot;, &quot;tags&quot;: [&quot;latest&quot;, &quot;smartphone&quot;, &quot;technology&quot;], &quot;created_at&quot;: &quot;2025-04-22 03:30:02&quot; &#125;&#x27;# 返回值&#123; &quot;_index&quot; : &quot;shopping_new&quot;, &quot;_id&quot; : &quot;100&quot;, &quot;_version&quot; : 1, &quot;result&quot; : &quot;created&quot;, &quot;_shards&quot; : &#123; &quot;total&quot; : 3, &quot;successful&quot; : 1, &quot;failed&quot; : 0 &#125;, &quot;_seq_no&quot; : 2, &quot;_primary_term&quot; : 1&#125; 3.为指定索引插入一条数据(_create方式：指定id) 1234567891011121314# _create 的方式创建索引数据时，必须指定id,而且只能执行一次，因为执行过一次后指定id的数据就存在了，不能再次创建# POST /&lt;target&gt;/_create/&lt;id&gt;curl -X POST -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_create/1?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;category&quot;: &quot;electronics&quot;, &quot;price&quot;: 999.99, &quot;count&quot;: 10, &quot;title&quot;: &quot;Smartphone X - 128GB&quot;, &quot;remark&quot;: &quot;This latest Smartphone X comes with a powerful processor and high-resolution camera.&quot;, &quot;address&quot;: &quot;123 Electronic Ave, Beijing, China&quot;, &quot;tags&quot;: [&quot;latest&quot;, &quot;smartphone&quot;, &quot;technology&quot;], &quot;created_at&quot;: &quot;2025-04-22 03:30:02&quot; &#125;&#x27; 修改数据 1.修改全部数据 1234567891011121314# POST /&lt;target&gt;/_doc/&lt;id&gt;# 执行时会先删除原数据再创建新数据，所以必须全量更新才行。curl -X POST -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_doc/sImNW5YBmgASmV9McVvI&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;category&quot;: &quot;electronics&quot;, &quot;price&quot;: 999.99, &quot;count&quot;: 20, &quot;title&quot;: &quot;Smartphone X - 128GB&quot;, &quot;remark&quot;: &quot;This latest Smartphone X comes with a powerful processor and high-resolution camera.&quot;, &quot;address&quot;: &quot;123 Electronic Ave, Beijing, China&quot;, &quot;tags&quot;: [&quot;latest&quot;, &quot;smartphone&quot;, &quot;technology&quot;], &quot;created_at&quot;: &quot;2025-04-22 03:30:02&quot; &#125;&#x27; 2.修改部分数据 12345# POST /&lt;target&gt;/_update/&lt;id&gt;# 执行时只会修改指定字段，不会删除原数据，所以可以部分更新。curl -X POST -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_update/1&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123;&quot;doc&quot;:&#123;&quot;count&quot;:100&#125;&#125;&#x27; 查询指定索引的指定id的数据 12345678910111213141516171819202122232425# GET /&lt;target&gt;/_doc/&lt;id&gt;curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_doc/100?pretty&#x27;# 返回值&#123; &quot;_index&quot; : &quot;shopping_new&quot;, &quot;_id&quot; : &quot;100&quot;, &quot;_version&quot; : 1, &quot;_seq_no&quot; : 2, &quot;_primary_term&quot; : 1, &quot;found&quot; : true, &quot;_source&quot; : &#123; &quot;category&quot; : &quot;electronics&quot;, &quot;price&quot; : 999.99, &quot;count&quot; : 10, &quot;title&quot; : &quot;Smartphone X - 128GB&quot;, &quot;remark&quot; : &quot;This latest Smartphone X comes with a powerful processor and high-resolution camera.&quot;, &quot;address&quot; : &quot;123 Electronic Ave, Beijing, China&quot;, &quot;tags&quot; : [ &quot;latest&quot;, &quot;smartphone&quot;, &quot;technology&quot; ], &quot;created_at&quot; : &quot;2025-04-22 03:30:02&quot; &#125;&#125; 删除指定索引的指定id的数据 12# DELETE /&lt;target&gt;/_doc/&lt;id&gt;curl -X DELETE -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_doc/100&#x27; 删除索引全部数据 123curl -X POST -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_delete_by_query?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123;&quot;query&quot;:&#123;&quot;match_all&quot;:&#123;&#125;&#125;&#125;&#x27; 批量操作 批量新增数据 1234567891011121314151617181920212223242526272829303132333435363738394041# 注意数据行要顶行写，前面不要有空格# POST /_bulkcurl -X POST -u elastic:123456 -k &#x27;https://127.0.0.1:9200/_bulk&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;index&quot;: &#123; &quot;_index&quot;: &quot;shopping&quot;, &quot;_id&quot;: &quot;1&quot; &#125; &#125;&#123; &quot;category&quot;: &quot;electronics&quot;, &quot;price&quot;: 999.99, &quot;count&quot;: 10, &quot;title&quot;: &quot;Smartphone X - 128GB&quot;, &quot;remark&quot;: &quot;This latest Smartphone X comes with a powerful processor and high-resolution camera.&quot;, &quot;address&quot;: &quot;广州天河公园&quot;, &quot;tags&quot;: [&quot;latest&quot;, &quot;smartphone&quot;, &quot;technology&quot;], &quot;created_at&quot;: &quot;2025-04-22 03:30:02&quot; &#125;&#123; &quot;index&quot;: &#123; &quot;_index&quot;: &quot;shopping&quot;, &quot;_id&quot;: &quot;2&quot; &#125; &#125;&#123; &quot;category&quot;: &quot;fashion&quot;, &quot;price&quot;: 49.99, &quot;count&quot;: 25, &quot;title&quot;: &quot;Designer T-shirt&quot;, &quot;remark&quot;: &quot;Trendy designer T-shirt made with high quality fabric.&quot;, &quot;address&quot;: &quot;广州荔湾大厦&quot;, &quot;tags&quot;: [&quot;clothing&quot;, &quot;designer&quot;, &quot;style&quot;], &quot;created_at&quot;: &quot;2025-04-21 12:15:00&quot; &#125;&#123; &quot;index&quot;: &#123; &quot;_index&quot;: &quot;shopping&quot;, &quot;_id&quot;: &quot;3&quot; &#125; &#125;&#123; &quot;category&quot;: &quot;home_appliances&quot;, &quot;price&quot;: 299.99, &quot;count&quot;: 5, &quot;title&quot;: &quot;Robot Vacuum Cleaner&quot;, &quot;remark&quot;: &quot;Efficient robot vacuum cleaner with smart navigation.&quot;, &quot;address&quot;: &quot;广州白云山公园&quot;, &quot;tags&quot;: [&quot;appliances&quot;, &quot;vacuum&quot;, &quot;robot&quot;], &quot;created_at&quot;: &quot;2025-04-20 08:45:30&quot; &#125;&#123; &quot;index&quot;: &#123; &quot;_index&quot;: &quot;shopping&quot;, &quot;_id&quot;: &quot;4&quot; &#125; &#125;&#123; &quot;category&quot;: &quot;books&quot;, &quot;price&quot;: 19.99, &quot;count&quot;: 100, &quot;title&quot;: &quot;Inspirational Novel&quot;, &quot;remark&quot;: &quot;A gripping novel that inspires and motivates.&quot;, &quot;address&quot;: &quot;321 Book Rd, Shenzhen, China&quot;, &quot;tags&quot;: [&quot;book&quot;, &quot;novel&quot;, &quot;inspiration&quot;], &quot;created_at&quot;: &quot;2025-04-19 10:05:00&quot; &#125;&#123; &quot;index&quot;: &#123; &quot;_index&quot;: &quot;shopping&quot;, &quot;_id&quot;: &quot;5&quot; &#125; &#125;&#123; &quot;category&quot;: &quot;groceries&quot;, &quot;price&quot;: 3.99, &quot;count&quot;: 200, &quot;title&quot;: &quot;Organic Apples&quot;, &quot;remark&quot;: &quot;Fresh and crispy organic apples.&quot;, &quot;address&quot;: &quot;654 Grocery Ln, Chengdu, China&quot;, &quot;tags&quot;: [&quot;fruit&quot;, &quot;organic&quot;, &quot;healthy&quot;], &quot;created_at&quot;: &quot;2025-04-18 14:30:45&quot; &#125;&#123; &quot;index&quot;: &#123; &quot;_index&quot;: &quot;shopping&quot;, &quot;_id&quot;: &quot;6&quot; &#125; &#125;&#123; &quot;category&quot;: &quot;electronics&quot;, &quot;price&quot;: 1999.99, &quot;count&quot;: 15, &quot;title&quot;: &quot;Smartphone X - 256GB&quot;, &quot;remark&quot;: &quot;This latest Smartphone X comes with a powerful processor and high-resolution camera.&quot;, &quot;address&quot;: &quot;广州天河公园&quot;, &quot;tags&quot;: [&quot;latest&quot;, &quot;smartphone&quot;, &quot;technology&quot;], &quot;created_at&quot;: &quot;2025-04-22 03:30:02&quot; &#125;&#x27;# 参数说明# index: 用于创建新文档或替换已有文档。# create: 用于创建新文档，如果文档已存在，则返回错误。# _index: 指定索引名称。# _id: 指定文档ID。如果不指定则会自动生成一个随机的ID。# 批量新增数据时也可以在url中指定索引名称# 此时可以指定id，如果不指定则自动生成一个随机字符串的ID# POST /&lt;target&gt;/_bulkcurl -X POST -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_bulk&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;index&quot;: &#123;&#125; &#125;&#123; &quot;category&quot;: &quot;electronics&quot;, &quot;price&quot;: 999.99, &quot;count&quot;: 10, &quot;title&quot;: &quot;Smartphone X - 128GB&quot;, &quot;remark&quot;: &quot;This latest Smartphone X comes with a powerful processor and high-resolution camera.&quot;, &quot;address&quot;: &quot;广州天河公园&quot;, &quot;tags&quot;: [&quot;latest&quot;, &quot;smartphone&quot;, &quot;technology&quot;], &quot;created_at&quot;: &quot;2025-04-22 03:30:02&quot; &#125;&#123; &quot;index&quot;: &#123;&#125; &#125;&#123; &quot;category&quot;: &quot;fashion&quot;, &quot;price&quot;: 49.99, &quot;count&quot;: 25, &quot;title&quot;: &quot;Designer T-shirt&quot;, &quot;remark&quot;: &quot;Trendy designer T-shirt made with high quality fabric.&quot;, &quot;address&quot;: &quot;广州荔湾大厦&quot;, &quot;tags&quot;: [&quot;clothing&quot;, &quot;designer&quot;, &quot;style&quot;], &quot;created_at&quot;: &quot;2025-04-21 12:15:00&quot; &#125;&#123; &quot;index&quot;: &#123;&#125; &#125;&#123; &quot;category&quot;: &quot;home_appliances&quot;, &quot;price&quot;: 299.99, &quot;count&quot;: 5, &quot;title&quot;: &quot;Robot Vacuum Cleaner&quot;, &quot;remark&quot;: &quot;Efficient robot vacuum cleaner with smart navigation.&quot;, &quot;address&quot;: &quot;广州白云山公园&quot;, &quot;tags&quot;: [&quot;appliances&quot;, &quot;vacuum&quot;, &quot;robot&quot;], &quot;created_at&quot;: &quot;2025-04-20 08:45:30&quot; &#125;&#123; &quot;index&quot;: &#123;&#125; &#125;&#123; &quot;category&quot;: &quot;books&quot;, &quot;price&quot;: 19.99, &quot;count&quot;: 100, &quot;title&quot;: &quot;Inspirational Novel&quot;, &quot;remark&quot;: &quot;A gripping novel that inspires and motivates.&quot;, &quot;address&quot;: &quot;321 Book Rd, Shenzhen, China&quot;, &quot;tags&quot;: [&quot;book&quot;, &quot;novel&quot;, &quot;inspiration&quot;], &quot;created_at&quot;: &quot;2025-04-19 10:05:00&quot; &#125;&#123; &quot;index&quot;: &#123;&#125; &#125;&#123; &quot;category&quot;: &quot;groceries&quot;, &quot;price&quot;: 3.99, &quot;count&quot;: 200, &quot;title&quot;: &quot;Organic Apples&quot;, &quot;remark&quot;: &quot;Fresh and crispy organic apples.&quot;, &quot;address&quot;: &quot;654 Grocery Ln, Chengdu, China&quot;, &quot;tags&quot;: [&quot;fruit&quot;, &quot;organic&quot;, &quot;healthy&quot;], &quot;created_at&quot;: &quot;2025-04-18 14:30:45&quot; &#125;&#123; &quot;index&quot;: &#123;&#125; &#125;&#123; &quot;category&quot;: &quot;electronics&quot;, &quot;price&quot;: 1999.99, &quot;count&quot;: 15, &quot;title&quot;: &quot;Smartphone X - 256GB&quot;, &quot;remark&quot;: &quot;This latest Smartphone X comes with a powerful processor and high-resolution camera.&quot;, &quot;address&quot;: &quot;广州天河公园&quot;, &quot;tags&quot;: [&quot;latest&quot;, &quot;smartphone&quot;, &quot;technology&quot;], &quot;created_at&quot;: &quot;2025-04-22 03:30:02&quot; &#125;&#x27; 批量修改数据 1234567891011# 注意数据行要顶行写，前面不要有空格curl -X POST -u elastic:123456 -k &#x27;https://127.0.0.1:9200/_bulk&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123;&quot;update&quot;:&#123;&quot;_index&quot;:&quot;shopping&quot;,&quot;_id&quot;:&quot;1&quot;&#125;&#125;&#123;&quot;doc&quot;:&#123;&quot;title&quot;:&quot;Smartphone X2 - 128GB&quot;,&quot;price&quot;:1000.11&#125;&#125;&#123;&quot;update&quot;:&#123;&quot;_index&quot;:&quot;shopping&quot;,&quot;_id&quot;:&quot;2&quot;&#125;&#125;&#123;&quot;doc&quot;:&#123;&quot;title&quot;:&quot;T-shirt&quot;,&quot;price&quot;:45.99&#125;&#125;&#x27;# 参数说明# update: 用于更新文档。# doc: 指定要更新的字段。 批量删除数据 12345678910# 注意数据行要顶行写，前面不要有空格curl -X POST -u elastic:123456 -k &#x27;https://127.0.0.1:9200/_bulk&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123;&quot;delete&quot;:&#123;&quot;_index&quot;:&quot;shopping&quot;,&quot;_id&quot;:&quot;1&quot;&#125;&#125;&#123;&quot;delete&quot;:&#123;&quot;_index&quot;:&quot;shopping&quot;,&quot;_id&quot;:&quot;2&quot;&#125;&#125;&#123;&quot;delete&quot;:&#123;&quot;_index&quot;:&quot;shopping&quot;,&quot;_id&quot;:&quot;3&quot;&#125;&#125;&#123;&quot;delete&quot;:&#123;&quot;_index&quot;:&quot;shopping&quot;,&quot;_id&quot;:&quot;4&quot;&#125;&#125;&#x27;# 参数说明# delete: 用于删除文档。 条件更新 123456789101112131415161718192021# POST /&lt;target&gt;/_update_by_query# 这里将category为华为的数据价格改为1999curl -X POST -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_update_by_query?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;query&quot;: &#123; &quot;match&quot;: &#123; &quot;category&quot;: &quot;books&quot; &#125; &#125;, &quot;script&quot;: &#123; &quot;source&quot;: &quot;ctx._source.price = 20.99&quot;, &quot;lang&quot;: &quot;painless&quot; &#125; &#125;&#x27;# 参数说明## &quot;query&quot;: &#123;&#125; 查询条件## &quot;script&quot;: &#123;&#125; 脚本### source: 脚本内容### lang: 脚本语言#### painless 是 Elasticsearch 官方提供的脚本语言，它提供了许多内置函数和变量，可以方便地实现各种复杂的逻辑操作。https://www.elastic.co/guide/en/elasticsearch/painless/current/painless-lang-spec.html 条件删除 1234# POST /&lt;target&gt;/_delete_by_querycurl -X POST -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_delete_by_query?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123;&quot;query&quot;:&#123;&quot;match&quot;:&#123;&quot;category&quot;:&quot;books&quot;&#125;&#125;&#125;&#x27; 条件查询 match_all: 全部匹配查询 1234567# GET /&lt;target&gt;/_searchcurl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123;&quot;query&quot;:&#123;&quot;match_all&quot;:&#123;&#125;&#125;&#125;&#x27;# 或者简写为curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; term: 精确匹配查询（关键字查询，即不分词） 12345678910111213curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123;&quot;query&quot;:&#123;&quot;term&quot;:&#123;&quot;category&quot;:&quot;electronics&quot;&#125;&#125;&#125;&#x27;# 如果字段被额外设置 keyword 类型，则需要加上 .keyword 后缀curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123;&quot;query&quot;:&#123;&quot;term&quot;:&#123;&quot;address.keyword&quot;:&quot;广州白云山公园&quot;&#125;&#125;&#125;&#x27;# term处理多值字段(数组)时，term查询是包含，不是等于curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123;&quot;query&quot;:&#123;&quot;term&quot;:&#123;&quot;tags&quot;:&quot;technology&quot;&#125;&#125;&#125;&#x27; terms: 多关键字精确匹配查询 123curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123;&quot;query&quot;:&#123;&quot;terms&quot;:&#123;&quot;category&quot;:[&quot;electronics&quot;,&quot;books&quot;]&#125;&#125;&#125;&#x27; range: 范围查询 12345678910111213141516171819202122232425curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123;&quot;query&quot;:&#123;&quot;range&quot;:&#123;&quot;price&quot;:&#123;&quot;gte&quot;:20,&quot;lte&quot;:30&#125;&#125;&#125;&#125;&#x27; # gte: 大于等于 # lte: 小于等于 # gt: 大于 # lt: 小于# 时间范围查询curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123;&quot;query&quot;:&#123;&quot;range&quot;:&#123;&quot;created_at&quot;:&#123;&quot;gte&quot;:&quot;2025-04-20 00:00:00&quot;,&quot;lte&quot;:&quot;2025-05-20 23:59:59&quot;&#125;&#125;&#125;&#125;&#x27;# 基于日期数学表达式查询curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123;&quot;query&quot;:&#123;&quot;range&quot;:&#123;&quot;created_at&quot;:&#123;&quot;gte&quot;:&quot;now-1y&quot;&#125;&#125;&#125;&#125;&#x27;# 支持的日期表达式# - now：当前时间点。# - now-1d：从当前时间点向前推1天的时间点。# - now-1w：从当前时间点向前推1周的时间点。# - now-1M：从当前时间点向前推1个月的时间点。# - now-1y：从当前时间点向前推1年的时间点。# - now+1h：从当前时间点向后推1小时的时间点。 exists: 查询字段存在的数据 12345curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123;&quot;query&quot;:&#123;&quot;exists&quot;:&#123;&quot;field&quot;:&quot;title&quot;&#125;&#125;&#125;&#x27; # field: 指定要查询的字段 # 示例：查询 title 字段存在的文档 ids: 根据一组ID查询 12345curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123;&quot;query&quot;:&#123;&quot;ids&quot;:&#123;&quot;values&quot;:[&quot;1&quot;,&quot;2&quot;]&#125;&#125;&#125;&#x27; # values: 指定要查询的ID列表 # 示例：查询ID为1和2的文档 prefix: 前缀查询 仅适用于关键字类型(keyword)的字段 123456789101112curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123;&quot;query&quot;:&#123;&quot;prefix&quot;:&#123;&quot;category&quot;:&quot;elec&quot;&#125;&#125;&#125;&#x27;# 仅适用于keyword类型字段，所以下面这个请求查询不到数据curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123;&quot;query&quot;:&#123;&quot;prefix&quot;:&#123;&quot;address&quot;:&quot;广州白云山&quot;&#125;&#125;&#125;&#x27;# 因为address被附加了keyword类型，所以需要加上.keyword后缀后可以查询到数据curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123;&quot;query&quot;:&#123;&quot;prefix&quot;:&#123;&quot;address.keyword&quot;:&quot;广州白云山&quot;&#125;&#125;&#125;&#x27; wildcard: 通配符查询 仅适用于关键字类型(keyword)的字段 12345curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123;&quot;query&quot;:&#123;&quot;wildcard&quot;:&#123;&quot;category&quot;:&quot;e?e*&quot;&#125;&#125;&#125;&#x27;# ?: 任意单个字符# *: 任意多个字符 regexp: 正则表达式查询 仅适用于关键字类型(keyword)的字段 123curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123;&quot;query&quot;:&#123;&quot;regexp&quot;:&#123;&quot;category&quot;:&quot;e.e.*&quot;&#125;&#125;&#125;&#x27; fuzzy: 支持编辑距离的模糊查询 仅适用于关键字类型(keyword)的字段 fuzzy检索是一种强大的搜索功能，它能够在用户输入内容存在拼写错误或上下文不一致时，仍然返回与搜索词相似的文档。通过使用编辑距离算法来度量输入词与文档中词条的相似程度，模糊查询在保证搜索结果相关性的同时，有效地提高了搜索容错能力。 编辑距离是指从一个单词转换到另一个单词需要编辑单字符的次数。如中文集团到中威集团编辑距离就是1，只需要修改一个字符；如果fuzziness值在这里设置成2，会把编辑距离为2的东东集团也查出来。 123456789101112131415curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;query&quot;:&#123; &quot;fuzzy&quot;:&#123; &quot;category&quot;:&#123; &quot;value&quot;:&quot;beeks&quot;, &quot;fuzziness&quot;:&quot;2&quot;, &quot;prefix_length&quot;:1 &#125; &#125; &#125; &#125;&#x27;# fuzziness：用于编辑距离的设置，其默认值为AUTO，支持的数值为[0，1，2]。如果值设置越界会报错。# prefix_length: 搜索词的前缀长度，在此长度内不会应用模糊匹配。默认是0，即整个词都会被模糊匹配。 match: 全文检索(即分词) 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123;&quot;query&quot;:&#123;&quot;match&quot;:&#123;&quot;address&quot;:&quot;广州白云山公园&quot;&#125;&#125;&#125;&#x27;# 因为 desc 的索引分词器是 ik_max_word，查看“广州白云山公园”被分词后的结果curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/_analyze?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;analyzer&quot;: &quot;ik_max_word&quot;, &quot;text&quot;: &quot;广州白云山公园&quot; &#125;&#x27;# 返回值&#123; &quot;tokens&quot; : [ &#123; &quot;token&quot; : &quot;广州&quot;, &quot;start_offset&quot; : 0, &quot;end_offset&quot; : 2, &quot;type&quot; : &quot;CN_WORD&quot;, &quot;position&quot; : 0 &#125;, &#123; &quot;token&quot; : &quot;白云山&quot;, &quot;start_offset&quot; : 2, &quot;end_offset&quot; : 5, &quot;type&quot; : &quot;CN_WORD&quot;, &quot;position&quot; : 1 &#125;, &#123; &quot;token&quot; : &quot;白云&quot;, &quot;start_offset&quot; : 2, &quot;end_offset&quot; : 4, &quot;type&quot; : &quot;CN_WORD&quot;, &quot;position&quot; : 2 &#125;, &#123; &quot;token&quot; : &quot;云山&quot;, &quot;start_offset&quot; : 3, &quot;end_offset&quot; : 5, &quot;type&quot; : &quot;CN_WORD&quot;, &quot;position&quot; : 3 &#125;, &#123; &quot;token&quot; : &quot;公园&quot;, &quot;start_offset&quot; : 5, &quot;end_offset&quot; : 7, &quot;type&quot; : &quot;CN_WORD&quot;, &quot;position&quot; : 4 &#125; ]&#125;# 所以只要desc中包含如上这些内容的数据都会被匹配上# 但是这样匹配的结果就不够精确，如何尽量匹配更多的分词呢，可以增加 minimum_should_matchcurl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;query&quot;:&#123; &quot;match&quot;:&#123; &quot;address&quot;:&#123; &quot;query&quot;: &quot;广州白云山公园&quot;, &quot;minimum_should_match&quot;: 2 &#125; &#125; &#125; &#125;&#x27;# minimum_should_match: 2 表示至少匹配两个# 如果希望全部都匹配呢curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;query&quot;:&#123; &quot;match&quot;:&#123; &quot;address&quot;:&#123; &quot;query&quot;: &quot;广州白云山公园&quot;, &quot;operator&quot;: &quot;and&quot; &#125; &#125; &#125; &#125;&#x27;# operator: and 表示全部匹配，此时相当于精确匹配，其默认值是 or multi_match: 多字段查询 multi_match查询在Elasticsearch中用于在多个字段上执行相同的搜索操作。它可以接受一个查询字符串，并在指定的字段集合中搜索这个字符串。multi_match查询提供了灵活的匹配类型和操作符选项，以便根据不同的搜索需求调整搜索行为。 123456789101112curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;query&quot;:&#123; &quot;multi_match&quot;:&#123; &quot;query&quot;: &quot;广州shirt&quot;, &quot;fields&quot;:[&quot;title&quot;,&quot;address&quot;] &#125; &#125; &#125;&#x27;# query: 查询条件# fields: 指定多个字段进行匹配 match_phrase: 短语查询 match_phrase查询在Elasticsearch中用于执行短语搜索，它不仅匹配整个短语，而且还考虑了短语中各个词的顺序和位置。这种查询类型对于搜索精确短语非常有用，尤其是在用户输入的查询与文档中的文本表达方式需要严格匹配时。 123456789101112curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;query&quot;:&#123; &quot;match_phrase&quot;:&#123; &quot;address&quot;:&#123; &quot;query&quot;:&quot;广州白云山&quot; &#125; &#125; &#125; &#125;&#x27;# 要求查询结果中的数据必须包含&quot;广州白云山&quot;，而且“广州”和“白云山”这两个词是不能分开的，因为 match_phrase 匹配的是相邻词条 query_string: 支持与或非表达式的查询 query_string查询是一种灵活的查询类型，它允许使用Lucene查询语法来构建复杂的搜索查询。这种查询类型支持多种逻辑运算符，包括与（AND）、或（OR）和非（NOT），以及通配符、模糊搜索和正则表达式等功能。query_string查询可以在单个或多个字段上进行搜索，并且可以处理复杂的查询逻辑。 注意: 查询字段分词就将查询条件分词查询，查询字段不分词将查询条件不分词查询 12345678910111213141516171819202122232425262728293031323334# 查询所有字段中包含 &quot;公园&quot;和 &quot;华为&quot; 的文档curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;query&quot;:&#123; &quot;query_string&quot;:&#123; &quot;query&quot;:&quot;公园 AND electronics&quot; &#125; &#125; &#125;&#x27;# 指定查询的单个字段curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;query&quot;:&#123; &quot;query_string&quot;:&#123; &quot;default_field&quot;:&quot;category&quot;, &quot;query&quot;:&quot;白云山 OR books&quot; &#125; &#125; &#125;&#x27;# 指定查询的多个字段curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;query&quot;:&#123; &quot;query_string&quot;:&#123; &quot;fields&quot;:[&quot;category&quot;,&quot;address&quot;], &quot;query&quot;:&quot;白云山 OR (electronics AND shirt)&quot; &#125; &#125; &#125;&#x27; simple_query_string: 类似 query_string，但是会忽略错误的语法，同时只支持部分查询语法 1234567891011curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;query&quot;:&#123; &quot;simple_query_string&quot;:&#123; &quot;query&quot;:&quot;广州公园&quot;, &quot;default_operator&quot;:&quot;AND&quot; &#125; &#125; &#125;&#x27;# default_operator: 默认为 OR，设置为 AND 则必须同时匹配 ES查询结果属性含义 123456789101112131415161718&#123; &quot;took&quot;:16, # 表示查询从请求到完成耗时 16 毫秒。 &quot;timed_out&quot;:false, # 表示查询在规定的时间内完成，没有发生超时。如果为 true，则表示查询超时。 &quot;_shards&quot;:&#123; # 涉及到查询过程中使用的分片信息 &quot;total&quot;:1, # 表示查询涉及到的总分片数为 1 &quot;successful&quot;:1, # 表示查询成功完成的分片数为 1 &quot;skipped&quot;:0, # 表示查询过程中被跳过的分片数为 0 &quot;failed&quot;:0 # 表示查询过程中失败的分片数为 0 &#125;, &quot;hits&quot;:&#123; # 包含查询结果的详细信息 &quot;total&quot;:&#123; # 包含查询结果的总数 &quot;value&quot;:4, # 表示查询结果的总数为 4 &quot;relation&quot;:&quot;eq&quot; # 表示返回的总数 value 是确切的（equal）。如果为 gte，则表示返回的总数是一个下限值。 &#125;, &quot;max_score&quot;:0.0, # 表示匹配到的文档中最高的得分。如果是排序查询，这个值会有意义。当前结果因为 size: 0，没有实际返回文档，所以得分为 0.0 &quot;hits&quot;:[ ] # 包含查询结果的列表，每个结果都是一个对象，包含文档的元数据，如 id、分数等。 &#125;&#125; bool 查询 布尔查询可以按照布尔逻辑条件组织多条查询语句，只有符合整个布尔条件的文档才会被搜索出来。 在布尔条件中，可以包含两种不同的上下文。 1.搜索上下文(query context)：使用搜索上下文时，Elasticsearch需要计算每个文档与搜索条件的相关度得分，这个得分的计算需使用一套复杂的计算公式，有一定的性能开销，带文本分析的全文检索的查询语句很适合放在搜索上下文中。 2.过滤上下文(filter context)：使用过滤上下文时，Elasticsearch只需要判断搜索条件跟文档数据是否匹配，例如使用Term query判断一个值是否跟搜索内容一致，使用Range query判断某数据是否位于某个区间等。过滤上下文的查询不需要进行相关度得分计算，还可以使用缓存加快响应速度，很多术语级查询语句都适合放在过滤上下文中。 bool 查询包含 must、must_not、should、filter 四种子句。 类型 说明 must 可包含多个查询条件，每个条件均满足的文档才能被搜索到，每次查询需要计算相关度得分，属于搜索上下文 should 可包含多个查询条件，不存在must和fiter条件时，至少要满足多个查询条件中的一个，文档才能被搜索到，否则需满足的条件数量不受限制,匹配到的查询越多相关度越高，也属于搜索上下文 filter 可包含多个过滤条件，每个条件均满足的文档才能被搜索到，每个过滤条件不计算相关度得分，结果在一定条件下会被缓存， 属于过滤上下文 must_not 可包含多个过滤条件，每个条件均不满足的文档才能被搜索到，每个过滤条件不计算相关度得分，结果在一定条件下会被缓存， 属于过滤上下文 must 12345678910111213# 两个条件都需要满足curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;query&quot;:&#123; &quot;bool&quot;:&#123; &quot;must&quot;:[ &#123;&quot;match&quot;:&#123;&quot;category&quot;:&quot;electronics&quot;&#125;&#125;, &#123;&quot;match&quot;:&#123;&quot;desc&quot;:&quot;公园&quot;&#125;&#125; ] &#125; &#125; &#125;&#x27; must_not 12345678910111213# 两个条件都不满足curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;query&quot;:&#123; &quot;bool&quot;:&#123; &quot;must_not&quot;:[ &#123;&quot;match&quot;:&#123;&quot;category&quot;:&quot;electronics&quot;&#125;&#125;, &#123;&quot;match&quot;:&#123;&quot;desc&quot;:&quot;公园&quot;&#125;&#125; ] &#125; &#125; &#125;&#x27; should 12345678910111213# 两个条件满足一个即可curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;query&quot;:&#123; &quot;bool&quot;:&#123; &quot;should&quot;:[ &#123;&quot;match&quot;:&#123;&quot;category&quot;:&quot;electronics&quot;&#125;&#125;, &#123;&quot;match&quot;:&#123;&quot;desc&quot;:&quot;公园&quot;&#125;&#125; ] &#125; &#125; &#125;&#x27; filter 12345678910111213# filter中的条件为非 match，即不能是全文检索curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;query&quot;:&#123; &quot;bool&quot;:&#123; &quot;filter&quot;:[ &#123;&quot;term&quot;:&#123;&quot;category&quot;:&quot;electronics&quot;&#125;&#125;, &#123;&quot;range&quot;:&#123;&quot;price&quot;:&#123;&quot;gte&quot;:20&#125;&#125;&#125; ] &#125; &#125; &#125;&#x27; 分页与排序 1234567891011# from: 从第几条开始，默认0# size: 取多少条# sort: 排序，默认为按文档id升序curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;query&quot;:&#123;&quot;range&quot;:&#123;&quot;price&quot;:&#123;&quot;gte&quot;:20,&quot;lte&quot;:30&#125;&#125;&#125;, &quot;sort&quot;:[&#123;&quot;price&quot;:&quot;address&quot;&#125;], &quot;from&quot;:0, &quot;size&quot;:5 &#125;&#x27; 只返回部分字段 1234567# _source: 指定要返回的字段列表curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27; &#123;&quot;query&quot;:&#123;&quot;range&quot;:&#123;&quot;price&quot;:&#123;&quot;gte&quot;:20,&quot;lte&quot;:30&#125;&#125;&#125;, &quot;_source&quot;:[&quot;category&quot;,&quot;title&quot;,&quot;price&quot;] &#125;&#x27; 高亮显示 123456789101112131415161718# 高亮显示仅支持全文检索字段curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;query&quot;: &#123; &quot;multi_match&quot;: &#123; &quot;fields&quot;: [&quot;title&quot;,&quot;address&quot;], &quot;query&quot;: &quot;公园shirt&quot; &#125; &#125;, &quot;highlight&quot;: &#123; &quot;post_tags&quot;: [&quot;&lt;/span&gt;&quot;], &quot;pre_tags&quot;: [&quot;&lt;span style=&#x27;color:red&#x27;&gt;&quot;], &quot;fields&quot;: &#123; &quot;*&quot;:&#123;&#125; &#125; &#125; &#125;&#x27; 地理空间位置查询 地理空间位置查询是数据库和搜索系统中的一个重要特性，特别是在地理信息系统（GIS）和位置服务中。它允许用户基于地理位置信息来搜索和过滤数据。在Elasticsearch这样的全文搜索引擎中，地理空间位置查询被广泛应用，例如在旅行、房地产、物流和零售等行业，用于提供基于位置的搜索功能。 在Elasticsearch中，地理空间数据通常存储在geo_point字段类型中。这种字段类型可以存储纬度和经度坐标，用于表示地球上的一个点。 示例 创建一个索引，并添加一个geo_point字段： 12345678910111213141516curl -X PUT -u elastic:123456 -k &#x27;https://127.0.0.1:9200/tourist_spots&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;mappings&quot;: &#123; &quot;properties&quot;: &#123; &quot;name&quot;: &#123; &quot;type&quot;: &quot;text&quot;, &quot;analyzer&quot;: &quot;ik_max_word&quot;, &quot;search_analyzer&quot;: &quot;ik_max_word&quot; &#125;, &quot;location&quot;: &#123; &quot;type&quot;: &quot;geo_point&quot; &#125; &#125; &#125; &#125;&#x27; 插入数据 1234567891011curl -X POST -u elastic:123456 -k &#x27;https://127.0.0.1:9200/tourist_spots/_bulk&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123;&quot;index&quot;:&#123;&#125;&#125;&#123;&quot;name&quot;:&quot;雷峰塔&quot;,&quot;location&quot;:&#123;&quot;lat&quot;:30.2615,&quot;lon&quot;:120.1480&#125;&#125;&#123;&quot;index&quot;:&#123;&#125;&#125;&#123;&quot;name&quot;:&quot;西湖&quot;,&quot;location&quot;:&#123;&quot;lat&quot;:30.2614,&quot;lon&quot;:120.1479&#125;&#125;&#123;&quot;index&quot;:&#123;&#125;&#125;&#123;&quot;name&quot;:&quot;苏堤春晓&quot;,&quot;location&quot;:&#123;&quot;lat&quot;:30.2624,&quot;lon&quot;:120.1708&#125;&#125;&#x27;# lat: 纬度# lon: 经度 查询数据 12345678910111213141516171819202122232425262728293031# 查询杭州西湖5km附近的景点# 雷峰塔 - 位于西湖附近，距离约2.8公里。# 苏堤春晓 - 位于西湖边，距离西湖中心约1公里。curl -X GET -u elastic:123456 -k &#x27;https://127.0.0.1:9200/tourist_spots/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;query&quot;: &#123; &quot;bool&quot;: &#123; &quot;must&quot;: &#123; &quot;match_all&quot;: &#123;&#125; &#125;, &quot;filter&quot;: &#123; &quot;geo_distance&quot;: &#123; &quot;distance&quot;: &quot;5km&quot;, &quot;distance_type&quot;: &quot;arc&quot;, &quot;location&quot;: &#123; &quot;lat&quot;: 30.2614, &quot;lon&quot;: 120.1479 &#125; &#125; &#125; &#125; &#125; &#125;&#x27;# distance: 5km 表示距离为5公里# distance_type: arc, plane, sloppy_arc, # arc: 默认值，使用haversine公式计算距离，结果是精确的，但计算速度较慢。 # plane: 使用平面直角坐标系计算距离，结果是粗略的，但计算速度更快。 # sloppy_arc: 使用haversine公式计算距离，但允许误差。# location: 搜索条件 向量搜索 Elasticsearch 8.x 引入了一个重要的新特性：向量检索（Vector Search），特别是通过KNN（K-Nearest Neighbors）算法支持向量近邻检索。这一特性使得Elasticsearch在机器学习、数据分析和推荐系统等领域的应用变得更加广泛和强大。 向量检索的基本思路是，将文档（或数据项）表示为高维向量，并使用这些向量来执行相似性搜索。在Elasticsearch中，这些向量被存储在dense_vector类型的字段中，然后使用KNN算法来找到与给定向量最相似的其他向量。 示例 创建索引 12345678910111213141516171819202122curl -X PUT -u elastic:123456 -k &#x27;https://127.0.0.1:9200/image-index&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;mappings&quot;: &#123; &quot;properties&quot;: &#123; &quot;image-vector&quot;: &#123; &quot;type&quot;: &quot;dense_vector&quot;, &quot;dims&quot;: 3 &#125;, &quot;title&quot;: &#123; &quot;type&quot;: &quot;text&quot; &#125;, &quot;file-type&quot;: &#123; &quot;type&quot;: &quot;keyword&quot; &#125;, &quot;my_label&quot;: &#123; &quot;type&quot;: &quot;text&quot; &#125; &#125; &#125; &#125;&#x27;# dims: 3 表示3维向量，最高支持2048 添加数据 123456789curl -X POST -u elastic:123456 -k &#x27;https://127.0.0.1:9200/image-index/_bulk&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;index&quot;: &#123;&#125; &#125;&#123; &quot;image-vector&quot;: [-5, 9, -12], &quot;title&quot;: &quot;Image A&quot;, &quot;file-type&quot;: &quot;jpeg&quot;, &quot;my_label&quot;: &quot;red&quot; &#125;&#123; &quot;index&quot;: &#123;&#125; &#125;&#123; &quot;image-vector&quot;: [10, -2, 3], &quot;title&quot;: &quot;Image B&quot;, &quot;file-type&quot;: &quot;png&quot;, &quot;my_label&quot;: &quot;blue&quot; &#125;&#123; &quot;index&quot;: &#123;&#125; &#125;&#123; &quot;image-vector&quot;: [4, 0, -1], &quot;title&quot;: &quot;Image C&quot;, &quot;file-type&quot;: &quot;gif&quot;, &quot;my_label&quot;: &quot;red&quot; &#125;&#x27; 向量检索 1234567891011121314151617181920curl -X POST -u elastic:123456 -k &#x27;https://127.0.0.1:9200/image-index/_search?pretty&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;query&quot;:&#123; &quot;match_all&quot;: &#123;&#125; &#125;, &quot;knn&quot;: &#123; &quot;field&quot;: &quot;image-vector&quot;, &quot;query_vector&quot;: [-5, 10, -12], &quot;k&quot;: 10, &quot;num_candidates&quot;: 100 &#125;, &quot;fields&quot;: [ &quot;title&quot;, &quot;file-type&quot; ] &#125;&#x27;# query: 搜索条件，这里可以不加这个# knn: 8.8.1 版本开始默认支持# field: 搜索向量字段# query_vector: 搜索向量# k: 搜索结果数量# num_candidates: 搜索候选数量，用于优化性能# fields: 搜索结果返回字段","summary":"摘要 本文介绍 Elasticsearch 的 REST APIs Elasticsearch版本8.17.3 官方文档:REST APIs Elasticsearch 的 REST APIs:聚合查询","date_published":"2025-04-17T13:30:05.000Z","tags":["技术","elastic","elasticsearch","elasticsearch"]},{"id":"https://blog.hanqunfeng.com/2025/04/16/elasticsearch-04-cert/","url":"https://blog.hanqunfeng.com/2025/04/16/elasticsearch-04-cert/","title":"Elasticsearch的证书过期处理方法","content_html":"<!--\n **加粗**\n *斜体*\n ***加粗并斜体***\n ~~删除线~~\n ==突出显示==\n `突出显示(推荐)`\n ++下划线++\n ~下标~\n ^上标^\n 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.\n 图片设置宽度和高度(通过uPic上传后，需要将upic修改过为blog，用于添加水印) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)\n\n +++ **点击折叠**\n 这是被隐藏的内容\n +++\n\n::: tips success warning danger\n这里是容器内的内容\n:::\n\n% note info % success warning danger\n这里是容器内的内容\n% endnote %\n\n引用本地其它文章连接{}\n 大括号开始% post_link 文件名称(不包含.md) %大括号结束\n -->\n<h2 id=\"摘要\">摘要</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>本文介绍Elasticsearch证书过期时的处理方法</p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/8.17/index.html\">Elasticsearch</a>版本8.17.3</p>\n</li>\n<li class=\"lvl-2\">\n<p>本文基于 <a href=\"/2025/03/20/elasticsearch-01-install/\" title=\"linux下安装Elasticsearch\">linux下安装Elasticsearch</a></p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/8.17/update-node-certs.html\">官方文档:Updating node security certificates</a></p>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"ES证书简介\">ES证书简介</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Elasticsearch 8 默认情况下创建的证书只有3年有效期，过期时需要创建新的证书，为了不必要的麻烦，也可以一开始就创建一个有效期比较长的证书。</p>\n</li>\n<li class=\"lvl-2\">\n<p>在 Elasticsearch 8 的配置下，<code>config/certs</code> 目录通常存放的是用于安全通信的证书和密钥文件。这些文件确保了 Elasticsearch 实例之间的通讯以及与外部客户端的通讯能够被加密且经过认证。</p>\n</li>\n<li class=\"lvl-2\">\n<p><code>config/certs</code> 目录包含三个文件分别是：</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-4\"><code>http.p12</code>: 这是一个 PKCS#12 格式的文件（通常带有.p12或.pfx扩展名），包含了 Elasticsearch HTTP 层用来进行 TLS/SSL 通信所需的一切，包括一个私钥、相应的公钥证书（服务器证书）及 CA 证书链。客户端使用这个文件来验证它们正在与正确的服务器进行通信，并且此服务器也信任该客户端。</li>\n<li class=\"lvl-4\"><code>http_ca.crt</code>: CA (Certificate Authority) 根证书或中间证书，用于验证通过 HTTP 协议连接至 Elasticsearch 服务端点的身份。当客户端尝试建立 HTTPS 连接时，它会检查来自 Elasticsearch 的证书是否由这个 CA 签名；这是确保双方通信安全的重要步骤之一。</li>\n<li class=\"lvl-4\"><code>transport.p12</code>: 同样为 PKCS#12 格式，但这个特定的文件是给 Elasticsearch 节点之间内部传输层使用的。在集群内，节点间需<br>\n要相互认证，transport.p12就包含着让不同 Elasticsearch 实例能互相识别所需的私钥和证书。</li>\n</ul>\n</li>\n<li class=\"lvl-2\">\n<p>总之，<code>http.p12</code>服务于面向 Web 的接口，而<code>transport.p12</code>则处理 Elasticsearch 群集内的交互；两者都依赖于<code>http_ca.crt</code>来进行身份验证过程的一部分。</p>\n</li>\n</ul>\n<h2 id=\"ES证书过期的影响\">ES证书过期的影响</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>‌集群无法增加新节点‌：特别是在重启集群时，节点无法加入集群，导致无法正常重启。‌</p>\n</li>\n<li class=\"lvl-2\">\n<p>‌访问异常‌：如果使用证书连接ES集群，会导致无法正常访问集群。</p>\n</li>\n<li class=\"lvl-2\">\n<p>‌安全风险‌：证书过期会破坏证书链的信任，可能引发安全漏洞。</p>\n</li>\n<li class=\"lvl-2\">\n<p>‌日志干扰‌：会持续出现证书过期的错误日志，干扰问题排查和诊断。</p>\n</li>\n</ul>\n<h2 id=\"查看证书的过期时间\">查看证书的过期时间</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>通过openssl查看证书的过期时间</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看crt证书到期时间</span></span><br><span class=\"line\"><span class=\"comment\"># -dates: 显示证书的开始时间和结束时间</span></span><br><span class=\"line\"><span class=\"comment\"># -noout: 不输出证书的详细信息</span></span><br><span class=\"line\">openssl x509 -<span class=\"keyword\">in</span> config/certs/http_ca.crt -dates -noout</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看p12证书到期时间</span></span><br><span class=\"line\"><span class=\"comment\"># -clcerts: 只显示证书，不显示私钥</span></span><br><span class=\"line\"><span class=\"comment\"># -nokeys: 不输出私钥</span></span><br><span class=\"line\"><span class=\"comment\"># -password pass: 指定私钥的密码，这里为空(因为在创建证书时没有设置密码)，注意密码必须写在pass:的后面，不加这个参数会提示你输入密码，直接回车即可</span></span><br><span class=\"line\">openssl pkcs12 -<span class=\"keyword\">in</span> ca.p12 -password pass: -clcerts -nokeys | openssl x509 -dates -noout</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>通过ES的API查看证书过期时间</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -XGET -k -u <span class=\"string\">&#x27;elastic:123456&#x27;</span> <span class=\"string\">&#x27;https://127.0.0.1:9200/_ssl/certificates?pretty&#x27;</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"证书过期处理\">证书过期处理</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Elasticsearch 8 的证书创建需要使用命令行工具 <code>elasticsearch-certutil</code>，这部分的详细信息可以参考<a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/8.17/certutil.html\">官方文档:elasticsearch-certutil</a></p>\n</li>\n<li class=\"lvl-2\">\n<p>当证书过期时，需要重新生成证书，并更新<code>config/certs</code>目录下的文件，更新前要备份原证书。</p>\n</li>\n</ul>\n<h3 id=\"备份原证书\">备份原证书</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ <span class=\"built_in\">cp</span> -r config/certs config/certs.bak</span><br><span class=\"line\">$ <span class=\"built_in\">rm</span> -rf config/certs/*</span><br></pre></td></tr></table></figure>\n<h3 id=\"生成新证书\">生成新证书</h3>\n<h4 id=\"生成CA证书\">生成CA证书</h4>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>生成crt证书</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># --days 36500: 指定证书的有效期，单位为天，这里设置为 36500 天，大约 10 年</span></span><br><span class=\"line\">$ bin/elasticsearch-certutil ca --pem --out new-ca.zip --days 36500</span><br><span class=\"line\"><span class=\"comment\"># 解压</span></span><br><span class=\"line\">$ unzip new-ca.zip</span><br><span class=\"line\"><span class=\"comment\"># 将创建的证书移动到指定目录</span></span><br><span class=\"line\">$ <span class=\"built_in\">mv</span> ca/ca.crt config/certs/http_ca.crt</span><br><span class=\"line\">$ <span class=\"built_in\">mv</span> ca/ca.key config/certs/http_ca.key</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>也可以生成PKCS#12格式的证书</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ bin/elasticsearch-certutil ca --out config/certs/ca.p12 --days 36500</span><br></pre></td></tr></table></figure>\n<h4 id=\"生成transport证书\">生成transport证书</h4>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 基于crt证书</span></span><br><span class=\"line\">$ bin/elasticsearch-certutil cert --ca-cert config/certs/http_ca.crt --ca-key config/certs/http_ca.key --out config/certs/transport.p12 --days 36500</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 基于PKCS#12格式的证书</span></span><br><span class=\"line\">$ bin/elasticsearch-certutil cert --ca config/certs/ca.p12 --out config/certs/transport.p12 --days 36500</span><br></pre></td></tr></table></figure>\n<h4 id=\"生成http证书\">生成http证书</h4>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 这里是交互式命令行</span></span><br><span class=\"line\">$ bin/elasticsearch-certutil http</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>输出说明</p>\n</li>\n</ul>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Generate a CSR? [y/N]n # 不生成CSR</span><br><span class=\"line\">Use an existing CA? [y/N]y # 使用已有的CA</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">以下区分crt证书和PKCS#12格式的证书</span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">crt 证书</span></span><br><span class=\"line\">CA Path: certs/http_ca.crt # CA证书，这里相对路径是相对应 config 目录，也可以是绝对路径</span><br><span class=\"line\">CA Key: certs/http_ca.key # CA密钥，这里相对路径是相对应 config 目录，也可以是绝对路径</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">PKCS#12格式的证书</span></span><br><span class=\"line\">CA Path: certs/ca.p12 # CA证书，这里相对路径是相对应 config 目录，也可以是绝对路径</span><br><span class=\"line\">Password for ca.p12: # CA密码，因为没有设置密码，所以这里直接回车</span><br><span class=\"line\"></span><br><span class=\"line\">For how long should your certificate be valid? [5y] 100y # 证书有效期，单位为年，默认是 5 年，这里设置为 100 年</span><br><span class=\"line\">Generate a certificate per node? [y/N]n # 不为每个节点创建独立的证书，即所有节点都使用同一个证书</span><br><span class=\"line\">Enter all the hostnames that you need, one per line.</span><br><span class=\"line\">When you are done, press &lt;ENTER&gt; once more to move on to the next step.</span><br><span class=\"line\"></span><br><span class=\"line\">localhost # 主机名，这里可以添加多个，回车一行一个，这里应该填写集群内所有节点服务器的hostname，可以通过 hostname 命令查看</span><br><span class=\"line\">ip-10-250-0-17.cn-northwest-1.compute.internal</span><br><span class=\"line\">ip-10-250-0-173.cn-northwest-1.compute.internal</span><br><span class=\"line\">ip-10-250-0-239.cn-northwest-1.compute.internal</span><br><span class=\"line\"></span><br><span class=\"line\">You entered the following hostnames.</span><br><span class=\"line\"></span><br><span class=\"line\"> - localhost</span><br><span class=\"line\"> - ip-10-250-0-17.cn-northwest-1.compute.internal</span><br><span class=\"line\"> - ip-10-250-0-173.cn-northwest-1.compute.internal</span><br><span class=\"line\"> - ip-10-250-0-239.cn-northwest-1.compute.internal</span><br><span class=\"line\"></span><br><span class=\"line\">Is this correct [Y/n]y # 确认主机名是否正确</span><br><span class=\"line\"></span><br><span class=\"line\">Enter all the IP addresses that you need, one per line.</span><br><span class=\"line\">When you are done, press &lt;ENTER&gt; once more to move on to the next step.</span><br><span class=\"line\"></span><br><span class=\"line\">127.0.0.1 # 主机IP，这里可以添加多个，回车一行一个，这里应该填写集群内所有节点服务器的IP地址</span><br><span class=\"line\">10.250.0.17</span><br><span class=\"line\">10.250.0.173</span><br><span class=\"line\">10.250.0.239</span><br><span class=\"line\"></span><br><span class=\"line\">You entered the following IP addresses.</span><br><span class=\"line\"></span><br><span class=\"line\"> - 127.0.0.1</span><br><span class=\"line\"> - 10.250.0.17</span><br><span class=\"line\"> - 10.250.0.173</span><br><span class=\"line\"> - 10.250.0.239</span><br><span class=\"line\"></span><br><span class=\"line\">Is this correct [Y/n]y # 确认IP是否正确</span><br><span class=\"line\"></span><br><span class=\"line\">Do you wish to change any of these options? [y/N]n # 不修改任何选项</span><br><span class=\"line\"></span><br><span class=\"line\">If you wish to use a blank password, simply press &lt;enter&gt; at the prompt below.</span><br><span class=\"line\">Provide a password for the &quot;http.p12&quot; file:  [&lt;ENTER&gt; for none] # 直接回车不设置密码</span><br><span class=\"line\"></span><br><span class=\"line\">What filename should be used for the output zip file? [/usr/local/elasticsearch/elasticsearch-8.17.3/elasticsearch-ssl-http.zip] # 输出文件名，这里可以自定义，默认是 elasticsearch-ssl-http.zip</span><br><span class=\"line\"></span><br><span class=\"line\">Zip file written to /usr/local/elasticsearch/elasticsearch-8.17.3/elasticsearch-ssl-http.zip</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>解压并将http证书拷贝到config/certs目录下</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ unzip elasticsearch-ssl-http.zip</span><br><span class=\"line\">Archive:  elasticsearch-ssl-http.zip</span><br><span class=\"line\">   creating: elasticsearch/</span><br><span class=\"line\">  inflating: elasticsearch/README.txt <span class=\"comment\"># 说明文件</span></span><br><span class=\"line\">  inflating: elasticsearch/http.p12  <span class=\"comment\"># http证书</span></span><br><span class=\"line\">  inflating: elasticsearch/sample-elasticsearch.yml <span class=\"comment\"># 示例elasticsearch配置文件</span></span><br><span class=\"line\">   creating: kibana/</span><br><span class=\"line\">  inflating: kibana/README.txt <span class=\"comment\"># 说明文件</span></span><br><span class=\"line\">  inflating: kibana/elasticsearch-ca.pem  <span class=\"comment\"># kibana用于验证ES的证书，即 elasticsearch.ssl.certificateAuthorities 中的配置</span></span><br><span class=\"line\">  inflating: kibana/sample-kibana.yml <span class=\"comment\"># 示例kibana配置文件</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 将http证书拷贝到config/certs目录下</span></span><br><span class=\"line\">$ <span class=\"built_in\">cp</span> elasticsearch/http.p12 config/certs/http.p12</span><br></pre></td></tr></table></figure>\n<h3 id=\"分发到ES集群中的每个节点\">分发到ES集群中的每个节点</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>上面创建新的证书时我们只在一个节点上进行即可，之后将生成好的证书分发到ES集群中的其它节点，这里就是 <code>http.p12</code> 和 <code>transport.p12</code>，将其拷贝到每个节点的 <code>config/certs</code> 目录下，拷贝前做好原证书的备份。</p>\n</li>\n<li class=\"lvl-2\">\n<p>如有必要也可以拷贝 <code>ca.p12</code> 或者 <code>http_ca.crt</code> 和 <code>http_ca.key</code> 到每个节点的 <code>config/certs</code> 目录下</p>\n</li>\n</ul>\n<h3 id=\"重启ES服务\">重启ES服务</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>集群中的节点依次重启</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ bin/elasticsearch -d</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>重启时可能会报错</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">org.elasticsearch.ElasticsearchSecurityException: failed to load SSL configuration [xpack.security.transport.ssl] - cannot <span class=\"built_in\">read</span> configured [PKCS12] keystore (as a truststore) [/usr/local/elasticsearch/elasticsearch-8.17.3/config/certs/transport.p12] - this is usually caused by an incorrect password; (a keystore password was provided)</span><br><span class=\"line\"><span class=\"comment\"># 虽然我们没有给transport.p12设置密码，但这里依旧提示提供的密码不正确，实际上这里使用的是 secure_password</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>解决方法</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 使用bin/elasticsearch-keystore list查看现有的密钥列表</span></span><br><span class=\"line\">$ bin/elasticsearch-keystore list</span><br><span class=\"line\">keystore.seed</span><br><span class=\"line\">xpack.security.http.ssl.keystore.secure_password</span><br><span class=\"line\">xpack.security.transport.ssl.keystore.secure_password</span><br><span class=\"line\">xpack.security.transport.ssl.truststore.secure_password</span><br><span class=\"line\"><span class=\"comment\"># 删除secure_password后再次重启ES服务就会正常了</span></span><br><span class=\"line\">$ bin/elasticsearch-keystore remove xpack.security.http.ssl.keystore.secure_password</span><br><span class=\"line\">$ bin/elasticsearch-keystore remove xpack.security.transport.ssl.keystore.secure_password</span><br><span class=\"line\">$ bin/elasticsearch-keystore remove xpack.security.transport.ssl.truststore.secure_password</span><br></pre></td></tr></table></figure>\n<h3 id=\"替换Kibana的证书\">替换Kibana的证书</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>将上面创建好的 <code>kibana/elasticsearch-ca.pem</code> 拷贝到Kibana服务器，比如 <code>/usr/local/kibana/kibana-8.17.3/config/certs/elasticsearch-ca.pem</code></p>\n</li>\n<li class=\"lvl-2\">\n<p>修改Kibana配置文件 <code>config/kibana.yml</code> 中的 <code>elasticsearch.ssl.certificateAuthorities</code> 配置，使其指向 <code>/usr/local/kibana/kibana-8.17.3/config/certs/elasticsearch-ca.pem</code></p>\n</li>\n</ul>\n<figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">elasticsearch.ssl.certificateAuthorities:</span> [<span class=\"string\">&quot;/usr/local/kibana/kibana-8.17.3/config/certs/elasticsearch-ca.pem&quot;</span>]</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>重启Kibana服务</p>\n</li>\n</ul>\n<h2 id=\"证书格式转换\">证书格式转换</h2>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># p12转换为crt格式</span></span><br><span class=\"line\">$ openssl pkcs12 -<span class=\"keyword\">in</span> config/certs/ca.p12 -out config/certs/http_ca.crt -nokeys</span><br><span class=\"line\"><span class=\"comment\"># p12转换为key格式</span></span><br><span class=\"line\">$ openssl pkcs12 -<span class=\"keyword\">in</span> config/certs/ca.p12 -out config/certs/http_ca.key -nocerts -nodes</span><br><span class=\"line\"><span class=\"comment\"># p12转换为pem格式</span></span><br><span class=\"line\">$ openssl pkcs12 -<span class=\"keyword\">in</span> config/certs/ca.p12 -out config/certs/http_ca.pem -nodes</span><br><span class=\"line\"><span class=\"comment\"># crt转换回PKCS12格式</span></span><br><span class=\"line\">$ openssl pkcs12 -<span class=\"built_in\">export</span> -out config/certs/http_ca.p12 -inkey config/certs/http_ca.key -<span class=\"keyword\">in</span> config/certs/http_ca.crt -name <span class=\"string\">&quot;My CA&quot;</span></span><br></pre></td></tr></table></figure>\n<div class=\"tips\">\n<p><em><strong>生成http证书时为每个节点单独配置证书</strong></em></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Generate a certificate per node? [y/N]y <span class=\"comment\"># 是否为每个节点单独配置证书，这里选择是</span></span><br><span class=\"line\">node <span class=\"comment\">#1 name: node-1 # 节点名称，必须与ES配置文件中的node.name一致</span></span><br><span class=\"line\"></span><br><span class=\"line\">Enter all the hostnames that you need, one per line. <span class=\"comment\"># 输入 node-1 节点的hostname</span></span><br><span class=\"line\">When you are <span class=\"keyword\">done</span>, press &lt;ENTER&gt; once more to move on to the next step.</span><br><span class=\"line\"></span><br><span class=\"line\">localhost                                         <span class=\"comment\"># 习惯加上 localhost</span></span><br><span class=\"line\">ip-10-250-0-239.cn-northwest-1.compute.internal   <span class=\"comment\"># node-1 的 hostname</span></span><br><span class=\"line\"></span><br><span class=\"line\">You entered the following hostnames.</span><br><span class=\"line\"></span><br><span class=\"line\"> - localhost</span><br><span class=\"line\"> - ip-10-250-0-239.cn-northwest-1.compute.internal</span><br><span class=\"line\"></span><br><span class=\"line\">Is this correct [Y/n]y <span class=\"comment\"># 确认是否正确</span></span><br><span class=\"line\"></span><br><span class=\"line\">Enter all the IP addresses that you need, one per line. <span class=\"comment\"># 输入 node-1 节点的IP地址</span></span><br><span class=\"line\">When you are <span class=\"keyword\">done</span>, press &lt;ENTER&gt; once more to move on to the next step.</span><br><span class=\"line\"></span><br><span class=\"line\">127.0.0.1                                         <span class=\"comment\"># 习惯加上 127.0.0.1</span></span><br><span class=\"line\">10.250.0.239                                      <span class=\"comment\"># node-1 的 IP</span></span><br><span class=\"line\"></span><br><span class=\"line\">You entered the following IP addresses.</span><br><span class=\"line\"></span><br><span class=\"line\"> - 127.0.0.1</span><br><span class=\"line\"> - 10.250.0.239</span><br><span class=\"line\"></span><br><span class=\"line\">Is this correct [Y/n]y <span class=\"comment\"># 确认是否正确</span></span><br><span class=\"line\"></span><br><span class=\"line\">Do you wish to change any of these options? [y/N]n <span class=\"comment\"># 不修改任何选项</span></span><br><span class=\"line\">Generate additional certificates? [Y/n]y  <span class=\"comment\"># 是否生成其他证书，这里选择是，接着为其它节点创建证书</span></span><br><span class=\"line\">node <span class=\"comment\">#2 name: node-2 # 节点名称，必须与ES配置文件中的node.name一致</span></span><br><span class=\"line\"><span class=\"comment\"># 依次为每个节点创建证书</span></span><br><span class=\"line\">………………</span><br><span class=\"line\"></span><br><span class=\"line\">Generate additional certificates? [Y/n]n <span class=\"comment\"># 创建好所有节点的证书后，选择n，不再创建新的证书</span></span><br><span class=\"line\"></span><br><span class=\"line\">If you wish to use a blank password, simply press &lt;enter&gt; at the prompt below.</span><br><span class=\"line\">Provide a password <span class=\"keyword\">for</span> the <span class=\"string\">&quot;http.p12&quot;</span> file:  [&lt;ENTER&gt; <span class=\"keyword\">for</span> none] <span class=\"comment\"># 直接回车不设置密码</span></span><br><span class=\"line\"></span><br><span class=\"line\">What filename should be used <span class=\"keyword\">for</span> the output zip file? [/usr/local/elasticsearch/elasticsearch-8.17.3/elasticsearch-ssl-http.zip] <span class=\"comment\"># 输出文件名，这里可以自定义，默认是 elasticsearch-ssl-http.zip</span></span><br><span class=\"line\"></span><br><span class=\"line\">Zip file written to /usr/local/elasticsearch/elasticsearch-8.17.3/elasticsearch-ssl-http.zip</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">此时解压查看文件结构</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">unzip elasticsearch-ssl-http.zip</span><br><span class=\"line\">Archive:  elasticsearch-ssl-http.zip</span><br><span class=\"line\">   creating: elasticsearch/</span><br><span class=\"line\">   creating: elasticsearch/node-1/</span><br><span class=\"line\">  inflating: elasticsearch/node-1/README.txt</span><br><span class=\"line\">  inflating: elasticsearch/node-1/http.p12  <span class=\"comment\"># node-1 的证书</span></span><br><span class=\"line\">  inflating: elasticsearch/node-1/sample-elasticsearch.yml</span><br><span class=\"line\">   creating: elasticsearch/node-2/</span><br><span class=\"line\">  inflating: elasticsearch/node-2/README.txt</span><br><span class=\"line\">  inflating: elasticsearch/node-2/http.p12 <span class=\"comment\"># node-2 的证书</span></span><br><span class=\"line\">  inflating: elasticsearch/node-2/sample-elasticsearch.yml</span><br><span class=\"line\">  creating: elasticsearch/node-3/</span><br><span class=\"line\">  inflating: elasticsearch/node-3/README.txt</span><br><span class=\"line\">  inflating: elasticsearch/node-3/http.p12 <span class=\"comment\"># node-3 的证书</span></span><br><span class=\"line\">  inflating: elasticsearch/node-3/sample-elasticsearch.yml</span><br><span class=\"line\">   creating: kibana/</span><br><span class=\"line\">  inflating: kibana/README.txt</span><br><span class=\"line\">  inflating: kibana/elasticsearch-ca.pem <span class=\"comment\"># kibana 的证书</span></span><br><span class=\"line\">  inflating: kibana/sample-kibana.yml</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">\n<p>将对应的证书拷贝到对应节点的 <code>config/certs</code> 目录下</p>\n</li>\n</ul>\n</div>\n","content_text":"摘要 本文介绍Elasticsearch证书过期时的处理方法 Elasticsearch版本8.17.3 本文基于 linux下安装Elasticsearch 官方文档:Updating node security certificates ES证书简介 Elasticsearch 8 默认情况下创建的证书只有3年有效期，过期时需要创建新的证书，为了不必要的麻烦，也可以一开始就创建一个有效期比较长的证书。 在 Elasticsearch 8 的配置下，config/certs 目录通常存放的是用于安全通信的证书和密钥文件。这些文件确保了 Elasticsearch 实例之间的通讯以及与外部客户端的通讯能够被加密且经过认证。 config/certs 目录包含三个文件分别是： http.p12: 这是一个 PKCS#12 格式的文件（通常带有.p12或.pfx扩展名），包含了 Elasticsearch HTTP 层用来进行 TLS/SSL 通信所需的一切，包括一个私钥、相应的公钥证书（服务器证书）及 CA 证书链。客户端使用这个文件来验证它们正在与正确的服务器进行通信，并且此服务器也信任该客户端。 http_ca.crt: CA (Certificate Authority) 根证书或中间证书，用于验证通过 HTTP 协议连接至 Elasticsearch 服务端点的身份。当客户端尝试建立 HTTPS 连接时，它会检查来自 Elasticsearch 的证书是否由这个 CA 签名；这是确保双方通信安全的重要步骤之一。 transport.p12: 同样为 PKCS#12 格式，但这个特定的文件是给 Elasticsearch 节点之间内部传输层使用的。在集群内，节点间需 要相互认证，transport.p12就包含着让不同 Elasticsearch 实例能互相识别所需的私钥和证书。 总之，http.p12服务于面向 Web 的接口，而transport.p12则处理 Elasticsearch 群集内的交互；两者都依赖于http_ca.crt来进行身份验证过程的一部分。 ES证书过期的影响 ‌集群无法增加新节点‌：特别是在重启集群时，节点无法加入集群，导致无法正常重启。‌ ‌访问异常‌：如果使用证书连接ES集群，会导致无法正常访问集群。 ‌安全风险‌：证书过期会破坏证书链的信任，可能引发安全漏洞。 ‌日志干扰‌：会持续出现证书过期的错误日志，干扰问题排查和诊断。 查看证书的过期时间 通过openssl查看证书的过期时间 12345678910# 查看crt证书到期时间# -dates: 显示证书的开始时间和结束时间# -noout: 不输出证书的详细信息openssl x509 -in config/certs/http_ca.crt -dates -noout# 查看p12证书到期时间# -clcerts: 只显示证书，不显示私钥# -nokeys: 不输出私钥# -password pass: 指定私钥的密码，这里为空(因为在创建证书时没有设置密码)，注意密码必须写在pass:的后面，不加这个参数会提示你输入密码，直接回车即可openssl pkcs12 -in ca.p12 -password pass: -clcerts -nokeys | openssl x509 -dates -noout 通过ES的API查看证书过期时间 1curl -XGET -k -u &#x27;elastic:123456&#x27; &#x27;https://127.0.0.1:9200/_ssl/certificates?pretty&#x27; 证书过期处理 Elasticsearch 8 的证书创建需要使用命令行工具 elasticsearch-certutil，这部分的详细信息可以参考官方文档:elasticsearch-certutil 当证书过期时，需要重新生成证书，并更新config/certs目录下的文件，更新前要备份原证书。 备份原证书 12$ cp -r config/certs config/certs.bak$ rm -rf config/certs/* 生成新证书 生成CA证书 生成crt证书 1234567# --days 36500: 指定证书的有效期，单位为天，这里设置为 36500 天，大约 10 年$ bin/elasticsearch-certutil ca --pem --out new-ca.zip --days 36500# 解压$ unzip new-ca.zip# 将创建的证书移动到指定目录$ mv ca/ca.crt config/certs/http_ca.crt$ mv ca/ca.key config/certs/http_ca.key 也可以生成PKCS#12格式的证书 1$ bin/elasticsearch-certutil ca --out config/certs/ca.p12 --days 36500 生成transport证书 12345# 基于crt证书$ bin/elasticsearch-certutil cert --ca-cert config/certs/http_ca.crt --ca-key config/certs/http_ca.key --out config/certs/transport.p12 --days 36500# 基于PKCS#12格式的证书$ bin/elasticsearch-certutil cert --ca config/certs/ca.p12 --out config/certs/transport.p12 --days 36500 生成http证书 12# 这里是交互式命令行$ bin/elasticsearch-certutil http 输出说明 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556Generate a CSR? [y/N]n # 不生成CSRUse an existing CA? [y/N]y # 使用已有的CA# 以下区分crt证书和PKCS#12格式的证书# crt 证书CA Path: certs/http_ca.crt # CA证书，这里相对路径是相对应 config 目录，也可以是绝对路径CA Key: certs/http_ca.key # CA密钥，这里相对路径是相对应 config 目录，也可以是绝对路径# PKCS#12格式的证书CA Path: certs/ca.p12 # CA证书，这里相对路径是相对应 config 目录，也可以是绝对路径Password for ca.p12: # CA密码，因为没有设置密码，所以这里直接回车For how long should your certificate be valid? [5y] 100y # 证书有效期，单位为年，默认是 5 年，这里设置为 100 年Generate a certificate per node? [y/N]n # 不为每个节点创建独立的证书，即所有节点都使用同一个证书Enter all the hostnames that you need, one per line.When you are done, press &lt;ENTER&gt; once more to move on to the next step.localhost # 主机名，这里可以添加多个，回车一行一个，这里应该填写集群内所有节点服务器的hostname，可以通过 hostname 命令查看ip-10-250-0-17.cn-northwest-1.compute.internalip-10-250-0-173.cn-northwest-1.compute.internalip-10-250-0-239.cn-northwest-1.compute.internalYou entered the following hostnames. - localhost - ip-10-250-0-17.cn-northwest-1.compute.internal - ip-10-250-0-173.cn-northwest-1.compute.internal - ip-10-250-0-239.cn-northwest-1.compute.internalIs this correct [Y/n]y # 确认主机名是否正确Enter all the IP addresses that you need, one per line.When you are done, press &lt;ENTER&gt; once more to move on to the next step.127.0.0.1 # 主机IP，这里可以添加多个，回车一行一个，这里应该填写集群内所有节点服务器的IP地址10.250.0.1710.250.0.17310.250.0.239You entered the following IP addresses. - 127.0.0.1 - 10.250.0.17 - 10.250.0.173 - 10.250.0.239Is this correct [Y/n]y # 确认IP是否正确Do you wish to change any of these options? [y/N]n # 不修改任何选项If you wish to use a blank password, simply press &lt;enter&gt; at the prompt below.Provide a password for the &quot;http.p12&quot; file: [&lt;ENTER&gt; for none] # 直接回车不设置密码What filename should be used for the output zip file? [/usr/local/elasticsearch/elasticsearch-8.17.3/elasticsearch-ssl-http.zip] # 输出文件名，这里可以自定义，默认是 elasticsearch-ssl-http.zipZip file written to /usr/local/elasticsearch/elasticsearch-8.17.3/elasticsearch-ssl-http.zip 解压并将http证书拷贝到config/certs目录下 12345678910111213$ unzip elasticsearch-ssl-http.zipArchive: elasticsearch-ssl-http.zip creating: elasticsearch/ inflating: elasticsearch/README.txt # 说明文件 inflating: elasticsearch/http.p12 # http证书 inflating: elasticsearch/sample-elasticsearch.yml # 示例elasticsearch配置文件 creating: kibana/ inflating: kibana/README.txt # 说明文件 inflating: kibana/elasticsearch-ca.pem # kibana用于验证ES的证书，即 elasticsearch.ssl.certificateAuthorities 中的配置 inflating: kibana/sample-kibana.yml # 示例kibana配置文件# 将http证书拷贝到config/certs目录下$ cp elasticsearch/http.p12 config/certs/http.p12 分发到ES集群中的每个节点 上面创建新的证书时我们只在一个节点上进行即可，之后将生成好的证书分发到ES集群中的其它节点，这里就是 http.p12 和 transport.p12，将其拷贝到每个节点的 config/certs 目录下，拷贝前做好原证书的备份。 如有必要也可以拷贝 ca.p12 或者 http_ca.crt 和 http_ca.key 到每个节点的 config/certs 目录下 重启ES服务 集群中的节点依次重启 1$ bin/elasticsearch -d 重启时可能会报错 12org.elasticsearch.ElasticsearchSecurityException: failed to load SSL configuration [xpack.security.transport.ssl] - cannot read configured [PKCS12] keystore (as a truststore) [/usr/local/elasticsearch/elasticsearch-8.17.3/config/certs/transport.p12] - this is usually caused by an incorrect password; (a keystore password was provided)# 虽然我们没有给transport.p12设置密码，但这里依旧提示提供的密码不正确，实际上这里使用的是 secure_password 解决方法 12345678910# 使用bin/elasticsearch-keystore list查看现有的密钥列表$ bin/elasticsearch-keystore listkeystore.seedxpack.security.http.ssl.keystore.secure_passwordxpack.security.transport.ssl.keystore.secure_passwordxpack.security.transport.ssl.truststore.secure_password# 删除secure_password后再次重启ES服务就会正常了$ bin/elasticsearch-keystore remove xpack.security.http.ssl.keystore.secure_password$ bin/elasticsearch-keystore remove xpack.security.transport.ssl.keystore.secure_password$ bin/elasticsearch-keystore remove xpack.security.transport.ssl.truststore.secure_password 替换Kibana的证书 将上面创建好的 kibana/elasticsearch-ca.pem 拷贝到Kibana服务器，比如 /usr/local/kibana/kibana-8.17.3/config/certs/elasticsearch-ca.pem 修改Kibana配置文件 config/kibana.yml 中的 elasticsearch.ssl.certificateAuthorities 配置，使其指向 /usr/local/kibana/kibana-8.17.3/config/certs/elasticsearch-ca.pem 1elasticsearch.ssl.certificateAuthorities: [&quot;/usr/local/kibana/kibana-8.17.3/config/certs/elasticsearch-ca.pem&quot;] 重启Kibana服务 证书格式转换 12345678# p12转换为crt格式$ openssl pkcs12 -in config/certs/ca.p12 -out config/certs/http_ca.crt -nokeys# p12转换为key格式$ openssl pkcs12 -in config/certs/ca.p12 -out config/certs/http_ca.key -nocerts -nodes# p12转换为pem格式$ openssl pkcs12 -in config/certs/ca.p12 -out config/certs/http_ca.pem -nodes# crt转换回PKCS12格式$ openssl pkcs12 -export -out config/certs/http_ca.p12 -inkey config/certs/http_ca.key -in config/certs/http_ca.crt -name &quot;My CA&quot; 生成http证书时为每个节点单独配置证书 12345678910111213141516171819202122232425262728293031323334353637383940414243Generate a certificate per node? [y/N]y # 是否为每个节点单独配置证书，这里选择是node #1 name: node-1 # 节点名称，必须与ES配置文件中的node.name一致Enter all the hostnames that you need, one per line. # 输入 node-1 节点的hostnameWhen you are done, press &lt;ENTER&gt; once more to move on to the next step.localhost # 习惯加上 localhostip-10-250-0-239.cn-northwest-1.compute.internal # node-1 的 hostnameYou entered the following hostnames. - localhost - ip-10-250-0-239.cn-northwest-1.compute.internalIs this correct [Y/n]y # 确认是否正确Enter all the IP addresses that you need, one per line. # 输入 node-1 节点的IP地址When you are done, press &lt;ENTER&gt; once more to move on to the next step.127.0.0.1 # 习惯加上 127.0.0.110.250.0.239 # node-1 的 IPYou entered the following IP addresses. - 127.0.0.1 - 10.250.0.239Is this correct [Y/n]y # 确认是否正确Do you wish to change any of these options? [y/N]n # 不修改任何选项Generate additional certificates? [Y/n]y # 是否生成其他证书，这里选择是，接着为其它节点创建证书node #2 name: node-2 # 节点名称，必须与ES配置文件中的node.name一致# 依次为每个节点创建证书………………Generate additional certificates? [Y/n]n # 创建好所有节点的证书后，选择n，不再创建新的证书If you wish to use a blank password, simply press &lt;enter&gt; at the prompt below.Provide a password for the &quot;http.p12&quot; file: [&lt;ENTER&gt; for none] # 直接回车不设置密码What filename should be used for the output zip file? [/usr/local/elasticsearch/elasticsearch-8.17.3/elasticsearch-ssl-http.zip] # 输出文件名，这里可以自定义，默认是 elasticsearch-ssl-http.zipZip file written to /usr/local/elasticsearch/elasticsearch-8.17.3/elasticsearch-ssl-http.zip 此时解压查看文件结构 12345678910111213141516171819unzip elasticsearch-ssl-http.zipArchive: elasticsearch-ssl-http.zip creating: elasticsearch/ creating: elasticsearch/node-1/ inflating: elasticsearch/node-1/README.txt inflating: elasticsearch/node-1/http.p12 # node-1 的证书 inflating: elasticsearch/node-1/sample-elasticsearch.yml creating: elasticsearch/node-2/ inflating: elasticsearch/node-2/README.txt inflating: elasticsearch/node-2/http.p12 # node-2 的证书 inflating: elasticsearch/node-2/sample-elasticsearch.yml creating: elasticsearch/node-3/ inflating: elasticsearch/node-3/README.txt inflating: elasticsearch/node-3/http.p12 # node-3 的证书 inflating: elasticsearch/node-3/sample-elasticsearch.yml creating: kibana/ inflating: kibana/README.txt inflating: kibana/elasticsearch-ca.pem # kibana 的证书 inflating: kibana/sample-kibana.yml 将对应的证书拷贝到对应节点的 config/certs 目录下","summary":"摘要 本文介绍Elasticsearch证书过期时的处理方法 Elasticsearch版本8.17.3 本文基于 linux下安装Elasticsearch 官方文档:Updating node security certificates","date_published":"2025-04-16T13:30:05.000Z","tags":["技术","elastic","elasticsearch","elasticsearch"]},{"id":"https://blog.hanqunfeng.com/2025/04/07/elk-02-springboot/","url":"https://blog.hanqunfeng.com/2025/04/07/elk-02-springboot/","title":"Springboot整合Logstash实现日志采集","content_html":"<!--\n **加粗**\n *斜体*\n ***加粗并斜体***\n ~~删除线~~\n ==突出显示==\n `突出显示(推荐)`\n ++下划线++\n ~下标~\n ^上标^\n 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.\n 图片设置宽度和高度(通过uPic上传后，需要将upic修改过为blog，用于添加水印) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)\n\n +++ **点击折叠**\n 这是被隐藏的内容\n +++\n\n::: tips success warning danger\n这里是容器内的内容\n:::\n\n% note info % success warning danger\n这里是容器内的内容\n% endnote %\n\n引用本地其它文章连接{}\n 大括号开始% post_link 文件名称(不包含.md) %大括号结束\n -->\n<h2 id=\"摘要\">摘要</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>本文介绍如何在Springboot项目中整合LogStash实现日志采集</p>\n</li>\n<li class=\"lvl-2\">\n<p>本文基于Springboot2.7.x版本进行测试，Logstash版本为8.17.3</p>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"使用logstash日志插件\">使用logstash日志插件</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><a href=\"https://github.com/logfellow/logstash-logback-encoder\">SpringBoot的Logstash日志插件</a>，本文只进行简单介绍，更多详细配置可以参考<a href=\"https://github.com/logfellow/logstash-logback-encoder\">官方文档</a></p>\n</li>\n<li class=\"lvl-2\">\n<p>引入依赖，这里需要注意8.x以上的版本需要jdk11，如果是jdk8的话可以使用6.x或7.x版本</p>\n</li>\n</ul>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>net.logstash.logback<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>logstash-logback-encoder<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>7.3<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span> <span class=\"comment\">&lt;!-- 版本号根据实际情况修改 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>注意：<br>\nspringboot2.7.x以下版本，建议使用logstash-logback-encoder的7.3以下版本。<br>\nspringboot3.x.x以上版本，建议使用logstash-logback-encoder的7.4及以上版本。</p>\n</blockquote>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>logback-spring.xml</code>中添加logstash配置</p>\n</li>\n</ul>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=<span class=\"string\">&quot;1.0&quot;</span> encoding=<span class=\"string\">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">configuration</span> <span class=\"attr\">debug</span>=<span class=\"string\">&quot;false&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- 控制台输出 --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">appender</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;STDOUT&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;ch.qos.logback.core.ConsoleAppender&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">encoder</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;ch.qos.logback.classic.encoder.PatternLayoutEncoder&quot;</span>&gt;</span></span><br><span class=\"line\">            <span class=\"comment\">&lt;!--格式化输出：%d表示日期，%thread表示线程名，%-5level：级别从左显示5个字符宽度 %logger&#123;50&#125;：类路径，最大显示50个字符 %M：方法名称 %L：行号 %msg：日志消息，%n是换行符--&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">pattern</span>&gt;</span>[%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125;] [%thread] %-5level [%X&#123;userName&#125;][%X&#123;userLocale&#125;] %logger&#123;50&#125; - %M - %L - %msg%n<span class=\"tag\">&lt;/<span class=\"name\">pattern</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">encoder</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">appender</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- logstash输出 --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">appender</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;LOGSTASH&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;net.logstash.logback.appender.LogstashTcpSocketAppender&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">destination</span>&gt;</span>161.189.78.202:4560<span class=\"tag\">&lt;/<span class=\"name\">destination</span>&gt;</span> <span class=\"comment\">&lt;!-- logstash地址和端口 --&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">encoder</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;net.logstash.logback.encoder.LogstashEncoder&quot;</span> &gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">timestampPattern</span>&gt;</span>yyyy-MM-dd&#x27;T&#x27;HH:mm:ss.SSS<span class=\"tag\">&lt;/<span class=\"name\">timestampPattern</span>&gt;</span> <span class=\"comment\">&lt;!-- 时间格式，这个是默认值 --&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">includeMdc</span>&gt;</span>true<span class=\"tag\">&lt;/<span class=\"name\">includeMdc</span>&gt;</span>   <span class=\"comment\">&lt;!-- 默认true, true表示输出MDC信息 --&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">includeCallerData</span>&gt;</span>true<span class=\"tag\">&lt;/<span class=\"name\">includeCallerData</span>&gt;</span> <span class=\"comment\">&lt;!-- 默认false, true表示输出打印日志的类名、方法名、行号等信息 --&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">customFields</span>&gt;</span>&#123;&quot;appname&quot;: &quot;springboot-logstash-demo&quot;&#125;<span class=\"tag\">&lt;/<span class=\"name\">customFields</span>&gt;</span> <span class=\"comment\">&lt;!-- 自定义字段 --&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">encoder</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">appender</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- 日志输出级别 --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">root</span> <span class=\"attr\">level</span>=<span class=\"string\">&quot;info&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">appender-ref</span> <span class=\"attr\">ref</span>=<span class=\"string\">&quot;STDOUT&quot;</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">appender-ref</span> <span class=\"attr\">ref</span>=<span class=\"string\">&quot;LOGSTASH&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">root</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>添加<code>config/springboot-demo.conf</code>配置</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">input &#123;</span><br><span class=\"line\">  tcp &#123;</span><br><span class=\"line\">    host =&gt; <span class=\"string\">&quot;0.0.0.0&quot;</span> <span class=\"comment\"># 监听任意地址</span></span><br><span class=\"line\">    port =&gt; <span class=\"string\">&quot;4560&quot;</span> <span class=\"comment\"># 监听端口</span></span><br><span class=\"line\">    mode =&gt; <span class=\"string\">&quot;server&quot;</span> <span class=\"comment\"># server模式</span></span><br><span class=\"line\">    codec =&gt; json_lines <span class=\"comment\"># 使用json_lines格式</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">output &#123;</span><br><span class=\"line\">  stdout &#123;</span><br><span class=\"line\">    codec =&gt; rubydebug</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  elasticsearch &#123; <span class=\"comment\"># 输出到ES</span></span><br><span class=\"line\">        index =&gt; <span class=\"string\">&quot;%&#123;[appname]&#125;-%&#123;+YYYY-MM-DD&#125;&quot;</span> <span class=\"comment\"># 索引名,按天分隔，这里使用变量appname作为索引名</span></span><br><span class=\"line\">        hosts =&gt; [<span class=\"string\">&quot;https://10.250.0.239:9200&quot;</span>] <span class=\"comment\"># ES地址</span></span><br><span class=\"line\">        user =&gt; <span class=\"string\">&quot;elastic&quot;</span>                   <span class=\"comment\"># ES用户名</span></span><br><span class=\"line\">        password =&gt; <span class=\"string\">&quot;123456&quot;</span>                <span class=\"comment\"># ES密码</span></span><br><span class=\"line\">        ssl =&gt; <span class=\"literal\">true</span>                         <span class=\"comment\"># 是否启用SSL，因为这里是https访问ES</span></span><br><span class=\"line\">        ssl_certificate_verification =&gt; <span class=\"literal\">false</span> <span class=\"comment\"># 禁用证书验证</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>启动logstash</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bin/logstash -f config/springboot-demo.conf --config.reload.automatic</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>logstash启动成功后，会输出类似如下信息</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;message&quot;</span> =&gt; <span class=\"string\">&quot;Tomcat started on port(s): 8088 (http) with context path &#x27;/springboot-logstash&#x27;&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;level_value&quot;</span> =&gt; 20000,</span><br><span class=\"line\">            <span class=\"string\">&quot;appname&quot;</span> =&gt; <span class=\"string\">&quot;springboot-logstash-demo&quot;</span>,</span><br><span class=\"line\">              <span class=\"string\">&quot;level&quot;</span> =&gt; <span class=\"string\">&quot;INFO&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;logger_name&quot;</span> =&gt; <span class=\"string\">&quot;org.springframework.boot.web.embedded.tomcat.TomcatWebServer&quot;</span>,</span><br><span class=\"line\">         <span class=\"string\">&quot;@timestamp&quot;</span> =&gt; 2025-04-07T09:39:43.569Z,</span><br><span class=\"line\">           <span class=\"string\">&quot;@version&quot;</span> =&gt; <span class=\"string\">&quot;1&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;thread_name&quot;</span> =&gt; <span class=\"string\">&quot;restartedMain&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;caller_class_name&quot;</span> =&gt; <span class=\"string\">&quot;org.springframework.boot.web.embedded.tomcat.TomcatWebServer&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;caller_file_name&quot;</span> =&gt; <span class=\"string\">&quot;TomcatWebServer.java&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;caller_method_name&quot;</span> =&gt; <span class=\"string\">&quot;start&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;caller_line_number&quot;</span> =&gt; 220,</span><br><span class=\"line\">        <span class=\"string\">&quot;userName&quot;</span> =&gt; <span class=\"string\">&quot;admin&quot;</span>, <span class=\"comment\"># MDC信息默认会打印</span></span><br><span class=\"line\">        <span class=\"string\">&quot;userLocale&quot;</span> =&gt; <span class=\"string\">&quot;zh_CN&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>可以访问ES或者Kibana查看索引信息，这里不再赘述。</p>\n</li>\n</ul>\n","content_text":"摘要 本文介绍如何在Springboot项目中整合LogStash实现日志采集 本文基于Springboot2.7.x版本进行测试，Logstash版本为8.17.3 使用logstash日志插件 SpringBoot的Logstash日志插件，本文只进行简单介绍，更多详细配置可以参考官方文档 引入依赖，这里需要注意8.x以上的版本需要jdk11，如果是jdk8的话可以使用6.x或7.x版本 12345&lt;dependency&gt; &lt;groupId&gt;net.logstash.logback&lt;/groupId&gt; &lt;artifactId&gt;logstash-logback-encoder&lt;/artifactId&gt; &lt;version&gt;7.3&lt;/version&gt; &lt;!-- 版本号根据实际情况修改 --&gt;&lt;/dependency&gt; 注意： springboot2.7.x以下版本，建议使用logstash-logback-encoder的7.3以下版本。 springboot3.x.x以上版本，建议使用logstash-logback-encoder的7.4及以上版本。 logback-spring.xml中添加logstash配置 123456789101112131415161718192021222324252627&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;configuration debug=&quot;false&quot;&gt; &lt;!-- 控制台输出 --&gt; &lt;appender name=&quot;STDOUT&quot; class=&quot;ch.qos.logback.core.ConsoleAppender&quot;&gt; &lt;encoder class=&quot;ch.qos.logback.classic.encoder.PatternLayoutEncoder&quot;&gt; &lt;!--格式化输出：%d表示日期，%thread表示线程名，%-5level：级别从左显示5个字符宽度 %logger&#123;50&#125;：类路径，最大显示50个字符 %M：方法名称 %L：行号 %msg：日志消息，%n是换行符--&gt; &lt;pattern&gt;[%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125;] [%thread] %-5level [%X&#123;userName&#125;][%X&#123;userLocale&#125;] %logger&#123;50&#125; - %M - %L - %msg%n&lt;/pattern&gt; &lt;/encoder&gt; &lt;/appender&gt; &lt;!-- logstash输出 --&gt; &lt;appender name=&quot;LOGSTASH&quot; class=&quot;net.logstash.logback.appender.LogstashTcpSocketAppender&quot;&gt; &lt;destination&gt;161.189.78.202:4560&lt;/destination&gt; &lt;!-- logstash地址和端口 --&gt; &lt;encoder class=&quot;net.logstash.logback.encoder.LogstashEncoder&quot; &gt; &lt;timestampPattern&gt;yyyy-MM-dd&#x27;T&#x27;HH:mm:ss.SSS&lt;/timestampPattern&gt; &lt;!-- 时间格式，这个是默认值 --&gt; &lt;includeMdc&gt;true&lt;/includeMdc&gt; &lt;!-- 默认true, true表示输出MDC信息 --&gt; &lt;includeCallerData&gt;true&lt;/includeCallerData&gt; &lt;!-- 默认false, true表示输出打印日志的类名、方法名、行号等信息 --&gt; &lt;customFields&gt;&#123;&quot;appname&quot;: &quot;springboot-logstash-demo&quot;&#125;&lt;/customFields&gt; &lt;!-- 自定义字段 --&gt; &lt;/encoder&gt; &lt;/appender&gt; &lt;!-- 日志输出级别 --&gt; &lt;root level=&quot;info&quot;&gt; &lt;appender-ref ref=&quot;STDOUT&quot;/&gt; &lt;appender-ref ref=&quot;LOGSTASH&quot;/&gt; &lt;/root&gt;&lt;/configuration&gt; 添加config/springboot-demo.conf配置 123456789101112131415161718192021input &#123; tcp &#123; host =&gt; &quot;0.0.0.0&quot; # 监听任意地址 port =&gt; &quot;4560&quot; # 监听端口 mode =&gt; &quot;server&quot; # server模式 codec =&gt; json_lines # 使用json_lines格式 &#125;&#125;output &#123; stdout &#123; codec =&gt; rubydebug &#125; elasticsearch &#123; # 输出到ES index =&gt; &quot;%&#123;[appname]&#125;-%&#123;+YYYY-MM-DD&#125;&quot; # 索引名,按天分隔，这里使用变量appname作为索引名 hosts =&gt; [&quot;https://10.250.0.239:9200&quot;] # ES地址 user =&gt; &quot;elastic&quot; # ES用户名 password =&gt; &quot;123456&quot; # ES密码 ssl =&gt; true # 是否启用SSL，因为这里是https访问ES ssl_certificate_verification =&gt; false # 禁用证书验证 &#125;&#125; 启动logstash 1bin/logstash -f config/springboot-demo.conf --config.reload.automatic logstash启动成功后，会输出类似如下信息 12345678910111213141516&#123; &quot;message&quot; =&gt; &quot;Tomcat started on port(s): 8088 (http) with context path &#x27;/springboot-logstash&#x27;&quot;, &quot;level_value&quot; =&gt; 20000, &quot;appname&quot; =&gt; &quot;springboot-logstash-demo&quot;, &quot;level&quot; =&gt; &quot;INFO&quot;, &quot;logger_name&quot; =&gt; &quot;org.springframework.boot.web.embedded.tomcat.TomcatWebServer&quot;, &quot;@timestamp&quot; =&gt; 2025-04-07T09:39:43.569Z, &quot;@version&quot; =&gt; &quot;1&quot;, &quot;thread_name&quot; =&gt; &quot;restartedMain&quot;, &quot;caller_class_name&quot; =&gt; &quot;org.springframework.boot.web.embedded.tomcat.TomcatWebServer&quot;, &quot;caller_file_name&quot; =&gt; &quot;TomcatWebServer.java&quot;, &quot;caller_method_name&quot; =&gt; &quot;start&quot;, &quot;caller_line_number&quot; =&gt; 220, &quot;userName&quot; =&gt; &quot;admin&quot;, # MDC信息默认会打印 &quot;userLocale&quot; =&gt; &quot;zh_CN&quot;&#125; 可以访问ES或者Kibana查看索引信息，这里不再赘述。","summary":"摘要 本文介绍如何在Springboot项目中整合LogStash实现日志采集 本文基于Springboot2.7.x版本进行测试，Logstash版本为8.17.3","date_published":"2025-04-07T13:30:05.000Z","tags":["技术","springboot","logstash","springboot","logstash"]},{"id":"https://blog.hanqunfeng.com/2025/03/27/elk-01/","url":"https://blog.hanqunfeng.com/2025/03/27/elk-01/","title":"一文搞懂ELK","content_html":"<!--\n **加粗**\n *斜体*\n ***加粗并斜体***\n ~~删除线~~\n ==突出显示==\n `突出显示(推荐)`\n ++下划线++\n ~下标~\n ^上标^\n 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.\n 图片设置宽度和高度(通过uPic上传后，需要将upic修改过为blog，用于添加水印) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)\n\n +++ **点击折叠**\n 这是被隐藏的内容\n +++\n\n::: tips success warning danger\n这里是容器内的内容\n:::\n\n% note info % success warning danger\n这里是容器内的内容\n% endnote %\n\n引用本地其它文章连接{}\n 大括号开始% post_link 文件名称(不包含.md) %大括号结束\n -->\n<h2 id=\"摘要\">摘要</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>本文介绍如何在linux下安装LogStash和FileBeat</p>\n</li>\n<li class=\"lvl-2\">\n<p>通过示例讲解ELK的经典架构和高并发架构的实现过程</p>\n</li>\n<li class=\"lvl-2\">\n<p>LogStash版本8.17.3，FileBeat版本8.17.3</p>\n</li>\n<li class=\"lvl-2\">\n<p>Elasticsearch版本8.17.3，<a href=\"/2025/03/20/elasticsearch-01-install/\" title=\"linux下安装Elasticsearch\">linux下安装Elasticsearch</a></p>\n</li>\n<li class=\"lvl-2\">\n<p>Kibana版本8.17.3，<a href=\"/2025/03/21/kibana-01-install/\" title=\"linux下安装Kibana\">linux下安装Kibana</a></p>\n</li>\n<li class=\"lvl-2\">\n<p>Elasticsearch集群搭建，<a href=\"/2025/03/24/elasticsearch-02-install-cluster/\" title=\"linux下安装Elasticsearch集群\">linux下安装Elasticsearch集群</a></p>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"Logstash概述\">Logstash概述</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><a href=\"https://www.elastic.co/cn/logstash\">Logstash</a> 是免费且开放的服务器端数据处理管道，能够从多个来源采集数据，转换数据，然后将数据发送到您最喜欢的存储库中。</p>\n</li>\n<li class=\"lvl-2\">\n<p>Logstash数据传输原理<br>\n<img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/image-2.png\" alt=\"\"></p>\n</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.数据采集与输入：Logstash支持各种输入选择，能够以连续的流式传输方式，轻松地从日志、指标、Web应用以及数据存储中采集数据。</span><br><span class=\"line\">2.实时解析和数据转换：通过Logstash过滤器解析各个事件，识别已命名的字段来构建结构，并将它们转换成通用格式，最终将数据从源端传输到存储库中。</span><br><span class=\"line\">3.存储与数据导出：Logstash提供多种输出选择，可以将数据发送到指定的地方。</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/%E6%88%AA%E5%9B%BE-3.png\" alt=\"\"></p>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Logstash通过管道完成数据的采集与处理，管道配置中包含input、output和filter（可选）插件，input和output用来配置输入和输出数据源、filter用来对数据进行过滤或预处理。</p>\n</li>\n</ul>\n<h2 id=\"Logstash下载安装\">Logstash下载安装</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>下载地址：<a href=\"https://www.elastic.co/cn/downloads/past-releases#logstash\">https://www.elastic.co/cn/downloads/past-releases#logstash</a></p>\n</li>\n<li class=\"lvl-2\">\n<p>选择对应的版本：这里选择当前的最新版<code>LogStash 8.17.3</code>，之后选择对应的操作系统<code>LINUX X86_64</code></p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget https://artifacts.elastic.co/downloads/logstash/logstash-8.17.3-linux-x86_64.tar.gz</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>下载完成后解压到<code>/usr/local/logstash</code>目录下，解压命令如下：</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">mkdir</span> /usr/local/logstash</span><br><span class=\"line\">tar -zxvf logstash-8.17.3-linux-x86_64.tar.gz -C /usr/local/logstash</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>elasticsearch和kibana都不能用root用户启动，为了统一管理，logstash也使用这个用户（非必要）</p>\n</li>\n<li class=\"lvl-2\">\n<p>创建用户<code>elastic</code>，并设置密码，这一步我们在安装elasticsearch的时候已经配置过了，这里就不再赘述了</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">useradd elastic</span><br><span class=\"line\">passwd elastic</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>修改logstash安装目录的用户权限</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">chown</span> -R elastic:elastic /usr/local/logstash</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>切换到elastic用户下执行命令</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 切换用户</span></span><br><span class=\"line\">su - elastic</span><br><span class=\"line\"><span class=\"comment\"># 进入logstash安装目录</span></span><br><span class=\"line\"><span class=\"built_in\">cd</span> /usr/local/logstash/logstash-8.17.3/</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>运行一个简单的测试</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># -e: 直接把配置放在命令中，这样可以有效快速进行测试</span></span><br><span class=\"line\"><span class=\"comment\"># input &#123; stdin &#123; &#125; &#125;: 输入插件，从标准输入中读取数据</span></span><br><span class=\"line\"><span class=\"comment\"># output &#123; stdout &#123;&#125; &#125;: 输出插件，将数据输出到标准输出</span></span><br><span class=\"line\"><span class=\"comment\"># 这里只包含了 input 和 output 两个部分，实际使用中还需要添加 filter 部分</span></span><br><span class=\"line\">./bin/logstash -e <span class=\"string\">&#x27;input &#123; stdin &#123; &#125; &#125; output &#123; stdout &#123;&#125; &#125;&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># 输出：</span></span><br><span class=\"line\">。。。。。。。 <span class=\"comment\"># 输出启动信息</span></span><br><span class=\"line\">The stdin plugin is now waiting <span class=\"keyword\">for</span> input: <span class=\"comment\"># 输出提示信息，提示你输入内容</span></span><br><span class=\"line\">hello world  <span class=\"comment\"># 我输入内容</span></span><br><span class=\"line\"><span class=\"comment\"># logstash输出内容</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">       <span class=\"string\">&quot;message&quot;</span> =&gt; <span class=\"string\">&quot;hello world&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;@version&quot;</span> =&gt; <span class=\"string\">&quot;1&quot;</span>,</span><br><span class=\"line\">         <span class=\"string\">&quot;event&quot;</span> =&gt; &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;original&quot;</span> =&gt; <span class=\"string\">&quot;hello world&quot;</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">          <span class=\"string\">&quot;host&quot;</span> =&gt; &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;hostname&quot;</span> =&gt; <span class=\"string\">&quot;ip-10-250-0-239.cn-northwest-1.compute.internal&quot;</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">&quot;@timestamp&quot;</span> =&gt; 2025-03-27T06:48:12.810617855Z</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>也可以通过配置文件启动logstash</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># vim test.conf</span></span><br><span class=\"line\">input &#123;</span><br><span class=\"line\">  stdin &#123; &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">output &#123;</span><br><span class=\"line\">  stdout &#123; codec =&gt; rubydebug &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># codec =&gt; rubydebug : 是指定了一个编码器（Codec）为 rubydebug。</span></span><br><span class=\"line\"><span class=\"comment\"># 编码器负责如何格式化输出的数据。</span></span><br><span class=\"line\"><span class=\"comment\"># Rubydebug 编码器是一种特别适合开发和调试目的的编码器，因为它能以相当易读的形式展示复杂的结构化数据，比如嵌套的哈希表或者数组。</span></span><br><span class=\"line\"><span class=\"comment\"># 除了 Rubydebug 编码器，Logstash 还提供了其他几种编码器，比如 json、plain、multiline 等等。</span></span><br><span class=\"line\"><span class=\"comment\"># 具体可以参考官方文档：https://www.elastic.co/guide/en/logstash/current/codec-plugins.html</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./bin/logstash -f ./test.conf</span><br></pre></td></tr></table></figure>\n<h2 id=\"Logstash插件\">Logstash插件</h2>\n<h3 id=\"Input-Plugins\">Input Plugins</h3>\n<blockquote>\n<p><a href=\"https://www.elastic.co/guide/en/logstash/8.17/input-plugins.html\">https://www.elastic.co/guide/en/logstash/8.17/input-plugins.html</a></p>\n</blockquote>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>一个 Pipeline可以有多个input插件</p>\n</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- Stdin / File</span><br><span class=\"line\">- Beats / Log4J /Elasticsearch / JDBC / Kafka /Rabbitmq /Redis</span><br><span class=\"line\">- JMX/ HTTP / Websocket / UDP / TCP</span><br><span class=\"line\">- Google Cloud Storage / S3</span><br><span class=\"line\">- Github / Twitter</span><br></pre></td></tr></table></figure>\n<h3 id=\"Filter-Plugins\">Filter Plugins</h3>\n<blockquote>\n<p><a href=\"https://www.elastic.co/guide/en/logstash/8.17/filter-plugins.html\">https://www.elastic.co/guide/en/logstash/8.17/filter-plugins.html</a></p>\n</blockquote>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Filter Plugin可以对Logstash Event进行各种处理，例如解析，删除字段，类型转换</p>\n</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- Date: 日期解析</span><br><span class=\"line\">- Dissect: 分割符解析</span><br><span class=\"line\">- Grok: 正则匹配解析</span><br><span class=\"line\">- Mutate: 对字段做各种操作</span><br><span class=\"line\">- Convert : 类型转换</span><br><span class=\"line\">- Gsub : 字符串替换</span><br><span class=\"line\">- Split / Join /Merge:  字符串切割，数组合并字符串，数组合并数组</span><br><span class=\"line\">- Rename: 字段重命名</span><br><span class=\"line\">- Update / Replace: 字段内容更新替换</span><br><span class=\"line\">- Remove_field: 字段删除</span><br><span class=\"line\">- Ruby: 利用Ruby 代码来动态修改Event</span><br></pre></td></tr></table></figure>\n<h3 id=\"Output-Plugins\">Output Plugins</h3>\n<blockquote>\n<p><a href=\"https://www.elastic.co/guide/en/logstash/8.17/output-plugins.html\">https://www.elastic.co/guide/en/logstash/8.17/output-plugins.html</a></p>\n</blockquote>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>将Event发送到特定的目的地，是 Pipeline 的最后一个阶段。常见 Output Plugins：</p>\n</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- Elasticsearch</span><br><span class=\"line\">- Email / Pageduty</span><br><span class=\"line\">- Influxdb / Kafka / Mongodb / Opentsdb / Zabbix</span><br><span class=\"line\">- Http / TCP / Websocket</span><br></pre></td></tr></table></figure>\n<h3 id=\"Codec-Plugins\">Codec Plugins</h3>\n<blockquote>\n<p><a href=\"https://www.elastic.co/guide/en/logstash/8.17/codec-plugins.html\">https://www.elastic.co/guide/en/logstash/8.17/codec-plugins.html</a></p>\n</blockquote>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>将原始数据decode成Event;将Event encode成目标数据，内置的Codec Plugins:</p>\n</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- Line / Multiline</span><br><span class=\"line\">- JSON / Avro / Cef (ArcSight Common Event Format)</span><br><span class=\"line\">- Dots / Rubydebug</span><br></pre></td></tr></table></figure>\n<h2 id=\"FileBeat概述\">FileBeat概述</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><a href=\"https://www.elastic.co/cn/beats\">Beats</a> 是一个免费且开放的平台，集合了多种单一用途的数据采集器。它们从成百上千或成千上万台机器和系统向 Logstash 或 Elasticsearch 发送数据。<br>\n<img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/iEmI1C.png\" alt=\"\"></p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://www.elastic.co/cn/beats/filebeat\">FileBeat</a> 专门用于转发和收集日志数据的轻量级采集工具。它可以作为代理安装在服务器上，FileBeat监视指定路径的日志文件，收集日志数据，并将收集到的日志转发到Elasticsearch或者Logstash。</p>\n</li>\n</ul>\n<h2 id=\"logstash-vs-FileBeat\">logstash vs FileBeat</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Logstash是在jvm上运行的，资源消耗比较大。而FileBeat是基于golang编写的，功能较少但资源消耗也比较小，更轻量级。</p>\n</li>\n<li class=\"lvl-2\">\n<p>Logstash 和Filebeat都具有日志收集功能，Filebeat更轻量，占用资源更少</p>\n</li>\n<li class=\"lvl-2\">\n<p>Logstash 具有Filter功能，能过滤分析日志</p>\n</li>\n<li class=\"lvl-2\">\n<p>一般结构都是Filebeat采集日志，然后发送到消息队列、Redis、MQ中，然后Logstash去获取，利用Filter功能过滤分析，然后存储到Elasticsearch中</p>\n</li>\n<li class=\"lvl-2\">\n<p>FileBeat和Logstash配合，实现背压机制。当将数据发送到Logstash或 Elasticsearch时，Filebeat使用背压敏感协议，以应对更多的数据量。如果Logstash正在忙于处理数据，则会告诉Filebeat 减慢读取速度。一旦拥堵得到解决，Filebeat就会恢复到原来的步伐并继续传输数据。</p>\n</li>\n</ul>\n<h2 id=\"FileBeat下载和安装\">FileBeat下载和安装</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>下载地址：<a href=\"https://www.elastic.co/cn/downloads/past-releases#filebeat\">https://www.elastic.co/cn/downloads/past-releases#filebeat</a></p>\n</li>\n<li class=\"lvl-2\">\n<p>选择对应的版本：这里选择当前的最新版<code>FileBeat 8.17.3</code>，之后选择对应的操作系统<code>LINUX X86_64</code></p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-8.17.3-linux-x86_64.tar.gz</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>下载完成后解压到<code>/usr/local/filebeat</code>目录下，解压命令如下：</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">mkdir</span> /usr/local/filebeat</span><br><span class=\"line\">tar -zxvf filebeat-8.17.3-linux-x86_64.tar.gz -C /usr/local/filebeat</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>修改logstash安装目录的用户权限</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">chown</span> -R elastic:elastic /usr/local/filebeat</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>切换到elastic用户下执行命令</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 切换用户</span></span><br><span class=\"line\">su - elastic</span><br><span class=\"line\"><span class=\"comment\"># 进入 filebeat 安装目录</span></span><br><span class=\"line\"><span class=\"built_in\">cd</span> /usr/local/filebeat/filebeat-8.17.3-linux-x86_64/</span><br></pre></td></tr></table></figure>\n<h2 id=\"经典的ELK架构\">经典的ELK架构</h2>\n<p><img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/%E6%88%AA%E5%9B%BE.png\" alt=\"\"></p>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Filebeat日志收集：Filebeat作为轻量级的日志收集代理，部署在客户端上，消耗资源少，能够高效地收集日志数据。</p>\n</li>\n<li class=\"lvl-2\">\n<p>Logstash数据处理：Logstash作为数据处理管道，负责将Filebeat收集的日志数据进行过滤、转换等操作，然后发送到Elasticsearch进行存储。</p>\n</li>\n<li class=\"lvl-2\">\n<p>Elasticsearch存储与搜索：Elasticsearch是一个基于Lucene的分布式搜索和分析引擎，提供强大的数据存储和搜索能力。</p>\n</li>\n<li class=\"lvl-2\">\n<p>Kibana可视化：Kibana为Elasticsearch提供Web可视化界面，允许用户通过图表、仪表盘等方式直观地查看和分析日志数据。</p>\n</li>\n<li class=\"lvl-2\">\n<p>适用场景：经典的ELK架构主要适用于数据量较小的开发环境。然而，由于缺少消息队列的缓冲机制，当Logstash或Elasticsearch出现故障时，可能存在数据丢失的风险。</p>\n</li>\n</ul>\n<h2 id=\"一个经典ELK架构示例\">一个经典ELK架构示例</h2>\n<h3 id=\"FileBeat采集Nginx服务器日志并发送到Logstash\">FileBeat采集Nginx服务器日志并发送到Logstash</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>创建配置文件<code>filebeat-nginx.yml</code>，将其保存到Filebeat安装目录下的conf目录下。</p>\n</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 因为Nginx的access.log日志都是以IP地址开头的，所以我们需要修改下匹配字段。</span></span><br><span class=\"line\"><span class=\"comment\"># 不以ip地址开头的行追加到上一行</span></span><br><span class=\"line\"><span class=\"attr\">filebeat.inputs:</span> <span class=\"comment\"># 输入源配置</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">type:</span> <span class=\"string\">log</span> <span class=\"comment\"># 日志类型</span></span><br><span class=\"line\">  <span class=\"attr\">enabled:</span> <span class=\"literal\">true</span> <span class=\"comment\"># 是否启用</span></span><br><span class=\"line\">  <span class=\"attr\">paths:</span> <span class=\"comment\"># 采集路径</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">/var/log/nginx/access*.*</span></span><br><span class=\"line\">  <span class=\"attr\">exclude_files:</span> [<span class=\"string\">&quot;.gz$&quot;</span>] <span class=\"comment\"># 排除以.gz 结尾的文件</span></span><br><span class=\"line\">  <span class=\"attr\">multiline.pattern:</span> <span class=\"string\">&#x27;^\\\\d&#123;1,3&#125;\\\\.\\\\d&#123;1,3&#125;\\\\.\\\\d&#123;1,3&#125;\\\\.\\\\d&#123;1,3&#125;\\\\s&#x27;</span> <span class=\"comment\"># 匹配以IP地址开头，并紧跟一个空白字符</span></span><br><span class=\"line\">  <span class=\"attr\">multiline.negate:</span> <span class=\"literal\">true</span> <span class=\"comment\"># 不以ip地址开头的行追加到上一行</span></span><br><span class=\"line\">  <span class=\"attr\">multiline.match:</span> <span class=\"string\">after</span> <span class=\"comment\"># 追加到上一行的后面</span></span><br><span class=\"line\">  <span class=\"comment\"># multiline: 多行日志配置，这里实际上不需要配置多行设置，因为nginx的access日志都是单行日志，这里只做演示</span></span><br><span class=\"line\">    <span class=\"comment\"># pattern: 正则表达式</span></span><br><span class=\"line\">    <span class=\"comment\"># negate: false，匹配pattern的行合并到上一行；true，不匹配pattern的行合并到上一行</span></span><br><span class=\"line\">    <span class=\"comment\"># match: after，合并到上一行的末尾；before，合并到上一行的开头</span></span><br><span class=\"line\">  <span class=\"attr\">scan_frequency:</span> <span class=\"string\">10s</span> <span class=\"comment\"># 每 10 秒扫描一次日志文件</span></span><br><span class=\"line\">  <span class=\"attr\">clean_removed:</span> <span class=\"literal\">true</span> <span class=\"comment\"># 在日志文件被删除后是否从其内部状态中移除该文件的记录</span></span><br><span class=\"line\">  <span class=\"attr\">clean_inactive:</span> <span class=\"string\">2h</span> <span class=\"comment\"># 在日志文件处于非活动状态多长时间后将其从状态数据库中移,设置为比 ignore_older + scan_frequency 更大的值</span></span><br><span class=\"line\">  <span class=\"attr\">ignore_older:</span> <span class=\"string\">1h</span> <span class=\"comment\"># 忽略那些比当前时间早于 1 小时的日志文件</span></span><br><span class=\"line\"><span class=\"attr\">output.logstash:</span> <span class=\"comment\"># 输出配置，这里是发送到Logstash</span></span><br><span class=\"line\">  <span class=\"attr\">enabled:</span> <span class=\"literal\">true</span> <span class=\"comment\"># 是否启用</span></span><br><span class=\"line\">  <span class=\"attr\">hosts:</span> [<span class=\"string\">&quot;10.250.0.239:5044&quot;</span>] <span class=\"comment\"># Logstash服务地址</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>为FileBeat的用户分配日志目录的读取权限</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 使用 setfacl命令为elastic用户分配日志目录的读取权限</span></span><br><span class=\"line\"><span class=\"built_in\">sudo</span> setfacl -d -m u:elastic:r-x -R /var/log/nginx/</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>启动FileBeat</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./filebeat -e -c conf/filebeat-nginx.yml</span><br><span class=\"line\"><span class=\"comment\"># 后台启动</span></span><br><span class=\"line\"><span class=\"built_in\">nohup</span> ./filebeat -e -c conf/filebeat-nginx.yml &amp;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>在启动filebeat时可能会遇到如下错误</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Exiting: error loading config file: config file (<span class=\"string\">&quot;conf/filebeat-nginx.yml&quot;</span>) can only be writable by the owner but the permissions are <span class=\"string\">&quot;-rw-rw-r--&quot;</span> (to fix the permissions use: <span class=\"string\">&#x27;chmod go-w /usr/local/filebeat/filebeat-8.17.3-linux-x86_64/conf/filebeat-nginx.yml&#x27;</span>)</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-4\">\n<p>因为安全原因不要其他用户写的权限，去掉写的权限就可以了</p>\n</li>\n</ul>\n  <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">chmod</span> go-w conf/filebeat-nginx.yml</span><br></pre></td></tr></table></figure>\n<h3 id=\"配置Logstash接收FileBeat收集的数据并打印\">配置Logstash接收FileBeat收集的数据并打印</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>创建配置文件<code>logstash-nginx.conf</code>，将其保存到Logstash安装目录下的config目录下。</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 进入logstash安装目录</span></span><br><span class=\"line\"><span class=\"comment\"># vim config/logstash-nginx.conf</span></span><br><span class=\"line\"><span class=\"comment\"># 配置从FileBeat接收数据</span></span><br><span class=\"line\">input &#123; <span class=\"comment\"># 输入源配置</span></span><br><span class=\"line\">    beats &#123; <span class=\"comment\"># 从FileBeat接收数据</span></span><br><span class=\"line\">      port =&gt; 5044 <span class=\"comment\"># 监听5044端口</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">output &#123; <span class=\"comment\"># 输出配置</span></span><br><span class=\"line\">    stdout &#123; <span class=\"comment\"># 打印到控制台</span></span><br><span class=\"line\">      codec =&gt; rubydebug <span class=\"comment\"># 指定编码器</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>测试logstash配置是否正确</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bin/logstash -f config/logstash-nginx.conf --config.test_and_exit</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>启动logstash</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># reload.automatic：修改配置文件时自动重新加载</span></span><br><span class=\"line\">bin/logstash -f config/logstash-nginx.conf --config.reload.automatic</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 此时在控制台会看到如下输出：</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">         <span class=\"string\">&quot;input&quot;</span> =&gt; &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;type&quot;</span> =&gt; <span class=\"string\">&quot;log&quot;</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">      <span class=\"string\">&quot;@version&quot;</span> =&gt; <span class=\"string\">&quot;1&quot;</span>,</span><br><span class=\"line\">       <span class=\"string\">&quot;message&quot;</span> =&gt; <span class=\"string\">&quot;1.119.161.30 - elastic [27/Mar/2025:08:52:41 +0000] \\&quot;GET /_cluster/stats HTTP/1.1\\&quot; 200 7445 \\&quot;-\\&quot; \\&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/134.0.0.0 Safari/537.36\\&quot; \\&quot;-\\&quot;&quot;</span>,</span><br><span class=\"line\">           <span class=\"string\">&quot;log&quot;</span> =&gt; &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;file&quot;</span> =&gt; &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;path&quot;</span> =&gt; <span class=\"string\">&quot;/var/log/nginx/access.log&quot;</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;offset&quot;</span> =&gt; 42985</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">          <span class=\"string\">&quot;tags&quot;</span> =&gt; [</span><br><span class=\"line\">        [0] <span class=\"string\">&quot;beats_input_codec_plain_applied&quot;</span></span><br><span class=\"line\">    ],</span><br><span class=\"line\">    <span class=\"string\">&quot;@timestamp&quot;</span> =&gt; 2025-03-27T08:52:42.947Z,</span><br><span class=\"line\">           <span class=\"string\">&quot;ecs&quot;</span> =&gt; &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;version&quot;</span> =&gt; <span class=\"string\">&quot;8.0.0&quot;</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">         <span class=\"string\">&quot;agent&quot;</span> =&gt; &#123;</span><br><span class=\"line\">                  <span class=\"string\">&quot;id&quot;</span> =&gt; <span class=\"string\">&quot;4dbe185b-900d-4990-b841-c13bf9618fc6&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;name&quot;</span> =&gt; <span class=\"string\">&quot;ip-10-250-0-239.cn-northwest-1.compute.internal&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;ephemeral_id&quot;</span> =&gt; <span class=\"string\">&quot;6bb04808-7da7-4acb-95fd-f3f915651457&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;type&quot;</span> =&gt; <span class=\"string\">&quot;filebeat&quot;</span>,</span><br><span class=\"line\">             <span class=\"string\">&quot;version&quot;</span> =&gt; <span class=\"string\">&quot;8.17.3&quot;</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">         <span class=\"string\">&quot;event&quot;</span> =&gt; &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;original&quot;</span> =&gt; <span class=\"string\">&quot;1.119.161.30 - elastic [27/Mar/2025:08:52:41 +0000] \\&quot;GET /_cluster/stats HTTP/1.1\\&quot; 200 7445 \\&quot;-\\&quot; \\&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/134.0.0.0 Safari/537.36\\&quot; \\&quot;-\\&quot;&quot;</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">          <span class=\"string\">&quot;host&quot;</span> =&gt; &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;name&quot;</span> =&gt; <span class=\"string\">&quot;ip-10-250-0-239.cn-northwest-1.compute.internal&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"利用Logstash过滤器解析日志\">利用Logstash过滤器解析日志</h4>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>从打印结果看到包含了大量的无关数据，此时可以利用Logstash过滤器解析日志，这里使用<code>Grok</code>插件</p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://www.elastic.co/guide/en/logstash/8.17/plugins-filters-grok.html\">Grok</a>是一种将非结构化日志解析为结构化的插件。这个工具非常适合用来解析系统日志、Web服务器日志、MySQL或者是任意其他的日志格式。</p>\n</li>\n<li class=\"lvl-2\">\n<p>Grok是通过模式匹配的方式来识别日志中的数据,可以把Grok插件简单理解为升级版本的正则表达式。它拥有更多的模式，默认Logstash拥有120个模式。如果这些模式不满足我们解析日志的需求，我们可以直接使用正则表达式来进行匹配。</p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://help.aliyun.com/zh/sls/user-guide/grok-patterns\">GROK模式参考</a></p>\n</li>\n<li class=\"lvl-2\">\n<p>grok模式的语法是:</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">%&#123;SYNTAX:SEMANTIC&#125;</span><br><span class=\"line\"><span class=\"comment\"># SYNTAX（语法）指的是Grok模式名称，SEMANTIC（语义）是给模式匹配到的文本字段名。例如：</span></span><br><span class=\"line\">%&#123;NUMBER:duration&#125; %&#123;IP:client&#125;</span><br><span class=\"line\"><span class=\"comment\"># duration表示：匹配一个数字，client表示匹配一个IP地址。</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>匹配nginx日志</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># nginx access日志格式</span></span><br><span class=\"line\">1.119.161.30 - elastic [27/Mar/2025:03:05:36 +0000] <span class=\"string\">&quot;GET /_cluster/stats HTTP/1.1&quot;</span> 200 7446 <span class=\"string\">&quot;-&quot;</span> <span class=\"string\">&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/134.0.0.0 Safari/537.36&quot;</span> <span class=\"string\">&quot;-&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># grok</span></span><br><span class=\"line\">%&#123;IP:client_ip&#125; - %&#123;USER:remote_user&#125; \\[%&#123;HTTPDATE:timestamp&#125;\\] \\&quot;%&#123;WORD:verb&#125; %&#123;URIPATHPARAM:request&#125; HTTP/%&#123;NUMBER:httpversion&#125;\\&quot; %&#123;INT:http_status&#125; %&#123;INT:body_bytes_sent&#125; \\&quot;%&#123;NOTSPACE:referrer&#125;\\&quot; \\&quot;%&#123;GREEDYDATA:agent&#125;\\&quot; %&#123;QUOTEDSTRING:x_forwarded_for&#125;</span><br><span class=\"line\"><span class=\"comment\"># 解释每个部分的作用：</span></span><br><span class=\"line\"><span class=\"comment\"># %&#123;IP:client_ip&#125;：匹配客户端 IP 地址。</span></span><br><span class=\"line\"><span class=\"comment\"># -：匹配一个破折号（-），表示匿名用户或未认证用户。</span></span><br><span class=\"line\"><span class=\"comment\"># %&#123;USER:remote_user&#125;：匹配远程用户名， - 表示匿名用户。</span></span><br><span class=\"line\"><span class=\"comment\"># \\[%&#123;HTTPDATE:timestamp&#125;\\]：匹配请求的时间戳，格式为 [27/Mar/2025:03:05:36 +0000]。</span></span><br><span class=\"line\"><span class=\"comment\"># \\&quot;%&#123;WORD:verb&#125; : 匹配请求方法 (GET)</span></span><br><span class=\"line\"><span class=\"comment\"># %&#123;URIPATHPARAM:request&#125; : 匹配请求路径 (/_cluster/stats)</span></span><br><span class=\"line\"><span class=\"comment\"># HTTP/%&#123;NUMBER:httpversion&#125;\\\\\\&quot;：匹配 HTTP 版本 (HTTP/1.1)。</span></span><br><span class=\"line\"><span class=\"comment\"># %&#123;INT:http_status&#125;：匹配 HTTP 响应状态码 (200)。</span></span><br><span class=\"line\"><span class=\"comment\"># %&#123;INT:body_bytes_sent&#125;：匹配响应体的字节数 (7446)。</span></span><br><span class=\"line\"><span class=\"comment\"># \\&quot;%&#123;NOTSPACE:referrer&#125;\\&quot;：匹配引用页 (Referer) 字段，这里为空 (&quot;-&quot;)。</span></span><br><span class=\"line\"><span class=\"comment\"># \\&quot;%&#123;GREEDYDATA:agent&#125;\\&quot;：匹配用户代理 (User-Agent) 字段。GREEDYDATA 会匹配尽可能多的数据，直到遇到下一个分隔符。</span></span><br><span class=\"line\"><span class=\"comment\"># %&#123;QUOTEDSTRING:x_forwarded_for&#125;：匹配 X-Forwarded-For 头字段，这里为空 (&quot;-&quot;)。</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 匹配结果</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;request&quot;</span>: <span class=\"string\">&quot;/_cluster/stats&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;agent&quot;</span>: <span class=\"string\">&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/134.0.0.0 Safari/537.36&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;body_bytes_sent&quot;</span>: <span class=\"string\">&quot;7446&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;verb&quot;</span>: <span class=\"string\">&quot;GET&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;x_forwarded_for&quot;</span>: <span class=\"string\">&quot;\\&quot;-\\&quot;&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;remote_user&quot;</span>: <span class=\"string\">&quot;elastic&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;referrer&quot;</span>: <span class=\"string\">&quot;-&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;client_ip&quot;</span>: <span class=\"string\">&quot;1.119.161.30&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;httpversion&quot;</span>: <span class=\"string\">&quot;1.1&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;http_status&quot;</span>: <span class=\"string\">&quot;200&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;timestamp&quot;</span>: <span class=\"string\">&quot;27/Mar/2025:03:05:36 +0000&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>匹配Grok模式是个非常繁琐的过程，我们可以使用Kibana来进行可视化的Grok调试<br>\n<img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/nhgnKY.png\" alt=\"\"></p>\n</li>\n<li class=\"lvl-2\">\n<p>grok配置</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">grok &#123;</span><br><span class=\"line\">    match =&gt; &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;message&quot;</span> =&gt; <span class=\"string\">&quot;%&#123;IP:client_ip&#125; - %&#123;USER:remote_user&#125; \\[%&#123;HTTPDATE:timestamp&#125;\\] \\&quot;%&#123;WORD:verb&#125; %&#123;URIPATHPARAM:request&#125; HTTP/%&#123;NUMBER:httpversion&#125;\\&quot; %&#123;INT:http_status&#125; %&#123;INT:body_bytes_sent&#125; \\&quot;%&#123;NOTSPACE:referrer&#125;\\&quot; \\&quot;%&#123;GREEDYDATA:agent&#125;\\&quot; %&#123;QUOTEDSTRING:x_forwarded_for&#125;&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"使用mutate插件过滤掉不需要的字段\">使用mutate插件过滤掉不需要的字段</h4>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>除了nginx日志本身的格式外，logstash还会打印许多我们不需要的字段，此时可以使用<code>mutate</code>插件来过滤掉不需要的字段。</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mutate &#123;</span><br><span class=\"line\">    enable_metric =&gt; <span class=\"string\">&quot;false&quot;</span> <span class=\"comment\"># 禁用指标上报</span></span><br><span class=\"line\">    remove_field =&gt; [<span class=\"string\">&quot;message&quot;</span>, <span class=\"string\">&quot;log&quot;</span>, <span class=\"string\">&quot;tags&quot;</span>, <span class=\"string\">&quot;input&quot;</span>, <span class=\"string\">&quot;agent&quot;</span>, <span class=\"string\">&quot;host&quot;</span>, <span class=\"string\">&quot;ecs&quot;</span>, <span class=\"string\">&quot;@version&quot;</span>] <span class=\"comment\"># 移除不需要的字段</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"使用Date插件对时间进行格式转换\">使用Date插件对时间进行格式转换</h4>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">date</span> &#123;</span><br><span class=\"line\">    match =&gt; [<span class=\"string\">&quot;timestamp&quot;</span>,<span class=\"string\">&quot;dd/MMM/yyyy:HH:mm:ss Z&quot;</span>,<span class=\"string\">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>] <span class=\"comment\"># 时间格式转换</span></span><br><span class=\"line\">    target =&gt; <span class=\"string\">&quot;timestamp&quot;</span> <span class=\"comment\"># 目标字段</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"完整的Logstash配置\">完整的Logstash配置</h4>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 进入logstash安装目录</span></span><br><span class=\"line\"><span class=\"comment\"># vim config/logstsh-nginx.conf</span></span><br><span class=\"line\"><span class=\"comment\"># 配置从FileBeat接收数据</span></span><br><span class=\"line\">input &#123; <span class=\"comment\"># 输入源配置</span></span><br><span class=\"line\">    beats &#123; <span class=\"comment\"># 从FileBeat接收数据</span></span><br><span class=\"line\">      port =&gt; 5044 <span class=\"comment\"># 监听5044端口</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">filter &#123; <span class=\"comment\"># 过滤器配置</span></span><br><span class=\"line\">    grok &#123;</span><br><span class=\"line\">        match =&gt; &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;message&quot;</span> =&gt; <span class=\"string\">&quot;%&#123;IP:client_ip&#125; - %&#123;USER:remote_user&#125; \\[%&#123;HTTPDATE:timestamp&#125;\\] \\&quot;%&#123;WORD:verb&#125; %&#123;URIPATHPARAM:request&#125; HTTP/%&#123;NUMBER:httpversion&#125;\\&quot; %&#123;INT:http_status&#125; %&#123;INT:body_bytes_sent&#125; \\&quot;%&#123;NOTSPACE:referrer&#125;\\&quot; \\&quot;%&#123;GREEDYDATA:agent&#125;\\&quot; %&#123;QUOTEDSTRING:x_forwarded_for&#125;&quot;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    mutate &#123;</span><br><span class=\"line\">        enable_metric =&gt; <span class=\"string\">&quot;false&quot;</span> <span class=\"comment\"># 禁用指标上报</span></span><br><span class=\"line\">        remove_field =&gt; [<span class=\"string\">&quot;message&quot;</span>, <span class=\"string\">&quot;log&quot;</span>, <span class=\"string\">&quot;tags&quot;</span>, <span class=\"string\">&quot;input&quot;</span>, <span class=\"string\">&quot;agent&quot;</span>, <span class=\"string\">&quot;host&quot;</span>, <span class=\"string\">&quot;ecs&quot;</span>, <span class=\"string\">&quot;@version&quot;</span>] <span class=\"comment\"># 移除不需要的字段</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">date</span> &#123;</span><br><span class=\"line\">        match =&gt; [<span class=\"string\">&quot;timestamp&quot;</span>,<span class=\"string\">&quot;dd/MMM/yyyy:HH:mm:ss Z&quot;</span>,<span class=\"string\">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>] <span class=\"comment\"># 时间格式转换</span></span><br><span class=\"line\">        target =&gt; <span class=\"string\">&quot;timestamp&quot;</span> <span class=\"comment\"># 目标字段</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">output &#123; <span class=\"comment\"># 输出配置</span></span><br><span class=\"line\">    stdout &#123; <span class=\"comment\"># 打印到控制台</span></span><br><span class=\"line\">      codec =&gt; rubydebug <span class=\"comment\"># 指定编码器</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>重新启动logstash后得到如下结果：</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">              <span class=\"string\">&quot;event&quot;</span> =&gt; &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;original&quot;</span> =&gt; <span class=\"string\">&quot;1.119.161.30 - elastic [27/Mar/2025:09:49:41 +0000] \\&quot;GET /_cluster/stats HTTP/1.1\\&quot; 200 7445 \\&quot;-\\&quot; \\&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/134.0.0.0 Safari/537.36\\&quot; \\&quot;-\\&quot;&quot;</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">          <span class=\"string\">&quot;client_ip&quot;</span> =&gt; <span class=\"string\">&quot;1.119.161.30&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;request&quot;</span> =&gt; <span class=\"string\">&quot;/_cluster/stats&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;http_status&quot;</span> =&gt; <span class=\"string\">&quot;200&quot;</span>,</span><br><span class=\"line\">         <span class=\"string\">&quot;@timestamp&quot;</span> =&gt; 2025-03-27T09:49:45.751Z,</span><br><span class=\"line\">    <span class=\"string\">&quot;body_bytes_sent&quot;</span> =&gt; <span class=\"string\">&quot;7445&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;x_forwarded_for&quot;</span> =&gt; <span class=\"string\">&quot;\\&quot;-\\&quot;&quot;</span>,</span><br><span class=\"line\">          <span class=\"string\">&quot;timestamp&quot;</span> =&gt; 2025-03-27T09:49:41.000Z,</span><br><span class=\"line\">           <span class=\"string\">&quot;referrer&quot;</span> =&gt; <span class=\"string\">&quot;-&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;remote_user&quot;</span> =&gt; <span class=\"string\">&quot;elastic&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;httpversion&quot;</span> =&gt; <span class=\"string\">&quot;1.1&quot;</span>,</span><br><span class=\"line\">               <span class=\"string\">&quot;verb&quot;</span> =&gt; <span class=\"string\">&quot;GET&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"将结果输出到ES\">将结果输出到ES</h4>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 在输出配置中添加ES输出配置</span></span><br><span class=\"line\">output &#123; <span class=\"comment\"># 输出配置</span></span><br><span class=\"line\">    stdout &#123; <span class=\"comment\"># 打印到控制台</span></span><br><span class=\"line\">      codec =&gt; rubydebug <span class=\"comment\"># 指定编码器</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    elasticsearch &#123; <span class=\"comment\"># 输出到ES</span></span><br><span class=\"line\">        index =&gt; <span class=\"string\">&quot;nginx_access_log_%&#123;+YYYY-MM&#125;&quot;</span> <span class=\"comment\"># 索引名,按月分隔</span></span><br><span class=\"line\">        hosts =&gt; [<span class=\"string\">&quot;https://10.250.0.239:9200&quot;</span>] <span class=\"comment\"># ES地址</span></span><br><span class=\"line\">        user =&gt; <span class=\"string\">&quot;elastic&quot;</span>                   <span class=\"comment\"># ES用户名</span></span><br><span class=\"line\">        password =&gt; <span class=\"string\">&quot;123456&quot;</span>                <span class=\"comment\"># ES密码</span></span><br><span class=\"line\">        ssl =&gt; <span class=\"literal\">true</span>                         <span class=\"comment\"># 是否启用SSL，因为这里是https访问ES</span></span><br><span class=\"line\">        ssl_certificate_verification =&gt; <span class=\"literal\">false</span> <span class=\"comment\"># 禁用证书验证</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>如果需要开启证书校验，可以通过如下方法进行配置</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">获取 Elasticsearch 的 SSL 证书：</li>\n</ul>\n  <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 从 Elasticsearch 的配置文件或证书文件路径中获取证书（通常是 .pem 或 .crt 文件）。</span></span><br><span class=\"line\">/usr/local/elasticsearch/elasticsearch-8.17.3/config/certs/http_ca.crt</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">导入证书到 Java 信任库：注意这里要导入到启动Logstash的JAVA进程的信任库</li>\n</ul>\n  <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># logstash的jdk路径，默认在logstash的安装目录下</span></span><br><span class=\"line\"><span class=\"built_in\">cd</span> /usr/local/logstash/logstash-8.17.3/jdk</span><br><span class=\"line\"></span><br><span class=\"line\">bin/keytool -importcert -<span class=\"built_in\">alias</span> es-cert -keystore /usr/local/logstash/logstash-8.17.3/logstash.keystore -file /usr/local/elasticsearch/elasticsearch-8.17.3/config/certs/http_ca.crt</span><br><span class=\"line\"><span class=\"comment\"># 输出</span></span><br><span class=\"line\">Enter keystore password:  <span class=\"comment\"># 输入密码 这里是123456</span></span><br><span class=\"line\">Re-enter new password:</span><br><span class=\"line\">Owner: CN=Elasticsearch security auto-configuration HTTP CA</span><br><span class=\"line\">Issuer: CN=Elasticsearch security auto-configuration HTTP CA</span><br><span class=\"line\">Serial number: 89d5c501a2efd5d45a6ee5e08daa16bd605d8c28</span><br><span class=\"line\">Valid from: Thu Mar 20 08:53:26 UTC 2025 <span class=\"keyword\">until</span>: Sun Mar 19 08:53:26 UTC 2028</span><br><span class=\"line\">Certificate fingerprints:</span><br><span class=\"line\">    SHA1: DE:73:0C:EC:46:59:69:83:52:7C:C4:CC:6B:65:EC:B6:31:BE:10:22</span><br><span class=\"line\">    SHA256: 3F:14:1C:16:DF:C6:E1:65:89:4B:C1:67:20:84:B2:20:DC:DD:22:FF:E0:21:16:D5:1A:C1:80:03:CF:AA:5A:1D</span><br><span class=\"line\">Signature algorithm name: SHA256withRSA</span><br><span class=\"line\">Subject Public Key Algorithm: 4096-bit RSA key</span><br><span class=\"line\">Version: 3</span><br><span class=\"line\"></span><br><span class=\"line\">Extensions:</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#1: ObjectId: 2.5.29.35 Criticality=false</span></span><br><span class=\"line\">AuthorityKeyIdentifier [</span><br><span class=\"line\">KeyIdentifier [</span><br><span class=\"line\">0000: 25 EF BA 81 AE 5E 14 1C   7E FF A1 87 12 F8 D0 2E  %....^..........</span><br><span class=\"line\">0010: 3A D7 54 5F                                        :.T_</span><br><span class=\"line\">]</span><br><span class=\"line\">]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#2: ObjectId: 2.5.29.19 Criticality=true</span></span><br><span class=\"line\">BasicConstraints:[</span><br><span class=\"line\">CA:<span class=\"literal\">true</span></span><br><span class=\"line\">PathLen: no <span class=\"built_in\">limit</span></span><br><span class=\"line\">]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#3: ObjectId: 2.5.29.14 Criticality=false</span></span><br><span class=\"line\">SubjectKeyIdentifier [</span><br><span class=\"line\">KeyIdentifier [</span><br><span class=\"line\">0000: 25 EF BA 81 AE 5E 14 1C   7E FF A1 87 12 F8 D0 2E  %....^..........</span><br><span class=\"line\">0010: 3A D7 54 5F                                        :.T_</span><br><span class=\"line\">]</span><br><span class=\"line\">]</span><br><span class=\"line\"></span><br><span class=\"line\">Trust this certificate? [no]:  <span class=\"built_in\">yes</span> <span class=\"comment\"># yes确认</span></span><br><span class=\"line\">Certificate was added to keystore</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">\n<p>配置 Logstash 使用信任库</p>\n</li>\n</ul>\n  <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">output &#123;</span><br><span class=\"line\">    elasticsearch &#123;</span><br><span class=\"line\">        index =&gt; <span class=\"string\">&quot;nginx_access_log_%&#123;+YYYY-MM&#125;&quot;</span> <span class=\"comment\"># 索引名,按月分隔</span></span><br><span class=\"line\">        hosts =&gt; [<span class=\"string\">&quot;https://10.250.0.239:9200&quot;</span>] <span class=\"comment\"># ES地址</span></span><br><span class=\"line\">        user =&gt; <span class=\"string\">&quot;elastic&quot;</span>                     <span class=\"comment\"># ES用户名</span></span><br><span class=\"line\">        password =&gt; <span class=\"string\">&quot;123456&quot;</span>                  <span class=\"comment\"># ES密码</span></span><br><span class=\"line\">        ssl =&gt; <span class=\"literal\">true</span>                           <span class=\"comment\"># 是否启用SSL，因为这里是https访问ES</span></span><br><span class=\"line\">        ssl_certificate_verification =&gt; <span class=\"literal\">true</span>  <span class=\"comment\"># 启用证书校验</span></span><br><span class=\"line\">        ssl_truststore_path =&gt; <span class=\"string\">&quot;/usr/local/logstash/logstash-8.17.3/logstash.keystore&quot;</span> <span class=\"comment\"># 指定信任库路径</span></span><br><span class=\"line\">        ssl_truststore_password =&gt; <span class=\"string\">&quot;123456&quot;</span>   <span class=\"comment\"># 信任库密码</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<h2 id=\"整合消息队列-Nginx的ELK架构\">整合消息队列+Nginx的ELK架构</h2>\n<p><img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/%E6%88%AA%E5%9B%BE-2.png\" alt=\"\"></p>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>消息队列：引入消息队列作为缓冲机制，确保即使在Logstash或Elasticsearch出现故障时，日志数据也不会丢失。消息队列能够均衡网络传输，降低数据丢失的可能性。</p>\n</li>\n<li class=\"lvl-2\">\n<p>Nginx：Nginx作为高性能的Web和反向代理服务器，可以进一步优化整个系统的性能和可用性。它可以在负载均衡、缓存等方面发挥作用，提升用户访问体验。</p>\n</li>\n<li class=\"lvl-2\">\n<p>扩展性：由于引入了消息队列和Nginx等组件，整个架构的扩展性得到增强。可以根据实际需求动态调整各组件的资源分配和部署规模。</p>\n</li>\n<li class=\"lvl-2\">\n<p>适用场景：整合消息队列+Nginx的架构主要适用于生产环境，特别是需要处理大数据量的场景。它能够确保数据的安全性和完整性，同时提供高性能的日志处理和可视化分析服务。</p>\n</li>\n<li class=\"lvl-2\">\n<p>总结来说就是</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-4\">filebeat将采集的日志发送到Redis\\RabbitMQ\\Kafka等</li>\n<li class=\"lvl-4\">Logstash再从Redis\\RabbitMQ\\Kafka中读取日志数据，并进行解析后发送到ES中。</li>\n<li class=\"lvl-4\">ES集群使用nginx进行负载均衡，以实现高可用和高性能。具体实现方法查看：<a href=\"/2025/03/24/elasticsearch-02-install-cluster/\" title=\"linux下安装Elasticsearch集群\">linux下安装Elasticsearch集群</a></li>\n</ul>\n</li>\n</ul>\n<h2 id=\"基于Redis的ELK架构示例\">基于Redis的ELK架构示例</h2>\n<h3 id=\"filebeat将采集的日志发送到Redis\">filebeat将采集的日志发送到Redis</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>创建配置文件<code>filebeat-nginx-to-redis.yml</code>，将其保存到Filebeat安装目录下的conf目录下。</p>\n</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 因为Nginx的access.log日志都是以IP地址开头的，所以我们需要修改下匹配字段。</span></span><br><span class=\"line\"><span class=\"comment\"># 不以ip地址开头的行追加到上一行</span></span><br><span class=\"line\"><span class=\"attr\">filebeat.inputs:</span> <span class=\"comment\"># 输入源配置</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">type:</span> <span class=\"string\">log</span> <span class=\"comment\"># 日志类型</span></span><br><span class=\"line\">  <span class=\"attr\">enabled:</span> <span class=\"literal\">true</span> <span class=\"comment\"># 是否启用</span></span><br><span class=\"line\">  <span class=\"attr\">paths:</span> <span class=\"comment\"># 采集路径</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">/var/log/nginx/access*.*</span></span><br><span class=\"line\">  <span class=\"attr\">exclude_files:</span> [<span class=\"string\">&quot;.gz$&quot;</span>] <span class=\"comment\"># 排除以.gz 结尾的文件</span></span><br><span class=\"line\">  <span class=\"attr\">multiline.pattern:</span> <span class=\"string\">&#x27;^\\\\d&#123;1,3&#125;\\\\.\\\\d&#123;1,3&#125;\\\\.\\\\d&#123;1,3&#125;\\\\.\\\\d&#123;1,3&#125;\\\\s&#x27;</span> <span class=\"comment\"># 匹配以IP地址开头，并紧跟一个空白字符</span></span><br><span class=\"line\">  <span class=\"attr\">multiline.negate:</span> <span class=\"literal\">true</span> <span class=\"comment\"># 不以ip地址开头的行追加到上一行</span></span><br><span class=\"line\">  <span class=\"attr\">multiline.match:</span> <span class=\"string\">after</span> <span class=\"comment\"># 追加到上一行的后面</span></span><br><span class=\"line\">  <span class=\"comment\"># multiline: 多行日志配置，这里实际上不需要配置多行设置，因为nginx的access日志都是单行日志，这里只做演示</span></span><br><span class=\"line\">    <span class=\"comment\"># pattern: 正则表达式</span></span><br><span class=\"line\">    <span class=\"comment\"># negate: false，匹配pattern的行合并到上一行；true，不匹配pattern的行合并到上一行</span></span><br><span class=\"line\">    <span class=\"comment\"># match: after，合并到上一行的末尾；before，合并到上一行的开头</span></span><br><span class=\"line\">  <span class=\"attr\">scan_frequency:</span> <span class=\"string\">10s</span> <span class=\"comment\"># 每 10 秒扫描一次日志文件</span></span><br><span class=\"line\">  <span class=\"attr\">clean_removed:</span> <span class=\"literal\">true</span> <span class=\"comment\"># 在日志文件被删除后是否从其内部状态中移除该文件的记录</span></span><br><span class=\"line\">  <span class=\"attr\">clean_inactive:</span> <span class=\"string\">2h</span> <span class=\"comment\"># 在日志文件处于非活动状态多长时间后将其从状态数据库中移,设置为比 ignore_older + scan_frequency 更大的值</span></span><br><span class=\"line\">  <span class=\"attr\">ignore_older:</span> <span class=\"string\">1h</span> <span class=\"comment\"># 忽略那些比当前时间早于 1 小时的日志文件</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">output.redis:</span> <span class=\"comment\"># Redis输出配置</span></span><br><span class=\"line\">  <span class=\"attr\">hosts:</span> [<span class=\"string\">&quot;10.250.0.214:6379&quot;</span>] <span class=\"comment\"># Redis服务器地址</span></span><br><span class=\"line\">  <span class=\"attr\">password:</span> <span class=\"string\">&quot;123456&quot;</span> <span class=\"comment\"># Redis密码</span></span><br><span class=\"line\">  <span class=\"attr\">key:</span> <span class=\"string\">&quot;filebeat_nginx&quot;</span> <span class=\"comment\"># Redis的key，类型为 list</span></span><br><span class=\"line\">  <span class=\"attr\">db:</span> <span class=\"number\">3</span> <span class=\"comment\"># Redis数据库</span></span><br><span class=\"line\">  <span class=\"attr\">timeout:</span> <span class=\"number\">3</span> <span class=\"comment\"># Redis连接超时时间，单位秒</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>启动Filebeat，并查看日志输出。</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./filebeat -e -c conf/filebeat-nginx-to-redis.yml</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>查看Redis中的数据</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ redis-cli -h 10.250.0.214 -p 6379 -a 123456</span><br><span class=\"line\">10.250.0.214:6379&gt; <span class=\"keyword\">select</span> 3</span><br><span class=\"line\">OK</span><br><span class=\"line\">10.250.0.214:6379[3]&gt; keys filebeat*</span><br><span class=\"line\">1) <span class=\"string\">&quot;filebeat_nginx&quot;</span></span><br><span class=\"line\">10.250.0.214:6379[3]&gt; <span class=\"built_in\">type</span> filebeat_nginx</span><br><span class=\"line\">list</span><br><span class=\"line\">10.250.0.214:6379[3]&gt; LLEN filebeat_nginx</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 14</span><br><span class=\"line\">10.250.0.214:6379[3]&gt; LINDEX filebeat_nginx 1</span><br><span class=\"line\"><span class=\"string\">&quot;&#123;\\&quot;@timestamp\\&quot;:\\&quot;2025-03-28T09:15:23.402Z\\&quot;,\\&quot;@metadata\\&quot;:&#123;\\&quot;beat\\&quot;:\\&quot;filebeat\\&quot;,\\&quot;type\\&quot;:\\&quot;_doc\\&quot;,\\&quot;version\\&quot;:\\&quot;8.17.3\\&quot;&#125;,\\&quot;host\\&quot;:&#123;\\&quot;name\\&quot;:\\&quot;ip-10-250-0-239.cn-northwest-1.compute.internal\\&quot;&#125;,\\&quot;agent\\&quot;:&#123;\\&quot;version\\&quot;:\\&quot;8.17.3\\&quot;,\\&quot;ephemeral_id\\&quot;:\\&quot;c0a521fe-690b-46b1-aadc-bbe16ef1db9a\\&quot;,\\&quot;id\\&quot;:\\&quot;4dbe185b-900d-4990-b841-c13bf9618fc6\\&quot;,\\&quot;name\\&quot;:\\&quot;ip-10-250-0-239.cn-northwest-1.compute.internal\\&quot;,\\&quot;type\\&quot;:\\&quot;filebeat\\&quot;&#125;,\\&quot;log\\&quot;:&#123;\\&quot;offset\\&quot;:46745,\\&quot;file\\&quot;:&#123;\\&quot;path\\&quot;:\\&quot;/var/log/nginx/access.log\\&quot;&#125;&#125;,\\&quot;message\\&quot;:\\&quot;1.119.161.30 - elastic [28/Mar/2025:09:15:13 +0000] \\\\\\&quot;GET /_cluster/stats HTTP/1.1\\\\\\&quot; 200 7457 \\\\\\&quot;-\\\\\\&quot; \\\\\\&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/134.0.0.0 Safari/537.36\\\\\\&quot; \\\\\\&quot;-\\\\\\&quot;\\&quot;,\\&quot;input\\&quot;:&#123;\\&quot;type\\&quot;:\\&quot;log\\&quot;&#125;,\\&quot;ecs\\&quot;:&#123;\\&quot;version\\&quot;:\\&quot;8.0.0\\&quot;&#125;&#125;&quot;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"Logstash从Redis中读取日志并写入Elasticsearch\">Logstash从Redis中读取日志并写入Elasticsearch</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>创建配置文件<code>logstash-nginx-redis-to-es.conf</code>，将其保存到Logstash安装目录下的conf目录下。</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 进入logstash安装目录</span></span><br><span class=\"line\"><span class=\"comment\"># vim logstash-nginx-redis-to-es.conf</span></span><br><span class=\"line\"><span class=\"comment\"># 配置从 redis 接收数据</span></span><br><span class=\"line\">input &#123; <span class=\"comment\"># 输入源配置</span></span><br><span class=\"line\">    redis &#123; <span class=\"comment\"># Redis输入配置</span></span><br><span class=\"line\">        host =&gt; <span class=\"string\">&#x27;10.250.0.214&#x27;</span> <span class=\"comment\"># Redis服务器地址</span></span><br><span class=\"line\">        port =&gt; <span class=\"string\">&quot;6379&quot;</span> <span class=\"comment\"># Redis服务器端口</span></span><br><span class=\"line\">        password =&gt; <span class=\"string\">&quot;123456&quot;</span> <span class=\"comment\"># Redis密码</span></span><br><span class=\"line\">        db =&gt; <span class=\"string\">&quot;3&quot;</span>           <span class=\"comment\"># Redis数据库</span></span><br><span class=\"line\">        data_type =&gt; <span class=\"string\">&#x27;list&#x27;</span> <span class=\"comment\"># 数据类型为list</span></span><br><span class=\"line\">        key =&gt; <span class=\"string\">&quot;filebeat_nginx&quot;</span>   <span class=\"comment\"># Redis的key</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">filter &#123; <span class=\"comment\"># 过滤器配置</span></span><br><span class=\"line\">    grok &#123;</span><br><span class=\"line\">        match =&gt; &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;message&quot;</span> =&gt; <span class=\"string\">&quot;%&#123;IP:client_ip&#125; - %&#123;USER:remote_user&#125; \\[%&#123;HTTPDATE:timestamp&#125;\\] \\&quot;%&#123;WORD:verb&#125; %&#123;URIPATHPARAM:request&#125; HTTP/%&#123;NUMBER:httpversion&#125;\\&quot; %&#123;INT:http_status&#125; %&#123;INT:body_bytes_sent&#125; \\&quot;%&#123;NOTSPACE:referrer&#125;\\&quot; \\&quot;%&#123;GREEDYDATA:agent&#125;\\&quot; %&#123;QUOTEDSTRING:x_forwarded_for&#125;&quot;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    mutate &#123;</span><br><span class=\"line\">        enable_metric =&gt; <span class=\"string\">&quot;false&quot;</span> <span class=\"comment\"># 禁用指标上报</span></span><br><span class=\"line\">        remove_field =&gt; [<span class=\"string\">&quot;message&quot;</span>, <span class=\"string\">&quot;log&quot;</span>, <span class=\"string\">&quot;tags&quot;</span>, <span class=\"string\">&quot;input&quot;</span>, <span class=\"string\">&quot;agent&quot;</span>, <span class=\"string\">&quot;host&quot;</span>, <span class=\"string\">&quot;ecs&quot;</span>, <span class=\"string\">&quot;@version&quot;</span>] <span class=\"comment\"># 移除不需要的字段</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">date</span> &#123;</span><br><span class=\"line\">        match =&gt; [<span class=\"string\">&quot;timestamp&quot;</span>,<span class=\"string\">&quot;dd/MMM/yyyy:HH:mm:ss Z&quot;</span>,<span class=\"string\">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>] <span class=\"comment\"># 时间格式转换</span></span><br><span class=\"line\">        target =&gt; <span class=\"string\">&quot;timestamp&quot;</span> <span class=\"comment\"># 目标字段</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 在输出配置中添加ES输出配置</span></span><br><span class=\"line\">output &#123; <span class=\"comment\"># 输出配置</span></span><br><span class=\"line\">    stdout &#123; <span class=\"comment\"># 打印到控制台</span></span><br><span class=\"line\">      codec =&gt; rubydebug <span class=\"comment\"># 指定编码器</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    elasticsearch &#123; <span class=\"comment\"># 输出到ES</span></span><br><span class=\"line\">        index =&gt; <span class=\"string\">&quot;redis_nginx_access_log_%&#123;+YYYY-MM&#125;&quot;</span> <span class=\"comment\"># 索引名,按月分隔</span></span><br><span class=\"line\">        hosts =&gt; [<span class=\"string\">&quot;https://10.250.0.239:9200&quot;</span>] <span class=\"comment\"># ES地址</span></span><br><span class=\"line\">        user =&gt; <span class=\"string\">&quot;elastic&quot;</span>                   <span class=\"comment\"># ES用户名</span></span><br><span class=\"line\">        password =&gt; <span class=\"string\">&quot;123456&quot;</span>                <span class=\"comment\"># ES密码</span></span><br><span class=\"line\">        ssl =&gt; <span class=\"literal\">true</span>                         <span class=\"comment\"># 是否启用SSL，因为这里是https访问ES</span></span><br><span class=\"line\">        ssl_certificate_verification =&gt; <span class=\"literal\">false</span> <span class=\"comment\"># 禁用证书验证</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>测试logstash配置是否正确</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bin/logstash -f config/logstash-nginx-redis-to-es.conf --config.test_and_exit</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>启动logstash</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># reload.automatic：修改配置文件时自动重新加载</span></span><br><span class=\"line\">bin/logstash -f config/logstash-nginx-redis-to-es.conf --config.reload.automatic</span><br></pre></td></tr></table></figure>","content_text":"摘要 本文介绍如何在linux下安装LogStash和FileBeat 通过示例讲解ELK的经典架构和高并发架构的实现过程 LogStash版本8.17.3，FileBeat版本8.17.3 Elasticsearch版本8.17.3，linux下安装Elasticsearch Kibana版本8.17.3，linux下安装Kibana Elasticsearch集群搭建，linux下安装Elasticsearch集群 Logstash概述 Logstash 是免费且开放的服务器端数据处理管道，能够从多个来源采集数据，转换数据，然后将数据发送到您最喜欢的存储库中。 Logstash数据传输原理 1231.数据采集与输入：Logstash支持各种输入选择，能够以连续的流式传输方式，轻松地从日志、指标、Web应用以及数据存储中采集数据。2.实时解析和数据转换：通过Logstash过滤器解析各个事件，识别已命名的字段来构建结构，并将它们转换成通用格式，最终将数据从源端传输到存储库中。3.存储与数据导出：Logstash提供多种输出选择，可以将数据发送到指定的地方。 Logstash通过管道完成数据的采集与处理，管道配置中包含input、output和filter（可选）插件，input和output用来配置输入和输出数据源、filter用来对数据进行过滤或预处理。 Logstash下载安装 下载地址：https://www.elastic.co/cn/downloads/past-releases#logstash 选择对应的版本：这里选择当前的最新版LogStash 8.17.3，之后选择对应的操作系统LINUX X86_64 1wget https://artifacts.elastic.co/downloads/logstash/logstash-8.17.3-linux-x86_64.tar.gz 下载完成后解压到/usr/local/logstash目录下，解压命令如下： 12mkdir /usr/local/logstashtar -zxvf logstash-8.17.3-linux-x86_64.tar.gz -C /usr/local/logstash elasticsearch和kibana都不能用root用户启动，为了统一管理，logstash也使用这个用户（非必要） 创建用户elastic，并设置密码，这一步我们在安装elasticsearch的时候已经配置过了，这里就不再赘述了 12useradd elasticpasswd elastic 修改logstash安装目录的用户权限 1chown -R elastic:elastic /usr/local/logstash 切换到elastic用户下执行命令 1234# 切换用户su - elastic# 进入logstash安装目录cd /usr/local/logstash/logstash-8.17.3/ 运行一个简单的测试 123456789101112131415161718192021# -e: 直接把配置放在命令中，这样可以有效快速进行测试# input &#123; stdin &#123; &#125; &#125;: 输入插件，从标准输入中读取数据# output &#123; stdout &#123;&#125; &#125;: 输出插件，将数据输出到标准输出# 这里只包含了 input 和 output 两个部分，实际使用中还需要添加 filter 部分./bin/logstash -e &#x27;input &#123; stdin &#123; &#125; &#125; output &#123; stdout &#123;&#125; &#125;&#x27;# 输出：。。。。。。。 # 输出启动信息The stdin plugin is now waiting for input: # 输出提示信息，提示你输入内容hello world # 我输入内容# logstash输出内容&#123; &quot;message&quot; =&gt; &quot;hello world&quot;, &quot;@version&quot; =&gt; &quot;1&quot;, &quot;event&quot; =&gt; &#123; &quot;original&quot; =&gt; &quot;hello world&quot; &#125;, &quot;host&quot; =&gt; &#123; &quot;hostname&quot; =&gt; &quot;ip-10-250-0-239.cn-northwest-1.compute.internal&quot; &#125;, &quot;@timestamp&quot; =&gt; 2025-03-27T06:48:12.810617855Z&#125; 也可以通过配置文件启动logstash 1234567891011121314# vim test.confinput &#123; stdin &#123; &#125;&#125;output &#123; stdout &#123; codec =&gt; rubydebug &#125;&#125;# codec =&gt; rubydebug : 是指定了一个编码器（Codec）为 rubydebug。# 编码器负责如何格式化输出的数据。# Rubydebug 编码器是一种特别适合开发和调试目的的编码器，因为它能以相当易读的形式展示复杂的结构化数据，比如嵌套的哈希表或者数组。# 除了 Rubydebug 编码器，Logstash 还提供了其他几种编码器，比如 json、plain、multiline 等等。# 具体可以参考官方文档：https://www.elastic.co/guide/en/logstash/current/codec-plugins.html 1./bin/logstash -f ./test.conf Logstash插件 Input Plugins https://www.elastic.co/guide/en/logstash/8.17/input-plugins.html 一个 Pipeline可以有多个input插件 12345- Stdin / File- Beats / Log4J /Elasticsearch / JDBC / Kafka /Rabbitmq /Redis- JMX/ HTTP / Websocket / UDP / TCP- Google Cloud Storage / S3- Github / Twitter Filter Plugins https://www.elastic.co/guide/en/logstash/8.17/filter-plugins.html Filter Plugin可以对Logstash Event进行各种处理，例如解析，删除字段，类型转换 1234567891011- Date: 日期解析- Dissect: 分割符解析- Grok: 正则匹配解析- Mutate: 对字段做各种操作- Convert : 类型转换- Gsub : 字符串替换- Split / Join /Merge: 字符串切割，数组合并字符串，数组合并数组- Rename: 字段重命名- Update / Replace: 字段内容更新替换- Remove_field: 字段删除- Ruby: 利用Ruby 代码来动态修改Event Output Plugins https://www.elastic.co/guide/en/logstash/8.17/output-plugins.html 将Event发送到特定的目的地，是 Pipeline 的最后一个阶段。常见 Output Plugins： 1234- Elasticsearch- Email / Pageduty- Influxdb / Kafka / Mongodb / Opentsdb / Zabbix- Http / TCP / Websocket Codec Plugins https://www.elastic.co/guide/en/logstash/8.17/codec-plugins.html 将原始数据decode成Event;将Event encode成目标数据，内置的Codec Plugins: 123- Line / Multiline- JSON / Avro / Cef (ArcSight Common Event Format)- Dots / Rubydebug FileBeat概述 Beats 是一个免费且开放的平台，集合了多种单一用途的数据采集器。它们从成百上千或成千上万台机器和系统向 Logstash 或 Elasticsearch 发送数据。 FileBeat 专门用于转发和收集日志数据的轻量级采集工具。它可以作为代理安装在服务器上，FileBeat监视指定路径的日志文件，收集日志数据，并将收集到的日志转发到Elasticsearch或者Logstash。 logstash vs FileBeat Logstash是在jvm上运行的，资源消耗比较大。而FileBeat是基于golang编写的，功能较少但资源消耗也比较小，更轻量级。 Logstash 和Filebeat都具有日志收集功能，Filebeat更轻量，占用资源更少 Logstash 具有Filter功能，能过滤分析日志 一般结构都是Filebeat采集日志，然后发送到消息队列、Redis、MQ中，然后Logstash去获取，利用Filter功能过滤分析，然后存储到Elasticsearch中 FileBeat和Logstash配合，实现背压机制。当将数据发送到Logstash或 Elasticsearch时，Filebeat使用背压敏感协议，以应对更多的数据量。如果Logstash正在忙于处理数据，则会告诉Filebeat 减慢读取速度。一旦拥堵得到解决，Filebeat就会恢复到原来的步伐并继续传输数据。 FileBeat下载和安装 下载地址：https://www.elastic.co/cn/downloads/past-releases#filebeat 选择对应的版本：这里选择当前的最新版FileBeat 8.17.3，之后选择对应的操作系统LINUX X86_64 1wget https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-8.17.3-linux-x86_64.tar.gz 下载完成后解压到/usr/local/filebeat目录下，解压命令如下： 12mkdir /usr/local/filebeattar -zxvf filebeat-8.17.3-linux-x86_64.tar.gz -C /usr/local/filebeat 修改logstash安装目录的用户权限 1chown -R elastic:elastic /usr/local/filebeat 切换到elastic用户下执行命令 1234# 切换用户su - elastic# 进入 filebeat 安装目录cd /usr/local/filebeat/filebeat-8.17.3-linux-x86_64/ 经典的ELK架构 Filebeat日志收集：Filebeat作为轻量级的日志收集代理，部署在客户端上，消耗资源少，能够高效地收集日志数据。 Logstash数据处理：Logstash作为数据处理管道，负责将Filebeat收集的日志数据进行过滤、转换等操作，然后发送到Elasticsearch进行存储。 Elasticsearch存储与搜索：Elasticsearch是一个基于Lucene的分布式搜索和分析引擎，提供强大的数据存储和搜索能力。 Kibana可视化：Kibana为Elasticsearch提供Web可视化界面，允许用户通过图表、仪表盘等方式直观地查看和分析日志数据。 适用场景：经典的ELK架构主要适用于数据量较小的开发环境。然而，由于缺少消息队列的缓冲机制，当Logstash或Elasticsearch出现故障时，可能存在数据丢失的风险。 一个经典ELK架构示例 FileBeat采集Nginx服务器日志并发送到Logstash 创建配置文件filebeat-nginx.yml，将其保存到Filebeat安装目录下的conf目录下。 12345678910111213141516171819202122# 因为Nginx的access.log日志都是以IP地址开头的，所以我们需要修改下匹配字段。# 不以ip地址开头的行追加到上一行filebeat.inputs: # 输入源配置- type: log # 日志类型 enabled: true # 是否启用 paths: # 采集路径 - /var/log/nginx/access*.* exclude_files: [&quot;.gz$&quot;] # 排除以.gz 结尾的文件 multiline.pattern: &#x27;^\\\\d&#123;1,3&#125;\\\\.\\\\d&#123;1,3&#125;\\\\.\\\\d&#123;1,3&#125;\\\\.\\\\d&#123;1,3&#125;\\\\s&#x27; # 匹配以IP地址开头，并紧跟一个空白字符 multiline.negate: true # 不以ip地址开头的行追加到上一行 multiline.match: after # 追加到上一行的后面 # multiline: 多行日志配置，这里实际上不需要配置多行设置，因为nginx的access日志都是单行日志，这里只做演示 # pattern: 正则表达式 # negate: false，匹配pattern的行合并到上一行；true，不匹配pattern的行合并到上一行 # match: after，合并到上一行的末尾；before，合并到上一行的开头 scan_frequency: 10s # 每 10 秒扫描一次日志文件 clean_removed: true # 在日志文件被删除后是否从其内部状态中移除该文件的记录 clean_inactive: 2h # 在日志文件处于非活动状态多长时间后将其从状态数据库中移,设置为比 ignore_older + scan_frequency 更大的值 ignore_older: 1h # 忽略那些比当前时间早于 1 小时的日志文件output.logstash: # 输出配置，这里是发送到Logstash enabled: true # 是否启用 hosts: [&quot;10.250.0.239:5044&quot;] # Logstash服务地址 为FileBeat的用户分配日志目录的读取权限 12# 使用 setfacl命令为elastic用户分配日志目录的读取权限sudo setfacl -d -m u:elastic:r-x -R /var/log/nginx/ 启动FileBeat 123./filebeat -e -c conf/filebeat-nginx.yml# 后台启动nohup ./filebeat -e -c conf/filebeat-nginx.yml &amp; 在启动filebeat时可能会遇到如下错误 1Exiting: error loading config file: config file (&quot;conf/filebeat-nginx.yml&quot;) can only be writable by the owner but the permissions are &quot;-rw-rw-r--&quot; (to fix the permissions use: &#x27;chmod go-w /usr/local/filebeat/filebeat-8.17.3-linux-x86_64/conf/filebeat-nginx.yml&#x27;) 因为安全原因不要其他用户写的权限，去掉写的权限就可以了 1chmod go-w conf/filebeat-nginx.yml 配置Logstash接收FileBeat收集的数据并打印 创建配置文件logstash-nginx.conf，将其保存到Logstash安装目录下的config目录下。 1234567891011121314# 进入logstash安装目录# vim config/logstash-nginx.conf# 配置从FileBeat接收数据input &#123; # 输入源配置 beats &#123; # 从FileBeat接收数据 port =&gt; 5044 # 监听5044端口 &#125;&#125;output &#123; # 输出配置 stdout &#123; # 打印到控制台 codec =&gt; rubydebug # 指定编码器 &#125;&#125; 测试logstash配置是否正确 1bin/logstash -f config/logstash-nginx.conf --config.test_and_exit 启动logstash 12345678910111213141516171819202122232425262728293031323334353637# reload.automatic：修改配置文件时自动重新加载bin/logstash -f config/logstash-nginx.conf --config.reload.automatic# 此时在控制台会看到如下输出：&#123; &quot;input&quot; =&gt; &#123; &quot;type&quot; =&gt; &quot;log&quot; &#125;, &quot;@version&quot; =&gt; &quot;1&quot;, &quot;message&quot; =&gt; &quot;1.119.161.30 - elastic [27/Mar/2025:08:52:41 +0000] \\&quot;GET /_cluster/stats HTTP/1.1\\&quot; 200 7445 \\&quot;-\\&quot; \\&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/134.0.0.0 Safari/537.36\\&quot; \\&quot;-\\&quot;&quot;, &quot;log&quot; =&gt; &#123; &quot;file&quot; =&gt; &#123; &quot;path&quot; =&gt; &quot;/var/log/nginx/access.log&quot; &#125;, &quot;offset&quot; =&gt; 42985 &#125;, &quot;tags&quot; =&gt; [ [0] &quot;beats_input_codec_plain_applied&quot; ], &quot;@timestamp&quot; =&gt; 2025-03-27T08:52:42.947Z, &quot;ecs&quot; =&gt; &#123; &quot;version&quot; =&gt; &quot;8.0.0&quot; &#125;, &quot;agent&quot; =&gt; &#123; &quot;id&quot; =&gt; &quot;4dbe185b-900d-4990-b841-c13bf9618fc6&quot;, &quot;name&quot; =&gt; &quot;ip-10-250-0-239.cn-northwest-1.compute.internal&quot;, &quot;ephemeral_id&quot; =&gt; &quot;6bb04808-7da7-4acb-95fd-f3f915651457&quot;, &quot;type&quot; =&gt; &quot;filebeat&quot;, &quot;version&quot; =&gt; &quot;8.17.3&quot; &#125;, &quot;event&quot; =&gt; &#123; &quot;original&quot; =&gt; &quot;1.119.161.30 - elastic [27/Mar/2025:08:52:41 +0000] \\&quot;GET /_cluster/stats HTTP/1.1\\&quot; 200 7445 \\&quot;-\\&quot; \\&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/134.0.0.0 Safari/537.36\\&quot; \\&quot;-\\&quot;&quot; &#125;, &quot;host&quot; =&gt; &#123; &quot;name&quot; =&gt; &quot;ip-10-250-0-239.cn-northwest-1.compute.internal&quot; &#125;&#125; 利用Logstash过滤器解析日志 从打印结果看到包含了大量的无关数据，此时可以利用Logstash过滤器解析日志，这里使用Grok插件 Grok是一种将非结构化日志解析为结构化的插件。这个工具非常适合用来解析系统日志、Web服务器日志、MySQL或者是任意其他的日志格式。 Grok是通过模式匹配的方式来识别日志中的数据,可以把Grok插件简单理解为升级版本的正则表达式。它拥有更多的模式，默认Logstash拥有120个模式。如果这些模式不满足我们解析日志的需求，我们可以直接使用正则表达式来进行匹配。 GROK模式参考 grok模式的语法是: 1234%&#123;SYNTAX:SEMANTIC&#125;# SYNTAX（语法）指的是Grok模式名称，SEMANTIC（语义）是给模式匹配到的文本字段名。例如：%&#123;NUMBER:duration&#125; %&#123;IP:client&#125;# duration表示：匹配一个数字，client表示匹配一个IP地址。 匹配nginx日志 123456789101112131415161718192021222324252627282930313233# nginx access日志格式1.119.161.30 - elastic [27/Mar/2025:03:05:36 +0000] &quot;GET /_cluster/stats HTTP/1.1&quot; 200 7446 &quot;-&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/134.0.0.0 Safari/537.36&quot; &quot;-&quot;# grok%&#123;IP:client_ip&#125; - %&#123;USER:remote_user&#125; \\[%&#123;HTTPDATE:timestamp&#125;\\] \\&quot;%&#123;WORD:verb&#125; %&#123;URIPATHPARAM:request&#125; HTTP/%&#123;NUMBER:httpversion&#125;\\&quot; %&#123;INT:http_status&#125; %&#123;INT:body_bytes_sent&#125; \\&quot;%&#123;NOTSPACE:referrer&#125;\\&quot; \\&quot;%&#123;GREEDYDATA:agent&#125;\\&quot; %&#123;QUOTEDSTRING:x_forwarded_for&#125;# 解释每个部分的作用：# %&#123;IP:client_ip&#125;：匹配客户端 IP 地址。# -：匹配一个破折号（-），表示匿名用户或未认证用户。# %&#123;USER:remote_user&#125;：匹配远程用户名， - 表示匿名用户。# \\[%&#123;HTTPDATE:timestamp&#125;\\]：匹配请求的时间戳，格式为 [27/Mar/2025:03:05:36 +0000]。# \\&quot;%&#123;WORD:verb&#125; : 匹配请求方法 (GET)# %&#123;URIPATHPARAM:request&#125; : 匹配请求路径 (/_cluster/stats)# HTTP/%&#123;NUMBER:httpversion&#125;\\\\\\&quot;：匹配 HTTP 版本 (HTTP/1.1)。# %&#123;INT:http_status&#125;：匹配 HTTP 响应状态码 (200)。# %&#123;INT:body_bytes_sent&#125;：匹配响应体的字节数 (7446)。# \\&quot;%&#123;NOTSPACE:referrer&#125;\\&quot;：匹配引用页 (Referer) 字段，这里为空 (&quot;-&quot;)。# \\&quot;%&#123;GREEDYDATA:agent&#125;\\&quot;：匹配用户代理 (User-Agent) 字段。GREEDYDATA 会匹配尽可能多的数据，直到遇到下一个分隔符。# %&#123;QUOTEDSTRING:x_forwarded_for&#125;：匹配 X-Forwarded-For 头字段，这里为空 (&quot;-&quot;)。# 匹配结果&#123; &quot;request&quot;: &quot;/_cluster/stats&quot;, &quot;agent&quot;: &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/134.0.0.0 Safari/537.36&quot;, &quot;body_bytes_sent&quot;: &quot;7446&quot;, &quot;verb&quot;: &quot;GET&quot;, &quot;x_forwarded_for&quot;: &quot;\\&quot;-\\&quot;&quot;, &quot;remote_user&quot;: &quot;elastic&quot;, &quot;referrer&quot;: &quot;-&quot;, &quot;client_ip&quot;: &quot;1.119.161.30&quot;, &quot;httpversion&quot;: &quot;1.1&quot;, &quot;http_status&quot;: &quot;200&quot;, &quot;timestamp&quot;: &quot;27/Mar/2025:03:05:36 +0000&quot;&#125; 匹配Grok模式是个非常繁琐的过程，我们可以使用Kibana来进行可视化的Grok调试 grok配置 12345grok &#123; match =&gt; &#123; &quot;message&quot; =&gt; &quot;%&#123;IP:client_ip&#125; - %&#123;USER:remote_user&#125; \\[%&#123;HTTPDATE:timestamp&#125;\\] \\&quot;%&#123;WORD:verb&#125; %&#123;URIPATHPARAM:request&#125; HTTP/%&#123;NUMBER:httpversion&#125;\\&quot; %&#123;INT:http_status&#125; %&#123;INT:body_bytes_sent&#125; \\&quot;%&#123;NOTSPACE:referrer&#125;\\&quot; \\&quot;%&#123;GREEDYDATA:agent&#125;\\&quot; %&#123;QUOTEDSTRING:x_forwarded_for&#125;&quot; &#125;&#125; 使用mutate插件过滤掉不需要的字段 除了nginx日志本身的格式外，logstash还会打印许多我们不需要的字段，此时可以使用mutate插件来过滤掉不需要的字段。 1234mutate &#123; enable_metric =&gt; &quot;false&quot; # 禁用指标上报 remove_field =&gt; [&quot;message&quot;, &quot;log&quot;, &quot;tags&quot;, &quot;input&quot;, &quot;agent&quot;, &quot;host&quot;, &quot;ecs&quot;, &quot;@version&quot;] # 移除不需要的字段&#125; 使用Date插件对时间进行格式转换 1234date &#123; match =&gt; [&quot;timestamp&quot;,&quot;dd/MMM/yyyy:HH:mm:ss Z&quot;,&quot;yyyy-MM-dd HH:mm:ss&quot;] # 时间格式转换 target =&gt; &quot;timestamp&quot; # 目标字段&#125; 完整的Logstash配置 1234567891011121314151617181920212223242526272829303132# 进入logstash安装目录# vim config/logstsh-nginx.conf# 配置从FileBeat接收数据input &#123; # 输入源配置 beats &#123; # 从FileBeat接收数据 port =&gt; 5044 # 监听5044端口 &#125;&#125;filter &#123; # 过滤器配置 grok &#123; match =&gt; &#123; &quot;message&quot; =&gt; &quot;%&#123;IP:client_ip&#125; - %&#123;USER:remote_user&#125; \\[%&#123;HTTPDATE:timestamp&#125;\\] \\&quot;%&#123;WORD:verb&#125; %&#123;URIPATHPARAM:request&#125; HTTP/%&#123;NUMBER:httpversion&#125;\\&quot; %&#123;INT:http_status&#125; %&#123;INT:body_bytes_sent&#125; \\&quot;%&#123;NOTSPACE:referrer&#125;\\&quot; \\&quot;%&#123;GREEDYDATA:agent&#125;\\&quot; %&#123;QUOTEDSTRING:x_forwarded_for&#125;&quot; &#125; &#125; mutate &#123; enable_metric =&gt; &quot;false&quot; # 禁用指标上报 remove_field =&gt; [&quot;message&quot;, &quot;log&quot;, &quot;tags&quot;, &quot;input&quot;, &quot;agent&quot;, &quot;host&quot;, &quot;ecs&quot;, &quot;@version&quot;] # 移除不需要的字段 &#125; date &#123; match =&gt; [&quot;timestamp&quot;,&quot;dd/MMM/yyyy:HH:mm:ss Z&quot;,&quot;yyyy-MM-dd HH:mm:ss&quot;] # 时间格式转换 target =&gt; &quot;timestamp&quot; # 目标字段 &#125;&#125;output &#123; # 输出配置 stdout &#123; # 打印到控制台 codec =&gt; rubydebug # 指定编码器 &#125;&#125; 重新启动logstash后得到如下结果： 12345678910111213141516&#123; &quot;event&quot; =&gt; &#123; &quot;original&quot; =&gt; &quot;1.119.161.30 - elastic [27/Mar/2025:09:49:41 +0000] \\&quot;GET /_cluster/stats HTTP/1.1\\&quot; 200 7445 \\&quot;-\\&quot; \\&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/134.0.0.0 Safari/537.36\\&quot; \\&quot;-\\&quot;&quot; &#125;, &quot;client_ip&quot; =&gt; &quot;1.119.161.30&quot;, &quot;request&quot; =&gt; &quot;/_cluster/stats&quot;, &quot;http_status&quot; =&gt; &quot;200&quot;, &quot;@timestamp&quot; =&gt; 2025-03-27T09:49:45.751Z, &quot;body_bytes_sent&quot; =&gt; &quot;7445&quot;, &quot;x_forwarded_for&quot; =&gt; &quot;\\&quot;-\\&quot;&quot;, &quot;timestamp&quot; =&gt; 2025-03-27T09:49:41.000Z, &quot;referrer&quot; =&gt; &quot;-&quot;, &quot;remote_user&quot; =&gt; &quot;elastic&quot;, &quot;httpversion&quot; =&gt; &quot;1.1&quot;, &quot;verb&quot; =&gt; &quot;GET&quot;&#125; 将结果输出到ES 1234567891011121314# 在输出配置中添加ES输出配置output &#123; # 输出配置 stdout &#123; # 打印到控制台 codec =&gt; rubydebug # 指定编码器 &#125; elasticsearch &#123; # 输出到ES index =&gt; &quot;nginx_access_log_%&#123;+YYYY-MM&#125;&quot; # 索引名,按月分隔 hosts =&gt; [&quot;https://10.250.0.239:9200&quot;] # ES地址 user =&gt; &quot;elastic&quot; # ES用户名 password =&gt; &quot;123456&quot; # ES密码 ssl =&gt; true # 是否启用SSL，因为这里是https访问ES ssl_certificate_verification =&gt; false # 禁用证书验证 &#125;&#125; 如果需要开启证书校验，可以通过如下方法进行配置 获取 Elasticsearch 的 SSL 证书： 12# 从 Elasticsearch 的配置文件或证书文件路径中获取证书（通常是 .pem 或 .crt 文件）。/usr/local/elasticsearch/elasticsearch-8.17.3/config/certs/http_ca.crt 导入证书到 Java 信任库：注意这里要导入到启动Logstash的JAVA进程的信任库 1234567891011121314151617181920212223242526272829303132333435363738394041424344# logstash的jdk路径，默认在logstash的安装目录下cd /usr/local/logstash/logstash-8.17.3/jdkbin/keytool -importcert -alias es-cert -keystore /usr/local/logstash/logstash-8.17.3/logstash.keystore -file /usr/local/elasticsearch/elasticsearch-8.17.3/config/certs/http_ca.crt# 输出Enter keystore password: # 输入密码 这里是123456Re-enter new password:Owner: CN=Elasticsearch security auto-configuration HTTP CAIssuer: CN=Elasticsearch security auto-configuration HTTP CASerial number: 89d5c501a2efd5d45a6ee5e08daa16bd605d8c28Valid from: Thu Mar 20 08:53:26 UTC 2025 until: Sun Mar 19 08:53:26 UTC 2028Certificate fingerprints: SHA1: DE:73:0C:EC:46:59:69:83:52:7C:C4:CC:6B:65:EC:B6:31:BE:10:22 SHA256: 3F:14:1C:16:DF:C6:E1:65:89:4B:C1:67:20:84:B2:20:DC:DD:22:FF:E0:21:16:D5:1A:C1:80:03:CF:AA:5A:1DSignature algorithm name: SHA256withRSASubject Public Key Algorithm: 4096-bit RSA keyVersion: 3Extensions:#1: ObjectId: 2.5.29.35 Criticality=falseAuthorityKeyIdentifier [KeyIdentifier [0000: 25 EF BA 81 AE 5E 14 1C 7E FF A1 87 12 F8 D0 2E %....^..........0010: 3A D7 54 5F :.T_]]#2: ObjectId: 2.5.29.19 Criticality=trueBasicConstraints:[CA:truePathLen: no limit]#3: ObjectId: 2.5.29.14 Criticality=falseSubjectKeyIdentifier [KeyIdentifier [0000: 25 EF BA 81 AE 5E 14 1C 7E FF A1 87 12 F8 D0 2E %....^..........0010: 3A D7 54 5F :.T_]]Trust this certificate? [no]: yes # yes确认Certificate was added to keystore 配置 Logstash 使用信任库 123456789101112output &#123; elasticsearch &#123; index =&gt; &quot;nginx_access_log_%&#123;+YYYY-MM&#125;&quot; # 索引名,按月分隔 hosts =&gt; [&quot;https://10.250.0.239:9200&quot;] # ES地址 user =&gt; &quot;elastic&quot; # ES用户名 password =&gt; &quot;123456&quot; # ES密码 ssl =&gt; true # 是否启用SSL，因为这里是https访问ES ssl_certificate_verification =&gt; true # 启用证书校验 ssl_truststore_path =&gt; &quot;/usr/local/logstash/logstash-8.17.3/logstash.keystore&quot; # 指定信任库路径 ssl_truststore_password =&gt; &quot;123456&quot; # 信任库密码 &#125;&#125; 整合消息队列+Nginx的ELK架构 消息队列：引入消息队列作为缓冲机制，确保即使在Logstash或Elasticsearch出现故障时，日志数据也不会丢失。消息队列能够均衡网络传输，降低数据丢失的可能性。 Nginx：Nginx作为高性能的Web和反向代理服务器，可以进一步优化整个系统的性能和可用性。它可以在负载均衡、缓存等方面发挥作用，提升用户访问体验。 扩展性：由于引入了消息队列和Nginx等组件，整个架构的扩展性得到增强。可以根据实际需求动态调整各组件的资源分配和部署规模。 适用场景：整合消息队列+Nginx的架构主要适用于生产环境，特别是需要处理大数据量的场景。它能够确保数据的安全性和完整性，同时提供高性能的日志处理和可视化分析服务。 总结来说就是 filebeat将采集的日志发送到Redis\\RabbitMQ\\Kafka等 Logstash再从Redis\\RabbitMQ\\Kafka中读取日志数据，并进行解析后发送到ES中。 ES集群使用nginx进行负载均衡，以实现高可用和高性能。具体实现方法查看：linux下安装Elasticsearch集群 基于Redis的ELK架构示例 filebeat将采集的日志发送到Redis 创建配置文件filebeat-nginx-to-redis.yml，将其保存到Filebeat安装目录下的conf目录下。 1234567891011121314151617181920212223242526# 因为Nginx的access.log日志都是以IP地址开头的，所以我们需要修改下匹配字段。# 不以ip地址开头的行追加到上一行filebeat.inputs: # 输入源配置- type: log # 日志类型 enabled: true # 是否启用 paths: # 采集路径 - /var/log/nginx/access*.* exclude_files: [&quot;.gz$&quot;] # 排除以.gz 结尾的文件 multiline.pattern: &#x27;^\\\\d&#123;1,3&#125;\\\\.\\\\d&#123;1,3&#125;\\\\.\\\\d&#123;1,3&#125;\\\\.\\\\d&#123;1,3&#125;\\\\s&#x27; # 匹配以IP地址开头，并紧跟一个空白字符 multiline.negate: true # 不以ip地址开头的行追加到上一行 multiline.match: after # 追加到上一行的后面 # multiline: 多行日志配置，这里实际上不需要配置多行设置，因为nginx的access日志都是单行日志，这里只做演示 # pattern: 正则表达式 # negate: false，匹配pattern的行合并到上一行；true，不匹配pattern的行合并到上一行 # match: after，合并到上一行的末尾；before，合并到上一行的开头 scan_frequency: 10s # 每 10 秒扫描一次日志文件 clean_removed: true # 在日志文件被删除后是否从其内部状态中移除该文件的记录 clean_inactive: 2h # 在日志文件处于非活动状态多长时间后将其从状态数据库中移,设置为比 ignore_older + scan_frequency 更大的值 ignore_older: 1h # 忽略那些比当前时间早于 1 小时的日志文件output.redis: # Redis输出配置 hosts: [&quot;10.250.0.214:6379&quot;] # Redis服务器地址 password: &quot;123456&quot; # Redis密码 key: &quot;filebeat_nginx&quot; # Redis的key，类型为 list db: 3 # Redis数据库 timeout: 3 # Redis连接超时时间，单位秒 启动Filebeat，并查看日志输出。 1./filebeat -e -c conf/filebeat-nginx-to-redis.yml 查看Redis中的数据 1234567891011$ redis-cli -h 10.250.0.214 -p 6379 -a 12345610.250.0.214:6379&gt; select 3OK10.250.0.214:6379[3]&gt; keys filebeat*1) &quot;filebeat_nginx&quot;10.250.0.214:6379[3]&gt; type filebeat_nginxlist10.250.0.214:6379[3]&gt; LLEN filebeat_nginx(integer) 1410.250.0.214:6379[3]&gt; LINDEX filebeat_nginx 1&quot;&#123;\\&quot;@timestamp\\&quot;:\\&quot;2025-03-28T09:15:23.402Z\\&quot;,\\&quot;@metadata\\&quot;:&#123;\\&quot;beat\\&quot;:\\&quot;filebeat\\&quot;,\\&quot;type\\&quot;:\\&quot;_doc\\&quot;,\\&quot;version\\&quot;:\\&quot;8.17.3\\&quot;&#125;,\\&quot;host\\&quot;:&#123;\\&quot;name\\&quot;:\\&quot;ip-10-250-0-239.cn-northwest-1.compute.internal\\&quot;&#125;,\\&quot;agent\\&quot;:&#123;\\&quot;version\\&quot;:\\&quot;8.17.3\\&quot;,\\&quot;ephemeral_id\\&quot;:\\&quot;c0a521fe-690b-46b1-aadc-bbe16ef1db9a\\&quot;,\\&quot;id\\&quot;:\\&quot;4dbe185b-900d-4990-b841-c13bf9618fc6\\&quot;,\\&quot;name\\&quot;:\\&quot;ip-10-250-0-239.cn-northwest-1.compute.internal\\&quot;,\\&quot;type\\&quot;:\\&quot;filebeat\\&quot;&#125;,\\&quot;log\\&quot;:&#123;\\&quot;offset\\&quot;:46745,\\&quot;file\\&quot;:&#123;\\&quot;path\\&quot;:\\&quot;/var/log/nginx/access.log\\&quot;&#125;&#125;,\\&quot;message\\&quot;:\\&quot;1.119.161.30 - elastic [28/Mar/2025:09:15:13 +0000] \\\\\\&quot;GET /_cluster/stats HTTP/1.1\\\\\\&quot; 200 7457 \\\\\\&quot;-\\\\\\&quot; \\\\\\&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/134.0.0.0 Safari/537.36\\\\\\&quot; \\\\\\&quot;-\\\\\\&quot;\\&quot;,\\&quot;input\\&quot;:&#123;\\&quot;type\\&quot;:\\&quot;log\\&quot;&#125;,\\&quot;ecs\\&quot;:&#123;\\&quot;version\\&quot;:\\&quot;8.0.0\\&quot;&#125;&#125;&quot; Logstash从Redis中读取日志并写入Elasticsearch 创建配置文件logstash-nginx-redis-to-es.conf，将其保存到Logstash安装目录下的conf目录下。 12345678910111213141516171819202122232425262728293031323334353637383940414243444546# 进入logstash安装目录# vim logstash-nginx-redis-to-es.conf# 配置从 redis 接收数据input &#123; # 输入源配置 redis &#123; # Redis输入配置 host =&gt; &#x27;10.250.0.214&#x27; # Redis服务器地址 port =&gt; &quot;6379&quot; # Redis服务器端口 password =&gt; &quot;123456&quot; # Redis密码 db =&gt; &quot;3&quot; # Redis数据库 data_type =&gt; &#x27;list&#x27; # 数据类型为list key =&gt; &quot;filebeat_nginx&quot; # Redis的key &#125;&#125;filter &#123; # 过滤器配置 grok &#123; match =&gt; &#123; &quot;message&quot; =&gt; &quot;%&#123;IP:client_ip&#125; - %&#123;USER:remote_user&#125; \\[%&#123;HTTPDATE:timestamp&#125;\\] \\&quot;%&#123;WORD:verb&#125; %&#123;URIPATHPARAM:request&#125; HTTP/%&#123;NUMBER:httpversion&#125;\\&quot; %&#123;INT:http_status&#125; %&#123;INT:body_bytes_sent&#125; \\&quot;%&#123;NOTSPACE:referrer&#125;\\&quot; \\&quot;%&#123;GREEDYDATA:agent&#125;\\&quot; %&#123;QUOTEDSTRING:x_forwarded_for&#125;&quot; &#125; &#125; mutate &#123; enable_metric =&gt; &quot;false&quot; # 禁用指标上报 remove_field =&gt; [&quot;message&quot;, &quot;log&quot;, &quot;tags&quot;, &quot;input&quot;, &quot;agent&quot;, &quot;host&quot;, &quot;ecs&quot;, &quot;@version&quot;] # 移除不需要的字段 &#125; date &#123; match =&gt; [&quot;timestamp&quot;,&quot;dd/MMM/yyyy:HH:mm:ss Z&quot;,&quot;yyyy-MM-dd HH:mm:ss&quot;] # 时间格式转换 target =&gt; &quot;timestamp&quot; # 目标字段 &#125;&#125;# 在输出配置中添加ES输出配置output &#123; # 输出配置 stdout &#123; # 打印到控制台 codec =&gt; rubydebug # 指定编码器 &#125; elasticsearch &#123; # 输出到ES index =&gt; &quot;redis_nginx_access_log_%&#123;+YYYY-MM&#125;&quot; # 索引名,按月分隔 hosts =&gt; [&quot;https://10.250.0.239:9200&quot;] # ES地址 user =&gt; &quot;elastic&quot; # ES用户名 password =&gt; &quot;123456&quot; # ES密码 ssl =&gt; true # 是否启用SSL，因为这里是https访问ES ssl_certificate_verification =&gt; false # 禁用证书验证 &#125;&#125; 测试logstash配置是否正确 1bin/logstash -f config/logstash-nginx-redis-to-es.conf --config.test_and_exit 启动logstash 12# reload.automatic：修改配置文件时自动重新加载bin/logstash -f config/logstash-nginx-redis-to-es.conf --config.reload.automatic","summary":"摘要 本文介绍如何在linux下安装LogStash和FileBeat 通过示例讲解ELK的经典架构和高并发架构的实现过程 LogStash版本8.17.3，FileBeat版本8.17.3 Elasticsearch版本8.17.3，linux下安装Elasticsearch Kibana版本8.17.3，linux下安装Kibana Elasticsearch集群搭建，linux下安装Elasticsearch集群","date_published":"2025-03-27T13:30:05.000Z","tags":["技术","elastic","kibana","logstash","elasticsearch","kibana","logstash"]},{"id":"https://blog.hanqunfeng.com/2025/03/25/elasticsearch-03-plugins/","url":"https://blog.hanqunfeng.com/2025/03/25/elasticsearch-03-plugins/","title":"linux下Elasticsearch插件安装","content_html":"<!--\n **加粗**\n *斜体*\n ***加粗并斜体***\n ~~删除线~~\n ==突出显示==\n `突出显示(推荐)`\n ++下划线++\n ~下标~\n ^上标^\n 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.\n 图片设置宽度和高度(通过uPic上传后，需要将upic修改过为blog，用于添加水印) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)\n\n +++ **点击折叠**\n 这是被隐藏的内容\n +++\n\n::: tips success warning danger\n这里是容器内的内容\n:::\n\n% note info % success warning danger\n这里是容器内的内容\n% endnote %\n\n引用本地其它文章连接{}\n 大括号开始% post_link 文件名称(不包含.md) %大括号结束\n -->\n<h2 id=\"摘要\">摘要</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>本文介绍如何在linux为Elasticsearch安装插件</p>\n</li>\n<li class=\"lvl-2\">\n<p>Elasticsearch版本8.17.3</p>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"安装Elasticsearch核心库插件\">安装Elasticsearch核心库插件</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>以安装 <code>analysis-icu</code> 这个分词插件为例</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 进入Elasticsearch安装目录，插件的安装路径在 plugins 目录下</span></span><br><span class=\"line\"><span class=\"comment\"># 安装插件</span></span><br><span class=\"line\">bin/elasticsearch-plugin install analysis-icu</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>安装或卸载插件后，需要重启Elasticsearch服务</p>\n</li>\n</ul>\n<h2 id=\"安装其它来源的插件\">安装其它来源的插件</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>以安装 <code>analysis-ik</code> 这个中文分词插件为例</p>\n</li>\n<li class=\"lvl-2\">\n<p>从<a href=\"https://release.infinilabs.com/analysis-ik/stable/\">https://release.infinilabs.com/analysis-ik/stable/</a>找到对应版本的插件连接，这里以<code>8.17.3</code>为例</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.基于url安装插件</span></span><br><span class=\"line\">bin/elasticsearch-plugin install https://release.infinilabs.com/analysis-ik/stable/elasticsearch-analysis-ik-8.17.3.zip</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.基于本地文件安装插件，我们可以先将插件下载的本地目录</span></span><br><span class=\"line\">wget https://release.infinilabs.com/analysis-ik/stable/elasticsearch-analysis-ik-8.17.3.zip -P /tmp/</span><br><span class=\"line\">bin/elasticsearch-plugin install file:///tmp/elasticsearch-analysis-ik-8.17.3.zip</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3.可以将下载好的包解压到plugins目录下，然后重启Elasticsearch服务</span></span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> /usr/local/elasticsearch/elasticsearch-8.17.3/plugins/analysis-ik</span><br><span class=\"line\">unzip elasticsearch-analysis-ik-8.17.3.zip -d /usr/local/elasticsearch/elasticsearch-8.17.3/plugins/analysis-ik</span><br></pre></td></tr></table></figure>\n<h2 id=\"查看和卸载插件\">查看和卸载插件</h2>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 列出所有插件</span></span><br><span class=\"line\">bin/elasticsearch-plugin list</span><br><span class=\"line\"><span class=\"comment\"># 卸载插件</span></span><br><span class=\"line\">bin/elasticsearch-plugin remove analysis-ik</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 通过curl命令查看插件信息</span></span><br><span class=\"line\">curl -u elastic:123456 -k https://localhost:9200/_cat/plugins?v</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>安装或卸载插件后，需要重启Elasticsearch服务</p>\n</li>\n</ul>\n<h2 id=\"analysis-ik-中文分词插件的使用\"><code>analysis-ik</code> 中文分词插件的使用</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>测试分词效果</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#ES的默认分词器是standard，会单字拆分</span></span><br><span class=\"line\">POST _analyze</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;analyzer&quot;</span>: <span class=\"string\">&quot;standard&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;text&quot;</span>: <span class=\"string\">&quot;中华人民共和国&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#analysis-ik的ik_smart分词器:会做最粗粒度的拆</span></span><br><span class=\"line\">POST _analyze</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;analyzer&quot;</span>: <span class=\"string\">&quot;ik_smart&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;text&quot;</span>: <span class=\"string\">&quot;中华人民共和国&quot;</span></span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#analysis-ik的ik_max_word分词器:会将文本做最细粒度的拆分</span></span><br><span class=\"line\">POST _analyze</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;analyzer&quot;</span>: <span class=\"string\">&quot;ik_max_word&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;text&quot;</span>: <span class=\"string\">&quot;中华人民共和国&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>配置索引的分词器</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 创建索引，并指定默认分词器为ik_max_word</span></span><br><span class=\"line\">PUT /test_index</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;settings&quot;</span> : &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;index&quot;</span> : &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;analysis.analyzer.default.type&quot;</span>: <span class=\"string\">&quot;ik_max_word&quot;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\"># 查看索引setting信息</span></span><br><span class=\"line\">GET /test_index/_settings</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>配置索引字段的分词器</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#创建索引</span></span><br><span class=\"line\">PUT /index</span><br><span class=\"line\"><span class=\"comment\"># 指定content字段使用ik分词器</span></span><br><span class=\"line\">POST /index/_mapping</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;properties&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;content&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;type&quot;</span>: <span class=\"string\">&quot;text&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;analyzer&quot;</span>: <span class=\"string\">&quot;ik_max_word&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;search_analyzer&quot;</span>: <span class=\"string\">&quot;ik_smart&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#索引文档，也就是插入文档</span></span><br><span class=\"line\">POST /index/_create/1</span><br><span class=\"line\">&#123;<span class=\"string\">&quot;content&quot;</span>:<span class=\"string\">&quot;美国留给伊拉克的是个烂摊子吗&quot;</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST /index/_create/2</span><br><span class=\"line\">&#123;<span class=\"string\">&quot;content&quot;</span>:<span class=\"string\">&quot;公安部：各地校车将享最高路权&quot;</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST /index/_create/3</span><br><span class=\"line\">&#123;<span class=\"string\">&quot;content&quot;</span>:<span class=\"string\">&quot;中韩渔警冲突调查：韩警平均每天扣1艘中国渔船&quot;</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST /index/_create/4</span><br><span class=\"line\">&#123;<span class=\"string\">&quot;content&quot;</span>:<span class=\"string\">&quot;中国驻洛杉矶领事馆遭亚裔男子枪击 嫌犯已自首&quot;</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#带高亮的查询</span></span><br><span class=\"line\">POST /index/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;query&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;match&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;content&quot;</span>: <span class=\"string\">&quot;中国&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;highlight&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;pre_tags&quot;</span>: [</span><br><span class=\"line\">      <span class=\"string\">&quot;&lt;tag1&gt;&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;&lt;tag2&gt;&quot;</span></span><br><span class=\"line\">    ],</span><br><span class=\"line\">    <span class=\"string\">&quot;post_tags&quot;</span>: [</span><br><span class=\"line\">      <span class=\"string\">&quot;&lt;/tag1&gt;&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;&lt;/tag2&gt;&quot;</span></span><br><span class=\"line\">    ],</span><br><span class=\"line\">    <span class=\"string\">&quot;fields&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;content&quot;</span>: &#123;&#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n","content_text":"摘要 本文介绍如何在linux为Elasticsearch安装插件 Elasticsearch版本8.17.3 安装Elasticsearch核心库插件 以安装 analysis-icu 这个分词插件为例 123# 进入Elasticsearch安装目录，插件的安装路径在 plugins 目录下# 安装插件bin/elasticsearch-plugin install analysis-icu 安装或卸载插件后，需要重启Elasticsearch服务 安装其它来源的插件 以安装 analysis-ik 这个中文分词插件为例 从https://release.infinilabs.com/analysis-ik/stable/找到对应版本的插件连接，这里以8.17.3为例 12345678910# 1.基于url安装插件bin/elasticsearch-plugin install https://release.infinilabs.com/analysis-ik/stable/elasticsearch-analysis-ik-8.17.3.zip# 2.基于本地文件安装插件，我们可以先将插件下载的本地目录wget https://release.infinilabs.com/analysis-ik/stable/elasticsearch-analysis-ik-8.17.3.zip -P /tmp/bin/elasticsearch-plugin install file:///tmp/elasticsearch-analysis-ik-8.17.3.zip# 3.可以将下载好的包解压到plugins目录下，然后重启Elasticsearch服务mkdir /usr/local/elasticsearch/elasticsearch-8.17.3/plugins/analysis-ikunzip elasticsearch-analysis-ik-8.17.3.zip -d /usr/local/elasticsearch/elasticsearch-8.17.3/plugins/analysis-ik 查看和卸载插件 1234567# 列出所有插件bin/elasticsearch-plugin list# 卸载插件bin/elasticsearch-plugin remove analysis-ik# 通过curl命令查看插件信息curl -u elastic:123456 -k https://localhost:9200/_cat/plugins?v 安装或卸载插件后，需要重启Elasticsearch服务 analysis-ik 中文分词插件的使用 测试分词效果 1234567891011121314151617181920#ES的默认分词器是standard，会单字拆分POST _analyze&#123; &quot;analyzer&quot;: &quot;standard&quot;, &quot;text&quot;: &quot;中华人民共和国&quot;&#125;#analysis-ik的ik_smart分词器:会做最粗粒度的拆POST _analyze&#123; &quot;analyzer&quot;: &quot;ik_smart&quot;, &quot;text&quot;: &quot;中华人民共和国&quot; &#125;#analysis-ik的ik_max_word分词器:会将文本做最细粒度的拆分POST _analyze&#123; &quot;analyzer&quot;: &quot;ik_max_word&quot;, &quot;text&quot;: &quot;中华人民共和国&quot;&#125; 配置索引的分词器 1234567891011# 创建索引，并指定默认分词器为ik_max_wordPUT /test_index&#123; &quot;settings&quot; : &#123; &quot;index&quot; : &#123; &quot;analysis.analyzer.default.type&quot;: &quot;ik_max_word&quot; &#125; &#125;&#125;# 查看索引setting信息GET /test_index/_settings 配置索引字段的分词器 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849#创建索引PUT /index# 指定content字段使用ik分词器POST /index/_mapping&#123; &quot;properties&quot;: &#123; &quot;content&quot;: &#123; &quot;type&quot;: &quot;text&quot;, &quot;analyzer&quot;: &quot;ik_max_word&quot;, &quot;search_analyzer&quot;: &quot;ik_smart&quot; &#125; &#125;&#125;#索引文档，也就是插入文档POST /index/_create/1&#123;&quot;content&quot;:&quot;美国留给伊拉克的是个烂摊子吗&quot;&#125;POST /index/_create/2&#123;&quot;content&quot;:&quot;公安部：各地校车将享最高路权&quot;&#125;POST /index/_create/3&#123;&quot;content&quot;:&quot;中韩渔警冲突调查：韩警平均每天扣1艘中国渔船&quot;&#125;POST /index/_create/4&#123;&quot;content&quot;:&quot;中国驻洛杉矶领事馆遭亚裔男子枪击 嫌犯已自首&quot;&#125;#带高亮的查询POST /index/_search&#123; &quot;query&quot;: &#123; &quot;match&quot;: &#123; &quot;content&quot;: &quot;中国&quot; &#125; &#125;, &quot;highlight&quot;: &#123; &quot;pre_tags&quot;: [ &quot;&lt;tag1&gt;&quot;, &quot;&lt;tag2&gt;&quot; ], &quot;post_tags&quot;: [ &quot;&lt;/tag1&gt;&quot;, &quot;&lt;/tag2&gt;&quot; ], &quot;fields&quot;: &#123; &quot;content&quot;: &#123;&#125; &#125; &#125;&#125;","summary":"摘要 本文介绍如何在linux为Elasticsearch安装插件 Elasticsearch版本8.17.3","date_published":"2025-03-25T13:30:05.000Z","tags":["技术","elastic","elasticsearch","elasticsearch"]},{"id":"https://blog.hanqunfeng.com/2025/03/24/elasticsearch-02-install-cluster/","url":"https://blog.hanqunfeng.com/2025/03/24/elasticsearch-02-install-cluster/","title":"linux下安装Elasticsearch集群","content_html":"<!--\n **加粗**\n *斜体*\n ***加粗并斜体***\n ~~删除线~~\n ==突出显示==\n `突出显示(推荐)`\n ++下划线++\n ~下标~\n ^上标^\n 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.\n 图片设置宽度和高度(通过uPic上传后，需要将upic修改过为blog，用于添加水印) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)\n\n +++ **点击折叠**\n 这是被隐藏的内容\n +++\n\n::: tips success warning danger\n这里是容器内的内容\n:::\n\n% note info % success warning danger\n这里是容器内的内容\n% endnote %\n\n引用本地其它文章连接{}\n 大括号开始% post_link 文件名称(不包含.md) %大括号结束\n -->\n<h2 id=\"摘要\">摘要</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>本文介绍如何在linux下安装Elasticsearch集群(三节点)</p>\n</li>\n<li class=\"lvl-2\">\n<p>Elasticsearch版本8.17.3</p>\n</li>\n<li class=\"lvl-2\">\n<p>单节点安装参考<a href=\"/2025/03/20/elasticsearch-01-install/\" title=\"linux下安装Elasticsearch\">linux下安装Elasticsearch</a>，本文在此基础上完成集群安装</p>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"集群安装\">集群安装</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>三个节点分别安照单节点的安装方式完成下载，用户配置，环境变量配置，系统参数配置，等等。</p>\n</li>\n<li class=\"lvl-2\">\n<p>任选一个节点作为集群的master节点，我们命名为<code>node-1</code>，其它节点命名为<code>node-2</code>和<code>node-3</code></p>\n</li>\n<li class=\"lvl-2\">\n<p>先配置<code>node-1</code>节点的配置文件</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 集群名称</span></span><br><span class=\"line\">cluster.name: test-elk</span><br><span class=\"line\"><span class=\"comment\"># 节点名称</span></span><br><span class=\"line\">node.name: node-1</span><br><span class=\"line\"><span class=\"comment\"># 数据存储路径，默认值 $ES_HOME/data</span></span><br><span class=\"line\">path.data: /usr/local/elasticsearch/data</span><br><span class=\"line\"><span class=\"comment\"># 日志存储路径，默认值 $ES_HOME/logs</span></span><br><span class=\"line\">path.logs: /usr/local/elasticsearch/logs</span><br><span class=\"line\"><span class=\"comment\"># 配置ES启动时是否进行内存锁定检查，默认值true，本机内存比较小时设置为false</span></span><br><span class=\"line\">bootstrap.memory_lock: <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"comment\"># 允许通过任何地址访问，开启远程访问</span></span><br><span class=\"line\">network.host: 0.0.0.0</span><br><span class=\"line\"><span class=\"comment\"># 配置当前ES节点对外提供服务的http端口，默认 9200</span></span><br><span class=\"line\">http.port: 9200</span><br><span class=\"line\"><span class=\"comment\"># 配置当前ES节点对外提供服务的tcp端口，默认 9300</span></span><br><span class=\"line\">transport.port: 9300</span><br><span class=\"line\"><span class=\"comment\"># 集群内的主机列表，开启安全认证时无需配置，注意这里不要进行配置</span></span><br><span class=\"line\"><span class=\"comment\"># discovery.seed_hosts: [&quot;127.0.0.1&quot;]</span></span><br><span class=\"line\"><span class=\"comment\"># 第一次启动时需要参与选主的节点名称，这里只配置node-1</span></span><br><span class=\"line\">cluster.initial_master_nodes: [<span class=\"string\">&quot;node-1&quot;</span>]</span><br><span class=\"line\"><span class=\"comment\">#解决跨域问题</span></span><br><span class=\"line\">http.cors.enabled: <span class=\"literal\">true</span></span><br><span class=\"line\">http.cors.allow-origin: <span class=\"string\">&quot;*&quot;</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>配置<code>node-2</code>节点的配置文件</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 集群名称</span></span><br><span class=\"line\">cluster.name: test-elk</span><br><span class=\"line\"><span class=\"comment\"># 节点名称</span></span><br><span class=\"line\">node.name: node-2</span><br><span class=\"line\"><span class=\"comment\"># 数据存储路径，默认值 $ES_HOME/data</span></span><br><span class=\"line\">path.data: /usr/local/elasticsearch/data</span><br><span class=\"line\"><span class=\"comment\"># 日志存储路径，默认值 $ES_HOME/logs</span></span><br><span class=\"line\">path.logs: /usr/local/elasticsearch/logs</span><br><span class=\"line\"><span class=\"comment\"># 配置ES启动时是否进行内存锁定检查，默认值true，本机内存比较小时设置为false</span></span><br><span class=\"line\">bootstrap.memory_lock: <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"comment\"># 允许通过任何地址访问，开启远程访问</span></span><br><span class=\"line\">network.host: 0.0.0.0</span><br><span class=\"line\"><span class=\"comment\"># 配置当前ES节点对外提供服务的http端口，默认 9200</span></span><br><span class=\"line\">http.port: 9200</span><br><span class=\"line\"><span class=\"comment\"># 配置当前ES节点对外提供服务的tcp端口，默认 9300</span></span><br><span class=\"line\">transport.port: 9300</span><br><span class=\"line\"><span class=\"comment\">#解决跨域问题</span></span><br><span class=\"line\">http.cors.enabled: <span class=\"literal\">true</span></span><br><span class=\"line\">http.cors.allow-origin: <span class=\"string\">&quot;*&quot;</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>配置<code>node-3</code>节点的配置文件</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 集群名称</span></span><br><span class=\"line\">cluster.name: test-elk</span><br><span class=\"line\"><span class=\"comment\"># 节点名称</span></span><br><span class=\"line\">node.name: node-3</span><br><span class=\"line\"><span class=\"comment\"># 数据存储路径，默认值 $ES_HOME/data</span></span><br><span class=\"line\">path.data: /usr/local/elasticsearch/data</span><br><span class=\"line\"><span class=\"comment\"># 日志存储路径，默认值 $ES_HOME/logs</span></span><br><span class=\"line\">path.logs: /usr/local/elasticsearch/logs</span><br><span class=\"line\"><span class=\"comment\"># 配置ES启动时是否进行内存锁定检查，默认值true，本机内存比较小时设置为false</span></span><br><span class=\"line\">bootstrap.memory_lock: <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"comment\"># 允许通过任何地址访问，开启远程访问</span></span><br><span class=\"line\">network.host: 0.0.0.0</span><br><span class=\"line\"><span class=\"comment\"># 配置当前ES节点对外提供服务的http端口，默认 9200</span></span><br><span class=\"line\">http.port: 9200</span><br><span class=\"line\"><span class=\"comment\"># 配置当前ES节点对外提供服务的tcp端口，默认 9300</span></span><br><span class=\"line\">transport.port: 9300</span><br><span class=\"line\"><span class=\"comment\">#解决跨域问题</span></span><br><span class=\"line\">http.cors.enabled: <span class=\"literal\">true</span></span><br><span class=\"line\">http.cors.allow-origin: <span class=\"string\">&quot;*&quot;</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>启动<code>node-1</code>，启动成功后我们会在日志中看到如下安全认证信息信息，记录其中的加入集群的节点的token信息</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span><br><span class=\"line\"><span class=\"comment\"># 这些日志信息提供了 Elasticsearch 8 在首次启动时自动配置的安全特性、生成的默认密码、证书指纹以及如何配置 Kibana 和其他节点加入集群的详细说明。</span></span><br><span class=\"line\">✅ Elasticsearch security features have been automatically configured!</span><br><span class=\"line\">✅ Authentication is enabled and cluster connections are encrypted.</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 这是 elastic 用户的默认密码。系统建议你使用 bin/elasticsearch-reset-password -u elastic 命令来重置此密码。</span></span><br><span class=\"line\">ℹ️  Password <span class=\"keyword\">for</span> the elastic user (reset with `bin/elasticsearch-reset-password -u elastic`):</span><br><span class=\"line\">  BNb=*qz6_M*mXL9uZiSP <span class=\"comment\"># 这里会打印出ES自动生成的密码</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 这是 HTTP CA 证书的 SHA-256 指纹。CA 证书用于验证 HTTPS 连接的身份。</span></span><br><span class=\"line\">ℹ️  HTTP CA certificate SHA-256 fingerprint:</span><br><span class=\"line\">  3f141c16dfc6e165894bc1672084b220dcdd22ffe02116d51ac18003cfaa5a1d</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 提供了将 Kibana 配置为使用此 Elasticsearch 集群的步骤。</span></span><br><span class=\"line\">ℹ️  Configure Kibana to use this cluster:</span><br><span class=\"line\"><span class=\"comment\"># 启动 Kibana 并按照终端中显示的配置链接进行操作。</span></span><br><span class=\"line\">• Run Kibana and click the configuration <span class=\"built_in\">link</span> <span class=\"keyword\">in</span> the terminal when Kibana starts.</span><br><span class=\"line\"><span class=\"comment\"># 复制提供的注册令牌，并在浏览器中打开 Kibana 时粘贴此令牌。令牌在接下来的 30 分钟内有效。</span></span><br><span class=\"line\"><span class=\"comment\"># 补充说明：生成新的kibana注册令牌：bin/elasticsearch-create-enrollment-token -s kibana</span></span><br><span class=\"line\">• Copy the following enrollment token and <span class=\"built_in\">paste</span> it into Kibana <span class=\"keyword\">in</span> your browser (valid <span class=\"keyword\">for</span> the next 30 minutes):</span><br><span class=\"line\">  eyJ2ZXIiOiI4LjE0LjAiLCJhZHIiOlsiMTAuMjUwLjAuMjM5OjkyMDAiXSwiZmdyIjoiM2YxNDFjMTZkZmM2ZTE2NTg5NGJjMTY3MjA4NGIyMjBkY2RkMjJmZmUwMjExNmQ1MWFjMTgwMDNjZmFhNWExZCIsImtleSI6ImFSWFBzcFVCTVVmc1d5aUJnbjBtOmRzbVBLQV95UXhDZkJpXzQyWDNEMVEifQ==</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 提供了将新的 Elasticsearch 节点加入现有集群的步骤。</span></span><br><span class=\"line\">ℹ️ Configure other nodes to <span class=\"built_in\">join</span> this cluster:</span><br><span class=\"line\"><span class=\"comment\"># 使用 bin/elasticsearch --enrollment-token &lt;token&gt; 命令启动新的 Elasticsearch 节点。令牌在接下来的 30 分钟内有效。</span></span><br><span class=\"line\"><span class=\"comment\"># 补充说明：生成新的节点注册令牌：bin/elasticsearch-create-enrollment-token -s node</span></span><br><span class=\"line\">• Copy the following enrollment token and start new Elasticsearch nodes with `bin/elasticsearch --enrollment-token &lt;token&gt;` (valid <span class=\"keyword\">for</span> the next 30 minutes):</span><br><span class=\"line\">  eyJ2ZXIiOiI4LjE0LjAiLCJhZHIiOlsiMTAuMjUwLjAuMjM5OjkyMDAiXSwiZmdyIjoiM2YxNDFjMTZkZmM2ZTE2NTg5NGJjMTY3MjA4NGIyMjBkY2RkMjJmZmUwMjExNmQ1MWFjMTgwMDNjZmFhNWExZCIsImtleSI6ImF4WFBzcFVCTVVmc1d5aUJnbjFtOkFEallPdnpzUzh1MGJqOFpfVFE4a3cifQ==</span><br><span class=\"line\"><span class=\"comment\"># 如果你在 Docker 中运行 Elasticsearch，可以使用 docker run -e &quot;ENROLLMENT_TOKEN=&lt;token&gt;&quot; docker.elastic.co/elasticsearch/elasticsearch:8.17.3 命令启动新节点。</span></span><br><span class=\"line\">  If you<span class=\"string\">&#x27;re running in Docker, copy the enrollment token and run:</span></span><br><span class=\"line\"><span class=\"string\">  `docker run -e &quot;ENROLLMENT_TOKEN=&lt;token&gt;&quot; docker.elastic.co/elasticsearch/elasticsearch:8.17.3`</span></span><br><span class=\"line\"><span class=\"string\">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>token信息有效时间只有30分钟，超时后可以使用如下命令重新生成新的token</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 进入node-1节点的ES安装目录，此命令会生成新的节点注册令牌</span></span><br><span class=\"line\">bin/elasticsearch-create-enrollment-token -s node</span><br><span class=\"line\">eyJ2ZXIiOiI4LjE0LjAiLCJhZHIiOlsiMTAuMjUwLjAuMjM5OjkyMDAiXSwiZmdyIjoiM2YxNDFjMTZkZmM2ZTE2NTg5NGJjMTY3MjA4NGIyMjBkY2RkMjJmZmUwMjExNmQ1MWFjMTgwMDNjZmFhNWExZCIsImtleSI6IlpoRVZ4NVVCeXRPajdLeTBqb3BvOmdHRW44ZW5mU0RDZHA2Yy1uSDF4eGcifQ==</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>启动<code>node-2</code>节点，启动时要带上token信息，<code>node-3</code>与此一样。这里要注意，只有第一次加入集群时启动才需要带上注册令牌，后续启动不需要token信息</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 进入node-2节点的ES安装目录，此命令会启动ES节点，并加入到集群中</span></span><br><span class=\"line\"><span class=\"comment\"># bin/elasticsearch --enrollment-token &lt;token&gt;</span></span><br><span class=\"line\">bin/elasticsearch --enrollment-token eyJ2ZXIiOiI4LjE0LjAiLCJhZHIiOlsiMTAuMjUwLjAuMjM5OjkyMDAiXSwiZmdyIjoiM2YxNDFjMTZkZmM2ZTE2NTg5NGJjMTY3MjA4NGIyMjBkY2RkMjJmZmUwMjExNmQ1MWFjMTgwMDNjZmFhNWExZCIsImtleSI6IlpoRVZ4NVVCeXRPajdLeTBqb3BvOmdHRW44ZW5mU0RDZHA2Yy1uSDF4eGcifQ==</span><br></pre></td></tr></table></figure>\n<div class=\"tips\">\n<p><em><strong>加入集群失败</strong></em></p>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">在执行<code>bin/elasticsearch --enrollment-token &lt;token&gt;</code>时有可能会遇到如下异常：</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ERROR: Aborting auto configuration because the node keystore contains password settings already, with <span class=\"built_in\">exit</span> code 78</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">这通常意味着节点的 <code>keystore</code> 已经包含了密码设置，因此自动配置过程被中止。</li>\n<li class=\"lvl-2\">产生这种错误的原因大概率是当前ES是从已经安装好的服务器上拷贝过来的，而不是全新安装的，此时我们除了需要清空<code>data</code>目录外，还需要删除 <code>keystore</code> 中的密码</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看keystore中的密码</span></span><br><span class=\"line\">$ bin/elasticsearch-keystore list</span><br><span class=\"line\">keystore.seed</span><br><span class=\"line\">xpack.security.http.ssl.keystore.secure_password</span><br><span class=\"line\">xpack.security.transport.ssl.keystore.secure_password</span><br><span class=\"line\">xpack.security.transport.ssl.truststore.secure_password</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 删除keystore中的密码</span></span><br><span class=\"line\">$ bin/elasticsearch-keystore remove xpack.security.http.ssl.keystore.secure_password</span><br><span class=\"line\">$ bin/elasticsearch-keystore remove xpack.security.transport.ssl.keystore.secure_password</span><br><span class=\"line\">$ bin/elasticsearch-keystore remove xpack.security.transport.ssl.truststore.secure_password</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">\n<p>再次执行<code>bin/elasticsearch --enrollment-token &lt;token&gt;</code>即可。</p>\n</li>\n<li class=\"lvl-2\">\n<p>另外还可能遇到如下报错：</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ERROR: Aborting enrolling to cluster. Could not communicate with the node on any of the addresses from the enrollment token. All of [10.250.0.239:9200] were attempted., with <span class=\"built_in\">exit</span> code 69</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">这是由于token过期了，重新生成新的token即可</li>\n</ul>\n</div>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>启动成功后会在<code>node-2</code>的配置文件中看到如下配置信息</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#----------------------- BEGIN SECURITY AUTO CONFIGURATION -----------------------</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"comment\"># The following settings, TLS certificates, and keys have been automatically</span></span><br><span class=\"line\"><span class=\"comment\"># generated to configure Elasticsearch security features on 24-03-2025 07:45:11</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"comment\"># --------------------------------------------------------------------------------</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Enable security features</span></span><br><span class=\"line\">xpack.security.enabled: <span class=\"literal\">true</span></span><br><span class=\"line\"></span><br><span class=\"line\">xpack.security.enrollment.enabled: <span class=\"literal\">true</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Enable encryption for HTTP API client connections, such as Kibana, Logstash, and Agents</span></span><br><span class=\"line\">xpack.security.http.ssl:</span><br><span class=\"line\">  enabled: <span class=\"literal\">true</span></span><br><span class=\"line\">  keystore.path: certs/http.p12</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Enable encryption and mutual authentication between cluster nodes</span></span><br><span class=\"line\">xpack.security.transport.ssl:</span><br><span class=\"line\">  enabled: <span class=\"literal\">true</span></span><br><span class=\"line\">  verification_mode: certificate</span><br><span class=\"line\">  keystore.path: certs/transport.p12</span><br><span class=\"line\">  truststore.path: certs/transport.p12</span><br><span class=\"line\"><span class=\"comment\"># Discover existing nodes in the cluster</span></span><br><span class=\"line\">discovery.seed_hosts: [<span class=\"string\">&quot;10.250.0.239:9300&quot;</span>] <span class=\"comment\"># 这里是node-1节点的IP地址和端口号</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## 而node-3这里会显示如下信息，也就是越是后来加入进来的，这里就会加上之前所有节点的IP地址和端口号</span></span><br><span class=\"line\">discovery.seed_hosts: [<span class=\"string\">&quot;10.250.0.239:9300&quot;</span>, <span class=\"string\">&quot;10.250.0.17:9300&quot;</span>] <span class=\"comment\"># 这里是node-1和node-2节点的IP地址和端口号</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#----------------------- END SECURITY AUTO CONFIGURATION -------------------------</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"验证集群状态\">验证集群状态</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>启动完成后，可以通过如下命令查看集群状态：</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看集群状态</span></span><br><span class=\"line\">$ curl -u elastic:123456 --cacert /usr/local/elasticsearch/elasticsearch-8.17.3/config/certs/http_ca.crt  https://127.0.0.1:9200/_cluster/health?pretty</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;cluster_name&quot;</span> : <span class=\"string\">&quot;test-elk&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;status&quot;</span> : <span class=\"string\">&quot;green&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;timed_out&quot;</span> : <span class=\"literal\">false</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;number_of_nodes&quot;</span> : 3,</span><br><span class=\"line\">  <span class=\"string\">&quot;number_of_data_nodes&quot;</span> : 3,</span><br><span class=\"line\">  <span class=\"string\">&quot;active_primary_shards&quot;</span> : 31,</span><br><span class=\"line\">  <span class=\"string\">&quot;active_shards&quot;</span> : 62,</span><br><span class=\"line\">  <span class=\"string\">&quot;relocating_shards&quot;</span> : 0,</span><br><span class=\"line\">  <span class=\"string\">&quot;initializing_shards&quot;</span> : 0,</span><br><span class=\"line\">  <span class=\"string\">&quot;unassigned_shards&quot;</span> : 0,</span><br><span class=\"line\">  <span class=\"string\">&quot;unassigned_primary_shards&quot;</span> : 0,</span><br><span class=\"line\">  <span class=\"string\">&quot;delayed_unassigned_shards&quot;</span> : 0,</span><br><span class=\"line\">  <span class=\"string\">&quot;number_of_pending_tasks&quot;</span> : 0,</span><br><span class=\"line\">  <span class=\"string\">&quot;number_of_in_flight_fetch&quot;</span> : 0,</span><br><span class=\"line\">  <span class=\"string\">&quot;task_max_waiting_in_queue_millis&quot;</span> : 0,</span><br><span class=\"line\">  <span class=\"string\">&quot;active_shards_percent_as_number&quot;</span> : 100.0</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\"># 查看节点信息，其中 * 表示当前节点为master节点</span></span><br><span class=\"line\">$ curl -u elastic:123456 --cacert /usr/local/elasticsearch/elasticsearch-8.17.3/config/certs/http_ca.crt  https://127.0.0.1:9200/_cat/nodes?v</span><br><span class=\"line\">ip           heap.percent ram.percent cpu load_1m load_5m load_15m node.role   master name</span><br><span class=\"line\">10.250.0.17             8          63  28    1.03    0.38     0.14 cdfhilmrstw -      node-2</span><br><span class=\"line\">10.250.0.173            9          63  22    0.86    0.37     0.19 cdfhilmrstw -      node-3</span><br><span class=\"line\">10.250.0.239            9          78   6    0.38    0.22     0.16 cdfhilmrstw *      node-1</span><br></pre></td></tr></table></figure>\n<h2 id=\"重要说明\">重要说明</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>集群一旦创建完成，则至少需要两个节点运行才能保证集群可用性，否则集群将无法运行。</p>\n</li>\n<li class=\"lvl-2\">\n<p>如果<code>node-1</code>节点挂了，集群中剩下的两个节点会重新选择一个新的<code>master</code>节点，不会影响集群的可用性。</p>\n</li>\n<li class=\"lvl-2\">\n<p>一旦关闭<code>node-1</code>，则重新启动<code>node-1</code>节点前要修改其配置文件，否则无法启动成功。</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 注释掉该配置</span></span><br><span class=\"line\"><span class=\"comment\"># cluster.initial_master_nodes: [&quot;node-1&quot;]</span></span><br><span class=\"line\"><span class=\"comment\"># 加入该配置，实际上最好在重启每个节点前，将每个节点都配置为这样</span></span><br><span class=\"line\">discovery.seed_hosts: [<span class=\"string\">&quot;10.250.0.239:9300&quot;</span>, <span class=\"string\">&quot;10.250.0.17:9300&quot;</span>, <span class=\"string\">&quot;10.250.0.173:9300&quot;</span>]</span><br></pre></td></tr></table></figure>\n<h2 id=\"Kibana关联ES集群\">Kibana关联ES集群</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Kibana 关联单节点ES参考 <a href=\"/2025/03/21/kibana-01-install/\" title=\"linux下安装Kibana\">linux下安装Kibana</a>，在此基础上对配置文件进行如下修改：</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 关联集群的节点地址，将集群内所有节点的地址都配置到该字段中</span></span><br><span class=\"line\">elasticsearch.hosts: [<span class=\"string\">&#x27;https://10.250.0.239:9200&#x27;</span>, <span class=\"string\">&#x27;https://10.250.0.173:9200&#x27;</span>, <span class=\"string\">&#x27;https://10.250.0.17:9200&#x27;</span>]</span><br><span class=\"line\"><span class=\"comment\"># 关联集群的输出地址，将集群内所有节点的地址都配置到该字段中</span></span><br><span class=\"line\">xpack.fleet.outputs: [&#123;<span class=\"built_in\">id</span>: fleet-default-output, name: default, is_default: <span class=\"literal\">true</span>, is_default_monitoring: <span class=\"literal\">true</span>, <span class=\"built_in\">type</span>: elasticsearch, hosts: [<span class=\"string\">&#x27;https://10.250.0.239:9200&#x27;</span>, <span class=\"string\">&#x27;https://10.250.0.173:9200&#x27;</span>, <span class=\"string\">&#x27;https://10.250.0.17:9200&#x27;</span>], ca_trusted_fingerprint: 3f141c16dfc6e165894bc1672084b220dcdd22ffe02116d51ac18003cfaa5a1d&#125;]</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>重启Kibana</p>\n</li>\n<li class=\"lvl-2\">\n<p>只要保证集群内至少有两个ES节点工作正常，即可正常访问Kibana</p>\n</li>\n</ul>\n<h2 id=\"nginx反向代理ES集群\">nginx反向代理ES集群</h2>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vim /etc/nginx/conf.d/es.conf <span class=\"comment\"># 添加如下内容</span></span><br><span class=\"line\">upstream es &#123;</span><br><span class=\"line\">    server 10.250.0.239:9200;</span><br><span class=\"line\">    server 10.250.0.173:9200;</span><br><span class=\"line\">    server 10.250.0.17:9200;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">        listen       8888;</span><br><span class=\"line\">        server_name  localhost es.domain;</span><br><span class=\"line\"></span><br><span class=\"line\">        location / &#123;</span><br><span class=\"line\">            proxy_pass https://es; <span class=\"comment\">#这个名称和要上面 upstream es 对应，注意这里是 https 协议</span></span><br><span class=\"line\">            proxy_redirect     default;</span><br><span class=\"line\">            proxy_http_version 1.1;</span><br><span class=\"line\"></span><br><span class=\"line\">            proxy_set_header   Host              <span class=\"variable\">$host</span>;</span><br><span class=\"line\">            proxy_set_header   X-Real-IP         <span class=\"variable\">$remote_addr</span>;</span><br><span class=\"line\">            proxy_set_header   X-Forwarded-For   <span class=\"variable\">$proxy_add_x_forwarded_for</span>;</span><br><span class=\"line\">            proxy_set_header   X-Forwarded-Proto <span class=\"variable\">$scheme</span>;</span><br><span class=\"line\">            proxy_max_temp_file_size 0;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">#this is the maximum upload size</span></span><br><span class=\"line\">            client_max_body_size       10m;</span><br><span class=\"line\">            client_body_buffer_size    128k;</span><br><span class=\"line\"></span><br><span class=\"line\">            proxy_connect_timeout      90;</span><br><span class=\"line\">            proxy_send_timeout         90;</span><br><span class=\"line\">            proxy_read_timeout         90;</span><br><span class=\"line\">            proxy_buffering            off;</span><br><span class=\"line\">            proxy_request_buffering    off; <span class=\"comment\"># Required for HTTP CLI commands</span></span><br><span class=\"line\">            proxy_set_header Connection <span class=\"string\">&quot;&quot;</span>; <span class=\"comment\"># Clear for keepalive</span></span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 重启nginx</span></span><br><span class=\"line\">systemctl restart nginx</span><br><span class=\"line\"><span class=\"comment\"># 访问ES集群</span></span><br><span class=\"line\">curl -u elastic:123456 http://127.0.0.1:8888/_cluster/health?pretty</span><br></pre></td></tr></table></figure>","content_text":"摘要 本文介绍如何在linux下安装Elasticsearch集群(三节点) Elasticsearch版本8.17.3 单节点安装参考linux下安装Elasticsearch，本文在此基础上完成集群安装 集群安装 三个节点分别安照单节点的安装方式完成下载，用户配置，环境变量配置，系统参数配置，等等。 任选一个节点作为集群的master节点，我们命名为node-1，其它节点命名为node-2和node-3 先配置node-1节点的配置文件 1234567891011121314151617181920212223# 集群名称cluster.name: test-elk# 节点名称node.name: node-1# 数据存储路径，默认值 $ES_HOME/datapath.data: /usr/local/elasticsearch/data# 日志存储路径，默认值 $ES_HOME/logspath.logs: /usr/local/elasticsearch/logs# 配置ES启动时是否进行内存锁定检查，默认值true，本机内存比较小时设置为falsebootstrap.memory_lock: false# 允许通过任何地址访问，开启远程访问network.host: 0.0.0.0# 配置当前ES节点对外提供服务的http端口，默认 9200http.port: 9200# 配置当前ES节点对外提供服务的tcp端口，默认 9300transport.port: 9300# 集群内的主机列表，开启安全认证时无需配置，注意这里不要进行配置# discovery.seed_hosts: [&quot;127.0.0.1&quot;]# 第一次启动时需要参与选主的节点名称，这里只配置node-1cluster.initial_master_nodes: [&quot;node-1&quot;]#解决跨域问题http.cors.enabled: truehttp.cors.allow-origin: &quot;*&quot; 配置node-2节点的配置文件 12345678910111213141516171819# 集群名称cluster.name: test-elk# 节点名称node.name: node-2# 数据存储路径，默认值 $ES_HOME/datapath.data: /usr/local/elasticsearch/data# 日志存储路径，默认值 $ES_HOME/logspath.logs: /usr/local/elasticsearch/logs# 配置ES启动时是否进行内存锁定检查，默认值true，本机内存比较小时设置为falsebootstrap.memory_lock: false# 允许通过任何地址访问，开启远程访问network.host: 0.0.0.0# 配置当前ES节点对外提供服务的http端口，默认 9200http.port: 9200# 配置当前ES节点对外提供服务的tcp端口，默认 9300transport.port: 9300#解决跨域问题http.cors.enabled: truehttp.cors.allow-origin: &quot;*&quot; 配置node-3节点的配置文件 12345678910111213141516171819# 集群名称cluster.name: test-elk# 节点名称node.name: node-3# 数据存储路径，默认值 $ES_HOME/datapath.data: /usr/local/elasticsearch/data# 日志存储路径，默认值 $ES_HOME/logspath.logs: /usr/local/elasticsearch/logs# 配置ES启动时是否进行内存锁定检查，默认值true，本机内存比较小时设置为falsebootstrap.memory_lock: false# 允许通过任何地址访问，开启远程访问network.host: 0.0.0.0# 配置当前ES节点对外提供服务的http端口，默认 9200http.port: 9200# 配置当前ES节点对外提供服务的tcp端口，默认 9300transport.port: 9300#解决跨域问题http.cors.enabled: truehttp.cors.allow-origin: &quot;*&quot; 启动node-1，启动成功后我们会在日志中看到如下安全认证信息信息，记录其中的加入集群的节点的token信息 1234567891011121314151617181920212223242526272829303132━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━# 这些日志信息提供了 Elasticsearch 8 在首次启动时自动配置的安全特性、生成的默认密码、证书指纹以及如何配置 Kibana 和其他节点加入集群的详细说明。✅ Elasticsearch security features have been automatically configured!✅ Authentication is enabled and cluster connections are encrypted.# 这是 elastic 用户的默认密码。系统建议你使用 bin/elasticsearch-reset-password -u elastic 命令来重置此密码。ℹ️ Password for the elastic user (reset with `bin/elasticsearch-reset-password -u elastic`): BNb=*qz6_M*mXL9uZiSP # 这里会打印出ES自动生成的密码# 这是 HTTP CA 证书的 SHA-256 指纹。CA 证书用于验证 HTTPS 连接的身份。ℹ️ HTTP CA certificate SHA-256 fingerprint: 3f141c16dfc6e165894bc1672084b220dcdd22ffe02116d51ac18003cfaa5a1d# 提供了将 Kibana 配置为使用此 Elasticsearch 集群的步骤。ℹ️ Configure Kibana to use this cluster:# 启动 Kibana 并按照终端中显示的配置链接进行操作。• Run Kibana and click the configuration link in the terminal when Kibana starts.# 复制提供的注册令牌，并在浏览器中打开 Kibana 时粘贴此令牌。令牌在接下来的 30 分钟内有效。# 补充说明：生成新的kibana注册令牌：bin/elasticsearch-create-enrollment-token -s kibana• Copy the following enrollment token and paste it into Kibana in your browser (valid for the next 30 minutes): eyJ2ZXIiOiI4LjE0LjAiLCJhZHIiOlsiMTAuMjUwLjAuMjM5OjkyMDAiXSwiZmdyIjoiM2YxNDFjMTZkZmM2ZTE2NTg5NGJjMTY3MjA4NGIyMjBkY2RkMjJmZmUwMjExNmQ1MWFjMTgwMDNjZmFhNWExZCIsImtleSI6ImFSWFBzcFVCTVVmc1d5aUJnbjBtOmRzbVBLQV95UXhDZkJpXzQyWDNEMVEifQ==# 提供了将新的 Elasticsearch 节点加入现有集群的步骤。ℹ️ Configure other nodes to join this cluster:# 使用 bin/elasticsearch --enrollment-token &lt;token&gt; 命令启动新的 Elasticsearch 节点。令牌在接下来的 30 分钟内有效。# 补充说明：生成新的节点注册令牌：bin/elasticsearch-create-enrollment-token -s node• Copy the following enrollment token and start new Elasticsearch nodes with `bin/elasticsearch --enrollment-token &lt;token&gt;` (valid for the next 30 minutes): eyJ2ZXIiOiI4LjE0LjAiLCJhZHIiOlsiMTAuMjUwLjAuMjM5OjkyMDAiXSwiZmdyIjoiM2YxNDFjMTZkZmM2ZTE2NTg5NGJjMTY3MjA4NGIyMjBkY2RkMjJmZmUwMjExNmQ1MWFjMTgwMDNjZmFhNWExZCIsImtleSI6ImF4WFBzcFVCTVVmc1d5aUJnbjFtOkFEallPdnpzUzh1MGJqOFpfVFE4a3cifQ==# 如果你在 Docker 中运行 Elasticsearch，可以使用 docker run -e &quot;ENROLLMENT_TOKEN=&lt;token&gt;&quot; docker.elastic.co/elasticsearch/elasticsearch:8.17.3 命令启动新节点。 If you&#x27;re running in Docker, copy the enrollment token and run: `docker run -e &quot;ENROLLMENT_TOKEN=&lt;token&gt;&quot; docker.elastic.co/elasticsearch/elasticsearch:8.17.3`━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ token信息有效时间只有30分钟，超时后可以使用如下命令重新生成新的token 123# 进入node-1节点的ES安装目录，此命令会生成新的节点注册令牌bin/elasticsearch-create-enrollment-token -s nodeeyJ2ZXIiOiI4LjE0LjAiLCJhZHIiOlsiMTAuMjUwLjAuMjM5OjkyMDAiXSwiZmdyIjoiM2YxNDFjMTZkZmM2ZTE2NTg5NGJjMTY3MjA4NGIyMjBkY2RkMjJmZmUwMjExNmQ1MWFjMTgwMDNjZmFhNWExZCIsImtleSI6IlpoRVZ4NVVCeXRPajdLeTBqb3BvOmdHRW44ZW5mU0RDZHA2Yy1uSDF4eGcifQ== 启动node-2节点，启动时要带上token信息，node-3与此一样。这里要注意，只有第一次加入集群时启动才需要带上注册令牌，后续启动不需要token信息 123# 进入node-2节点的ES安装目录，此命令会启动ES节点，并加入到集群中# bin/elasticsearch --enrollment-token &lt;token&gt;bin/elasticsearch --enrollment-token eyJ2ZXIiOiI4LjE0LjAiLCJhZHIiOlsiMTAuMjUwLjAuMjM5OjkyMDAiXSwiZmdyIjoiM2YxNDFjMTZkZmM2ZTE2NTg5NGJjMTY3MjA4NGIyMjBkY2RkMjJmZmUwMjExNmQ1MWFjMTgwMDNjZmFhNWExZCIsImtleSI6IlpoRVZ4NVVCeXRPajdLeTBqb3BvOmdHRW44ZW5mU0RDZHA2Yy1uSDF4eGcifQ== 加入集群失败 在执行bin/elasticsearch --enrollment-token &lt;token&gt;时有可能会遇到如下异常： 1ERROR: Aborting auto configuration because the node keystore contains password settings already, with exit code 78 这通常意味着节点的 keystore 已经包含了密码设置，因此自动配置过程被中止。 产生这种错误的原因大概率是当前ES是从已经安装好的服务器上拷贝过来的，而不是全新安装的，此时我们除了需要清空data目录外，还需要删除 keystore 中的密码 1234567891011# 查看keystore中的密码$ bin/elasticsearch-keystore listkeystore.seedxpack.security.http.ssl.keystore.secure_passwordxpack.security.transport.ssl.keystore.secure_passwordxpack.security.transport.ssl.truststore.secure_password# 删除keystore中的密码$ bin/elasticsearch-keystore remove xpack.security.http.ssl.keystore.secure_password$ bin/elasticsearch-keystore remove xpack.security.transport.ssl.keystore.secure_password$ bin/elasticsearch-keystore remove xpack.security.transport.ssl.truststore.secure_password 再次执行bin/elasticsearch --enrollment-token &lt;token&gt;即可。 另外还可能遇到如下报错： 1ERROR: Aborting enrolling to cluster. Could not communicate with the node on any of the addresses from the enrollment token. All of [10.250.0.239:9200] were attempted., with exit code 69 这是由于token过期了，重新生成新的token即可 启动成功后会在node-2的配置文件中看到如下配置信息 123456789101112131415161718192021222324252627282930#----------------------- BEGIN SECURITY AUTO CONFIGURATION -----------------------## The following settings, TLS certificates, and keys have been automatically# generated to configure Elasticsearch security features on 24-03-2025 07:45:11## --------------------------------------------------------------------------------# Enable security featuresxpack.security.enabled: truexpack.security.enrollment.enabled: true# Enable encryption for HTTP API client connections, such as Kibana, Logstash, and Agentsxpack.security.http.ssl: enabled: true keystore.path: certs/http.p12# Enable encryption and mutual authentication between cluster nodesxpack.security.transport.ssl: enabled: true verification_mode: certificate keystore.path: certs/transport.p12 truststore.path: certs/transport.p12# Discover existing nodes in the clusterdiscovery.seed_hosts: [&quot;10.250.0.239:9300&quot;] # 这里是node-1节点的IP地址和端口号## 而node-3这里会显示如下信息，也就是越是后来加入进来的，这里就会加上之前所有节点的IP地址和端口号discovery.seed_hosts: [&quot;10.250.0.239:9300&quot;, &quot;10.250.0.17:9300&quot;] # 这里是node-1和node-2节点的IP地址和端口号#----------------------- END SECURITY AUTO CONFIGURATION ------------------------- 验证集群状态 启动完成后，可以通过如下命令查看集群状态： 1234567891011121314151617181920212223242526# 查看集群状态$ curl -u elastic:123456 --cacert /usr/local/elasticsearch/elasticsearch-8.17.3/config/certs/http_ca.crt https://127.0.0.1:9200/_cluster/health?pretty&#123; &quot;cluster_name&quot; : &quot;test-elk&quot;, &quot;status&quot; : &quot;green&quot;, &quot;timed_out&quot; : false, &quot;number_of_nodes&quot; : 3, &quot;number_of_data_nodes&quot; : 3, &quot;active_primary_shards&quot; : 31, &quot;active_shards&quot; : 62, &quot;relocating_shards&quot; : 0, &quot;initializing_shards&quot; : 0, &quot;unassigned_shards&quot; : 0, &quot;unassigned_primary_shards&quot; : 0, &quot;delayed_unassigned_shards&quot; : 0, &quot;number_of_pending_tasks&quot; : 0, &quot;number_of_in_flight_fetch&quot; : 0, &quot;task_max_waiting_in_queue_millis&quot; : 0, &quot;active_shards_percent_as_number&quot; : 100.0&#125;# 查看节点信息，其中 * 表示当前节点为master节点$ curl -u elastic:123456 --cacert /usr/local/elasticsearch/elasticsearch-8.17.3/config/certs/http_ca.crt https://127.0.0.1:9200/_cat/nodes?vip heap.percent ram.percent cpu load_1m load_5m load_15m node.role master name10.250.0.17 8 63 28 1.03 0.38 0.14 cdfhilmrstw - node-210.250.0.173 9 63 22 0.86 0.37 0.19 cdfhilmrstw - node-310.250.0.239 9 78 6 0.38 0.22 0.16 cdfhilmrstw * node-1 重要说明 集群一旦创建完成，则至少需要两个节点运行才能保证集群可用性，否则集群将无法运行。 如果node-1节点挂了，集群中剩下的两个节点会重新选择一个新的master节点，不会影响集群的可用性。 一旦关闭node-1，则重新启动node-1节点前要修改其配置文件，否则无法启动成功。 1234# 注释掉该配置# cluster.initial_master_nodes: [&quot;node-1&quot;]# 加入该配置，实际上最好在重启每个节点前，将每个节点都配置为这样discovery.seed_hosts: [&quot;10.250.0.239:9300&quot;, &quot;10.250.0.17:9300&quot;, &quot;10.250.0.173:9300&quot;] Kibana关联ES集群 Kibana 关联单节点ES参考 linux下安装Kibana，在此基础上对配置文件进行如下修改： 1234# 关联集群的节点地址，将集群内所有节点的地址都配置到该字段中elasticsearch.hosts: [&#x27;https://10.250.0.239:9200&#x27;, &#x27;https://10.250.0.173:9200&#x27;, &#x27;https://10.250.0.17:9200&#x27;]# 关联集群的输出地址，将集群内所有节点的地址都配置到该字段中xpack.fleet.outputs: [&#123;id: fleet-default-output, name: default, is_default: true, is_default_monitoring: true, type: elasticsearch, hosts: [&#x27;https://10.250.0.239:9200&#x27;, &#x27;https://10.250.0.173:9200&#x27;, &#x27;https://10.250.0.17:9200&#x27;], ca_trusted_fingerprint: 3f141c16dfc6e165894bc1672084b220dcdd22ffe02116d51ac18003cfaa5a1d&#125;] 重启Kibana 只要保证集群内至少有两个ES节点工作正常，即可正常访问Kibana nginx反向代理ES集群 123456789101112131415161718192021222324252627282930313233343536373839vim /etc/nginx/conf.d/es.conf # 添加如下内容upstream es &#123; server 10.250.0.239:9200; server 10.250.0.173:9200; server 10.250.0.17:9200;&#125;server &#123; listen 8888; server_name localhost es.domain; location / &#123; proxy_pass https://es; #这个名称和要上面 upstream es 对应，注意这里是 https 协议 proxy_redirect default; proxy_http_version 1.1; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; proxy_max_temp_file_size 0; #this is the maximum upload size client_max_body_size 10m; client_body_buffer_size 128k; proxy_connect_timeout 90; proxy_send_timeout 90; proxy_read_timeout 90; proxy_buffering off; proxy_request_buffering off; # Required for HTTP CLI commands proxy_set_header Connection &quot;&quot;; # Clear for keepalive &#125;&#125;# 重启nginxsystemctl restart nginx# 访问ES集群curl -u elastic:123456 http://127.0.0.1:8888/_cluster/health?pretty","summary":"摘要 本文介绍如何在linux下安装Elasticsearch集群(三节点) Elasticsearch版本8.17.3 单节点安装参考linux下安装Elasticsearch，本文在此基础上完成集群安装","date_published":"2025-03-24T13:30:05.000Z","tags":["技术","elastic","elasticsearch","elasticsearch"]},{"id":"https://blog.hanqunfeng.com/2025/03/21/kibana-01-install/","url":"https://blog.hanqunfeng.com/2025/03/21/kibana-01-install/","title":"linux下安装Kibana","content_html":"<!--\n **加粗**\n *斜体*\n ***加粗并斜体***\n ~~删除线~~\n ==突出显示==\n `突出显示(推荐)`\n ++下划线++\n ~下标~\n ^上标^\n 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.\n 图片设置宽度和高度(通过uPic上传后，需要将upic修改过为blog，用于添加水印) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)\n\n +++ **点击折叠**\n 这是被隐藏的内容\n +++\n\n::: tips success warning danger\n这里是容器内的内容\n:::\n\n% note info % success warning danger\n这里是容器内的内容\n% endnote %\n\n引用本地其它文章连接{}\n 大括号开始% post_link 文件名称(不包含.md) %大括号结束\n -->\n<h2 id=\"摘要\">摘要</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>本文介绍如何在linux下安装Kibana</p>\n</li>\n<li class=\"lvl-2\">\n<p>Kibana版本8.17.3</p>\n</li>\n<li class=\"lvl-2\">\n<p>Elasticsearch版本8.17.3，<a href=\"/2025/03/20/elasticsearch-01-install/\" title=\"linux下安装Elasticsearch\">linux下安装Elasticsearch</a></p>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"下载\">下载</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>下载地址：<a href=\"https://www.elastic.co/cn/downloads/past-releases#kibana\">https://www.elastic.co/cn/downloads/past-releases#kibana</a></p>\n</li>\n<li class=\"lvl-2\">\n<p>选择对应的版本：这里选择当前的最新版<code>Kibana 8.17.3</code>，之后选择对应的操作系统<code>LINUX X86_64</code></p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget https://artifacts.elastic.co/downloads/kibana/kibana-8.17.3-linux-x86_64.tar.gz</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>下载完成后解压到<code>/usr/local/kibana</code>目录下，解压命令如下：</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">mkdir</span> /usr/local/kibana</span><br><span class=\"line\">tar -zxvf kibana-8.17.3-linux-x86_64.tar.gz -C /usr/local/kibana</span><br></pre></td></tr></table></figure>\n<h2 id=\"创建启动用户\">创建启动用户</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>elasticsearch和kibana都不能用root用户启动</p>\n</li>\n<li class=\"lvl-2\">\n<p>创建用户<code>elastic</code>，并设置密码，这一步我们在安装elasticsearch的时候已经配置过了，这里就不再赘述了</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">useradd elastic</span><br><span class=\"line\">passwd elastic</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>修改kibana安装目录的用户权限</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">chown</span> -R elastic:elastic /usr/local/kibana</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>切换到elastic用户下执行命令</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">su - elastic</span><br></pre></td></tr></table></figure>\n<h2 id=\"关联Kibana和Elasticsearch\">关联Kibana和Elasticsearch</h2>\n<h3 id=\"方法1：注册令牌Token关联-官方推荐\">方法1：注册令牌Token关联[官方推荐]</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>注意此方法要求<code>elasticsearch</code>必须开启安全认证，而且<code>xpack.security.http.ssl.enabled</code> 必须设置为 true</p>\n</li>\n<li class=\"lvl-2\">\n<p>配置启动文件，进入<code>/usr/local/kibana/kibana-8.17.3/config</code>目录，根据需要修改<code>kibana.yml</code>文件</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 端口，默认5601</span></span><br><span class=\"line\">server.port: 5601</span><br><span class=\"line\"><span class=\"comment\"># kibana服务器的ip，4个0表示任何一个网卡都可以访问，默认为localhost</span></span><br><span class=\"line\">server.host: <span class=\"string\">&quot;0.0.0.0&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># 中文，默认为 en</span></span><br><span class=\"line\">i18n.locale: <span class=\"string\">&quot;zh-CN&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># 配置https，默认值为 certificate</span></span><br><span class=\"line\">elasticsearch.ssl.verificationMode: <span class=\"string\">&#x27;certificate&#x27;</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>还记得我们第一次启动ES时日志信息中的有关kibana注册令牌的信息吗？那个令牌只有30分钟有效期，过期后可以进入elasticsearch安装目录，重新创建kibana注册令牌</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bin/elasticsearch-create-enrollment-token -s kibana</span><br><span class=\"line\"><span class=\"comment\"># 输出结果如下</span></span><br><span class=\"line\">eyJ2ZXIiOiI4LjE0LjAiLCJhZHIiOlsiMTAuMjUwLjAuMjM5OjkyMDAiXSwiZmdyIjoiM2YxNDFjMTZkZmM2ZTE2NTg5NGJjMTY3MjA4NGIyMjBkY2RkMjJmZmUwMjExNmQ1MWFjMTgwMDNjZmFhNWExZCIsImtleSI6ImxlTWh1SlVCcVJWQUw4WGFjMk1HOkVHYTYxcWlfVEotQWQ1Y3dQdXcyckEifQ==</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>进入kibana安装目录，通过下面的命令注册 Kibana</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># bin/kibana-setup --enrollment-token &lt;enrollment-token&gt;</span></span><br><span class=\"line\">bin/kibana-setup --enrollment-token eyJ2ZXIiOiI4LjE0LjAiLCJhZHIiOlsiMTAuMjUwLjAuMjM5OjkyMDAiXSwiZmdyIjoiM2YxNDFjMTZkZmM2ZTE2NTg5NGJjMTY3MjA4NGIyMjBkY2RkMjJmZmUwMjExNmQ1MWFjMTgwMDNjZmFhNWExZCIsImtleSI6ImxlTWh1SlVCcVJWQUw4WGFjMk1HOkVHYTYxcWlfVEotQWQ1Y3dQdXcyckEifQ==</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 注册成功会输出</span></span><br><span class=\"line\">✔ Kibana configured successfully.</span><br></pre></td></tr></table></figure>\n<div class=\"tips\">\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">\n<p>如果ES的<code>xpack.security.http.ssl.enabled</code> 设置为 false，注册Kibana时会报错，报错信息如下：</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">✖ Unable to connect to Elasticsearch with the provided enrollment token: Unable to connect to any of the provided hosts.</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">注册成功后会在<code>/usr/local/kibana/kibana-8.17.3/config/kibana.yml</code>文件中添加如下内容：</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># This section was automatically generated during setup.</span></span><br><span class=\"line\"><span class=\"comment\"># ES服务URL</span></span><br><span class=\"line\">elasticsearch.hosts: [<span class=\"string\">&#x27;https://10.250.0.239:9200&#x27;</span>] <span class=\"comment\"># 10.250.0.239是本机的内网IP</span></span><br><span class=\"line\"><span class=\"comment\"># 指定用于认证的服务账户令牌</span></span><br><span class=\"line\">elasticsearch.serviceAccountToken: AAEAAWVsYXN0aWMva2liYW5hL2Vucm9sbC1wcm9jZXNzLXRva2VuLTE3NDI1NTA5ODU0MTg6Z2lJUERGaG1TR3VNcC1sb0RyMnMydw</span><br><span class=\"line\"><span class=\"comment\"># 指定用来验证 Elasticsearch 服务器 SSL 证书的 CA 证书路径</span></span><br><span class=\"line\">elasticsearch.ssl.certificateAuthorities: [/usr/local/kibana/kibana-8.17.3/data/ca_1742550986498.crt]</span><br><span class=\"line\"><span class=\"comment\"># 配置 Fleet 的输出目标。Fleet 是 Elastic 的一个管理工具，用于管理和监控弹性栈（Elastic Stack）。这个配置定义了 Fleet 默认输出的目标，即 Elasticsearch。</span></span><br><span class=\"line\">xpack.fleet.outputs: [&#123;<span class=\"built_in\">id</span>: fleet-default-output, name: default, is_default: <span class=\"literal\">true</span>, is_default_monitoring: <span class=\"literal\">true</span>, <span class=\"built_in\">type</span>: elasticsearch, hosts: [<span class=\"string\">&#x27;https://10.250.0.239:9200&#x27;</span>], ca_trusted_fingerprint: 3f141c16dfc6e165894bc1672084b220dcdd22ffe02116d51ac18003cfaa5a1d&#125;]</span><br><span class=\"line\">  <span class=\"comment\"># id: fleet-default-output：输出的唯一标识符。</span></span><br><span class=\"line\">  <span class=\"comment\"># name: default：输出的名称。</span></span><br><span class=\"line\">  <span class=\"comment\"># is_default: true：表示这是默认输出。</span></span><br><span class=\"line\">  <span class=\"comment\"># is_default_monitoring: true：表示这是默认的监控输出。</span></span><br><span class=\"line\">  <span class=\"comment\"># type: elasticsearch：输出类型是 Elasticsearch。</span></span><br><span class=\"line\">  <span class=\"comment\"># hosts: [&#x27;https://10.250.0.239:9200&#x27;]：连接到的 Elasticsearch 主机地址。</span></span><br><span class=\"line\">  <span class=\"comment\"># ca_trusted_fingerprint: 3f141c16dfc6e165894bc1672084b220dcdd22ffe02116d51ac18003cfaa5a1d：CA 证书的信任指纹，用于验证 CA 证书的身份。</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"方法2：用户名密码关联\">方法2：用户名密码关联</h3>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">\n<p>创建kibana连接elasticsearch的用户密码，不能用 <code>elastic</code> 这个用户，因为这个是超级用户，要使用 kibana_system 用户</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 进入elasticsearch安装目录，执行下面的命令重置 kibana_system 用户的密码</span></span><br><span class=\"line\">bin/elasticsearch-reset-password -u kibana_system -i</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">\n<p>配置启动文件，进入<code>/usr/local/kibana/kibana-8.17.3/config</code>目录，修改<code>kibana.yml</code>文件</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 端口，默认5601</span></span><br><span class=\"line\">server.port: 5601</span><br><span class=\"line\"><span class=\"comment\"># kibana服务器的ip，4个0表示任何一个网卡都可以访问</span></span><br><span class=\"line\">server.host: <span class=\"string\">&quot;0.0.0.0&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># elasctisearch关联</span></span><br><span class=\"line\"><span class=\"comment\"># ES服务地址，注意这里是https</span></span><br><span class=\"line\">elasticsearch.hosts: [<span class=\"string\">&quot;https://10.250.0.239:9200&quot;</span>]</span><br><span class=\"line\"><span class=\"comment\"># 指定https证书路径，可以从ES的证书目录中获取</span></span><br><span class=\"line\">elasticsearch.ssl.certificateAuthorities: [<span class=\"string\">&quot;/usr/local/elasticsearch/elasticsearch-8.17.3/config/certs/http_ca.crt&quot;</span>]</span><br><span class=\"line\"><span class=\"comment\"># 用户名密码</span></span><br><span class=\"line\">elasticsearch.username: <span class=\"string\">&quot;kibana_system&quot;</span></span><br><span class=\"line\">elasticsearch.password: <span class=\"string\">&quot;123456&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># 中文</span></span><br><span class=\"line\">i18n.locale: <span class=\"string\">&quot;zh-CN&quot;</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">\n<p>如果ES没有开启安全认证，则只需要进行如下配置即可：</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 端口，默认5601</span></span><br><span class=\"line\">server.port: 5601</span><br><span class=\"line\"><span class=\"comment\"># kibana服务器的ip，4个0表示任何一个网卡都可以访问</span></span><br><span class=\"line\">server.host: <span class=\"string\">&quot;0.0.0.0&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># ES服务地址，注意这里是http</span></span><br><span class=\"line\">elasticsearch.hosts: [<span class=\"string\">&quot;http://10.250.0.239:9200&quot;</span>]</span><br><span class=\"line\"><span class=\"comment\"># 中文</span></span><br><span class=\"line\">i18n.locale: <span class=\"string\">&quot;zh-CN&quot;</span></span><br></pre></td></tr></table></figure>\n</div>\n<h2 id=\"启动Kibana服务\">启动Kibana服务</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>进入<code>/usr/local/kibana/kibana-8.17.3</code>目录，执行以下命令启动服务</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./bin/kibana</span><br><span class=\"line\"><span class=\"comment\"># 后台启动，并将日志写入到logs/kibana.log</span></span><br><span class=\"line\"><span class=\"built_in\">nohup</span> bin/kibana &gt; logs/kibana.log 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>访问地址：<a href=\"http://localhost:5601\">http://localhost:5601</a>，这里注意登录用户需要使用：<code>elastic</code>，而不是<code>kibana_system</code>。</p>\n</li>\n</ul>\n<h2 id=\"启动Kibana服务后的日志告警\">启动Kibana服务后的日志告警</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Kibana服务启动后，会在<code>/usr/local/kibana/kibana-8.17.3/logs/kibana.log</code>文件中记录一些错误日志，如果出现错误，可以查看日志，解决错误。</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[WARN ][plugins.fleet] xpack.encryptedSavedObjects.encryptionKey is not configured, private key passphrase is being stored <span class=\"keyword\">in</span> plain text</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>这个警告信息表明 Kibana 的某些插件（如 Fleet）在缺少 <code>xpack.encryptedSavedObjects.encryptionKey</code> 配置的情况下运行，导致私钥密码和代理卸载令牌以明文形式存储。为了提高安全性，建议配置一个加密密钥。</p>\n</li>\n<li class=\"lvl-2\">\n<p>生成加密密钥</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ bin/kibana-encryption-keys generate</span><br><span class=\"line\">Kibana is currently running with legacy OpenSSL providers enabled! For details and instructions on how to <span class=\"built_in\">disable</span> see https://www.elastic.co/guide/en/kibana/8.17/production.html#openssl-legacy-provider</span><br><span class=\"line\"><span class=\"comment\">## Kibana Encryption Key Generation Utility</span></span><br><span class=\"line\"></span><br><span class=\"line\">The <span class=\"string\">&#x27;generate&#x27;</span> <span class=\"built_in\">command</span> guides you through the process of setting encryption keys <span class=\"keyword\">for</span>:</span><br><span class=\"line\"></span><br><span class=\"line\">xpack.encryptedSavedObjects.encryptionKey</span><br><span class=\"line\">    Used to encrypt stored objects such as dashboards and visualizations</span><br><span class=\"line\">    https://www.elastic.co/guide/en/kibana/current/xpack-security-secure-saved-objects.html#xpack-security-secure-saved-objects</span><br><span class=\"line\"></span><br><span class=\"line\">xpack.reporting.encryptionKey</span><br><span class=\"line\">    Used to encrypt saved reports</span><br><span class=\"line\">    https://www.elastic.co/guide/en/kibana/current/reporting-settings-kb.html#general-reporting-settings</span><br><span class=\"line\"></span><br><span class=\"line\">xpack.security.encryptionKey</span><br><span class=\"line\">    Used to encrypt session information</span><br><span class=\"line\">    https://www.elastic.co/guide/en/kibana/current/security-settings-kb.html#security-session-and-cookie-settings</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">Already defined settings are ignored and can be regenerated using the --force flag.  Check the documentation links <span class=\"keyword\">for</span> instructions on how to rotate encryption keys.</span><br><span class=\"line\">Definitions should be <span class=\"built_in\">set</span> <span class=\"keyword\">in</span> the kibana.yml used configure Kibana.</span><br><span class=\"line\"></span><br><span class=\"line\">Settings:</span><br><span class=\"line\">xpack.encryptedSavedObjects.encryptionKey: 47967e4b78bd26decb622b78f0ddd324</span><br><span class=\"line\">xpack.reporting.encryptionKey: 78b5f603f3b0e6ad76c13a0f5d00cde0</span><br><span class=\"line\">xpack.security.encryptionKey: 8aa7f4dfbc4e734a2a9f92a2730b36af</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>配置 Kibana 以使用加密密钥，添加到 kibana.yml 文件中：</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">xpack.encryptedSavedObjects.encryptionKey: 47967e4b78bd26decb622b78f0ddd324</span><br><span class=\"line\">xpack.reporting.encryptionKey: 78b5f603f3b0e6ad76c13a0f5d00cde0</span><br><span class=\"line\">xpack.security.encryptionKey: 8aa7f4dfbc4e734a2a9f92a2730b36af</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>重启 Kibana 服务 以应用更改。</p>\n</li>\n</ul>\n<h2 id=\"Kibana-自启动脚本\">Kibana 自启动脚本</h2>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 创建服务文件</span></span><br><span class=\"line\">$ vim /usr/lib/systemd/system/kibana.service</span><br><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=kibana</span><br><span class=\"line\">Documentation=https://www.elastic.co</span><br><span class=\"line\">After=es.service</span><br><span class=\"line\"></span><br><span class=\"line\">[Service]</span><br><span class=\"line\">Type=simple</span><br><span class=\"line\">PrivateTmp=<span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"comment\"># 指定ES用户</span></span><br><span class=\"line\">User=elastic</span><br><span class=\"line\">Group=elastic</span><br><span class=\"line\">LimitNOFILE=100000</span><br><span class=\"line\">LimitNPROC=100000</span><br><span class=\"line\">Restart=<span class=\"built_in\">yes</span></span><br><span class=\"line\"><span class=\"comment\"># 启动命令</span></span><br><span class=\"line\">ExecStart=/usr/local/kibana/kibana-8.17.3/bin/kibana</span><br><span class=\"line\">ExecRestart=/bin/kill -s HUP <span class=\"variable\">$MAINPID</span></span><br><span class=\"line\">ExecStop=/bin/kill -s QUIT <span class=\"variable\">$MAINPID</span></span><br><span class=\"line\"></span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 重新加载</span></span><br><span class=\"line\">$ systemctl daemon-reload</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 启动</span></span><br><span class=\"line\">$ systemctl start kibana</span><br><span class=\"line\"><span class=\"comment\"># 停止</span></span><br><span class=\"line\">$ systemctl stop kibana</span><br><span class=\"line\"><span class=\"comment\"># 查看状态</span></span><br><span class=\"line\">$ systemctl status kibana</span><br><span class=\"line\"><span class=\"comment\"># 设置开机启动</span></span><br><span class=\"line\">$ systemctl <span class=\"built_in\">enable</span> kibana</span><br></pre></td></tr></table></figure>","content_text":"摘要 本文介绍如何在linux下安装Kibana Kibana版本8.17.3 Elasticsearch版本8.17.3，linux下安装Elasticsearch 下载 下载地址：https://www.elastic.co/cn/downloads/past-releases#kibana 选择对应的版本：这里选择当前的最新版Kibana 8.17.3，之后选择对应的操作系统LINUX X86_64 1wget https://artifacts.elastic.co/downloads/kibana/kibana-8.17.3-linux-x86_64.tar.gz 下载完成后解压到/usr/local/kibana目录下，解压命令如下： 12mkdir /usr/local/kibanatar -zxvf kibana-8.17.3-linux-x86_64.tar.gz -C /usr/local/kibana 创建启动用户 elasticsearch和kibana都不能用root用户启动 创建用户elastic，并设置密码，这一步我们在安装elasticsearch的时候已经配置过了，这里就不再赘述了 12useradd elasticpasswd elastic 修改kibana安装目录的用户权限 1chown -R elastic:elastic /usr/local/kibana 切换到elastic用户下执行命令 1su - elastic 关联Kibana和Elasticsearch 方法1：注册令牌Token关联[官方推荐] 注意此方法要求elasticsearch必须开启安全认证，而且xpack.security.http.ssl.enabled 必须设置为 true 配置启动文件，进入/usr/local/kibana/kibana-8.17.3/config目录，根据需要修改kibana.yml文件 12345678# 端口，默认5601server.port: 5601# kibana服务器的ip，4个0表示任何一个网卡都可以访问，默认为localhostserver.host: &quot;0.0.0.0&quot;# 中文，默认为 eni18n.locale: &quot;zh-CN&quot;# 配置https，默认值为 certificateelasticsearch.ssl.verificationMode: &#x27;certificate&#x27; 还记得我们第一次启动ES时日志信息中的有关kibana注册令牌的信息吗？那个令牌只有30分钟有效期，过期后可以进入elasticsearch安装目录，重新创建kibana注册令牌 123bin/elasticsearch-create-enrollment-token -s kibana# 输出结果如下eyJ2ZXIiOiI4LjE0LjAiLCJhZHIiOlsiMTAuMjUwLjAuMjM5OjkyMDAiXSwiZmdyIjoiM2YxNDFjMTZkZmM2ZTE2NTg5NGJjMTY3MjA4NGIyMjBkY2RkMjJmZmUwMjExNmQ1MWFjMTgwMDNjZmFhNWExZCIsImtleSI6ImxlTWh1SlVCcVJWQUw4WGFjMk1HOkVHYTYxcWlfVEotQWQ1Y3dQdXcyckEifQ== 进入kibana安装目录，通过下面的命令注册 Kibana 12345# bin/kibana-setup --enrollment-token &lt;enrollment-token&gt;bin/kibana-setup --enrollment-token eyJ2ZXIiOiI4LjE0LjAiLCJhZHIiOlsiMTAuMjUwLjAuMjM5OjkyMDAiXSwiZmdyIjoiM2YxNDFjMTZkZmM2ZTE2NTg5NGJjMTY3MjA4NGIyMjBkY2RkMjJmZmUwMjExNmQ1MWFjMTgwMDNjZmFhNWExZCIsImtleSI6ImxlTWh1SlVCcVJWQUw4WGFjMk1HOkVHYTYxcWlfVEotQWQ1Y3dQdXcyckEifQ==# 注册成功会输出✔ Kibana configured successfully. 如果ES的xpack.security.http.ssl.enabled 设置为 false，注册Kibana时会报错，报错信息如下： 1✖ Unable to connect to Elasticsearch with the provided enrollment token: Unable to connect to any of the provided hosts. 注册成功后会在/usr/local/kibana/kibana-8.17.3/config/kibana.yml文件中添加如下内容： 12345678910111213141516# This section was automatically generated during setup.# ES服务URLelasticsearch.hosts: [&#x27;https://10.250.0.239:9200&#x27;] # 10.250.0.239是本机的内网IP# 指定用于认证的服务账户令牌elasticsearch.serviceAccountToken: AAEAAWVsYXN0aWMva2liYW5hL2Vucm9sbC1wcm9jZXNzLXRva2VuLTE3NDI1NTA5ODU0MTg6Z2lJUERGaG1TR3VNcC1sb0RyMnMydw# 指定用来验证 Elasticsearch 服务器 SSL 证书的 CA 证书路径elasticsearch.ssl.certificateAuthorities: [/usr/local/kibana/kibana-8.17.3/data/ca_1742550986498.crt]# 配置 Fleet 的输出目标。Fleet 是 Elastic 的一个管理工具，用于管理和监控弹性栈（Elastic Stack）。这个配置定义了 Fleet 默认输出的目标，即 Elasticsearch。xpack.fleet.outputs: [&#123;id: fleet-default-output, name: default, is_default: true, is_default_monitoring: true, type: elasticsearch, hosts: [&#x27;https://10.250.0.239:9200&#x27;], ca_trusted_fingerprint: 3f141c16dfc6e165894bc1672084b220dcdd22ffe02116d51ac18003cfaa5a1d&#125;] # id: fleet-default-output：输出的唯一标识符。 # name: default：输出的名称。 # is_default: true：表示这是默认输出。 # is_default_monitoring: true：表示这是默认的监控输出。 # type: elasticsearch：输出类型是 Elasticsearch。 # hosts: [&#x27;https://10.250.0.239:9200&#x27;]：连接到的 Elasticsearch 主机地址。 # ca_trusted_fingerprint: 3f141c16dfc6e165894bc1672084b220dcdd22ffe02116d51ac18003cfaa5a1d：CA 证书的信任指纹，用于验证 CA 证书的身份。 方法2：用户名密码关联 创建kibana连接elasticsearch的用户密码，不能用 elastic 这个用户，因为这个是超级用户，要使用 kibana_system 用户 12# 进入elasticsearch安装目录，执行下面的命令重置 kibana_system 用户的密码bin/elasticsearch-reset-password -u kibana_system -i 配置启动文件，进入/usr/local/kibana/kibana-8.17.3/config目录，修改kibana.yml文件 123456789101112131415# 端口，默认5601server.port: 5601# kibana服务器的ip，4个0表示任何一个网卡都可以访问server.host: &quot;0.0.0.0&quot;# elasctisearch关联# ES服务地址，注意这里是httpselasticsearch.hosts: [&quot;https://10.250.0.239:9200&quot;]# 指定https证书路径，可以从ES的证书目录中获取elasticsearch.ssl.certificateAuthorities: [&quot;/usr/local/elasticsearch/elasticsearch-8.17.3/config/certs/http_ca.crt&quot;]# 用户名密码elasticsearch.username: &quot;kibana_system&quot;elasticsearch.password: &quot;123456&quot;# 中文i18n.locale: &quot;zh-CN&quot; 如果ES没有开启安全认证，则只需要进行如下配置即可： 12345678# 端口，默认5601server.port: 5601# kibana服务器的ip，4个0表示任何一个网卡都可以访问server.host: &quot;0.0.0.0&quot;# ES服务地址，注意这里是httpelasticsearch.hosts: [&quot;http://10.250.0.239:9200&quot;]# 中文i18n.locale: &quot;zh-CN&quot; 启动Kibana服务 进入/usr/local/kibana/kibana-8.17.3目录，执行以下命令启动服务 123./bin/kibana# 后台启动，并将日志写入到logs/kibana.lognohup bin/kibana &gt; logs/kibana.log 2&gt;&amp;1 &amp; 访问地址：http://localhost:5601，这里注意登录用户需要使用：elastic，而不是kibana_system。 启动Kibana服务后的日志告警 Kibana服务启动后，会在/usr/local/kibana/kibana-8.17.3/logs/kibana.log文件中记录一些错误日志，如果出现错误，可以查看日志，解决错误。 1[WARN ][plugins.fleet] xpack.encryptedSavedObjects.encryptionKey is not configured, private key passphrase is being stored in plain text 这个警告信息表明 Kibana 的某些插件（如 Fleet）在缺少 xpack.encryptedSavedObjects.encryptionKey 配置的情况下运行，导致私钥密码和代理卸载令牌以明文形式存储。为了提高安全性，建议配置一个加密密钥。 生成加密密钥 1234567891011121314151617181920212223242526$ bin/kibana-encryption-keys generateKibana is currently running with legacy OpenSSL providers enabled! For details and instructions on how to disable see https://www.elastic.co/guide/en/kibana/8.17/production.html#openssl-legacy-provider## Kibana Encryption Key Generation UtilityThe &#x27;generate&#x27; command guides you through the process of setting encryption keys for:xpack.encryptedSavedObjects.encryptionKey Used to encrypt stored objects such as dashboards and visualizations https://www.elastic.co/guide/en/kibana/current/xpack-security-secure-saved-objects.html#xpack-security-secure-saved-objectsxpack.reporting.encryptionKey Used to encrypt saved reports https://www.elastic.co/guide/en/kibana/current/reporting-settings-kb.html#general-reporting-settingsxpack.security.encryptionKey Used to encrypt session information https://www.elastic.co/guide/en/kibana/current/security-settings-kb.html#security-session-and-cookie-settingsAlready defined settings are ignored and can be regenerated using the --force flag. Check the documentation links for instructions on how to rotate encryption keys.Definitions should be set in the kibana.yml used configure Kibana.Settings:xpack.encryptedSavedObjects.encryptionKey: 47967e4b78bd26decb622b78f0ddd324xpack.reporting.encryptionKey: 78b5f603f3b0e6ad76c13a0f5d00cde0xpack.security.encryptionKey: 8aa7f4dfbc4e734a2a9f92a2730b36af 配置 Kibana 以使用加密密钥，添加到 kibana.yml 文件中： 123xpack.encryptedSavedObjects.encryptionKey: 47967e4b78bd26decb622b78f0ddd324xpack.reporting.encryptionKey: 78b5f603f3b0e6ad76c13a0f5d00cde0xpack.security.encryptionKey: 8aa7f4dfbc4e734a2a9f92a2730b36af 重启 Kibana 服务 以应用更改。 Kibana 自启动脚本 1234567891011121314151617181920212223242526272829303132333435# 创建服务文件$ vim /usr/lib/systemd/system/kibana.service[Unit]Description=kibanaDocumentation=https://www.elastic.coAfter=es.service[Service]Type=simplePrivateTmp=true# 指定ES用户User=elasticGroup=elasticLimitNOFILE=100000LimitNPROC=100000Restart=yes# 启动命令ExecStart=/usr/local/kibana/kibana-8.17.3/bin/kibanaExecRestart=/bin/kill -s HUP $MAINPIDExecStop=/bin/kill -s QUIT $MAINPID[Install]WantedBy=multi-user.target# 重新加载$ systemctl daemon-reload# 启动$ systemctl start kibana# 停止$ systemctl stop kibana# 查看状态$ systemctl status kibana# 设置开机启动$ systemctl enable kibana","summary":"摘要 本文介绍如何在linux下安装Kibana Kibana版本8.17.3 Elasticsearch版本8.17.3，linux下安装Elasticsearch","date_published":"2025-03-21T13:30:05.000Z","tags":["技术","elastic","kibana","elasticsearch","kibana"]},{"id":"https://blog.hanqunfeng.com/2025/03/20/elasticsearch-01-install/","url":"https://blog.hanqunfeng.com/2025/03/20/elasticsearch-01-install/","title":"linux下安装Elasticsearch","content_html":"<!--\n **加粗**\n *斜体*\n ***加粗并斜体***\n ~~删除线~~\n ==突出显示==\n `突出显示(推荐)`\n ++下划线++\n ~下标~\n ^上标^\n 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.\n 图片设置宽度和高度(通过uPic上传后，需要将upic修改过为blog，用于添加水印) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)\n\n +++ **点击折叠**\n 这是被隐藏的内容\n +++\n\n::: tips success warning danger\n这里是容器内的内容\n:::\n\n% note info % success warning danger\n这里是容器内的内容\n% endnote %\n\n引用本地其它文章连接{}\n 大括号开始% post_link 文件名称(不包含.md) %大括号结束\n -->\n<h2 id=\"摘要\">摘要</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>本文介绍如何在linux下安装Elasticsearch</p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/8.17/index.html\">Elasticsearch</a>版本8.17.3</p>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"下载\">下载</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>下载地址：<a href=\"https://www.elastic.co/cn/downloads/past-releases#elasticsearch\">https://www.elastic.co/cn/downloads/past-releases#elasticsearch</a></p>\n</li>\n<li class=\"lvl-2\">\n<p>选择对应的版本：这里选择当前的最新版<code>Elasticsearch 8.17.3</code>，之后选择对应的操作系统<code>LINUX X86_64</code></p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-8.17.3-linux-x86_64.tar.gz</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>下载完成后解压到<code>/usr/local/elasticsearch</code>目录下，解压命令如下：</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">mkdir</span> /usr/local/elasticsearch</span><br><span class=\"line\">tar -zxvf elasticsearch-8.17.3-linux-x86_64.tar.gz -C /usr/local/elasticsearch</span><br></pre></td></tr></table></figure>\n<h2 id=\"ElasticSearch目录结构\">ElasticSearch目录结构</h2>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bin        <span class=\"comment\"># 脚本文件，包括启动elasticsearch，安装插件，运行统计数据等</span></span><br><span class=\"line\">config     <span class=\"comment\"># 配置文件目录，如elasticsearch配置、角色配置、jvm配置、证书等。</span></span><br><span class=\"line\">data       <span class=\"comment\"># 数据目录，默认值 $ES_HOME/data，包含节点、分片、索引、文档的所有数据，生产环境建议修改</span></span><br><span class=\"line\">jdk        <span class=\"comment\"># JDK目录，用于运行Elasticsearch，7.x以后自带</span></span><br><span class=\"line\">lib        <span class=\"comment\"># Elasticsearch依赖的JAR包</span></span><br><span class=\"line\">logs       <span class=\"comment\"># 日志目录，默认值 $ES_HOME/logs，生产环境建议修改</span></span><br><span class=\"line\">modules    <span class=\"comment\"># 包含所有的Elasticsearch模块，如Cluster、Discovery、Indices等</span></span><br><span class=\"line\">plugins    <span class=\"comment\"># 已安装插件目录</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"创建启动用户\">创建启动用户</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>elasticsearch和kibana都不能用root用户启动</p>\n</li>\n<li class=\"lvl-2\">\n<p>创建用户<code>elastic</code>，并设置密码</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">useradd elastic</span><br><span class=\"line\">passwd elastic</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>修改elasticsearch安装目录的用户权限</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">chown</span> -R elastic:elastic /usr/local/elasticsearch</span><br></pre></td></tr></table></figure>\n<h2 id=\"配置环境变量\">配置环境变量</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>进入elastic用户主目录，/home/elastic目录下，设置用户级别的环境变量</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 切换到elastic用户</span></span><br><span class=\"line\">su - elastic</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>vim .bash_profile</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Elasticsearch安装目录，它用于定位Elasticsearch的配置文件、插件和其他相关资源。</span></span><br><span class=\"line\"><span class=\"built_in\">export</span> ES_HOME=/usr/local/elasticsearch/elasticsearch-8.17.3</span><br><span class=\"line\"><span class=\"comment\"># Elasticsearch使用的JDK安装目录，在启动Elasticsearch时，它会检查ES_JAVA_HOME环境变量并使用其中的Java路径。</span></span><br><span class=\"line\"><span class=\"built_in\">export</span> ES_JAVA_HOME=/usr/local/elasticsearch/elasticsearch-8.17.3/jdk/</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>执行以下命令使配置生效</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">source</span> .bash_profile</span><br></pre></td></tr></table></figure>\n<h2 id=\"配置JVM参数（可选）\">配置JVM参数（可选）</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ES比较耗内存，建议虚拟机4G或以上内存，jvm1g以上的内存分配</p>\n</li>\n<li class=\"lvl-2\">\n<p>进入<code>/usr/local/elasticsearch/elasticsearch-8.17.3/config</code>目录，修改<code>jvm.options</code>文件，调整jvm堆内存大小</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-Xms4g <span class=\"comment\"># 设置最小堆内存，默认4g，不能小于1g</span></span><br><span class=\"line\">-Xmx4g <span class=\"comment\"># 设置最大堆内存，默认4g，Xmx不要超过机器内存的50%，不要超过30g</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"创建数据和日志存储目录\">创建数据和日志存储目录</h2>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 切换到elastic用户</span></span><br><span class=\"line\">su - elastic</span><br><span class=\"line\"><span class=\"comment\"># 创建目录</span></span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> /usr/local/elasticsearch/data /usr/local/elasticsearch/log</span><br></pre></td></tr></table></figure>\n<h2 id=\"配置启动文件\">配置启动文件</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>如果是本地开发环境，也可以不做任何修改直接启动，因为大部分配置项都有默认值，但为了更好的控制ES，推荐按如下方式进行配置</p>\n</li>\n<li class=\"lvl-2\">\n<p>进入<code>/usr/local/elasticsearch/elasticsearch-8.17.3/config</code>目录，修改<code>elasticsearch.yml</code>文件</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 集群名称，多个节点如果要组成同一个集群，那么集群名称一定要配置成相同，默认值elasticsearch</span></span><br><span class=\"line\">cluster.name: test-elk</span><br><span class=\"line\"><span class=\"comment\"># 节点名称，默认值当前节点部署所在机器的主机名</span></span><br><span class=\"line\">node.name: node-1</span><br><span class=\"line\"><span class=\"comment\"># 数据存储路径，默认值 $ES_HOME/data</span></span><br><span class=\"line\">path.data: /usr/local/elasticsearch/data</span><br><span class=\"line\"><span class=\"comment\"># 日志存储路径，默认值 $ES_HOME/logs</span></span><br><span class=\"line\">path.logs: /usr/local/elasticsearch/logs</span><br><span class=\"line\"><span class=\"comment\"># 配置ES启动时是否进行内存锁定检查，默认值true，本机内存比较小时设置为false</span></span><br><span class=\"line\">bootstrap.memory_lock: <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"comment\"># 允许通过任何地址访问，开启远程访问</span></span><br><span class=\"line\">network.host: 0.0.0.0</span><br><span class=\"line\"><span class=\"comment\"># 配置当前ES节点对外提供服务的http端口，默认 9200</span></span><br><span class=\"line\">http.port: 9200</span><br><span class=\"line\"><span class=\"comment\"># 配置当前ES节点对外提供服务的tcp端口，默认 9300</span></span><br><span class=\"line\">transport.port: 9300</span><br><span class=\"line\"><span class=\"comment\"># 集群内的主机列表，单节点启动时可以不配置</span></span><br><span class=\"line\"><span class=\"comment\"># discovery.seed_hosts: [&quot;127.0.0.1&quot;]</span></span><br><span class=\"line\"><span class=\"comment\"># 第一次启动时需要参与选主的节点名称</span></span><br><span class=\"line\">cluster.initial_master_nodes: [<span class=\"string\">&quot;node-1&quot;</span>]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#解决跨域问题</span></span><br><span class=\"line\">http.cors.enabled: <span class=\"literal\">true</span></span><br><span class=\"line\">http.cors.allow-origin: <span class=\"string\">&quot;*&quot;</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"启动ElasticSearch服务\">启动ElasticSearch服务</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>进入<code>/usr/local/elasticsearch/elasticsearch-8.17.3</code>目录，执行以下命令启动服务</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./bin/elasticsearch</span><br><span class=\"line\"><span class=\"comment\"># 后台启动</span></span><br><span class=\"line\">./bin/elasticsearch -d</span><br></pre></td></tr></table></figure>\n<h2 id=\"ES启动前的引导检查\">ES启动前的引导检查</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>ES启动时，默认会进行引导检查，所谓引导检查就是在服务启动之前对一些重要的配置项进行检查，检查其配置值是否是合理的。引导检查包括对JVM大小、内存锁、虚拟内存、最大线程数、集群发现相关配置等相关的检查，如果某一项或者几项的配置不合理，ES会拒绝启动服务。</p>\n</li>\n<li class=\"lvl-2\">\n<p>如果启动服务时，报以下错误，则需要解决引导检查中的问题</p>\n</li>\n<li class=\"lvl-2\">\n<p>1.max virtual memory areas vm.max_map_count [65530] is too low, increase to at least [262144];</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">原因：最大虚拟内存太小,调大系统的虚拟内存</li>\n<li class=\"lvl-6\">解决办法：</li>\n</ul>\n  <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># root用户下运行</span></span><br><span class=\"line\">vim /etc/sysctl.conf</span><br><span class=\"line\"><span class=\"comment\"># 追加以下内容：</span></span><br><span class=\"line\">vm.max_map_count=262144</span><br><span class=\"line\"><span class=\"comment\"># 保存退出之后执行如下命令：</span></span><br><span class=\"line\">sysctl -p</span><br></pre></td></tr></table></figure>\n</li>\n<li class=\"lvl-2\">\n<p>2.max file descriptors [4096] for elasticsearch process is too low, increase to at least [65536]</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">原因：文件描述符太小，调大系统的文件描述符</li>\n<li class=\"lvl-6\">解决办法：</li>\n</ul>\n  <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># root用户下运行</span></span><br><span class=\"line\">vim /etc/security/limits.conf</span><br><span class=\"line\"><span class=\"comment\"># 末尾添加如下配置：</span></span><br><span class=\"line\">* soft nofile 65536</span><br><span class=\"line\">* hard nofile 65536</span><br><span class=\"line\">* soft <span class=\"built_in\">nproc</span> 4096</span><br><span class=\"line\">* hard <span class=\"built_in\">nproc</span> 4096</span><br></pre></td></tr></table></figure>\n</li>\n<li class=\"lvl-2\">\n<p>如果只是单节点的开发环境，则可以关闭引导检查，生成环境不建议这样做，因为关闭引导检查后，ES服务将无法保证集群的高可用性。</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 进入elasticsearch安装目录</span></span><br><span class=\"line\">vim config/elasticsearch.yml</span><br><span class=\"line\"><span class=\"comment\"># 添加如下配置：</span></span><br><span class=\"line\"><span class=\"comment\"># 指定节点为单节点，可以绕过引导检查</span></span><br><span class=\"line\">discovery.type: single-node</span><br></pre></td></tr></table></figure>\n<h2 id=\"服务正常启动后仍然不能正常访问\">服务正常启动后仍然不能正常访问</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>访问服务</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl http://127.0.0.1:9200</span><br><span class=\"line\">curl: (52) Empty reply from server</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>查看日志<code>/usr/local/elasticsearch/elasticsearch-8.17.3/logs/test-elk.log</code>，发现报如下警告：</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[WARN ][o.e.h.n.Netty4HttpServerTransport] [node-1] received plaintext http traffic on an https channel, closing connection Netty4HttpChannel&#123;localAddress=/127.0.0.1:9200, remoteAddress=/127.0.0.1:38426&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>原因是ES在启动服务时默认开启了 <code>X-Pack 安全功能</code>，查看配置文件<code>/usr/local/elasticsearch/elasticsearch-8.17.3/config/elasticsearch.yml</code>，发现配置项<code>xpack.security.xxx</code>相关配置项被自动添加了，如下：</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#----------------------- BEGIN SECURITY AUTO CONFIGURATION -----------------------</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"comment\"># The following settings, TLS certificates, and keys have been automatically</span></span><br><span class=\"line\"><span class=\"comment\"># generated to configure Elasticsearch security features on 20-03-2025 08:53:20</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"comment\"># --------------------------------------------------------------------------------</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Enable security features</span></span><br><span class=\"line\"><span class=\"comment\"># 启用 Elasticsearch 的安全特性，包括用户认证、角色管理、加密等。</span></span><br><span class=\"line\"><span class=\"comment\"># 开启了 X-Pack 安全功能，这意味着你需要进行用户认证才能访问 Elasticsearch。</span></span><br><span class=\"line\"><span class=\"comment\"># 如果需要关闭 X-Pack 安全功能，你可以将 xpack.security.enabled 设置为 false。</span></span><br><span class=\"line\">xpack.security.enabled: <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"comment\"># 启用安全注册功能，允许通过交互式向导来配置安全设置。</span></span><br><span class=\"line\"><span class=\"comment\"># 这使得你可以通过 Kibana 或命令行工具来自动配置 SSL 证书和其他安全设置。</span></span><br><span class=\"line\">xpack.security.enrollment.enabled: <span class=\"literal\">true</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Enable encryption for HTTP API client connections, such as Kibana, Logstash, and Agents</span></span><br><span class=\"line\"><span class=\"comment\"># 启用 HTTP API 客户端连接的加密</span></span><br><span class=\"line\"><span class=\"comment\"># Kibana、Logstash 和其他通过 HTTP API 连接到 Elasticsearch 的客户端将使用 HTTPS 进行通信，增强安全性。</span></span><br><span class=\"line\">xpack.security.http.ssl:</span><br><span class=\"line\">  enabled: <span class=\"literal\">true</span> <span class=\"comment\"># 启用 HTTP 层的 SSL 加密，即https访问，确保客户端与 Elasticsearch 之间的通信是加密的。设置为false时，关闭加密，即http访问</span></span><br><span class=\"line\">  keystore.path: certs/http.p12 <span class=\"comment\"># 指定用于 HTTP 层加密的密钥库文件路径。这是一个 PKCS12 文件，包含用于加密和验证的公钥和私钥。</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Enable encryption and mutual authentication between cluster nodes</span></span><br><span class=\"line\"><span class=\"comment\"># 启用节点间的加密和双向认证</span></span><br><span class=\"line\"><span class=\"comment\"># Elasticsearch 集群中的节点之间的通信将使用 SSL 加密，并且每个节点都会验证其他节点的身份，从而增强集群的安全性。</span></span><br><span class=\"line\"><span class=\"comment\"># 所有节点要配置相同的证书</span></span><br><span class=\"line\">xpack.security.transport.ssl:</span><br><span class=\"line\">  enabled: <span class=\"literal\">true</span> <span class=\"comment\"># 启用传输层的 SSL 加密，确保节点之间的内部通信是加密的。</span></span><br><span class=\"line\">  verification_mode: certificate <span class=\"comment\"># 设置验证模式为 certificate，这意味着节点之间需要双向认证（即每个节点都需要验证对方的身份）。</span></span><br><span class=\"line\">  keystore.path: certs/transport.p12 <span class=\"comment\"># 指定用于传输层加密的密钥库文件路径。这是另一个 PKCS12 文件，包含用于加密和验证的公钥和私钥。</span></span><br><span class=\"line\">  truststore.path: certs/transport.p12 <span class=\"comment\"># 指定用于存储信任证书的信任库文件路径。这通常与密钥库相同，但可以不同。</span></span><br><span class=\"line\"><span class=\"comment\">#----------------------- END SECURITY AUTO CONFIGURATION -------------------------</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>解决方法：</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">1.不想开启安全认证，将 <code>xpack.security.enabled</code> 设置为 false，这样即便下面的配置都设置为true也不会有效。</li>\n<li class=\"lvl-6\">2.不想https访问，将 <code>xpack.security.http.ssl.enabled</code> 设置为 false，但这样会导致无法通过认证Token添加其它节点或Kibana。</li>\n<li class=\"lvl-6\">3.不想节点间通信加密，将 <code>xpack.security.transport.ssl.enabled</code> 设置为 false</li>\n</ul>\n</li>\n<li class=\"lvl-2\">\n<p>为了保证ES的安全，我这里就开启安全认证，并且通过https访问ES，但此时我们访问ES的API就需要带上认证用户，那么用户名和密码是什么呢？</p>\n</li>\n<li class=\"lvl-2\">\n<p>实际上在ES第一次正常启动时其日志中就打印了自动配置的安全相关的信息提示，里面就给出了登录用户和初始的密码，如下：</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span><br><span class=\"line\"><span class=\"comment\"># 这些日志信息提供了 Elasticsearch 8 在首次启动时自动配置的安全特性、生成的默认密码、证书指纹以及如何配置 Kibana 和其他节点加入集群的详细说明。</span></span><br><span class=\"line\">✅ Elasticsearch security features have been automatically configured!</span><br><span class=\"line\">✅ Authentication is enabled and cluster connections are encrypted.</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 这是 elastic 用户的默认密码。系统建议你使用 bin/elasticsearch-reset-password -u elastic 命令来重置此密码。</span></span><br><span class=\"line\">ℹ️  Password <span class=\"keyword\">for</span> the elastic user (reset with `bin/elasticsearch-reset-password -u elastic`):</span><br><span class=\"line\">  BNb=*qz6_M*mXL9uZiSP <span class=\"comment\"># 这里会打印出ES自动生成的密码</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 这是 HTTP CA 证书的 SHA-256 指纹。CA 证书用于验证 HTTPS 连接的身份。</span></span><br><span class=\"line\">ℹ️  HTTP CA certificate SHA-256 fingerprint:</span><br><span class=\"line\">  3f141c16dfc6e165894bc1672084b220dcdd22ffe02116d51ac18003cfaa5a1d</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 提供了将 Kibana 配置为使用此 Elasticsearch 集群的步骤。</span></span><br><span class=\"line\">ℹ️  Configure Kibana to use this cluster:</span><br><span class=\"line\"><span class=\"comment\"># 启动 Kibana 并按照终端中显示的配置链接进行操作。</span></span><br><span class=\"line\">• Run Kibana and click the configuration <span class=\"built_in\">link</span> <span class=\"keyword\">in</span> the terminal when Kibana starts.</span><br><span class=\"line\"><span class=\"comment\"># 复制提供的注册令牌，并在浏览器中打开 Kibana 时粘贴此令牌。令牌在接下来的 30 分钟内有效。</span></span><br><span class=\"line\"><span class=\"comment\"># 补充说明：生成新的kibana注册令牌：bin/elasticsearch-create-enrollment-token -s kibana</span></span><br><span class=\"line\">• Copy the following enrollment token and <span class=\"built_in\">paste</span> it into Kibana <span class=\"keyword\">in</span> your browser (valid <span class=\"keyword\">for</span> the next 30 minutes):</span><br><span class=\"line\">  eyJ2ZXIiOiI4LjE0LjAiLCJhZHIiOlsiMTAuMjUwLjAuMjM5OjkyMDAiXSwiZmdyIjoiM2YxNDFjMTZkZmM2ZTE2NTg5NGJjMTY3MjA4NGIyMjBkY2RkMjJmZmUwMjExNmQ1MWFjMTgwMDNjZmFhNWExZCIsImtleSI6ImFSWFBzcFVCTVVmc1d5aUJnbjBtOmRzbVBLQV95UXhDZkJpXzQyWDNEMVEifQ==</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 提供了将新的 Elasticsearch 节点加入现有集群的步骤。</span></span><br><span class=\"line\">ℹ️ Configure other nodes to <span class=\"built_in\">join</span> this cluster:</span><br><span class=\"line\"><span class=\"comment\"># 使用 bin/elasticsearch --enrollment-token &lt;token&gt; 命令启动新的 Elasticsearch 节点。令牌在接下来的 30 分钟内有效。</span></span><br><span class=\"line\"><span class=\"comment\"># 补充说明：生成新的节点注册令牌：bin/elasticsearch-create-enrollment-token -s node</span></span><br><span class=\"line\">• Copy the following enrollment token and start new Elasticsearch nodes with `bin/elasticsearch --enrollment-token &lt;token&gt;` (valid <span class=\"keyword\">for</span> the next 30 minutes):</span><br><span class=\"line\">  eyJ2ZXIiOiI4LjE0LjAiLCJhZHIiOlsiMTAuMjUwLjAuMjM5OjkyMDAiXSwiZmdyIjoiM2YxNDFjMTZkZmM2ZTE2NTg5NGJjMTY3MjA4NGIyMjBkY2RkMjJmZmUwMjExNmQ1MWFjMTgwMDNjZmFhNWExZCIsImtleSI6ImF4WFBzcFVCTVVmc1d5aUJnbjFtOkFEallPdnpzUzh1MGJqOFpfVFE4a3cifQ==</span><br><span class=\"line\"><span class=\"comment\"># 如果你在 Docker 中运行 Elasticsearch，可以使用 docker run -e &quot;ENROLLMENT_TOKEN=&lt;token&gt;&quot; docker.elastic.co/elasticsearch/elasticsearch:8.17.3 命令启动新节点。</span></span><br><span class=\"line\">  If you<span class=\"string\">&#x27;re running in Docker, copy the enrollment token and run:</span></span><br><span class=\"line\"><span class=\"string\">  `docker run -e &quot;ENROLLMENT_TOKEN=&lt;token&gt;&quot; docker.elastic.co/elasticsearch/elasticsearch:8.17.3`</span></span><br><span class=\"line\"><span class=\"string\">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>登录用户为<code>elastic</code>[其角色为超级用户]，我们可以通过日志查看初始的密码，也可以通过如下命令重置密码</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 重置密码，密码自动生成</span></span><br><span class=\"line\">bin/elasticsearch-reset-password -u elastic</span><br><span class=\"line\"><span class=\"comment\"># 重置密码，自己输入要设置的密码，比如我这里这是为 123456</span></span><br><span class=\"line\">bin/elasticsearch-reset-password -u elastic -i</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 通过curl重置密码</span></span><br><span class=\"line\">curl -X PUT -u elastic:old_password -k <span class=\"string\">&#x27;https://127.0.0.1:9200/_security/user/elastic/_password&#x27;</span> \\</span><br><span class=\"line\">  -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;password&quot;: &quot;new_password&quot;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;&#x27;</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>curl 访问ES服务</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># -k 忽略证书校验</span></span><br><span class=\"line\">curl -u elastic:123456 -k https://127.0.0.1:9200</span><br><span class=\"line\"><span class=\"comment\"># 或者 将认证信息通过header传递，elastic:123456 通过base64加密</span></span><br><span class=\"line\">curl -k https://127.0.0.1:9200 -H <span class=\"string\">&#x27;Authorization: Basic ZWxhc3RpYzoxMjM0NTY=&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># 也可以通过证书访问https服务，这个证书就是ES在开启安全认证启动时自动生成的</span></span><br><span class=\"line\">curl -u elastic:123456 --cacert /usr/local/elasticsearch/elasticsearch-8.17.3/config/certs/http_ca.crt  https://127.0.0.1:9200</span><br><span class=\"line\"><span class=\"comment\"># 输出如下：</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;name&quot;</span> : <span class=\"string\">&quot;node-1&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;cluster_name&quot;</span> : <span class=\"string\">&quot;test-elk&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;cluster_uuid&quot;</span> : <span class=\"string\">&quot;RykjCSPnSCi4Hsi37uziWw&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;version&quot;</span> : &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;number&quot;</span> : <span class=\"string\">&quot;8.17.3&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;build_flavor&quot;</span> : <span class=\"string\">&quot;default&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;build_type&quot;</span> : <span class=\"string\">&quot;tar&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;build_hash&quot;</span> : <span class=\"string\">&quot;a091390de485bd4b127884f7e565c0cad59b10d2&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;build_date&quot;</span> : <span class=\"string\">&quot;2025-02-28T10:07:26.089129809Z&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;build_snapshot&quot;</span> : <span class=\"literal\">false</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;lucene_version&quot;</span> : <span class=\"string\">&quot;9.12.0&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;minimum_wire_compatibility_version&quot;</span> : <span class=\"string\">&quot;7.17.0&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;minimum_index_compatibility_version&quot;</span> : <span class=\"string\">&quot;7.0.0&quot;</span></span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;tagline&quot;</span> : <span class=\"string\">&quot;You Know, for Search&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<div class=\"tips\">\n<p><em><strong>开发模式和生产模式</strong></em></p>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">开发模式：如果用户只是出于学习目的，可以在配置文件中添加 <code>discovery.type=single-node</code> ，表示单节点模式，即开发模式。此模式可以绕过引导检查。</li>\n<li class=\"lvl-2\">生产模式：当用户配置了有关集群的相关配置项时就会触发生产模式，在生产模式下，服务启动会触发ES的引导检查或者叫启动检查（bootstrap checks），引导检查十分严格，即某些检查项不通过则ES服务将无法启动。\n<ul class=\"lvl-3\">\n<li class=\"lvl-4\">引导检查：在服务启动之前对一些重要的配置项进行检查，检查其配置值是否是合理的。引导检查包括对JVM大小、内存锁、虚拟内存、最大线程数、集群发现相关配置等相关的检查，如果某一项或者几项的配置不合理，ES会拒绝启动服务，并且在开发模式下的某些警告信息会升级成错误信息输出。引导检查十分严格，之所以宁可拒绝服务也要阻止用户启动服务是为了防止用户在对ES的基本使用不了解的前提下启动服务而导致的后期性能问题无法解决或者解决起来很麻烦。因为一旦服务以某种不合理的配置启动，时间久了之后可能会产生较大的性能问题，但此时集群已经变得难以维护和扩展，ES为了避免这种情况而做出了引导检查的设置，本来在开发模式下为警告的启动日志会升级为报错（Error）。这种设定虽然增加了用户的使用门槛，但是避免了日后产生更大的问题。</li>\n</ul>\n</li>\n</ul>\n</div>\n<h2 id=\"ES浏览器插件\">ES浏览器插件</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><a href=\"https://elasticvue.com/\">Elasticvue</a> : chrome/edge 插件，用于在浏览器中查看ES集群信息，功能非常强大</p>\n</li>\n</ul>\n<h2 id=\"ES自启动脚本\">ES自启动脚本</h2>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 创建服务文件</span></span><br><span class=\"line\">$ vim /usr/lib/systemd/system/es.service</span><br><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=elasticsearch</span><br><span class=\"line\">Documentation=https://www.elastic.co</span><br><span class=\"line\">After=network.target</span><br><span class=\"line\"></span><br><span class=\"line\">[Service]</span><br><span class=\"line\">Type=simple</span><br><span class=\"line\">PrivateTmp=<span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"comment\"># 指定ES用户</span></span><br><span class=\"line\">User=elastic</span><br><span class=\"line\">Group=elastic</span><br><span class=\"line\">LimitNOFILE=100000</span><br><span class=\"line\">LimitNPROC=100000</span><br><span class=\"line\">Restart=<span class=\"built_in\">yes</span></span><br><span class=\"line\"><span class=\"comment\"># 启动命令</span></span><br><span class=\"line\">ExecStart=/usr/local/elasticsearch/elasticsearch-8.17.3/bin/elasticsearch</span><br><span class=\"line\">ExecRestart=/bin/kill -s HUP <span class=\"variable\">$MAINPID</span></span><br><span class=\"line\">ExecStop=/bin/kill -s QUIT <span class=\"variable\">$MAINPID</span></span><br><span class=\"line\"></span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 重新加载</span></span><br><span class=\"line\">$ systemctl daemon-reload</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 启动</span></span><br><span class=\"line\">$ systemctl start es</span><br><span class=\"line\"><span class=\"comment\"># 停止</span></span><br><span class=\"line\">$ systemctl stop es</span><br><span class=\"line\"><span class=\"comment\"># 查看状态</span></span><br><span class=\"line\">$ systemctl status es</span><br><span class=\"line\"><span class=\"comment\"># 设置开机启动</span></span><br><span class=\"line\">$ systemctl <span class=\"built_in\">enable</span> es</span><br></pre></td></tr></table></figure>\n<h2 id=\"通过ApiKey访问ES\">通过ApiKey访问ES</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>关于ApiKey的详细介绍，可以参考<a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/current/security-api-create-api-key.html\">官方文档</a></p>\n</li>\n<li class=\"lvl-2\">\n<p>创建ApiKey</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -k <span class=\"string\">&#x27;https://127.0.0.1:9200/_security/api_key?pretty&#x27;</span> \\</span><br><span class=\"line\">-u elastic:123456 \\</span><br><span class=\"line\">--header <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">--data <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;name&quot;: &quot;elastic_api_key&quot;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;expiration&quot;: &quot;1d&quot;</span></span><br><span class=\"line\"><span class=\"string\">&#125;&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># 请求参数说明：</span></span><br><span class=\"line\"><span class=\"comment\"># name: ApiKey的名称</span></span><br><span class=\"line\"><span class=\"comment\"># expiration: ApiKey的过期时间，这里设置为一天，如果不设置，则永不过期</span></span><br><span class=\"line\"><span class=\"comment\"># 请求参数中还有一个重要的参数 `role_descriptors`，其含义是，指定ApiKey所拥有的权限，即角色。如果不进行设置，则默认使用当前认证用户的的角色</span></span><br><span class=\"line\"><span class=\"comment\"># metadata: ApiKey的元数据，即自定义的键值对，这里可以不设置</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 输出：</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;id&quot;</span>:<span class=\"string\">&quot;70It0ZUBrL2GcOxX0d1L&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;name&quot;</span>:<span class=\"string\">&quot;elastic_api_key&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;expiration&quot;</span>:1743057595723,</span><br><span class=\"line\">  <span class=\"string\">&quot;api_key&quot;</span>:<span class=\"string\">&quot;s85lqVkmQISkBlgXCTJmDQ&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;encoded&quot;</span>:<span class=\"string\">&quot;NzBJdDBaVUJyTDJHY094WDBkMUw6czg1bHFWa21RSVNrQmxnWENUSm1EUQ==&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\"># 输出参数说明：</span></span><br><span class=\"line\"><span class=\"comment\"># id: ApiKey的id</span></span><br><span class=\"line\"><span class=\"comment\"># name: ApiKey的名称</span></span><br><span class=\"line\"><span class=\"comment\"># expiration: ApiKey的过期时间，单位为毫秒</span></span><br><span class=\"line\"><span class=\"comment\"># api_key: ApiKey的密钥</span></span><br><span class=\"line\"><span class=\"comment\"># encoded: 对 `id:api_key` 进行base64编码，即可得到 `encoded`</span></span><br><span class=\"line\">    <span class=\"comment\"># echo -n &#x27;70It0ZUBrL2GcOxX0d1L:s85lqVkmQISkBlgXCTJmDQ&#x27; | base64</span></span><br><span class=\"line\">    <span class=\"comment\"># 输出：</span></span><br><span class=\"line\">    <span class=\"comment\"># NzBJdDBaVUJyTDJHY094WDBkMUw6czg1bHFWa21RSVNrQmxnWENUSm1EUQ==</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>使用ApiKey访问ES</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 这里的ApiKey，就是上面输出的encoded</span></span><br><span class=\"line\">curl -k <span class=\"string\">&#x27;https://127.0.0.1:9200?pretty&#x27;</span> \\</span><br><span class=\"line\">-H <span class=\"string\">&#x27;Authorization: ApiKey NzBJdDBaVUJyTDJHY094WDBkMUw6czg1bHFWa21RSVNrQmxnWENUSm1EUQ==&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># 输出</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;name&quot;</span> : <span class=\"string\">&quot;node-1&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;cluster_name&quot;</span> : <span class=\"string\">&quot;test-elk&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;cluster_uuid&quot;</span> : <span class=\"string\">&quot;RykjCSPnSCi4Hsi37uziWw&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;version&quot;</span> : &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;number&quot;</span> : <span class=\"string\">&quot;8.17.3&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;build_flavor&quot;</span> : <span class=\"string\">&quot;default&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;build_type&quot;</span> : <span class=\"string\">&quot;tar&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;build_hash&quot;</span> : <span class=\"string\">&quot;a091390de485bd4b127884f7e565c0cad59b10d2&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;build_date&quot;</span> : <span class=\"string\">&quot;2025-02-28T10:07:26.089129809Z&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;build_snapshot&quot;</span> : <span class=\"literal\">false</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;lucene_version&quot;</span> : <span class=\"string\">&quot;9.12.0&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;minimum_wire_compatibility_version&quot;</span> : <span class=\"string\">&quot;7.17.0&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;minimum_index_compatibility_version&quot;</span> : <span class=\"string\">&quot;7.0.0&quot;</span></span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;tagline&quot;</span> : <span class=\"string\">&quot;You Know, for Search&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>查看ApiKey信息，参考<a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/current/security-api-get-api-key.html\">官方文档</a></p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/_security/api_key?name=elastic_api_key&amp;pretty&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># 请求参数说明：</span></span><br><span class=\"line\"><span class=\"comment\"># name: ApiKey的名称，不同的ApiKey可以拥有相同的名称，但id不同，所以通过name进行查询可能会返回多个结果</span></span><br><span class=\"line\"><span class=\"comment\"># 或者 id: ApiKey的id，建议通过id进行查询，id唯一，所以通过id进行查询只会返回一个结果</span></span><br><span class=\"line\"><span class=\"comment\"># username: 查询指定用户的ApiKey</span></span><br><span class=\"line\"><span class=\"comment\"># owner: 是否只查询当前认证用户名下的ApiKey，默认为false，为false时必须至少设置name\\ids\\username中的一个参数</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 不加任何参数进行查询，则返回所有ApiKey的信息</span></span><br><span class=\"line\">curl -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/_security/api_key?pretty&#x27;</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>更新ApiKey，参考<a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/current/security-api-update-api-key.html\">官方文档</a></p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -u elastic:123456 -X PUT -k <span class=\"string\">&#x27;https://127.0.0.1:9200/_security/api_key/&#123;ApiKeyId&#125;?pretty&#x27;</span> \\</span><br><span class=\"line\">--header <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">--data <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;expiration&quot;: &quot;1h&quot;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;role_descriptors&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;role-a&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;indices&quot;: [</span></span><br><span class=\"line\"><span class=\"string\">            &#123;</span></span><br><span class=\"line\"><span class=\"string\">                &quot;names&quot;: [&quot;*&quot;],</span></span><br><span class=\"line\"><span class=\"string\">                &quot;privileges&quot;: [&quot;write&quot;]</span></span><br><span class=\"line\"><span class=\"string\">            &#125;</span></span><br><span class=\"line\"><span class=\"string\">        ]</span></span><br><span class=\"line\"><span class=\"string\">        &#125;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;metadata&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;environment&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">            &quot;level&quot;: 2,</span></span><br><span class=\"line\"><span class=\"string\">            &quot;trusted&quot;: true,</span></span><br><span class=\"line\"><span class=\"string\">            &quot;tags&quot;: [&quot;production&quot;]</span></span><br><span class=\"line\"><span class=\"string\">        &#125;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#125;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 可以更新的参数有：</span></span><br><span class=\"line\"><span class=\"comment\"># expiration: ApiKey的过期时间，如果已经设置过expiration，此时希望使其永不过期，则只能将其设置为一个比较大的时间，比如 &quot;expiration&quot;: &quot;100y&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># role_descriptors: ApiKey所拥有的角色，原先设置了role_descriptors，更新时希望其使用认证用户的角色，则此时可以将其设置为 &quot;role_descriptors&quot;: &#123;&#125;</span></span><br><span class=\"line\"><span class=\"comment\"># metadata: ApiKey的元数据，原先设置了 metadata ，更新时希望去除所有 metadata 信息，则此时可以将其设置为 &quot;metadata&quot;: &#123;&#125;</span></span><br><span class=\"line\"><span class=\"comment\"># 注意：三个参数可以只更新其中任何一个，更新哪个就只替换哪个，没有被更新的参数不会受到修改，当然也可以同时更新全部</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>置ApiKey无效，参考<a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/current/security-api-invalidate-api-key.html\">官方文档</a>，官方没有提供删除ApiKey的接口，只有置无效的接口</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -u elastic:123456 -X DELETE -k <span class=\"string\">&#x27;https://127.0.0.1:9200/_security/api_key?pretty&#x27;</span> \\</span><br><span class=\"line\">--header <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">--data <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;name&quot;: &quot;elastic_api_key&quot;</span></span><br><span class=\"line\"><span class=\"string\">&#125;&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># 请求参数说明：</span></span><br><span class=\"line\"><span class=\"comment\"># name: ApiKey的名称，会</span></span><br><span class=\"line\"><span class=\"comment\"># 或者使用  &quot;ids&quot; : [ &quot;70It0ZUBrL2GcOxX0d1L&quot; ] ，通过id进行删除，此时可以一次删除多个ApiKey</span></span><br><span class=\"line\"><span class=\"comment\"># username: 删除指定用户的ApiKey</span></span><br><span class=\"line\"><span class=\"comment\"># owner: 是否只删除当前认证用户名下的ApiKey，默认为false，为false时必须至少设置name\\ids\\username中的一个参数</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 输出：</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;invalidated_api_keys&quot;</span>:[</span><br><span class=\"line\">    <span class=\"string\">&quot;70It0ZUBrL2GcOxX0d1L&quot;</span></span><br><span class=\"line\">  ],</span><br><span class=\"line\">  <span class=\"string\">&quot;previously_invalidated_api_keys&quot;</span>:[ ],</span><br><span class=\"line\">  <span class=\"string\">&quot;error_count&quot;</span>:0</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\"># 输出参数说明：</span></span><br><span class=\"line\"><span class=\"comment\"># invalidated_api_keys: 被删除的ApiKey的id列表</span></span><br><span class=\"line\"><span class=\"comment\"># previously_invalidated_api_keys: 之前被删除的ApiKey的id列表</span></span><br><span class=\"line\"><span class=\"comment\"># error_count: 错误数量，如果为0，则表示成功</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>使用ApiKey的优缺点</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">优点</li>\n</ul>\n  <figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">安全性:</span><br><span class=\"line\">    细粒度控制: API Key 可以与特定的角色描述符关联，允许非常细化的权限控制。这有助于遵循最小权限原则，只授予必要的访问权限。</span><br><span class=\"line\">    时间限制: 可以为 API Key 设置过期时间，确保密钥不会永远有效，减少长期泄露的风险。</span><br><span class=\"line\">    可撤销性: 如果怀疑某个 API Key 被泄露或不再需要，可以随时撤销该密钥，提高安全性。</span><br><span class=\"line\">方便性:</span><br><span class=\"line\">    易于生成和管理: 创建和管理 API Key 的过程通常很简单，可以通过 REST API 或 Kibana 界面进行。</span><br><span class=\"line\">    无需用户交互: 一旦生成，API Key 可以直接用于自动化脚本或应用程序，无需用户手动登录或提供凭据。</span><br><span class=\"line\">审计和监控:</span><br><span class=\"line\">    跟踪使用情况: 通过日志记录和审计功能，可以跟踪哪个 API Key 进行了哪些操作，便于安全审计和问题排查。</span><br><span class=\"line\">    活动监控: 可以监控 API Key 的活动，及时发现异常行为，并采取相应的措施。</span><br><span class=\"line\">灵活性:</span><br><span class=\"line\">    多种用途: API Key 可以用于各种用途，如应用程序集成、数据导入导出、监控工具等。</span><br><span class=\"line\">    多环境支持: 可以为不同的环境（开发、测试、生产）生成独立的 API Key，确保各环境之间的隔离。</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">缺点</li>\n</ul>\n  <figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">安全性风险:</span><br><span class=\"line\">    密钥存储: API Key 需要安全地存储和传输，如果密钥被泄露，攻击者可以利用它进行未授权的操作。</span><br><span class=\"line\">    静态凭证: 与动态的身份验证机制（如 OAuth 令牌）相比，API Key 是静态的，一旦泄露可能会导致长期的安全风险。</span><br><span class=\"line\">管理复杂性:</span><br><span class=\"line\">    密钥管理: 随着时间和使用规模的增长，管理和维护大量 API Key 可能会变得复杂。需要定期更新和撤销老旧的密钥。</span><br><span class=\"line\">    角色分配: 细粒度的权限控制虽然提供了安全性，但也增加了配置和管理的复杂性。</span><br><span class=\"line\">缺乏用户上下文:</span><br><span class=\"line\">    匿名性: API Key 通常没有用户上下文信息，不像基于用户的认证机制（如 Basic Auth 或 OAuth），这可能不利于某些依赖用户身份的功能。</span><br><span class=\"line\">依赖客户端配置:</span><br><span class=\"line\">    易错性: 如果客户端配置不当，如错误地处理或暴露 API Key，可能会导致安全漏洞。</span><br><span class=\"line\">    更新挑战: 更新 API Key 后，所有使用该密钥的客户端都需要同步更新，这在大规模环境中可能是一个挑战。</span><br></pre></td></tr></table></figure>\n</li>\n<li class=\"lvl-2\">\n<p>何时使用 API Key</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">当您需要为自动化脚本、第三方服务或应用程序提供访问权限时。</li>\n<li class=\"lvl-6\">当您希望实现细粒度的权限控制并能够轻松管理密钥的生命周期时。</li>\n<li class=\"lvl-6\">当不需要用户上下文或复杂的用户会话管理时。</li>\n</ul>\n</li>\n<li class=\"lvl-2\">\n<p>示例</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 创建ApiKey</span></span><br><span class=\"line\">curl -X POST -k <span class=\"string\">&#x27;https://127.0.0.1:9200/_security/api_key?pretty&#x27;</span> \\</span><br><span class=\"line\">-u elastic:123456 \\</span><br><span class=\"line\">--header <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">--data <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">  &quot;name&quot;: &quot;my-api-key&quot;,</span></span><br><span class=\"line\"><span class=\"string\">  &quot;expiration&quot;: &quot;1d&quot;,</span></span><br><span class=\"line\"><span class=\"string\">  &quot;role_descriptors&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;role-a&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;cluster&quot;: [&quot;all&quot;],</span></span><br><span class=\"line\"><span class=\"string\">      &quot;indices&quot;: [</span></span><br><span class=\"line\"><span class=\"string\">        &#123;</span></span><br><span class=\"line\"><span class=\"string\">          &quot;names&quot;: [&quot;index-a*&quot;],</span></span><br><span class=\"line\"><span class=\"string\">          &quot;privileges&quot;: [&quot;read&quot;]</span></span><br><span class=\"line\"><span class=\"string\">        &#125;</span></span><br><span class=\"line\"><span class=\"string\">      ]</span></span><br><span class=\"line\"><span class=\"string\">    &#125;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;role-b&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;cluster&quot;: [&quot;all&quot;],</span></span><br><span class=\"line\"><span class=\"string\">      &quot;indices&quot;: [</span></span><br><span class=\"line\"><span class=\"string\">        &#123;</span></span><br><span class=\"line\"><span class=\"string\">          &quot;names&quot;: [&quot;index-b*&quot;],</span></span><br><span class=\"line\"><span class=\"string\">          &quot;privileges&quot;: [&quot;all&quot;]</span></span><br><span class=\"line\"><span class=\"string\">        &#125;</span></span><br><span class=\"line\"><span class=\"string\">      ]</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">  &#125;,</span></span><br><span class=\"line\"><span class=\"string\">  &quot;metadata&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;application&quot;: &quot;my-application&quot;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;environment&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">       &quot;level&quot;: 1,</span></span><br><span class=\"line\"><span class=\"string\">       &quot;trusted&quot;: true,</span></span><br><span class=\"line\"><span class=\"string\">       &quot;tags&quot;: [&quot;dev&quot;, &quot;staging&quot;]</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">  &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#125;&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># name: ApiKey的名称</span></span><br><span class=\"line\"><span class=\"comment\"># expiration: ApiKey的过期时间，支持的时间单位为：s（秒），m（分钟），h（小时），d（天），w（周），M（月），y（年）</span></span><br><span class=\"line\">    <span class=\"comment\"># expiration不能设置小于1分钟的时间，如果省略expiration，则表示无过期时间</span></span><br><span class=\"line\"><span class=\"comment\"># role_descriptors: 角色描述符，包含多个角色</span></span><br><span class=\"line\">    <span class=\"comment\"># role-a: 角色描述符名称，包含集群和索引的权限描述</span></span><br><span class=\"line\">        <span class=\"comment\"># cluster: 集群权限</span></span><br><span class=\"line\">            <span class=\"comment\"># all: 表示拥有全部集群权限</span></span><br><span class=\"line\">            <span class=\"comment\"># manage: 可以管理集群设置、模板和节点上的分片分配。</span></span><br><span class=\"line\">            <span class=\"comment\"># monitor: 可以监视集群的状态。</span></span><br><span class=\"line\">            <span class=\"comment\"># manage_security: 可以管理安全设置，如用户、角色和角色映射。</span></span><br><span class=\"line\">            <span class=\"comment\"># manage_api_key: 管理 API Key</span></span><br><span class=\"line\">        <span class=\"comment\"># indices: 索引权限，包含names和privileges，</span></span><br><span class=\"line\">            <span class=\"comment\"># names: 表示索引名称，index-a*表示所有以index-a开头的索引，all表示所有索引</span></span><br><span class=\"line\">            <span class=\"comment\"># privileges: 表示索引权限</span></span><br><span class=\"line\">                <span class=\"comment\"># read: 表示拥有索引的读取权限</span></span><br><span class=\"line\">                <span class=\"comment\"># write: 表示拥有索引的写入权限</span></span><br><span class=\"line\">                <span class=\"comment\"># delete: 表示拥有索引的删除权限</span></span><br><span class=\"line\">                <span class=\"comment\"># index: 表示拥有索引的索引权限</span></span><br><span class=\"line\">                <span class=\"comment\"># manage: 表示拥有索引的设置和映射权限</span></span><br><span class=\"line\">                <span class=\"comment\"># monitor: 表示拥有索引的监控权限</span></span><br><span class=\"line\">                <span class=\"comment\"># create_index: 表示允许创建索引</span></span><br><span class=\"line\">                <span class=\"comment\"># crud: 组合了 read, index, delete 权限</span></span><br><span class=\"line\">                <span class=\"comment\"># all: 表示拥有全部索引权限</span></span><br><span class=\"line\">            <span class=\"comment\"># allow_restricted_indices: 表示是否允许对 restricted indices(受限制索引，比如以.开头的索引) 进行操作，true表示允许，false表示不允许</span></span><br><span class=\"line\"><span class=\"comment\"># metadata: 元数据</span></span><br><span class=\"line\">    <span class=\"comment\"># application: 表示应用程序名称</span></span><br><span class=\"line\">    <span class=\"comment\"># environment: 表示环境信息</span></span><br><span class=\"line\">        <span class=\"comment\"># level: 表示环境级别</span></span><br><span class=\"line\">        <span class=\"comment\"># trusted: 表示是否受信任</span></span><br><span class=\"line\">        <span class=\"comment\"># tags: 表示环境标签</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 输出：</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;id&quot;</span> : <span class=\"string\">&quot;-kKu0ZUBrL2GcOxX0t1R&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;name&quot;</span> : <span class=\"string\">&quot;my-api-key&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;expiration&quot;</span> : 1743066050130,</span><br><span class=\"line\">  <span class=\"string\">&quot;api_key&quot;</span> : <span class=\"string\">&quot;03eNOYg_SCCHdzc0orsRvw&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;encoded&quot;</span> : <span class=\"string\">&quot;LWtLdTBaVUJyTDJHY094WDB0MVI6MDNlTk9ZZ19TQ0NIZHpjMG9yc1J2dw==&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看ApiKey信息，根据id查询只会返回一个ApiKey，根据name查询会返回多个ApiKey</span></span><br><span class=\"line\">curl -u elastic:123456 -k <span class=\"string\">&#x27;https://127.0.0.1:9200/_security/api_key?id=-kKu0ZUBrL2GcOxX0t1R&amp;pretty&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># 输出：</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;api_keys&quot;</span> : [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;id&quot;</span> : <span class=\"string\">&quot;-kKu0ZUBrL2GcOxX0t1R&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;name&quot;</span> : <span class=\"string\">&quot;my-api-key&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;rest&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;creation&quot;</span> : 1742979650130,</span><br><span class=\"line\">      <span class=\"string\">&quot;expiration&quot;</span> : 1743066050130,</span><br><span class=\"line\">      <span class=\"string\">&quot;invalidated&quot;</span> : <span class=\"literal\">false</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;username&quot;</span> : <span class=\"string\">&quot;elastic&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;realm&quot;</span> : <span class=\"string\">&quot;reserved&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;realm_type&quot;</span> : <span class=\"string\">&quot;reserved&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;metadata&quot;</span> : &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;environment&quot;</span> : &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;level&quot;</span> : 1,</span><br><span class=\"line\">          <span class=\"string\">&quot;trusted&quot;</span> : <span class=\"literal\">true</span>,</span><br><span class=\"line\">          <span class=\"string\">&quot;tags&quot;</span> : [</span><br><span class=\"line\">            <span class=\"string\">&quot;dev&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;staging&quot;</span></span><br><span class=\"line\">          ]</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;application&quot;</span> : <span class=\"string\">&quot;my-application&quot;</span></span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      <span class=\"string\">&quot;role_descriptors&quot;</span> : &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;role-a&quot;</span> : &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;cluster&quot;</span> : [</span><br><span class=\"line\">            <span class=\"string\">&quot;all&quot;</span></span><br><span class=\"line\">          ],</span><br><span class=\"line\">          <span class=\"string\">&quot;indices&quot;</span> : [</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">              <span class=\"string\">&quot;names&quot;</span> : [</span><br><span class=\"line\">                <span class=\"string\">&quot;index-a*&quot;</span></span><br><span class=\"line\">              ],</span><br><span class=\"line\">              <span class=\"string\">&quot;privileges&quot;</span> : [</span><br><span class=\"line\">                <span class=\"string\">&quot;read&quot;</span></span><br><span class=\"line\">              ],</span><br><span class=\"line\">              <span class=\"string\">&quot;allow_restricted_indices&quot;</span> : <span class=\"literal\">false</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          ],</span><br><span class=\"line\">          <span class=\"string\">&quot;applications&quot;</span> : [ ],</span><br><span class=\"line\">          <span class=\"string\">&quot;run_as&quot;</span> : [ ],</span><br><span class=\"line\">          <span class=\"string\">&quot;metadata&quot;</span> : &#123; &#125;,</span><br><span class=\"line\">          <span class=\"string\">&quot;transient_metadata&quot;</span> : &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;enabled&quot;</span> : <span class=\"literal\">true</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;role-b&quot;</span> : &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;cluster&quot;</span> : [</span><br><span class=\"line\">            <span class=\"string\">&quot;all&quot;</span></span><br><span class=\"line\">          ],</span><br><span class=\"line\">          <span class=\"string\">&quot;indices&quot;</span> : [</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">              <span class=\"string\">&quot;names&quot;</span> : [</span><br><span class=\"line\">                <span class=\"string\">&quot;index-b*&quot;</span></span><br><span class=\"line\">              ],</span><br><span class=\"line\">              <span class=\"string\">&quot;privileges&quot;</span> : [</span><br><span class=\"line\">                <span class=\"string\">&quot;all&quot;</span></span><br><span class=\"line\">              ],</span><br><span class=\"line\">              <span class=\"string\">&quot;allow_restricted_indices&quot;</span> : <span class=\"literal\">false</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          ],</span><br><span class=\"line\">          <span class=\"string\">&quot;applications&quot;</span> : [ ],</span><br><span class=\"line\">          <span class=\"string\">&quot;run_as&quot;</span> : [ ],</span><br><span class=\"line\">          <span class=\"string\">&quot;metadata&quot;</span> : &#123; &#125;,</span><br><span class=\"line\">          <span class=\"string\">&quot;transient_metadata&quot;</span> : &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;enabled&quot;</span> : <span class=\"literal\">true</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 更新ApiKey</span></span><br><span class=\"line\">curl -u elastic:123456 -X PUT -k <span class=\"string\">&#x27;https://127.0.0.1:9200/_security/api_key/-kKu0ZUBrL2GcOxX0t1R?pretty&#x27;</span> \\</span><br><span class=\"line\">--header <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">--data <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;metadata&quot;: &#123;&#125;</span></span><br><span class=\"line\"><span class=\"string\">&#125;&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># 输出：</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;updated&quot;</span> : <span class=\"literal\">true</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 置ApiKey无效</span></span><br><span class=\"line\">curl -u elastic:123456 -X DELETE -k <span class=\"string\">&#x27;https://127.0.0.1:9200/_security/api_key?pretty&#x27;</span> \\</span><br><span class=\"line\">--header <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> \\</span><br><span class=\"line\">--data <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">   &quot;ids&quot; : [ &quot;-kKu0ZUBrL2GcOxX0t1R&quot; ]</span></span><br><span class=\"line\"><span class=\"string\">&#125;&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># 输出：</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;invalidated_api_keys&quot;</span> : [</span><br><span class=\"line\">    <span class=\"string\">&quot;-kKu0ZUBrL2GcOxX0t1R&quot;</span></span><br><span class=\"line\">  ],</span><br><span class=\"line\">  <span class=\"string\">&quot;previously_invalidated_api_keys&quot;</span> : [ ],</span><br><span class=\"line\">  <span class=\"string\">&quot;error_count&quot;</span> : 0</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>","content_text":"摘要 本文介绍如何在linux下安装Elasticsearch Elasticsearch版本8.17.3 下载 下载地址：https://www.elastic.co/cn/downloads/past-releases#elasticsearch 选择对应的版本：这里选择当前的最新版Elasticsearch 8.17.3，之后选择对应的操作系统LINUX X86_64 1wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-8.17.3-linux-x86_64.tar.gz 下载完成后解压到/usr/local/elasticsearch目录下，解压命令如下： 12mkdir /usr/local/elasticsearchtar -zxvf elasticsearch-8.17.3-linux-x86_64.tar.gz -C /usr/local/elasticsearch ElasticSearch目录结构 12345678bin # 脚本文件，包括启动elasticsearch，安装插件，运行统计数据等config # 配置文件目录，如elasticsearch配置、角色配置、jvm配置、证书等。data # 数据目录，默认值 $ES_HOME/data，包含节点、分片、索引、文档的所有数据，生产环境建议修改jdk # JDK目录，用于运行Elasticsearch，7.x以后自带lib # Elasticsearch依赖的JAR包logs # 日志目录，默认值 $ES_HOME/logs，生产环境建议修改modules # 包含所有的Elasticsearch模块，如Cluster、Discovery、Indices等plugins # 已安装插件目录 创建启动用户 elasticsearch和kibana都不能用root用户启动 创建用户elastic，并设置密码 12useradd elasticpasswd elastic 修改elasticsearch安装目录的用户权限 1chown -R elastic:elastic /usr/local/elasticsearch 配置环境变量 进入elastic用户主目录，/home/elastic目录下，设置用户级别的环境变量 12# 切换到elastic用户su - elastic vim .bash_profile 1234# Elasticsearch安装目录，它用于定位Elasticsearch的配置文件、插件和其他相关资源。export ES_HOME=/usr/local/elasticsearch/elasticsearch-8.17.3# Elasticsearch使用的JDK安装目录，在启动Elasticsearch时，它会检查ES_JAVA_HOME环境变量并使用其中的Java路径。export ES_JAVA_HOME=/usr/local/elasticsearch/elasticsearch-8.17.3/jdk/ 执行以下命令使配置生效 1source .bash_profile 配置JVM参数（可选） ES比较耗内存，建议虚拟机4G或以上内存，jvm1g以上的内存分配 进入/usr/local/elasticsearch/elasticsearch-8.17.3/config目录，修改jvm.options文件，调整jvm堆内存大小 12-Xms4g # 设置最小堆内存，默认4g，不能小于1g-Xmx4g # 设置最大堆内存，默认4g，Xmx不要超过机器内存的50%，不要超过30g 创建数据和日志存储目录 1234# 切换到elastic用户su - elastic# 创建目录mkdir /usr/local/elasticsearch/data /usr/local/elasticsearch/log 配置启动文件 如果是本地开发环境，也可以不做任何修改直接启动，因为大部分配置项都有默认值，但为了更好的控制ES，推荐按如下方式进行配置 进入/usr/local/elasticsearch/elasticsearch-8.17.3/config目录，修改elasticsearch.yml文件 123456789101112131415161718192021222324# 集群名称，多个节点如果要组成同一个集群，那么集群名称一定要配置成相同，默认值elasticsearchcluster.name: test-elk# 节点名称，默认值当前节点部署所在机器的主机名node.name: node-1# 数据存储路径，默认值 $ES_HOME/datapath.data: /usr/local/elasticsearch/data# 日志存储路径，默认值 $ES_HOME/logspath.logs: /usr/local/elasticsearch/logs# 配置ES启动时是否进行内存锁定检查，默认值true，本机内存比较小时设置为falsebootstrap.memory_lock: false# 允许通过任何地址访问，开启远程访问network.host: 0.0.0.0# 配置当前ES节点对外提供服务的http端口，默认 9200http.port: 9200# 配置当前ES节点对外提供服务的tcp端口，默认 9300transport.port: 9300# 集群内的主机列表，单节点启动时可以不配置# discovery.seed_hosts: [&quot;127.0.0.1&quot;]# 第一次启动时需要参与选主的节点名称cluster.initial_master_nodes: [&quot;node-1&quot;]#解决跨域问题http.cors.enabled: truehttp.cors.allow-origin: &quot;*&quot; 启动ElasticSearch服务 进入/usr/local/elasticsearch/elasticsearch-8.17.3目录，执行以下命令启动服务 123./bin/elasticsearch# 后台启动./bin/elasticsearch -d ES启动前的引导检查 ES启动时，默认会进行引导检查，所谓引导检查就是在服务启动之前对一些重要的配置项进行检查，检查其配置值是否是合理的。引导检查包括对JVM大小、内存锁、虚拟内存、最大线程数、集群发现相关配置等相关的检查，如果某一项或者几项的配置不合理，ES会拒绝启动服务。 如果启动服务时，报以下错误，则需要解决引导检查中的问题 1.max virtual memory areas vm.max_map_count [65530] is too low, increase to at least [262144]; 原因：最大虚拟内存太小,调大系统的虚拟内存 解决办法： 123456# root用户下运行vim /etc/sysctl.conf# 追加以下内容：vm.max_map_count=262144# 保存退出之后执行如下命令：sysctl -p 2.max file descriptors [4096] for elasticsearch process is too low, increase to at least [65536] 原因：文件描述符太小，调大系统的文件描述符 解决办法： 1234567# root用户下运行vim /etc/security/limits.conf# 末尾添加如下配置：* soft nofile 65536* hard nofile 65536* soft nproc 4096* hard nproc 4096 如果只是单节点的开发环境，则可以关闭引导检查，生成环境不建议这样做，因为关闭引导检查后，ES服务将无法保证集群的高可用性。 12345# 进入elasticsearch安装目录vim config/elasticsearch.yml# 添加如下配置：# 指定节点为单节点，可以绕过引导检查discovery.type: single-node 服务正常启动后仍然不能正常访问 访问服务 12curl http://127.0.0.1:9200curl: (52) Empty reply from server 查看日志/usr/local/elasticsearch/elasticsearch-8.17.3/logs/test-elk.log，发现报如下警告： 1[WARN ][o.e.h.n.Netty4HttpServerTransport] [node-1] received plaintext http traffic on an https channel, closing connection Netty4HttpChannel&#123;localAddress=/127.0.0.1:9200, remoteAddress=/127.0.0.1:38426&#125; 原因是ES在启动服务时默认开启了 X-Pack 安全功能，查看配置文件/usr/local/elasticsearch/elasticsearch-8.17.3/config/elasticsearch.yml，发现配置项xpack.security.xxx相关配置项被自动添加了，如下： 123456789101112131415161718192021222324252627282930313233#----------------------- BEGIN SECURITY AUTO CONFIGURATION -----------------------## The following settings, TLS certificates, and keys have been automatically# generated to configure Elasticsearch security features on 20-03-2025 08:53:20## --------------------------------------------------------------------------------# Enable security features# 启用 Elasticsearch 的安全特性，包括用户认证、角色管理、加密等。# 开启了 X-Pack 安全功能，这意味着你需要进行用户认证才能访问 Elasticsearch。# 如果需要关闭 X-Pack 安全功能，你可以将 xpack.security.enabled 设置为 false。xpack.security.enabled: true# 启用安全注册功能，允许通过交互式向导来配置安全设置。# 这使得你可以通过 Kibana 或命令行工具来自动配置 SSL 证书和其他安全设置。xpack.security.enrollment.enabled: true# Enable encryption for HTTP API client connections, such as Kibana, Logstash, and Agents# 启用 HTTP API 客户端连接的加密# Kibana、Logstash 和其他通过 HTTP API 连接到 Elasticsearch 的客户端将使用 HTTPS 进行通信，增强安全性。xpack.security.http.ssl: enabled: true # 启用 HTTP 层的 SSL 加密，即https访问，确保客户端与 Elasticsearch 之间的通信是加密的。设置为false时，关闭加密，即http访问 keystore.path: certs/http.p12 # 指定用于 HTTP 层加密的密钥库文件路径。这是一个 PKCS12 文件，包含用于加密和验证的公钥和私钥。# Enable encryption and mutual authentication between cluster nodes# 启用节点间的加密和双向认证# Elasticsearch 集群中的节点之间的通信将使用 SSL 加密，并且每个节点都会验证其他节点的身份，从而增强集群的安全性。# 所有节点要配置相同的证书xpack.security.transport.ssl: enabled: true # 启用传输层的 SSL 加密，确保节点之间的内部通信是加密的。 verification_mode: certificate # 设置验证模式为 certificate，这意味着节点之间需要双向认证（即每个节点都需要验证对方的身份）。 keystore.path: certs/transport.p12 # 指定用于传输层加密的密钥库文件路径。这是另一个 PKCS12 文件，包含用于加密和验证的公钥和私钥。 truststore.path: certs/transport.p12 # 指定用于存储信任证书的信任库文件路径。这通常与密钥库相同，但可以不同。#----------------------- END SECURITY AUTO CONFIGURATION ------------------------- 解决方法： 1.不想开启安全认证，将 xpack.security.enabled 设置为 false，这样即便下面的配置都设置为true也不会有效。 2.不想https访问，将 xpack.security.http.ssl.enabled 设置为 false，但这样会导致无法通过认证Token添加其它节点或Kibana。 3.不想节点间通信加密，将 xpack.security.transport.ssl.enabled 设置为 false 为了保证ES的安全，我这里就开启安全认证，并且通过https访问ES，但此时我们访问ES的API就需要带上认证用户，那么用户名和密码是什么呢？ 实际上在ES第一次正常启动时其日志中就打印了自动配置的安全相关的信息提示，里面就给出了登录用户和初始的密码，如下： 1234567891011121314151617181920212223242526272829303132━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━# 这些日志信息提供了 Elasticsearch 8 在首次启动时自动配置的安全特性、生成的默认密码、证书指纹以及如何配置 Kibana 和其他节点加入集群的详细说明。✅ Elasticsearch security features have been automatically configured!✅ Authentication is enabled and cluster connections are encrypted.# 这是 elastic 用户的默认密码。系统建议你使用 bin/elasticsearch-reset-password -u elastic 命令来重置此密码。ℹ️ Password for the elastic user (reset with `bin/elasticsearch-reset-password -u elastic`): BNb=*qz6_M*mXL9uZiSP # 这里会打印出ES自动生成的密码# 这是 HTTP CA 证书的 SHA-256 指纹。CA 证书用于验证 HTTPS 连接的身份。ℹ️ HTTP CA certificate SHA-256 fingerprint: 3f141c16dfc6e165894bc1672084b220dcdd22ffe02116d51ac18003cfaa5a1d# 提供了将 Kibana 配置为使用此 Elasticsearch 集群的步骤。ℹ️ Configure Kibana to use this cluster:# 启动 Kibana 并按照终端中显示的配置链接进行操作。• Run Kibana and click the configuration link in the terminal when Kibana starts.# 复制提供的注册令牌，并在浏览器中打开 Kibana 时粘贴此令牌。令牌在接下来的 30 分钟内有效。# 补充说明：生成新的kibana注册令牌：bin/elasticsearch-create-enrollment-token -s kibana• Copy the following enrollment token and paste it into Kibana in your browser (valid for the next 30 minutes): eyJ2ZXIiOiI4LjE0LjAiLCJhZHIiOlsiMTAuMjUwLjAuMjM5OjkyMDAiXSwiZmdyIjoiM2YxNDFjMTZkZmM2ZTE2NTg5NGJjMTY3MjA4NGIyMjBkY2RkMjJmZmUwMjExNmQ1MWFjMTgwMDNjZmFhNWExZCIsImtleSI6ImFSWFBzcFVCTVVmc1d5aUJnbjBtOmRzbVBLQV95UXhDZkJpXzQyWDNEMVEifQ==# 提供了将新的 Elasticsearch 节点加入现有集群的步骤。ℹ️ Configure other nodes to join this cluster:# 使用 bin/elasticsearch --enrollment-token &lt;token&gt; 命令启动新的 Elasticsearch 节点。令牌在接下来的 30 分钟内有效。# 补充说明：生成新的节点注册令牌：bin/elasticsearch-create-enrollment-token -s node• Copy the following enrollment token and start new Elasticsearch nodes with `bin/elasticsearch --enrollment-token &lt;token&gt;` (valid for the next 30 minutes): eyJ2ZXIiOiI4LjE0LjAiLCJhZHIiOlsiMTAuMjUwLjAuMjM5OjkyMDAiXSwiZmdyIjoiM2YxNDFjMTZkZmM2ZTE2NTg5NGJjMTY3MjA4NGIyMjBkY2RkMjJmZmUwMjExNmQ1MWFjMTgwMDNjZmFhNWExZCIsImtleSI6ImF4WFBzcFVCTVVmc1d5aUJnbjFtOkFEallPdnpzUzh1MGJqOFpfVFE4a3cifQ==# 如果你在 Docker 中运行 Elasticsearch，可以使用 docker run -e &quot;ENROLLMENT_TOKEN=&lt;token&gt;&quot; docker.elastic.co/elasticsearch/elasticsearch:8.17.3 命令启动新节点。 If you&#x27;re running in Docker, copy the enrollment token and run: `docker run -e &quot;ENROLLMENT_TOKEN=&lt;token&gt;&quot; docker.elastic.co/elasticsearch/elasticsearch:8.17.3`━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 登录用户为elastic[其角色为超级用户]，我们可以通过日志查看初始的密码，也可以通过如下命令重置密码 1234567891011# 重置密码，密码自动生成bin/elasticsearch-reset-password -u elastic# 重置密码，自己输入要设置的密码，比如我这里这是为 123456bin/elasticsearch-reset-password -u elastic -i# 通过curl重置密码curl -X PUT -u elastic:old_password -k &#x27;https://127.0.0.1:9200/_security/user/elastic/_password&#x27; \\ -H &#x27;Content-Type: application/json&#x27; \\ -d &#x27;&#123; &quot;password&quot;: &quot;new_password&quot; &#125;&#x27; curl 访问ES服务 123456789101112131415161718192021222324# -k 忽略证书校验curl -u elastic:123456 -k https://127.0.0.1:9200# 或者 将认证信息通过header传递，elastic:123456 通过base64加密curl -k https://127.0.0.1:9200 -H &#x27;Authorization: Basic ZWxhc3RpYzoxMjM0NTY=&#x27;# 也可以通过证书访问https服务，这个证书就是ES在开启安全认证启动时自动生成的curl -u elastic:123456 --cacert /usr/local/elasticsearch/elasticsearch-8.17.3/config/certs/http_ca.crt https://127.0.0.1:9200# 输出如下：&#123; &quot;name&quot; : &quot;node-1&quot;, &quot;cluster_name&quot; : &quot;test-elk&quot;, &quot;cluster_uuid&quot; : &quot;RykjCSPnSCi4Hsi37uziWw&quot;, &quot;version&quot; : &#123; &quot;number&quot; : &quot;8.17.3&quot;, &quot;build_flavor&quot; : &quot;default&quot;, &quot;build_type&quot; : &quot;tar&quot;, &quot;build_hash&quot; : &quot;a091390de485bd4b127884f7e565c0cad59b10d2&quot;, &quot;build_date&quot; : &quot;2025-02-28T10:07:26.089129809Z&quot;, &quot;build_snapshot&quot; : false, &quot;lucene_version&quot; : &quot;9.12.0&quot;, &quot;minimum_wire_compatibility_version&quot; : &quot;7.17.0&quot;, &quot;minimum_index_compatibility_version&quot; : &quot;7.0.0&quot; &#125;, &quot;tagline&quot; : &quot;You Know, for Search&quot;&#125; 开发模式和生产模式 开发模式：如果用户只是出于学习目的，可以在配置文件中添加 discovery.type=single-node ，表示单节点模式，即开发模式。此模式可以绕过引导检查。 生产模式：当用户配置了有关集群的相关配置项时就会触发生产模式，在生产模式下，服务启动会触发ES的引导检查或者叫启动检查（bootstrap checks），引导检查十分严格，即某些检查项不通过则ES服务将无法启动。 引导检查：在服务启动之前对一些重要的配置项进行检查，检查其配置值是否是合理的。引导检查包括对JVM大小、内存锁、虚拟内存、最大线程数、集群发现相关配置等相关的检查，如果某一项或者几项的配置不合理，ES会拒绝启动服务，并且在开发模式下的某些警告信息会升级成错误信息输出。引导检查十分严格，之所以宁可拒绝服务也要阻止用户启动服务是为了防止用户在对ES的基本使用不了解的前提下启动服务而导致的后期性能问题无法解决或者解决起来很麻烦。因为一旦服务以某种不合理的配置启动，时间久了之后可能会产生较大的性能问题，但此时集群已经变得难以维护和扩展，ES为了避免这种情况而做出了引导检查的设置，本来在开发模式下为警告的启动日志会升级为报错（Error）。这种设定虽然增加了用户的使用门槛，但是避免了日后产生更大的问题。 ES浏览器插件 Elasticvue : chrome/edge 插件，用于在浏览器中查看ES集群信息，功能非常强大 ES自启动脚本 1234567891011121314151617181920212223242526272829303132333435# 创建服务文件$ vim /usr/lib/systemd/system/es.service[Unit]Description=elasticsearchDocumentation=https://www.elastic.coAfter=network.target[Service]Type=simplePrivateTmp=true# 指定ES用户User=elasticGroup=elasticLimitNOFILE=100000LimitNPROC=100000Restart=yes# 启动命令ExecStart=/usr/local/elasticsearch/elasticsearch-8.17.3/bin/elasticsearchExecRestart=/bin/kill -s HUP $MAINPIDExecStop=/bin/kill -s QUIT $MAINPID[Install]WantedBy=multi-user.target# 重新加载$ systemctl daemon-reload# 启动$ systemctl start es# 停止$ systemctl stop es# 查看状态$ systemctl status es# 设置开机启动$ systemctl enable es 通过ApiKey访问ES 关于ApiKey的详细介绍，可以参考官方文档 创建ApiKey 123456789101112131415161718192021222324252627282930curl -k &#x27;https://127.0.0.1:9200/_security/api_key?pretty&#x27; \\-u elastic:123456 \\--header &#x27;Content-Type: application/json&#x27; \\--data &#x27;&#123; &quot;name&quot;: &quot;elastic_api_key&quot;, &quot;expiration&quot;: &quot;1d&quot;&#125;&#x27;# 请求参数说明：# name: ApiKey的名称# expiration: ApiKey的过期时间，这里设置为一天，如果不设置，则永不过期# 请求参数中还有一个重要的参数 `role_descriptors`，其含义是，指定ApiKey所拥有的权限，即角色。如果不进行设置，则默认使用当前认证用户的的角色# metadata: ApiKey的元数据，即自定义的键值对，这里可以不设置# 输出：&#123; &quot;id&quot;:&quot;70It0ZUBrL2GcOxX0d1L&quot;, &quot;name&quot;:&quot;elastic_api_key&quot;, &quot;expiration&quot;:1743057595723, &quot;api_key&quot;:&quot;s85lqVkmQISkBlgXCTJmDQ&quot;, &quot;encoded&quot;:&quot;NzBJdDBaVUJyTDJHY094WDBkMUw6czg1bHFWa21RSVNrQmxnWENUSm1EUQ==&quot;&#125;# 输出参数说明：# id: ApiKey的id# name: ApiKey的名称# expiration: ApiKey的过期时间，单位为毫秒# api_key: ApiKey的密钥# encoded: 对 `id:api_key` 进行base64编码，即可得到 `encoded` # echo -n &#x27;70It0ZUBrL2GcOxX0d1L:s85lqVkmQISkBlgXCTJmDQ&#x27; | base64 # 输出： # NzBJdDBaVUJyTDJHY094WDBkMUw6czg1bHFWa21RSVNrQmxnWENUSm1EUQ== 使用ApiKey访问ES 123456789101112131415161718192021# 这里的ApiKey，就是上面输出的encodedcurl -k &#x27;https://127.0.0.1:9200?pretty&#x27; \\-H &#x27;Authorization: ApiKey NzBJdDBaVUJyTDJHY094WDBkMUw6czg1bHFWa21RSVNrQmxnWENUSm1EUQ==&#x27;# 输出&#123; &quot;name&quot; : &quot;node-1&quot;, &quot;cluster_name&quot; : &quot;test-elk&quot;, &quot;cluster_uuid&quot; : &quot;RykjCSPnSCi4Hsi37uziWw&quot;, &quot;version&quot; : &#123; &quot;number&quot; : &quot;8.17.3&quot;, &quot;build_flavor&quot; : &quot;default&quot;, &quot;build_type&quot; : &quot;tar&quot;, &quot;build_hash&quot; : &quot;a091390de485bd4b127884f7e565c0cad59b10d2&quot;, &quot;build_date&quot; : &quot;2025-02-28T10:07:26.089129809Z&quot;, &quot;build_snapshot&quot; : false, &quot;lucene_version&quot; : &quot;9.12.0&quot;, &quot;minimum_wire_compatibility_version&quot; : &quot;7.17.0&quot;, &quot;minimum_index_compatibility_version&quot; : &quot;7.0.0&quot; &#125;, &quot;tagline&quot; : &quot;You Know, for Search&quot;&#125; 查看ApiKey信息，参考官方文档 123456789curl -u elastic:123456 -k &#x27;https://127.0.0.1:9200/_security/api_key?name=elastic_api_key&amp;pretty&#x27;# 请求参数说明：# name: ApiKey的名称，不同的ApiKey可以拥有相同的名称，但id不同，所以通过name进行查询可能会返回多个结果# 或者 id: ApiKey的id，建议通过id进行查询，id唯一，所以通过id进行查询只会返回一个结果# username: 查询指定用户的ApiKey# owner: 是否只查询当前认证用户名下的ApiKey，默认为false，为false时必须至少设置name\\ids\\username中的一个参数# 不加任何参数进行查询，则返回所有ApiKey的信息curl -u elastic:123456 -k &#x27;https://127.0.0.1:9200/_security/api_key?pretty&#x27; 更新ApiKey，参考官方文档 12345678910111213141516171819202122232425262728curl -u elastic:123456 -X PUT -k &#x27;https://127.0.0.1:9200/_security/api_key/&#123;ApiKeyId&#125;?pretty&#x27; \\--header &#x27;Content-Type: application/json&#x27; \\--data &#x27;&#123; &quot;expiration&quot;: &quot;1h&quot;, &quot;role_descriptors&quot;: &#123; &quot;role-a&quot;: &#123; &quot;indices&quot;: [ &#123; &quot;names&quot;: [&quot;*&quot;], &quot;privileges&quot;: [&quot;write&quot;] &#125; ] &#125; &#125;, &quot;metadata&quot;: &#123; &quot;environment&quot;: &#123; &quot;level&quot;: 2, &quot;trusted&quot;: true, &quot;tags&quot;: [&quot;production&quot;] &#125; &#125;&#125;&#x27;# 可以更新的参数有：# expiration: ApiKey的过期时间，如果已经设置过expiration，此时希望使其永不过期，则只能将其设置为一个比较大的时间，比如 &quot;expiration&quot;: &quot;100y&quot;# role_descriptors: ApiKey所拥有的角色，原先设置了role_descriptors，更新时希望其使用认证用户的角色，则此时可以将其设置为 &quot;role_descriptors&quot;: &#123;&#125;# metadata: ApiKey的元数据，原先设置了 metadata ，更新时希望去除所有 metadata 信息，则此时可以将其设置为 &quot;metadata&quot;: &#123;&#125;# 注意：三个参数可以只更新其中任何一个，更新哪个就只替换哪个，没有被更新的参数不会受到修改，当然也可以同时更新全部 置ApiKey无效，参考官方文档，官方没有提供删除ApiKey的接口，只有置无效的接口 1234567891011121314151617181920212223curl -u elastic:123456 -X DELETE -k &#x27;https://127.0.0.1:9200/_security/api_key?pretty&#x27; \\--header &#x27;Content-Type: application/json&#x27; \\--data &#x27;&#123; &quot;name&quot;: &quot;elastic_api_key&quot;&#125;&#x27;# 请求参数说明：# name: ApiKey的名称，会# 或者使用 &quot;ids&quot; : [ &quot;70It0ZUBrL2GcOxX0d1L&quot; ] ，通过id进行删除，此时可以一次删除多个ApiKey# username: 删除指定用户的ApiKey# owner: 是否只删除当前认证用户名下的ApiKey，默认为false，为false时必须至少设置name\\ids\\username中的一个参数# 输出：&#123; &quot;invalidated_api_keys&quot;:[ &quot;70It0ZUBrL2GcOxX0d1L&quot; ], &quot;previously_invalidated_api_keys&quot;:[ ], &quot;error_count&quot;:0&#125;# 输出参数说明：# invalidated_api_keys: 被删除的ApiKey的id列表# previously_invalidated_api_keys: 之前被删除的ApiKey的id列表# error_count: 错误数量，如果为0，则表示成功 使用ApiKey的优缺点 优点 12345678910111213安全性: 细粒度控制: API Key 可以与特定的角色描述符关联，允许非常细化的权限控制。这有助于遵循最小权限原则，只授予必要的访问权限。 时间限制: 可以为 API Key 设置过期时间，确保密钥不会永远有效，减少长期泄露的风险。 可撤销性: 如果怀疑某个 API Key 被泄露或不再需要，可以随时撤销该密钥，提高安全性。方便性: 易于生成和管理: 创建和管理 API Key 的过程通常很简单，可以通过 REST API 或 Kibana 界面进行。 无需用户交互: 一旦生成，API Key 可以直接用于自动化脚本或应用程序，无需用户手动登录或提供凭据。审计和监控: 跟踪使用情况: 通过日志记录和审计功能，可以跟踪哪个 API Key 进行了哪些操作，便于安全审计和问题排查。 活动监控: 可以监控 API Key 的活动，及时发现异常行为，并采取相应的措施。灵活性: 多种用途: API Key 可以用于各种用途，如应用程序集成、数据导入导出、监控工具等。 多环境支持: 可以为不同的环境（开发、测试、生产）生成独立的 API Key，确保各环境之间的隔离。 缺点 1234567891011安全性风险: 密钥存储: API Key 需要安全地存储和传输，如果密钥被泄露，攻击者可以利用它进行未授权的操作。 静态凭证: 与动态的身份验证机制（如 OAuth 令牌）相比，API Key 是静态的，一旦泄露可能会导致长期的安全风险。管理复杂性: 密钥管理: 随着时间和使用规模的增长，管理和维护大量 API Key 可能会变得复杂。需要定期更新和撤销老旧的密钥。 角色分配: 细粒度的权限控制虽然提供了安全性，但也增加了配置和管理的复杂性。缺乏用户上下文: 匿名性: API Key 通常没有用户上下文信息，不像基于用户的认证机制（如 Basic Auth 或 OAuth），这可能不利于某些依赖用户身份的功能。依赖客户端配置: 易错性: 如果客户端配置不当，如错误地处理或暴露 API Key，可能会导致安全漏洞。 更新挑战: 更新 API Key 后，所有使用该密钥的客户端都需要同步更新，这在大规模环境中可能是一个挑战。 何时使用 API Key 当您需要为自动化脚本、第三方服务或应用程序提供访问权限时。 当您希望实现细粒度的权限控制并能够轻松管理密钥的生命周期时。 当不需要用户上下文或复杂的用户会话管理时。 示例 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177# 创建ApiKeycurl -X POST -k &#x27;https://127.0.0.1:9200/_security/api_key?pretty&#x27; \\-u elastic:123456 \\--header &#x27;Content-Type: application/json&#x27; \\--data &#x27;&#123; &quot;name&quot;: &quot;my-api-key&quot;, &quot;expiration&quot;: &quot;1d&quot;, &quot;role_descriptors&quot;: &#123; &quot;role-a&quot;: &#123; &quot;cluster&quot;: [&quot;all&quot;], &quot;indices&quot;: [ &#123; &quot;names&quot;: [&quot;index-a*&quot;], &quot;privileges&quot;: [&quot;read&quot;] &#125; ] &#125;, &quot;role-b&quot;: &#123; &quot;cluster&quot;: [&quot;all&quot;], &quot;indices&quot;: [ &#123; &quot;names&quot;: [&quot;index-b*&quot;], &quot;privileges&quot;: [&quot;all&quot;] &#125; ] &#125; &#125;, &quot;metadata&quot;: &#123; &quot;application&quot;: &quot;my-application&quot;, &quot;environment&quot;: &#123; &quot;level&quot;: 1, &quot;trusted&quot;: true, &quot;tags&quot;: [&quot;dev&quot;, &quot;staging&quot;] &#125; &#125;&#125;&#x27;# name: ApiKey的名称# expiration: ApiKey的过期时间，支持的时间单位为：s（秒），m（分钟），h（小时），d（天），w（周），M（月），y（年） # expiration不能设置小于1分钟的时间，如果省略expiration，则表示无过期时间# role_descriptors: 角色描述符，包含多个角色 # role-a: 角色描述符名称，包含集群和索引的权限描述 # cluster: 集群权限 # all: 表示拥有全部集群权限 # manage: 可以管理集群设置、模板和节点上的分片分配。 # monitor: 可以监视集群的状态。 # manage_security: 可以管理安全设置，如用户、角色和角色映射。 # manage_api_key: 管理 API Key # indices: 索引权限，包含names和privileges， # names: 表示索引名称，index-a*表示所有以index-a开头的索引，all表示所有索引 # privileges: 表示索引权限 # read: 表示拥有索引的读取权限 # write: 表示拥有索引的写入权限 # delete: 表示拥有索引的删除权限 # index: 表示拥有索引的索引权限 # manage: 表示拥有索引的设置和映射权限 # monitor: 表示拥有索引的监控权限 # create_index: 表示允许创建索引 # crud: 组合了 read, index, delete 权限 # all: 表示拥有全部索引权限 # allow_restricted_indices: 表示是否允许对 restricted indices(受限制索引，比如以.开头的索引) 进行操作，true表示允许，false表示不允许# metadata: 元数据 # application: 表示应用程序名称 # environment: 表示环境信息 # level: 表示环境级别 # trusted: 表示是否受信任 # tags: 表示环境标签# 输出：&#123; &quot;id&quot; : &quot;-kKu0ZUBrL2GcOxX0t1R&quot;, &quot;name&quot; : &quot;my-api-key&quot;, &quot;expiration&quot; : 1743066050130, &quot;api_key&quot; : &quot;03eNOYg_SCCHdzc0orsRvw&quot;, &quot;encoded&quot; : &quot;LWtLdTBaVUJyTDJHY094WDB0MVI6MDNlTk9ZZ19TQ0NIZHpjMG9yc1J2dw==&quot;&#125;# 查看ApiKey信息，根据id查询只会返回一个ApiKey，根据name查询会返回多个ApiKeycurl -u elastic:123456 -k &#x27;https://127.0.0.1:9200/_security/api_key?id=-kKu0ZUBrL2GcOxX0t1R&amp;pretty&#x27;# 输出：&#123; &quot;api_keys&quot; : [ &#123; &quot;id&quot; : &quot;-kKu0ZUBrL2GcOxX0t1R&quot;, &quot;name&quot; : &quot;my-api-key&quot;, &quot;type&quot; : &quot;rest&quot;, &quot;creation&quot; : 1742979650130, &quot;expiration&quot; : 1743066050130, &quot;invalidated&quot; : false, &quot;username&quot; : &quot;elastic&quot;, &quot;realm&quot; : &quot;reserved&quot;, &quot;realm_type&quot; : &quot;reserved&quot;, &quot;metadata&quot; : &#123; &quot;environment&quot; : &#123; &quot;level&quot; : 1, &quot;trusted&quot; : true, &quot;tags&quot; : [ &quot;dev&quot;, &quot;staging&quot; ] &#125;, &quot;application&quot; : &quot;my-application&quot; &#125;, &quot;role_descriptors&quot; : &#123; &quot;role-a&quot; : &#123; &quot;cluster&quot; : [ &quot;all&quot; ], &quot;indices&quot; : [ &#123; &quot;names&quot; : [ &quot;index-a*&quot; ], &quot;privileges&quot; : [ &quot;read&quot; ], &quot;allow_restricted_indices&quot; : false &#125; ], &quot;applications&quot; : [ ], &quot;run_as&quot; : [ ], &quot;metadata&quot; : &#123; &#125;, &quot;transient_metadata&quot; : &#123; &quot;enabled&quot; : true &#125; &#125;, &quot;role-b&quot; : &#123; &quot;cluster&quot; : [ &quot;all&quot; ], &quot;indices&quot; : [ &#123; &quot;names&quot; : [ &quot;index-b*&quot; ], &quot;privileges&quot; : [ &quot;all&quot; ], &quot;allow_restricted_indices&quot; : false &#125; ], &quot;applications&quot; : [ ], &quot;run_as&quot; : [ ], &quot;metadata&quot; : &#123; &#125;, &quot;transient_metadata&quot; : &#123; &quot;enabled&quot; : true &#125; &#125; &#125; &#125; ]&#125;# 更新ApiKeycurl -u elastic:123456 -X PUT -k &#x27;https://127.0.0.1:9200/_security/api_key/-kKu0ZUBrL2GcOxX0t1R?pretty&#x27; \\--header &#x27;Content-Type: application/json&#x27; \\--data &#x27;&#123; &quot;metadata&quot;: &#123;&#125;&#125;&#x27;# 输出：&#123; &quot;updated&quot; : true&#125;# 置ApiKey无效curl -u elastic:123456 -X DELETE -k &#x27;https://127.0.0.1:9200/_security/api_key?pretty&#x27; \\--header &#x27;Content-Type: application/json&#x27; \\--data &#x27;&#123; &quot;ids&quot; : [ &quot;-kKu0ZUBrL2GcOxX0t1R&quot; ]&#125;&#x27;# 输出：&#123; &quot;invalidated_api_keys&quot; : [ &quot;-kKu0ZUBrL2GcOxX0t1R&quot; ], &quot;previously_invalidated_api_keys&quot; : [ ], &quot;error_count&quot; : 0&#125;","summary":"摘要 本文介绍如何在linux下安装Elasticsearch Elasticsearch版本8.17.3","date_published":"2025-03-20T13:30:05.000Z","tags":["技术","elastic","elasticsearch","elasticsearch"]},{"id":"https://blog.hanqunfeng.com/2025/03/13/npm-study/","url":"https://blog.hanqunfeng.com/2025/03/13/npm-study/","title":"npm使用手册","content_html":"<!--\n **加粗**\n *斜体*\n ***加粗并斜体***\n ~~删除线~~\n ==突出显示==\n `突出显示(推荐)`\n ++下划线++\n ~下标~\n ^上标^\n 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.\n 图片设置宽度和高度(通过uPic上传后，需要将upic修改过为blog，用于添加水印) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)\n\n +++ **点击折叠**\n 这是被隐藏的内容\n +++\n\n::: tips success warning danger\n这里是容器内的内容\n:::\n\n% note info % success warning danger\n这里是容器内的内容\n% endnote %\n\n引用本地其它文章连接{}\n 大括号开始% post_link 文件名称(不包含.md) %大括号结束\n -->\n<h2 id=\"摘要\">摘要</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>本文介绍如何使用npm</p>\n</li>\n<li class=\"lvl-2\">\n<p>npm版本10.5.0</p>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"npm简介\">npm简介</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>npm（Node Package Manager）是 Node.js 的包管理工具，也是 JavaScript 编程社区中最常用的管理和分享代码的工具。</p>\n</li>\n<li class=\"lvl-2\">\n<p>它允许开发者轻松地安装、共享、和管理在项目中使用的 JavaScript 包。</p>\n</li>\n<li class=\"lvl-2\">\n<p>npm 分为两个主要部分：命令行工具（CLI）和 npm 注册表。</p>\n</li>\n<li class=\"lvl-2\">\n<p>命令行工具（CLI）：用于与注册表进行交互，安装和管理项目中的依赖。</p>\n</li>\n<li class=\"lvl-2\">\n<p>npm 注册表：一个在线的数据库，存储了数百万个开源的 Node.js 包，开发者可以在自己的项目中使用这些包。</p>\n</li>\n</ul>\n<h2 id=\"npm-的安装与配置\">npm 的安装与配置</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>npm 通常与 Node.js 一起安装，因此安装 Node.js 会自动安装 npm。</p>\n</li>\n<li class=\"lvl-2\">\n<p>从 <a href=\"https://nodejs.org/zh-cn\">Node.js 官网</a>下载并安装 Node.js。</p>\n</li>\n<li class=\"lvl-2\">\n<p>跟随<a href=\"https://nodejs.org/zh-cn/download\">Node.js 官网–Download</a>的提示完成 Node.js 的安装，</p>\n</li>\n<li class=\"lvl-2\">\n<p>现在官方更推荐使用<a href=\"https://github.com/nvm-sh/nvm\">nvm</a>的方式进行安装，当然你也可以选择对应系统的二进制包进行安装（此种方法要将node的bin目录配置到PATH环境变量），node.js安装完成后，npm 也会一起安装。</p>\n</li>\n<li class=\"lvl-2\">\n<p>打开命令行或终端工具，输入以下命令来验证是否成功安装</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm -v</span><br><span class=\"line\">node -v</span><br></pre></td></tr></table></figure>\n<h2 id=\"npm-常用命令\">npm 常用命令</h2>\n<h3 id=\"npm-init：初始化项目\">npm init：初始化项目</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>npm init命令用于初始化一个新的 Node.js 项目，生成一个package.json文件，其中包含项目的元数据和配置。</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">mkdir</span> my-project</span><br><span class=\"line\"><span class=\"built_in\">cd</span> my-project</span><br><span class=\"line\">npm init</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>执行该命令后，会按照提示输入一些项目相关的信息，如名称、版本、描述等。也可以使用 <code>npm init -y</code> 跳过提示，生成一个默认的package.json文件。</p>\n</li>\n</ul>\n<h3 id=\"npm-create：基于模板创建项目\">npm create：基于模板创建项目</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>npm create命令用于基于模板创建一个新的 Node.js 项目，比如我们创建一个基于Vue的Web项目，可以执行以下命令：</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm create vue@latest</span><br></pre></td></tr></table></figure>\n<h3 id=\"npm-install：安装依赖包\">npm install：安装依赖包</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>npm install命令用于安装项目中所需的依赖包，比如在package.json文件中指定了依赖包，可以执行以下命令：</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm install</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>安装完成后，会在node_modules目录下生成依赖包，并更新package-lock.json文件。</p>\n</li>\n<li class=\"lvl-2\">\n<p>安装指定依赖包，默认安装最新版，自动将依赖包添加到 package.json 的 “dependencies” 部分。</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm install express</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>如果需要安装特定的版本，可以执行以下命令：</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm install express@4.17.1</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>安装开发依赖包，安装并写入package.json的&quot;devDependencies&quot;中</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm install express -D</span><br><span class=\"line\"><span class=\"comment\"># 等价于</span></span><br><span class=\"line\">npm install express --save-dev</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>安装全局依赖包</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 全局安装的包会被安装到全局的node_modules目录下，不会被安装到项目目录下，也不会出现在package.json中</span></span><br><span class=\"line\">npm install express -g</span><br><span class=\"line\"><span class=\"comment\"># 等价于</span></span><br><span class=\"line\">npm install express --global</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 全局node_modules目录路径查看</span></span><br><span class=\"line\">npm root -g</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>从本地安装依赖包</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 从本地安装</span></span><br><span class=\"line\">npm install ./path/to/local_project</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>从远程Git仓库安装依赖包</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 安装公共项目：</span></span><br><span class=\"line\"><span class=\"comment\"># npm install https://github.com/user_name/node_project</span></span><br><span class=\"line\">npm install https://github.com/trentm/json.git</span><br><span class=\"line\"><span class=\"comment\"># 缩写，如果是gitlab仓库，则需要使用gitlab前缀，推荐使用上面的完整语义版本</span></span><br><span class=\"line\">npm install github:trentm/json</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 安装特定提交：</span></span><br><span class=\"line\"><span class=\"comment\"># npm install https://github.com/user_name/node_project#commit</span></span><br><span class=\"line\">npm install https://github.com/trentm/json.git\\#6912b25272312d0f13ad32e98ebc1b4deb6334cc</span><br><span class=\"line\"><span class=\"comment\"># 安装特定分支：</span></span><br><span class=\"line\"><span class=\"comment\"># npm install https://github.com/user_name/node_project#branchName</span></span><br><span class=\"line\">npm install https://github.com/trentm/json.git\\#streaming</span><br><span class=\"line\"><span class=\"comment\"># 通过标签安装：</span></span><br><span class=\"line\"><span class=\"comment\"># npm install https://github.com/user_name/node_project#tag</span></span><br><span class=\"line\">npm install https://github.com/trentm/json.git\\#10.0.0</span><br><span class=\"line\"><span class=\"comment\"># 安装特定版本：</span></span><br><span class=\"line\"><span class=\"comment\"># npm install https://github.com/user_name/node_project#version</span></span><br><span class=\"line\">npm install https://github.com/trentm/json.git\\#10.0.0</span><br><span class=\"line\"><span class=\"comment\"># 完整的语义版本：</span></span><br><span class=\"line\">npm install https://github.com/trentm/json.git\\#semver:v10.0.0</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 使用git的ssh repo link 安装私有库：后面同样可以接 commit、branchName、tag、version等</span></span><br><span class=\"line\"><span class=\"comment\"># npm install git+ssh://git@github.com:user_name/node_project.git</span></span><br><span class=\"line\">npm install git+ssh://git@github.com/trentm/json.git</span><br></pre></td></tr></table></figure>\n<h3 id=\"npm-update：更新依赖包\">npm update：更新依赖包</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>npm update命令用于更新项目中的依赖包，比如要更新express依赖包到最新版本，可以执行以下命令：</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 更新生产环境依赖包</span></span><br><span class=\"line\">npm update express</span><br><span class=\"line\"><span class=\"comment\"># 更新开发环境依赖包</span></span><br><span class=\"line\">npm update express -D</span><br><span class=\"line\"><span class=\"comment\"># 全局更新</span></span><br><span class=\"line\">npm update express -g</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>修改了package.json文件，并希望更新依赖包，可以执行以下命令：</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># #为了避免不必要的麻烦，可以先删除项目中的node_modules文件夹在执行，此时和 npm install 一样</span></span><br><span class=\"line\">npm update</span><br></pre></td></tr></table></figure>\n<h3 id=\"npm-outdate：检查哪些包可以升级\">npm outdate：检查哪些包可以升级</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>npm outdate命令用于检查哪些包可以升级</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 检查当前项目下哪些包可以升级</span></span><br><span class=\"line\">npm outdate</span><br><span class=\"line\"><span class=\"comment\"># 检查指定包</span></span><br><span class=\"line\">npm outdated express</span><br><span class=\"line\"><span class=\"comment\"># 检查全局模块</span></span><br><span class=\"line\">npm outdate -g</span><br><span class=\"line\">npm outdated -g express</span><br></pre></td></tr></table></figure>\n<h3 id=\"npm-upgrade：判断package-json哪些包需要升级\">npm-upgrade：判断package.json哪些包需要升级</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>安装</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm install -g npm-upgrade</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>使用</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 判断package.json哪些包需要升级，用户确认后会自动更新package.json文件，此时只是更新文件，并没有真正升级</span></span><br><span class=\"line\">npm-upgrade</span><br><span class=\"line\"><span class=\"comment\"># 基于package.json中的配置进行升级，可以先删除node_modules再执行，此时和 npm install 一样</span></span><br><span class=\"line\">npm update</span><br></pre></td></tr></table></figure>\n<h3 id=\"npm-list：列出依赖包\">npm list：列出依赖包</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>npm list命令用于列出项目中的依赖包，比如要列出当前项目下的依赖包，可以执行以下命令：</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 此时列出的是package.json中的dependencies依赖包</span></span><br><span class=\"line\">npm list</span><br><span class=\"line\"><span class=\"comment\"># 列出开发依赖包，此时会列出package.json中的devDependencies和dependencies依赖包</span></span><br><span class=\"line\">npm list -D</span><br><span class=\"line\"><span class=\"comment\"># 列出指定包</span></span><br><span class=\"line\">npm list express</span><br><span class=\"line\"><span class=\"comment\"># 列出全局模块</span></span><br><span class=\"line\">npm list -g</span><br><span class=\"line\">npm list -g express</span><br></pre></td></tr></table></figure>\n<h3 id=\"npm-uninstall：卸载依赖包\">npm uninstall：卸载依赖包</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>npm uninstall命令用于卸载项目中的依赖包，比如要卸载express依赖包，可以执行以下命令：</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm uninstall express</span><br><span class=\"line\"><span class=\"comment\"># 删除全局模块</span></span><br><span class=\"line\">npm uninstall -g express</span><br></pre></td></tr></table></figure>\n<h3 id=\"npm-search：搜索依赖包\">npm search：搜索依赖包</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>npm search命令用于搜索依赖包，比如要搜索express依赖包，可以执行以下命令：</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm search express</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>可以使用正则表达式搜索依赖包，比如要搜索以express开头的依赖包，可以执行以下命令：</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm search /^express/</span><br></pre></td></tr></table></figure>\n<h3 id=\"npm-view-npm-info：查看包信息\">npm view == npm info：查看包信息</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>npm view命令用于查看包的信息，比如要查看express依赖包的信息，可以执行以下命令：</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm view express</span><br><span class=\"line\"><span class=\"comment\"># 或者，view与info命令可以互换使用</span></span><br><span class=\"line\">npm info express</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>npm view命令还可以查看包的所有版本信息，比如要查看express依赖包的所有版本信息，可以执行以下命令：</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 此时我们从结果中选择一个版本进行安装即可</span></span><br><span class=\"line\">npm view express versions</span><br></pre></td></tr></table></figure>\n<h3 id=\"npm-home：打开包的主页\">npm home：打开包的主页</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>打开某个 npm 包的主页（通常是 GitHub 主页或 npm 页面）。</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm home express</span><br></pre></td></tr></table></figure>\n<h2 id=\"npm-镜像源\">npm 镜像源</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>npm 默认使用官方的镜像源，但是官方的镜像源速度很慢，我们可以使用第三方的镜像源来加速下载。</p>\n</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm 官方原始镜像网址是：https://registry.npmjs.org/</span><br><span class=\"line\">淘宝 NPM 镜像：http://registry.npmmirror.com</span><br><span class=\"line\">阿里云 NPM 镜像：https://npm.aliyun.com</span><br><span class=\"line\">腾讯云 NPM 镜像：https://mirrors.cloud.tencent.com/npm/</span><br><span class=\"line\">华为云 NPM 镜像：https://mirrors.huaweicloud.com/repository/npm/</span><br><span class=\"line\">网易 NPM 镜像：https://mirrors.163.com/npm/</span><br><span class=\"line\">中国科学技术大学开源镜像站：http://mirrors.ustc.edu.cn/</span><br><span class=\"line\">清华大学开源镜像站：https://mirrors.tuna.tsinghua.edu.cn/</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>可以通过以下命令来查看当前使用的镜像源：</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm config get registry</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>可以通过以下命令来设置镜像源：</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm config <span class=\"built_in\">set</span> registry https://registry.npmmirror.com</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>可以通过以下命令来删除用户配置的镜像源，删除后恢复为默认镜像源：</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm config delete registry</span><br></pre></td></tr></table></figure>\n<h2 id=\"npm-配置\">npm 配置</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>可以通过以下命令来查看npm的配置信息：</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看全局配置信息，只显示用户自定义的配置信息</span></span><br><span class=\"line\">npm config list</span><br><span class=\"line\"><span class=\"comment\"># 查看全局配置信息，显示所有配置信息及其默认缺省值</span></span><br><span class=\"line\">npm config <span class=\"built_in\">ls</span> -l</span><br><span class=\"line\"><span class=\"comment\"># json 格式 显示全部配置信息</span></span><br><span class=\"line\">npm config list --json</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>默认全局配置在当前用户HOME目录下的.npmrc文件中，可以通过以下命令来查看全局配置信息：</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cat</span> ~/.npmrc</span><br><span class=\"line\"><span class=\"built_in\">cat</span> ~/.npmrc | grep registry</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>在项目根目录创建一个.npmrc 文件可以为该项目单独设置 npm 配置。</p>\n</li>\n<li class=\"lvl-2\">\n<p>npm config 允许你控制 npm 的行为，包括 安装目录、代理、日志级别、依赖管理 等。</p>\n</li>\n<li class=\"lvl-2\">\n<p>你可以使用 <code>npm config get &lt;key&gt;</code> 查看值，<code>npm config set &lt;key&gt; &lt;value&gt;</code> 进行修改，<code>npm config delete &lt;key&gt;</code> 删除设置。</p>\n</li>\n<li class=\"lvl-2\">\n<p>npm常用配置</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>配置项</th>\n<th>作用</th>\n<th>默认值</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>prefix</td>\n<td>设置 npm 全局安装的路径（npm install -g 影响的目录）</td>\n<td>环境变量 NODE_HOME 或 /usr/local（系统）</td>\n</tr>\n<tr>\n<td>cache</td>\n<td>npm 的缓存目录</td>\n<td>~/.npm</td>\n</tr>\n<tr>\n<td>registry</td>\n<td>指定 npm 的包管理仓库地址（如官方、淘宝镜像）</td>\n<td><a href=\"https://registry.npmjs.org/\">https://registry.npmjs.org/</a></td>\n</tr>\n<tr>\n<td>strict-ssl</td>\n<td>是否强制使用 HTTPS 进行 npm 操作</td>\n<td>true</td>\n</tr>\n<tr>\n<td>proxy</td>\n<td>配置 HTTP 代理</td>\n<td>null</td>\n</tr>\n<tr>\n<td>https-proxy</td>\n<td>配置 HTTPS 代理</td>\n<td>null</td>\n</tr>\n<tr>\n<td>init-author-name</td>\n<td>设置 package.json 默认作者名称</td>\n<td>“”</td>\n</tr>\n<tr>\n<td>init-author-email</td>\n<td>设置 package.json 默认作者邮箱</td>\n<td>“”</td>\n</tr>\n<tr>\n<td>init-author-url</td>\n<td>设置 package.json 默认作者网站</td>\n<td>“”</td>\n</tr>\n<tr>\n<td>init-license</td>\n<td>设置 package.json 默认许可证</td>\n<td>“ISC”</td>\n</tr>\n<tr>\n<td>init-version</td>\n<td>package.json 默认版本号</td>\n<td>“1.0.0”</td>\n</tr>\n<tr>\n<td>save-exact</td>\n<td>true 时，安装依赖时不使用 ^ 或 ~，直接锁定版本</td>\n<td>false</td>\n</tr>\n<tr>\n<td>engine-strict</td>\n<td>是否强制匹配 package.json 的 engines 字段</td>\n<td>false</td>\n</tr>\n<tr>\n<td>loglevel</td>\n<td>设置日志输出级别（silent, error, warn, notice, info, verbose, silly）</td>\n<td>notice</td>\n</tr>\n<tr>\n<td>fund</td>\n<td>是否显示 package 的资金支持信息</td>\n<td>true</td>\n</tr>\n<tr>\n<td>audit</td>\n<td>是否启用安全审计</td>\n<td>true</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"npm-config-save-exact\">npm config save-exact</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>推荐配置为 true，避免因为版本更新导致依赖包版本不匹配</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm config <span class=\"built_in\">set</span> save-exact <span class=\"literal\">true</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"npm-config-loglevel\">npm config loglevel</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>loglevel 可选值</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>级别</th>\n<th>说明</th>\n<th>适用场景</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>silent</td>\n<td>不输出任何日志（除非发生错误）</td>\n<td>适用于 CI/CD 需要最少日志的环境</td>\n</tr>\n<tr>\n<td>error</td>\n<td>仅显示错误信息</td>\n<td>只关心 npm 运行是否出错</td>\n</tr>\n<tr>\n<td>warn</td>\n<td>显示警告和错误</td>\n<td>发现潜在问题但不影响使用</td>\n</tr>\n<tr>\n<td>notice (默认)</td>\n<td>显示关键信息、警告和错误</td>\n<td>npm 默认值，适合大多数场景</td>\n</tr>\n<tr>\n<td>http</td>\n<td>记录 HTTP 请求的详细信息</td>\n<td>用于调试 npm 下载速度问题</td>\n</tr>\n<tr>\n<td>info</td>\n<td>显示一般信息、依赖安装情况等</td>\n<td>适用于一般开发者调试</td>\n</tr>\n<tr>\n<td>verbose</td>\n<td>详细的调试信息</td>\n<td>适用于深入分析 npm 运行情况</td>\n</tr>\n<tr>\n<td>silly</td>\n<td>最详细的日志，包含所有调试信息</td>\n<td>适用于 npm 开发者或极端调试需求</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>设置方法</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm config <span class=\"built_in\">set</span> loglevel verbose</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>临时使用</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm --loglevel verbose install</span><br><span class=\"line\"><span class=\"comment\"># 或者</span></span><br><span class=\"line\">npm -<span class=\"built_in\">dd</span> install</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#  支持快捷方式的值：</span></span><br><span class=\"line\"><span class=\"comment\"># • -s, --silent: --loglevel silent</span></span><br><span class=\"line\"><span class=\"comment\"># • -q, --quiet: --loglevel warn</span></span><br><span class=\"line\"><span class=\"comment\"># • -d: --loglevel info</span></span><br><span class=\"line\"><span class=\"comment\"># • -dd, --verbose: --loglevel verbose</span></span><br><span class=\"line\"><span class=\"comment\"># • -ddd: --loglevel silly</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"npm-config-timing\">npm config timing</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>timing 是 npm 的一个 日志输出配置项，用于控制是否在命令执行时显示详细的时间信息，默认值为 false。</p>\n</li>\n<li class=\"lvl-2\">\n<p>当 timing 设为 true 时，npm 会在命令执行结束后 打印详细的时间统计信息，包括：</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">每个子任务的执行时间（如解析 package.json、解析 node_modules、下载依赖等）</li>\n<li class=\"lvl-6\">网络请求的耗时</li>\n<li class=\"lvl-6\">依赖解析和安装的耗时</li>\n<li class=\"lvl-6\">整体执行的时间开销</li>\n</ul>\n</li>\n<li class=\"lvl-2\">\n<p>这对分析 npm 性能、优化依赖安装速度非常有用，特别是在大项目或 CI/CD 环境中。</p>\n</li>\n<li class=\"lvl-2\">\n<p>启用 timing</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm config <span class=\"built_in\">set</span> timing <span class=\"literal\">true</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>临时启用</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm --timing install</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>适用场景</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">分析 npm 命令执行时间，优化构建速度</li>\n<li class=\"lvl-6\">CI/CD 环境中排查 npm 安装变慢的原因</li>\n<li class=\"lvl-6\">排查 npm 依赖解析、安装或下载过程的性能瓶颈</li>\n</ul>\n</li>\n<li class=\"lvl-2\">\n<p>一般日常开发：日志会变长，可能影响可读性，所以再没有遇到问题时不建议开启</p>\n</li>\n</ul>\n<h2 id=\"npm、pnpm、yarn-之间的联系和区别\">npm、pnpm、yarn 之间的联系和区别</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>这三者都是 JavaScript 生态中的包管理工具，主要用于安装、管理和运行 Node.js 项目的依赖。它们的关系如下：</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">npm（Node Package Manager）是 Node.js 官方自带的包管理工具。</li>\n<li class=\"lvl-6\"><a href=\"https://classic.yarnpkg.com/en/docs\">yarn（Yet Another Resource Negotiator）</a>是 Facebook 开发的替代 npm 的工具，提供更快、更安全的依赖管理。</li>\n<li class=\"lvl-6\"><a href=\"https://pnpm.io/zh/\">pnpm（Performant npm）</a>是一个更高效的 npm 替代品，使用硬链接和去重机制来减少磁盘占用并加快安装速度。</li>\n</ul>\n</li>\n<li class=\"lvl-2\">\n<p>npm、pnpm、yarn 的主要区别</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>特性</th>\n<th>npm</th>\n<th>yarn</th>\n<th>pnpm</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>默认包管理方式</td>\n<td>直接安装到 node_modules/</td>\n<td>直接安装到 node_modules/</td>\n<td>使用 硬链接 + 共享依赖，占用更少磁盘</td>\n</tr>\n<tr>\n<td>安装速度</td>\n<td>5+ 版本后速度较快，但依赖解析仍有性能问题</td>\n<td>速度较快，支持并行下载</td>\n<td>最快，去重能力强</td>\n</tr>\n<tr>\n<td>磁盘占用</td>\n<td>较大（每个项目都会存一份完整的依赖）</td>\n<td>较大（和 npm 类似）</td>\n<td>最小（共享全局缓存，多个项目共用依赖）</td>\n</tr>\n<tr>\n<td>锁文件</td>\n<td>package-lock.json</td>\n<td>yarn.lock</td>\n<td>pnpm-lock.yaml</td>\n</tr>\n<tr>\n<td>并发安装</td>\n<td>支持（npm 5+ 优化）</td>\n<td>支持（更快）</td>\n<td>支持（最优化）</td>\n</tr>\n<tr>\n<td>全局缓存</td>\n<td>支持（但项目仍会存副本）</td>\n<td>支持（仍会拷贝到 node_modules/）</td>\n<td>强制启用（多个项目共用依赖，节省空间）</td>\n</tr>\n<tr>\n<td>monorepo（多包管理）</td>\n<td>需要手动配置</td>\n<td>支持 Workspaces</td>\n<td>原生支持 Workspaces（最强大）</td>\n</tr>\n<tr>\n<td>命令兼容性</td>\n<td>标准</td>\n<td>兼容 npm，部分不同</td>\n<td>兼容 npm，大部分命令相同</td>\n</tr>\n<tr>\n<td>自动修复 package.json</td>\n<td>是</td>\n<td>是</td>\n<td>是</td>\n</tr>\n<tr>\n<td>生态兼容性</td>\n<td>官方标准，兼容性最好</td>\n<td>兼容 npm，但部分特性不同</td>\n<td>兼容 npm，但采用不同的依赖管理方式</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>常见命令对比</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>任务</th>\n<th>npm</th>\n<th>yarn</th>\n<th>pnpm</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>初始化项目</td>\n<td>npm init</td>\n<td>yarn init</td>\n<td>pnpm init</td>\n</tr>\n<tr>\n<td>安装依赖</td>\n<td>npm install</td>\n<td>yarn install</td>\n<td>pnpm install</td>\n</tr>\n<tr>\n<td>安装特定依赖</td>\n<td>npm install lodash</td>\n<td>yarn add lodash</td>\n<td>pnpm add lodash</td>\n</tr>\n<tr>\n<td>安装开发依赖</td>\n<td>npm install lodash -D</td>\n<td>yarn add lodash -D</td>\n<td>pnpm add lodash -D</td>\n</tr>\n<tr>\n<td>删除依赖</td>\n<td>npm uninstall lodash</td>\n<td>yarn remove lodash</td>\n<td>pnpm remove lodash</td>\n</tr>\n<tr>\n<td>更新依赖</td>\n<td>npm update lodash</td>\n<td>yarn upgrade lodash</td>\n<td>pnpm update lodash</td>\n</tr>\n<tr>\n<td>全局安装</td>\n<td>npm install -g serve</td>\n<td>yarn global add serve</td>\n<td>pnpm add -g serve</td>\n</tr>\n<tr>\n<td>运行脚本</td>\n<td>npm run dev</td>\n<td>yarn dev</td>\n<td>pnpm dev</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>什么时候使用 npm、yarn、pnpm？</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">\n<p>✅ 使用 pnpm（推荐）：<br>\n1.你希望减少磁盘占用、加快安装速度<br>\n2.你正在开发 monorepo（多包）项目<br>\n3.你希望更高效地管理依赖</p>\n</li>\n<li class=\"lvl-6\">\n<p>✅ 使用 yarn：<br>\n1.你希望更快的安装速度，但又不想改变 npm 传统结构<br>\n2.你的团队习惯使用 yarn.lock 文件<br>\n3.你在用 React Native（官方推荐 yarn）</p>\n</li>\n<li class=\"lvl-6\">\n<p>✅ 使用 npm（适合简单项目）：<br>\n1.你希望使用 Node.js 官方的默认工具<br>\n2.你不想安装额外的包管理工具<br>\n3.你在开发小型项目，不需要 workspaces</p>\n</li>\n</ul>\n</li>\n</ul>\n","content_text":"摘要 本文介绍如何使用npm npm版本10.5.0 npm简介 npm（Node Package Manager）是 Node.js 的包管理工具，也是 JavaScript 编程社区中最常用的管理和分享代码的工具。 它允许开发者轻松地安装、共享、和管理在项目中使用的 JavaScript 包。 npm 分为两个主要部分：命令行工具（CLI）和 npm 注册表。 命令行工具（CLI）：用于与注册表进行交互，安装和管理项目中的依赖。 npm 注册表：一个在线的数据库，存储了数百万个开源的 Node.js 包，开发者可以在自己的项目中使用这些包。 npm 的安装与配置 npm 通常与 Node.js 一起安装，因此安装 Node.js 会自动安装 npm。 从 Node.js 官网下载并安装 Node.js。 跟随Node.js 官网–Download的提示完成 Node.js 的安装， 现在官方更推荐使用nvm的方式进行安装，当然你也可以选择对应系统的二进制包进行安装（此种方法要将node的bin目录配置到PATH环境变量），node.js安装完成后，npm 也会一起安装。 打开命令行或终端工具，输入以下命令来验证是否成功安装 12npm -vnode -v npm 常用命令 npm init：初始化项目 npm init命令用于初始化一个新的 Node.js 项目，生成一个package.json文件，其中包含项目的元数据和配置。 123mkdir my-projectcd my-projectnpm init 执行该命令后，会按照提示输入一些项目相关的信息，如名称、版本、描述等。也可以使用 npm init -y 跳过提示，生成一个默认的package.json文件。 npm create：基于模板创建项目 npm create命令用于基于模板创建一个新的 Node.js 项目，比如我们创建一个基于Vue的Web项目，可以执行以下命令： 1npm create vue@latest npm install：安装依赖包 npm install命令用于安装项目中所需的依赖包，比如在package.json文件中指定了依赖包，可以执行以下命令： 1npm install 安装完成后，会在node_modules目录下生成依赖包，并更新package-lock.json文件。 安装指定依赖包，默认安装最新版，自动将依赖包添加到 package.json 的 “dependencies” 部分。 1npm install express 如果需要安装特定的版本，可以执行以下命令： 1npm install express@4.17.1 安装开发依赖包，安装并写入package.json的&quot;devDependencies&quot;中 123npm install express -D# 等价于npm install express --save-dev 安装全局依赖包 1234567# 全局安装的包会被安装到全局的node_modules目录下，不会被安装到项目目录下，也不会出现在package.json中npm install express -g# 等价于npm install express --global# 全局node_modules目录路径查看npm root -g 从本地安装依赖包 12# 从本地安装npm install ./path/to/local_project 从远程Git仓库安装依赖包 123456789101112131415161718192021222324# 安装公共项目：# npm install https://github.com/user_name/node_projectnpm install https://github.com/trentm/json.git# 缩写，如果是gitlab仓库，则需要使用gitlab前缀，推荐使用上面的完整语义版本npm install github:trentm/json# 安装特定提交：# npm install https://github.com/user_name/node_project#commitnpm install https://github.com/trentm/json.git\\#6912b25272312d0f13ad32e98ebc1b4deb6334cc# 安装特定分支：# npm install https://github.com/user_name/node_project#branchNamenpm install https://github.com/trentm/json.git\\#streaming# 通过标签安装：# npm install https://github.com/user_name/node_project#tagnpm install https://github.com/trentm/json.git\\#10.0.0# 安装特定版本：# npm install https://github.com/user_name/node_project#versionnpm install https://github.com/trentm/json.git\\#10.0.0# 完整的语义版本：npm install https://github.com/trentm/json.git\\#semver:v10.0.0# 使用git的ssh repo link 安装私有库：后面同样可以接 commit、branchName、tag、version等# npm install git+ssh://git@github.com:user_name/node_project.gitnpm install git+ssh://git@github.com/trentm/json.git npm update：更新依赖包 npm update命令用于更新项目中的依赖包，比如要更新express依赖包到最新版本，可以执行以下命令： 123456# 更新生产环境依赖包npm update express# 更新开发环境依赖包npm update express -D# 全局更新npm update express -g 修改了package.json文件，并希望更新依赖包，可以执行以下命令： 12# #为了避免不必要的麻烦，可以先删除项目中的node_modules文件夹在执行，此时和 npm install 一样npm update npm outdate：检查哪些包可以升级 npm outdate命令用于检查哪些包可以升级 1234567# 检查当前项目下哪些包可以升级npm outdate# 检查指定包npm outdated express# 检查全局模块npm outdate -gnpm outdated -g express npm-upgrade：判断package.json哪些包需要升级 安装 1npm install -g npm-upgrade 使用 1234# 判断package.json哪些包需要升级，用户确认后会自动更新package.json文件，此时只是更新文件，并没有真正升级npm-upgrade# 基于package.json中的配置进行升级，可以先删除node_modules再执行，此时和 npm install 一样npm update npm list：列出依赖包 npm list命令用于列出项目中的依赖包，比如要列出当前项目下的依赖包，可以执行以下命令： 123456789# 此时列出的是package.json中的dependencies依赖包npm list# 列出开发依赖包，此时会列出package.json中的devDependencies和dependencies依赖包npm list -D# 列出指定包npm list express# 列出全局模块npm list -gnpm list -g express npm uninstall：卸载依赖包 npm uninstall命令用于卸载项目中的依赖包，比如要卸载express依赖包，可以执行以下命令： 123npm uninstall express# 删除全局模块npm uninstall -g express npm search：搜索依赖包 npm search命令用于搜索依赖包，比如要搜索express依赖包，可以执行以下命令： 1npm search express 可以使用正则表达式搜索依赖包，比如要搜索以express开头的依赖包，可以执行以下命令： 1npm search /^express/ npm view == npm info：查看包信息 npm view命令用于查看包的信息，比如要查看express依赖包的信息，可以执行以下命令： 123npm view express# 或者，view与info命令可以互换使用npm info express npm view命令还可以查看包的所有版本信息，比如要查看express依赖包的所有版本信息，可以执行以下命令： 12# 此时我们从结果中选择一个版本进行安装即可npm view express versions npm home：打开包的主页 打开某个 npm 包的主页（通常是 GitHub 主页或 npm 页面）。 1npm home express npm 镜像源 npm 默认使用官方的镜像源，但是官方的镜像源速度很慢，我们可以使用第三方的镜像源来加速下载。 12345678npm 官方原始镜像网址是：https://registry.npmjs.org/淘宝 NPM 镜像：http://registry.npmmirror.com阿里云 NPM 镜像：https://npm.aliyun.com腾讯云 NPM 镜像：https://mirrors.cloud.tencent.com/npm/华为云 NPM 镜像：https://mirrors.huaweicloud.com/repository/npm/网易 NPM 镜像：https://mirrors.163.com/npm/中国科学技术大学开源镜像站：http://mirrors.ustc.edu.cn/清华大学开源镜像站：https://mirrors.tuna.tsinghua.edu.cn/ 可以通过以下命令来查看当前使用的镜像源： 1npm config get registry 可以通过以下命令来设置镜像源： 1npm config set registry https://registry.npmmirror.com 可以通过以下命令来删除用户配置的镜像源，删除后恢复为默认镜像源： 1npm config delete registry npm 配置 可以通过以下命令来查看npm的配置信息： 123456# 查看全局配置信息，只显示用户自定义的配置信息npm config list# 查看全局配置信息，显示所有配置信息及其默认缺省值npm config ls -l# json 格式 显示全部配置信息npm config list --json 默认全局配置在当前用户HOME目录下的.npmrc文件中，可以通过以下命令来查看全局配置信息： 12cat ~/.npmrccat ~/.npmrc | grep registry 在项目根目录创建一个.npmrc 文件可以为该项目单独设置 npm 配置。 npm config 允许你控制 npm 的行为，包括 安装目录、代理、日志级别、依赖管理 等。 你可以使用 npm config get &lt;key&gt; 查看值，npm config set &lt;key&gt; &lt;value&gt; 进行修改，npm config delete &lt;key&gt; 删除设置。 npm常用配置 配置项 作用 默认值 prefix 设置 npm 全局安装的路径（npm install -g 影响的目录） 环境变量 NODE_HOME 或 /usr/local（系统） cache npm 的缓存目录 ~/.npm registry 指定 npm 的包管理仓库地址（如官方、淘宝镜像） https://registry.npmjs.org/ strict-ssl 是否强制使用 HTTPS 进行 npm 操作 true proxy 配置 HTTP 代理 null https-proxy 配置 HTTPS 代理 null init-author-name 设置 package.json 默认作者名称 “” init-author-email 设置 package.json 默认作者邮箱 “” init-author-url 设置 package.json 默认作者网站 “” init-license 设置 package.json 默认许可证 “ISC” init-version package.json 默认版本号 “1.0.0” save-exact true 时，安装依赖时不使用 ^ 或 ~，直接锁定版本 false engine-strict 是否强制匹配 package.json 的 engines 字段 false loglevel 设置日志输出级别（silent, error, warn, notice, info, verbose, silly） notice fund 是否显示 package 的资金支持信息 true audit 是否启用安全审计 true npm config save-exact 推荐配置为 true，避免因为版本更新导致依赖包版本不匹配 1npm config set save-exact true npm config loglevel loglevel 可选值 级别 说明 适用场景 silent 不输出任何日志（除非发生错误） 适用于 CI/CD 需要最少日志的环境 error 仅显示错误信息 只关心 npm 运行是否出错 warn 显示警告和错误 发现潜在问题但不影响使用 notice (默认) 显示关键信息、警告和错误 npm 默认值，适合大多数场景 http 记录 HTTP 请求的详细信息 用于调试 npm 下载速度问题 info 显示一般信息、依赖安装情况等 适用于一般开发者调试 verbose 详细的调试信息 适用于深入分析 npm 运行情况 silly 最详细的日志，包含所有调试信息 适用于 npm 开发者或极端调试需求 设置方法 1npm config set loglevel verbose 临时使用 12345678910npm --loglevel verbose install# 或者npm -dd install# 支持快捷方式的值：# • -s, --silent: --loglevel silent# • -q, --quiet: --loglevel warn# • -d: --loglevel info# • -dd, --verbose: --loglevel verbose# • -ddd: --loglevel silly npm config timing timing 是 npm 的一个 日志输出配置项，用于控制是否在命令执行时显示详细的时间信息，默认值为 false。 当 timing 设为 true 时，npm 会在命令执行结束后 打印详细的时间统计信息，包括： 每个子任务的执行时间（如解析 package.json、解析 node_modules、下载依赖等） 网络请求的耗时 依赖解析和安装的耗时 整体执行的时间开销 这对分析 npm 性能、优化依赖安装速度非常有用，特别是在大项目或 CI/CD 环境中。 启用 timing 1npm config set timing true 临时启用 1npm --timing install 适用场景 分析 npm 命令执行时间，优化构建速度 CI/CD 环境中排查 npm 安装变慢的原因 排查 npm 依赖解析、安装或下载过程的性能瓶颈 一般日常开发：日志会变长，可能影响可读性，所以再没有遇到问题时不建议开启 npm、pnpm、yarn 之间的联系和区别 这三者都是 JavaScript 生态中的包管理工具，主要用于安装、管理和运行 Node.js 项目的依赖。它们的关系如下： npm（Node Package Manager）是 Node.js 官方自带的包管理工具。 yarn（Yet Another Resource Negotiator）是 Facebook 开发的替代 npm 的工具，提供更快、更安全的依赖管理。 pnpm（Performant npm）是一个更高效的 npm 替代品，使用硬链接和去重机制来减少磁盘占用并加快安装速度。 npm、pnpm、yarn 的主要区别 特性 npm yarn pnpm 默认包管理方式 直接安装到 node_modules/ 直接安装到 node_modules/ 使用 硬链接 + 共享依赖，占用更少磁盘 安装速度 5+ 版本后速度较快，但依赖解析仍有性能问题 速度较快，支持并行下载 最快，去重能力强 磁盘占用 较大（每个项目都会存一份完整的依赖） 较大（和 npm 类似） 最小（共享全局缓存，多个项目共用依赖） 锁文件 package-lock.json yarn.lock pnpm-lock.yaml 并发安装 支持（npm 5+ 优化） 支持（更快） 支持（最优化） 全局缓存 支持（但项目仍会存副本） 支持（仍会拷贝到 node_modules/） 强制启用（多个项目共用依赖，节省空间） monorepo（多包管理） 需要手动配置 支持 Workspaces 原生支持 Workspaces（最强大） 命令兼容性 标准 兼容 npm，部分不同 兼容 npm，大部分命令相同 自动修复 package.json 是 是 是 生态兼容性 官方标准，兼容性最好 兼容 npm，但部分特性不同 兼容 npm，但采用不同的依赖管理方式 常见命令对比 任务 npm yarn pnpm 初始化项目 npm init yarn init pnpm init 安装依赖 npm install yarn install pnpm install 安装特定依赖 npm install lodash yarn add lodash pnpm add lodash 安装开发依赖 npm install lodash -D yarn add lodash -D pnpm add lodash -D 删除依赖 npm uninstall lodash yarn remove lodash pnpm remove lodash 更新依赖 npm update lodash yarn upgrade lodash pnpm update lodash 全局安装 npm install -g serve yarn global add serve pnpm add -g serve 运行脚本 npm run dev yarn dev pnpm dev 什么时候使用 npm、yarn、pnpm？ ✅ 使用 pnpm（推荐）： 1.你希望减少磁盘占用、加快安装速度 2.你正在开发 monorepo（多包）项目 3.你希望更高效地管理依赖 ✅ 使用 yarn： 1.你希望更快的安装速度，但又不想改变 npm 传统结构 2.你的团队习惯使用 yarn.lock 文件 3.你在用 React Native（官方推荐 yarn） ✅ 使用 npm（适合简单项目）： 1.你希望使用 Node.js 官方的默认工具 2.你不想安装额外的包管理工具 3.你在开发小型项目，不需要 workspaces","summary":"摘要 本文介绍如何使用npm npm版本10.5.0","date_published":"2025-03-13T13:30:05.000Z","tags":["技术","npm","nodejs","npm"]},{"id":"https://blog.hanqunfeng.com/2025/01/02/mermaid/","url":"https://blog.hanqunfeng.com/2025/01/02/mermaid/","title":"Hexo-Next 主题的图形工具 -- Mermaid","content_html":"<!--\n **加粗**\n *斜体*\n ***加粗并斜体***\n ~~删除线~~\n ==突出显示==\n `突出显示(推荐)`\n ++下划线++\n ~下标~\n ^上标^\n 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.\n 图片设置宽度和高度(通过uPic上传后，需要将upic修改过为blog，用于添加水印) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)\n\n +++ **点击折叠**\n 这是被隐藏的内容\n +++\n\n::: tips success warning danger\n这里是容器内的内容\n:::\n\n% note info % success warning danger\n这里是容器内的内容\n% endnote %\n\n-->\n<h2 id=\"摘要\">摘要</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><a href=\"https://mermaid.js.org/intro/\">Mermaid</a> 是一个支持在Markdown文档中绘制流程图、甘特图、序列图等图形的工具。它基于JavaScript实现，能够将Markdown中的元素渲染成HTML元素，从而在网页上直观地展示各种图表‌</p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://theme-next.js.org/docs/tag-plugins/mermaid\">Next主题中使用Mermaid说明</a></p>\n</li>\n<li class=\"lvl-2\">\n<p>本文介绍如何在 <code>Hexo-Next</code> 主题中使用 <code>Mermaid</code></p>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"配置和使用方法\">配置和使用方法</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>NexT config file 中找到<code>mermaid</code>配置，并设置为<code>true</code>，<code>theme</code> 可以设置浅色和深色背景的样式，共有4个可用选项</p>\n</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">mermaid:</span></span><br><span class=\"line\">  <span class=\"attr\">enable:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">  <span class=\"comment\"># Available themes: default | dark | forest | neutral</span></span><br><span class=\"line\">  <span class=\"attr\">theme:</span></span><br><span class=\"line\">    <span class=\"attr\">light:</span> <span class=\"string\">dark</span></span><br><span class=\"line\">    <span class=\"attr\">dark:</span> <span class=\"string\">dark</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>使用方法，其中mermaid与endmermaid是固定搭配，type 用于设置图形的种类，如流程图、时序图、甘特图等，下面示例中会介绍</p>\n</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% mermaid type %&#125;</span><br><span class=\"line\">&#123;% endmermaid %&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>有些小伙伴喜欢使用代码块的形式，使用时去掉前面的<code>#</code></p>\n</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#```mermaid</span><br><span class=\"line\">type</span><br><span class=\"line\"></span><br><span class=\"line\">#```</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>但是此时需要在 Hexo config file 中找到<code>highlight</code>，并添加如下内容，才会使代码块的形式生效</p>\n</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">highlight:</span></span><br><span class=\"line\">  <span class=\"attr\">exclude_languages:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">mermaid</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"图形示例\">图形示例</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>这里只介绍常用的一些图表，更多图表的使用方法可以参考<a href=\"https://mermaid.js.org/intro/\">Mermaid帮助文档</a></p>\n</li>\n</ul>\n<h3 id=\"Flowchart\">Flowchart</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>用于绘制流程图，支持方向（例如从左到右、从上到下）和节点间关系的定义。</p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://mermaid.js.org/syntax/flowchart.html\">Mermaid Flowchart</a></p>\n</li>\n<li class=\"lvl-2\">\n<p>type 为 <code>&quot;graph TD&quot;</code>或者<code>&quot;graph LR&quot;</code>，分别表示从上到下和从左到右的方向</p>\n</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- 流程图方向:</span><br><span class=\"line\">  - TB - 从上到下</span><br><span class=\"line\">  - TD - 自上而下，等同于TB</span><br><span class=\"line\">  - BT - 从下到上</span><br><span class=\"line\">  - RL - 从右到左</span><br><span class=\"line\">  - LR - 从左到右</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>&quot;graph TD&quot;</code>：从上到下</p>\n</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% mermaid graph TD %&#125;</span><br><span class=\"line\">A[Hard] --&gt;|Text| B(Round)</span><br><span class=\"line\">B --&gt; C&#123;Decision&#125;</span><br><span class=\"line\">C --&gt;|One| D[Result 1]</span><br><span class=\"line\">C --&gt;|Two| E[Result 2]</span><br><span class=\"line\">&#123;% endmermaid %&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>效果</p>\n</li>\n</ul>\n<pre><code class=\"highlight mermaid\">graph TD\nA[Hard] --&gt;|Text| B(Round)\nB --&gt; C&#123;Decision&#125;\nC --&gt;|One| D[Result 1]\nC --&gt;|Two| E[Result 2]</code></pre>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>说明</p>\n</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">graph TD，定义一个从上到下的流程图。</span><br><span class=\"line\">TD 是 Top to Down 的缩写，表示流程图从上向下排列。</span><br><span class=\"line\"></span><br><span class=\"line\">A[Hard] --&gt;|Text| B(Round)，定义了一个节点 A，显示为 Hard。</span><br><span class=\"line\">一个带标签的箭头 --&gt;|Text| 指向节点 B，箭头上的标签为 Text。</span><br><span class=\"line\">节点 B 被定义为 Round，这是一个椭圆形节点。</span><br><span class=\"line\"></span><br><span class=\"line\">B --&gt; C&#123;Decision&#125;，节点 B 指向节点 C。</span><br><span class=\"line\">节点 C 被定义为 Decision，这是一个决策节点，用大括号 &#123;&#125; 表示。</span><br><span class=\"line\"></span><br><span class=\"line\">C --&gt;|One| D[Result 1]，决策节点 C 的一个分支，带标签 One，指向节点 D。</span><br><span class=\"line\">节点 D 显示为 Result 1，这是一个矩形节点。</span><br><span class=\"line\"></span><br><span class=\"line\">C --&gt;|Two| E[Result 2]，决策节点 C 的另一个分支，带标签 Two，指向节点 E。</span><br><span class=\"line\">节点 E 显示为 Result 2，也是一个矩形节点。</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>&quot;graph LR&quot;</code>：从左到右</p>\n</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% mermaid graph LR %&#125;</span><br><span class=\"line\">A[长方形] -- 链接 --&gt; B((圆))</span><br><span class=\"line\">A --&gt; C(圆角长方形)</span><br><span class=\"line\">B --&gt; D&#123;菱形&#125;</span><br><span class=\"line\">C --&gt; D</span><br><span class=\"line\">&#123;% endmermaid %&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>效果</p>\n</li>\n</ul>\n<pre><code class=\"highlight mermaid\">graph LR\nA[长方形] -- 链接 --&gt; B((圆))\nA --&gt; C(圆角长方形)\nB --&gt; D&#123;菱形&#125;\nC --&gt; D</code></pre>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>说明</p>\n</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">graph LR，定义流程图的方向是从左到右（Left to Right）。</span><br><span class=\"line\">节点和箭头从左向右排列。</span><br><span class=\"line\"></span><br><span class=\"line\">A[长方形] -- 链接 --&gt; B((圆))，定义了节点 A 和节点 B。</span><br><span class=\"line\">A 是一个长方形节点，显示内容为“长方形”。</span><br><span class=\"line\">B 是一个圆形节点，内容为空。</span><br><span class=\"line\">它们之间通过一个带标签的箭头 -- 链接 --&gt; 连接，箭头上标注了“链接”。</span><br><span class=\"line\"></span><br><span class=\"line\">A --&gt; C(圆角长方形)，节点 A 指向节点 C。</span><br><span class=\"line\">C 是一个圆角长方形节点，显示内容为“圆角长方形”。</span><br><span class=\"line\"></span><br><span class=\"line\">B --&gt; D&#123;菱形&#125;，节点 B 指向节点 D。</span><br><span class=\"line\">D 是一个菱形节点，显示内容为“菱形”。</span><br><span class=\"line\"></span><br><span class=\"line\">C --&gt; D，节点 C 也指向节点 D，箭头不带标签。</span><br><span class=\"line\"></span><br><span class=\"line\">节点类型和形状</span><br><span class=\"line\">长方形 [] ：如 A[长方形]，是默认的矩形节点。</span><br><span class=\"line\">圆形 (()) ：如 B((圆))，用于表示一个圆形节点。</span><br><span class=\"line\">圆角长方形 () ：如 C(圆角长方形)，用于表示圆角矩形节点。</span><br><span class=\"line\">菱形 &#123;&#125; ：如 D&#123;菱形&#125;，用于表示决策点或条件分支。</span><br></pre></td></tr></table></figure>\n<h3 id=\"Sequence-Diagram\">Sequence Diagram</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>用于绘制时序图，显示多个实体之间的交互关系，包括消息、时间、状态和数据交换。</p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://mermaid.js.org/syntax/sequenceDiagram.html\">Mermaid Sequence Diagram</a></p>\n</li>\n<li class=\"lvl-2\">\n<p>type 为 <code>&quot;sequenceDiagram&quot;</code></p>\n</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% mermaid sequenceDiagram %&#125;</span><br><span class=\"line\">Alice-&gt;&gt;John: Hello John, how are you?</span><br><span class=\"line\">loop Healthcheck</span><br><span class=\"line\">    John-&gt;&gt;John: Fight against hypochondria</span><br><span class=\"line\">end</span><br><span class=\"line\">Note right of John: Rational thoughts!</span><br><span class=\"line\">John--&gt;&gt;Alice: Great!</span><br><span class=\"line\">John-&gt;&gt;Bob: How about you?</span><br><span class=\"line\">Bob--&gt;&gt;John: Jolly good!</span><br><span class=\"line\">&#123;% endmermaid %&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>效果</p>\n</li>\n</ul>\n<pre><code class=\"highlight mermaid\">sequenceDiagram\nAlice-&gt;&gt;John: Hello John, how are you?\nloop Healthcheck\n    John-&gt;&gt;John: Fight against hypochondria\nend\nNote right of John: Rational thoughts!\nJohn--&gt;&gt;Alice: Great!\nJohn-&gt;&gt;Bob: How about you?\nBob--&gt;&gt;John: Jolly good!</code></pre>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>说明</p>\n</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">基本结构说明</span><br><span class=\"line\">sequenceDiagram: 定义一个序列图，表示消息和事件的时间顺序。</span><br><span class=\"line\">参与者</span><br><span class=\"line\">    Alice、John 和 Bob 是参与者。</span><br><span class=\"line\">    每个参与者在图中会以垂直排列的形式显示。</span><br><span class=\"line\">消息和箭头</span><br><span class=\"line\">    -&gt;&gt; 表示一个消息的发送，方向由箭头决定。</span><br><span class=\"line\">    消息内容写在箭头旁边。</span><br><span class=\"line\">循环（loop）</span><br><span class=\"line\">    使用 loop 定义一个循环块，循环中的消息会重复执行，表示某种持续行为。</span><br><span class=\"line\">备注（Note）</span><br><span class=\"line\">    Note right of John 定义了一条备注，显示在 John 的右侧，用来补充说明。</span><br><span class=\"line\"></span><br><span class=\"line\">代码逐步解析</span><br><span class=\"line\">Alice-&gt;&gt;John: Hello John, how are you?</span><br><span class=\"line\">    表示 Alice 给 John 发送一条消息：“Hello John, how are you?”</span><br><span class=\"line\">loop Healthcheck</span><br><span class=\"line\">    定义一个循环块，标题为“Healthcheck”（健康检查）。</span><br><span class=\"line\">    循环内容是：</span><br><span class=\"line\">        John-&gt;&gt;John: Fight against hypochondria</span><br><span class=\"line\">        表示 John 自己向自己发送一条消息：“Fight against hypochondria”（与疑病症抗争）。</span><br><span class=\"line\">Note right of John: Rational thoughts!</span><br><span class=\"line\">    定义了一条备注，显示在 John 的右侧。</span><br><span class=\"line\">    备注内容为：“Rational thoughts!”（理性思考！）。</span><br><span class=\"line\">John--&gt;&gt;Alice: Great!</span><br><span class=\"line\">    John 回复 Alice 一条消息：“Great!”（很好！）。</span><br><span class=\"line\">    使用 --&gt;&gt; 表示回复消息。</span><br><span class=\"line\">John-&gt;&gt;Bob: How about you?</span><br><span class=\"line\">    John 询问 Bob 一条消息：“How about you?”（你怎么样？）。</span><br><span class=\"line\">Bob--&gt;&gt;John: Jolly good!</span><br><span class=\"line\">    Bob 回复 John 一条消息：“Jolly good!”（非常好！）。</span><br></pre></td></tr></table></figure>\n<h3 id=\"Class-Diagram\">Class Diagram</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>用于绘制类图，显示对象之间的关系，包括继承、关联、依赖等。</p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://mermaid.js.org/syntax/classDiagram.html\">Mermaid Class Diagram</a></p>\n</li>\n<li class=\"lvl-2\">\n<p>type 为 <code>&quot;classDiagram&quot;</code></p>\n</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% mermaid classDiagram %&#125;</span><br><span class=\"line\">Class01 &lt;|-- AveryLongClass : Cool</span><br><span class=\"line\">&lt;&lt;interface&gt;&gt; Class01</span><br><span class=\"line\">Class09 --&gt; C2 : Where am i?</span><br><span class=\"line\">Class09 --* C3</span><br><span class=\"line\">Class09 --|&gt; Class07</span><br><span class=\"line\">Class07 : equals()</span><br><span class=\"line\">Class07 : Object[] elementData</span><br><span class=\"line\">Class01 : size()</span><br><span class=\"line\">Class01 : int chimp</span><br><span class=\"line\">Class01 : int gorilla</span><br><span class=\"line\">class Class10 &#123;</span><br><span class=\"line\">  &lt;&lt;service&gt;&gt;</span><br><span class=\"line\">  int id</span><br><span class=\"line\">  size()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#123;% endmermaid %&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>效果</p>\n</li>\n</ul>\n<pre><code class=\"highlight mermaid\">classDiagram\nClass01 &lt;|-- AveryLongClass : Cool\n&lt;&lt;interface&gt;&gt; Class01\nClass09 --&gt; C2 : Where am i?\nClass09 --* C3\nClass09 --|&gt; Class07\nClass07 : equals()\nClass07 : Object[] elementData\nClass01 : size()\nClass01 : int chimp\nClass01 : int gorilla\nclass Class10 &#123;\n  &lt;&lt;service&gt;&gt;\n  int id\n  size()\n&#125;</code></pre>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>说明</p>\n</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">基本结构</span><br><span class=\"line\">classDiagram</span><br><span class=\"line\">    定义一个类图，展示类的属性、方法以及它们之间的关系。</span><br><span class=\"line\">类和修饰符</span><br><span class=\"line\">    使用 class ClassName 定义一个类。</span><br><span class=\"line\">    类的属性和方法定义在 class 块内。</span><br><span class=\"line\">    特殊修饰符如 &lt;&lt;interface&gt;&gt; 和 &lt;&lt;service&gt;&gt; 用于说明类的角色或类型。</span><br><span class=\"line\">关系符号</span><br><span class=\"line\">    &lt;|-- 表示继承（extends）。</span><br><span class=\"line\">    --|&gt; 表示实现（implements，接口的实现）。</span><br><span class=\"line\">    --&gt; 表示关联（普通引用）。</span><br><span class=\"line\">    --* 表示组合关系（一个类包含另一个类）。</span><br><span class=\"line\">    : 后跟关系的说明或注释。</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">代码逐步解析</span><br><span class=\"line\">Class01 &lt;|-- AveryLongClass : Cool</span><br><span class=\"line\">    表示 AveryLongClass 继承了 Class01，关系名称为 Cool。</span><br><span class=\"line\">    &lt;|-- 表示继承（父类到子类）。</span><br><span class=\"line\">&lt;&lt;interface&gt;&gt; Class01</span><br><span class=\"line\">    将 Class01 标记为一个接口。</span><br><span class=\"line\">Class09 --&gt; C2 : Where am i?</span><br><span class=\"line\">    表示 Class09 与 C2 有一个关联关系，注释为 “Where am i?”。</span><br><span class=\"line\">Class09 --* C3</span><br><span class=\"line\">    表示 Class09 与 C3 有一个组合关系。</span><br><span class=\"line\">    Class09 包含一个或多个 C3 的实例。</span><br><span class=\"line\">Class09 --|&gt; Class07</span><br><span class=\"line\">    表示 Class09 实现了 Class07。</span><br><span class=\"line\">    --|&gt; 通常用于表示接口实现。</span><br><span class=\"line\">Class07 : equals()</span><br><span class=\"line\">    表示 Class07 定义了一个方法 equals()。</span><br><span class=\"line\">Class07 : Object[] elementData</span><br><span class=\"line\">    表示 Class07 有一个属性 elementData，类型是 Object[]（数组）。</span><br><span class=\"line\">Class01 : size()</span><br><span class=\"line\">    表示 Class01 有一个方法 size()。</span><br><span class=\"line\">Class01 : int chimp 和 Class01 : int gorilla</span><br><span class=\"line\">    表示 Class01 有两个整型属性：chimp 和 gorilla。</span><br><span class=\"line\">class Class10 &#123; ... &#125;</span><br><span class=\"line\">    定义了一个名为 Class10 的类。</span><br><span class=\"line\">    类中有一个修饰符 &lt;&lt;service&gt;&gt;，表示这是一个服务类。</span><br><span class=\"line\">    属性和方法：</span><br><span class=\"line\">        int id：整型属性。</span><br><span class=\"line\">        size()：方法。</span><br></pre></td></tr></table></figure>\n<h3 id=\"State-Diagram\">State Diagram</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>用于绘制状态图，显示对象的状态转移和行为。</p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://mermaid.js.org/syntax/stateDiagram.html\">Mermaid State Diagram</a></p>\n</li>\n<li class=\"lvl-2\">\n<p>type 为 <code>&quot;stateDiagram&quot;</code></p>\n</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% mermaid stateDiagram %&#125;</span><br><span class=\"line\">[*] --&gt; Still</span><br><span class=\"line\">Still --&gt; [*]</span><br><span class=\"line\">Still --&gt; Moving</span><br><span class=\"line\">Moving --&gt; Still</span><br><span class=\"line\">Moving --&gt; Crash</span><br><span class=\"line\">Crash --&gt; [*]</span><br><span class=\"line\">&#123;% endmermaid %&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>效果</p>\n</li>\n</ul>\n<pre><code class=\"highlight mermaid\">stateDiagram\n[*] --&gt; Still\nStill --&gt; [*]\nStill --&gt; Moving\nMoving --&gt; Still\nMoving --&gt; Crash\nCrash --&gt; [*]</code></pre>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>说明</p>\n</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">基本结构</span><br><span class=\"line\">stateDiagram</span><br><span class=\"line\">    定义这是一个状态图，用于表示状态和状态之间的转换。</span><br><span class=\"line\">[*]</span><br><span class=\"line\">    表示初始状态或终止状态。</span><br><span class=\"line\">    起始状态通常有箭头指向第一个状态。</span><br><span class=\"line\">    终止状态通常有箭头指向它。</span><br><span class=\"line\">状态</span><br><span class=\"line\">    用状态名称定义状态，例如 Still、Moving、Crash。</span><br><span class=\"line\">箭头</span><br><span class=\"line\">    --&gt; 表示状态之间的转换方向。</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">代码逐步解析</span><br><span class=\"line\">[*] --&gt; Still</span><br><span class=\"line\">    系统从初始状态进入 Still 状态。</span><br><span class=\"line\">Still --&gt; [*]</span><br><span class=\"line\">    系统从 Still 状态可以直接进入终止状态（系统结束）。</span><br><span class=\"line\">Still --&gt; Moving</span><br><span class=\"line\">    系统从 Still 状态可以转换为 Moving 状态。</span><br><span class=\"line\">Moving --&gt; Still</span><br><span class=\"line\">    系统从 Moving 状态可以返回到 Still 状态。</span><br><span class=\"line\">Moving --&gt; Crash</span><br><span class=\"line\">    系统从 Moving 状态可以进入 Crash 状态。</span><br><span class=\"line\">Crash --&gt; [*]</span><br><span class=\"line\">    系统从 Crash 状态可以进入终止状态（表示系统崩溃或终止）。</span><br></pre></td></tr></table></figure>\n<h3 id=\"Entity-Relationship-Diagram\">Entity Relationship Diagram</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>用于绘制实体关系图，显示实体之间的关系，包括关联、依赖等。</p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://mermaid.js.org/syntax/entityRelationshipDiagram.html\">Mermaid Entity Relationship Diagram</a></p>\n</li>\n<li class=\"lvl-2\">\n<p>type 为 <code>&quot;erDiagram&quot;</code></p>\n</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% mermaid erDiagram %&#125;</span><br><span class=\"line\">CUSTOMER ||--o&#123; ORDER : places</span><br><span class=\"line\">ORDER ||--|&#123; ITEM : contains</span><br><span class=\"line\">CUSTOMER &#125;|..|&#123; DELIVERY-ADDRESS : has</span><br><span class=\"line\">&#123;% endmermaid %&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>效果</p>\n</li>\n</ul>\n<pre><code class=\"highlight mermaid\">erDiagram\nCUSTOMER ||--o&#123; ORDER : places\nORDER ||--|&#123; ITEM : contains\nCUSTOMER &#125;|..|&#123; DELIVERY-ADDRESS : has</code></pre>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>说明</p>\n</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">基本结构</span><br><span class=\"line\">erDiagram</span><br><span class=\"line\">    定义这是一个实体关系图。</span><br><span class=\"line\">    展示数据库中表（实体）之间的关系。</span><br><span class=\"line\">实体</span><br><span class=\"line\">    例如 CUSTOMER、ORDER 和 ITEM，每个实体对应数据库中的一个表。</span><br><span class=\"line\">关系</span><br><span class=\"line\">    ||--o&#123; 表示一对多关系（1:N）。</span><br><span class=\"line\">    ||--|&#123; 表示一对多关系（1:N），但强调实体的唯一性（每个子记录属于唯一的父记录）。</span><br><span class=\"line\">    &#125;|..|&#123; 表示多对多关系（N:M）。</span><br><span class=\"line\">注释</span><br><span class=\"line\">    : 后的文字是关系的描述，例如 places、contains、has。</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">代码逐步解析</span><br><span class=\"line\">CUSTOMER ||--o&#123; ORDER : places</span><br><span class=\"line\">    表示一个客户 (CUSTOMER) 可以下多个订单 (ORDER)。</span><br><span class=\"line\">    ||--o&#123; 表示 一对多关系（1:N），即一个客户对应多个订单。</span><br><span class=\"line\">ORDER ||--|&#123; ITEM : contains</span><br><span class=\"line\">    表示一个订单 (ORDER) 包含多个商品 (ITEM)。</span><br><span class=\"line\">    ||--|&#123; 表示 一对多关系，且每个商品的记录与某个订单唯一对应。</span><br><span class=\"line\">CUSTOMER &#125;|..|&#123; DELIVERY-ADDRESS : has</span><br><span class=\"line\">    表示一个客户 (CUSTOMER) 可以有多个配送地址 (DELIVERY-ADDRESS)，而每个配送地址也可能对应多个客户。</span><br><span class=\"line\">    &#125;|..|&#123; 表示 多对多关系（N:M）。</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"Gantt-Chart\">Gantt Chart</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>用于绘制甘特图，显示任务计划、进度和资源分配。</p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://mermaid.js.org/syntax/gantt.html\">Mermaid Gantt Chart</a></p>\n</li>\n<li class=\"lvl-2\">\n<p>type 为 <code>&quot;gantt&quot;</code></p>\n</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% mermaid gantt %&#125;</span><br><span class=\"line\">title Project Timeline</span><br><span class=\"line\">dateFormat  YYYY-MM-DD</span><br><span class=\"line\">section Section1</span><br><span class=\"line\">Completed :done,    des1, 2014-01-06,2014-01-08</span><br><span class=\"line\">Active        :active,  des2, 2014-01-07, 3d</span><br><span class=\"line\">Parallel 1   :         des3, after des1, 1d</span><br><span class=\"line\">Parallel 2   :         des4, after des1, 1d</span><br><span class=\"line\">Parallel 3   :         des5, after des3, 1d</span><br><span class=\"line\">Parallel 4   :         des6, after des4, 1d</span><br><span class=\"line\">section Section2</span><br><span class=\"line\">Task 1 :  t1,after des6,5d</span><br><span class=\"line\">Task 2 :  t2,after t1,3d</span><br><span class=\"line\">&#123;% endmermaid %&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>效果</p>\n</li>\n</ul>\n<pre><code class=\"highlight mermaid\">gantt\ntitle Project Timeline\ndateFormat  YYYY-MM-DD\nsection Section1\nCompleted :done,    des1, 2014-01-06,2014-01-08\nActive        :active,  des2, 2014-01-07, 3d\nParallel 1   :         des3, after des1, 1d\nParallel 2   :         des4, after des1, 1d\nParallel 3   :         des5, after des3, 1d\nParallel 4   :         des6, after des4, 1d\nsection Section2\nTask 1 :  t1,after des6,5d\nTask 2 :  t2,after t1,3d</code></pre>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>说明</p>\n</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">基本结构</span><br><span class=\"line\">gantt</span><br><span class=\"line\">    定义一个甘特图，用于表示任务的时间分布和依赖关系。</span><br><span class=\"line\">title</span><br><span class=\"line\">    定义甘特图的标题，这里是 Project Timeline。</span><br><span class=\"line\">dateFormat</span><br><span class=\"line\">    定义日期格式，这里是 YYYY-MM-DD（年-月-日）。</span><br><span class=\"line\">section</span><br><span class=\"line\">    定义任务的分类（部分）。</span><br><span class=\"line\">    每个 section 下包含一组任务，任务在图表中分组显示。</span><br><span class=\"line\">任务格式</span><br><span class=\"line\">    每个任务按以下格式定义：</span><br><span class=\"line\">        任务名称 : 状态, 标识符, 开始日期或依赖, 持续时间</span><br><span class=\"line\">    任务名称：任务的描述。</span><br><span class=\"line\">    状态：可选，表示任务状态：</span><br><span class=\"line\">        done：已完成。</span><br><span class=\"line\">        active：正在进行。</span><br><span class=\"line\">    标识符：任务的唯一标识符，用于定义依赖关系。</span><br><span class=\"line\">    时间：可以是开始日期、结束日期、或依赖任务。</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">代码逐步解析</span><br><span class=\"line\">section Section1</span><br><span class=\"line\">    定义一个名为 Section1 的部分，包含一组任务。</span><br><span class=\"line\">Completed :done, des1, 2014-01-06,2014-01-08</span><br><span class=\"line\">    任务名称：Completed。</span><br><span class=\"line\">    状态：done（已完成）。</span><br><span class=\"line\">    标识符：des1。</span><br><span class=\"line\">    开始日期：2014-01-06。</span><br><span class=\"line\">    结束日期：2014-01-08。</span><br><span class=\"line\">Active :active, des2, 2014-01-07, 3d</span><br><span class=\"line\">    任务名称：Active。</span><br><span class=\"line\">    状态：active（正在进行）。</span><br><span class=\"line\">    标识符：des2。</span><br><span class=\"line\">    开始日期：2014-01-07。</span><br><span class=\"line\">    持续时间：3d（3天）。</span><br><span class=\"line\">Parallel 1 : des3, after des1, 1d</span><br><span class=\"line\">    任务名称：Parallel 1。</span><br><span class=\"line\">    无状态（默认值）。</span><br><span class=\"line\">    标识符：des3。</span><br><span class=\"line\">    开始时间：依赖任务 des1（在任务 Completed 后开始）。</span><br><span class=\"line\">    持续时间：1d（1天）。</span><br><span class=\"line\">Parallel 2 : des4, after des1, 1d</span><br><span class=\"line\">    任务名称：Parallel 2。</span><br><span class=\"line\">    无状态。</span><br><span class=\"line\">    标识符：des4。</span><br><span class=\"line\">    开始时间：依赖任务 des1（在任务 Completed 后开始）。</span><br><span class=\"line\">    持续时间：1d（1天）。</span><br><span class=\"line\">Parallel 3 : des5, after des3, 1d</span><br><span class=\"line\">    任务名称：Parallel 3。</span><br><span class=\"line\">    无状态。</span><br><span class=\"line\">    标识符：des5。</span><br><span class=\"line\">    开始时间：依赖任务 des3（在任务 Parallel 1 后开始）。</span><br><span class=\"line\">    持续时间：1d（1天）。</span><br><span class=\"line\">Parallel 4 : des6, after des4, 1d</span><br><span class=\"line\">    任务名称：Parallel 4。</span><br><span class=\"line\">    无状态。</span><br><span class=\"line\">    标识符：des6。</span><br><span class=\"line\">    开始时间：依赖任务 des4（在任务 Parallel 2 后开始）。</span><br><span class=\"line\">    持续时间：1d（1天）。</span><br><span class=\"line\">section Section2</span><br><span class=\"line\">    定义甘特图的第二部分，用于分组显示后续任务。</span><br><span class=\"line\">    任务属于不同的部分以便分类和分组。</span><br><span class=\"line\">Task 1 : t1, after des6, 5d</span><br><span class=\"line\">    任务名称：Task 1。</span><br><span class=\"line\">    标识符：t1。</span><br><span class=\"line\">    开始时间：依赖任务 des6（Parallel 4）完成后开始。</span><br><span class=\"line\">    持续时间：5d（5天）。</span><br><span class=\"line\">Task 2 : t2, after t1, 3d</span><br><span class=\"line\">    任务名称：Task 2。</span><br><span class=\"line\">    标识符：t2。</span><br><span class=\"line\">    开始时间：依赖任务 t1（Task 1）完成后开始。</span><br><span class=\"line\">    持续时间：3d（3天）。</span><br></pre></td></tr></table></figure>\n<h3 id=\"Pie-Chart\">Pie Chart</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>用于绘制饼状图，显示数据分布情况。</p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://mermaid.js.org/syntax/pie.html\">Mermaid Pie Chart</a></p>\n</li>\n<li class=\"lvl-2\">\n<p>type 为 <code>&quot;pie&quot;</code></p>\n</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% mermaid pie showData %&#125;</span><br><span class=\"line\">%%&#123;init: &#123;&quot;pie&quot;: &#123;&quot;textPosition&quot;: 0.4&#125;, &quot;themeVariables&quot;: &#123;&quot;pieOuterStrokeWidth&quot;: &quot;5px&quot;,&quot;pie1&quot;: &quot;#ff9999&quot;,&quot;pie2&quot;: &quot;#99ccff&quot;,&quot;pie3&quot;: &quot;#99ff99&quot;&#125;&#125; &#125;%%</span><br><span class=\"line\">title Expenses</span><br><span class=\"line\">&quot;Rent&quot; : 200</span><br><span class=\"line\">&quot;Food&quot; : 200</span><br><span class=\"line\">&quot;Transport&quot; : 400</span><br><span class=\"line\">&#123;% endmermaid %&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>效果</p>\n</li>\n</ul>\n<pre><code class=\"highlight mermaid\">%%&#123;init: &#123;&quot;pie&quot;: &#123;&quot;textPosition&quot;: 0.4&#125;, &quot;themeVariables&quot;: &#123;&quot;pieOuterStrokeWidth&quot;: &quot;5px&quot;,&quot;pie1&quot;: &quot;#ff9999&quot;,&quot;pie2&quot;: &quot;#99ccff&quot;,&quot;pie3&quot;: &quot;#99ff99&quot;&#125;&#125; &#125;%%\npie showData\ntitle Expenses\n&quot;Rent&quot; : 200\n&quot;Food&quot; : 200\n&quot;Transport&quot; : 400</code></pre>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>说明</p>\n</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">基本结构</span><br><span class=\"line\">%%&#123;init: ...&#125;%%：</span><br><span class=\"line\">    Mermaid.js 的初始化配置，用于全局设置图表属性和样式。</span><br><span class=\"line\">    pie 属性</span><br><span class=\"line\">        textPosition: 设置饼图数据标签的相对位置。</span><br><span class=\"line\">            值范围为 0 到 1，表示标签距离饼图中心的比例。0.4 表示标签距离中心较近，接近 40% 的半径位置。</span><br><span class=\"line\">    themeVariables</span><br><span class=\"line\">        pieOuterStrokeWidth: 设置饼图外环的宽度。设置为 5px，表示饼图有明显的外边框。</span><br><span class=\"line\">        &quot;pie1&quot;: &quot;#ff9999&quot;,&quot;pie2&quot;: &quot;#99ccff&quot;,&quot;pie3&quot;: &quot;#99ff99&quot;: 配置每个分区的颜色。</span><br><span class=\"line\">pie</span><br><span class=\"line\">    定义这是一个饼图。</span><br><span class=\"line\">showData</span><br><span class=\"line\">    显示数据项的数值。</span><br><span class=\"line\">title Expenses</span><br><span class=\"line\">    设置饼图的标题为 Expenses（费用）。</span><br><span class=\"line\">数据项</span><br><span class=\"line\">    数据项定义了饼图的各个部分：</span><br><span class=\"line\">        &quot;Rent&quot; : 200，占比：200 / (200 + 200 + 400) = 1/4 = 25%。</span><br><span class=\"line\">        &quot;Food&quot; : 200，占比：200 / (200 + 200 + 400) = 1/4 = 25%。</span><br><span class=\"line\">        &quot;Transport&quot; : 400，占比：400 / (200 + 200 + 400) = 1/2 = 50%。</span><br><span class=\"line\">    每个数据项包含：</span><br><span class=\"line\">        标签：如 &quot;Rent&quot;、&quot;Food&quot;、&quot;Transport&quot;。</span><br><span class=\"line\">        数值：如 200、400，表示该部分的权重或数值大小。</span><br></pre></td></tr></table></figure>\n<h3 id=\"XY-Chart\">XY Chart</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>用于绘制 XY 轴图(柱状图和折线图)，显示数据分布和趋势。</p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://mermaid.js.org/syntax/xyChart.html\">Mermaid XY Chart</a></p>\n</li>\n<li class=\"lvl-2\">\n<p>type 为 <code>&quot;xychart-beta&quot;</code>，目前 xychart-beta 还处在改进阶段</p>\n</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% mermaid xychart-beta %&#125;</span><br><span class=\"line\">%%&#123;init: &#123;&quot;xyChart&quot;: &#123;&quot;width&quot;: 900,&quot;height&quot;:600&#125;, &quot;themeVariables&quot;: &#123;&quot;xyChart&quot;:&#123;&quot;titleColor&quot;: &quot;#ff0000&quot;&#125;&#125;&#125; &#125;%%</span><br><span class=\"line\">title &quot;Sales Revenue&quot;</span><br><span class=\"line\">x-axis [jan, feb, mar, apr, may, jun, jul, aug, sep, oct, nov, dec]</span><br><span class=\"line\">y-axis &quot;Revenue (in $)&quot; 4000 --&gt; 11000</span><br><span class=\"line\">bar [5000, 6000, 7500, 8200, 9500, 10500, 11000, 10200, 9200, 8500, 7000, 6000]</span><br><span class=\"line\">line [5000, 6000, 7500, 8200, 9500, 10500, 11000, 10200, 9200, 8500, 7000, 6000]</span><br><span class=\"line\">&#123;% endmermaid %&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>效果</p>\n</li>\n</ul>\n<pre><code class=\"highlight mermaid\">---\nconfig:\n    xyChart:\n        width: 900\n        height: 600\n    themeVariables:\n        xyChart:\n            titleColor: &quot;#ff0000&quot;\n---\nxychart-beta\ntitle &quot;Sales Revenue&quot;\nx-axis [jan, feb, mar, apr, may, jun, jul, aug, sep, oct, nov, dec]\ny-axis &quot;Revenue (in $)&quot; 4000 --&gt; 11000\nbar [5000, 6000, 7500, 8200, 9500, 10500, 11000, 10200, 9200, 8500, 7000, 6000]\nline [5000, 6000, 7500, 8200, 9500, 10500, 11000, 10200, 9200, 8500, 7000, 6000]</code></pre>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>说明</p>\n</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">代码结构解析</span><br><span class=\"line\">%%&#123;init: ...&#125;%%：</span><br><span class=\"line\">    Mermaid.js 的初始化配置，用于全局设置图表属性和样式。</span><br><span class=\"line\">    xyChart.width 和 xyChart.height : 设置图表的宽度和高度。</span><br><span class=\"line\">    themeVariables.xyChart.titleColor: 设置标题的颜色。</span><br><span class=\"line\">title</span><br><span class=\"line\">    设置图表的标题。</span><br><span class=\"line\">坐标轴定义</span><br><span class=\"line\">    x-axis：X轴标签为月份（从1月到12月）。</span><br><span class=\"line\">    y-axis：Y轴范围从 $4000 到 $11000，单位为美元。</span><br><span class=\"line\">数据</span><br><span class=\"line\">    bar：柱状图数据，表示每个月的销售收入。</span><br><span class=\"line\">    line：折线图数据，表示每个月的销量趋势。</span><br></pre></td></tr></table></figure>\n<h3 id=\"Journey-Diagram\">Journey Diagram</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>用于绘制旅程图，显示用户的体验流程，包括用户进入系统、操作、退出系统等。</p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://mermaid.js.org/syntax/userJourney.html\">Mermaid Journey Diagram</a></p>\n</li>\n<li class=\"lvl-2\">\n<p>type 为 <code>&quot;journey&quot;</code></p>\n</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% mermaid journey %&#125;</span><br><span class=\"line\">title My working day</span><br><span class=\"line\">section Morning</span><br><span class=\"line\">  wake up : 5 : me</span><br><span class=\"line\">  go to work : 3 : me,you</span><br><span class=\"line\">section Lunch</span><br><span class=\"line\">  have lunch : 5 : me,you</span><br><span class=\"line\">  go to work : 1 : me,you</span><br><span class=\"line\">section Dinner</span><br><span class=\"line\">  finish your meal : 5 : me</span><br><span class=\"line\">section Go home</span><br><span class=\"line\">  go home : 5 : me</span><br><span class=\"line\">&#123;% endmermaid %&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>效果</p>\n</li>\n</ul>\n<pre><code class=\"highlight mermaid\">journey\ntitle My working day\nsection Morning\n  wake up : 5 : me\n  go to work : 3 : me,you\nsection Lunch\n  have lunch : 5 : me,you\n  go to work : 1 : me,you\nsection Dinner\n  finish your meal : 5 : me\nsection Go home\n  go home : 5 : me</code></pre>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>说明</p>\n</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">基本结构</span><br><span class=\"line\">journey</span><br><span class=\"line\">    定义这是一个旅程图。</span><br><span class=\"line\">title My working day</span><br><span class=\"line\">    设置旅程图的标题为 &quot;My working day&quot;（我的工作日）。</span><br><span class=\"line\">section</span><br><span class=\"line\">    定义旅程图的分段，用于表示一天中的不同阶段，例如：</span><br><span class=\"line\">        Morning（早晨）。</span><br><span class=\"line\">        Lunch（午餐时间）。</span><br><span class=\"line\">        Dinner（晚餐）。</span><br><span class=\"line\">        Go home（回家）。</span><br><span class=\"line\">任务格式</span><br><span class=\"line\">    任务描述 : 满意度评分 : 参与者</span><br><span class=\"line\">        任务描述：描述具体的任务或活动。</span><br><span class=\"line\">        满意度评分：从 1 到 5，表示对任务或活动的满意程度。</span><br><span class=\"line\">        参与者：参与任务的人，可以是 me（自己）、you（其他人）或两者。</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">代码逐步解析</span><br><span class=\"line\">section Morning</span><br><span class=\"line\">    wake up : 5 : me</span><br><span class=\"line\">        活动：wake up（起床）。</span><br><span class=\"line\">        满意度：5（非常满意）。</span><br><span class=\"line\">        参与者：me（自己）。</span><br><span class=\"line\">    go to work : 3 : me,you</span><br><span class=\"line\">        活动：go to work（去工作）。</span><br><span class=\"line\">        满意度：3（中等满意）。</span><br><span class=\"line\">        参与者：me 和 you（自己和其他人）。</span><br><span class=\"line\">section Lunch</span><br><span class=\"line\">    have lunch : 5 : me,you</span><br><span class=\"line\">        活动：have lunch（吃午饭）。</span><br><span class=\"line\">        满意度：5（非常满意）。</span><br><span class=\"line\">        参与者：me 和 you（自己和其他人）。</span><br><span class=\"line\">    go to work : 1 : me,you</span><br><span class=\"line\">        活动：go to work（吃完饭继续工作）。</span><br><span class=\"line\">        满意度：1（非常不满意）。</span><br><span class=\"line\">        参与者：me 和 you。</span><br><span class=\"line\">section Dinner</span><br><span class=\"line\">    finish your meal : 5 : me</span><br><span class=\"line\">        活动：finish your meal（吃完饭）。</span><br><span class=\"line\">        满意度：5（非常满意）。</span><br><span class=\"line\">        参与者：me（自己）。</span><br><span class=\"line\">section Go home</span><br><span class=\"line\">    go home : 5 : me</span><br><span class=\"line\">        活动：go home（回家）。</span><br><span class=\"line\">        满意度：5（非常满意）。</span><br><span class=\"line\">        参与者：me（自己）。</span><br></pre></td></tr></table></figure>\n<h3 id=\"Requirement-Diagram\">Requirement Diagram</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>用于绘制需求图，显示系统的功能需求和依赖关系。</p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://mermaid.js.org/syntax/requirementDiagram.html\">Mermaid Requirement Diagram</a></p>\n</li>\n<li class=\"lvl-2\">\n<p>type 为 <code>&quot;requirementDiagram&quot;</code></p>\n</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% mermaid requirementDiagram %&#125;</span><br><span class=\"line\">requirement &quot;测试需求&quot; &#123;</span><br><span class=\"line\">    id: 1</span><br><span class=\"line\">    text: &quot;测试文本&quot;</span><br><span class=\"line\">    risk: High</span><br><span class=\"line\">    verifymethod: test</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">requirement &quot;测试需求2&quot; &#123;</span><br><span class=\"line\">    id: 2</span><br><span class=\"line\">    text: &quot;测试文本&quot;</span><br><span class=\"line\">    risk: High</span><br><span class=\"line\">    verifymethod: test</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">element &quot;测试实体&quot; &#123;</span><br><span class=\"line\">    type: &quot;模拟&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&quot;测试实体&quot; - satisfies -&gt; &quot;测试需求&quot;</span><br><span class=\"line\">&quot;测试实体&quot; - satisfies -&gt; &quot;测试需求2&quot;</span><br><span class=\"line\">&#123;% endmermaid %&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>效果</p>\n</li>\n</ul>\n<pre><code class=\"highlight mermaid\">requirementDiagram\nrequirement &quot;测试需求&quot; &#123;\n    id: 1\n    text: &quot;测试文本&quot;\n    risk: High\n    verifymethod: test\n&#125;\nrequirement &quot;测试需求2&quot; &#123;\n    id: 2\n    text: &quot;测试文本&quot;\n    risk: High\n    verifymethod: test\n&#125;\nelement &quot;测试实体&quot; &#123;\n    type: &quot;模拟&quot;\n&#125;\n&quot;测试实体&quot; - satisfies -&gt; &quot;测试需求&quot;\n&quot;测试实体&quot; - satisfies -&gt; &quot;测试需求2&quot;</code></pre>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>说明</p>\n</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">基本结构</span><br><span class=\"line\">requirementDiagram</span><br><span class=\"line\">    定义这是一个需求图。</span><br><span class=\"line\">requirement</span><br><span class=\"line\">    定义一个需求节点，包含需求的详细属性，如：</span><br><span class=\"line\">        id：需求编号。</span><br><span class=\"line\">        text：需求的描述。</span><br><span class=\"line\">        risk：需求的风险级别（如 High 表示高风险）。</span><br><span class=\"line\">        verifymethod：验证需求的方法（如 test 表示通过测试验证）。</span><br><span class=\"line\">element</span><br><span class=\"line\">    定义一个元素，用于表示系统中的某个实体或对象。</span><br><span class=\"line\">    包含属性，如：</span><br><span class=\"line\">        type：实体的类型（如 模拟 表示模拟实体）。</span><br><span class=\"line\">关系定义</span><br><span class=\"line\">    定义了两个关系：</span><br><span class=\"line\">        &quot;测试实体&quot; - satisfies -&gt; &quot;测试需求&quot;  : 测试实体 满足了 测试需求</span><br><span class=\"line\">        &quot;测试实体&quot; - satisfies -&gt; &quot;测试需求2&quot; : 测试实体 满足了 测试需求2</span><br><span class=\"line\">    - satisfies -&gt;：satisfies 表示满足关系，箭头方向从实体指向需求</span><br><span class=\"line\"></span><br><span class=\"line\">代码逐步解析</span><br><span class=\"line\">需求定义</span><br><span class=\"line\">    requirement &quot;测试需求&quot;</span><br><span class=\"line\">        定义第一个需求，显示名称为 测试需求。</span><br><span class=\"line\">        属性：</span><br><span class=\"line\">            id: 1（需求编号为 1）。</span><br><span class=\"line\">            text: &quot;测试文本&quot;（描述文本为 &quot;测试文本&quot;）。</span><br><span class=\"line\">            risk: High（高风险需求）。</span><br><span class=\"line\">            verifymethod: test（验证方法为测试）。</span><br><span class=\"line\">    requirement &quot;测试需求2&quot;</span><br><span class=\"line\">        定义第二个需求，显示名称为 测试需求2。</span><br><span class=\"line\">        属性：</span><br><span class=\"line\">            id: 2（需求编号为 2）。</span><br><span class=\"line\">            text: &quot;测试文本&quot;（描述文本与第一个需求相同）。</span><br><span class=\"line\">            risk: High（高风险需求）。</span><br><span class=\"line\">            verifymethod: test（验证方法为测试）。</span><br><span class=\"line\">实体定义</span><br><span class=\"line\">    element &quot;测试实体&quot;</span><br><span class=\"line\">        定义一个系统实体，显示名称为 测试实体。</span><br><span class=\"line\">        属性：</span><br><span class=\"line\">            type: &quot;模拟&quot;（实体类型为 &quot;模拟&quot;）。</span><br></pre></td></tr></table></figure>\n<h3 id=\"Gitgraph-Diagram\">Gitgraph Diagram</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>用于绘制Git图，显示代码仓库的提交历史和分支关系。</p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://mermaid.js.org/syntax/gitgraph.html\">Mermaid Gitgraph Diagram</a></p>\n</li>\n<li class=\"lvl-2\">\n<p>type 为 <code>&quot;gitgraph&quot;</code></p>\n</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% mermaid gitGraph %&#125;</span><br><span class=\"line\">commit</span><br><span class=\"line\">commit</span><br><span class=\"line\">commit</span><br><span class=\"line\">branch newbranch</span><br><span class=\"line\">checkout newbranch</span><br><span class=\"line\">commit</span><br><span class=\"line\">commit</span><br><span class=\"line\">checkout main</span><br><span class=\"line\">merge newbranch</span><br><span class=\"line\">&#123;% endmermaid %&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>效果</p>\n</li>\n</ul>\n<pre><code class=\"highlight mermaid\">gitGraph\ncommit\ncommit\ncommit\nbranch newbranch\ncheckout newbranch\ncommit\ncommit\ncheckout main\nmerge newbranch</code></pre>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>说明</p>\n</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">基本结构</span><br><span class=\"line\">gitGraph</span><br><span class=\"line\">    定义这是一个 Git 图。</span><br><span class=\"line\">commit</span><br><span class=\"line\">    表示一次提交操作，每个 commit 节点代表代码仓库的某个提交点。</span><br><span class=\"line\">branch</span><br><span class=\"line\">    创建一个新分支。</span><br><span class=\"line\">    格式：branch 分支名称。</span><br><span class=\"line\">checkout</span><br><span class=\"line\">    切换到指定分支。</span><br><span class=\"line\">    格式：checkout 分支名称。</span><br><span class=\"line\">merge</span><br><span class=\"line\">    将指定分支合并到当前分支。</span><br><span class=\"line\">    格式：merge 分支名称。</span><br></pre></td></tr></table></figure>\n<h3 id=\"Mindmap\">Mindmap</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>用于绘制思维导图，显示主题和子主题之间的 hierarchical 关系。</p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://mermaid.js.org/syntax/mindmap.html\">Mermaid Mindmap</a></p>\n</li>\n<li class=\"lvl-2\">\n<p>type 为 <code>&quot;mindmap&quot;</code></p>\n</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% mermaid mindmap %&#125;</span><br><span class=\"line\">root((mindmap))</span><br><span class=\"line\">    (origins)</span><br><span class=\"line\">        Long history</span><br><span class=\"line\">        ::icon(fa fa-book)</span><br><span class=\"line\">        Popularisation</span><br><span class=\"line\">            British popular psychology author Tony Buzan</span><br><span class=\"line\">    [Research]</span><br><span class=\"line\">        On effectivness&lt;br/&gt;and features</span><br><span class=\"line\">        On Automatic creation</span><br><span class=\"line\">            Uses</span><br><span class=\"line\">                Creative techniques</span><br><span class=\"line\">                Strategic planning</span><br><span class=\"line\">                Argument mapping</span><br><span class=\"line\">    Tools</span><br><span class=\"line\">        Pen and paper</span><br><span class=\"line\">        Mermaid</span><br><span class=\"line\">&#123;% endmermaid %&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>效果</p>\n</li>\n</ul>\n<pre><code class=\"highlight mermaid\">mindmap\nroot((mindmap))\n    (origins)\n        Long history\n        ::icon(fa fa-book)\n        Popularisation\n            British popular psychology author Tony Buzan\n    [Research]\n        On effectivness&lt;br/&gt;and features\n        On Automatic creation\n            Uses\n                Creative techniques\n                Strategic planning\n                Argument mapping\n    Tools\n        Pen and paper\n        Mermaid</code></pre>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>说明</p>\n</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">基本结构</span><br><span class=\"line\">mindmap</span><br><span class=\"line\">    定义这是一个思维导图。</span><br><span class=\"line\">root((mindmap))</span><br><span class=\"line\">    定义思维导图的根节点，显示为圆形并标注为 &quot;mindmap&quot;。</span><br><span class=\"line\">子节点使用缩进表示从属关系：</span><br><span class=\"line\">    每一级缩进代表一个层级的子节点。</span><br><span class=\"line\">    子节点可以直接添加内容或通过 &lt;br/&gt; 换行。</span><br><span class=\"line\">::icon(...)</span><br><span class=\"line\">    为节点添加图标。Mermaid.js 支持使用 FontAwesome 的图标。</span><br><span class=\"line\"></span><br><span class=\"line\">节点形状</span><br><span class=\"line\">长方形 [] ：如 [长方形]，是默认的矩形节点。这个是默认的节点类型。</span><br><span class=\"line\">圆形 (()) ：如 ((圆))，用于表示一个圆形节点。</span><br><span class=\"line\">圆角长方形 () ：如 (圆角长方形)，用于表示圆角矩形节点。</span><br></pre></td></tr></table></figure>\n<h3 id=\"QuadrantChart\">QuadrantChart</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>用于绘制象限图，显示不同维度之间的比较关系。</p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://mermaid.js.org/syntax/quadrantChart.html\">Mermaid QuadrantChart</a></p>\n</li>\n<li class=\"lvl-2\">\n<p>type 为 <code>&quot;quadrantChart&quot;</code></p>\n</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% mermaid quadrantChart %&#125;</span><br><span class=\"line\">%%&#123;init: &#123;&quot;quadrantChart&quot;: &#123;&quot;chartHeight&quot;: 600, &quot;chartWidth&quot;: 800, &quot;pointTextPadding&quot;: 10&#125;, &quot;themeVariables&quot;: &#123;&quot;quadrant1Fill&quot;: &quot;#ff0000&quot;, &quot;quadrant2Fill&quot;: &quot;#FFFF00&quot;, &quot;quadrant3Fill&quot;: &quot;#32CD32&quot;, &quot;quadrant4Fill&quot;: &quot;#800080&quot;&#125;&#125;&#125;%%</span><br><span class=\"line\">title Reach and engagement of carpaigns</span><br><span class=\"line\">x-axis Low Reach --&gt; High Reach</span><br><span class=\"line\">y-axis Low Engagement --&gt; High Engagement</span><br><span class=\"line\">quadrant-1 we should expand</span><br><span class=\"line\">quadrant-2 Need to promote</span><br><span class=\"line\">quadrant-3 Re-evaluate</span><br><span class=\"line\">quadrant-4 May be improved</span><br><span class=\"line\">Campaign A: [0.3,0.6]</span><br><span class=\"line\">Campaign B: [0.45,0.23]</span><br><span class=\"line\">Campaign C: [0.57,0.69]</span><br><span class=\"line\">Campaign D: [0.78,0.34]</span><br><span class=\"line\">Campaign E: [0.40,0.34]</span><br><span class=\"line\">Campaign F: [0.35,0.78]</span><br><span class=\"line\">&#123;% endmermaid %&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>效果</p>\n</li>\n</ul>\n<pre><code class=\"highlight mermaid\">%%&#123;init: &#123;&quot;quadrantChart&quot;: &#123;&quot;chartHeight&quot;: 600, &quot;chartWidth&quot;: 800, &quot;pointTextPadding&quot;: 10&#125;, &quot;themeVariables&quot;: &#123;&quot;quadrant1Fill&quot;: &quot;#ff0000&quot;, &quot;quadrant2Fill&quot;: &quot;#FFFF00&quot;, &quot;quadrant3Fill&quot;: &quot;#32CD32&quot;, &quot;quadrant4Fill&quot;: &quot;#800080&quot;&#125;&#125;&#125;%%\nquadrantChart\ntitle Reach and engagement of carpaigns\nx-axis Low Reach --&gt; High Reach\ny-axis Low Engagement --&gt; High Engagement\nquadrant-1 we should expand\nquadrant-2 Need to promote\nquadrant-3 Re-evaluate\nquadrant-4 May be improved\nCampaign A: [0.3,0.6]\nCampaign B: [0.45,0.23]\nCampaign C: [0.57,0.69]\nCampaign D: [0.78,0.34]\nCampaign E: [0.40,0.34]\nCampaign F: [0.35,0.78]</code></pre>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>说明</p>\n</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">基本结构</span><br><span class=\"line\">%%&#123;init: ...&#125;%%</span><br><span class=\"line\">    这是 Mermaid.js 的初始化配置块，用于自定义图表的全局参数和样式。</span><br><span class=\"line\">    配置内容，详见下文：</span><br><span class=\"line\">        quadrantChart：自定义象限图的相关参数。</span><br><span class=\"line\">        themeVariables： 图表主题配色。</span><br><span class=\"line\">quadrantChart</span><br><span class=\"line\">    定义这是一个象限图。</span><br><span class=\"line\">title</span><br><span class=\"line\">    标题</span><br><span class=\"line\"></span><br><span class=\"line\">坐标轴，定义 X 轴和 Y 轴的范围和方向：</span><br><span class=\"line\">x-axis Low Reach --&gt; High Reach</span><br><span class=\"line\">    X 轴 从 “Low Reach” 到 “High Reach”。</span><br><span class=\"line\">y-axis Low Engagement --&gt; High Engagement</span><br><span class=\"line\">    Y 轴 从 “Low Engagement” 到 “High Engagement”。</span><br><span class=\"line\"></span><br><span class=\"line\">象限定义</span><br><span class=\"line\">quadrant-1 we should expand</span><br><span class=\"line\">    象限 1（右上）：&quot;we should expand&quot;</span><br><span class=\"line\">quadrant-2 Need to promote</span><br><span class=\"line\">    象限 2（左上）：&quot;Need to promote&quot;</span><br><span class=\"line\">quadrant-3 Re-evaluate</span><br><span class=\"line\">    象限 3（左下）：&quot;Re-evaluate&quot;</span><br><span class=\"line\">quadrant-4 May be improved</span><br><span class=\"line\">    象限 4（右下）：&quot;May be improved&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">数据点</span><br><span class=\"line\">Campaign A: [0.3,0.6]</span><br><span class=\"line\">Campaign B: [0.45,0.23]</span><br><span class=\"line\">Campaign C: [0.57,0.69]</span><br><span class=\"line\">Campaign D: [0.78,0.34]</span><br><span class=\"line\">Campaign E: [0.40,0.34]</span><br><span class=\"line\">Campaign F: [0.35,0.78]</span><br><span class=\"line\">定义了 6 个活动（Campaign）的数据点，使用 [name]: [x, y] 的格式来添加数据点，其中 [name] 是数据点的名称，[x, y] 是数据点在 x 轴和 y 轴上的坐标值，对于点x和y值，最小值为0，最大值为1。</span><br><span class=\"line\">X 值：表示活动的 Reach（覆盖面）。</span><br><span class=\"line\">Y 值：表示活动的 Engagement（参与度）。</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>初始化配置</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">quadrantChart：自定义象限图的相关参数</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>参数</th>\n<th>描述</th>\n<th>默认值</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>chartHeight</td>\n<td>图表的高度</td>\n<td>500</td>\n</tr>\n<tr>\n<td>chartWidth</td>\n<td>图表的宽度</td>\n<td>500</td>\n</tr>\n<tr>\n<td>pointLabelFontSize</td>\n<td>点文本字体大小</td>\n<td>12</td>\n</tr>\n<tr>\n<td>pointRadius</td>\n<td>要绘制的点的半径</td>\n<td>5</td>\n</tr>\n<tr>\n<td>pointTextPadding</td>\n<td>点和下面文本之间的填充</td>\n<td>5</td>\n</tr>\n<tr>\n<td>quadrantExternalBorderStrokeWidth</td>\n<td>象限外边框描边宽度</td>\n<td>2</td>\n</tr>\n<tr>\n<td>quadrantInternalBorderStrokeWidth</td>\n<td>象限内的边框描边宽度</td>\n<td>1</td>\n</tr>\n<tr>\n<td>quadrantLabelFontSize</td>\n<td>象限文本字体大小</td>\n<td>16</td>\n</tr>\n<tr>\n<td>quadrantPadding</td>\n<td>所有象限外的填充</td>\n<td>5</td>\n</tr>\n<tr>\n<td>quadrantTextTopPadding</td>\n<td>当文本绘制在顶部时象限文本顶部填充（那里没有数据点）</td>\n<td>5</td>\n</tr>\n<tr>\n<td>titlePadding</td>\n<td>标题的顶部和底部填充</td>\n<td>10</td>\n</tr>\n<tr>\n<td>titleFontSize</td>\n<td>标题字体大小</td>\n<td>20</td>\n</tr>\n<tr>\n<td>xAxisLabelPadding</td>\n<td>x 轴文本的顶部和底部填充</td>\n<td>5</td>\n</tr>\n<tr>\n<td>xAxisLabelFontSize</td>\n<td>X 轴文本字体大小</td>\n<td>16</td>\n</tr>\n<tr>\n<td>xAxisPosition</td>\n<td>x 轴的位置（顶部、底部）如果有点，则 x 轴将始终渲染在底部</td>\n<td>‘top’</td>\n</tr>\n<tr>\n<td>yAxisLabelPadding</td>\n<td>y 轴文本的左右填充</td>\n<td>5</td>\n</tr>\n<tr>\n<td>yAxisLabelFontSize</td>\n<td>Y 轴文本字体大小</td>\n<td>16</td>\n</tr>\n<tr>\n<td>yAxisPosition</td>\n<td>y 轴位置（左、右）</td>\n<td>‘left’</td>\n</tr>\n</tbody>\n</table>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">\n<p>themeVariables： 图表主题配色</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>参数</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>quadrant1Fill</td>\n<td>右上象限的填充颜色</td>\n</tr>\n<tr>\n<td>quadrant2Fill</td>\n<td>左上象限的填充颜色</td>\n</tr>\n<tr>\n<td>quadrant3Fill</td>\n<td>左下象限的填充颜色</td>\n</tr>\n<tr>\n<td>quadrant4Fill</td>\n<td>右下象限的填充颜色</td>\n</tr>\n<tr>\n<td>quadrant1TextFill</td>\n<td>右上象限的文本颜色</td>\n</tr>\n<tr>\n<td>quadrant2TextFill</td>\n<td>左上象限的文本颜色</td>\n</tr>\n<tr>\n<td>quadrant3TextFill</td>\n<td>左下象限的文本颜色</td>\n</tr>\n<tr>\n<td>quadrant4TextFill</td>\n<td>右下象限的文本颜色</td>\n</tr>\n<tr>\n<td>quadrantPointFill</td>\n<td>点填充颜色</td>\n</tr>\n<tr>\n<td>quadrantPointTextFill</td>\n<td>点文本颜色</td>\n</tr>\n<tr>\n<td>quadrantXAxisTextFill</td>\n<td>X 轴文本颜色</td>\n</tr>\n<tr>\n<td>quadrantYAxisTextFill</td>\n<td>Y 轴文本颜色</td>\n</tr>\n<tr>\n<td>quadrantInternalBorderStrokeFill</td>\n<td>象限内边框颜色</td>\n</tr>\n<tr>\n<td>quadrantExternalBorderStrokeFill</td>\n<td>象限外边框颜色</td>\n</tr>\n<tr>\n<td>quadrantTitleFill</td>\n<td>标题颜色</td>\n</tr>\n</tbody>\n</table>\n</li>\n</ul>\n","content_text":"摘要 Mermaid 是一个支持在Markdown文档中绘制流程图、甘特图、序列图等图形的工具。它基于JavaScript实现，能够将Markdown中的元素渲染成HTML元素，从而在网页上直观地展示各种图表‌ Next主题中使用Mermaid说明 本文介绍如何在 Hexo-Next 主题中使用 Mermaid 配置和使用方法 NexT config file 中找到mermaid配置，并设置为true，theme 可以设置浅色和深色背景的样式，共有4个可用选项 123456mermaid: enable: true # Available themes: default | dark | forest | neutral theme: light: dark dark: dark 使用方法，其中mermaid与endmermaid是固定搭配，type 用于设置图形的种类，如流程图、时序图、甘特图等，下面示例中会介绍 12&#123;% mermaid type %&#125;&#123;% endmermaid %&#125; 有些小伙伴喜欢使用代码块的形式，使用时去掉前面的# 1234#```mermaidtype#``` 但是此时需要在 Hexo config file 中找到highlight，并添加如下内容，才会使代码块的形式生效 123highlight: exclude_languages: - mermaid 图形示例 这里只介绍常用的一些图表，更多图表的使用方法可以参考Mermaid帮助文档 Flowchart 用于绘制流程图，支持方向（例如从左到右、从上到下）和节点间关系的定义。 Mermaid Flowchart type 为 &quot;graph TD&quot;或者&quot;graph LR&quot;，分别表示从上到下和从左到右的方向 123456- 流程图方向: - TB - 从上到下 - TD - 自上而下，等同于TB - BT - 从下到上 - RL - 从右到左 - LR - 从左到右 &quot;graph TD&quot;：从上到下 123456&#123;% mermaid graph TD %&#125;A[Hard] --&gt;|Text| B(Round)B --&gt; C&#123;Decision&#125;C --&gt;|One| D[Result 1]C --&gt;|Two| E[Result 2]&#123;% endmermaid %&#125; 效果 graph TD A[Hard] --&gt;|Text| B(Round) B --&gt; C&#123;Decision&#125; C --&gt;|One| D[Result 1] C --&gt;|Two| E[Result 2] 说明 123456789101112131415graph TD，定义一个从上到下的流程图。TD 是 Top to Down 的缩写，表示流程图从上向下排列。A[Hard] --&gt;|Text| B(Round)，定义了一个节点 A，显示为 Hard。一个带标签的箭头 --&gt;|Text| 指向节点 B，箭头上的标签为 Text。节点 B 被定义为 Round，这是一个椭圆形节点。B --&gt; C&#123;Decision&#125;，节点 B 指向节点 C。节点 C 被定义为 Decision，这是一个决策节点，用大括号 &#123;&#125; 表示。C --&gt;|One| D[Result 1]，决策节点 C 的一个分支，带标签 One，指向节点 D。节点 D 显示为 Result 1，这是一个矩形节点。C --&gt;|Two| E[Result 2]，决策节点 C 的另一个分支，带标签 Two，指向节点 E。节点 E 显示为 Result 2，也是一个矩形节点。 &quot;graph LR&quot;：从左到右 123456&#123;% mermaid graph LR %&#125;A[长方形] -- 链接 --&gt; B((圆))A --&gt; C(圆角长方形)B --&gt; D&#123;菱形&#125;C --&gt; D&#123;% endmermaid %&#125; 效果 graph LR A[长方形] -- 链接 --&gt; B((圆)) A --&gt; C(圆角长方形) B --&gt; D&#123;菱形&#125; C --&gt; D 说明 123456789101112131415161718192021graph LR，定义流程图的方向是从左到右（Left to Right）。节点和箭头从左向右排列。A[长方形] -- 链接 --&gt; B((圆))，定义了节点 A 和节点 B。A 是一个长方形节点，显示内容为“长方形”。B 是一个圆形节点，内容为空。它们之间通过一个带标签的箭头 -- 链接 --&gt; 连接，箭头上标注了“链接”。A --&gt; C(圆角长方形)，节点 A 指向节点 C。C 是一个圆角长方形节点，显示内容为“圆角长方形”。B --&gt; D&#123;菱形&#125;，节点 B 指向节点 D。D 是一个菱形节点，显示内容为“菱形”。C --&gt; D，节点 C 也指向节点 D，箭头不带标签。节点类型和形状长方形 [] ：如 A[长方形]，是默认的矩形节点。圆形 (()) ：如 B((圆))，用于表示一个圆形节点。圆角长方形 () ：如 C(圆角长方形)，用于表示圆角矩形节点。菱形 &#123;&#125; ：如 D&#123;菱形&#125;，用于表示决策点或条件分支。 Sequence Diagram 用于绘制时序图，显示多个实体之间的交互关系，包括消息、时间、状态和数据交换。 Mermaid Sequence Diagram type 为 &quot;sequenceDiagram&quot; 12345678910&#123;% mermaid sequenceDiagram %&#125;Alice-&gt;&gt;John: Hello John, how are you?loop Healthcheck John-&gt;&gt;John: Fight against hypochondriaendNote right of John: Rational thoughts!John--&gt;&gt;Alice: Great!John-&gt;&gt;Bob: How about you?Bob--&gt;&gt;John: Jolly good!&#123;% endmermaid %&#125; 效果 sequenceDiagram Alice-&gt;&gt;John: Hello John, how are you? loop Healthcheck John-&gt;&gt;John: Fight against hypochondria end Note right of John: Rational thoughts! John--&gt;&gt;Alice: Great! John-&gt;&gt;Bob: How about you? Bob--&gt;&gt;John: Jolly good! 说明 12345678910111213141516171819202122232425262728293031基本结构说明sequenceDiagram: 定义一个序列图，表示消息和事件的时间顺序。参与者 Alice、John 和 Bob 是参与者。 每个参与者在图中会以垂直排列的形式显示。消息和箭头 -&gt;&gt; 表示一个消息的发送，方向由箭头决定。 消息内容写在箭头旁边。循环（loop） 使用 loop 定义一个循环块，循环中的消息会重复执行，表示某种持续行为。备注（Note） Note right of John 定义了一条备注，显示在 John 的右侧，用来补充说明。代码逐步解析Alice-&gt;&gt;John: Hello John, how are you? 表示 Alice 给 John 发送一条消息：“Hello John, how are you?”loop Healthcheck 定义一个循环块，标题为“Healthcheck”（健康检查）。 循环内容是： John-&gt;&gt;John: Fight against hypochondria 表示 John 自己向自己发送一条消息：“Fight against hypochondria”（与疑病症抗争）。Note right of John: Rational thoughts! 定义了一条备注，显示在 John 的右侧。 备注内容为：“Rational thoughts!”（理性思考！）。John--&gt;&gt;Alice: Great! John 回复 Alice 一条消息：“Great!”（很好！）。 使用 --&gt;&gt; 表示回复消息。John-&gt;&gt;Bob: How about you? John 询问 Bob 一条消息：“How about you?”（你怎么样？）。Bob--&gt;&gt;John: Jolly good! Bob 回复 John 一条消息：“Jolly good!”（非常好！）。 Class Diagram 用于绘制类图，显示对象之间的关系，包括继承、关联、依赖等。 Mermaid Class Diagram type 为 &quot;classDiagram&quot; 1234567891011121314151617&#123;% mermaid classDiagram %&#125;Class01 &lt;|-- AveryLongClass : Cool&lt;&lt;interface&gt;&gt; Class01Class09 --&gt; C2 : Where am i?Class09 --* C3Class09 --|&gt; Class07Class07 : equals()Class07 : Object[] elementDataClass01 : size()Class01 : int chimpClass01 : int gorillaclass Class10 &#123; &lt;&lt;service&gt;&gt; int id size()&#125;&#123;% endmermaid %&#125; 效果 classDiagram Class01 &lt;|-- AveryLongClass : Cool &lt;&lt;interface&gt;&gt; Class01 Class09 --&gt; C2 : Where am i? Class09 --* C3 Class09 --|&gt; Class07 Class07 : equals() Class07 : Object[] elementData Class01 : size() Class01 : int chimp Class01 : int gorilla class Class10 &#123; &lt;&lt;service&gt;&gt; int id size() &#125; 说明 12345678910111213141516171819202122232425262728293031323334353637383940414243基本结构classDiagram 定义一个类图，展示类的属性、方法以及它们之间的关系。类和修饰符 使用 class ClassName 定义一个类。 类的属性和方法定义在 class 块内。 特殊修饰符如 &lt;&lt;interface&gt;&gt; 和 &lt;&lt;service&gt;&gt; 用于说明类的角色或类型。关系符号 &lt;|-- 表示继承（extends）。 --|&gt; 表示实现（implements，接口的实现）。 --&gt; 表示关联（普通引用）。 --* 表示组合关系（一个类包含另一个类）。 : 后跟关系的说明或注释。代码逐步解析Class01 &lt;|-- AveryLongClass : Cool 表示 AveryLongClass 继承了 Class01，关系名称为 Cool。 &lt;|-- 表示继承（父类到子类）。&lt;&lt;interface&gt;&gt; Class01 将 Class01 标记为一个接口。Class09 --&gt; C2 : Where am i? 表示 Class09 与 C2 有一个关联关系，注释为 “Where am i?”。Class09 --* C3 表示 Class09 与 C3 有一个组合关系。 Class09 包含一个或多个 C3 的实例。Class09 --|&gt; Class07 表示 Class09 实现了 Class07。 --|&gt; 通常用于表示接口实现。Class07 : equals() 表示 Class07 定义了一个方法 equals()。Class07 : Object[] elementData 表示 Class07 有一个属性 elementData，类型是 Object[]（数组）。Class01 : size() 表示 Class01 有一个方法 size()。Class01 : int chimp 和 Class01 : int gorilla 表示 Class01 有两个整型属性：chimp 和 gorilla。class Class10 &#123; ... &#125; 定义了一个名为 Class10 的类。 类中有一个修饰符 &lt;&lt;service&gt;&gt;，表示这是一个服务类。 属性和方法： int id：整型属性。 size()：方法。 State Diagram 用于绘制状态图，显示对象的状态转移和行为。 Mermaid State Diagram type 为 &quot;stateDiagram&quot; 12345678&#123;% mermaid stateDiagram %&#125;[*] --&gt; StillStill --&gt; [*]Still --&gt; MovingMoving --&gt; StillMoving --&gt; CrashCrash --&gt; [*]&#123;% endmermaid %&#125; 效果 stateDiagram [*] --&gt; Still Still --&gt; [*] Still --&gt; Moving Moving --&gt; Still Moving --&gt; Crash Crash --&gt; [*] 说明 123456789101112131415161718192021222324252627基本结构stateDiagram 定义这是一个状态图，用于表示状态和状态之间的转换。[*] 表示初始状态或终止状态。 起始状态通常有箭头指向第一个状态。 终止状态通常有箭头指向它。状态 用状态名称定义状态，例如 Still、Moving、Crash。箭头 --&gt; 表示状态之间的转换方向。代码逐步解析[*] --&gt; Still 系统从初始状态进入 Still 状态。Still --&gt; [*] 系统从 Still 状态可以直接进入终止状态（系统结束）。Still --&gt; Moving 系统从 Still 状态可以转换为 Moving 状态。Moving --&gt; Still 系统从 Moving 状态可以返回到 Still 状态。Moving --&gt; Crash 系统从 Moving 状态可以进入 Crash 状态。Crash --&gt; [*] 系统从 Crash 状态可以进入终止状态（表示系统崩溃或终止）。 Entity Relationship Diagram 用于绘制实体关系图，显示实体之间的关系，包括关联、依赖等。 Mermaid Entity Relationship Diagram type 为 &quot;erDiagram&quot; 12345&#123;% mermaid erDiagram %&#125;CUSTOMER ||--o&#123; ORDER : placesORDER ||--|&#123; ITEM : containsCUSTOMER &#125;|..|&#123; DELIVERY-ADDRESS : has&#123;% endmermaid %&#125; 效果 erDiagram CUSTOMER ||--o&#123; ORDER : places ORDER ||--|&#123; ITEM : contains CUSTOMER &#125;|..|&#123; DELIVERY-ADDRESS : has 说明 12345678910111213141516171819202122232425基本结构erDiagram 定义这是一个实体关系图。 展示数据库中表（实体）之间的关系。实体 例如 CUSTOMER、ORDER 和 ITEM，每个实体对应数据库中的一个表。关系 ||--o&#123; 表示一对多关系（1:N）。 ||--|&#123; 表示一对多关系（1:N），但强调实体的唯一性（每个子记录属于唯一的父记录）。 &#125;|..|&#123; 表示多对多关系（N:M）。注释 : 后的文字是关系的描述，例如 places、contains、has。代码逐步解析CUSTOMER ||--o&#123; ORDER : places 表示一个客户 (CUSTOMER) 可以下多个订单 (ORDER)。 ||--o&#123; 表示 一对多关系（1:N），即一个客户对应多个订单。ORDER ||--|&#123; ITEM : contains 表示一个订单 (ORDER) 包含多个商品 (ITEM)。 ||--|&#123; 表示 一对多关系，且每个商品的记录与某个订单唯一对应。CUSTOMER &#125;|..|&#123; DELIVERY-ADDRESS : has 表示一个客户 (CUSTOMER) 可以有多个配送地址 (DELIVERY-ADDRESS)，而每个配送地址也可能对应多个客户。 &#125;|..|&#123; 表示 多对多关系（N:M）。 Gantt Chart 用于绘制甘特图，显示任务计划、进度和资源分配。 Mermaid Gantt Chart type 为 &quot;gantt&quot; 1234567891011121314&#123;% mermaid gantt %&#125;title Project TimelinedateFormat YYYY-MM-DDsection Section1Completed :done, des1, 2014-01-06,2014-01-08Active :active, des2, 2014-01-07, 3dParallel 1 : des3, after des1, 1dParallel 2 : des4, after des1, 1dParallel 3 : des5, after des3, 1dParallel 4 : des6, after des4, 1dsection Section2Task 1 : t1,after des6,5dTask 2 : t2,after t1,3d&#123;% endmermaid %&#125; 效果 gantt title Project Timeline dateFormat YYYY-MM-DD section Section1 Completed :done, des1, 2014-01-06,2014-01-08 Active :active, des2, 2014-01-07, 3d Parallel 1 : des3, after des1, 1d Parallel 2 : des4, after des1, 1d Parallel 3 : des5, after des3, 1d Parallel 4 : des6, after des4, 1d section Section2 Task 1 : t1,after des6,5d Task 2 : t2,after t1,3d 说明 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273基本结构gantt 定义一个甘特图，用于表示任务的时间分布和依赖关系。title 定义甘特图的标题，这里是 Project Timeline。dateFormat 定义日期格式，这里是 YYYY-MM-DD（年-月-日）。section 定义任务的分类（部分）。 每个 section 下包含一组任务，任务在图表中分组显示。任务格式 每个任务按以下格式定义： 任务名称 : 状态, 标识符, 开始日期或依赖, 持续时间 任务名称：任务的描述。 状态：可选，表示任务状态： done：已完成。 active：正在进行。 标识符：任务的唯一标识符，用于定义依赖关系。 时间：可以是开始日期、结束日期、或依赖任务。代码逐步解析section Section1 定义一个名为 Section1 的部分，包含一组任务。Completed :done, des1, 2014-01-06,2014-01-08 任务名称：Completed。 状态：done（已完成）。 标识符：des1。 开始日期：2014-01-06。 结束日期：2014-01-08。Active :active, des2, 2014-01-07, 3d 任务名称：Active。 状态：active（正在进行）。 标识符：des2。 开始日期：2014-01-07。 持续时间：3d（3天）。Parallel 1 : des3, after des1, 1d 任务名称：Parallel 1。 无状态（默认值）。 标识符：des3。 开始时间：依赖任务 des1（在任务 Completed 后开始）。 持续时间：1d（1天）。Parallel 2 : des4, after des1, 1d 任务名称：Parallel 2。 无状态。 标识符：des4。 开始时间：依赖任务 des1（在任务 Completed 后开始）。 持续时间：1d（1天）。Parallel 3 : des5, after des3, 1d 任务名称：Parallel 3。 无状态。 标识符：des5。 开始时间：依赖任务 des3（在任务 Parallel 1 后开始）。 持续时间：1d（1天）。Parallel 4 : des6, after des4, 1d 任务名称：Parallel 4。 无状态。 标识符：des6。 开始时间：依赖任务 des4（在任务 Parallel 2 后开始）。 持续时间：1d（1天）。section Section2 定义甘特图的第二部分，用于分组显示后续任务。 任务属于不同的部分以便分类和分组。Task 1 : t1, after des6, 5d 任务名称：Task 1。 标识符：t1。 开始时间：依赖任务 des6（Parallel 4）完成后开始。 持续时间：5d（5天）。Task 2 : t2, after t1, 3d 任务名称：Task 2。 标识符：t2。 开始时间：依赖任务 t1（Task 1）完成后开始。 持续时间：3d（3天）。 Pie Chart 用于绘制饼状图，显示数据分布情况。 Mermaid Pie Chart type 为 &quot;pie&quot; 1234567&#123;% mermaid pie showData %&#125;%%&#123;init: &#123;&quot;pie&quot;: &#123;&quot;textPosition&quot;: 0.4&#125;, &quot;themeVariables&quot;: &#123;&quot;pieOuterStrokeWidth&quot;: &quot;5px&quot;,&quot;pie1&quot;: &quot;#ff9999&quot;,&quot;pie2&quot;: &quot;#99ccff&quot;,&quot;pie3&quot;: &quot;#99ff99&quot;&#125;&#125; &#125;%%title Expenses&quot;Rent&quot; : 200&quot;Food&quot; : 200&quot;Transport&quot; : 400&#123;% endmermaid %&#125; 效果 %%&#123;init: &#123;&quot;pie&quot;: &#123;&quot;textPosition&quot;: 0.4&#125;, &quot;themeVariables&quot;: &#123;&quot;pieOuterStrokeWidth&quot;: &quot;5px&quot;,&quot;pie1&quot;: &quot;#ff9999&quot;,&quot;pie2&quot;: &quot;#99ccff&quot;,&quot;pie3&quot;: &quot;#99ff99&quot;&#125;&#125; &#125;%% pie showData title Expenses &quot;Rent&quot; : 200 &quot;Food&quot; : 200 &quot;Transport&quot; : 400 说明 1234567891011121314151617181920212223基本结构%%&#123;init: ...&#125;%%： Mermaid.js 的初始化配置，用于全局设置图表属性和样式。 pie 属性 textPosition: 设置饼图数据标签的相对位置。 值范围为 0 到 1，表示标签距离饼图中心的比例。0.4 表示标签距离中心较近，接近 40% 的半径位置。 themeVariables pieOuterStrokeWidth: 设置饼图外环的宽度。设置为 5px，表示饼图有明显的外边框。 &quot;pie1&quot;: &quot;#ff9999&quot;,&quot;pie2&quot;: &quot;#99ccff&quot;,&quot;pie3&quot;: &quot;#99ff99&quot;: 配置每个分区的颜色。pie 定义这是一个饼图。showData 显示数据项的数值。title Expenses 设置饼图的标题为 Expenses（费用）。数据项 数据项定义了饼图的各个部分： &quot;Rent&quot; : 200，占比：200 / (200 + 200 + 400) = 1/4 = 25%。 &quot;Food&quot; : 200，占比：200 / (200 + 200 + 400) = 1/4 = 25%。 &quot;Transport&quot; : 400，占比：400 / (200 + 200 + 400) = 1/2 = 50%。 每个数据项包含： 标签：如 &quot;Rent&quot;、&quot;Food&quot;、&quot;Transport&quot;。 数值：如 200、400，表示该部分的权重或数值大小。 XY Chart 用于绘制 XY 轴图(柱状图和折线图)，显示数据分布和趋势。 Mermaid XY Chart type 为 &quot;xychart-beta&quot;，目前 xychart-beta 还处在改进阶段 12345678&#123;% mermaid xychart-beta %&#125;%%&#123;init: &#123;&quot;xyChart&quot;: &#123;&quot;width&quot;: 900,&quot;height&quot;:600&#125;, &quot;themeVariables&quot;: &#123;&quot;xyChart&quot;:&#123;&quot;titleColor&quot;: &quot;#ff0000&quot;&#125;&#125;&#125; &#125;%%title &quot;Sales Revenue&quot;x-axis [jan, feb, mar, apr, may, jun, jul, aug, sep, oct, nov, dec]y-axis &quot;Revenue (in $)&quot; 4000 --&gt; 11000bar [5000, 6000, 7500, 8200, 9500, 10500, 11000, 10200, 9200, 8500, 7000, 6000]line [5000, 6000, 7500, 8200, 9500, 10500, 11000, 10200, 9200, 8500, 7000, 6000]&#123;% endmermaid %&#125; 效果 --- config: xyChart: width: 900 height: 600 themeVariables: xyChart: titleColor: &quot;#ff0000&quot; --- xychart-beta title &quot;Sales Revenue&quot; x-axis [jan, feb, mar, apr, may, jun, jul, aug, sep, oct, nov, dec] y-axis &quot;Revenue (in $)&quot; 4000 --&gt; 11000 bar [5000, 6000, 7500, 8200, 9500, 10500, 11000, 10200, 9200, 8500, 7000, 6000] line [5000, 6000, 7500, 8200, 9500, 10500, 11000, 10200, 9200, 8500, 7000, 6000] 说明 12345678910111213代码结构解析%%&#123;init: ...&#125;%%： Mermaid.js 的初始化配置，用于全局设置图表属性和样式。 xyChart.width 和 xyChart.height : 设置图表的宽度和高度。 themeVariables.xyChart.titleColor: 设置标题的颜色。title 设置图表的标题。坐标轴定义 x-axis：X轴标签为月份（从1月到12月）。 y-axis：Y轴范围从 $4000 到 $11000，单位为美元。数据 bar：柱状图数据，表示每个月的销售收入。 line：折线图数据，表示每个月的销量趋势。 Journey Diagram 用于绘制旅程图，显示用户的体验流程，包括用户进入系统、操作、退出系统等。 Mermaid Journey Diagram type 为 &quot;journey&quot; 12345678910111213&#123;% mermaid journey %&#125;title My working daysection Morning wake up : 5 : me go to work : 3 : me,yousection Lunch have lunch : 5 : me,you go to work : 1 : me,yousection Dinner finish your meal : 5 : mesection Go home go home : 5 : me&#123;% endmermaid %&#125; 效果 journey title My working day section Morning wake up : 5 : me go to work : 3 : me,you section Lunch have lunch : 5 : me,you go to work : 1 : me,you section Dinner finish your meal : 5 : me section Go home go home : 5 : me 说明 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748基本结构journey 定义这是一个旅程图。title My working day 设置旅程图的标题为 &quot;My working day&quot;（我的工作日）。section 定义旅程图的分段，用于表示一天中的不同阶段，例如： Morning（早晨）。 Lunch（午餐时间）。 Dinner（晚餐）。 Go home（回家）。任务格式 任务描述 : 满意度评分 : 参与者 任务描述：描述具体的任务或活动。 满意度评分：从 1 到 5，表示对任务或活动的满意程度。 参与者：参与任务的人，可以是 me（自己）、you（其他人）或两者。代码逐步解析section Morning wake up : 5 : me 活动：wake up（起床）。 满意度：5（非常满意）。 参与者：me（自己）。 go to work : 3 : me,you 活动：go to work（去工作）。 满意度：3（中等满意）。 参与者：me 和 you（自己和其他人）。section Lunch have lunch : 5 : me,you 活动：have lunch（吃午饭）。 满意度：5（非常满意）。 参与者：me 和 you（自己和其他人）。 go to work : 1 : me,you 活动：go to work（吃完饭继续工作）。 满意度：1（非常不满意）。 参与者：me 和 you。section Dinner finish your meal : 5 : me 活动：finish your meal（吃完饭）。 满意度：5（非常满意）。 参与者：me（自己）。section Go home go home : 5 : me 活动：go home（回家）。 满意度：5（非常满意）。 参与者：me（自己）。 Requirement Diagram 用于绘制需求图，显示系统的功能需求和依赖关系。 Mermaid Requirement Diagram type 为 &quot;requirementDiagram&quot; 12345678910111213141516171819&#123;% mermaid requirementDiagram %&#125;requirement &quot;测试需求&quot; &#123; id: 1 text: &quot;测试文本&quot; risk: High verifymethod: test&#125;requirement &quot;测试需求2&quot; &#123; id: 2 text: &quot;测试文本&quot; risk: High verifymethod: test&#125;element &quot;测试实体&quot; &#123; type: &quot;模拟&quot;&#125;&quot;测试实体&quot; - satisfies -&gt; &quot;测试需求&quot;&quot;测试实体&quot; - satisfies -&gt; &quot;测试需求2&quot;&#123;% endmermaid %&#125; 效果 requirementDiagram requirement &quot;测试需求&quot; &#123; id: 1 text: &quot;测试文本&quot; risk: High verifymethod: test &#125; requirement &quot;测试需求2&quot; &#123; id: 2 text: &quot;测试文本&quot; risk: High verifymethod: test &#125; element &quot;测试实体&quot; &#123; type: &quot;模拟&quot; &#125; &quot;测试实体&quot; - satisfies -&gt; &quot;测试需求&quot; &quot;测试实体&quot; - satisfies -&gt; &quot;测试需求2&quot; 说明 12345678910111213141516171819202122232425262728293031323334353637383940基本结构requirementDiagram 定义这是一个需求图。requirement 定义一个需求节点，包含需求的详细属性，如： id：需求编号。 text：需求的描述。 risk：需求的风险级别（如 High 表示高风险）。 verifymethod：验证需求的方法（如 test 表示通过测试验证）。element 定义一个元素，用于表示系统中的某个实体或对象。 包含属性，如： type：实体的类型（如 模拟 表示模拟实体）。关系定义 定义了两个关系： &quot;测试实体&quot; - satisfies -&gt; &quot;测试需求&quot; : 测试实体 满足了 测试需求 &quot;测试实体&quot; - satisfies -&gt; &quot;测试需求2&quot; : 测试实体 满足了 测试需求2 - satisfies -&gt;：satisfies 表示满足关系，箭头方向从实体指向需求代码逐步解析需求定义 requirement &quot;测试需求&quot; 定义第一个需求，显示名称为 测试需求。 属性： id: 1（需求编号为 1）。 text: &quot;测试文本&quot;（描述文本为 &quot;测试文本&quot;）。 risk: High（高风险需求）。 verifymethod: test（验证方法为测试）。 requirement &quot;测试需求2&quot; 定义第二个需求，显示名称为 测试需求2。 属性： id: 2（需求编号为 2）。 text: &quot;测试文本&quot;（描述文本与第一个需求相同）。 risk: High（高风险需求）。 verifymethod: test（验证方法为测试）。实体定义 element &quot;测试实体&quot; 定义一个系统实体，显示名称为 测试实体。 属性： type: &quot;模拟&quot;（实体类型为 &quot;模拟&quot;）。 Gitgraph Diagram 用于绘制Git图，显示代码仓库的提交历史和分支关系。 Mermaid Gitgraph Diagram type 为 &quot;gitgraph&quot; 1234567891011&#123;% mermaid gitGraph %&#125;commitcommitcommitbranch newbranchcheckout newbranchcommitcommitcheckout mainmerge newbranch&#123;% endmermaid %&#125; 效果 gitGraph commit commit commit branch newbranch checkout newbranch commit commit checkout main merge newbranch 说明 1234567891011121314基本结构gitGraph 定义这是一个 Git 图。commit 表示一次提交操作，每个 commit 节点代表代码仓库的某个提交点。branch 创建一个新分支。 格式：branch 分支名称。checkout 切换到指定分支。 格式：checkout 分支名称。merge 将指定分支合并到当前分支。 格式：merge 分支名称。 Mindmap 用于绘制思维导图，显示主题和子主题之间的 hierarchical 关系。 Mermaid Mindmap type 为 &quot;mindmap&quot; 123456789101112131415161718&#123;% mermaid mindmap %&#125;root((mindmap)) (origins) Long history ::icon(fa fa-book) Popularisation British popular psychology author Tony Buzan [Research] On effectivness&lt;br/&gt;and features On Automatic creation Uses Creative techniques Strategic planning Argument mapping Tools Pen and paper Mermaid&#123;% endmermaid %&#125; 效果 mindmap root((mindmap)) (origins) Long history ::icon(fa fa-book) Popularisation British popular psychology author Tony Buzan [Research] On effectivness&lt;br/&gt;and features On Automatic creation Uses Creative techniques Strategic planning Argument mapping Tools Pen and paper Mermaid 说明 123456789101112131415基本结构mindmap 定义这是一个思维导图。root((mindmap)) 定义思维导图的根节点，显示为圆形并标注为 &quot;mindmap&quot;。子节点使用缩进表示从属关系： 每一级缩进代表一个层级的子节点。 子节点可以直接添加内容或通过 &lt;br/&gt; 换行。::icon(...) 为节点添加图标。Mermaid.js 支持使用 FontAwesome 的图标。节点形状长方形 [] ：如 [长方形]，是默认的矩形节点。这个是默认的节点类型。圆形 (()) ：如 ((圆))，用于表示一个圆形节点。圆角长方形 () ：如 (圆角长方形)，用于表示圆角矩形节点。 QuadrantChart 用于绘制象限图，显示不同维度之间的比较关系。 Mermaid QuadrantChart type 为 &quot;quadrantChart&quot; 12345678910111213141516&#123;% mermaid quadrantChart %&#125;%%&#123;init: &#123;&quot;quadrantChart&quot;: &#123;&quot;chartHeight&quot;: 600, &quot;chartWidth&quot;: 800, &quot;pointTextPadding&quot;: 10&#125;, &quot;themeVariables&quot;: &#123;&quot;quadrant1Fill&quot;: &quot;#ff0000&quot;, &quot;quadrant2Fill&quot;: &quot;#FFFF00&quot;, &quot;quadrant3Fill&quot;: &quot;#32CD32&quot;, &quot;quadrant4Fill&quot;: &quot;#800080&quot;&#125;&#125;&#125;%%title Reach and engagement of carpaignsx-axis Low Reach --&gt; High Reachy-axis Low Engagement --&gt; High Engagementquadrant-1 we should expandquadrant-2 Need to promotequadrant-3 Re-evaluatequadrant-4 May be improvedCampaign A: [0.3,0.6]Campaign B: [0.45,0.23]Campaign C: [0.57,0.69]Campaign D: [0.78,0.34]Campaign E: [0.40,0.34]Campaign F: [0.35,0.78]&#123;% endmermaid %&#125; 效果 %%&#123;init: &#123;&quot;quadrantChart&quot;: &#123;&quot;chartHeight&quot;: 600, &quot;chartWidth&quot;: 800, &quot;pointTextPadding&quot;: 10&#125;, &quot;themeVariables&quot;: &#123;&quot;quadrant1Fill&quot;: &quot;#ff0000&quot;, &quot;quadrant2Fill&quot;: &quot;#FFFF00&quot;, &quot;quadrant3Fill&quot;: &quot;#32CD32&quot;, &quot;quadrant4Fill&quot;: &quot;#800080&quot;&#125;&#125;&#125;%% quadrantChart title Reach and engagement of carpaigns x-axis Low Reach --&gt; High Reach y-axis Low Engagement --&gt; High Engagement quadrant-1 we should expand quadrant-2 Need to promote quadrant-3 Re-evaluate quadrant-4 May be improved Campaign A: [0.3,0.6] Campaign B: [0.45,0.23] Campaign C: [0.57,0.69] Campaign D: [0.78,0.34] Campaign E: [0.40,0.34] Campaign F: [0.35,0.78] 说明 12345678910111213141516171819202122232425262728293031323334353637基本结构%%&#123;init: ...&#125;%% 这是 Mermaid.js 的初始化配置块，用于自定义图表的全局参数和样式。 配置内容，详见下文： quadrantChart：自定义象限图的相关参数。 themeVariables： 图表主题配色。quadrantChart 定义这是一个象限图。title 标题坐标轴，定义 X 轴和 Y 轴的范围和方向：x-axis Low Reach --&gt; High Reach X 轴 从 “Low Reach” 到 “High Reach”。y-axis Low Engagement --&gt; High Engagement Y 轴 从 “Low Engagement” 到 “High Engagement”。象限定义quadrant-1 we should expand 象限 1（右上）：&quot;we should expand&quot;quadrant-2 Need to promote 象限 2（左上）：&quot;Need to promote&quot;quadrant-3 Re-evaluate 象限 3（左下）：&quot;Re-evaluate&quot;quadrant-4 May be improved 象限 4（右下）：&quot;May be improved&quot;数据点Campaign A: [0.3,0.6]Campaign B: [0.45,0.23]Campaign C: [0.57,0.69]Campaign D: [0.78,0.34]Campaign E: [0.40,0.34]Campaign F: [0.35,0.78]定义了 6 个活动（Campaign）的数据点，使用 [name]: [x, y] 的格式来添加数据点，其中 [name] 是数据点的名称，[x, y] 是数据点在 x 轴和 y 轴上的坐标值，对于点x和y值，最小值为0，最大值为1。X 值：表示活动的 Reach（覆盖面）。Y 值：表示活动的 Engagement（参与度）。 初始化配置 quadrantChart：自定义象限图的相关参数 参数 描述 默认值 chartHeight 图表的高度 500 chartWidth 图表的宽度 500 pointLabelFontSize 点文本字体大小 12 pointRadius 要绘制的点的半径 5 pointTextPadding 点和下面文本之间的填充 5 quadrantExternalBorderStrokeWidth 象限外边框描边宽度 2 quadrantInternalBorderStrokeWidth 象限内的边框描边宽度 1 quadrantLabelFontSize 象限文本字体大小 16 quadrantPadding 所有象限外的填充 5 quadrantTextTopPadding 当文本绘制在顶部时象限文本顶部填充（那里没有数据点） 5 titlePadding 标题的顶部和底部填充 10 titleFontSize 标题字体大小 20 xAxisLabelPadding x 轴文本的顶部和底部填充 5 xAxisLabelFontSize X 轴文本字体大小 16 xAxisPosition x 轴的位置（顶部、底部）如果有点，则 x 轴将始终渲染在底部 ‘top’ yAxisLabelPadding y 轴文本的左右填充 5 yAxisLabelFontSize Y 轴文本字体大小 16 yAxisPosition y 轴位置（左、右） ‘left’ themeVariables： 图表主题配色 参数 描述 quadrant1Fill 右上象限的填充颜色 quadrant2Fill 左上象限的填充颜色 quadrant3Fill 左下象限的填充颜色 quadrant4Fill 右下象限的填充颜色 quadrant1TextFill 右上象限的文本颜色 quadrant2TextFill 左上象限的文本颜色 quadrant3TextFill 左下象限的文本颜色 quadrant4TextFill 右下象限的文本颜色 quadrantPointFill 点填充颜色 quadrantPointTextFill 点文本颜色 quadrantXAxisTextFill X 轴文本颜色 quadrantYAxisTextFill Y 轴文本颜色 quadrantInternalBorderStrokeFill 象限内边框颜色 quadrantExternalBorderStrokeFill 象限外边框颜色 quadrantTitleFill 标题颜色","summary":"摘要 Mermaid 是一个支持在Markdown文档中绘制流程图、甘特图、序列图等图形的工具。它基于JavaScript实现，能够将Markdown中的元素渲染成HTML元素，从而在网页上直观地展示各种图表‌ Next主题中使用Mermaid说明 本文介绍如何在 Hexo-Next 主题中使用 Mermaid","date_published":"2025-01-02T13:55:05.000Z","tags":["Hexo","Hexo"]},{"id":"https://blog.hanqunfeng.com/2024/11/28/brew/","url":"https://blog.hanqunfeng.com/2024/11/28/brew/","title":"MacOS软件包管理器--brew","content_html":"<!--\n **加粗**\n *斜体*\n ***加粗并斜体***\n ~~删除线~~\n ==突出显示==\n `突出显示(推荐)`\n ++下划线++\n ~下标~\n ^上标^\n 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.\n 图片设置宽度和高度(通过uPic上传后，需要将upic修改过为blog，用于添加水印) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)\n\n +++ **点击折叠**\n 这是被隐藏的内容\n +++\n\n::: tips success warning danger\n这里是容器内的内容\n:::\n\n% note info % success warning danger\n这里是容器内的内容\n% endnote %\n\n-->\n<h2 id=\"摘要\">摘要</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><a href=\"https://brew.sh\">brew</a>是一个软件包管理器，同时支持MacOS和Linux，可以很方便地安装各种软件，比如<code>git</code>、<code>node</code>、<code>python</code>等。</p>\n</li>\n<li class=\"lvl-2\">\n<p><code>brew</code>虽然支持linux，但是实际使用中很少会使用brew来管理linux的软件包。</p>\n</li>\n<li class=\"lvl-2\">\n<p>本文介绍如何在macos下安装brew，以及如何使用brew管理各种软件包。</p>\n</li>\n<li class=\"lvl-2\">\n<p>本文基于 MacOS Intel Ventura 13.7.1，brew 版本为4.4.8。</p>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"安装\">安装</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>首先要确保系统中安装了 <code>git</code> 和 <code>curl</code>，对于 macOS 用户来说，这些系统都自带了，唯一需额外要求安装的是<code>Command Line Tools (CLT) for Xcode</code>。</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 检查系统中是否安装了 Command Line Tools (CLT) for Xcode</span></span><br><span class=\"line\">xcode-select --version <span class=\"comment\"># 能够输出版本号说明安装了，否则需要安装。</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 安装 Command Line Tools (CLT) for Xcode</span></span><br><span class=\"line\">xcode-select --install</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 打印当前的 Command Line Tools (CLT) for Xcode 的安装路径</span></span><br><span class=\"line\">xcode-select -p <span class=\"comment\"># /Library/Developer/CommandLineTools</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"在MacOS上安装brew的方法\">在MacOS上安装brew的方法</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><a href=\"https://github.com/Homebrew/install\">参考资料</a></p>\n</li>\n</ul>\n<h4 id=\"方法一：使用脚本安装\">方法一：使用脚本安装</h4>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/bin/bash -c <span class=\"string\">&quot;<span class=\"subst\">$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)</span>&quot;</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>安装时可以指定镜像下载源，默认是<a href=\"https://github.com/Homebrew/brew.git\">Homebrew的GitHub下载源</a>，也可以选择国内的镜像源，比如使用<a href=\"https://mirrors.tuna.tsinghua.edu.cn/help/homebrew/\">清华大学的Homebrew</a>镜像源</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 控制了 Homebrew 在安装软件包时是否从 Homebrew 的 API 服务器获取信息，brew4.0后是默认行为，无需设置</span></span><br><span class=\"line\"><span class=\"built_in\">export</span> HOMEBREW_INSTALL_FROM_API=1</span><br><span class=\"line\"><span class=\"comment\"># 设置brew仓库上游</span></span><br><span class=\"line\"><span class=\"built_in\">export</span> HOMEBREW_BREW_GIT_REMOTE=<span class=\"string\">&quot;https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/brew.git&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># 设置homebrew核心上游</span></span><br><span class=\"line\"><span class=\"built_in\">export</span> HOMEBREW_CORE_GIT_REMOTE=<span class=\"string\">&quot;https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/homebrew-core.git&quot;</span></span><br><span class=\"line\">/bin/bash -c <span class=\"string\">&quot;<span class=\"subst\">$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)</span>&quot;</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"方法二：使用PKG文件安装\">方法二：使用PKG文件安装</h4>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>从<a href=\"https://github.com/Homebrew/brew\">Homebrew的github</a>上下载最新版的<a href=\"https://github.com/Homebrew/brew/releases/latest\">Homebrew-x.x.x.pkg</a></p>\n</li>\n</ul>\n<h4 id=\"方法三：国内无法访问github地址时可以使用国内镜像源\">方法三：国内无法访问github地址时可以使用国内镜像源</h4>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>这里依旧以清华大学的Homebrew镜像源为例</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">export</span> HOMEBREW_BREW_GIT_REMOTE=<span class=\"string\">&quot;https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/brew.git&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">export</span> HOMEBREW_CORE_GIT_REMOTE=<span class=\"string\">&quot;https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/homebrew-core.git&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># 从镜像下载安装脚本并安装 Homebrew / Linuxbrew</span></span><br><span class=\"line\">git <span class=\"built_in\">clone</span> --depth=1 https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/install.git brew-install</span><br><span class=\"line\">/bin/bash brew-install/install.sh</span><br><span class=\"line\"><span class=\"built_in\">rm</span> -rf brew-install</span><br></pre></td></tr></table></figure>\n<h4 id=\"验证是否安装成功\">验证是否安装成功</h4>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>brew</code> 命令本身及通过brew安装的所有命令都会被软链接到<code>/usr/local/bin/</code>下，所以需要将该路径加入系统环境PATH中</p>\n</li>\n<li class=\"lvl-2\">\n<p>重启终端，然后执行<code>brew -v</code>命令查看brew的版本，如果安装成功，会输出类似如下内容</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ brew -v</span><br><span class=\"line\">Homebrew 4.4.8-40-g13c3def</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Homebrew本身的安装位置可以通过<code>brew --repo</code>查看，默认为<code>/usr/local/Homebrew</code></p>\n</li>\n<li class=\"lvl-2\">\n<p>通过brew安装的软件包默认会被安装到<code>/usr/local/Cellar/</code>下，比如<code>git</code>安装后会在<code>/usr/local/Cellar/git/</code>目录下，可以通过<code>brew info git</code>查看安装信息，包括依赖库等。</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 显示 Homebrew 安装路径，macOS ARM: /opt/homebrew，macOS Intel: /usr/local</span></span><br><span class=\"line\">$ brew --prefix</span><br><span class=\"line\">/usr/local</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 显示 Homebrew 本地的 Git 仓库</span></span><br><span class=\"line\">$ brew --repo</span><br><span class=\"line\">/usr/local/Homebrew</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 显示 Homebrew Cellar 路径，命令行工具的安装路径</span></span><br><span class=\"line\">$ brew --cellar</span><br><span class=\"line\">/usr/local/Cellar</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 显示 Homebrew Caskroom 路径，GUI工具的安装路径</span></span><br><span class=\"line\">$ brew --caskroom</span><br><span class=\"line\">/usr/local/Caskroom</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 缓存路径，下载安装包的缓存路径，通过 brew cleanup 清理</span></span><br><span class=\"line\">$ brew --cache</span><br><span class=\"line\">~/Library/Caches/Homebrew</span><br></pre></td></tr></table></figure>\n<h4 id=\"配置命令补全\">配置命令补全</h4>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>参考官网<a href=\"https://docs.brew.sh/Shell-Completion\">Homebrew Documentation–brew Shell Completion</a></p>\n</li>\n<li class=\"lvl-2\">\n<p>我这里使用的是<code>zsh</code>，在<code>~/.zshrc</code>中加入如下内容并重启终端即可生效</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">autoload</span> -Uz compinit</span><br><span class=\"line\">compinit</span><br></pre></td></tr></table></figure>\n<h4 id=\"卸载brew\">卸载brew</h4>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/bin/bash -c <span class=\"string\">&quot;<span class=\"subst\">$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/uninstall.sh)</span>&quot;</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"常用命令\">常用命令</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>brew</code>支持安装<code>命令行工具(formula)</code>和<code>GUI工具(cask)</code></p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-5\"><code>brew install xxx</code> 安装命令行工具，这个最为常用，比如 <code>brew install fd</code></li>\n<li class=\"lvl-5\"><code>brew install --cask xxx</code> 安装GUI工具，一般很少使用brew安装GUI工具，比如 <code>brew install --cask firefox</code></li>\n</ul>\n</li>\n<li class=\"lvl-2\">\n<p>brew的命令和参数非常多，但日常使用只需要记住常用的几个就够了，详细的命令列表可以参考<a href=\"https://docs.brew.sh/Manpage\">Homebrew Documentation</a></p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看brew支持哪些命令</span></span><br><span class=\"line\">brew commands</span><br><span class=\"line\"><span class=\"comment\"># 查看命令的帮助信息，比如</span></span><br><span class=\"line\">brew install --<span class=\"built_in\">help</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"一些常用的命令\">一些常用的命令</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">brew update <span class=\"comment\"># 更新brew到最新版本</span></span><br><span class=\"line\">brew --version <span class=\"comment\"># 查看brew的版本，可以简写为 brew -v</span></span><br><span class=\"line\">brew config <span class=\"comment\"># 查看brew的配置信息，这个命令很有用，可以查看到与brew相关的环境变量的值</span></span><br><span class=\"line\">brew home <span class=\"comment\"># 浏览器打开brew官网</span></span><br><span class=\"line\">brew home xxx <span class=\"comment\"># 浏览器打开xxx官网 如：打开fd命令的官网 brew home fd ,具体的名称可以通过brew list查看</span></span><br><span class=\"line\">brew cleanup <span class=\"comment\"># 清理缓存及日志文件，建议定期清理，当运行brew时会自动清理（2.0以后的版本）</span></span><br><span class=\"line\">brew cleanup -n <span class=\"comment\"># 显示将要清理的缓存及日志文件，只查看不删除</span></span><br><span class=\"line\">brew doctor <span class=\"comment\"># 检查是否有依赖问题，比如没有安装依赖库，或者依赖库版本过低，当运行brew报错时可以通过该命令进行检查并根据提示进行修改</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>查看已安装的包</p>\n</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看</span></span><br><span class=\"line\">brew list <span class=\"comment\"># 查看已安装的包</span></span><br><span class=\"line\">brew list --versions <span class=\"comment\"># 查看已安装的包及版本</span></span><br><span class=\"line\">brew info xxx <span class=\"comment\"># 查看xxx的安装信息</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>安装、卸载</p>\n</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查找、安装、卸载</span></span><br><span class=\"line\">brew search xxx <span class=\"comment\"># 查找软件包，也可以通过 https://formulae.brew.sh 网页进行搜索</span></span><br><span class=\"line\">brew install xxx <span class=\"comment\"># 安装软件包，此命令相当于加上了 --formula ，安装时会自动下载依赖库，比如安装`nginx`时，会自动下载`openssl@3`和`pcre2`等</span></span><br><span class=\"line\">brew install --cask xxx <span class=\"comment\"># 安装GUI工具，比如`firefox`</span></span><br><span class=\"line\">brew uninstall xxx <span class=\"comment\"># 卸载软件包，此命令相当于加上了 --formula ，只会卸载当前包，不会卸载依赖库，这样就有可能存在很多冗余包</span></span><br><span class=\"line\">brew uninstall --cask xxx <span class=\"comment\"># 卸载GUI工具</span></span><br><span class=\"line\">brew autoremove <span class=\"comment\"># 删除所有仅作为另一个软件包的依赖项安装并且现在不再需要的包</span></span><br><span class=\"line\">brew autoremove --dry-run <span class=\"comment\"># --dry-run 仅查看哪些包可以删除，并不会真的删除</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>升级</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 升级</span></span><br><span class=\"line\">brew outdated <span class=\"comment\"># 查看需要升级的包</span></span><br><span class=\"line\">brew upgrade xxx <span class=\"comment\"># 升级xxx到最新版</span></span><br><span class=\"line\">brew upgrade <span class=\"comment\"># 更新全部命令到最新版</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>依赖关系</p>\n</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 依赖关系</span></span><br><span class=\"line\">brew deps --tree xxx <span class=\"comment\"># 树形显示包的依赖树</span></span><br><span class=\"line\">brew deps --installed --tree <span class=\"comment\"># 树形显示所有安装包的依赖关系</span></span><br><span class=\"line\">brew deps --installed xxx <span class=\"comment\"># 显示当前安装包的依赖关系，纵向展示</span></span><br><span class=\"line\">brew deps --installed --for-each xxx <span class=\"comment\"># 显示当前安装包的依赖关系，横向展示</span></span><br><span class=\"line\">brew uses --installed xxx <span class=\"comment\"># 查看已经安装的哪些工具依赖当前包</span></span><br><span class=\"line\">brew leaves <span class=\"comment\"># 查看顶级安装包，即你通过brew直接安装的包，而不是通过安装其他软件包间接安装的</span></span><br><span class=\"line\">brew leaves | xargs brew deps --installed --for-each --formula <span class=\"comment\"># 查看顶级包，并列出每个顶级包的已安装依赖</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>仓库管理，参考资料<a href=\"https://docs.brew.sh/Taps\">Homebrew Documentation–Taps</a></p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 仓库管理</span></span><br><span class=\"line\">brew tap <span class=\"comment\"># 查看所有已安装的仓库，tap安装路径 /usr/local/Homebrew/Library/Taps/</span></span><br><span class=\"line\">brew tap user/repo <span class=\"comment\"># 添加一个仓库，从gitthub下载</span></span><br><span class=\"line\">brew tap repo_url <span class=\"comment\"># 添加一个仓库，从给定的仓库地址下载</span></span><br><span class=\"line\">brew untap user/repo <span class=\"comment\"># 删除一个仓库</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 从第三方仓库安装工具，此时会自动将 homebrew-ffmpeg/ffmpeg 这个仓库添加到本地</span></span><br><span class=\"line\">brew install homebrew-ffmpeg/ffmpeg/ffmpeg</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 更新仓库，无论是brew自己的仓库还是第三方仓库，都会自动更新</span></span><br><span class=\"line\">brew update</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>brew services</code>: brew的服务管理工具，可以方便的管理通过brew安装的服务，包括启动、停止、重启服务，等等，比如<code>nginx、redis、mysql</code>等，具体命令可以参考<a href=\"https://docs.brew.sh/Manpage#services-subcommand\">Homebrew Documentation</a></p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 第一次执行 services 相关的命令时会自动下载 homebrew/services，也可以 通过 brew tap homebrew/services 提前下载</span></span><br><span class=\"line\">brew services list <span class=\"comment\"># 查看已安装的所有服务</span></span><br><span class=\"line\">brew services start nginx <span class=\"comment\"># 启动服务，并注册到系统启动服务列表，即创建系统自启动文件： ~/Library/LaunchAgents/homebrew.mxcl.nginx.plist</span></span><br><span class=\"line\">brew services stop nginx <span class=\"comment\"># 停止服务，并从系统启动服务列表中移除，即删除系统自启动文件</span></span><br><span class=\"line\">brew services <span class=\"built_in\">kill</span> nginx <span class=\"comment\"># 立即杀死服务，但不从系统启动服务列表中移除</span></span><br><span class=\"line\">brew services restart nginx <span class=\"comment\"># 重启服务</span></span><br><span class=\"line\">brew services info nginx <span class=\"comment\"># 查看服务的状态和进程IP</span></span><br><span class=\"line\">brew services run nginx <span class=\"comment\"># 运行服务，但不会保存到服务列表中</span></span><br><span class=\"line\">brew services cleanup <span class=\"comment\"># 清理无效的服务，即已卸载应用的无用的配置</span></span><br><span class=\"line\">brew services --<span class=\"built_in\">help</span> <span class=\"comment\"># 查看帮助</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"配置国内镜像源\">配置国内镜像源</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>上面安装部分介绍了如何在安装brew时就指定镜像源，但有些时候因为我们在安装时忘记配置，或者原来的镜像源已经失效需要重新配置，此时可以按照下面的方法进行配置。</p>\n</li>\n<li class=\"lvl-2\">\n<p>此处以配置<a href=\"https://mirrors.tuna.tsinghua.edu.cn/help/homebrew/\">清华镜像源</a>为例，阿里镜像源请参考<a href=\"https://developer.aliyun.com/mirror/homebrew/\">阿里的官网文档–Homebrew镜像</a>，科大源参考<a href=\"https://mirrors.ustc.edu.cn/help/brew.git.html\">Homebrew</a></p>\n</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">## 临时替换</span></span><br><span class=\"line\"><span class=\"comment\"># 配置brew国内镜像源</span></span><br><span class=\"line\">$ <span class=\"built_in\">export</span> HOMEBREW_BREW_GIT_REMOTE=<span class=\"string\">&quot;https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/brew.git&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># 配置brew-core国内镜像源</span></span><br><span class=\"line\">$ <span class=\"built_in\">export</span> HOMEBREW_CORE_GIT_REMOTE=<span class=\"string\">&quot;https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/homebrew-core.git&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># 配置brew-bottle国内镜像源</span></span><br><span class=\"line\">$ <span class=\"built_in\">export</span> HOMEBREW_API_DOMAIN=<span class=\"string\">&quot;https://mirrors.tuna.tsinghua.edu.cn/homebrew-bottles/api&quot;</span></span><br><span class=\"line\">$ <span class=\"built_in\">export</span> HOMEBREW_BOTTLE_DOMAIN=<span class=\"string\">&quot;https://mirrors.tuna.tsinghua.edu.cn/homebrew-bottles&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># 更新配置</span></span><br><span class=\"line\">$ brew update</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## 配置永久生效，zsh用户</span></span><br><span class=\"line\"><span class=\"comment\"># 配置brew国内镜像源</span></span><br><span class=\"line\">$ <span class=\"built_in\">echo</span> <span class=\"string\">&#x27;export HOMEBREW_BREW_GIT_REMOTE=&quot;https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/brew.git&quot;&#x27;</span> &gt;&gt; ~/.zshrc</span><br><span class=\"line\"><span class=\"comment\"># 配置brew-core国内镜像源</span></span><br><span class=\"line\">$ <span class=\"built_in\">echo</span> <span class=\"string\">&#x27;export HOMEBREW_CORE_GIT_REMOTE=&quot;https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/homebrew-core.git&quot;&#x27;</span> &gt;&gt; ~/.zshrc</span><br><span class=\"line\"><span class=\"comment\"># 配置brew-bottle国内镜像源</span></span><br><span class=\"line\">$ <span class=\"built_in\">echo</span> <span class=\"string\">&#x27;export HOMEBREW_API_DOMAIN=&quot;https://mirrors.tuna.tsinghua.edu.cn/homebrew-bottles/api&quot;&#x27;</span> &gt;&gt; ~/.zshrc</span><br><span class=\"line\">$ <span class=\"built_in\">echo</span> <span class=\"string\">&#x27;export HOMEBREW_BOTTLE_DOMAIN=&quot;https://mirrors.tuna.tsinghua.edu.cn/homebrew-bottles&quot;&#x27;</span> &gt;&gt; ~/.zshrc</span><br><span class=\"line\">$ <span class=\"built_in\">source</span> ~/.zshrc</span><br><span class=\"line\"><span class=\"comment\"># 更新配置</span></span><br><span class=\"line\">$ brew update</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 此时查看brew配置信息，可以看到已经生效了</span></span><br><span class=\"line\">$ brew config</span><br><span class=\"line\">HOMEBREW_VERSION: 4.4.8-38-g6089077</span><br><span class=\"line\">ORIGIN: https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/brew.git</span><br><span class=\"line\">HEAD: 60890774e0a70fe93f94973b080068cf7b0d1c93</span><br><span class=\"line\">Last commit: 9 hours ago</span><br><span class=\"line\">Branch: master</span><br><span class=\"line\">Core tap origin: https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/homebrew-core.git</span><br><span class=\"line\">Core tap HEAD: 787d1587bfa92794f7d141063a31773064ef9107</span><br><span class=\"line\">Core tap last commit: 11 minutes ago</span><br><span class=\"line\">Core tap JSON: 29 Nov 09:56 UTC</span><br><span class=\"line\">Core cask tap HEAD: 4c34bd8c418e13160fc79f1ca9312555d2edc254</span><br><span class=\"line\">Core cask tap last commit: 19 minutes ago</span><br><span class=\"line\">Core cask tap JSON: 29 Nov 09:56 UTC</span><br><span class=\"line\">HOMEBREW_PREFIX: /usr/local</span><br><span class=\"line\">HOMEBREW_API_DOMAIN: https://mirrors.tuna.tsinghua.edu.cn/homebrew-bottles/api</span><br><span class=\"line\">HOMEBREW_BOTTLE_DOMAIN: https://mirrors.tuna.tsinghua.edu.cn/homebrew-bottles</span><br><span class=\"line\">HOMEBREW_BREW_GIT_REMOTE: https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/brew.git</span><br><span class=\"line\">HOMEBREW_CASK_OPTS: []</span><br><span class=\"line\">HOMEBREW_CORE_GIT_REMOTE: https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/homebrew-core.git</span><br><span class=\"line\">HOMEBREW_GITHUB_API_TOKEN: <span class=\"built_in\">set</span></span><br><span class=\"line\">HOMEBREW_MAKE_JOBS: 12</span><br><span class=\"line\">HOMEBREW_SORBET_RUNTIME: <span class=\"built_in\">set</span></span><br><span class=\"line\">Homebrew Ruby: 3.3.6 =&gt; /usr/local/Homebrew/Library/Homebrew/vendor/portable-ruby/3.3.6/bin/ruby</span><br><span class=\"line\">CPU: dodeca-core 64-bit kabylake</span><br><span class=\"line\">Clang: 15.0.0 build 1500</span><br><span class=\"line\">Git: 2.43.0 =&gt; /usr/local/bin/git</span><br><span class=\"line\">Curl: 8.7.1 =&gt; /usr/bin/curl</span><br><span class=\"line\">macOS: 13.7.1-x86_64</span><br><span class=\"line\">CLT: 15.0.0.0.1.1694021235</span><br><span class=\"line\">Xcode: N/A</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 通过brew升级fd，可以看到使用了清华源</span></span><br><span class=\"line\">$ brew upgrade fd</span><br><span class=\"line\">==&gt; Upgrading 1 outdated package:</span><br><span class=\"line\">fd 8.2.1 -&gt; 10.2.0</span><br><span class=\"line\">==&gt; Fetching fd</span><br><span class=\"line\">==&gt; Downloading https://mirrors.tuna.tsinghua.edu.cn/homebrew-bottles/fd-10.2.0.ventura.bottle.tar.gz</span><br><span class=\"line\"><span class=\"comment\">################################################################################################################################################################################### 100.0%</span></span><br><span class=\"line\">==&gt; Verifying attestation <span class=\"keyword\">for</span> fd</span><br><span class=\"line\">==&gt; Upgrading fd</span><br><span class=\"line\">  8.2.1 -&gt; 10.2.0</span><br><span class=\"line\">==&gt; Pouring fd-10.2.0.ventura.bottle.tar.gz</span><br><span class=\"line\">==&gt; Caveats</span><br><span class=\"line\">zsh completions have been installed to:</span><br><span class=\"line\">  /usr/local/share/zsh/site-functions</span><br><span class=\"line\">==&gt; Summary</span><br><span class=\"line\">🍺  /usr/local/Cellar/fd/10.2.0: 14 files, 2.9MB</span><br><span class=\"line\">==&gt; Running `brew cleanup fd`...</span><br><span class=\"line\">Disable this behaviour by setting HOMEBREW_NO_INSTALL_CLEANUP.</span><br><span class=\"line\">Hide these hints with HOMEBREW_NO_ENV_HINTS (see `man brew`).</span><br><span class=\"line\">Removing: /usr/local/Cellar/fd/8.2.1... (13 files, 2.4MB)</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>恢复为默认的GitHub镜像源</p>\n</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ <span class=\"built_in\">unset</span> HOMEBREW_BREW_GIT_REMOTE</span><br><span class=\"line\">$ <span class=\"built_in\">unset</span> HOMEBREW_CORE_GIT_REMOTE</span><br><span class=\"line\">$ <span class=\"built_in\">unset</span> HOMEBREW_API_DOMAIN</span><br><span class=\"line\">$ <span class=\"built_in\">unset</span> HOMEBREW_BOTTLE_DOMAIN</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 如果您之前永久配置了 HOMEBREW 环境变量，还需要在对应的 ~/.bash_profile 或者 ~/.zshrc 配置文件中，将对应的 HOMEBREW 环境变量配置行删除</span></span><br><span class=\"line\">$ <span class=\"built_in\">source</span> ~/.zshrc</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 更新brew</span></span><br><span class=\"line\">$ git -C <span class=\"string\">&quot;<span class=\"subst\">$(brew --repo)</span>&quot;</span> remote set-url origin https://github.com/Homebrew/brew</span><br><span class=\"line\"><span class=\"comment\"># 更新brew-core，brew4.0后不会再下载brew-core，所以可以忽略</span></span><br><span class=\"line\"><span class=\"comment\"># 不过从低版本升级上来的还会有这个仓库，可以通过 brew tap 查看是否存在，实际上改不改都不会有影响，看着不舒服就修改吧</span></span><br><span class=\"line\">$ git -C <span class=\"string\">&quot;<span class=\"subst\">$(brew --repo homebrew/core)</span>&quot;</span> remote set-url origin https://github.com/Homebrew/homebrew-core</span><br><span class=\"line\">$ brew update</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看brew配置信息</span></span><br><span class=\"line\">$ brew config</span><br><span class=\"line\">HOMEBREW_VERSION: 4.4.8-38-g6089077</span><br><span class=\"line\">ORIGIN: https://github.com/Homebrew/brew</span><br><span class=\"line\">HEAD: 60890774e0a70fe93f94973b080068cf7b0d1c93</span><br><span class=\"line\">Last commit: 9 hours ago</span><br><span class=\"line\">Branch: master</span><br><span class=\"line\">Core tap HEAD: 787d1587bfa92794f7d141063a31773064ef9107</span><br><span class=\"line\">Core tap last commit: 13 minutes ago</span><br><span class=\"line\">Core tap JSON: 29 Nov 10:09 UTC</span><br><span class=\"line\">Core cask tap HEAD: 871fe2e8b93aac896a1808571ff11f8b89e6d90e</span><br><span class=\"line\">Core cask tap last commit: 48 seconds ago</span><br><span class=\"line\">Core cask tap JSON: 29 Nov 10:09 UTC</span><br><span class=\"line\">HOMEBREW_PREFIX: /usr/local</span><br><span class=\"line\">HOMEBREW_CASK_OPTS: []</span><br><span class=\"line\">HOMEBREW_GITHUB_API_TOKEN: <span class=\"built_in\">set</span></span><br><span class=\"line\">HOMEBREW_MAKE_JOBS: 12</span><br><span class=\"line\">HOMEBREW_SORBET_RUNTIME: <span class=\"built_in\">set</span></span><br><span class=\"line\">Homebrew Ruby: 3.3.6 =&gt; /usr/local/Homebrew/Library/Homebrew/vendor/portable-ruby/3.3.6/bin/ruby</span><br><span class=\"line\">CPU: dodeca-core 64-bit kabylake</span><br><span class=\"line\">Clang: 15.0.0 build 1500</span><br><span class=\"line\">Git: 2.43.0 =&gt; /usr/local/bin/git</span><br><span class=\"line\">Curl: 8.7.1 =&gt; /usr/bin/curl</span><br><span class=\"line\">macOS: 13.7.1-x86_64</span><br><span class=\"line\">CLT: 15.0.0.0.1.1694021235</span><br><span class=\"line\">Xcode: N/A</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 通过brew升级telnet，可以看到使用了GitHub源</span></span><br><span class=\"line\">$ brew upgrade telnet</span><br><span class=\"line\">==&gt; Upgrading 1 outdated package:</span><br><span class=\"line\">telnet 294 -&gt; 303.141.1</span><br><span class=\"line\">==&gt; Downloading https://ghcr.io/v2/homebrew/core/telnet/manifests/303.141.1</span><br><span class=\"line\"><span class=\"comment\">################################################################################################################################################################################### 100.0%</span></span><br><span class=\"line\">==&gt; Fetching telnet</span><br><span class=\"line\">==&gt; Downloading https://ghcr.io/v2/homebrew/core/telnet/blobs/sha256:1be6b7b6a17a311fb3a2f1bffe7dae52284f3239b8af03f651c4fac11362f702</span><br><span class=\"line\"><span class=\"comment\">################################################################################################################################################################################### 100.0%</span></span><br><span class=\"line\">==&gt; Verifying attestation <span class=\"keyword\">for</span> telnet</span><br><span class=\"line\">==&gt; Upgrading telnet</span><br><span class=\"line\">  294 -&gt; 303.141.1</span><br><span class=\"line\">==&gt; Pouring telnet--303.141.1.ventura.bottle.tar.gz</span><br><span class=\"line\">🍺  /usr/local/Cellar/telnet/303.141.1: 5 files, 207.5KB</span><br><span class=\"line\">==&gt; Running `brew cleanup telnet`...</span><br><span class=\"line\">Disable this behaviour by setting HOMEBREW_NO_INSTALL_CLEANUP.</span><br><span class=\"line\">Hide these hints with HOMEBREW_NO_ENV_HINTS (see `man brew`).</span><br><span class=\"line\">Removing: /usr/local/Cellar/telnet/294... (4 files, 208.2KB)</span><br></pre></td></tr></table></figure>\n<h2 id=\"重要的说明\">重要的说明</h2>\n<h3 id=\"环境变量\">环境变量</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>brew安装的软件包会被软连接到<code>/usr/local/bin/</code>下，所以需要将该路径加入系统环境PATH中</p>\n</li>\n<li class=\"lvl-2\">\n<p>这里要注意一点，如果该路径在PATH中声明的比较靠前，就可能会被优先使用，比如我们已经手工在系统中安装了<code>python</code>的某个版本，但通过brew安装某些软件包时因为其依赖python，就会通过brew同时安装对应的python版本，此时我们在使用python命令时，就会优先使用这个</p>\n</li>\n<li class=\"lvl-2\">\n<p>有两种方法可以解决，1是通过<code>brew unlink python</code>来解除链接，此时并不是删除，而只是解除了软链，不会影响依赖它的工具的使用，如果需要恢复链接，可以通过<code>brew link python</code>来恢复链接；2是将我们的系统中自己安装的一些工具的路径声明在<code>/usr/local/bin/</code>之前，这样就不会有影响了。</p>\n</li>\n</ul>\n<h3 id=\"Homebrew-4-0-带来的新变化\">Homebrew 4.0 带来的新变化</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Homebrew 4.0 进行了一项最大的改动，组织方式从Git仓库管理改为<a href=\"https://formulae.brew.sh/api/formula.jws.json\">JSON文件</a>下载。</p>\n</li>\n<li class=\"lvl-2\">\n<p>JSON文件会从<a href=\"https://formulae.brew.sh\">formulae.brew.sh</a>下载，而不再使用<code>homebrew/core</code>、<code>homebrew/cask</code>两个仓库，所以升级到4.0后，本地的<code>homebrew/core</code>、<code>homebrew/cask</code> 仓库都可以删除以释放磁盘空间。</p>\n</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看本地仓库</span></span><br><span class=\"line\">$ brew tap</span><br><span class=\"line\">homebrew/cask <span class=\"comment\"># cask 仓库，GUI的工具会从此下载，brew4.0后不再使用</span></span><br><span class=\"line\">homebrew/core <span class=\"comment\"># core 仓库，即 formula 仓库，命令行工具会从此下载，brew4.0后不再使用</span></span><br><span class=\"line\">homebrew/services <span class=\"comment\"># services 仓库，services 工具本身会从此下载，brew4.0后依旧使用</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 删除本地仓库</span></span><br><span class=\"line\">$ brew untap homebrew/core</span><br><span class=\"line\">$ brew untap homebrew/cask</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 此时再次执行 brew outdated 等命令时，会看到json文件被下载了，默认情况下，该json文件间隔24小时更新一次</span></span><br><span class=\"line\">$ brew outdated</span><br><span class=\"line\">==&gt; Downloading https://formulae.brew.sh/api/formula.jws.json</span><br><span class=\"line\"><span class=\"comment\">##################################################################################### 100.0%</span></span><br><span class=\"line\">==&gt; Downloading https://formulae.brew.sh/api/cask.jws.json</span><br><span class=\"line\"><span class=\"comment\">##################################################################################### 100.0%</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>如果还想使用旧的仓库模式，只要配置下环境变量</p>\n</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&#x27;export HOMEBREW_NO_INSTALL_FROM_API=1&#x27;</span> &gt;&gt; ~/.zshrc</span><br></pre></td></tr></table></figure>\n<h3 id=\"从镜像源的切换来理解brew下载安装包的过程\">从镜像源的切换来理解brew下载安装包的过程</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>前面我们介绍过，切换镜像源时要设置4个环境变量，那么为什么要设置这几个变量呢？它们的作用是什么呢，下面我就一个一个说明：</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-4\">\n<p>HOMEBREW_BREW_GIT_REMOTE</p>\n<ul class=\"lvl-4\">\n<li class=\"lvl-6\">设置brew仓库，用于更新brew命令本身，这个比较容易理解</li>\n</ul>\n</li>\n<li class=\"lvl-4\">\n<p>HOMEBREW_CORE_GIT_REMOTE</p>\n<ul class=\"lvl-4\">\n<li class=\"lvl-6\">设置core仓库，用于更新formula的安装脚本</li>\n<li class=\"lvl-6\">当通过<code>brew info xxx</code>查看安装包信息时，可以看到<code>From</code>信息，这个就是命令的安装脚本，比如下面的<code>fd.rb</code></li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ brew info fd</span><br><span class=\"line\">==&gt; fd: stable 10.2.0 (bottled), HEAD</span><br><span class=\"line\">Simple, fast and user-friendly alternative to find</span><br><span class=\"line\">https://github.com/sharkdp/fd</span><br><span class=\"line\">Conflicts with:</span><br><span class=\"line\">  fdclone (because both install `fd` binaries)</span><br><span class=\"line\">Installed</span><br><span class=\"line\">/usr/local/Cellar/fd/10.2.0 (14 files, 2.9MB) *</span><br><span class=\"line\">  Poured from bottle using the formulae.brew.sh API on 2024-11-29 at 18:02:16</span><br><span class=\"line\">From: https://github.com/Homebrew/homebrew-core/blob/HEAD/Formula/f/fd.rb</span><br><span class=\"line\">License: Apache-2.0 OR MIT</span><br><span class=\"line\">==&gt; Dependencies</span><br><span class=\"line\">Build: rust ✘</span><br><span class=\"line\">==&gt; Options</span><br><span class=\"line\">--HEAD</span><br><span class=\"line\">  Install HEAD version</span><br><span class=\"line\">==&gt; Caveats</span><br><span class=\"line\">zsh completions have been installed to:</span><br><span class=\"line\">  /usr/local/share/zsh/site-functions</span><br><span class=\"line\">==&gt; Analytics</span><br><span class=\"line\">install: 6,327 (30 days), 24,518 (90 days), 116,476 (365 days)</span><br><span class=\"line\">install-on-request: 6,326 (30 days), 24,515 (90 days), 116,363 (365 days)</span><br><span class=\"line\">build-error: 0 (30 days)</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-4\">\n<li class=\"lvl-6\">这个安装脚本中包含<code>bottle do</code>部分，其作用是当安装脚本时，优先从该部分获取对应的操作系统的二进制预编译包的sha256校验值，如果从对应的二进制源中找到，则直接从二进制预编译包的地址进行下载，该预编译下载地址由<code>HOMEBREW_BOTTLE_DOMAIN</code>指定，默认从官方源下载。</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">class Fd &lt; Formula</span><br><span class=\"line\">  desc <span class=\"string\">&quot;Simple, fast and user-friendly alternative to find&quot;</span></span><br><span class=\"line\">  homepage <span class=\"string\">&quot;https://github.com/sharkdp/fd&quot;</span></span><br><span class=\"line\">  url <span class=\"string\">&quot;https://github.com/sharkdp/fd/archive/refs/tags/v10.2.0.tar.gz&quot;</span></span><br><span class=\"line\">  sha256 <span class=\"string\">&quot;73329fe24c53f0ca47cd0939256ca5c4644742cb7c14cf4114c8c9871336d342&quot;</span></span><br><span class=\"line\">  license any_of: [<span class=\"string\">&quot;Apache-2.0&quot;</span>, <span class=\"string\">&quot;MIT&quot;</span>]</span><br><span class=\"line\">  <span class=\"built_in\">head</span> <span class=\"string\">&quot;https://github.com/sharkdp/fd.git&quot;</span>, branch: <span class=\"string\">&quot;master&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  bottle <span class=\"keyword\">do</span></span><br><span class=\"line\">    sha256 cellar: :any_skip_relocation, arm64_sequoia:  <span class=\"string\">&quot;9d17cfb029fbdc6ed31c732108f7aa746d3082dd4783ed35471ef79340615509&quot;</span></span><br><span class=\"line\">    sha256 cellar: :any_skip_relocation, arm64_sonoma:   <span class=\"string\">&quot;82d5c2ffc2e2d0d8643a7c3f620c81ed49d7b23920aa23b6a7f4c50be69abc0b&quot;</span></span><br><span class=\"line\">    sha256 cellar: :any_skip_relocation, arm64_ventura:  <span class=\"string\">&quot;354412ababb7d6c52abd9153ff96f133391406ce292b2122c76b96c2ab714f87&quot;</span></span><br><span class=\"line\">    sha256 cellar: :any_skip_relocation, arm64_monterey: <span class=\"string\">&quot;0b41f292041767fd1c3c5b92daaa6c823fb07c1d7cd11b0427a415f08463f035&quot;</span></span><br><span class=\"line\">    sha256 cellar: :any_skip_relocation, sonoma:         <span class=\"string\">&quot;4fa0fb4b3f512e45d35c569953efc7c59ebd8976caac9b2c1b1394b7e29157a0&quot;</span></span><br><span class=\"line\">    sha256 cellar: :any_skip_relocation, ventura:        <span class=\"string\">&quot;b1406e5414252b1e1b90cfad188454eb31058256ed6246baed48c4e1cfe593a1&quot;</span></span><br><span class=\"line\">    sha256 cellar: :any_skip_relocation, monterey:       <span class=\"string\">&quot;0ac060bf7d1529aa1f65e634f64b98b906df533d71f2185c883165c01f59ad53&quot;</span></span><br><span class=\"line\">    sha256 cellar: :any_skip_relocation, x86_64_linux:   <span class=\"string\">&quot;2464fb21cc981166ffa9783fa14a09265790af4d89ce3a763421ddaf29119541&quot;</span></span><br><span class=\"line\">  end</span><br><span class=\"line\"></span><br><span class=\"line\">  depends_on <span class=\"string\">&quot;rust&quot;</span> =&gt; :build</span><br><span class=\"line\"></span><br><span class=\"line\">  conflicts_with <span class=\"string\">&quot;fdclone&quot;</span>, because: <span class=\"string\">&quot;both install `fd` binaries&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  def install</span><br><span class=\"line\">    system <span class=\"string\">&quot;cargo&quot;</span>, <span class=\"string\">&quot;install&quot;</span>, *std_cargo_args</span><br><span class=\"line\">    man1.install <span class=\"string\">&quot;doc/fd.1&quot;</span></span><br><span class=\"line\">    generate_completions_from_executable(bin/<span class=\"string\">&quot;fd&quot;</span>, <span class=\"string\">&quot;--gen-completions&quot;</span>, shells: [:bash, :fish])</span><br><span class=\"line\">    zsh_completion.install <span class=\"string\">&quot;contrib/completion/_fd&quot;</span></span><br><span class=\"line\">    <span class=\"comment\"># Bash completions are not compatible with Bash 3 so don&#x27;t use v1 directory.</span></span><br><span class=\"line\">    <span class=\"comment\"># bash: complete: nosort: invalid option name</span></span><br><span class=\"line\">    <span class=\"comment\"># Issue ref: https://github.com/clap-rs/clap/issues/5190</span></span><br><span class=\"line\">    (share/<span class=\"string\">&quot;bash-completion/completions&quot;</span>).install bash_completion.children</span><br><span class=\"line\">  end</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">test</span> <span class=\"keyword\">do</span></span><br><span class=\"line\">    <span class=\"built_in\">touch</span> <span class=\"string\">&quot;foo_file&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">touch</span> <span class=\"string\">&quot;test_file&quot;</span></span><br><span class=\"line\">    assert_equal <span class=\"string\">&quot;test_file&quot;</span>, shell_output(<span class=\"string\">&quot;#&#123;bin&#125;/fd test&quot;</span>).chomp</span><br><span class=\"line\">  end</span><br><span class=\"line\">end</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-4\">\n<li class=\"lvl-6\">注意，brew4.0后不再使用从该git仓库中获取安装脚本，因为formula的安装源代码已经全部存储在json文件中(见<code>HOMEBREW_API_DOMAIN</code>说明)，不再需要通过Git仓库下载</li>\n<li class=\"lvl-6\">切换镜像源时，brew4.0后不需要设置该环境变量</li>\n</ul>\n</li>\n<li class=\"lvl-4\">\n<p>HOMEBREW_API_DOMAIN</p>\n<ul class=\"lvl-4\">\n<li class=\"lvl-6\">设置<code>formula\\cask</code>的安装脚本下载源，默认<a href=\"https://formulae.brew.sh\">https://formulae.brew.sh</a></li>\n<li class=\"lvl-6\">brew4.0后不再从git仓库获取安装脚本，而是从这个json文件中一次性获取所有工具的安装脚本，默认24小时更新一次</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">官方源：</span><br><span class=\"line\">  formula源：https://formulae.brew.sh/api/formula.jws.json</span><br><span class=\"line\">  cask源：https://formulae.brew.sh/api/cask.jws.json</span><br><span class=\"line\"></span><br><span class=\"line\">清华源：</span><br><span class=\"line\">  formula源：https://mirrors.tuna.tsinghua.edu.cn/homebrew-bottles/api/formula.jws.json</span><br><span class=\"line\">  cask源：https://mirrors.tuna.tsinghua.edu.cn/homebrew-bottles/api/cask.jws.json</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-4\">\n<li class=\"lvl-6\">如果还想使用旧的仓库模式，只要配置下环境变量，这样即使你升级后已经删除了对应的仓库，它也会在第一次使用到时自动下载</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 官方也提到，非开发人员没必要这样做</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&#x27;export HOMEBREW_NO_INSTALL_FROM_API=1&#x27;</span> &gt;&gt; ~/.zshrc</span><br></pre></td></tr></table></figure>\n</li>\n<li class=\"lvl-4\">\n<p>HOMEBREW_BOTTLE_DOMAIN</p>\n<ul class=\"lvl-4\">\n<li class=\"lvl-6\">指定预编译二进制包（也称为 bottles）的下载地址，Homebrew 使用这些 bottles 来加速软件安装过程，避免在每个用户的计算机上都重新从源代码构建软件。</li>\n<li class=\"lvl-6\">当我们通过<code>brew install xxx</code>安装软件时，brew会先从该formula的安装脚本（4.0以前从HOMEBREW_CORE_GIT_REMOTE指定的git仓库获取，4.0以后从HOMEBREW_API_DOMAIN指定的json文件中获取）中获取该软件的安装信息，然后根据安装信息从bottle中下载对应的预编译二进制包，再将其安装到本地。</li>\n<li class=\"lvl-6\">下载后的二进制包会被保存到缓存目录中(<code>brew --cache</code>)，安装后的软件包存储到Cellar目录中(<code>brew --cellar</code>)</li>\n</ul>\n</li>\n</ul>\n</li>\n<li class=\"lvl-2\">\n<p>通过上面的分析，我们可以得出结论，切换镜像源时，实际上只需要设置3个变量就够了</p>\n</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">HOMEBREW_BREW_GIT_REMOTE</span><br><span class=\"line\">HOMEBREW_API_DOMAIN</span><br><span class=\"line\">HOMEBREW_BOTTLE_DOMAIN</span><br></pre></td></tr></table></figure>\n","content_text":"摘要 brew是一个软件包管理器，同时支持MacOS和Linux，可以很方便地安装各种软件，比如git、node、python等。 brew虽然支持linux，但是实际使用中很少会使用brew来管理linux的软件包。 本文介绍如何在macos下安装brew，以及如何使用brew管理各种软件包。 本文基于 MacOS Intel Ventura 13.7.1，brew 版本为4.4.8。 安装 首先要确保系统中安装了 git 和 curl，对于 macOS 用户来说，这些系统都自带了，唯一需额外要求安装的是Command Line Tools (CLT) for Xcode。 12345678# 检查系统中是否安装了 Command Line Tools (CLT) for Xcodexcode-select --version # 能够输出版本号说明安装了，否则需要安装。# 安装 Command Line Tools (CLT) for Xcodexcode-select --install# 打印当前的 Command Line Tools (CLT) for Xcode 的安装路径xcode-select -p # /Library/Developer/CommandLineTools 在MacOS上安装brew的方法 参考资料 方法一：使用脚本安装 1/bin/bash -c &quot;$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)&quot; 安装时可以指定镜像下载源，默认是Homebrew的GitHub下载源，也可以选择国内的镜像源，比如使用清华大学的Homebrew镜像源 1234567# 控制了 Homebrew 在安装软件包时是否从 Homebrew 的 API 服务器获取信息，brew4.0后是默认行为，无需设置export HOMEBREW_INSTALL_FROM_API=1# 设置brew仓库上游export HOMEBREW_BREW_GIT_REMOTE=&quot;https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/brew.git&quot;# 设置homebrew核心上游export HOMEBREW_CORE_GIT_REMOTE=&quot;https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/homebrew-core.git&quot;/bin/bash -c &quot;$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)&quot; 方法二：使用PKG文件安装 从Homebrew的github上下载最新版的Homebrew-x.x.x.pkg 方法三：国内无法访问github地址时可以使用国内镜像源 这里依旧以清华大学的Homebrew镜像源为例 123456export HOMEBREW_BREW_GIT_REMOTE=&quot;https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/brew.git&quot;export HOMEBREW_CORE_GIT_REMOTE=&quot;https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/homebrew-core.git&quot;# 从镜像下载安装脚本并安装 Homebrew / Linuxbrewgit clone --depth=1 https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/install.git brew-install/bin/bash brew-install/install.shrm -rf brew-install 验证是否安装成功 brew 命令本身及通过brew安装的所有命令都会被软链接到/usr/local/bin/下，所以需要将该路径加入系统环境PATH中 重启终端，然后执行brew -v命令查看brew的版本，如果安装成功，会输出类似如下内容 12$ brew -vHomebrew 4.4.8-40-g13c3def Homebrew本身的安装位置可以通过brew --repo查看，默认为/usr/local/Homebrew 通过brew安装的软件包默认会被安装到/usr/local/Cellar/下，比如git安装后会在/usr/local/Cellar/git/目录下，可以通过brew info git查看安装信息，包括依赖库等。 12345678910111213141516171819# 显示 Homebrew 安装路径，macOS ARM: /opt/homebrew，macOS Intel: /usr/local$ brew --prefix/usr/local# 显示 Homebrew 本地的 Git 仓库$ brew --repo/usr/local/Homebrew# 显示 Homebrew Cellar 路径，命令行工具的安装路径$ brew --cellar/usr/local/Cellar# 显示 Homebrew Caskroom 路径，GUI工具的安装路径$ brew --caskroom/usr/local/Caskroom# 缓存路径，下载安装包的缓存路径，通过 brew cleanup 清理$ brew --cache~/Library/Caches/Homebrew 配置命令补全 参考官网Homebrew Documentation–brew Shell Completion 我这里使用的是zsh，在~/.zshrc中加入如下内容并重启终端即可生效 12autoload -Uz compinitcompinit 卸载brew 1/bin/bash -c &quot;$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/uninstall.sh)&quot; 常用命令 brew支持安装命令行工具(formula)和GUI工具(cask) brew install xxx 安装命令行工具，这个最为常用，比如 brew install fd brew install --cask xxx 安装GUI工具，一般很少使用brew安装GUI工具，比如 brew install --cask firefox brew的命令和参数非常多，但日常使用只需要记住常用的几个就够了，详细的命令列表可以参考Homebrew Documentation 1234# 查看brew支持哪些命令brew commands# 查看命令的帮助信息，比如brew install --help 一些常用的命令 12345678brew update # 更新brew到最新版本brew --version # 查看brew的版本，可以简写为 brew -vbrew config # 查看brew的配置信息，这个命令很有用，可以查看到与brew相关的环境变量的值brew home # 浏览器打开brew官网brew home xxx # 浏览器打开xxx官网 如：打开fd命令的官网 brew home fd ,具体的名称可以通过brew list查看brew cleanup # 清理缓存及日志文件，建议定期清理，当运行brew时会自动清理（2.0以后的版本）brew cleanup -n # 显示将要清理的缓存及日志文件，只查看不删除brew doctor # 检查是否有依赖问题，比如没有安装依赖库，或者依赖库版本过低，当运行brew报错时可以通过该命令进行检查并根据提示进行修改 查看已安装的包 1234# 查看brew list # 查看已安装的包brew list --versions # 查看已安装的包及版本brew info xxx # 查看xxx的安装信息 安装、卸载 12345678# 查找、安装、卸载brew search xxx # 查找软件包，也可以通过 https://formulae.brew.sh 网页进行搜索brew install xxx # 安装软件包，此命令相当于加上了 --formula ，安装时会自动下载依赖库，比如安装`nginx`时，会自动下载`openssl@3`和`pcre2`等brew install --cask xxx # 安装GUI工具，比如`firefox`brew uninstall xxx # 卸载软件包，此命令相当于加上了 --formula ，只会卸载当前包，不会卸载依赖库，这样就有可能存在很多冗余包brew uninstall --cask xxx # 卸载GUI工具brew autoremove # 删除所有仅作为另一个软件包的依赖项安装并且现在不再需要的包brew autoremove --dry-run # --dry-run 仅查看哪些包可以删除，并不会真的删除 升级 1234# 升级brew outdated # 查看需要升级的包brew upgrade xxx # 升级xxx到最新版brew upgrade # 更新全部命令到最新版 依赖关系 12345678# 依赖关系brew deps --tree xxx # 树形显示包的依赖树brew deps --installed --tree # 树形显示所有安装包的依赖关系brew deps --installed xxx # 显示当前安装包的依赖关系，纵向展示brew deps --installed --for-each xxx # 显示当前安装包的依赖关系，横向展示brew uses --installed xxx # 查看已经安装的哪些工具依赖当前包brew leaves # 查看顶级安装包，即你通过brew直接安装的包，而不是通过安装其他软件包间接安装的brew leaves | xargs brew deps --installed --for-each --formula # 查看顶级包，并列出每个顶级包的已安装依赖 仓库管理，参考资料Homebrew Documentation–Taps 1234567891011# 仓库管理brew tap # 查看所有已安装的仓库，tap安装路径 /usr/local/Homebrew/Library/Taps/brew tap user/repo # 添加一个仓库，从gitthub下载brew tap repo_url # 添加一个仓库，从给定的仓库地址下载brew untap user/repo # 删除一个仓库# 从第三方仓库安装工具，此时会自动将 homebrew-ffmpeg/ffmpeg 这个仓库添加到本地brew install homebrew-ffmpeg/ffmpeg/ffmpeg# 更新仓库，无论是brew自己的仓库还是第三方仓库，都会自动更新brew update brew services: brew的服务管理工具，可以方便的管理通过brew安装的服务，包括启动、停止、重启服务，等等，比如nginx、redis、mysql等，具体命令可以参考Homebrew Documentation 12345678910# 第一次执行 services 相关的命令时会自动下载 homebrew/services，也可以 通过 brew tap homebrew/services 提前下载brew services list # 查看已安装的所有服务brew services start nginx # 启动服务，并注册到系统启动服务列表，即创建系统自启动文件： ~/Library/LaunchAgents/homebrew.mxcl.nginx.plistbrew services stop nginx # 停止服务，并从系统启动服务列表中移除，即删除系统自启动文件brew services kill nginx # 立即杀死服务，但不从系统启动服务列表中移除brew services restart nginx # 重启服务brew services info nginx # 查看服务的状态和进程IPbrew services run nginx # 运行服务，但不会保存到服务列表中brew services cleanup # 清理无效的服务，即已卸载应用的无用的配置brew services --help # 查看帮助 配置国内镜像源 上面安装部分介绍了如何在安装brew时就指定镜像源，但有些时候因为我们在安装时忘记配置，或者原来的镜像源已经失效需要重新配置，此时可以按照下面的方法进行配置。 此处以配置清华镜像源为例，阿里镜像源请参考阿里的官网文档–Homebrew镜像，科大源参考Homebrew 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475## 临时替换# 配置brew国内镜像源$ export HOMEBREW_BREW_GIT_REMOTE=&quot;https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/brew.git&quot;# 配置brew-core国内镜像源$ export HOMEBREW_CORE_GIT_REMOTE=&quot;https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/homebrew-core.git&quot;# 配置brew-bottle国内镜像源$ export HOMEBREW_API_DOMAIN=&quot;https://mirrors.tuna.tsinghua.edu.cn/homebrew-bottles/api&quot;$ export HOMEBREW_BOTTLE_DOMAIN=&quot;https://mirrors.tuna.tsinghua.edu.cn/homebrew-bottles&quot;# 更新配置$ brew update## 配置永久生效，zsh用户# 配置brew国内镜像源$ echo &#x27;export HOMEBREW_BREW_GIT_REMOTE=&quot;https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/brew.git&quot;&#x27; &gt;&gt; ~/.zshrc# 配置brew-core国内镜像源$ echo &#x27;export HOMEBREW_CORE_GIT_REMOTE=&quot;https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/homebrew-core.git&quot;&#x27; &gt;&gt; ~/.zshrc# 配置brew-bottle国内镜像源$ echo &#x27;export HOMEBREW_API_DOMAIN=&quot;https://mirrors.tuna.tsinghua.edu.cn/homebrew-bottles/api&quot;&#x27; &gt;&gt; ~/.zshrc$ echo &#x27;export HOMEBREW_BOTTLE_DOMAIN=&quot;https://mirrors.tuna.tsinghua.edu.cn/homebrew-bottles&quot;&#x27; &gt;&gt; ~/.zshrc$ source ~/.zshrc# 更新配置$ brew update# 此时查看brew配置信息，可以看到已经生效了$ brew configHOMEBREW_VERSION: 4.4.8-38-g6089077ORIGIN: https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/brew.gitHEAD: 60890774e0a70fe93f94973b080068cf7b0d1c93Last commit: 9 hours agoBranch: masterCore tap origin: https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/homebrew-core.gitCore tap HEAD: 787d1587bfa92794f7d141063a31773064ef9107Core tap last commit: 11 minutes agoCore tap JSON: 29 Nov 09:56 UTCCore cask tap HEAD: 4c34bd8c418e13160fc79f1ca9312555d2edc254Core cask tap last commit: 19 minutes agoCore cask tap JSON: 29 Nov 09:56 UTCHOMEBREW_PREFIX: /usr/localHOMEBREW_API_DOMAIN: https://mirrors.tuna.tsinghua.edu.cn/homebrew-bottles/apiHOMEBREW_BOTTLE_DOMAIN: https://mirrors.tuna.tsinghua.edu.cn/homebrew-bottlesHOMEBREW_BREW_GIT_REMOTE: https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/brew.gitHOMEBREW_CASK_OPTS: []HOMEBREW_CORE_GIT_REMOTE: https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/homebrew-core.gitHOMEBREW_GITHUB_API_TOKEN: setHOMEBREW_MAKE_JOBS: 12HOMEBREW_SORBET_RUNTIME: setHomebrew Ruby: 3.3.6 =&gt; /usr/local/Homebrew/Library/Homebrew/vendor/portable-ruby/3.3.6/bin/rubyCPU: dodeca-core 64-bit kabylakeClang: 15.0.0 build 1500Git: 2.43.0 =&gt; /usr/local/bin/gitCurl: 8.7.1 =&gt; /usr/bin/curlmacOS: 13.7.1-x86_64CLT: 15.0.0.0.1.1694021235Xcode: N/A# 通过brew升级fd，可以看到使用了清华源$ brew upgrade fd==&gt; Upgrading 1 outdated package:fd 8.2.1 -&gt; 10.2.0==&gt; Fetching fd==&gt; Downloading https://mirrors.tuna.tsinghua.edu.cn/homebrew-bottles/fd-10.2.0.ventura.bottle.tar.gz################################################################################################################################################################################### 100.0%==&gt; Verifying attestation for fd==&gt; Upgrading fd 8.2.1 -&gt; 10.2.0==&gt; Pouring fd-10.2.0.ventura.bottle.tar.gz==&gt; Caveatszsh completions have been installed to: /usr/local/share/zsh/site-functions==&gt; Summary🍺 /usr/local/Cellar/fd/10.2.0: 14 files, 2.9MB==&gt; Running `brew cleanup fd`...Disable this behaviour by setting HOMEBREW_NO_INSTALL_CLEANUP.Hide these hints with HOMEBREW_NO_ENV_HINTS (see `man brew`).Removing: /usr/local/Cellar/fd/8.2.1... (13 files, 2.4MB) 恢复为默认的GitHub镜像源 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960$ unset HOMEBREW_BREW_GIT_REMOTE$ unset HOMEBREW_CORE_GIT_REMOTE$ unset HOMEBREW_API_DOMAIN$ unset HOMEBREW_BOTTLE_DOMAIN# 如果您之前永久配置了 HOMEBREW 环境变量，还需要在对应的 ~/.bash_profile 或者 ~/.zshrc 配置文件中，将对应的 HOMEBREW 环境变量配置行删除$ source ~/.zshrc# 更新brew$ git -C &quot;$(brew --repo)&quot; remote set-url origin https://github.com/Homebrew/brew# 更新brew-core，brew4.0后不会再下载brew-core，所以可以忽略# 不过从低版本升级上来的还会有这个仓库，可以通过 brew tap 查看是否存在，实际上改不改都不会有影响，看着不舒服就修改吧$ git -C &quot;$(brew --repo homebrew/core)&quot; remote set-url origin https://github.com/Homebrew/homebrew-core$ brew update# 查看brew配置信息$ brew configHOMEBREW_VERSION: 4.4.8-38-g6089077ORIGIN: https://github.com/Homebrew/brewHEAD: 60890774e0a70fe93f94973b080068cf7b0d1c93Last commit: 9 hours agoBranch: masterCore tap HEAD: 787d1587bfa92794f7d141063a31773064ef9107Core tap last commit: 13 minutes agoCore tap JSON: 29 Nov 10:09 UTCCore cask tap HEAD: 871fe2e8b93aac896a1808571ff11f8b89e6d90eCore cask tap last commit: 48 seconds agoCore cask tap JSON: 29 Nov 10:09 UTCHOMEBREW_PREFIX: /usr/localHOMEBREW_CASK_OPTS: []HOMEBREW_GITHUB_API_TOKEN: setHOMEBREW_MAKE_JOBS: 12HOMEBREW_SORBET_RUNTIME: setHomebrew Ruby: 3.3.6 =&gt; /usr/local/Homebrew/Library/Homebrew/vendor/portable-ruby/3.3.6/bin/rubyCPU: dodeca-core 64-bit kabylakeClang: 15.0.0 build 1500Git: 2.43.0 =&gt; /usr/local/bin/gitCurl: 8.7.1 =&gt; /usr/bin/curlmacOS: 13.7.1-x86_64CLT: 15.0.0.0.1.1694021235Xcode: N/A# 通过brew升级telnet，可以看到使用了GitHub源$ brew upgrade telnet==&gt; Upgrading 1 outdated package:telnet 294 -&gt; 303.141.1==&gt; Downloading https://ghcr.io/v2/homebrew/core/telnet/manifests/303.141.1################################################################################################################################################################################### 100.0%==&gt; Fetching telnet==&gt; Downloading https://ghcr.io/v2/homebrew/core/telnet/blobs/sha256:1be6b7b6a17a311fb3a2f1bffe7dae52284f3239b8af03f651c4fac11362f702################################################################################################################################################################################### 100.0%==&gt; Verifying attestation for telnet==&gt; Upgrading telnet 294 -&gt; 303.141.1==&gt; Pouring telnet--303.141.1.ventura.bottle.tar.gz🍺 /usr/local/Cellar/telnet/303.141.1: 5 files, 207.5KB==&gt; Running `brew cleanup telnet`...Disable this behaviour by setting HOMEBREW_NO_INSTALL_CLEANUP.Hide these hints with HOMEBREW_NO_ENV_HINTS (see `man brew`).Removing: /usr/local/Cellar/telnet/294... (4 files, 208.2KB) 重要的说明 环境变量 brew安装的软件包会被软连接到/usr/local/bin/下，所以需要将该路径加入系统环境PATH中 这里要注意一点，如果该路径在PATH中声明的比较靠前，就可能会被优先使用，比如我们已经手工在系统中安装了python的某个版本，但通过brew安装某些软件包时因为其依赖python，就会通过brew同时安装对应的python版本，此时我们在使用python命令时，就会优先使用这个 有两种方法可以解决，1是通过brew unlink python来解除链接，此时并不是删除，而只是解除了软链，不会影响依赖它的工具的使用，如果需要恢复链接，可以通过brew link python来恢复链接；2是将我们的系统中自己安装的一些工具的路径声明在/usr/local/bin/之前，这样就不会有影响了。 Homebrew 4.0 带来的新变化 Homebrew 4.0 进行了一项最大的改动，组织方式从Git仓库管理改为JSON文件下载。 JSON文件会从formulae.brew.sh下载，而不再使用homebrew/core、homebrew/cask两个仓库，所以升级到4.0后，本地的homebrew/core、homebrew/cask 仓库都可以删除以释放磁盘空间。 12345678910111213141516# 查看本地仓库$ brew taphomebrew/cask # cask 仓库，GUI的工具会从此下载，brew4.0后不再使用homebrew/core # core 仓库，即 formula 仓库，命令行工具会从此下载，brew4.0后不再使用homebrew/services # services 仓库，services 工具本身会从此下载，brew4.0后依旧使用# 删除本地仓库$ brew untap homebrew/core$ brew untap homebrew/cask# 此时再次执行 brew outdated 等命令时，会看到json文件被下载了，默认情况下，该json文件间隔24小时更新一次$ brew outdated==&gt; Downloading https://formulae.brew.sh/api/formula.jws.json##################################################################################### 100.0%==&gt; Downloading https://formulae.brew.sh/api/cask.jws.json##################################################################################### 100.0% 如果还想使用旧的仓库模式，只要配置下环境变量 1echo &#x27;export HOMEBREW_NO_INSTALL_FROM_API=1&#x27; &gt;&gt; ~/.zshrc 从镜像源的切换来理解brew下载安装包的过程 前面我们介绍过，切换镜像源时要设置4个环境变量，那么为什么要设置这几个变量呢？它们的作用是什么呢，下面我就一个一个说明： HOMEBREW_BREW_GIT_REMOTE 设置brew仓库，用于更新brew命令本身，这个比较容易理解 HOMEBREW_CORE_GIT_REMOTE 设置core仓库，用于更新formula的安装脚本 当通过brew info xxx查看安装包信息时，可以看到From信息，这个就是命令的安装脚本，比如下面的fd.rb 1234567891011121314151617181920212223$ brew info fd==&gt; fd: stable 10.2.0 (bottled), HEADSimple, fast and user-friendly alternative to findhttps://github.com/sharkdp/fdConflicts with: fdclone (because both install `fd` binaries)Installed/usr/local/Cellar/fd/10.2.0 (14 files, 2.9MB) * Poured from bottle using the formulae.brew.sh API on 2024-11-29 at 18:02:16From: https://github.com/Homebrew/homebrew-core/blob/HEAD/Formula/f/fd.rbLicense: Apache-2.0 OR MIT==&gt; DependenciesBuild: rust ✘==&gt; Options--HEAD Install HEAD version==&gt; Caveatszsh completions have been installed to: /usr/local/share/zsh/site-functions==&gt; Analyticsinstall: 6,327 (30 days), 24,518 (90 days), 116,476 (365 days)install-on-request: 6,326 (30 days), 24,515 (90 days), 116,363 (365 days)build-error: 0 (30 days) 这个安装脚本中包含bottle do部分，其作用是当安装脚本时，优先从该部分获取对应的操作系统的二进制预编译包的sha256校验值，如果从对应的二进制源中找到，则直接从二进制预编译包的地址进行下载，该预编译下载地址由HOMEBREW_BOTTLE_DOMAIN指定，默认从官方源下载。 12345678910111213141516171819202122232425262728293031323334353637383940class Fd &lt; Formula desc &quot;Simple, fast and user-friendly alternative to find&quot; homepage &quot;https://github.com/sharkdp/fd&quot; url &quot;https://github.com/sharkdp/fd/archive/refs/tags/v10.2.0.tar.gz&quot; sha256 &quot;73329fe24c53f0ca47cd0939256ca5c4644742cb7c14cf4114c8c9871336d342&quot; license any_of: [&quot;Apache-2.0&quot;, &quot;MIT&quot;] head &quot;https://github.com/sharkdp/fd.git&quot;, branch: &quot;master&quot; bottle do sha256 cellar: :any_skip_relocation, arm64_sequoia: &quot;9d17cfb029fbdc6ed31c732108f7aa746d3082dd4783ed35471ef79340615509&quot; sha256 cellar: :any_skip_relocation, arm64_sonoma: &quot;82d5c2ffc2e2d0d8643a7c3f620c81ed49d7b23920aa23b6a7f4c50be69abc0b&quot; sha256 cellar: :any_skip_relocation, arm64_ventura: &quot;354412ababb7d6c52abd9153ff96f133391406ce292b2122c76b96c2ab714f87&quot; sha256 cellar: :any_skip_relocation, arm64_monterey: &quot;0b41f292041767fd1c3c5b92daaa6c823fb07c1d7cd11b0427a415f08463f035&quot; sha256 cellar: :any_skip_relocation, sonoma: &quot;4fa0fb4b3f512e45d35c569953efc7c59ebd8976caac9b2c1b1394b7e29157a0&quot; sha256 cellar: :any_skip_relocation, ventura: &quot;b1406e5414252b1e1b90cfad188454eb31058256ed6246baed48c4e1cfe593a1&quot; sha256 cellar: :any_skip_relocation, monterey: &quot;0ac060bf7d1529aa1f65e634f64b98b906df533d71f2185c883165c01f59ad53&quot; sha256 cellar: :any_skip_relocation, x86_64_linux: &quot;2464fb21cc981166ffa9783fa14a09265790af4d89ce3a763421ddaf29119541&quot; end depends_on &quot;rust&quot; =&gt; :build conflicts_with &quot;fdclone&quot;, because: &quot;both install `fd` binaries&quot; def install system &quot;cargo&quot;, &quot;install&quot;, *std_cargo_args man1.install &quot;doc/fd.1&quot; generate_completions_from_executable(bin/&quot;fd&quot;, &quot;--gen-completions&quot;, shells: [:bash, :fish]) zsh_completion.install &quot;contrib/completion/_fd&quot; # Bash completions are not compatible with Bash 3 so don&#x27;t use v1 directory. # bash: complete: nosort: invalid option name # Issue ref: https://github.com/clap-rs/clap/issues/5190 (share/&quot;bash-completion/completions&quot;).install bash_completion.children end test do touch &quot;foo_file&quot; touch &quot;test_file&quot; assert_equal &quot;test_file&quot;, shell_output(&quot;#&#123;bin&#125;/fd test&quot;).chomp endend 注意，brew4.0后不再使用从该git仓库中获取安装脚本，因为formula的安装源代码已经全部存储在json文件中(见HOMEBREW_API_DOMAIN说明)，不再需要通过Git仓库下载 切换镜像源时，brew4.0后不需要设置该环境变量 HOMEBREW_API_DOMAIN 设置formula\\cask的安装脚本下载源，默认https://formulae.brew.sh brew4.0后不再从git仓库获取安装脚本，而是从这个json文件中一次性获取所有工具的安装脚本，默认24小时更新一次 1234567官方源： formula源：https://formulae.brew.sh/api/formula.jws.json cask源：https://formulae.brew.sh/api/cask.jws.json清华源： formula源：https://mirrors.tuna.tsinghua.edu.cn/homebrew-bottles/api/formula.jws.json cask源：https://mirrors.tuna.tsinghua.edu.cn/homebrew-bottles/api/cask.jws.json 如果还想使用旧的仓库模式，只要配置下环境变量，这样即使你升级后已经删除了对应的仓库，它也会在第一次使用到时自动下载 12# 官方也提到，非开发人员没必要这样做echo &#x27;export HOMEBREW_NO_INSTALL_FROM_API=1&#x27; &gt;&gt; ~/.zshrc HOMEBREW_BOTTLE_DOMAIN 指定预编译二进制包（也称为 bottles）的下载地址，Homebrew 使用这些 bottles 来加速软件安装过程，避免在每个用户的计算机上都重新从源代码构建软件。 当我们通过brew install xxx安装软件时，brew会先从该formula的安装脚本（4.0以前从HOMEBREW_CORE_GIT_REMOTE指定的git仓库获取，4.0以后从HOMEBREW_API_DOMAIN指定的json文件中获取）中获取该软件的安装信息，然后根据安装信息从bottle中下载对应的预编译二进制包，再将其安装到本地。 下载后的二进制包会被保存到缓存目录中(brew --cache)，安装后的软件包存储到Cellar目录中(brew --cellar) 通过上面的分析，我们可以得出结论，切换镜像源时，实际上只需要设置3个变量就够了 123HOMEBREW_BREW_GIT_REMOTEHOMEBREW_API_DOMAINHOMEBREW_BOTTLE_DOMAIN","summary":"摘要 brew是一个软件包管理器，同时支持MacOS和Linux，可以很方便地安装各种软件，比如git、node、python等。 brew虽然支持linux，但是实际使用中很少会使用brew来管理linux的软件包。 本文介绍如何在macos下安装brew，以及如何使用brew管理各种软件包。 本文基于 MacOS Intel Ventura 13.7.1，brew 版本为4.4.8。","date_published":"2024-11-28T13:55:05.000Z","tags":["macos","macos","brew"]},{"id":"https://blog.hanqunfeng.com/2024/11/22/python_poetry/","url":"https://blog.hanqunfeng.com/2024/11/22/python_poetry/","title":"Poetry--轻量级的python包管理器","content_html":"<h2 id=\"摘要\">摘要</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\"><a href=\"https://python-poetry.org/docs/\">Poetry</a>是一个轻量级的python包管理器，其目标是帮助开发者快速、轻松地构建、发布和分享python包。说它轻量，是与 <a href=\"https://docs.conda.io/projects/conda/en/stable/\">conda</a> 相比 poetry 更轻量，同时与 <code>venv + pip</code> <a href=\"/2018/04/28/python_virtualenv/\" title=\"Python--virtualenv\">Python--virtualenv</a> 的方式相比具有如下优点：\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">使用缓存机制，避免重复下载依赖包</li>\n<li class=\"lvl-6\">包管理上更加精确，删除不需要的包时会同时删除与其关联的且没有被使用的那些依赖包，避免无用的依赖包造成打包体积过大</li>\n<li class=\"lvl-6\">打包和发布更加简单，只需要一个命令就可以打包和发布</li>\n</ul>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"安装\">安装</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>参考官方文档<a href=\"https://python-poetry.org/docs/#installation\">Installation</a></p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 官方推荐使用pipx安装，当然也可以使用 pip</span></span><br><span class=\"line\">$ pipx install poetry</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看是否安装成功</span></span><br><span class=\"line\">$ poetry --version</span><br><span class=\"line\">Poetry (version 1.8.4)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 添加命令自动补全</span></span><br><span class=\"line\">$ <span class=\"built_in\">mkdir</span>  ~/.zfunc</span><br><span class=\"line\">$ poetry completions zsh &gt; ~/.zfunc/_poetry</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 在 ~/.zshrc 中添加以下配置（我是用的是zsh，其他shell可以参考官方文档）</span></span><br><span class=\"line\">fpath+=~/.zfunc</span><br><span class=\"line\"><span class=\"built_in\">autoload</span> -Uz compinit &amp;&amp; compinit</span><br></pre></td></tr></table></figure>\n<div class=\"tips\">\n<p><em><strong>pipx简介</strong></em></p>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">\n<p><a href=\"https://github.com/pypa/pipx\">pipx</a> 是一个 Python 包管理工具，使用pipx安装工具包时，每个工具都会被安装在一个独立的虚拟环境中，避免不同工具之间的依赖冲突。</p>\n</li>\n<li class=\"lvl-2\">\n<p>场景：两个工具依赖不同版本的同一个库<br>\n假设我们有两个命令行工具：</p>\n<p>工具A 依赖于 requests 库的版本 2.27.1。<br>\n工具B 依赖于 requests 库的版本 2.31.0。</p>\n<p>如果使用 pip 安装<br>\n工具会被安装到全局环境，共享相同的依赖版本：</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pip install toolA  <span class=\"comment\"># 安装时会安装 requests 2.27.1</span></span><br><span class=\"line\">pip install toolB  <span class=\"comment\"># 安装时会将 requests 升级到 2.31.0</span></span><br></pre></td></tr></table></figure>\n<p>结果：<br>\n当你运行工具A时，它可能会报错，因为它依赖的 requests 2.27.1 已被 requests 2.31.0 替换。<br>\n全局环境中的所有工具都共享一个 requests，版本冲突不可避免。</p>\n<p>如果使用 pipx 安装<br>\n每个工具会被安装到独立的虚拟环境中，各自的依赖互不影响：</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pipx install toolA  <span class=\"comment\"># 在虚拟环境A中安装 toolA 和 requests 2.27.1</span></span><br><span class=\"line\">pipx install toolB  <span class=\"comment\"># 在虚拟环境B中安装 toolB 和 requests 2.31.0</span></span><br></pre></td></tr></table></figure>\n<p>结果：<br>\n虚拟环境A 只包含 toolA 和它的依赖 requests 2.27.1。<br>\n虚拟环境B 只包含 toolB 和它的依赖 requests 2.31.0。<br>\n工具之间完全隔离，不会因为依赖版本冲突而导致问题。</p>\n</li>\n<li class=\"lvl-2\">\n<p>所以，当需要安装全局命令行工具时，使用pipx是个很好的选择</p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://github.com/pypa/pipx\">pipx</a> 的安装</p>\n</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 安装pipx</span></span><br><span class=\"line\">pip install pipx</span><br><span class=\"line\"><span class=\"comment\"># 配置环境变量，运行该命令会将</span></span><br><span class=\"line\">pipx ensurepath</span><br><span class=\"line\"><span class=\"comment\"># 运行上面的命令会将如下内容加入你的shell配置文件中，我的是 .zshrc 文件，实际上你也可以手工添加该配置，将$HOME/.local/bin放到前面更好一些。</span></span><br><span class=\"line\"><span class=\"built_in\">export</span> PATH=<span class=\"string\">&quot;<span class=\"variable\">$PATH</span>:<span class=\"variable\">$HOME</span>/.local/bin&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># 注意添加完成后要重启shell</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 添加pipx自动代码补全</span></span><br><span class=\"line\"><span class=\"comment\"># 运行如下命令，并根据提示完成</span></span><br><span class=\"line\">pipx completions</span><br><span class=\"line\"><span class=\"comment\"># 我的是zsh，所以在 .zshrc中添加如下内容</span></span><br><span class=\"line\"><span class=\"built_in\">autoload</span> -Uz compinit &amp;&amp; compinit <span class=\"comment\"># 如果没有添加过就需要先添加这个</span></span><br><span class=\"line\"><span class=\"built_in\">eval</span> <span class=\"string\">&quot;<span class=\"subst\">$(register-python-argcomplete pipx)</span>&quot;</span> <span class=\"comment\"># 添加自动代码补全</span></span><br><span class=\"line\"><span class=\"comment\"># 注意添加完成后要重启shell</span></span><br></pre></td></tr></table></figure>\n</div>\n<h2 id=\"查看所有命令\">查看所有命令</h2>\n<blockquote>\n<p>我已经将其翻译为中文</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ poetry list</span><br><span class=\"line\">Poetry (版本 1.8.4)</span><br><span class=\"line\"></span><br><span class=\"line\">用法：</span><br><span class=\"line\">  <span class=\"built_in\">command</span> [选项] [参数]</span><br><span class=\"line\"></span><br><span class=\"line\">选项：</span><br><span class=\"line\">  -h, --<span class=\"built_in\">help</span>                 显示给定命令的帮助。如果没有指定命令，则显示列表命令的帮助。</span><br><span class=\"line\">  -q, --quiet                不输出任何消息。</span><br><span class=\"line\">  -V, --version              显示此应用程序版本。</span><br><span class=\"line\">      --ansi                强制输出ANSI格式。</span><br><span class=\"line\">      --no-ansi             禁用ANSI输出。</span><br><span class=\"line\">  -n, --no-interaction       不要提问任何交互性问题。</span><br><span class=\"line\">      --no-plugins           禁用插件。</span><br><span class=\"line\">      --no-cache            禁用源缓存。</span><br><span class=\"line\">  -C, --directory=目录      Poetry命令的工作目录（默认为当前工作目录）。</span><br><span class=\"line\">  -v|vv|vvv, --verbose       增加消息的冗长度：1 表示正常输出，2 表示更详细的输出，3 表示调试。</span><br><span class=\"line\"></span><br><span class=\"line\">可用命令：</span><br><span class=\"line\">  about              显示关于Poetry的信息。</span><br><span class=\"line\">  add                将新依赖项添加到pyproject.toml并安装它。</span><br><span class=\"line\">  build              默认构建一个包，分别是tarball和wheel。</span><br><span class=\"line\">  check              验证pyproject.toml文件的内容及其与poetry.lock文件的一致性。</span><br><span class=\"line\">  config             管理配置设置。</span><br><span class=\"line\">  <span class=\"built_in\">export</span>             将锁文件导出到其他格式。</span><br><span class=\"line\">  <span class=\"built_in\">help</span>               显示特定命令的帮助。</span><br><span class=\"line\">  init               在当前目录创建一个基础的pyproject.toml文件。</span><br><span class=\"line\">  install            安装项目依赖项。</span><br><span class=\"line\">  list               列出命令。</span><br><span class=\"line\">  lock              锁定项目依赖项。</span><br><span class=\"line\">  new               在&lt;path&gt;处创建一个新的Python项目。</span><br><span class=\"line\">  publish           将包发布到远程仓库。</span><br><span class=\"line\">  remove            从项目依赖项中移除包。</span><br><span class=\"line\">  run                在适当的环境中运行命令。</span><br><span class=\"line\">  search            在远程仓库中搜索包。</span><br><span class=\"line\">  shell            在虚拟环境中启动shell。</span><br><span class=\"line\">  show              显示有关包的信息。</span><br><span class=\"line\">  update            根据pyproject.toml文件更新依赖项。</span><br><span class=\"line\">  version           显示项目的版本或在提供有效版本规则时更新它。</span><br><span class=\"line\"></span><br><span class=\"line\">缓存</span><br><span class=\"line\">  cache clear        按名称清除Poetry缓存。</span><br><span class=\"line\">  cache list         列出Poetry的缓存列表。</span><br><span class=\"line\"></span><br><span class=\"line\">调试</span><br><span class=\"line\">  debug info        显示调试信息。</span><br><span class=\"line\">  debug resolve    调试依赖项解析。</span><br><span class=\"line\"></span><br><span class=\"line\">环境</span><br><span class=\"line\">  <span class=\"built_in\">env</span> info         显示当前环境的信息。</span><br><span class=\"line\">  <span class=\"built_in\">env</span> list          列出与当前项目关联的所有虚拟环境。</span><br><span class=\"line\">  <span class=\"built_in\">env</span> remove        移除与项目关联的虚拟环境。</span><br><span class=\"line\">  <span class=\"built_in\">env</span> use           激活或创建当前项目的新的虚拟环境。</span><br><span class=\"line\"></span><br><span class=\"line\">自身</span><br><span class=\"line\">  self add          向Poetry的运行时环境添加其他包。</span><br><span class=\"line\">  self install      安装此Poetry安装所需的锁定包（包括插件）。</span><br><span class=\"line\">  self lock         锁定Poetry安装的系统要求。</span><br><span class=\"line\">  self remove       从Poetry的运行时环境中移除其他包。</span><br><span class=\"line\">  self show         显示Poetry运行时环境中的包。</span><br><span class=\"line\">  self show plugins 显示当前已安装插件的信息。</span><br><span class=\"line\">  self update       更新Poetry到最新版本。</span><br><span class=\"line\"></span><br><span class=\"line\">源</span><br><span class=\"line\">  <span class=\"built_in\">source</span> add         为项目添加源配置。</span><br><span class=\"line\">  <span class=\"built_in\">source</span> remove      移除为项目配置的源。</span><br><span class=\"line\">  <span class=\"built_in\">source</span> show        显示为项目配置的源信息。</span><br></pre></td></tr></table></figure>\n<h2 id=\"常用命令\">常用命令</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>这里只对日常开发中比较常用的命令进行简要说明，详细介绍可以参考<a href=\"https://python-poetry.org/docs/\">官方文档</a></p>\n</li>\n</ul>\n<h3 id=\"new-创建项目\">new : 创建项目</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 按照默认规则创建一个基于 poetry 的项目</span></span><br><span class=\"line\">$ poetry new my-project</span><br><span class=\"line\">Created package my_project <span class=\"keyword\">in</span> my-project</span><br><span class=\"line\">$ <span class=\"built_in\">cd</span> my-project</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看生成的目录结构</span></span><br><span class=\"line\">$ exa -T</span><br><span class=\"line\">.</span><br><span class=\"line\">├── my_project</span><br><span class=\"line\">│  └── __init__.py</span><br><span class=\"line\">├── pyproject.toml</span><br><span class=\"line\">├── README.md</span><br><span class=\"line\">└── tests</span><br><span class=\"line\">   └── __init__.py</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看 pyproject.toml 内容，该文件为项目的配置的配置文件</span></span><br><span class=\"line\">$ more pyproject.toml</span><br><span class=\"line\">[tool.poetry]</span><br><span class=\"line\">name = <span class=\"string\">&quot;my-project&quot;</span></span><br><span class=\"line\">version = <span class=\"string\">&quot;0.1.0&quot;</span></span><br><span class=\"line\">description = <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">authors = [<span class=\"string\">&quot;hanqunfeng &lt;hanqf2008@163.com&gt;&quot;</span>]</span><br><span class=\"line\">readme = <span class=\"string\">&quot;README.md&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">[tool.poetry.dependencies]</span><br><span class=\"line\">python = <span class=\"string\">&quot;^3.11&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">[build-system]</span><br><span class=\"line\">requires = [<span class=\"string\">&quot;poetry-core&quot;</span>]</span><br><span class=\"line\">build-backend = <span class=\"string\">&quot;poetry.core.masonry.api&quot;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"init-初始化一个已有的项目目录\">init : 初始化一个已有的项目目录</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 假设我们已经有个项目目录，目录名称为 poetryDemo</span></span><br><span class=\"line\">$ <span class=\"built_in\">cd</span> poetryDemo</span><br><span class=\"line\"><span class=\"comment\"># 初始化 poetryDemo ，在当前目录下创建 pyproject.toml 文件，注意该操作只会创建该文件，包目录以及readme文件都没有，需要手工创建</span></span><br><span class=\"line\">$ poetry init</span><br><span class=\"line\">This <span class=\"built_in\">command</span> will guide you through creating your pyproject.toml config.</span><br><span class=\"line\"></span><br><span class=\"line\">Package name [poetrydemo]:  <span class=\"comment\"># 包名称</span></span><br><span class=\"line\">Version [0.1.0]:  <span class=\"comment\"># 版本号</span></span><br><span class=\"line\">Description []:   <span class=\"comment\"># 描述信息</span></span><br><span class=\"line\">Author [hanqunfeng &lt;hanqf2008@163.com&gt;, n to skip]:  <span class=\"comment\"># 作者</span></span><br><span class=\"line\">License []:  <span class=\"comment\"># License</span></span><br><span class=\"line\">Compatible Python versions [^3.11]:  <span class=\"comment\"># python 版本</span></span><br><span class=\"line\"></span><br><span class=\"line\">Would you like to define your main dependencies interactively? (<span class=\"built_in\">yes</span>/no) [<span class=\"built_in\">yes</span>] <span class=\"comment\"># 您想以交互方式定义您的主环境依赖关系吗？默认yes</span></span><br><span class=\"line\">You can specify a package <span class=\"keyword\">in</span> the following forms:  <span class=\"comment\"># 您可以按以下形式指定包：</span></span><br><span class=\"line\">  - A single name (requests): this will search <span class=\"keyword\">for</span> matches on PyPI <span class=\"comment\"># 单个名称（requests）：这将在官方仓库PyPI上搜索匹配项，如果指定了其它镜像源就会从指定的源下载</span></span><br><span class=\"line\">  - A name and a constraint (requests@^2.23.0) <span class=\"comment\"># 名称和版本约束</span></span><br><span class=\"line\">  - A git url (git+https://github.com/python-poetry/poetry.git) <span class=\"comment\"># git地址</span></span><br><span class=\"line\">  - A git url with a revision (git+https://github.com/python-poetry/poetry.git#develop) <span class=\"comment\"># git地址，指定某个分支</span></span><br><span class=\"line\">  - A file path (../my-package/my-package.whl) <span class=\"comment\"># 文件路径</span></span><br><span class=\"line\">  - A directory (../my-package/) <span class=\"comment\"># 目录路径</span></span><br><span class=\"line\">  - A url (https://example.com/packages/my-package-0.1.0.tar.gz) <span class=\"comment\"># 一个安装包的地址</span></span><br><span class=\"line\"></span><br><span class=\"line\">Package to add or search <span class=\"keyword\">for</span> (leave blank to skip): <span class=\"comment\"># 添加主环境依赖，按上面的格式要求填写</span></span><br><span class=\"line\"></span><br><span class=\"line\">Would you like to define your development dependencies interactively? (<span class=\"built_in\">yes</span>/no) [<span class=\"built_in\">yes</span>] <span class=\"comment\"># 您想以交互方式定义您的开发依赖关系吗？默认yes</span></span><br><span class=\"line\">Package to add or search <span class=\"keyword\">for</span> (leave blank to skip): <span class=\"comment\"># 添加开发环境依赖，按上面的格式要求填写</span></span><br><span class=\"line\"></span><br><span class=\"line\">Generated file</span><br><span class=\"line\"><span class=\"comment\"># 要生成的 pyproject.toml 内容</span></span><br><span class=\"line\">[tool.poetry]</span><br><span class=\"line\">name = <span class=\"string\">&quot;poetrydemo&quot;</span>  <span class=\"comment\"># 包名称</span></span><br><span class=\"line\">version = <span class=\"string\">&quot;0.1.0&quot;</span>    <span class=\"comment\"># 版本</span></span><br><span class=\"line\">description = <span class=\"string\">&quot;&quot;</span>     <span class=\"comment\"># 描述信息</span></span><br><span class=\"line\">authors = [<span class=\"string\">&quot;hanqunfeng &lt;hanqf2008@163.com&gt;&quot;</span>] <span class=\"comment\"># 作者信息</span></span><br><span class=\"line\">readme = <span class=\"string\">&quot;README.md&quot;</span> <span class=\"comment\"># 说明文件</span></span><br><span class=\"line\"></span><br><span class=\"line\">[tool.poetry.dependencies] <span class=\"comment\"># 主环境依赖</span></span><br><span class=\"line\">python = <span class=\"string\">&quot;^3.11&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">[build-system]</span><br><span class=\"line\">requires = [<span class=\"string\">&quot;poetry-core&quot;</span>]</span><br><span class=\"line\">build-backend = <span class=\"string\">&quot;poetry.core.masonry.api&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">Do you confirm generation? (<span class=\"built_in\">yes</span>/no) [<span class=\"built_in\">yes</span>] <span class=\"comment\"># 确认是否按照上面的内容创建 pyproject.toml 文件，默认yes</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>上面的方式在初始化时会询问你相关的信息，如果你希望都用默认值的话，可以使用如下命令</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">poetry init -n</span><br></pre></td></tr></table></figure>\n<h3 id=\"config-poetry的全局配置\">config : poetry的全局配置</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>查看全局配置</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ poetry config --list</span><br><span class=\"line\">cache-dir = <span class=\"string\">&quot;/Users/hanqf/Library/Caches/pypoetry&quot;</span>  <span class=\"comment\"># 缓存目录,用于存储项目依赖和虚拟环境等缓存信息。</span></span><br><span class=\"line\">experimental.system-git-client = <span class=\"literal\">false</span>              <span class=\"comment\"># 是否使用系统自带的git客户端,false表示使用Poetry内置的git客户端</span></span><br><span class=\"line\">installer.max-workers = null                        <span class=\"comment\"># 安装依赖时的最大线程数,null表示使用默认线程数，可以设置为cpu核数+4</span></span><br><span class=\"line\">installer.modern-installation = <span class=\"literal\">true</span>                <span class=\"comment\"># 是否使用Poetry的现代安装方案,true表示使用</span></span><br><span class=\"line\">installer.no-binary = null                          <span class=\"comment\"># 是否不使用预编译的二进制包,null表示不限制</span></span><br><span class=\"line\">installer.parallel = <span class=\"literal\">true</span>                           <span class=\"comment\"># 是否并行安装依赖,true表示并行安装</span></span><br><span class=\"line\">keyring.enabled = <span class=\"literal\">true</span>                              <span class=\"comment\"># 是否启用密钥环（keyring）以保存认证信息。true 表示启用。</span></span><br><span class=\"line\">solver.lazy-wheel = <span class=\"literal\">true</span>                            <span class=\"comment\"># 是否延迟解析 wheel 包。true 表示延迟解析。</span></span><br><span class=\"line\">virtualenvs.create = <span class=\"literal\">true</span>                           <span class=\"comment\"># 是否自动创建虚拟环境,true表示创建</span></span><br><span class=\"line\">virtualenvs.in-project = null                       <span class=\"comment\"># 是否在项目内创建虚拟环境，null 表示使用默认值（通常为 false），即不在项目中创建。true表示在项目中创建</span></span><br><span class=\"line\">virtualenvs.options.always-copy = <span class=\"literal\">false</span>             <span class=\"comment\"># 如果设置为 true，Poetry 会始终复制文件到虚拟环境中，而不是使用符号链接（symlinks）。这可以避免某些系统上的权限问题，但会增加虚拟环境的存储需求。</span></span><br><span class=\"line\">virtualenvs.options.no-pip = <span class=\"literal\">false</span>                  <span class=\"comment\"># 如果设置为 true，Poetry 在创建虚拟环境时不会安装 pip。如果你的项目不需要直接使用 pip，并且你希望通过 Poetry 管理所有的依赖项，可以将 no-pip 设置为 true，以减少虚拟环境中的不必要的依赖项。</span></span><br><span class=\"line\">virtualenvs.options.no-setuptools = <span class=\"literal\">false</span>           <span class=\"comment\"># 如果设置为 true，Poetry 在创建虚拟环境时不会安装 setuptools。默认情况下，Poetry 会安装 pip 和 setuptools，以便你可以使用这些工具来管理依赖项。</span></span><br><span class=\"line\">virtualenvs.options.system-site-packages = <span class=\"literal\">false</span>    <span class=\"comment\"># 默认值false，此时 Poetry 创建的虚拟环境将不会包含全局 Python 安装的 site-packages 目录中的包。这有助于确保项目依赖项的隔离性，避免与系统中的其他包发生冲突。</span></span><br><span class=\"line\">virtualenvs.path = <span class=\"string\">&quot;&#123;cache-dir&#125;/virtualenvs&quot;</span>  <span class=\"comment\"># /Users/hanqf/Library/Caches/pypoetry/virtualenvs # 虚拟环境存放的路径，如果virtualenvs.in-project设置为true，就只会在项目中创建</span></span><br><span class=\"line\">virtualenvs.prefer-active-python = <span class=\"literal\">false</span>            <span class=\"comment\"># 是否优先使用系统激活的Python解释器</span></span><br><span class=\"line\">virtualenvs.prompt = <span class=\"string\">&quot;&#123;project_name&#125;-py&#123;python_version&#125;&quot;</span>  <span class=\"comment\"># 虚拟环境的命令提示格式</span></span><br><span class=\"line\">warnings.export = <span class=\"literal\">true</span>                              <span class=\"comment\"># 是否在导出时显示警告信息。true 表示显示</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>修改全局配置</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 修改全局配置，此后会在项目目录下创建 .venv 目录存放虚拟环境</span></span><br><span class=\"line\">$ poetry config virtualenvs.in-project <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"comment\"># 进入虚拟环境，如果虚拟环境尚未创建会自动创建</span></span><br><span class=\"line\">$ poetry shell</span><br><span class=\"line\"><span class=\"comment\"># 退出虚拟环境</span></span><br><span class=\"line\">$ <span class=\"built_in\">exit</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 只对当前项目有效，此时会在当前项目目录下创建 poetry.toml 来保存这些配置信息</span></span><br><span class=\"line\">$ poetry config virtualenvs.in-project <span class=\"literal\">true</span> --<span class=\"built_in\">local</span></span><br><span class=\"line\">$ poetry config virtualenvs.options.system-site-packages <span class=\"literal\">true</span> --<span class=\"built_in\">local</span></span><br><span class=\"line\">$ more poetry.toml</span><br><span class=\"line\">[virtualenvs]</span><br><span class=\"line\">in-project = <span class=\"literal\">true</span></span><br><span class=\"line\">[virtualenvs.options]</span><br><span class=\"line\">system-site-packages = <span class=\"literal\">true</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 这里要注意 virtualenvs 下的属性必须在创建虚拟环境前设置才会有效</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"env-虚拟环境管理\">env : 虚拟环境管理</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Poetry 会在你第一次运行某些命令（如 <code>poetry shell</code> 或者 <code>poetry add somepackage</code>）时自动创建虚拟环境。</p>\n</li>\n<li class=\"lvl-2\">\n<p>不过这种时候都是使用系统默认的python来创建虚拟环境，如果系统中安装了多个python，则可以通过如下方式设置虚拟环境要使用哪个python版本</p>\n</li>\n<li class=\"lvl-2\">\n<p>创建/切换虚拟环境</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 指定python的版本，这会从python的默认安装路径下查找对应的版本</span></span><br><span class=\"line\"><span class=\"comment\"># 比如macOs会从该路径下查找：/Library/Frameworks/Python.framework/Versions</span></span><br><span class=\"line\">$ poetry <span class=\"built_in\">env</span> use 3.11</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 如果可以直接在命令行使用python命令,比如：python3.12 -V，则可以使用如下方式创建虚拟环境</span></span><br><span class=\"line\">$ poetry <span class=\"built_in\">env</span> use python3.12</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 如果python安装到了其它路径，可以指定python安装路径</span></span><br><span class=\"line\">$ poetry <span class=\"built_in\">env</span> use /pythonDir/3.13/bin/python3</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>查看当前项目的虚拟环境信息</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 创建一个基于 python3.13 的虚拟环境</span></span><br><span class=\"line\">$ poetry <span class=\"built_in\">env</span> use python3.13</span><br><span class=\"line\">Creating virtualenv poetrydemo-fyqYbfje-py3.13 <span class=\"keyword\">in</span> /Users/hanqf/Library/Caches/pypoetry/virtualenvs</span><br><span class=\"line\">Using virtualenv: /Users/hanqf/Library/Caches/pypoetry/virtualenvs/poetrydemo-fyqYbfje-py3.13</span><br><span class=\"line\"><span class=\"comment\"># 再创建一个基于 python3.11 的虚拟环境，最后被use的处于默认激活状态</span></span><br><span class=\"line\">$ poetry <span class=\"built_in\">env</span> use python3.11</span><br><span class=\"line\">Creating virtualenv poetrydemo-fyqYbfje-py3.11 <span class=\"keyword\">in</span> /Users/hanqf/Library/Caches/pypoetry/virtualenvs</span><br><span class=\"line\">Using virtualenv: /Users/hanqf/Library/Caches/pypoetry/virtualenvs/poetrydemo-fyqYbfje-py3.11</span><br><span class=\"line\"><span class=\"comment\"># 查看当前项目有多少个虚拟环境</span></span><br><span class=\"line\">$ poetry <span class=\"built_in\">env</span> list</span><br><span class=\"line\">poetrydemo-fyqYbfje-py3.11 (Activated) <span class=\"comment\"># poetrydemo-fyqYbfje-py3.11 表示虚拟环境名称，Activated表示当前虚拟环境已经被激活</span></span><br><span class=\"line\">poetrydemo-fyqYbfje-py3.13</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看虚拟化环境路径</span></span><br><span class=\"line\">$ poetry <span class=\"built_in\">env</span> list  --full-path</span><br><span class=\"line\">/Users/hanqf/Library/Caches/pypoetry/virtualenvs/poetrydemo-fyqYbfje-py3.11 (Activated)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看当前激活的虚拟环境信息</span></span><br><span class=\"line\">$ poetry <span class=\"built_in\">env</span> info</span><br><span class=\"line\"></span><br><span class=\"line\">Virtualenv</span><br><span class=\"line\">Python:         3.11.3</span><br><span class=\"line\">Implementation: CPython</span><br><span class=\"line\">Path:           /Users/hanqf/Library/Caches/pypoetry/virtualenvs/poetrydemo-fyqYbfje-py3.11</span><br><span class=\"line\">Executable:     /Users/hanqf/Library/Caches/pypoetry/virtualenvs/poetrydemo-fyqYbfje-py3.11/bin/python</span><br><span class=\"line\">Valid:          True</span><br><span class=\"line\"></span><br><span class=\"line\">Base</span><br><span class=\"line\">Platform:   darwin</span><br><span class=\"line\">OS:         posix</span><br><span class=\"line\">Python:     3.11.3</span><br><span class=\"line\">Path:       /Library/Frameworks/Python.framework/Versions/3.11</span><br><span class=\"line\">Executable: /Library/Frameworks/Python.framework/Versions/3.11/bin/python3.11</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 删除虚拟环境</span></span><br><span class=\"line\">$ poetry <span class=\"built_in\">env</span> remove python3.13</span><br><span class=\"line\">Deleted virtualenv: /Users/hanqf/Library/Caches/pypoetry/virtualenvs/poetrydemo-fyqYbfje-py3.13</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 删除全部虚拟环境</span></span><br><span class=\"line\">$ poetry <span class=\"built_in\">env</span> remove --all</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>注意，当<code>virtualenvs.in-project</code>被设置为<code>true</code>时，即只在项目目录下创建虚拟环境时，只会保留一个环境，即<code>.venv</code></p>\n</li>\n<li class=\"lvl-2\">\n<p>切换到新的虚拟环境时会全新创建一个新的环境，原先的环境会被删除，所以要使用<code>poetry install</code>命令重新安装依赖</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">$ poetry <span class=\"built_in\">env</span> use python3.11</span><br><span class=\"line\">Recreating virtualenv poetrydemo <span class=\"keyword\">in</span> /Users/hanqf/Desktop/pythonDir/poetryDir/poetryDemo/.venv</span><br><span class=\"line\">Using virtualenv: /Users/hanqf/Desktop/pythonDir/poetryDir/poetryDemo/.venv</span><br><span class=\"line\"></span><br><span class=\"line\">$ poetry <span class=\"built_in\">env</span> list <span class=\"comment\"># 虽然可以通过 poetry env use 的方式来创建新的虚拟环境，但实际上只会有一个环境被保留，所以这里只会显示一个</span></span><br><span class=\"line\">.venv (Activated) <span class=\"comment\"># .venv 表示虚拟环境名称，Activated表示当前虚拟环境已经被激活</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看虚拟环境信息</span></span><br><span class=\"line\">$ poetry <span class=\"built_in\">env</span> info</span><br><span class=\"line\"></span><br><span class=\"line\">Virtualenv</span><br><span class=\"line\">Python:         3.11.3</span><br><span class=\"line\">Implementation: CPython</span><br><span class=\"line\">Path:           /Users/hanqf/Desktop/pythonDir/poetryDir/poetryDemo/.venv</span><br><span class=\"line\">Executable:     /Users/hanqf/Desktop/pythonDir/poetryDir/poetryDemo/.venv/bin/python</span><br><span class=\"line\">Valid:          True</span><br><span class=\"line\"></span><br><span class=\"line\">Base</span><br><span class=\"line\">Platform:   darwin</span><br><span class=\"line\">OS:         posix</span><br><span class=\"line\">Python:     3.11.3</span><br><span class=\"line\">Path:       /Library/Frameworks/Python.framework/Versions/3.11</span><br><span class=\"line\">Executable: /Library/Frameworks/Python.framework/Versions/3.11/bin/python3.11</span><br></pre></td></tr></table></figure>\n<h3 id=\"依赖包管理\">依赖包管理</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>add : 安装依赖包</p>\n</li>\n</ul>\n<blockquote>\n<p>这个命令会修改 pyproject.toml 文件，在 [tool.poetry.dependencies] 部分添加新的依赖项。还会自动更新 poetry.lock 文件，锁定依赖的确切版本。</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 安装依赖，安装后会将依赖信息写入 pyproject.toml 中</span></span><br><span class=\"line\"><span class=\"comment\"># 不指定版本则安装最新版</span></span><br><span class=\"line\">$ poetry add fastapi</span><br><span class=\"line\">Using version ^0.115.5 <span class=\"keyword\">for</span> fastapi</span><br><span class=\"line\"></span><br><span class=\"line\">Updating dependencies</span><br><span class=\"line\">Resolving dependencies... (1.3s)</span><br><span class=\"line\"></span><br><span class=\"line\">Package operations: 9 installs, 0 updates, 0 removals</span><br><span class=\"line\"></span><br><span class=\"line\">  - Installing idna (3.10)</span><br><span class=\"line\">  - Installing sniffio (1.3.1)</span><br><span class=\"line\">  - Installing typing-extensions (4.12.2)</span><br><span class=\"line\">  - Installing annotated-types (0.7.0)</span><br><span class=\"line\">  - Installing anyio (4.6.2.post1)</span><br><span class=\"line\">  - Installing pydantic-core (2.23.4)</span><br><span class=\"line\">  - Installing pydantic (2.9.2)</span><br><span class=\"line\">  - Installing starlette (0.41.3)</span><br><span class=\"line\">  - Installing fastapi (0.115.5)</span><br><span class=\"line\"></span><br><span class=\"line\">Writing lock file</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 指定版本号安装依赖</span></span><br><span class=\"line\">poetry add package_name@^1.2.3</span><br><span class=\"line\">    <span class=\"comment\"># 规则说明</span></span><br><span class=\"line\">    ^1.2.3 表示兼容 1.2.3 及更高的小版本，但不包括 2.0.0。    如：poetry add requests@^2.28.0</span><br><span class=\"line\">    ~1.2.3：允许升级到 1.2.x，但不包括 1.3.0。               如：poetry add requests@~2.28.0</span><br><span class=\"line\">    1.2.3：固定为 1.2.3。                                   如：poetry add requests@2.28.0</span><br><span class=\"line\">    &gt;=1.2.3：允许使用 1.2.3 及以上版本。注意zsh下要加上双引号，如：poetry add <span class=\"string\">&quot;requests@&gt;=2.28.0&quot;</span></span><br><span class=\"line\">    &lt;2.0.0：允许使用小于 2.0.0 的版本。 注意zsh下要加上双引号，如：poetry add <span class=\"string\">&quot;requests@&lt;3.0.0&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 安装到指定的分组，默认都是安装到主环境中的，poetry build默认只会打包主环境的依赖</span></span><br><span class=\"line\">poetry add flask <span class=\"comment\"># 安装到主环境中</span></span><br><span class=\"line\">poetry add flask --group=<span class=\"built_in\">test</span> <span class=\"comment\">#添加分组名 test</span></span><br><span class=\"line\">poetry add flask --dev  <span class=\"comment\">#相当于--group=dev</span></span><br><span class=\"line\"><span class=\"comment\"># 分别执行上面3个安装命令后，输出 pyproject.toml 的内容如下</span></span><br><span class=\"line\">[tool.poetry]</span><br><span class=\"line\">name = <span class=\"string\">&quot;poetrydemo&quot;</span></span><br><span class=\"line\">version = <span class=\"string\">&quot;0.1.0&quot;</span></span><br><span class=\"line\">description = <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">authors = [<span class=\"string\">&quot;hanqunfeng &lt;hanqf2008@163.com&gt;&quot;</span>]</span><br><span class=\"line\">readme = <span class=\"string\">&quot;README.md&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">[tool.poetry.dependencies] <span class=\"comment\"># 主环境</span></span><br><span class=\"line\">python = <span class=\"string\">&quot;^3.11&quot;</span></span><br><span class=\"line\">flask = <span class=\"string\">&quot;^3.1.0&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">[tool.poetry.group.test.dependencies] <span class=\"comment\"># test分组依赖</span></span><br><span class=\"line\">flask = <span class=\"string\">&quot;^3.1.0&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">[tool.poetry.group.dev.dependencies] <span class=\"comment\"># dev分组依赖</span></span><br><span class=\"line\">flask = <span class=\"string\">&quot;^3.1.0&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">[build-system]</span><br><span class=\"line\">requires = [<span class=\"string\">&quot;poetry-core&quot;</span>]</span><br><span class=\"line\">build-backend = <span class=\"string\">&quot;poetry.core.masonry.api&quot;</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>show : 查看依赖包</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看当前项目都需要哪些依赖，这些依赖不一定都安装了，它只是解析 pyproject.toml 中的声明来解析依赖树</span></span><br><span class=\"line\">$ poetry show</span><br><span class=\"line\">annotated-types   0.7.0       Reusable constraint types to use with typing.Annotated</span><br><span class=\"line\">anyio             4.6.2.post1 High level compatibility layer <span class=\"keyword\">for</span> multiple asynchronous ...</span><br><span class=\"line\">fastapi           0.115.5     FastAPI framework, high performance, easy to learn, fast ...</span><br><span class=\"line\">idna              3.10        Internationalized Domain Names <span class=\"keyword\">in</span> Applications (IDNA)</span><br><span class=\"line\">pydantic          2.9.2       Data validation using Python <span class=\"built_in\">type</span> hints</span><br><span class=\"line\">pydantic-core     2.23.4      Core functionality <span class=\"keyword\">for</span> Pydantic validation and serialization</span><br><span class=\"line\">sniffio           1.3.1       Sniff out <span class=\"built_in\">which</span> async library your code is running under</span><br><span class=\"line\">starlette         0.41.3      The little ASGI library that shines.</span><br><span class=\"line\">typing-extensions 4.12.2      Backported and Experimental Type Hints <span class=\"keyword\">for</span> Python 3.8+</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 只查看顶级依赖，即只查看在 pyproject.toml 中声明的依赖</span></span><br><span class=\"line\">$ poetry show --top-level</span><br><span class=\"line\">fastapi           0.115.5     FastAPI framework, high performance, easy to learn, fast ...</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>remove : 删除依赖包</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 删除依赖，此时会将当前包及其所有依赖一块删除</span></span><br><span class=\"line\">$ poetry remove fastapi</span><br><span class=\"line\">Updating dependencies</span><br><span class=\"line\">Resolving dependencies... (0.1s)</span><br><span class=\"line\"></span><br><span class=\"line\">Package operations: 0 installs, 0 updates, 9 removals</span><br><span class=\"line\"></span><br><span class=\"line\">  - Removing annotated-types (0.7.0)</span><br><span class=\"line\">  - Removing anyio (4.6.2.post1)</span><br><span class=\"line\">  - Removing fastapi (0.115.5)</span><br><span class=\"line\">  - Removing idna (3.10)</span><br><span class=\"line\">  - Removing pydantic (2.9.2)</span><br><span class=\"line\">  - Removing pydantic-core (2.23.4)</span><br><span class=\"line\">  - Removing sniffio (1.3.1)</span><br><span class=\"line\">  - Removing starlette (0.41.3)</span><br><span class=\"line\">  - Removing typing-extensions (4.12.2)</span><br><span class=\"line\"></span><br><span class=\"line\">Writing lock file</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>search : 搜索远程仓库</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 搜索远程仓库</span></span><br><span class=\"line\">$ poetry search fastapi</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>install 和 update : 安装和更新依赖包<br>\n<em><strong>在 Poetry 中，install 和 update 是两个常用的命令，但它们的作用和使用场景不同</strong></em></p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-7\">\n<p><code>poetry install</code> 的作用是根据现有的 poetry.lock 文件来安装依赖，确保安装的依赖版本与锁文件中记录的版本完全一致。<br>\n核心特点：</p>\n<ul class=\"lvl-4\">\n<li class=\"lvl-10\">安装锁定的版本：它只会安装 poetry.lock 文件中指定的版本，即使 pyproject.toml 文件中定义的版本范围已经有更新版本。</li>\n<li class=\"lvl-10\">重现依赖环境：适用于团队协作或部署环境，确保所有人或机器安装的依赖版本完全相同。</li>\n<li class=\"lvl-10\">锁文件存在时更高效：如果 poetry.lock 文件存在，poetry install 不会重新解析依赖树。</li>\n<li class=\"lvl-10\">首次运行时生成锁文件：如果没有 poetry.lock 文件，poetry install 会解析依赖并生成锁文件。<br>\n使用场景：</li>\n<li class=\"lvl-10\">新克隆的项目，需要安装依赖环境。</li>\n<li class=\"lvl-10\">部署生产环境，确保依赖版本的稳定性。</li>\n<li class=\"lvl-10\">重新安装之前已定义的依赖（例如清空了虚拟环境）。</li>\n</ul>\n</li>\n<li class=\"lvl-6\">\n<p><code>poetry update</code> 的作用是根据 pyproject.toml 文件中定义的依赖范围重新解析依赖树，并更新 poetry.lock 文件为最新的版本。<br>\n核心特点：</p>\n<ul class=\"lvl-4\">\n<li class=\"lvl-10\">更新到最新版本：它会尝试安装依赖范围内的最新版本，并更新 poetry.lock 文件。</li>\n<li class=\"lvl-10\">解析新的依赖树：即使 poetry.lock 文件存在，poetry update 也会忽略它并重新解析依赖。</li>\n<li class=\"lvl-10\">更改锁文件：它会覆盖现有的 poetry.lock 文件，因此团队其他成员需要重新运行 poetry install 以同步。<br>\n使用场景：</li>\n<li class=\"lvl-10\">更新依赖到最新版本（在依赖范围内）。</li>\n<li class=\"lvl-10\">当添加新依赖后，想要安装并更新锁文件。</li>\n<li class=\"lvl-10\">修复可能的版本冲突或不兼容问题。</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"lock-锁定依赖包\">lock : 锁定依赖包</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>poetry lock</code> 是 Poetry（一个 Python 包管理工具）中的一个命令，用于锁定项目的依赖关系。使用这个命令可以创建或更新 <code>poetry.lock</code> 文件，确保你的项目中所使用的每个包的版本都被明确记录下来。这样做对于项目的可复现性和稳定性至关重要。</p>\n</li>\n<li class=\"lvl-2\">\n<p>实际上，当运行 <code>poetry install</code> 、 <code>poetry update</code> 或者 <code>poetry add</code> 等命令时， poetry 都会根据<br>\n<code>pyproject.toml</code> 文件中的依赖范围，解析依赖树，并在项目目录下创建或更新 <code>poetry.lock</code> 文件。</p>\n</li>\n<li class=\"lvl-2\">\n<p>当我们手工修改了 <code>pyproject.toml</code> 文件中的依赖范围，此时又不想立刻更新依赖，而是希望在某个时机再更新，此时就可以使用 <code>poetry lock</code> 命令，先锁定这些依赖，之后再通过 <code>poetry install</code> 命令安装。</p>\n</li>\n<li class=\"lvl-2\">\n<p>可以使用 <code>poetry check</code> 命令检查 <code>pyproject.toml</code> 文件 与 <code>poetry.lock</code> 文件的一致性。</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 比如我手工删除了 `pyproject.toml` 文件中的某个依赖</span></span><br><span class=\"line\"><span class=\"comment\"># 此时运行 check 检查一致性会报错</span></span><br><span class=\"line\">$ poetry check</span><br><span class=\"line\">Error: pyproject.toml changed significantly since poetry.lock was last generated. Run `poetry lock [--no-update]` to fix the lock file.</span><br><span class=\"line\"><span class=\"comment\"># 锁定依赖</span></span><br><span class=\"line\">$ poetry lock</span><br><span class=\"line\">Updating dependencies</span><br><span class=\"line\">Resolving dependencies... (0.1s)</span><br><span class=\"line\"></span><br><span class=\"line\">Writing lock file</span><br><span class=\"line\"><span class=\"comment\"># 检查一致性通过</span></span><br><span class=\"line\">$ poetry check</span><br><span class=\"line\">All <span class=\"built_in\">set</span>!</span><br></pre></td></tr></table></figure>\n<div class=\"tips\">\n<p><em><strong>小贴士</strong></em></p>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">注意，此时通过 <code>poetry show</code> 查看不到那个手工删除的依赖包，但实际上依赖依旧在于虚拟环境中</li>\n<li class=\"lvl-2\">所以尽量避免手工删除依赖，而是通过 <code>poetry remove</code> 命令来删除依赖</li>\n</ul>\n</div>\n<h3 id=\"source-镜像源管理\">source : 镜像源管理</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>默认情况下都是从Pypi的官方仓库下载，国内一般需要指定镜像源来加速下载</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 添加镜像源，默认就是主要源，注意该方式只对当前项目有效</span></span><br><span class=\"line\"><span class=\"comment\"># 命令格式：poetry source add [选项] [--] &lt;name&gt; [&lt;url&gt;]，name：源仓库的名称，url：源仓库的 URL</span></span><br><span class=\"line\">$ poetry <span class=\"built_in\">source</span> add tsinghua https://pypi.tuna.tsinghua.edu.cn/simple</span><br><span class=\"line\">Adding <span class=\"built_in\">source</span> with name tsinghua.</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --priority=PRIORITY设置此源的优先级。可以是以下值之一：default（默认）、primary（主要）、supplemental（备用）、explicit（显式源，只有当包明确声明使用该源时才会被使用）。默认为 primary。</span></span><br><span class=\"line\">$ poetry <span class=\"built_in\">source</span> add  --priority=supplemental aliyun http://mirrors.aliyun.com/pypi/simple/</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看镜像源信息</span></span><br><span class=\"line\">$ poetry <span class=\"built_in\">source</span> show</span><br><span class=\"line\"> name      : tsinghua</span><br><span class=\"line\"> url       : https://pypi.tuna.tsinghua.edu.cn/simple</span><br><span class=\"line\"> priority  : primary</span><br><span class=\"line\"></span><br><span class=\"line\"> name      : aliyun</span><br><span class=\"line\"> url       : http://mirrors.aliyun.com/pypi/simple/</span><br><span class=\"line\"> priority  : supplemental</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 此时查看 pyproject.toml 文件可以看到镜像源信息</span></span><br><span class=\"line\">[[tool.poetry.source]]</span><br><span class=\"line\">name = <span class=\"string\">&quot;tsinghua&quot;</span></span><br><span class=\"line\">url = <span class=\"string\">&quot;https://pypi.tuna.tsinghua.edu.cn/simple&quot;</span></span><br><span class=\"line\">priority = <span class=\"string\">&quot;primary&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">[[tool.poetry.source]]</span><br><span class=\"line\">name = <span class=\"string\">&quot;aliyun&quot;</span></span><br><span class=\"line\">url = <span class=\"string\">&quot;http://mirrors.aliyun.com/pypi/simple/&quot;</span></span><br><span class=\"line\">priority = <span class=\"string\">&quot;supplemental&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 删除镜像源</span></span><br><span class=\"line\">$ poetry <span class=\"built_in\">source</span> remove aliyun <span class=\"comment\"># 指定镜像源名称</span></span><br><span class=\"line\">Removing <span class=\"built_in\">source</span> with name aliyun.</span><br></pre></td></tr></table></figure>\n<h3 id=\"运行\">运行</h3>\n<p>这里以一个小示例来说明这个功能</p>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>创建一个新的项目</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ poetry new poetryDemo</span><br><span class=\"line\">Created package poetrydemo <span class=\"keyword\">in</span> poetryDemo</span><br><span class=\"line\"><span class=\"comment\"># 进入项目目录</span></span><br><span class=\"line\">$ <span class=\"built_in\">cd</span> poetryDemo</span><br><span class=\"line\"><span class=\"comment\"># 查看生成的文件</span></span><br><span class=\"line\">$ ll</span><br><span class=\"line\">total 8</span><br><span class=\"line\">drwxr-xr-x  6 hanqf  staff  192 11 21 17:32 .</span><br><span class=\"line\">drwxr-xr-x  4 hanqf  staff  128 11 21 17:32 ..</span><br><span class=\"line\">-rw-r--r--  1 hanqf  staff    0 11 21 17:32 README.md</span><br><span class=\"line\">drwxr-xr-x  3 hanqf  staff   96 11 21 17:32 poetrydemo</span><br><span class=\"line\">-rw-r--r--  1 hanqf  staff  266 11 21 17:32 pyproject.toml</span><br><span class=\"line\">drwxr-xr-x  3 hanqf  staff   96 11 21 17:32 tests</span><br><span class=\"line\"><span class=\"comment\"># 进入包目录</span></span><br><span class=\"line\">$ <span class=\"built_in\">cd</span> poetrydemo</span><br><span class=\"line\"><span class=\"comment\"># 查看包目录下的文件</span></span><br><span class=\"line\">$ ll</span><br><span class=\"line\">total 0</span><br><span class=\"line\">drwxr-xr-x  3 hanqf  staff   96 11 21 17:32 .</span><br><span class=\"line\">drwxr-xr-x  6 hanqf  staff  192 11 21 17:32 ..</span><br><span class=\"line\">-rw-r--r--  1 hanqf  staff    0 11 21 17:32 __init__.py</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>在包目录下创建 array_util.py，内容如下</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import numpy as np</span><br><span class=\"line\"></span><br><span class=\"line\">def generate_random_array(shape, distribution=<span class=\"string\">&quot;uniform&quot;</span>, params=None, seed=None):</span><br><span class=\"line\">    <span class=\"string\">&quot;&quot;</span><span class=\"string\">&quot;</span></span><br><span class=\"line\"><span class=\"string\">    生成随机数组的工具方法。</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    :param shape: tuple，指定数组的形状，例如 (3, 4) 表示 3 行 4 列。</span></span><br><span class=\"line\"><span class=\"string\">    :param distribution: str，指定随机数分布类型，可选值：</span></span><br><span class=\"line\"><span class=\"string\">        - &quot;</span>uniform<span class=\"string\">&quot;：均匀分布（默认）。</span></span><br><span class=\"line\"><span class=\"string\">        - &quot;</span>normal<span class=\"string\">&quot;：正态分布。</span></span><br><span class=\"line\"><span class=\"string\">        - &quot;</span><span class=\"built_in\">integer</span><span class=\"string\">&quot;：随机整数。</span></span><br><span class=\"line\"><span class=\"string\">    :param params: dict，分布的参数配置：</span></span><br><span class=\"line\"><span class=\"string\">        - 均匀分布：&#123;&quot;</span>low<span class=\"string\">&quot;: 最小值, &quot;</span>high<span class=\"string\">&quot;: 最大值&#125;，默认 low=0, high=1。</span></span><br><span class=\"line\"><span class=\"string\">        - 正态分布：&#123;&quot;</span>mean<span class=\"string\">&quot;: 均值, &quot;</span>std<span class=\"string\">&quot;: 标准差&#125;，默认 mean=0, std=1。</span></span><br><span class=\"line\"><span class=\"string\">        - 随机整数：&#123;&quot;</span>low<span class=\"string\">&quot;: 最小值, &quot;</span>high<span class=\"string\">&quot;: 最大值, &quot;</span>dtype<span class=\"string\">&quot;: 类型&#125;，默认 low=0, high=10。</span></span><br><span class=\"line\"><span class=\"string\">    :param seed: int，随机数种子（可选），用于结果可复现。</span></span><br><span class=\"line\"><span class=\"string\">    :return: np.ndarray，生成的随机数组。</span></span><br><span class=\"line\"><span class=\"string\">    &quot;</span><span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> seed is not None:</span><br><span class=\"line\">        np.random.seed(seed)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> params is None:</span><br><span class=\"line\">        params = &#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> distribution == <span class=\"string\">&quot;uniform&quot;</span>:</span><br><span class=\"line\">        low = params.get(<span class=\"string\">&quot;low&quot;</span>, 0)</span><br><span class=\"line\">        high = params.get(<span class=\"string\">&quot;high&quot;</span>, 1)</span><br><span class=\"line\">        <span class=\"built_in\">return</span> np.random.uniform(low, high, size=shape)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">elif</span> distribution == <span class=\"string\">&quot;normal&quot;</span>:</span><br><span class=\"line\">        mean = params.get(<span class=\"string\">&quot;mean&quot;</span>, 0)</span><br><span class=\"line\">        std = params.get(<span class=\"string\">&quot;std&quot;</span>, 1)</span><br><span class=\"line\">        <span class=\"built_in\">return</span> np.random.normal(mean, std, size=shape)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">elif</span> distribution == <span class=\"string\">&quot;integer&quot;</span>:</span><br><span class=\"line\">        low = params.get(<span class=\"string\">&quot;low&quot;</span>, 0)</span><br><span class=\"line\">        high = params.get(<span class=\"string\">&quot;high&quot;</span>, 10)</span><br><span class=\"line\">        dtype = params.get(<span class=\"string\">&quot;dtype&quot;</span>, int)</span><br><span class=\"line\">        <span class=\"built_in\">return</span> np.random.randint(low, high, size=shape, dtype=dtype)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">else</span>:</span><br><span class=\"line\">        raise ValueError(<span class=\"string\">&quot;不支持的分布类型！可选值为 &#x27;uniform&#x27;, &#x27;normal&#x27;, &#x27;integer&#x27;。&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 示例用法</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">&quot;__main__&quot;</span>:</span><br><span class=\"line\">    array_uniform = generate_random_array((<span class=\"number\">3</span>, <span class=\"number\">4</span>), distribution=&quot;uniform&quot;, params=&#123;&quot;low&quot;: <span class=\"number\">1</span>, &quot;high&quot;: <span class=\"number\">10</span>&#125;)</span><br><span class=\"line\">    array_normal = generate_random_array((<span class=\"number\">2</span>, <span class=\"number\">3</span>), distribution=&quot;normal&quot;, params=&#123;&quot;mean&quot;: <span class=\"number\">0</span>, &quot;std&quot;: <span class=\"number\">1</span>&#125;, seed=<span class=\"number\">42</span>)</span><br><span class=\"line\">    array_integer = generate_random_array((<span class=\"number\">4</span>, <span class=\"number\">5</span>), distribution=&quot;integer&quot;, params=&#123;&quot;low&quot;: <span class=\"number\">0</span>, &quot;high&quot;: <span class=\"number\">20</span>&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">    print(&quot;均匀分布随机数组：\\n&quot;, array_uniform)</span><br><span class=\"line\">    print(&quot;正态分布随机数组：\\n&quot;, array_normal)</span><br><span class=\"line\">    print(&quot;随机整数数组：\\n&quot;, array_integer)</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>安装依赖</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ poetry add numpy</span><br><span class=\"line\">Using version ^2.1.3 <span class=\"keyword\">for</span> numpy</span><br><span class=\"line\"></span><br><span class=\"line\">Updating dependencies</span><br><span class=\"line\">Resolving dependencies... (1.1s)</span><br><span class=\"line\"></span><br><span class=\"line\">Package operations: 1 install, 0 updates, 0 removals</span><br><span class=\"line\"></span><br><span class=\"line\">  - Installing numpy (2.1.3)</span><br><span class=\"line\"></span><br><span class=\"line\">Writing lock file</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>运行，两种方法</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\"><code>poetry run</code></li>\n</ul>\n  <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ poetry run python array_util.py</span><br><span class=\"line\">均匀分布随机数组：</span><br><span class=\"line\">[[7.44623063 1.89415788 4.81008329 4.25556572]</span><br><span class=\"line\">[3.31925154 6.44037063 5.3216543  7.54950573]</span><br><span class=\"line\">[3.97160747 5.04800698 3.28299934 3.42841887]]</span><br><span class=\"line\">正态分布随机数组：</span><br><span class=\"line\">[[ 0.49671415 -0.1382643   0.64768854]</span><br><span class=\"line\">[ 1.52302986 -0.23415337 -0.23413696]]</span><br><span class=\"line\">随机整数数组：</span><br><span class=\"line\">[[10 10  3  7  2]</span><br><span class=\"line\">[ 1 11  5  1  0]</span><br><span class=\"line\">[11 11 16  9 15]</span><br><span class=\"line\">[14 14 18 11 19]]</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\"><code>poetry shell</code> : 此时会开启一个新的shell，并开启虚拟环境</li>\n</ul>\n  <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 开启虚拟环境</span></span><br><span class=\"line\">$ poetry shell</span><br><span class=\"line\">Spawning shell within /Users/hanqf/Library/Caches/pypoetry/virtualenvs/poetrydemo-fyqYbfje-py3.11</span><br><span class=\"line\">Restored session: 2024年11月21日 星期四 15时31分52秒 CST</span><br><span class=\"line\">➜  poetrydemo <span class=\"built_in\">emulate</span> bash -c <span class=\"string\">&#x27;. /Users/hanqf/Library/Caches/pypoetry/virtualenvs/poetrydemo-fyqYbfje-py3.11/bin/activate&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># 在虚拟环境下运行</span></span><br><span class=\"line\">$ python array_util.py</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<h3 id=\"打包和发布\">打包和发布</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>接着上面的项目</p>\n</li>\n<li class=\"lvl-2\">\n<p>打包</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 会在项目目录下创建 dist 目录，并将打好的包存放于此</span></span><br><span class=\"line\">$ poetry build</span><br><span class=\"line\">Building poetrydemo (0.1.0)</span><br><span class=\"line\">  - Building sdist</span><br><span class=\"line\">  - Built poetrydemo-0.1.0.tar.gz</span><br><span class=\"line\">  - Building wheel</span><br><span class=\"line\">  - Built poetrydemo-0.1.0-py3-none-any.whl</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看生成的打包文件</span></span><br><span class=\"line\">$ exa -1 dist</span><br><span class=\"line\">hqf_poetrydemo-0.1.0-py3-none-any.whl</span><br><span class=\"line\">hqf_poetrydemo-0.1.0.tar.gz</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>发布</p>\n</li>\n<li class=\"lvl-2\">\n<p>首先要先在<a href=\"https://pypi.org/\">PyPI</a>上注册个帐号，需要开启“双要素身份验证 （2FA）”，否则不能获取发布时的API令牌。</p>\n</li>\n<li class=\"lvl-2\">\n<p>获取API令牌<br>\n<img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/iShot_2024-11-21_18.00.50.png\" alt=\"\"></p>\n</li>\n<li class=\"lvl-2\">\n<p>发布，不过这次发布提示包名已经存在了</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 发布时提示包名已经存在了</span></span><br><span class=\"line\">$ poetry publish -u __token__  -p pypi-AgEIcHlwaS5vcmcCJDU0Y2Q5NjhkLWYyYTEtN</span><br><span class=\"line\">Publishing poetrydemo (0.1.0) to PyPI</span><br><span class=\"line\"> - Uploading poetrydemo-0.1.0-py3-none-any.whl FAILED</span><br><span class=\"line\"></span><br><span class=\"line\">HTTP Error 400: The name <span class=\"string\">&#x27;poetrydemo&#x27;</span> is too similar to an existing project. See https://pypi.org/help/#project-name <span class=\"keyword\">for</span> more information. | b<span class=\"string\">&quot;&lt;html&gt;\\n &lt;head&gt;\\n  &lt;title&gt;400 The name &#x27;poetrydemo&#x27; is too similar to an existing project. See https://pypi.org/help/#project-name for more information.\\n \\n &lt;body&gt;\\n  &lt;h1&gt;400 The name &#x27;poetrydemo&#x27; is too similar to an existing project. See https://pypi.org/help/#project-name for more information.\\n  The server could not comply with the request since it is either malformed or otherwise incorrect.&lt;br/&gt;&lt;br/&gt;\\nThe name &amp;#x27;poetrydemo&amp;#x27; is too similar to an existing project. See https://pypi.org/help/#project-name for more information.\\n\\n\\n \\n&quot;</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>先修改包名，直接编辑 pyproject.toml 即可，将name属性修改为“hqf_poetrydemo”，然后将包目录的名称也修改为这个<code>mv poetrydemo hqf_poetrydemo</code>，并删除dist目录，之后重新打包<code>poetry build</code>，再次发布</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ vim pyproject.toml <span class=\"comment\"># 将name属性修改为“hqf_poetrydemo”</span></span><br><span class=\"line\">$ <span class=\"built_in\">mv</span> poetrydemo hqf_poetrydemo <span class=\"comment\"># 将包目录的名称也修改为这个</span></span><br><span class=\"line\">$ <span class=\"built_in\">rm</span> -rf dist <span class=\"comment\"># 删除dist目录</span></span><br><span class=\"line\">$ poetry build    <span class=\"comment\"># 重新打包</span></span><br><span class=\"line\">Creating virtualenv hqf-poetrydemo-fyqYbfje-py3.11 <span class=\"keyword\">in</span> /Users/hanqf/Library/Caches/pypoetry/virtualenvs</span><br><span class=\"line\">Building hqf_poetrydemo (0.1.0)</span><br><span class=\"line\">  - Building sdist</span><br><span class=\"line\">  - Built hqf_poetrydemo-0.1.0.tar.gz</span><br><span class=\"line\">  - Building wheel</span><br><span class=\"line\">  - Built hqf_poetrydemo-0.1.0-py3-none-any.whl</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 再次发布</span></span><br><span class=\"line\">$ poetry publish -u __token__  -p pypi-AgEIcHlwaS5vcmcCJDU0Y2Q5NjhkLWYyYTEtN</span><br><span class=\"line\"></span><br><span class=\"line\">Publishing hqf_poetrydemo (0.1.0) to PyPI</span><br><span class=\"line\"> - Uploading hqf_poetrydemo-0.1.0-py3-none-any.whl 100%</span><br><span class=\"line\"> - Uploading hqf_poetrydemo-0.1.0.tar.gz 100%</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/iShot_2024-11-21_18.13.21.png\" alt=\"\"></p>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>之后就可以在其它项目中安装这个包了</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># pip install</span></span><br><span class=\"line\">$ pip install hqf_poetrydemo</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># poetry add</span></span><br><span class=\"line\">$ poetry add hqf_poetrydemo</span><br><span class=\"line\">Using version ^0.1.0 <span class=\"keyword\">for</span> hqf-poetrydemo</span><br><span class=\"line\"></span><br><span class=\"line\">Updating dependencies</span><br><span class=\"line\">Resolving dependencies... (0.5s)</span><br><span class=\"line\"></span><br><span class=\"line\">Package operations: 2 installs, 0 updates, 0 removals</span><br><span class=\"line\"></span><br><span class=\"line\">  - Installing numpy (2.1.3)</span><br><span class=\"line\">  - Installing hqf-poetrydemo (0.1.0)</span><br><span class=\"line\"></span><br><span class=\"line\">Writing lock file</span><br></pre></td></tr></table></figure>\n<h3 id=\"self-update-升级-poetry-版本\"><code>self update</code> : 升级 poetry 版本</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>self 相关命令主要用于 poetry 自身安装插件使用</p>\n</li>\n<li class=\"lvl-2\">\n<p>估计插件功能目前还不成熟，官网也没有进行详细的说明，并且 windows 下无法使用，所以这里不讨论。</p>\n</li>\n<li class=\"lvl-2\">\n<p><code>self</code>命令下目前只需要记住一个命令： <code>self update</code> : 升级 poetry 版本</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ poetry self update</span><br></pre></td></tr></table></figure>\n<h3 id=\"debug-resolve-查看包的依赖关系\"><code>debug resolve</code> : 查看包的依赖关系</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 只查看，不安装</span></span><br><span class=\"line\">$ poetry debug resolve requests</span><br><span class=\"line\">Resolving dependencies... (0.4s)</span><br><span class=\"line\"></span><br><span class=\"line\">Resolution results:</span><br><span class=\"line\"></span><br><span class=\"line\">certifi            2024.8.30</span><br><span class=\"line\">charset-normalizer 3.4.0</span><br><span class=\"line\">idna               3.10</span><br><span class=\"line\">urllib3            2.2.3</span><br><span class=\"line\">requests           2.32.3</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看指定版本的依赖关系</span></span><br><span class=\"line\">$ poetry debug resolve requests@2.32.3</span><br></pre></td></tr></table></figure>\n<h3 id=\"cache-缓存管理\">cache : 缓存管理</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>poetry一个很重要的功能就是缓存安装包，可以 <code>减少</code> 相同的安装包被重复下载。为什么是减少而不是避免呢？因为不同的镜像源的包是分别缓存的。</p>\n</li>\n<li class=\"lvl-2\">\n<p>通过 <code>poetry config --list </code> 可以看到 <code>cache-dir</code> 的地址，这里就是缓存下载包的目录。</p>\n</li>\n<li class=\"lvl-2\">\n<p>以下是一些常见的使用场景</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">解决依赖安装问题：<br>\n如果你在安装或更新依赖时遇到问题（例如，某个包无法正确安装或版本不对），清空缓存可以帮助你确保 Poetry 重新下载所有必要的文件，从而解决问题。</li>\n<li class=\"lvl-6\">清理磁盘空间：<br>\n如果你的项目很多或者经常修改依赖项，缓存可能会变得非常大。使用 poetry cache clear 可以帮助释放磁盘空间，特别是当你不经常使用某些包时。</li>\n<li class=\"lvl-6\">测试最新版本的依赖：<br>\n如果你想测试某个包的新版本是否解决了某个问题，或者想确保你使用的确实是最新的版本，清除缓存可以强制 Poetry 从远程仓库重新下载最新的包。</li>\n<li class=\"lvl-6\">环境变化：<br>\n如果你的开发或生产环境发生了变化（例如，切换了操作系统、更新了 Python 版本等），清除缓存可以帮助你确保依赖项在新环境中正确安装。</li>\n<li class=\"lvl-6\">调试依赖问题：<br>\n在调试依赖项问题时，有时候清除缓存可以帮助你确定问题是否与缓存中的旧版本有关。</li>\n<li class=\"lvl-6\">CI/CD 环境的一致性：<br>\n在持续集成或持续部署 (CI/CD) 环境中，为了确保每次构建都基于最新的依赖，有时会在构建脚本中包含清除缓存的步骤。</li>\n</ul>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看缓存列表，这里会按镜像源进行分组</span></span><br><span class=\"line\">$ poetry cache list</span><br><span class=\"line\">PyPI</span><br><span class=\"line\">_default_cache</span><br><span class=\"line\">tsinghua</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 清除指定源的全部缓存</span></span><br><span class=\"line\">$ poetry cache clear pypi --all</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 清除指定源下某个包的缓存</span></span><br><span class=\"line\">$ poetry cache clear pypi:requests:2.24.0</span><br></pre></td></tr></table></figure>\n","content_text":"摘要 Poetry是一个轻量级的python包管理器，其目标是帮助开发者快速、轻松地构建、发布和分享python包。说它轻量，是与 conda 相比 poetry 更轻量，同时与 venv + pip Python--virtualenv 的方式相比具有如下优点： 使用缓存机制，避免重复下载依赖包 包管理上更加精确，删除不需要的包时会同时删除与其关联的且没有被使用的那些依赖包，避免无用的依赖包造成打包体积过大 打包和发布更加简单，只需要一个命令就可以打包和发布 安装 参考官方文档Installation 1234567891011121314# 官方推荐使用pipx安装，当然也可以使用 pip$ pipx install poetry# 查看是否安装成功$ poetry --versionPoetry (version 1.8.4)# 添加命令自动补全$ mkdir ~/.zfunc$ poetry completions zsh &gt; ~/.zfunc/_poetry# 在 ~/.zshrc 中添加以下配置（我是用的是zsh，其他shell可以参考官方文档）fpath+=~/.zfuncautoload -Uz compinit &amp;&amp; compinit pipx简介 pipx 是一个 Python 包管理工具，使用pipx安装工具包时，每个工具都会被安装在一个独立的虚拟环境中，避免不同工具之间的依赖冲突。 场景：两个工具依赖不同版本的同一个库 假设我们有两个命令行工具： 工具A 依赖于 requests 库的版本 2.27.1。 工具B 依赖于 requests 库的版本 2.31.0。 如果使用 pip 安装 工具会被安装到全局环境，共享相同的依赖版本： 12pip install toolA # 安装时会安装 requests 2.27.1pip install toolB # 安装时会将 requests 升级到 2.31.0 结果： 当你运行工具A时，它可能会报错，因为它依赖的 requests 2.27.1 已被 requests 2.31.0 替换。 全局环境中的所有工具都共享一个 requests，版本冲突不可避免。 如果使用 pipx 安装 每个工具会被安装到独立的虚拟环境中，各自的依赖互不影响： 12pipx install toolA # 在虚拟环境A中安装 toolA 和 requests 2.27.1pipx install toolB # 在虚拟环境B中安装 toolB 和 requests 2.31.0 结果： 虚拟环境A 只包含 toolA 和它的依赖 requests 2.27.1。 虚拟环境B 只包含 toolB 和它的依赖 requests 2.31.0。 工具之间完全隔离，不会因为依赖版本冲突而导致问题。 所以，当需要安装全局命令行工具时，使用pipx是个很好的选择 pipx 的安装 123456789101112131415# 安装pipxpip install pipx# 配置环境变量，运行该命令会将pipx ensurepath# 运行上面的命令会将如下内容加入你的shell配置文件中，我的是 .zshrc 文件，实际上你也可以手工添加该配置，将$HOME/.local/bin放到前面更好一些。export PATH=&quot;$PATH:$HOME/.local/bin&quot;# 注意添加完成后要重启shell# 添加pipx自动代码补全# 运行如下命令，并根据提示完成pipx completions# 我的是zsh，所以在 .zshrc中添加如下内容autoload -Uz compinit &amp;&amp; compinit # 如果没有添加过就需要先添加这个eval &quot;$(register-python-argcomplete pipx)&quot; # 添加自动代码补全# 注意添加完成后要重启shell 查看所有命令 我已经将其翻译为中文 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667$ poetry listPoetry (版本 1.8.4)用法： command [选项] [参数]选项： -h, --help 显示给定命令的帮助。如果没有指定命令，则显示列表命令的帮助。 -q, --quiet 不输出任何消息。 -V, --version 显示此应用程序版本。 --ansi 强制输出ANSI格式。 --no-ansi 禁用ANSI输出。 -n, --no-interaction 不要提问任何交互性问题。 --no-plugins 禁用插件。 --no-cache 禁用源缓存。 -C, --directory=目录 Poetry命令的工作目录（默认为当前工作目录）。 -v|vv|vvv, --verbose 增加消息的冗长度：1 表示正常输出，2 表示更详细的输出，3 表示调试。可用命令： about 显示关于Poetry的信息。 add 将新依赖项添加到pyproject.toml并安装它。 build 默认构建一个包，分别是tarball和wheel。 check 验证pyproject.toml文件的内容及其与poetry.lock文件的一致性。 config 管理配置设置。 export 将锁文件导出到其他格式。 help 显示特定命令的帮助。 init 在当前目录创建一个基础的pyproject.toml文件。 install 安装项目依赖项。 list 列出命令。 lock 锁定项目依赖项。 new 在&lt;path&gt;处创建一个新的Python项目。 publish 将包发布到远程仓库。 remove 从项目依赖项中移除包。 run 在适当的环境中运行命令。 search 在远程仓库中搜索包。 shell 在虚拟环境中启动shell。 show 显示有关包的信息。 update 根据pyproject.toml文件更新依赖项。 version 显示项目的版本或在提供有效版本规则时更新它。缓存 cache clear 按名称清除Poetry缓存。 cache list 列出Poetry的缓存列表。调试 debug info 显示调试信息。 debug resolve 调试依赖项解析。环境 env info 显示当前环境的信息。 env list 列出与当前项目关联的所有虚拟环境。 env remove 移除与项目关联的虚拟环境。 env use 激活或创建当前项目的新的虚拟环境。自身 self add 向Poetry的运行时环境添加其他包。 self install 安装此Poetry安装所需的锁定包（包括插件）。 self lock 锁定Poetry安装的系统要求。 self remove 从Poetry的运行时环境中移除其他包。 self show 显示Poetry运行时环境中的包。 self show plugins 显示当前已安装插件的信息。 self update 更新Poetry到最新版本。源 source add 为项目添加源配置。 source remove 移除为项目配置的源。 source show 显示为项目配置的源信息。 常用命令 这里只对日常开发中比较常用的命令进行简要说明，详细介绍可以参考官方文档 new : 创建项目 12345678910111213141516171819202122232425262728293031# 按照默认规则创建一个基于 poetry 的项目$ poetry new my-projectCreated package my_project in my-project$ cd my-project# 查看生成的目录结构$ exa -T.├── my_project│ └── __init__.py├── pyproject.toml├── README.md└── tests └── __init__.py# 查看 pyproject.toml 内容，该文件为项目的配置的配置文件$ more pyproject.toml[tool.poetry]name = &quot;my-project&quot;version = &quot;0.1.0&quot;description = &quot;&quot;authors = [&quot;hanqunfeng &lt;hanqf2008@163.com&gt;&quot;]readme = &quot;README.md&quot;[tool.poetry.dependencies]python = &quot;^3.11&quot;[build-system]requires = [&quot;poetry-core&quot;]build-backend = &quot;poetry.core.masonry.api&quot; init : 初始化一个已有的项目目录 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647# 假设我们已经有个项目目录，目录名称为 poetryDemo$ cd poetryDemo# 初始化 poetryDemo ，在当前目录下创建 pyproject.toml 文件，注意该操作只会创建该文件，包目录以及readme文件都没有，需要手工创建$ poetry initThis command will guide you through creating your pyproject.toml config.Package name [poetrydemo]: # 包名称Version [0.1.0]: # 版本号Description []: # 描述信息Author [hanqunfeng &lt;hanqf2008@163.com&gt;, n to skip]: # 作者License []: # LicenseCompatible Python versions [^3.11]: # python 版本Would you like to define your main dependencies interactively? (yes/no) [yes] # 您想以交互方式定义您的主环境依赖关系吗？默认yesYou can specify a package in the following forms: # 您可以按以下形式指定包： - A single name (requests): this will search for matches on PyPI # 单个名称（requests）：这将在官方仓库PyPI上搜索匹配项，如果指定了其它镜像源就会从指定的源下载 - A name and a constraint (requests@^2.23.0) # 名称和版本约束 - A git url (git+https://github.com/python-poetry/poetry.git) # git地址 - A git url with a revision (git+https://github.com/python-poetry/poetry.git#develop) # git地址，指定某个分支 - A file path (../my-package/my-package.whl) # 文件路径 - A directory (../my-package/) # 目录路径 - A url (https://example.com/packages/my-package-0.1.0.tar.gz) # 一个安装包的地址Package to add or search for (leave blank to skip): # 添加主环境依赖，按上面的格式要求填写Would you like to define your development dependencies interactively? (yes/no) [yes] # 您想以交互方式定义您的开发依赖关系吗？默认yesPackage to add or search for (leave blank to skip): # 添加开发环境依赖，按上面的格式要求填写Generated file# 要生成的 pyproject.toml 内容[tool.poetry]name = &quot;poetrydemo&quot; # 包名称version = &quot;0.1.0&quot; # 版本description = &quot;&quot; # 描述信息authors = [&quot;hanqunfeng &lt;hanqf2008@163.com&gt;&quot;] # 作者信息readme = &quot;README.md&quot; # 说明文件[tool.poetry.dependencies] # 主环境依赖python = &quot;^3.11&quot;[build-system]requires = [&quot;poetry-core&quot;]build-backend = &quot;poetry.core.masonry.api&quot;Do you confirm generation? (yes/no) [yes] # 确认是否按照上面的内容创建 pyproject.toml 文件，默认yes 上面的方式在初始化时会询问你相关的信息，如果你希望都用默认值的话，可以使用如下命令 1poetry init -n config : poetry的全局配置 查看全局配置 12345678910111213141516171819$ poetry config --listcache-dir = &quot;/Users/hanqf/Library/Caches/pypoetry&quot; # 缓存目录,用于存储项目依赖和虚拟环境等缓存信息。experimental.system-git-client = false # 是否使用系统自带的git客户端,false表示使用Poetry内置的git客户端installer.max-workers = null # 安装依赖时的最大线程数,null表示使用默认线程数，可以设置为cpu核数+4installer.modern-installation = true # 是否使用Poetry的现代安装方案,true表示使用installer.no-binary = null # 是否不使用预编译的二进制包,null表示不限制installer.parallel = true # 是否并行安装依赖,true表示并行安装keyring.enabled = true # 是否启用密钥环（keyring）以保存认证信息。true 表示启用。solver.lazy-wheel = true # 是否延迟解析 wheel 包。true 表示延迟解析。virtualenvs.create = true # 是否自动创建虚拟环境,true表示创建virtualenvs.in-project = null # 是否在项目内创建虚拟环境，null 表示使用默认值（通常为 false），即不在项目中创建。true表示在项目中创建virtualenvs.options.always-copy = false # 如果设置为 true，Poetry 会始终复制文件到虚拟环境中，而不是使用符号链接（symlinks）。这可以避免某些系统上的权限问题，但会增加虚拟环境的存储需求。virtualenvs.options.no-pip = false # 如果设置为 true，Poetry 在创建虚拟环境时不会安装 pip。如果你的项目不需要直接使用 pip，并且你希望通过 Poetry 管理所有的依赖项，可以将 no-pip 设置为 true，以减少虚拟环境中的不必要的依赖项。virtualenvs.options.no-setuptools = false # 如果设置为 true，Poetry 在创建虚拟环境时不会安装 setuptools。默认情况下，Poetry 会安装 pip 和 setuptools，以便你可以使用这些工具来管理依赖项。virtualenvs.options.system-site-packages = false # 默认值false，此时 Poetry 创建的虚拟环境将不会包含全局 Python 安装的 site-packages 目录中的包。这有助于确保项目依赖项的隔离性，避免与系统中的其他包发生冲突。virtualenvs.path = &quot;&#123;cache-dir&#125;/virtualenvs&quot; # /Users/hanqf/Library/Caches/pypoetry/virtualenvs # 虚拟环境存放的路径，如果virtualenvs.in-project设置为true，就只会在项目中创建virtualenvs.prefer-active-python = false # 是否优先使用系统激活的Python解释器virtualenvs.prompt = &quot;&#123;project_name&#125;-py&#123;python_version&#125;&quot; # 虚拟环境的命令提示格式warnings.export = true # 是否在导出时显示警告信息。true 表示显示 修改全局配置 1234567891011121314151617# 修改全局配置，此后会在项目目录下创建 .venv 目录存放虚拟环境$ poetry config virtualenvs.in-project true# 进入虚拟环境，如果虚拟环境尚未创建会自动创建$ poetry shell# 退出虚拟环境$ exit# 只对当前项目有效，此时会在当前项目目录下创建 poetry.toml 来保存这些配置信息$ poetry config virtualenvs.in-project true --local$ poetry config virtualenvs.options.system-site-packages true --local$ more poetry.toml[virtualenvs]in-project = true[virtualenvs.options]system-site-packages = true# 这里要注意 virtualenvs 下的属性必须在创建虚拟环境前设置才会有效 env : 虚拟环境管理 Poetry 会在你第一次运行某些命令（如 poetry shell 或者 poetry add somepackage）时自动创建虚拟环境。 不过这种时候都是使用系统默认的python来创建虚拟环境，如果系统中安装了多个python，则可以通过如下方式设置虚拟环境要使用哪个python版本 创建/切换虚拟环境 123456789# 指定python的版本，这会从python的默认安装路径下查找对应的版本# 比如macOs会从该路径下查找：/Library/Frameworks/Python.framework/Versions$ poetry env use 3.11# 如果可以直接在命令行使用python命令,比如：python3.12 -V，则可以使用如下方式创建虚拟环境$ poetry env use python3.12# 如果python安装到了其它路径，可以指定python安装路径$ poetry env use /pythonDir/3.13/bin/python3 查看当前项目的虚拟环境信息 12345678910111213141516171819202122232425262728293031323334353637383940# 创建一个基于 python3.13 的虚拟环境$ poetry env use python3.13Creating virtualenv poetrydemo-fyqYbfje-py3.13 in /Users/hanqf/Library/Caches/pypoetry/virtualenvsUsing virtualenv: /Users/hanqf/Library/Caches/pypoetry/virtualenvs/poetrydemo-fyqYbfje-py3.13# 再创建一个基于 python3.11 的虚拟环境，最后被use的处于默认激活状态$ poetry env use python3.11Creating virtualenv poetrydemo-fyqYbfje-py3.11 in /Users/hanqf/Library/Caches/pypoetry/virtualenvsUsing virtualenv: /Users/hanqf/Library/Caches/pypoetry/virtualenvs/poetrydemo-fyqYbfje-py3.11# 查看当前项目有多少个虚拟环境$ poetry env listpoetrydemo-fyqYbfje-py3.11 (Activated) # poetrydemo-fyqYbfje-py3.11 表示虚拟环境名称，Activated表示当前虚拟环境已经被激活poetrydemo-fyqYbfje-py3.13# 查看虚拟化环境路径$ poetry env list --full-path/Users/hanqf/Library/Caches/pypoetry/virtualenvs/poetrydemo-fyqYbfje-py3.11 (Activated)# 查看当前激活的虚拟环境信息$ poetry env infoVirtualenvPython: 3.11.3Implementation: CPythonPath: /Users/hanqf/Library/Caches/pypoetry/virtualenvs/poetrydemo-fyqYbfje-py3.11Executable: /Users/hanqf/Library/Caches/pypoetry/virtualenvs/poetrydemo-fyqYbfje-py3.11/bin/pythonValid: TrueBasePlatform: darwinOS: posixPython: 3.11.3Path: /Library/Frameworks/Python.framework/Versions/3.11Executable: /Library/Frameworks/Python.framework/Versions/3.11/bin/python3.11# 删除虚拟环境$ poetry env remove python3.13Deleted virtualenv: /Users/hanqf/Library/Caches/pypoetry/virtualenvs/poetrydemo-fyqYbfje-py3.13# 删除全部虚拟环境$ poetry env remove --all 注意，当virtualenvs.in-project被设置为true时，即只在项目目录下创建虚拟环境时，只会保留一个环境，即.venv 切换到新的虚拟环境时会全新创建一个新的环境，原先的环境会被删除，所以要使用poetry install命令重新安装依赖 123456789101112131415161718192021222324$ poetry env use python3.11Recreating virtualenv poetrydemo in /Users/hanqf/Desktop/pythonDir/poetryDir/poetryDemo/.venvUsing virtualenv: /Users/hanqf/Desktop/pythonDir/poetryDir/poetryDemo/.venv$ poetry env list # 虽然可以通过 poetry env use 的方式来创建新的虚拟环境，但实际上只会有一个环境被保留，所以这里只会显示一个.venv (Activated) # .venv 表示虚拟环境名称，Activated表示当前虚拟环境已经被激活# 查看虚拟环境信息$ poetry env infoVirtualenvPython: 3.11.3Implementation: CPythonPath: /Users/hanqf/Desktop/pythonDir/poetryDir/poetryDemo/.venvExecutable: /Users/hanqf/Desktop/pythonDir/poetryDir/poetryDemo/.venv/bin/pythonValid: TrueBasePlatform: darwinOS: posixPython: 3.11.3Path: /Library/Frameworks/Python.framework/Versions/3.11Executable: /Library/Frameworks/Python.framework/Versions/3.11/bin/python3.11 依赖包管理 add : 安装依赖包 这个命令会修改 pyproject.toml 文件，在 [tool.poetry.dependencies] 部分添加新的依赖项。还会自动更新 poetry.lock 文件，锁定依赖的确切版本。 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556# 安装依赖，安装后会将依赖信息写入 pyproject.toml 中# 不指定版本则安装最新版$ poetry add fastapiUsing version ^0.115.5 for fastapiUpdating dependenciesResolving dependencies... (1.3s)Package operations: 9 installs, 0 updates, 0 removals - Installing idna (3.10) - Installing sniffio (1.3.1) - Installing typing-extensions (4.12.2) - Installing annotated-types (0.7.0) - Installing anyio (4.6.2.post1) - Installing pydantic-core (2.23.4) - Installing pydantic (2.9.2) - Installing starlette (0.41.3) - Installing fastapi (0.115.5)Writing lock file# 指定版本号安装依赖poetry add package_name@^1.2.3 # 规则说明 ^1.2.3 表示兼容 1.2.3 及更高的小版本，但不包括 2.0.0。 如：poetry add requests@^2.28.0 ~1.2.3：允许升级到 1.2.x，但不包括 1.3.0。 如：poetry add requests@~2.28.0 1.2.3：固定为 1.2.3。 如：poetry add requests@2.28.0 &gt;=1.2.3：允许使用 1.2.3 及以上版本。注意zsh下要加上双引号，如：poetry add &quot;requests@&gt;=2.28.0&quot; &lt;2.0.0：允许使用小于 2.0.0 的版本。 注意zsh下要加上双引号，如：poetry add &quot;requests@&lt;3.0.0&quot;# 安装到指定的分组，默认都是安装到主环境中的，poetry build默认只会打包主环境的依赖poetry add flask # 安装到主环境中poetry add flask --group=test #添加分组名 testpoetry add flask --dev #相当于--group=dev# 分别执行上面3个安装命令后，输出 pyproject.toml 的内容如下[tool.poetry]name = &quot;poetrydemo&quot;version = &quot;0.1.0&quot;description = &quot;&quot;authors = [&quot;hanqunfeng &lt;hanqf2008@163.com&gt;&quot;]readme = &quot;README.md&quot;[tool.poetry.dependencies] # 主环境python = &quot;^3.11&quot;flask = &quot;^3.1.0&quot;[tool.poetry.group.test.dependencies] # test分组依赖flask = &quot;^3.1.0&quot;[tool.poetry.group.dev.dependencies] # dev分组依赖flask = &quot;^3.1.0&quot;[build-system]requires = [&quot;poetry-core&quot;]build-backend = &quot;poetry.core.masonry.api&quot; show : 查看依赖包 123456789101112131415# 查看当前项目都需要哪些依赖，这些依赖不一定都安装了，它只是解析 pyproject.toml 中的声明来解析依赖树$ poetry showannotated-types 0.7.0 Reusable constraint types to use with typing.Annotatedanyio 4.6.2.post1 High level compatibility layer for multiple asynchronous ...fastapi 0.115.5 FastAPI framework, high performance, easy to learn, fast ...idna 3.10 Internationalized Domain Names in Applications (IDNA)pydantic 2.9.2 Data validation using Python type hintspydantic-core 2.23.4 Core functionality for Pydantic validation and serializationsniffio 1.3.1 Sniff out which async library your code is running understarlette 0.41.3 The little ASGI library that shines.typing-extensions 4.12.2 Backported and Experimental Type Hints for Python 3.8+# 只查看顶级依赖，即只查看在 pyproject.toml 中声明的依赖$ poetry show --top-levelfastapi 0.115.5 FastAPI framework, high performance, easy to learn, fast ... remove : 删除依赖包 123456789101112131415161718# 删除依赖，此时会将当前包及其所有依赖一块删除$ poetry remove fastapiUpdating dependenciesResolving dependencies... (0.1s)Package operations: 0 installs, 0 updates, 9 removals - Removing annotated-types (0.7.0) - Removing anyio (4.6.2.post1) - Removing fastapi (0.115.5) - Removing idna (3.10) - Removing pydantic (2.9.2) - Removing pydantic-core (2.23.4) - Removing sniffio (1.3.1) - Removing starlette (0.41.3) - Removing typing-extensions (4.12.2)Writing lock file search : 搜索远程仓库 12# 搜索远程仓库$ poetry search fastapi install 和 update : 安装和更新依赖包 在 Poetry 中，install 和 update 是两个常用的命令，但它们的作用和使用场景不同 poetry install 的作用是根据现有的 poetry.lock 文件来安装依赖，确保安装的依赖版本与锁文件中记录的版本完全一致。 核心特点： 安装锁定的版本：它只会安装 poetry.lock 文件中指定的版本，即使 pyproject.toml 文件中定义的版本范围已经有更新版本。 重现依赖环境：适用于团队协作或部署环境，确保所有人或机器安装的依赖版本完全相同。 锁文件存在时更高效：如果 poetry.lock 文件存在，poetry install 不会重新解析依赖树。 首次运行时生成锁文件：如果没有 poetry.lock 文件，poetry install 会解析依赖并生成锁文件。 使用场景： 新克隆的项目，需要安装依赖环境。 部署生产环境，确保依赖版本的稳定性。 重新安装之前已定义的依赖（例如清空了虚拟环境）。 poetry update 的作用是根据 pyproject.toml 文件中定义的依赖范围重新解析依赖树，并更新 poetry.lock 文件为最新的版本。 核心特点： 更新到最新版本：它会尝试安装依赖范围内的最新版本，并更新 poetry.lock 文件。 解析新的依赖树：即使 poetry.lock 文件存在，poetry update 也会忽略它并重新解析依赖。 更改锁文件：它会覆盖现有的 poetry.lock 文件，因此团队其他成员需要重新运行 poetry install 以同步。 使用场景： 更新依赖到最新版本（在依赖范围内）。 当添加新依赖后，想要安装并更新锁文件。 修复可能的版本冲突或不兼容问题。 lock : 锁定依赖包 poetry lock 是 Poetry（一个 Python 包管理工具）中的一个命令，用于锁定项目的依赖关系。使用这个命令可以创建或更新 poetry.lock 文件，确保你的项目中所使用的每个包的版本都被明确记录下来。这样做对于项目的可复现性和稳定性至关重要。 实际上，当运行 poetry install 、 poetry update 或者 poetry add 等命令时， poetry 都会根据 pyproject.toml 文件中的依赖范围，解析依赖树，并在项目目录下创建或更新 poetry.lock 文件。 当我们手工修改了 pyproject.toml 文件中的依赖范围，此时又不想立刻更新依赖，而是希望在某个时机再更新，此时就可以使用 poetry lock 命令，先锁定这些依赖，之后再通过 poetry install 命令安装。 可以使用 poetry check 命令检查 pyproject.toml 文件 与 poetry.lock 文件的一致性。 12345678910111213# 比如我手工删除了 `pyproject.toml` 文件中的某个依赖# 此时运行 check 检查一致性会报错$ poetry checkError: pyproject.toml changed significantly since poetry.lock was last generated. Run `poetry lock [--no-update]` to fix the lock file.# 锁定依赖$ poetry lockUpdating dependenciesResolving dependencies... (0.1s)Writing lock file# 检查一致性通过$ poetry checkAll set! 小贴士 注意，此时通过 poetry show 查看不到那个手工删除的依赖包，但实际上依赖依旧在于虚拟环境中 所以尽量避免手工删除依赖，而是通过 poetry remove 命令来删除依赖 source : 镜像源管理 默认情况下都是从Pypi的官方仓库下载，国内一般需要指定镜像源来加速下载 123456789101112131415161718192021222324252627282930313233# 添加镜像源，默认就是主要源，注意该方式只对当前项目有效# 命令格式：poetry source add [选项] [--] &lt;name&gt; [&lt;url&gt;]，name：源仓库的名称，url：源仓库的 URL$ poetry source add tsinghua https://pypi.tuna.tsinghua.edu.cn/simpleAdding source with name tsinghua.# --priority=PRIORITY设置此源的优先级。可以是以下值之一：default（默认）、primary（主要）、supplemental（备用）、explicit（显式源，只有当包明确声明使用该源时才会被使用）。默认为 primary。$ poetry source add --priority=supplemental aliyun http://mirrors.aliyun.com/pypi/simple/# 查看镜像源信息$ poetry source show name : tsinghua url : https://pypi.tuna.tsinghua.edu.cn/simple priority : primary name : aliyun url : http://mirrors.aliyun.com/pypi/simple/ priority : supplemental# 此时查看 pyproject.toml 文件可以看到镜像源信息[[tool.poetry.source]]name = &quot;tsinghua&quot;url = &quot;https://pypi.tuna.tsinghua.edu.cn/simple&quot;priority = &quot;primary&quot;[[tool.poetry.source]]name = &quot;aliyun&quot;url = &quot;http://mirrors.aliyun.com/pypi/simple/&quot;priority = &quot;supplemental&quot;# 删除镜像源$ poetry source remove aliyun # 指定镜像源名称Removing source with name aliyun. 运行 这里以一个小示例来说明这个功能 创建一个新的项目 123456789101112131415161718192021$ poetry new poetryDemoCreated package poetrydemo in poetryDemo# 进入项目目录$ cd poetryDemo# 查看生成的文件$ lltotal 8drwxr-xr-x 6 hanqf staff 192 11 21 17:32 .drwxr-xr-x 4 hanqf staff 128 11 21 17:32 ..-rw-r--r-- 1 hanqf staff 0 11 21 17:32 README.mddrwxr-xr-x 3 hanqf staff 96 11 21 17:32 poetrydemo-rw-r--r-- 1 hanqf staff 266 11 21 17:32 pyproject.tomldrwxr-xr-x 3 hanqf staff 96 11 21 17:32 tests# 进入包目录$ cd poetrydemo# 查看包目录下的文件$ lltotal 0drwxr-xr-x 3 hanqf staff 96 11 21 17:32 .drwxr-xr-x 6 hanqf staff 192 11 21 17:32 ..-rw-r--r-- 1 hanqf staff 0 11 21 17:32 __init__.py 在包目录下创建 array_util.py，内容如下 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152import numpy as npdef generate_random_array(shape, distribution=&quot;uniform&quot;, params=None, seed=None): &quot;&quot;&quot; 生成随机数组的工具方法。 :param shape: tuple，指定数组的形状，例如 (3, 4) 表示 3 行 4 列。 :param distribution: str，指定随机数分布类型，可选值： - &quot;uniform&quot;：均匀分布（默认）。 - &quot;normal&quot;：正态分布。 - &quot;integer&quot;：随机整数。 :param params: dict，分布的参数配置： - 均匀分布：&#123;&quot;low&quot;: 最小值, &quot;high&quot;: 最大值&#125;，默认 low=0, high=1。 - 正态分布：&#123;&quot;mean&quot;: 均值, &quot;std&quot;: 标准差&#125;，默认 mean=0, std=1。 - 随机整数：&#123;&quot;low&quot;: 最小值, &quot;high&quot;: 最大值, &quot;dtype&quot;: 类型&#125;，默认 low=0, high=10。 :param seed: int，随机数种子（可选），用于结果可复现。 :return: np.ndarray，生成的随机数组。 &quot;&quot;&quot; if seed is not None: np.random.seed(seed) if params is None: params = &#123;&#125; if distribution == &quot;uniform&quot;: low = params.get(&quot;low&quot;, 0) high = params.get(&quot;high&quot;, 1) return np.random.uniform(low, high, size=shape) elif distribution == &quot;normal&quot;: mean = params.get(&quot;mean&quot;, 0) std = params.get(&quot;std&quot;, 1) return np.random.normal(mean, std, size=shape) elif distribution == &quot;integer&quot;: low = params.get(&quot;low&quot;, 0) high = params.get(&quot;high&quot;, 10) dtype = params.get(&quot;dtype&quot;, int) return np.random.randint(low, high, size=shape, dtype=dtype) else: raise ValueError(&quot;不支持的分布类型！可选值为 &#x27;uniform&#x27;, &#x27;normal&#x27;, &#x27;integer&#x27;。&quot;)# 示例用法if __name__ == &quot;__main__&quot;: array_uniform = generate_random_array((3, 4), distribution=&quot;uniform&quot;, params=&#123;&quot;low&quot;: 1, &quot;high&quot;: 10&#125;) array_normal = generate_random_array((2, 3), distribution=&quot;normal&quot;, params=&#123;&quot;mean&quot;: 0, &quot;std&quot;: 1&#125;, seed=42) array_integer = generate_random_array((4, 5), distribution=&quot;integer&quot;, params=&#123;&quot;low&quot;: 0, &quot;high&quot;: 20&#125;) print(&quot;均匀分布随机数组：\\n&quot;, array_uniform) print(&quot;正态分布随机数组：\\n&quot;, array_normal) print(&quot;随机整数数组：\\n&quot;, array_integer) 安装依赖 1234567891011$ poetry add numpyUsing version ^2.1.3 for numpyUpdating dependenciesResolving dependencies... (1.1s)Package operations: 1 install, 0 updates, 0 removals - Installing numpy (2.1.3)Writing lock file 运行，两种方法 poetry run 12345678910111213$ poetry run python array_util.py均匀分布随机数组：[[7.44623063 1.89415788 4.81008329 4.25556572][3.31925154 6.44037063 5.3216543 7.54950573][3.97160747 5.04800698 3.28299934 3.42841887]]正态分布随机数组：[[ 0.49671415 -0.1382643 0.64768854][ 1.52302986 -0.23415337 -0.23413696]]随机整数数组：[[10 10 3 7 2][ 1 11 5 1 0][11 11 16 9 15][14 14 18 11 19]] poetry shell : 此时会开启一个新的shell，并开启虚拟环境 1234567# 开启虚拟环境$ poetry shellSpawning shell within /Users/hanqf/Library/Caches/pypoetry/virtualenvs/poetrydemo-fyqYbfje-py3.11Restored session: 2024年11月21日 星期四 15时31分52秒 CST➜ poetrydemo emulate bash -c &#x27;. /Users/hanqf/Library/Caches/pypoetry/virtualenvs/poetrydemo-fyqYbfje-py3.11/bin/activate&#x27;# 在虚拟环境下运行$ python array_util.py 打包和发布 接着上面的项目 打包 123456789101112# 会在项目目录下创建 dist 目录，并将打好的包存放于此$ poetry buildBuilding poetrydemo (0.1.0) - Building sdist - Built poetrydemo-0.1.0.tar.gz - Building wheel - Built poetrydemo-0.1.0-py3-none-any.whl# 查看生成的打包文件$ exa -1 disthqf_poetrydemo-0.1.0-py3-none-any.whlhqf_poetrydemo-0.1.0.tar.gz 发布 首先要先在PyPI上注册个帐号，需要开启“双要素身份验证 （2FA）”，否则不能获取发布时的API令牌。 获取API令牌 发布，不过这次发布提示包名已经存在了 123456# 发布时提示包名已经存在了$ poetry publish -u __token__ -p pypi-AgEIcHlwaS5vcmcCJDU0Y2Q5NjhkLWYyYTEtNPublishing poetrydemo (0.1.0) to PyPI - Uploading poetrydemo-0.1.0-py3-none-any.whl FAILEDHTTP Error 400: The name &#x27;poetrydemo&#x27; is too similar to an existing project. See https://pypi.org/help/#project-name for more information. | b&quot;&lt;html&gt;\\n &lt;head&gt;\\n &lt;title&gt;400 The name &#x27;poetrydemo&#x27; is too similar to an existing project. See https://pypi.org/help/#project-name for more information.\\n \\n &lt;body&gt;\\n &lt;h1&gt;400 The name &#x27;poetrydemo&#x27; is too similar to an existing project. See https://pypi.org/help/#project-name for more information.\\n The server could not comply with the request since it is either malformed or otherwise incorrect.&lt;br/&gt;&lt;br/&gt;\\nThe name &amp;#x27;poetrydemo&amp;#x27; is too similar to an existing project. See https://pypi.org/help/#project-name for more information.\\n\\n\\n \\n&quot; 先修改包名，直接编辑 pyproject.toml 即可，将name属性修改为“hqf_poetrydemo”，然后将包目录的名称也修改为这个mv poetrydemo hqf_poetrydemo，并删除dist目录，之后重新打包poetry build，再次发布 1234567891011121314151617$ vim pyproject.toml # 将name属性修改为“hqf_poetrydemo”$ mv poetrydemo hqf_poetrydemo # 将包目录的名称也修改为这个$ rm -rf dist # 删除dist目录$ poetry build # 重新打包Creating virtualenv hqf-poetrydemo-fyqYbfje-py3.11 in /Users/hanqf/Library/Caches/pypoetry/virtualenvsBuilding hqf_poetrydemo (0.1.0) - Building sdist - Built hqf_poetrydemo-0.1.0.tar.gz - Building wheel - Built hqf_poetrydemo-0.1.0-py3-none-any.whl# 再次发布$ poetry publish -u __token__ -p pypi-AgEIcHlwaS5vcmcCJDU0Y2Q5NjhkLWYyYTEtNPublishing hqf_poetrydemo (0.1.0) to PyPI - Uploading hqf_poetrydemo-0.1.0-py3-none-any.whl 100% - Uploading hqf_poetrydemo-0.1.0.tar.gz 100% 之后就可以在其它项目中安装这个包了 12345678910111213141516# pip install$ pip install hqf_poetrydemo# poetry add$ poetry add hqf_poetrydemoUsing version ^0.1.0 for hqf-poetrydemoUpdating dependenciesResolving dependencies... (0.5s)Package operations: 2 installs, 0 updates, 0 removals - Installing numpy (2.1.3) - Installing hqf-poetrydemo (0.1.0)Writing lock file self update : 升级 poetry 版本 self 相关命令主要用于 poetry 自身安装插件使用 估计插件功能目前还不成熟，官网也没有进行详细的说明，并且 windows 下无法使用，所以这里不讨论。 self命令下目前只需要记住一个命令： self update : 升级 poetry 版本 1$ poetry self update debug resolve : 查看包的依赖关系 1234567891011121314# 只查看，不安装$ poetry debug resolve requestsResolving dependencies... (0.4s)Resolution results:certifi 2024.8.30charset-normalizer 3.4.0idna 3.10urllib3 2.2.3requests 2.32.3# 查看指定版本的依赖关系$ poetry debug resolve requests@2.32.3 cache : 缓存管理 poetry一个很重要的功能就是缓存安装包，可以 减少 相同的安装包被重复下载。为什么是减少而不是避免呢？因为不同的镜像源的包是分别缓存的。 通过 poetry config --list 可以看到 cache-dir 的地址，这里就是缓存下载包的目录。 以下是一些常见的使用场景 解决依赖安装问题： 如果你在安装或更新依赖时遇到问题（例如，某个包无法正确安装或版本不对），清空缓存可以帮助你确保 Poetry 重新下载所有必要的文件，从而解决问题。 清理磁盘空间： 如果你的项目很多或者经常修改依赖项，缓存可能会变得非常大。使用 poetry cache clear 可以帮助释放磁盘空间，特别是当你不经常使用某些包时。 测试最新版本的依赖： 如果你想测试某个包的新版本是否解决了某个问题，或者想确保你使用的确实是最新的版本，清除缓存可以强制 Poetry 从远程仓库重新下载最新的包。 环境变化： 如果你的开发或生产环境发生了变化（例如，切换了操作系统、更新了 Python 版本等），清除缓存可以帮助你确保依赖项在新环境中正确安装。 调试依赖问题： 在调试依赖项问题时，有时候清除缓存可以帮助你确定问题是否与缓存中的旧版本有关。 CI/CD 环境的一致性： 在持续集成或持续部署 (CI/CD) 环境中，为了确保每次构建都基于最新的依赖，有时会在构建脚本中包含清除缓存的步骤。 1234567891011# 查看缓存列表，这里会按镜像源进行分组$ poetry cache listPyPI_default_cachetsinghua# 清除指定源的全部缓存$ poetry cache clear pypi --all# 清除指定源下某个包的缓存$ poetry cache clear pypi:requests:2.24.0","summary":"摘要 Poetry是一个轻量级的python包管理器，其目标是帮助开发者快速、轻松地构建、发布和分享python包。说它轻量，是与 conda 相比 poetry 更轻量，同时与 venv + pip Python--virtualenv 的方式相比具有如下优点： 使用缓存机制，避免重复下载依赖包 包管理上更加精确，删除不需要的包时会同时删除与其关联的且没有被使用的那些依赖包，避免无用的依赖包造成打包体积过大 打包和发布更加简单，只需要一个命令就可以打包和发布","date_published":"2024-11-22T15:33:15.000Z","tags":["技术","Python"]},{"id":"https://blog.hanqunfeng.com/2024/11/18/python_pip/","url":"https://blog.hanqunfeng.com/2024/11/18/python_pip/","title":"pip--CERTIFICATE_VERIFY_FAILED","content_html":"<h2 id=\"摘要\">摘要</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">测试环境：macOS 13.7.1，Python 3.11.3</li>\n<li class=\"lvl-2\">今天将<code>pip</code>升级(<code>pip install --upgrade pip</code>)到<code>24.3.1</code>版本后，通过<code>pip install</code>命令安装依赖时会报错，比如：</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ pip install certifi</span><br><span class=\"line\">Could not fetch URL https://pypi.org/simple/certifi/: There was a problem confirming the ssl certificate: HTTPSConnectionPool(host=<span class=\"string\">&#x27;pypi.org&#x27;</span>, port=443): Max retries exceeded with url: /simple/certifi/ (Caused by SSLError(SSLCertVerificationError(1, <span class=\"string\">&#x27;[SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: unable to get local issuer certificate (_ssl.c:1002)&#x27;</span>))) - skipping</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">很奇怪，从<code>pip</code>自己的网站上下载依赖都会出现证书无法验证的错误。测试了一下，该问题只在macOS上遇到，其他平台没有遇到过。</li>\n<li class=\"lvl-2\">先说结论，推荐使用第五种方法。</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"解决方法\">解决方法</h2>\n<h3 id=\"1-trusted-host-忽略证书验证\">1. <code>--trusted-host</code>: 忽略证书验证</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>指定信任的证书域名，从而不进行验证证书，可以指定多个</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pip install certifi --trusted-host pypi.org --trusted-host files.pythonhosted.org</span><br></pre></td></tr></table></figure>\n<h3 id=\"2-cert-指定证书文件\">2. <code>--cert</code>: 指定证书文件</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>此时需要先下载证书文件，用Chrome浏览器打开<a href=\"https://pypi.org\">https://pypi.org</a>，按如下步骤导出证书文件<br>\n<img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/tMocyD.png\" alt=\"\" width=\"300\" height=\"300\"><br>\n<img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/uS4W2W.png\" alt=\"\" width=\"300\" height=\"300\"><br>\n<img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/OiZf9R.png\" alt=\"\" width=\"400\" height=\"500\"><br>\n<img src=\"https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/JHw2ML.png\" alt=\"\" width=\"400\" height=\"300\"></p>\n</li>\n<li class=\"lvl-2\">\n<p>然后再执行如下命令进行安装</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pip install certifi --cert ~/Downloads/GlobalSign.pem</span><br></pre></td></tr></table></figure>\n<h3 id=\"3-pip-conf-配置全局证书文件\">3. <code>pip.conf</code>: 配置全局证书文件</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>还是需要先下载证书文件，参考上面方法</p>\n</li>\n<li class=\"lvl-2\">\n<p><code>pip</code> 的配置文件位置因操作系统而异。可以通过以下命令找到配置文件路径：</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 我使用的是 macOS</span></span><br><span class=\"line\">$ pip config -v list</span><br><span class=\"line\">For variant <span class=\"string\">&#x27;global&#x27;</span>, will try loading <span class=\"string\">&#x27;/Library/Application Support/pip/pip.conf&#x27;</span></span><br><span class=\"line\">For variant <span class=\"string\">&#x27;user&#x27;</span>, will try loading <span class=\"string\">&#x27;/Users/hanqf/.pip/pip.conf&#x27;</span></span><br><span class=\"line\">For variant <span class=\"string\">&#x27;user&#x27;</span>, will try loading <span class=\"string\">&#x27;/Users/hanqf/.config/pip/pip.conf&#x27;</span></span><br><span class=\"line\">For variant <span class=\"string\">&#x27;site&#x27;</span>, will try loading <span class=\"string\">&#x27;/Library/Frameworks/Python.framework/Versions/3.11/pip.conf&#x27;</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>pip</code>会从上面的路径中查找配置信息，我这里选择第二个，如果不存在就创建<code>~/.pip/pip.conf</code>文件，内容如下：</p>\n</li>\n</ul>\n<figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[global]</span></span><br><span class=\"line\"><span class=\"attr\">cert</span> = ~/Downloads/GlobalSign.pem</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>配置好后可以通过如下命令查看配置信息</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ pip config list</span><br><span class=\"line\">global.cert=<span class=\"string\">&#x27;~/.pip/GlobalSign.pem&#x27;</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>然后再执行如下命令进行安装</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pip install certifi</span><br></pre></td></tr></table></figure>\n<h3 id=\"4-将证书添加到系统信任的证书存储\">4.将证书添加到系统信任的证书存储</h3>\n<h4 id=\"对于-macOS：\">对于 macOS：</h4>\n<div class=\"danger\">\n<p><em><strong>我设置后依旧报错，暂不清楚原因</strong></em></p>\n</div>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>打开 <code>钥匙串访问</code> 应用程序，并选择 <code>系统钥匙串</code> 中的 <code>系统</code> (从网上查询说是要加入<code>系统根证书</code>，但是我没有加入成功)</p>\n</li>\n<li class=\"lvl-2\">\n<p><code>文件</code> 》<code>导入项目</code> 》 <code>选择证书文件</code></p>\n</li>\n<li class=\"lvl-2\">\n<p>会提示你输入密码，如果证书不受信任，可以将证书设置为为始终信任该证书 (双击证书 》 信任 》 使用此证书时 》设置为<code>始终信任</code>)。</p>\n</li>\n</ul>\n<h3 id=\"5-使用-Python-官方推荐的证书修复工具-（推荐）\">5.使用 Python 官方推荐的证书修复工具 （推荐）</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>这个方法最简单</p>\n</li>\n<li class=\"lvl-2\">\n<p>运行这个脚本前需要先安装 <code>certifi</code>，其主要用于提供权威的CA根证书列表</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ pip install certifi --trusted-host pypi.org --trusted-host files.pythonhosted.org</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>运行证书安装脚本（适用于 macOS 内置的 Python）</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 首次运行依旧会报错，但实际上已经进行了修复，主要就是最后4步进行的操作</span></span><br><span class=\"line\"><span class=\"comment\"># 注意替换你自己的Python版本号</span></span><br><span class=\"line\">$ /Applications/Python\\ 3.11/Install\\ Certificates.<span class=\"built_in\">command</span></span><br><span class=\"line\"></span><br><span class=\"line\"> -- pip install --upgrade certifi</span><br><span class=\"line\">Requirement already satisfied: certifi <span class=\"keyword\">in</span> /Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages (2024.8.30)</span><br><span class=\"line\">WARNING: Retrying (Retry(total=4, connect=None, <span class=\"built_in\">read</span>=None, redirect=None, status=None)) after connection broken by <span class=\"string\">&#x27;SSLError(SSLCertVerificationError(1, &#x27;</span>[SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: unable to get <span class=\"built_in\">local</span> issuer certificate (_ssl.c:1002)<span class=\"string\">&#x27;))&#x27;</span>: /simple/certifi/</span><br><span class=\"line\">WARNING: Retrying (Retry(total=3, connect=None, <span class=\"built_in\">read</span>=None, redirect=None, status=None)) after connection broken by <span class=\"string\">&#x27;SSLError(SSLCertVerificationError(1, &#x27;</span>[SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: unable to get <span class=\"built_in\">local</span> issuer certificate (_ssl.c:1002)<span class=\"string\">&#x27;))&#x27;</span>: /simple/certifi/</span><br><span class=\"line\">WARNING: Retrying (Retry(total=2, connect=None, <span class=\"built_in\">read</span>=None, redirect=None, status=None)) after connection broken by <span class=\"string\">&#x27;SSLError(SSLCertVerificationError(1, &#x27;</span>[SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: unable to get <span class=\"built_in\">local</span> issuer certificate (_ssl.c:1002)<span class=\"string\">&#x27;))&#x27;</span>: /simple/certifi/</span><br><span class=\"line\">WARNING: Retrying (Retry(total=1, connect=None, <span class=\"built_in\">read</span>=None, redirect=None, status=None)) after connection broken by <span class=\"string\">&#x27;SSLError(SSLCertVerificationError(1, &#x27;</span>[SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: unable to get <span class=\"built_in\">local</span> issuer certificate (_ssl.c:1002)<span class=\"string\">&#x27;))&#x27;</span>: /simple/certifi/</span><br><span class=\"line\">WARNING: Retrying (Retry(total=0, connect=None, <span class=\"built_in\">read</span>=None, redirect=None, status=None)) after connection broken by <span class=\"string\">&#x27;SSLError(SSLCertVerificationError(1, &#x27;</span>[SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: unable to get <span class=\"built_in\">local</span> issuer certificate (_ssl.c:1002)<span class=\"string\">&#x27;))&#x27;</span>: /simple/certifi/</span><br><span class=\"line\">Could not fetch URL https://pypi.org/simple/certifi/: There was a problem confirming the ssl certificate: HTTPSConnectionPool(host=<span class=\"string\">&#x27;pypi.org&#x27;</span>, port=443): Max retries exceeded with url: /simple/certifi/ (Caused by SSLError(SSLCertVerificationError(1, <span class=\"string\">&#x27;[SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: unable to get local issuer certificate (_ssl.c:1002)&#x27;</span>))) - skipping</span><br><span class=\"line\"> -- removing any existing file or <span class=\"built_in\">link</span></span><br><span class=\"line\"> -- creating symlink to certifi certificate bundle</span><br><span class=\"line\"> -- setting permissions</span><br><span class=\"line\"> -- update complete</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>之后再运行<code>pip install</code>命令，就不会报错了</p>\n</li>\n</ul>\n<h3 id=\"6-使用其它镜像源\">6.使用其它镜像源</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>该问题是因为Pypi软件仓库官网的证书文件存在问题导致的，只要我们不从官网下载就不会有问题。</p>\n</li>\n<li class=\"lvl-2\">\n<p>在国内为了加速下载我们一般会使用国内的镜像源，例如<a href=\"https://developer.aliyun.com/mirror/pypi\">阿里云的Pypi镜像源</a>或者<a href=\"https://mirrors.tuna.tsinghua.edu.cn/help/pypi/\">清华大学的Pypi镜像源</a>，具体使用方法参考各自的官网说明即可。</p>\n</li>\n</ul>\n","content_text":"摘要 测试环境：macOS 13.7.1，Python 3.11.3 今天将pip升级(pip install --upgrade pip)到24.3.1版本后，通过pip install命令安装依赖时会报错，比如： 12$ pip install certifiCould not fetch URL https://pypi.org/simple/certifi/: There was a problem confirming the ssl certificate: HTTPSConnectionPool(host=&#x27;pypi.org&#x27;, port=443): Max retries exceeded with url: /simple/certifi/ (Caused by SSLError(SSLCertVerificationError(1, &#x27;[SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: unable to get local issuer certificate (_ssl.c:1002)&#x27;))) - skipping 很奇怪，从pip自己的网站上下载依赖都会出现证书无法验证的错误。测试了一下，该问题只在macOS上遇到，其他平台没有遇到过。 先说结论，推荐使用第五种方法。 解决方法 1. --trusted-host: 忽略证书验证 指定信任的证书域名，从而不进行验证证书，可以指定多个 1pip install certifi --trusted-host pypi.org --trusted-host files.pythonhosted.org 2. --cert: 指定证书文件 此时需要先下载证书文件，用Chrome浏览器打开https://pypi.org，按如下步骤导出证书文件 然后再执行如下命令进行安装 1pip install certifi --cert ~/Downloads/GlobalSign.pem 3. pip.conf: 配置全局证书文件 还是需要先下载证书文件，参考上面方法 pip 的配置文件位置因操作系统而异。可以通过以下命令找到配置文件路径： 123456# 我使用的是 macOS$ pip config -v listFor variant &#x27;global&#x27;, will try loading &#x27;/Library/Application Support/pip/pip.conf&#x27;For variant &#x27;user&#x27;, will try loading &#x27;/Users/hanqf/.pip/pip.conf&#x27;For variant &#x27;user&#x27;, will try loading &#x27;/Users/hanqf/.config/pip/pip.conf&#x27;For variant &#x27;site&#x27;, will try loading &#x27;/Library/Frameworks/Python.framework/Versions/3.11/pip.conf&#x27; pip会从上面的路径中查找配置信息，我这里选择第二个，如果不存在就创建~/.pip/pip.conf文件，内容如下： 12[global]cert = ~/Downloads/GlobalSign.pem 配置好后可以通过如下命令查看配置信息 12$ pip config listglobal.cert=&#x27;~/.pip/GlobalSign.pem&#x27; 然后再执行如下命令进行安装 1pip install certifi 4.将证书添加到系统信任的证书存储 对于 macOS： 我设置后依旧报错，暂不清楚原因 打开 钥匙串访问 应用程序，并选择 系统钥匙串 中的 系统 (从网上查询说是要加入系统根证书，但是我没有加入成功) 文件 》导入项目 》 选择证书文件 会提示你输入密码，如果证书不受信任，可以将证书设置为为始终信任该证书 (双击证书 》 信任 》 使用此证书时 》设置为始终信任)。 5.使用 Python 官方推荐的证书修复工具 （推荐） 这个方法最简单 运行这个脚本前需要先安装 certifi，其主要用于提供权威的CA根证书列表 1$ pip install certifi --trusted-host pypi.org --trusted-host files.pythonhosted.org 运行证书安装脚本（适用于 macOS 内置的 Python） 12345678910111213141516# 首次运行依旧会报错，但实际上已经进行了修复，主要就是最后4步进行的操作# 注意替换你自己的Python版本号$ /Applications/Python\\ 3.11/Install\\ Certificates.command -- pip install --upgrade certifiRequirement already satisfied: certifi in /Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages (2024.8.30)WARNING: Retrying (Retry(total=4, connect=None, read=None, redirect=None, status=None)) after connection broken by &#x27;SSLError(SSLCertVerificationError(1, &#x27;[SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: unable to get local issuer certificate (_ssl.c:1002)&#x27;))&#x27;: /simple/certifi/WARNING: Retrying (Retry(total=3, connect=None, read=None, redirect=None, status=None)) after connection broken by &#x27;SSLError(SSLCertVerificationError(1, &#x27;[SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: unable to get local issuer certificate (_ssl.c:1002)&#x27;))&#x27;: /simple/certifi/WARNING: Retrying (Retry(total=2, connect=None, read=None, redirect=None, status=None)) after connection broken by &#x27;SSLError(SSLCertVerificationError(1, &#x27;[SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: unable to get local issuer certificate (_ssl.c:1002)&#x27;))&#x27;: /simple/certifi/WARNING: Retrying (Retry(total=1, connect=None, read=None, redirect=None, status=None)) after connection broken by &#x27;SSLError(SSLCertVerificationError(1, &#x27;[SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: unable to get local issuer certificate (_ssl.c:1002)&#x27;))&#x27;: /simple/certifi/WARNING: Retrying (Retry(total=0, connect=None, read=None, redirect=None, status=None)) after connection broken by &#x27;SSLError(SSLCertVerificationError(1, &#x27;[SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: unable to get local issuer certificate (_ssl.c:1002)&#x27;))&#x27;: /simple/certifi/Could not fetch URL https://pypi.org/simple/certifi/: There was a problem confirming the ssl certificate: HTTPSConnectionPool(host=&#x27;pypi.org&#x27;, port=443): Max retries exceeded with url: /simple/certifi/ (Caused by SSLError(SSLCertVerificationError(1, &#x27;[SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: unable to get local issuer certificate (_ssl.c:1002)&#x27;))) - skipping -- removing any existing file or link -- creating symlink to certifi certificate bundle -- setting permissions -- update complete 之后再运行pip install命令，就不会报错了 6.使用其它镜像源 该问题是因为Pypi软件仓库官网的证书文件存在问题导致的，只要我们不从官网下载就不会有问题。 在国内为了加速下载我们一般会使用国内的镜像源，例如阿里云的Pypi镜像源或者清华大学的Pypi镜像源，具体使用方法参考各自的官网说明即可。","summary":"摘要 测试环境：macOS 13.7.1，Python 3.11.3 今天将pip升级(pip install --upgrade pip)到24.3.1版本后，通过pip install命令安装依赖时会报错，比如： 12$ pip install certifiCould not fetch URL https://pypi.org/simple/certifi/: There was a problem confirming the ssl certificate: HTTPSConnectionPool(host=&#x27;pypi.org&#x27;, port=443): Max retries exceeded with url: /simple/certifi/ (Caused by SSLError(SSLCertVerificationError(1, &#x27;[SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: unable to get local issuer certificate (_ssl.c:1002)&#x27;))) - skipping 很奇怪，从pip自己的网站上下载依赖都会出现证书无法验证的错误。测试了一下，该问题只在macOS上遇到，其他平台没有遇到过。 先说结论，推荐使用第五种方法。","date_published":"2024-11-18T15:33:15.000Z","tags":["技术","Python"]},{"id":"https://blog.hanqunfeng.com/2024/11/12/mathjax-demo/","url":"https://blog.hanqunfeng.com/2024/11/12/mathjax-demo/","title":"Hexo NexT -- 数学公式","content_html":"<!--\n **加粗**\n *斜体*\n ***加粗并斜体***\n ~~删除线~~\n ==突出显示==\n `突出显示(推荐)`\n ++下划线++\n ~下标~\n ^上标^\n 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.\n 图片设置宽度和高度(通过uPic上传后，需要将upic修改过为blog，用于添加水印) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)\n\n +++ **点击折叠**\n 这是被隐藏的内容\n +++\n\n::: tips success warning danger\n这里是容器内的内容\n:::\n\n% note info % success warning danger\n这里是容器内的内容\n% endnote %\n\n-->\n<h2 id=\"摘要\">摘要</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Hexo是基于markdown的，所以可以使用LaTex语法来编写数学公式，只不过需要安装相应的公式渲染插件来实现。</p>\n</li>\n<li class=\"lvl-2\">\n<p>Next主题 支持的公式插件为<code>MathJax</code>和<code>KaTeX</code>，它们都支持LaTex语法，参考: <a href=\"https://theme-next.js.org/docs/third-party-services/math-equations\">https://theme-next.js.org/docs/third-party-services/math-equations</a></p>\n</li>\n<li class=\"lvl-2\">\n<p>本文使用的是<a href=\"https://katex.org/docs/supported\">Katex</a>，原因是我已经使用了<a href=\"https://github.com/hexojs/hexo-renderer-markdown-it\">hexo-renderer-markdown-it</a>渲染器，其与 mathjax 的 <a href=\"https://github.com/hexojs/hexo-renderer-pandoc\">hexo-renderer-pandoc</a>渲染器不能并存，所以只能选<code>Katex</code>了。</p>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"安装\">安装</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>详细的安装方法请参考:<a href=\"https://theme-next.js.org/docs/third-party-services/math-equations\">Math Equations</a></p>\n</li>\n<li class=\"lvl-2\">\n<p>因为已经使用了<a href=\"https://github.com/hexojs/hexo-renderer-markdown-it\">hexo-renderer-markdown-it</a>渲染器，所以这里就没有使用<a href=\"https://github.com/CHENXCHEN/hexo-renderer-markdown-it-plus\">hexo-renderer-markdown-it-plus</a>渲染器，其实两者也没有太大的区别，只不过后者默认就加载了一些插件，而前者需要自己安装插件并配置才可以使用。</p>\n</li>\n<li class=\"lvl-2\">\n<p>但是测试时发现，按照官网的配置<code>hexo-renderer-markdown-it</code> + <code>markdown-it-katex</code> 的方式并不能很好的进行公式的渲染，所以这里参考了 <code>hexo-renderer-markdown-it-plus</code> 渲染器，将其更换为<a href=\"https://github.com/iktakahiro/markdown-it-katex#readme\">@iktakahiro/markdown-it-katex</a>。</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm install @iktakahiro/markdown-it-katex --save</span><br></pre></td></tr></table></figure>\n<p>在<code>_config.yml</code>配置上该插件</p>\n<figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># config of hexo-renderer-markdown-it</span></span><br><span class=\"line\"><span class=\"attr\">markdown:</span></span><br><span class=\"line\">  <span class=\"attr\">render:</span></span><br><span class=\"line\">    <span class=\"attr\">html:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">    <span class=\"attr\">xhtmlOut:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">    <span class=\"attr\">breaks:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">    <span class=\"attr\">linkify:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">    <span class=\"attr\">typographer:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">    <span class=\"attr\">quotes:</span> <span class=\"string\">&#x27;“”‘’&#x27;</span></span><br><span class=\"line\">  <span class=\"attr\">plugins:</span></span><br><span class=\"line\">    <span class=\"comment\"># katex公式</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">&quot;@iktakahiro/markdown-it-katex&quot;</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"安装后遇到的问题\">安装后遇到的问题</h2>\n<h3 id=\"1-安装后发现通过hexo编译时会报类似如下警告\">1.安装后发现通过hexo编译时会报类似如下警告</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">LaTeX-incompatible input and strict mode is set to &#x27;warn&#x27;: Unicode text character &quot;即&quot; used in math mode [unicodeTextInMathMode]</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>原因是<code>@iktakahiro/markdown-it-katex</code>插件默认开启的是严格模式，不能在<code>$$...$$</code>或<code>$...$</code>中包含中文，虽然我设置的是<code>math -- every_page: false</code>，但其在编译阶段依旧会检查所有的页面，不过报这个警告并不会有什么影响，所以可以忽略。</p>\n</li>\n<li class=\"lvl-2\">\n<p>如果不希望看到这个警告，可以为 <code>@iktakahiro/markdown-it-katex</code> 添加模式的控制行为</p>\n</li>\n</ul>\n<figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># config of hexo-renderer-markdown-it</span></span><br><span class=\"line\"><span class=\"attr\">markdown:</span></span><br><span class=\"line\">  <span class=\"attr\">render:</span></span><br><span class=\"line\">    <span class=\"attr\">html:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">    <span class=\"attr\">xhtmlOut:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">    <span class=\"attr\">breaks:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">    <span class=\"attr\">linkify:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">    <span class=\"attr\">typographer:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">    <span class=\"attr\">quotes:</span> <span class=\"string\">&#x27;“”‘’&#x27;</span></span><br><span class=\"line\">  <span class=\"attr\">plugins:</span></span><br><span class=\"line\">    <span class=\"comment\"># katex公式</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">&quot;@iktakahiro/markdown-it-katex&quot;</span></span><br><span class=\"line\">      <span class=\"attr\">options:</span></span><br><span class=\"line\">         <span class=\"attr\">strict:</span> <span class=\"string\">error</span> <span class=\"comment\"># 默认为warn，这里设置为error，只有当解析器遇到不支持的公式时才报错，也可以设置为 false，表示不检查</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"不支持Katex的Auto-render-Extension\">不支持<code>Katex</code>的<code>Auto-render Extension</code></h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>通过查看<code>Katex</code>官网可以知道，开启<a href=\"https://katex.org/docs/autorender\">Auto-render Extension</a>后，<code>Katex</code>可以渲染更多的公式语法，但要注意这并不是<code>LaTex</code>的标准语法</p>\n</li>\n<li class=\"lvl-2\">\n<p>但是<code>@iktakahiro/markdown-it-katex</code>中并没有相应的配置，为了解决这个问题，简单的方法就是将所需要的资源添加到页面中，比如我在<code>source\\_data\\post-body-start.njk</code>中添加了如下内容</p>\n</li>\n</ul>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;%- if page.mathjax %&#125;</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">link</span> <span class=\"attr\">rel</span>=<span class=\"string\">&quot;stylesheet&quot;</span> <span class=\"attr\">href</span>=<span class=\"string\">&quot;https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css&quot;</span> <span class=\"attr\">integrity</span>=<span class=\"string\">&quot;sha384-nB0miv6/jRmo5UMMR1wu3Gz6NLsoTkbqJghGIsx//Rlm+ZU03BU6SQNC66uf4l5+&quot;</span> <span class=\"attr\">crossorigin</span>=<span class=\"string\">&quot;anonymous&quot;</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">defer</span> <span class=\"attr\">src</span>=<span class=\"string\">&quot;https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js&quot;</span> <span class=\"attr\">integrity</span>=<span class=\"string\">&quot;sha384-7zkQWkzuo3B5mTepMUcHkMB5jZaolc2xDwL6VFqjFALcbeS9Ggm/Yr2r3Dy4lfFg&quot;</span> <span class=\"attr\">crossorigin</span>=<span class=\"string\">&quot;anonymous&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">defer</span> <span class=\"attr\">src</span>=<span class=\"string\">&quot;https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js&quot;</span> <span class=\"attr\">integrity</span>=<span class=\"string\">&quot;sha384-43gviWU0YVjaDtb/GhzOouOXtZMP/7XUzwPTstBeZFe/+rCMvRwr4yROQP43s0Xk&quot;</span> <span class=\"attr\">crossorigin</span>=<span class=\"string\">&quot;anonymous&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"variable language_\">document</span>.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&quot;DOMContentLoaded&quot;</span>, <span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">        <span class=\"title function_\">renderMathInElement</span>(<span class=\"variable language_\">document</span>.<span class=\"property\">body</span>, &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">          <span class=\"comment\">// customised options</span></span></span><br><span class=\"line\"><span class=\"language-javascript\">          <span class=\"comment\">// • auto-render specific keys, e.g.:</span></span></span><br><span class=\"line\"><span class=\"language-javascript\">          <span class=\"attr\">delimiters</span>: [</span></span><br><span class=\"line\"><span class=\"language-javascript\">            &#123;<span class=\"attr\">left</span>: <span class=\"string\">&quot;$$&quot;</span>, <span class=\"attr\">right</span>: <span class=\"string\">&quot;$$&quot;</span>, <span class=\"attr\">display</span>: <span class=\"literal\">true</span>&#125;,</span></span><br><span class=\"line\"><span class=\"language-javascript\">            &#123;<span class=\"attr\">left</span>: <span class=\"string\">&quot;\\\\(&quot;</span>, <span class=\"attr\">right</span>: <span class=\"string\">&quot;\\\\)&quot;</span>, <span class=\"attr\">display</span>: <span class=\"literal\">false</span>&#125;,</span></span><br><span class=\"line\"><span class=\"language-javascript\">            &#123;<span class=\"attr\">left</span>: <span class=\"string\">&quot;\\\\begin&#123;equation&#125;&quot;</span>, <span class=\"attr\">right</span>: <span class=\"string\">&quot;\\\\end&#123;equation&#125;&quot;</span>, <span class=\"attr\">display</span>: <span class=\"literal\">true</span>&#125;,</span></span><br><span class=\"line\"><span class=\"language-javascript\">            &#123;<span class=\"attr\">left</span>: <span class=\"string\">&quot;\\\\begin&#123;align&#125;&quot;</span>, <span class=\"attr\">right</span>: <span class=\"string\">&quot;\\\\end&#123;align&#125;&quot;</span>, <span class=\"attr\">display</span>: <span class=\"literal\">true</span>&#125;,</span></span><br><span class=\"line\"><span class=\"language-javascript\">            &#123;<span class=\"attr\">left</span>: <span class=\"string\">&quot;\\\\begin&#123;alignat&#125;&quot;</span>, <span class=\"attr\">right</span>: <span class=\"string\">&quot;\\\\end&#123;alignat&#125;&quot;</span>, <span class=\"attr\">display</span>: <span class=\"literal\">true</span>&#125;,</span></span><br><span class=\"line\"><span class=\"language-javascript\">            &#123;<span class=\"attr\">left</span>: <span class=\"string\">&quot;\\\\begin&#123;gather&#125;&quot;</span>, <span class=\"attr\">right</span>: <span class=\"string\">&quot;\\\\end&#123;gather&#125;&quot;</span>, <span class=\"attr\">display</span>: <span class=\"literal\">true</span>&#125;,</span></span><br><span class=\"line\"><span class=\"language-javascript\">            &#123;<span class=\"attr\">left</span>: <span class=\"string\">&quot;\\\\begin&#123;CD&#125;&quot;</span>, <span class=\"attr\">right</span>: <span class=\"string\">&quot;\\\\end&#123;CD&#125;&quot;</span>, <span class=\"attr\">display</span>: <span class=\"literal\">true</span>&#125;,</span></span><br><span class=\"line\"><span class=\"language-javascript\">            &#123;<span class=\"attr\">left</span>: <span class=\"string\">&quot;\\\\[&quot;</span>, <span class=\"attr\">right</span>: <span class=\"string\">&quot;\\\\]&quot;</span>, <span class=\"attr\">display</span>: <span class=\"literal\">true</span>&#125;</span></span><br><span class=\"line\"><span class=\"language-javascript\">            ],</span></span><br><span class=\"line\"><span class=\"language-javascript\">          <span class=\"comment\">// • rendering keys, e.g.:</span></span></span><br><span class=\"line\"><span class=\"language-javascript\">          throwOnError : <span class=\"literal\">false</span></span></span><br><span class=\"line\"><span class=\"language-javascript\">        &#125;);</span></span><br><span class=\"line\"><span class=\"language-javascript\">    &#125;);</span></span><br><span class=\"line\"><span class=\"language-javascript\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">&#123;%- endif %&#125;</span><br></pre></td></tr></table></figure>\n<div class=\"tips\">\n<p><em><strong>小贴士</strong></em><br>\n可以通过next模板的<code>_config.yml</code>中的<code>custom_file_path</code>配置项来自定义渲染页面的某个部分，这样对应的每个页面都会加上该模板内容</p>\n<figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">custom_file_path:</span></span><br><span class=\"line\">  <span class=\"attr\">postBodyStart:</span> <span class=\"string\">source/_data/post-body-start.njk</span></span><br></pre></td></tr></table></figure>\n</div>\n<hr>\n<div class=\"warning\">\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">\n<p>使用<code>hexo-renderer-markdown-it-plus</code>渲染器时，如果修改了页面的内容，此时刷新页面，会发现页面中的公式不能被渲染了，只能重新启动hexo服务。</p>\n</li>\n<li class=\"lvl-2\">\n<p>但是使用<code>hexo-renderer-markdown-it</code>渲染器时，刷新页面后公式就可以被渲染了。</p>\n</li>\n</ul>\n</div>\n<hr>\n<h2 id=\"使用\">使用</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>每个页面的<code>front-matter</code>中要添加<code>mathjax: true</code>，这样在页面中就可以使用公式了。</p>\n</li>\n<li class=\"lvl-2\">\n<p><code>Katex</code>公式的渲染方式支持<code>$...$</code>和<code>$$...$$</code>两种方式</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-5\"><code>$...$</code>为行级公式</li>\n</ul>\n <figure class=\"highlight latex\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">$</span>sin(<span class=\"keyword\">\\omega</span> t)=<span class=\"keyword\">\\frac</span>&#123;1&#125;&#123;2j&#125;(e<span class=\"built_in\">^</span>&#123;j<span class=\"keyword\">\\omega</span> t&#125;-e<span class=\"built_in\">^</span>&#123;-j<span class=\"keyword\">\\omega</span> t&#125;)<span class=\"built_in\">$</span></span><br></pre></td></tr></table></figure>\n<p><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>s</mi><mi>i</mi><mi>n</mi><mo stretchy=\"false\">(</mo><mi>ω</mi><mi>t</mi><mo stretchy=\"false\">)</mo><mo>=</mo><mfrac><mn>1</mn><mrow><mn>2</mn><mi>j</mi></mrow></mfrac><mo stretchy=\"false\">(</mo><msup><mi>e</mi><mrow><mi>j</mi><mi>ω</mi><mi>t</mi></mrow></msup><mo>−</mo><msup><mi>e</mi><mrow><mo>−</mo><mi>j</mi><mi>ω</mi><mi>t</mi></mrow></msup><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">sin(\\omega t)=\\frac{1}{2j}(e^{j\\omega t}-e^{-j\\omega t})</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">n</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">ω</span><span class=\"mord mathnormal\">t</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.326216em;vertical-align:-0.481108em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.845108em;\"><span style=\"top:-2.6550000000000002em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">2</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.394em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">1</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.481108em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\">e</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.824664em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">ω</span><span class=\"mord mathnormal mtight\">t</span></span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.0746639999999998em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">e</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.824664em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">−</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">ω</span><span class=\"mord mathnormal mtight\">t</span></span></span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span></p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-5\"><code>$$...$$</code>为块级公式，独占一行且居中展示</li>\n</ul>\n <figure class=\"highlight latex\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">$</span><span class=\"built_in\">$</span></span><br><span class=\"line\">sin(<span class=\"keyword\">\\omega</span> t)=<span class=\"keyword\">\\frac</span>&#123;1&#125;&#123;2j&#125;(e<span class=\"built_in\">^</span>&#123;j<span class=\"keyword\">\\omega</span> t&#125;-e<span class=\"built_in\">^</span>&#123;-j<span class=\"keyword\">\\omega</span> t&#125;)</span><br><span class=\"line\"><span class=\"built_in\">$</span><span class=\"built_in\">$</span></span><br></pre></td></tr></table></figure>\n<p class='katex-block'><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>s</mi><mi>i</mi><mi>n</mi><mo stretchy=\"false\">(</mo><mi>ω</mi><mi>t</mi><mo stretchy=\"false\">)</mo><mo>=</mo><mfrac><mn>1</mn><mrow><mn>2</mn><mi>j</mi></mrow></mfrac><mo stretchy=\"false\">(</mo><msup><mi>e</mi><mrow><mi>j</mi><mi>ω</mi><mi>t</mi></mrow></msup><mo>−</mo><msup><mi>e</mi><mrow><mo>−</mo><mi>j</mi><mi>ω</mi><mi>t</mi></mrow></msup><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">sin(\\omega t)=\\frac{1}{2j}(e^{j\\omega t}-e^{-j\\omega t})\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">n</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">ω</span><span class=\"mord mathnormal\">t</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.20188em;vertical-align:-0.8804400000000001em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.32144em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"mord mathnormal\" style=\"margin-right:0.05724em;\">j</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">1</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8804400000000001em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\">e</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.874664em;\"><span style=\"top:-3.1130000000000004em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">ω</span><span class=\"mord mathnormal mtight\">t</span></span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.124664em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">e</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.874664em;\"><span style=\"top:-3.1130000000000004em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">−</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">ω</span><span class=\"mord mathnormal mtight\">t</span></span></span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span></span></p>\n</li>\n<li class=\"lvl-2\">\n<p><code>$$...$$</code>和<code>$...$</code>中不能出现Unicode字符，否则会报错，即不支持中文，如果需要显示中文，则需要使用<code>\\text&#123;中文&#125;</code></p>\n</li>\n<li class=\"lvl-2\">\n<p>块级公式，在开头的<code>$$</code>之前和结尾的<code>$$</code>之后，不得有任何字符（空格除外）</p>\n</li>\n<li class=\"lvl-2\">\n<p>行级公式，在开头的<code>$</code>之后和结尾的<code>$</code>之前，不得有空格</p>\n</li>\n</ul>\n<h2 id=\"示例\">示例</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>使用方式可以参考 <a href=\"https://katex.org/docs/supported\">KaTeX公式符号</a> 以及 <a href=\"https://zh.wikipedia.org/wiki/Help:%E6%95%B0%E5%AD%A6%E5%85%AC%E5%BC%8F\">维基百科：LaTeX公式手册</a></p>\n</li>\n<li class=\"lvl-2\">\n<p>不过记住这些公式符号还是比较困难的，这里推荐两个工具</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-5\"><a href=\"https://webdemo.myscript.com/views/math/index.html\">MyScript</a>: 手写转LaTeX公式，直接将你需要的数学公式画出来，它会自动将其转换为LaTeX公式，然后复制即可</li>\n<li class=\"lvl-5\"><a href=\"https://www.latexlive.com/home\">LaTeX公式编辑器</a>: 提供公式模板、图片识别(有次数限制)等功能，并且支持输出各种格式。</li>\n<li class=\"lvl-5\"><a href=\"https://simpletex.cn/ai/latex_ocr\">Simpletex</a>: 支持LaTex公式图片识别和手写转公式，且无次数限制，但是需要注册账号。同时也提供了客户端版本。</li>\n</ul>\n</li>\n</ul>\n<hr>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>这里随便给几个示例，以下是<code>LaTeX</code>的标准语法</p>\n</li>\n</ul>\n<hr>\n<figure class=\"highlight latex\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">$</span><span class=\"built_in\">$</span></span><br><span class=\"line\"><span class=\"keyword\">\\left</span>(<span class=\"keyword\">\\beta</span> m c<span class=\"built_in\">^</span>2 + c <span class=\"keyword\">\\left</span>(<span class=\"keyword\">\\sum</span><span class=\"built_in\">_</span>&#123;n=1&#125;<span class=\"built_in\">^</span>3<span class=\"keyword\">\\alpha</span><span class=\"built_in\">_</span>n p<span class=\"built_in\">_</span>n<span class=\"keyword\">\\right</span>)<span class=\"keyword\">\\right</span>) <span class=\"keyword\">\\psi</span>(x,t)</span><br><span class=\"line\">= i<span class=\"keyword\">\\hbar</span> <span class=\"keyword\">\\frac</span>&#123;<span class=\"keyword\">\\partial</span> <span class=\"keyword\">\\psi</span>(x,t)&#125;&#123;<span class=\"keyword\">\\partial</span> t&#125;</span><br><span class=\"line\"><span class=\"built_in\">$</span><span class=\"built_in\">$</span></span><br></pre></td></tr></table></figure>\n<p class='katex-block'><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mrow><mo fence=\"true\">(</mo><mi>β</mi><mi>m</mi><msup><mi>c</mi><mn>2</mn></msup><mo>+</mo><mi>c</mi><mrow><mo fence=\"true\">(</mo><munderover><mo>∑</mo><mrow><mi>n</mi><mo>=</mo><mn>1</mn></mrow><mn>3</mn></munderover><msub><mi>α</mi><mi>n</mi></msub><msub><mi>p</mi><mi>n</mi></msub><mo fence=\"true\">)</mo></mrow><mo fence=\"true\">)</mo></mrow><mi>ψ</mi><mo stretchy=\"false\">(</mo><mi>x</mi><mo separator=\"true\">,</mo><mi>t</mi><mo stretchy=\"false\">)</mo><mo>=</mo><mi>i</mi><mi mathvariant=\"normal\">ℏ</mi><mfrac><mrow><mi mathvariant=\"normal\">∂</mi><mi>ψ</mi><mo stretchy=\"false\">(</mo><mi>x</mi><mo separator=\"true\">,</mo><mi>t</mi><mo stretchy=\"false\">)</mo></mrow><mrow><mi mathvariant=\"normal\">∂</mi><mi>t</mi></mrow></mfrac></mrow><annotation encoding=\"application/x-tex\">\\left(\\beta m c^2 + c \\left(\\sum_{n=1}^3\\alpha_n p_n\\right)\\right) \\psi(x,t)\n= i\\hbar \\frac{\\partial \\psi(x,t)}{\\partial t}\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:3.068226em;vertical-align:-1.267113em;\"></span><span class=\"minner\"><span class=\"mopen delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size4\">(</span></span><span class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">β</span><span class=\"mord mathnormal\">m</span><span class=\"mord\"><span class=\"mord mathnormal\">c</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8641079999999999em;\"><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord mathnormal\">c</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"minner\"><span class=\"mopen delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size4\">(</span></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.8011130000000004em;\"><span style=\"top:-1.882887em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">n</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">1</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3000050000000005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">3</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.267113em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.0037em;\">α</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.0037em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">n</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">n</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size4\">)</span></span></span><span class=\"mclose delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size4\">)</span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">ψ</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\">t</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.113em;vertical-align:-0.686em;\"></span><span class=\"mord mathnormal\">i</span><span class=\"mord\">ℏ</span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.427em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\" style=\"margin-right:0.05556em;\">∂</span><span class=\"mord mathnormal\">t</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\" style=\"margin-right:0.05556em;\">∂</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">ψ</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\">t</span><span class=\"mclose\">)</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.686em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span></span></span></p>\n<hr>\n<figure class=\"highlight latex\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Aha! <span class=\"built_in\">$</span>E = mc<span class=\"built_in\">^</span>&#123;2&#125;<span class=\"built_in\">$</span>.</span><br></pre></td></tr></table></figure>\n<p>Aha! <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>E</mi><mo>=</mo><mi>m</mi><msup><mi>c</mi><mn>2</mn></msup></mrow><annotation encoding=\"application/x-tex\">E = mc^{2}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8141079999999999em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">m</span><span class=\"mord\"><span class=\"mord mathnormal\">c</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141079999999999em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span></span></span></span>.</p>\n<hr>\n<figure class=\"highlight latex\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">$</span><span class=\"built_in\">$</span></span><br><span class=\"line\"><span class=\"keyword\">\\left</span>(<span class=\"keyword\">\\LARGE</span>&#123;AB&#125;<span class=\"keyword\">\\right</span>)</span><br><span class=\"line\"><span class=\"built_in\">$</span><span class=\"built_in\">$</span></span><br></pre></td></tr></table></figure>\n<p class='katex-block'><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mo fence=\"true\">(</mo><mstyle mathsize=\"1.728em\"><mrow><mi>A</mi><mi>B</mi></mrow></mstyle><mo fence=\"true\">)</mo></mrow><annotation encoding=\"application/x-tex\">\\left(\\LARGE{AB}\\right)\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.83081424em;vertical-align:-0.65002em;\"></span><span class=\"minner\"><span class=\"mopen delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size2\">(</span></span><span class=\"mord sizing reset-size6 size9\"><span class=\"mord mathnormal\">A</span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span></span><span class=\"mclose delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size2\">)</span></span></span></span></span></span></span></p>\n<hr>\n<figure class=\"highlight latex\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">$</span><span class=\"built_in\">$</span></span><br><span class=\"line\"><span class=\"keyword\">\\begin</span>&#123;matrix&#125;</span><br><span class=\"line\">   a <span class=\"built_in\">&amp;</span> b <span class=\"keyword\">\\\\</span></span><br><span class=\"line\">   c <span class=\"built_in\">&amp;</span> d</span><br><span class=\"line\"><span class=\"keyword\">\\end</span>&#123;matrix&#125;</span><br><span class=\"line\"><span class=\"built_in\">$</span><span class=\"built_in\">$</span></span><br></pre></td></tr></table></figure>\n<p class='katex-block'><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mtable rowspacing=\"0.15999999999999992em\" columnspacing=\"1em\"><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mi>a</mi></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mi>b</mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mi>c</mi></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mi>d</mi></mstyle></mtd></mtr></mtable><annotation encoding=\"application/x-tex\">\\begin{matrix}\n   a &amp; b \\\\\n   c &amp; d\n\\end{matrix}\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:2.4000000000000004em;vertical-align:-0.9500000000000004em;\"></span><span class=\"mord\"><span class=\"mtable\"><span class=\"col-align-c\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.45em;\"><span style=\"top:-3.61em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">a</span></span></span><span style=\"top:-2.4099999999999997em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">c</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9500000000000004em;\"><span></span></span></span></span></span><span class=\"arraycolsep\" style=\"width:0.5em;\"></span><span class=\"arraycolsep\" style=\"width:0.5em;\"></span><span class=\"col-align-c\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.45em;\"><span style=\"top:-3.61em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">b</span></span></span><span style=\"top:-2.4099999999999997em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">d</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9500000000000004em;\"><span></span></span></span></span></span></span></span></span></span></span></span></p>\n<hr>\n<figure class=\"highlight latex\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">$</span><span class=\"built_in\">$</span></span><br><span class=\"line\"><span class=\"keyword\">\\def</span><span class=\"keyword\">\\arraystretch</span>&#123;1.5&#125;</span><br><span class=\"line\">   <span class=\"keyword\">\\begin</span>&#123;array&#125;&#123;c:c:c&#125;</span><br><span class=\"line\">   a <span class=\"built_in\">&amp;</span> b <span class=\"built_in\">&amp;</span> c <span class=\"keyword\">\\\\</span> <span class=\"keyword\">\\hline</span></span><br><span class=\"line\">   d <span class=\"built_in\">&amp;</span> e <span class=\"built_in\">&amp;</span> f <span class=\"keyword\">\\\\</span></span><br><span class=\"line\">   <span class=\"keyword\">\\hdashline</span></span><br><span class=\"line\">   g <span class=\"built_in\">&amp;</span> h <span class=\"built_in\">&amp;</span> i</span><br><span class=\"line\"><span class=\"keyword\">\\end</span>&#123;array&#125;</span><br><span class=\"line\"><span class=\"built_in\">$</span><span class=\"built_in\">$</span></span><br></pre></td></tr></table></figure>\n<p class='katex-block'><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mtable rowspacing=\"0.6599999999999999em\" columnalign=\"center center center\" columnlines=\"dashed dashed\" columnspacing=\"1em\" rowlines=\"solid dashed\"><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mi>a</mi></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mi>b</mi></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mi>c</mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mi>d</mi></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mi>e</mi></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mi>f</mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mi>g</mi></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mi>h</mi></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mi>i</mi></mstyle></mtd></mtr></mtable><annotation encoding=\"application/x-tex\">\\def\\arraystretch{1.5}\n   \\begin{array}{c:c:c}\n   a &amp; b &amp; c \\\\ \\hline\n   d &amp; e &amp; f \\\\\n   \\hdashline\n   g &amp; h &amp; i\n\\end{array}\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:5.4em;vertical-align:-2.45em;\"></span><span class=\"mord\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:2.95em;\"><span style=\"top:-4.95em;\"><span class=\"pstrut\" style=\"height:4.95em;\"></span><span class=\"mtable\"><span class=\"arraycolsep\" style=\"width:0.5em;\"></span><span class=\"col-align-c\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:2.95em;\"><span style=\"top:-4.95em;\"><span class=\"pstrut\" style=\"height:3.26em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">a</span></span></span><span style=\"top:-3.15em;\"><span class=\"pstrut\" style=\"height:3.26em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">d</span></span></span><span style=\"top:-1.3499999999999996em;\"><span class=\"pstrut\" style=\"height:3.26em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">g</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:2.45em;\"><span></span></span></span></span></span><span class=\"arraycolsep\" style=\"width:0.5em;\"></span><span class=\"vertical-separator\" style=\"height:5.4em;border-right-width:0.04em;border-right-style:dashed;margin:0 -0.02em;vertical-align:-2.45em;\"></span><span class=\"arraycolsep\" style=\"width:0.5em;\"></span><span class=\"col-align-c\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:2.95em;\"><span style=\"top:-4.95em;\"><span class=\"pstrut\" style=\"height:3.26em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">b</span></span></span><span style=\"top:-3.15em;\"><span class=\"pstrut\" style=\"height:3.26em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">e</span></span></span><span style=\"top:-1.3499999999999996em;\"><span class=\"pstrut\" style=\"height:3.26em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">h</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:2.45em;\"><span></span></span></span></span></span><span class=\"arraycolsep\" style=\"width:0.5em;\"></span><span class=\"vertical-separator\" style=\"height:5.4em;border-right-width:0.04em;border-right-style:dashed;margin:0 -0.02em;vertical-align:-2.45em;\"></span><span class=\"arraycolsep\" style=\"width:0.5em;\"></span><span class=\"col-align-c\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:2.95em;\"><span style=\"top:-4.95em;\"><span class=\"pstrut\" style=\"height:3.26em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">c</span></span></span><span style=\"top:-3.15em;\"><span class=\"pstrut\" style=\"height:3.26em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span></span></span><span style=\"top:-1.3499999999999996em;\"><span class=\"pstrut\" style=\"height:3.26em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:2.45em;\"><span></span></span></span></span></span><span class=\"arraycolsep\" style=\"width:0.5em;\"></span></span></span><span style=\"top:-4.300000000000001em;\"><span class=\"pstrut\" style=\"height:4.95em;\"></span><span class=\"hdashline\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-6.1000000000000005em;\"><span class=\"pstrut\" style=\"height:4.95em;\"></span><span class=\"hline\" style=\"border-bottom-width:0.04em;\"></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:2.45em;\"><span></span></span></span></span></span></span></span></span></span></p>\n<hr>\n<figure class=\"highlight latex\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">$</span><span class=\"keyword\">\\tilde</span>&#123;a&#125;<span class=\"built_in\">$</span>  <span class=\"built_in\">&amp;</span>nbsp;<span class=\"built_in\">&amp;</span>nbsp; <span class=\"built_in\">&amp;</span>nbsp; <span class=\"built_in\">&amp;</span>nbsp; <span class=\"built_in\">&amp;</span>nbsp; <span class=\"built_in\">$</span><span class=\"keyword\">\\underrightarrow</span>&#123;AB&#125;<span class=\"built_in\">$</span></span><br></pre></td></tr></table></figure>\n<p><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mover accent=\"true\"><mi>a</mi><mo>~</mo></mover></mrow><annotation encoding=\"application/x-tex\">\\tilde{a}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6678599999999999em;vertical-align:0em;\"></span><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.6678599999999999em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">a</span></span></span><span style=\"top:-3.35em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.25em;\"><span class=\"mord\">~</span></span></span></span></span></span></span></span></span></span>           <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><munder accentunder=\"true\"><mrow><mi>A</mi><mi>B</mi></mrow><mo stretchy=\"true\">→</mo></munder></mrow><annotation encoding=\"application/x-tex\">\\underrightarrow{AB}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.20533em;vertical-align:-0.522em;\"></span><span class=\"mord accentunder\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.68333em;\"><span class=\"svg-align\" style=\"top:-2.4779999999999998em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"hide-tail\" style=\"height:0.522em;min-width:0.888em;\"><svg width='400em' height='0.522em' viewBox='0 0 400000 522' preserveAspectRatio='xMaxYMin slice'><path d='M0 241v40h399891c-47.3 35.3-84 78-110 128\n-16.7 32-27.7 63.7-33 95 0 1.3-.2 2.7-.5 4-.3 1.3-.5 2.3-.5 3 0 7.3 6.7 11 20\n 11 8 0 13.2-.8 15.5-2.5 2.3-1.7 4.2-5.5 5.5-11.5 2-13.3 5.7-27 11-41 14.7-44.7\n 39-84.5 73-119.5s73.7-60.2 119-75.5c6-2 9-5.7 9-11s-3-9-9-11c-45.3-15.3-85\n-40.5-119-75.5s-58.3-74.8-73-119.5c-4.7-14-8.3-27.3-11-40-1.3-6.7-3.2-10.8-5.5\n-12.5-2.3-1.7-7.5-2.5-15.5-2.5-14 0-21 3.7-21 11 0 2 2 10.3 6 25 20.7 83.3 67\n 151.7 139 205zm0 0v40h399900v-40z'/></svg></span></span><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">A</span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.522em;\"><span></span></span></span></span></span></span></span></span></p>\n<hr>\n<figure class=\"highlight latex\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">$</span><span class=\"built_in\">$</span></span><br><span class=\"line\"><span class=\"keyword\">\\tilde</span>&#123;a&#125; <span class=\"keyword\">\\underrightarrow</span>&#123;AB&#125;<span class=\"keyword\">\\begin</span>&#123;array&#125;&#123;l&#125;</span><br><span class=\"line\">  a<span class=\"keyword\">\\mathop</span>&#123;x&#125;<span class=\"keyword\">\\nolimits</span><span class=\"built_in\">^</span>&#123;2&#125;+bx+c=0 <span class=\"keyword\">\\\\</span></span><br><span class=\"line\">  <span class=\"keyword\">\\Delta</span> =<span class=\"keyword\">\\mathop</span>&#123;b&#125;<span class=\"keyword\">\\nolimits</span><span class=\"built_in\">^</span>&#123;2&#125;-4ac <span class=\"keyword\">\\\\</span></span><br><span class=\"line\">  <span class=\"keyword\">\\left</span><span class=\"keyword\">\\&#123;</span><span class=\"keyword\">\\begin</span>&#123;matrix&#125;</span><br><span class=\"line\">  <span class=\"keyword\">\\Delta</span> <span class=\"keyword\">\\gt</span> 0<span class=\"keyword\">\\text</span>&#123;方程有两个不相等的实根&#125; <span class=\"keyword\">\\\\</span></span><br><span class=\"line\">  <span class=\"keyword\">\\Delta</span> = 0<span class=\"keyword\">\\text</span>&#123;方程有两个相等的实根&#125; <span class=\"keyword\">\\\\</span></span><br><span class=\"line\">  <span class=\"keyword\">\\Delta</span> <span class=\"keyword\">\\lt</span> 0<span class=\"keyword\">\\text</span>&#123;方程无实根&#125;</span><br><span class=\"line\"><span class=\"keyword\">\\end</span>&#123;matrix&#125;<span class=\"keyword\">\\right</span>.</span><br><span class=\"line\"><span class=\"keyword\">\\end</span>&#123;array&#125;</span><br><span class=\"line\"><span class=\"built_in\">$</span><span class=\"built_in\">$</span></span><br></pre></td></tr></table></figure>\n<p class='katex-block'><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mover accent=\"true\"><mi>a</mi><mo>~</mo></mover><munder accentunder=\"true\"><mrow><mi>A</mi><mi>B</mi></mrow><mo stretchy=\"true\">→</mo></munder><mtable rowspacing=\"0.15999999999999992em\" columnalign=\"left\" columnspacing=\"1em\"><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mrow><mi>a</mi><msup><mo><mi>x</mi></mo><mn>2</mn></msup><mo>+</mo><mi>b</mi><mi>x</mi><mo>+</mo><mi>c</mi><mo>=</mo><mn>0</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mrow><mi mathvariant=\"normal\">Δ</mi><mo>=</mo><msup><mo><mi>b</mi></mo><mn>2</mn></msup><mo>−</mo><mn>4</mn><mi>a</mi><mi>c</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mrow><mo fence=\"true\">{</mo><mtable rowspacing=\"0.15999999999999992em\" columnspacing=\"1em\"><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mrow><mi mathvariant=\"normal\">Δ</mi><mo>&gt;</mo><mn>0</mn><mtext> 方程有两个不相等的实根</mtext></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mrow><mi mathvariant=\"normal\">Δ</mi><mo>=</mo><mn>0</mn><mtext> 方程有两个相等的实根</mtext></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mrow><mi mathvariant=\"normal\">Δ</mi><mo>&lt;</mo><mn>0</mn><mtext> 方程无实根</mtext></mrow></mstyle></mtd></mtr></mtable></mrow></mstyle></mtd></mtr></mtable></mrow><annotation encoding=\"application/x-tex\">\\tilde{a} \\underrightarrow{AB}\\begin{array}{l}\n  a\\mathop{x}\\nolimits^{2}+bx+c=0 \\\\\n  \\Delta =\\mathop{b}\\nolimits^{2}-4ac \\\\\n  \\left\\{\\begin{matrix}\n  \\Delta \\gt 0\\text{ 方程有两个不相等的实根} \\\\\n  \\Delta = 0\\text{ 方程有两个相等的实根} \\\\\n  \\Delta \\lt 0\\text{ 方程无实根}\n\\end{matrix}\\right.\n\\end{array}\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:6.0584880000000005em;vertical-align:-2.7792439999999994em;\"></span><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.6678599999999999em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">a</span></span></span><span style=\"top:-3.35em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.25em;\"><span class=\"mord\">~</span></span></span></span></span></span></span><span class=\"mord accentunder\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.68333em;\"><span class=\"svg-align\" style=\"top:-2.4779999999999998em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"hide-tail\" style=\"height:0.522em;min-width:0.888em;\"><svg width='400em' height='0.522em' viewBox='0 0 400000 522' preserveAspectRatio='xMaxYMin slice'><path d='M0 241v40h399891c-47.3 35.3-84 78-110 128\n-16.7 32-27.7 63.7-33 95 0 1.3-.2 2.7-.5 4-.3 1.3-.5 2.3-.5 3 0 7.3 6.7 11 20\n 11 8 0 13.2-.8 15.5-2.5 2.3-1.7 4.2-5.5 5.5-11.5 2-13.3 5.7-27 11-41 14.7-44.7\n 39-84.5 73-119.5s73.7-60.2 119-75.5c6-2 9-5.7 9-11s-3-9-9-11c-45.3-15.3-85\n-40.5-119-75.5s-58.3-74.8-73-119.5c-4.7-14-8.3-27.3-11-40-1.3-6.7-3.2-10.8-5.5\n-12.5-2.3-1.7-7.5-2.5-15.5-2.5-14 0-21 3.7-21 11 0 2 2 10.3 6 25 20.7 83.3 67\n 151.7 139 205zm0 0v40h399900v-40z'/></svg></span></span><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">A</span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.522em;\"><span></span></span></span></span></span><span class=\"mord\"><span class=\"mtable\"><span class=\"arraycolsep\" style=\"width:0.5em;\"></span><span class=\"col-align-l\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:3.2792440000000007em;\"><span style=\"top:-6.489264000000001em;\"><span class=\"pstrut\" style=\"height:4.05002em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">a</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop\"><span class=\"mop mathnormal\" style=\"position:relative;top:-0.03472em;\">x</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141079999999999em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\">+</span><span class=\"mord mathnormal\">b</span><span class=\"mord mathnormal\">x</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord mathnormal\">c</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mord\">0</span></span></span><span style=\"top:-5.230816em;\"><span class=\"pstrut\" style=\"height:4.05002em;\"></span><span class=\"mord\"><span class=\"mord\">Δ</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mop\"><span class=\"mop mathnormal\" style=\"position:relative;top:0.09721999999999997em;\">b</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8984479999999999em;\"><span style=\"top:-3.1473400000000002em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\">−</span><span class=\"mord\">4</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">c</span></span></span><span style=\"top:-2.8207960000000005em;\"><span class=\"pstrut\" style=\"height:4.05002em;\"></span><span class=\"mord\"><span class=\"minner\"><span class=\"mopen\"><span class=\"delimsizing mult\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:2.05002em;\"><span style=\"top:-2.49999em;\"><span class=\"pstrut\" style=\"height:3.15em;\"></span><span class=\"delimsizinginner delim-size4\"><span>⎩</span></span></span><span style=\"top:-2.20499em;\"><span class=\"pstrut\" style=\"height:3.15em;\"></span><span class=\"delimsizinginner delim-size4\"><span>⎪</span></span></span><span style=\"top:-3.15001em;\"><span class=\"pstrut\" style=\"height:3.15em;\"></span><span class=\"delimsizinginner delim-size4\"><span>⎨</span></span></span><span style=\"top:-4.00501em;\"><span class=\"pstrut\" style=\"height:3.15em;\"></span><span class=\"delimsizinginner delim-size4\"><span>⎪</span></span></span><span style=\"top:-4.30002em;\"><span class=\"pstrut\" style=\"height:3.15em;\"></span><span class=\"delimsizinginner delim-size4\"><span>⎧</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.55002em;\"><span></span></span></span></span></span></span><span class=\"mord\"><span class=\"mtable\"><span class=\"col-align-c\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:2.05em;\"><span style=\"top:-4.21em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">Δ</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">&gt;</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mord\">0</span><span class=\"mord text\"><span class=\"mord\"> </span><span class=\"mord cjk_fallback\">方程有两个不相等的实根</span></span></span></span><span style=\"top:-3.0099999999999993em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">Δ</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mord\">0</span><span class=\"mord text\"><span class=\"mord\"> </span><span class=\"mord cjk_fallback\">方程有两个相等的实根</span></span></span></span><span style=\"top:-1.8099999999999994em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">Δ</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">&lt;</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mord\">0</span><span class=\"mord text\"><span class=\"mord\"> </span><span class=\"mord cjk_fallback\">方程无实根</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.5500000000000007em;\"><span></span></span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:2.7792439999999994em;\"><span></span></span></span></span></span><span class=\"arraycolsep\" style=\"width:0.5em;\"></span></span></span></span></span></span></span></p>\n<hr>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>以下为开启<code>Auto-render Extension</code>后支持的公式语法，并不是<code>LaTex</code>的标准语法</p>\n</li>\n</ul>\n<hr>\n<figure class=\"highlight latex\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">$</span><span class=\"built_in\">$</span></span><br><span class=\"line\"><span class=\"keyword\">\\begin</span>&#123;equation&#125;</span><br><span class=\"line\"><span class=\"keyword\">\\begin</span>&#123;split&#125;   a <span class=\"built_in\">&amp;</span>=b+c<span class=\"keyword\">\\\\</span></span><br><span class=\"line\">      <span class=\"built_in\">&amp;</span>=e+f</span><br><span class=\"line\"><span class=\"keyword\">\\end</span>&#123;split&#125;</span><br><span class=\"line\"><span class=\"keyword\">\\end</span>&#123;equation&#125;</span><br><span class=\"line\"><span class=\"built_in\">$</span><span class=\"built_in\">$</span></span><br></pre></td></tr></table></figure>\n<p class='katex-block katex-error' title='ParseError: KaTeX parse error: No such environment: equation at position 7: \\begin{̲e̲q̲u̲a̲t̲i̲o̲n̲}̲\n\\begin{split} …'>\\begin{equation}\n\\begin{split}   a &amp;=b+c\\\\\n      &amp;=e+f\n\\end{split}\n\\end{equation}\n</p>\n<hr>\n<figure class=\"highlight latex\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">$</span><span class=\"built_in\">$</span></span><br><span class=\"line\"><span class=\"keyword\">\\begin</span>&#123;align&#125;</span><br><span class=\"line\">   a<span class=\"built_in\">&amp;</span>=b+c <span class=\"keyword\">\\\\</span></span><br><span class=\"line\">   d+e<span class=\"built_in\">&amp;</span>=f</span><br><span class=\"line\"><span class=\"keyword\">\\end</span>&#123;align&#125;</span><br><span class=\"line\"><span class=\"built_in\">$</span><span class=\"built_in\">$</span></span><br></pre></td></tr></table></figure>\n<p class='katex-block katex-error' title='ParseError: KaTeX parse error: No such environment: align at position 7: \\begin{̲a̲l̲i̲g̲n̲}̲\n   a&amp;=b+c \\\\\n …'>\\begin{align}\n   a&amp;=b+c \\\\\n   d+e&amp;=f\n\\end{align}\n</p>\n<hr>\n<figure class=\"highlight latex\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">$</span><span class=\"built_in\">$</span></span><br><span class=\"line\"><span class=\"keyword\">\\begin</span>&#123;CD&#125;</span><br><span class=\"line\">   A @&gt;a&gt;&gt; B <span class=\"keyword\">\\\\</span></span><br><span class=\"line\">@VbVV @AAcA <span class=\"keyword\">\\\\</span></span><br><span class=\"line\">   C @= D</span><br><span class=\"line\"><span class=\"keyword\">\\end</span>&#123;CD&#125;</span><br><span class=\"line\"><span class=\"built_in\">$</span><span class=\"built_in\">$</span></span><br></pre></td></tr></table></figure>\n<p class='katex-block katex-error' title='ParseError: KaTeX parse error: No such environment: CD at position 7: \\begin{̲C̲D̲}̲\n   A @&gt;a&gt;&gt; B \\…'>\\begin{CD}\n   A @&gt;a&gt;&gt; B \\\\\n@VbVV @AAcA \\\\\n   C @= D\n\\end{CD}\n</p>\n","content_text":"摘要 Hexo是基于markdown的，所以可以使用LaTex语法来编写数学公式，只不过需要安装相应的公式渲染插件来实现。 Next主题 支持的公式插件为MathJax和KaTeX，它们都支持LaTex语法，参考: https://theme-next.js.org/docs/third-party-services/math-equations 本文使用的是Katex，原因是我已经使用了hexo-renderer-markdown-it渲染器，其与 mathjax 的 hexo-renderer-pandoc渲染器不能并存，所以只能选Katex了。 安装 详细的安装方法请参考:Math Equations 因为已经使用了hexo-renderer-markdown-it渲染器，所以这里就没有使用hexo-renderer-markdown-it-plus渲染器，其实两者也没有太大的区别，只不过后者默认就加载了一些插件，而前者需要自己安装插件并配置才可以使用。 但是测试时发现，按照官网的配置hexo-renderer-markdown-it + markdown-it-katex 的方式并不能很好的进行公式的渲染，所以这里参考了 hexo-renderer-markdown-it-plus 渲染器，将其更换为@iktakahiro/markdown-it-katex。 1npm install @iktakahiro/markdown-it-katex --save 在_config.yml配置上该插件 123456789101112# config of hexo-renderer-markdown-itmarkdown: render: html: true xhtmlOut: false breaks: true linkify: true typographer: true quotes: &#x27;“”‘’&#x27; plugins: # katex公式 - &quot;@iktakahiro/markdown-it-katex&quot; 安装后遇到的问题 1.安装后发现通过hexo编译时会报类似如下警告 1LaTeX-incompatible input and strict mode is set to &#x27;warn&#x27;: Unicode text character &quot;即&quot; used in math mode [unicodeTextInMathMode] 原因是@iktakahiro/markdown-it-katex插件默认开启的是严格模式，不能在$$...$$或$...$中包含中文，虽然我设置的是math -- every_page: false，但其在编译阶段依旧会检查所有的页面，不过报这个警告并不会有什么影响，所以可以忽略。 如果不希望看到这个警告，可以为 @iktakahiro/markdown-it-katex 添加模式的控制行为 1234567891011121314# config of hexo-renderer-markdown-itmarkdown: render: html: true xhtmlOut: false breaks: true linkify: true typographer: true quotes: &#x27;“”‘’&#x27; plugins: # katex公式 - name: &quot;@iktakahiro/markdown-it-katex&quot; options: strict: error # 默认为warn，这里设置为error，只有当解析器遇到不支持的公式时才报错，也可以设置为 false，表示不检查 不支持Katex的Auto-render Extension 通过查看Katex官网可以知道，开启Auto-render Extension后，Katex可以渲染更多的公式语法，但要注意这并不是LaTex的标准语法 但是@iktakahiro/markdown-it-katex中并没有相应的配置，为了解决这个问题，简单的方法就是将所需要的资源添加到页面中，比如我在source\\_data\\post-body-start.njk中添加了如下内容 1234567891011121314151617181920212223242526&#123;%- if page.mathjax %&#125;&lt;link rel=&quot;stylesheet&quot; href=&quot;https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css&quot; integrity=&quot;sha384-nB0miv6/jRmo5UMMR1wu3Gz6NLsoTkbqJghGIsx//Rlm+ZU03BU6SQNC66uf4l5+&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;script defer src=&quot;https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js&quot; integrity=&quot;sha384-7zkQWkzuo3B5mTepMUcHkMB5jZaolc2xDwL6VFqjFALcbeS9Ggm/Yr2r3Dy4lfFg&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt;&lt;script defer src=&quot;https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js&quot; integrity=&quot;sha384-43gviWU0YVjaDtb/GhzOouOXtZMP/7XUzwPTstBeZFe/+rCMvRwr4yROQP43s0Xk&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt;&lt;script&gt; document.addEventListener(&quot;DOMContentLoaded&quot;, function() &#123; renderMathInElement(document.body, &#123; // customised options // • auto-render specific keys, e.g.: delimiters: [ &#123;left: &quot;$$&quot;, right: &quot;$$&quot;, display: true&#125;, &#123;left: &quot;\\\\(&quot;, right: &quot;\\\\)&quot;, display: false&#125;, &#123;left: &quot;\\\\begin&#123;equation&#125;&quot;, right: &quot;\\\\end&#123;equation&#125;&quot;, display: true&#125;, &#123;left: &quot;\\\\begin&#123;align&#125;&quot;, right: &quot;\\\\end&#123;align&#125;&quot;, display: true&#125;, &#123;left: &quot;\\\\begin&#123;alignat&#125;&quot;, right: &quot;\\\\end&#123;alignat&#125;&quot;, display: true&#125;, &#123;left: &quot;\\\\begin&#123;gather&#125;&quot;, right: &quot;\\\\end&#123;gather&#125;&quot;, display: true&#125;, &#123;left: &quot;\\\\begin&#123;CD&#125;&quot;, right: &quot;\\\\end&#123;CD&#125;&quot;, display: true&#125;, &#123;left: &quot;\\\\[&quot;, right: &quot;\\\\]&quot;, display: true&#125; ], // • rendering keys, e.g.: throwOnError : false &#125;); &#125;);&lt;/script&gt;&#123;%- endif %&#125; 小贴士 可以通过next模板的_config.yml中的custom_file_path配置项来自定义渲染页面的某个部分，这样对应的每个页面都会加上该模板内容 12custom_file_path: postBodyStart: source/_data/post-body-start.njk 使用hexo-renderer-markdown-it-plus渲染器时，如果修改了页面的内容，此时刷新页面，会发现页面中的公式不能被渲染了，只能重新启动hexo服务。 但是使用hexo-renderer-markdown-it渲染器时，刷新页面后公式就可以被渲染了。 使用 每个页面的front-matter中要添加mathjax: true，这样在页面中就可以使用公式了。 Katex公式的渲染方式支持$...$和$$...$$两种方式 $...$为行级公式 1$sin(\\omega t)=\\frac&#123;1&#125;&#123;2j&#125;(e^&#123;j\\omega t&#125;-e^&#123;-j\\omega t&#125;)$ sin(ωt)=12j(ejωt−e−jωt)sin(\\omega t)=\\frac{1}{2j}(e^{j\\omega t}-e^{-j\\omega t})sin(ωt)=2j1​(ejωt−e−jωt) $$...$$为块级公式，独占一行且居中展示 123$$sin(\\omega t)=\\frac&#123;1&#125;&#123;2j&#125;(e^&#123;j\\omega t&#125;-e^&#123;-j\\omega t&#125;)$$ sin(ωt)=12j(ejωt−e−jωt)sin(\\omega t)=\\frac{1}{2j}(e^{j\\omega t}-e^{-j\\omega t}) sin(ωt)=2j1​(ejωt−e−jωt) $$...$$和$...$中不能出现Unicode字符，否则会报错，即不支持中文，如果需要显示中文，则需要使用\\text&#123;中文&#125; 块级公式，在开头的$$之前和结尾的$$之后，不得有任何字符（空格除外） 行级公式，在开头的$之后和结尾的$之前，不得有空格 示例 使用方式可以参考 KaTeX公式符号 以及 维基百科：LaTeX公式手册 不过记住这些公式符号还是比较困难的，这里推荐两个工具 MyScript: 手写转LaTeX公式，直接将你需要的数学公式画出来，它会自动将其转换为LaTeX公式，然后复制即可 LaTeX公式编辑器: 提供公式模板、图片识别(有次数限制)等功能，并且支持输出各种格式。 Simpletex: 支持LaTex公式图片识别和手写转公式，且无次数限制，但是需要注册账号。同时也提供了客户端版本。 这里随便给几个示例，以下是LaTeX的标准语法 1234$$\\left(\\beta m c^2 + c \\left(\\sum_&#123;n=1&#125;^3\\alpha_n p_n\\right)\\right) \\psi(x,t)= i\\hbar \\frac&#123;\\partial \\psi(x,t)&#125;&#123;\\partial t&#125;$$ (βmc2+c(∑n=13αnpn))ψ(x,t)=iℏ∂ψ(x,t)∂t\\left(\\beta m c^2 + c \\left(\\sum_{n=1}^3\\alpha_n p_n\\right)\\right) \\psi(x,t) = i\\hbar \\frac{\\partial \\psi(x,t)}{\\partial t} (βmc2+c(n=1∑3​αn​pn​))ψ(x,t)=iℏ∂t∂ψ(x,t)​ 1Aha! $E = mc^&#123;2&#125;$. Aha! E=mc2E = mc^{2}E=mc2. 123$$\\left(\\LARGE&#123;AB&#125;\\right)$$ (AB)\\left(\\LARGE{AB}\\right) (AB) 123456$$\\begin&#123;matrix&#125; a &amp; b \\\\ c &amp; d\\end&#123;matrix&#125;$$ abcd\\begin{matrix} a &amp; b \\\\ c &amp; d \\end{matrix} ac​bd​ 123456789$$\\def\\arraystretch&#123;1.5&#125; \\begin&#123;array&#125;&#123;c:c:c&#125; a &amp; b &amp; c \\\\ \\hline d &amp; e &amp; f \\\\ \\hdashline g &amp; h &amp; i\\end&#123;array&#125;$$ abcdefghi\\def\\arraystretch{1.5} \\begin{array}{c:c:c} a &amp; b &amp; c \\\\ \\hline d &amp; e &amp; f \\\\ \\hdashline g &amp; h &amp; i \\end{array} adg​beh​cfi​​ 1$\\tilde&#123;a&#125;$ &amp;nbsp;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; $\\underrightarrow&#123;AB&#125;$ a~\\tilde{a}a~ AB→\\underrightarrow{AB}AB​ 1234567891011$$\\tilde&#123;a&#125; \\underrightarrow&#123;AB&#125;\\begin&#123;array&#125;&#123;l&#125; a\\mathop&#123;x&#125;\\nolimits^&#123;2&#125;+bx+c=0 \\\\ \\Delta =\\mathop&#123;b&#125;\\nolimits^&#123;2&#125;-4ac \\\\ \\left\\&#123;\\begin&#123;matrix&#125; \\Delta \\gt 0\\text&#123;方程有两个不相等的实根&#125; \\\\ \\Delta = 0\\text&#123;方程有两个相等的实根&#125; \\\\ \\Delta \\lt 0\\text&#123;方程无实根&#125;\\end&#123;matrix&#125;\\right.\\end&#123;array&#125;$$ a~AB→ax2+bx+c=0Δ=b2−4ac{Δ&gt;0 方程有两个不相等的实根Δ=0 方程有两个相等的实根Δ&lt;0 方程无实根\\tilde{a} \\underrightarrow{AB}\\begin{array}{l} a\\mathop{x}\\nolimits^{2}+bx+c=0 \\\\ \\Delta =\\mathop{b}\\nolimits^{2}-4ac \\\\ \\left\\{\\begin{matrix} \\Delta \\gt 0\\text{ 方程有两个不相等的实根} \\\\ \\Delta = 0\\text{ 方程有两个相等的实根} \\\\ \\Delta \\lt 0\\text{ 方程无实根} \\end{matrix}\\right. \\end{array} a~AB​ax2+bx+c=0Δ=b2−4ac⎩⎪⎨⎪⎧​Δ&gt;0 方程有两个不相等的实根Δ=0 方程有两个相等的实根Δ&lt;0 方程无实根​​ 以下为开启Auto-render Extension后支持的公式语法，并不是LaTex的标准语法 1234567$$\\begin&#123;equation&#125;\\begin&#123;split&#125; a &amp;=b+c\\\\ &amp;=e+f\\end&#123;split&#125;\\end&#123;equation&#125;$$ \\begin{equation} \\begin{split} a &amp;=b+c\\\\ &amp;=e+f \\end{split} \\end{equation} 123456$$\\begin&#123;align&#125; a&amp;=b+c \\\\ d+e&amp;=f\\end&#123;align&#125;$$ \\begin{align} a&amp;=b+c \\\\ d+e&amp;=f \\end{align} 1234567$$\\begin&#123;CD&#125; A @&gt;a&gt;&gt; B \\\\@VbVV @AAcA \\\\ C @= D\\end&#123;CD&#125;$$ \\begin{CD} A @&gt;a&gt;&gt; B \\\\ @VbVV @AAcA \\\\ C @= D \\end{CD}","summary":"摘要 Hexo是基于markdown的，所以可以使用LaTex语法来编写数学公式，只不过需要安装相应的公式渲染插件来实现。 Next主题 支持的公式插件为MathJax和KaTeX，它们都支持LaTex语法，参考: https://theme-next.js.org/docs/third-party-services/math-equations 本文使用的是Katex，原因是我已经使用了hexo-renderer-markdown-it渲染器，其与 mathjax 的 hexo-renderer-pandoc渲染器不能并存，所以只能选Katex了。","date_published":"2024-11-12T13:55:05.000Z","tags":["Hexo","Hexo"]},{"id":"https://blog.hanqunfeng.com/2024/09/05/linux-zabbix_vfs_fs_inode/","url":"https://blog.hanqunfeng.com/2024/09/05/linux-zabbix_vfs_fs_inode/","title":"zabbix监控告警--vfs.fs.inode不足5%的解决过程","content_html":"<!--\n **加粗**\n *斜体*\n ***加粗并斜体***\n ~~删除线~~\n ==突出显示==\n `突出显示(推荐)`\n ++下划线++\n ~下标~\n ^上标^\n 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.\n 图片设置宽度和高度(通过uPic上传后，需要将upic修改过为blog，用于添加水印) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)\n\n +++ **点击折叠**\n 这是被隐藏的内容\n +++\n\n::: tips success warning danger\n这里是容器内的内容\n:::\n\n% note info % success warning danger\n这里是容器内的内容\n% endnote %\n\n -->\n<h2 id=\"摘要\">摘要</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>解决Linux索引节点(inode)用满导致故障的方法</p>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"zabbix告警\">zabbix告警</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vfs.fs.inode[/,pfree]):5 %</span><br></pre></td></tr></table></figure>\n<h2 id=\"解决过程\">解决过程</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>登录linux系统后查看inode使用情况和磁盘使用情况</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># inode 不足了</span></span><br><span class=\"line\"><span class=\"built_in\">df</span> -hi</span><br><span class=\"line\">文件系统\t      Inode  已用(I)  可用(I) 已用(I)%% 挂载点</span><br><span class=\"line\">/dev/xvda1              1.9M    1.8M     96K   96% /</span><br><span class=\"line\">tmpfs                   251K       1    251K    1% /dev/shm</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># disk 充足</span></span><br><span class=\"line\"><span class=\"built_in\">df</span> -hT</span><br><span class=\"line\">文件系统    类型      容量  已用  可用 已用%% 挂载点</span><br><span class=\"line\">/dev/xvda1    ext4     30G   18G   12G  61% /</span><br><span class=\"line\">tmpfs        tmpfs   1003M     0 1003M   0% /dev/shm</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>根据上面的查询结果初步判断是系统产生了大量的临时文件导致inode用尽了</p>\n</li>\n<li class=\"lvl-2\">\n<p>排查到底哪个目录下的文件数过多</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 通过下面的命令统计文件数量前十名，这里发现是/var目录中文件异常的多</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> /*; <span class=\"keyword\">do</span> <span class=\"built_in\">echo</span> <span class=\"string\">&quot;<span class=\"subst\">$(find $i |wc -l)</span>:<span class=\"variable\">$i</span>&quot;</span>; <span class=\"keyword\">done</span> | <span class=\"built_in\">sort</span> -nr | <span class=\"built_in\">head</span> -n 10</span><br><span class=\"line\">1815728:/var</span><br><span class=\"line\">52498:/usr</span><br><span class=\"line\">18804:/proc</span><br><span class=\"line\">7333:/sys</span><br><span class=\"line\">1834:/lib</span><br><span class=\"line\">1447:/opt</span><br><span class=\"line\">1047:/etc</span><br><span class=\"line\">457:/dev</span><br><span class=\"line\">411:/lib64</span><br><span class=\"line\">245:/sbin</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 接着查看/var中的文件数量</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> /var/*; <span class=\"keyword\">do</span> <span class=\"built_in\">echo</span> <span class=\"string\">&quot;<span class=\"subst\">$(find $i |wc -l)</span>:<span class=\"variable\">$i</span>&quot;</span>; <span class=\"keyword\">done</span> | <span class=\"built_in\">sort</span> -nr | <span class=\"built_in\">head</span> -n 10</span><br><span class=\"line\">1813442:/var/spool</span><br><span class=\"line\">2033:/var/lib</span><br><span class=\"line\">85:/var/cache</span><br><span class=\"line\">82:/var/log</span><br><span class=\"line\">39:/var/run</span><br><span class=\"line\">24:/var/lock</span><br><span class=\"line\">7:/var/db</span><br><span class=\"line\">3:/var/yp</span><br><span class=\"line\">2:/var/empty</span><br><span class=\"line\">2:/var/account</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 接着查看/var/spool中的文件数量，这里基本定位到是/var/spool/clientmqueue目录</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> /var/spool/*; <span class=\"keyword\">do</span> <span class=\"built_in\">echo</span> <span class=\"string\">&quot;<span class=\"subst\">$(find $i |wc -l)</span>:<span class=\"variable\">$i</span>&quot;</span>; <span class=\"keyword\">done</span> | <span class=\"built_in\">sort</span> -nr | <span class=\"built_in\">head</span> -n 10</span><br><span class=\"line\">1812413:/var/spool/clientmqueue</span><br><span class=\"line\">7:/var/spool/mail</span><br><span class=\"line\">4:/var/spool/anacron</span><br><span class=\"line\">3:/var/spool/at</span><br><span class=\"line\">2:/var/spool/cron</span><br><span class=\"line\">1:/var/spool/mqueue</span><br><span class=\"line\">1:/var/spool/lpd</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>百度一下<code>/var/spool/clientmqueue</code>目录的作用</p>\n</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">‌Linux文件目录 /var/spool/clientmqueue/ 下的文件主要是由cron任务产生的输出文件。‌ 当cron任务中有输出内容时，如果服务器上没有配置sendmail服务，这些输出内容就会被保存到 /var/spool/clientmqueue/ 目录内。这是因为cron任务中的命令如果有输出（比如错误信息或者正常的输出信息），默认会通过sendmail发送，但如果服务器上没有配置sendmail服务，这些输出内容就会被保存到 /var/spool/clientmqueue/ 目录中。因此，这个目录下主要包含的是由cron任务产生的输出文件，这些文件记录了cron任务执行过程中的输出信息。</span><br><span class=\"line\"></span><br><span class=\"line\">如果需要处理这些文件，可以通过修改crontab配置来实现。具体来说，可以在每个cron任务命令的末尾添加重定向操作，将输出内容抛弃，例如使用命令 &gt;/dev/null 2&gt;&amp;1。这样，无论标准输出还是错误输出都会被重定向到 /dev/null，即被抛弃，从而避免在 /var/spool/clientmqueue/ 目录下产生不必要的文件。</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>上面的解释说明<code>/var/spool/clientmqueue</code>目录下的文件可以被删除，所以直接删了就可以解决该问题了</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 文件数量过多，不能这么删除</span></span><br><span class=\"line\"><span class=\"comment\"># rm -rf /var/spool/clientmqueue/*</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 正确方法</span></span><br><span class=\"line\">find /var/spool/clientmqueue -name <span class=\"string\">&quot;*&quot;</span> -<span class=\"built_in\">type</span> f | xargs <span class=\"built_in\">rm</span> -rf</span><br></pre></td></tr></table></figure>\n<h2 id=\"详解inode\">详解inode</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>inode是文件系统内一个重要的数据结构，它用来描述一个文件，包括文件名、文件类型、权限、所有者、创建时间、修改时间等。在Linux系统中，每个文件都有一个唯一的inode号，这个inode号是分配给该文件的，并且不能被改变。</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看当前目录的inode号</span></span><br><span class=\"line\"><span class=\"built_in\">ls</span> -li</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>操作系统打开文件时会按如下步骤执行：</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">查找文件名称对应的inode号</li>\n<li class=\"lvl-6\">根据inode号获取inode信息</li>\n<li class=\"lvl-6\">根据inode信息找到文件对应的数据块，读出数据</li>\n</ul>\n</li>\n<li class=\"lvl-2\">\n<p>inode的大小是有限制的，通常取决于文件系统和操作系统。在大多数Linux文件系统中，inode大小通常是128字节或256字节。这是由文件系统在格式化时决定的，并且格式化后不能更改。</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看inode大小</span></span><br><span class=\"line\">dumpe2fs /dev/xvda1 | grep <span class=\"string\">&quot;Inode size&quot;</span></span><br><span class=\"line\">dumpe2fs 1.43.5 (04-Aug-2017)</span><br><span class=\"line\">Inode size:\t          256</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>查看文件系统的inode总数</p>\n</li>\n</ul>\n<blockquote>\n<p>一个inode只对应一个实际文件，所以inodes最大数量就是文件的最大数量。</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看所有挂载磁盘</span></span><br><span class=\"line\"><span class=\"built_in\">df</span> -i</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看指定磁盘</span></span><br><span class=\"line\"><span class=\"built_in\">df</span> -i /dev/xvda1</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>不同的文件系统默认的inode数量不同，以<code>1G</code>磁盘空间为例，<code>ext4</code>文件系统默认为<code>65536</code>，<code>xfs</code>文件系统默认为<code>52万</code>(每2k设置一个inode)，并且<code>xfs</code>会动态扩容inode数量。</p>\n</li>\n</ul>\n","content_text":"摘要 解决Linux索引节点(inode)用满导致故障的方法 zabbix告警 1vfs.fs.inode[/,pfree]):5 % 解决过程 登录linux系统后查看inode使用情况和磁盘使用情况 1234567891011# inode 不足了df -hi文件系统 Inode 已用(I) 可用(I) 已用(I)%% 挂载点/dev/xvda1 1.9M 1.8M 96K 96% /tmpfs 251K 1 251K 1% /dev/shm# disk 充足df -hT文件系统 类型 容量 已用 可用 已用%% 挂载点/dev/xvda1 ext4 30G 18G 12G 61% /tmpfs tmpfs 1003M 0 1003M 0% /dev/shm 根据上面的查询结果初步判断是系统产生了大量的临时文件导致inode用尽了 排查到底哪个目录下的文件数过多 1234567891011121314151617181920212223242526272829303132333435# 通过下面的命令统计文件数量前十名，这里发现是/var目录中文件异常的多for i in /*; do echo &quot;$(find $i |wc -l):$i&quot;; done | sort -nr | head -n 101815728:/var52498:/usr18804:/proc7333:/sys1834:/lib1447:/opt1047:/etc457:/dev411:/lib64245:/sbin# 接着查看/var中的文件数量for i in /var/*; do echo &quot;$(find $i |wc -l):$i&quot;; done | sort -nr | head -n 101813442:/var/spool2033:/var/lib85:/var/cache82:/var/log39:/var/run24:/var/lock7:/var/db3:/var/yp2:/var/empty2:/var/account# 接着查看/var/spool中的文件数量，这里基本定位到是/var/spool/clientmqueue目录for i in /var/spool/*; do echo &quot;$(find $i |wc -l):$i&quot;; done | sort -nr | head -n 101812413:/var/spool/clientmqueue7:/var/spool/mail4:/var/spool/anacron3:/var/spool/at2:/var/spool/cron1:/var/spool/mqueue1:/var/spool/lpd 百度一下/var/spool/clientmqueue目录的作用 123‌Linux文件目录 /var/spool/clientmqueue/ 下的文件主要是由cron任务产生的输出文件。‌ 当cron任务中有输出内容时，如果服务器上没有配置sendmail服务，这些输出内容就会被保存到 /var/spool/clientmqueue/ 目录内。这是因为cron任务中的命令如果有输出（比如错误信息或者正常的输出信息），默认会通过sendmail发送，但如果服务器上没有配置sendmail服务，这些输出内容就会被保存到 /var/spool/clientmqueue/ 目录中。因此，这个目录下主要包含的是由cron任务产生的输出文件，这些文件记录了cron任务执行过程中的输出信息。如果需要处理这些文件，可以通过修改crontab配置来实现。具体来说，可以在每个cron任务命令的末尾添加重定向操作，将输出内容抛弃，例如使用命令 &gt;/dev/null 2&gt;&amp;1。这样，无论标准输出还是错误输出都会被重定向到 /dev/null，即被抛弃，从而避免在 /var/spool/clientmqueue/ 目录下产生不必要的文件。 上面的解释说明/var/spool/clientmqueue目录下的文件可以被删除，所以直接删了就可以解决该问题了 12345# 文件数量过多，不能这么删除# rm -rf /var/spool/clientmqueue/*# 正确方法find /var/spool/clientmqueue -name &quot;*&quot; -type f | xargs rm -rf 详解inode inode是文件系统内一个重要的数据结构，它用来描述一个文件，包括文件名、文件类型、权限、所有者、创建时间、修改时间等。在Linux系统中，每个文件都有一个唯一的inode号，这个inode号是分配给该文件的，并且不能被改变。 12# 查看当前目录的inode号ls -li 操作系统打开文件时会按如下步骤执行： 查找文件名称对应的inode号 根据inode号获取inode信息 根据inode信息找到文件对应的数据块，读出数据 inode的大小是有限制的，通常取决于文件系统和操作系统。在大多数Linux文件系统中，inode大小通常是128字节或256字节。这是由文件系统在格式化时决定的，并且格式化后不能更改。 1234# 查看inode大小dumpe2fs /dev/xvda1 | grep &quot;Inode size&quot;dumpe2fs 1.43.5 (04-Aug-2017)Inode size: 256 查看文件系统的inode总数 一个inode只对应一个实际文件，所以inodes最大数量就是文件的最大数量。 12345# 查看所有挂载磁盘df -i# 查看指定磁盘df -i /dev/xvda1 不同的文件系统默认的inode数量不同，以1G磁盘空间为例，ext4文件系统默认为65536，xfs文件系统默认为52万(每2k设置一个inode)，并且xfs会动态扩容inode数量。","summary":"摘要 解决Linux索引节点(inode)用满导致故障的方法","date_published":"2024-09-05T14:30:05.000Z","tags":["技术","linux","zabbix","linux","zabbix"]},{"id":"https://blog.hanqunfeng.com/2024/08/02/gradle-depoly-maven-center-repository-new/","url":"https://blog.hanqunfeng.com/2024/08/02/gradle-depoly-maven-center-repository-new/","title":"发布Jar到Maven中央仓库--Gradle版(最新方式)","content_html":"<h2 id=\"摘要\">摘要</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\"><a href=\"https://oss.sonatype.org\">https://oss.sonatype.org</a>已经不再支持新用户注册，新的注册地址为<a href=\"https://central.sonatype.com\">https://central.sonatype.com</a></li>\n<li class=\"lvl-2\">通过本文，你将知道如何将Gradle构建的项目发布到Maven中央仓库</li>\n<li class=\"lvl-2\">Maven构建方式请看 <a href=\"/2024/08/01/mvn-depoly-maven-center-repository-new/\" title=\"发布Jar到Maven中央仓库--Maven版(最新方式)\">发布Jar到Maven中央仓库--Maven版(最新方式)</a> 。</li>\n<li class=\"lvl-2\">前三个步骤与 <a href=\"/2024/08/01/mvn-depoly-maven-center-repository-new/\" title=\"发布Jar到Maven中央仓库--Maven版(最新方式)\">发布Jar到Maven中央仓库--Maven版(最新方式)</a> 相同，不在赘述。</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"一、将项目推送到远程仓库，如-Github或者Gitee\">一、将项目推送到远程仓库，如 <code>Github</code>或者<code>Gitee</code></h2>\n<h2 id=\"二、注册-Sonatype-账户\">二、注册 <code>Sonatype</code> 账户</h2>\n<h2 id=\"三、登录-Sonatype-创建Namespace\">三、登录 Sonatype 创建<code>Namespace</code></h2>\n<p>前三个步骤与 <a href=\"/2024/08/01/mvn-depoly-maven-center-repository-new/\" title=\"发布Jar到Maven中央仓库--Maven版(最新方式)\">发布Jar到Maven中央仓库--Maven版(最新方式)</a> 相同，不在赘述。</p>\n<h2 id=\"四、发布\">四、发布</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>签名<br>\n我是mac电脑，于是签名工具使用的是<a href=\"https://gpgtools.org\">https://gpgtools.org</a>，gradle签名时需要使用到<code>.gpg</code>证书文件，这个工具不支持直接导出<code>.gpg</code>，其导出的证书文件是<code>.asc</code>格式的，<code>asc</code>其实就是<code>字符串</code>，可以用记事本打开查看。</p>\n<p>使用如下命令导出<code>.gpg</code>格式的证书：</p>\n  <figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 列出当前全部证书</span></span><br><span class=\"line\">gpg -k</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 导出私钥，qunfeng_han@126.com是创建证书时使用的邮箱，会要求你输入创建证书时的密码</span></span><br><span class=\"line\">gpg --output private.pgp --armor --export-secret-key qunfeng_han@126.com</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 导出公钥</span></span><br><span class=\"line\">gpg --output public.pgp --armor --<span class=\"built_in\">export</span> qunfeng_han@126.com</span><br></pre></td></tr></table></figure>\n</li>\n<li class=\"lvl-2\">\n<p>build.gradle<br>\n官方没有出gradle发布插件，但是<a href=\"https://central.sonatype.org/publish/publish-portal-gradle/\">官网</a>推荐使用第三方的<a href=\"https://jreleaser.org/guide/latest/examples/maven/maven-central.html#_gradle\">jreleaser</a>插件。</p>\n</li>\n</ul>\n<figure class=\"highlight gradle\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">plugins &#123;</span><br><span class=\"line\"><span class=\"comment\">//    id &#x27;io.spring.dependency-management&#x27; version &#x27;1.0.10.RELEASE&#x27;</span></span><br><span class=\"line\">    id <span class=\"string\">&#x27;io.spring.dependency-management&#x27;</span> version <span class=\"string\">&#x27;1.1.6&#x27;</span></span><br><span class=\"line\">    <span class=\"comment\">//此处必须是java-library，如果是java则api方法不可用，api可以理解为就是compile，支持传递依赖</span></span><br><span class=\"line\">    id <span class=\"string\">&#x27;java-library&#x27;</span></span><br><span class=\"line\">    <span class=\"comment\">//发布插件</span></span><br><span class=\"line\">    id <span class=\"string\">&#x27;maven-publish&#x27;</span></span><br><span class=\"line\">    <span class=\"comment\">//自动发布到maven中央仓库插件</span></span><br><span class=\"line\">    <span class=\"comment\">//https://jreleaser.org/guide/latest/examples/maven/maven-central.html#_gradle</span></span><br><span class=\"line\">    id <span class=\"string\">&#x27;org.jreleaser&#x27;</span> version <span class=\"string\">&#x27;1.13.1&#x27;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">group</span> = <span class=\"string\">&#x27;io.github.hanqunfeng&#x27;</span></span><br><span class=\"line\"><span class=\"comment\">//version = &#x27;1.0.0-SNAPSHOT&#x27;</span></span><br><span class=\"line\">version = <span class=\"string\">&#x27;1.0.1&#x27;</span></span><br><span class=\"line\"><span class=\"keyword\">sourceCompatibility</span> = <span class=\"string\">&#x27;1.8&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">java &#123;</span><br><span class=\"line\">    withJavadocJar()</span><br><span class=\"line\">    withSourcesJar()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">repositories</span> &#123;</span><br><span class=\"line\">    maven &#123; url <span class=\"string\">&#x27;https://maven.aliyun.com/repository/public/&#x27;</span> &#125;</span><br><span class=\"line\">    mavenLocal()</span><br><span class=\"line\">    mavenCentral()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">dependencyManagement &#123;</span><br><span class=\"line\">    imports &#123; mavenBom(<span class=\"string\">&quot;software.amazon.awssdk:bom:2.23.10&quot;</span>) &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">dependencies</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">//lombok</span></span><br><span class=\"line\">    compileOnly <span class=\"string\">&#x27;org.projectlombok:lombok:1.18.32&#x27;</span></span><br><span class=\"line\">    annotationProcessor <span class=\"string\">&#x27;org.projectlombok:lombok:1.18.32&#x27;</span></span><br><span class=\"line\">    api <span class=\"string\">&#x27;software.amazon.awssdk:s3&#x27;</span></span><br><span class=\"line\">    api <span class=\"string\">&#x27;software.amazon.awssdk:apache-client&#x27;</span></span><br><span class=\"line\">    api <span class=\"string\">&#x27;software.amazon.awssdk:s3-transfer-manager&#x27;</span></span><br><span class=\"line\">    api <span class=\"string\">&#x27;software.amazon.awssdk:aws-crt-client&#x27;</span></span><br><span class=\"line\">    api <span class=\"string\">&#x27;org.springframework:spring-core:5.3.29&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// java编译的时候缺省状态下会因为中文字符而失败</span></span><br><span class=\"line\">[compileJava, compileTestJava]*.<span class=\"keyword\">options</span>*.encoding = <span class=\"string\">&#x27;UTF-8&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 发布插件</span></span><br><span class=\"line\"><span class=\"comment\"> * 参考：https://docs.gradle.org/6.6.1/userguide/publishing_maven.html#publishing_maven:resolved_dependencies</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> * 发布为bom，参考：https://zhuanlan.zhihu.com/p/195678201</span></span><br><span class=\"line\"><span class=\"comment\"> * 注意：java-platform不能与java和java-library同时存在</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\">publishing &#123;</span><br><span class=\"line\">    publications &#123;</span><br><span class=\"line\">        maven(MavenPublication) &#123;</span><br><span class=\"line\">            groupId = <span class=\"keyword\">project</span>.<span class=\"keyword\">group</span></span><br><span class=\"line\">            artifactId = <span class=\"keyword\">project</span>.name</span><br><span class=\"line\">            version = <span class=\"keyword\">project</span>.version</span><br><span class=\"line\">            <span class=\"comment\">//如果不定义，则会按照以上默认值执行</span></span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">from</span> components.java</span><br><span class=\"line\"></span><br><span class=\"line\">            pom &#123;</span><br><span class=\"line\">                name = <span class=\"string\">&#x27;aws-s3-v2-tools-gradle&#x27;</span></span><br><span class=\"line\">                <span class=\"keyword\">description</span> = <span class=\"string\">&#x27;AWS S3 Tools.&#x27;</span></span><br><span class=\"line\">                url = <span class=\"string\">&#x27;https://blog.hanqunfeng.com&#x27;</span></span><br><span class=\"line\">                licenses &#123;</span><br><span class=\"line\">                    license &#123;</span><br><span class=\"line\">                        name = <span class=\"string\">&#x27;The Apache License, Version 2.0&#x27;</span></span><br><span class=\"line\">                        url = <span class=\"string\">&#x27;http://www.apache.org/licenses/LICENSE-2.0.txt&#x27;</span></span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                developers &#123;</span><br><span class=\"line\">                    developer &#123;</span><br><span class=\"line\">                        id = <span class=\"string\">&#x27;hanqf&#x27;</span></span><br><span class=\"line\">                        name = <span class=\"string\">&#x27;han qunfeng&#x27;</span></span><br><span class=\"line\">                        email = <span class=\"string\">&#x27;qunfeng_han@126.com&#x27;</span></span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                scm &#123;</span><br><span class=\"line\">                    connection = <span class=\"string\">&#x27;scm:git:https://github.com/hanqunfeng/aws-s3-v2-tools-gradle.git&#x27;</span></span><br><span class=\"line\">                    developerConnection = <span class=\"string\">&#x27;scm:git:https://github.com:hanqunfeng/aws-s3-v2-tools-gradle.git&#x27;</span></span><br><span class=\"line\">                    url = <span class=\"string\">&#x27;https://github.com/hanqunfeng/aws-s3-v2-tools-gradle&#x27;</span></span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            versionMapping &#123;</span><br><span class=\"line\">                usage(<span class=\"string\">&#x27;java-api&#x27;</span>) &#123;</span><br><span class=\"line\">                    fromResolutionOf(<span class=\"string\">&#x27;runtimeClasspath&#x27;</span>)</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                usage(<span class=\"string\">&#x27;java-runtime&#x27;</span>) &#123;</span><br><span class=\"line\">                    fromResolutionResult()</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">repositories</span> &#123;</span><br><span class=\"line\">        maven &#123;</span><br><span class=\"line\">            url = layout.buildDirectory.dir(<span class=\"string\">&#x27;staging-deploy&#x27;</span>)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">tasks.withType(JavaCompile) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">options</span>.encoding = <span class=\"string\">&#x27;UTF-8&#x27;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//javadoc，如果用jdk11，默认就支持中文</span></span><br><span class=\"line\"><span class=\"comment\">//查看可以配置的属性：https://docs.gradle.org/current/javadoc/org/gradle/external/javadoc/StandardJavadocDocletOptions.html</span></span><br><span class=\"line\">tasks.withType(Javadoc) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">options</span>.version = <span class=\"keyword\">true</span></span><br><span class=\"line\">    <span class=\"keyword\">options</span>.author = <span class=\"keyword\">true</span></span><br><span class=\"line\">    <span class=\"keyword\">options</span>.encoding = <span class=\"string\">&quot;UTF-8&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">options</span>.charSet = <span class=\"string\">&quot;UTF-8&quot;</span>  <span class=\"comment\">//解决中文乱码</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">javadoc &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (JavaVersion.current().isJava9Compatible()) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">options</span>.addBooleanOption(<span class=\"string\">&#x27;html5&#x27;</span>, <span class=\"keyword\">true</span>)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (JavaVersion.current().isJava8Compatible()) &#123;</span><br><span class=\"line\">        tasks.withType(Javadoc) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// disable the crazy super-strict doclint tool in Java 8</span></span><br><span class=\"line\">            <span class=\"comment\">// noinspection SpellCheckingInspection</span></span><br><span class=\"line\">            <span class=\"keyword\">options</span>.addStringOption(<span class=\"string\">&#x27;Xdoclint:none&#x27;</span>, <span class=\"string\">&#x27;-quiet&#x27;</span>)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// jreleaser配置文件：~/.jreleaser/config.toml</span></span><br><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">JRELEASER_MAVENCENTRAL_USERNAME = &quot;&lt;your-publisher-portal-username&gt;&quot;</span></span><br><span class=\"line\"><span class=\"comment\">JRELEASER_MAVENCENTRAL_PASSWORD = &quot;&lt;your-publisher-portal-password&gt;&quot;</span></span><br><span class=\"line\"><span class=\"comment\">JRELEASER_NEXUS2_USERNAME = &quot;&lt;your-sonatype-account-username&gt;&quot;</span></span><br><span class=\"line\"><span class=\"comment\">JRELEASER_NEXUS2_PASSWORD = &quot;&lt;your-sonatype-account-password&gt;&quot;</span></span><br><span class=\"line\"><span class=\"comment\">JRELEASER_GPG_PASSPHRASE = &quot;&lt;your-pgp-passphrase&gt;&quot;</span></span><br><span class=\"line\"><span class=\"comment\">JRELEASER_GITHUB_TOKEN = &quot;&lt;your-github-token&quot;</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\">jreleaser &#123;</span><br><span class=\"line\">    signing &#123;</span><br><span class=\"line\">        active = <span class=\"string\">&#x27;ALWAYS&#x27;</span></span><br><span class=\"line\">        armored = <span class=\"keyword\">true</span></span><br><span class=\"line\">        mode = <span class=\"string\">&#x27;FILE&#x27;</span></span><br><span class=\"line\">        publicKey = <span class=\"string\">&#x27;/Users/hanqf/develop_soft/gpg_key/hanqf/public.pgp&#x27;</span></span><br><span class=\"line\">        secretKey = <span class=\"string\">&#x27;/Users/hanqf/develop_soft/gpg_key/hanqf/private.pgp&#x27;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    deploy &#123;</span><br><span class=\"line\">        maven &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">/* Portal Publisher API */</span></span><br><span class=\"line\">            mavenCentral &#123;</span><br><span class=\"line\">                sonatype &#123;</span><br><span class=\"line\">                    active = <span class=\"string\">&#x27;ALWAYS&#x27;</span></span><br><span class=\"line\">                    url = <span class=\"string\">&#x27;https://central.sonatype.com/api/v1/publisher&#x27;</span></span><br><span class=\"line\">                    stagingRepository(<span class=\"string\">&#x27;build/staging-deploy&#x27;</span>)</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>~/.jreleaser/config.toml ：配置相关认证信息</p>\n</li>\n</ul>\n<figure class=\"highlight properties\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># https://central.sonatype.com 的认证信息</span></span><br><span class=\"line\"><span class=\"attr\">JRELEASER_MAVENCENTRAL_USERNAME</span> = <span class=\"string\">&quot;&lt;your-publisher-portal-username&gt;&quot;</span></span><br><span class=\"line\"><span class=\"attr\">JRELEASER_MAVENCENTRAL_PASSWORD</span> = <span class=\"string\">&quot;&lt;your-publisher-portal-password&gt;&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># https://oss.sonatype.org 的认证信息，这里没有用到，可以不进行配置</span></span><br><span class=\"line\"><span class=\"attr\">JRELEASER_NEXUS2_USERNAME</span> = <span class=\"string\">&quot;&lt;your-sonatype-account-username&gt;&quot;</span></span><br><span class=\"line\"><span class=\"attr\">JRELEASER_NEXUS2_PASSWORD</span> = <span class=\"string\">&quot;&lt;your-sonatype-account-password&gt;&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># 创建 pgp 密钥时的密码</span></span><br><span class=\"line\"><span class=\"attr\">JRELEASER_GPG_PASSPHRASE</span> = <span class=\"string\">&quot;&lt;your-pgp-passphrase&gt;&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># github token</span></span><br><span class=\"line\"><span class=\"attr\">JRELEASER_GITHUB_TOKEN</span> = <span class=\"string\">&quot;&lt;your-github-token&quot;</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>执行命令</p>\n</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./gradlew jreleaserConfig <span class=\"comment\"># 验证配置文件是否正确</span></span><br><span class=\"line\">./gradlew clean publish <span class=\"comment\"># 发布到本地 build/staging-deploy</span></span><br><span class=\"line\">./gradlew jreleaserFullRelease <span class=\"comment\"># 发布到远程Maven中央仓库</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>更新部署<br>\n与 <a href=\"/2024/08/01/mvn-depoly-maven-center-repository-new/\" title=\"发布Jar到Maven中央仓库--Maven版(最新方式)\">发布Jar到Maven中央仓库--Maven版(最新方式)</a> 中的描述类似，只需要修改<code>build.gradle</code>中对应的版本号后重新执行上面的发布命令即可，发布的jar包可以在<a href=\"https://central.sonatype.com\">https://central.sonatype.com</a>中检索。</p>\n</li>\n</ul>\n","content_text":"摘要 https://oss.sonatype.org已经不再支持新用户注册，新的注册地址为https://central.sonatype.com 通过本文，你将知道如何将Gradle构建的项目发布到Maven中央仓库 Maven构建方式请看 发布Jar到Maven中央仓库--Maven版(最新方式) 。 前三个步骤与 发布Jar到Maven中央仓库--Maven版(最新方式) 相同，不在赘述。 一、将项目推送到远程仓库，如 Github或者Gitee 二、注册 Sonatype 账户 三、登录 Sonatype 创建Namespace 前三个步骤与 发布Jar到Maven中央仓库--Maven版(最新方式) 相同，不在赘述。 四、发布 签名 我是mac电脑，于是签名工具使用的是https://gpgtools.org，gradle签名时需要使用到.gpg证书文件，这个工具不支持直接导出.gpg，其导出的证书文件是.asc格式的，asc其实就是字符串，可以用记事本打开查看。 使用如下命令导出.gpg格式的证书： 12345678# 列出当前全部证书gpg -k# 导出私钥，qunfeng_han@126.com是创建证书时使用的邮箱，会要求你输入创建证书时的密码gpg --output private.pgp --armor --export-secret-key qunfeng_han@126.com# 导出公钥gpg --output public.pgp --armor --export qunfeng_han@126.com build.gradle 官方没有出gradle发布插件，但是官网推荐使用第三方的jreleaser插件。 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170plugins &#123;// id &#x27;io.spring.dependency-management&#x27; version &#x27;1.0.10.RELEASE&#x27; id &#x27;io.spring.dependency-management&#x27; version &#x27;1.1.6&#x27; //此处必须是java-library，如果是java则api方法不可用，api可以理解为就是compile，支持传递依赖 id &#x27;java-library&#x27; //发布插件 id &#x27;maven-publish&#x27; //自动发布到maven中央仓库插件 //https://jreleaser.org/guide/latest/examples/maven/maven-central.html#_gradle id &#x27;org.jreleaser&#x27; version &#x27;1.13.1&#x27;&#125;group = &#x27;io.github.hanqunfeng&#x27;//version = &#x27;1.0.0-SNAPSHOT&#x27;version = &#x27;1.0.1&#x27;sourceCompatibility = &#x27;1.8&#x27;java &#123; withJavadocJar() withSourcesJar()&#125;repositories &#123; maven &#123; url &#x27;https://maven.aliyun.com/repository/public/&#x27; &#125; mavenLocal() mavenCentral()&#125;dependencyManagement &#123; imports &#123; mavenBom(&quot;software.amazon.awssdk:bom:2.23.10&quot;) &#125;&#125;dependencies &#123; //lombok compileOnly &#x27;org.projectlombok:lombok:1.18.32&#x27; annotationProcessor &#x27;org.projectlombok:lombok:1.18.32&#x27; api &#x27;software.amazon.awssdk:s3&#x27; api &#x27;software.amazon.awssdk:apache-client&#x27; api &#x27;software.amazon.awssdk:s3-transfer-manager&#x27; api &#x27;software.amazon.awssdk:aws-crt-client&#x27; api &#x27;org.springframework:spring-core:5.3.29&#x27;&#125;// java编译的时候缺省状态下会因为中文字符而失败[compileJava, compileTestJava]*.options*.encoding = &#x27;UTF-8&#x27;/** * 发布插件 * 参考：https://docs.gradle.org/6.6.1/userguide/publishing_maven.html#publishing_maven:resolved_dependencies * * 发布为bom，参考：https://zhuanlan.zhihu.com/p/195678201 * 注意：java-platform不能与java和java-library同时存在 */publishing &#123; publications &#123; maven(MavenPublication) &#123; groupId = project.group artifactId = project.name version = project.version //如果不定义，则会按照以上默认值执行 from components.java pom &#123; name = &#x27;aws-s3-v2-tools-gradle&#x27; description = &#x27;AWS S3 Tools.&#x27; url = &#x27;https://blog.hanqunfeng.com&#x27; licenses &#123; license &#123; name = &#x27;The Apache License, Version 2.0&#x27; url = &#x27;http://www.apache.org/licenses/LICENSE-2.0.txt&#x27; &#125; &#125; developers &#123; developer &#123; id = &#x27;hanqf&#x27; name = &#x27;han qunfeng&#x27; email = &#x27;qunfeng_han@126.com&#x27; &#125; &#125; scm &#123; connection = &#x27;scm:git:https://github.com/hanqunfeng/aws-s3-v2-tools-gradle.git&#x27; developerConnection = &#x27;scm:git:https://github.com:hanqunfeng/aws-s3-v2-tools-gradle.git&#x27; url = &#x27;https://github.com/hanqunfeng/aws-s3-v2-tools-gradle&#x27; &#125; &#125; versionMapping &#123; usage(&#x27;java-api&#x27;) &#123; fromResolutionOf(&#x27;runtimeClasspath&#x27;) &#125; usage(&#x27;java-runtime&#x27;) &#123; fromResolutionResult() &#125; &#125; &#125; &#125; repositories &#123; maven &#123; url = layout.buildDirectory.dir(&#x27;staging-deploy&#x27;) &#125; &#125;&#125;tasks.withType(JavaCompile) &#123; options.encoding = &#x27;UTF-8&#x27;&#125;//javadoc，如果用jdk11，默认就支持中文//查看可以配置的属性：https://docs.gradle.org/current/javadoc/org/gradle/external/javadoc/StandardJavadocDocletOptions.htmltasks.withType(Javadoc) &#123; options.version = true options.author = true options.encoding = &quot;UTF-8&quot; options.charSet = &quot;UTF-8&quot; //解决中文乱码&#125;javadoc &#123; if (JavaVersion.current().isJava9Compatible()) &#123; options.addBooleanOption(&#x27;html5&#x27;, true) &#125; if (JavaVersion.current().isJava8Compatible()) &#123; tasks.withType(Javadoc) &#123; // disable the crazy super-strict doclint tool in Java 8 // noinspection SpellCheckingInspection options.addStringOption(&#x27;Xdoclint:none&#x27;, &#x27;-quiet&#x27;) &#125; &#125;&#125;// jreleaser配置文件：~/.jreleaser/config.toml/*JRELEASER_MAVENCENTRAL_USERNAME = &quot;&lt;your-publisher-portal-username&gt;&quot;JRELEASER_MAVENCENTRAL_PASSWORD = &quot;&lt;your-publisher-portal-password&gt;&quot;JRELEASER_NEXUS2_USERNAME = &quot;&lt;your-sonatype-account-username&gt;&quot;JRELEASER_NEXUS2_PASSWORD = &quot;&lt;your-sonatype-account-password&gt;&quot;JRELEASER_GPG_PASSPHRASE = &quot;&lt;your-pgp-passphrase&gt;&quot;JRELEASER_GITHUB_TOKEN = &quot;&lt;your-github-token&quot; */jreleaser &#123; signing &#123; active = &#x27;ALWAYS&#x27; armored = true mode = &#x27;FILE&#x27; publicKey = &#x27;/Users/hanqf/develop_soft/gpg_key/hanqf/public.pgp&#x27; secretKey = &#x27;/Users/hanqf/develop_soft/gpg_key/hanqf/private.pgp&#x27; &#125; deploy &#123; maven &#123; /* Portal Publisher API */ mavenCentral &#123; sonatype &#123; active = &#x27;ALWAYS&#x27; url = &#x27;https://central.sonatype.com/api/v1/publisher&#x27; stagingRepository(&#x27;build/staging-deploy&#x27;) &#125; &#125; &#125; &#125;&#125; ~/.jreleaser/config.toml ：配置相关认证信息 12345678910# https://central.sonatype.com 的认证信息JRELEASER_MAVENCENTRAL_USERNAME = &quot;&lt;your-publisher-portal-username&gt;&quot;JRELEASER_MAVENCENTRAL_PASSWORD = &quot;&lt;your-publisher-portal-password&gt;&quot;# https://oss.sonatype.org 的认证信息，这里没有用到，可以不进行配置JRELEASER_NEXUS2_USERNAME = &quot;&lt;your-sonatype-account-username&gt;&quot;JRELEASER_NEXUS2_PASSWORD = &quot;&lt;your-sonatype-account-password&gt;&quot;# 创建 pgp 密钥时的密码JRELEASER_GPG_PASSPHRASE = &quot;&lt;your-pgp-passphrase&gt;&quot;# github tokenJRELEASER_GITHUB_TOKEN = &quot;&lt;your-github-token&quot; 执行命令 123./gradlew jreleaserConfig # 验证配置文件是否正确./gradlew clean publish # 发布到本地 build/staging-deploy./gradlew jreleaserFullRelease # 发布到远程Maven中央仓库 更新部署 与 发布Jar到Maven中央仓库--Maven版(最新方式) 中的描述类似，只需要修改build.gradle中对应的版本号后重新执行上面的发布命令即可，发布的jar包可以在https://central.sonatype.com中检索。","summary":"摘要 https://oss.sonatype.org已经不再支持新用户注册，新的注册地址为https://central.sonatype.com 通过本文，你将知道如何将Gradle构建的项目发布到Maven中央仓库 Maven构建方式请看 发布Jar到Maven中央仓库--Maven版(最新方式) 。 前三个步骤与 发布Jar到Maven中央仓库--Maven版(最新方式) 相同，不在赘述。","date_published":"2024-08-02T13:30:05.000Z","tags":["技术","maven","gradle"]},{"id":"https://blog.hanqunfeng.com/2024/08/01/mvn-depoly-maven-center-repository-new/","url":"https://blog.hanqunfeng.com/2024/08/01/mvn-depoly-maven-center-repository-new/","title":"发布Jar到Maven中央仓库--Maven版(最新方式)","content_html":"<h2 id=\"摘要\">摘要</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\"><a href=\"https://oss.sonatype.org\">https://oss.sonatype.org</a>已经不再支持新用户注册，新的注册地址为<a href=\"https://central.sonatype.com\">https://central.sonatype.com</a></li>\n<li class=\"lvl-2\">通过本文，你将知道如何将Maven构建的项目发布到Maven中央仓库</li>\n<li class=\"lvl-2\">Gradle构建方式请看 <a href=\"/2024/08/02/gradle-depoly-maven-center-repository-new/\" title=\"发布Jar到Maven中央仓库--Gradle版(最新方式)\">发布Jar到Maven中央仓库--Gradle版(最新方式)</a> 。</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"一、将项目推送到远程仓库，如-Github或者Gitee\">一、将项目推送到远程仓库，如 <code>Github</code>或者<code>Gitee</code></h2>\n<h2 id=\"二、注册-Sonatype-账户\">二、注册 <code>Sonatype</code> 账户</h2>\n<p>进入 <a href=\"https://central.sonatype.com\">https://central.sonatype.com</a> 注册一个账号，邮箱要真实。</p>\n<h2 id=\"三、登录-Sonatype-创建Namespace\">三、登录 Sonatype 创建<code>Namespace</code></h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>进入 Namespace 模块，然后点击 Add Namespace 按钮，Namespace 具有唯一性</p>\n</li>\n<li class=\"lvl-2\">\n<p>发布前一定要创建<code>Namespace</code>，实际上就是项目的<code>Group Id</code>，因为要进行验证，所以这里不能随便填写，你可以配置为你拥有的域名，比如我的域名是<code>hanqunfeng.com</code>，这里就填写<code>com.hanqunfeng</code>。域名的验证方法是配置DNS TXT记录。</p>\n</li>\n<li class=\"lvl-2\">\n<p>如果你没有域名，也可以使用Github的域名，比如我的Github用户名是<code>hanqunfeng</code>，则这里可以配置为<code>io.github.hanqunfeng</code>。Github的验证方式是根据给定个名称创建一个public repository。</p>\n</li>\n</ul>\n<h2 id=\"四、发布\">四、发布</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>1.准备签名</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">可以使用工具创建密钥对<br>\n需要下载一个签名工具，我是mac电脑，下载的是<a href=\"https://gpgtools.org\">https://gpgtools.org</a>。<br>\n安装后点击新建，按照提示创建一个密钥对即可，注意高级选项里有个过期时间，默认是<code>3年</code>。创建好后会主动提示你是否将公钥发布到<code>key server</code>，点击<code>Upload Public key</code>即可。也可以在创建后的证书列表页面邮件选择<code>证书</code>–&gt;<code>Send Public Key To Key Server</code>。</li>\n</ul>\n<p>导出证书时，勾选密码并设置密码就是私钥和公钥证书，不勾选密码就是公钥，看生成文件的名称就可以，公开就是公钥，私密就是私钥，格式都是<code>asc</code>，其实就是<code>字符串</code>，可以用记事本打开查看。</p>\n<p>如果windows系统，可以下载<a href=\"https://www.gpg4win.org/\">https://www.gpg4win.org/</a> ，使用方式差不多，最后点击“将公钥上传的目录服务”。</p>\n<p>公钥发布到<code>key server</code>后要稍微等一会，大约<code>10分钟</code>吧，因为<code>key server</code>有多个，同步需要一些时间。<br>\n记住你创建密钥对时的密码，发布项目时要使用。</p>\n<ul class=\"lvl-2\">\n<li class=\"lvl-6\">\n<p>也可以使用命令行创建密钥对，版本<code>[gpg (GnuPG/MacGPG2) 2.2.24]</code></p>\n  <figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 创建密钥对，按提示输入用户名称和邮箱地址</span></span><br><span class=\"line\">gpg --generate-key</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 列出密钥，hanqunfeng就是创建密钥对是的用户名，此处也可以使用邮箱</span></span><br><span class=\"line\"><span class=\"comment\"># 结果中第二行一长串的后8位就是keyId，比如：30FF8D58，gradle构建时会用到</span></span><br><span class=\"line\">gpg --list-keys hanqunfeng</span><br><span class=\"line\"><span class=\"comment\"># 也可以直接通过id查询</span></span><br><span class=\"line\">gpg --list-keys 30FF8D58</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 上传公钥到server key，默认上传到hkps://keys.openpgp.org，但是提示上传失败</span></span><br><span class=\"line\"><span class=\"comment\"># 看到网上的示例可以通过--keyserver指定上传的服务器地址，但是我这个版本[gpg (GnuPG/MacGPG2) 2.2.24]没有这个参数</span></span><br><span class=\"line\"><span class=\"comment\"># 使用 https://gpgtools.org 上传公钥就会成功</span></span><br><span class=\"line\">gpg --send-keys 30FF8D58</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看指纹</span></span><br><span class=\"line\">gpg --fingerprint 30FF8D58</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 删除私钥，这里也可以使用用户名称或者邮箱，如果唯一的话</span></span><br><span class=\"line\">gpg --delete-secret-keys 30FF8D58</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 删除公钥</span></span><br><span class=\"line\">gpg --delete-keys 30FF8D58</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</li>\n<li class=\"lvl-2\">\n<p>2.settings.xml<br>\n配置 <code>maven</code> 的 <code>settings.xml</code> 文件，设置一个 <code>server</code>，里面添加 <code>User Token</code>。</p>\n</li>\n</ul>\n<blockquote>\n<p>登录<a href=\"https://central.sonatype.com\">https://central.sonatype.com</a>后点击右上角的用户名称–&gt; View Account --&gt; Generate User Token</p>\n</blockquote>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">settings</span>&gt;</span></span><br><span class=\"line\">    [...]</span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">servers</span>&gt;</span></span><br><span class=\"line\">       [...]</span><br><span class=\"line\">       <span class=\"tag\">&lt;<span class=\"name\">server</span>&gt;</span></span><br><span class=\"line\">          <span class=\"tag\">&lt;<span class=\"name\">id</span>&gt;</span>maven-central<span class=\"tag\">&lt;/<span class=\"name\">id</span>&gt;</span></span><br><span class=\"line\">          <span class=\"tag\">&lt;<span class=\"name\">username</span>&gt;</span>username<span class=\"tag\">&lt;/<span class=\"name\">username</span>&gt;</span></span><br><span class=\"line\">          <span class=\"tag\">&lt;<span class=\"name\">password</span>&gt;</span>token<span class=\"tag\">&lt;/<span class=\"name\">password</span>&gt;</span></span><br><span class=\"line\">       <span class=\"tag\">&lt;/<span class=\"name\">server</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">servers</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">settings</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>3.pom.xml，重点是后面几个plugin<br>\n这里重点说一下<code>central-publishing-maven-plugin</code>这个插件，该插件会将jar包推送到<code>Maven Central</code>仓库，如果插件没有配置参数<code>autoPublish</code>为<code>true</code>，则但此时发布的jar会处于<code>VALIDATED</code>状态，需要登录<a href=\"https://central.sonatype.com\">https://central.sonatype.com</a>后切换到Deployment，找到我们刚刚上传的包名，然后点击右侧的<code>Publish</code>按钮，如果一切顺利，大于10分钟后其状态变为<code>PUBLISHED</code>，表示发布成功。如果发布失败，其状态会变更为<code>FAILED</code>，可以在<code>Component Summary</code>中查看失败原因，重新发布即可。</p>\n</li>\n</ul>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">project</span> <span class=\"attr\">xmlns</span>=<span class=\"string\">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class=\"attr\">xmlns:xsi</span>=<span class=\"string\">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">         <span class=\"attr\">xsi:schemaLocation</span>=<span class=\"string\">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">modelVersion</span>&gt;</span>4.0.0<span class=\"tag\">&lt;/<span class=\"name\">modelVersion</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>io.github.hanqunfeng<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>aws-s3-v2-tools<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>1.0.1<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">packaging</span>&gt;</span>jar<span class=\"tag\">&lt;/<span class=\"name\">packaging</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>aws-s3-v2-tools<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">description</span>&gt;</span></span><br><span class=\"line\">        AWS S3 Tools.</span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">description</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">url</span>&gt;</span>https://blog.hanqunfeng.com<span class=\"tag\">&lt;/<span class=\"name\">url</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">licenses</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">license</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>The Apache License, Version 2.0<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">url</span>&gt;</span>http://www.apache.org/licenses/LICENSE-2.0.txt<span class=\"tag\">&lt;/<span class=\"name\">url</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">license</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">licenses</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">developers</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">developer</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">id</span>&gt;</span>hanqf<span class=\"tag\">&lt;/<span class=\"name\">id</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>hanqunfeng<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">email</span>&gt;</span>qunfeng_han@126.com<span class=\"tag\">&lt;/<span class=\"name\">email</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">developer</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">developers</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">scm</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">connection</span>&gt;</span>scm:git:https://github.com/hanqunfeng/aws-s3-v2-tools.git</span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">connection</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">developerConnection</span>&gt;</span></span><br><span class=\"line\">            scm:git:https://github.com:hanqunfeng/aws-s3-v2-tools.git</span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">developerConnection</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">url</span>&gt;</span>https://github.com/hanqunfeng/aws-s3-v2-tools<span class=\"tag\">&lt;/<span class=\"name\">url</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">scm</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">properties</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">java.version</span>&gt;</span>1.8<span class=\"tag\">&lt;/<span class=\"name\">java.version</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">maven.compiler.source</span>&gt;</span>8<span class=\"tag\">&lt;/<span class=\"name\">maven.compiler.source</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">maven.compiler.target</span>&gt;</span>8<span class=\"tag\">&lt;/<span class=\"name\">maven.compiler.target</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class=\"tag\">&lt;/<span class=\"name\">project.build.sourceEncoding</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">properties</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">dependencyManagement</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dependencies</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>software.amazon.awssdk<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>bom<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>2.23.10<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">type</span>&gt;</span>pom<span class=\"tag\">&lt;/<span class=\"name\">type</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">scope</span>&gt;</span>import<span class=\"tag\">&lt;/<span class=\"name\">scope</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">dependencies</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">dependencyManagement</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">dependencies</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>software.amazon.awssdk<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>s3<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">&lt;!-- 为避免Potential Conflicts，你应该将commons-logging.jar从classpath中删除。你可以尝试从项目依赖中排除commons-logging，这样你的应用程序就会被强制使用Spring JCL而不是Commons Logging。 --&gt;</span></span><br><span class=\"line\">        <span class=\"comment\">&lt;!-- 问题：Standard Commons Logging discovery in action with spring-jcl: please remove commons-logging.jar from classpath in order to avoid potential conflicts --&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>software.amazon.awssdk<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>apache-client<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">exclusions</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">exclusion</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>commons-logging<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>commons-logging<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;/<span class=\"name\">exclusion</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">exclusions</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>software.amazon.awssdk<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>s3-transfer-manager<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>software.amazon.awssdk<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>aws-crt-client<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.projectlombok<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>lombok<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">optional</span>&gt;</span>true<span class=\"tag\">&lt;/<span class=\"name\">optional</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>1.18.32<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-core<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>5.3.29<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">dependencies</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">build</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">plugins</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">plugin</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.apache.maven.plugins<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>maven-compiler-plugin<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>3.8.1<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">configuration</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;<span class=\"name\">source</span>&gt;</span>$&#123;java.version&#125;<span class=\"tag\">&lt;/<span class=\"name\">source</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;<span class=\"name\">target</span>&gt;</span>$&#123;java.version&#125;<span class=\"tag\">&lt;/<span class=\"name\">target</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;/<span class=\"name\">configuration</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">plugin</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">plugin</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.apache.maven.plugins<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>maven-source-plugin<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>3.2.1<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">executions</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;<span class=\"name\">execution</span>&gt;</span></span><br><span class=\"line\">                        <span class=\"tag\">&lt;<span class=\"name\">id</span>&gt;</span>attach-source<span class=\"tag\">&lt;/<span class=\"name\">id</span>&gt;</span></span><br><span class=\"line\">                        <span class=\"tag\">&lt;<span class=\"name\">phase</span>&gt;</span>verify<span class=\"tag\">&lt;/<span class=\"name\">phase</span>&gt;</span></span><br><span class=\"line\">                        <span class=\"tag\">&lt;<span class=\"name\">goals</span>&gt;</span></span><br><span class=\"line\">                            <span class=\"comment\">&lt;!--生成源代码的jar --&gt;</span></span><br><span class=\"line\">                            <span class=\"tag\">&lt;<span class=\"name\">goal</span>&gt;</span>jar<span class=\"tag\">&lt;/<span class=\"name\">goal</span>&gt;</span></span><br><span class=\"line\">                        <span class=\"tag\">&lt;/<span class=\"name\">goals</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;/<span class=\"name\">execution</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;/<span class=\"name\">executions</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">plugin</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">plugin</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.apache.maven.plugins<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>maven-javadoc-plugin<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>3.2.0<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">executions</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;<span class=\"name\">execution</span>&gt;</span></span><br><span class=\"line\">                        <span class=\"tag\">&lt;<span class=\"name\">id</span>&gt;</span>attach-javadoc<span class=\"tag\">&lt;/<span class=\"name\">id</span>&gt;</span></span><br><span class=\"line\">                        <span class=\"tag\">&lt;<span class=\"name\">phase</span>&gt;</span>verify<span class=\"tag\">&lt;/<span class=\"name\">phase</span>&gt;</span></span><br><span class=\"line\">                        <span class=\"tag\">&lt;<span class=\"name\">goals</span>&gt;</span></span><br><span class=\"line\">                            <span class=\"comment\">&lt;!--生成javadoc的jar --&gt;</span></span><br><span class=\"line\">                            <span class=\"tag\">&lt;<span class=\"name\">goal</span>&gt;</span>jar<span class=\"tag\">&lt;/<span class=\"name\">goal</span>&gt;</span></span><br><span class=\"line\">                            <span class=\"comment\">&lt;!--生成javadoc的html --&gt;</span></span><br><span class=\"line\">                            <span class=\"tag\">&lt;<span class=\"name\">goal</span>&gt;</span>javadoc<span class=\"tag\">&lt;/<span class=\"name\">goal</span>&gt;</span></span><br><span class=\"line\">                        <span class=\"tag\">&lt;/<span class=\"name\">goals</span>&gt;</span></span><br><span class=\"line\">                        <span class=\"tag\">&lt;<span class=\"name\">configuration</span>&gt;</span></span><br><span class=\"line\">                            <span class=\"comment\">&lt;!--不显示javadoc警告--&gt;</span></span><br><span class=\"line\">                            <span class=\"tag\">&lt;<span class=\"name\">additionalOptions</span>&gt;</span>-Xdoclint:none<span class=\"tag\">&lt;/<span class=\"name\">additionalOptions</span>&gt;</span></span><br><span class=\"line\">                            <span class=\"tag\">&lt;<span class=\"name\">additionalJOption</span>&gt;</span>-Xdoclint:none<span class=\"tag\">&lt;/<span class=\"name\">additionalJOption</span>&gt;</span></span><br><span class=\"line\">                        <span class=\"tag\">&lt;/<span class=\"name\">configuration</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;/<span class=\"name\">execution</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;/<span class=\"name\">executions</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">plugin</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">&lt;!-- gpg plugin,用于签名认证 --&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">plugin</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.apache.maven.plugins<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>maven-gpg-plugin<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>1.6<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">executions</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;<span class=\"name\">execution</span>&gt;</span></span><br><span class=\"line\">                        <span class=\"tag\">&lt;<span class=\"name\">id</span>&gt;</span>sign-artifacts<span class=\"tag\">&lt;/<span class=\"name\">id</span>&gt;</span></span><br><span class=\"line\">                        <span class=\"tag\">&lt;<span class=\"name\">phase</span>&gt;</span>verify<span class=\"tag\">&lt;/<span class=\"name\">phase</span>&gt;</span></span><br><span class=\"line\">                        <span class=\"tag\">&lt;<span class=\"name\">goals</span>&gt;</span></span><br><span class=\"line\">                            <span class=\"tag\">&lt;<span class=\"name\">goal</span>&gt;</span>sign<span class=\"tag\">&lt;/<span class=\"name\">goal</span>&gt;</span></span><br><span class=\"line\">                        <span class=\"tag\">&lt;/<span class=\"name\">goals</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;/<span class=\"name\">execution</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;/<span class=\"name\">executions</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">plugin</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">&lt;!-- 发布到私服时需要注释掉下面两个插件 --&gt;</span></span><br><span class=\"line\">            <span class=\"comment\">&lt;!--staging puglin,用于自动执行发布阶段(免手动)--&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">plugin</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.sonatype.central<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>central-publishing-maven-plugin<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>0.5.0<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">extensions</span>&gt;</span>true<span class=\"tag\">&lt;/<span class=\"name\">extensions</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">configuration</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"comment\">&lt;!-- 这里的publishingServerId是在settings.xml中配置的server认证信息 --&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;<span class=\"name\">publishingServerId</span>&gt;</span>maven-central<span class=\"tag\">&lt;/<span class=\"name\">publishingServerId</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"comment\">&lt;!-- 这里的autoPublish是自动发布，而不是手动发布 --&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;<span class=\"name\">autoPublish</span>&gt;</span>true<span class=\"tag\">&lt;/<span class=\"name\">autoPublish</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"comment\">&lt;!-- 这里的waitUntil配置为published是等待发布完成，因为发布完成的时间比较长，所以可以不加这个参数 --&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;<span class=\"name\">waitUntil</span>&gt;</span>published<span class=\"tag\">&lt;/<span class=\"name\">waitUntil</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"comment\">&lt;!-- 这里的deploymentName是发布到中央仓库的名称 --&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;<span class=\"name\">deploymentName</span>&gt;</span>$&#123;project.groupId&#125;:$&#123;project.artifactId&#125;:$&#123;project.version&#125;<span class=\"tag\">&lt;/<span class=\"name\">deploymentName</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;/<span class=\"name\">configuration</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">plugin</span>&gt;</span></span><br><span class=\"line\">            <span class=\"comment\">&lt;!-- release plugin,用于发布到release仓库部署插件 --&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">plugin</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.apache.maven.plugins<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>maven-release-plugin<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>2.5.3<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">plugin</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">plugins</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">build</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">distributionManagement</span>&gt;</span></span><br><span class=\"line\">        <span class=\"comment\">&lt;!--        &lt;repository&gt;--&gt;</span></span><br><span class=\"line\">        <span class=\"comment\">&lt;!--            &lt;id&gt;maven-releases&lt;/id&gt;--&gt;</span></span><br><span class=\"line\">        <span class=\"comment\">&lt;!--            &lt;name&gt;Nexus Release Repository&lt;/name&gt;--&gt;</span></span><br><span class=\"line\">        <span class=\"comment\">&lt;!--            &lt;url&gt;http://nexus.cxzh.ltd:8081/repository/maven-releases/&lt;/url&gt;--&gt;</span></span><br><span class=\"line\">        <span class=\"comment\">&lt;!--        &lt;/repository&gt;--&gt;</span></span><br><span class=\"line\">        <span class=\"comment\">&lt;!--        &lt;snapshotRepository&gt;--&gt;</span></span><br><span class=\"line\">        <span class=\"comment\">&lt;!--            &lt;id&gt;maven-snapshots&lt;/id&gt;--&gt;</span></span><br><span class=\"line\">        <span class=\"comment\">&lt;!--            &lt;name&gt;Nexus Snapshot Repository&lt;/name&gt;--&gt;</span></span><br><span class=\"line\">        <span class=\"comment\">&lt;!--            &lt;url&gt;http://nexus.cxzh.ltd:8081/repository/maven-snapshots/&lt;/url&gt;--&gt;</span></span><br><span class=\"line\">        <span class=\"comment\">&lt;!--        &lt;/snapshotRepository&gt;--&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">distributionManagement</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">project</span>&gt;</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>4.执行命令</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mvn clean package <span class=\"comment\"># 完成打包和测试</span></span><br><span class=\"line\">mvn clean verify  <span class=\"comment\"># 完成源码打包和javadoc打包，同时完成签名</span></span><br><span class=\"line\">mvn clean deploy  <span class=\"comment\"># 完成本地部署和maven中央仓库部署</span></span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>4.1 执行过程中会提示你输入创建密钥对时的密码，如果不想人工参与，也可以使用如下方式（参考：<a href=\"http://maven.apache.org/plugins/maven-gpg-plugin/usage.html%EF%BC%89\">http://maven.apache.org/plugins/maven-gpg-plugin/usage.html）</a></p>\n</blockquote>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>a.在执行命令时指定密码：</p>\n  <figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mvn clean deploy -Dgpg.passphrase=thephrase</span><br></pre></td></tr></table></figure>\n</li>\n<li class=\"lvl-2\">\n<p>b.setting.xml中创建一个server</p>\n  <figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">settings</span>&gt;</span></span><br><span class=\"line\">[...]</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">servers</span>&gt;</span></span><br><span class=\"line\">    [...]</span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">server</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">id</span>&gt;</span>gpg.passphrase<span class=\"tag\">&lt;/<span class=\"name\">id</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">passphrase</span>&gt;</span>clear or encrypted text<span class=\"tag\">&lt;/<span class=\"name\">passphrase</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">server</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">servers</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">settings</span>&gt;</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>6.更新部署<br>\n修改<code>pom.xml</code>中的版本号，重新执行<code>mvn clean deploy</code>即可。发布的jar包可以在<a href=\"https://central.sonatype.com\">https://central.sonatype.com</a>中检索。</p>\n</li>\n</ul>\n","content_text":"摘要 https://oss.sonatype.org已经不再支持新用户注册，新的注册地址为https://central.sonatype.com 通过本文，你将知道如何将Maven构建的项目发布到Maven中央仓库 Gradle构建方式请看 发布Jar到Maven中央仓库--Gradle版(最新方式) 。 一、将项目推送到远程仓库，如 Github或者Gitee 二、注册 Sonatype 账户 进入 https://central.sonatype.com 注册一个账号，邮箱要真实。 三、登录 Sonatype 创建Namespace 进入 Namespace 模块，然后点击 Add Namespace 按钮，Namespace 具有唯一性 发布前一定要创建Namespace，实际上就是项目的Group Id，因为要进行验证，所以这里不能随便填写，你可以配置为你拥有的域名，比如我的域名是hanqunfeng.com，这里就填写com.hanqunfeng。域名的验证方法是配置DNS TXT记录。 如果你没有域名，也可以使用Github的域名，比如我的Github用户名是hanqunfeng，则这里可以配置为io.github.hanqunfeng。Github的验证方式是根据给定个名称创建一个public repository。 四、发布 1.准备签名 可以使用工具创建密钥对 需要下载一个签名工具，我是mac电脑，下载的是https://gpgtools.org。 安装后点击新建，按照提示创建一个密钥对即可，注意高级选项里有个过期时间，默认是3年。创建好后会主动提示你是否将公钥发布到key server，点击Upload Public key即可。也可以在创建后的证书列表页面邮件选择证书–&gt;Send Public Key To Key Server。 导出证书时，勾选密码并设置密码就是私钥和公钥证书，不勾选密码就是公钥，看生成文件的名称就可以，公开就是公钥，私密就是私钥，格式都是asc，其实就是字符串，可以用记事本打开查看。 如果windows系统，可以下载https://www.gpg4win.org/ ，使用方式差不多，最后点击“将公钥上传的目录服务”。 公钥发布到key server后要稍微等一会，大约10分钟吧，因为key server有多个，同步需要一些时间。 记住你创建密钥对时的密码，发布项目时要使用。 也可以使用命令行创建密钥对，版本[gpg (GnuPG/MacGPG2) 2.2.24] 12345678910111213141516171819202122# 创建密钥对，按提示输入用户名称和邮箱地址gpg --generate-key# 列出密钥，hanqunfeng就是创建密钥对是的用户名，此处也可以使用邮箱# 结果中第二行一长串的后8位就是keyId，比如：30FF8D58，gradle构建时会用到gpg --list-keys hanqunfeng# 也可以直接通过id查询gpg --list-keys 30FF8D58# 上传公钥到server key，默认上传到hkps://keys.openpgp.org，但是提示上传失败# 看到网上的示例可以通过--keyserver指定上传的服务器地址，但是我这个版本[gpg (GnuPG/MacGPG2) 2.2.24]没有这个参数# 使用 https://gpgtools.org 上传公钥就会成功gpg --send-keys 30FF8D58# 查看指纹gpg --fingerprint 30FF8D58# 删除私钥，这里也可以使用用户名称或者邮箱，如果唯一的话gpg --delete-secret-keys 30FF8D58# 删除公钥gpg --delete-keys 30FF8D58 2.settings.xml 配置 maven 的 settings.xml 文件，设置一个 server，里面添加 User Token。 登录https://central.sonatype.com后点击右上角的用户名称–&gt; View Account --&gt; Generate User Token 1234567891011&lt;settings&gt; [...] &lt;servers&gt; [...] &lt;server&gt; &lt;id&gt;maven-central&lt;/id&gt; &lt;username&gt;username&lt;/username&gt; &lt;password&gt;token&lt;/password&gt; &lt;/server&gt; &lt;/servers&gt;&lt;/settings&gt; 3.pom.xml，重点是后面几个plugin 这里重点说一下central-publishing-maven-plugin这个插件，该插件会将jar包推送到Maven Central仓库，如果插件没有配置参数autoPublish为true，则但此时发布的jar会处于VALIDATED状态，需要登录https://central.sonatype.com后切换到Deployment，找到我们刚刚上传的包名，然后点击右侧的Publish按钮，如果一切顺利，大于10分钟后其状态变为PUBLISHED，表示发布成功。如果发布失败，其状态会变更为FAILED，可以在Component Summary中查看失败原因，重新发布即可。 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt; &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt; &lt;groupId&gt;io.github.hanqunfeng&lt;/groupId&gt; &lt;artifactId&gt;aws-s3-v2-tools&lt;/artifactId&gt; &lt;version&gt;1.0.1&lt;/version&gt; &lt;packaging&gt;jar&lt;/packaging&gt; &lt;name&gt;aws-s3-v2-tools&lt;/name&gt; &lt;description&gt; AWS S3 Tools. &lt;/description&gt; &lt;url&gt;https://blog.hanqunfeng.com&lt;/url&gt; &lt;licenses&gt; &lt;license&gt; &lt;name&gt;The Apache License, Version 2.0&lt;/name&gt; &lt;url&gt;http://www.apache.org/licenses/LICENSE-2.0.txt&lt;/url&gt; &lt;/license&gt; &lt;/licenses&gt; &lt;developers&gt; &lt;developer&gt; &lt;id&gt;hanqf&lt;/id&gt; &lt;name&gt;hanqunfeng&lt;/name&gt; &lt;email&gt;qunfeng_han@126.com&lt;/email&gt; &lt;/developer&gt; &lt;/developers&gt; &lt;scm&gt; &lt;connection&gt;scm:git:https://github.com/hanqunfeng/aws-s3-v2-tools.git &lt;/connection&gt; &lt;developerConnection&gt; scm:git:https://github.com:hanqunfeng/aws-s3-v2-tools.git &lt;/developerConnection&gt; &lt;url&gt;https://github.com/hanqunfeng/aws-s3-v2-tools&lt;/url&gt; &lt;/scm&gt; &lt;properties&gt; &lt;java.version&gt;1.8&lt;/java.version&gt; &lt;maven.compiler.source&gt;8&lt;/maven.compiler.source&gt; &lt;maven.compiler.target&gt;8&lt;/maven.compiler.target&gt; &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt; &lt;/properties&gt; &lt;dependencyManagement&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;software.amazon.awssdk&lt;/groupId&gt; &lt;artifactId&gt;bom&lt;/artifactId&gt; &lt;version&gt;2.23.10&lt;/version&gt; &lt;type&gt;pom&lt;/type&gt; &lt;scope&gt;import&lt;/scope&gt; &lt;/dependency&gt; &lt;/dependencies&gt; &lt;/dependencyManagement&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;software.amazon.awssdk&lt;/groupId&gt; &lt;artifactId&gt;s3&lt;/artifactId&gt; &lt;/dependency&gt; &lt;!-- 为避免Potential Conflicts，你应该将commons-logging.jar从classpath中删除。你可以尝试从项目依赖中排除commons-logging，这样你的应用程序就会被强制使用Spring JCL而不是Commons Logging。 --&gt; &lt;!-- 问题：Standard Commons Logging discovery in action with spring-jcl: please remove commons-logging.jar from classpath in order to avoid potential conflicts --&gt; &lt;dependency&gt; &lt;groupId&gt;software.amazon.awssdk&lt;/groupId&gt; &lt;artifactId&gt;apache-client&lt;/artifactId&gt; &lt;exclusions&gt; &lt;exclusion&gt; &lt;groupId&gt;commons-logging&lt;/groupId&gt; &lt;artifactId&gt;commons-logging&lt;/artifactId&gt; &lt;/exclusion&gt; &lt;/exclusions&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;software.amazon.awssdk&lt;/groupId&gt; &lt;artifactId&gt;s3-transfer-manager&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;software.amazon.awssdk&lt;/groupId&gt; &lt;artifactId&gt;aws-crt-client&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.projectlombok&lt;/groupId&gt; &lt;artifactId&gt;lombok&lt;/artifactId&gt; &lt;optional&gt;true&lt;/optional&gt; &lt;version&gt;1.18.32&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework&lt;/groupId&gt; &lt;artifactId&gt;spring-core&lt;/artifactId&gt; &lt;version&gt;5.3.29&lt;/version&gt; &lt;/dependency&gt; &lt;/dependencies&gt; &lt;build&gt; &lt;plugins&gt; &lt;plugin&gt; &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt; &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt; &lt;version&gt;3.8.1&lt;/version&gt; &lt;configuration&gt; &lt;source&gt;$&#123;java.version&#125;&lt;/source&gt; &lt;target&gt;$&#123;java.version&#125;&lt;/target&gt; &lt;/configuration&gt; &lt;/plugin&gt; &lt;plugin&gt; &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt; &lt;artifactId&gt;maven-source-plugin&lt;/artifactId&gt; &lt;version&gt;3.2.1&lt;/version&gt; &lt;executions&gt; &lt;execution&gt; &lt;id&gt;attach-source&lt;/id&gt; &lt;phase&gt;verify&lt;/phase&gt; &lt;goals&gt; &lt;!--生成源代码的jar --&gt; &lt;goal&gt;jar&lt;/goal&gt; &lt;/goals&gt; &lt;/execution&gt; &lt;/executions&gt; &lt;/plugin&gt; &lt;plugin&gt; &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt; &lt;artifactId&gt;maven-javadoc-plugin&lt;/artifactId&gt; &lt;version&gt;3.2.0&lt;/version&gt; &lt;executions&gt; &lt;execution&gt; &lt;id&gt;attach-javadoc&lt;/id&gt; &lt;phase&gt;verify&lt;/phase&gt; &lt;goals&gt; &lt;!--生成javadoc的jar --&gt; &lt;goal&gt;jar&lt;/goal&gt; &lt;!--生成javadoc的html --&gt; &lt;goal&gt;javadoc&lt;/goal&gt; &lt;/goals&gt; &lt;configuration&gt; &lt;!--不显示javadoc警告--&gt; &lt;additionalOptions&gt;-Xdoclint:none&lt;/additionalOptions&gt; &lt;additionalJOption&gt;-Xdoclint:none&lt;/additionalJOption&gt; &lt;/configuration&gt; &lt;/execution&gt; &lt;/executions&gt; &lt;/plugin&gt; &lt;!-- gpg plugin,用于签名认证 --&gt; &lt;plugin&gt; &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt; &lt;artifactId&gt;maven-gpg-plugin&lt;/artifactId&gt; &lt;version&gt;1.6&lt;/version&gt; &lt;executions&gt; &lt;execution&gt; &lt;id&gt;sign-artifacts&lt;/id&gt; &lt;phase&gt;verify&lt;/phase&gt; &lt;goals&gt; &lt;goal&gt;sign&lt;/goal&gt; &lt;/goals&gt; &lt;/execution&gt; &lt;/executions&gt; &lt;/plugin&gt; &lt;!-- 发布到私服时需要注释掉下面两个插件 --&gt; &lt;!--staging puglin,用于自动执行发布阶段(免手动)--&gt; &lt;plugin&gt; &lt;groupId&gt;org.sonatype.central&lt;/groupId&gt; &lt;artifactId&gt;central-publishing-maven-plugin&lt;/artifactId&gt; &lt;version&gt;0.5.0&lt;/version&gt; &lt;extensions&gt;true&lt;/extensions&gt; &lt;configuration&gt; &lt;!-- 这里的publishingServerId是在settings.xml中配置的server认证信息 --&gt; &lt;publishingServerId&gt;maven-central&lt;/publishingServerId&gt; &lt;!-- 这里的autoPublish是自动发布，而不是手动发布 --&gt; &lt;autoPublish&gt;true&lt;/autoPublish&gt; &lt;!-- 这里的waitUntil配置为published是等待发布完成，因为发布完成的时间比较长，所以可以不加这个参数 --&gt; &lt;waitUntil&gt;published&lt;/waitUntil&gt; &lt;!-- 这里的deploymentName是发布到中央仓库的名称 --&gt; &lt;deploymentName&gt;$&#123;project.groupId&#125;:$&#123;project.artifactId&#125;:$&#123;project.version&#125;&lt;/deploymentName&gt; &lt;/configuration&gt; &lt;/plugin&gt; &lt;!-- release plugin,用于发布到release仓库部署插件 --&gt; &lt;plugin&gt; &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt; &lt;artifactId&gt;maven-release-plugin&lt;/artifactId&gt; &lt;version&gt;2.5.3&lt;/version&gt; &lt;/plugin&gt; &lt;/plugins&gt; &lt;/build&gt; &lt;distributionManagement&gt; &lt;!-- &lt;repository&gt;--&gt; &lt;!-- &lt;id&gt;maven-releases&lt;/id&gt;--&gt; &lt;!-- &lt;name&gt;Nexus Release Repository&lt;/name&gt;--&gt; &lt;!-- &lt;url&gt;http://nexus.cxzh.ltd:8081/repository/maven-releases/&lt;/url&gt;--&gt; &lt;!-- &lt;/repository&gt;--&gt; &lt;!-- &lt;snapshotRepository&gt;--&gt; &lt;!-- &lt;id&gt;maven-snapshots&lt;/id&gt;--&gt; &lt;!-- &lt;name&gt;Nexus Snapshot Repository&lt;/name&gt;--&gt; &lt;!-- &lt;url&gt;http://nexus.cxzh.ltd:8081/repository/maven-snapshots/&lt;/url&gt;--&gt; &lt;!-- &lt;/snapshotRepository&gt;--&gt; &lt;/distributionManagement&gt;&lt;/project&gt; 4.执行命令 123mvn clean package # 完成打包和测试mvn clean verify # 完成源码打包和javadoc打包，同时完成签名mvn clean deploy # 完成本地部署和maven中央仓库部署 4.1 执行过程中会提示你输入创建密钥对时的密码，如果不想人工参与，也可以使用如下方式（参考：http://maven.apache.org/plugins/maven-gpg-plugin/usage.html） a.在执行命令时指定密码： 1mvn clean deploy -Dgpg.passphrase=thephrase b.setting.xml中创建一个server 12345678910&lt;settings&gt;[...]&lt;servers&gt; [...] &lt;server&gt; &lt;id&gt;gpg.passphrase&lt;/id&gt; &lt;passphrase&gt;clear or encrypted text&lt;/passphrase&gt; &lt;/server&gt;&lt;/servers&gt;&lt;/settings&gt; 6.更新部署 修改pom.xml中的版本号，重新执行mvn clean deploy即可。发布的jar包可以在https://central.sonatype.com中检索。","summary":"摘要 https://oss.sonatype.org已经不再支持新用户注册，新的注册地址为https://central.sonatype.com 通过本文，你将知道如何将Maven构建的项目发布到Maven中央仓库 Gradle构建方式请看 发布Jar到Maven中央仓库--Gradle版(最新方式) 。","date_published":"2024-08-01T13:30:05.000Z","tags":["技术","maven","maven"]},{"id":"https://blog.hanqunfeng.com/2024/05/08/mysql8-upgrade/","url":"https://blog.hanqunfeng.com/2024/05/08/mysql8-upgrade/","title":"MySql--从Mysql5.7升级到Mysql8","content_html":"<!--\n **加粗**\n *斜体*\n ***加粗并斜体***\n ~~删除线~~\n ==突出显示==\n `突出显示(推荐)`\n ++下划线++\n ~下标~\n ^上标^\n 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.\n 图片设置宽度和高度(通过uPic上传后，需要将upic修改过为blog，用于添加水印) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)\n\n +++ **点击折叠**\n 这是被隐藏的内容\n +++\n -->\n<h2 id=\"摘要\">摘要</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>MySql知识点介绍:从Mysql5.7升级到Mysql8</p>\n</li>\n<li class=\"lvl-2\">\n<p>本文基于<code>mysql-8.0.30</code>，<a href=\"https://dev.mysql.com/doc/refman/8.0/en/\">https://dev.mysql.com/doc/refman/8.0/en/</a></p>\n</li>\n<li class=\"lvl-2\">\n<p>2024-04-30，<a href=\"https://dev.mysql.com/doc/relnotes/mysql/8.4/en/news-8-4-0.html\">mysql-8.4.0 LTS</a>版本发布，本文在将mysql从5.7.44升级到8.0.30的基础上，升级到8.4.0 LTS版本。<a href=\"https://dev.mysql.com/doc/refman/8.4/en/\">mysql-8.4.0 LTS官方文档</a></p>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"从Mysql5-7升级到Mysql8\">从Mysql5.7升级到Mysql8</h2>\n<p><em><strong>升级前，请先备份数据库，防止升级失败</strong></em></p>\n<h3 id=\"mysqlsh\">mysqlsh</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>在mysql8以前，升级mysql还是比较麻烦的，除了要处理不兼容的参数和语法外，而且不支持跨版本的升级，比如5.5必须先升级到5.6，然后再升级到5.7。</p>\n</li>\n<li class=\"lvl-2\">\n<p><code>mysqlsh</code>是mysql官方提供的一个命令行工具，是MySQL的高级客户端和代码编辑器。其不仅可以像使用<code>mysql</code>命令一样执行sql，而且还支持js脚本、python脚本，等等，具体可以查看<a href=\"https://dev.mysql.com/doc/mysql-shell/8.0/en/mysql-shell-commands.html\">官网</a>。</p>\n</li>\n<li class=\"lvl-2\">\n<p><code>mysqlsh</code>的众多功能之一就是可以检测当前版本是否可以升级到与当前<code>mysqlsh</code>相同的版本。</p>\n</li>\n<li class=\"lvl-2\">\n<p>如果你当前的版本是5.6，你甚至都不需要先将数据库升级到5.7就可以直接升级到8.0，因为mysql8.0支持mysql5.5到mysql8.0的升级。</p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://dev.mysql.com/doc/mysql-shell/8.0/en/\">mysqlsh官方文档</a></p>\n</li>\n</ul>\n<h4 id=\"安装mysqlsh\">安装mysqlsh</h4>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><a href=\"https://dev.mysql.com/downloads/shell/\">官网下载地址</a></p>\n</li>\n<li class=\"lvl-2\">\n<p>选择需要的版本进行下载，我这里选择下载的版本是<a href=\"https://downloads.mysql.com/archives/get/p/43/file/mysql-shell-8.0.30-linux-glibc2.12-x86-64bit.tar.gz\">linux的8.0.30版本</a></p>\n</li>\n<li class=\"lvl-2\">\n<p>下载后解压即可</p>\n</li>\n</ul>\n<h4 id=\"检查是否可以升级\">检查是否可以升级</h4>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><a href=\"https://dev.mysql.com/doc/mysql-shell/8.0/en/mysql-shell-utilities-upgrade.html\">官网说明</a></p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># mysqlsh8.4以前可以使用如下方法，因为其默认就是执行js代码</span></span><br><span class=\"line\">./mysqlsh username:password@host -e <span class=\"string\">&quot;util.checkForServerUpgrade()&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># mysqlsh8.4后默认执行的是sql代码，所以要先登录，切换到js环境后再运行上面的代码</span></span><br><span class=\"line\"><span class=\"comment\"># 登录</span></span><br><span class=\"line\">./mysqlsh username:password@host</span><br><span class=\"line\"> MySQL  localhost  SQL  &gt; \\js</span><br><span class=\"line\">Switching to JavaScript mode...</span><br><span class=\"line\"> MySQL  localhost  JS  &gt; util.checkForServerUpgrade()</span><br><span class=\"line\"> ……………………………………………………</span><br><span class=\"line\"> <span class=\"comment\"># 退出</span></span><br><span class=\"line\"> MySQL  localhost  JS &gt; \\q</span><br><span class=\"line\">Bye!</span><br></pre></td></tr></table></figure>\n<h4 id=\"检查输出信息说明\">检查输出信息说明</h4>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">WARNING: Using a password on the <span class=\"built_in\">command</span> line interface can be insecure.</span><br><span class=\"line\">The MySQL server at</span><br><span class=\"line\">localhost:3306, version</span><br><span class=\"line\">5.7.44-<span class=\"built_in\">log</span> - Please upgrade to 8.0 or opt-in to the paid RDS Extended Support</span><br><span class=\"line\">service before 5.7 reaches end of standard support on 29 February, 2024:</span><br><span class=\"line\">https://a.co/hQqiIn0, will now be checked <span class=\"keyword\">for</span> compatibility issues <span class=\"keyword\">for</span> upgrade</span><br><span class=\"line\">to MySQL 8.0.30...</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 旧时间类型的使用</span></span><br><span class=\"line\">1) Usage of old temporal <span class=\"built_in\">type</span></span><br><span class=\"line\">  No issues found</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 使用与新保留关键字冲突的数据库对象名称</span></span><br><span class=\"line\">2) Usage of db objects with names conflicting with new reserved keywords</span><br><span class=\"line\">  No issues found</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 使用utf8mb3字符集</span></span><br><span class=\"line\">3) Usage of utf8mb3 charset</span><br><span class=\"line\">  Warning: The following objects use the utf8mb3 character <span class=\"built_in\">set</span>. It is</span><br><span class=\"line\">    recommended to convert them to use utf8mb4 instead, <span class=\"keyword\">for</span> improved Unicode</span><br><span class=\"line\">    support.</span><br><span class=\"line\">  More information:</span><br><span class=\"line\">    https://dev.mysql.com/doc/refman/8.0/en/charset-unicode-utf8mb3.html</span><br><span class=\"line\"></span><br><span class=\"line\">  mydb - schema<span class=\"string\">&#x27;s default character set: utf8</span></span><br><span class=\"line\"><span class=\"string\">  mysql - schema&#x27;</span>s default character <span class=\"built_in\">set</span>: utf8</span><br><span class=\"line\">  mydb.tbl_info_i.a_product - column<span class=\"string\">&#x27;s default character set: utf8</span></span><br><span class=\"line\"><span class=\"string\">  mydb.tbl_info_i.a_country - column&#x27;</span>s default character <span class=\"built_in\">set</span>: utf8</span><br><span class=\"line\">  mydb.tbl_info_i.a_version - column<span class=\"string\">&#x27;s default character set: utf8</span></span><br><span class=\"line\"><span class=\"string\">  mydb.tbl_info_i.a_placement - column&#x27;</span>s default character <span class=\"built_in\">set</span>: utf8</span><br><span class=\"line\">………………………………………………………………………………………………………………………………</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># MySQL模式中的表名与8.0中的新表冲突</span></span><br><span class=\"line\">4) Table names <span class=\"keyword\">in</span> the mysql schema conflicting with new tables <span class=\"keyword\">in</span> 8.0</span><br><span class=\"line\">  No issues found</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 使用非本机分区引擎的分区表</span></span><br><span class=\"line\">5) Partitioned tables using engines with non native partitioning</span><br><span class=\"line\">  No issues found</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 外键约束名称超过64个字符</span></span><br><span class=\"line\">6) Foreign key constraint names longer than 64 characters</span><br><span class=\"line\">  No issues found</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 使用过时的MAXDB sql_mode标志</span></span><br><span class=\"line\">7) Usage of obsolete MAXDB sql_mode flag</span><br><span class=\"line\">  No issues found</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 使用过时的sql_mode标志</span></span><br><span class=\"line\">8) Usage of obsolete sql_mode flags</span><br><span class=\"line\">  No issues found</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ENUM/SET列定义包含超过255个字符的元素</span></span><br><span class=\"line\">9) ENUM/SET column definitions containing elements longer than 255 characters</span><br><span class=\"line\">  No issues found</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 在共享表空间中使用分区表</span></span><br><span class=\"line\">10) Usage of partitioned tables <span class=\"keyword\">in</span> shared tablespaces</span><br><span class=\"line\">  No issues found</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 表空间数据文件路径中的循环目录引用</span></span><br><span class=\"line\">11) Circular directory references <span class=\"keyword\">in</span> tablespace data file paths</span><br><span class=\"line\">  No issues found</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 使用已删除的函数</span></span><br><span class=\"line\">12) Usage of removed <span class=\"built_in\">functions</span></span><br><span class=\"line\">  No issues found</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 使用已删除的GROUP BY ASC/DESC语法</span></span><br><span class=\"line\">13) Usage of removed GROUP BY ASC/DESC syntax</span><br><span class=\"line\">  No issues found</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 已删除的用于错误日志记录到系统日志配置的系统变量</span></span><br><span class=\"line\">14) Removed system variables <span class=\"keyword\">for</span> error logging to the system <span class=\"built_in\">log</span> configuration</span><br><span class=\"line\">  To run this check requires full path to MySQL server configuration file to be specified at <span class=\"string\">&#x27;configPath&#x27;</span> key of options dictionary</span><br><span class=\"line\">  More information:</span><br><span class=\"line\">    https://dev.mysql.com/doc/relnotes/mysql/8.0/en/news-8-0-13.html#mysqld-8-0-13-logging</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 已删除的系统变量</span></span><br><span class=\"line\">15) Removed system variables</span><br><span class=\"line\">  To run this check requires full path to MySQL server configuration file to be specified at <span class=\"string\">&#x27;configPath&#x27;</span> key of options dictionary</span><br><span class=\"line\">  More information:</span><br><span class=\"line\">    https://dev.mysql.com/doc/refman/8.0/en/added-deprecated-removed.html#optvars-removed</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 具有新默认值的系统变量</span></span><br><span class=\"line\">16) System variables with new default values</span><br><span class=\"line\">  To run this check requires full path to MySQL server configuration file to be specified at <span class=\"string\">&#x27;configPath&#x27;</span> key of options dictionary</span><br><span class=\"line\">  More information:</span><br><span class=\"line\">    https://mysqlserverteam.com/new-defaults-in-mysql-8-0/</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 零日期、日期时间和时间戳值</span></span><br><span class=\"line\">17) Zero Date, Datetime, and Timestamp values</span><br><span class=\"line\">  Warning: By default zero <span class=\"built_in\">date</span>/datetime/timestamp values are no longer allowed</span><br><span class=\"line\">    <span class=\"keyword\">in</span> MySQL, as of 5.7.8 NO_ZERO_IN_DATE and NO_ZERO_DATE are included <span class=\"keyword\">in</span></span><br><span class=\"line\">    SQL_MODE by default. These modes should be used with strict mode as they will</span><br><span class=\"line\">    be merged with strict mode <span class=\"keyword\">in</span> a future release. If you <span class=\"keyword\">do</span> not include these</span><br><span class=\"line\">    modes <span class=\"keyword\">in</span> your SQL_MODE setting, you are able to insert</span><br><span class=\"line\">    <span class=\"built_in\">date</span>/datetime/timestamp values that contain zeros. It is strongly advised to</span><br><span class=\"line\">    replace zero values with valid ones, as they may not work correctly <span class=\"keyword\">in</span> the</span><br><span class=\"line\">    future.</span><br><span class=\"line\">  More information:</span><br><span class=\"line\">    https://lefred.be/content/mysql-8-0-and-wrong-dates/</span><br><span class=\"line\"></span><br><span class=\"line\">  global.sql_mode - does not contain either NO_ZERO_DATE or NO_ZERO_IN_DATE</span><br><span class=\"line\">    <span class=\"built_in\">which</span> allows insertion of zero dates</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 由文件删除或损坏导致的模式不一致</span></span><br><span class=\"line\">18) Schema inconsistencies resulting from file removal or corruption</span><br><span class=\"line\">  No issues found</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 被InnoDB识别但属于不同引擎的表</span></span><br><span class=\"line\">19) Tables recognized by InnoDB that belong to a different engine</span><br><span class=\"line\">  No issues found</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># &#x27;check table x for upgrade&#x27;命令报告的问题</span></span><br><span class=\"line\">20) Issues reported by <span class=\"string\">&#x27;check table x for upgrade&#x27;</span> <span class=\"built_in\">command</span></span><br><span class=\"line\">  No issues found</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 新的默认认证插件考虑</span></span><br><span class=\"line\">21) New default authentication plugin considerations</span><br><span class=\"line\">  Warning: The new default authentication plugin <span class=\"string\">&#x27;caching_sha2_password&#x27;</span> offers</span><br><span class=\"line\">    more secure password hashing than previously used <span class=\"string\">&#x27;mysql_native_password&#x27;</span></span><br><span class=\"line\">    (and consequent improved client connection authentication). However, it also</span><br><span class=\"line\">    has compatibility implications that may affect existing MySQL installations.</span><br><span class=\"line\">    If your MySQL installation must serve pre-8.0 clients and you encounter</span><br><span class=\"line\">    compatibility issues after upgrading, the simplest way to address those</span><br><span class=\"line\">    issues is to reconfigure the server to revert to the previous default</span><br><span class=\"line\">    authentication plugin (mysql_native_password). For example, use these lines</span><br><span class=\"line\">    <span class=\"keyword\">in</span> the server option file:</span><br><span class=\"line\"></span><br><span class=\"line\">    [mysqld]</span><br><span class=\"line\">    default_authentication_plugin=mysql_native_password</span><br><span class=\"line\"></span><br><span class=\"line\">    However, the setting should be viewed as temporary, not as a long term or</span><br><span class=\"line\">    permanent solution, because it causes new accounts created with the setting</span><br><span class=\"line\">    <span class=\"keyword\">in</span> effect to forego the improved authentication security.</span><br><span class=\"line\">    If you are using replication please take time to understand how the</span><br><span class=\"line\">    authentication plugin changes may impact you.</span><br><span class=\"line\">  More information:</span><br><span class=\"line\">    https://dev.mysql.com/doc/refman/8.0/en/upgrading-from-previous-series.html#upgrade-caching-sha2-password-compatibility-issues</span><br><span class=\"line\">    https://dev.mysql.com/doc/refman/8.0/en/upgrading-from-previous-series.html#upgrade-caching-sha2-password-replication</span><br><span class=\"line\"></span><br><span class=\"line\">Errors:   0</span><br><span class=\"line\">Warnings: 98</span><br><span class=\"line\">Notices:  0</span><br><span class=\"line\"></span><br><span class=\"line\">NOTE: No fatal errors were found that would prevent an upgrade, but some potential issues were detected. Please ensure that the reported issues are not significant before upgrading.</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>可以看到，其检查的数据库版本是5.7.44，其检查是否可以升级到8.0.30</p>\n</li>\n<li class=\"lvl-2\">\n<p>检测项共有21个，其中警告有98个，错误有0个，注意，如果有错误，则不能直接升级，需要解决错误问题，否则升级会失败。至于警告暂时可以不处理。</p>\n</li>\n<li class=\"lvl-2\">\n<p>警告集中体现在字符集上，5.7.44的字符集是utf8(实际就是utf8mb3)，而mysql8以后的默认字符集是utf8mb4，这个警告不影响升级，可以忽略。如果需要修改字符集到utf8mb4，需要注意原来的字段字符串长度是否符合要求，因为utf8mb4是4字节，而utf8mb3是3字节。另外如果使用了存储过程也要注意参数的长度是否符合要求。</p>\n</li>\n<li class=\"lvl-2\">\n<p>这里说一下<code>default_authentication_plugin</code>，mysql8.0.13开始，默认的认证插件是<code>caching_sha2_password</code>，而之前是<code>mysql_native_password</code>，这个警告虽然可以忽略，但是升级后建议尽快将认证插件修改为<code>caching_sha2_password</code>，因为<code>mysql_native_password</code>的认证方式存在安全漏洞，可以参考<a href=\"https://dev.mysql.com/doc/refman/8.0/en/upgrading-from-previous-series.html#upgrade-caching-sha2-password-compatibility-issues\">官方文档</a>。另外，从mysql8.4.0开始，不再支持<code>default_authentication_plugin</code>，若要使其支持<code>mysql_native_password</code>插件，8.4.0开始为我们增加了一个新的配置项<code>mysql-native-password</code>，在[mysqld]中配置<code>mysql-native-password=ON</code>即可开启支持，默认为<code>OFF</code>。</p>\n</li>\n<li class=\"lvl-2\">\n<p>另外还要注意<code>关键词</code>和<code>保留词</code>的问题，mysql8.0以后，又增加了很多个<code>关键词</code>和<code>保留词</code>，如果检查到则需要修改一下，不然升级会失败。即便表和字段里没有使用这些保留字，也要检查一下业务代码中是否有使用。关于<code>关键词</code>和<code>保留词</code>可以查看官网<a href=\"https://dev.mysql.com/doc/refman/8.0/en/keywords.html\">Keywords and Reserved Words</a>，相比于MySQL 5.7，增加了大约130个，同时也减少了6个。</p>\n<blockquote>\n<p>这里建议设置表名称和字段名称时，可以为其设置前缀，比如：表名称为：t_user、字段名称为：f_user_id</p>\n</blockquote>\n</li>\n<li class=\"lvl-2\">\n<p>还有一点需要注意，Mysql8修改了很多参数的默认值，具体可以查看<a href=\"https://dev.mysql.com/blog-archive/new-defaults-in-mysql-8-0/\">官方网站的说明</a>，如果你不希望使用默认值，则需要将其配置到配置文件中，这里强调一下，重点关注 <code>character_set_server</code> 和 <code>collation_server</code> 这两个参数。所有的参数配置参考<a href=\"https://dev.mysql.com/doc/refman/8.0/en/programs.html\">官方文档</a></p>\n</li>\n</ul>\n<div class=\"tips\">\n<p><em><strong>关于字符集还想多说两句</strong></em></p>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">mysql8的<code>character_set_server</code>默认是<code>utf8mb4</code>，<code>collation_server</code>默认是<code>utf8mb4_0900_ai_ci</code></li>\n<li class=\"lvl-2\">如果创建数据库或者表的时候没有指定字符集，则默认使用<code>character_set_server</code>和<code>collation_server</code>的默认值</li>\n<li class=\"lvl-2\">此时新创建的表就有可能与旧表字符集不一致，关联查询时就有可能导致错误或因为需要进行字符集转换导致查询性能下降。</li>\n<li class=\"lvl-2\">最好的方式是创建数据库或表时明确指定字符集，或者在<code>my.cnf</code>配置文件中配置<code>character_set_server</code>和<code>collation_server</code>的值。</li>\n</ul>\n</div>\n<h3 id=\"升级数据库的过程\">升级数据库的过程</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>因为我们要升级到mysql8.0.30，所以需要先下载并安装mysql8.0.30</p>\n</li>\n<li class=\"lvl-2\">\n<p>关闭mysql5.7的数据库</p>\n</li>\n<li class=\"lvl-2\">\n<p>备份数据目录(一定要做好备份，升级后不能降级的)</p>\n</li>\n<li class=\"lvl-2\">\n<p>根据检查提示修改<code>my.cnf</code>配置文件中的配置(主要是不兼容的配置，如果检查提示没有则不需要修改)</p>\n</li>\n<li class=\"lvl-2\">\n<p>非常重要的一步，就是修改<code>my.cnf</code>配置文件中的<code>basedir</code>，将其指向mysql8.0.30的安装目录</p>\n</li>\n<li class=\"lvl-2\">\n<p>直接使用mysql8.0.30的命令启动数据库，启动过程中就会完成数据库的升级，可以通过mysql的日志文件(log-error)查看升级情况</p>\n</li>\n<li class=\"lvl-2\">\n<p>升级完成后尽快使用新的密码认证插件修改密码，注意要修改所有用户的密码，包括root用户</p>\n</li>\n</ul>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql<span class=\"operator\">&gt;</span> <span class=\"keyword\">ALTER</span> <span class=\"keyword\">USER</span> <span class=\"string\">&#x27;root&#x27;</span>@<span class=\"string\">&#x27;localhost&#x27;</span> IDENTIFIED <span class=\"keyword\">WITH</span> caching_sha2_password <span class=\"keyword\">BY</span> <span class=\"string\">&#x27;123456&#x27;</span>;</span><br></pre></td></tr></table></figure>\n<div class=\"tips\">\n<p><em><strong>小贴士</strong></em></p>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">mysql8.4.0相比于之前的版本变化比较大，具体可以查看<a href=\"https://dev.mysql.com/doc/refman/8.4/en/mysql-nutshell.html\">官网文档</a></li>\n<li class=\"lvl-2\">mysql5.7不要直接升级到8.4.0及以后的版本，可以先升级到8.0.30，然后再升级到8.4.0</li>\n<li class=\"lvl-2\">升级到8.4.0前依旧要先使用<code>mysqlsh</code>检查是否可以升级，注意要下载对应的<code>mysqlsh</code>版本</li>\n<li class=\"lvl-2\">升级前要先检查是否所有用户的密码插件都是<code>caching_sha2_password</code>，如果没有则需要修改</li>\n<li class=\"lvl-2\">升级前要先检查<code>my.cnf</code>中是否配置了default_authentication_plugin，如果有则删除，如果必须要配置<code>mysql_native_password</code>认证插件，则需要配置<code>mysql-native-password=ON</code></li>\n<li class=\"lvl-2\">修改<code>my.cnf</code>中的<code>basedir</code>使其指向8.4.0的安装目录</li>\n<li class=\"lvl-2\">使用8.4.0的命令启动mysql，检查日志是否有错误。</li>\n</ul>\n</div>\n<h2 id=\"mysql5-7-44升级到8-0-30，再升级到8-4-0的完整过程\">mysql5.7.44升级到8.0.30，再升级到8.4.0的完整过程</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>准备好各个版本的mysql和mysqlsh</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 目录结构</span></span><br><span class=\"line\">mysql5 <span class=\"comment\"># 5.7.44安装目录</span></span><br><span class=\"line\">mysql8.0.30 <span class=\"comment\"># 8.0.30安装目录</span></span><br><span class=\"line\">mysql8.4.0 <span class=\"comment\"># 8.4.0安装目录</span></span><br><span class=\"line\">mysqlsh8.0.30 <span class=\"comment\"># 8.0.30的mysqlsh安装目录</span></span><br><span class=\"line\">mysqlsh8.4.0 <span class=\"comment\"># 8.4.0的mysqlsh安装目录</span></span><br><span class=\"line\">datas/mysql <span class=\"comment\"># 存放数据目录</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>mysql5/my.cnf</code>配置</p>\n</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[mysql]</span><br><span class=\"line\">default-character-set=utf8mb4</span><br><span class=\"line\">local_infile=ON</span><br><span class=\"line\"></span><br><span class=\"line\">[client]</span><br><span class=\"line\">default-character-set=utf8mb4</span><br><span class=\"line\">port       = 3306</span><br><span class=\"line\">socket     = /tmp/mysql.sock</span><br><span class=\"line\"></span><br><span class=\"line\">[mysqld]</span><br><span class=\"line\">skip-name-resolve</span><br><span class=\"line\">secure_file_priv=&quot;&quot;</span><br><span class=\"line\">local_infile=ON</span><br><span class=\"line\"></span><br><span class=\"line\">default_authentication_plugin=mysql_native_password</span><br><span class=\"line\"></span><br><span class=\"line\">port       = 3306</span><br><span class=\"line\">server-id  = 1001</span><br><span class=\"line\">user       = mysql</span><br><span class=\"line\">socket     = /tmp/mysql.sock</span><br><span class=\"line\">basedir    = /usr/local/soft/mysql5</span><br><span class=\"line\">datadir    = /usr/local/soft/datas/mysql</span><br><span class=\"line\"></span><br><span class=\"line\">log-bin    = mysql-bin</span><br><span class=\"line\">binlog-format = ROW</span><br><span class=\"line\"></span><br><span class=\"line\">expire-logs-days=10</span><br><span class=\"line\"></span><br><span class=\"line\">sync-binlog=0</span><br><span class=\"line\">innodb_data_home_dir      =./</span><br><span class=\"line\">innodb_log_group_home_dir =./</span><br><span class=\"line\">log-error =mysql.log</span><br><span class=\"line\">pid-file  =mysql.pid</span><br><span class=\"line\">character-set-server=utf8mb4</span><br><span class=\"line\">lower_case_table_names=1</span><br><span class=\"line\">autocommit =1</span><br><span class=\"line\">slow_query_log=1</span><br><span class=\"line\">slow_query_log_file=db_slow.log</span><br><span class=\"line\">long_query_time=5</span><br><span class=\"line\">log_output=FILE</span><br><span class=\"line\">log_queries_not_using_indexes=1</span><br><span class=\"line\">skip-external-locking</span><br><span class=\"line\">key_buffer_size = 256M</span><br><span class=\"line\">max_allowed_packet = 64M</span><br><span class=\"line\">table_open_cache = 1024</span><br><span class=\"line\">sort_buffer_size = 4M</span><br><span class=\"line\">net_buffer_length = 8K</span><br><span class=\"line\">read_buffer_size = 4M</span><br><span class=\"line\">read_rnd_buffer_size = 512K</span><br><span class=\"line\">myisam_sort_buffer_size = 64M</span><br><span class=\"line\">thread_cache_size = 64</span><br><span class=\"line\">tmp_table_size = 128M</span><br><span class=\"line\">explicit_defaults_for_timestamp = true</span><br><span class=\"line\">max_connections = 500</span><br><span class=\"line\">max_connect_errors = 100</span><br><span class=\"line\">open_files_limit = 65535</span><br><span class=\"line\">default_storage_engine = InnoDB</span><br><span class=\"line\">innodb_data_file_path = ibdata1:10M:autoextend</span><br></pre></td></tr></table></figure>\n<h3 id=\"5-7-44升级到8-0-30\">5.7.44升级到8.0.30</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>升级检查</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 升级检查</span></span><br><span class=\"line\">./mysqlsh8.0.30/bin/mysqlsh --uri root:123456@localhost  -e <span class=\"string\">&quot;util.checkForServerUpgrade()&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># 输出</span></span><br><span class=\"line\">WARNING: Using a password on the <span class=\"built_in\">command</span> line interface can be insecure.</span><br><span class=\"line\">The MySQL server at /tmp%2Fmysql.sock, version 5.7.44-<span class=\"built_in\">log</span> - MySQL Community</span><br><span class=\"line\">Server (GPL), will now be checked <span class=\"keyword\">for</span> compatibility issues <span class=\"keyword\">for</span> upgrade to MySQL</span><br><span class=\"line\">8.0.30...</span><br><span class=\"line\"></span><br><span class=\"line\">1) Usage of old temporal <span class=\"built_in\">type</span></span><br><span class=\"line\">  No issues found</span><br><span class=\"line\"></span><br><span class=\"line\">2) Usage of db objects with names conflicting with new reserved keywords</span><br><span class=\"line\">  No issues found</span><br><span class=\"line\"></span><br><span class=\"line\">3) Usage of utf8mb3 charset</span><br><span class=\"line\">  Warning: The following objects use the utf8mb3 character <span class=\"built_in\">set</span>. It is</span><br><span class=\"line\">    recommended to convert them to use utf8mb4 instead, <span class=\"keyword\">for</span> improved Unicode</span><br><span class=\"line\">    support.</span><br><span class=\"line\">  More information:</span><br><span class=\"line\">    https://dev.mysql.com/doc/refman/8.0/en/charset-unicode-utf8mb3.html</span><br><span class=\"line\"></span><br><span class=\"line\">  mydb - schema<span class=\"string\">&#x27;s default character set: utf8</span></span><br><span class=\"line\"><span class=\"string\">  mysql - schema&#x27;</span>s default character <span class=\"built_in\">set</span>: utf8</span><br><span class=\"line\">  mydb.tbl_info_i.a_product - column<span class=\"string\">&#x27;s default character set: utf8</span></span><br><span class=\"line\"><span class=\"string\">  mydb.tbl_info_i.a_country - column&#x27;</span>s default character <span class=\"built_in\">set</span>: utf8</span><br><span class=\"line\">  mydb.tbl_info_i.a_version - column<span class=\"string\">&#x27;s default character set: utf8</span></span><br><span class=\"line\"><span class=\"string\">  mydb.tbl_info_i.a_placement - column&#x27;</span>s default character <span class=\"built_in\">set</span>: utf8</span><br><span class=\"line\"> …………………………………………………………………………………………</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">4) Table names <span class=\"keyword\">in</span> the mysql schema conflicting with new tables <span class=\"keyword\">in</span> 8.0</span><br><span class=\"line\">  No issues found</span><br><span class=\"line\"></span><br><span class=\"line\">5) Partitioned tables using engines with non native partitioning</span><br><span class=\"line\">  No issues found</span><br><span class=\"line\"></span><br><span class=\"line\">6) Foreign key constraint names longer than 64 characters</span><br><span class=\"line\">  No issues found</span><br><span class=\"line\"></span><br><span class=\"line\">7) Usage of obsolete MAXDB sql_mode flag</span><br><span class=\"line\">  No issues found</span><br><span class=\"line\"></span><br><span class=\"line\">8) Usage of obsolete sql_mode flags</span><br><span class=\"line\">  Notice: The following DB objects have obsolete options persisted <span class=\"keyword\">for</span></span><br><span class=\"line\">    sql_mode, <span class=\"built_in\">which</span> will be cleared during upgrade to 8.0.</span><br><span class=\"line\">  More information:</span><br><span class=\"line\">    https://dev.mysql.com/doc/refman/8.0/en/mysql-nutshell.html#mysql-nutshell-removals</span><br><span class=\"line\"></span><br><span class=\"line\">  global system variable sql_mode - defined using obsolete NO_AUTO_CREATE_USER</span><br><span class=\"line\">    option</span><br><span class=\"line\"></span><br><span class=\"line\">9) ENUM/SET column definitions containing elements longer than 255 characters</span><br><span class=\"line\">  No issues found</span><br><span class=\"line\"></span><br><span class=\"line\">10) Usage of partitioned tables <span class=\"keyword\">in</span> shared tablespaces</span><br><span class=\"line\">  No issues found</span><br><span class=\"line\"></span><br><span class=\"line\">11) Circular directory references <span class=\"keyword\">in</span> tablespace data file paths</span><br><span class=\"line\">  No issues found</span><br><span class=\"line\"></span><br><span class=\"line\">12) Usage of removed <span class=\"built_in\">functions</span></span><br><span class=\"line\">  No issues found</span><br><span class=\"line\"></span><br><span class=\"line\">13) Usage of removed GROUP BY ASC/DESC syntax</span><br><span class=\"line\">  No issues found</span><br><span class=\"line\"></span><br><span class=\"line\">14) Removed system variables <span class=\"keyword\">for</span> error logging to the system <span class=\"built_in\">log</span> configuration</span><br><span class=\"line\">  To run this check requires full path to MySQL server configuration file to be specified at <span class=\"string\">&#x27;configPath&#x27;</span> key of options dictionary</span><br><span class=\"line\">  More information:</span><br><span class=\"line\">    https://dev.mysql.com/doc/relnotes/mysql/8.0/en/news-8-0-13.html#mysqld-8-0-13-logging</span><br><span class=\"line\"></span><br><span class=\"line\">15) Removed system variables</span><br><span class=\"line\">  To run this check requires full path to MySQL server configuration file to be specified at <span class=\"string\">&#x27;configPath&#x27;</span> key of options dictionary</span><br><span class=\"line\">  More information:</span><br><span class=\"line\">    https://dev.mysql.com/doc/refman/8.0/en/added-deprecated-removed.html#optvars-removed</span><br><span class=\"line\"></span><br><span class=\"line\">16) System variables with new default values</span><br><span class=\"line\">  To run this check requires full path to MySQL server configuration file to be specified at <span class=\"string\">&#x27;configPath&#x27;</span> key of options dictionary</span><br><span class=\"line\">  More information:</span><br><span class=\"line\">    https://mysqlserverteam.com/new-defaults-in-mysql-8-0/</span><br><span class=\"line\"></span><br><span class=\"line\">17) Zero Date, Datetime, and Timestamp values</span><br><span class=\"line\">  No issues found</span><br><span class=\"line\"></span><br><span class=\"line\">18) Schema inconsistencies resulting from file removal or corruption</span><br><span class=\"line\">  No issues found</span><br><span class=\"line\"></span><br><span class=\"line\">19) Tables recognized by InnoDB that belong to a different engine</span><br><span class=\"line\">  No issues found</span><br><span class=\"line\"></span><br><span class=\"line\">20) Issues reported by <span class=\"string\">&#x27;check table x for upgrade&#x27;</span> <span class=\"built_in\">command</span></span><br><span class=\"line\">  No issues found</span><br><span class=\"line\"></span><br><span class=\"line\">21) New default authentication plugin considerations</span><br><span class=\"line\">  Warning: The new default authentication plugin <span class=\"string\">&#x27;caching_sha2_password&#x27;</span> offers</span><br><span class=\"line\">    more secure password hashing than previously used <span class=\"string\">&#x27;mysql_native_password&#x27;</span></span><br><span class=\"line\">    (and consequent improved client connection authentication). However, it also</span><br><span class=\"line\">    has compatibility implications that may affect existing MySQL installations.</span><br><span class=\"line\">    If your MySQL installation must serve pre-8.0 clients and you encounter</span><br><span class=\"line\">    compatibility issues after upgrading, the simplest way to address those</span><br><span class=\"line\">    issues is to reconfigure the server to revert to the previous default</span><br><span class=\"line\">    authentication plugin (mysql_native_password). For example, use these lines</span><br><span class=\"line\">    <span class=\"keyword\">in</span> the server option file:</span><br><span class=\"line\"></span><br><span class=\"line\">    [mysqld]</span><br><span class=\"line\">    default_authentication_plugin=mysql_native_password</span><br><span class=\"line\"></span><br><span class=\"line\">    However, the setting should be viewed as temporary, not as a long term or</span><br><span class=\"line\">    permanent solution, because it causes new accounts created with the setting</span><br><span class=\"line\">    <span class=\"keyword\">in</span> effect to forego the improved authentication security.</span><br><span class=\"line\">    If you are using replication please take time to understand how the</span><br><span class=\"line\">    authentication plugin changes may impact you.</span><br><span class=\"line\">  More information:</span><br><span class=\"line\">    https://dev.mysql.com/doc/refman/8.0/en/upgrading-from-previous-series.html#upgrade-caching-sha2-password-compatibility-issues</span><br><span class=\"line\">    https://dev.mysql.com/doc/refman/8.0/en/upgrading-from-previous-series.html#upgrade-caching-sha2-password-replication</span><br><span class=\"line\"></span><br><span class=\"line\">Errors:   0</span><br><span class=\"line\">Warnings: 98</span><br><span class=\"line\">Notices:  1</span><br><span class=\"line\"></span><br><span class=\"line\">NOTE: No fatal errors were found that would prevent an upgrade, but some potential issues were detected. Please ensure that the reported issues are not significant before upgrading.</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>看到没有error，开始升级</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 关闭数据库</span></span><br><span class=\"line\">./mysql5/bin/mysqladmin --defaults-file=./mysql5/my.cnf -uroot -p123456 shutdown</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 复制mysql配置文件</span></span><br><span class=\"line\"><span class=\"built_in\">cp</span> ./mysql5/my.cnf ./mysql8.0.30/my.cnf</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 修改新的配置文件中的basedir，使其指向8.0.30的安装路径</span></span><br><span class=\"line\">basedir    = /usr/local/soft/mysql8.0.30</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 使用8.0.30启动</span></span><br><span class=\"line\">./mysql8.0.30/bin/mysqld_safe --defaults-file=./mysql8.0.30/my.cnf &amp;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>查看启动日志，没有错误说明升级成功</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">2024-05-09T06:48:50.524705Z 0 [Warning] [MY-011068] [Server] The syntax <span class=\"string\">&#x27;expire-logs-days&#x27;</span> is deprecated and will be removed <span class=\"keyword\">in</span> a future release. Please use binlog_expire_logs_seconds instead.</span><br><span class=\"line\">2024-05-09T06:48:50.524819Z 0 [Warning] [MY-010097] [Server] Insecure configuration <span class=\"keyword\">for</span> --secure-file-priv: Current value does not restrict location of generated files. Consider setting it to a valid, non-empty path.</span><br><span class=\"line\">2024-05-09T06:48:50.524917Z 0 [Warning] [MY-010918] [Server] <span class=\"string\">&#x27;default_authentication_plugin&#x27;</span> is deprecated and will be removed <span class=\"keyword\">in</span> a future release. Please use authentication_policy instead.</span><br><span class=\"line\">2024-05-09T06:48:50.524983Z 0 [System] [MY-010116] [Server] /usr/local/soft/mysql8.0.30/bin/mysqld (mysqld 8.0.30) starting as process 26696</span><br><span class=\"line\">2024-05-09T06:48:50.563366Z 1 [System] [MY-011012] [Server] Starting upgrade of data directory.</span><br><span class=\"line\">2024-05-09T06:48:50.563414Z 1 [System] [MY-013576] [InnoDB] InnoDB initialization has started.</span><br><span class=\"line\">2024-05-09T06:48:51.260298Z 1 [System] [MY-013577] [InnoDB] InnoDB initialization has ended.</span><br><span class=\"line\">2024-05-09T06:48:53.614398Z 2 [System] [MY-011003] [Server] Finished populating Data Dictionary tables with data.</span><br><span class=\"line\">2024-05-09T06:48:55.055320Z 5 [System] [MY-013381] [Server] Server upgrade from <span class=\"string\">&#x27;50700&#x27;</span> to <span class=\"string\">&#x27;80030&#x27;</span> started.</span><br><span class=\"line\">2024-05-09T06:49:02.063990Z 5 [System] [MY-013381] [Server] Server upgrade from <span class=\"string\">&#x27;50700&#x27;</span> to <span class=\"string\">&#x27;80030&#x27;</span> completed.</span><br><span class=\"line\">2024-05-09T06:49:02.237992Z 0 [Warning] [MY-010068] [Server] CA certificate ca.pem is self signed.</span><br><span class=\"line\">2024-05-09T06:49:02.238048Z 0 [System] [MY-013602] [Server] Channel mysql_main configured to support TLS. Encrypted connections are now supported <span class=\"keyword\">for</span> this channel.</span><br><span class=\"line\">2024-05-09T06:49:02.267583Z 0 [System] [MY-011323] [Server] X Plugin ready <span class=\"keyword\">for</span> connections. Bind-address: <span class=\"string\">&#x27;::&#x27;</span> port: 33060, socket: /tmp/mysqlx.sock</span><br><span class=\"line\">2024-05-09T06:49:02.267648Z 0 [System] [MY-010931] [Server] /usr/local/soft/mysql8.0.30/bin/mysqld: ready <span class=\"keyword\">for</span> connections. Version: <span class=\"string\">&#x27;8.0.30&#x27;</span>  socket: <span class=\"string\">&#x27;/tmp/mysql.sock&#x27;</span>  port: 3306  MySQL Community Server - GPL.</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>根据日志提示我们应该修改两个配置参数，未来将不可用了，不过这里暂且先不去管它，等检查通不过了再进行处理就可以。</p>\n</blockquote>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.The syntax &#x27;expire-logs-days&#x27; is deprecated and will be removed in a future release. Please use binlog_expire_logs_seconds instead.</span><br><span class=\"line\">2.&#x27;default_authentication_plugin&#x27; is deprecated and will be removed in a future release. Please use authentication_policy instead.</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>修改密码插件，这个步骤很重要</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 登录</span></span><br><span class=\"line\">./mysql8.0.30/bin/mysql -uroot -p123456</span><br><span class=\"line\"><span class=\"comment\"># 升级完成后使用新的密码认证插件修改密码，8.4不再推荐mysql_native_password认证插，所以升级到8.4以前一定要先修改密码插件，如果忘记了也没关系，文末有重置密码的方法</span></span><br><span class=\"line\">mysql&gt; ALTER USER <span class=\"string\">&#x27;root&#x27;</span>@<span class=\"string\">&#x27;localhost&#x27;</span> IDENTIFIED WITH caching_sha2_password BY <span class=\"string\">&#x27;123456&#x27;</span>;</span><br></pre></td></tr></table></figure>\n<h3 id=\"8-0-30升级到8-4-0\">8.0.30升级到8.4.0</h3>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>同样先用8.4.0的mysqlsh检查一下</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 升级检查</span></span><br><span class=\"line\">./mysqlsh8.4.0/bin/mysqlsh --uri root:123456@localhost</span><br><span class=\"line\"><span class=\"comment\"># 输出</span></span><br><span class=\"line\">MySQL Shell 8.4.0</span><br><span class=\"line\"></span><br><span class=\"line\">Copyright (c) 2016, 2024, Oracle and/or its affiliates.</span><br><span class=\"line\">Oracle is a registered trademark of Oracle Corporation and/or its affiliates.</span><br><span class=\"line\">Other names may be trademarks of their respective owners.</span><br><span class=\"line\"></span><br><span class=\"line\">Type <span class=\"string\">&#x27;\\help&#x27;</span> or <span class=\"string\">&#x27;\\?&#x27;</span> <span class=\"keyword\">for</span> <span class=\"built_in\">help</span>; <span class=\"string\">&#x27;\\quit&#x27;</span> to <span class=\"built_in\">exit</span>.</span><br><span class=\"line\">WARNING: Using a password on the <span class=\"built_in\">command</span> line interface can be insecure.</span><br><span class=\"line\">Creating a Classic session to <span class=\"string\">&#x27;root@/tmp%2Fmysql.sock&#x27;</span></span><br><span class=\"line\">Fetching global names <span class=\"keyword\">for</span> auto-completion... Press ^C to stop.</span><br><span class=\"line\">Your MySQL connection <span class=\"built_in\">id</span> is 15</span><br><span class=\"line\">Server version: 8.0.30 MySQL Community Server - GPL</span><br><span class=\"line\">No default schema selected; <span class=\"built_in\">type</span> \\use &lt;schema&gt; to <span class=\"built_in\">set</span> one.</span><br><span class=\"line\"> MySQL  localhost  SQL &gt; \\js</span><br><span class=\"line\">Switching to JavaScript mode...</span><br><span class=\"line\"> MySQL  localhost  JS &gt; util.checkForServerUpgrade()</span><br><span class=\"line\">The MySQL server at /tmp%2Fmysql.sock, version 8.0.30 - MySQL Community Server</span><br><span class=\"line\">- GPL, will now be checked <span class=\"keyword\">for</span> compatibility issues <span class=\"keyword\">for</span> upgrade to MySQL 8.4.0.</span><br><span class=\"line\">To check <span class=\"keyword\">for</span> a different target server version, use the targetVersion option.</span><br><span class=\"line\"></span><br><span class=\"line\">WARNING: Upgrading MySQL Server from version 8.0.30 to 8.4.0 is not supported.</span><br><span class=\"line\">Please consider running the check using the following option: targetVersion=8.0</span><br><span class=\"line\"></span><br><span class=\"line\">1) Usage of db objects with names conflicting with new reserved keywords</span><br><span class=\"line\">(reservedKeywords)</span><br><span class=\"line\">  No issues found</span><br><span class=\"line\"></span><br><span class=\"line\">2) Removed system variables (removedSysVars)</span><br><span class=\"line\">  Error: Following system variables that were detected as being used will be</span><br><span class=\"line\">    removed. Please update your system to not rely on them before the upgrade.</span><br><span class=\"line\">  More information:</span><br><span class=\"line\">    https://dev.mysql.com/doc/refman/8.0/en/added-deprecated-removed.html#optvars-removed</span><br><span class=\"line\"></span><br><span class=\"line\">  expire_logs_days - Error: The system variable <span class=\"string\">&#x27;expire_logs_days&#x27;</span> is <span class=\"built_in\">set</span> to 10</span><br><span class=\"line\">    (EXPLICIT) and will be removed.</span><br><span class=\"line\"></span><br><span class=\"line\">3) System variables with new default values (sysVarsNewDefaults)</span><br><span class=\"line\">  Warning: Following system variables that are not defined <span class=\"keyword\">in</span> your</span><br><span class=\"line\">    configuration file will have new default values. Please review <span class=\"keyword\">if</span> you rely on</span><br><span class=\"line\">    their current values and <span class=\"keyword\">if</span> so define them before performing upgrade.</span><br><span class=\"line\">  More information:</span><br><span class=\"line\">    https://dev.mysql.com/blog-archive/new-defaults-in-mysql-8-0/</span><br><span class=\"line\"></span><br><span class=\"line\">  binlog_transaction_dependency_tracking - default value will change from</span><br><span class=\"line\">    COMMIT_ORDER to WRITESET.</span><br><span class=\"line\">  group_replication_consistency - default value will change from EVENTUAL to</span><br><span class=\"line\">    BEFORE_ON_PRIMARY_FAILOVER.</span><br><span class=\"line\">  group_replication_exit_state_action - default value will change from</span><br><span class=\"line\">    READ_ONLY to OFFLINE_MODE.</span><br><span class=\"line\">  innodb_adaptive_hash_index - default value will change from ON to OFF.</span><br><span class=\"line\">  innodb_buffer_pool_in_core_file - default value will change from ON to OFF.</span><br><span class=\"line\">  innodb_buffer_pool_instances - default value will change from 8 (or 1 <span class=\"keyword\">if</span></span><br><span class=\"line\">    innodb_buffer_pool_size &lt; 1GB) to MAX(1, <span class=\"comment\">#vcpu/4).</span></span><br><span class=\"line\">  innodb_change_buffering - default value will change from all to none.</span><br><span class=\"line\">  innodb_doublewrite_files - default value will change from</span><br><span class=\"line\">    innodb_buffer_pool_instances * 2 to 2.</span><br><span class=\"line\">  innodb_doublewrite_pages - default value will change from</span><br><span class=\"line\">    innodb_write_io_threads to 128.</span><br><span class=\"line\">  innodb_flush_method - default value will change from fsynch (unix) or</span><br><span class=\"line\">    unbuffered (windows) to O_DIRECT.</span><br><span class=\"line\">  innodb_io_capacity - default value will change from 200 to 10000.</span><br><span class=\"line\">  innodb_io_capacity_max - default value will change from 200 to 2 x</span><br><span class=\"line\">    innodb_io_capacity.</span><br><span class=\"line\">  innodb_log_buffer_size - default value will change from 16777216 (16MB) to</span><br><span class=\"line\">    67108864 (64MB).</span><br><span class=\"line\">  innodb_log_writer_threads - default value will change from ON to OFF ( <span class=\"keyword\">if</span></span><br><span class=\"line\">    <span class=\"comment\">#vcpu &lt;= 32 ).</span></span><br><span class=\"line\">  innodb_numa_interleave - default value will change from OFF to ON.</span><br><span class=\"line\">  innodb_page_cleaners - default value will change from 4 to</span><br><span class=\"line\">    innodb_buffer_pool_instances.</span><br><span class=\"line\">  innodb_parallel_read_threads - default value will change from 4 to</span><br><span class=\"line\">    MAX(#vcpu/8, 4).</span><br><span class=\"line\">  innodb_purge_threads - default value will change from 4 to 1 ( <span class=\"keyword\">if</span> <span class=\"comment\">#vcpu &lt;= 16</span></span><br><span class=\"line\">    ).</span><br><span class=\"line\">  innodb_read_io_threads - default value will change from 4 to MAX(#vcpu/2, 4).</span><br><span class=\"line\">  innodb_redo_log_capacity - default value will change from 104857600 (100MB)</span><br><span class=\"line\">    to MIN ( <span class=\"comment\">#vcpu/2, 16 )GB.</span></span><br><span class=\"line\"></span><br><span class=\"line\">4) Issues reported by <span class=\"string\">&#x27;check table x for upgrade&#x27;</span> <span class=\"built_in\">command</span> (checkTableCommand)</span><br><span class=\"line\">  No issues found</span><br><span class=\"line\"></span><br><span class=\"line\">5) Check <span class=\"keyword\">for</span> deprecated usage of single dollar signs <span class=\"keyword\">in</span> object names</span><br><span class=\"line\">(dollarSignName)</span><br><span class=\"line\">  No issues found</span><br><span class=\"line\"></span><br><span class=\"line\">6) Check <span class=\"keyword\">for</span> deprecated or invalid user authentication methods.</span><br><span class=\"line\">(authMethodUsage)</span><br><span class=\"line\">  Warning: The following <span class=\"built_in\">users</span> are using the <span class=\"string\">&#x27;mysql_native_password&#x27;</span></span><br><span class=\"line\">  authentication method <span class=\"built_in\">which</span> is deprecated as of MySQL 8.0.0 and will be</span><br><span class=\"line\">  removed <span class=\"keyword\">in</span> a future release.</span><br><span class=\"line\">  Consider switching the <span class=\"built_in\">users</span> to a different authentication method (i.e.</span><br><span class=\"line\">  caching_sha2_password).</span><br><span class=\"line\"></span><br><span class=\"line\">  - mydb@%</span><br><span class=\"line\">  - mysql.session@localhost</span><br><span class=\"line\">  - mysql.sys@localhost</span><br><span class=\"line\">  - root@localhost</span><br><span class=\"line\"></span><br><span class=\"line\">  More information:</span><br><span class=\"line\">    https://dev.mysql.com/doc/refman/8.0/en/caching-sha2-pluggable-authentication.html</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">7) Check <span class=\"keyword\">for</span> deprecated or removed plugin usage. (pluginUsage)</span><br><span class=\"line\">  No issues found</span><br><span class=\"line\"></span><br><span class=\"line\">8) Check <span class=\"keyword\">for</span> deprecated or invalid default authentication methods <span class=\"keyword\">in</span> system</span><br><span class=\"line\">variables. (deprecatedDefaultAuth)</span><br><span class=\"line\">  The following variables have problems with their <span class=\"built_in\">set</span> authentication method:</span><br><span class=\"line\"></span><br><span class=\"line\">  Error: default_authentication_plugin - mysql_native_password authentication</span><br><span class=\"line\">    method was removed and it must be corrected before upgrading to 8.4.0 release.</span><br><span class=\"line\"></span><br><span class=\"line\">9) Check <span class=\"keyword\">for</span> deprecated or invalid authentication methods <span class=\"keyword\">in</span> use by MySQL</span><br><span class=\"line\">Router internal accounts. (deprecatedRouterAuthMethod)</span><br><span class=\"line\">  No issues found</span><br><span class=\"line\"></span><br><span class=\"line\">10) Checks <span class=\"keyword\">for</span> errors <span class=\"keyword\">in</span> column definitions (columnDefinition)</span><br><span class=\"line\">  No issues found</span><br><span class=\"line\"></span><br><span class=\"line\">11) Check <span class=\"keyword\">for</span> allowed values <span class=\"keyword\">in</span> System Variables. (sysvarAllowedValues)</span><br><span class=\"line\">  No issues found</span><br><span class=\"line\"></span><br><span class=\"line\">12) Checks <span class=\"keyword\">for</span> user privileges that will be removed (invalidPrivileges)</span><br><span class=\"line\">  Verifies <span class=\"keyword\">for</span> <span class=\"built_in\">users</span> containing grants to be removed, since privileges are</span><br><span class=\"line\">    removed as part of the upgrade, raises a NOTICE to inform the user about</span><br><span class=\"line\">    <span class=\"built_in\">users</span> that will be losing invalid privileges</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"string\">&#x27;mysql.session&#x27;</span>@<span class=\"string\">&#x27;localhost&#x27;</span> - The user <span class=\"string\">&#x27;mysql.session&#x27;</span>@<span class=\"string\">&#x27;localhost&#x27;</span> has the</span><br><span class=\"line\">    following privileges that will be removed as part of the upgrade process:</span><br><span class=\"line\">    SET_USER_ID</span><br><span class=\"line\">  <span class=\"string\">&#x27;root&#x27;</span>@<span class=\"string\">&#x27;localhost&#x27;</span> - The user <span class=\"string\">&#x27;root&#x27;</span>@<span class=\"string\">&#x27;localhost&#x27;</span> has the following privileges</span><br><span class=\"line\">    that will be removed as part of the upgrade process: SET_USER_ID</span><br><span class=\"line\"></span><br><span class=\"line\">13) Checks <span class=\"keyword\">for</span> partitions by key using columns with prefix key indexes</span><br><span class=\"line\">(partitionsWithPrefixKeys)</span><br><span class=\"line\">  No issues found</span><br><span class=\"line\"></span><br><span class=\"line\">Errors:   2</span><br><span class=\"line\">Warnings: 24</span><br><span class=\"line\">Notices:  2</span><br><span class=\"line\"></span><br><span class=\"line\">ERROR: 2 errors were found. Please correct these issues before upgrading to avoid compatibility issues.</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>看到了两处错误，就是我们上面说的那两个参数需要修改，修改<code>./mysql8.0.30/my.cnf</code></p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># binlog日志过期时间，单位秒，过期的binlog日志会被删除，保证磁盘空间，这里设置为10天，mysql8以前的版本这个参数是expire-logs-days，单位是天</span></span><br><span class=\"line\">binlog_expire_logs_seconds =864000</span><br><span class=\"line\"><span class=\"comment\">#expire-logs-days=10</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#default_authentication_plugin=mysql_native_password</span></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>修改后要重启数据库</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 关闭数据库</span></span><br><span class=\"line\"> ./mysql8.0.30/bin/mysqladmin --defaults-file=./mysql8.0.30/my.cnf -uroot -p123456 shutdown</span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"comment\"># 使用8.0.30启动</span></span><br><span class=\"line\"> ./mysql8.0.30/bin/mysqld_safe --defaults-file=./mysql8.0.30/my.cnf &amp;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>再次进程升级检查</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 升级检查</span></span><br><span class=\"line\">./mysqlsh8.4.0/bin/mysqlsh --uri root:123456@localhost</span><br><span class=\"line\"><span class=\"comment\"># 输出</span></span><br><span class=\"line\">MySQL Shell 8.4.0</span><br><span class=\"line\"></span><br><span class=\"line\">Copyright (c) 2016, 2024, Oracle and/or its affiliates.</span><br><span class=\"line\">Oracle is a registered trademark of Oracle Corporation and/or its affiliates.</span><br><span class=\"line\">Other names may be trademarks of their respective owners.</span><br><span class=\"line\"></span><br><span class=\"line\">Type <span class=\"string\">&#x27;\\help&#x27;</span> or <span class=\"string\">&#x27;\\?&#x27;</span> <span class=\"keyword\">for</span> <span class=\"built_in\">help</span>; <span class=\"string\">&#x27;\\quit&#x27;</span> to <span class=\"built_in\">exit</span>.</span><br><span class=\"line\">WARNING: Using a password on the <span class=\"built_in\">command</span> line interface can be insecure.</span><br><span class=\"line\">Creating a Classic session to <span class=\"string\">&#x27;root@/tmp%2Fmysql.sock&#x27;</span></span><br><span class=\"line\">Fetching global names <span class=\"keyword\">for</span> auto-completion... Press ^C to stop.</span><br><span class=\"line\">Your MySQL connection <span class=\"built_in\">id</span> is 8</span><br><span class=\"line\">Server version: 8.0.30 MySQL Community Server - GPL</span><br><span class=\"line\">No default schema selected; <span class=\"built_in\">type</span> \\use &lt;schema&gt; to <span class=\"built_in\">set</span> one.</span><br><span class=\"line\"> MySQL  localhost  SQL &gt; \\js</span><br><span class=\"line\">Switching to JavaScript mode...</span><br><span class=\"line\"> MySQL  localhost  JS &gt; util.checkForServerUpgrade()</span><br><span class=\"line\">The MySQL server at /tmp%2Fmysql.sock, version 8.0.30 - MySQL Community Server</span><br><span class=\"line\">- GPL, will now be checked <span class=\"keyword\">for</span> compatibility issues <span class=\"keyword\">for</span> upgrade to MySQL 8.4.0.</span><br><span class=\"line\">To check <span class=\"keyword\">for</span> a different target server version, use the targetVersion option.</span><br><span class=\"line\"></span><br><span class=\"line\">WARNING: Upgrading MySQL Server from version 8.0.30 to 8.4.0 is not supported.</span><br><span class=\"line\">Please consider running the check using the following option: targetVersion=8.0</span><br><span class=\"line\"></span><br><span class=\"line\">1) Usage of db objects with names conflicting with new reserved keywords</span><br><span class=\"line\">(reservedKeywords)</span><br><span class=\"line\">  No issues found</span><br><span class=\"line\"></span><br><span class=\"line\">2) Removed system variables (removedSysVars)</span><br><span class=\"line\">  No issues found</span><br><span class=\"line\"></span><br><span class=\"line\">3) System variables with new default values (sysVarsNewDefaults)</span><br><span class=\"line\">  Warning: Following system variables that are not defined <span class=\"keyword\">in</span> your</span><br><span class=\"line\">    configuration file will have new default values. Please review <span class=\"keyword\">if</span> you rely on</span><br><span class=\"line\">    their current values and <span class=\"keyword\">if</span> so define them before performing upgrade.</span><br><span class=\"line\">  More information:</span><br><span class=\"line\">    https://dev.mysql.com/blog-archive/new-defaults-in-mysql-8-0/</span><br><span class=\"line\"></span><br><span class=\"line\">  binlog_transaction_dependency_tracking - default value will change from</span><br><span class=\"line\">    COMMIT_ORDER to WRITESET.</span><br><span class=\"line\">  group_replication_consistency - default value will change from EVENTUAL to</span><br><span class=\"line\">    BEFORE_ON_PRIMARY_FAILOVER.</span><br><span class=\"line\">  group_replication_exit_state_action - default value will change from</span><br><span class=\"line\">    READ_ONLY to OFFLINE_MODE.</span><br><span class=\"line\">  innodb_adaptive_hash_index - default value will change from ON to OFF.</span><br><span class=\"line\">  innodb_buffer_pool_in_core_file - default value will change from ON to OFF.</span><br><span class=\"line\">  innodb_buffer_pool_instances - default value will change from 8 (or 1 <span class=\"keyword\">if</span></span><br><span class=\"line\">    innodb_buffer_pool_size &lt; 1GB) to MAX(1, <span class=\"comment\">#vcpu/4).</span></span><br><span class=\"line\">  innodb_change_buffering - default value will change from all to none.</span><br><span class=\"line\">  innodb_doublewrite_files - default value will change from</span><br><span class=\"line\">    innodb_buffer_pool_instances * 2 to 2.</span><br><span class=\"line\">  innodb_doublewrite_pages - default value will change from</span><br><span class=\"line\">    innodb_write_io_threads to 128.</span><br><span class=\"line\">  innodb_flush_method - default value will change from fsynch (unix) or</span><br><span class=\"line\">    unbuffered (windows) to O_DIRECT.</span><br><span class=\"line\">  innodb_io_capacity - default value will change from 200 to 10000.</span><br><span class=\"line\">  innodb_io_capacity_max - default value will change from 200 to 2 x</span><br><span class=\"line\">    innodb_io_capacity.</span><br><span class=\"line\">  innodb_log_buffer_size - default value will change from 16777216 (16MB) to</span><br><span class=\"line\">    67108864 (64MB).</span><br><span class=\"line\">  innodb_log_writer_threads - default value will change from ON to OFF ( <span class=\"keyword\">if</span></span><br><span class=\"line\">    <span class=\"comment\">#vcpu &lt;= 32 ).</span></span><br><span class=\"line\">  innodb_numa_interleave - default value will change from OFF to ON.</span><br><span class=\"line\">  innodb_page_cleaners - default value will change from 4 to</span><br><span class=\"line\">    innodb_buffer_pool_instances.</span><br><span class=\"line\">  innodb_parallel_read_threads - default value will change from 4 to</span><br><span class=\"line\">    MAX(#vcpu/8, 4).</span><br><span class=\"line\">  innodb_purge_threads - default value will change from 4 to 1 ( <span class=\"keyword\">if</span> <span class=\"comment\">#vcpu &lt;= 16</span></span><br><span class=\"line\">    ).</span><br><span class=\"line\">  innodb_read_io_threads - default value will change from 4 to MAX(#vcpu/2, 4).</span><br><span class=\"line\">  innodb_redo_log_capacity - default value will change from 104857600 (100MB)</span><br><span class=\"line\">    to MIN ( <span class=\"comment\">#vcpu/2, 16 )GB.</span></span><br><span class=\"line\"></span><br><span class=\"line\">4) Issues reported by <span class=\"string\">&#x27;check table x for upgrade&#x27;</span> <span class=\"built_in\">command</span> (checkTableCommand)</span><br><span class=\"line\">  No issues found</span><br><span class=\"line\"></span><br><span class=\"line\">5) Check <span class=\"keyword\">for</span> deprecated usage of single dollar signs <span class=\"keyword\">in</span> object names</span><br><span class=\"line\">(dollarSignName)</span><br><span class=\"line\">  No issues found</span><br><span class=\"line\"></span><br><span class=\"line\">6) Check <span class=\"keyword\">for</span> deprecated or invalid user authentication methods.</span><br><span class=\"line\">(authMethodUsage)</span><br><span class=\"line\">  Warning: The following <span class=\"built_in\">users</span> are using the <span class=\"string\">&#x27;mysql_native_password&#x27;</span></span><br><span class=\"line\">  authentication method <span class=\"built_in\">which</span> is deprecated as of MySQL 8.0.0 and will be</span><br><span class=\"line\">  removed <span class=\"keyword\">in</span> a future release.</span><br><span class=\"line\">  Consider switching the <span class=\"built_in\">users</span> to a different authentication method (i.e.</span><br><span class=\"line\">  caching_sha2_password).</span><br><span class=\"line\"></span><br><span class=\"line\">  - mydb@%</span><br><span class=\"line\">  - mysql.session@localhost</span><br><span class=\"line\">  - mysql.sys@localhost</span><br><span class=\"line\">  - root@localhost</span><br><span class=\"line\"></span><br><span class=\"line\">  More information:</span><br><span class=\"line\">    https://dev.mysql.com/doc/refman/8.0/en/caching-sha2-pluggable-authentication.html</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">7) Check <span class=\"keyword\">for</span> deprecated or removed plugin usage. (pluginUsage)</span><br><span class=\"line\">  No issues found</span><br><span class=\"line\"></span><br><span class=\"line\">8) Check <span class=\"keyword\">for</span> deprecated or invalid default authentication methods <span class=\"keyword\">in</span> system</span><br><span class=\"line\">variables. (deprecatedDefaultAuth)</span><br><span class=\"line\">  No issues found</span><br><span class=\"line\"></span><br><span class=\"line\">9) Check <span class=\"keyword\">for</span> deprecated or invalid authentication methods <span class=\"keyword\">in</span> use by MySQL</span><br><span class=\"line\">Router internal accounts. (deprecatedRouterAuthMethod)</span><br><span class=\"line\">  No issues found</span><br><span class=\"line\"></span><br><span class=\"line\">10) Checks <span class=\"keyword\">for</span> errors <span class=\"keyword\">in</span> column definitions (columnDefinition)</span><br><span class=\"line\">  No issues found</span><br><span class=\"line\"></span><br><span class=\"line\">11) Check <span class=\"keyword\">for</span> allowed values <span class=\"keyword\">in</span> System Variables. (sysvarAllowedValues)</span><br><span class=\"line\">  No issues found</span><br><span class=\"line\"></span><br><span class=\"line\">12) Checks <span class=\"keyword\">for</span> user privileges that will be removed (invalidPrivileges)</span><br><span class=\"line\">  Verifies <span class=\"keyword\">for</span> <span class=\"built_in\">users</span> containing grants to be removed, since privileges are</span><br><span class=\"line\">    removed as part of the upgrade, raises a NOTICE to inform the user about</span><br><span class=\"line\">    <span class=\"built_in\">users</span> that will be losing invalid privileges</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"string\">&#x27;mysql.session&#x27;</span>@<span class=\"string\">&#x27;localhost&#x27;</span> - The user <span class=\"string\">&#x27;mysql.session&#x27;</span>@<span class=\"string\">&#x27;localhost&#x27;</span> has the</span><br><span class=\"line\">    following privileges that will be removed as part of the upgrade process:</span><br><span class=\"line\">    SET_USER_ID</span><br><span class=\"line\">  <span class=\"string\">&#x27;root&#x27;</span>@<span class=\"string\">&#x27;localhost&#x27;</span> - The user <span class=\"string\">&#x27;root&#x27;</span>@<span class=\"string\">&#x27;localhost&#x27;</span> has the following privileges</span><br><span class=\"line\">    that will be removed as part of the upgrade process: SET_USER_ID</span><br><span class=\"line\"></span><br><span class=\"line\">13) Checks <span class=\"keyword\">for</span> partitions by key using columns with prefix key indexes</span><br><span class=\"line\">(partitionsWithPrefixKeys)</span><br><span class=\"line\">  No issues found</span><br><span class=\"line\"></span><br><span class=\"line\">Errors:   0</span><br><span class=\"line\">Warnings: 24</span><br><span class=\"line\">Notices:  2</span><br><span class=\"line\"></span><br><span class=\"line\">NOTE: No fatal errors were found that would prevent an upgrade, but some potential issues were detected. Please ensure that the reported issues are not significant before upgrading.</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>此时看到通过检查，关闭数据库直接升级吧</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 关闭数据库</span></span><br><span class=\"line\">./mysql8.0.30/bin/mysqladmin --defaults-file=./mysql8.0.30/my.cnf -uroot -p123456 shutdown</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 复制mysql配置文件</span></span><br><span class=\"line\"><span class=\"built_in\">cp</span> ./mysql8.0.30/my.cnf ./mysql8.4.0/my.cnf</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 修改新的配置文件中的basedir，使其指向8.4.0的安装路径</span></span><br><span class=\"line\">basedir    = /usr/local/soft/mysql8.4.0</span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"comment\"># 使用8.4.0启动</span></span><br><span class=\"line\">./mysql8.4.0/bin/mysqld_safe --defaults-file=./mysql8.4.0/my.cnf &amp;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>查看日志，依旧是没有错误，升级很顺利</p>\n</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">2024-05-09T07:21:55.325669Z 0 [System] [MY-015015] [Server] MySQL Server - start.</span><br><span class=\"line\">2024-05-09T07:21:55.740435Z 0 [Warning] [MY-011070] [Server] &#x27;binlog_format&#x27; is deprecated and will be removed in a future release.</span><br><span class=\"line\">2024-05-09T07:21:55.740549Z 0 [Warning] [MY-010097] [Server] Insecure configuration for --secure-file-priv: Current value does not restrict location of generated files. Consider setting it to a valid, non-empty path.</span><br><span class=\"line\">2024-05-09T07:21:55.740629Z 0 [System] [MY-010116] [Server] /usr/local/soft/mysql-8.4.0-linux-glibc2.17-x86_64/bin/mysqld (mysqld 8.4.0) starting as process 28414</span><br><span class=\"line\">2024-05-09T07:21:55.796983Z 1 [System] [MY-013576] [InnoDB] InnoDB initialization has started.</span><br><span class=\"line\">2024-05-09T07:21:56.421873Z 1 [System] [MY-013577] [InnoDB] InnoDB initialization has ended.</span><br><span class=\"line\">2024-05-09T07:21:56.442008Z 1 [System] [MY-011090] [Server] Data dictionary upgrading from version &#x27;80023&#x27; to &#x27;80300&#x27;.</span><br><span class=\"line\">2024-05-09T07:21:57.106002Z 1 [System] [MY-013413] [Server] Data dictionary upgrade from version &#x27;80023&#x27; to &#x27;80300&#x27; completed.</span><br><span class=\"line\">2024-05-09T07:22:00.128935Z 4 [System] [MY-013381] [Server] Server upgrade from &#x27;80030&#x27; to &#x27;80400&#x27; started.</span><br><span class=\"line\">2024-05-09T07:22:06.850838Z 4 [System] [MY-013381] [Server] Server upgrade from &#x27;80030&#x27; to &#x27;80400&#x27; completed.</span><br><span class=\"line\">2024-05-09T07:22:07.063386Z 0 [Warning] [MY-010068] [Server] CA certificate ca.pem is self signed.</span><br><span class=\"line\">2024-05-09T07:22:07.063456Z 0 [System] [MY-013602] [Server] Channel mysql_main configured to support TLS. Encrypted connections are now supported for this channel.</span><br><span class=\"line\">2024-05-09T07:22:07.085760Z 0 [System] [MY-010931] [Server] /usr/local/soft/mysql-8.4.0-linux-glibc2.17-x86_64/bin/mysqld: ready for connections. Version: &#x27;8.4.0&#x27;  socket: &#x27;/tmp/mysql.sock&#x27;  port: 3306  MySQL Community Server - GPL.</span><br><span class=\"line\">2024-05-09T07:22:07.340333Z 0 [System] [MY-011323] [Server] X Plugin ready for connections. Bind-address: &#x27;::&#x27; port: 33060, socket: /tmp/mysqlx.sock</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>从日志看到’binlog_format’也要不支持了，不过先不用管，等到不支持了再处理吧。</p>\n</blockquote>\n<h2 id=\"如果升级到8-4之前忘记修改密码插件了，则升级之后就不能正常登录了，此时怎么办呢？\">如果升级到8.4之前忘记修改密码插件了，则升级之后就不能正常登录了，此时怎么办呢？</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>升级到8.4之前忘记修改密码插件了，则升级之后登录数据库会报告如下错误</p>\n</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ERROR 1524 (HY000): Plugin &#x27;mysql_native_password&#x27; is not loaded</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>解决方案<br>\n在mysql的配置文件中增加<code>mysql-native-password=ON</code>，然后重启数据库即可，但还是建议尽快修改用户的认证插件为<code>caching_sha2_password</code>吧，毕竟这个认证方式存在安全漏洞。</p>\n</li>\n</ul>\n<div class=\"tips\">\n<p><em><strong>小贴士</strong></em><br>\n笔者之前没有注意到8.4.0新增的<code>mysql-native-password=ON</code>这个配置，所以采用了如下重置密码的方式进行插件修改，留个纪念吧。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># kill掉mysql服务</span></span><br><span class=\"line\">killall mysqld</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 无权限模式启动</span></span><br><span class=\"line\">./mysql8.4.0/bin/mysqld_safe --defaults-file=./mysql8.4.0/my.cnf --skip-grant-tables &amp;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 登录，此时不需要密码</span></span><br><span class=\"line\">./mysql8.4.0/bin/mysql -uroot</span><br><span class=\"line\"></span><br><span class=\"line\">mysql&gt; USE mysql;</span><br><span class=\"line\"><span class=\"comment\"># 修改密码插件为 caching_sha2_password</span></span><br><span class=\"line\">mysql&gt; UPDATE user SET plugin=<span class=\"string\">&#x27;caching_sha2_password&#x27;</span> WHERE User=<span class=\"string\">&#x27;root&#x27;</span>;</span><br><span class=\"line\"><span class=\"comment\"># 将密码设置为空</span></span><br><span class=\"line\">mysql&gt; UPDATE user SET authentication_string=null WHERE User=<span class=\"string\">&#x27;root&#x27;</span>;</span><br><span class=\"line\"><span class=\"comment\"># 刷新权限：</span></span><br><span class=\"line\">mysql&gt; FLUSH PRIVILEGES;</span><br><span class=\"line\"><span class=\"comment\"># 退出MySQL</span></span><br><span class=\"line\">mysql&gt; <span class=\"built_in\">exit</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 关闭数据库，此时不需要密码即可关闭</span></span><br><span class=\"line\">./mysql8.4.0/bin/mysqladmin --defaults-file=./mysql8.4.0/my.cnf -uroot -p shutdown</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 重启启动mysql服务</span></span><br><span class=\"line\">./mysql8.4.0/bin/mysqld_safe --defaults-file=./mysql8.4.0/my.cnf &amp;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 登录，此时依旧不需要密码</span></span><br><span class=\"line\">./mysql8.4.0/bin/mysql -uroot</span><br><span class=\"line\"><span class=\"comment\"># 设置密码</span></span><br><span class=\"line\">mysql&gt; ALTER USER <span class=\"string\">&#x27;root&#x27;</span>@<span class=\"string\">&#x27;localhost&#x27;</span> IDENTIFIED BY <span class=\"string\">&#x27;123456&#x27;</span>;</span><br><span class=\"line\"><span class=\"comment\"># 刷新权限：</span></span><br><span class=\"line\">mysql&gt; FLUSH PRIVILEGES;</span><br><span class=\"line\"><span class=\"comment\"># 退出MySQL</span></span><br><span class=\"line\">mysql&gt; <span class=\"built_in\">exit</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 登录，此时使用密码就可以正常登录了</span></span><br><span class=\"line\">./mysql8.4.0/bin/mysql -uroot -p123456</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 之后再修改其他用户的密码即可，比如</span></span><br><span class=\"line\">mysql&gt; ALTER USER <span class=\"string\">&#x27;other&#x27;</span>@<span class=\"string\">&#x27;%&#x27;</span> IDENTIFIED WITH caching_sha2_password BY <span class=\"string\">&#x27;otherpass&#x27;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看修改后的user信息</span></span><br><span class=\"line\">mysql&gt; use mysql;</span><br><span class=\"line\">mysql&gt; <span class=\"keyword\">select</span> user,host,plugin from user;</span><br></pre></td></tr></table></figure>\n</div>\n","content_text":"摘要 MySql知识点介绍:从Mysql5.7升级到Mysql8 本文基于mysql-8.0.30，https://dev.mysql.com/doc/refman/8.0/en/ 2024-04-30，mysql-8.4.0 LTS版本发布，本文在将mysql从5.7.44升级到8.0.30的基础上，升级到8.4.0 LTS版本。mysql-8.4.0 LTS官方文档 从Mysql5.7升级到Mysql8 升级前，请先备份数据库，防止升级失败 mysqlsh 在mysql8以前，升级mysql还是比较麻烦的，除了要处理不兼容的参数和语法外，而且不支持跨版本的升级，比如5.5必须先升级到5.6，然后再升级到5.7。 mysqlsh是mysql官方提供的一个命令行工具，是MySQL的高级客户端和代码编辑器。其不仅可以像使用mysql命令一样执行sql，而且还支持js脚本、python脚本，等等，具体可以查看官网。 mysqlsh的众多功能之一就是可以检测当前版本是否可以升级到与当前mysqlsh相同的版本。 如果你当前的版本是5.6，你甚至都不需要先将数据库升级到5.7就可以直接升级到8.0，因为mysql8.0支持mysql5.5到mysql8.0的升级。 mysqlsh官方文档 安装mysqlsh 官网下载地址 选择需要的版本进行下载，我这里选择下载的版本是linux的8.0.30版本 下载后解压即可 检查是否可以升级 官网说明 123456789101112# mysqlsh8.4以前可以使用如下方法，因为其默认就是执行js代码./mysqlsh username:password@host -e &quot;util.checkForServerUpgrade()&quot;# mysqlsh8.4后默认执行的是sql代码，所以要先登录，切换到js环境后再运行上面的代码# 登录./mysqlsh username:password@host MySQL localhost SQL &gt; \\jsSwitching to JavaScript mode... MySQL localhost JS &gt; util.checkForServerUpgrade() …………………………………………………… # 退出 MySQL localhost JS &gt; \\qBye! 检查输出信息说明 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148WARNING: Using a password on the command line interface can be insecure.The MySQL server atlocalhost:3306, version5.7.44-log - Please upgrade to 8.0 or opt-in to the paid RDS Extended Supportservice before 5.7 reaches end of standard support on 29 February, 2024:https://a.co/hQqiIn0, will now be checked for compatibility issues for upgradeto MySQL 8.0.30...# 旧时间类型的使用1) Usage of old temporal type No issues found# 使用与新保留关键字冲突的数据库对象名称2) Usage of db objects with names conflicting with new reserved keywords No issues found# 使用utf8mb3字符集3) Usage of utf8mb3 charset Warning: The following objects use the utf8mb3 character set. It is recommended to convert them to use utf8mb4 instead, for improved Unicode support. More information: https://dev.mysql.com/doc/refman/8.0/en/charset-unicode-utf8mb3.html mydb - schema&#x27;s default character set: utf8 mysql - schema&#x27;s default character set: utf8 mydb.tbl_info_i.a_product - column&#x27;s default character set: utf8 mydb.tbl_info_i.a_country - column&#x27;s default character set: utf8 mydb.tbl_info_i.a_version - column&#x27;s default character set: utf8 mydb.tbl_info_i.a_placement - column&#x27;s default character set: utf8………………………………………………………………………………………………………………………………# MySQL模式中的表名与8.0中的新表冲突4) Table names in the mysql schema conflicting with new tables in 8.0 No issues found# 使用非本机分区引擎的分区表5) Partitioned tables using engines with non native partitioning No issues found# 外键约束名称超过64个字符6) Foreign key constraint names longer than 64 characters No issues found# 使用过时的MAXDB sql_mode标志7) Usage of obsolete MAXDB sql_mode flag No issues found# 使用过时的sql_mode标志8) Usage of obsolete sql_mode flags No issues found# ENUM/SET列定义包含超过255个字符的元素9) ENUM/SET column definitions containing elements longer than 255 characters No issues found# 在共享表空间中使用分区表10) Usage of partitioned tables in shared tablespaces No issues found# 表空间数据文件路径中的循环目录引用11) Circular directory references in tablespace data file paths No issues found# 使用已删除的函数12) Usage of removed functions No issues found# 使用已删除的GROUP BY ASC/DESC语法13) Usage of removed GROUP BY ASC/DESC syntax No issues found# 已删除的用于错误日志记录到系统日志配置的系统变量14) Removed system variables for error logging to the system log configuration To run this check requires full path to MySQL server configuration file to be specified at &#x27;configPath&#x27; key of options dictionary More information: https://dev.mysql.com/doc/relnotes/mysql/8.0/en/news-8-0-13.html#mysqld-8-0-13-logging# 已删除的系统变量15) Removed system variables To run this check requires full path to MySQL server configuration file to be specified at &#x27;configPath&#x27; key of options dictionary More information: https://dev.mysql.com/doc/refman/8.0/en/added-deprecated-removed.html#optvars-removed# 具有新默认值的系统变量16) System variables with new default values To run this check requires full path to MySQL server configuration file to be specified at &#x27;configPath&#x27; key of options dictionary More information: https://mysqlserverteam.com/new-defaults-in-mysql-8-0/# 零日期、日期时间和时间戳值17) Zero Date, Datetime, and Timestamp values Warning: By default zero date/datetime/timestamp values are no longer allowed in MySQL, as of 5.7.8 NO_ZERO_IN_DATE and NO_ZERO_DATE are included in SQL_MODE by default. These modes should be used with strict mode as they will be merged with strict mode in a future release. If you do not include these modes in your SQL_MODE setting, you are able to insert date/datetime/timestamp values that contain zeros. It is strongly advised to replace zero values with valid ones, as they may not work correctly in the future. More information: https://lefred.be/content/mysql-8-0-and-wrong-dates/ global.sql_mode - does not contain either NO_ZERO_DATE or NO_ZERO_IN_DATE which allows insertion of zero dates# 由文件删除或损坏导致的模式不一致18) Schema inconsistencies resulting from file removal or corruption No issues found# 被InnoDB识别但属于不同引擎的表19) Tables recognized by InnoDB that belong to a different engine No issues found# &#x27;check table x for upgrade&#x27;命令报告的问题20) Issues reported by &#x27;check table x for upgrade&#x27; command No issues found# 新的默认认证插件考虑21) New default authentication plugin considerations Warning: The new default authentication plugin &#x27;caching_sha2_password&#x27; offers more secure password hashing than previously used &#x27;mysql_native_password&#x27; (and consequent improved client connection authentication). However, it also has compatibility implications that may affect existing MySQL installations. If your MySQL installation must serve pre-8.0 clients and you encounter compatibility issues after upgrading, the simplest way to address those issues is to reconfigure the server to revert to the previous default authentication plugin (mysql_native_password). For example, use these lines in the server option file: [mysqld] default_authentication_plugin=mysql_native_password However, the setting should be viewed as temporary, not as a long term or permanent solution, because it causes new accounts created with the setting in effect to forego the improved authentication security. If you are using replication please take time to understand how the authentication plugin changes may impact you. More information: https://dev.mysql.com/doc/refman/8.0/en/upgrading-from-previous-series.html#upgrade-caching-sha2-password-compatibility-issues https://dev.mysql.com/doc/refman/8.0/en/upgrading-from-previous-series.html#upgrade-caching-sha2-password-replicationErrors: 0Warnings: 98Notices: 0NOTE: No fatal errors were found that would prevent an upgrade, but some potential issues were detected. Please ensure that the reported issues are not significant before upgrading. 可以看到，其检查的数据库版本是5.7.44，其检查是否可以升级到8.0.30 检测项共有21个，其中警告有98个，错误有0个，注意，如果有错误，则不能直接升级，需要解决错误问题，否则升级会失败。至于警告暂时可以不处理。 警告集中体现在字符集上，5.7.44的字符集是utf8(实际就是utf8mb3)，而mysql8以后的默认字符集是utf8mb4，这个警告不影响升级，可以忽略。如果需要修改字符集到utf8mb4，需要注意原来的字段字符串长度是否符合要求，因为utf8mb4是4字节，而utf8mb3是3字节。另外如果使用了存储过程也要注意参数的长度是否符合要求。 这里说一下default_authentication_plugin，mysql8.0.13开始，默认的认证插件是caching_sha2_password，而之前是mysql_native_password，这个警告虽然可以忽略，但是升级后建议尽快将认证插件修改为caching_sha2_password，因为mysql_native_password的认证方式存在安全漏洞，可以参考官方文档。另外，从mysql8.4.0开始，不再支持default_authentication_plugin，若要使其支持mysql_native_password插件，8.4.0开始为我们增加了一个新的配置项mysql-native-password，在[mysqld]中配置mysql-native-password=ON即可开启支持，默认为OFF。 另外还要注意关键词和保留词的问题，mysql8.0以后，又增加了很多个关键词和保留词，如果检查到则需要修改一下，不然升级会失败。即便表和字段里没有使用这些保留字，也要检查一下业务代码中是否有使用。关于关键词和保留词可以查看官网Keywords and Reserved Words，相比于MySQL 5.7，增加了大约130个，同时也减少了6个。 这里建议设置表名称和字段名称时，可以为其设置前缀，比如：表名称为：t_user、字段名称为：f_user_id 还有一点需要注意，Mysql8修改了很多参数的默认值，具体可以查看官方网站的说明，如果你不希望使用默认值，则需要将其配置到配置文件中，这里强调一下，重点关注 character_set_server 和 collation_server 这两个参数。所有的参数配置参考官方文档 关于字符集还想多说两句 mysql8的character_set_server默认是utf8mb4，collation_server默认是utf8mb4_0900_ai_ci 如果创建数据库或者表的时候没有指定字符集，则默认使用character_set_server和collation_server的默认值 此时新创建的表就有可能与旧表字符集不一致，关联查询时就有可能导致错误或因为需要进行字符集转换导致查询性能下降。 最好的方式是创建数据库或表时明确指定字符集，或者在my.cnf配置文件中配置character_set_server和collation_server的值。 升级数据库的过程 因为我们要升级到mysql8.0.30，所以需要先下载并安装mysql8.0.30 关闭mysql5.7的数据库 备份数据目录(一定要做好备份，升级后不能降级的) 根据检查提示修改my.cnf配置文件中的配置(主要是不兼容的配置，如果检查提示没有则不需要修改) 非常重要的一步，就是修改my.cnf配置文件中的basedir，将其指向mysql8.0.30的安装目录 直接使用mysql8.0.30的命令启动数据库，启动过程中就会完成数据库的升级，可以通过mysql的日志文件(log-error)查看升级情况 升级完成后尽快使用新的密码认证插件修改密码，注意要修改所有用户的密码，包括root用户 1mysql&gt; ALTER USER &#x27;root&#x27;@&#x27;localhost&#x27; IDENTIFIED WITH caching_sha2_password BY &#x27;123456&#x27;; 小贴士 mysql8.4.0相比于之前的版本变化比较大，具体可以查看官网文档 mysql5.7不要直接升级到8.4.0及以后的版本，可以先升级到8.0.30，然后再升级到8.4.0 升级到8.4.0前依旧要先使用mysqlsh检查是否可以升级，注意要下载对应的mysqlsh版本 升级前要先检查是否所有用户的密码插件都是caching_sha2_password，如果没有则需要修改 升级前要先检查my.cnf中是否配置了default_authentication_plugin，如果有则删除，如果必须要配置mysql_native_password认证插件，则需要配置mysql-native-password=ON 修改my.cnf中的basedir使其指向8.4.0的安装目录 使用8.4.0的命令启动mysql，检查日志是否有错误。 mysql5.7.44升级到8.0.30，再升级到8.4.0的完整过程 准备好各个版本的mysql和mysqlsh 1234567# 目录结构mysql5 # 5.7.44安装目录mysql8.0.30 # 8.0.30安装目录mysql8.4.0 # 8.4.0安装目录mysqlsh8.0.30 # 8.0.30的mysqlsh安装目录mysqlsh8.4.0 # 8.4.0的mysqlsh安装目录datas/mysql # 存放数据目录 mysql5/my.cnf配置 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758[mysql]default-character-set=utf8mb4local_infile=ON[client]default-character-set=utf8mb4port = 3306socket = /tmp/mysql.sock[mysqld]skip-name-resolvesecure_file_priv=&quot;&quot;local_infile=ONdefault_authentication_plugin=mysql_native_passwordport = 3306server-id = 1001user = mysqlsocket = /tmp/mysql.sockbasedir = /usr/local/soft/mysql5datadir = /usr/local/soft/datas/mysqllog-bin = mysql-binbinlog-format = ROWexpire-logs-days=10sync-binlog=0innodb_data_home_dir =./innodb_log_group_home_dir =./log-error =mysql.logpid-file =mysql.pidcharacter-set-server=utf8mb4lower_case_table_names=1autocommit =1slow_query_log=1slow_query_log_file=db_slow.loglong_query_time=5log_output=FILElog_queries_not_using_indexes=1skip-external-lockingkey_buffer_size = 256Mmax_allowed_packet = 64Mtable_open_cache = 1024sort_buffer_size = 4Mnet_buffer_length = 8Kread_buffer_size = 4Mread_rnd_buffer_size = 512Kmyisam_sort_buffer_size = 64Mthread_cache_size = 64tmp_table_size = 128Mexplicit_defaults_for_timestamp = truemax_connections = 500max_connect_errors = 100open_files_limit = 65535default_storage_engine = InnoDBinnodb_data_file_path = ibdata1:10M:autoextend 5.7.44升级到8.0.30 升级检查 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122# 升级检查./mysqlsh8.0.30/bin/mysqlsh --uri root:123456@localhost -e &quot;util.checkForServerUpgrade()&quot;# 输出WARNING: Using a password on the command line interface can be insecure.The MySQL server at /tmp%2Fmysql.sock, version 5.7.44-log - MySQL CommunityServer (GPL), will now be checked for compatibility issues for upgrade to MySQL8.0.30...1) Usage of old temporal type No issues found2) Usage of db objects with names conflicting with new reserved keywords No issues found3) Usage of utf8mb3 charset Warning: The following objects use the utf8mb3 character set. It is recommended to convert them to use utf8mb4 instead, for improved Unicode support. More information: https://dev.mysql.com/doc/refman/8.0/en/charset-unicode-utf8mb3.html mydb - schema&#x27;s default character set: utf8 mysql - schema&#x27;s default character set: utf8 mydb.tbl_info_i.a_product - column&#x27;s default character set: utf8 mydb.tbl_info_i.a_country - column&#x27;s default character set: utf8 mydb.tbl_info_i.a_version - column&#x27;s default character set: utf8 mydb.tbl_info_i.a_placement - column&#x27;s default character set: utf8 …………………………………………………………………………………………4) Table names in the mysql schema conflicting with new tables in 8.0 No issues found5) Partitioned tables using engines with non native partitioning No issues found6) Foreign key constraint names longer than 64 characters No issues found7) Usage of obsolete MAXDB sql_mode flag No issues found8) Usage of obsolete sql_mode flags Notice: The following DB objects have obsolete options persisted for sql_mode, which will be cleared during upgrade to 8.0. More information: https://dev.mysql.com/doc/refman/8.0/en/mysql-nutshell.html#mysql-nutshell-removals global system variable sql_mode - defined using obsolete NO_AUTO_CREATE_USER option9) ENUM/SET column definitions containing elements longer than 255 characters No issues found10) Usage of partitioned tables in shared tablespaces No issues found11) Circular directory references in tablespace data file paths No issues found12) Usage of removed functions No issues found13) Usage of removed GROUP BY ASC/DESC syntax No issues found14) Removed system variables for error logging to the system log configuration To run this check requires full path to MySQL server configuration file to be specified at &#x27;configPath&#x27; key of options dictionary More information: https://dev.mysql.com/doc/relnotes/mysql/8.0/en/news-8-0-13.html#mysqld-8-0-13-logging15) Removed system variables To run this check requires full path to MySQL server configuration file to be specified at &#x27;configPath&#x27; key of options dictionary More information: https://dev.mysql.com/doc/refman/8.0/en/added-deprecated-removed.html#optvars-removed16) System variables with new default values To run this check requires full path to MySQL server configuration file to be specified at &#x27;configPath&#x27; key of options dictionary More information: https://mysqlserverteam.com/new-defaults-in-mysql-8-0/17) Zero Date, Datetime, and Timestamp values No issues found18) Schema inconsistencies resulting from file removal or corruption No issues found19) Tables recognized by InnoDB that belong to a different engine No issues found20) Issues reported by &#x27;check table x for upgrade&#x27; command No issues found21) New default authentication plugin considerations Warning: The new default authentication plugin &#x27;caching_sha2_password&#x27; offers more secure password hashing than previously used &#x27;mysql_native_password&#x27; (and consequent improved client connection authentication). However, it also has compatibility implications that may affect existing MySQL installations. If your MySQL installation must serve pre-8.0 clients and you encounter compatibility issues after upgrading, the simplest way to address those issues is to reconfigure the server to revert to the previous default authentication plugin (mysql_native_password). For example, use these lines in the server option file: [mysqld] default_authentication_plugin=mysql_native_password However, the setting should be viewed as temporary, not as a long term or permanent solution, because it causes new accounts created with the setting in effect to forego the improved authentication security. If you are using replication please take time to understand how the authentication plugin changes may impact you. More information: https://dev.mysql.com/doc/refman/8.0/en/upgrading-from-previous-series.html#upgrade-caching-sha2-password-compatibility-issues https://dev.mysql.com/doc/refman/8.0/en/upgrading-from-previous-series.html#upgrade-caching-sha2-password-replicationErrors: 0Warnings: 98Notices: 1NOTE: No fatal errors were found that would prevent an upgrade, but some potential issues were detected. Please ensure that the reported issues are not significant before upgrading. 看到没有error，开始升级 1234567891011# 关闭数据库./mysql5/bin/mysqladmin --defaults-file=./mysql5/my.cnf -uroot -p123456 shutdown# 复制mysql配置文件cp ./mysql5/my.cnf ./mysql8.0.30/my.cnf# 修改新的配置文件中的basedir，使其指向8.0.30的安装路径basedir = /usr/local/soft/mysql8.0.30# 使用8.0.30启动./mysql8.0.30/bin/mysqld_safe --defaults-file=./mysql8.0.30/my.cnf &amp; 查看启动日志，没有错误说明升级成功 12345678910111213142024-05-09T06:48:50.524705Z 0 [Warning] [MY-011068] [Server] The syntax &#x27;expire-logs-days&#x27; is deprecated and will be removed in a future release. Please use binlog_expire_logs_seconds instead.2024-05-09T06:48:50.524819Z 0 [Warning] [MY-010097] [Server] Insecure configuration for --secure-file-priv: Current value does not restrict location of generated files. Consider setting it to a valid, non-empty path.2024-05-09T06:48:50.524917Z 0 [Warning] [MY-010918] [Server] &#x27;default_authentication_plugin&#x27; is deprecated and will be removed in a future release. Please use authentication_policy instead.2024-05-09T06:48:50.524983Z 0 [System] [MY-010116] [Server] /usr/local/soft/mysql8.0.30/bin/mysqld (mysqld 8.0.30) starting as process 266962024-05-09T06:48:50.563366Z 1 [System] [MY-011012] [Server] Starting upgrade of data directory.2024-05-09T06:48:50.563414Z 1 [System] [MY-013576] [InnoDB] InnoDB initialization has started.2024-05-09T06:48:51.260298Z 1 [System] [MY-013577] [InnoDB] InnoDB initialization has ended.2024-05-09T06:48:53.614398Z 2 [System] [MY-011003] [Server] Finished populating Data Dictionary tables with data.2024-05-09T06:48:55.055320Z 5 [System] [MY-013381] [Server] Server upgrade from &#x27;50700&#x27; to &#x27;80030&#x27; started.2024-05-09T06:49:02.063990Z 5 [System] [MY-013381] [Server] Server upgrade from &#x27;50700&#x27; to &#x27;80030&#x27; completed.2024-05-09T06:49:02.237992Z 0 [Warning] [MY-010068] [Server] CA certificate ca.pem is self signed.2024-05-09T06:49:02.238048Z 0 [System] [MY-013602] [Server] Channel mysql_main configured to support TLS. Encrypted connections are now supported for this channel.2024-05-09T06:49:02.267583Z 0 [System] [MY-011323] [Server] X Plugin ready for connections. Bind-address: &#x27;::&#x27; port: 33060, socket: /tmp/mysqlx.sock2024-05-09T06:49:02.267648Z 0 [System] [MY-010931] [Server] /usr/local/soft/mysql8.0.30/bin/mysqld: ready for connections. Version: &#x27;8.0.30&#x27; socket: &#x27;/tmp/mysql.sock&#x27; port: 3306 MySQL Community Server - GPL. 根据日志提示我们应该修改两个配置参数，未来将不可用了，不过这里暂且先不去管它，等检查通不过了再进行处理就可以。 121.The syntax &#x27;expire-logs-days&#x27; is deprecated and will be removed in a future release. Please use binlog_expire_logs_seconds instead.2.&#x27;default_authentication_plugin&#x27; is deprecated and will be removed in a future release. Please use authentication_policy instead. 修改密码插件，这个步骤很重要 1234# 登录./mysql8.0.30/bin/mysql -uroot -p123456# 升级完成后使用新的密码认证插件修改密码，8.4不再推荐mysql_native_password认证插，所以升级到8.4以前一定要先修改密码插件，如果忘记了也没关系，文末有重置密码的方法mysql&gt; ALTER USER &#x27;root&#x27;@&#x27;localhost&#x27; IDENTIFIED WITH caching_sha2_password BY &#x27;123456&#x27;; 8.0.30升级到8.4.0 同样先用8.4.0的mysqlsh检查一下 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145# 升级检查./mysqlsh8.4.0/bin/mysqlsh --uri root:123456@localhost# 输出MySQL Shell 8.4.0Copyright (c) 2016, 2024, Oracle and/or its affiliates.Oracle is a registered trademark of Oracle Corporation and/or its affiliates.Other names may be trademarks of their respective owners.Type &#x27;\\help&#x27; or &#x27;\\?&#x27; for help; &#x27;\\quit&#x27; to exit.WARNING: Using a password on the command line interface can be insecure.Creating a Classic session to &#x27;root@/tmp%2Fmysql.sock&#x27;Fetching global names for auto-completion... Press ^C to stop.Your MySQL connection id is 15Server version: 8.0.30 MySQL Community Server - GPLNo default schema selected; type \\use &lt;schema&gt; to set one. MySQL localhost SQL &gt; \\jsSwitching to JavaScript mode... MySQL localhost JS &gt; util.checkForServerUpgrade()The MySQL server at /tmp%2Fmysql.sock, version 8.0.30 - MySQL Community Server- GPL, will now be checked for compatibility issues for upgrade to MySQL 8.4.0.To check for a different target server version, use the targetVersion option.WARNING: Upgrading MySQL Server from version 8.0.30 to 8.4.0 is not supported.Please consider running the check using the following option: targetVersion=8.01) Usage of db objects with names conflicting with new reserved keywords(reservedKeywords) No issues found2) Removed system variables (removedSysVars) Error: Following system variables that were detected as being used will be removed. Please update your system to not rely on them before the upgrade. More information: https://dev.mysql.com/doc/refman/8.0/en/added-deprecated-removed.html#optvars-removed expire_logs_days - Error: The system variable &#x27;expire_logs_days&#x27; is set to 10 (EXPLICIT) and will be removed.3) System variables with new default values (sysVarsNewDefaults) Warning: Following system variables that are not defined in your configuration file will have new default values. Please review if you rely on their current values and if so define them before performing upgrade. More information: https://dev.mysql.com/blog-archive/new-defaults-in-mysql-8-0/ binlog_transaction_dependency_tracking - default value will change from COMMIT_ORDER to WRITESET. group_replication_consistency - default value will change from EVENTUAL to BEFORE_ON_PRIMARY_FAILOVER. group_replication_exit_state_action - default value will change from READ_ONLY to OFFLINE_MODE. innodb_adaptive_hash_index - default value will change from ON to OFF. innodb_buffer_pool_in_core_file - default value will change from ON to OFF. innodb_buffer_pool_instances - default value will change from 8 (or 1 if innodb_buffer_pool_size &lt; 1GB) to MAX(1, #vcpu/4). innodb_change_buffering - default value will change from all to none. innodb_doublewrite_files - default value will change from innodb_buffer_pool_instances * 2 to 2. innodb_doublewrite_pages - default value will change from innodb_write_io_threads to 128. innodb_flush_method - default value will change from fsynch (unix) or unbuffered (windows) to O_DIRECT. innodb_io_capacity - default value will change from 200 to 10000. innodb_io_capacity_max - default value will change from 200 to 2 x innodb_io_capacity. innodb_log_buffer_size - default value will change from 16777216 (16MB) to 67108864 (64MB). innodb_log_writer_threads - default value will change from ON to OFF ( if #vcpu &lt;= 32 ). innodb_numa_interleave - default value will change from OFF to ON. innodb_page_cleaners - default value will change from 4 to innodb_buffer_pool_instances. innodb_parallel_read_threads - default value will change from 4 to MAX(#vcpu/8, 4). innodb_purge_threads - default value will change from 4 to 1 ( if #vcpu &lt;= 16 ). innodb_read_io_threads - default value will change from 4 to MAX(#vcpu/2, 4). innodb_redo_log_capacity - default value will change from 104857600 (100MB) to MIN ( #vcpu/2, 16 )GB.4) Issues reported by &#x27;check table x for upgrade&#x27; command (checkTableCommand) No issues found5) Check for deprecated usage of single dollar signs in object names(dollarSignName) No issues found6) Check for deprecated or invalid user authentication methods.(authMethodUsage) Warning: The following users are using the &#x27;mysql_native_password&#x27; authentication method which is deprecated as of MySQL 8.0.0 and will be removed in a future release. Consider switching the users to a different authentication method (i.e. caching_sha2_password). - mydb@% - mysql.session@localhost - mysql.sys@localhost - root@localhost More information: https://dev.mysql.com/doc/refman/8.0/en/caching-sha2-pluggable-authentication.html7) Check for deprecated or removed plugin usage. (pluginUsage) No issues found8) Check for deprecated or invalid default authentication methods in systemvariables. (deprecatedDefaultAuth) The following variables have problems with their set authentication method: Error: default_authentication_plugin - mysql_native_password authentication method was removed and it must be corrected before upgrading to 8.4.0 release.9) Check for deprecated or invalid authentication methods in use by MySQLRouter internal accounts. (deprecatedRouterAuthMethod) No issues found10) Checks for errors in column definitions (columnDefinition) No issues found11) Check for allowed values in System Variables. (sysvarAllowedValues) No issues found12) Checks for user privileges that will be removed (invalidPrivileges) Verifies for users containing grants to be removed, since privileges are removed as part of the upgrade, raises a NOTICE to inform the user about users that will be losing invalid privileges &#x27;mysql.session&#x27;@&#x27;localhost&#x27; - The user &#x27;mysql.session&#x27;@&#x27;localhost&#x27; has the following privileges that will be removed as part of the upgrade process: SET_USER_ID &#x27;root&#x27;@&#x27;localhost&#x27; - The user &#x27;root&#x27;@&#x27;localhost&#x27; has the following privileges that will be removed as part of the upgrade process: SET_USER_ID13) Checks for partitions by key using columns with prefix key indexes(partitionsWithPrefixKeys) No issues foundErrors: 2Warnings: 24Notices: 2ERROR: 2 errors were found. Please correct these issues before upgrading to avoid compatibility issues. 看到了两处错误，就是我们上面说的那两个参数需要修改，修改./mysql8.0.30/my.cnf 12345# binlog日志过期时间，单位秒，过期的binlog日志会被删除，保证磁盘空间，这里设置为10天，mysql8以前的版本这个参数是expire-logs-days，单位是天binlog_expire_logs_seconds =864000#expire-logs-days=10#default_authentication_plugin=mysql_native_password 修改后要重启数据库 12345# 关闭数据库 ./mysql8.0.30/bin/mysqladmin --defaults-file=./mysql8.0.30/my.cnf -uroot -p123456 shutdown # 使用8.0.30启动 ./mysql8.0.30/bin/mysqld_safe --defaults-file=./mysql8.0.30/my.cnf &amp; 再次进程升级检查 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136# 升级检查./mysqlsh8.4.0/bin/mysqlsh --uri root:123456@localhost# 输出MySQL Shell 8.4.0Copyright (c) 2016, 2024, Oracle and/or its affiliates.Oracle is a registered trademark of Oracle Corporation and/or its affiliates.Other names may be trademarks of their respective owners.Type &#x27;\\help&#x27; or &#x27;\\?&#x27; for help; &#x27;\\quit&#x27; to exit.WARNING: Using a password on the command line interface can be insecure.Creating a Classic session to &#x27;root@/tmp%2Fmysql.sock&#x27;Fetching global names for auto-completion... Press ^C to stop.Your MySQL connection id is 8Server version: 8.0.30 MySQL Community Server - GPLNo default schema selected; type \\use &lt;schema&gt; to set one. MySQL localhost SQL &gt; \\jsSwitching to JavaScript mode... MySQL localhost JS &gt; util.checkForServerUpgrade()The MySQL server at /tmp%2Fmysql.sock, version 8.0.30 - MySQL Community Server- GPL, will now be checked for compatibility issues for upgrade to MySQL 8.4.0.To check for a different target server version, use the targetVersion option.WARNING: Upgrading MySQL Server from version 8.0.30 to 8.4.0 is not supported.Please consider running the check using the following option: targetVersion=8.01) Usage of db objects with names conflicting with new reserved keywords(reservedKeywords) No issues found2) Removed system variables (removedSysVars) No issues found3) System variables with new default values (sysVarsNewDefaults) Warning: Following system variables that are not defined in your configuration file will have new default values. Please review if you rely on their current values and if so define them before performing upgrade. More information: https://dev.mysql.com/blog-archive/new-defaults-in-mysql-8-0/ binlog_transaction_dependency_tracking - default value will change from COMMIT_ORDER to WRITESET. group_replication_consistency - default value will change from EVENTUAL to BEFORE_ON_PRIMARY_FAILOVER. group_replication_exit_state_action - default value will change from READ_ONLY to OFFLINE_MODE. innodb_adaptive_hash_index - default value will change from ON to OFF. innodb_buffer_pool_in_core_file - default value will change from ON to OFF. innodb_buffer_pool_instances - default value will change from 8 (or 1 if innodb_buffer_pool_size &lt; 1GB) to MAX(1, #vcpu/4). innodb_change_buffering - default value will change from all to none. innodb_doublewrite_files - default value will change from innodb_buffer_pool_instances * 2 to 2. innodb_doublewrite_pages - default value will change from innodb_write_io_threads to 128. innodb_flush_method - default value will change from fsynch (unix) or unbuffered (windows) to O_DIRECT. innodb_io_capacity - default value will change from 200 to 10000. innodb_io_capacity_max - default value will change from 200 to 2 x innodb_io_capacity. innodb_log_buffer_size - default value will change from 16777216 (16MB) to 67108864 (64MB). innodb_log_writer_threads - default value will change from ON to OFF ( if #vcpu &lt;= 32 ). innodb_numa_interleave - default value will change from OFF to ON. innodb_page_cleaners - default value will change from 4 to innodb_buffer_pool_instances. innodb_parallel_read_threads - default value will change from 4 to MAX(#vcpu/8, 4). innodb_purge_threads - default value will change from 4 to 1 ( if #vcpu &lt;= 16 ). innodb_read_io_threads - default value will change from 4 to MAX(#vcpu/2, 4). innodb_redo_log_capacity - default value will change from 104857600 (100MB) to MIN ( #vcpu/2, 16 )GB.4) Issues reported by &#x27;check table x for upgrade&#x27; command (checkTableCommand) No issues found5) Check for deprecated usage of single dollar signs in object names(dollarSignName) No issues found6) Check for deprecated or invalid user authentication methods.(authMethodUsage) Warning: The following users are using the &#x27;mysql_native_password&#x27; authentication method which is deprecated as of MySQL 8.0.0 and will be removed in a future release. Consider switching the users to a different authentication method (i.e. caching_sha2_password). - mydb@% - mysql.session@localhost - mysql.sys@localhost - root@localhost More information: https://dev.mysql.com/doc/refman/8.0/en/caching-sha2-pluggable-authentication.html7) Check for deprecated or removed plugin usage. (pluginUsage) No issues found8) Check for deprecated or invalid default authentication methods in systemvariables. (deprecatedDefaultAuth) No issues found9) Check for deprecated or invalid authentication methods in use by MySQLRouter internal accounts. (deprecatedRouterAuthMethod) No issues found10) Checks for errors in column definitions (columnDefinition) No issues found11) Check for allowed values in System Variables. (sysvarAllowedValues) No issues found12) Checks for user privileges that will be removed (invalidPrivileges) Verifies for users containing grants to be removed, since privileges are removed as part of the upgrade, raises a NOTICE to inform the user about users that will be losing invalid privileges &#x27;mysql.session&#x27;@&#x27;localhost&#x27; - The user &#x27;mysql.session&#x27;@&#x27;localhost&#x27; has the following privileges that will be removed as part of the upgrade process: SET_USER_ID &#x27;root&#x27;@&#x27;localhost&#x27; - The user &#x27;root&#x27;@&#x27;localhost&#x27; has the following privileges that will be removed as part of the upgrade process: SET_USER_ID13) Checks for partitions by key using columns with prefix key indexes(partitionsWithPrefixKeys) No issues foundErrors: 0Warnings: 24Notices: 2NOTE: No fatal errors were found that would prevent an upgrade, but some potential issues were detected. Please ensure that the reported issues are not significant before upgrading. 此时看到通过检查，关闭数据库直接升级吧 1234567891011# 关闭数据库./mysql8.0.30/bin/mysqladmin --defaults-file=./mysql8.0.30/my.cnf -uroot -p123456 shutdown# 复制mysql配置文件cp ./mysql8.0.30/my.cnf ./mysql8.4.0/my.cnf# 修改新的配置文件中的basedir，使其指向8.4.0的安装路径basedir = /usr/local/soft/mysql8.4.0 # 使用8.4.0启动./mysql8.4.0/bin/mysqld_safe --defaults-file=./mysql8.4.0/my.cnf &amp; 查看日志，依旧是没有错误，升级很顺利 12345678910111213142024-05-09T07:21:55.325669Z 0 [System] [MY-015015] [Server] MySQL Server - start.2024-05-09T07:21:55.740435Z 0 [Warning] [MY-011070] [Server] &#x27;binlog_format&#x27; is deprecated and will be removed in a future release.2024-05-09T07:21:55.740549Z 0 [Warning] [MY-010097] [Server] Insecure configuration for --secure-file-priv: Current value does not restrict location of generated files. Consider setting it to a valid, non-empty path.2024-05-09T07:21:55.740629Z 0 [System] [MY-010116] [Server] /usr/local/soft/mysql-8.4.0-linux-glibc2.17-x86_64/bin/mysqld (mysqld 8.4.0) starting as process 284142024-05-09T07:21:55.796983Z 1 [System] [MY-013576] [InnoDB] InnoDB initialization has started.2024-05-09T07:21:56.421873Z 1 [System] [MY-013577] [InnoDB] InnoDB initialization has ended.2024-05-09T07:21:56.442008Z 1 [System] [MY-011090] [Server] Data dictionary upgrading from version &#x27;80023&#x27; to &#x27;80300&#x27;.2024-05-09T07:21:57.106002Z 1 [System] [MY-013413] [Server] Data dictionary upgrade from version &#x27;80023&#x27; to &#x27;80300&#x27; completed.2024-05-09T07:22:00.128935Z 4 [System] [MY-013381] [Server] Server upgrade from &#x27;80030&#x27; to &#x27;80400&#x27; started.2024-05-09T07:22:06.850838Z 4 [System] [MY-013381] [Server] Server upgrade from &#x27;80030&#x27; to &#x27;80400&#x27; completed.2024-05-09T07:22:07.063386Z 0 [Warning] [MY-010068] [Server] CA certificate ca.pem is self signed.2024-05-09T07:22:07.063456Z 0 [System] [MY-013602] [Server] Channel mysql_main configured to support TLS. Encrypted connections are now supported for this channel.2024-05-09T07:22:07.085760Z 0 [System] [MY-010931] [Server] /usr/local/soft/mysql-8.4.0-linux-glibc2.17-x86_64/bin/mysqld: ready for connections. Version: &#x27;8.4.0&#x27; socket: &#x27;/tmp/mysql.sock&#x27; port: 3306 MySQL Community Server - GPL.2024-05-09T07:22:07.340333Z 0 [System] [MY-011323] [Server] X Plugin ready for connections. Bind-address: &#x27;::&#x27; port: 33060, socket: /tmp/mysqlx.sock 从日志看到’binlog_format’也要不支持了，不过先不用管，等到不支持了再处理吧。 如果升级到8.4之前忘记修改密码插件了，则升级之后就不能正常登录了，此时怎么办呢？ 升级到8.4之前忘记修改密码插件了，则升级之后登录数据库会报告如下错误 1ERROR 1524 (HY000): Plugin &#x27;mysql_native_password&#x27; is not loaded 解决方案 在mysql的配置文件中增加mysql-native-password=ON，然后重启数据库即可，但还是建议尽快修改用户的认证插件为caching_sha2_password吧，毕竟这个认证方式存在安全漏洞。 小贴士 笔者之前没有注意到8.4.0新增的mysql-native-password=ON这个配置，所以采用了如下重置密码的方式进行插件修改，留个纪念吧。 12345678910111213141516171819202122232425262728293031323334353637383940414243# kill掉mysql服务killall mysqld# 无权限模式启动./mysql8.4.0/bin/mysqld_safe --defaults-file=./mysql8.4.0/my.cnf --skip-grant-tables &amp;# 登录，此时不需要密码./mysql8.4.0/bin/mysql -urootmysql&gt; USE mysql;# 修改密码插件为 caching_sha2_passwordmysql&gt; UPDATE user SET plugin=&#x27;caching_sha2_password&#x27; WHERE User=&#x27;root&#x27;;# 将密码设置为空mysql&gt; UPDATE user SET authentication_string=null WHERE User=&#x27;root&#x27;;# 刷新权限：mysql&gt; FLUSH PRIVILEGES;# 退出MySQLmysql&gt; exit;# 关闭数据库，此时不需要密码即可关闭./mysql8.4.0/bin/mysqladmin --defaults-file=./mysql8.4.0/my.cnf -uroot -p shutdown# 重启启动mysql服务./mysql8.4.0/bin/mysqld_safe --defaults-file=./mysql8.4.0/my.cnf &amp;# 登录，此时依旧不需要密码./mysql8.4.0/bin/mysql -uroot# 设置密码mysql&gt; ALTER USER &#x27;root&#x27;@&#x27;localhost&#x27; IDENTIFIED BY &#x27;123456&#x27;;# 刷新权限：mysql&gt; FLUSH PRIVILEGES;# 退出MySQLmysql&gt; exit;# 登录，此时使用密码就可以正常登录了./mysql8.4.0/bin/mysql -uroot -p123456# 之后再修改其他用户的密码即可，比如mysql&gt; ALTER USER &#x27;other&#x27;@&#x27;%&#x27; IDENTIFIED WITH caching_sha2_password BY &#x27;otherpass&#x27;;# 查看修改后的user信息mysql&gt; use mysql;mysql&gt; select user,host,plugin from user;","summary":"摘要 MySql知识点介绍:从Mysql5.7升级到Mysql8 本文基于mysql-8.0.30，https://dev.mysql.com/doc/refman/8.0/en/ 2024-04-30，mysql-8.4.0 LTS版本发布，本文在将mysql从5.7.44升级到8.0.30的基础上，升级到8.4.0 LTS版本。mysql-8.4.0 LTS官方文档","date_published":"2024-05-08T13:35:05.000Z","tags":["技术","mysql","mysql"]},{"id":"https://blog.hanqunfeng.com/2024/04/08/mongodb7-pool-springboot/","url":"https://blog.hanqunfeng.com/2024/04/08/mongodb7-pool-springboot/","title":"MongoDB7.0--SpringBoot配置mongodb连接池","content_html":"<!--\n **加粗**\n *斜体*\n ***加粗并斜体***\n ~~删除线~~\n ==突出显示==\n `突出显示(推荐)`\n ++下划线++\n ~下标~\n ^上标^\n 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.\n 图片设置宽度和高度(通过uPic上传后，需要将upic修改过为blog，用于添加水印) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)\n\n +++ **点击折叠**\n 这是被隐藏的内容\n +++\n\n::: tips success warning danger\n这里是容器内的内容\n:::\n\n% note info % success warning danger\n这里是容器内的内容\n% endnote %\n\n引用本地其它文章连接{}\n 大括号开始% post_link 文件名称(不包含.md) %大括号结束\n -->\n<h2 id=\"摘要\">摘要</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>本文介绍如何使用SpringBoot配置MongoDB7.0的连接池</p>\n</li>\n<li class=\"lvl-2\">\n<p>SpringBoot版本3.2.4，MongoDB版本7.0.6</p>\n</li>\n<li class=\"lvl-2\">\n<p>关于springboot与mongodb的集成可以参考：<a href=\"/2024/03/05/mongodb7-springboot/\" title=\"MongoDB7.0--SpringBoot单集合操作\">MongoDB7.0--SpringBoot单集合操作</a>，本文只讨论连接池相关内容。</p>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"spring-boot-的-MongoDB-连接池\">spring-boot 的 MongoDB 连接池</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>当我们在springboot的配置文件中配置mongodb的相关属性时，并没有发现和连接池相关的属性，查看<code>MongoProperties</code>中的属性也可以证实这一点，这就很奇怪，按理说springboot应该不会这么弱鸡。</p>\n</li>\n<li class=\"lvl-2\">\n<p>于是我打算看看springboot的源码，看看springboot为我们自动创建的<code>MongoClient</code>到底有没有连接池的配置。</p>\n</li>\n<li class=\"lvl-2\">\n<p>我们就从mongodb的自动配置类<code>MongoAutoConfiguration</code>开始，该类中定义了<code>PropertiesMongoConnectionDetails</code>和<code>MongoClient</code></p>\n</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//这个类主要用于ConnectionString对象的封装，后面会讲到</span></span><br><span class=\"line\"><span class=\"meta\">@Bean</span></span><br><span class=\"line\"><span class=\"meta\">@ConditionalOnMissingBean(&#123;MongoConnectionDetails.class&#125;)</span></span><br><span class=\"line\">PropertiesMongoConnectionDetails <span class=\"title function_\">mongoConnectionDetails</span><span class=\"params\">(MongoProperties properties)</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">PropertiesMongoConnectionDetails</span>(properties);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Bean</span></span><br><span class=\"line\"><span class=\"meta\">@ConditionalOnMissingBean(&#123;MongoClient.class&#125;)</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> MongoClient <span class=\"title function_\">mongo</span><span class=\"params\">(ObjectProvider&lt;MongoClientSettingsBuilderCustomizer&gt; builderCustomizers, MongoClientSettings settings)</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> (MongoClient)(<span class=\"keyword\">new</span> <span class=\"title class_\">MongoClientFactory</span>(builderCustomizers.orderedStream().toList())).createMongoClient(settings);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>可以看到，创建<code>MongoClient</code>的bean时，依赖两个参数，一个是<code>ObjectProvider&lt;MongoClientSettingsBuilderCustomizer&gt;</code>，一个是<code>MongoClientSettings</code>，前者会将spring上下文中所有类型为<code>MongoClientSettingsBuilderCustomizer</code>的bean封装到该对象中(springboot默认只提供了一个<code>StandardMongoClientSettingsBuilderCustomizer</code>)</p>\n</li>\n<li class=\"lvl-2\">\n<p><code>MongoAutoConfiguration</code>缺省为我们提供了<code>MongoClientSettings</code>和<code>StandardMongoClientSettingsBuilderCustomizer</code>，这两个类都很重要，连接池参数就和它们有关</p>\n</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Bean</span></span><br><span class=\"line\">MongoClientSettings <span class=\"title function_\">mongoClientSettings</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> MongoClientSettings.builder().build();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// 需要的参数connectionDetails刚好是上面的PropertiesMongoConnectionDetails</span></span><br><span class=\"line\"><span class=\"meta\">@Bean</span></span><br><span class=\"line\">StandardMongoClientSettingsBuilderCustomizer <span class=\"title function_\">standardMongoSettingsCustomizer</span><span class=\"params\">(MongoProperties properties, MongoConnectionDetails connectionDetails, ObjectProvider&lt;SslBundles&gt; sslBundles)</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">StandardMongoClientSettingsBuilderCustomizer</span>(connectionDetails.getConnectionString(), properties.getUuidRepresentation(), properties.getSsl(), (SslBundles)sslBundles.getIfAvailable());</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>我们先看<code>MongoClientSettings</code>，其中就定义一个连接池的配置对象<code>ConnectionPoolSettings</code>，而<code>ConnectionPoolSettings</code>其内部就定义了连接池的配置属性，<code>MongoClientSettings</code>通过<code>ConnectionPoolSettings</code>的构造器创建出了<code>ConnectionPoolSettings</code>对象，其缺省值如下：</p>\n</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"type\">int</span> <span class=\"variable\">maxSize</span> <span class=\"operator\">=</span> <span class=\"number\">100</span>;</span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"type\">int</span> minSize;</span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"type\">long</span> <span class=\"variable\">maxWaitTimeMS</span> <span class=\"operator\">=</span> <span class=\"number\">1000</span> * <span class=\"number\">60</span> * <span class=\"number\">2</span>;</span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"type\">long</span> maxConnectionLifeTimeMS;</span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"type\">long</span> maxConnectionIdleTimeMS;</span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"type\">int</span> <span class=\"variable\">maxConnecting</span> <span class=\"operator\">=</span> <span class=\"number\">2</span>;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>我们看另一个和创建<code>MongoClient</code>相关的bean，这个<code>StandardMongoClientSettingsBuilderCustomizer</code>，创建这个bean时需要一个<code>MongoConnectionDetails</code>对象，并调用其<code>getConnectionString</code>方法，这个对象<code>MongoAutoConfiguration</code>也为我们提供了(上面可以看到)</p>\n</li>\n<li class=\"lvl-2\">\n<p>查看<code>PropertiesMongoConnectionDetails</code>的源码，发现<code>connectionDetails.getConnectionString()</code>的功能就是将<code>MongoProperties</code>的属性封装为<code>uri</code>并传递给<code>ConnectionString</code>的构造器创建对象</p>\n</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> ConnectionString <span class=\"title function_\">getConnectionString</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"built_in\">this</span>.properties.getUri() != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ConnectionString</span>(<span class=\"built_in\">this</span>.properties.getUri());</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"type\">StringBuilder</span> <span class=\"variable\">builder</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">StringBuilder</span>(<span class=\"string\">&quot;mongodb://&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"built_in\">this</span>.properties.getUsername() != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            builder.append(<span class=\"built_in\">this</span>.encode(<span class=\"built_in\">this</span>.properties.getUsername()));</span><br><span class=\"line\">            builder.append(<span class=\"string\">&quot;:&quot;</span>);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (<span class=\"built_in\">this</span>.properties.getPassword() != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">                builder.append(<span class=\"built_in\">this</span>.encode(<span class=\"built_in\">this</span>.properties.getPassword()));</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            builder.append(<span class=\"string\">&quot;@&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        builder.append(<span class=\"built_in\">this</span>.properties.getHost() != <span class=\"literal\">null</span> ? <span class=\"built_in\">this</span>.properties.getHost() : <span class=\"string\">&quot;localhost&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"built_in\">this</span>.properties.getPort() != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            builder.append(<span class=\"string\">&quot;:&quot;</span>);</span><br><span class=\"line\">            builder.append(<span class=\"built_in\">this</span>.properties.getPort());</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"built_in\">this</span>.properties.getAdditionalHosts() != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            builder.append(<span class=\"string\">&quot;,&quot;</span>);</span><br><span class=\"line\">            builder.append(String.join(<span class=\"string\">&quot;,&quot;</span>, <span class=\"built_in\">this</span>.properties.getAdditionalHosts()));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        builder.append(<span class=\"string\">&quot;/&quot;</span>);</span><br><span class=\"line\">        builder.append(<span class=\"built_in\">this</span>.properties.getMongoClientDatabase());</span><br><span class=\"line\">        List&lt;String&gt; options = <span class=\"built_in\">this</span>.getOptions();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!options.isEmpty()) &#123;</span><br><span class=\"line\">            builder.append(<span class=\"string\">&quot;?&quot;</span>);</span><br><span class=\"line\">            builder.append(String.join(<span class=\"string\">&quot;&amp;&quot;</span>, options));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">// 将MongoProperties转换为uri格式后调用构造器创建ConnectionString</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ConnectionString</span>(builder.toString());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>这个<code>ConnectionString</code>对象的初始化过程就很有意思了，其会对这个<code>uri</code>进行解析，解析过程中会调用<code>parseOptions(connectionStringQueryParameters)</code>方法，其会将<code>uri</code>中的参数转换为<code>Map</code>，之后调用<code>translateOptions(combinedOptionsMaps)</code>方法遍历这个map，而在遍历的过程中就会完成对<code>ConnectionString</code>对象的连接池相关属性的初始化</p>\n</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">translateOptions</span><span class=\"params\">(<span class=\"keyword\">final</span> Map&lt;String, List&lt;String&gt;&gt; optionsMap)</span> &#123;</span><br><span class=\"line\">        <span class=\"type\">boolean</span> <span class=\"variable\">tlsInsecureSet</span> <span class=\"operator\">=</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">        <span class=\"type\">boolean</span> <span class=\"variable\">tlsAllowInvalidHostnamesSet</span> <span class=\"operator\">=</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">final</span> String key : GENERAL_OPTIONS_KEYS) &#123;</span><br><span class=\"line\">            <span class=\"type\">String</span> <span class=\"variable\">value</span> <span class=\"operator\">=</span> getLastValue(optionsMap, key);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (value == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">switch</span> (key) &#123;</span><br><span class=\"line\">                <span class=\"comment\">// 连接池相关属性，注意这里的属性名称，后面我们配置连接池时会用到</span></span><br><span class=\"line\">                <span class=\"keyword\">case</span> <span class=\"string\">&quot;maxpoolsize&quot;</span>:</span><br><span class=\"line\">                    maxConnectionPoolSize = parseInteger(value, <span class=\"string\">&quot;maxpoolsize&quot;</span>);</span><br><span class=\"line\">                    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">                <span class=\"keyword\">case</span> <span class=\"string\">&quot;minpoolsize&quot;</span>:</span><br><span class=\"line\">                    minConnectionPoolSize = parseInteger(value, <span class=\"string\">&quot;minpoolsize&quot;</span>);</span><br><span class=\"line\">                    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">                <span class=\"keyword\">case</span> <span class=\"string\">&quot;maxidletimems&quot;</span>:</span><br><span class=\"line\">                    maxConnectionIdleTime = parseInteger(value, <span class=\"string\">&quot;maxidletimems&quot;</span>);</span><br><span class=\"line\">                    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">                <span class=\"keyword\">case</span> <span class=\"string\">&quot;maxlifetimems&quot;</span>:</span><br><span class=\"line\">                    maxConnectionLifeTime = parseInteger(value, <span class=\"string\">&quot;maxlifetimems&quot;</span>);</span><br><span class=\"line\">                    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">                <span class=\"keyword\">case</span> <span class=\"string\">&quot;maxconnecting&quot;</span>:</span><br><span class=\"line\">                    maxConnecting = parseInteger(value, <span class=\"string\">&quot;maxConnecting&quot;</span>);</span><br><span class=\"line\">                    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">                <span class=\"keyword\">case</span> <span class=\"string\">&quot;waitqueuetimeoutms&quot;</span>:</span><br><span class=\"line\">                    maxWaitTime = parseInteger(value, <span class=\"string\">&quot;waitqueuetimeoutms&quot;</span>);</span><br><span class=\"line\">                    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">                <span class=\"keyword\">case</span> <span class=\"string\">&quot;connecttimeoutms&quot;</span>:</span><br><span class=\"line\">                    connectTimeout = parseInteger(value, <span class=\"string\">&quot;connecttimeoutms&quot;</span>);</span><br><span class=\"line\">                    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">           ……………………………………………………………………………………</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>其实此时我们就已经知道应该如何配置连接池参数了，就是将连接池相关的参数追加到<code>uri</code>的参数部分，但是前面我们提到负责连接池的类是<code>ConnectionPoolSettings</code>，那么<code>ConnectionString</code>对象中的连接池属性是如何被传递给<code>ConnectionPoolSettings</code>的呢，我们接着往下看。</p>\n</li>\n<li class=\"lvl-2\">\n<p>参数准备好后就开始创建<code>MongoClient</code>了，其会调用<code>MongoClientFactory</code>的<code>createMongoClient</code>方法，其会对<code>MongoClientSettings</code>对象做进一步的封装，并最终基于封装后的<code>MongoClientSettings</code>对象创建出<code>MongoClient</code>对象</p>\n</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> T <span class=\"title function_\">createMongoClient</span><span class=\"params\">(MongoClientSettings settings)</span> &#123;</span><br><span class=\"line\">    <span class=\"type\">Builder</span> <span class=\"variable\">targetSettings</span> <span class=\"operator\">=</span> MongoClientSettings.builder(settings);</span><br><span class=\"line\">    customize(targetSettings);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"built_in\">this</span>.clientCreator.apply(targetSettings.build(), driverInformation());</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">customize</span><span class=\"params\">(Builder builder)</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (MongoClientSettingsBuilderCustomizer customizer : <span class=\"built_in\">this</span>.builderCustomizers) &#123;</span><br><span class=\"line\">        customizer.customize(builder);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>而在进一步封装<code>MongoClientSettings</code>对象时，会调用系统中所有被spring管理的<code>MongoClientSettingsBuilderCustomizer</code>,实际上也就是<code>StandardMongoClientSettingsBuilderCustomizer</code>的<code>customize</code>方法，其又会调用<code>MongoClientSettings.builder()</code>的<code>applyConnectionSettings</code>方法，而在该方法中调用<code>connectionPoolSettingsBuilder.applyConnectionString(connectionString);</code>就完成了将<code>ConnectionString</code>对象中的连接池属性传递给<code>ConnectionPoolSettings</code>对象的过程，当然，如果属性没有获取到就会使用默认值，所以我们可以基于需要配置相关的属性。</p>\n</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> Builder <span class=\"title function_\">applyConnectionString</span><span class=\"params\">(<span class=\"keyword\">final</span> ConnectionString connectionString)</span> &#123;</span><br><span class=\"line\">    <span class=\"type\">Integer</span> <span class=\"variable\">maxConnectionPoolSize</span> <span class=\"operator\">=</span> connectionString.getMaxConnectionPoolSize();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (maxConnectionPoolSize != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        maxSize(maxConnectionPoolSize);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"type\">Integer</span> <span class=\"variable\">minConnectionPoolSize</span> <span class=\"operator\">=</span> connectionString.getMinConnectionPoolSize();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (minConnectionPoolSize != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        minSize(minConnectionPoolSize);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"type\">Integer</span> <span class=\"variable\">maxWaitTime</span> <span class=\"operator\">=</span> connectionString.getMaxWaitTime();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (maxWaitTime != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        maxWaitTime(maxWaitTime, MILLISECONDS);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"type\">Integer</span> <span class=\"variable\">maxConnectionIdleTime</span> <span class=\"operator\">=</span> connectionString.getMaxConnectionIdleTime();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (maxConnectionIdleTime != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        maxConnectionIdleTime(maxConnectionIdleTime, MILLISECONDS);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"type\">Integer</span> <span class=\"variable\">maxConnectionLifeTime</span> <span class=\"operator\">=</span> connectionString.getMaxConnectionLifeTime();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (maxConnectionLifeTime != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        maxConnectionLifeTime(maxConnectionLifeTime, MILLISECONDS);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"type\">Integer</span> <span class=\"variable\">maxConnecting</span> <span class=\"operator\">=</span> connectionString.getMaxConnecting();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (maxConnecting != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        maxConnecting(maxConnecting);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"built_in\">this</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>大体过程就是这样，很绕，简单点说就是springboot已经为我们提供了mongodb的连接池，我们也可以基于需要，在配置<code>mongodb-uri</code>时，增加相关的连接池参数，springboot就会按照我们配置的参数为我们创建连接池，并自动管理连接池。</p>\n</li>\n</ul>\n<figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">spring:</span></span><br><span class=\"line\">  <span class=\"attr\">data:</span></span><br><span class=\"line\">    <span class=\"attr\">mongodb:</span></span><br><span class=\"line\">      <span class=\"attr\">uri:</span> <span class=\"string\">mongodb://user:password@127.0.0.1:27040,127.0.0.1:27041,127.0.0.1:27042/mytest?authSource=admin&amp;readPreference=primaryPreferred&amp;maxpoolsize=100&amp;minpoolsize=10&amp;maxidletimems=0&amp;maxlifetimems=0&amp;maxconnecting=5&amp;waitqueuetimeoutms=60000</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>参数说明</p>\n</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">maxpoolsize: 100 # 池中允许的最大连接数。一旦池耗尽，任何需要连接的操作都将在阻塞队列中等待直到获取到连接， 默认: 100</span><br><span class=\"line\">minpoolsize: 10 # 池中允许的最小连接数。这些连接在空闲时将保留在池中，并且池将确保它至少包含这个最小数量 默认: 0</span><br><span class=\"line\">maxidletimems: 0 # 池连接的最大空闲时间。零值表示对空闲时间没有限制。超过其空闲时间的池连接将被关闭并在必要时由新连接替换。单位为毫秒</span><br><span class=\"line\">maxlifetimems: 0 # 池连接可以存活的最长时间。零值表示寿命没有限制。超过其生命周期的池连接将被关闭并在必要时由新连接替换。单位为毫秒</span><br><span class=\"line\">maxconnecting: 5 # 同一时刻允许的最大并行连接数。默认值是: 2。</span><br><span class=\"line\">waitqueuetimeoutms: 60000 # 阻塞队列中请求的最大等待时间，超过这个时间的请求将被拒绝。单位为毫秒，默认为: 120s</span><br></pre></td></tr></table></figure>\n<h2 id=\"如何查看连接池是否生效了？\">如何查看连接池是否生效了？</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>很简单，我们只需要注入<code>MongoClient</code>并查看其<code>settings</code>属性，就可以看到连接池的配置信息了`</p>\n</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Autowired</span></span><br><span class=\"line\">MongoClient mongoClient;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 打印连接池配置信息</span></span><br><span class=\"line\">System.out.println(((MongoClientImpl) mongoClient).getSettings().getConnectionPoolSettings());</span><br><span class=\"line\"><span class=\"comment\">// 输出结果</span></span><br><span class=\"line\">ConnectionPoolSettings&#123;maxSize=<span class=\"number\">100</span>, minSize=<span class=\"number\">10</span>, maxWaitTimeMS=<span class=\"number\">60000</span>, maxConnectionLifeTimeMS=<span class=\"number\">0</span>, maxConnectionIdleTimeMS=<span class=\"number\">0</span>, maintenanceInitialDelayMS=<span class=\"number\">0</span>, maintenanceFrequencyMS=<span class=\"number\">60000</span>, connectionPoolListeners=[], maxConnecting=<span class=\"number\">5</span>&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"后记\">后记</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>springboot为什么没有将mongodb的连接池属性也封装到<code>MongoProperties</code>中呢，也许是因为和mongodb相关的链接参数太多了吧，而且我们在配置mongodb时，一般都会使用<code>mongodb-uri</code>的方式，所以springboot就直接将连接池参数放到<code>mongodb-uri</code>中，这样配置起来就比较方便了。</p>\n</li>\n<li class=\"lvl-2\">\n<p>另外我们发现，在<code>MongoClientSettings</code>中除了连接池的配置，还有很多配置项也是基于<code>mongodb-uri</code>的，我们可以基于需要进行配置，如下所示：</p>\n</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">final</span> ReadPreference readPreference;</span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">final</span> WriteConcern writeConcern;</span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"type\">boolean</span> retryWrites;</span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"type\">boolean</span> retryReads;</span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">final</span> ReadConcern readConcern;</span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">final</span> MongoCredential credential;</span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">final</span> TransportSettings transportSettings;</span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">final</span> LoggerSettings loggerSettings;</span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">final</span> ClusterSettings clusterSettings;</span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">final</span> SocketSettings socketSettings;</span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">final</span> SocketSettings heartbeatSocketSettings;</span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">final</span> ConnectionPoolSettings connectionPoolSettings;</span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">final</span> ServerSettings serverSettings;</span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">final</span> SslSettings sslSettings;</span><br></pre></td></tr></table></figure>\n","content_text":"摘要 本文介绍如何使用SpringBoot配置MongoDB7.0的连接池 SpringBoot版本3.2.4，MongoDB版本7.0.6 关于springboot与mongodb的集成可以参考：MongoDB7.0--SpringBoot单集合操作，本文只讨论连接池相关内容。 spring-boot 的 MongoDB 连接池 当我们在springboot的配置文件中配置mongodb的相关属性时，并没有发现和连接池相关的属性，查看MongoProperties中的属性也可以证实这一点，这就很奇怪，按理说springboot应该不会这么弱鸡。 于是我打算看看springboot的源码，看看springboot为我们自动创建的MongoClient到底有没有连接池的配置。 我们就从mongodb的自动配置类MongoAutoConfiguration开始，该类中定义了PropertiesMongoConnectionDetails和MongoClient 123456789101112//这个类主要用于ConnectionString对象的封装，后面会讲到@Bean@ConditionalOnMissingBean(&#123;MongoConnectionDetails.class&#125;)PropertiesMongoConnectionDetails mongoConnectionDetails(MongoProperties properties) &#123; return new PropertiesMongoConnectionDetails(properties);&#125;@Bean@ConditionalOnMissingBean(&#123;MongoClient.class&#125;)public MongoClient mongo(ObjectProvider&lt;MongoClientSettingsBuilderCustomizer&gt; builderCustomizers, MongoClientSettings settings) &#123; return (MongoClient)(new MongoClientFactory(builderCustomizers.orderedStream().toList())).createMongoClient(settings);&#125; 可以看到，创建MongoClient的bean时，依赖两个参数，一个是ObjectProvider&lt;MongoClientSettingsBuilderCustomizer&gt;，一个是MongoClientSettings，前者会将spring上下文中所有类型为MongoClientSettingsBuilderCustomizer的bean封装到该对象中(springboot默认只提供了一个StandardMongoClientSettingsBuilderCustomizer) MongoAutoConfiguration缺省为我们提供了MongoClientSettings和StandardMongoClientSettingsBuilderCustomizer，这两个类都很重要，连接池参数就和它们有关 123456789@BeanMongoClientSettings mongoClientSettings() &#123; return MongoClientSettings.builder().build();&#125;// 需要的参数connectionDetails刚好是上面的PropertiesMongoConnectionDetails@BeanStandardMongoClientSettingsBuilderCustomizer standardMongoSettingsCustomizer(MongoProperties properties, MongoConnectionDetails connectionDetails, ObjectProvider&lt;SslBundles&gt; sslBundles) &#123; return new StandardMongoClientSettingsBuilderCustomizer(connectionDetails.getConnectionString(), properties.getUuidRepresentation(), properties.getSsl(), (SslBundles)sslBundles.getIfAvailable());&#125; 我们先看MongoClientSettings，其中就定义一个连接池的配置对象ConnectionPoolSettings，而ConnectionPoolSettings其内部就定义了连接池的配置属性，MongoClientSettings通过ConnectionPoolSettings的构造器创建出了ConnectionPoolSettings对象，其缺省值如下： 123456private int maxSize = 100;private int minSize;private long maxWaitTimeMS = 1000 * 60 * 2;private long maxConnectionLifeTimeMS;private long maxConnectionIdleTimeMS;private int maxConnecting = 2; 我们看另一个和创建MongoClient相关的bean，这个StandardMongoClientSettingsBuilderCustomizer，创建这个bean时需要一个MongoConnectionDetails对象，并调用其getConnectionString方法，这个对象MongoAutoConfiguration也为我们提供了(上面可以看到) 查看PropertiesMongoConnectionDetails的源码，发现connectionDetails.getConnectionString()的功能就是将MongoProperties的属性封装为uri并传递给ConnectionString的构造器创建对象 12345678910111213141516171819202122232425262728293031323334353637public ConnectionString getConnectionString() &#123; if (this.properties.getUri() != null) &#123; return new ConnectionString(this.properties.getUri()); &#125; else &#123; StringBuilder builder = new StringBuilder(&quot;mongodb://&quot;); if (this.properties.getUsername() != null) &#123; builder.append(this.encode(this.properties.getUsername())); builder.append(&quot;:&quot;); if (this.properties.getPassword() != null) &#123; builder.append(this.encode(this.properties.getPassword())); &#125; builder.append(&quot;@&quot;); &#125; builder.append(this.properties.getHost() != null ? this.properties.getHost() : &quot;localhost&quot;); if (this.properties.getPort() != null) &#123; builder.append(&quot;:&quot;); builder.append(this.properties.getPort()); &#125; if (this.properties.getAdditionalHosts() != null) &#123; builder.append(&quot;,&quot;); builder.append(String.join(&quot;,&quot;, this.properties.getAdditionalHosts())); &#125; builder.append(&quot;/&quot;); builder.append(this.properties.getMongoClientDatabase()); List&lt;String&gt; options = this.getOptions(); if (!options.isEmpty()) &#123; builder.append(&quot;?&quot;); builder.append(String.join(&quot;&amp;&quot;, options)); &#125; // 将MongoProperties转换为uri格式后调用构造器创建ConnectionString return new ConnectionString(builder.toString()); &#125;&#125; 这个ConnectionString对象的初始化过程就很有意思了，其会对这个uri进行解析，解析过程中会调用parseOptions(connectionStringQueryParameters)方法，其会将uri中的参数转换为Map，之后调用translateOptions(combinedOptionsMaps)方法遍历这个map，而在遍历的过程中就会完成对ConnectionString对象的连接池相关属性的初始化 123456789101112131415161718192021222324252627282930313233private void translateOptions(final Map&lt;String, List&lt;String&gt;&gt; optionsMap) &#123; boolean tlsInsecureSet = false; boolean tlsAllowInvalidHostnamesSet = false; for (final String key : GENERAL_OPTIONS_KEYS) &#123; String value = getLastValue(optionsMap, key); if (value == null) &#123; continue; &#125; switch (key) &#123; // 连接池相关属性，注意这里的属性名称，后面我们配置连接池时会用到 case &quot;maxpoolsize&quot;: maxConnectionPoolSize = parseInteger(value, &quot;maxpoolsize&quot;); break; case &quot;minpoolsize&quot;: minConnectionPoolSize = parseInteger(value, &quot;minpoolsize&quot;); break; case &quot;maxidletimems&quot;: maxConnectionIdleTime = parseInteger(value, &quot;maxidletimems&quot;); break; case &quot;maxlifetimems&quot;: maxConnectionLifeTime = parseInteger(value, &quot;maxlifetimems&quot;); break; case &quot;maxconnecting&quot;: maxConnecting = parseInteger(value, &quot;maxConnecting&quot;); break; case &quot;waitqueuetimeoutms&quot;: maxWaitTime = parseInteger(value, &quot;waitqueuetimeoutms&quot;); break; case &quot;connecttimeoutms&quot;: connectTimeout = parseInteger(value, &quot;connecttimeoutms&quot;); break; …………………………………………………………………………………… 其实此时我们就已经知道应该如何配置连接池参数了，就是将连接池相关的参数追加到uri的参数部分，但是前面我们提到负责连接池的类是ConnectionPoolSettings，那么ConnectionString对象中的连接池属性是如何被传递给ConnectionPoolSettings的呢，我们接着往下看。 参数准备好后就开始创建MongoClient了，其会调用MongoClientFactory的createMongoClient方法，其会对MongoClientSettings对象做进一步的封装，并最终基于封装后的MongoClientSettings对象创建出MongoClient对象 12345678910public T createMongoClient(MongoClientSettings settings) &#123; Builder targetSettings = MongoClientSettings.builder(settings); customize(targetSettings); return this.clientCreator.apply(targetSettings.build(), driverInformation());&#125;private void customize(Builder builder) &#123; for (MongoClientSettingsBuilderCustomizer customizer : this.builderCustomizers) &#123; customizer.customize(builder); &#125;&#125; 而在进一步封装MongoClientSettings对象时，会调用系统中所有被spring管理的MongoClientSettingsBuilderCustomizer,实际上也就是StandardMongoClientSettingsBuilderCustomizer的customize方法，其又会调用MongoClientSettings.builder()的applyConnectionSettings方法，而在该方法中调用connectionPoolSettingsBuilder.applyConnectionString(connectionString);就完成了将ConnectionString对象中的连接池属性传递给ConnectionPoolSettings对象的过程，当然，如果属性没有获取到就会使用默认值，所以我们可以基于需要配置相关的属性。 123456789101112131415161718192021222324252627282930313233public Builder applyConnectionString(final ConnectionString connectionString) &#123; Integer maxConnectionPoolSize = connectionString.getMaxConnectionPoolSize(); if (maxConnectionPoolSize != null) &#123; maxSize(maxConnectionPoolSize); &#125; Integer minConnectionPoolSize = connectionString.getMinConnectionPoolSize(); if (minConnectionPoolSize != null) &#123; minSize(minConnectionPoolSize); &#125; Integer maxWaitTime = connectionString.getMaxWaitTime(); if (maxWaitTime != null) &#123; maxWaitTime(maxWaitTime, MILLISECONDS); &#125; Integer maxConnectionIdleTime = connectionString.getMaxConnectionIdleTime(); if (maxConnectionIdleTime != null) &#123; maxConnectionIdleTime(maxConnectionIdleTime, MILLISECONDS); &#125; Integer maxConnectionLifeTime = connectionString.getMaxConnectionLifeTime(); if (maxConnectionLifeTime != null) &#123; maxConnectionLifeTime(maxConnectionLifeTime, MILLISECONDS); &#125; Integer maxConnecting = connectionString.getMaxConnecting(); if (maxConnecting != null) &#123; maxConnecting(maxConnecting); &#125; return this;&#125; 大体过程就是这样，很绕，简单点说就是springboot已经为我们提供了mongodb的连接池，我们也可以基于需要，在配置mongodb-uri时，增加相关的连接池参数，springboot就会按照我们配置的参数为我们创建连接池，并自动管理连接池。 12345spring: data: mongodb: uri: mongodb://user:password@127.0.0.1:27040,127.0.0.1:27041,127.0.0.1:27042/mytest?authSource=admin&amp;readPreference=primaryPreferred&amp;maxpoolsize=100&amp;minpoolsize=10&amp;maxidletimems=0&amp;maxlifetimems=0&amp;maxconnecting=5&amp;waitqueuetimeoutms=60000 参数说明 123456maxpoolsize: 100 # 池中允许的最大连接数。一旦池耗尽，任何需要连接的操作都将在阻塞队列中等待直到获取到连接， 默认: 100minpoolsize: 10 # 池中允许的最小连接数。这些连接在空闲时将保留在池中，并且池将确保它至少包含这个最小数量 默认: 0maxidletimems: 0 # 池连接的最大空闲时间。零值表示对空闲时间没有限制。超过其空闲时间的池连接将被关闭并在必要时由新连接替换。单位为毫秒maxlifetimems: 0 # 池连接可以存活的最长时间。零值表示寿命没有限制。超过其生命周期的池连接将被关闭并在必要时由新连接替换。单位为毫秒maxconnecting: 5 # 同一时刻允许的最大并行连接数。默认值是: 2。waitqueuetimeoutms: 60000 # 阻塞队列中请求的最大等待时间，超过这个时间的请求将被拒绝。单位为毫秒，默认为: 120s 如何查看连接池是否生效了？ 很简单，我们只需要注入MongoClient并查看其settings属性，就可以看到连接池的配置信息了` 1234567@AutowiredMongoClient mongoClient;// 打印连接池配置信息System.out.println(((MongoClientImpl) mongoClient).getSettings().getConnectionPoolSettings());// 输出结果ConnectionPoolSettings&#123;maxSize=100, minSize=10, maxWaitTimeMS=60000, maxConnectionLifeTimeMS=0, maxConnectionIdleTimeMS=0, maintenanceInitialDelayMS=0, maintenanceFrequencyMS=60000, connectionPoolListeners=[], maxConnecting=5&#125; 后记 springboot为什么没有将mongodb的连接池属性也封装到MongoProperties中呢，也许是因为和mongodb相关的链接参数太多了吧，而且我们在配置mongodb时，一般都会使用mongodb-uri的方式，所以springboot就直接将连接池参数放到mongodb-uri中，这样配置起来就比较方便了。 另外我们发现，在MongoClientSettings中除了连接池的配置，还有很多配置项也是基于mongodb-uri的，我们可以基于需要进行配置，如下所示： 1234567891011121314private final ReadPreference readPreference;private final WriteConcern writeConcern;private final boolean retryWrites;private final boolean retryReads;private final ReadConcern readConcern;private final MongoCredential credential;private final TransportSettings transportSettings;private final LoggerSettings loggerSettings;private final ClusterSettings clusterSettings;private final SocketSettings socketSettings;private final SocketSettings heartbeatSocketSettings;private final ConnectionPoolSettings connectionPoolSettings;private final ServerSettings serverSettings;private final SslSettings sslSettings;","summary":"摘要 本文介绍如何使用SpringBoot配置MongoDB7.0的连接池 SpringBoot版本3.2.4，MongoDB版本7.0.6 关于springboot与mongodb的集成可以参考：MongoDB7.0--SpringBoot单集合操作，本文只讨论连接池相关内容。","date_published":"2024-04-08T13:30:05.000Z","tags":["技术","linux","mongodb","mongodb"]},{"id":"https://blog.hanqunfeng.com/2024/04/07/mongodb7-others/","url":"https://blog.hanqunfeng.com/2024/04/07/mongodb7-others/","title":"MongoDB7.0一些有用的功能","content_html":"<!--\n **加粗**\n *斜体*\n ***加粗并斜体***\n ~~删除线~~\n ==突出显示==\n `突出显示(推荐)`\n ++下划线++\n ~下标~\n ^上标^\n 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.\n 图片设置宽度和高度(通过uPic上传后，需要将upic修改过为blog，用于添加水印) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)\n\n +++ **点击折叠**\n 这是被隐藏的内容\n +++\n\n::: tips success warning danger\n这里是容器内的内容\n:::\n\n% note info % success warning danger\n这里是容器内的内容\n% endnote %\n\n引用本地其它文章连接{}\n 大括号开始% post_link 文件名称(不包含.md) %大括号结束\n -->\n<h2 id=\"摘要\">摘要</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>本文介绍MongoDB7.0的一些有用的功能，比如运行js，查看慢查询日志等等</p>\n</li>\n<li class=\"lvl-2\">\n<p>MongoDB<a href=\"https://www.mongodb.com/docs/v7.0/\">官方文档</a></p>\n</li>\n<li class=\"lvl-2\">\n<p>本文基于<code>CentOS8(x86_64)</code></p>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"运行js\">运行js</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>运行js文件</p>\n</li>\n</ul>\n<blockquote>\n<p>insertMany.js</p>\n</blockquote>\n  <figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> tags = [<span class=\"string\">&#x27;nosql&#x27;</span>, <span class=\"string\">&#x27;mongodb&#x27;</span>, <span class=\"string\">&#x27;document&#x27;</span>, <span class=\"string\">&#x27;developer&#x27;</span>, <span class=\"string\">&#x27;popular&#x27;</span>]</span><br><span class=\"line\"><span class=\"keyword\">var</span> types = [<span class=\"string\">&#x27;technology&#x27;</span>, <span class=\"string\">&#x27;sociality&#x27;</span>, <span class=\"string\">&#x27;travel&#x27;</span>, <span class=\"string\">&#x27;novel&#x27;</span>, <span class=\"string\">&#x27;literature&#x27;</span>]</span><br><span class=\"line\"><span class=\"keyword\">var</span> books = []</span><br><span class=\"line\"><span class=\"keyword\">for</span> (<span class=\"keyword\">var</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">50</span>; i++) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> typeIdx = <span class=\"title class_\">Math</span>.<span class=\"title function_\">floor</span>(<span class=\"title class_\">Math</span>.<span class=\"title function_\">random</span>() * types.<span class=\"property\">length</span>)</span><br><span class=\"line\">  <span class=\"keyword\">var</span> tagIdx = <span class=\"title class_\">Math</span>.<span class=\"title function_\">floor</span>(<span class=\"title class_\">Math</span>.<span class=\"title function_\">random</span>() * tags.<span class=\"property\">length</span>)</span><br><span class=\"line\">  <span class=\"keyword\">var</span> favCount = <span class=\"title class_\">Math</span>.<span class=\"title function_\">floor</span>(<span class=\"title class_\">Math</span>.<span class=\"title function_\">random</span>() * <span class=\"number\">100</span>)</span><br><span class=\"line\">  <span class=\"keyword\">var</span> book = &#123;</span><br><span class=\"line\">    <span class=\"attr\">title</span>: <span class=\"string\">&#x27;book-&#x27;</span> + i,</span><br><span class=\"line\">    <span class=\"attr\">type</span>: types[typeIdx],</span><br><span class=\"line\">    <span class=\"attr\">tag</span>: tags[tagIdx],</span><br><span class=\"line\">    <span class=\"attr\">favCount</span>: favCount,</span><br><span class=\"line\">    <span class=\"attr\">author</span>: <span class=\"string\">&#x27;xxx&#x27;</span> + i</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  books.<span class=\"title function_\">push</span>(book)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">db.<span class=\"property\">books</span>.<span class=\"title function_\">insertMany</span>(books)</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># -f 运行js文件</span></span><br><span class=\"line\">mongosh <span class=\"string\">&quot;mongodb://user:password@10.1.2.26:27017,10.1.2.142:27017,10.1.2.41:27017/test?authSource=admin&amp;replicaSet=rs0&quot;</span> -f insertMany.js</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>运行js语句</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ---eval 运行js语句</span></span><br><span class=\"line\">mongosh <span class=\"string\">&quot;mongodb://user:password@10.1.2.26:27017,10.1.2.142:27017,10.1.2.41:27017/test?authSource=admin&amp;replicaSet=rs0&quot;</span> --<span class=\"built_in\">eval</span> <span class=\"string\">&quot;db.books.find().limit(2)&quot;</span></span><br><span class=\"line\">[</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    _id: ObjectId(<span class=\"string\">&#x27;660d0b05a8a6c09b0b1852b7&#x27;</span>),</span><br><span class=\"line\">    title: <span class=\"string\">&#x27;book-0&#x27;</span>,</span><br><span class=\"line\">    <span class=\"built_in\">type</span>: <span class=\"string\">&#x27;novel&#x27;</span>,</span><br><span class=\"line\">    tag: <span class=\"string\">&#x27;document&#x27;</span>,</span><br><span class=\"line\">    favCount: 58,</span><br><span class=\"line\">    author: <span class=\"string\">&#x27;xxx0&#x27;</span></span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    _id: ObjectId(<span class=\"string\">&#x27;660d0b05a8a6c09b0b1852b8&#x27;</span>),</span><br><span class=\"line\">    title: <span class=\"string\">&#x27;book-1&#x27;</span>,</span><br><span class=\"line\">    <span class=\"built_in\">type</span>: <span class=\"string\">&#x27;novel&#x27;</span>,</span><br><span class=\"line\">    tag: <span class=\"string\">&#x27;popular&#x27;</span>,</span><br><span class=\"line\">    favCount: 10,</span><br><span class=\"line\">    author: <span class=\"string\">&#x27;xxx1&#x27;</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">]</span><br></pre></td></tr></table></figure>\n<h2 id=\"Profiler模块\">Profiler模块</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Profiler模块可以用来记录、分析MongoDB的详细操作日志，默认情况下该功能是关闭的。</p>\n</li>\n<li class=\"lvl-2\">\n<p>Profiler模块开启对于每个业务库来说是独立的，对某个业务库开启Profiler模块之后，符合条件的慢操作日志会被写入该库的<code>system.profile</code>集合中。</p>\n</li>\n<li class=\"lvl-2\">\n<p>Profiler模块的调试级别有：</p>\n</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0：关闭Profiler模块；</span><br><span class=\"line\">1：部分开启，仅符合条件（时长大于slowms）的操作日志会被记录；</span><br><span class=\"line\">2：日志全开，所有的操作日志都被记录；</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>设置Profiler模块的调试级别：</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 设置Profiler模块的调试级别为2</span></span><br><span class=\"line\">&gt; db.setProfilingLevel(2)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看当的调试级别信息</span></span><br><span class=\"line\">&gt; db.<span class=\"function\"><span class=\"title\">getProfilingStatus</span></span>()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  was: 2,  <span class=\"comment\"># 当前的调试级别</span></span><br><span class=\"line\">  slowms: 100, <span class=\"comment\"># 慢查询的阈值，单位是毫秒；</span></span><br><span class=\"line\">  sampleRate: 1.0, <span class=\"comment\"># 日志随机采样率，1.0则表示满足条件的全部输出。</span></span><br><span class=\"line\">  ok: 1,   <span class=\"comment\"># 状态</span></span><br><span class=\"line\">  <span class=\"string\">&#x27;$clusterTime&#x27;</span>: &#123; <span class=\"comment\"># 时间戳</span></span><br><span class=\"line\">    clusterTime: Timestamp(&#123; t: 1712471779, i: 1 &#125;), <span class=\"comment\"># 时间戳</span></span><br><span class=\"line\">    signature: &#123; <span class=\"comment\"># 签名</span></span><br><span class=\"line\">      <span class=\"built_in\">hash</span>: Binary.createFromBase64(<span class=\"string\">&#x27;GGCAjzJrW8arhfJX0Cn0VpvC5MA=&#x27;</span>, 0), <span class=\"comment\"># 签名</span></span><br><span class=\"line\">      keyId: Long(<span class=\"string\">&#x27;7346062378896719877&#x27;</span>)  <span class=\"comment\"># 签名</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  operationTime: Timestamp(&#123; t: 1712471779, i: 1 &#125;) <span class=\"comment\"># 操作时间</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 只记录时长超过500ms的操作</span></span><br><span class=\"line\">&gt; db.setProfilingLevel(1,500)</span><br><span class=\"line\"><span class=\"comment\"># 同时加上采样率</span></span><br><span class=\"line\">&gt; db.setProfilingLevel(1,&#123;slowms:500,sampleRate:0.5&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 关闭Profiler模块</span></span><br><span class=\"line\">&gt; db.setProfilingLevel(2)</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>查看日志</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看操作日志</span></span><br><span class=\"line\">&gt; db.system.profile.find().<span class=\"built_in\">limit</span>(5).<span class=\"built_in\">sort</span>(&#123;ts:-1&#125;).pretty()</span><br><span class=\"line\">[</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    op: <span class=\"string\">&#x27;query&#x27;</span>, <span class=\"comment\"># 操作类型,比如查询,更新,删除等</span></span><br><span class=\"line\">    ns: <span class=\"string\">&#x27;admin.system.profile&#x27;</span>, <span class=\"comment\"># 操作的集合</span></span><br><span class=\"line\">    <span class=\"built_in\">command</span>: &#123; <span class=\"comment\"># 操作的命令</span></span><br><span class=\"line\">      find: <span class=\"string\">&#x27;system.profile&#x27;</span>, <span class=\"comment\"># 操作的集合</span></span><br><span class=\"line\">      filter: &#123;&#125;, <span class=\"comment\"># 查询条件</span></span><br><span class=\"line\">      lsid: &#123; <span class=\"built_in\">id</span>: UUID(<span class=\"string\">&#x27;2285d6a5-b2df-4b46-b9d2-5e556b0a7c7d&#x27;</span>) &#125;, <span class=\"comment\"># 会话id</span></span><br><span class=\"line\">      <span class=\"string\">&#x27;$clusterTime&#x27;</span>: &#123; <span class=\"comment\"># 时间戳</span></span><br><span class=\"line\">        clusterTime: Timestamp(&#123; t: 1712471018, i: 1 &#125;),</span><br><span class=\"line\">        signature: &#123;</span><br><span class=\"line\">          <span class=\"built_in\">hash</span>: Binary.createFromBase64(<span class=\"string\">&#x27;8YEsN+XUWO6EkoHEegKkG49eWPA=&#x27;</span>, 0),</span><br><span class=\"line\">          keyId: Long(<span class=\"string\">&#x27;7346062378896719877&#x27;</span>)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      <span class=\"string\">&#x27;$db&#x27;</span>: <span class=\"string\">&#x27;admin&#x27;</span>, <span class=\"comment\"># 数据库</span></span><br><span class=\"line\">      <span class=\"string\">&#x27;$readPreference&#x27;</span>: &#123; mode: <span class=\"string\">&#x27;primaryPreferred&#x27;</span> &#125; <span class=\"comment\"># 读偏好</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    keysExamined: 0, <span class=\"comment\"># 扫描索引条目数，如果比nreturned大出很多，则说明查询效率不高。</span></span><br><span class=\"line\">    docsExamined: 3, <span class=\"comment\"># 扫描文档条目数，如果比nreturned大出很多，则说明查询效率不高。</span></span><br><span class=\"line\">    nBatches: 1, <span class=\"comment\"># 批处理数量</span></span><br><span class=\"line\">    cursorExhausted: <span class=\"literal\">true</span>, <span class=\"comment\"># 是否游标已耗尽</span></span><br><span class=\"line\">    numYield: 0, <span class=\"comment\"># 操作数，大于0表示等待锁或者是磁盘I/O操作</span></span><br><span class=\"line\">    nreturned: 3, <span class=\"comment\"># 返回的文档数量</span></span><br><span class=\"line\">    queryHash: <span class=\"string\">&#x27;8880B5AF&#x27;</span>, <span class=\"comment\"># 查询哈希值</span></span><br><span class=\"line\">    planCacheKey: <span class=\"string\">&#x27;8880B5AF&#x27;</span>,</span><br><span class=\"line\">    queryFramework: <span class=\"string\">&#x27;classic&#x27;</span>,</span><br><span class=\"line\">    locks: &#123;       <span class=\"comment\"># 锁占用的情况。</span></span><br><span class=\"line\">      FeatureCompatibilityVersion: &#123; acquireCount: &#123; r: Long(<span class=\"string\">&#x27;1&#x27;</span>) &#125; &#125;,</span><br><span class=\"line\">      Global: &#123; acquireCount: &#123; r: Long(<span class=\"string\">&#x27;1&#x27;</span>) &#125; &#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    flowControl: &#123;&#125;,</span><br><span class=\"line\">    readConcern: &#123; level: <span class=\"string\">&#x27;local&#x27;</span>, provenance: <span class=\"string\">&#x27;implicitDefault&#x27;</span> &#125;, <span class=\"comment\"># 读关注</span></span><br><span class=\"line\">    responseLength: 3414, <span class=\"comment\"># 响应数据大小（字节数），一次性查询太多的数据会影响性能，可以使用limit、batchSize进行一些限制。</span></span><br><span class=\"line\">    protocol: <span class=\"string\">&#x27;op_msg&#x27;</span>, <span class=\"comment\"># 协议类型，op_msg是mongodb 4.0+的协议，op_query是mongodb 3.2及以前版本的协议。</span></span><br><span class=\"line\">    millis: 0, <span class=\"comment\"># 命令执行的时长，单位是毫秒。</span></span><br><span class=\"line\">    planSummary: <span class=\"string\">&#x27;COLLSCAN&#x27;</span>, <span class=\"comment\"># 查询计划的概要，如IXSCAN表示使用了索引扫描。</span></span><br><span class=\"line\">    planningTimeMicros: 79,</span><br><span class=\"line\">    execStats: &#123;  <span class=\"comment\"># 执行过程统计信息。</span></span><br><span class=\"line\">      stage: <span class=\"string\">&#x27;COLLSCAN&#x27;</span>,</span><br><span class=\"line\">      nReturned: 3,</span><br><span class=\"line\">      executionTimeMillisEstimate: 0,</span><br><span class=\"line\">      works: 4,</span><br><span class=\"line\">      advanced: 3,</span><br><span class=\"line\">      needTime: 0,</span><br><span class=\"line\">      needYield: 0,</span><br><span class=\"line\">      saveState: 0,</span><br><span class=\"line\">      restoreState: 0,</span><br><span class=\"line\">      isEOF: 1,</span><br><span class=\"line\">      direction: <span class=\"string\">&#x27;forward&#x27;</span>,</span><br><span class=\"line\">      docsExamined: 3</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    ts: ISODate(<span class=\"string\">&#x27;2024-04-07T06:23:56.054Z&#x27;</span>), <span class=\"comment\"># 命令执行的时间点。</span></span><br><span class=\"line\">    client: <span class=\"string\">&#x27;127.0.0.1&#x27;</span>, <span class=\"comment\"># 客户端地址。</span></span><br><span class=\"line\">    appName: <span class=\"string\">&#x27;mongosh 2.1.5&#x27;</span>, <span class=\"comment\"># 客户端名称。</span></span><br><span class=\"line\">    allUsers: [ &#123; user: <span class=\"string\">&#x27;user&#x27;</span>, db: <span class=\"string\">&#x27;admin&#x27;</span> &#125; ], <span class=\"comment\"># 所有用户信息。</span></span><br><span class=\"line\">    user: <span class=\"string\">&#x27;user@admin&#x27;</span> <span class=\"comment\"># 当前用户信息。</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">………………………………</span><br><span class=\"line\">]</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看执行时长最大的10条操作记录</span></span><br><span class=\"line\">&gt; db.system.profile.find().<span class=\"built_in\">limit</span>(10).<span class=\"built_in\">sort</span>(&#123;millis:-1&#125;).pretty()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看某个集合中的update操作日志</span></span><br><span class=\"line\">&gt; db.system.profile.find(&#123;op:<span class=\"string\">&quot;update&quot;</span>,ns:<span class=\"string\">&quot;shop.user&quot;</span>&#125;)</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><code>system.profile</code>是一个1MB的固定大小的集合，随着记录日志的增多，一些旧的记录会被滚动删除。</p>\n</li>\n<li class=\"lvl-2\">\n<p>Profiler模块的设置是内存级的，重启服务器后会自动恢复默认状态。</p>\n</li>\n</ul>\n<h2 id=\"db-currentOp\">db.currentOp()</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Profiler模块所记录的日志都是已经发生的事情，<code>db.currentOp()</code>命令则与此相反，它可以用来查看数据库当前正在执行的一些操作。</p>\n</li>\n<li class=\"lvl-2\">\n<p>db.currentOp()读取的是当前数据库的命令快照，该命令可以返回许多有用的信息，比如：</p>\n</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">操作的运行时长，快速发现耗时漫长的低效扫描操作。</span><br><span class=\"line\">执行计划信息，用于判断是否命中了索引，或者存在锁冲突的情况。</span><br><span class=\"line\">操作ID、时间、客户端等信息，方便定位出产生慢操作的源头</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; db.<span class=\"function\"><span class=\"title\">currentOp</span></span>()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">inprog: [ <span class=\"comment\"># 当前正在执行的操作</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">      <span class=\"built_in\">type</span>: <span class=\"string\">&#x27;op&#x27;</span>, <span class=\"comment\"># 操作类型，可以是op、idleSession、idleCursor的一种，一般的操作信息以op表示。其为MongoDB 4.2版本新增功能</span></span><br><span class=\"line\">      host: <span class=\"string\">&#x27;localhost:27041&#x27;</span>, <span class=\"comment\"># 操作所在的主机</span></span><br><span class=\"line\">      desc: <span class=\"string\">&#x27;conn474&#x27;</span>, <span class=\"comment\"># 操作的描述信息</span></span><br><span class=\"line\">      connectionId: 474, <span class=\"comment\"># 操作的连接ID</span></span><br><span class=\"line\">      client: <span class=\"string\">&#x27;127.0.0.1:58103&#x27;</span>, <span class=\"comment\"># 操作的客户端信息</span></span><br><span class=\"line\">      appName: <span class=\"string\">&#x27;mongosh 2.1.5&#x27;</span>, <span class=\"comment\"># 操作的客户端应用信息</span></span><br><span class=\"line\">      clientMetadata: &#123; <span class=\"comment\"># 关于客户端的附加信息，可以包含驱动的版本。</span></span><br><span class=\"line\">        application: &#123; name: <span class=\"string\">&#x27;mongosh 2.1.5&#x27;</span> &#125;,</span><br><span class=\"line\">        driver: &#123; name: <span class=\"string\">&#x27;nodejs|mongosh&#x27;</span>, version: <span class=\"string\">&#x27;6.3.0|2.1.5&#x27;</span> &#125;,</span><br><span class=\"line\">        platform: <span class=\"string\">&#x27;Node.js v20.11.1, LE&#x27;</span>,</span><br><span class=\"line\">        os: &#123;</span><br><span class=\"line\">          name: <span class=\"string\">&#x27;darwin&#x27;</span>,</span><br><span class=\"line\">          architecture: <span class=\"string\">&#x27;x64&#x27;</span>,</span><br><span class=\"line\">          version: <span class=\"string\">&#x27;22.6.0&#x27;</span>,</span><br><span class=\"line\">          <span class=\"built_in\">type</span>: <span class=\"string\">&#x27;Darwin&#x27;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      active: <span class=\"literal\">true</span>, <span class=\"comment\"># 操作是否活跃。如果是空闲状态则为false</span></span><br><span class=\"line\">      currentOpTime: <span class=\"string\">&#x27;2024-04-07T14:54:02.994+08:00&#x27;</span>, <span class=\"comment\"># 操作的开始时间。MongoDB 3.6版本新增功能</span></span><br><span class=\"line\">      threaded: <span class=\"literal\">true</span>,</span><br><span class=\"line\">      opid: 236247, <span class=\"comment\"># opid：当前操作在数据库进程中的唯一编号,如果已经发现该操作正在导致数据库系统响应缓慢，则可以考虑将其“杀”死 : db.killOp(236247)</span></span><br><span class=\"line\">      secs_running: Long(<span class=\"string\">&#x27;3&#x27;</span>), <span class=\"comment\"># 操作持续时间,单位：秒</span></span><br><span class=\"line\">      microsecs_running: Long(<span class=\"string\">&#x27;3362378&#x27;</span>), <span class=\"comment\"># 操作持续时间，单位：微秒</span></span><br><span class=\"line\">      op: <span class=\"string\">&#x27;command&#x27;</span>, <span class=\"comment\"># 标识操作类型的字符串，如 command, insert, query, update, delete, getMore, killCursors</span></span><br><span class=\"line\">      ns: <span class=\"string\">&#x27;admin.$cmd&#x27;</span>, <span class=\"comment\"># 操作的命名空间，格式为 db.collection</span></span><br><span class=\"line\">      redacted: <span class=\"literal\">false</span>, <span class=\"comment\"># 是否已脱敏</span></span><br><span class=\"line\">      <span class=\"built_in\">command</span>: &#123; <span class=\"comment\"># 操作命令参数</span></span><br><span class=\"line\">        hello: 1,</span><br><span class=\"line\">        maxAwaitTimeMS: 10000,</span><br><span class=\"line\">        topologyVersion: &#123;</span><br><span class=\"line\">          processId: ObjectId(<span class=\"string\">&#x27;6611f8cd59f7cfaa5c8cd7e4&#x27;</span>),</span><br><span class=\"line\">          counter: Long(<span class=\"string\">&#x27;18&#x27;</span>)</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&#x27;$clusterTime&#x27;</span>: &#123;</span><br><span class=\"line\">          clusterTime: Timestamp(&#123; t: 1712470998, i: 1 &#125;),</span><br><span class=\"line\">          signature: &#123;</span><br><span class=\"line\">            <span class=\"built_in\">hash</span>: Binary.createFromBase64(<span class=\"string\">&#x27;gvgo03Wqi1AuOVqnrlhzKIK2NAU=&#x27;</span>, 0),</span><br><span class=\"line\">            keyId: Long(<span class=\"string\">&#x27;7346062378896719877&#x27;</span>)</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&#x27;$db&#x27;</span>: <span class=\"string\">&#x27;admin&#x27;</span></span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      numYields: 0,</span><br><span class=\"line\">      locks: &#123;&#125;, <span class=\"comment\"># 当前操作持有锁的类型和模式。</span></span><br><span class=\"line\">      waitingForLock: <span class=\"literal\">false</span>, <span class=\"comment\"># 是否在等待锁</span></span><br><span class=\"line\">      lockStats: &#123;&#125;, <span class=\"comment\"># 当前操作持有锁的统计。</span></span><br><span class=\"line\">      waitingForFlowControl: <span class=\"literal\">false</span>,</span><br><span class=\"line\">      flowControlStats: &#123;&#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">………………………………</span><br><span class=\"line\">]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看等待锁的增加、删除、修改、查询操作</span></span><br><span class=\"line\">&gt; db.currentOp(&#123;</span><br><span class=\"line\"> waitingForLock:<span class=\"literal\">true</span>,</span><br><span class=\"line\"> <span class=\"variable\">$or</span>:[</span><br><span class=\"line\">  &#123;op:&#123;<span class=\"variable\">$in</span>:[<span class=\"string\">&quot;insert&quot;</span>,<span class=\"string\">&quot;update&quot;</span>,<span class=\"string\">&quot;remove&quot;</span>]&#125;&#125;,</span><br><span class=\"line\">  &#123;<span class=\"string\">&quot;query.findandmodify&quot;</span>:&#123;<span class=\"variable\">$exists</span>:<span class=\"literal\">true</span>&#125;&#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\"> &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看执行时间超过1s的操作</span></span><br><span class=\"line\">&gt; db.currentOp(&#123;</span><br><span class=\"line\">   secs_running:&#123;<span class=\"variable\">$gt</span>:1&#125;</span><br><span class=\"line\"> &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看test数据库中的操作</span></span><br><span class=\"line\">&gt; db.currentOp(&#123;</span><br><span class=\"line\">   ns:/test/</span><br><span class=\"line\"> &#125;)</span><br></pre></td></tr></table></figure>","content_text":"摘要 本文介绍MongoDB7.0的一些有用的功能，比如运行js，查看慢查询日志等等 MongoDB官方文档 本文基于CentOS8(x86_64) 运行js 运行js文件 insertMany.js 1234567891011121314151617var tags = [&#x27;nosql&#x27;, &#x27;mongodb&#x27;, &#x27;document&#x27;, &#x27;developer&#x27;, &#x27;popular&#x27;]var types = [&#x27;technology&#x27;, &#x27;sociality&#x27;, &#x27;travel&#x27;, &#x27;novel&#x27;, &#x27;literature&#x27;]var books = []for (var i = 0; i &lt; 50; i++) &#123; var typeIdx = Math.floor(Math.random() * types.length) var tagIdx = Math.floor(Math.random() * tags.length) var favCount = Math.floor(Math.random() * 100) var book = &#123; title: &#x27;book-&#x27; + i, type: types[typeIdx], tag: tags[tagIdx], favCount: favCount, author: &#x27;xxx&#x27; + i &#125; books.push(book)&#125;db.books.insertMany(books) 12# -f 运行js文件mongosh &quot;mongodb://user:password@10.1.2.26:27017,10.1.2.142:27017,10.1.2.41:27017/test?authSource=admin&amp;replicaSet=rs0&quot; -f insertMany.js 运行js语句 1234567891011121314151617181920# ---eval 运行js语句mongosh &quot;mongodb://user:password@10.1.2.26:27017,10.1.2.142:27017,10.1.2.41:27017/test?authSource=admin&amp;replicaSet=rs0&quot; --eval &quot;db.books.find().limit(2)&quot;[ &#123; _id: ObjectId(&#x27;660d0b05a8a6c09b0b1852b7&#x27;), title: &#x27;book-0&#x27;, type: &#x27;novel&#x27;, tag: &#x27;document&#x27;, favCount: 58, author: &#x27;xxx0&#x27; &#125;, &#123; _id: ObjectId(&#x27;660d0b05a8a6c09b0b1852b8&#x27;), title: &#x27;book-1&#x27;, type: &#x27;novel&#x27;, tag: &#x27;popular&#x27;, favCount: 10, author: &#x27;xxx1&#x27; &#125;] Profiler模块 Profiler模块可以用来记录、分析MongoDB的详细操作日志，默认情况下该功能是关闭的。 Profiler模块开启对于每个业务库来说是独立的，对某个业务库开启Profiler模块之后，符合条件的慢操作日志会被写入该库的system.profile集合中。 Profiler模块的调试级别有： 1230：关闭Profiler模块；1：部分开启，仅符合条件（时长大于slowms）的操作日志会被记录；2：日志全开，所有的操作日志都被记录； 设置Profiler模块的调试级别： 123456789101112131415161718192021222324252627# 设置Profiler模块的调试级别为2&gt; db.setProfilingLevel(2)# 查看当的调试级别信息&gt; db.getProfilingStatus()&#123; was: 2, # 当前的调试级别 slowms: 100, # 慢查询的阈值，单位是毫秒； sampleRate: 1.0, # 日志随机采样率，1.0则表示满足条件的全部输出。 ok: 1, # 状态 &#x27;$clusterTime&#x27;: &#123; # 时间戳 clusterTime: Timestamp(&#123; t: 1712471779, i: 1 &#125;), # 时间戳 signature: &#123; # 签名 hash: Binary.createFromBase64(&#x27;GGCAjzJrW8arhfJX0Cn0VpvC5MA=&#x27;, 0), # 签名 keyId: Long(&#x27;7346062378896719877&#x27;) # 签名 &#125; &#125;, operationTime: Timestamp(&#123; t: 1712471779, i: 1 &#125;) # 操作时间&#125;# 只记录时长超过500ms的操作&gt; db.setProfilingLevel(1,500)# 同时加上采样率&gt; db.setProfilingLevel(1,&#123;slowms:500,sampleRate:0.5&#125;)# 关闭Profiler模块&gt; db.setProfilingLevel(2) 查看日志 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869# 查看操作日志&gt; db.system.profile.find().limit(5).sort(&#123;ts:-1&#125;).pretty()[ &#123; op: &#x27;query&#x27;, # 操作类型,比如查询,更新,删除等 ns: &#x27;admin.system.profile&#x27;, # 操作的集合 command: &#123; # 操作的命令 find: &#x27;system.profile&#x27;, # 操作的集合 filter: &#123;&#125;, # 查询条件 lsid: &#123; id: UUID(&#x27;2285d6a5-b2df-4b46-b9d2-5e556b0a7c7d&#x27;) &#125;, # 会话id &#x27;$clusterTime&#x27;: &#123; # 时间戳 clusterTime: Timestamp(&#123; t: 1712471018, i: 1 &#125;), signature: &#123; hash: Binary.createFromBase64(&#x27;8YEsN+XUWO6EkoHEegKkG49eWPA=&#x27;, 0), keyId: Long(&#x27;7346062378896719877&#x27;) &#125; &#125;, &#x27;$db&#x27;: &#x27;admin&#x27;, # 数据库 &#x27;$readPreference&#x27;: &#123; mode: &#x27;primaryPreferred&#x27; &#125; # 读偏好 &#125;, keysExamined: 0, # 扫描索引条目数，如果比nreturned大出很多，则说明查询效率不高。 docsExamined: 3, # 扫描文档条目数，如果比nreturned大出很多，则说明查询效率不高。 nBatches: 1, # 批处理数量 cursorExhausted: true, # 是否游标已耗尽 numYield: 0, # 操作数，大于0表示等待锁或者是磁盘I/O操作 nreturned: 3, # 返回的文档数量 queryHash: &#x27;8880B5AF&#x27;, # 查询哈希值 planCacheKey: &#x27;8880B5AF&#x27;, queryFramework: &#x27;classic&#x27;, locks: &#123; # 锁占用的情况。 FeatureCompatibilityVersion: &#123; acquireCount: &#123; r: Long(&#x27;1&#x27;) &#125; &#125;, Global: &#123; acquireCount: &#123; r: Long(&#x27;1&#x27;) &#125; &#125; &#125;, flowControl: &#123;&#125;, readConcern: &#123; level: &#x27;local&#x27;, provenance: &#x27;implicitDefault&#x27; &#125;, # 读关注 responseLength: 3414, # 响应数据大小（字节数），一次性查询太多的数据会影响性能，可以使用limit、batchSize进行一些限制。 protocol: &#x27;op_msg&#x27;, # 协议类型，op_msg是mongodb 4.0+的协议，op_query是mongodb 3.2及以前版本的协议。 millis: 0, # 命令执行的时长，单位是毫秒。 planSummary: &#x27;COLLSCAN&#x27;, # 查询计划的概要，如IXSCAN表示使用了索引扫描。 planningTimeMicros: 79, execStats: &#123; # 执行过程统计信息。 stage: &#x27;COLLSCAN&#x27;, nReturned: 3, executionTimeMillisEstimate: 0, works: 4, advanced: 3, needTime: 0, needYield: 0, saveState: 0, restoreState: 0, isEOF: 1, direction: &#x27;forward&#x27;, docsExamined: 3 &#125;, ts: ISODate(&#x27;2024-04-07T06:23:56.054Z&#x27;), # 命令执行的时间点。 client: &#x27;127.0.0.1&#x27;, # 客户端地址。 appName: &#x27;mongosh 2.1.5&#x27;, # 客户端名称。 allUsers: [ &#123; user: &#x27;user&#x27;, db: &#x27;admin&#x27; &#125; ], # 所有用户信息。 user: &#x27;user@admin&#x27; # 当前用户信息。 &#125;………………………………]# 查看执行时长最大的10条操作记录&gt; db.system.profile.find().limit(10).sort(&#123;millis:-1&#125;).pretty()# 查看某个集合中的update操作日志&gt; db.system.profile.find(&#123;op:&quot;update&quot;,ns:&quot;shop.user&quot;&#125;) system.profile是一个1MB的固定大小的集合，随着记录日志的增多，一些旧的记录会被滚动删除。 Profiler模块的设置是内存级的，重启服务器后会自动恢复默认状态。 db.currentOp() Profiler模块所记录的日志都是已经发生的事情，db.currentOp()命令则与此相反，它可以用来查看数据库当前正在执行的一些操作。 db.currentOp()读取的是当前数据库的命令快照，该命令可以返回许多有用的信息，比如： 123操作的运行时长，快速发现耗时漫长的低效扫描操作。执行计划信息，用于判断是否命中了索引，或者存在锁冲突的情况。操作ID、时间、客户端等信息，方便定位出产生慢操作的源头 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677&gt; db.currentOp()&#123;inprog: [ # 当前正在执行的操作 &#123; type: &#x27;op&#x27;, # 操作类型，可以是op、idleSession、idleCursor的一种，一般的操作信息以op表示。其为MongoDB 4.2版本新增功能 host: &#x27;localhost:27041&#x27;, # 操作所在的主机 desc: &#x27;conn474&#x27;, # 操作的描述信息 connectionId: 474, # 操作的连接ID client: &#x27;127.0.0.1:58103&#x27;, # 操作的客户端信息 appName: &#x27;mongosh 2.1.5&#x27;, # 操作的客户端应用信息 clientMetadata: &#123; # 关于客户端的附加信息，可以包含驱动的版本。 application: &#123; name: &#x27;mongosh 2.1.5&#x27; &#125;, driver: &#123; name: &#x27;nodejs|mongosh&#x27;, version: &#x27;6.3.0|2.1.5&#x27; &#125;, platform: &#x27;Node.js v20.11.1, LE&#x27;, os: &#123; name: &#x27;darwin&#x27;, architecture: &#x27;x64&#x27;, version: &#x27;22.6.0&#x27;, type: &#x27;Darwin&#x27; &#125; &#125;, active: true, # 操作是否活跃。如果是空闲状态则为false currentOpTime: &#x27;2024-04-07T14:54:02.994+08:00&#x27;, # 操作的开始时间。MongoDB 3.6版本新增功能 threaded: true, opid: 236247, # opid：当前操作在数据库进程中的唯一编号,如果已经发现该操作正在导致数据库系统响应缓慢，则可以考虑将其“杀”死 : db.killOp(236247) secs_running: Long(&#x27;3&#x27;), # 操作持续时间,单位：秒 microsecs_running: Long(&#x27;3362378&#x27;), # 操作持续时间，单位：微秒 op: &#x27;command&#x27;, # 标识操作类型的字符串，如 command, insert, query, update, delete, getMore, killCursors ns: &#x27;admin.$cmd&#x27;, # 操作的命名空间，格式为 db.collection redacted: false, # 是否已脱敏 command: &#123; # 操作命令参数 hello: 1, maxAwaitTimeMS: 10000, topologyVersion: &#123; processId: ObjectId(&#x27;6611f8cd59f7cfaa5c8cd7e4&#x27;), counter: Long(&#x27;18&#x27;) &#125;, &#x27;$clusterTime&#x27;: &#123; clusterTime: Timestamp(&#123; t: 1712470998, i: 1 &#125;), signature: &#123; hash: Binary.createFromBase64(&#x27;gvgo03Wqi1AuOVqnrlhzKIK2NAU=&#x27;, 0), keyId: Long(&#x27;7346062378896719877&#x27;) &#125; &#125;, &#x27;$db&#x27;: &#x27;admin&#x27; &#125;, numYields: 0, locks: &#123;&#125;, # 当前操作持有锁的类型和模式。 waitingForLock: false, # 是否在等待锁 lockStats: &#123;&#125;, # 当前操作持有锁的统计。 waitingForFlowControl: false, flowControlStats: &#123;&#125; &#125;………………………………]&#125;# 查看等待锁的增加、删除、修改、查询操作&gt; db.currentOp(&#123; waitingForLock:true, $or:[ &#123;op:&#123;$in:[&quot;insert&quot;,&quot;update&quot;,&quot;remove&quot;]&#125;&#125;, &#123;&quot;query.findandmodify&quot;:&#123;$exists:true&#125;&#125; ] &#125;)# 查看执行时间超过1s的操作&gt; db.currentOp(&#123; secs_running:&#123;$gt:1&#125; &#125;)# 查看test数据库中的操作&gt; db.currentOp(&#123; ns:/test/ &#125;)","summary":"摘要 本文介绍MongoDB7.0的一些有用的功能，比如运行js，查看慢查询日志等等 MongoDB官方文档 本文基于CentOS8(x86_64)","date_published":"2024-04-07T13:30:05.000Z","tags":["技术","linux","mongodb","mongodb"]},{"id":"https://blog.hanqunfeng.com/2024/04/03/mongodb7-tools/","url":"https://blog.hanqunfeng.com/2024/04/03/mongodb7-tools/","title":"MongoDB Command Line Database Tools","content_html":"<!--\n **加粗**\n *斜体*\n ***加粗并斜体***\n ~~删除线~~\n ==突出显示==\n `突出显示(推荐)`\n ++下划线++\n ~下标~\n ^上标^\n 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.\n 图片设置宽度和高度(通过uPic上传后，需要将upic修改过为blog，用于添加水印) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)\n\n +++ **点击折叠**\n 这是被隐藏的内容\n +++\n\n::: tips success warning danger\n这里是容器内的内容\n:::\n\n% note info % success warning danger\n这里是容器内的内容\n% endnote %\n\n引用本地其它文章连接{}\n 大括号开始% post_link 文件名称(不包含.md) %大括号结束\n -->\n<h2 id=\"摘要\">摘要</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>本文介绍Linux下MongoDB Command Line Database Tools的安装与使用</p>\n</li>\n<li class=\"lvl-2\">\n<p>MongoDB Command Line Database Tools<a href=\"https://www.mongodb.com/docs/database-tools/\">官方文档</a></p>\n</li>\n<li class=\"lvl-2\">\n<p>本文基于<code>CentOS8(x86_64)</code></p>\n</li>\n</ul>\n<span id=\"more\"></span>\n<h2 id=\"MongoDB-Database-Tools\">MongoDB Database Tools</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>MongoDB Database Tools是MongoDB官方提供的数据库管理工具，可以用于管理MongoDB数据库，包括MongoDB的备份、恢复、监控等功能。</p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://www.mongodb.com/try/download/database-tools\">MongoDB Database Tools的下载地址</a></p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 下载安装包</span></span><br><span class=\"line\">wget https://fastdl.mongodb.org/tools/db/mongodb-database-tools-rhel80-x86_64-100.9.4.tgz</span><br><span class=\"line\"><span class=\"comment\"># 解压安装包</span></span><br><span class=\"line\">tar -xvzf mongodb-database-tools-rhel80-x86_64-100.9.4.tgz</span><br><span class=\"line\"><span class=\"comment\"># 创建软连接</span></span><br><span class=\"line\"><span class=\"built_in\">ln</span> -s mongodb-database-tools-rhel80-x86_64-100.9.4 /mongodb/tools</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 在/etc/profile文件中配置PATH环境变量</span></span><br><span class=\"line\"><span class=\"built_in\">export</span> PATH=/mongodb/tools/bin:<span class=\"variable\">$PATH</span></span><br><span class=\"line\"><span class=\"comment\"># 使配置生效</span></span><br><span class=\"line\"><span class=\"built_in\">source</span> /etc/profile</span><br></pre></td></tr></table></figure>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>MongoDB Database Tools常用命令，详细的使用方法请查看<a href=\"https://www.mongodb.com/docs/database-tools/\">官方文档</a></p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>文件名称</th>\n<th>作用</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>mongostat</td>\n<td>数据库性能监控工具</td>\n</tr>\n<tr>\n<td>mongotop</td>\n<td>热点表监控工具</td>\n</tr>\n<tr>\n<td>mongodump</td>\n<td>数据库逻辑备份工具</td>\n</tr>\n<tr>\n<td>mongorestore</td>\n<td>数据库逻辑恢复工具</td>\n</tr>\n<tr>\n<td>mongoexport</td>\n<td>数据导出工具</td>\n</tr>\n<tr>\n<td>mongoimport</td>\n<td>数据导入工具</td>\n</tr>\n<tr>\n<td>bsondump</td>\n<td>BSON格式转换工具</td>\n</tr>\n<tr>\n<td>mongofiles</td>\n<td>GridFS文件工具</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"mongoexport-导出数据\">mongoexport: 导出数据</h2>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 导出csv格式的数据</span></span><br><span class=\"line\">mongoexport <span class=\"string\">&quot;mongodb://user:password@10.1.2.26:27017,10.1.2.142:27017,10.1.2.41:27017/?authSource=admin&amp;replicaSet=rs0&quot;</span> -d <span class=\"built_in\">test</span> -c books -f _id,title,<span class=\"built_in\">type</span>,tag --<span class=\"built_in\">type</span>=csv -o books.csv</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 导出json格式的数据</span></span><br><span class=\"line\">mongoexport <span class=\"string\">&quot;mongodb://user:password@10.1.2.26:27017,10.1.2.142:27017,10.1.2.41:27017/?authSource=admin&amp;replicaSet=rs0&quot;</span> -d <span class=\"built_in\">test</span> -c books -f _id,title,<span class=\"built_in\">type</span>,tag --<span class=\"built_in\">type</span>=json -o books.json</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 参数说明</span></span><br><span class=\"line\">-d 指定数据库</span><br><span class=\"line\">-c 指定集合</span><br><span class=\"line\">-f 指定导出字段，csv格式需要指定字段，json格式可以不指定字段，默认导出全部</span><br><span class=\"line\">--<span class=\"built_in\">type</span>=csv/json 指定导出格式</span><br><span class=\"line\">-o 指定导出文件</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 导出时可以增加过滤条件</span></span><br><span class=\"line\">mongoexport <span class=\"string\">&quot;mongodb://user:password@10.1.2.26:27017,10.1.2.142:27017,10.1.2.41:27017?authSource=admin&amp;replicaSet=rs0&quot;</span> -d mydb -c user --<span class=\"built_in\">type</span>=json -o user.json  --<span class=\"built_in\">limit</span>=10 --skip=2 --<span class=\"built_in\">sort</span>=<span class=\"string\">&#x27;&#123;&quot;name&quot;:1&#125;&#x27;</span> --query=<span class=\"string\">&#x27;&#123;&quot;age&quot;:&#123;&quot;$gt&quot;:25&#125;,&quot;name&quot;:&quot;zhangsan&quot;&#125;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 参数说明</span></span><br><span class=\"line\">--<span class=\"built_in\">limit</span>=10 指定导出条数</span><br><span class=\"line\">--skip=2 指定跳过条数</span><br><span class=\"line\">--<span class=\"built_in\">sort</span>=<span class=\"string\">&#x27;&#123;&quot;name&quot;:1&#125;&#x27;</span> 指定排序字段</span><br><span class=\"line\">--query=<span class=\"string\">&#x27;&#123;&quot;age&quot;:&#123;&quot;$gt&quot;:25&#125;,&quot;name&quot;:&quot;zhangsan&quot;&#125;&#x27;</span> 指定查询条件，注意这里的查询条件是json格式，字段名需要使用双引号包裹</span><br></pre></td></tr></table></figure>\n<h2 id=\"mongoimport-导入数据\">mongoimport: 导入数据</h2>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 导入csv格式的数据</span></span><br><span class=\"line\"><span class=\"comment\"># 注意此时导入的csv文件中第一行如果是字段名，需要先删除第一行再导入，这里使用了 -f 指定字段，来和导入的csv文件的列一一对应</span></span><br><span class=\"line\">mongoimport <span class=\"string\">&quot;mongodb://user:password@10.1.2.26:27017,10.1.2.142:27017,10.1.2.41:27017/?authSource=admin&amp;replicaSet=rs0&quot;</span> -d <span class=\"built_in\">test</span> -c books_new -f _id,title,<span class=\"built_in\">type</span>,tag --<span class=\"built_in\">type</span>=csv --file books.csv</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 注意此时导入的csv文件中第一行如果是字段名，需要先删除第一行再导入，这里使用了 -f 指定字段，来和导入的csv文件的列一一对应</span></span><br><span class=\"line\">mongoimport <span class=\"string\">&quot;mongodb://user:password@10.1.2.26:27017,10.1.2.142:27017,10.1.2.41:27017/?authSource=admin&amp;replicaSet=rs0&quot;</span> -d <span class=\"built_in\">test</span> -c books_new --headerline --<span class=\"built_in\">type</span>=csv --file books.csv</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 导入json格式的数据</span></span><br><span class=\"line\">mongoimport <span class=\"string\">&quot;mongodb://user:password@10.1.2.26:27017,10.1.2.142:27017,10.1.2.41:27017/?authSource=admin&amp;replicaSet=rs0&quot;</span> -d <span class=\"built_in\">test</span> -c books_new --<span class=\"built_in\">type</span>=json --file books.json</span><br><span class=\"line\"></span><br><span class=\"line\">-d 指定数据库</span><br><span class=\"line\">-c 指定集合</span><br><span class=\"line\">-f 指定导入字段，csv格式需要指定字段</span><br><span class=\"line\">--headerline 指定第一行是字段名</span><br><span class=\"line\">--<span class=\"built_in\">type</span>=csv/json 指定导入格式</span><br><span class=\"line\">--file 指定导入文件</span><br><span class=\"line\">--mode 指定导入方式，默认是insert，还可以是upsert，merge，delete</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>mode说明</p>\n</blockquote>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>insert: 默认值，如果数据不存在，则插入，如果存在，则报错</p>\n</li>\n<li class=\"lvl-2\">\n<p>upsert: 如果数据不存在，则插入，如果存在，则更新</p>\n</li>\n<li class=\"lvl-2\">\n<p>merge: 如果数据不存在，则插入，如果存在，则合并后更新</p>\n</li>\n<li class=\"lvl-2\">\n<p>delete: 如果数据不存在，也不执行插入，如果存在，则删除</p>\n</li>\n</ul>\n<h2 id=\"mongostat-数据库性能监控\">mongostat: 数据库性能监控</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>mongostat命令用于实时监控MongoDB数据库的性能，包括连接数、文档数、索引数、内存使用情况等。</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 监控20次，间隔1秒</span></span><br><span class=\"line\">mongostat <span class=\"string\">&quot;mongodb://user:password@10.1.2.26:27017,10.1.2.142:27017,10.1.2.41:27017/?authSource=admin&amp;replicaSet=rs0&quot;</span> -n20 1</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 参数说明</span></span><br><span class=\"line\">-n 指定监控次数</span><br><span class=\"line\">1 指定监控间隔时间，单位为秒</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 监控实时数据</span></span><br><span class=\"line\">host               insert query update delete getmore <span class=\"built_in\">command</span> dirty  used flushes vsize  res qrw arw net_in net_out conn <span class=\"built_in\">set</span> repl                time</span><br><span class=\"line\">10.1.2.142:27017    *0    *0     *0     *0       0     4|0     0.4%  5.0%       0 2.95G 151M 0|0 0|0  1.13k   75.2k   24 rs0  SLV Apr  3 08:37:49.405</span><br><span class=\"line\">10.1.2.26:27017     *0    *0     *0     *0       0     2|0     0.2%  3.8%       0 2.87G 138M 0|0 0|0   710b   74.3k   14 rs0  SEC Apr  3 08:37:49.385</span><br><span class=\"line\">10.1.2.41:27017     *0    *0     *0     *0       0     5|0     0.0% 17.7%       0 2.96G 184M 0|0 0|0  1.45k   75.5k   16 rs0  SEC Apr  3 08:37:49.426</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>指标说明</p>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th>指标名</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>inserts</code></td>\n<td>每秒插入数</td>\n</tr>\n<tr>\n<td><code>query</code></td>\n<td>每秒查询数</td>\n</tr>\n<tr>\n<td><code>update</code></td>\n<td>每秒更新数</td>\n</tr>\n<tr>\n<td><code>delete</code></td>\n<td>每秒删除数</td>\n</tr>\n<tr>\n<td><code>getmore</code></td>\n<td>每秒getmore数</td>\n</tr>\n<tr>\n<td><code>command</code></td>\n<td>每秒命令数，涵盖了内部的一些操作</td>\n</tr>\n<tr>\n<td><code>%dirty</code></td>\n<td>WiredTiger缓存中脏数据百分比</td>\n</tr>\n<tr>\n<td><code>%used</code></td>\n<td>WiredTiger 正在使用的缓存百分比</td>\n</tr>\n<tr>\n<td><code>flushes</code></td>\n<td>WiredTiger执行CheckPoint的次数</td>\n</tr>\n<tr>\n<td><code>vsize</code></td>\n<td>虚拟内存使用量</td>\n</tr>\n<tr>\n<td><code>res</code></td>\n<td>物理内存使用量</td>\n</tr>\n<tr>\n<td><code>qrw</code></td>\n<td>客户端读写等待队列数量，高并发时，一般队列值会升高</td>\n</tr>\n<tr>\n<td><code>arw</code></td>\n<td>客户端读写活跃个数</td>\n</tr>\n<tr>\n<td><code>netIn</code></td>\n<td>网络接收数据量</td>\n</tr>\n<tr>\n<td><code>netOut</code></td>\n<td>网络发送数据量</td>\n</tr>\n<tr>\n<td><code>conn</code></td>\n<td>当前连接数</td>\n</tr>\n<tr>\n<td><code>set</code></td>\n<td>所属复制集名称</td>\n</tr>\n<tr>\n<td><code>repl</code></td>\n<td>复制节点状态，如PRI(主节点,我这里主节点显示为SLV),SEC(从节点),ARB(仲裁节点),REC(节点正在恢复),UNK(未知状态),RTR(mongos)</td>\n</tr>\n<tr>\n<td><code>time</code></td>\n<td>时间戳</td>\n</tr>\n</tbody>\n</table>\n<blockquote>\n<p>需要重点关注的指标<br>\n1.插入、删除、修改、查询的速率是否产生较大波动，是否超出预期。<br>\n2.qrw、arw：队列是否较高，若长时间大于0则说明此时读写速度较慢。<br>\n3.conn：连接数是否太多。<br>\n4.dirty：百分比是否较高，若持续高于10%则说明磁盘I/O存在瓶颈。<br>\n5.netIn、netOut：是否超过网络带宽阈值。<br>\n6.repl：状态是否异常，如PRI、SEC、RTR为正常，若出现REC等异常值则需要修复。</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 指定监控指标 -o</span></span><br><span class=\"line\">mongostat <span class=\"string\">&quot;mongodb://user:password@10.1.2.26:27017,10.1.2.142:27017,10.1.2.41:27017/?authSource=admin&amp;replicaSet=rs0&quot;</span> -n1 1 -o=<span class=\"string\">&#x27;host,insert,query,update,delete,qrw,arw,conn,dirty,repl,version&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">            host insert query update delete qrw arw conn dirty repl version</span><br><span class=\"line\">10.1.2.142:27017     *0    *0     *0     *0 0|0 0|0   24  0.4%  SLV   7.0.7</span><br><span class=\"line\"> 10.1.2.26:27017     *0    *0     *0     *0 0|0 0|0   14  0.2%  SEC   7.0.7</span><br><span class=\"line\"> 10.1.2.41:27017     *0    *0     *0     *0 0|0 0|0   16  0.4%  SEC   7.0.7</span><br></pre></td></tr></table></figure>\n<h2 id=\"mongotop-查看数据库性能\">mongotop: 查看数据库性能</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>mongotop命令可用于查看数据库的热点表，通过观察mongotop的输出，可以判定是哪些集合占用了大部分读写时间。</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 监控20次，间隔1秒</span></span><br><span class=\"line\">mongotop <span class=\"string\">&quot;mongodb://user:password@10.1.2.26:27017,10.1.2.142:27017,10.1.2.41:27017/?authSource=admin&amp;replicaSet=rs0&quot;</span> -n 20 1</span><br><span class=\"line\"></span><br><span class=\"line\">                             ns    total    <span class=\"built_in\">read</span>    write    2024-04-03T09:16:53Z</span><br><span class=\"line\">                 admin.atlascli      0ms     0ms      0ms</span><br><span class=\"line\">              admin.system.keys      0ms     0ms      0ms</span><br><span class=\"line\">             admin.system.users      0ms     0ms      0ms</span><br><span class=\"line\">           admin.system.version      0ms     0ms      0ms</span><br><span class=\"line\">config.external_validation_keys      0ms     0ms      0ms</span><br><span class=\"line\">        config.image_collection      0ms     0ms      0ms</span><br><span class=\"line\">          config.queryAnalyzers      0ms     0ms      0ms</span><br><span class=\"line\">                config.settings      0ms     0ms      0ms</span><br><span class=\"line\">    config.shardMergeRecipients      0ms     0ms      0ms</span><br><span class=\"line\">        config.shardSplitDonors      0ms     0ms      0ms</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 输出说明</span></span><br><span class=\"line\">ns 集合名称</span><br><span class=\"line\">total 花费在该集合上的时长</span><br><span class=\"line\"><span class=\"built_in\">read</span> 花费在该集合上的读操作时长</span><br><span class=\"line\">write 花费在该集合上的写操作时长</span><br></pre></td></tr></table></figure>\n<h2 id=\"mongodump-备份数据库\">mongodump: 备份数据库</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>mongodump命令用于备份数据库</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 备份所有库，默认输出到dump文件夹下</span></span><br><span class=\"line\">mongodump <span class=\"string\">&quot;mongodb://user:password@10.1.2.26:27017,10.1.2.142:27017,10.1.2.41:27017/?authSource=admin&amp;replicaSet=rs0&quot;</span> --gzip</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 备份指定库，默认输出到dump文件夹下</span></span><br><span class=\"line\">mongodump <span class=\"string\">&quot;mongodb://user:password@10.1.2.26:27017,10.1.2.142:27017,10.1.2.41:27017/?authSource=admin&amp;replicaSet=rs0&quot;</span> -d <span class=\"built_in\">test</span> --gzip</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 备份指定集合</span></span><br><span class=\"line\">mongodump <span class=\"string\">&quot;mongodb://user:password@10.1.2.26:27017,10.1.2.142:27017,10.1.2.41:27017/?authSource=admin&amp;replicaSet=rs0&quot;</span> -d <span class=\"built_in\">test</span> -c books --gzip -o ./books</span><br><span class=\"line\">2024-04-03T09:36:18.980+0000\twriting test.books to books/test/books.bson.gz</span><br><span class=\"line\">2024-04-03T09:36:18.983+0000\t<span class=\"keyword\">done</span> dumping test.books (50 documents)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 参数说明</span></span><br><span class=\"line\">-d 指定数据库，不指定则导出全部数据库</span><br><span class=\"line\">-c 指定集合，不指定则导出全部集合</span><br><span class=\"line\">--gzip 指定压缩格式，导出的文件会被压缩为.gz格式</span><br><span class=\"line\">-o 指定备份目录，不指定则默认为当前目录下的dump文件夹</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 类似于 mongoexport ,备份数据时同样支持过滤条件</span></span><br><span class=\"line\">mongodump <span class=\"string\">&quot;mongodb://user:password@10.1.2.26:27017,10.1.2.142:27017,10.1.2.41:27017/?authSource=admin&amp;replicaSet=rs0&quot;</span> -d <span class=\"built_in\">test</span> -c books --gzip -o ./books --query=<span class=\"string\">&#x27;&#123;&quot;name&quot;:&quot;hello&quot;&#125;&#x27;</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"mongorestore-恢复数据库\">mongorestore: 恢复数据库</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>mongorestore命令用于恢复数据库</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 恢复到相同数据库的相同集合,此时会将dump目录下的所有数据库进行恢复</span></span><br><span class=\"line\">mongorestore <span class=\"string\">&quot;mongodb://user:password@10.1.2.26:27017,10.1.2.142:27017,10.1.2.41:27017/?authSource=admin&amp;replicaSet=rs0&quot;</span> --gzip ./dump</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 只恢复指定的库下的所有集合</span></span><br><span class=\"line\">mongorestore <span class=\"string\">&quot;mongodb://user:password@10.1.2.26:27017,10.1.2.142:27017,10.1.2.41:27017/?authSource=admin&amp;replicaSet=rs0&quot;</span> --nsInclude=<span class=\"string\">&quot;test.*&quot;</span> --gzip ./dump</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 只恢复指定的集合</span></span><br><span class=\"line\">mongorestore <span class=\"string\">&quot;mongodb://user:password@10.1.2.26:27017,10.1.2.142:27017,10.1.2.41:27017/?authSource=admin&amp;replicaSet=rs0&quot;</span> --nsInclude=<span class=\"string\">&quot;test.books&quot;</span> --gzip ./dump</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 参数说明</span></span><br><span class=\"line\">--nsInclude=test.books 指定要恢复的集合</span><br><span class=\"line\">--gzip 指定压缩格式</span><br></pre></td></tr></table></figure>\n<h2 id=\"bsondump-查看BSON文件内容\">bsondump: 查看BSON文件内容</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>bsondump命令用于查看BSON文件内容，可以将bson格式的数据转换为json格式，方便查看。</p>\n</li>\n<li class=\"lvl-2\">\n<p>我们使用mongodump导出的数据格式为bson格式，可以使用bsondump命令将其转换为json格式。</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 如果导出的是压缩格式需要先解压缩</span></span><br><span class=\"line\">gunzip emp.bson.gz</span><br><span class=\"line\"><span class=\"comment\"># 将bson文件转换为json文件</span></span><br><span class=\"line\">bsondump emp.bson &gt; emp.json</span><br></pre></td></tr></table></figure>\n<h2 id=\"mongofiles-文件存储\">mongofiles: 文件存储</h2>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>mongofiles命令用于文件存储，可以将文件存储到MongoDB中，然后通过mongofiles命令进行查看和删除。</p>\n</li>\n<li class=\"lvl-2\">\n<p>不过现在文件存储基本都会使用S3，很少使用mongodb了。</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 上传</span></span><br><span class=\"line\">mongofiles <span class=\"string\">&quot;mongodb://user:password@10.1.2.26:27017,10.1.2.142:27017,10.1.2.41:27017/?authSource=admin&amp;replicaSet=rs0&quot;</span> -d mydb put shell从入门到精通.docx</span><br><span class=\"line\"><span class=\"comment\"># 上传后会在指定的数据库中创建两个集合：fs.files 和 fs.chunks</span></span><br><span class=\"line\"></span><br><span class=\"line\">&gt; db.fs.files.find()</span><br><span class=\"line\">[</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    _id: ObjectId(<span class=\"string\">&#x27;66120f0135b8419b3a1ca510&#x27;</span>), <span class=\"comment\"># 文档ID，唯一标识</span></span><br><span class=\"line\">    length: Long(<span class=\"string\">&#x27;486680&#x27;</span>),                    <span class=\"comment\"># 文件大小</span></span><br><span class=\"line\">    chunkSize: 261120,                         <span class=\"comment\"># 每个分片的大小</span></span><br><span class=\"line\">    uploadDate: ISODate(<span class=\"string\">&#x27;2024-04-07T03:12:01.965Z&#x27;</span>), <span class=\"comment\"># 上传时间</span></span><br><span class=\"line\">    filename: <span class=\"string\">&#x27;shell从入门到精通.docx&#x27;</span>,          <span class=\"comment\"># 文件名</span></span><br><span class=\"line\">    metadata: &#123;&#125;                               <span class=\"comment\"># 元数据</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">]</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">&gt; db.fs.chunks.find()</span><br><span class=\"line\">[</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    _id: ObjectId(<span class=\"string\">&#x27;66120f0135b8419b3a1ca512&#x27;</span>),     <span class=\"comment\"># 分片ID</span></span><br><span class=\"line\">    files_id: ObjectId(<span class=\"string\">&#x27;66120f0135b8419b3a1ca510&#x27;</span>), <span class=\"comment\"># 文档ID，对应fs.files集合中的_id</span></span><br><span class=\"line\">    n: 1,                                         <span class=\"comment\"># 分片序号</span></span><br><span class=\"line\">    data: &lt;Binary&gt;                                <span class=\"comment\"># 分片数据</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看</span></span><br><span class=\"line\">mongofiles <span class=\"string\">&quot;mongodb://user:password@10.1.2.26:27017,10.1.2.142:27017,10.1.2.41:27017/?authSource=admin&amp;replicaSet=rs0&quot;</span> -d mydb list</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 搜索</span></span><br><span class=\"line\">mongofiles <span class=\"string\">&quot;mongodb://user:password@10.1.2.26:27017,10.1.2.142:27017,10.1.2.41:27017/?authSource=admin&amp;replicaSet=rs0&quot;</span> -d mydb search shell</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 下载</span></span><br><span class=\"line\">mongofiles <span class=\"string\">&quot;mongodb://user:password@10.1.2.26:27017,10.1.2.142:27017,10.1.2.41:27017/?authSource=admin&amp;replicaSet=rs0&quot;</span> -d mydb get shell从入门到精通.docx</span><br><span class=\"line\"><span class=\"comment\"># 根据id获取文件</span></span><br><span class=\"line\">mongofiles <span class=\"string\">&quot;mongodb://user:password@10.1.2.26:27017,10.1.2.142:27017,10.1.2.41:27017/?authSource=admin&amp;replicaSet=rs0&quot;</span> -d mydb get_id <span class=\"string\">&#x27;&#123;&quot;$oid&quot;: &quot;66120f0135b8419b3a1ca510&quot;&#125;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 删除</span></span><br><span class=\"line\">mongofiles <span class=\"string\">&quot;mongodb://user:password@10.1.2.26:27017,10.1.2.142:27017,10.1.2.41:27017/?authSource=admin&amp;replicaSet=rs0&quot;</span> -d mydb delete shell从入门到精通.docx</span><br><span class=\"line\"><span class=\"comment\"># 根据id删除文件</span></span><br><span class=\"line\">mongofiles <span class=\"string\">&quot;mongodb://user:password@10.1.2.26:27017,10.1.2.142:27017,10.1.2.41:27017/?authSource=admin&amp;replicaSet=rs0&quot;</span> -d mydb delete_id <span class=\"string\">&#x27;&#123;&quot;$oid&quot;: &quot;66120f0135b8419b3a1ca510&quot;&#125;&#x27;</span></span><br></pre></td></tr></table></figure>","content_text":"摘要 本文介绍Linux下MongoDB Command Line Database Tools的安装与使用 MongoDB Command Line Database Tools官方文档 本文基于CentOS8(x86_64) MongoDB Database Tools MongoDB Database Tools是MongoDB官方提供的数据库管理工具，可以用于管理MongoDB数据库，包括MongoDB的备份、恢复、监控等功能。 MongoDB Database Tools的下载地址 1234567891011# 下载安装包wget https://fastdl.mongodb.org/tools/db/mongodb-database-tools-rhel80-x86_64-100.9.4.tgz# 解压安装包tar -xvzf mongodb-database-tools-rhel80-x86_64-100.9.4.tgz# 创建软连接ln -s mongodb-database-tools-rhel80-x86_64-100.9.4 /mongodb/tools# 在/etc/profile文件中配置PATH环境变量export PATH=/mongodb/tools/bin:$PATH# 使配置生效source /etc/profile MongoDB Database Tools常用命令，详细的使用方法请查看官方文档 文件名称 作用 mongostat 数据库性能监控工具 mongotop 热点表监控工具 mongodump 数据库逻辑备份工具 mongorestore 数据库逻辑恢复工具 mongoexport 数据导出工具 mongoimport 数据导入工具 bsondump BSON格式转换工具 mongofiles GridFS文件工具 mongoexport: 导出数据 123456789101112131415161718192021# 导出csv格式的数据mongoexport &quot;mongodb://user:password@10.1.2.26:27017,10.1.2.142:27017,10.1.2.41:27017/?authSource=admin&amp;replicaSet=rs0&quot; -d test -c books -f _id,title,type,tag --type=csv -o books.csv# 导出json格式的数据mongoexport &quot;mongodb://user:password@10.1.2.26:27017,10.1.2.142:27017,10.1.2.41:27017/?authSource=admin&amp;replicaSet=rs0&quot; -d test -c books -f _id,title,type,tag --type=json -o books.json# 参数说明-d 指定数据库-c 指定集合-f 指定导出字段，csv格式需要指定字段，json格式可以不指定字段，默认导出全部--type=csv/json 指定导出格式-o 指定导出文件# 导出时可以增加过滤条件mongoexport &quot;mongodb://user:password@10.1.2.26:27017,10.1.2.142:27017,10.1.2.41:27017?authSource=admin&amp;replicaSet=rs0&quot; -d mydb -c user --type=json -o user.json --limit=10 --skip=2 --sort=&#x27;&#123;&quot;name&quot;:1&#125;&#x27; --query=&#x27;&#123;&quot;age&quot;:&#123;&quot;$gt&quot;:25&#125;,&quot;name&quot;:&quot;zhangsan&quot;&#125;&#x27;# 参数说明--limit=10 指定导出条数--skip=2 指定跳过条数--sort=&#x27;&#123;&quot;name&quot;:1&#125;&#x27; 指定排序字段--query=&#x27;&#123;&quot;age&quot;:&#123;&quot;$gt&quot;:25&#125;,&quot;name&quot;:&quot;zhangsan&quot;&#125;&#x27; 指定查询条件，注意这里的查询条件是json格式，字段名需要使用双引号包裹 mongoimport: 导入数据 1234567891011121314151617# 导入csv格式的数据# 注意此时导入的csv文件中第一行如果是字段名，需要先删除第一行再导入，这里使用了 -f 指定字段，来和导入的csv文件的列一一对应mongoimport &quot;mongodb://user:password@10.1.2.26:27017,10.1.2.142:27017,10.1.2.41:27017/?authSource=admin&amp;replicaSet=rs0&quot; -d test -c books_new -f _id,title,type,tag --type=csv --file books.csv# 注意此时导入的csv文件中第一行如果是字段名，需要先删除第一行再导入，这里使用了 -f 指定字段，来和导入的csv文件的列一一对应mongoimport &quot;mongodb://user:password@10.1.2.26:27017,10.1.2.142:27017,10.1.2.41:27017/?authSource=admin&amp;replicaSet=rs0&quot; -d test -c books_new --headerline --type=csv --file books.csv# 导入json格式的数据mongoimport &quot;mongodb://user:password@10.1.2.26:27017,10.1.2.142:27017,10.1.2.41:27017/?authSource=admin&amp;replicaSet=rs0&quot; -d test -c books_new --type=json --file books.json-d 指定数据库-c 指定集合-f 指定导入字段，csv格式需要指定字段--headerline 指定第一行是字段名--type=csv/json 指定导入格式--file 指定导入文件--mode 指定导入方式，默认是insert，还可以是upsert，merge，delete mode说明 insert: 默认值，如果数据不存在，则插入，如果存在，则报错 upsert: 如果数据不存在，则插入，如果存在，则更新 merge: 如果数据不存在，则插入，如果存在，则合并后更新 delete: 如果数据不存在，也不执行插入，如果存在，则删除 mongostat: 数据库性能监控 mongostat命令用于实时监控MongoDB数据库的性能，包括连接数、文档数、索引数、内存使用情况等。 123456789101112# 监控20次，间隔1秒mongostat &quot;mongodb://user:password@10.1.2.26:27017,10.1.2.142:27017,10.1.2.41:27017/?authSource=admin&amp;replicaSet=rs0&quot; -n20 1# 参数说明-n 指定监控次数1 指定监控间隔时间，单位为秒# 监控实时数据host insert query update delete getmore command dirty used flushes vsize res qrw arw net_in net_out conn set repl time10.1.2.142:27017 *0 *0 *0 *0 0 4|0 0.4% 5.0% 0 2.95G 151M 0|0 0|0 1.13k 75.2k 24 rs0 SLV Apr 3 08:37:49.40510.1.2.26:27017 *0 *0 *0 *0 0 2|0 0.2% 3.8% 0 2.87G 138M 0|0 0|0 710b 74.3k 14 rs0 SEC Apr 3 08:37:49.38510.1.2.41:27017 *0 *0 *0 *0 0 5|0 0.0% 17.7% 0 2.96G 184M 0|0 0|0 1.45k 75.5k 16 rs0 SEC Apr 3 08:37:49.426 指标说明 指标名 说明 inserts 每秒插入数 query 每秒查询数 update 每秒更新数 delete 每秒删除数 getmore 每秒getmore数 command 每秒命令数，涵盖了内部的一些操作 %dirty WiredTiger缓存中脏数据百分比 %used WiredTiger 正在使用的缓存百分比 flushes WiredTiger执行CheckPoint的次数 vsize 虚拟内存使用量 res 物理内存使用量 qrw 客户端读写等待队列数量，高并发时，一般队列值会升高 arw 客户端读写活跃个数 netIn 网络接收数据量 netOut 网络发送数据量 conn 当前连接数 set 所属复制集名称 repl 复制节点状态，如PRI(主节点,我这里主节点显示为SLV),SEC(从节点),ARB(仲裁节点),REC(节点正在恢复),UNK(未知状态),RTR(mongos) time 时间戳 需要重点关注的指标 1.插入、删除、修改、查询的速率是否产生较大波动，是否超出预期。 2.qrw、arw：队列是否较高，若长时间大于0则说明此时读写速度较慢。 3.conn：连接数是否太多。 4.dirty：百分比是否较高，若持续高于10%则说明磁盘I/O存在瓶颈。 5.netIn、netOut：是否超过网络带宽阈值。 6.repl：状态是否异常，如PRI、SEC、RTR为正常，若出现REC等异常值则需要修复。 1234567# 指定监控指标 -omongostat &quot;mongodb://user:password@10.1.2.26:27017,10.1.2.142:27017,10.1.2.41:27017/?authSource=admin&amp;replicaSet=rs0&quot; -n1 1 -o=&#x27;host,insert,query,update,delete,qrw,arw,conn,dirty,repl,version&#x27; host insert query update delete qrw arw conn dirty repl version10.1.2.142:27017 *0 *0 *0 *0 0|0 0|0 24 0.4% SLV 7.0.7 10.1.2.26:27017 *0 *0 *0 *0 0|0 0|0 14 0.2% SEC 7.0.7 10.1.2.41:27017 *0 *0 *0 *0 0|0 0|0 16 0.4% SEC 7.0.7 mongotop: 查看数据库性能 mongotop命令可用于查看数据库的热点表，通过观察mongotop的输出，可以判定是哪些集合占用了大部分读写时间。 1234567891011121314151617181920# 监控20次，间隔1秒mongotop &quot;mongodb://user:password@10.1.2.26:27017,10.1.2.142:27017,10.1.2.41:27017/?authSource=admin&amp;replicaSet=rs0&quot; -n 20 1 ns total read write 2024-04-03T09:16:53Z admin.atlascli 0ms 0ms 0ms admin.system.keys 0ms 0ms 0ms admin.system.users 0ms 0ms 0ms admin.system.version 0ms 0ms 0msconfig.external_validation_keys 0ms 0ms 0ms config.image_collection 0ms 0ms 0ms config.queryAnalyzers 0ms 0ms 0ms config.settings 0ms 0ms 0ms config.shardMergeRecipients 0ms 0ms 0ms config.shardSplitDonors 0ms 0ms 0ms# 输出说明ns 集合名称total 花费在该集合上的时长read 花费在该集合上的读操作时长write 花费在该集合上的写操作时长 mongodump: 备份数据库 mongodump命令用于备份数据库 12345678910111213141516171819# 备份所有库，默认输出到dump文件夹下mongodump &quot;mongodb://user:password@10.1.2.26:27017,10.1.2.142:27017,10.1.2.41:27017/?authSource=admin&amp;replicaSet=rs0&quot; --gzip# 备份指定库，默认输出到dump文件夹下mongodump &quot;mongodb://user:password@10.1.2.26:27017,10.1.2.142:27017,10.1.2.41:27017/?authSource=admin&amp;replicaSet=rs0&quot; -d test --gzip# 备份指定集合mongodump &quot;mongodb://user:password@10.1.2.26:27017,10.1.2.142:27017,10.1.2.41:27017/?authSource=admin&amp;replicaSet=rs0&quot; -d test -c books --gzip -o ./books2024-04-03T09:36:18.980+0000 writing test.books to books/test/books.bson.gz2024-04-03T09:36:18.983+0000 done dumping test.books (50 documents)# 参数说明-d 指定数据库，不指定则导出全部数据库-c 指定集合，不指定则导出全部集合--gzip 指定压缩格式，导出的文件会被压缩为.gz格式-o 指定备份目录，不指定则默认为当前目录下的dump文件夹# 类似于 mongoexport ,备份数据时同样支持过滤条件mongodump &quot;mongodb://user:password@10.1.2.26:27017,10.1.2.142:27017,10.1.2.41:27017/?authSource=admin&amp;replicaSet=rs0&quot; -d test -c books --gzip -o ./books --query=&#x27;&#123;&quot;name&quot;:&quot;hello&quot;&#125;&#x27; mongorestore: 恢复数据库 mongorestore命令用于恢复数据库 12345678910111213# 恢复到相同数据库的相同集合,此时会将dump目录下的所有数据库进行恢复mongorestore &quot;mongodb://user:password@10.1.2.26:27017,10.1.2.142:27017,10.1.2.41:27017/?authSource=admin&amp;replicaSet=rs0&quot; --gzip ./dump# 只恢复指定的库下的所有集合mongorestore &quot;mongodb://user:password@10.1.2.26:27017,10.1.2.142:27017,10.1.2.41:27017/?authSource=admin&amp;replicaSet=rs0&quot; --nsInclude=&quot;test.*&quot; --gzip ./dump# 只恢复指定的集合mongorestore &quot;mongodb://user:password@10.1.2.26:27017,10.1.2.142:27017,10.1.2.41:27017/?authSource=admin&amp;replicaSet=rs0&quot; --nsInclude=&quot;test.books&quot; --gzip ./dump# 参数说明--nsInclude=test.books 指定要恢复的集合--gzip 指定压缩格式 bsondump: 查看BSON文件内容 bsondump命令用于查看BSON文件内容，可以将bson格式的数据转换为json格式，方便查看。 我们使用mongodump导出的数据格式为bson格式，可以使用bsondump命令将其转换为json格式。 1234# 如果导出的是压缩格式需要先解压缩gunzip emp.bson.gz# 将bson文件转换为json文件bsondump emp.bson &gt; emp.json mongofiles: 文件存储 mongofiles命令用于文件存储，可以将文件存储到MongoDB中，然后通过mongofiles命令进行查看和删除。 不过现在文件存储基本都会使用S3，很少使用mongodb了。 123456789101112131415161718192021222324252627282930313233343536373839404142# 上传mongofiles &quot;mongodb://user:password@10.1.2.26:27017,10.1.2.142:27017,10.1.2.41:27017/?authSource=admin&amp;replicaSet=rs0&quot; -d mydb put shell从入门到精通.docx# 上传后会在指定的数据库中创建两个集合：fs.files 和 fs.chunks&gt; db.fs.files.find()[ &#123; _id: ObjectId(&#x27;66120f0135b8419b3a1ca510&#x27;), # 文档ID，唯一标识 length: Long(&#x27;486680&#x27;), # 文件大小 chunkSize: 261120, # 每个分片的大小 uploadDate: ISODate(&#x27;2024-04-07T03:12:01.965Z&#x27;), # 上传时间 filename: &#x27;shell从入门到精通.docx&#x27;, # 文件名 metadata: &#123;&#125; # 元数据 &#125;]&gt; db.fs.chunks.find()[ &#123; _id: ObjectId(&#x27;66120f0135b8419b3a1ca512&#x27;), # 分片ID files_id: ObjectId(&#x27;66120f0135b8419b3a1ca510&#x27;), # 文档ID，对应fs.files集合中的_id n: 1, # 分片序号 data: &lt;Binary&gt; # 分片数据 &#125;]# 查看mongofiles &quot;mongodb://user:password@10.1.2.26:27017,10.1.2.142:27017,10.1.2.41:27017/?authSource=admin&amp;replicaSet=rs0&quot; -d mydb list# 搜索mongofiles &quot;mongodb://user:password@10.1.2.26:27017,10.1.2.142:27017,10.1.2.41:27017/?authSource=admin&amp;replicaSet=rs0&quot; -d mydb search shell# 下载mongofiles &quot;mongodb://user:password@10.1.2.26:27017,10.1.2.142:27017,10.1.2.41:27017/?authSource=admin&amp;replicaSet=rs0&quot; -d mydb get shell从入门到精通.docx# 根据id获取文件mongofiles &quot;mongodb://user:password@10.1.2.26:27017,10.1.2.142:27017,10.1.2.41:27017/?authSource=admin&amp;replicaSet=rs0&quot; -d mydb get_id &#x27;&#123;&quot;$oid&quot;: &quot;66120f0135b8419b3a1ca510&quot;&#125;&#x27;# 删除mongofiles &quot;mongodb://user:password@10.1.2.26:27017,10.1.2.142:27017,10.1.2.41:27017/?authSource=admin&amp;replicaSet=rs0&quot; -d mydb delete shell从入门到精通.docx# 根据id删除文件mongofiles &quot;mongodb://user:password@10.1.2.26:27017,10.1.2.142:27017,10.1.2.41:27017/?authSource=admin&amp;replicaSet=rs0&quot; -d mydb delete_id &#x27;&#123;&quot;$oid&quot;: &quot;66120f0135b8419b3a1ca510&quot;&#125;&#x27;","summary":"摘要 本文介绍Linux下MongoDB Command Line Database Tools的安装与使用 MongoDB Command Line Database Tools官方文档 本文基于CentOS8(x86_64)","date_published":"2024-04-03T13:30:05.000Z","tags":["技术","linux","mongodb","mongodb"]}]}