<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Django," />





  <link rel="alternate" href="/atom.xml" title="hanqunfeng's blog" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="摘要 版本：python3.6.4+django2.0.3Demo：https://github.com/hanqunfeng/DjangoHelloWorld  参考资料：官方资料Django 1.8.2 文档Django 1.11.6 文档Django 2.0.2文档Django中文教程">
<meta name="keywords" content="Django">
<meta property="og:type" content="article">
<meta property="og:title" content="Django2学习笔记">
<meta property="og:url" content="http://blog.hanqunfeng.com/2018/04/28/django2_study/index.html">
<meta property="og:site_name" content="hanqunfeng&#39;s blog">
<meta property="og:description" content="摘要 版本：python3.6.4+django2.0.3Demo：https://github.com/hanqunfeng/DjangoHelloWorld  参考资料：官方资料Django 1.8.2 文档Django 1.11.6 文档Django 2.0.2文档Django中文教程">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2018-04-28T09:47:14.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Django2学习笔记">
<meta name="twitter:description" content="摘要 版本：python3.6.4+django2.0.3Demo：https://github.com/hanqunfeng/DjangoHelloWorld  参考资料：官方资料Django 1.8.2 文档Django 1.11.6 文档Django 2.0.2文档Django中文教程">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://blog.hanqunfeng.com/2018/04/28/django2_study/"/>





  <title> Django2学习笔记 | hanqunfeng's blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?df09093d4aac102842ad15c241595440";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">hanqunfeng's blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">Spring--java程序员的春天</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-book">
          <a href="/2016/12/02/book/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />
            
            资料
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>


    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://blog.hanqunfeng.com/2018/04/28/django2_study/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="hanqunfeng">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/touxiang.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="hanqunfeng's blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="hanqunfeng's blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Django2学习笔记
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-04-28T23:33:15+08:00">
                2018-04-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2018/04/28/django2_study/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2018/04/28/django2_study/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2018/04/28/django2_study/" class="leancloud_visitors" data-flag-title="Django2学习笔记">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">阅读次数 </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          <span class="post-time">
              &nbsp; | &nbsp;
           <span class="post-meta-item-icon">
             <i class="fa fa-calendar-o"></i>
           </span>
           <span class="post-meta-item-text">字数统计:</span>
           <span class="post-count">6,058(字)</span>
           
          </span>
    
         <span class="post-time">
            &nbsp; | &nbsp;
           <span class="post-meta-item-icon">
             <i class="fa fa-calendar-o"></i>
           </span>
           <span class="post-meta-item-text">阅读时长:</span>
           <span class="post-count">28(分)</span>
           
         </span>

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h2><ul>
<li><p>版本：python3.6.4+django2.0.3<br>Demo：<a href="https://github.com/hanqunfeng/DjangoHelloWorld" target="_blank" rel="noopener">https://github.com/hanqunfeng/DjangoHelloWorld</a></p>
</li>
<li><p>参考资料：<br><a href="https://docs.djangoproject.com/en/2.0/" target="_blank" rel="noopener">官方资料</a><br><a href="https://yiyibooks.cn/xx/django_182/index.html" target="_blank" rel="noopener">Django 1.8.2 文档</a><br><a href="https://yiyibooks.cn/xx/Django_1.11.6/index.html" target="_blank" rel="noopener">Django 1.11.6 文档</a><br><a href="https://yiyibooks.cn/qy/django2/index.html" target="_blank" rel="noopener">Django 2.0.2文档</a><br><a href="https://code.ziqiangxuetang.com/django/django-internationalization.html" target="_blank" rel="noopener">Django中文教程</a></p>
<a id="more"></a>
</li>
</ul>
<h2 id="1-安装"><a href="#1-安装" class="headerlink" title="1.安装"></a>1.安装</h2><p><code>pip install Django</code><br><code>python -m django --version</code></p>
<h2 id="2-创建新项目"><a href="#2-创建新项目" class="headerlink" title="2.创建新项目"></a>2.创建新项目</h2><p><code>django-admin startproject mysite</code>  # mysite就是项目名称</p>
<h2 id="3-创建新的应用"><a href="#3-创建新的应用" class="headerlink" title="3.创建新的应用"></a>3.创建新的应用</h2><p><code>python manage.py startapp polls</code> # polls是应用名称<br>settings.py中加入新应用配置<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">INSTALLED_APPS = [</div><div class="line">    <span class="string">'polls.apps.PollsConfig'</span>,</div><div class="line">    <span class="string">'django.contrib.admin'</span>,</div><div class="line">    <span class="string">'django.contrib.auth'</span>,</div><div class="line">    <span class="string">'django.contrib.contenttypes'</span>,</div><div class="line">    <span class="string">'django.contrib.sessions'</span>,</div><div class="line">    <span class="string">'django.contrib.messages'</span>,</div><div class="line">    <span class="string">'django.contrib.staticfiles'</span>,</div><div class="line">]</div></pre></td></tr></table></figure></p>
<h2 id="4-创建和更新数据库："><a href="#4-创建和更新数据库：" class="headerlink" title="4.创建和更新数据库："></a>4.创建和更新数据库：</h2><p><code>python manage.py makemigrations</code> # 全部应用都会创建迁移文件</p>
<p><code>python manage.py makemigrations polls</code> # 只创建指定的应用</p>
<p><code>python manage.py migrate</code> # 执行迁移文件到数据库</p>
<p>查看迁移文件生成的sql:<br> sqlmigrate命令接收迁移文件的名字并返回它们的SQL语句：#只是打印出要执行的sql语句</p>
<p><code>python manage.py sqlmigrate polls 0001</code>  # 这里迁移文件的后缀_initial.py不需要。</p>
<h2 id="5-启动服务器"><a href="#5-启动服务器" class="headerlink" title="5.启动服务器"></a>5.启动服务器</h2><p>Django的管理后台站点是默认启用的。 让我们启动开发服务器，然后探索它。<br>如果服务器没有运行，像下面这样启动它：</p>
<p><code>python manage.py runserver</code></p>
<p>现在，打开一个浏览器访问你本地域名中的 “/admin/” — 例如<a href="http://127.0.0.1:8000/admin/。" target="_blank" rel="noopener">http://127.0.0.1:8000/admin/。</a></p>
<p>启动：</p>
<p><code>python manage.py runserver 9000</code> #指定启动端口</p>
<p><code>python manage.py runserver 0.0.0.0:9000</code> #指定启动ip+端口</p>
<h2 id="6-测试："><a href="#6-测试：" class="headerlink" title="6.测试："></a>6.测试：</h2><p><code>python manage.py test</code> #运行整个项目的全部tests.py</p>
<p><code>python manage.py test django2</code> #运行指定模块的tests.py</p>
<p><code>python manage.py test django2.tests.Django2Test</code> #测试指定模块的指定测试类</p>
<p><code>python manage.py test django2.tests.Django2Test.test_sql</code> #测试指定模块的指定测试类指定方法</p>
<h2 id="7-检查代码覆盖率："><a href="#7-检查代码覆盖率：" class="headerlink" title="7.检查代码覆盖率："></a>7.检查代码覆盖率：</h2><p><code>pip install coverage</code></p>
<p><code>coverage run my_program.py arg1 arg2</code></p>
<p>django检查方法：</p>
<p><code>coverage run --source=&#39;.&#39; manage.py test myapp</code></p>
<p>之后可以运行</p>
<p><code>coverage report</code> ：显示结果</p>
<p><code>coverage html</code>：生成html  测试会在当前项目下生成htmlcov目录，运行index.html即可查看</p>
<h2 id="8-mysql"><a href="#8-mysql" class="headerlink" title="8.mysql:"></a>8.mysql:</h2><p><code>brew install mysql-connector-c</code></p>
<p><code>pip install mysqlclient</code></p>
<p>需要提前创建好数据库<br>settings.py:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">DATABASES = &#123;</div><div class="line">    <span class="string">'default'</span>: &#123;</div><div class="line">        <span class="string">'ENGINE'</span>: <span class="string">'django.db.backends.mysql'</span>,</div><div class="line">        <span class="string">'NAME'</span>: <span class="string">'django'</span>,</div><div class="line">        <span class="string">'USER'</span>: <span class="string">'django'</span>,</div><div class="line">        <span class="string">'PASSWORD'</span>: <span class="string">'django'</span>,</div><div class="line">        <span class="string">'HOST'</span>: <span class="string">'127.0.0.1'</span>,</div><div class="line">        <span class="string">'PORT'</span>: <span class="string">'3306'</span>,</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>数据库更新：<br>一般情况下，我们使用如下两个命令更新数据库</p>
<p><code>python manage.py makemigrations</code> #生成数据库模型文件</p>
<p><code>python manage.py migrate</code> #执行模型文件</p>
<p>或者：<br><code>python  manage.py migrate --database=users</code> #指定数据库，默认为default</p>
<p>如果由于默写原因删除了数据库中对应的表，则再次执行上面的命令是不能重新创建成功的，原因是每次django执行模型文件时都会在django_migrations表中新增对应的log记录，删掉对应的log记录即可重新执行成功。</p>
<h2 id="9-多数据源配置"><a href="#9-多数据源配置" class="headerlink" title="9.多数据源配置"></a>9.多数据源配置</h2><p>django配置连接多个数据库，自定义表名称：<br><a href="https://www.cnblogs.com/dreamer-fish/p/5469141.html" target="_blank" rel="noopener">https://www.cnblogs.com/dreamer-fish/p/5469141.html</a></p>
<p>使用models文件夹维护model时，一定要在其下的<strong>init</strong>.py中添加对model的引用，<br>否则<code>python manage.py makemigrations</code> 命令不会创建出对应的迁移文件<br>比如：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> .person <span class="keyword">import</span> Person</div><div class="line"><span class="keyword">from</span> .user <span class="keyword">import</span> User</div><div class="line"><span class="keyword">from</span> .identity_card <span class="keyword">import</span> IdentityCard</div><div class="line"><span class="keyword">from</span> .car <span class="keyword">import</span> Car</div></pre></td></tr></table></figure></p>
<p>数据库路由:<br>settings.py:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">DATABASE_ROUTERS = [<span class="string">'django2.router.django2_router.Django2Router'</span>, ]</div></pre></td></tr></table></figure></p>
<p>可以将对应的迁移文件的sql导入到指定的db，所以路由器的设置很重要<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">allow_migrate</span><span class="params">(self, db, app_label, model_name=None, **hints)</span>:</span></div><div class="line">    <span class="keyword">if</span> db == <span class="string">'django2_db'</span>:  <span class="comment">#如果指定了数据库</span></div><div class="line">        <span class="keyword">return</span> app_label == <span class="string">'django2'</span> <span class="comment">#并且model被设置了正确的app_label，则可以执行迁移文件</span></div><div class="line">    <span class="keyword">elif</span> app_label == <span class="string">'django2'</span>:</div><div class="line">        <span class="keyword">return</span> <span class="keyword">False</span></div></pre></td></tr></table></figure></p>
<p>设置好数据库路由器后，执行python manage.py migrate –database=django2_db</p>
<h2 id="10-缓存"><a href="#10-缓存" class="headerlink" title="10.缓存"></a>10.缓存</h2><p>说明：不推荐使用站点级缓存和页面级缓存，除非是展示信息类的网站，如果是频繁修改的站点，最好手工在代码中维护缓存。</p>
<p>1).memcached</p>
<p><code>brew install memcached</code></p>
<p>启动：<code>memcached -d -p 11211 -c 1024 -m 64</code></p>
<p>-d:后台运行<br>-p:端口<br>-c:最大连接数<br>-m:最多分配内存</p>
<p>1.使用memcached：<code>pip install python-memcached</code></p>
<p>2.settings</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 缓存设置</span></div><div class="line">CACHES = &#123;</div><div class="line">    <span class="string">'default'</span>: &#123;</div><div class="line">        <span class="string">'BACKEND'</span>: <span class="string">'django.core.cache.backends.memcached.MemcachedCache'</span>,</div><div class="line">        <span class="string">'LOCATION'</span>: <span class="string">'127.0.0.1:11211'</span>,</div><div class="line">        <span class="string">'TIMEOUT'</span>: <span class="number">600</span>,  <span class="comment"># 单位秒，默认300s, 60s * 10 = 10min</span></div><div class="line">        <span class="string">'KEY_PREFIX'</span>: <span class="string">'myapp'</span>,  <span class="comment"># 缓存键的字符串前缀</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>3.代码中<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> django.core.cache <span class="keyword">import</span> caches</div><div class="line">cache = caches[<span class="string">'default'</span>]</div></pre></td></tr></table></figure></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#如果希望使用默认的default，也可以</span></div><div class="line"><span class="keyword">from</span> django.core.cache <span class="keyword">import</span> cache</div><div class="line"></div><div class="line">cache.set(<span class="string">'user_list'</span>, user_list)</div><div class="line">user_list = cache.get(<span class="string">'user_list'</span>)</div><div class="line">user_list = cache.delete(<span class="string">'user_list'</span>)</div></pre></td></tr></table></figure>
<p>2).redis</p>
<p>参考资料：<a href="http://django-redis-chs.readthedocs.io/zh_CN/latest/" target="_blank" rel="noopener">http://django-redis-chs.readthedocs.io/zh_CN/latest/</a></p>
<p>1.<code>brew install redis</code></p>
<p>启动：<code>redis-server /usr/local/etc/redis.conf</code></p>
<p>2.<code>pip install django-redis</code></p>
<p>3.settings<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 缓存设置</span></div><div class="line">CACHES = &#123;</div><div class="line">    <span class="string">'default'</span>: &#123;</div><div class="line">        <span class="string">'BACKEND'</span>: <span class="string">'django.core.cache.backends.memcached.MemcachedCache'</span>,</div><div class="line">        <span class="string">'LOCATION'</span>: <span class="string">'127.0.0.1:11211'</span>,</div><div class="line">        <span class="string">'TIMEOUT'</span>: <span class="number">600</span>,  <span class="comment"># 单位秒，默认300s, 60s * 10 = 10min</span></div><div class="line">        <span class="string">'KEY_PREFIX'</span>: <span class="string">'myapp'</span>,  <span class="comment"># 缓存键的字符串前缀</span></div><div class="line">    &#125;,</div><div class="line">    <span class="string">"redis"</span>: &#123;</div><div class="line">        <span class="string">"BACKEND"</span>: <span class="string">"django_redis.cache.RedisCache"</span>,</div><div class="line">        <span class="string">"LOCATION"</span>: <span class="string">"redis://127.0.0.1:6379/1"</span>,</div><div class="line">        <span class="string">'TIMEOUT'</span>: <span class="number">600</span>,</div><div class="line">        <span class="string">"OPTIONS"</span>: &#123;</div><div class="line">            <span class="string">"CLIENT_CLASS"</span>: <span class="string">"django_redis.client.DefaultClient"</span>,</div><div class="line">            <span class="string">"SOCKET_CONNECT_TIMEOUT"</span>: <span class="number">5</span>,  <span class="comment"># in seconds socket 建立连接超时设置</span></div><div class="line">            <span class="string">"SOCKET_TIMEOUT"</span>: <span class="number">5</span>,  <span class="comment"># in seconds 连接建立后的读写操作超时设置</span></div><div class="line">            <span class="string">"COMPRESSOR"</span>: <span class="string">"django_redis.compressors.zlib.ZlibCompressor"</span>,  <span class="comment"># 压缩支持</span></div><div class="line">            <span class="string">"IGNORE_EXCEPTIONS"</span>: <span class="keyword">True</span>,  <span class="comment"># 如果redis服务关闭，不会引起异常，memcached默认支持</span></div><div class="line">            <span class="string">"CONNECTION_POOL_KWARGS"</span>: &#123;<span class="string">"max_connections"</span>: <span class="number">100</span>&#125;  <span class="comment"># 连接池</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment"># redis记录异常日志</span></div><div class="line">DJANGO_REDIS_LOG_IGNORED_EXCEPTIONS = <span class="keyword">True</span></div></pre></td></tr></table></figure></p>
<p>4.代码中<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> django.core.cache <span class="keyword">import</span> caches</div><div class="line">redis_cache = caches[<span class="string">'redis'</span>]</div><div class="line"></div><div class="line">redis_cache.set(<span class="string">'user_list'</span>, user_list)</div><div class="line">user_list = redis_cache.get(<span class="string">'user_list'</span>)</div><div class="line">user_list = redis_cache.delete(<span class="string">'user_list'</span>)</div></pre></td></tr></table></figure></p>
<h2 id="11-注册模板自定义方法"><a href="#11-注册模板自定义方法" class="headerlink" title="11.注册模板自定义方法:"></a>11.注册模板自定义方法:</h2><p>1.创建myapp.libraries.utils.py<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> django <span class="keyword">import</span> template</div><div class="line">register = template.Library()</div><div class="line">color = ((<span class="number">1</span>, <span class="string">'red'</span>), (<span class="number">2</span>, <span class="string">'black'</span>), (<span class="number">3</span>, <span class="string">'blue'</span>))</div><div class="line"></div><div class="line"><span class="comment"># @register.filter使用方法，最多两个参数</span></div><div class="line"><span class="comment"># &#123;&#123; car.carColor|getcolorstr &#125;&#125;</span></div><div class="line"><span class="comment"># &#123;&#123; car.carColor|getcolorstr:param2 &#125;&#125; 前面的表示第一个参数</span></div><div class="line"><span class="meta">@register.filter</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">getcolorstr</span><span class="params">(colorNum)</span>:</span></div><div class="line">    <span class="keyword">return</span> color[colorNum - <span class="number">1</span>][<span class="number">1</span>]</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># @register.simple_tag使用方法，不限制参数个数</span></div><div class="line"><span class="comment"># &#123;% getcolorstr2 car.carColor %&#125;</span></div><div class="line"><span class="comment"># &#123;% getcolorstr2 param1 param2 param3 %&#125;</span></div><div class="line"><span class="meta">@register.simple_tag</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">getcolorstr2</span><span class="params">(colorNum)</span>:</span></div><div class="line">    <span class="keyword">return</span> color[colorNum - <span class="number">1</span>][<span class="number">1</span>]</div></pre></td></tr></table></figure></p>
<p>2.settings:在模板配置中加入libraries配置<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">TEMPLATES = [</div><div class="line">    &#123;</div><div class="line">        <span class="string">'BACKEND'</span>: <span class="string">'django.template.backends.django.DjangoTemplates'</span>,</div><div class="line">        <span class="string">'DIRS'</span>: [os.path.join(BASE_DIR, <span class="string">'templates'</span>)]</div><div class="line">        ,</div><div class="line">        <span class="string">'APP_DIRS'</span>: <span class="keyword">True</span>,</div><div class="line">        <span class="string">'OPTIONS'</span>: &#123;</div><div class="line">            <span class="string">'context_processors'</span>: [</div><div class="line">                <span class="string">'django.template.context_processors.debug'</span>,</div><div class="line">                <span class="string">'django.template.context_processors.request'</span>,</div><div class="line">                <span class="string">'django.contrib.auth.context_processors.auth'</span>,</div><div class="line">                <span class="string">'django.contrib.messages.context_processors.messages'</span>,</div><div class="line">            ],</div><div class="line">            <span class="string">'libraries'</span>: &#123;  <span class="comment"># Adding this section should work around the issue.</span></div><div class="line">                <span class="string">'utils'</span>: <span class="string">'myapp.libraries.utils'</span>,</div><div class="line">            &#125;,</div><div class="line">        &#125;,</div><div class="line">    &#125;,</div><div class="line">]</div></pre></td></tr></table></figure></p>
<p>3.模板页面中使用<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&#123;% load utils %&#125;</div><div class="line">&#123;&#123; car.carColor|getcolorstr &#125;&#125;</div><div class="line">&#123;% getcolorstr2 car.carColor %&#125;</div></pre></td></tr></table></figure></p>
<h2 id="12-模板"><a href="#12-模板" class="headerlink" title="12.模板"></a>12.模板</h2><p>1.转义:<br>由于模板系统没有“转义”的概念，为了显示模板标签中使用的一个位，必须使用{％ templatetag ％}标记。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">论据 输出</div><div class="line">openblock &#123;％</div><div class="line">closeblock ％&#125;</div><div class="line">openvariable &#123;&#123;</div><div class="line">closevariable &#125;&#125;</div><div class="line">openbrace &#123;</div><div class="line">closebrace &#125;</div><div class="line">opencomment &#123;＃</div><div class="line">closecomment ＃&#125;</div></pre></td></tr></table></figure></p>
<p>例如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;% templatetag openblock %&#125; url &apos;entry_list&apos; &#123;% templatetag closeblock %&#125;</div></pre></td></tr></table></figure></p>
<p>或者使用如下方式：被包含的内容不会被模板引擎转意，将直接输出<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&#123;% verbatim myblock %&#125;</div><div class="line">    Avoid template rendering via the &#123;% verbatim %&#125;&#123;% endverbatim %&#125; block.</div><div class="line">&#123;% endverbatim myblock %&#125;</div></pre></td></tr></table></figure></p>
<p>2.for:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">变量 描述</div><div class="line">forloop.counter 循环的当前迭代（1索引）</div><div class="line">forloop.counter0 循环的当前迭代（0索引）</div><div class="line">forloop.revcounter 循环结束的迭代次数（1索引）</div><div class="line">forloop.revcounter0 循环结束的迭代次数（0索引）</div><div class="line">forloop.first 如果这是第一次通过循环，则为真</div><div class="line">forloop.last 如果这是最后一次循环，则为真</div><div class="line">forloop.parentloop 对于嵌套循环，这是围绕当前循环的循环</div></pre></td></tr></table></figure></p>
<h2 id="13-自定义400、403、404、500页面"><a href="#13-自定义400、403、404、500页面" class="headerlink" title="13.自定义400、403、404、500页面"></a>13.自定义400、403、404、500页面</h2><p>1.settings.py中DEBUG = False，否则自定义页面不起作用</p>
<p>2.在任意模块下的views.py中增加如下方法，也可以在主模块中创建一个views.py<br>方法处理逻辑可以参考：~venv/lib/python3.6/site-packages/django/views/defaults.py中对各个方法的定义<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">bad_request</span><span class="params">(request, exception, template_name=<span class="string">'400.html'</span>)</span>:</span></div><div class="line">    <span class="keyword">return</span> render(request, template_name)</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">permission_denied</span><span class="params">(request, exception, template_name=<span class="string">'403.html'</span>)</span>:</span></div><div class="line">    <span class="keyword">return</span> render(request, template_name)</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">page_not_found</span><span class="params">(request, exception, template_name=<span class="string">'404.html'</span>)</span>:</span></div><div class="line">    context = &#123;<span class="string">'exception'</span>: exception&#125;</div><div class="line">    <span class="keyword">return</span> render(request, template_name, context=context)</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">server_error</span><span class="params">(request, template_name=<span class="string">'500.html'</span>)</span>:</span></div><div class="line">    <span class="keyword">return</span> render(request, template_name)</div></pre></td></tr></table></figure></p>
<p>3.在项目根目录下的templates下创建对应的400.html、403.html、404.html、500.html，内容更加需要自定义，也可以参考~venv/lib/python3.6/site-packages/django/views/templates下的对应文件</p>
<p>4.在主模块下urls.py中增加如下配置:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">handler400 = <span class="string">'DjangoHelloWorld.views.bad_request'</span> <span class="comment">#模块名称.views.方法名称</span></div><div class="line">handler403 = <span class="string">'DjangoHelloWorld.views.permission_denied'</span></div><div class="line">handler404 = <span class="string">'DjangoHelloWorld.views.page_not_found'</span></div><div class="line">handler500 = <span class="string">'DjangoHelloWorld.views.server_error'</span></div></pre></td></tr></table></figure></p>
<h2 id="14-Django配置session超时"><a href="#14-Django配置session超时" class="headerlink" title="14.Django配置session超时"></a>14.Django配置session超时</h2><p>#配置失效时间为半个小时<br>SESSION_COOKIE_AGE = 60*30</p>
<p>#关闭浏览器清除cookie<br>SESSION_EXPIRE_AT_BROWSER_CLOSE = True</p>
<h2 id="15-json与xml"><a href="#15-json与xml" class="headerlink" title="15.json与xml"></a>15.json与xml</h2><p>1.json<br>创建一个JSONUtil工具类，用于返回json数据<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> json</div><div class="line"><span class="keyword">from</span> django.core.serializers <span class="keyword">import</span> serialize, deserialize</div><div class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</div><div class="line"><span class="keyword">from</span> django.db.models.query <span class="keyword">import</span> QuerySet</div><div class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> JsonResponse</div><div class="line"></div><div class="line"><span class="comment"># 反序列化</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">json_to_list</span><span class="params">(json)</span>:</span></div><div class="line">    <span class="keyword">if</span> json[<span class="number">0</span>] == <span class="string">'['</span>:</div><div class="line">        deserializedObjectList = deserialize(<span class="string">'json'</span>, json)</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        deserializedObjectList = deserialize(<span class="string">'json'</span>, <span class="string">'['</span> + json + <span class="string">']'</span>)</div><div class="line">    list = []</div><div class="line">    <span class="keyword">for</span> deserializedObject <span class="keyword">in</span> deserializedObjectList:</div><div class="line">        list.append(deserializedObject.object)</div><div class="line">    <span class="keyword">return</span> list</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># 序列化</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">to_json</span><span class="params">(obj)</span>:</span></div><div class="line">    <span class="keyword">if</span> isinstance(obj, models.Model):</div><div class="line">        obj = [obj]  <span class="comment"># 因为serialize只支持可迭代对象，比如querySet对象</span></div><div class="line">    data = serialize(<span class="string">"json"</span>, obj)</div><div class="line">    <span class="keyword">return</span> data</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># 该方法没有做严格的验证，只支持dict,models.Model,models.QuerySet，可以根据需要自行扩展</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">render_json</span><span class="params">(data, dict_key=<span class="string">'data'</span>, **response_kwargs)</span>:</span></div><div class="line">    <span class="keyword">if</span> isinstance(data, dict):</div><div class="line">        <span class="keyword">return</span> JsonResponse(data)</div><div class="line">    data = to_json(data)</div><div class="line">    <span class="keyword">if</span> <span class="string">'safe'</span> <span class="keyword">in</span> response_kwargs <span class="keyword">and</span> response_kwargs[<span class="string">'safe'</span>] <span class="keyword">is</span> <span class="keyword">False</span>:</div><div class="line">        <span class="keyword">pass</span></div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        data = &#123;dict_key: data&#125;  <span class="comment"># 默认必须传递字典数据</span></div><div class="line">    <span class="keyword">if</span> isinstance(data, str):  <span class="comment"># 由于非字典类型的数据会被当做字符串处理，即返回结果两边都有引号，所以此处将其转换为对象，否则ajax调用时不方便处理</span></div><div class="line">        data = json.loads(data)</div><div class="line">    <span class="keyword">return</span> JsonResponse(data, **response_kwargs)</div></pre></td></tr></table></figure></p>
<p>view.py中：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">user_query_json</span><span class="params">(request)</span>:</span></div><div class="line">    user_list = User.objects.all()</div><div class="line">    <span class="keyword">return</span> JSONUtil.render_json(user_list, safe=<span class="keyword">False</span>) <span class="comment"># safe=False可以传递对象，否则必须传递一个dict，ajax请求时这样要设置safe=False，这样页面可以直接获取到对象</span></div></pre></td></tr></table></figure></p>
<p>返回结果，可以看到两边没有引号：<br>[{“model”: “myapp.user”, “pk”: 4, “fields”: {“name”: “\u54c8\u54c8”, “birth_day”: “2018-04-09”, “phone”: “None”, “email”: “None”}}, {“model”: “myapp.user”, “pk”: 9, “fields”: {“name”: “\u5929\u738b\u5c71”, “birth_day”: “2018-09-10”, “phone”: “123”, “email”: “123@123.com”}}]</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">user_query_json_get</span><span class="params">(request, user_id)</span>:</span></div><div class="line">    user = User.objects.get(pk=user_id)</div><div class="line">    <span class="comment"># user = User.objects.filter(pk=user_id)</span></div><div class="line">    <span class="keyword">return</span> JSONUtil.render_json(user, dict_key=<span class="string">'user'</span>, safe=<span class="keyword">True</span>)</div></pre></td></tr></table></figure>
<p>返回结果：[{“model”: “myapp.user”, “pk”: 1, “fields”: {“name”: “\u97e9\u7fa4\u5cf0”, “birth_day”: “2018-04-07”, “phone”: “None”, “email”: “qunfeng_han@126.com”}}]</p>
<p>模板中：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'polls/js/jquery-1.11.0.min.js' %&#125;"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span> #注意这里必须有闭合标签<span class="tag">&lt;/<span class="name">script</span>&gt;</span>，否则显示会有问题</div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"userdiv"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"userlistdiv"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="xml"></span></div><div class="line"></div><div class="line">    $.getJSON("&#123;% url 'myapp:user_query_json_get' 1 %&#125;", function(ret) &#123;</div><div class="line">        $.each(ret, function (key, value) &#123;</div><div class="line">            // key 为字典的 key，value 为对应的值</div><div class="line">            $("#userdiv").append(value.pk+"#"+value.fields.name+"#"+value.fields.birth_day+"#"+value.fields.phone+"#"+value.fields.email+"<span class="tag">&lt;<span class="name">br</span>&gt;</span>")</div><div class="line"></div><div class="line">        &#125;);</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    $.getJSON("&#123;% url 'myapp:user_query_json' %&#125;", function(ret) &#123;</div><div class="line">        $.each(ret, function (key, value) &#123;</div><div class="line">            // key 为字典的 key，value 为对应的值</div><div class="line">            $("#userlistdiv").append(value.pk+"#"+value.fields.name+"#"+value.fields.birth_day+"#"+value.fields.phone+"#"+value.fields.email+"<span class="tag">&lt;<span class="name">br</span>&gt;</span>")</div><div class="line"></div><div class="line">        &#125;);</div><div class="line">    &#125;)</div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>2.xml</p>
<p>XMLUtil.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># -*- coding=utf-8 -*-</span></div><div class="line"><span class="keyword">from</span> django.core <span class="keyword">import</span> serializers</div><div class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</div><div class="line"><span class="keyword">from</span> django.db.models.query <span class="keyword">import</span> QuerySet</div><div class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">render_xml</span><span class="params">(data)</span>:</span></div><div class="line">    data = to_xml(data)</div><div class="line">    response = HttpResponse(data)</div><div class="line">    response[<span class="string">'Content-Type'</span>] = <span class="string">'application/xml'</span></div><div class="line">    <span class="keyword">return</span> response</div><div class="line"></div><div class="line"><span class="comment"># 序列化</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">to_xml</span><span class="params">(data)</span>:</span></div><div class="line">    <span class="keyword">if</span> isinstance(data, models.Model):</div><div class="line">        data = [data]  <span class="comment"># 因为serialize只支持可迭代对象，比如querySet对象</span></div><div class="line">    <span class="keyword">elif</span> isinstance(data, QuerySet):</div><div class="line">        data = data</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">pass</span></div><div class="line">    data = serializers.serialize(<span class="string">"xml"</span>, data)</div><div class="line">    <span class="keyword">return</span> data</div><div class="line"></div><div class="line"><span class="comment"># 反序列化</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">xml_to_list</span><span class="params">(xml)</span>:</span></div><div class="line">    deserializedObjectList = serializers.deserialize(<span class="string">"xml"</span>, xml)</div><div class="line">    list = []</div><div class="line">    <span class="keyword">for</span> deserializedObject <span class="keyword">in</span> deserializedObjectList:</div><div class="line">        list.append(deserializedObject.object)</div><div class="line">    <span class="keyword">return</span> list</div></pre></td></tr></table></figure>
<p>views.py<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> utils <span class="keyword">import</span> XMLUtil</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">user_query_xml</span><span class="params">(request)</span>:</span></div><div class="line">    user_list = User.objects.all()</div><div class="line">    <span class="keyword">return</span> XMLUtil.render_xml(user_list)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">user_query_xml_get</span><span class="params">(request, user_id)</span>:</span></div><div class="line">    user = User.objects.get(pk=user_id)</div><div class="line">    <span class="keyword">return</span> XMLUtil.render_xml(user)</div></pre></td></tr></table></figure></p>
<p>输出结果<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">django-objects</span> <span class="attr">version</span>=<span class="string">"1.0"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">object</span> <span class="attr">model</span>=<span class="string">"myapp.user"</span> <span class="attr">pk</span>=<span class="string">"4"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">"name"</span> <span class="attr">type</span>=<span class="string">"CharField"</span>&gt;</span>哈哈<span class="tag">&lt;/<span class="name">field</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">"birth_day"</span> <span class="attr">type</span>=<span class="string">"DateField"</span>&gt;</span>2018-04-09<span class="tag">&lt;/<span class="name">field</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">"phone"</span> <span class="attr">type</span>=<span class="string">"CharField"</span>&gt;</span>13800138000<span class="tag">&lt;/<span class="name">field</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">"email"</span> <span class="attr">type</span>=<span class="string">"CharField"</span>&gt;</span>138@qq.com<span class="tag">&lt;/<span class="name">field</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">object</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">object</span> <span class="attr">model</span>=<span class="string">"myapp.user"</span> <span class="attr">pk</span>=<span class="string">"2"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">"name"</span> <span class="attr">type</span>=<span class="string">"CharField"</span>&gt;</span>张三<span class="tag">&lt;/<span class="name">field</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">"birth_day"</span> <span class="attr">type</span>=<span class="string">"DateField"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">None</span>&gt;</span><span class="tag">&lt;/<span class="name">None</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">field</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">"phone"</span> <span class="attr">type</span>=<span class="string">"CharField"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">None</span>&gt;</span><span class="tag">&lt;/<span class="name">None</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">field</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">"email"</span> <span class="attr">type</span>=<span class="string">"CharField"</span>&gt;</span>zhansan@163.com<span class="tag">&lt;/<span class="name">field</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">object</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">django-objects</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>js:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">$.ajax(&#123;</div><div class="line">    <span class="attr">url</span>:<span class="string">"&#123;% url 'myapp:user_query_xml' %&#125;"</span>,</div><div class="line">    <span class="attr">type</span>:<span class="string">"GET"</span>,</div><div class="line">    <span class="attr">dataType</span>:<span class="string">'xml'</span>,</div><div class="line">    <span class="attr">success</span>:<span class="function"><span class="keyword">function</span>(<span class="params">xml</span>)</span>&#123;</div><div class="line">        $(xml).find(<span class="string">"object"</span>).each(<span class="function"><span class="keyword">function</span>(<span class="params">i</span>) </span>&#123;</div><div class="line">            <span class="comment">//获取id</span></div><div class="line">            <span class="keyword">var</span> id=$(<span class="keyword">this</span>).attr(<span class="string">"pk"</span>);</div><div class="line">            <span class="keyword">var</span> content = <span class="string">""</span>;</div><div class="line">            $(<span class="keyword">this</span>).find(<span class="string">"field"</span>).each(<span class="function"><span class="keyword">function</span>(<span class="params">j</span>)</span>&#123;</div><div class="line">                content += $(<span class="keyword">this</span>).attr(<span class="string">'name'</span>) + <span class="string">"=="</span> + $(<span class="keyword">this</span>).text() + <span class="string">"#"</span></div><div class="line">            &#125;)</div><div class="line">            $(<span class="string">"#userdivxml"</span>).append(id+ <span class="string">"#"</span> + content +<span class="string">"&lt;br&gt;"</span>)</div><div class="line"></div><div class="line">        &#125;);</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">error</span>:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123; alert(<span class="string">"加载失败"</span>); &#125;</div><div class="line">&#125;)</div></pre></td></tr></table></figure></p>
<h2 id="16-response添加相应头"><a href="#16-response添加相应头" class="headerlink" title="16.response添加相应头"></a>16.response添加相应头</h2><p>一般我们返回视图时都是调用<br>from django.shortcuts import render的render(request, ‘myapp/user/index.html’, context)<br>实际上它返回的是一个HttpResponse对象，我们可以这样为其添加返回头<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">response = render(request, <span class="string">'myapp/user/index.html'</span>, context)</div><div class="line">response[<span class="string">'Last-Modified'</span>] = date.strftime(<span class="string">'%a, %d %b %Y %H:%M:%S GMT'</span>)</div><div class="line"><span class="keyword">return</span> response</div></pre></td></tr></table></figure></p>
<h2 id="17-多语言"><a href="#17-多语言" class="headerlink" title="17.多语言"></a>17.多语言</h2><p>参考：<a href="https://code.ziqiangxuetang.com/django/django-internationalization.html" target="_blank" rel="noopener">https://code.ziqiangxuetang.com/django/django-internationalization.html</a></p>
<p>1.<code>brew install gettext</code></p>
<p>2.pip的bug，需要手工处理<br>/venv/lib/python3.6/site-packages/pip-9.0.1-py3.6.egg/pip/_vendor/webencodings/<br>修改3个文件：<br><strong>init</strong>.py，<br>tests.py，<br>x_user_defined.py，<br>将：utf8 修改为 utf-8.<br>3.settings.py<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">LANGUAGE_CODE = <span class="string">'zh-hans'</span>  <span class="comment"># 英文是en，这里是中文，注意这里必须配置为zh-hans，而下面创建和编译语言文件是要使用zh_hans</span></div><div class="line">USE_I18N = <span class="keyword">True</span></div><div class="line">LOCALE_PATHS = (</div><div class="line">    os.path.join(BASE_DIR, <span class="string">'myapp/locale'</span>), <span class="comment"># 应用下的路径</span></div><div class="line">    os.path.join(BASE_DIR, <span class="string">'locale'</span>),</div><div class="line">)</div></pre></td></tr></table></figure></p>
<p>注意：这里『locale』文件夹需要手工创建，默认就是项目根路径下的locale目录。<br>这里需要注意一点，如果应用下面创建了locale并且配置到LOCALE_PATHS中，则后面执行创建命令时，无论是在项目根路径下执行还是在应用下执行，都只会将语言文件创建到应用下的locale中。如果应用下没用locale目录则需要在项目根路径下执行命令，并且创建到项目根路径下的locale目录中。</p>
<p>4.在代码中加入一些多语言对应的内容<br>代码中<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> django.utils.translation <span class="keyword">import</span> ugettext <span class="keyword">as</span> _</div><div class="line"> output = _(<span class="string">'Today is %(month)s %(day)s.'</span>) % &#123;<span class="string">'month'</span>: m, <span class="string">'day'</span>: d&#125;</div></pre></td></tr></table></figure></p>
<p>模板页面中可以直接使用下划线的别名形式<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&#123;&#123; _('Django site admin') &#125;&#125;<span class="tag">&lt;<span class="name">br</span>&gt;</span></div><div class="line">&#123;&#123; _('my test local') &#125;&#125;<span class="tag">&lt;<span class="name">br</span>&gt;</span></div></pre></td></tr></table></figure></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">这里注意，如果要使用『trans』标签，必须在页面中加载 i18n</div><div class="line">&#123;% load i18n %&#125;</div><div class="line">&#123;% trans "my test local" %&#125;<span class="tag">&lt;<span class="name">br</span>&gt;</span></div><div class="line"></div><div class="line">&#123;#将翻译结果保存到变量中#&#125;</div><div class="line">&#123;% trans "my test local" as mylocal %&#125;</div><div class="line">&#123;&#123; mylocal &#125;&#125;<span class="tag">&lt;<span class="name">br</span>&gt;</span></div><div class="line"></div><div class="line">&#123;#设置局部显示的语言，下面的内容将显示对应的英文内容，但只在区块内有效#&#125;</div><div class="line">&#123;% language 'en' %&#125;</div><div class="line">    &#123;% get_current_language as LANGUAGE_CODE %&#125;</div><div class="line">    Current language: &#123;&#123; LANGUAGE_CODE &#125;&#125; <span class="tag">&lt;<span class="name">br</span>&gt;</span>  #区块内显示en</div><div class="line">    &#123;&#123; _('Django site admin') &#125;&#125;<span class="tag">&lt;<span class="name">br</span>&gt;</span></div><div class="line">&#123;% endlanguage %&#125;</div><div class="line"></div><div class="line">&#123;% get_current_language as LANGUAGE_CODE %&#125;</div><div class="line">    Current language: &#123;&#123; LANGUAGE_CODE &#125;&#125; <span class="tag">&lt;<span class="name">br</span>&gt;</span>  #区块外显示zh-hans</div></pre></td></tr></table></figure>
<p>如果没有找到对应的key值，则会直接显示待翻译的key值字符串；<br>如果对应的语言包下没有找到key值，而默认语言包下有对应的key值，则会显示默认的语言，如LANGUAGE_CODE = ‘zh-hans’</p>
<p>PS:如果需要翻译的内容包含变量，比如_(‘Today is %(month)s %(day)s.’) ，最好在后台处理好后做为变量传递到模板页面上，目前暂不知道如何在模板中直接处理。</p>
<p>5.创建或更新语言文件</p>
<p><code>django-admin makemessages -l en</code> # 英文</p>
<p><code>django-admin makemessages -l zh_hans</code> #指定中文语言，注意这里不要写成zh-hans</p>
<p>会在locale目录下生成对应的语言包django.po</p>
<p><code>django-admin makemessages -a</code> #全部语言</p>
<p>说明：如果在项目根路径下执行，会将项目中所有应用都扫描一遍并汇总合并到一起，如果在某个应用下执行命令，则只会扫描当前应用，并在其下的locale目录下创建文件，优先级根据settings中配置的LOCALE_PATHS的顺序而定。</p>
<p>6.编译</p>
<p><code>django-admin compilemessages --locale zh_hans</code> #指定语言</p>
<p><code>django-admin compilemessages</code> # 全部语言</p>
<ul>
<li>django.po—-&gt;diango.mo</li>
</ul>
<p>7.语言切换</p>
<p>1）在settings中的中间件配置中加入如下配置：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">MIDDLEWARE = [</div><div class="line">    <span class="string">'django.middleware.security.SecurityMiddleware'</span>,</div><div class="line">    <span class="string">'django.contrib.sessions.middleware.SessionMiddleware'</span>,</div><div class="line">    <span class="string">'django.middleware.locale.LocaleMiddleware'</span>,</div><div class="line">    <span class="string">'django.middleware.common.CommonMiddleware'</span>,</div><div class="line">    <span class="string">'django.middleware.csrf.CsrfViewMiddleware'</span>,</div><div class="line">    <span class="string">'django.contrib.auth.middleware.AuthenticationMiddleware'</span>,</div><div class="line">    <span class="string">'django.contrib.messages.middleware.MessageMiddleware'</span>,</div><div class="line">    <span class="string">'django.middleware.clickjacking.XFrameOptionsMiddleware'</span>,</div><div class="line">]</div></pre></td></tr></table></figure></p>
<p>2）url中加入配置：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">path(<span class="string">'i18n/'</span>, include(<span class="string">'django.conf.urls.i18n'</span>)), <span class="comment">#对应下面的&#123;% url 'set_language' %&#125;</span></div></pre></td></tr></table></figure></p>
<p>变更后的语言会保存在session中，可以通过<code>request.session[&#39;_language&#39;]</code>获得</p>
<p>3）在模板页面中需要切换语言的地方加入如下代码：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"&#123;% url 'set_language' %&#125;"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span>&#123;% csrf_token %&#125;</div><div class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"next"</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">value</span>=<span class="string">"&#123;&#123; redirect_to &#125;&#125;"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">name</span>=<span class="string">"language"</span>&gt;</span></div><div class="line">        &#123;% get_current_language as LANGUAGE_CODE %&#125;</div><div class="line">        &#123;% get_available_languages as LANGUAGES %&#125;</div><div class="line">        &#123;% get_language_info_list for LANGUAGES as languages %&#125;</div><div class="line">        &#123;% for language in languages %&#125;</div><div class="line">            <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">"&#123;&#123; language.code &#125;&#125;"</span>&#123;% <span class="attr">if</span> <span class="attr">language.code</span> == <span class="string">LANGUAGE_CODE</span> %&#125; <span class="attr">selected</span>&#123;% <span class="attr">endif</span> %&#125;&gt;</span></div><div class="line">                &#123;&#123; language.name_local &#125;&#125; (&#123;&#123; language.code &#125;&#125;)</div><div class="line">            <span class="tag">&lt;/<span class="name">option</span>&gt;</span></div><div class="line">        &#123;% endfor %&#125;</div><div class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"Go"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>说明：<br>redirect_to：如果不设置就会返回当前页面，设置的话就会跳转到设置的页面<br>这里get_available_languages会显示所有支持的语言，不过一般项目不会支持这么多的语言，所以可以在settings中增加配置来明确语言范围：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">LANGUAGES = (</div><div class="line">    (<span class="string">'en'</span>, (<span class="string">'English'</span>)),</div><div class="line">    (<span class="string">'zh-hans'</span>, (<span class="string">'中文简体'</span>)),</div><div class="line">    (<span class="string">'zh-hant'</span>, (<span class="string">'中文繁體'</span>)),</div><div class="line">)</div></pre></td></tr></table></figure></p>
<p>4）js中使用多语言<br>js需要单独处理，比如我们写了一个js文件，路径为project/myapp/static/myapp/js/test.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">a = gettext(<span class="string">'wwww hhhh'</span>)</div><div class="line">alert(a)</div></pre></td></tr></table></figure></p>
<p>模板中引入：</p>
<p>#下面这个是动态js，必须引入，否则gettext方法不起作用<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"&#123;% url 'javascript-catalog' %&#125;"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'myapp/js/test.js' %&#125;"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>urls加入对javascript-catalog的支持：<br>`path(‘jsi18n/‘, JavaScriptCatalog.as_view(), name=’javascript-catalog’),``</p>
<p>执行如下命令：</p>
<p><code>django-admin makemessages -d djangojs  -l zh_hans</code><br>此时会在应用下的locale中生成djangojs.po文件（如果配置了应用locale，否则会在项目下的locale中创建）</p>
<p><code>django-admin compilemessages --locale zh_hans</code><br>此时会将djangojs.po编译为djangojs.mo</p>
<p>如果直接将带翻译的js代码写在模板页面中，暂时不清楚要通过什么命令实现，不过可以有个折中的办法，就是创建一个js文件，然后将所有需要翻译的内容都加上，然后运行上面两个命令，这样django在运行模板中的js时同样可以完成翻译<br>模板中：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;script&gt;</div><div class="line">    alert(gettext(<span class="string">'hello js'</span>))</div><div class="line">    alert(gettext(<span class="string">'o my god'</span>))</div><div class="line">&lt;<span class="regexp">/script&gt;</span></div></pre></td></tr></table></figure></p>
<p>js中：只要js代码中出现翻译方法的地方都会被加入翻译，这个js不需要被任何模板引入，也不需要被同步到静态文件夹中，仅仅是为生成翻译文件而存在<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">gettext(<span class="string">'hello js'</span>)</div><div class="line">gettext(<span class="string">'o my god'</span>)</div></pre></td></tr></table></figure></p>
<h2 id="18-日志"><a href="#18-日志" class="headerlink" title="18.日志"></a>18.日志</h2><p>1.settings<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre></td><td class="code"><pre><div class="line">LOGGING = &#123;</div><div class="line">    <span class="string">'version'</span>: <span class="number">1</span>,</div><div class="line">    <span class="string">'disable_existing_loggers'</span>: <span class="keyword">False</span>,  <span class="comment"># 是否禁用logger，建议设置为False</span></div><div class="line">    <span class="string">'formatters'</span>: &#123;  <span class="comment"># 日志格式，提供给handler使用，非必须，如果不设置格式，默认只会打印消息体</span></div><div class="line">        <span class="string">'verbose'</span>: &#123;  <span class="comment"># 格式名称</span></div><div class="line">            <span class="comment"># INFO 2018-04-25 15:43:27,586 views 8756 123145350217728 这是一个日志</span></div><div class="line">            <span class="string">'format'</span>: <span class="string">'%(levelname)s %(asctime)s %(module)s %(process)d %(thread)d %(message)s'</span></div><div class="line">        &#125;,</div><div class="line">        <span class="string">'simple'</span>: &#123;</div><div class="line">            <span class="comment"># INFO  这是一个日志</span></div><div class="line">            <span class="string">'format'</span>: <span class="string">'%(levelname)s %(message)s'</span></div><div class="line">        &#125;,</div><div class="line">        <span class="string">'standard'</span>: &#123;</div><div class="line">            <span class="comment"># 2018-04-25 16:40:00,195 [Thread-7:123145575223296] [myapp.log:282] [views:user_query_json_get] [INFO]- 这是一个日志</span></div><div class="line">            <span class="string">'format'</span>: <span class="string">'%(asctime)s [%(threadName)s:%(thread)d] [%(name)s:%(lineno)d] [%(module)s:%(funcName)s] [%(levelname)s]- %(message)s'</span></div><div class="line">        &#125;,</div><div class="line"></div><div class="line">    &#125;,</div><div class="line">    <span class="string">'filters'</span>: &#123;  <span class="comment"># 过滤器，提供给handler使用，非必须</span></div><div class="line">        <span class="string">'require_debug_true'</span>: &#123;  <span class="comment"># 要求DEBUG=True时才打印日志</span></div><div class="line">            <span class="string">'()'</span>: <span class="string">'django.utils.log.RequireDebugTrue'</span>,</div><div class="line">        &#125;,</div><div class="line">    &#125;,</div><div class="line">    <span class="string">'handlers'</span>: &#123;  <span class="comment"># 处理器，设置日志记录方式，必须</span></div><div class="line">        <span class="string">'console'</span>: &#123;  <span class="comment"># 处理器名称</span></div><div class="line">            <span class="string">'level'</span>: <span class="string">'DEBUG'</span>,  <span class="comment"># 设置级别</span></div><div class="line">            <span class="string">'filters'</span>: [<span class="string">'require_debug_true'</span>],  <span class="comment"># 设置过滤器，多个用逗号分割</span></div><div class="line">            <span class="string">'class'</span>: <span class="string">'logging.StreamHandler'</span>,  <span class="comment"># 处理器，这里是控制台打印</span></div><div class="line">            <span class="string">'formatter'</span>: <span class="string">'verbose'</span>  <span class="comment"># 设置日志格式</span></div><div class="line">        &#125;,</div><div class="line">        <span class="string">'file'</span>: &#123;</div><div class="line">            <span class="string">'level'</span>: <span class="string">'DEBUG'</span>,</div><div class="line">            <span class="string">'class'</span>: <span class="string">'logging.FileHandler'</span>,  <span class="comment"># 记录到文件</span></div><div class="line">            <span class="string">'filename'</span>: <span class="string">'/Users/hanqunfeng/python_workspace/log/file.log'</span>,</div><div class="line">            <span class="string">'formatter'</span>: <span class="string">'verbose'</span></div><div class="line">        &#125;,</div><div class="line">        <span class="string">'rotatingFile'</span>: &#123;</div><div class="line">            <span class="string">'level'</span>: <span class="string">'DEBUG'</span>,</div><div class="line">            <span class="string">'class'</span>: <span class="string">'logging.handlers.RotatingFileHandler'</span>,  <span class="comment"># 按文件大小切割日志</span></div><div class="line">            <span class="comment"># 'filename': 'log/all.log',  # 日志输出文件 默认在当前项目根路径下</span></div><div class="line">            <span class="string">'filename'</span>: <span class="string">'/Users/hanqunfeng/python_workspace/log/rotatingFile.log'</span>,  <span class="comment"># 日志输出文件</span></div><div class="line">            <span class="string">'maxBytes'</span>: <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">5</span>,  <span class="comment"># 每个文件大小</span></div><div class="line">            <span class="string">'backupCount'</span>: <span class="number">5</span>,  <span class="comment"># 保留日志份数，只保留最后5份，如果都保留，设置为0，默认就是0</span></div><div class="line">            <span class="string">'formatter'</span>: <span class="string">'standard'</span>,  <span class="comment"># 使用哪种formatters日志格式</span></div><div class="line">        &#125;,</div><div class="line">		<span class="string">'timedRotatingFile'</span>: &#123;</div><div class="line">		    <span class="string">'level'</span>: <span class="string">'DEBUG'</span>,</div><div class="line">		    <span class="string">'class'</span>: <span class="string">'logging.handlers.TimedRotatingFileHandler'</span>,  <span class="comment"># 按时间切割日志</span></div><div class="line">		    <span class="string">'filename'</span>: <span class="string">'/Users/hanqunfeng/python_workspace/log/timedRotatingFile.log'</span>,  <span class="comment"># 日志输出文件</span></div><div class="line">		    <span class="string">'when'</span>: <span class="string">'D'</span>,  <span class="comment"># 按天分割</span></div><div class="line">		    <span class="string">'backupCount'</span>: <span class="number">5</span>,  <span class="comment"># 保留日志份数，只保留最后5份，如果都保留，设置为0，默认就是0</span></div><div class="line">		    <span class="string">'formatter'</span>: <span class="string">'standard'</span>,  <span class="comment"># 使用哪种formatters日志格式</span></div><div class="line">		&#125;,</div><div class="line">    &#125;,</div><div class="line">    <span class="string">'loggers'</span>: &#123;<span class="comment">#日志记录器</span></div><div class="line">        <span class="string">'django'</span>: &#123;<span class="comment">#日志名称路径前缀，即logging.getLogger(__name__)获取logger对象时，_name__得到的前缀与之匹配即可，比如__name__得到的是django.server</span></div><div class="line">            <span class="string">'handlers'</span>: [<span class="string">'console'</span>],</div><div class="line">            <span class="string">'propagate'</span>: <span class="keyword">True</span>,</div><div class="line">            <span class="string">'level'</span>: os.getenv(<span class="string">'DJANGO_LOG_LEVEL'</span>, <span class="string">'DEBUG'</span>),  <span class="comment"># 只有设置DEBUG = True时，该配置才会打印sql信息</span></div><div class="line">        &#125;,</div><div class="line">        <span class="string">'django.request'</span>: &#123;</div><div class="line">            <span class="string">'handlers'</span>: [<span class="string">'rotatingFile'</span>],</div><div class="line">            <span class="string">'level'</span>: <span class="string">'ERROR'</span>,</div><div class="line">            <span class="string">'propagate'</span>: <span class="keyword">False</span>,  <span class="comment"># 设置为False，表示不像其父级别传递日志内容</span></div><div class="line">        &#125;,</div><div class="line">        <span class="string">'myapp.log'</span>: &#123; <span class="comment"># 也可以这样创建logger对象，logging.getLogger('myapp.log')</span></div><div class="line">            <span class="string">'handlers'</span>: [<span class="string">'file'</span>, <span class="string">'timedRotatingFile'</span>],</div><div class="line">            <span class="string">'level'</span>: <span class="string">'INFO'</span>,  <span class="comment"># 这里的日志级别不能低于处理器中设置的日志级别</span></div><div class="line">        &#125;,</div><div class="line">    &#125;,</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>代码中使用方式：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 导入logging库</span></div><div class="line"><span class="keyword">import</span> logging</div><div class="line"><span class="comment"># 获取logger的一个实例</span></div><div class="line"><span class="comment"># logger = logging.getLogger(__name__)</span></div><div class="line">logger = logging.getLogger(<span class="string">'myapp.log'</span>)</div><div class="line"></div><div class="line"><span class="comment"># 方法中：</span></div><div class="line">logger.info(<span class="string">'这是一个日志'</span>)</div></pre></td></tr></table></figure></p>
<h2 id="19-发送邮件"><a href="#19-发送邮件" class="headerlink" title="19.发送邮件"></a>19.发送邮件</h2><p>1.settings<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">EMAIL_BACKEND = <span class="string">'django.core.mail.backends.smtp.EmailBackend'</span></div><div class="line">EMAIL_USE_SSL = <span class="keyword">True</span></div><div class="line">EMAIL_HOST = <span class="string">'smtp.163.com'</span></div><div class="line">EMAIL_PORT = <span class="number">465</span></div><div class="line">EMAIL_HOST_USER = <span class="string">'xxx@163.com'</span>  <span class="comment"># 帐号</span></div><div class="line">EMAIL_HOST_PASSWORD = <span class="string">'xxxxxxx'</span>  <span class="comment"># 密码</span></div><div class="line">DEFAULT_FROM_EMAIL = <span class="string">'hanqf &lt;xxx@163.com&gt;'</span></div></pre></td></tr></table></figure></p>
<p>2.代码里<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings</div><div class="line"><span class="comment"># 发送邮件</span></div><div class="line"><span class="keyword">from</span> django.core.mail <span class="keyword">import</span> send_mail</div><div class="line">send_mail(<span class="string">'Subject here主题'</span>, <span class="string">'Here is the message.消息'</span>, settings.DEFAULT_FROM_EMAIL,</div><div class="line">          [<span class="string">'aaaaa@126.com'</span>], fail_silently=<span class="keyword">False</span>)</div><div class="line"></div><div class="line"><span class="comment"># 一次可以发送多组邮件</span></div><div class="line"><span class="keyword">from</span> django.core.mail <span class="keyword">import</span> send_mass_mail</div><div class="line"></div><div class="line">message1 = (<span class="string">'Subject here'</span>, <span class="string">'Here is the message'</span>, settings.DEFAULT_FROM_EMAIL,</div><div class="line">            [<span class="string">'aaaaa@126.com'</span>, <span class="string">'aaaaa@163.com'</span>])</div><div class="line">message2 = (<span class="string">'Another Subject'</span>, <span class="string">'Here is another message'</span>, settings.DEFAULT_FROM_EMAIL, [<span class="string">'aaaaa@126.com'</span>])</div><div class="line">send_mass_mail((message1, message2), fail_silently=<span class="keyword">False</span>)</div><div class="line"></div><div class="line"><span class="comment"># 可以这是抄送附件等</span></div><div class="line"><span class="keyword">from</span> django.core.mail <span class="keyword">import</span> EmailMultiAlternatives</div><div class="line">msg = EmailMultiAlternatives(<span class="string">'主题'</span>, <span class="string">'内容'</span>, settings.DEFAULT_FROM_EMAIL, [<span class="string">'aaaaa@126.com'</span>],</div><div class="line">                             cc=[<span class="string">'aaaaa@163.com'</span>])</div><div class="line"><span class="comment"># msg.content_subtype = "html" # 设置邮件格式，html可以发送内容为html，不推荐这么使用，可以使用下面的方式</span></div><div class="line">html_content = <span class="string">'&lt;p&gt;这是一封&lt;strong&gt;重要的&lt;/strong&gt;邮件.&lt;/p&gt;'</span></div><div class="line">msg.attach_alternative(html_content, <span class="string">"text/html"</span>)  <span class="comment"># 如果接收方的邮件支持html，则显示该信息，否则显示原「内容」</span></div><div class="line"><span class="comment"># 添加附件（可选）</span></div><div class="line">msg.attach_file(<span class="string">'/Users/hanqunfeng/python_workspace/STATIC_ROOT/polls/images/background.jpg'</span>)</div><div class="line"><span class="comment"># 发送</span></div><div class="line">msg.send()</div></pre></td></tr></table></figure></p>
<h2 id="20-main方法测试"><a href="#20-main方法测试" class="headerlink" title="20.main方法测试"></a>20.main方法测试</h2><p>mian方法测试一定要在如下情况下使用，这样可以保证当前模块被别处引用时不会触发如下测试代码，只有独立运行该模块时才会执行。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    <span class="comment"># 加载环境配置</span></div><div class="line">    <span class="keyword">import</span> django, os</div><div class="line">    os.environ.setdefault(<span class="string">"DJANGO_SETTINGS_MODULE"</span>, <span class="string">"DjangoHelloWorld.settings"</span>)</div><div class="line">    django.setup()</div><div class="line">    <span class="comment"># 以下是测试内容</span></div><div class="line">    <span class="keyword">from</span> myapp.models.user <span class="keyword">import</span> User</div><div class="line">    user_list = User.objects.all()</div><div class="line">    xml = to_xml(user_list)</div><div class="line">    print(xml)</div></pre></td></tr></table></figure></p>
<h2 id="21-Signal，信号，有点类似MQ"><a href="#21-Signal，信号，有点类似MQ" class="headerlink" title="21.Signal，信号，有点类似MQ"></a>21.Signal，信号，有点类似MQ</h2><p>1.定义信号和接收器<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> django.dispatch <span class="keyword">import</span> Signal, receiver</div><div class="line"><span class="comment"># my_singal = Signal()</span></div><div class="line">my_singal = Signal(providing_args=[<span class="string">"key1"</span>, <span class="string">"key2"</span>]) <span class="comment"># 定义信号接收的参数，不指定参数也可以</span></div><div class="line"></div><div class="line"><span class="meta">@receiver(my_singal)</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_callback</span><span class="params">(sender, **kwargs)</span>:</span> <span class="comment"># 接收器回调函数</span></div><div class="line">    print(sender)</div><div class="line">    print(kwargs)</div><div class="line">    <span class="keyword">for</span> key <span class="keyword">in</span> kwargs:</div><div class="line">        print(key)</div><div class="line">        print(kwargs[key])</div><div class="line">    print(<span class="string">"Request finished!"</span>)</div></pre></td></tr></table></figure></p>
<p>2.发送信号，发送信号时接收器就会被执行<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> signals.signals <span class="keyword">import</span> my_singal</div><div class="line">my_singal.send(sender=__name__, key1=<span class="string">'qqq'</span>, key2=<span class="number">10</span>, key3=<span class="number">100</span>) <span class="comment"># 实际上可以多发送一些参数</span></div></pre></td></tr></table></figure></p>
<h2 id="22-Django管理后台简介"><a href="#22-Django管理后台简介" class="headerlink" title="22.Django管理后台简介"></a>22.Django管理后台简介</h2><p>首先，我们需要创建一个能够登录管理后台站点的用户。<br>运行如下命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">python manage.py createsuperuser</div></pre></td></tr></table></figure></p>
<p>键入你想要使用的用户名，然后按下回车键：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Username: admin</div></pre></td></tr></table></figure></p>
<p>然后提示你输入想要使用的邮件地址：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Email address: admin@example.com</div></pre></td></tr></table></figure></p>
<p>你需要输入两次密码，第二次输入是确认密码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Password: **********</div><div class="line">Password (again): *********</div><div class="line">Superuser created successfully.</div></pre></td></tr></table></figure></p>
<p>PS：管理员密码忘记了可以通过如下方法修改：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$ python manage.py shell</div><div class="line">&gt;&gt;&gt; from django.contrib.auth.models import User</div><div class="line">&gt;&gt;&gt; user = User.objects.get(pk=1) # 可以通过查询获得用户对象</div><div class="line">&gt;&gt;&gt; user.set_password(&apos;xxxxxxxx&apos;)</div><div class="line">&gt;&gt;&gt; user.save()</div><div class="line">&gt;&gt;&gt; quit()</div></pre></td></tr></table></figure></p>
<h2 id="23-部署正式环境"><a href="#23-部署正式环境" class="headerlink" title="23.部署正式环境"></a>23.部署正式环境</h2><p>settings.py:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">DEBUG = <span class="keyword">False</span> <span class="comment"># 此时很多问题就会出现，需要增加很多额外的配置才能正常工作，这也是为了包含生产环境吧</span></div><div class="line"></div><div class="line">ALLOWED_HOSTS = [<span class="string">'127.0.0.1'</span>]</div><div class="line"><span class="comment"># ALLOWED_HOSTS = ['*', ]  # 允许所有机器访问</span></div><div class="line"></div><div class="line">STATIC_URL = <span class="string">'http://localhost/static/'</span>      <span class="comment"># apache部署的静态文件服务器访问地址</span></div><div class="line"></div><div class="line">STATIC_ROOT = <span class="string">"/Users/hanqunfeng/python_workspace/STATIC_ROOT/"</span>  <span class="comment">#apache 服务目录</span></div><div class="line"></div><div class="line"><span class="comment"># 上传文件路径</span></div><div class="line">MEDIA_URL = <span class="string">'http://localhost/media/'</span></div><div class="line">MEDIA_ROOT = <span class="string">'/Users/hanqunfeng/python_workspace/MEDIA/'</span></div></pre></td></tr></table></figure></p>
<p>apache配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">Alias /media/ /Users/hanqunfeng/python_workspace/MEDIA/</div><div class="line">Alias /static/ /Users/hanqunfeng/python_workspace/STATIC_ROOT/</div><div class="line"></div><div class="line">&lt;Directory /Users/hanqunfeng/python_workspace/STATIC_ROOT&gt;</div><div class="line">Require all granted</div><div class="line">&lt;/Directory&gt;</div><div class="line"></div><div class="line">&lt;Directory /Users/hanqunfeng/python_workspace/MEDIA/&gt;</div><div class="line">Require all granted</div><div class="line">&lt;/Directory&gt;</div></pre></td></tr></table></figure></p>
<p>使用如下命令可以将本地的静态资源部署到apache服务目录：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">python manage.py collectstatic</div></pre></td></tr></table></figure></p>
<p>模板页面：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&#123;% load static %&#125;</div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">type</span>=<span class="string">"text/css"</span> <span class="attr">href</span>=<span class="string">"&#123;% static 'polls/style.css' %&#125;"</span> /&gt;</span></div></pre></td></tr></table></figure></p>
<p>上传文件：<br>model中：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">photo = models.ImageField(upload_to=<span class="string">"photo"</span>, default=<span class="string">"default/django.jpeg"</span>)  <span class="comment"># 路径相对于MEDIA_ROOT的配置</span></div></pre></td></tr></table></figure></p>
<p>之后要注意更新数据库。</p>
<p>需要安装Pillow，否则会报错<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ERRORS:</div><div class="line">polls.Question.photo: (fields.E210) Cannot use ImageField because Pillow is not installed.</div><div class="line">	HINT: Get Pillow at https://pypi.python.org/pypi/Pillow or run command &quot;pip install Pillow&quot;.</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pip install Pillow</div></pre></td></tr></table></figure>
<p>如果要在页面中使用settings中的变量，需要在当前应用中创建一个context_processors.py 文件<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings  <span class="comment"># import the settings file</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">settings_constant</span><span class="params">(request)</span>:</span></div><div class="line">    <span class="comment"># return the value you want as a dictionnary. you may add multiple values in there.</span></div><div class="line">    <span class="keyword">return</span> &#123;<span class="string">'MEDIA_URL'</span>: settings.MEDIA_URL, <span class="string">'DEBUG'</span>: settings.DEBUG&#125;</div></pre></td></tr></table></figure></p>
<p>并在settings文件配置如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">TEMPLATES = [</div><div class="line">    &#123;</div><div class="line">        <span class="string">'BACKEND'</span>: <span class="string">'django.template.backends.django.DjangoTemplates'</span>,</div><div class="line">        <span class="string">'DIRS'</span>: [os.path.join(BASE_DIR, <span class="string">'templates'</span>)]</div><div class="line">        ,</div><div class="line">        <span class="string">'APP_DIRS'</span>: <span class="keyword">True</span>,</div><div class="line">        <span class="string">'OPTIONS'</span>: &#123;</div><div class="line">            <span class="string">'context_processors'</span>: [</div><div class="line">                <span class="string">'django.template.context_processors.debug'</span>,</div><div class="line">                <span class="string">'django.template.context_processors.request'</span>,</div><div class="line">                <span class="string">'django.contrib.auth.context_processors.auth'</span>,</div><div class="line">                <span class="string">'django.contrib.messages.context_processors.messages'</span>,</div><div class="line">                <span class="string">'polls.context_processors.settings_constant'</span>, <span class="comment">#应用名称.文件名称.方法名称</span></div><div class="line">            ],</div><div class="line">        &#125;,</div><div class="line">    &#125;,</div><div class="line">]</div></pre></td></tr></table></figure>
<p>模板页面中：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"&#123;&#123;MEDIA_URL&#125;&#125;abc/a.png"</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">"photo"</span> <span class="attr">id</span>=<span class="string">"id_photo"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></div><div class="line"></div><div class="line">也可以使用下面的形式获得上传文件的url，</div><div class="line">即使用上传文件字段的url属性：&#123;&#123; question.photo.url &#125;&#125;</div><div class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;&#123;MEDIA_URL&#125;&#125;&#123;&#123; question.photo &#125;&#125;"</span>&gt;</span>&#123;&#123; question.photo &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span> ##</div><div class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;&#123; question.photo.url &#125;&#125;"</span>&gt;</span>&#123;&#123; question.photo &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>views处理代码中：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">input_img = request.FILES[<span class="string">'photo'</span>]</div><div class="line">question.photo = input_img</div><div class="line">question.save()</div></pre></td></tr></table></figure></p>
<p>部署到apache：</p>
<p>下载mod_wsgi：<a href="https://github.com/GrahamDumpleton/mod_wsgi/releases" target="_blank" rel="noopener">https://github.com/GrahamDumpleton/mod_wsgi/releases</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">tar xvfz mod_wsgi-X.Y.tar.gz</div><div class="line">./configure --with-apxs=/Applications/XAMPP/bin/apxs --with-python=/Library/Frameworks/Python.framework/Versions/3.6/bin/python3</div><div class="line"></div><div class="line">make</div><div class="line">make install</div></pre></td></tr></table></figure></p>
<p>然后在apache配置文件中加入如下配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">LoadModule wsgi_module modules/mod_wsgi.so</div></pre></td></tr></table></figure></p>
<p>普通模式：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">WSGIPythonHome /Users/hanqunfeng/python_workspace/DjangoHelloWorld/venv</div><div class="line">WSGIPythonPath /Users/hanqunfeng/python_workspace/DjangoHelloWorld</div></pre></td></tr></table></figure></p>
<p>或者采用守护进程模式：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">WSGIDaemonProcess example.com python-home=/Users/hanqunfeng/python_workspace/DjangoHelloWorld/venv python-path=/Users/hanqunfeng/python_workspace/DjangoHelloWorld</div><div class="line"></div><div class="line">WSGIProcessGroup example.com</div></pre></td></tr></table></figure></p>
<p>配置项目访问路径<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">WSGIScriptAlias /mysite /Users/hanqunfeng/python_workspace/DjangoHelloWorld/DjangoHelloWorld/wsgi.py</div><div class="line"></div><div class="line">&lt;Directory /Users/hanqunfeng/python_workspace/DjangoHelloWorld/DjangoHelloWorld&gt;</div><div class="line">&lt;Files wsgi.py&gt;</div><div class="line">Require all granted</div><div class="line">&lt;/Files&gt;</div><div class="line">&lt;/Directory&gt;</div></pre></td></tr></table></figure></p>
<p>访问地址：<a href="http://127.0.0.1/mysite/polls" target="_blank" rel="noopener">http://127.0.0.1/mysite/polls</a></p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Django/" rel="tag"># Django</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/04/28/python_virtualenv/" rel="next" title="Python--virtualenv">
                <i class="fa fa-chevron-left"></i> Python--virtualenv
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/10/10/thymeleaf_study/" rel="prev" title="Spring Boot2学习笔记--thymeleaf">
                Spring Boot2学习笔记--thymeleaf <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
        
  <div class="bdsharebuttonbox">
    <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
    <a href="#" class="bds_douban" data-cmd="douban" title="分享到豆瓣网"></a>
    <a href="#" class="bds_sqq" data-cmd="sqq" title="分享到QQ好友"></a>
    <a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a>
    <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a>
    <a href="#" class="bds_tieba" data-cmd="tieba" title="分享到百度贴吧"></a>
    <a href="#" class="bds_twi" data-cmd="twi" title="分享到Twitter"></a>
    <a href="#" class="bds_fbook" data-cmd="fbook" title="分享到Facebook"></a>
    <a href="#" class="bds_more" data-cmd="more"></a>
    <a class="bds_count" data-cmd="count"></a>
  </div>
  <script>
    window._bd_share_config = {
      "common": {
        "bdText": "",
        "bdMini": "2",
        "bdMiniList": false,
        "bdPic": ""
      },
      "share": {
        "bdSize": "16",
        "bdStyle": "0"
      },
      "image": {
        "viewList": ["tsina", "douban", "sqq", "qzone", "weixin", "twi", "fbook"],
        "viewText": "分享到：",
        "viewSize": "16"
      }
    }
  </script>

<script>
  with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='//bdimg.share.baidu.com/static/api/js/share.js?cdnversion='+~(-new Date()/36e5)];
</script>

      
    </div>
  </div>


          </div>
          

  <p>热评文章</p>
  <div class="ds-top-threads" data-range="weekly" data-num-items="4"></div>


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2018/04/28/django2_study/"
           data-title="Django2学习笔记" data-url="http://blog.hanqunfeng.com/2018/04/28/django2_study/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/touxiang.jpg"
               alt="hanqunfeng" />
          <p class="site-author-name" itemprop="name">hanqunfeng</p>
          <p class="site-description motion-element" itemprop="description">分享成长与快乐的地方</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">25</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">3</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">8</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/hanqunfeng" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://hanqunfeng.iteye.com" target="_blank" title="Iteye">
                  
                    <i class="fa fa-fw fa-bus"></i>
                  
                  Iteye
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://blog.csdn.net/hanqunfeng" target="_blank" title="CSDN">
                  
                    <i class="fa fa-fw fa-car"></i>
                  
                  CSDN
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.jianshu.com/users/763c53661578/latest_articles" target="_blank" title="简书">
                  
                    <i class="fa fa-fw fa-font-awesome"></i>
                  
                  简书
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              Links
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://duoshuo.com" title="多说评论" target="_blank">多说评论</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://tongji.baidu.com/web/welcome/login" title="百度统计" target="_blank">百度统计</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://zhanzhang.baidu.com" title="百度站长" target="_blank">百度站长</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://www.aliyun.com" title="阿里云" target="_blank">阿里云</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://leancloud.cn" title="Leancloud" target="_blank">Leancloud</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://coding.net/u/hanqunfeng" title="Coding" target="_blank">Coding</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://www.dnspod.cn" title="Dnspod" target="_blank">Dnspod</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://fontawesome.io/icons/" title="FontAwsome" target="_blank">FontAwsome</a>
                </li>
              
            </ul>
          </div>
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#摘要"><span class="nav-number">1.</span> <span class="nav-text">摘要</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-安装"><span class="nav-number">2.</span> <span class="nav-text">1.安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-创建新项目"><span class="nav-number">3.</span> <span class="nav-text">2.创建新项目</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-创建新的应用"><span class="nav-number">4.</span> <span class="nav-text">3.创建新的应用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-创建和更新数据库："><span class="nav-number">5.</span> <span class="nav-text">4.创建和更新数据库：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-启动服务器"><span class="nav-number">6.</span> <span class="nav-text">5.启动服务器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-测试："><span class="nav-number">7.</span> <span class="nav-text">6.测试：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-检查代码覆盖率："><span class="nav-number">8.</span> <span class="nav-text">7.检查代码覆盖率：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-mysql"><span class="nav-number">9.</span> <span class="nav-text">8.mysql:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-多数据源配置"><span class="nav-number">10.</span> <span class="nav-text">9.多数据源配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-缓存"><span class="nav-number">11.</span> <span class="nav-text">10.缓存</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-注册模板自定义方法"><span class="nav-number">12.</span> <span class="nav-text">11.注册模板自定义方法:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#12-模板"><span class="nav-number">13.</span> <span class="nav-text">12.模板</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#13-自定义400、403、404、500页面"><span class="nav-number">14.</span> <span class="nav-text">13.自定义400、403、404、500页面</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#14-Django配置session超时"><span class="nav-number">15.</span> <span class="nav-text">14.Django配置session超时</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#15-json与xml"><span class="nav-number">16.</span> <span class="nav-text">15.json与xml</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#16-response添加相应头"><span class="nav-number">17.</span> <span class="nav-text">16.response添加相应头</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#17-多语言"><span class="nav-number">18.</span> <span class="nav-text">17.多语言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#18-日志"><span class="nav-number">19.</span> <span class="nav-text">18.日志</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#19-发送邮件"><span class="nav-number">20.</span> <span class="nav-text">19.发送邮件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#20-main方法测试"><span class="nav-number">21.</span> <span class="nav-text">20.main方法测试</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#21-Signal，信号，有点类似MQ"><span class="nav-number">22.</span> <span class="nav-text">21.Signal，信号，有点类似MQ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#22-Django管理后台简介"><span class="nav-number">23.</span> <span class="nav-text">22.Django管理后台简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#23-部署正式环境"><span class="nav-number">24.</span> <span class="nav-text">23.部署正式环境</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  <span>「Hosted by Coding Pages」</span>
  
  &copy; 
  
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">hanqunfeng</span>

</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>



<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"hanqunfeng"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  








  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
      search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="popoverlay">').css('overflow', 'hidden');
      $('.popup').toggle();
    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';
      $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = $( "entry", xmlResponse ).map(function() {
            return {
              title: $( "title", this ).text(),
              content: $("content",this).text(),
              url: $( "url" , this).text()
            };
          }).get();
          var $input = document.getElementById(search_id);
          var $resultContent = document.getElementById(content_id);
          $input.addEventListener('input', function(){
            var matchcounts = 0;
            var str='<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length > 1) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var content_index = [];
                var data_title = data.title.trim().toLowerCase();
                var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                var data_url = decodeURIComponent(data.url);
                var index_title = -1;
                var index_content = -1;
                var first_occur = -1;
                // only match artiles with not empty titles and contents
                if(data_title != '') {
                  keywords.forEach(function(keyword, i) {
                    index_title = data_title.indexOf(keyword);
                    index_content = data_content.indexOf(keyword);
                    if( index_title >= 0 || index_content >= 0 ){
                      isMatch = true;
                      if (i == 0) {
                        first_occur = index_content;
                      }
                    }

                  });
                }
                // show search results
                if (isMatch) {
                  matchcounts += 1;
                  str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                  var content = data.content.trim().replace(/<[^>]+>/g,"");
                  if (first_occur >= 0) {
                    // cut out 100 characters
                    var start = first_occur - 20;
                    var end = first_occur + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if(start == 0){
                      end = 50;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    var match_content = content.substring(start, end);
                    // highlight all keywords
                    keywords.forEach(function(keyword){
                      var regS = new RegExp(keyword, "gi");
                      match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                    });

                    str += "<p class=\"search-result\">" + match_content +"...</p>"
                  }
                  str += "</li>";
                }
              })};
            str += "</ul>";
            if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
            if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
            $resultContent.innerHTML = str;
          });
          proceedsearch();
        }
      });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".popoverlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>


  

  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("OGMvTuds9s7tzvWNopJHAJ5W-gzGzoHsz", "A0HB73VDqWDODaRS4yyiW6V8");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  


</body>
</html>
