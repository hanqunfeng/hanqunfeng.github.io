<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>RocketMQ Docker安装方式</title>
    <url>/2021/06/24/rocketmq-docker/</url>
    <content><![CDATA[<h2 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h2><p>看完本文你将掌握如下知识点：</p>
<ul>
<li>docker[20.10.7]安装rocketmq[4.8.0]的方法</li>
</ul>
<span id="more"></span>

<h3 id="server-有日志目录映射"><a href="#server-有日志目录映射" class="headerlink" title="server 有日志目录映射"></a>server 有日志目录映射</h3><ul>
<li>设置目录权限<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">chmod 777 $(pwd)/logs</span><br></pre></td></tr></table></figure></li>
<li>启动<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker run -d -v $(pwd)/logs:/home/rocketmq/logs \</span><br><span class="line">-v $(pwd)/logs:/home/rocketmq/logs \</span><br><span class="line">--name rmqnamesrv \</span><br><span class="line">-e &quot;JAVA_OPT_EXT=-Xms512M -Xmx512M -Xmn128m&quot; \</span><br><span class="line">-p 9876:9876 \</span><br><span class="line">foxiswho/rocketmq:4.8.0 \</span><br><span class="line">sh mqnamesrv</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="broker-目录映射"><a href="#broker-目录映射" class="headerlink" title="broker 目录映射"></a>broker 目录映射</h3><ul>
<li><p>设置目录权限</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">chmod 777 $(pwd)/logs</span><br><span class="line">chmod 777 $(pwd)/store</span><br><span class="line">chmod 777 $(pwd)/conf</span><br></pre></td></tr></table></figure></li>
<li><p>添加文件：$(pwd)/conf/broker.conf</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">brokerClusterName = DefaultCluster</span><br><span class="line">brokerName = broker-a</span><br><span class="line">brokerId = 0</span><br><span class="line">deleteWhen = 04</span><br><span class="line">fileReservedTime = 48</span><br><span class="line">brokerRole = ASYNC_MASTER</span><br><span class="line">flushDiskType = ASYNC_FLUSH</span><br><span class="line">brokerIP1 = &#123;宿主机 IP&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>启动</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker run -d</span><br><span class="line">-v $(pwd)/logs:/home/rocketmq/logs</span><br><span class="line">-v $(pwd)/store:/home/rocketmq/store \</span><br><span class="line">-v $(pwd)/conf:/home/rocketmq/conf \</span><br><span class="line">--name rmqbroker --link rmqnamesrv:rmqnamesrv \</span><br><span class="line">-e &quot;NAMESRV_ADDR=rmqnamesrv:9876&quot; \</span><br><span class="line">-e &quot;JAVA_OPT_EXT=-Xms512M -Xmx512M -Xmn128m&quot; \</span><br><span class="line">-p 10911:10911 -p 10912:10912 -p 10909:10909 \</span><br><span class="line">foxiswho/rocketmq:4.8.0 \</span><br><span class="line">sh mqbroker -c /home/rocketmq/conf/broker.conf</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="console"><a href="#console" class="headerlink" title="console"></a>console</h3><ul>
<li><p>启动</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker run --name rmqconsole --link rmqnamesrv:rmqnamesrv \</span><br><span class="line">-e &quot;JAVA_OPTS=-Drocketmq.namesrv.addr=rmqnamesrv:9876 -Dcom.rocketmq.sendMessageWithVIPChannel=false&quot; \</span><br><span class="line">-p 8180:8080 -t styletang/rocketmq-console-ng</span><br></pre></td></tr></table></figure></li>
<li><p>访问地址<br><a href="http://localhost:8180/">http://localhost:8180/</a></p>
</li>
</ul>
]]></content>
      <categories>
        <category>技术</category>
        <category>Docker</category>
      </categories>
      <tags>
        <tag>rocketmq</tag>
        <tag>docker</tag>
      </tags>
  </entry>
  <entry>
    <title>vim配置</title>
    <url>/2021/01/23/vimrc/</url>
    <content><![CDATA[<h2 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h2><ul>
<li>vim常用配置</li>
<li>基于<a href="https://github.com/junegunn/vim-plug">vim-plug</a>进行插件管理<span id="more"></span></li>
</ul>
<h2 id="vimrc"><a href="#vimrc" class="headerlink" title=".vimrc"></a>.vimrc</h2><figure class="highlight vim"><table><tr><td class="code"><pre><span class="line"><span class="comment">&quot; =============================================================</span></span><br><span class="line"><span class="comment">&quot; :set all  查看所有可以设置的命令</span></span><br><span class="line"><span class="comment">&quot; :set command?  查看该命令当前状态，比如:set nu?</span></span><br><span class="line"><span class="comment">&quot;</span></span><br><span class="line"><span class="comment">&quot; :map      查看所有键盘映射，参考：http://yyq123.github.io/learn-vim/learn-vi-51-KeyMapping.html</span></span><br><span class="line"><span class="comment">&quot; :autocmd  查看所有自动命令，参考：http://yyq123.github.io/learn-vim/learn-vi-49-01-autocmd.html</span></span><br><span class="line"><span class="comment">&quot; =============================================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&quot; 开启行号</span></span><br><span class="line"><span class="keyword">set</span> <span class="keyword">nu</span></span><br><span class="line"><span class="comment">&quot; 语法高亮</span></span><br><span class="line"><span class="keyword">syntax</span> <span class="keyword">on</span></span><br><span class="line"><span class="comment">&quot; 设置自动缩进的宽度为4个空格</span></span><br><span class="line"><span class="keyword">set</span> <span class="keyword">ts</span>=<span class="number">4</span></span><br><span class="line"><span class="keyword">set</span> <span class="keyword">sw</span>=<span class="number">4</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&quot; 设置vim编码，默认就是utf-8</span></span><br><span class="line"><span class="keyword">set</span> encoding=utf-<span class="number">8</span></span><br><span class="line"><span class="comment">&quot; 设置vim自动识别的文件编码列表，按顺序进行匹配</span></span><br><span class="line"><span class="keyword">set</span> fileencodings=utf-<span class="number">8</span>,ucs-bom,shift-jis,gb18030,gbk,gb2312,cp936,utf-<span class="number">16</span>,big5,euc-jp,latin1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">&quot; 搜索时忽略大小写，默认是精确匹配，noignorecase</span></span><br><span class="line"><span class="comment">&quot; 如果想在搜索时精确匹配，可以加上&#x27;\C&#x27;前缀，比如搜索plug，:/\Cplug</span></span><br><span class="line"><span class="comment">&quot; &#x27;\c&#x27;就是忽略大小写</span></span><br><span class="line"><span class="keyword">set</span> ignorecase</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">&quot; =============================================================</span></span><br><span class="line"><span class="comment">&quot; 翻页</span></span><br><span class="line"><span class="comment">&quot; Ctrl + f         向下翻整页</span></span><br><span class="line"><span class="comment">&quot; Ctrl + b         向上翻整页</span></span><br><span class="line"><span class="comment">&quot;</span></span><br><span class="line"><span class="comment">&quot; Ctrl + d         向下翻半页</span></span><br><span class="line"><span class="comment">&quot; Ctrl + u         向上翻半页</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&quot; =============================================================</span></span><br><span class="line"><span class="comment">&quot; 窗口</span></span><br><span class="line"><span class="comment">&quot; Ctrl + w + w          光标在 nerdtree 和 vim 编辑窗口 之间切换</span></span><br><span class="line"><span class="comment">&quot; Ctrl + w + (h/j/k/l)  即h左、j下、k上、l右，表示窗口切换的方向</span></span><br><span class="line"><span class="comment">&quot; Ctrl + w + n          新建水平窗口并开始编辑新文件，上方</span></span><br><span class="line"><span class="comment">&quot; :vnew                 新建垂直窗口并开始编辑新文件，右侧</span></span><br><span class="line"><span class="comment">&quot; Ctrl + w + s          新建水平窗口并显示当前文件，右侧</span></span><br><span class="line"><span class="comment">&quot; Ctrl + w + v          新建垂直窗口并显示当前文件，上方</span></span><br><span class="line"><span class="comment">&quot; :term                 新建终端窗口，上方，关闭使用exit</span></span><br><span class="line"><span class="comment">&quot;</span></span><br><span class="line"><span class="comment">&quot; vim -o file1 file2 file3   水平分割窗口</span></span><br><span class="line"><span class="comment">&quot; vim -O file1 file2 file3   垂直分割窗口</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&quot; =============================================================</span></span><br><span class="line"><span class="comment">&quot; Tab页，标签页，注意：tab不适buffer</span></span><br><span class="line"><span class="comment">&quot; :tabnew               新建tab页，打开一个新的为文件</span></span><br><span class="line"><span class="comment">&quot; :tabedit file         新建tab页，打开指定的文件</span></span><br><span class="line"><span class="comment">&quot; gt/gT                 向后/向前切换tab页，可以循环</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">&quot; =============================================================</span></span><br><span class="line"><span class="comment">&quot;</span></span><br><span class="line"><span class="comment">&quot; 标记marks</span></span><br><span class="line"><span class="comment">&quot; :marks         查看全部可以跳转到的标记</span></span><br><span class="line"><span class="comment">&quot; 快捷键：m/     这个快捷键只会列出当前文件的标记</span></span><br><span class="line"><span class="comment">&quot;</span></span><br><span class="line"><span class="comment">&quot; 为当前行添加一个标记: 同一行可以添加多个标记</span></span><br><span class="line"><span class="comment">&quot; m+英文字母</span></span><br><span class="line"><span class="comment">&quot; 小写字母只能在当前文件内部跳转，大写字母可以在其它文件中跳转，如：ma，mA</span></span><br><span class="line"><span class="comment">&quot;</span></span><br><span class="line"><span class="comment">&quot; 跳转到指定标记:</span></span><br><span class="line"><span class="comment">&quot; &#x27;+英文字母     移动到标记的文本行首，如：&#x27;a，&#x27;A</span></span><br><span class="line"><span class="comment">&quot; `+英文字母     移动到标记的光标位置，如：`a，`A</span></span><br><span class="line"><span class="comment">&quot;</span></span><br><span class="line"><span class="comment">&quot; 删除标记:</span></span><br><span class="line"><span class="comment">&quot; :delmarks a A  删除一个或多个指定标记，快捷键：dmx :x is a-zA-Z</span></span><br><span class="line"><span class="comment">&quot; :delmarks!     删除所有标记    快捷键：m&lt;Space&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">&quot; =============================================================</span></span><br><span class="line"><span class="comment">&quot; 不生产wrap文件,warp文件是vim意外退出时用于恢复文件时使用的</span></span><br><span class="line"><span class="comment">&quot; set nowrap</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&quot; 不生产备份文件</span></span><br><span class="line"><span class="comment">&quot; set nobackup</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">&quot; =============================================================</span></span><br><span class="line"><span class="comment">&quot; 快速跳转到指定行</span></span><br><span class="line"><span class="comment">&quot; 1.查看模式下numgg，比如30gg，跳转到30行</span></span><br><span class="line"><span class="comment">&quot; 2.命令行模式下:num，比如:30，跳转到30行</span></span><br><span class="line"><span class="comment">&quot; =============================================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&quot; 撤销：u       :undo</span></span><br><span class="line"><span class="comment">&quot; 恢复：ctrl-r  :redo</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&quot; =============================================================</span></span><br><span class="line"><span class="comment">&quot; 命令行模式下，通过上下方向键就可以显示历史命令</span></span><br><span class="line"><span class="comment">&quot; 命令行模式下，ctrl-f，会打开历史命令窗口，上下方向键选择</span></span><br><span class="line"><span class="comment">&quot; 普通模式下，q: ，也可以打开历史命令窗口</span></span><br><span class="line"><span class="comment">&quot; 打开历史命令行窗口后，可以像在普通窗口一样键入&#x27;\key&#x27;进行关键字搜索</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&quot; =============================================================</span></span><br><span class="line"><span class="comment">&quot; 大小写转换:</span></span><br><span class="line"><span class="comment">&quot; gUU：将整行转换为大写</span></span><br><span class="line"><span class="comment">&quot; guu：将整行转换为小写</span></span><br><span class="line"><span class="comment">&quot;</span></span><br><span class="line"><span class="comment">&quot; v模式下，选择要转换的字符，然后按 ~，则会进行大小写间的转换</span></span><br><span class="line"><span class="comment">&quot; 这里要注意，~ 转换时，原先是大写就转小写，小写就转大写，</span></span><br><span class="line"><span class="comment">&quot; 所以如果单词中是大小写混合时，要全部转为大写或小写可以使用：U(大写)、u(小写)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">&quot;==============================================================</span></span><br><span class="line"><span class="comment">&quot; 代码格式化整个文档：</span></span><br><span class="line"><span class="comment">&quot; (1) 按两下小写g，即gg，定位光标到第一行。</span></span><br><span class="line"><span class="comment">&quot; (2) 按住Shift+v，即大写V，进入可视化编辑的行编辑模式。</span></span><br><span class="line"><span class="comment">&quot; (3) Shift+g，即大写G，选中整个代码。</span></span><br><span class="line"><span class="comment">&quot; (4) 按下等号=，格式化所有代码。</span></span><br><span class="line"><span class="comment">&quot;</span></span><br><span class="line"><span class="comment">&quot; 也可以在normal模式下，连续输入 gg=G ，也可以格式化整个文档</span></span><br><span class="line"><span class="comment">&quot;</span></span><br><span class="line"><span class="comment">&quot; 代码格式化部分行：</span></span><br><span class="line"><span class="comment">&quot; (1) 光标定位到开始的行；</span></span><br><span class="line"><span class="comment">&quot; (2) 按住Shift+v，即大写V，进入可视化编辑的行编辑模式。</span></span><br><span class="line"><span class="comment">&quot; (3) 按向下方向键选择要参与格式化的行。</span></span><br><span class="line"><span class="comment">&quot; (4) 按下等号=，格式化所选行代码。</span></span><br><span class="line"><span class="comment">&quot;</span></span><br><span class="line"><span class="comment">&quot; 也可以在normal模式下，连续输入 5gg=8G ，也可以格式化5~8行的文档</span></span><br><span class="line"><span class="comment">&quot;==============================================================</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">&quot; 当我们并不知道确切的命令名称时，可以只输入开头的几个字母，然后按下Tab键，就将在底部显示可能匹配的命令。</span></span><br><span class="line"><span class="comment">&quot; 继续按Tab键，可以在这些命令列表间移动，左右方向键也可以移动，没有找到命令时可以按esc退出选择窗口</span></span><br><span class="line"><span class="keyword">set</span> wildmenu</span><br><span class="line"><span class="comment">&quot; 第一次按tab键时会先打印所有匹配的命令名称，再次按tab才会在命令中进行</span></span><br><span class="line"><span class="keyword">set</span> wildmode=lis<span class="variable">t:longest</span>,full</span><br><span class="line"></span><br><span class="line"><span class="comment">&quot; autocmd 自动执行指令，参考：http://yyq123.github.io/learn-vim/learn-vi-49-01-autocmd.html</span></span><br><span class="line"><span class="comment">&quot; 快速跳转到上次退出时光标所在行: &#x27;0 不好用啊，会打开buffer</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">has</span>(<span class="string">&quot;autocmd&quot;</span>)</span><br><span class="line">  <span class="comment">&quot; autocmd可以简写为au</span></span><br><span class="line">  <span class="keyword">au</span> BufReadPost * <span class="keyword">if</span> <span class="built_in">line</span>(<span class="string">&quot;&#x27;\&quot;&quot;</span>) &gt; <span class="number">1</span> &amp;&amp; <span class="built_in">line</span>(<span class="string">&quot;&#x27;\&quot;&quot;</span>) &lt;= <span class="built_in">line</span>(<span class="string">&quot;$&quot;</span>) | <span class="keyword">exe</span> <span class="string">&quot;normal! g&#x27;\&quot;&quot;</span> | <span class="keyword">endif</span></span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&quot; 查看用&lt;&gt;括起来的快捷键的含义  :help keycodes</span></span><br><span class="line"><span class="keyword">nmap</span> <span class="symbol">&lt;leader&gt;</span>kk :<span class="keyword">help</span> keycodes<span class="symbol">&lt;CR&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">&quot; 设置&lt;leader&gt;的字符，默认为: \</span></span><br><span class="line"><span class="string">&quot; let mapleader=&quot;</span>,<span class="comment">&quot;</span></span><br><span class="line"><span class="comment">&quot; 按\w保存文件</span></span><br><span class="line"><span class="keyword">nmap</span> <span class="symbol">&lt;leader&gt;</span><span class="keyword">w</span> :<span class="keyword">w</span><span class="symbol">&lt;CR&gt;</span></span><br><span class="line"><span class="comment">&quot; 按\wq保存退出</span></span><br><span class="line"><span class="keyword">nmap</span> <span class="symbol">&lt;leader&gt;</span><span class="keyword">wq</span> :<span class="keyword">wq</span><span class="symbol">&lt;CR&gt;</span></span><br><span class="line"><span class="comment">&quot; 按\qq不保存退出</span></span><br><span class="line"><span class="keyword">nmap</span> <span class="symbol">&lt;leader&gt;</span>qq :q!<span class="symbol">&lt;CR&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&quot; \ev，在新tab中打开vimrc配置文件，按\tn在多个tab中切换,按\tc关闭当前tab</span></span><br><span class="line"><span class="keyword">nmap</span> <span class="symbol">&lt;leader&gt;</span>ev :<span class="keyword">tabe</span><span class="symbol">&lt;Space&gt;</span>$MYVIMRC<span class="symbol">&lt;CR&gt;</span></span><br><span class="line"><span class="comment">&quot; 让配置变更保存时就立即生效，:w，这里只针对.vimrc文件保存时生效，其它文件需要重新打开才生效</span></span><br><span class="line"><span class="keyword">autocmd</span> BufWritePost $MYVIMRC <span class="keyword">source</span> $MYVIMRC</span><br><span class="line"></span><br><span class="line"><span class="comment">&quot;高亮显示当前行</span></span><br><span class="line"><span class="keyword">set</span> cursorline</span><br><span class="line"><span class="comment">&quot;高亮显示当前列</span></span><br><span class="line"><span class="keyword">set</span> cursorcolumn</span><br><span class="line"></span><br><span class="line"><span class="comment">&quot; 颜色模式</span></span><br><span class="line"><span class="comment">&quot;https://github.com/tomasr/molokai</span></span><br><span class="line"><span class="keyword">colorscheme</span> molokai</span><br><span class="line"><span class="comment">&quot;-----------------molokai setting---------</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">g:molokai_original</span> = <span class="number">1</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">g:rehash256</span> = <span class="number">1</span></span><br><span class="line"><span class="comment">&quot;-----------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&quot;https://github.com/altercation/vim-colors-solarized</span></span><br><span class="line"><span class="comment">&quot;colorscheme solarized</span></span><br><span class="line"><span class="comment">&quot;--------------solarizded setting---------</span></span><br><span class="line"><span class="comment">&quot; 使用 termnal 背景</span></span><br><span class="line"><span class="comment">&quot;let g:solarized_termtrans  = 1</span></span><br><span class="line"><span class="comment">&quot;let g:solarized_termcolors=256</span></span><br><span class="line"><span class="comment">&quot; 使用 :set list 显示特殊字符时的高亮级别</span></span><br><span class="line"><span class="comment">&quot;let g:solarized_visibility = &#x27;high&#x27;</span></span><br><span class="line"><span class="comment">&quot;-----------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&quot;https://github.com/morhetz/gruvbox</span></span><br><span class="line"><span class="comment">&quot;colorscheme gruvbox</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&quot;https://github.com/rakr/vim-one</span></span><br><span class="line"><span class="comment">&quot;colorscheme one</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&quot;macos 自带</span></span><br><span class="line"><span class="comment">&quot; colorscheme desert</span></span><br><span class="line"><span class="comment">&quot;colorscheme pablo</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span> background=dark</span><br><span class="line"></span><br><span class="line"><span class="comment">&quot; 高亮搜索结果</span></span><br><span class="line"><span class="keyword">set</span> hlsearch</span><br><span class="line"><span class="comment">&quot;取消搜索后高亮 &lt;silent&gt;表示静默执行，就是不打印命令</span></span><br><span class="line"><span class="keyword">nnoremap</span> <span class="symbol">&lt;silent&gt;</span><span class="symbol">&lt;leader&gt;</span>h :<span class="keyword">noh</span><span class="symbol">&lt;CR&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&quot; 取消自动折行，一行内容超出屏幕时不进行折行显示</span></span><br><span class="line"><span class="keyword">set</span> nowrap</span><br><span class="line"><span class="comment">&quot; set wrap</span></span><br><span class="line"><span class="comment">&quot; 一行内容超出屏幕时，实现更加平滑的逐个字符扩展显示</span></span><br><span class="line"><span class="keyword">set</span> sidescroll=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&quot; 解决插入模式下delete/backspce键失效问题</span></span><br><span class="line"><span class="comment">&quot; https://www.cnblogs.com/shengulong/p/10530188.html</span></span><br><span class="line"><span class="keyword">set</span> backspace=<span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&quot; 括号和引号的自动补全</span></span><br><span class="line"><span class="keyword">inoremap</span> ( ()<span class="symbol">&lt;ESC&gt;</span>i</span><br><span class="line"><span class="keyword">inoremap</span> [ []<span class="symbol">&lt;ESC&gt;</span>i</span><br><span class="line"><span class="keyword">inoremap</span> &#123; &#123;&#125;<span class="symbol">&lt;ESC&gt;</span>i</span><br><span class="line"><span class="keyword">inoremap</span> <span class="string">&#x27; &#x27;</span><span class="string">&#x27;&lt;ESC&gt;i</span></span><br><span class="line"><span class="string">inoremap &quot; &quot;&quot;&lt;ESC&gt;i</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot; 针对不同的文件类型采用不同的缩进格式</span></span><br><span class="line"><span class="string">filetype indent on</span></span><br><span class="line"><span class="string">&quot; 针对不同的文件类型加载对应的插件</span></span><br><span class="line"><span class="string">filetype plugin on</span></span><br><span class="line"><span class="string">&quot; 启用自动补全</span></span><br><span class="line"><span class="string">&quot;filetype plugin indent on</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot; set rtp+=/usr/local/opt/fzf</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;---------------------------------vim-plug setting------------------------------</span></span><br><span class="line"><span class="string">&quot; vim-plug插件管理器的声明及配置，具体配置参考： https://github.com/junegunn/vim-plug</span></span><br><span class="line"><span class="string">call plug#begin(&#x27;</span>~/.<span class="keyword">vim</span>/plugged<span class="string">&#x27;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot; If installed using Homebrew</span></span><br><span class="line"><span class="string">&quot; 文件搜索</span></span><br><span class="line"><span class="string">Plug &#x27;</span>/usr/local/<span class="keyword">opt</span>/fzf<span class="string">&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot; https://github.com/junegunn/vim-easy-align</span></span><br><span class="line"><span class="string">&quot; 文本对其</span></span><br><span class="line"><span class="string">Plug &#x27;</span>junegunn/<span class="keyword">vim</span>-easy-align<span class="string">&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot; https://github.com/vim-airline/vim-airline</span></span><br><span class="line"><span class="string">&quot; 状态栏设置</span></span><br><span class="line"><span class="string">Plug &#x27;</span><span class="keyword">vim</span>-airline/<span class="keyword">vim</span>-airline<span class="string">&#x27;</span></span><br><span class="line"><span class="string">&quot; Plug &#x27;</span><span class="keyword">vim</span>-airline/<span class="keyword">vim</span>-airline-themes<span class="string">&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot; https://github.com/ycm-core/YouCompleteMe#installation</span></span><br><span class="line"><span class="string">&quot; 代码提示</span></span><br><span class="line"><span class="string">Plug &#x27;</span>Valloric/YouCompleteMe<span class="string">&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;https://github.com/preservim/nerdtree</span></span><br><span class="line"><span class="string">&quot;目录树</span></span><br><span class="line"><span class="string">Plug &#x27;</span>preservim/nerdtree<span class="string">&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;https://github.com/preservim/tagbar</span></span><br><span class="line"><span class="string">&quot;将当前文件的内容分类展示，比如java代码中的package\method\field等等</span></span><br><span class="line"><span class="string">Plug &#x27;</span>preservim/tagbar<span class="string">&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;https://github.com/SirVer/ultisnips</span></span><br><span class="line"><span class="string">&quot;代码片段补全</span></span><br><span class="line"><span class="string">Plug &#x27;</span>SirVer/ultisnips<span class="string">&#x27;</span></span><br><span class="line"><span class="string">&quot; 网友贡献的补全片段</span></span><br><span class="line"><span class="string">Plug &#x27;</span>honza/<span class="keyword">vim</span>-snippets<span class="string">&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;https://github.com/preservim/nerdcommenter</span></span><br><span class="line"><span class="string">&quot;注释插件</span></span><br><span class="line"><span class="string">Plug &#x27;</span>preservim/nerdcommenter<span class="string">&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;https://github.com/tpope/vim-surround</span></span><br><span class="line"><span class="string">&quot;引号、括号等的替换和删除</span></span><br><span class="line"><span class="string">Plug &#x27;</span>tpope/<span class="keyword">vim</span>-surround<span class="string">&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot; https://github.com/mhinz/vim-signify</span></span><br><span class="line"><span class="string">&quot; svn\git插件，修改文件时状态栏会有记录</span></span><br><span class="line"><span class="string">if has(&#x27;</span>nvim<span class="string">&#x27;) || has(&#x27;</span>patch-<span class="number">8.0</span>.<span class="number">902</span><span class="string">&#x27;)</span></span><br><span class="line"><span class="string">  Plug &#x27;</span>mhinz/<span class="keyword">vim</span>-signify<span class="string">&#x27;</span></span><br><span class="line"><span class="string">else</span></span><br><span class="line"><span class="string">  Plug &#x27;</span>mhinz/<span class="keyword">vim</span>-signify<span class="string">&#x27;, &#123; &#x27;</span>branch<span class="string">&#x27;: &#x27;</span>legacy<span class="string">&#x27; &#125;</span></span><br><span class="line"><span class="string">endif</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot; https://github.com/kshenoy/vim-signature</span></span><br><span class="line"><span class="string">&quot; 窗口左侧显示标记</span></span><br><span class="line"><span class="string">Plug &#x27;</span>kshenoy/<span class="keyword">vim</span>-signature<span class="string">&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">call plug#end()</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;---------------------------------vim-plug setting------------------------------</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;###############以下是单个插件的特殊配置项#########################&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;----------------------vim-easy-align setting--------------------</span></span><br><span class="line"><span class="string">&quot; Start interactive EasyAlign in visual mode (e.g. vipga)</span></span><br><span class="line"><span class="string">&quot; vipga</span></span><br><span class="line"><span class="string">xmap ga &lt;Plug&gt;(EasyAlign)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot; Start interactive EasyAlign for a motion/text object (e.g. gaip)</span></span><br><span class="line"><span class="string">&quot; gaip</span></span><br><span class="line"><span class="string">nmap ga &lt;Plug&gt;(EasyAlign)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;----------------------vim-easy-align setting--------------------</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;----------------------vim-airline setting-----------------------</span></span><br><span class="line"><span class="string">if !exists(&#x27;</span><span class="variable">g:airline_symbols</span><span class="string">&#x27;)</span></span><br><span class="line"><span class="string">  let g:airline_symbols = &#123;&#125;</span></span><br><span class="line"><span class="string">endif</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot; default theme is dark</span></span><br><span class="line"><span class="string">&quot; let g:airline_theme = &#x27;</span>dark<span class="string">&#x27;</span></span><br><span class="line"><span class="string">&quot; let g:airline_theme = &#x27;</span>luna<span class="string">&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">let g:airline_left_sep = &#x27;</span>▶<span class="string">&#x27;</span></span><br><span class="line"><span class="string">let g:airline_left_alt_sep = &#x27;</span>❯<span class="string">&#x27;</span></span><br><span class="line"><span class="string">let g:airline_right_sep = &#x27;</span>◀<span class="string">&#x27;</span></span><br><span class="line"><span class="string">let g:airline_right_alt_sep = &#x27;</span>❮<span class="string">&#x27;</span></span><br><span class="line"><span class="string">&quot; let g:airline_symbols.linenr = &#x27;</span>¶<span class="string">&#x27;</span></span><br><span class="line"><span class="string">let g:airline_symbols.branch = &#x27;</span>⎇<span class="string">&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot; 缓冲区：http://yyq123.blogspot.com/2009/07/vim-buffer.html</span></span><br><span class="line"><span class="string">&quot; 是否打开tabline,打开后，tabline和tmuxline都可以得到增强</span></span><br><span class="line"><span class="string">&quot; let g:airline#extensions#tabline#enabled = 1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot; tabline中当前buffer两端的分隔字符</span></span><br><span class="line"><span class="string">let g:airline#extensions#tabline#left_sep = &#x27;</span> <span class="string">&#x27;</span></span><br><span class="line"><span class="string">&quot; tabline中未激活buffer两端的分隔字符</span></span><br><span class="line"><span class="string">let g:airline#extensions#tabline#left_alt_sep = &#x27;</span>|<span class="string">&#x27;</span></span><br><span class="line"><span class="string">&quot; tabline中buffer显示编号</span></span><br><span class="line"><span class="string">let g:airline#extensions#tabline#buffer_nr_show = 1</span></span><br><span class="line"><span class="string">&quot; 映射切换buffer的键位</span></span><br><span class="line"><span class="string">nnoremap [b :bp&lt;CR&gt;</span></span><br><span class="line"><span class="string">nnoremap ]b :bn&lt;CR&gt;</span></span><br><span class="line"><span class="string">&quot; 映射&lt;leader&gt;num到num buffer</span></span><br><span class="line"><span class="string">map &lt;leader&gt;1 :b 1&lt;CR&gt;</span></span><br><span class="line"><span class="string">map &lt;leader&gt;2 :b 2&lt;CR&gt;</span></span><br><span class="line"><span class="string">map &lt;leader&gt;3 :b 3&lt;CR&gt;</span></span><br><span class="line"><span class="string">map &lt;leader&gt;4 :b 4&lt;CR&gt;</span></span><br><span class="line"><span class="string">map &lt;leader&gt;5 :b 5&lt;CR&gt;</span></span><br><span class="line"><span class="string">map &lt;leader&gt;6 :b 6&lt;CR&gt;</span></span><br><span class="line"><span class="string">map &lt;leader&gt;7 :b 7&lt;CR&gt;</span></span><br><span class="line"><span class="string">map &lt;leader&gt;8 :b 8&lt;CR&gt;</span></span><br><span class="line"><span class="string">map &lt;leader&gt;9 :b 9&lt;CR&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot; let g:airline#extensions#hunks#enabled=0</span></span><br><span class="line"><span class="string">&quot; let g:airline#extensions#branch#enabled=1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;----------------------vim-airline setting-----------------------</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;----------------------YouCompleteMe setting---------------------</span></span><br><span class="line"><span class="string">&quot;---------------------简称：YCM--------------------</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;打开vim时不再询问是否加载ycm_extra_conf.py配置</span></span><br><span class="line"><span class="string">let g:ycm_confirm_extra_conf=0</span></span><br><span class="line"><span class="string">&quot;让Vim的补全菜单行为与一般IDE一致(参考VimTip1228)</span></span><br><span class="line"><span class="string">set completeopt=longest,menu</span></span><br><span class="line"><span class="string">&quot;python解释器路径</span></span><br><span class="line"><span class="string">&quot;let g:ycm_path_to_python_interpreter=&#x27;</span>/usr/bin/<span class="keyword">python</span><span class="string">&#x27;</span></span><br><span class="line"><span class="string">&quot;是否开启语义补全</span></span><br><span class="line"><span class="string">let g:ycm_seed_identifiers_with_syntax=1</span></span><br><span class="line"><span class="string">&quot;是否在注释中也开启补全</span></span><br><span class="line"><span class="string">let g:ycm_complete_in_comments=1</span></span><br><span class="line"><span class="string">let g:ycm_collect_identifiers_from_comments_and_strings = 0</span></span><br><span class="line"><span class="string">&quot;开始补全的字符数</span></span><br><span class="line"><span class="string">let g:ycm_min_num_of_chars_for_completion=2</span></span><br><span class="line"><span class="string">&quot;补全后自动关闭预览窗口</span></span><br><span class="line"><span class="string">let g:ycm_autoclose_preview_window_after_completion=1</span></span><br><span class="line"><span class="string">let g:ycm_autoclose_preview_window_after_insertion=1</span></span><br><span class="line"><span class="string">&quot; 禁止缓存匹配项,每次都重新生成匹配项</span></span><br><span class="line"><span class="string">let g:ycm_cache_omnifunc=0</span></span><br><span class="line"><span class="string">&quot;字符串中也开启补全</span></span><br><span class="line"><span class="string">let g:ycm_complete_in_strings = 1</span></span><br><span class="line"><span class="string">&quot;离开插入模式后自动关闭预览窗口</span></span><br><span class="line"><span class="string">autocmd InsertLeave * if pumvisible() == 0|pclose|endif</span></span><br><span class="line"><span class="string">&quot; 空格键用于关闭补全窗口</span></span><br><span class="line"><span class="string">let g:ycm_key_list_stop_completion = [&#x27;</span><span class="symbol">&lt;space&gt;</span><span class="string">&#x27;]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;默认关闭代码自动提示，目前只安装了c和python语言的代码提示，所以需要代码提示时，可以在NORMAL模式下输入&#x27;</span>\+<span class="keyword">y</span><span class="string">&#x27;开启代码提示</span></span><br><span class="line"><span class="string">let g:ycm_auto_trigger=0</span></span><br><span class="line"><span class="string">&quot;turn on YCM：</span></span><br><span class="line"><span class="string">&quot;\+y一起按，看到命令输出后回车即可，这里&lt;leader&gt;代表命令前缀，默认为\</span></span><br><span class="line"><span class="string">nnoremap &lt;leader&gt;y :let g:ycm_auto_trigger=1&lt;CR&gt;</span></span><br><span class="line"><span class="string">&quot;turn off YCM：\+y+y一起按</span></span><br><span class="line"><span class="string">nnoremap &lt;leader&gt;yy :let g:ycm_auto_trigger=0&lt;CR&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;----------------------YouCompleteMe setting---------------------</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;-------------NERDTree setting-----------------------</span></span><br><span class="line"><span class="string">&quot;######常用快捷键说明########</span></span><br><span class="line"><span class="string">&quot;Ctrl + t 打开/关闭nerdtree</span></span><br><span class="line"><span class="string">&quot;Ctrl + n 打开、回到最开始打开的文件目录</span></span><br><span class="line"><span class="string">&quot;Shift + f 打开上级目录</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">&quot;Ctrl + w + w	光标在 nerdtree 和 vim 编辑窗口 之间切换</span></span><br><span class="line"><span class="string">&quot;Ctrl + w + (h/j/k/l)  即h左、j下、k上、l右，表示窗口切换的方向</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">&quot;q	关闭 nerdtree</span></span><br><span class="line"><span class="string">&quot;o	打开选中的文件； 折叠/展开选中的目录</span></span><br><span class="line"><span class="string">&quot;i	打开选中的文件，与已打开文件纵向排布窗口，并跳转至该窗口</span></span><br><span class="line"><span class="string">&quot;gi	打开选中的文件，与已打开文件纵向排布窗口，但不跳转至该窗口</span></span><br><span class="line"><span class="string">&quot;s	打开选中的文件，与已打开文件横向排布窗口，并跳转至该窗口</span></span><br><span class="line"><span class="string">&quot;gs	打开选中的文件，与已打开文件横向排布窗口，但不跳转至该窗口</span></span><br><span class="line"><span class="string">&quot;t	在新 Tab 中打开选中文件/书签，并跳到新 Tab</span></span><br><span class="line"><span class="string">&quot;T	在新 Tab 中打开选中文件/书签，但不跳到新 Tab</span></span><br><span class="line"><span class="string">&quot;x	折叠选中结点的父目录</span></span><br><span class="line"><span class="string">&quot;X	递归折叠选中结点下的所有目录</span></span><br><span class="line"><span class="string">&quot;k / j	光标在 Neadtree 上下移动</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">&quot;&lt;leader&gt;tc	:tabc   关闭当前的 tab</span></span><br><span class="line"><span class="string">&quot;&lt;leader&gt;to	:tabo   关闭所有其他 tab</span></span><br><span class="line"><span class="string">&quot;&lt;leader&gt;ts	:tabs   查看所有打开的 tab</span></span><br><span class="line"><span class="string">&quot;&lt;leader&gt;tp	:tabp   前一个 tab</span></span><br><span class="line"><span class="string">&quot;&lt;leader&gt;tn	:tabn   后一个 tab</span></span><br><span class="line"><span class="string">&quot;?	显示菜单</span></span><br><span class="line"><span class="string">&quot;######常用快捷键说明########</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot; 高亮当前行</span></span><br><span class="line"><span class="string">let NERDTreeHighlightCursorline = 1</span></span><br><span class="line"><span class="string">&quot; 显示行号</span></span><br><span class="line"><span class="string">let NERDTreeShowLineNumbers     = 1</span></span><br><span class="line"><span class="string">&quot; 忽略列表中的文件</span></span><br><span class="line"><span class="string">let NERDTreeIgnore = [ &#x27;</span>\.pyc$<span class="string">&#x27;, &#x27;</span>\.pyo$<span class="string">&#x27;, &#x27;</span>\.obj$<span class="string">&#x27;, &#x27;</span>\.<span class="keyword">o</span>$<span class="string">&#x27;, &#x27;</span>\.egg$<span class="string">&#x27;, &#x27;</span>^\.git$<span class="string">&#x27;, &#x27;</span>^\.repo$<span class="string">&#x27;, &#x27;</span>^\.svn$<span class="string">&#x27;, &#x27;</span>^\.hg$<span class="string">&#x27; ]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">nnoremap &lt;leader&gt;n :NERDTreeFocus&lt;CR&gt;</span></span><br><span class="line"><span class="string">&quot;打开、回到最开始打开的文件目录</span></span><br><span class="line"><span class="string">nnoremap &lt;C-n&gt; :NERDTree&lt;CR&gt;</span></span><br><span class="line"><span class="string">&quot;打开、关闭目录</span></span><br><span class="line"><span class="string">nnoremap &lt;C-t&gt; :NERDTreeToggle&lt;CR&gt;</span></span><br><span class="line"><span class="string">&quot;打开上级目录</span></span><br><span class="line"><span class="string">nnoremap &lt;S-f&gt; :NERDTreeFind&lt;CR&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot; \tc 关闭当前的 tab</span></span><br><span class="line"><span class="string">map &lt;leader&gt;tc :tabc&lt;CR&gt;</span></span><br><span class="line"><span class="string">&quot; \to 关闭所有其他的 tab</span></span><br><span class="line"><span class="string">map &lt;leader&gt;to :tabo&lt;CR&gt;</span></span><br><span class="line"><span class="string">&quot; \ts 查看所有打开的 tab</span></span><br><span class="line"><span class="string">map &lt;leader&gt;ts :tabs&lt;CR&gt;</span></span><br><span class="line"><span class="string">&quot; \tp 前一个 tab</span></span><br><span class="line"><span class="string">map &lt;leader&gt;tp :tabp&lt;CR&gt;</span></span><br><span class="line"><span class="string">&quot; \tn 后一个 tab</span></span><br><span class="line"><span class="string">map &lt;leader&gt;tn :tabn&lt;CR&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot; Exit Vim if NERDTree is the only window left.</span></span><br><span class="line"><span class="string">&quot; 关闭 NERDTree，当没有文件打开的时候</span></span><br><span class="line"><span class="string">autocmd BufEnter * if tabpagenr(&#x27;</span>$<span class="string">&#x27;) == 1 &amp;&amp; winnr(&#x27;</span>$<span class="string">&#x27;) == 1 &amp;&amp; exists(&#x27;</span><span class="variable">b:NERDTree</span><span class="string">&#x27;) &amp;&amp; b:NERDTree.isTabTree() |</span></span><br><span class="line"><span class="string">    \ quit | endif</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot; 启动 vim 时打开 NERDTree</span></span><br><span class="line"><span class="string">&quot;autocmd vimenter * NERDTree</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot; 当打开 VIM，没有指定文件时和打开一个目录时，打开 NERDTree</span></span><br><span class="line"><span class="string">autocmd StdinReadPre * let s:std_in=1</span></span><br><span class="line"><span class="string">autocmd VimEnter * if argc() == 1 &amp;&amp; isdirectory(argv()[0]) &amp;&amp; !exists(&#x27;</span><span class="variable">s:std_in</span><span class="string">&#x27;) |</span></span><br><span class="line"><span class="string">    \ execute &#x27;</span>NERDTree<span class="string">&#x27; argv()[0] | wincmd p | enew | execute &#x27;</span><span class="keyword">cd</span> <span class="string">&#x27;.argv()[0] | endif</span></span><br><span class="line"><span class="string">autocmd VimEnter * if argc() == 0 &amp;&amp; !exists(&#x27;</span><span class="variable">s:std_in</span><span class="string">&#x27;) | NERDTree | endif</span></span><br><span class="line"><span class="string">&quot;-------------NERDTree setting-----------------------</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;-----------tagbar setting---------------------------</span></span><br><span class="line"><span class="string">&quot;Ctrl - w - w	光标在 Tagbar 和 vim 编辑窗口 之间切换</span></span><br><span class="line"><span class="string">&quot;&lt;leader&gt;tb	打开 tagbar</span></span><br><span class="line"><span class="string">&quot;q	关闭 tagbar</span></span><br><span class="line"><span class="string">&quot;o（+/-）	折叠 / 展开标签集合</span></span><br><span class="line"><span class="string">&quot;p	跳转到选中的标签，但光标仍停留在 Tagbar</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot; tagbar 依赖 ctags 插件 brew install ctags</span></span><br><span class="line"><span class="string">let g:tagbar_ctags_bin = &#x27;</span>ctags<span class="string">&#x27;</span></span><br><span class="line"><span class="string">&quot; 设置 tagbar 的宽度为 30 列，默认 40 列</span></span><br><span class="line"><span class="string">let g:tagbar_width     = 30</span></span><br><span class="line"><span class="string">&quot; 打开 tagbar 时光标在 tagbar 页面内，默认在 vim 打开的文件内</span></span><br><span class="line"><span class="string">let g:tagbar_autofocus = 1</span></span><br><span class="line"><span class="string">&quot; 让 tagbar 在页面左侧显示，默认右边</span></span><br><span class="line"><span class="string">let g:tagbar_left      = 1</span></span><br><span class="line"><span class="string">&quot; 标签不排序，默认排序</span></span><br><span class="line"><span class="string">&quot;let g:tagbar_sort      = 0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot; &lt;leader&gt;tb 打开 tagbar 窗口，在左侧栏显示</span></span><br><span class="line"><span class="string">nmap &lt;leader&gt;tb :TagbarToggle&lt;CR&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;-----------tagbar setting---------------------------</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;----------ultisnips setting-------------------------</span></span><br><span class="line"><span class="string">&quot;:UltiSnipsEdit 显示帮助信息&quot;</span></span><br><span class="line"><span class="string">&quot; 片段信息寻找的文件夹名称，默认UltiSnips，多个逗号分隔</span></span><br><span class="line"><span class="string">&quot;let g:UltiSnipsSnippetDirectories = [&#x27;</span>UltiSnips<span class="string">&#x27;]</span></span><br><span class="line"><span class="string">&quot; :UltiSnipsEdit 显示帮助信的目录路径，默认~/.vim/UltiSnips</span></span><br><span class="line"><span class="string">let g:UltiSnipsSnippetStorageDirectoryForUltiSnipsEdit = &#x27;</span>~/.<span class="keyword">vim</span>/plugged/<span class="keyword">vim</span>-snippets/UltiSnips<span class="string">&#x27;</span></span><br><span class="line"><span class="string">&quot; 代码片段补全触发，需要在编辑模式</span></span><br><span class="line"><span class="string">let g:UltiSnipsExpandTrigger       = &#x27;</span><span class="symbol">&lt;c-w&gt;</span><span class="string">&#x27;</span></span><br><span class="line"><span class="string">&quot; 列出补全可选列表，需要在编辑模式，可以在输入一些字符后调用，显示当前字符的代码片段提示</span></span><br><span class="line"><span class="string">let g:UltiSnipsListSnippets        = &#x27;</span>&lt;<span class="keyword">c</span>-\&gt;<span class="string">&#x27;</span></span><br><span class="line"><span class="string">&quot; 下一条补全，需要在编辑模式，不好使</span></span><br><span class="line"><span class="string">let g:UltiSnipsJumpForwardTrigger  = &#x27;</span><span class="symbol">&lt;c-b&gt;</span><span class="string">&#x27;</span></span><br><span class="line"><span class="string">&quot; 上一条补全，需要在编辑模式，不好使</span></span><br><span class="line"><span class="string">let g:UltiSnipsJumpBackwardTrigger = &#x27;</span><span class="symbol">&lt;c-z&gt;</span><span class="string">&#x27;</span></span><br><span class="line"><span class="string">&quot; 帮助信息水平显示</span></span><br><span class="line"><span class="string">let g:UltiSnipsEditSplit           = &#x27;</span>horizontal<span class="string">&#x27;</span></span><br><span class="line"><span class="string">&quot; 帮助信息垂直显示</span></span><br><span class="line"><span class="string">&quot;let g:UltiSnipsEditSplit           = &#x27;</span><span class="keyword">vertical</span><span class="string">&#x27;</span></span><br><span class="line"><span class="string">&quot; python3</span></span><br><span class="line"><span class="string">&quot;let g:UltiSnipsUsePythonVersion = 3</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;----------ultisnips setting--------------------------</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;------------nerdcommenter setting--------------------</span></span><br><span class="line"><span class="string">&quot; \c+空格</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;[count]&lt;leader&gt;cc	注释当前行起始的 [count]行 或者 注释 visual mode 选中的文本</span></span><br><span class="line"><span class="string">&quot;[count]&lt;leader&gt;cn	注释方式同 &lt;leader&gt;cc，但是强制嵌套</span></span><br><span class="line"><span class="string">&quot;[count]&lt;leader&gt;c&lt;space&gt;	这个是最重要的，记住这一个就行了。切换所选行的注释状态。 如果注释了最上面的选定行，则取消注释所有选定行，反之亦然。</span></span><br><span class="line"><span class="string">&quot;[count]&lt;leader&gt;cm	使用一组多行注释符注释选定行</span></span><br><span class="line"><span class="string">&quot;[count]&lt;leader&gt;ci	单独切换所选行的各行注释状态</span></span><br><span class="line"><span class="string">&quot;[count]&lt;leader&gt;cs	使用块格式布局注释掉选定的行。</span></span><br><span class="line"><span class="string">&quot;&lt;leader&gt;c$	注释从光标到行尾的当前行。</span></span><br><span class="line"><span class="string">&quot;&lt;leader&gt;cA	在行尾添加注释，并切换至插入模式，光标停留在注释符中间</span></span><br><span class="line"><span class="string">&quot;[count]&lt;leader&gt;cl</span></span><br><span class="line"><span class="string">&quot;[count]&lt;leader&gt;cb	注释方式同 &lt;leader&gt;cc，注释符左对齐（&lt;leader&gt;cl）或者两边对齐（&lt;leader&gt;cb）</span></span><br><span class="line"><span class="string">&quot;[count]&lt;leader&gt;cu	取消选定行的注释</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot; 在注释符号后加一个空格</span></span><br><span class="line"><span class="string">let g:NERDSpaceDelims            = 1</span></span><br><span class="line"><span class="string">&quot; 紧凑排布多行注释</span></span><br><span class="line"><span class="string">let g:NERDCompactSexyComs        = 1</span></span><br><span class="line"><span class="string">&quot; 逐行注释左对齐</span></span><br><span class="line"><span class="string">let g:NERDDefaultAlign           = &#x27;</span><span class="keyword">left</span><span class="string">&#x27;</span></span><br><span class="line"><span class="string">&quot; JAVA 语言使用默认的注释符号</span></span><br><span class="line"><span class="string">let g:NERDAltDelims_java         = 1</span></span><br><span class="line"><span class="string">&quot; C 语言注释符号</span></span><br><span class="line"><span class="string">let g:NERDCustomDelimiters       = &#123;&#x27;</span><span class="keyword">c</span><span class="string">&#x27;: &#123;&#x27;</span><span class="keyword">left</span><span class="string">&#x27;: &#x27;</span>/**<span class="string">&#x27;, &#x27;</span><span class="keyword">right</span><span class="string">&#x27;: &#x27;</span>*/<span class="string">&#x27;&#125;&#125;</span></span><br><span class="line"><span class="string">&quot; 允许空行注释</span></span><br><span class="line"><span class="string">let g:NERDCommentEmptyLines      = 1</span></span><br><span class="line"><span class="string">&quot; 取消注释时删除行尾空格</span></span><br><span class="line"><span class="string">let g:NERDTrimTrailingWhitespace = 1</span></span><br><span class="line"><span class="string">&quot; 检查选中的行操作是否成功</span></span><br><span class="line"><span class="string">let g:NERDToggleCheckAllLines    = 1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;------------nerdcommenter setting--------------------</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;------------fzf setting------------------------------</span></span><br><span class="line"><span class="string">&quot; 在当前目录搜索文件</span></span><br><span class="line"><span class="string">nnoremap &lt;Leader&gt;f :FZF&lt;CR&gt;</span></span><br><span class="line"><span class="string">&quot;------------fzf setting------------------------------</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot; ----------tpope/vim-surround setting---------------</span></span><br><span class="line"><span class="string">&quot; normal模式下，光标所在航</span></span><br><span class="line"><span class="string">&quot; 替换：</span></span><br><span class="line"><span class="string">&quot; cs&quot;&#x27;</span>  : 将光标所在行中成对出现的双引号替换为单引号</span><br><span class="line"><span class="comment">&quot; cs([  : 将小括号替换为中括号</span></span><br><span class="line"><span class="string">&quot; cst&quot;</span>  : 将当前文本两边成对出现的引号或括号替换为双引号</span><br><span class="line"><span class="comment">&quot; 删除:</span></span><br><span class="line"><span class="string">&quot; ds&quot;</span>   : 删除双引号</span><br><span class="line"><span class="comment">&quot; 添加：</span></span><br><span class="line"><span class="string">&quot; ysiw&quot;</span>  : 将光标所在单词添加上双引号</span><br><span class="line"><span class="string">&quot; yss&quot;</span>   : 将当前行添加上双引号</span><br><span class="line"><span class="comment">&quot; ----------tpope/vim-surround setting---------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&quot; ----------mhinz/vim-signify setting----------------</span></span><br><span class="line"><span class="comment">&quot; default updatetime 4000ms is not good for async update</span></span><br><span class="line"><span class="keyword">set</span> updatetime=<span class="number">100</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&quot; ----------mhinz/vim-signify setting----------------</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>技术</category>
      </categories>
      <tags>
        <tag>vim</tag>
        <tag>vim-plug</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot-OAuth2-JWT-WebFlux-ClientServer</title>
    <url>/2020/12/02/springboot-oauth2-jwt-webflux-clientserver/</url>
    <content><![CDATA[<h2 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h2><ul>
<li>通过本文，你将知道如何搭建一个基于SpringBoot-OAuth2-JWT-WebFlux的客户端服务器</li>
<li>本文基于springboot:2.4.0，项目基于Gradle-6.6.1构建</li>
<li>本文基于<a href="https://blog.hanqunfeng.com/2020/11/15/springboot-oauth2-jwt-clientserver/">SpringBoot-OAuth2-JWT-ClientServer</a>并实现其功能，可以参考对比</li>
<li>代码地址:<a href="https://github.com/hanqunfeng/springbootchapter/tree/master/chapter48">https://github.com/hanqunfeng/springbootchapter/tree/master/chapter48</a></li>
</ul>
<span id="more"></span>
<h2 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h2><ul>
<li>springboot官方提供了支持<figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line"><span class="comment">//webflux</span></span><br><span class="line">implementation <span class="string">&#x27;org.springframework.boot:spring-boot-starter-webflux&#x27;</span></span><br><span class="line">implementation <span class="string">&#x27;org.springframework.boot:spring-boot-starter-oauth2-client&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//本项目使用了自定义授权页面，所以引入视图模板依赖和基于webjar的bootstrap，jquery</span></span><br><span class="line">implementation <span class="string">&#x27;org.springframework.boot:spring-boot-starter-thymeleaf&#x27;</span></span><br><span class="line"><span class="comment">//webjars https://www.webjars.org</span></span><br><span class="line">implementation <span class="string">&#x27;org.webjars:bootstrap:4.5.3&#x27;</span></span><br><span class="line">implementation <span class="string">&#x27;org.webjars.bower:jquery:3.5.1&#x27;</span></span><br><span class="line"><span class="comment">// 可以在html中去掉webjars的版本号，这样升级的时候直接修改上面引入的webjars中的版本号即可，页面中不需要修改</span></span><br><span class="line">implementation <span class="string">&#x27;org.webjars:webjars-locator:0.40&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//r2dbc mysql 库</span></span><br><span class="line">implementation <span class="string">&#x27;dev.miku:r2dbc-mysql&#x27;</span></span><br><span class="line"><span class="comment">//Spring r2dbc 抽象层</span></span><br><span class="line">implementation <span class="string">&#x27;org.springframework.boot:spring-boot-starter-data-r2dbc&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//本项目中使用了lombok减少代码量，非必须依赖</span></span><br><span class="line">compileOnly <span class="string">&#x27;org.projectlombok:lombok&#x27;</span></span><br><span class="line">annotationProcessor <span class="string">&#x27;org.projectlombok:lombok&#x27;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="ReactiveSecurityConfig"><a href="#ReactiveSecurityConfig" class="headerlink" title="ReactiveSecurityConfig"></a>ReactiveSecurityConfig</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.oauth2clientwebfluxdemo.config;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.oauth2clientwebfluxdemo.security.CustomReactiveAuthorizationManager;</span><br><span class="line"><span class="keyword">import</span> com.example.oauth2clientwebfluxdemo.security.CustomServerAccessDeniedHandler;</span><br><span class="line"><span class="keyword">import</span> com.example.oauth2clientwebfluxdemo.security.CustomServerAuthenticationEntryPoint;</span><br><span class="line"><span class="keyword">import</span> com.example.oauth2clientwebfluxdemo.security.CustomServerOAuth2AuthorizedClientRepository;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.method.configuration.EnableReactiveMethodSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.reactive.EnableWebFluxSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.web.server.ServerHttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.server.SecurityWebFilterChain;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.server.authentication.logout.RedirectServerLogoutSuccessHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.server.authentication.logout.ServerLogoutSuccessHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.URI;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;h1&gt;安全认证配置&lt;/h1&gt;</span></span><br><span class="line"><span class="comment"> * Created by hanqf on 2020/11/19 10:26.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebFluxSecurity</span> <span class="comment">//必要</span></span><br><span class="line"><span class="meta">@EnableReactiveMethodSecurity</span> <span class="comment">//启用@PreAuthorize注解配置</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReactiveSecurityConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;oauth2.server.logout&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String oauth2_server_logout;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CustomServerAccessDeniedHandler customServerAccessDeniedHandler;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CustomServerAuthenticationEntryPoint customServerAuthenticationEntryPoint;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CustomReactiveAuthorizationManager customReactiveAuthorizationManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CustomServerOAuth2AuthorizedClientRepository customServerOAuth2AuthorizedClientRepository;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注册安全验证规则</span></span><br><span class="line"><span class="comment">     * 配置方式与HttpSecurity基本一致</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function">SecurityWebFilterChain <span class="title">springSecurityFilterChain</span><span class="params">(ServerHttpSecurity http)</span> </span>&#123; <span class="comment">//定义SecurityWebFilterChain对安全进行控制，使用ServerHttpSecurity构造过滤器链；</span></span><br><span class="line">        <span class="keyword">return</span> http.authorizeExchange()</span><br><span class="line">                <span class="comment">//.anyExchange().authenticated() //所有请求都需要通过认证</span></span><br><span class="line">                .pathMatchers(<span class="string">&quot;/&quot;</span>).authenticated()</span><br><span class="line">                <span class="comment">//需要具备相应的角色才能访问</span></span><br><span class="line">                .pathMatchers(<span class="string">&quot;/user/**&quot;</span>, <span class="string">&quot;/user2/**&quot;</span>).hasAuthority(<span class="string">&quot;SCOPE_any&quot;</span>)</span><br><span class="line">                <span class="comment">//不需要登录就可以访问</span></span><br><span class="line">                .pathMatchers(<span class="string">&quot;/login&quot;</span>,<span class="string">&quot;/webjars/**&quot;</span>).permitAll()</span><br><span class="line"></span><br><span class="line">                <span class="comment">//其它路径需要根据指定的方法判断是否有权限访问，基于权限管理模型认证</span></span><br><span class="line">                .anyExchange().access(customReactiveAuthorizationManager)</span><br><span class="line">                <span class="comment">//.anyExchange().permitAll()</span></span><br><span class="line">                .and()</span><br><span class="line">                .csrf().disable() <span class="comment">//关闭CSRF（Cross-site request forgery）跨站请求伪造</span></span><br><span class="line">                <span class="comment">//必须post访问</span></span><br><span class="line">                .logout().logoutUrl(<span class="string">&quot;/logout&quot;</span>).logoutSuccessHandler(serverLogoutSuccessHandler())</span><br><span class="line">                .and()</span><br><span class="line"></span><br><span class="line">                <span class="comment">//开启oauth2登录认证</span></span><br><span class="line">                .oauth2Login()</span><br><span class="line">                .and()</span><br><span class="line">                <span class="comment">//开启基于oauth2的客户端信息</span></span><br><span class="line">                .oauth2Client()</span><br><span class="line">                <span class="comment">//客户端信息基于数据库，基于内存去掉下面配置即可</span></span><br><span class="line">                .authorizedClientRepository(customServerOAuth2AuthorizedClientRepository)</span><br><span class="line">                .and().exceptionHandling()</span><br><span class="line">                .accessDeniedHandler(customServerAccessDeniedHandler)</span><br><span class="line">                .authenticationEntryPoint(customServerAuthenticationEntryPoint)</span><br><span class="line">                .and()</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 退出重定向到认证登录页面，默认&quot;/login?logout&quot;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServerLogoutSuccessHandler <span class="title">serverLogoutSuccessHandler</span><span class="params">()</span></span>&#123;</span><br><span class="line">        RedirectServerLogoutSuccessHandler redirectServerLogoutSuccessHandler = <span class="keyword">new</span> RedirectServerLogoutSuccessHandler();</span><br><span class="line">        redirectServerLogoutSuccessHandler.setLogoutSuccessUrl(URI.create(oauth2_server_logout));</span><br><span class="line">        <span class="keyword">return</span> redirectServerLogoutSuccessHandler;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="CustomReactiveAuthorizationManager"><a href="#CustomReactiveAuthorizationManager" class="headerlink" title="CustomReactiveAuthorizationManager"></a>CustomReactiveAuthorizationManager</h2><p>基于RBAC权限认证管理模型的认证方式</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.oauth2resourceserverwebfluxdemo.security;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.http.server.reactive.ServerHttpRequest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authorization.AuthorizationDecision;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authorization.ReactiveAuthorizationManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.Authentication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.jwt.Jwt;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.server.authorization.AuthorizationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.AntPathMatcher;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;h1&gt;ReactiveAuthorizationManager&lt;/h1&gt;</span></span><br><span class="line"><span class="comment"> * Created by hanqf on 2020/11/30 12:05.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomReactiveAuthorizationManager</span> <span class="keyword">implements</span> <span class="title">ReactiveAuthorizationManager</span>&lt;<span class="title">AuthorizationContext</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;AuthorizationDecision&gt; <span class="title">check</span><span class="params">(Mono&lt;Authentication&gt; authentication, AuthorizationContext object)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> authentication.map(auth -&gt; &#123;</span><br><span class="line">            ServerHttpRequest request = object.getExchange().getRequest();</span><br><span class="line">            Object principal = auth.getPrincipal();</span><br><span class="line">            String username;</span><br><span class="line">            <span class="keyword">if</span> (principal <span class="keyword">instanceof</span> Jwt) &#123;</span><br><span class="line">                username = ((Jwt) principal).getClaimAsString(<span class="string">&quot;user_name&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                username = principal.toString();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">boolean</span> hasPerssion = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.hasText(username) &amp;&amp; !<span class="string">&quot;anonymousUser&quot;</span>.equals(username)) &#123;</span><br><span class="line">                <span class="comment">//根据用户名查询用户资源权限，这里应该访问数据库查询</span></span><br><span class="line">                Set&lt;String&gt; uris = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">                <span class="keyword">for</span> (String uri : uris) &#123;</span><br><span class="line">                    <span class="comment">//验证用户拥有的资源权限是否与请求的资源相匹配</span></span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">new</span> AntPathMatcher().match(uri, request.getURI().toString())) &#123;</span><br><span class="line">                        hasPerssion = <span class="keyword">true</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//暂时全部返回true</span></span><br><span class="line">            hasPerssion = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> AuthorizationDecision(hasPerssion);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="CustomServerAccessDeniedHandler"><a href="#CustomServerAccessDeniedHandler" class="headerlink" title="CustomServerAccessDeniedHandler"></a>CustomServerAccessDeniedHandler</h2><p>没有权限时的处理方式</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.oauth2resourceserverwebfluxdemo.security;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.oauth2resourceserverwebfluxdemo.exception.AjaxResponse;</span><br><span class="line"><span class="keyword">import</span> com.example.oauth2resourceserverwebfluxdemo.exception.CustomException;</span><br><span class="line"><span class="keyword">import</span> com.example.oauth2resourceserverwebfluxdemo.exception.CustomExceptionType;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.core.JsonProcessingException;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> lombok.SneakyThrows;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.server.reactive.ServerHttpResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.access.AccessDeniedException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.server.authorization.ServerAccessDeniedHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.server.ServerWebExchange;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;h1&gt;没有权限时的处理方式&lt;/h1&gt;</span></span><br><span class="line"><span class="comment"> * Created by hanqf on 2020/11/20 11:56.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomServerAccessDeniedHandler</span> <span class="keyword">implements</span> <span class="title">ServerAccessDeniedHandler</span> </span>&#123;</span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">handle</span><span class="params">(ServerWebExchange serverWebExchange, AccessDeniedException e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> setErrorResponse(serverWebExchange.getResponse(),e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Mono&lt;Void&gt; <span class="title">setErrorResponse</span><span class="params">(ServerHttpResponse response, String message)</span> <span class="keyword">throws</span> JsonProcessingException </span>&#123;</span><br><span class="line">        response.getHeaders().setContentType(MediaType.APPLICATION_JSON);</span><br><span class="line">        ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">        AjaxResponse ajaxResponse = AjaxResponse.error(<span class="keyword">new</span> CustomException(CustomExceptionType.USER_INPUT_ERROR, message));</span><br><span class="line">        <span class="keyword">return</span> response.writeWith(Mono.just(response.bufferFactory().wrap(objectMapper.writeValueAsBytes(ajaxResponse))));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="CustomServerAuthenticationEntryPoint"><a href="#CustomServerAuthenticationEntryPoint" class="headerlink" title="CustomServerAuthenticationEntryPoint"></a>CustomServerAuthenticationEntryPoint</h2><p>token格式错误或过期时的处理方式</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.oauth2resourceserverwebfluxdemo.security;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.oauth2resourceserverwebfluxdemo.exception.AjaxResponse;</span><br><span class="line"><span class="keyword">import</span> com.example.oauth2resourceserverwebfluxdemo.exception.CustomException;</span><br><span class="line"><span class="keyword">import</span> com.example.oauth2resourceserverwebfluxdemo.exception.CustomExceptionType;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.core.JsonProcessingException;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> lombok.SneakyThrows;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.server.reactive.ServerHttpResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.AuthenticationException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.server.ServerAuthenticationEntryPoint;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.server.ServerWebExchange;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;h1&gt;ServerAuthenticationEntryPoint&lt;/h1&gt;</span></span><br><span class="line"><span class="comment"> * Created by hanqf on 2020/11/20 12:01.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * token格式错误或过期时的处理方式</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomServerAuthenticationEntryPoint</span> <span class="keyword">implements</span> <span class="title">ServerAuthenticationEntryPoint</span> </span>&#123;</span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">commence</span><span class="params">(ServerWebExchange serverWebExchange, AuthenticationException e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> setErrorResponse(serverWebExchange.getResponse(), e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Mono&lt;Void&gt; <span class="title">setErrorResponse</span><span class="params">(ServerHttpResponse response, String message)</span> <span class="keyword">throws</span> JsonProcessingException </span>&#123;</span><br><span class="line">        response.getHeaders().setContentType(MediaType.APPLICATION_JSON);</span><br><span class="line">        ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">        AjaxResponse ajaxResponse = AjaxResponse.error(<span class="keyword">new</span> CustomException(CustomExceptionType.USER_INPUT_ERROR, message));</span><br><span class="line">        <span class="keyword">return</span> response.writeWith(Mono.just(response.bufferFactory().wrap(objectMapper.writeValueAsBytes(ajaxResponse))));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="WebFluxConfig"><a href="#WebFluxConfig" class="headerlink" title="WebFluxConfig"></a>WebFluxConfig</h2><p>配置跨域</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.oauth2resourceserverwebfluxdemo.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.reactive.config.CorsRegistry;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.reactive.config.WebFluxConfigurer;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;h1&gt;WebFlux配置类&lt;/h1&gt;</span></span><br><span class="line"><span class="comment"> * Created by hanqf on 2020/11/18 17:43.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 我们若需要配置Spring WebFlux只需让配置配实现接口WebFluxConfigurer，</span></span><br><span class="line"><span class="comment"> * 这样我们既能保留Spring Boot给WebFlux配置又能添加我们的定制配置。</span></span><br><span class="line"><span class="comment"> * 若我们向完全控制WebFlux，则在配置类添加注解<span class="doctag">@EnableWebFlux</span></span></span><br><span class="line"><span class="comment"> * 配置方式和Spring MVC类似</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebFluxConfig</span> <span class="keyword">implements</span> <span class="title">WebFluxConfigurer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//跨域设置</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addCorsMappings</span><span class="params">(CorsRegistry registry)</span> </span>&#123;</span><br><span class="line">        registry.addMapping(<span class="string">&quot;/**&quot;</span>) <span class="comment">//添加映射路径，“/**”表示对所有的路径实行全局跨域访问权限的设置</span></span><br><span class="line">                .allowedMethods(<span class="string">&quot;GET&quot;</span>,<span class="string">&quot;POST&quot;</span>, <span class="string">&quot;PUT&quot;</span>, <span class="string">&quot;DELETE&quot;</span>) <span class="comment">//开放哪些Http方法，允许跨域访问</span></span><br><span class="line">                .allowedHeaders(<span class="string">&quot;*&quot;</span>) <span class="comment">//允许HTTP请求中的携带哪些Header信息</span></span><br><span class="line">                <span class="comment">//When allowCredentials is true, allowedOrigins cannot contain the special value &quot;*&quot;since that cannot be set on the &quot;Access-Control-Allow-Origin&quot; response header.</span></span><br><span class="line">                <span class="comment">// To allow credentials to a set of origins, list them explicitly or consider using &quot;allowedOriginPatterns&quot; instead.</span></span><br><span class="line">                <span class="comment">//.allowedOrigins(&quot;*&quot;) //开放哪些ip、端口、域名的访问权限</span></span><br><span class="line">                .allowedOriginPatterns(<span class="string">&quot;*&quot;</span>)</span><br><span class="line">                .allowCredentials(<span class="keyword">true</span>); <span class="comment">//是否允许发送Cookie信息</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="CustomServerOAuth2AuthorizedClientRepository"><a href="#CustomServerOAuth2AuthorizedClientRepository" class="headerlink" title="CustomServerOAuth2AuthorizedClientRepository"></a>CustomServerOAuth2AuthorizedClientRepository</h2><p>基于jdbc存储token信。</p>
<p>这里有一个注意事项：查询时不要使用.fetch()方法，其会按照字段名称的字母排序进行赋值，导致结果中key和value匹配混乱</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.oauth2clientwebfluxdemo.security;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.dao.DataRetrievalFailureException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.r2dbc.core.DatabaseClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.Authentication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.client.OAuth2AuthorizedClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.client.registration.ClientRegistration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.client.registration.ReactiveClientRegistrationRepository;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.client.web.server.ServerOAuth2AuthorizedClientRepository;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.core.OAuth2AccessToken;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.core.OAuth2RefreshToken;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.Assert;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.server.ServerWebExchange;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"><span class="keyword">import</span> java.time.Instant;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.time.ZoneId;</span><br><span class="line"><span class="keyword">import</span> java.time.format.DateTimeFormatter;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.Optional;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">import</span> java.util.function.Function;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;h1&gt;ServerOAuth2AuthorizedClientRepository&lt;/h1&gt;</span></span><br><span class="line"><span class="comment"> * Created by hanqf on 2020/12/1 09:58.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomServerOAuth2AuthorizedClientRepository</span> <span class="keyword">implements</span> <span class="title">ServerOAuth2AuthorizedClientRepository</span> </span>&#123;</span><br><span class="line">    <span class="comment">// @formatter:off</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String COLUMN_NAMES = <span class="string">&quot;client_registration_id, &quot;</span></span><br><span class="line">            + <span class="string">&quot;principal_name, &quot;</span></span><br><span class="line">            + <span class="string">&quot;access_token_type, &quot;</span></span><br><span class="line">            + <span class="string">&quot;access_token_value, &quot;</span></span><br><span class="line">            + <span class="string">&quot;access_token_issued_at, &quot;</span></span><br><span class="line">            + <span class="string">&quot;access_token_expires_at, &quot;</span></span><br><span class="line">            + <span class="string">&quot;access_token_scopes, &quot;</span></span><br><span class="line">            + <span class="string">&quot;refresh_token_value, &quot;</span></span><br><span class="line">            + <span class="string">&quot;refresh_token_issued_at&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TABLE_NAME = <span class="string">&quot;oauth2_authorized_client&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PK_FILTER = <span class="string">&quot;client_registration_id = ? AND principal_name = ?&quot;</span>;</span><br><span class="line">    <span class="comment">// @formatter:on</span></span><br><span class="line">    <span class="comment">// @formatter:off</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String LOAD_AUTHORIZED_CLIENT_SQL = <span class="string">&quot;SELECT &quot;</span> + COLUMN_NAMES</span><br><span class="line">            + <span class="string">&quot; FROM &quot;</span> + TABLE_NAME</span><br><span class="line">            + <span class="string">&quot; WHERE &quot;</span> + PK_FILTER;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @formatter:off</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SAVE_AUTHORIZED_CLIENT_SQL = <span class="string">&quot;INSERT INTO &quot;</span> + TABLE_NAME</span><br><span class="line">            + <span class="string">&quot; (&quot;</span> + COLUMN_NAMES + <span class="string">&quot;) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String REMOVE_AUTHORIZED_CLIENT_SQL = <span class="string">&quot;DELETE FROM &quot;</span> + TABLE_NAME + <span class="string">&quot; WHERE &quot;</span> + PK_FILTER;</span><br><span class="line">    <span class="comment">// @formatter:on</span></span><br><span class="line">    <span class="comment">// @formatter:off</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String UPDATE_AUTHORIZED_CLIENT_SQL = <span class="string">&quot;UPDATE &quot;</span> + TABLE_NAME</span><br><span class="line">            + <span class="string">&quot; SET access_token_type = ?, access_token_value = ?, access_token_issued_at = ?,&quot;</span></span><br><span class="line">            + <span class="string">&quot; access_token_expires_at = ?, access_token_scopes = ?,&quot;</span></span><br><span class="line">            + <span class="string">&quot; refresh_token_value = ?, refresh_token_issued_at = ?&quot;</span></span><br><span class="line">            + <span class="string">&quot; WHERE &quot;</span> + PK_FILTER;</span><br><span class="line">    <span class="comment">// @formatter:on</span></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> DatabaseClient databaseClient;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ReactiveClientRegistrationRepository reactiveClientRegistrationRepository;</span><br><span class="line">    <span class="comment">// @formatter:on</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 这里有一个注意事项：查询时不要使用.fetch()方法，其会按照字段名称的字母排序进行赋值，导致结果中key和value匹配混乱</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T extends OAuth2AuthorizedClient&gt; <span class="function">Mono&lt;T&gt; <span class="title">loadAuthorizedClient</span><span class="params">(String clientRegistrationId, Authentication principal, ServerWebExchange exchange)</span> </span>&#123;</span><br><span class="line">        Assert.hasText(clientRegistrationId, <span class="string">&quot;clientRegistrationId cannot be empty&quot;</span>);</span><br><span class="line">        Assert.hasText(principal.getName(), <span class="string">&quot;principalName cannot be empty&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Mono&lt;OAuth2AuthorizedClient&gt; oAuth2AuthorizedClientMono = databaseClient.sql(LOAD_AUTHORIZED_CLIENT_SQL)</span><br><span class="line">                .bind(<span class="number">0</span>, clientRegistrationId)</span><br><span class="line">                .bind(<span class="number">1</span>, principal.getName())</span><br><span class="line">                .map(row -&gt; &#123;</span><br><span class="line">                    String clientRegistrationId1 = row.get(<span class="string">&quot;client_registration_id&quot;</span>, String.class);</span><br><span class="line">                    String access_token_type = row.get(<span class="string">&quot;access_token_type&quot;</span>, String.class);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                    OAuth2AccessToken.TokenType tokenType = <span class="keyword">null</span>;</span><br><span class="line">                    <span class="keyword">if</span> (OAuth2AccessToken.TokenType.BEARER.getValue().equalsIgnoreCase(access_token_type)) &#123;</span><br><span class="line">                        tokenType = OAuth2AccessToken.TokenType.BEARER;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    String tokenValue = <span class="keyword">new</span> String(row.get(<span class="string">&quot;access_token_value&quot;</span>, <span class="keyword">byte</span>[].class), StandardCharsets.UTF_8);</span><br><span class="line">                    Instant issuedAt = row.get(<span class="string">&quot;access_token_issued_at&quot;</span>, LocalDateTime.class).atZone(ZoneId.systemDefault()).toInstant();</span><br><span class="line">                    Instant expiresAt = row.get(<span class="string">&quot;access_token_expires_at&quot;</span>, LocalDateTime.class).atZone(ZoneId.systemDefault()).toInstant();</span><br><span class="line">                    Set&lt;String&gt; scopes = Collections.emptySet();</span><br><span class="line">                    String accessTokenScopes = row.get(<span class="string">&quot;access_token_scopes&quot;</span>, String.class);</span><br><span class="line">                    <span class="keyword">if</span> (accessTokenScopes != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        scopes = StringUtils.commaDelimitedListToSet(accessTokenScopes);</span><br><span class="line">                    &#125;</span><br><span class="line">                    OAuth2AccessToken accessToken = <span class="keyword">new</span> OAuth2AccessToken(tokenType, tokenValue, issuedAt, expiresAt, scopes);</span><br><span class="line">                    OAuth2RefreshToken refreshToken = <span class="keyword">null</span>;</span><br><span class="line">                    <span class="keyword">byte</span>[] refreshTokenValue = row.get(<span class="string">&quot;refresh_token_value&quot;</span>, <span class="keyword">byte</span>[].class);</span><br><span class="line">                    <span class="keyword">if</span> (refreshTokenValue != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        tokenValue = <span class="keyword">new</span> String(refreshTokenValue, StandardCharsets.UTF_8);</span><br><span class="line">                        issuedAt = <span class="keyword">null</span>;</span><br><span class="line">                        LocalDateTime refreshTokenIssuedAt = row.get(<span class="string">&quot;refresh_token_issued_at&quot;</span>, LocalDateTime.class);</span><br><span class="line">                        <span class="keyword">if</span> (refreshTokenIssuedAt != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            issuedAt = refreshTokenIssuedAt.atZone(ZoneId.systemDefault()).toInstant();</span><br><span class="line">                        &#125;</span><br><span class="line">                        refreshToken = <span class="keyword">new</span> OAuth2RefreshToken(tokenValue, issuedAt);</span><br><span class="line">                    &#125;</span><br><span class="line">                    String principalName = row.get(<span class="string">&quot;principal_name&quot;</span>, String.class);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">final</span> OAuth2RefreshToken refreshToken1 = refreshToken;</span><br><span class="line"></span><br><span class="line">                    Mono&lt;ClientRegistration&gt; clientRegistrationMono = reactiveClientRegistrationRepository</span><br><span class="line">                            .findByRegistrationId(clientRegistrationId1);</span><br><span class="line">                    <span class="keyword">return</span> clientRegistrationMono</span><br><span class="line">                            .switchIfEmpty(Mono.error(<span class="keyword">new</span> DataRetrievalFailureException(</span><br><span class="line">                                    <span class="string">&quot;The ClientRegistration with id &#x27;&quot;</span> + clientRegistrationId1 + <span class="string">&quot;&#x27; exists in the data source, &quot;</span></span><br><span class="line">                                            + <span class="string">&quot;however, it was not found in the ClientRegistrationRepository.&quot;</span>)))</span><br><span class="line">                            .map(clientRegistration -&gt; <span class="keyword">new</span> OAuth2AuthorizedClient(clientRegistration, principalName, accessToken, refreshToken1));</span><br><span class="line">                &#125;).first().flatMap(oAuth2AuthorizedClientMono1 -&gt; oAuth2AuthorizedClientMono1);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (Mono&lt;T&gt;) oAuth2AuthorizedClientMono.doOnNext(unused -&gt; log.info(<span class="string">&quot;select client token info success!&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">saveAuthorizedClient</span><span class="params">(OAuth2AuthorizedClient authorizedClient, Authentication principal, ServerWebExchange exchange)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Assert.notNull(authorizedClient, <span class="string">&quot;authorizedClient cannot be null&quot;</span>);</span><br><span class="line">        Assert.notNull(principal, <span class="string">&quot;principal cannot be null&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.loadAuthorizedClient(authorizedClient.getClientRegistration().getRegistrationId(), principal, exchange)</span><br><span class="line">                 .flatMap((Function&lt;OAuth2AuthorizedClient, Mono&lt;Optional&lt;OAuth2AuthorizedClient&gt;&gt;&gt;) oAuth2AuthorizedClient -&gt; Mono.just(Optional.of(oAuth2AuthorizedClient)))</span><br><span class="line">                 .defaultIfEmpty(Optional.empty())</span><br><span class="line">                 .flatMap((Function&lt;Optional&lt;OAuth2AuthorizedClient&gt;, Mono&lt;Void&gt;&gt;) oAuth2AuthorizedClient -&gt; &#123;</span><br><span class="line">                     <span class="keyword">if</span>(!oAuth2AuthorizedClient.isPresent())&#123;</span><br><span class="line">                         <span class="keyword">return</span> insertAuthorizedClient(authorizedClient,principal);</span><br><span class="line">                     &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                         <span class="keyword">return</span> updateAuthorizedClient(authorizedClient, principal);</span><br><span class="line">                     &#125;</span><br><span class="line">                 &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Mono&lt;Void&gt; <span class="title">updateAuthorizedClient</span><span class="params">(OAuth2AuthorizedClient authorizedClient, Authentication principal)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> databaseClient.sql(UPDATE_AUTHORIZED_CLIENT_SQL)</span><br><span class="line">                .bind(<span class="number">0</span>, authorizedClient.getAccessToken().getTokenType().getValue())</span><br><span class="line">                .bind(<span class="number">1</span>, authorizedClient.getAccessToken().getTokenValue().getBytes(StandardCharsets.UTF_8))</span><br><span class="line">                .bind(<span class="number">2</span>, timeFromInstant(authorizedClient.getAccessToken().getIssuedAt()))</span><br><span class="line">                .bind(<span class="number">3</span>, timeFromInstant(authorizedClient.getAccessToken().getExpiresAt()))</span><br><span class="line">                .bind(<span class="number">4</span>, StringUtils.collectionToCommaDelimitedString(authorizedClient.getAccessToken().getScopes()))</span><br><span class="line">                .bind(<span class="number">5</span>, authorizedClient.getRefreshToken().getTokenValue().getBytes(StandardCharsets.UTF_8))</span><br><span class="line">                .bind(<span class="number">6</span>, timeFromInstant(authorizedClient.getRefreshToken().getIssuedAt()))</span><br><span class="line">                .bind(<span class="number">7</span>, authorizedClient.getClientRegistration().getRegistrationId())</span><br><span class="line">                .bind(<span class="number">8</span>, principal.getName())</span><br><span class="line">                .then()</span><br><span class="line">                .doOnNext(unused -&gt; log.info(<span class="string">&quot;update client token info success!&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Mono&lt;Void&gt; <span class="title">insertAuthorizedClient</span><span class="params">(OAuth2AuthorizedClient authorizedClient, Authentication principal)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> databaseClient.sql(SAVE_AUTHORIZED_CLIENT_SQL)</span><br><span class="line">                .bind(<span class="number">0</span>, authorizedClient.getClientRegistration().getRegistrationId())</span><br><span class="line">                .bind(<span class="number">1</span>, principal.getName())</span><br><span class="line">                .bind(<span class="number">2</span>, authorizedClient.getAccessToken().getTokenType().getValue())</span><br><span class="line">                .bind(<span class="number">3</span>, authorizedClient.getAccessToken().getTokenValue().getBytes(StandardCharsets.UTF_8))</span><br><span class="line">                .bind(<span class="number">4</span>, timeFromInstant(authorizedClient.getAccessToken().getIssuedAt()))</span><br><span class="line">                .bind(<span class="number">5</span>, timeFromInstant(authorizedClient.getAccessToken().getExpiresAt()))</span><br><span class="line">                .bind(<span class="number">6</span>, StringUtils.collectionToCommaDelimitedString(authorizedClient.getAccessToken().getScopes()))</span><br><span class="line">                .bind(<span class="number">7</span>, authorizedClient.getRefreshToken().getTokenValue().getBytes(StandardCharsets.UTF_8))</span><br><span class="line">                .bind(<span class="number">8</span>, timeFromInstant(authorizedClient.getRefreshToken().getIssuedAt()))</span><br><span class="line">                .then()</span><br><span class="line">                .doOnNext(unused -&gt; log.info(<span class="string">&quot;insert client token info success!&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">removeAuthorizedClient</span><span class="params">(String clientRegistrationId, Authentication principal, ServerWebExchange exchange)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Assert.hasText(clientRegistrationId, <span class="string">&quot;clientRegistrationId cannot be empty&quot;</span>);</span><br><span class="line">        Assert.hasText(principal.getName(), <span class="string">&quot;principalName cannot be empty&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> databaseClient.sql(REMOVE_AUTHORIZED_CLIENT_SQL)</span><br><span class="line">                .bind(<span class="number">0</span>, clientRegistrationId)</span><br><span class="line">                .bind(<span class="number">1</span>, principal.getName())</span><br><span class="line">                .then()</span><br><span class="line">                .doOnNext(unused -&gt; log.info(<span class="string">&quot;remove client token info success!&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">timeFromInstant</span><span class="params">(Instant instant)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>).format(LocalDateTime.ofInstant(instant, ZoneId.systemDefault()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="AuthController"><a href="#AuthController" class="headerlink" title="AuthController"></a>AuthController</h2><p>自定义登录跳转页面</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.oauth2clientwebfluxdemo.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.oauth2clientwebfluxdemo.security.CustomServerOAuth2AuthorizedClientRepository;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.client.registration.InMemoryReactiveClientRegistrationRepository;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.client.registration.ReactiveClientRegistrationRepository;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ui.Model;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;h1&gt;login&lt;/h1&gt;</span></span><br><span class="line"><span class="comment"> * Created by hanqf on 2020/11/30 18:02.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    ReactiveClientRegistrationRepository reactiveClientRegistrationRepository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/login&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">login</span><span class="params">(Model model)</span> </span>&#123;</span><br><span class="line">        Map&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span> (reactiveClientRegistrationRepository <span class="keyword">instanceof</span> InMemoryReactiveClientRegistrationRepository) &#123;</span><br><span class="line">            ((InMemoryReactiveClientRegistrationRepository) reactiveClientRegistrationRepository).forEach(registrations -&gt; &#123;</span><br><span class="line">                String registrationId = registrations.getRegistrationId();</span><br><span class="line">                String clientName = registrations.getClientName();</span><br><span class="line">                System.out.println(registrationId + <span class="string">&quot;---&quot;</span> + clientName);</span><br><span class="line">                map.put(registrationId, clientName);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        model.addAttribute(<span class="string">&quot;registrations&quot;</span>, map);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;oauth2/login&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="login-html"><a href="#login-html" class="headerlink" title="login.html"></a>login.html</h2><p>自定义登录页面</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1, shrink-to-fit=no&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;/webjars/bootstrap/css/bootstrap.min.css&#125;&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">th:src</span>=<span class="string">&quot;@&#123;/webjars/jquery/jquery.min.js&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">th:src</span>=<span class="string">&quot;@&#123;/webjars/bootstrap/js/bootstrap.min.js&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h2</span> <span class="attr">class</span>=<span class="string">&quot;form-signin-heading&quot;</span>&gt;</span>Login with OAuth 2.0<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">class</span>=<span class="string">&quot;table table-striped&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span> <span class="attr">th:each</span>=<span class="string">&quot;registration: $&#123;registrations&#125;&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;&#x27;/oauth2/authorization/&#x27;+$&#123;registration.key&#125;&#125;&quot;</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;registration.value&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">th:action</span>=<span class="string">&quot;@&#123;/logout&#125;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;container&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span>&gt;</span>Logout<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="application-yml"><a href="#application-yml" class="headerlink" title="application.yml"></a>application.yml</h2><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8099</span></span><br><span class="line"></span><br><span class="line"><span class="attr">oauth2:</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">http://localhost:8080</span></span><br><span class="line">    <span class="attr">logout:</span> <span class="string">$&#123;oauth2.server.url&#125;/logout</span> <span class="comment">#认证服务器logout地址</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">oauth2-client-webflux</span></span><br><span class="line">  <span class="comment">#资源国际化</span></span><br><span class="line">  <span class="attr">messages:</span></span><br><span class="line">    <span class="attr">basename:</span> <span class="string">static/i18n/messages</span></span><br><span class="line">    <span class="attr">encoding:</span> <span class="string">utf-8</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">#thymeleaf</span></span><br><span class="line">  <span class="attr">thymeleaf:</span></span><br><span class="line">    <span class="attr">cache:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">encoding:</span> <span class="string">UTF-8</span></span><br><span class="line">    <span class="attr">mode:</span> <span class="string">HTML</span></span><br><span class="line">    <span class="attr">prefix:</span> <span class="string">classpath:/templates/</span></span><br><span class="line">    <span class="attr">servlet:</span></span><br><span class="line">      <span class="attr">content-type:</span> <span class="string">text/html</span></span><br><span class="line">    <span class="attr">suffix:</span> <span class="string">.html</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">#r2dbc mysql</span></span><br><span class="line">  <span class="attr">r2dbc:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">r2dbc:mysql://localhost:3306/springboot?useUnicode=true&amp;characterEncoding=utf-8&amp;useTimezone=true&amp;serverTimezone=GMT%2B8</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">newpwd</span></span><br><span class="line">    <span class="attr">pool:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">initial-size:</span> <span class="number">5</span></span><br><span class="line">      <span class="attr">max-size:</span> <span class="number">20</span></span><br><span class="line">      <span class="attr">max-idle-time:</span> <span class="string">30m</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">#oauth2</span></span><br><span class="line">  <span class="comment"># 支持多客户端认证方式</span></span><br><span class="line">  <span class="attr">security:</span></span><br><span class="line">    <span class="attr">oauth2:</span></span><br><span class="line">      <span class="attr">client:</span></span><br><span class="line">        <span class="attr">registration:</span></span><br><span class="line">          <span class="comment"># /oauth2/authorization/flux-client # 认证地址</span></span><br><span class="line">          <span class="attr">flux-client:</span> <span class="comment"># 注册名称</span></span><br><span class="line">            <span class="attr">client-id:</span> <span class="string">postman</span> <span class="comment"># 客户端登录用户名称</span></span><br><span class="line">            <span class="attr">client-secret:</span> <span class="string">postman</span> <span class="comment"># 客户端登录密码</span></span><br><span class="line">            <span class="attr">authorization-grant-type:</span> <span class="string">authorization_code</span> <span class="comment">#认证方式为code</span></span><br><span class="line">            <span class="comment">#回调地址，需要配置到认证服务器中</span></span><br><span class="line">            <span class="attr">redirect-uri:</span> <span class="string">http://localhost:8099/login/oauth2/code/flux-client</span></span><br><span class="line">            <span class="attr">scope:</span> <span class="string">any</span> <span class="comment">#授权范围</span></span><br><span class="line">            <span class="attr">client-name:</span> <span class="string">客户端1</span> <span class="comment">#显示名称</span></span><br><span class="line"><span class="comment">#          # /oauth2/authorization/flux-client2</span></span><br><span class="line">          <span class="attr">flux-client2:</span></span><br><span class="line">            <span class="attr">client-id:</span> <span class="string">demo-client</span></span><br><span class="line">            <span class="attr">client-secret:</span> <span class="string">demo-client</span></span><br><span class="line">            <span class="attr">authorization-grant-type:</span> <span class="string">authorization_code</span></span><br><span class="line">            <span class="attr">redirect-uri:</span> <span class="string">http://localhost:8099/login/oauth2/code/flux-client2</span></span><br><span class="line">            <span class="attr">scope:</span> <span class="string">any</span></span><br><span class="line">            <span class="attr">client-name:</span> <span class="string">客户端2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">          <span class="attr">google:</span> <span class="comment"># google</span></span><br><span class="line">            <span class="attr">client-id:</span> <span class="string">xxxxxxxxx</span></span><br><span class="line">            <span class="attr">client-secret:</span> <span class="string">xxxxxxx</span></span><br><span class="line">            <span class="attr">client-name:</span> <span class="string">Google认证</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">          <span class="attr">facebook:</span> <span class="comment"># facebook</span></span><br><span class="line">            <span class="attr">client-id:</span> <span class="string">xxxxxxxxx</span></span><br><span class="line">            <span class="attr">client-secret:</span> <span class="string">xxxxxxx</span></span><br><span class="line">            <span class="attr">client-name:</span> <span class="string">Facebook认证</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">          <span class="attr">github:</span> <span class="comment"># github</span></span><br><span class="line">            <span class="attr">client-id:</span> <span class="string">xxxxxxxxx</span></span><br><span class="line">            <span class="attr">client-secret:</span> <span class="string">xxxxxxx</span></span><br><span class="line">            <span class="attr">client-name:</span> <span class="string">Github认证</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">provider:</span></span><br><span class="line">          <span class="attr">flux-client:</span> <span class="comment"># 注册客户端的认证信息</span></span><br><span class="line">            <span class="attr">authorization-uri:</span> <span class="string">$&#123;oauth2.server.url&#125;/oauth/authorize</span> <span class="comment"># 认证服务器授权地址</span></span><br><span class="line">            <span class="attr">token-uri:</span> <span class="string">$&#123;oauth2.server.url&#125;/oauth/token</span> <span class="comment"># 认证服务器token地址</span></span><br><span class="line">            <span class="attr">user-info-uri:</span> <span class="string">http://localhost:8080/userInfo</span> <span class="comment"># 认证服务器用户信息地址</span></span><br><span class="line">            <span class="attr">userNameAttribute:</span> <span class="string">username</span> <span class="comment"># 指定user-info-uri返回map中的属性名称用于表示用户名</span></span><br><span class="line">          <span class="attr">flux-client2:</span></span><br><span class="line">            <span class="attr">authorization-uri:</span> <span class="string">$&#123;oauth2.server.url&#125;/oauth/authorize</span></span><br><span class="line">            <span class="attr">token-uri:</span> <span class="string">$&#123;oauth2.server.url&#125;/oauth/token</span></span><br><span class="line">            <span class="attr">user-info-uri:</span> <span class="string">http://localhost:8080/userInfo</span></span><br><span class="line">            <span class="attr">userNameAttribute:</span> <span class="string">username</span></span><br><span class="line"><span class="attr">debug:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 可以打印sql</span></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">org.springframework.data.r2dbc:</span> <span class="string">DEBUG</span></span><br></pre></td></tr></table></figure>


<h2 id="ResController"><a href="#ResController" class="headerlink" title="ResController"></a>ResController</h2><p>请求资源服务示例</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.oauth2clientwebfluxdemo.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.oauth2clientwebfluxdemo.exception.AjaxResponse;</span><br><span class="line"><span class="keyword">import</span> com.example.oauth2clientwebfluxdemo.exception.CustomException;</span><br><span class="line"><span class="keyword">import</span> com.example.oauth2clientwebfluxdemo.exception.CustomExceptionType;</span><br><span class="line"><span class="keyword">import</span> com.example.oauth2clientwebfluxdemo.security.CustomServerOAuth2AuthorizedClientRepository;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpHeaders;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.Authentication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.client.OAuth2AuthorizedClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.client.authentication.OAuth2AuthenticationToken;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.reactive.function.client.WebClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.server.ServerWebExchange;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;h1&gt;获取资源服务器数据&lt;/h1&gt;</span></span><br><span class="line"><span class="comment"> * Created by hanqf on 2020/11/7 22:47.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/res&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> WebClient CLIENT = WebClient.create(<span class="string">&quot;http://localhost:8083&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CustomServerOAuth2AuthorizedClientRepository customServerOAuth2AuthorizedClientRepository;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取资源服务器的数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/res1&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;AjaxResponse&gt; <span class="title">getRes</span><span class="params">(Authentication principal, ServerWebExchange exchange)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (principal <span class="keyword">instanceof</span> OAuth2AuthenticationToken) &#123;</span><br><span class="line">            String authorizedClientRegistrationId = ((OAuth2AuthenticationToken) principal).getAuthorizedClientRegistrationId();</span><br><span class="line">            Mono&lt;OAuth2AuthorizedClient&gt; oAuth2AuthorizedClientMono = customServerOAuth2AuthorizedClientRepository.loadAuthorizedClient(authorizedClientRegistrationId, principal, exchange);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> oAuth2AuthorizedClientMono.flatMap(client -&gt; &#123;</span><br><span class="line">                String tokenValue = client.getAccessToken().getTokenValue();</span><br><span class="line">                String tokenType = client.getAccessToken().getTokenType().getValue();</span><br><span class="line">                <span class="keyword">return</span> CLIENT.get()</span><br><span class="line">                        .uri(<span class="string">&quot;/res/res1&quot;</span>)</span><br><span class="line">                        <span class="comment">//增加了Bearer安全认证，所以这里需要传递header认证信息</span></span><br><span class="line">                        .header(HttpHeaders.AUTHORIZATION,</span><br><span class="line">                                tokenType + <span class="string">&quot; &quot;</span> + tokenValue)</span><br><span class="line">                        .retrieve()<span class="comment">//异步接收服务端响应</span></span><br><span class="line">                        .bodyToMono(AjaxResponse.class)</span><br><span class="line">                        .retry(<span class="number">3</span>)</span><br><span class="line">                        .defaultIfEmpty(AjaxResponse.success(<span class="string">&quot;返回结果为Null&quot;</span>));</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Mono.just(AjaxResponse.error(<span class="keyword">new</span> CustomException(CustomExceptionType.SYSTEM_ERROR,<span class="string">&quot;Authentication类型转换异常&quot;</span>)));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/user&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;AjaxResponse&gt; <span class="title">getUser</span><span class="params">(Authentication principal, ServerWebExchange exchange)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (principal <span class="keyword">instanceof</span> OAuth2AuthenticationToken) &#123;</span><br><span class="line">            String authorizedClientRegistrationId = ((OAuth2AuthenticationToken) principal).getAuthorizedClientRegistrationId();</span><br><span class="line">            Mono&lt;OAuth2AuthorizedClient&gt; oAuth2AuthorizedClientMono = customServerOAuth2AuthorizedClientRepository.loadAuthorizedClient(authorizedClientRegistrationId, principal, exchange);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> oAuth2AuthorizedClientMono.flatMap(client -&gt; &#123;</span><br><span class="line">                String tokenValue = client.getAccessToken().getTokenValue();</span><br><span class="line">                String tokenType = client.getAccessToken().getTokenType().getValue();</span><br><span class="line">                <span class="keyword">return</span> CLIENT.post()</span><br><span class="line">                        .uri(<span class="string">&quot;/user&quot;</span>)</span><br><span class="line">                        <span class="comment">//增加了Bearer安全认证，所以这里需要传递header认证信息</span></span><br><span class="line">                        .header(HttpHeaders.AUTHORIZATION,</span><br><span class="line">                                tokenType + <span class="string">&quot; &quot;</span> + tokenValue)</span><br><span class="line">                        .retrieve()<span class="comment">//异步接收服务端响应</span></span><br><span class="line">                        .bodyToMono(AjaxResponse.class)</span><br><span class="line">                        .retry(<span class="number">3</span>)</span><br><span class="line">                        .defaultIfEmpty(AjaxResponse.success(<span class="string">&quot;返回结果为Null&quot;</span>));</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Mono.just(AjaxResponse.error(<span class="keyword">new</span> CustomException(CustomExceptionType.SYSTEM_ERROR,<span class="string">&quot;Authentication类型转换异常&quot;</span>)));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/rbac&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;AjaxResponse&gt; <span class="title">getRbac</span><span class="params">(Authentication principal, ServerWebExchange exchange)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (principal <span class="keyword">instanceof</span> OAuth2AuthenticationToken) &#123;</span><br><span class="line">            String authorizedClientRegistrationId = ((OAuth2AuthenticationToken) principal).getAuthorizedClientRegistrationId();</span><br><span class="line">            Mono&lt;OAuth2AuthorizedClient&gt; oAuth2AuthorizedClientMono = customServerOAuth2AuthorizedClientRepository.loadAuthorizedClient(authorizedClientRegistrationId, principal, exchange);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> oAuth2AuthorizedClientMono.flatMap(client -&gt; &#123;</span><br><span class="line">                String tokenValue = client.getAccessToken().getTokenValue();</span><br><span class="line">                String tokenType = client.getAccessToken().getTokenType().getValue();</span><br><span class="line">                <span class="keyword">return</span> CLIENT.get()</span><br><span class="line">                        .uri(<span class="string">&quot;/rbac&quot;</span>)</span><br><span class="line">                        <span class="comment">//增加了Bearer安全认证，所以这里需要传递header认证信息</span></span><br><span class="line">                        .header(HttpHeaders.AUTHORIZATION,</span><br><span class="line">                                tokenType + <span class="string">&quot; &quot;</span> + tokenValue)</span><br><span class="line">                        .retrieve()<span class="comment">//异步接收服务端响应</span></span><br><span class="line">                        .bodyToMono(AjaxResponse.class)</span><br><span class="line">                        .retry(<span class="number">3</span>)</span><br><span class="line">                        .defaultIfEmpty(AjaxResponse.success(<span class="string">&quot;返回结果为Null&quot;</span>));</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Mono.just(AjaxResponse.error(<span class="keyword">new</span> CustomException(CustomExceptionType.SYSTEM_ERROR,<span class="string">&quot;Authentication类型转换异常&quot;</span>)));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/userInfo&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Map&gt; <span class="title">getuserInfo</span><span class="params">(Authentication principal, ServerWebExchange exchange)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (principal <span class="keyword">instanceof</span> OAuth2AuthenticationToken) &#123;</span><br><span class="line">            String authorizedClientRegistrationId = ((OAuth2AuthenticationToken) principal).getAuthorizedClientRegistrationId();</span><br><span class="line">            Mono&lt;OAuth2AuthorizedClient&gt; oAuth2AuthorizedClientMono = customServerOAuth2AuthorizedClientRepository.loadAuthorizedClient(authorizedClientRegistrationId, principal, exchange);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> oAuth2AuthorizedClientMono.flatMap(client -&gt; &#123;</span><br><span class="line">                String tokenValue = client.getAccessToken().getTokenValue();</span><br><span class="line">                String tokenType = client.getAccessToken().getTokenType().getValue();</span><br><span class="line">                <span class="keyword">return</span> CLIENT.get()</span><br><span class="line">                        .uri(<span class="string">&quot;/userInfo&quot;</span>)</span><br><span class="line">                        <span class="comment">//增加了Bearer安全认证，所以这里需要传递header认证信息</span></span><br><span class="line">                        .header(HttpHeaders.AUTHORIZATION,</span><br><span class="line">                                tokenType + <span class="string">&quot; &quot;</span> + tokenValue)</span><br><span class="line">                        .retrieve()<span class="comment">//异步接收服务端响应</span></span><br><span class="line">                        .bodyToMono(Map.class)</span><br><span class="line">                        .retry(<span class="number">3</span>)</span><br><span class="line">                        .defaultIfEmpty(<span class="keyword">new</span> HashMap());</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Mono.error(<span class="keyword">new</span> CustomException(CustomExceptionType.SYSTEM_ERROR,<span class="string">&quot;Authentication类型转换异常&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>技术</category>
        <category>springboot2</category>
        <category>Java</category>
      </categories>
      <tags>
        <tag>springboot</tag>
        <tag>oauth2</tag>
        <tag>springsecurity</tag>
        <tag>jwt</tag>
        <tag>webflux</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot-OAuth2-JWT-WebFlux-ResourceServer</title>
    <url>/2020/12/02/springboot-oauth2-jwt-webflux-resourceserver/</url>
    <content><![CDATA[<h2 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h2><ul>
<li>通过本文，你将知道如何搭建一个基于SpringBoot-OAuth2-JWT-WebFlux的资源服务器</li>
<li>本文基于springboot:2.4.0，项目基于Gradle-6.6.1构建</li>
<li>本文基于<a href="https://blog.hanqunfeng.com/2020/11/15/springBoot-oauth2-jwt-resourcceserver/">SpringBoot-OAuth2-JWT-ResourceServer</a>并实现其功能，可以参考对比</li>
<li>代码地址:<a href="https://github.com/hanqunfeng/springbootchapter/tree/master/chapter48">https://github.com/hanqunfeng/springbootchapter/tree/master/chapter48</a></li>
</ul>
<span id="more"></span>
<h2 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h2><ul>
<li>springboot官方提供了支持<figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line"><span class="comment">//webflux</span></span><br><span class="line">implementation <span class="string">&#x27;org.springframework.boot:spring-boot-starter-webflux&#x27;</span></span><br><span class="line">implementation <span class="string">&#x27;org.springframework.boot:spring-boot-starter-oauth2-resource-server&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//本项目中使用了lombok减少代码量，非必须依赖</span></span><br><span class="line">compileOnly <span class="string">&#x27;org.projectlombok:lombok&#x27;</span></span><br><span class="line">annotationProcessor <span class="string">&#x27;org.projectlombok:lombok&#x27;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="ReactiveSecurityConfig"><a href="#ReactiveSecurityConfig" class="headerlink" title="ReactiveSecurityConfig"></a>ReactiveSecurityConfig</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.oauth2resourceserverwebfluxdemo.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.oauth2resourceserverwebfluxdemo.security.CustomReactiveAuthorizationManager;</span><br><span class="line"><span class="keyword">import</span> com.example.oauth2resourceserverwebfluxdemo.security.CustomServerAccessDeniedHandler;</span><br><span class="line"><span class="keyword">import</span> com.example.oauth2resourceserverwebfluxdemo.security.CustomServerAuthenticationEntryPoint;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.method.configuration.EnableReactiveMethodSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.web.server.ServerHttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.authority.SimpleGrantedAuthority;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.server.resource.authentication.JwtAuthenticationToken;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.server.SecurityWebFilterChain;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;h1&gt;安全认证配置&lt;/h1&gt;</span></span><br><span class="line"><span class="comment"> * Created by hanqf on 2020/11/19 10:26.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">//@EnableWebFluxSecurity //非必要</span></span><br><span class="line"><span class="meta">@EnableReactiveMethodSecurity</span> <span class="comment">//启用@PreAuthorize注解配置</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReactiveSecurityConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CustomServerAccessDeniedHandler customServerAccessDeniedHandler;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CustomServerAuthenticationEntryPoint customServerAuthenticationEntryPoint;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CustomReactiveAuthorizationManager customReactiveAuthorizationManager;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注册安全验证规则</span></span><br><span class="line"><span class="comment">     * 配置方式与HttpSecurity基本一致</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function">SecurityWebFilterChain <span class="title">springSecurityFilterChain</span><span class="params">(ServerHttpSecurity http)</span> </span>&#123; <span class="comment">//定义SecurityWebFilterChain对安全进行控制，使用ServerHttpSecurity构造过滤器链；</span></span><br><span class="line">        <span class="keyword">return</span> http.authorizeExchange()</span><br><span class="line">                <span class="comment">//.anyExchange().authenticated() //所有请求都需要通过认证</span></span><br><span class="line">                .pathMatchers(<span class="string">&quot;/res/**&quot;</span>, <span class="string">&quot;/userInfo/**&quot;</span>).authenticated()</span><br><span class="line">                <span class="comment">//需要具备相应的角色才能访问</span></span><br><span class="line">                .pathMatchers(<span class="string">&quot;/user/**&quot;</span>).hasAnyRole(<span class="string">&quot;admin&quot;</span>, <span class="string">&quot;user&quot;</span>)</span><br><span class="line">                <span class="comment">//不需要登录就可以访问</span></span><br><span class="line">                .pathMatchers(<span class="string">&quot;/swagger-ui/**&quot;</span>, <span class="string">&quot;/v3/api-docs**&quot;</span>).permitAll()</span><br><span class="line"></span><br><span class="line">                <span class="comment">//其它路径需要根据指定的方法判断是否有权限访问，基于权限管理模型认证</span></span><br><span class="line">                .anyExchange().access(customReactiveAuthorizationManager)</span><br><span class="line">                .and()</span><br><span class="line">                .csrf().disable() <span class="comment">//关闭CSRF（Cross-site request forgery）跨站请求伪造</span></span><br><span class="line">                .httpBasic().disable() <span class="comment">//不支持HTTP Basic方式登录</span></span><br><span class="line">                .formLogin().disable()<span class="comment">//不支持login页面登录</span></span><br><span class="line">                .cors() <span class="comment">//开启跨域支持</span></span><br><span class="line">                .and()</span><br><span class="line"></span><br><span class="line">                <span class="comment">//鉴权时只支持Bearer Token的形式，不支持url后加参数access_token</span></span><br><span class="line">                .oauth2ResourceServer()<span class="comment">//开启oauth2资源认证</span></span><br><span class="line">                .jwt() <span class="comment">//token为jwt</span></span><br><span class="line">                <span class="comment">//默认情况下，权限是scope，而我们希望使用的是用户的角色，所以这里需要通过转换器进行处理</span></span><br><span class="line">                .jwtAuthenticationConverter(jwt -&gt; &#123; <span class="comment">//通过自定义Converter来指定权限，Converter是函数接口，当前上下问参数为JWT对象</span></span><br><span class="line">                    Collection&lt;SimpleGrantedAuthority&gt; authorities =</span><br><span class="line">                            ((Collection&lt;String&gt;) jwt.getClaims()</span><br><span class="line">                                    .get(<span class="string">&quot;authorities&quot;</span>)).stream() <span class="comment">//获取JWT中的authorities</span></span><br><span class="line">                                    .map(SimpleGrantedAuthority::<span class="keyword">new</span>)</span><br><span class="line">                                    .collect(Collectors.toSet());</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//如果希望保留scope的权限，可以取出scope数据然后合并到一起，这样因为不是以ROLE_开头，所以需要使用hasAuthority(&#x27;SCOPE_any&#x27;)的形式</span></span><br><span class="line">                    Collection&lt;SimpleGrantedAuthority&gt; scopes = ((Collection&lt;String&gt;) jwt.getClaims()</span><br><span class="line">                            .get(<span class="string">&quot;scope&quot;</span>)).stream().map(scope -&gt; <span class="keyword">new</span> SimpleGrantedAuthority(<span class="string">&quot;SCOPE_&quot;</span> + scope))</span><br><span class="line">                            .collect(Collectors.toSet());</span><br><span class="line">                    <span class="comment">//合并权限</span></span><br><span class="line">                    authorities.addAll(scopes);</span><br><span class="line">                    <span class="keyword">return</span> Mono.just(<span class="keyword">new</span> JwtAuthenticationToken(jwt, authorities));</span><br><span class="line">                &#125;)</span><br><span class="line">                .and()</span><br><span class="line">                .accessDeniedHandler(customServerAccessDeniedHandler)</span><br><span class="line">                .authenticationEntryPoint(customServerAuthenticationEntryPoint)</span><br><span class="line">                .and().build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="CustomReactiveAuthorizationManager"><a href="#CustomReactiveAuthorizationManager" class="headerlink" title="CustomReactiveAuthorizationManager"></a>CustomReactiveAuthorizationManager</h2><p>基于RBAC权限认证管理模型的认证方式</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.oauth2resourceserverwebfluxdemo.security;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.http.server.reactive.ServerHttpRequest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authorization.AuthorizationDecision;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authorization.ReactiveAuthorizationManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.Authentication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.jwt.Jwt;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.server.authorization.AuthorizationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.AntPathMatcher;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;h1&gt;ReactiveAuthorizationManager&lt;/h1&gt;</span></span><br><span class="line"><span class="comment"> * Created by hanqf on 2020/11/30 12:05.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomReactiveAuthorizationManager</span> <span class="keyword">implements</span> <span class="title">ReactiveAuthorizationManager</span>&lt;<span class="title">AuthorizationContext</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;AuthorizationDecision&gt; <span class="title">check</span><span class="params">(Mono&lt;Authentication&gt; authentication, AuthorizationContext object)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> authentication.map(auth -&gt; &#123;</span><br><span class="line">            ServerHttpRequest request = object.getExchange().getRequest();</span><br><span class="line">            Object principal = auth.getPrincipal();</span><br><span class="line">            String username;</span><br><span class="line">            <span class="keyword">if</span> (principal <span class="keyword">instanceof</span> Jwt) &#123;</span><br><span class="line">                username = ((Jwt) principal).getClaimAsString(<span class="string">&quot;user_name&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                username = principal.toString();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">boolean</span> hasPerssion = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.hasText(username) &amp;&amp; !<span class="string">&quot;anonymousUser&quot;</span>.equals(username)) &#123;</span><br><span class="line">                <span class="comment">//根据用户名查询用户资源权限，这里应该访问数据库查询</span></span><br><span class="line">                Set&lt;String&gt; uris = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">                <span class="keyword">for</span> (String uri : uris) &#123;</span><br><span class="line">                    <span class="comment">//验证用户拥有的资源权限是否与请求的资源相匹配</span></span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">new</span> AntPathMatcher().match(uri, request.getURI().toString())) &#123;</span><br><span class="line">                        hasPerssion = <span class="keyword">true</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//暂时全部返回true</span></span><br><span class="line">            hasPerssion = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> AuthorizationDecision(hasPerssion);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="CustomServerAccessDeniedHandler"><a href="#CustomServerAccessDeniedHandler" class="headerlink" title="CustomServerAccessDeniedHandler"></a>CustomServerAccessDeniedHandler</h2><p>没有权限时的处理方式</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.oauth2resourceserverwebfluxdemo.security;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.oauth2resourceserverwebfluxdemo.exception.AjaxResponse;</span><br><span class="line"><span class="keyword">import</span> com.example.oauth2resourceserverwebfluxdemo.exception.CustomException;</span><br><span class="line"><span class="keyword">import</span> com.example.oauth2resourceserverwebfluxdemo.exception.CustomExceptionType;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.core.JsonProcessingException;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> lombok.SneakyThrows;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.server.reactive.ServerHttpResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.access.AccessDeniedException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.server.authorization.ServerAccessDeniedHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.server.ServerWebExchange;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;h1&gt;没有权限时的处理方式&lt;/h1&gt;</span></span><br><span class="line"><span class="comment"> * Created by hanqf on 2020/11/20 11:56.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomServerAccessDeniedHandler</span> <span class="keyword">implements</span> <span class="title">ServerAccessDeniedHandler</span> </span>&#123;</span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">handle</span><span class="params">(ServerWebExchange serverWebExchange, AccessDeniedException e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> setErrorResponse(serverWebExchange.getResponse(),e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Mono&lt;Void&gt; <span class="title">setErrorResponse</span><span class="params">(ServerHttpResponse response, String message)</span> <span class="keyword">throws</span> JsonProcessingException </span>&#123;</span><br><span class="line">        response.getHeaders().setContentType(MediaType.APPLICATION_JSON);</span><br><span class="line">        ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">        AjaxResponse ajaxResponse = AjaxResponse.error(<span class="keyword">new</span> CustomException(CustomExceptionType.USER_INPUT_ERROR, message));</span><br><span class="line">        <span class="keyword">return</span> response.writeWith(Mono.just(response.bufferFactory().wrap(objectMapper.writeValueAsBytes(ajaxResponse))));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="CustomServerAuthenticationEntryPoint"><a href="#CustomServerAuthenticationEntryPoint" class="headerlink" title="CustomServerAuthenticationEntryPoint"></a>CustomServerAuthenticationEntryPoint</h2><p>token格式错误或过期时的处理方式</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.oauth2resourceserverwebfluxdemo.security;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.oauth2resourceserverwebfluxdemo.exception.AjaxResponse;</span><br><span class="line"><span class="keyword">import</span> com.example.oauth2resourceserverwebfluxdemo.exception.CustomException;</span><br><span class="line"><span class="keyword">import</span> com.example.oauth2resourceserverwebfluxdemo.exception.CustomExceptionType;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.core.JsonProcessingException;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> lombok.SneakyThrows;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.server.reactive.ServerHttpResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.AuthenticationException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.server.ServerAuthenticationEntryPoint;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.server.ServerWebExchange;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;h1&gt;ServerAuthenticationEntryPoint&lt;/h1&gt;</span></span><br><span class="line"><span class="comment"> * Created by hanqf on 2020/11/20 12:01.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * token格式错误或过期时的处理方式</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomServerAuthenticationEntryPoint</span> <span class="keyword">implements</span> <span class="title">ServerAuthenticationEntryPoint</span> </span>&#123;</span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">commence</span><span class="params">(ServerWebExchange serverWebExchange, AuthenticationException e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> setErrorResponse(serverWebExchange.getResponse(), e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Mono&lt;Void&gt; <span class="title">setErrorResponse</span><span class="params">(ServerHttpResponse response, String message)</span> <span class="keyword">throws</span> JsonProcessingException </span>&#123;</span><br><span class="line">        response.getHeaders().setContentType(MediaType.APPLICATION_JSON);</span><br><span class="line">        ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">        AjaxResponse ajaxResponse = AjaxResponse.error(<span class="keyword">new</span> CustomException(CustomExceptionType.USER_INPUT_ERROR, message));</span><br><span class="line">        <span class="keyword">return</span> response.writeWith(Mono.just(response.bufferFactory().wrap(objectMapper.writeValueAsBytes(ajaxResponse))));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="WebFluxConfig"><a href="#WebFluxConfig" class="headerlink" title="WebFluxConfig"></a>WebFluxConfig</h2><p>配置跨域</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.oauth2resourceserverwebfluxdemo.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.reactive.config.CorsRegistry;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.reactive.config.WebFluxConfigurer;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;h1&gt;WebFlux配置类&lt;/h1&gt;</span></span><br><span class="line"><span class="comment"> * Created by hanqf on 2020/11/18 17:43.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 我们若需要配置Spring WebFlux只需让配置配实现接口WebFluxConfigurer，</span></span><br><span class="line"><span class="comment"> * 这样我们既能保留Spring Boot给WebFlux配置又能添加我们的定制配置。</span></span><br><span class="line"><span class="comment"> * 若我们向完全控制WebFlux，则在配置类添加注解<span class="doctag">@EnableWebFlux</span></span></span><br><span class="line"><span class="comment"> * 配置方式和Spring MVC类似</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebFluxConfig</span> <span class="keyword">implements</span> <span class="title">WebFluxConfigurer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//跨域设置</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addCorsMappings</span><span class="params">(CorsRegistry registry)</span> </span>&#123;</span><br><span class="line">        registry.addMapping(<span class="string">&quot;/**&quot;</span>) <span class="comment">//添加映射路径，“/**”表示对所有的路径实行全局跨域访问权限的设置</span></span><br><span class="line">                .allowedMethods(<span class="string">&quot;GET&quot;</span>,<span class="string">&quot;POST&quot;</span>, <span class="string">&quot;PUT&quot;</span>, <span class="string">&quot;DELETE&quot;</span>) <span class="comment">//开放哪些Http方法，允许跨域访问</span></span><br><span class="line">                .allowedHeaders(<span class="string">&quot;*&quot;</span>) <span class="comment">//允许HTTP请求中的携带哪些Header信息</span></span><br><span class="line">                <span class="comment">//When allowCredentials is true, allowedOrigins cannot contain the special value &quot;*&quot;since that cannot be set on the &quot;Access-Control-Allow-Origin&quot; response header.</span></span><br><span class="line">                <span class="comment">// To allow credentials to a set of origins, list them explicitly or consider using &quot;allowedOriginPatterns&quot; instead.</span></span><br><span class="line">                <span class="comment">//.allowedOrigins(&quot;*&quot;) //开放哪些ip、端口、域名的访问权限</span></span><br><span class="line">                .allowedOriginPatterns(<span class="string">&quot;*&quot;</span>)</span><br><span class="line">                .allowCredentials(<span class="keyword">true</span>); <span class="comment">//是否允许发送Cookie信息</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="application-yml"><a href="#application-yml" class="headerlink" title="application.yml"></a>application.yml</h2><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">#资源服务器端口号</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8083</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">oauth2-resource-server-webflux</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">#oauth2 配置</span></span><br><span class="line">  <span class="attr">security:</span></span><br><span class="line">    <span class="attr">oauth2:</span></span><br><span class="line">      <span class="attr">resourceserver:</span></span><br><span class="line">        <span class="attr">jwt:</span></span><br><span class="line">          <span class="comment"># 公钥文件路径</span></span><br><span class="line">          <span class="comment"># public-key-location: classpath:oauth2_key.pub</span></span><br><span class="line"></span><br><span class="line">          <span class="comment"># 认证服务器提供的密钥验证路径，这种方式每次验证access_token都需要访问认证服务器</span></span><br><span class="line">          <span class="attr">jwk-set-uri:</span> <span class="string">http://localhost:8080/.well-known/jwks.json</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="资源接口示例"><a href="#资源接口示例" class="headerlink" title="资源接口示例"></a>资源接口示例</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.oauth2resourceserverwebfluxdemo.controller;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.oauth2resourceserverwebfluxdemo.exception.AjaxResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.access.prepost.PreAuthorize;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.Authentication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.jwt.Jwt;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.security.Principal;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;h1&gt;res&lt;/h1&gt;</span></span><br><span class="line"><span class="comment"> * Created by hanqf on 2020/11/6 17:22.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//注意权限区分大小写</span></span><br><span class="line">    <span class="meta">@PreAuthorize(&quot;hasRole(&#x27;admin&#x27;) or hasRole(&#x27;user&#x27;)&quot;)</span></span><br><span class="line">    <span class="comment">//@PreAuthorize(&quot;#oauth2.hasScope(&#x27;any&#x27;)&quot;) //不支持oauth2表达式</span></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/user&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;AjaxResponse&gt; <span class="title">user</span><span class="params">(Principal principal)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//principal在经过security拦截后，是org.springframework.security.authentication.UsernamePasswordAuthenticationToken</span></span><br><span class="line">        <span class="comment">//在经OAuth2拦截后，是OAuth2Authentication</span></span><br><span class="line">        <span class="keyword">return</span> Mono.just(AjaxResponse.success(principal));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//注意权限区分大小写</span></span><br><span class="line">    <span class="meta">@PreAuthorize(&quot;hasAuthority(&#x27;SCOPE_any&#x27;)&quot;)</span></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/user2&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;AjaxResponse&gt; <span class="title">user2</span><span class="params">(Principal principal)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//principal在经过security拦截后，是org.springframework.security.authentication.UsernamePasswordAuthenticationToken</span></span><br><span class="line">        <span class="comment">//在经OAuth2拦截后，是OAuth2Authentication</span></span><br><span class="line">        <span class="keyword">return</span> Mono.just(AjaxResponse.success(principal));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取用户的claim信息</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/userInfo&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Map&lt;String, Object&gt;&gt; userInfo(Authentication authentication)&#123;</span><br><span class="line">        Map&lt;String,Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        Object principal = authentication.getPrincipal();</span><br><span class="line">        <span class="keyword">if</span>(principal <span class="keyword">instanceof</span> Jwt)&#123;</span><br><span class="line">            map.put(<span class="string">&quot;username&quot;</span>, ((Jwt) principal).getClaim(<span class="string">&quot;user_name&quot;</span>));</span><br><span class="line">            map.putAll(((Jwt) principal).getClaims());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Mono.just(map);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>技术</category>
        <category>springboot2</category>
        <category>Java</category>
      </categories>
      <tags>
        <tag>springboot</tag>
        <tag>oauth2</tag>
        <tag>springsecurity</tag>
        <tag>jwt</tag>
        <tag>webflux</tag>
      </tags>
  </entry>
  <entry>
    <title>发布Jar到Maven中央仓库--gradle</title>
    <url>/2020/11/27/gradle-depoly-maven-center-repository/</url>
    <content><![CDATA[<h2 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h2><ul>
<li>通过本文，你将知道如何将gradle构建的项目发布到Maven中央仓库</li>
<li>maven构建请看<a href="https://blog.hanqunfeng.com/2020/11/26/mvn-depoly-maven-center-repository/#more">发布Jar到Maven中央仓库–mvn</a>。</li>
<li>前三个步骤与<a href="https://blog.hanqunfeng.com/2020/11/26/mvn-depoly-maven-center-repository/#more">发布Jar到Maven中央仓库–mvn</a>相同，不在赘述。</li>
</ul>
<span id="more"></span>
<h2 id="一、将项目推送到远程仓库，如-Github或者Gitee"><a href="#一、将项目推送到远程仓库，如-Github或者Gitee" class="headerlink" title="一、将项目推送到远程仓库，如 Github或者Gitee"></a>一、将项目推送到远程仓库，如 Github或者Gitee</h2><h2 id="二、注册-Sonatype-账户–就是一个JIRA"><a href="#二、注册-Sonatype-账户–就是一个JIRA" class="headerlink" title="二、注册 Sonatype 账户–就是一个JIRA"></a>二、注册 Sonatype 账户–就是一个JIRA</h2><h2 id="三、登录-Sonatype-创建工单–每部署一个新项目就创建一个工单"><a href="#三、登录-Sonatype-创建工单–每部署一个新项目就创建一个工单" class="headerlink" title="三、登录 Sonatype 创建工单–每部署一个新项目就创建一个工单"></a>三、登录 Sonatype 创建工单–每部署一个新项目就创建一个工单</h2><p>前三个步骤与<a href="https://blog.hanqunfeng.com/2020/11/26/mvn-depoly-maven-center-repository/#more">发布Jar到Maven中央仓库–mvn</a>相同，不在赘述。</p>
<h2 id="四、发布"><a href="#四、发布" class="headerlink" title="四、发布"></a>四、发布</h2><ul>
<li><p>1.签名<br>  我是mac电脑，于是签名工具使用的是<a href="https://gpgtools.org/">https://gpgtools.org</a>，gradle签名时需要使用到<code>.gpg</code>证书文件，这个工具不支持直接导出gpg，其导出的证书文件是<code>.asc</code>格式的，asc其实就是字符串，可以用记事本打开查看。</p>
<p>  使用如下命令导出gpg格式的私钥证书：</p>
  <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> qunfeng_han@126.com是创建证书时使用的邮箱，会要求你输入创建证书时的密码</span></span><br><span class="line">gpg --export-secret-keys qunfeng_han@126.com &gt; secret.gpg</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 也可以使用创建证书的用户名，会要求你输入创建证书时的密码</span></span><br><span class="line">gpg --export-secret-keys hanqunfeng &gt; secret.gpg</span><br><span class="line"><span class="meta">#</span><span class="bash"> 导出私钥明文</span></span><br><span class="line">gpg --export-secret-keys --armor hanqunfeng &gt; secret.asc</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 列出当前全部证书</span></span><br><span class="line">gpg -k</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 导出公钥</span></span><br><span class="line">gpg --export hanqunfeng &gt; public.gpg</span><br><span class="line"><span class="meta">#</span><span class="bash"> 导出公钥明文</span></span><br><span class="line">gpg --export --armor hanqunfeng &gt; public.asc</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 导入公钥或私钥，区别就是导入公钥不需要创建证书的密码</span></span><br><span class="line">gpg --import public.gpg</span><br><span class="line">gpg --import --armor secret.asc</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>  也可以使用windows系统下载的<a href="https://www.gpg4win.org/">https://www.gpg4win.org/</a>Kleopatra，将gpgtools导出的证书（勾选密码才是私钥证书，看生成文件的名称就可以，公开就是公钥，私密就是私钥）导入到Kleopatra中，然后右键选择–&gt;Backup secret keys,记得后缀一定是gpg，该工具支持三种格式，asc、gpg、pgp，默认也是acs，手工将文件后缀修改为gpg即可。</p>
<p>  也可以重新生成了一个密钥对，打开软件，菜单–&gt;文件–&gt;新建密钥对–&gt;创建个人penPGP密钥对，创建好后记得点击“保存密钥副本”，以导出gpg证书文件，该工具支持三种格式，asc、gpg、pgp，默认也是acs，手工将文件后缀修改为gpg即可，如果此时忘记点击保留副本，也可以在证书列表页右键选择–&gt;Backup secret keys,记得后缀一定是gpg。</p>
</li>
</ul>
<ul>
<li><p>build.gradle<br>重点还是<code>io.codearte.nexus-staging</code>这个自动发布插件，不需要手工操作oss-sonatype的UI进行发布。</p>
<figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">plugins &#123;</span><br><span class="line">    id <span class="string">&#x27;io.spring.dependency-management&#x27;</span> version <span class="string">&#x27;1.0.10.RELEASE&#x27;</span></span><br><span class="line">    <span class="comment">//此处必须是java-library，如果是java则api方法不可用，api可以理解为就是compile，支持传递依赖</span></span><br><span class="line">    id <span class="string">&#x27;java-library&#x27;</span></span><br><span class="line">    <span class="comment">//发布插件</span></span><br><span class="line">    id <span class="string">&#x27;maven-publish&#x27;</span></span><br><span class="line">    <span class="comment">//签名插件</span></span><br><span class="line">    id <span class="string">&#x27;signing&#x27;</span></span><br><span class="line">    <span class="comment">//自动发布到maven中央仓库插件</span></span><br><span class="line">    <span class="comment">//https://github.com/Codearte/gradle-nexus-staging-plugin</span></span><br><span class="line">    id <span class="string">&#x27;io.codearte.nexus-staging&#x27;</span> version <span class="string">&#x27;0.22.0&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">group</span> = <span class="string">&#x27;com.hanqunfeng&#x27;</span></span><br><span class="line"><span class="comment">//SNAPSHOT版本是不支持发布到Maven中央仓库</span></span><br><span class="line">version = <span class="string">&#x27;1.0.3&#x27;</span></span><br><span class="line"><span class="keyword">sourceCompatibility</span> = <span class="string">&#x27;1.8&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">java &#123;</span><br><span class="line">    withJavadocJar()</span><br><span class="line">    withSourcesJar()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">repositories</span> &#123;</span><br><span class="line">    maven &#123; url <span class="string">&#x27;https://maven.aliyun.com/repository/public/&#x27;</span> &#125;</span><br><span class="line">    mavenLocal()</span><br><span class="line">    mavenCentral()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencyManagement &#123;</span><br><span class="line">    imports &#123; mavenBom(<span class="string">&quot;org.springframework.boot:spring-boot-dependencies:2.4.0&quot;</span>) &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">    <span class="comment">//lombok</span></span><br><span class="line">    compileOnly <span class="string">&#x27;org.projectlombok:lombok&#x27;</span></span><br><span class="line">    annotationProcessor <span class="string">&#x27;org.projectlombok:lombok&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果不希望传递依赖，则使用implementation，传递依赖则使用compile或者api，gradle7后将不再支持compile</span></span><br><span class="line">    <span class="comment">//注解相关</span></span><br><span class="line">    api <span class="string">&#x27;org.springframework.boot:spring-boot-autoconfigure&#x27;</span></span><br><span class="line">    api <span class="string">&#x27;org.springframework.boot:spring-boot-configuration-processor&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//json-jackson</span></span><br><span class="line">    api <span class="string">&#x27;com.fasterxml.jackson.core:jackson-databind&#x27;</span></span><br><span class="line">    api <span class="string">&#x27;com.fasterxml.jackson.datatype:jackson-datatype-jdk8&#x27;</span></span><br><span class="line">    api <span class="string">&#x27;com.fasterxml.jackson.datatype:jackson-datatype-jsr310&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//@Aspect</span></span><br><span class="line">    api <span class="string">&#x27;org.aspectj:aspectjweaver&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//Mono Flux</span></span><br><span class="line">    api <span class="string">&#x27;io.projectreactor:reactor-core&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//redis-template</span></span><br><span class="line">    api <span class="string">&#x27;org.springframework.data:spring-data-redis&#x27;</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">test &#123;</span><br><span class="line">    useJUnitPlatform()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// java编译的时候缺省状态下会因为中文字符而失败</span></span><br><span class="line">[compileJava, compileTestJava]*.<span class="keyword">options</span>*.encoding = <span class="string">&#x27;UTF-8&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 发布插件</span></span><br><span class="line"><span class="comment"> * 参考：https://docs.gradle.org/6.6.1/userguide/publishing_maven.html#publishing_maven:resolved_dependencies</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">publishing &#123;</span><br><span class="line">    publications &#123;</span><br><span class="line">        mavenJava(MavenPublication) &#123;</span><br><span class="line">            groupId = <span class="keyword">project</span>.<span class="keyword">group</span></span><br><span class="line">            artifactId = <span class="keyword">project</span>.name</span><br><span class="line">            version = <span class="keyword">project</span>.version</span><br><span class="line">            <span class="comment">//如果不定义，则会按照以上默认值执行</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">from</span> components.java</span><br><span class="line"></span><br><span class="line">            pom &#123;</span><br><span class="line">                name = <span class="string">&#x27;redis-cache-annotation-reactive&#x27;</span></span><br><span class="line">                <span class="keyword">description</span> = <span class="string">&#x27;redis cache function annotation for webflux&#x27;</span></span><br><span class="line">                url = <span class="string">&#x27;https://blog.hanqunfeng.com&#x27;</span></span><br><span class="line">                licenses &#123;</span><br><span class="line">                    license &#123;</span><br><span class="line">                        name = <span class="string">&#x27;The Apache License, Version 2.0&#x27;</span></span><br><span class="line">                        url = <span class="string">&#x27;http://www.apache.org/licenses/LICENSE-2.0.txt&#x27;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                developers &#123;</span><br><span class="line">                    developer &#123;</span><br><span class="line">                        id = <span class="string">&#x27;hanqf&#x27;</span></span><br><span class="line">                        name = <span class="string">&#x27;han qunfeng&#x27;</span></span><br><span class="line">                        email = <span class="string">&#x27;qunfeng_han@126.com&#x27;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                scm &#123;</span><br><span class="line">                    connection = <span class="string">&#x27;scm:git:https://github.com/hanqunfeng/reactive-redis-cache-annotation-spring-boot-starter.git&#x27;</span></span><br><span class="line">                    developerConnection = <span class="string">&#x27;scm:git:https://github.com:hanqunfeng/reactive-redis-cache-annotation-spring-boot-starter.git&#x27;</span></span><br><span class="line">                    url = <span class="string">&#x27;https://github.com/hanqunfeng/reactive-redis-cache-annotation-spring-boot-starter&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            versionMapping &#123;</span><br><span class="line">                usage(<span class="string">&#x27;java-api&#x27;</span>) &#123;</span><br><span class="line">                    fromResolutionOf(<span class="string">&#x27;runtimeClasspath&#x27;</span>)</span><br><span class="line">                &#125;</span><br><span class="line">                usage(<span class="string">&#x27;java-runtime&#x27;</span>) &#123;</span><br><span class="line">                    fromResolutionResult()</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">repositories</span> &#123;</span><br><span class="line">        maven &#123;</span><br><span class="line">            <span class="comment">// 发布仓库配置，这里基于version后缀是否为SNAPSHOT来区分发布到release库还是snapshots库</span></span><br><span class="line">           <span class="comment">// def releasesRepoUrl = &quot;http://nexus.cxzh.ltd:8081/repository/maven-releases/&quot;</span></span><br><span class="line">           <span class="comment">// def snapshotsRepoUrl = &quot;http://nexus.cxzh.ltd:8081/repository/maven-snapshots/&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">def</span> releasesRepoUrl = <span class="string">&quot;https://oss.sonatype.org/service/local/staging/deploy/maven2/&quot;</span></span><br><span class="line">            <span class="keyword">def</span> snapshotsRepoUrl = <span class="string">&quot;https://oss.sonatype.org/content/repositories/snapshots/&quot;</span></span><br><span class="line">            url = version.endsWith(<span class="string">&#x27;SNAPSHOT&#x27;</span>) ? snapshotsRepoUrl : releasesRepoUrl</span><br><span class="line"></span><br><span class="line">            <span class="comment">//认证用户和密码，在配置文件gradle.properties中配置</span></span><br><span class="line">            <span class="comment">//oss-sonatype的登录用户名和密码</span></span><br><span class="line">            credentials &#123;</span><br><span class="line">                username nexusUser</span><br><span class="line">                password nexusPassword</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tasks.withType(JavaCompile) &#123;</span><br><span class="line">    <span class="keyword">options</span>.encoding = <span class="string">&#x27;UTF-8&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//javadoc，如果用jdk11，默认就支持中文</span></span><br><span class="line"><span class="comment">//查看可以配置的属性：https://docs.gradle.org/current/javadoc/org/gradle/external/javadoc/StandardJavadocDocletOptions.html</span></span><br><span class="line">tasks.withType(Javadoc) &#123;</span><br><span class="line">    <span class="keyword">options</span>.version = <span class="keyword">true</span></span><br><span class="line">    <span class="keyword">options</span>.author = <span class="keyword">true</span></span><br><span class="line">    <span class="keyword">options</span>.encoding = <span class="string">&quot;UTF-8&quot;</span></span><br><span class="line">    <span class="keyword">options</span>.charSet = <span class="string">&quot;UTF-8&quot;</span>  <span class="comment">//解决中文乱码</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">javadoc &#123;</span><br><span class="line">    <span class="keyword">if</span>(JavaVersion.current().isJava9Compatible()) &#123;</span><br><span class="line">        <span class="keyword">options</span>.addBooleanOption(<span class="string">&#x27;html5&#x27;</span>, <span class="keyword">true</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (JavaVersion.current().isJava8Compatible()) &#123;</span><br><span class="line">        tasks.withType(Javadoc) &#123;</span><br><span class="line">            <span class="comment">// disable the crazy super-strict doclint tool in Java 8</span></span><br><span class="line">            <span class="comment">// noinspection SpellCheckingInspection</span></span><br><span class="line">            <span class="keyword">options</span>.addStringOption(<span class="string">&#x27;Xdoclint:none&#x27;</span>, <span class="string">&#x27;-quiet&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//签名，发布时会先执行签名</span></span><br><span class="line"><span class="comment">//参考：https://docs.gradle.org/current/userguide/signing_plugin.html</span></span><br><span class="line">signing &#123;</span><br><span class="line">    sign publishing.publications.mavenJava</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//自动发布到maven中央仓库插件的配置信息</span></span><br><span class="line"><span class="comment">//参考：https://github.com/Codearte/gradle-nexus-staging-plugin</span></span><br><span class="line">nexusStaging &#123;</span><br><span class="line">    <span class="comment">//oss-sonatype的登录用户名和密码</span></span><br><span class="line">    username nexusUser</span><br><span class="line">    password nexusPassword</span><br><span class="line">    <span class="comment">//重试次数，默认是60次</span></span><br><span class="line">    numberOfRetries <span class="number">10</span></span><br><span class="line">    <span class="comment">//每次重试的间隔时间，单位毫秒，默认2000，按照官网的说明，执行发布时有延迟，需要等待响应，所以建议调整间隔时间，可以减少重试次数，我这里间隔20秒，大约重试1~2次即可完成</span></span><br><span class="line">    delayBetweenRetriesInMillis <span class="number">20000</span></span><br><span class="line"><span class="comment">//    packageGroup = &quot;com.hanqunfeng&quot; //optional if packageGroup == project.getGroup()</span></span><br><span class="line"><span class="comment">//    stagingProfileId = &quot;yourStagingProfileId&quot; //when not defined will be got from server using &quot;packageGroup&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>gradle.properties</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#gradle -PnexusUser=developer -PnexusPassword=developer clean publish</span><br><span class="line"># 注意参数要放到命令前面</span><br><span class="line"># 这里替换为自己的oss-sonatype的用户名和密码</span><br><span class="line">nexusUser=developer</span><br><span class="line">nexusPassword=developer</span><br><span class="line"></span><br><span class="line">#Disable maven-metadata.xml SHA256 and SHA512 upload warnings to Nexus</span><br><span class="line">#参考：https://github.com/gradle/gradle/issues/12355</span><br><span class="line">systemProp.org.gradle.internal.publish.checksums.insecure=true</span><br><span class="line"></span><br><span class="line">#签名信息。或者执行命令时携带参数，如：gradle -Psigning.secretKeyRingFile=/SECRET.gpg -Psigning.password=xxxxxxxx -Psigning.keyId=xxxxxxxx clean publish</span><br><span class="line"># 这里替换自己的签名信息</span><br><span class="line">signing.keyId=xxxxxxxx</span><br><span class="line">signing.password=xxxxxxxx</span><br><span class="line">signing.secretKeyRingFile=/SECRET.gpg</span><br></pre></td></tr></table></figure></li>
<li><p>执行命令</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">./gradlew clean publish closeAndReleaseRepository # 部署到maven中央仓库，参数都配置在gradle.properties中</span><br><span class="line">./gradlew -PnexusUser=developer -PnexusPassword=developer -Psigning.secretKeyRingFile=/SECRET.gpg -Psigning.password=xxxxxxxx -Psigning.keyId=xxxxxxxx clean publish closeAndReleaseRepository # 命令行携带参数</span><br></pre></td></tr></table></figure></li>
</ul>
]]></content>
      <categories>
        <category>技术</category>
      </categories>
      <tags>
        <tag>maven</tag>
        <tag>gradle</tag>
      </tags>
  </entry>
  <entry>
    <title>发布Jar到Maven中央仓库--mvn</title>
    <url>/2020/11/26/mvn-depoly-maven-center-repository/</url>
    <content><![CDATA[<h2 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h2><ul>
<li>通过本文，你将知道如何将maven构建的项目发布到Maven中央仓库</li>
<li>gradle构建请看<a href="https://blog.hanqunfeng.com/2020/11/27/gradle-depoly-maven-center-repository/">发布Jar到Maven中央仓库–gradle</a></li>
</ul>
<span id="more"></span>
<h2 id="一、将项目推送到远程仓库，如-Github或者Gitee"><a href="#一、将项目推送到远程仓库，如-Github或者Gitee" class="headerlink" title="一、将项目推送到远程仓库，如 Github或者Gitee"></a>一、将项目推送到远程仓库，如 Github或者Gitee</h2><h2 id="二、注册-Sonatype-账户–就是一个JIRA"><a href="#二、注册-Sonatype-账户–就是一个JIRA" class="headerlink" title="二、注册 Sonatype 账户–就是一个JIRA"></a>二、注册 Sonatype 账户–就是一个JIRA</h2><p>进入 <a href="https://issues.sonatype.org/secure/Dashboard.jspa">https://issues.sonatype.org/secure/Dashboard.jspa</a> 注册一个账号，邮箱要真实。</p>
<h2 id="三、登录-Sonatype-创建工单–每部署一个新项目就创建一个工单"><a href="#三、登录-Sonatype-创建工单–每部署一个新项目就创建一个工单" class="headerlink" title="三、登录 Sonatype 创建工单–每部署一个新项目就创建一个工单"></a>三、登录 Sonatype 创建工单–每部署一个新项目就创建一个工单</h2><ul>
<li>登录后点击“新建”创建工单，如果没有显示“新建”菜单，可以直接请求“<a href="https://issues.sonatype.org/secure/CreateIssue.jspa?issuetype=21&amp;pid=10134%E2%80%9D">https://issues.sonatype.org/secure/CreateIssue.jspa?issuetype=21&amp;pid=10134”</a></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Summary：工单摘要，随便给个名称</span><br><span class="line">Group Id：填写项目的Group Id</span><br><span class="line">Project URL：填写远程仓库的浏览器地址</span><br><span class="line">SCM url：填写下载项目的git地址</span><br></pre></td></tr></table></figure>
<ul>
<li><p>注意：Group Id：最好填写你拥有的域名，比如我的域名是hanqunfeng.com，这里就填写com.hanqunfeng，这样后面验证domain时会方便一些。我第一次就是不知道这个事情，所以随便填的hanqf.org。</p>
</li>
<li><p>创建好工单后会收到两封邮件：</p>
<ul>
<li><p>第一封，通知你创建工单成功。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hanqunfeng created OSSRH-62247:</span><br><span class="line">----------------------------------</span><br><span class="line"></span><br><span class="line">            Summary: reactive-redis-cache-annotation</span><br><span class="line">                Key: OSSRH-62247</span><br><span class="line">                URL: https://issues.sonatype.org/browse/OSSRH-62247</span><br><span class="line">            Project: Community Support - Open Source Project Repository Hosting</span><br><span class="line">        Issue Type: New Project</span><br><span class="line">            Reporter: hanqunfeng</span><br><span class="line">            Assignee: Joel Orlina</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">reactive-redis-cache-annotation-spring-boot-starter</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">--</span><br><span class="line">This message was sent by Atlassian Jira</span><br><span class="line">(v8.5.7#805007)</span><br></pre></td></tr></table></figure></li>
<li><p>第二封邮件，要求你验证domain，两封邮件间隔大约5分钟。同时你在工单的注释中也能看到系统回复的同样的信息。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[ https://issues.sonatype.org/browse/OSSRH-62247?page=com.atlassian.jira.plugin.system.issuetabpanels:all-tabpanel ]</span><br><span class="line"></span><br><span class="line">Central OSSRH updated OSSRH-62247:</span><br><span class="line">----------------------------------</span><br><span class="line">    Status: Waiting for Response  (was: Open)</span><br><span class="line"></span><br><span class="line">Do you own the domain hanqf.org? If so, please verify ownership via one of the following methods:</span><br><span class="line">* Add a TXT record to your DNS referencing this JIRA ticket: OSSRH-62247 (Fastest)</span><br><span class="line">* Setup a redirect to your Github page (if it does not already exist)</span><br><span class="line"></span><br><span class="line">If you do not own this domain, please read:</span><br><span class="line">http://central.sonatype.org/pages/choosing-your-coordinates.html</span><br><span class="line">You may also choose a groupId that reflects your project hosting, in this case, something like io.github.hanqunfeng or com.github.hanqunfeng</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&gt; reactive-redis-cache-annotation</span><br><span class="line">&gt; -------------------------------</span><br><span class="line">&gt;</span><br><span class="line">&gt;                 Key: OSSRH-62247</span><br><span class="line">&gt;                 URL: https://issues.sonatype.org/browse/OSSRH-62247</span><br><span class="line">&gt;             Project: Community Support - Open Source Project Repository Hosting</span><br><span class="line">&gt;          Issue Type: New Project</span><br><span class="line">&gt;            Reporter: hanqunfeng</span><br><span class="line">&gt;            Assignee: Joel Orlina</span><br><span class="line">&gt;            Priority: Major</span><br><span class="line">&gt;</span><br><span class="line">&gt; reactive-redis-cache-annotation-spring-boot-starter</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<ul>
<li><p>看邮件说明，如果是自己的域名，添加一条TXT record 是最快速的验证方式，刚好我有一个域名，于是修改了工单的Group Id，修改工单时需要填写注释，随便填就行。</p>
</li>
<li><p>然后去设置了DNS，一条TXT记录，key是工单号，我这里就是OSSRH-62247，值是工单地址，这里就是<a href="https://issues.sonatype.org/browse/OSSRH-62247%EF%BC%8C%E5%88%9B%E5%BB%BA%E5%A5%BD%E5%90%8E%EF%BC%8C%E5%9C%A8%E5%B7%A5%E5%8D%95%E4%B8%AD%E6%B7%BB%E5%8A%A0%E4%B8%80%E6%9D%A1%E6%B3%A8%E9%87%8A">https://issues.sonatype.org/browse/OSSRH-62247，创建好后，在工单中添加一条注释</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">I have change the group Id to com.hanqunfeng,and I own the domain hanqunfeng.com,and I have added a dns record TXT.</span><br></pre></td></tr></table></figure>
<p>其它验证方式我并未尝试。</p>
</li>
<li><p>过一会你就会收到回复邮件，通知你验证完成，可以发布了，并且给出了发布地址。</p>
<ul>
<li>注意这里是先发布到<a href="https://oss.sonatype.org,而不是maven中央仓库的地址./">https://oss.sonatype.org，而不是maven中央仓库的地址。</a><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[ https://issues.sonatype.org/browse/OSSRH-62247?page=com.atlassian.jira.plugin.system.issuetabpanels:all-tabpanel ]</span><br><span class="line"></span><br><span class="line">Central OSSRH resolved OSSRH-62247.</span><br><span class="line">-----------------------------------</span><br><span class="line">    Resolution: Fixed</span><br><span class="line"></span><br><span class="line">com.hanqunfeng has been prepared, now user(s) hanqf can:</span><br><span class="line">* Deploy snapshot artifacts into repository https://oss.sonatype.org/content/repositories/snapshots</span><br><span class="line">* Deploy release artifacts into the staging repository https://oss.sonatype.org/service/local/staging/deploy/maven2</span><br><span class="line">* Release staged artifacts into repository &#x27;Releases&#x27;</span><br><span class="line"></span><br><span class="line">please comment on this ticket when you promoted your first release, thanks</span><br><span class="line"></span><br><span class="line">&gt; reactive-redis-cache-annotation</span><br><span class="line">&gt; -------------------------------</span><br><span class="line">&gt;</span><br><span class="line">&gt;                 Key: OSSRH-62247</span><br><span class="line">&gt;                 URL: https://issues.sonatype.org/browse/OSSRH-62247</span><br><span class="line">&gt;             Project: Community Support - Open Source Project Repository Hosting</span><br><span class="line">&gt;          Issue Type: New Project</span><br><span class="line">&gt;            Reporter: hanqunfeng</span><br><span class="line">&gt;            Assignee: Joel Orlina</span><br><span class="line">&gt;            Priority: Major</span><br><span class="line">&gt;</span><br><span class="line">&gt; reactive-redis-cache-annotation-spring-boot-starter</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">--</span><br><span class="line">This message was sent by Atlassian Jira</span><br><span class="line">(v8.5.7#805007)</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h2 id="四、发布"><a href="#四、发布" class="headerlink" title="四、发布"></a>四、发布</h2><ul>
<li><p>1.准备签名</p>
<ul>
<li>可以使用工具创建密钥对<br>需要下载一个签名工具，我是mac电脑，下载的是<a href="https://gpgtools.org/">https://gpgtools.org</a>。<br>安装后点击新建，按照提示创建一个密钥对即可，注意高级选项里有个过期时间，默认是3年。创建好后会主动提示你是否将公钥发布到key server，点击Upload Public key即可。也可以在创建后的证书列表页面邮件选择证书–&gt;Send Public Key To Key Server。</li>
</ul>
<p>  导出证书时，勾选密码并设置密码就是私钥和公钥证书，不勾选密码就是公钥，看生成文件的名称就可以，公开就是公钥，私密就是私钥，格式都是asc，其实就是字符串，可以用记事本打开查看。</p>
<p>  如果windows系统，可以下载<a href="https://www.gpg4win.org/">https://www.gpg4win.org/</a> ，使用方式差不多，最后点击“将公钥上传的目录服务”。</p>
<p>  公钥发布到key server后要稍微等一会，大约10分钟吧，因为key server有多个，同步需要一些时间。<br>  记住你创建密钥对时的密码，发布项目时要使用。</p>
<ul>
<li>也可以使用命令行创建密钥对，版本[gpg (GnuPG/MacGPG2) 2.2.24]  <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 创建密钥对，按提示输入用户名称和邮箱地址</span></span><br><span class="line">gpg --generate-key</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 列出密钥，hanqunfeng就是创建密钥对是的用户名，此处也可以使用邮箱</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 结果中第二行一长串的后8位就是keyId，比如：30FF8D58，gradle构建时会用到</span></span><br><span class="line">gpg --list-keys hanqunfeng</span><br><span class="line"><span class="meta">#</span><span class="bash"> 也可以直接通过id查询</span></span><br><span class="line">gpg --list-keys 30FF8D58</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 上传公钥到server key，默认上传到hkps://keys.openpgp.org，但是提示上传失败</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 看到网上的示例可以通过--keyserver指定上传的服务器地址，但是我这个版本[gpg (GnuPG/MacGPG2) 2.2.24]没有这个参数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用 https://gpgtools.org 上传公钥就会成功</span></span><br><span class="line">gpg --send-keys 30FF8D58</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看指纹</span></span><br><span class="line">gpg --fingerprint 30FF8D58</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除私钥，这里也可以使用用户名称或者邮箱，如果唯一的话</span></span><br><span class="line">gpg --delete-secret-keys 30FF8D58</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除公钥</span></span><br><span class="line">gpg --delete-keys 30FF8D58</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>2.settings.xml<br>配置 maven 的 settings.xml 文件，设置一个 server，里面添加 Sonatype 的账号和密码。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;settings&gt;</span><br><span class="line">    [...]</span><br><span class="line">    &lt;servers&gt;</span><br><span class="line">       [...]</span><br><span class="line">       &lt;server&gt;</span><br><span class="line">          &lt;id&gt;ossrh&lt;/id&gt;</span><br><span class="line">          &lt;username&gt;Sonatype账号&lt;/username&gt;</span><br><span class="line">          &lt;password&gt;Sonatype密码&lt;/password&gt;</span><br><span class="line">       &lt;/server&gt;</span><br><span class="line">    &lt;/servers&gt;</span><br><span class="line">&lt;/settings&gt;</span><br></pre></td></tr></table></figure></li>
<li><p>3.pom.xml，重点是后面几个plugin<br>这里重点说一下“nexus-staging-maven-plugin”这个插件，该插件会将我们发布到<a href="https://oss.sonatype.org的jar自动发布到maven中央仓库,如果没有这个插件,我们需要登录https//oss.sonatype.org%EF%BC%8C%E7%84%B6%E5%90%8E%E6%89%8B%E5%B7%A5%E7%82%B9%E5%87%BBStaging">https://oss.sonatype.org的jar自动发布到maven中央仓库，如果没有这个插件，我们需要登录https://oss.sonatype.org，然后手工点击Staging</a> Repositories ，找到你发布的包（GroupId开头的），然后点击close，再点击release。有说这种方式容易失败（我没有测试），推荐使用插件自动发布。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.hanqunfeng<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>reactive-redis-cache-annotation-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>redis-cache-annotation-reactive<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>redis cache function annotation for webflux<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://blog.hanqunfeng.com<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">licenses</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">license</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>The Apache License, Version 2.0<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://www.apache.org/licenses/LICENSE-2.0.txt<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">license</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">licenses</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">developers</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">developer</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>hanqf<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>hanqunfeng<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">email</span>&gt;</span>qunfeng_han@126.com<span class="tag">&lt;/<span class="name">email</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">developer</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">developers</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scm</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">connection</span>&gt;</span>scm:git:https://github.com/hanqunfeng/reactive-redis-cache-annotation-spring-boot-starter.git<span class="tag">&lt;/<span class="name">connection</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">developerConnection</span>&gt;</span>scm:git:https://github.com:hanqunfeng/reactive-redis-cache-annotation-spring-boot-starter.git<span class="tag">&lt;/<span class="name">developerConnection</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://github.com/hanqunfeng/reactive-redis-cache-annotation-spring-boot-starter<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">scm</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.encoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">maven.compiler.encoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-autoconfigure<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.datatype<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-datatype-jdk8<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.datatype<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-datatype-jsr310<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.aspectj<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aspectjweaver<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.projectreactor<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>reactor-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.data<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">source</span>&gt;</span>$&#123;java.version&#125;<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">target</span>&gt;</span>$&#123;java.version&#125;<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-source-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">id</span>&gt;</span>attach-source<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">phase</span>&gt;</span>verify<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                            <span class="comment">&lt;!--生成源代码的jar --&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-javadoc-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">id</span>&gt;</span>attach-javadoc<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">phase</span>&gt;</span>verify<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                            <span class="comment">&lt;!--生成javadoc的jar --&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                            <span class="comment">&lt;!--生成javadoc的html --&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>javadoc<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                            <span class="comment">&lt;!--不显示javadoc警告--&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">additionalOptions</span>&gt;</span>-Xdoclint:none<span class="tag">&lt;/<span class="name">additionalOptions</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">additionalJOption</span>&gt;</span>-Xdoclint:none<span class="tag">&lt;/<span class="name">additionalJOption</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">&lt;!-- gpg plugin,用于签名认证 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-gpg-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">id</span>&gt;</span>sign-artifacts<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">phase</span>&gt;</span>verify<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>sign<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--staging puglin,用于自动执行发布阶段(免手动)--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.sonatype.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>nexus-staging-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.6.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">extensions</span>&gt;</span>true<span class="tag">&lt;/<span class="name">extensions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">serverId</span>&gt;</span>ossrh<span class="tag">&lt;/<span class="name">serverId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">nexusUrl</span>&gt;</span>https://oss.sonatype.org/<span class="tag">&lt;/<span class="name">nexusUrl</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">autoReleaseAfterClose</span>&gt;</span>true<span class="tag">&lt;/<span class="name">autoReleaseAfterClose</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- release plugin,用于发布到release仓库部署插件 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-release-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.5.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">distributionManagement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">snapshotRepository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>ossrh<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://oss.sonatype.org/content/repositories/snapshots/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">snapshotRepository</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>ossrh<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://oss.sonatype.org/service/local/staging/deploy/maven2/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">distributionManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p>4.执行命令</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mvn clean package # 完成打包和测试</span><br><span class="line">mvn clean verify  # 完成源码打包和javadoc打包，同时完成签名</span><br><span class="line">mvn clean deploy  # 完成本地部署和maven中央仓库部署</span><br></pre></td></tr></table></figure>

<p>  执行过程中会提示你输入创建密钥对时的密码，</p>
<p>  如果不想人工参与，也可以使用如下方式（参考：<a href="http://maven.apache.org/plugins/maven-gpg-plugin/usage.html%EF%BC%89">http://maven.apache.org/plugins/maven-gpg-plugin/usage.html）</a></p>
<ul>
<li><p>a.在执行命令时指定密码：</p>
  <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mvn clean deploy -Dgpg.passphrase=thephrase</span><br></pre></td></tr></table></figure></li>
<li><p>b.setting.xml中创建一个server</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;settings&gt;</span><br><span class="line">[...]</span><br><span class="line">&lt;servers&gt;</span><br><span class="line">    [...]</span><br><span class="line">    &lt;server&gt;</span><br><span class="line">    &lt;id&gt;gpg.passphrase&lt;/id&gt;</span><br><span class="line">    &lt;passphrase&gt;clear or encrypted text&lt;/passphrase&gt;</span><br><span class="line">    &lt;/server&gt;</span><br><span class="line">&lt;/servers&gt;</span><br><span class="line">&lt;/settings&gt;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>5.执行成功后即说明发布到maven中央仓库成功了，过一会就会收到邮件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[ https://issues.sonatype.org/browse/OSSRH-62247?page=com.atlassian.jira.plugin.system.issuetabpanels:all-tabpanel ]</span><br><span class="line"></span><br><span class="line">Central OSSRH 更新了 OSSRH-62247:</span><br><span class="line">------------------------------</span><br><span class="line"></span><br><span class="line">Central sync is activated for com.hanqunfeng. After you successfully release, your component will be published to Central, typically within 10 minutes, though updates to search.maven.org can take up to two hours.</span><br><span class="line"></span><br><span class="line">&gt; reactive-redis-cache-annotation</span><br><span class="line">&gt; -------------------------------</span><br><span class="line">&gt;</span><br><span class="line">&gt;                 关键字: OSSRH-62247</span><br><span class="line">&gt;                 URL: https://issues.sonatype.org/browse/OSSRH-62247</span><br><span class="line">&gt;                  项目: Community Support - Open Source Project Repository Hosting</span><br><span class="line">&gt;                问题类型: New Project</span><br><span class="line">&gt;                 报告人: hanqunfeng</span><br><span class="line">&gt;                 经办人: Joel Orlina</span><br><span class="line">&gt;                 优先级: 重要</span><br><span class="line">&gt;</span><br><span class="line">&gt; reactive-redis-cache-annotation-spring-boot-starter</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">--</span><br><span class="line">这条信息是由Atlassian Jira发送的</span><br><span class="line">(v8.5.7#805007)</span><br></pre></td></tr></table></figure>

<p>  提示你，大约10分钟后你就可以将依赖添加到项目中进行下载了，不过要通过search.maven.org检索到需要等待两个小时，毕竟更新索引也是需要时间的。<br>  另外，如果你确认发布是成功的，记得要回到工单添加个注释，如</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">I&#x27;ve released Releases successfully.Thank you!</span><br></pre></td></tr></table></figure></li>
</ul>
<ul>
<li>6.更新部署<br>修改pom.xml中的版本号，重新执行mvn clean deploy即可。此时不会再收到sonatype发的邮件，依旧等待大约10分钟后你就可以将依赖添加到项目中进行下载了，同样search.maven.org检索到需要等待两个小时。</li>
</ul>
]]></content>
      <categories>
        <category>技术</category>
      </categories>
      <tags>
        <tag>maven</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot-WebFlux-Redis缓存注解</title>
    <url>/2020/11/22/springboot-webflux-redis-annotation/</url>
    <content><![CDATA[<h2 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h2><ul>
<li>通过本文，你将知道如何在WebFlux项目中通过redis注解缓存方法的返回值;</li>
<li>本项目基于springboot:2.4.0，jdk1.8，并使用Maven构建;</li>
<li>代码地址:<a href="https://github.com/hanqunfeng/reactive-redis-cache-annotation-spring-boot-starter">https://github.com/hanqunfeng/reactive-redis-cache-annotation-spring-boot-starter</a></li>
</ul>
<span id="more"></span>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近在使用WebFlux时发现，SpringBoot提供的@Cacheable，@CachePut，@CacheEvict和@Caching注解不支持响应式方法，SpringBoot官方也没有提供响应式方法的缓存注解，看到网上的一些解决方案都是直接在方法代码中加入缓存数据的代码逻辑，这样虽然可以解决问题，但是代码侵入并不优雅，于是萌生自己写一个基于redis的响应式方法缓存注解的想法，本项目参考SpringBoot提供的@Cacheable，@CachePut，@CacheEvict和@Caching注解声明，但是只是实现了一些基本功能，可以满足绝大部分使用场景的要求，因为SpringBoot早晚会给出官方解决方案，在此之前，不妨一试。</p>
<h2 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h2><ul>
<li><p>本项目已经发布到maven中央仓库，直接在项目中添加依赖即可。</p>
</li>
<li><p>本项目虽然基于springboot:2.4.0构建，但实际上springboot2.0+都可以使用。</p>
</li>
<li><p>maven依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.hanqunfeng<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>reactive-redis-cache-annotation-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p>gradle依赖</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">implementation <span class="string">&#x27;com.hanqunfeng:reactive-redis-cache-annotation-spring-boot-starter:1.1.0&#x27;</span></span><br></pre></td></tr></table></figure></li>
<li><p>此时项目中可能还要添加其它依赖，以gradle举例</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"><span class="comment">//webflux，非必须，主要是面向响应式编程的，所以使用springboot大概率会使用webflux</span></span><br><span class="line">implementation <span class="string">&#x27;org.springframework.boot:spring-boot-starter-webflux&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Spring Boot Redis 依赖，或者spring-boot-starter-data-redis-reactive，任选其一即可，注意要在配置文件中加入redis的配置</span></span><br><span class="line">implementation <span class="string">&#x27;org.springframework.boot:spring-boot-starter-data-redis&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//redis lettuce连接池依赖，也可以使用jedis连接池，非必须，正式环境建议开启连接池</span></span><br><span class="line">implementation <span class="string">&#x27;org.apache.commons:commons-pool2&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//aop 面向方面编程 支持@Aspect，非必须</span></span><br><span class="line">implementation <span class="string">&#x27;org.springframework.boot:spring-boot-starter-aop&#x27;</span></span><br></pre></td></tr></table></figure></li>
<li><p>方法返回值必须是Mono或者Flux类型，使用方式与springboot提供的Cacheable等注解类似</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 缓存 cacheName和key支持EL表达式，实际key的名称是&quot;cacheName_key&quot;</span></span><br><span class="line"><span class="comment">* 缓存结果</span></span><br><span class="line"><span class="comment">* key:sysuser_find_lisi</span></span><br><span class="line"><span class="comment">* value:</span></span><br><span class="line"><span class="comment">* [</span></span><br><span class="line"><span class="comment">* &quot;com.example.model.SysUser&quot;</span></span><br><span class="line"><span class="comment">* &#123;</span></span><br><span class="line"><span class="comment">*    id:&quot;5c74a4e4-c4f2-4570-8735-761d7a570d36&quot;</span></span><br><span class="line"><span class="comment">*    username:&quot;lisi&quot;</span></span><br><span class="line"><span class="comment">*    password:&quot;$2a$10$PXoGXLwg05.5YO.QtZa46ONypBmiK59yfefvO1OGO8kYFwzOB.Os6&quot;</span></span><br><span class="line"><span class="comment">*    enable:true</span></span><br><span class="line"><span class="comment">* &#125;</span></span><br><span class="line"><span class="comment">* ]</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@ReactiveRedisCacheable(cacheName = &quot;sysuser&quot;, key = &quot;&#x27;find_&#x27; + #username&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Mono&lt;SysUser&gt; <span class="title">findUserByUsername</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> sysUserRepository.findByUsername(username);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ReactiveRedisCacheable(cacheName = &quot;sysuser&quot;, key = &quot;all&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Flux&lt;SysUser&gt; <span class="title">findAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> sysUserRepository.findAll();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 删除缓存，allEntries = true 表示删除全部以&quot;cacheName_&quot;开头的缓存</span></span><br><span class="line"><span class="comment">* allEntries 默认false，此时需要指定key的值，表示删除指定的&quot;cacheName_key&quot;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@ReactiveRedisCacheEvict(cacheName = &quot;sysuser&quot;, allEntries = true)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Mono&lt;SysUser&gt; <span class="title">add</span><span class="params">(SysUser sysUser)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> sysUserRepository.addSysUser(sysUser.getId(), sysUser.getUsername(), sysUser.getPassword(), sysUser.getEnable()).flatMap(data -&gt; sysUserRepository.findById(sysUser.getId()));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 组合注解，用法与<span class="doctag">@Caching</span>类似</span></span><br><span class="line"><span class="comment">* 规则：</span></span><br><span class="line"><span class="comment">* 1.cacheables不能与cacheEvicts或者cachePuts同时存在，因为后者一定会执行方法主体，达不到调用缓存的目的，所以当cacheables存在时，后者即便指定也不执行</span></span><br><span class="line"><span class="comment">* 2.先执行cacheEvicts，再执行cachePuts</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@ReactiveRedisCaching(</span></span><br><span class="line"><span class="meta">        evict = &#123;@ReactiveRedisCacheEvict(cacheName = &quot;sysuser&quot;, key = &quot;all&quot;)&#125;,</span></span><br><span class="line"><span class="meta">        put = &#123;@ReactiveRedisCachePut(cacheName = &quot;sysuser&quot;, key = &quot;&#x27;find_&#x27; + #sysUser.username&quot;)&#125;</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Mono&lt;SysUser&gt; <span class="title">update</span><span class="params">(SysUser sysUser)</span> </span>&#123;</span><br><span class="line">    Mono&lt;SysUser&gt; save = sysUserRepository.save(sysUser);</span><br><span class="line">    <span class="keyword">return</span> save;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 删除指定的&quot;cacheName_key&quot;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@ReactiveRedisCacheEvict(cacheName = &quot;sysuser&quot;, key=&quot;&#x27;find_&#x27; + #username&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Mono&lt;Boolean&gt; <span class="title">deleteByUserName</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> sysUserRepository.deleteByUsername(username);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="RedisTemplate"><a href="#RedisTemplate" class="headerlink" title="RedisTemplate"></a>RedisTemplate</h3></li>
<li><p>如果使用时没有创建RedisTemplate，本项目中提供了一个默认的RedisTemplate，基于jackson序列化，支持jdk8的LocalDate和LocalDateTime</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean(value = RedisTemplate.class)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="title">redisTemplate</span><span class="params">(RedisConnectionFactory redisConnectionFactory)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    log.debug(<span class="string">&quot;ReactiveRedisConfig RedisTemplate&quot;</span>);</span><br><span class="line">    ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">    objectMapper.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);</span><br><span class="line">    <span class="comment">//objectMapper.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);</span></span><br><span class="line">    objectMapper.activateDefaultTyping(objectMapper.getPolymorphicTypeValidator(), ObjectMapper.DefaultTyping.NON_FINAL, JsonTypeInfo.As.WRAPPER_ARRAY);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//LocalDateTime系列序列化和反序列化模块，继承自jsr310，我们在这里修改了日期格式</span></span><br><span class="line">    JavaTimeModule javaTimeModule = <span class="keyword">new</span> JavaTimeModule();</span><br><span class="line">    <span class="comment">//序列化</span></span><br><span class="line">    javaTimeModule.addSerializer(LocalDateTime.class, <span class="keyword">new</span> LocalDateTimeSerializer(</span><br><span class="line">            DateTimeFormatter.ofPattern(DEFAULT_DATE_TIME_FORMAT)));</span><br><span class="line">    javaTimeModule.addSerializer(LocalDate.class,</span><br><span class="line">            <span class="keyword">new</span> LocalDateSerializer(DateTimeFormatter.ofPattern(DEFAULT_DATE_FORMAT)));</span><br><span class="line">    javaTimeModule.addSerializer(LocalTime.class,</span><br><span class="line">            <span class="keyword">new</span> LocalTimeSerializer(DateTimeFormatter.ofPattern(DEFAULT_TIME_FORMAT)));</span><br><span class="line">    <span class="comment">//反序列化</span></span><br><span class="line">    javaTimeModule.addDeserializer(LocalDateTime.class, <span class="keyword">new</span> LocalDateTimeDeserializer(</span><br><span class="line">            DateTimeFormatter.ofPattern(DEFAULT_DATE_TIME_FORMAT)));</span><br><span class="line">    javaTimeModule.addDeserializer(LocalDate.class,</span><br><span class="line">            <span class="keyword">new</span> LocalDateDeserializer(DateTimeFormatter.ofPattern(DEFAULT_DATE_FORMAT)));</span><br><span class="line">    javaTimeModule.addDeserializer(LocalTime.class,</span><br><span class="line">            <span class="keyword">new</span> LocalTimeDeserializer(DateTimeFormatter.ofPattern(DEFAULT_TIME_FORMAT)));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//注册模块</span></span><br><span class="line">    objectMapper.registerModule(javaTimeModule);</span><br><span class="line"></span><br><span class="line">    Jackson2JsonRedisSerializer&lt;Object&gt; serializer = <span class="keyword">new</span> Jackson2JsonRedisSerializer&lt;&gt;(Object.class);</span><br><span class="line">    serializer.setObjectMapper(objectMapper);</span><br><span class="line"></span><br><span class="line">    RedisTemplate&lt;String, Object&gt; redisTemplate = <span class="keyword">new</span> RedisTemplate&lt;&gt;();</span><br><span class="line">    redisTemplate.setConnectionFactory(redisConnectionFactory);</span><br><span class="line">    redisTemplate.setKeySerializer(<span class="keyword">new</span> StringRedisSerializer());</span><br><span class="line">    redisTemplate.setValueSerializer(serializer);</span><br><span class="line">    redisTemplate.setHashKeySerializer(<span class="keyword">new</span> StringRedisSerializer());</span><br><span class="line">    redisTemplate.setHashValueSerializer(serializer);</span><br><span class="line">    redisTemplate.afterPropertiesSet();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> redisTemplate;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="以下为源码说明"><a href="#以下为源码说明" class="headerlink" title="以下为源码说明"></a>以下为源码说明</h1><h2 id="源码依赖"><a href="#源码依赖" class="headerlink" title="源码依赖"></a>源码依赖</h2><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-autoconfigure<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.datatype<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-datatype-jdk8<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.datatype<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-datatype-jsr310<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.aspectj<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aspectjweaver<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.projectreactor<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>reactor-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.data<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="自定义Redis缓存相关注解"><a href="#自定义Redis缓存相关注解" class="headerlink" title="自定义Redis缓存相关注解"></a>自定义Redis缓存相关注解</h2><ul>
<li>只支持方法返回类型为Mono或者Flux</li>
<li>其它返回类型时请使用springboot提供的Cacheable，CachePut，CacheEvict和Caching</li>
<li>使用方式与springboot提供的Cacheable，CachePut，CacheEvict和Caching类似，具体看本文上面的示例</li>
</ul>
<h3 id="ReactiveRedisCacheable"><a href="#ReactiveRedisCacheable" class="headerlink" title="ReactiveRedisCacheable"></a>ReactiveRedisCacheable</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hanqunfeng.reactive.redis.cache.aop;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;h1&gt;redis方法缓存注解&lt;/h1&gt;</span></span><br><span class="line"><span class="comment"> * Created by hanqf on 2020/11/21 18:28.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Target(&#123;ElementType.METHOD&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> ReactiveRedisCacheable &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 缓存key，key为cacheName+&quot;_&quot;+key</span></span><br><span class="line"><span class="comment">     * 支持EL表达式</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="function">String <span class="title">key</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 缓存key分组，会做为缓存key的前缀+&quot;_&quot;</span></span><br><span class="line"><span class="comment">     * 支持EL表达式</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="function">String <span class="title">cacheName</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 缓存过期时间，单位秒，默认24小时</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">timeout</span><span class="params">()</span> <span class="keyword">default</span> 24 * 3600L</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="ReactiveRedisCacheEvict"><a href="#ReactiveRedisCacheEvict" class="headerlink" title="ReactiveRedisCacheEvict"></a>ReactiveRedisCacheEvict</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hanqunfeng.reactive.redis.cache.aop;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;h1&gt;redis清除缓存注解&lt;/h1&gt;</span></span><br><span class="line"><span class="comment"> * Created by hanqf on 2020/11/21 22:26.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Target(&#123;ElementType.METHOD&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> ReactiveRedisCacheEvict &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 缓存key，如果cacheName不为空，则key为cacheName+&quot;_&quot;+key</span></span><br><span class="line"><span class="comment">     * 支持EL表达式</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">key</span><span class="params">()</span> <span class="keyword">default</span> &quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 缓存key分组，会做为缓存key的前缀+&quot;_&quot;</span></span><br><span class="line"><span class="comment">     * 支持EL表达式</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">cacheName</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否删除cacheName下全部缓存数据，</span></span><br><span class="line"><span class="comment">     * true时cacheName不能为空，此时即便指定了key值，也会删除cacheName下全部缓存</span></span><br><span class="line"><span class="comment">     * false时key值不能为空</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">allEntries</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">false</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 调用清除缓存的时机，true:执行方法前，false:执行方法后</span></span><br><span class="line"><span class="comment">     * 如果是false，则方法执行过程中发生异常，则不会清除缓存</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">beforeInvocation</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">false</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ReactiveRedisCachePut"><a href="#ReactiveRedisCachePut" class="headerlink" title="ReactiveRedisCachePut"></a>ReactiveRedisCachePut</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hanqunfeng.reactive.redis.cache.aop;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;h1&gt;执行完方法更新缓存&lt;/h1&gt;</span></span><br><span class="line"><span class="comment"> * Created by hanqf on 2020/11/21 23:15.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Target(&#123;ElementType.METHOD&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> ReactiveRedisCachePut &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 缓存key，key为cacheName+&quot;_&quot;+key</span></span><br><span class="line"><span class="comment">     * 支持EL表达式</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">key</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 缓存key分组，会做为缓存key的前缀+&quot;_&quot;</span></span><br><span class="line"><span class="comment">     * 支持EL表达式</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">cacheName</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 缓存过期时间，单位秒，默认24小时</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">timeout</span><span class="params">()</span> <span class="keyword">default</span> 24 * 3600L</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="ReactiveRedisCaching"><a href="#ReactiveRedisCaching" class="headerlink" title="ReactiveRedisCaching"></a>ReactiveRedisCaching</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hanqunfeng.reactive.redis.cache.aop;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;h1&gt;组合&lt;/h1&gt;</span></span><br><span class="line"><span class="comment"> * Created by hanqf on 2020/11/21 23:24.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Target(&#123;ElementType.METHOD&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> ReactiveRedisCaching &#123;</span><br><span class="line"></span><br><span class="line">    ReactiveRedisCacheable[] cacheable() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    ReactiveRedisCachePut[] put() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    ReactiveRedisCacheEvict[] evict() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="AOP–ReactiveRedisCacheAspect"><a href="#AOP–ReactiveRedisCacheAspect" class="headerlink" title="AOP–ReactiveRedisCacheAspect"></a>AOP–ReactiveRedisCacheAspect</h2><ul>
<li>支持方法返回类型为Mono或者Flux</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hanqunfeng.reactive.redis.cache.aop;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.ProceedingJoinPoint;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Around;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Pointcut;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.reflect.MethodSignature;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Flux;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicBoolean;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;h1&gt;redis缓存aop&lt;/h1&gt;</span></span><br><span class="line"><span class="comment"> * Created by hanqf on 2020/11/21 16:16.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="comment">//标识是一个Aspect代理类</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="comment">//如果有多个切面拦截相同的切点，可以用@Order指定执行顺序</span></span><br><span class="line"><span class="comment">//@Order(1)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReactiveRedisCacheAspect</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Pointcut(&quot;@annotation(com.hanqunfeng.reactive.redis.cache.aop.ReactiveRedisCacheable)&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cacheablePointCut</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Pointcut(&quot;@annotation(com.hanqunfeng.reactive.redis.cache.aop.ReactiveRedisCacheEvict)&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cacheEvictPointCut</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Pointcut(&quot;@annotation(com.hanqunfeng.reactive.redis.cache.aop.ReactiveRedisCachePut)&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cachePutPointCut</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Pointcut(&quot;@annotation(com.hanqunfeng.reactive.redis.cache.aop.ReactiveRedisCaching)&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cachingPointCut</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//环绕通知,一般不建议使用，可以通过@Before和@AfterReturning实现</span></span><br><span class="line">    <span class="comment">//但是响应式方法只能通过环绕通知实现aop，因为其它通知会导致不再同一个线程执行</span></span><br><span class="line">    <span class="meta">@Around(&quot;cacheablePointCut()&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">cacheableAround</span><span class="params">(ProceedingJoinPoint proceedingJoinPoint)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        log.debug(<span class="string">&quot;ReactiveRedisCacheAspect cacheableAround....&quot;</span>);</span><br><span class="line"></span><br><span class="line">        MethodSignature methodSignature = (MethodSignature) proceedingJoinPoint.getSignature();</span><br><span class="line">        Method method = methodSignature.getMethod();</span><br><span class="line">        String returnTypeName = method.getReturnType().getSimpleName();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        ReactiveRedisCacheable annotation = method.getAnnotation(ReactiveRedisCacheable.class);</span><br><span class="line">        String cacheName = annotation.cacheName();</span><br><span class="line">        String key = annotation.key();</span><br><span class="line">        <span class="keyword">long</span> timeout = annotation.timeout();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//转换EL表达式</span></span><br><span class="line">        cacheName = (String) AspectSupportUtils.getKeyValue(proceedingJoinPoint, cacheName);</span><br><span class="line">        key = (String) AspectSupportUtils.getKeyValue(proceedingJoinPoint, key);</span><br><span class="line"></span><br><span class="line">        String redis_key = cacheName + <span class="string">&quot;_&quot;</span> + key;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> hasKey = redisTemplate.hasKey(redis_key);</span><br><span class="line">        <span class="keyword">if</span> (hasKey) &#123;</span><br><span class="line">            Object o = redisTemplate.opsForValue().get(redis_key);</span><br><span class="line">            <span class="keyword">if</span> (returnTypeName.equals(<span class="string">&quot;Flux&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> Flux.fromIterable((List) o);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (returnTypeName.equals(<span class="string">&quot;Mono&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> Mono.just(o);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> o;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//实际执行的方法</span></span><br><span class="line">            Object proceed = proceedingJoinPoint.proceed();</span><br><span class="line">            <span class="keyword">if</span> (returnTypeName.equals(<span class="string">&quot;Flux&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> ((Flux) proceed).collectList().doOnNext(list -&gt; redisTemplate.opsForValue().set(redis_key, list, timeout, TimeUnit.SECONDS)).flatMapMany(list -&gt; Flux.fromIterable((List) list));</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (returnTypeName.equals(<span class="string">&quot;Mono&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> ((Mono) proceed).doOnNext(obj -&gt; redisTemplate.opsForValue().set(redis_key, obj, timeout, TimeUnit.SECONDS));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> proceed;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Around(&quot;cacheEvictPointCut()&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">cacheEvictAround</span><span class="params">(ProceedingJoinPoint proceedingJoinPoint)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        log.debug(<span class="string">&quot;ReactiveRedisCacheAspect cacheEvictAround....&quot;</span>);</span><br><span class="line"></span><br><span class="line">        MethodSignature methodSignature = (MethodSignature) proceedingJoinPoint.getSignature();</span><br><span class="line">        Method method = methodSignature.getMethod();</span><br><span class="line">        String returnTypeName = method.getReturnType().getSimpleName();</span><br><span class="line"></span><br><span class="line">        ReactiveRedisCacheEvict annotation = method.getAnnotation(ReactiveRedisCacheEvict.class);</span><br><span class="line">        String cacheName = annotation.cacheName();</span><br><span class="line">        String key = annotation.key();</span><br><span class="line">        <span class="keyword">boolean</span> allEntries = annotation.allEntries();</span><br><span class="line">        <span class="keyword">boolean</span> beforeInvocation = annotation.beforeInvocation();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//转换EL表达式</span></span><br><span class="line">        cacheName = (String) AspectSupportUtils.getKeyValue(proceedingJoinPoint, cacheName);</span><br><span class="line">        key = (String) AspectSupportUtils.getKeyValue(proceedingJoinPoint, key);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//执行方法前清除缓存</span></span><br><span class="line">        <span class="keyword">if</span> (beforeInvocation) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//清除全部缓存</span></span><br><span class="line">            deleteRedisCache(cacheName, key, allEntries);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//实际执行的方法</span></span><br><span class="line">            Object proceed = proceedingJoinPoint.proceed();</span><br><span class="line">            <span class="keyword">return</span> proceed;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;<span class="comment">//成功执行方法后清除缓存</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//实际执行的方法</span></span><br><span class="line">            Object proceed = proceedingJoinPoint.proceed();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> String cacheNameTemp = cacheName;</span><br><span class="line">            <span class="keyword">final</span> String keyTemp = key;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (returnTypeName.equals(<span class="string">&quot;Flux&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> ((Flux) proceed).collectList().doOnNext(list -&gt; &#123;</span><br><span class="line">                    <span class="comment">//清除全部缓存</span></span><br><span class="line">                    deleteRedisCache(cacheNameTemp, keyTemp, allEntries);</span><br><span class="line">                &#125;).flatMapMany(list -&gt; Flux.fromIterable((List) list));</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (returnTypeName.equals(<span class="string">&quot;Mono&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> ((Mono) proceed).doOnNext(obj -&gt; &#123;</span><br><span class="line">                    <span class="comment">//清除全部缓存</span></span><br><span class="line">                    deleteRedisCache(cacheNameTemp, keyTemp, allEntries);</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> proceed;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Around(&quot;cachePutPointCut()&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">cachePutAround</span><span class="params">(ProceedingJoinPoint proceedingJoinPoint)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        log.debug(<span class="string">&quot;ReactiveRedisCacheAspect cachePutAround....&quot;</span>);</span><br><span class="line"></span><br><span class="line">        MethodSignature methodSignature = (MethodSignature) proceedingJoinPoint.getSignature();</span><br><span class="line">        Method method = methodSignature.getMethod();</span><br><span class="line">        String returnTypeName = method.getReturnType().getSimpleName();</span><br><span class="line"></span><br><span class="line">        ReactiveRedisCachePut annotation = method.getAnnotation(ReactiveRedisCachePut.class);</span><br><span class="line">        String cacheName = annotation.cacheName();</span><br><span class="line">        String key = annotation.key();</span><br><span class="line">        <span class="keyword">long</span> timeout = annotation.timeout();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//转换EL表达式</span></span><br><span class="line">        cacheName = (String) AspectSupportUtils.getKeyValue(proceedingJoinPoint, cacheName);</span><br><span class="line">        key = (String) AspectSupportUtils.getKeyValue(proceedingJoinPoint, key);</span><br><span class="line"></span><br><span class="line">        String redis_key = cacheName + <span class="string">&quot;_&quot;</span> + key;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> hasKey = redisTemplate.hasKey(redis_key);</span><br><span class="line">        <span class="keyword">if</span> (hasKey) &#123;</span><br><span class="line">            redisTemplate.delete(redis_key);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//实际执行的方法</span></span><br><span class="line">        Object proceed = proceedingJoinPoint.proceed();</span><br><span class="line">        <span class="keyword">if</span> (returnTypeName.equals(<span class="string">&quot;Flux&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> ((Flux) proceed).collectList().doOnNext(list -&gt; redisTemplate.opsForValue().set(redis_key, list, timeout, TimeUnit.SECONDS)).flatMapMany(list -&gt; Flux.fromIterable((List) list));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (returnTypeName.equals(<span class="string">&quot;Mono&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> ((Mono) proceed).doOnNext(obj -&gt; redisTemplate.opsForValue().set(redis_key, obj, timeout, TimeUnit.SECONDS));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> proceed;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Around(&quot;cachingPointCut()&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">cachingAround</span><span class="params">(ProceedingJoinPoint proceedingJoinPoint)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        log.debug(<span class="string">&quot;ReactiveRedisCacheAspect cachingAround....&quot;</span>);</span><br><span class="line"></span><br><span class="line">        MethodSignature methodSignature = (MethodSignature) proceedingJoinPoint.getSignature();</span><br><span class="line">        Method method = methodSignature.getMethod();</span><br><span class="line">        String returnTypeName = method.getReturnType().getSimpleName();</span><br><span class="line"></span><br><span class="line">        ReactiveRedisCaching annotation = method.getAnnotation(ReactiveRedisCaching.class);</span><br><span class="line"></span><br><span class="line">        ReactiveRedisCacheEvict[] cacheEvicts = annotation.evict();</span><br><span class="line">        ReactiveRedisCachePut[] cachePuts = annotation.put();</span><br><span class="line">        ReactiveRedisCacheable[] cacheables = annotation.cacheable();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//规则：</span></span><br><span class="line">        <span class="comment">//1.cacheables不能与cacheEvicts或者cachePuts同时存在，因为后者一定会执行方法主体，达不到调用缓存的目的，所以当cacheables存在时，后者即便指定也不执行</span></span><br><span class="line">        <span class="comment">//2.先执行cacheEvicts，再执行cachePuts</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (cacheables.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            Map&lt;String, Long&gt; key_map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">            List&lt;String&gt; key_list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            Arrays.stream(cacheables).forEach(cacheable -&gt; &#123;</span><br><span class="line">                String cacheName = cacheable.cacheName();</span><br><span class="line">                String key = cacheable.key();</span><br><span class="line">                <span class="keyword">long</span> timeout = cacheable.timeout();</span><br><span class="line"></span><br><span class="line">                <span class="comment">//转换EL表达式</span></span><br><span class="line">                cacheName = (String) AspectSupportUtils.getKeyValue(proceedingJoinPoint, cacheName);</span><br><span class="line">                key = (String) AspectSupportUtils.getKeyValue(proceedingJoinPoint, key);</span><br><span class="line"></span><br><span class="line">                String redis_key = cacheName + <span class="string">&quot;_&quot;</span> + key;</span><br><span class="line"></span><br><span class="line">                key_map.put(redis_key, timeout);</span><br><span class="line">                key_list.add(redis_key);</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            AtomicBoolean isAllKeyHas = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">true</span>);</span><br><span class="line">            key_list.forEach(key -&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> (!redisTemplate.hasKey(key)) &#123;</span><br><span class="line">                    isAllKeyHas.set(<span class="keyword">false</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//全部key都有值，则直接返回缓存</span></span><br><span class="line">            <span class="keyword">if</span> (isAllKeyHas.get()) &#123;</span><br><span class="line">                Object o = redisTemplate.opsForValue().get(key_list.get(<span class="number">0</span>));</span><br><span class="line">                <span class="keyword">if</span> (returnTypeName.equals(<span class="string">&quot;Flux&quot;</span>)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> Flux.fromIterable((List) o);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (returnTypeName.equals(<span class="string">&quot;Mono&quot;</span>)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> Mono.just(o);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> o;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//实际执行的方法</span></span><br><span class="line">                Object proceed = proceedingJoinPoint.proceed();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (returnTypeName.equals(<span class="string">&quot;Flux&quot;</span>)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> ((Flux) proceed).collectList()</span><br><span class="line">                            .doOnNext(list -&gt; key_map.forEach((key, val) -&gt; redisTemplate.opsForValue().set(key, list, val, TimeUnit.SECONDS)))</span><br><span class="line">                            .flatMapMany(list -&gt; Flux.fromIterable((List) list));</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (returnTypeName.equals(<span class="string">&quot;Mono&quot;</span>)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> ((Mono) proceed)</span><br><span class="line">                            .doOnNext(obj -&gt; key_map.forEach((key, val) -&gt; redisTemplate.opsForValue().set(key, obj, val, TimeUnit.SECONDS)));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> proceed;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            Map&lt;String, Boolean&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">            <span class="keyword">if</span> (cacheEvicts.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                Arrays.stream(cacheEvicts).forEach(cacheEvict -&gt; &#123;</span><br><span class="line">                    String cacheName = cacheEvict.cacheName();</span><br><span class="line">                    String key = cacheEvict.key();</span><br><span class="line">                    <span class="keyword">boolean</span> allEntries = cacheEvict.allEntries();</span><br><span class="line">                    <span class="keyword">boolean</span> beforeInvocation = cacheEvict.beforeInvocation();</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//转换EL表达式</span></span><br><span class="line">                    cacheName = (String) AspectSupportUtils.getKeyValue(proceedingJoinPoint, cacheName);</span><br><span class="line">                    key = (String) AspectSupportUtils.getKeyValue(proceedingJoinPoint, key);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (beforeInvocation) &#123; <span class="comment">//执行方法前清除缓存</span></span><br><span class="line">                        <span class="comment">//清除全部缓存</span></span><br><span class="line">                        deleteRedisCache(cacheName, key, allEntries);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123; <span class="comment">//成功执行方法后清除缓存，先保存到map中</span></span><br><span class="line">                        <span class="comment">//清除全部缓存</span></span><br><span class="line">                        <span class="keyword">if</span> (allEntries) &#123;</span><br><span class="line">                            map.put(cacheName, <span class="keyword">true</span>);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            map.put(cacheName + <span class="string">&quot;_&quot;</span> + key, <span class="keyword">false</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//实际执行的方法</span></span><br><span class="line">            Object proceed = proceedingJoinPoint.proceed();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (cachePuts.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                Map&lt;String, Long&gt; key_map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">                Arrays.stream(cachePuts).forEach(cachePut -&gt; &#123;</span><br><span class="line">                    String cacheName = cachePut.cacheName();</span><br><span class="line">                    String key = cachePut.key();</span><br><span class="line">                    <span class="keyword">long</span> timeout = cachePut.timeout();</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//转换EL表达式</span></span><br><span class="line">                    cacheName = (String) AspectSupportUtils.getKeyValue(proceedingJoinPoint, cacheName);</span><br><span class="line">                    key = (String) AspectSupportUtils.getKeyValue(proceedingJoinPoint, key);</span><br><span class="line"></span><br><span class="line">                    String redis_key = cacheName + <span class="string">&quot;_&quot;</span> + key;</span><br><span class="line"></span><br><span class="line">                    key_map.put(redis_key, timeout);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">boolean</span> hasKey = redisTemplate.hasKey(redis_key);</span><br><span class="line">                    <span class="keyword">if</span> (hasKey) &#123;</span><br><span class="line">                        redisTemplate.delete(redis_key);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (returnTypeName.equals(<span class="string">&quot;Flux&quot;</span>)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> ((Flux) proceed).collectList()</span><br><span class="line">                            .doOnNext(list -&gt; &#123;</span><br><span class="line">                                <span class="comment">//执行方法后清除缓存</span></span><br><span class="line">                                <span class="keyword">if</span> (map.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                                    map.forEach((key, val) -&gt; &#123;</span><br><span class="line">                                        deleteRedisCache(key, val);</span><br><span class="line">                                    &#125;);</span><br><span class="line">                                &#125;</span><br><span class="line">                                key_map.forEach((key, val) -&gt; redisTemplate.opsForValue().set(key, list, val, TimeUnit.SECONDS));</span><br><span class="line">                            &#125;)</span><br><span class="line">                            .flatMapMany(list -&gt; Flux.fromIterable((List) list));</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (returnTypeName.equals(<span class="string">&quot;Mono&quot;</span>)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> ((Mono) proceed)</span><br><span class="line">                            .doOnNext(obj -&gt; &#123;</span><br><span class="line">                                <span class="comment">//执行方法后清除缓存</span></span><br><span class="line">                                <span class="keyword">if</span> (map.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                                    map.forEach((key, val) -&gt; &#123;</span><br><span class="line">                                        deleteRedisCache(key, val);</span><br><span class="line">                                    &#125;);</span><br><span class="line">                                &#125;</span><br><span class="line">                                key_map.forEach((key, val) -&gt; redisTemplate.opsForValue().set(key, obj, val, TimeUnit.SECONDS));</span><br><span class="line">                            &#125;);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> proceed;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (returnTypeName.equals(<span class="string">&quot;Flux&quot;</span>)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> ((Flux) proceed).collectList().doOnNext(list -&gt; &#123;</span><br><span class="line">                        <span class="comment">//执行方法后清除缓存</span></span><br><span class="line">                        <span class="keyword">if</span> (map.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                            map.forEach((key, val) -&gt; &#123;</span><br><span class="line">                                deleteRedisCache(key, val);</span><br><span class="line">                            &#125;);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;).flatMapMany(list -&gt; Flux.fromIterable((List) list));</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (returnTypeName.equals(<span class="string">&quot;Mono&quot;</span>)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> ((Mono) proceed).doOnNext(obj -&gt; &#123;</span><br><span class="line">                        <span class="comment">//执行方法后清除缓存</span></span><br><span class="line">                        <span class="keyword">if</span> (map.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                            map.forEach((key, val) -&gt; &#123;</span><br><span class="line">                                deleteRedisCache(key, val);</span><br><span class="line">                            &#125;);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> proceed;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">deleteRedisCache</span><span class="params">(String key, <span class="keyword">boolean</span> clearAll)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (clearAll) &#123;</span><br><span class="line">            Set keys = redisTemplate.keys(key + <span class="string">&quot;_*&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (!keys.isEmpty()) &#123;</span><br><span class="line">                redisTemplate.delete(keys);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (redisTemplate.hasKey(key)) &#123;</span><br><span class="line">                redisTemplate.delete(key);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">deleteRedisCache</span><span class="params">(String cacheName, String key, <span class="keyword">boolean</span> clearAll)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        String redis_key = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (clearAll) &#123;</span><br><span class="line">            redis_key = cacheName + <span class="string">&quot;_*&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            redis_key = cacheName + <span class="string">&quot;_&quot;</span> + key;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        deleteRedisCache(redis_key, clearAll);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="注解属性支持EL表达式的工具类"><a href="#注解属性支持EL表达式的工具类" class="headerlink" title="注解属性支持EL表达式的工具类"></a>注解属性支持EL表达式的工具类</h2><h3 id="AspectSupportUtils"><a href="#AspectSupportUtils" class="headerlink" title="AspectSupportUtils"></a>AspectSupportUtils</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hanqunfeng.reactive.redis.cache.aop;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.JoinPoint;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.reflect.MethodSignature;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.interceptor.SimpleKeyGenerator;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.expression.AnnotatedElementKey;</span><br><span class="line"><span class="keyword">import</span> org.springframework.expression.EvaluationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AspectSupportUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ExpressionEvaluator evaluator = <span class="keyword">new</span> ExpressionEvaluator();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">getKeyValue</span><span class="params">(JoinPoint joinPoint, String keyExpression)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(keyExpression.contains(<span class="string">&quot;#&quot;</span>) || keyExpression.contains(<span class="string">&quot;&#x27;&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> getKeyValue(joinPoint.getTarget(), joinPoint.getArgs(), joinPoint.getTarget().getClass(),</span><br><span class="line">                    ((MethodSignature) joinPoint.getSignature()).getMethod(), keyExpression);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> keyExpression;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title">getKeyValue</span><span class="params">(Object object, Object[] args, Class&lt;?&gt; clazz, Method method,</span></span></span><br><span class="line"><span class="params"><span class="function">                                      String keyExpression)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(keyExpression)) &#123;</span><br><span class="line">            EvaluationContext evaluationContext = evaluator.createEvaluationContext(object, clazz, method, args);</span><br><span class="line">            AnnotatedElementKey methodKey = <span class="keyword">new</span> AnnotatedElementKey(method, clazz);</span><br><span class="line">            <span class="keyword">return</span> evaluator.key(keyExpression, methodKey, evaluationContext);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> SimpleKeyGenerator.generateKey(args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="ExpressionEvaluator"><a href="#ExpressionEvaluator" class="headerlink" title="ExpressionEvaluator"></a>ExpressionEvaluator</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hanqunfeng.reactive.redis.cache.aop;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.aop.support.AopUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.expression.AnnotatedElementKey;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.expression.CachedExpressionEvaluator;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.expression.MethodBasedEvaluationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.DefaultParameterNameDiscoverer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.ParameterNameDiscoverer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.expression.EvaluationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.expression.Expression;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExpressionEvaluator</span> <span class="keyword">extends</span> <span class="title">CachedExpressionEvaluator</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ParameterNameDiscoverer paramNameDiscoverer = <span class="keyword">new</span> DefaultParameterNameDiscoverer();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;ExpressionKey, Expression&gt; conditionCache = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">64</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;AnnotatedElementKey, Method&gt; targetMethodCache = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">64</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> EvaluationContext <span class="title">createEvaluationContext</span><span class="params">(Object object, Class&lt;?&gt; targetClass, Method method,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                     Object[] args)</span> </span>&#123;</span><br><span class="line">        Method targetMethod = getTargetMethod(targetClass, method);</span><br><span class="line">        ExpressionRootObject root = <span class="keyword">new</span> ExpressionRootObject(object, args);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MethodBasedEvaluationContext(root, targetMethod, args, <span class="keyword">this</span>.paramNameDiscoverer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">key</span><span class="params">(String conditionExpression, AnnotatedElementKey elementKey, EvaluationContext evalContext)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getExpression(<span class="keyword">this</span>.conditionCache, elementKey, conditionExpression).getValue(evalContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Method <span class="title">getTargetMethod</span><span class="params">(Class&lt;?&gt; targetClass, Method method)</span> </span>&#123;</span><br><span class="line">        AnnotatedElementKey methodKey = <span class="keyword">new</span> AnnotatedElementKey(method, targetClass);</span><br><span class="line">        Method targetMethod = <span class="keyword">this</span>.targetMethodCache.get(methodKey);</span><br><span class="line">        <span class="keyword">if</span> (targetMethod == <span class="keyword">null</span>) &#123;</span><br><span class="line">            targetMethod = AopUtils.getMostSpecificMethod(method, targetClass);</span><br><span class="line">            <span class="keyword">if</span> (targetMethod == <span class="keyword">null</span>) &#123;</span><br><span class="line">                targetMethod = method;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">this</span>.targetMethodCache.put(methodKey, targetMethod);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> targetMethod;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ExpressionRootObject</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Object object;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Object[] args;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ExpressionRootObject</span><span class="params">(Object object, Object[] args)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.object = object;</span><br><span class="line">            <span class="keyword">this</span>.args = args;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">getobject</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> object;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Object[] getArgs() &#123;</span><br><span class="line">            <span class="keyword">return</span> args;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="本项目提供了自动配置类，开启Aspect支持同时提供RedisTemplate"><a href="#本项目提供了自动配置类，开启Aspect支持同时提供RedisTemplate" class="headerlink" title="本项目提供了自动配置类，开启Aspect支持同时提供RedisTemplate"></a>本项目提供了自动配置类，开启Aspect支持同时提供RedisTemplate</h2><ul>
<li>支持LocalDate和LocalDateTime的序列化和反序列化</li>
<li>存储key为字符串，值为json<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hanqunfeng.reactive.redis.cache.config;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.annotation.JsonAutoDetect;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.annotation.JsonTypeInfo;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.annotation.PropertyAccessor;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.datatype.jsr310.JavaTimeModule;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.datatype.jsr310.deser.LocalDateDeserializer;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.datatype.jsr310.deser.LocalDateTimeDeserializer;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.datatype.jsr310.deser.LocalTimeDeserializer;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.datatype.jsr310.ser.LocalDateSerializer;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.datatype.jsr310.ser.LocalDateTimeSerializer;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.datatype.jsr310.ser.LocalTimeSerializer;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ComponentScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.EnableAspectJAutoProxy;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.RedisConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.Jackson2JsonRedisSerializer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.StringRedisSerializer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDate;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalTime;</span><br><span class="line"><span class="keyword">import</span> java.time.format.DateTimeFormatter;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> hanqf</span></span><br><span class="line"><span class="comment"> * Created by hanqf on 2020/11/22 15:38</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(basePackages = &quot;org.hanqf.reactive.redis.cache&quot;)</span></span><br><span class="line"><span class="meta">@EnableAspectJAutoProxy</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReactiveRedisConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 默认日期时间格式</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_DATE_TIME_FORMAT = <span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 默认日期格式</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_DATE_FORMAT = <span class="string">&quot;yyyy-MM-dd&quot;</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 默认时间格式</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_TIME_FORMAT = <span class="string">&quot;HH:mm:ss&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean(value = RedisTemplate.class)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="title">redisTemplate</span><span class="params">(RedisConnectionFactory redisConnectionFactory)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        log.debug(<span class="string">&quot;ReactiveRedisConfig RedisTemplate&quot;</span>);</span><br><span class="line">        ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">        objectMapper.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);</span><br><span class="line">        <span class="comment">//objectMapper.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);</span></span><br><span class="line">        objectMapper.activateDefaultTyping(objectMapper.getPolymorphicTypeValidator(), ObjectMapper.DefaultTyping.NON_FINAL, JsonTypeInfo.As.WRAPPER_ARRAY);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//LocalDateTime系列序列化和反序列化模块，继承自jsr310，我们在这里修改了日期格式</span></span><br><span class="line">        JavaTimeModule javaTimeModule = <span class="keyword">new</span> JavaTimeModule();</span><br><span class="line">        <span class="comment">//序列化</span></span><br><span class="line">        javaTimeModule.addSerializer(LocalDateTime.class, <span class="keyword">new</span> LocalDateTimeSerializer(</span><br><span class="line">                DateTimeFormatter.ofPattern(DEFAULT_DATE_TIME_FORMAT)));</span><br><span class="line">        javaTimeModule.addSerializer(LocalDate.class,</span><br><span class="line">                <span class="keyword">new</span> LocalDateSerializer(DateTimeFormatter.ofPattern(DEFAULT_DATE_FORMAT)));</span><br><span class="line">        javaTimeModule.addSerializer(LocalTime.class,</span><br><span class="line">                <span class="keyword">new</span> LocalTimeSerializer(DateTimeFormatter.ofPattern(DEFAULT_TIME_FORMAT)));</span><br><span class="line">        <span class="comment">//反序列化</span></span><br><span class="line">        javaTimeModule.addDeserializer(LocalDateTime.class, <span class="keyword">new</span> LocalDateTimeDeserializer(</span><br><span class="line">                DateTimeFormatter.ofPattern(DEFAULT_DATE_TIME_FORMAT)));</span><br><span class="line">        javaTimeModule.addDeserializer(LocalDate.class,</span><br><span class="line">                <span class="keyword">new</span> LocalDateDeserializer(DateTimeFormatter.ofPattern(DEFAULT_DATE_FORMAT)));</span><br><span class="line">        javaTimeModule.addDeserializer(LocalTime.class,</span><br><span class="line">                <span class="keyword">new</span> LocalTimeDeserializer(DateTimeFormatter.ofPattern(DEFAULT_TIME_FORMAT)));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//注册模块</span></span><br><span class="line">        objectMapper.registerModule(javaTimeModule);</span><br><span class="line"></span><br><span class="line">        Jackson2JsonRedisSerializer&lt;Object&gt; serializer = <span class="keyword">new</span> Jackson2JsonRedisSerializer&lt;&gt;(Object.class);</span><br><span class="line">        serializer.setObjectMapper(objectMapper);</span><br><span class="line"></span><br><span class="line">        RedisTemplate&lt;String, Object&gt; redisTemplate = <span class="keyword">new</span> RedisTemplate&lt;&gt;();</span><br><span class="line">        redisTemplate.setConnectionFactory(redisConnectionFactory);</span><br><span class="line">        redisTemplate.setKeySerializer(<span class="keyword">new</span> StringRedisSerializer());</span><br><span class="line">        redisTemplate.setValueSerializer(serializer);</span><br><span class="line">        redisTemplate.setHashKeySerializer(<span class="keyword">new</span> StringRedisSerializer());</span><br><span class="line">        redisTemplate.setHashValueSerializer(serializer);</span><br><span class="line">        redisTemplate.afterPropertiesSet();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> redisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
]]></content>
      <categories>
        <category>技术</category>
        <category>springboot2</category>
        <category>Java</category>
      </categories>
      <tags>
        <tag>springboot</tag>
        <tag>redis</tag>
        <tag>webflux</tag>
        <tag>reactive</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot-OAuth2-JWT-ClientServer</title>
    <url>/2020/11/15/springboot-oauth2-jwt-clientserver/</url>
    <content><![CDATA[<h2 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h2><ul>
<li>通过本文，你将知道如何搭建一个基于SpringBoot-OAuth2-JWT的客户端服务器</li>
<li>本文基于springboot:2.4.0，项目基于Gradle-6.6.1构建</li>
<li>代码地址:<a href="https://github.com/hanqunfeng/springbootchapter/tree/master/chapter48">https://github.com/hanqunfeng/springbootchapter/tree/master/chapter48</a></li>
</ul>
<span id="more"></span>
<h2 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h2><ul>
<li>springboot官方提供了支持<figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line">implementation <span class="string">&#x27;org.springframework.boot:spring-boot-starter-web&#x27;</span></span><br><span class="line">implementation <span class="string">&#x27;org.springframework.boot:spring-boot-starter-oauth2-client&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//本项目中使用了lombok简少代码量，非必须依赖</span></span><br><span class="line">compileOnly <span class="string">&#x27;org.projectlombok:lombok&#x27;</span></span><br><span class="line">annotationProcessor <span class="string">&#x27;org.projectlombok:lombok&#x27;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="WebSecurityConfig"><a href="#WebSecurityConfig" class="headerlink" title="WebSecurityConfig"></a>WebSecurityConfig</h2><ul>
<li>springboot没有为client-server设置独立的注解和配置类，而是把这部分功能整合到了spring-security中<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.oauth2clientdemo2.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.oauth2clientdemo2.exception.CustomException;</span><br><span class="line"><span class="keyword">import</span> com.example.oauth2clientdemo2.security.CustomAccessDeniedHandler;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.web.client.RestTemplateCustomizer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.client.ClientHttpRequestInterceptor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.client.ClientHttpResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jdbc.core.JdbcOperations;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.WebSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.context.SecurityContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.client.JdbcOAuth2AuthorizedClientService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.client.OAuth2AuthorizedClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.client.OAuth2AuthorizedClientService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.client.authentication.OAuth2AuthenticationToken;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.client.registration.ClientRegistrationRepository;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.CollectionUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;h1&gt;&lt;/h1&gt;</span></span><br><span class="line"><span class="comment"> * Created by hanqf on 2020/11/9 18:11.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;oauth2.server.logout&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String oauth2_server_logout;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CustomAccessDeniedHandler customAccessDeniedHandler;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 指定不拦截的路径规则</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(WebSecurity web)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//设置不需要拦截的路径，也就是不需要认证的路径</span></span><br><span class="line">        web.ignoring().antMatchers(<span class="string">&quot;/webjars/**&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//logout跳转到认证服务器的logout</span></span><br><span class="line">        http.logout().logoutSuccessUrl(oauth2_server_logout);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//配置认证规则</span></span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                .mvcMatchers(<span class="string">&quot;/oauth/login&quot;</span>).permitAll()</span><br><span class="line">                <span class="comment">////所有路径都需要登录</span></span><br><span class="line">                .antMatchers(<span class="string">&quot;/&quot;</span>).authenticated()</span><br><span class="line">                <span class="comment">////需要具备相应的角色才能访问，这里返回的权限是scope，所以还是使用rbac验证吧</span></span><br><span class="line">                .antMatchers(<span class="string">&quot;/user/**&quot;</span>, <span class="string">&quot;/user2/**&quot;</span>).hasAuthority(<span class="string">&quot;SCOPE_any&quot;</span>)</span><br><span class="line">                .anyRequest().access(<span class="string">&quot;@rbacService.hasPerssion(request,authentication)&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//开启oauth2登录认证</span></span><br><span class="line">        http.oauth2Login();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//开启基于oauth2的客户端信息</span></span><br><span class="line">        http.oauth2Client();</span><br><span class="line"></span><br><span class="line">        http.csrf().disable();</span><br><span class="line"></span><br><span class="line">        http.exceptionHandling().accessDeniedHandler(customAccessDeniedHandler);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="WebSecurityConfig说明"><a href="#WebSecurityConfig说明" class="headerlink" title="WebSecurityConfig说明"></a>WebSecurityConfig说明</h3><p>与oauth2-client相关的代码就如下两行</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="comment">//开启oauth2登录认证</span></span><br><span class="line">http.oauth2Login();</span><br><span class="line"></span><br><span class="line"><span class="comment">//开启基于oauth2的客户端信息</span></span><br><span class="line">http.oauth2Client();</span><br></pre></td></tr></table></figure>

<h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">oauth2:</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">http://localhost:8080</span></span><br><span class="line">    <span class="attr">logout:</span> <span class="string">$&#123;oauth2.server.url&#125;/logout</span> <span class="comment">#可以实现单点登录，不能实现单点登出</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="comment">#oauth2客户端配置，默认基于内存，如果基于数据库，需要在config配置类进行相应的配置</span></span><br><span class="line">  <span class="attr">security:</span></span><br><span class="line">    <span class="attr">oauth2:</span></span><br><span class="line">      <span class="attr">client:</span></span><br><span class="line">        <span class="attr">registration:</span> <span class="comment">#支持多租户</span></span><br><span class="line">          <span class="comment"># /postman/oauth2/authorization/my-client</span></span><br><span class="line">          <span class="attr">my-client:</span> <span class="comment"># 1 注册客户端名称，随意指定，但是要与provider的配置相一致</span></span><br><span class="line">            <span class="attr">client-id:</span> <span class="string">postman</span> <span class="comment"># 2 客户端ID</span></span><br><span class="line">            <span class="attr">client-secret:</span> <span class="string">postman</span> <span class="comment"># 3 客户端密码</span></span><br><span class="line">            <span class="attr">authorization-grant-type:</span> <span class="string">authorization_code</span> <span class="comment"># 4 认证类型</span></span><br><span class="line">            <span class="comment">#默认重定向URI模板是&#123;baseUrl&#125;/login/oauth2/code/&#123;registrationId&#125;。</span></span><br><span class="line">            <span class="comment">#registrationId是ClientRegistration的唯一标识符。</span></span><br><span class="line">            <span class="attr">redirect-uri:</span> <span class="string">http://localhost:8088/postman/login/oauth2/code/my-client</span>  <span class="comment"># 5 回调地址，需要配置到数据表中，默认写法，注意最后的路径是注册客户端名称</span></span><br><span class="line">            <span class="attr">scope:</span> <span class="string">any</span> <span class="comment">#请求范围</span></span><br><span class="line">            <span class="attr">client-name:</span> <span class="string">客户端1</span></span><br><span class="line">          <span class="comment"># /postman/oauth2/authorization/my-client2</span></span><br><span class="line">          <span class="attr">my-client2:</span> <span class="comment"># 1 注册客户端名称，随意指定，但是要与provider的配置相一致</span></span><br><span class="line">            <span class="attr">client-id:</span> <span class="string">postman</span> <span class="comment"># 2 客户端ID</span></span><br><span class="line">            <span class="attr">client-secret:</span> <span class="string">postman</span> <span class="comment"># 3 客户端密码</span></span><br><span class="line">            <span class="attr">authorization-grant-type:</span> <span class="string">authorization_code</span> <span class="comment"># 4 认证类型</span></span><br><span class="line">            <span class="attr">redirect-uri:</span> <span class="string">http://localhost:8088/postman/login/oauth2/code/my-client2</span>  <span class="comment"># 5 回调地址，需要配置到数据表中，默认写法，注意最后的路径是注册客户端名称</span></span><br><span class="line">            <span class="attr">scope:</span> <span class="string">any</span> <span class="comment">#请求范围</span></span><br><span class="line">            <span class="attr">client-name:</span> <span class="string">客户端2</span></span><br><span class="line"></span><br><span class="line">          <span class="comment"># CommonOAuth2Provider 中定义了google,facebook,github,okta的默认provider信息，所以这里不需要为其配置provider信息</span></span><br><span class="line">          <span class="comment"># /postman/oauth2/authorization/google</span></span><br><span class="line">          <span class="comment"># 重定向后：https://accounts.google.com/o/oauth2/v2/auth?response_type=code&amp;client_id=xxxxxxxxx&amp;scope=openid%20profile%20email&amp;state=jO3PpuX2IzwOFemdd7FHBIHeeSPcxDwiP-mqDBTjdfw%3D&amp;redirect_uri=http://localhost:8088/postman/login/oauth2/code/google&amp;nonce=-sxhj2hjgrc7krSHSjL3qz_W90xPEX9nlP6SYzAfktY</span></span><br><span class="line">          <span class="attr">google:</span> <span class="comment"># google帐号认证，跳转到google登录页面</span></span><br><span class="line">            <span class="attr">client-id:</span> <span class="string">xxxxxxxxx</span> <span class="comment">#  客户端ID</span></span><br><span class="line">            <span class="attr">client-secret:</span> <span class="string">xxxxxxx</span> <span class="comment">#  客户端密码</span></span><br><span class="line">            <span class="attr">client-name:</span> <span class="string">Google认证</span></span><br><span class="line"></span><br><span class="line">          <span class="comment"># /postman/oauth2/authorization/facebook</span></span><br><span class="line">          <span class="comment"># https://www.facebook.com/v2.8/dialog/oauth?response_type=code&amp;client_id=xxxxxxxxx&amp;scope=public_profile%20email&amp;state=BVZM3OW2EUS82pbjJdpQfXvtXbFbMwaUe_lRMOt4BW4%3D&amp;redirect_uri=http://localhost:8088/postman/login/oauth2/code/facebook</span></span><br><span class="line">          <span class="attr">facebook:</span> <span class="comment"># facebook帐号登录，跳转到facebook登录页面</span></span><br><span class="line">            <span class="attr">client-id:</span> <span class="string">xxxxxxxxx</span> <span class="comment">#  客户端ID</span></span><br><span class="line">            <span class="attr">client-secret:</span> <span class="string">xxxxxxx</span> <span class="comment">#  客户端密码</span></span><br><span class="line">            <span class="attr">client-name:</span> <span class="string">Facebook认证</span></span><br><span class="line"></span><br><span class="line">          <span class="comment"># /postman/oauth2/authorization/github</span></span><br><span class="line">          <span class="comment"># 重定向后：https://github.com/login?client_id=xxxxxxxxx&amp;return_to=%2Flogin%2Foauth%2Fauthorize%3Fclient_id%3Dxxxxxxxxx%26redirect_uri%3Dhttp%253A%252F%252Flocalhost%253A8088%252Fpostman%252Flogin%252Foauth2%252Fcode%252Fgithub%26response_type%3Dcode%26scope%3Dread%253Auser%26state%3DmXtRWMQy8NaqVsFiie-NyYuy2z8OErrdq_VsuejDOPE%253D</span></span><br><span class="line">          <span class="comment"># api文档：https://docs.github.com/cn/free-pro-team@latest/rest</span></span><br><span class="line">          <span class="attr">github:</span> <span class="comment"># github帐号登录，跳转到github登录页面</span></span><br><span class="line">            <span class="attr">client-id:</span> <span class="string">xxxxxxxxx</span> <span class="comment">#  客户端ID</span></span><br><span class="line">            <span class="attr">client-secret:</span> <span class="string">xxxxxxx</span> <span class="comment">#  客户端密码</span></span><br><span class="line">            <span class="attr">client-name:</span> <span class="string">Github认证</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">provider:</span></span><br><span class="line">          <span class="attr">my-client:</span> <span class="comment"># 6 注册客户端名称</span></span><br><span class="line">            <span class="attr">authorization-uri:</span> <span class="string">$&#123;oauth2.server.url&#125;/oauth/authorize</span> <span class="comment"># 7 认证地址</span></span><br><span class="line">            <span class="attr">token-uri:</span> <span class="string">$&#123;oauth2.server.url&#125;/oauth/token</span> <span class="comment"># 8 获取token地址</span></span><br><span class="line">            <span class="attr">user-info-uri:</span> <span class="string">http://localhost:8080/userInfo</span> <span class="comment"># 9 获取用户信息地址，必须配置</span></span><br><span class="line">            <span class="attr">userNameAttribute:</span> <span class="string">username</span> <span class="comment"># 10 指定用户信息中哪个属性是用户名称</span></span><br><span class="line">          <span class="attr">my-client2:</span> <span class="comment"># 6 注册客户端名称</span></span><br><span class="line">            <span class="attr">authorization-uri:</span> <span class="string">$&#123;oauth2.server.url&#125;/oauth/authorize</span> <span class="comment"># 7 认证地址</span></span><br><span class="line">            <span class="attr">token-uri:</span> <span class="string">$&#123;oauth2.server.url&#125;/oauth/token</span> <span class="comment"># 8 获取token地址</span></span><br><span class="line">            <span class="attr">user-info-uri:</span> <span class="string">http://localhost:8080/userInfo</span> <span class="comment"># 9 获取用户信息地址，必须配置</span></span><br><span class="line">            <span class="attr">userNameAttribute:</span> <span class="string">username</span> <span class="comment"># 10 指定用户信息中哪个属性是用户名称</span></span><br></pre></td></tr></table></figure>
<h3 id="配置文件说明"><a href="#配置文件说明" class="headerlink" title="配置文件说明"></a>配置文件说明</h3><ul>
<li>springboot默认实现了google,facebook,github,okta的provider，但是其它认证服务器就需要自己指定provider信息。</li>
<li>这里需要为其指定user-info-uri，这个url提供认证用户的信息，需要认证服务端提供(也可以配置到受认证服务保护的资源服务中)，所以我们需要对认证服务进行改造</li>
<li>userNameAttribute表示从user-info-uri接口返回的信息中哪个属性名称表示用户名称</li>
<li>如果客户端信息只有一个，则访问当前客户端服务就会直接跳转到认证服务器的登录页面</li>
<li>如果客户端配置了多个，则会先跳转到login页面，需要选择要访问的认证服务器，后文有介绍如何自定义login页面</li>
</ul>
<h2 id="AuthServer改造"><a href="#AuthServer改造" class="headerlink" title="AuthServer改造"></a>AuthServer改造</h2><h3 id="UserController"><a href="#UserController" class="headerlink" title="UserController"></a>UserController</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.oauth2authserverdemo.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.Authentication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.jwt.Jwt;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/userInfo&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">userInfo</span><span class="params">(Authentication authentication)</span></span>&#123;</span><br><span class="line">        Map&lt;String,Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        Object principal = authentication.getPrincipal();</span><br><span class="line">        <span class="keyword">if</span>(principal <span class="keyword">instanceof</span> Jwt)&#123;</span><br><span class="line">            map.put(<span class="string">&quot;username&quot;</span>, ((Jwt) principal).getClaim(<span class="string">&quot;user_name&quot;</span>));</span><br><span class="line"></span><br><span class="line">            <span class="comment">//客户端获取用户信息时，将附加信息一块返回给客户端</span></span><br><span class="line">            map.putAll(((Jwt) principal).getClaims());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="UserController说明"><a href="#UserController说明" class="headerlink" title="UserController说明"></a>UserController说明</h4><ul>
<li>这个接口就是普通的controller接口，其返回一个map信息，里面至少包含一个用户名称信息。</li>
<li>因为client-server与auth-server之间是通过基于JWT的access-token进行访问的，所以这个接口实际上也是一个资源接口，需要为认证服务器配置资源服务。</li>
</ul>
<h3 id="SecurityConfig"><a href="#SecurityConfig" class="headerlink" title="SecurityConfig"></a>SecurityConfig</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//认证服务器同时作为资源服务器，其目的是可以对外提供访问的资源，比如&quot;客户端认证获取用户信息&quot;</span></span><br><span class="line"><span class="comment">//鉴权时只支持Bearer Token的形式，不支持url后加参数access_token</span></span><br><span class="line">http.oauth2ResourceServer().jwt() <span class="comment">//开启oauth2资源认证</span></span><br><span class="line">        <span class="comment">//默认情况下，权限是scope，而我们希望使用的是用户的角色，所以这里需要通过转换器进行处理</span></span><br><span class="line">        .jwtAuthenticationConverter(jwt -&gt; &#123; <span class="comment">//通过自定义Converter来指定权限，Converter是函数接口，当前上下问参数为JWT对象</span></span><br><span class="line">            Collection&lt;SimpleGrantedAuthority&gt; authorities =</span><br><span class="line">                    ((Collection&lt;String&gt;) jwt.getClaims()</span><br><span class="line">                            .get(<span class="string">&quot;authorities&quot;</span>)).stream() <span class="comment">//获取JWT中的authorities</span></span><br><span class="line">                            .map(SimpleGrantedAuthority::<span class="keyword">new</span>)</span><br><span class="line">                            .collect(Collectors.toSet());</span><br><span class="line"></span><br><span class="line">            <span class="comment">//如果希望保留scope的权限，可以取出scope数据然后合并到一起，这样因为不是以ROLE_开头，所以需要使用hasAuthority(&#x27;SCOPE_any&#x27;)的形式</span></span><br><span class="line">            Collection&lt;SimpleGrantedAuthority&gt; scopes = ((Collection&lt;String&gt;) jwt.getClaims()</span><br><span class="line">                    .get(<span class="string">&quot;scope&quot;</span>)).stream().map(scope -&gt; <span class="keyword">new</span> SimpleGrantedAuthority(<span class="string">&quot;SCOPE_&quot;</span> + scope))</span><br><span class="line">                    .collect(Collectors.toSet());</span><br><span class="line">            <span class="comment">//合并权限</span></span><br><span class="line">            authorities.addAll(scopes);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> JwtAuthenticationToken(jwt, authorities);</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>

<h4 id="SecurityConfig说明"><a href="#SecurityConfig说明" class="headerlink" title="SecurityConfig说明"></a>SecurityConfig说明</h4><ul>
<li>如果该接口是登录后就可以访问，只需要按如下配置即可：<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">http.oauth2ResourceServer().jwt();</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="配置文件-1"><a href="#配置文件-1" class="headerlink" title="配置文件"></a>配置文件</h3><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="comment">#oauth2 配置</span></span><br><span class="line">  <span class="attr">security:</span></span><br><span class="line">    <span class="attr">oauth2:</span></span><br><span class="line">      <span class="attr">resourceserver:</span></span><br><span class="line">        <span class="attr">jwt:</span></span><br><span class="line">          <span class="attr">public-key-location:</span> <span class="string">classpath:oauth2_key.pub</span></span><br></pre></td></tr></table></figure>
<ul>
<li>将公钥文件放到对应的路径下即可</li>
</ul>
<h2 id="自定义login页面"><a href="#自定义login页面" class="headerlink" title="自定义login页面"></a>自定义login页面</h2><ul>
<li>当客户端配置信息中指定了多个client时，访问当前服务时会先跳转到login页面，需要选择要访问哪个认证服务器。</li>
</ul>
<h3 id="依赖-1"><a href="#依赖-1" class="headerlink" title="依赖"></a>依赖</h3><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="string">implementation</span> <span class="string">&#x27;org.springframework.boot:spring-boot-starter-thymeleaf&#x27;</span></span><br><span class="line"><span class="string">//webjars</span> <span class="string">https://www.webjars.org</span></span><br><span class="line"><span class="string">implementation</span> <span class="string">&#x27;org.webjars:bootstrap:4.5.3&#x27;</span></span><br><span class="line"><span class="string">implementation</span> <span class="string">&#x27;org.webjars.bower:jquery:3.5.1&#x27;</span></span><br><span class="line"><span class="string">//</span> <span class="string">可以在html中去掉webjars的版本号，这样升级的时候直接修改上面引入的webjars中的版本号即可，页面中不需要修改</span></span><br><span class="line"><span class="string">implementation</span> <span class="string">&#x27;org.webjars:webjars-locator:0.40&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="LoginController"><a href="#LoginController" class="headerlink" title="LoginController"></a>LoginController</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.oauth2clientdemo2.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.log4j.Log4j2;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.client.registration.ClientRegistrationRepository;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.client.registration.InMemoryClientRegistrationRepository;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ui.Model;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;h1&gt;LoginController&lt;/h1&gt;</span></span><br><span class="line"><span class="comment"> * Created by hanqf on 2020/11/14 00:19.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@Log4j2</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ClientRegistrationRepository clientRegistrationRepository;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LoginController</span><span class="params">(ClientRegistrationRepository clientRegistrationRepository)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.clientRegistrationRepository = clientRegistrationRepository;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义登录页面，多租户登录时先显示该页面，由用户选择要使用的认证服务</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> model</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/oauth/login&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">login</span><span class="params">(Model model)</span></span>&#123;</span><br><span class="line">        Map&lt;String,String&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span>(clientRegistrationRepository <span class="keyword">instanceof</span> InMemoryClientRegistrationRepository)&#123;</span><br><span class="line">            ((InMemoryClientRegistrationRepository)clientRegistrationRepository).forEach(registrations-&gt;&#123;</span><br><span class="line">                String registrationId = registrations.getRegistrationId();</span><br><span class="line">                String clientName = registrations.getClientName();</span><br><span class="line">                map.put(registrationId,clientName);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        model.addAttribute(<span class="string">&quot;registrations&quot;</span>, map);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;oauth2/login&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="login-html"><a href="#login-html" class="headerlink" title="login.html"></a>login.html</h3><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1, shrink-to-fit=no&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;/webjars/bootstrap/css/bootstrap.min.css&#125;&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">th:src</span>=<span class="string">&quot;@&#123;/webjars/jquery/jquery.min.js&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">th:src</span>=<span class="string">&quot;@&#123;/webjars/bootstrap/js/bootstrap.min.js&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h2</span> <span class="attr">class</span>=<span class="string">&quot;form-signin-heading&quot;</span>&gt;</span>Login with OAuth 2.0<span class="tag">&lt;/<span class="name">h2</span>&gt;</span><span class="tag">&lt;<span class="name">table</span> <span class="attr">class</span>=<span class="string">&quot;table table-striped&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">tr</span> <span class="attr">th:each</span>=<span class="string">&quot;registration: $&#123;registrations&#125;&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;&#x27;/oauth2/authorization/&#x27;+$&#123;registration.key&#125;&#125;&quot;</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;registration.value&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="WebSecurityConfig-1"><a href="#WebSecurityConfig-1" class="headerlink" title="WebSecurityConfig"></a>WebSecurityConfig</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//开启oauth2登录认证</span></span><br><span class="line">http.oauth2Login()</span><br><span class="line">        <span class="comment">//自定义登录页面</span></span><br><span class="line">        .loginPage(<span class="string">&quot;/oauth/login&quot;</span>);</span><br></pre></td></tr></table></figure>

<h2 id="OAuth2AuthorizedClientService"><a href="#OAuth2AuthorizedClientService" class="headerlink" title="OAuth2AuthorizedClientService"></a>OAuth2AuthorizedClientService</h2><ul>
<li>默认每次客户端获取到的token信息都是存储在内存中的，如果服务器重启则token就会失效，可以将token保存到数据库中</li>
</ul>
<h3 id="创建数据表"><a href="#创建数据表" class="headerlink" title="创建数据表"></a>创建数据表</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"># 客户端认证信息表，只需建表，数据会自动创建</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `oauth2_authorized_client` (</span><br><span class="line">    `client_registration_id` <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">COLLATE</span> utf8mb4_bin <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;客户端注册Id&#x27;</span>,</span><br><span class="line">    `principal_name` <span class="type">varchar</span>(<span class="number">200</span>) <span class="keyword">COLLATE</span> utf8mb4_bin <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;登录用户名称&#x27;</span>,</span><br><span class="line">    `access_token_type` <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">COLLATE</span> utf8mb4_bin <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;验证类型，这里是bear&#x27;</span>,</span><br><span class="line">    `access_token_value` <span class="type">blob</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;access_token的值&#x27;</span>,</span><br><span class="line">    `access_token_issued_at` <span class="type">timestamp</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">current_timestamp</span>() <span class="keyword">ON</span> UPDATE <span class="built_in">current_timestamp</span>() COMMENT <span class="string">&#x27;access_token的创建时间&#x27;</span>,</span><br><span class="line">    `access_token_expires_at` <span class="type">timestamp</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0000-00-00 00:00:00&#x27;</span> COMMENT <span class="string">&#x27;access_token的过期时间&#x27;</span>,</span><br><span class="line">    `access_token_scopes` <span class="type">varchar</span>(<span class="number">1000</span>) <span class="keyword">COLLATE</span> utf8mb4_bin <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;授权范围&#x27;</span>,</span><br><span class="line">    `refresh_token_value` <span class="type">blob</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;refresh_token的值&#x27;</span>,</span><br><span class="line">    `refresh_token_issued_at` <span class="type">timestamp</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0000-00-00 00:00:00&#x27;</span> COMMENT <span class="string">&#x27;refresh_token创建时间&#x27;</span>,</span><br><span class="line">    `created_at` <span class="type">timestamp</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">current_timestamp</span>() COMMENT <span class="string">&#x27;数据创建时间&#x27;</span>,</span><br><span class="line">    `update_at` <span class="type">timestamp</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">current_timestamp</span>() <span class="keyword">ON</span> UPDATE <span class="built_in">current_timestamp</span>() COMMENT <span class="string">&#x27;数据最后更新时间&#x27;</span>,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`client_registration_id`,`principal_name`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8mb4_bin;</span><br></pre></td></tr></table></figure>
<h3 id="添加数据库依赖"><a href="#添加数据库依赖" class="headerlink" title="添加数据库依赖"></a>添加数据库依赖</h3><figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line"><span class="comment">//mysql</span></span><br><span class="line">runtimeOnly <span class="string">&#x27;mysql:mysql-connector-java&#x27;</span></span><br><span class="line"><span class="comment">//为了使用datasource</span></span><br><span class="line">implementation <span class="string">&#x27;org.springframework.boot:spring-boot-starter-jdbc&#x27;</span></span><br></pre></td></tr></table></figure>
<h3 id="配置文件添加数据库的配置"><a href="#配置文件添加数据库的配置" class="headerlink" title="配置文件添加数据库的配置"></a>配置文件添加数据库的配置</h3><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="comment">#数据源配置</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/springboot?useUnicode=true&amp;characterEncoding=utf-8&amp;useTimezone=true&amp;serverTimezone=GMT%2B8</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">newpwd</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">hikari:</span></span><br><span class="line">      <span class="attr">connection-timeout:</span> <span class="number">30000</span> <span class="comment">#毫秒，默认30秒</span></span><br><span class="line">      <span class="attr">idle-timeout:</span> <span class="number">600000</span>      <span class="comment">#毫秒，默认10分钟</span></span><br><span class="line">      <span class="attr">max-lifetime:</span> <span class="number">1800000</span>     <span class="comment">#毫秒，默认30分钟</span></span><br><span class="line">      <span class="attr">maximum-pool-size:</span> <span class="number">10</span>     <span class="comment">#默认10</span></span><br></pre></td></tr></table></figure>

<h3 id="WebSecurityConfig增加JdbcOAuth2AuthorizedClientService的配置"><a href="#WebSecurityConfig增加JdbcOAuth2AuthorizedClientService的配置" class="headerlink" title="WebSecurityConfig增加JdbcOAuth2AuthorizedClientService的配置"></a>WebSecurityConfig增加JdbcOAuth2AuthorizedClientService的配置</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 基于数据库的客户端信息配置，认证数据会自动创建到数据表中</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> OAuth2AuthorizedClientService <span class="title">authorizedClientService</span><span class="params">(JdbcOperations jdbcOperations, ClientRegistrationRepository clientRegistrationRepository)</span> </span>&#123;</span><br><span class="line">    JdbcOAuth2AuthorizedClientService authorizedClientService =</span><br><span class="line">            <span class="keyword">new</span> JdbcOAuth2AuthorizedClientService(jdbcOperations, clientRegistrationRepository);</span><br><span class="line">    <span class="keyword">return</span> authorizedClientService;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> OAuth2AuthorizedClientService oAuth2AuthorizedClientService;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//开启基于oauth2的客户端信息</span></span><br><span class="line">http.oauth2Client()</span><br><span class="line">        <span class="comment">//客户端信息基于数据库，基于内存去掉下面配置即可</span></span><br><span class="line">        .authorizedClientService(oAuth2AuthorizedClientService);</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="访问资源服务"><a href="#访问资源服务" class="headerlink" title="访问资源服务"></a>访问资源服务</h2><ul>
<li>WebSecurityConfig配置类增加如下配置</li>
<li>其目的就是在使用RestTemplate访问资源服务时，在请求头中增加Bearer Token<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 调用Resource Server服务使用RestTemplate，当调用的Resource Server时候我们时需要使用Bearer Token在头部传递Access Token；</span></span><br><span class="line"><span class="comment"> * RestTemplateAutoConfiguration已经给我们自动配置了RestTemplateBuilder来配置RestTemplate，我们需要通过RestTemplateCustomizer来对RestTemplate来定制</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function">RestTemplateCustomizer <span class="title">restTemplateCustomizer</span><span class="params">(OAuth2AuthorizedClientService clientService)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> restTemplate -&gt; &#123; <span class="comment">//1 RestTemplateCustomizer时函数接口，入参是RestTemplate</span></span><br><span class="line">        List&lt;ClientHttpRequestInterceptor&gt; interceptors = restTemplate.getInterceptors();</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(interceptors)) &#123;</span><br><span class="line">            interceptors = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">        interceptors.add((request, body, execution) -&gt; &#123; <span class="comment">//2 通过增加RestTemplate拦截器，让每次请求添加Bearer Token（Access Token）；ClientHttpRequestInterceptor是函数接口，可用Lambda表达式来实现</span></span><br><span class="line">            OAuth2AuthenticationToken auth = (OAuth2AuthenticationToken)</span><br><span class="line">                    SecurityContextHolder.getContext().getAuthentication();</span><br><span class="line">            String clientRegistrationId = auth.getAuthorizedClientRegistrationId();</span><br><span class="line">            String principalName = auth.getName();</span><br><span class="line">            OAuth2AuthorizedClient client =</span><br><span class="line">                    clientService.loadAuthorizedClient(clientRegistrationId, principalName); <span class="comment">//3 OAuth2AuthorizedClientService可获得用户的OAuth2AuthorizedClient</span></span><br><span class="line">            <span class="keyword">if</span> (client == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//如果客户端信息使用的是基于内存的InMemoryOAuth2AuthorizedClientService，则重启服务器就会失效，需要重新登录才能恢复，</span></span><br><span class="line">                <span class="comment">// 建议使用基于数据库的JdbcOAuth2AuthorizedClientService，本例使用的就是JdbcOAuth2AuthorizedClientService</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> CustomException(HttpStatus.NOT_ACCEPTABLE, <span class="string">&quot;用户状态异常，请重新登录&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            String accessToken = client.getAccessToken().getTokenValue(); <span class="comment">//4 OAuth2AuthorizedClient可获得用户Access Token</span></span><br><span class="line">            request.getHeaders().add(<span class="string">&quot;Authorization&quot;</span>, <span class="string">&quot;Bearer &quot;</span> + accessToken); <span class="comment">//5 将Access Token通过头部的Bearer Token中访问Resource Server</span></span><br><span class="line"></span><br><span class="line">            log.info(String.format(<span class="string">&quot;请求地址: %s&quot;</span>, request.getURI()));</span><br><span class="line">            log.info(String.format(<span class="string">&quot;请求头信息: %s&quot;</span>, request.getHeaders()));</span><br><span class="line"></span><br><span class="line">            ClientHttpResponse response = execution.execute(request, body);</span><br><span class="line">            log.info(String.format(<span class="string">&quot;响应头信息: %s&quot;</span>, response.getHeaders()));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> response;</span><br><span class="line">        &#125;);</span><br><span class="line">        restTemplate.setInterceptors(interceptors);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="以ResController举例如何访问资源服务"><a href="#以ResController举例如何访问资源服务" class="headerlink" title="以ResController举例如何访问资源服务"></a>以ResController举例如何访问资源服务</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.oauth2clientdemo2.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.oauth2clientdemo2.exception.AjaxResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.web.client.RestTemplateBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;h1&gt;获取资源服务器数据&lt;/h1&gt;</span></span><br><span class="line"><span class="comment"> * Created by hanqf on 2020/11/7 22:47.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/res&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ResController</span><span class="params">(RestTemplateBuilder restTemplateBuilder)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.restTemplate = restTemplateBuilder.build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取资源服务器的数据</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/res1&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AjaxResponse <span class="title">getRes</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> restTemplate.getForObject(<span class="string">&quot;http://localhost:8082/res/res1&quot;</span>, AjaxResponse.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/user&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AjaxResponse <span class="title">getUser</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> restTemplate.postForObject(<span class="string">&quot;http://localhost:8082/user&quot;</span>,<span class="keyword">null</span>, AjaxResponse.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/rbac&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AjaxResponse <span class="title">getRbac</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> restTemplate.getForObject(<span class="string">&quot;http://localhost:8082/rbac&quot;</span>, AjaxResponse.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/userInfo&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">getuserInfo</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> restTemplate.getForObject(<span class="string">&quot;http://localhost:8082/userInfo&quot;</span>, Map.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>技术</category>
        <category>springboot2</category>
        <category>Java</category>
      </categories>
      <tags>
        <tag>springboot</tag>
        <tag>oauth2</tag>
        <tag>springsecurity</tag>
        <tag>jwt</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot-OAuth2-JWT-ResourceServer</title>
    <url>/2020/11/15/springBoot-oauth2-jwt-resourcceserver/</url>
    <content><![CDATA[<h2 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h2><ul>
<li>通过本文，你将知道如何搭建一个基于SpringBoot-OAuth2-JWT的资源服务器</li>
<li>本文基于springboot:2.4.0，项目基于Gradle-6.6.1构建</li>
<li>代码地址:<a href="https://github.com/hanqunfeng/springbootchapter/tree/master/chapter48">https://github.com/hanqunfeng/springbootchapter/tree/master/chapter48</a></li>
</ul>
<span id="more"></span>
<h2 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h2><ul>
<li>springboot官方提供了支持<figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line">implementation <span class="string">&#x27;org.springframework.boot:spring-boot-starter-web&#x27;</span></span><br><span class="line">implementation <span class="string">&#x27;org.springframework.boot:spring-boot-starter-oauth2-resource-server&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//本项目中使用了lombok减代码量，非必须依赖</span></span><br><span class="line">compileOnly <span class="string">&#x27;org.projectlombok:lombok&#x27;</span></span><br><span class="line">annotationProcessor <span class="string">&#x27;org.projectlombok:lombok&#x27;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="WebSecurityConfig"><a href="#WebSecurityConfig" class="headerlink" title="WebSecurityConfig"></a>WebSecurityConfig</h2><ul>
<li>springboot没有为resource-server设置独立的注解和配置类，而是把这部分功能整合到了spring-security中<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.oauth2resourceserverdemo2.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.oauth2resourceserverdemo2.security.CustomAccessDeniedHandler;</span><br><span class="line"><span class="keyword">import</span> com.example.oauth2resourceserverdemo2.security.CustomAuthExceptionEntryPoint;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.http.SessionCreationPolicy;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.authority.SimpleGrantedAuthority;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.server.resource.authentication.JwtAuthenticationToken;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.cors.CorsConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.cors.CorsConfigurationSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.cors.UrlBasedCorsConfigurationSource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;h1&gt;WebSecurityConfig&lt;/h1&gt;</span></span><br><span class="line"><span class="comment"> * Created by hanqf on 2020/11/11 17:01.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableGlobalMethodSecurity(prePostEnabled = true)</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CustomAccessDeniedHandler customAccessDeniedHandler;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CustomAuthExceptionEntryPoint customAuthExceptionEntryPoint;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//开启跨域</span></span><br><span class="line">        http.cors();</span><br><span class="line">        http.sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//权限控制</span></span><br><span class="line">        http.authorizeRequests()<span class="comment">//登录成功就可以访问</span></span><br><span class="line">                .antMatchers(<span class="string">&quot;/res/**&quot;</span>, <span class="string">&quot;/userInfo/**&quot;</span>).authenticated()</span><br><span class="line">                <span class="comment">//需要具备相应的角色才能访问</span></span><br><span class="line">                .antMatchers(<span class="string">&quot;/user/**&quot;</span>).hasAnyRole(<span class="string">&quot;admin&quot;</span>, <span class="string">&quot;user&quot;</span>)</span><br><span class="line">                <span class="comment">//不需要登录就可以访问</span></span><br><span class="line">                .antMatchers(<span class="string">&quot;/swagger-ui/**&quot;</span>, <span class="string">&quot;/v3/api-docs**&quot;</span>).permitAll()</span><br><span class="line">                <span class="comment">//其它路径需要根据指定的方法判断是否有权限访问，基于权限管理模型认证</span></span><br><span class="line">                .anyRequest().access(<span class="string">&quot;@rbacService.hasPerssion(request,authentication)&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//鉴权时只支持Bearer Token的形式，不支持url后加参数access_token</span></span><br><span class="line">        http.oauth2ResourceServer()<span class="comment">//开启oauth2资源认证</span></span><br><span class="line">                .jwt() <span class="comment">//token为jwt</span></span><br><span class="line">                <span class="comment">//默认情况下，权限是scope，而我们希望使用的是用户的角色，所以这里需要通过转换器进行处理</span></span><br><span class="line">                .jwtAuthenticationConverter(jwt -&gt; &#123; <span class="comment">//通过自定义Converter来指定权限，Converter是函数接口，当前上下问参数为JWT对象</span></span><br><span class="line">                    Collection&lt;SimpleGrantedAuthority&gt; authorities =</span><br><span class="line">                            ((Collection&lt;String&gt;) jwt.getClaims()</span><br><span class="line">                                    .get(<span class="string">&quot;authorities&quot;</span>)).stream() <span class="comment">//获取JWT中的authorities</span></span><br><span class="line">                                    .map(SimpleGrantedAuthority::<span class="keyword">new</span>)</span><br><span class="line">                                    .collect(Collectors.toSet());</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//如果希望保留scope的权限，可以取出scope数据然后合并到一起，这样因为不是以ROLE_开头，所以需要使用hasAuthority(&#x27;SCOPE_any&#x27;)的形式</span></span><br><span class="line">                    Collection&lt;SimpleGrantedAuthority&gt; scopes = ((Collection&lt;String&gt;) jwt.getClaims()</span><br><span class="line">                            .get(<span class="string">&quot;scope&quot;</span>)).stream().map(scope -&gt; <span class="keyword">new</span> SimpleGrantedAuthority(<span class="string">&quot;SCOPE_&quot;</span> + scope))</span><br><span class="line">                            .collect(Collectors.toSet());</span><br><span class="line">                    <span class="comment">//合并权限</span></span><br><span class="line">                    authorities.addAll(scopes);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> JwtAuthenticationToken(jwt, authorities);</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//这部分看代码吧，没啥可说的</span></span><br><span class="line">        http.exceptionHandling()</span><br><span class="line">                <span class="comment">//access_token无效或过期时的处理方式</span></span><br><span class="line">                .authenticationEntryPoint(customAuthExceptionEntryPoint)</span><br><span class="line">                <span class="comment">//access_token认证后没有对应的权限时的处理方式</span></span><br><span class="line">                .accessDeniedHandler(customAccessDeniedHandler);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 跨域配置类</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CorsConfigurationSource <span class="title">corsConfigurationSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        CorsConfiguration corsConfiguration = <span class="keyword">new</span> CorsConfiguration().applyPermitDefaultValues();</span><br><span class="line">        <span class="comment">//开放哪些ip、端口、域名的访问权限，星号表示开放所有域</span></span><br><span class="line">        corsConfiguration.addAllowedOrigin(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">        <span class="comment">//corsConfiguration.setAllowedOrigins(Arrays.asList(&quot;http://localhost:8080&quot;,&quot;http://localhost:8081&quot;));</span></span><br><span class="line">        <span class="comment">//开放哪些Http方法，允许跨域访问</span></span><br><span class="line">        corsConfiguration.addAllowedMethod(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">        <span class="comment">//corsConfiguration.setAllowedMethods(Arrays.asList(&quot;GET&quot;,&quot;POST&quot;, &quot;PUT&quot;, &quot;DELETE&quot;));</span></span><br><span class="line">        <span class="comment">//允许HTTP请求中的携带哪些Header信息</span></span><br><span class="line">        corsConfiguration.addAllowedHeader(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">        <span class="comment">//是否允许发送Cookie信息</span></span><br><span class="line">        corsConfiguration.setAllowCredentials(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//添加映射路径，“/**”表示对所有的路径实行全局跨域访问权限的设置</span></span><br><span class="line">        UrlBasedCorsConfigurationSource configSource = <span class="keyword">new</span> UrlBasedCorsConfigurationSource();</span><br><span class="line">        configSource.registerCorsConfiguration(<span class="string">&quot;/**&quot;</span>, corsConfiguration);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> configSource;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="WebSecurityConfig说明"><a href="#WebSecurityConfig说明" class="headerlink" title="WebSecurityConfig说明"></a>WebSecurityConfig说明</h3><p>整体配置方式就是spring-security的配置方式，这里唯一的不同就是如下这部分代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//鉴权时只支持Bearer Token的形式，不支持url后加参数access_token</span></span><br><span class="line">http.oauth2ResourceServer()<span class="comment">//开启oauth2资源认证</span></span><br><span class="line">        .jwt() <span class="comment">//token为jwt</span></span><br><span class="line">        <span class="comment">//默认情况下，权限是scope，而我们希望使用的是用户的角色，所以这里需要通过转换器进行处理</span></span><br><span class="line">        .jwtAuthenticationConverter(jwt -&gt; &#123; <span class="comment">//通过自定义Converter来指定权限，Converter是函数接口，当前上下问参数为JWT对象</span></span><br><span class="line">            Collection&lt;SimpleGrantedAuthority&gt; authorities =</span><br><span class="line">                    ((Collection&lt;String&gt;) jwt.getClaims()</span><br><span class="line">                            .get(<span class="string">&quot;authorities&quot;</span>)).stream() <span class="comment">//获取JWT中的authorities</span></span><br><span class="line">                            .map(SimpleGrantedAuthority::<span class="keyword">new</span>)</span><br><span class="line">                            .collect(Collectors.toSet());</span><br><span class="line"></span><br><span class="line">            <span class="comment">//如果希望保留scope的权限，可以取出scope数据然后合并到一起，这样因为不是以ROLE_开头，所以需要使用hasAuthority(&#x27;SCOPE_any&#x27;)的形式</span></span><br><span class="line">            Collection&lt;SimpleGrantedAuthority&gt; scopes = ((Collection&lt;String&gt;) jwt.getClaims()</span><br><span class="line">                    .get(<span class="string">&quot;scope&quot;</span>)).stream().map(scope -&gt; <span class="keyword">new</span> SimpleGrantedAuthority(<span class="string">&quot;SCOPE_&quot;</span> + scope))</span><br><span class="line">                    .collect(Collectors.toSet());</span><br><span class="line">            <span class="comment">//合并权限</span></span><br><span class="line">            authorities.addAll(scopes);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> JwtAuthenticationToken(jwt, authorities);</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>
<ul>
<li>一般情况下，我们只需要这样配置<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">http.oauth2ResourceServer().jwt();</span><br></pre></td></tr></table></figure>
此时就已经开启的oauth2资源服务器的支持，但是此时我们鉴权后获取到的权限是scope，这可能并不是我们希望的，所以我们可以为其指定一个转换器，从access_token的payload中获取<code>authorities</code>属性，并将其设置为用户的权限，如果我们还希望同时得到scope，则也可以再次取出<code>scope</code>的值放入用户的权限列表中。</li>
</ul>
<h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="comment">#oauth2 配置</span></span><br><span class="line">  <span class="attr">security:</span></span><br><span class="line">    <span class="attr">oauth2:</span></span><br><span class="line">      <span class="attr">resourceserver:</span></span><br><span class="line">        <span class="attr">jwt:</span></span><br><span class="line">          <span class="comment"># 公钥文件路径</span></span><br><span class="line">          <span class="comment"># public-key-location: classpath:oauth2_key.pub</span></span><br><span class="line"></span><br><span class="line">          <span class="comment"># 认证服务器提供的密钥验证路径，这种方式每次验证access_token都需要访问认证服务器</span></span><br><span class="line">          <span class="attr">jwk-set-uri:</span> <span class="string">http://localhost:8080/.well-known/jwks.json</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h3><ul>
<li>本项目基于jks等非对称密钥的方式</li>
<li>密钥配置方式支持本地配置和认证服务器远程获取</li>
<li>如果是基于本地配置的方式，则认证服务器什么都不需要做，但是如果是基于认证服务器远程获取的方式，则需要为认证服务器添加对应的功能。</li>
</ul>
<h2 id="AuthServer改造"><a href="#AuthServer改造" class="headerlink" title="AuthServer改造"></a>AuthServer改造</h2><h3 id="JwkSetEndpoint"><a href="#JwkSetEndpoint" class="headerlink" title="JwkSetEndpoint"></a>JwkSetEndpoint</h3><ul>
<li>增加jwk-set验证端点，该功能就是为了获取公钥<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.oauth2authserverdemo.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.oauth2authserverdemo.security.jwt.JwtTokenProperties;</span><br><span class="line"><span class="keyword">import</span> com.nimbusds.jose.jwk.JWKSet;</span><br><span class="line"><span class="keyword">import</span> com.nimbusds.jose.jwk.RSAKey;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.endpoint.FrameworkEndpoint;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.store.KeyStoreKeyFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.security.KeyPair;</span><br><span class="line"><span class="keyword">import</span> java.security.interfaces.RSAPublicKey;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@FrameworkEndpoint</span> <span class="comment">//@FrameworkEndpoint和@Controller相同功能，只用于框架提供的端点</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JwkSetEndpoint</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JwtTokenProperties jwtTokenProperties;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/.well-known/jwks.json&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">getKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        KeyStoreKeyFactory keyStoreKeyFactory =</span><br><span class="line">                <span class="keyword">new</span> KeyStoreKeyFactory(jwtTokenProperties.getJksKeyFileResource(), jwtTokenProperties.getJksStorePassword().toCharArray());</span><br><span class="line">        KeyPair keyPair = keyStoreKeyFactory.getKeyPair(jwtTokenProperties.getJksKeyAlias(), jwtTokenProperties.getJksKeyPassword().toCharArray());</span><br><span class="line">        RSAPublicKey publicKey = (RSAPublicKey) keyPair.getPublic();</span><br><span class="line">        RSAKey key = <span class="keyword">new</span> RSAKey.Builder(publicKey).build();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JWKSet(key).toJSONObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="SecurityConfig开发对应的权限"><a href="#SecurityConfig开发对应的权限" class="headerlink" title="SecurityConfig开发对应的权限"></a>SecurityConfig开发对应的权限</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">http.authorizeRequests()</span><br><span class="line">       .antMatchers(customSecurityProperties.getPermitAll()).permitAll() <span class="comment">//不用身份认证可以访问</span></span><br><span class="line">       .mvcMatchers(<span class="string">&quot;/.well-known/jwks.json&quot;</span>).permitAll() <span class="comment">//开放JWK SET端点，提供给资源服务器访问获取公钥信息</span></span><br><span class="line">       .anyRequest().authenticated(); <span class="comment">//其它的请求要求必须有身份认证</span></span><br></pre></td></tr></table></figure>

<h3 id="资源，这里以UserController举例"><a href="#资源，这里以UserController举例" class="headerlink" title="资源，这里以UserController举例"></a>资源，这里以UserController举例</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.oauth2resourceserverdemo2.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.oauth2resourceserverdemo2.exception.AjaxResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.access.prepost.PreAuthorize;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.Authentication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.jwt.Jwt;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.security.Principal;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//注意权限区分大小写</span></span><br><span class="line">    <span class="meta">@PreAuthorize(&quot;hasRole(&#x27;admin&#x27;) or hasRole(&#x27;user&#x27;)&quot;)</span></span><br><span class="line">    <span class="comment">//@PreAuthorize(&quot;#oauth2.hasScope(&#x27;any&#x27;)&quot;) //不支持oauth2表达式</span></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/user&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AjaxResponse <span class="title">user</span><span class="params">(Principal principal)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//principal在经过security拦截后，是org.springframework.security.authentication.UsernamePasswordAuthenticationToken</span></span><br><span class="line">        <span class="comment">//在经OAuth2拦截后，是OAuth2Authentication</span></span><br><span class="line">        <span class="keyword">return</span> AjaxResponse.success(principal);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//注意权限区分大小写</span></span><br><span class="line">    <span class="meta">@PreAuthorize(&quot;hasAuthority(&#x27;SCOPE_any&#x27;)&quot;)</span></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/user2&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AjaxResponse <span class="title">user2</span><span class="params">(Principal principal)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//principal在经过security拦截后，是org.springframework.security.authentication.UsernamePasswordAuthenticationToken</span></span><br><span class="line">        <span class="comment">//在经OAuth2拦截后，是OAuth2Authentication</span></span><br><span class="line">        <span class="keyword">return</span> AjaxResponse.success(principal);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取用户的claim信息</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/userInfo&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">userInfo</span><span class="params">(Authentication authentication)</span></span>&#123;</span><br><span class="line">        Map&lt;String,Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        Object principal = authentication.getPrincipal();</span><br><span class="line">        <span class="keyword">if</span>(principal <span class="keyword">instanceof</span> Jwt)&#123;</span><br><span class="line">            map.put(<span class="string">&quot;username&quot;</span>, ((Jwt) principal).getClaim(<span class="string">&quot;user_name&quot;</span>));</span><br><span class="line">            map.putAll(((Jwt) principal).getClaims());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="资源服务器访问方式"><a href="#资源服务器访问方式" class="headerlink" title="资源服务器访问方式"></a>资源服务器访问方式</h2><ul>
<li>通过access_token访问受保护的资源</li>
</ul>
<h3 id="只支持Bearer-Token"><a href="#只支持Bearer-Token" class="headerlink" title="只支持Bearer Token"></a>只支持Bearer Token</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://localhost:8082/user</span><br><span class="line"></span><br><span class="line"># 在请求的header中设置参数：参数名称：Authorization，值是`[grant_type] [access_token]`，grant_type值与access_token值之间用空格分开。例如：</span><br><span class="line"></span><br><span class="line">bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX25hbWUiOiJhZG1pbiIsImp3dC1leHQiOiJKV1Qg5omp5bGV5L-h5oGvIiwic2NvcGUiOlsiYW55Il0sImV4cCI6MTYwNDY1ODc4NiwiYXV0aG9yaXRpZXMiOlsiUk9MRV9hZG1pbiJdLCJqdGkiOiJjYjEzZjhmZC03NWRiLTRmODItOTkxOC00YzFjZGI3MDEwMGMiLCJjbGllbnRfaWQiOiJwb3N0bWFuIn0.W78nue0rPxB-Te7ZsxfzmTUYTasHHfQT0lMgAMG_i5g</span><br></pre></td></tr></table></figure>
<p>使用Postman接口测试工具时，也可以使用其提供的认证功能[Authorization–&gt;TYPE–&gt; Bearer Token]，然后将access_token填入</p>
]]></content>
      <categories>
        <category>技术</category>
        <category>springboot2</category>
        <category>Java</category>
      </categories>
      <tags>
        <tag>springboot</tag>
        <tag>oauth2</tag>
        <tag>springsecurity</tag>
        <tag>jwt</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot-OAuth2-JWT-AuthServer</title>
    <url>/2020/11/15/springboot-oauth2-jwt-authserver/</url>
    <content><![CDATA[<h2 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h2><ul>
<li>通过本文，你将知道如何搭建一个基于SpringBoot-OAuth2-JWT的认证服务器</li>
<li>本文基于springboot:2.4.0，项目基于Gradle-6.6.1构建</li>
<li>代码地址:<a href="https://github.com/hanqunfeng/springbootchapter/tree/master/chapter48">https://github.com/hanqunfeng/springbootchapter/tree/master/chapter48</a></li>
</ul>
<span id="more"></span>
<h2 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h2><figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line">implementation <span class="string">&#x27;org.springframework.boot:spring-boot-starter-web&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//SpringBoot官方没有提供对认证服务的支持，需要自己搭建，</span></span><br><span class="line"><span class="comment">//我们可以使用SpringSecurity提供的spring-security-oauth2-autoconfigure进行搭建，</span></span><br><span class="line"><span class="comment">//不过SpringSecurity OAuth2项目目前已被弃用，SpringSecurity团队已决定不再为授权服务器提供支持,</span></span><br><span class="line"><span class="comment">//所以，在这个版本里你会看到很多弃用的类，如果不想看到类名称上出现烦人的横线，可以使用2.2.10这个版本，测试过程也没发现什么问题的。</span></span><br><span class="line">implementation <span class="string">&#x27;org.springframework.security.oauth.boot:spring-security-oauth2-autoconfigure:2.3.4.RELEASE&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//本项目中使用了lombok简少代码量，非必须依赖</span></span><br><span class="line">compileOnly <span class="string">&#x27;org.projectlombok:lombok&#x27;</span></span><br><span class="line">annotationProcessor <span class="string">&#x27;org.projectlombok:lombok&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="代码说明"><a href="#代码说明" class="headerlink" title="代码说明"></a>代码说明</h2><h3 id="SecurityConfig"><a href="#SecurityConfig" class="headerlink" title="SecurityConfig"></a>SecurityConfig</h3><ul>
<li><p>用于配置可以登录系统的用户及其权限，也就是认证服务器的用户</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.oauth2authserverdemo.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.oauth2authserverdemo.security.CustomSecurityProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.AuthenticationManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.BeanIds;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.WebSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.http.SessionCreationPolicy;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.authority.SimpleGrantedAuthority;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.User;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.password.PasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.server.resource.authentication.JwtAuthenticationToken;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.provisioning.InMemoryUserDetailsManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.cors.CorsConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.cors.CorsConfigurationSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.cors.UrlBasedCorsConfigurationSource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Spring-Security配置类,继承WebSecurityConfigurerAdapter</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="meta">@EnableGlobalMethodSecurity(prePostEnabled = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CustomSecurityProperties customSecurityProperties;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 引入密码加密类</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PasswordEncoder <span class="title">passwordEncoder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BCryptPasswordEncoder();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 为了测试方便，这里使用内存用户模型，真实系统请使用基于RBAC的权限模型</span></span><br><span class="line"><span class="comment">     * 用户策略设置，这里使用内存用户策略，自定义策略需要实现UserDetailsService接口</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDetailsService <span class="title">userDetailsService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        InMemoryUserDetailsManager inMemoryUserDetailsManager = <span class="keyword">new</span> InMemoryUserDetailsManager();</span><br><span class="line">        User.UserBuilder builder = User.builder().passwordEncoder(passwordEncoder()::encode);</span><br><span class="line">        inMemoryUserDetailsManager.createUser(builder.username(<span class="string">&quot;admin&quot;</span>).password(<span class="string">&quot;123456&quot;</span>).roles(<span class="string">&quot;admin&quot;</span>).build());</span><br><span class="line">        inMemoryUserDetailsManager.createUser(builder.username(<span class="string">&quot;guest&quot;</span>).password(<span class="string">&quot;123456&quot;</span>).roles(<span class="string">&quot;guest&quot;</span>).build());</span><br><span class="line">        inMemoryUserDetailsManager.createUser(builder.username(<span class="string">&quot;user&quot;</span>).password(<span class="string">&quot;123456&quot;</span>).roles(<span class="string">&quot;user&quot;</span>).build());</span><br><span class="line">        <span class="keyword">return</span> inMemoryUserDetailsManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 指定不拦截的路径规则</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(WebSecurity web)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//设置不需要拦截的路径，也就是不需要认证的路径</span></span><br><span class="line">        web.ignoring().antMatchers(customSecurityProperties.getIgnoring());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 配置URL访问授权,必须配置authorizeRequests(),否则启动报错,说是没有启用security技术。</span></span><br><span class="line"><span class="comment">     * 注意:在这里的身份进行认证与授权没有涉及到OAuth的技术：当访问要授权的URL时,请求会被DelegatingFilterProxy拦截,</span></span><br><span class="line"><span class="comment">     * 如果还没有授权,请求就会被重定向到登录界面。在登录成功(身份认证并授权)后,请求被重定向至之前访问的URL。</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> http</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        http.formLogin()</span><br><span class="line">                .permitAll(); <span class="comment">//登记界面，默认是permitAll</span></span><br><span class="line"></span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                .antMatchers(customSecurityProperties.getPermitAll()).permitAll() <span class="comment">//不用身份认证可以访问</span></span><br><span class="line">                .anyRequest().authenticated(); <span class="comment">//其它的请求要求必须有身份认证</span></span><br><span class="line"></span><br><span class="line">        http.csrf().disable();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//开启跨域</span></span><br><span class="line">        http.cors();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// session管理</span></span><br><span class="line">        http.sessionManagement()</span><br><span class="line">                .sessionCreationPolicy(SessionCreationPolicy.IF_REQUIRED);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 支持 password 模式(配置)</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(name = BeanIds.AUTHENTICATION_MANAGER)</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuthenticationManager <span class="title">authenticationManagerBean</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.authenticationManagerBean();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 跨域配置类</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CorsConfigurationSource <span class="title">corsConfigurationSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        CorsConfiguration corsConfiguration = <span class="keyword">new</span> CorsConfiguration().applyPermitDefaultValues();</span><br><span class="line">        <span class="comment">//开放哪些ip、端口、域名的访问权限，星号表示开放所有域</span></span><br><span class="line">        corsConfiguration.addAllowedOrigin(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">        <span class="comment">//corsConfiguration.setAllowedOrigins(Arrays.asList(&quot;http://localhost:8080&quot;,&quot;http://localhost:8081&quot;));</span></span><br><span class="line">        <span class="comment">//开放哪些Http方法，允许跨域访问</span></span><br><span class="line">        corsConfiguration.addAllowedMethod(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">        <span class="comment">//corsConfiguration.setAllowedMethods(Arrays.asList(&quot;GET&quot;,&quot;POST&quot;, &quot;PUT&quot;, &quot;DELETE&quot;));</span></span><br><span class="line">        <span class="comment">//允许HTTP请求中的携带哪些Header信息</span></span><br><span class="line">        corsConfiguration.addAllowedHeader(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">        <span class="comment">//是否允许发送Cookie信息</span></span><br><span class="line">        corsConfiguration.setAllowCredentials(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//添加映射路径，“/**”表示对所有的路径实行全局跨域访问权限的设置</span></span><br><span class="line">        UrlBasedCorsConfigurationSource configSource = <span class="keyword">new</span> UrlBasedCorsConfigurationSource();</span><br><span class="line">        configSource.registerCorsConfiguration(<span class="string">&quot;/**&quot;</span>, corsConfiguration);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> configSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="CustomSecurityProperties"><a href="#CustomSecurityProperties" class="headerlink" title="CustomSecurityProperties"></a>CustomSecurityProperties</h3></li>
<li><p>自定义属性配置类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;security&quot;)</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomSecurityProperties</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 不需要验证的路径数组</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">private</span> String[] permitAll;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 不需要拦截的路径数组</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">private</span> String[] ignoring;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>配置文件：</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment">#springsecurity 自定义属性</span></span><br><span class="line"><span class="attr">security:</span></span><br><span class="line">  <span class="comment">#不需要验证的路径</span></span><br><span class="line">  <span class="attr">permitAll:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/redirect/**</span></span><br><span class="line">  <span class="attr">ignoring:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/webjars/**</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/**/*.js/</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/**/*.css</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/static/**</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="AuthServerConfig"><a href="#AuthServerConfig" class="headerlink" title="AuthServerConfig"></a>AuthServerConfig</h3><ul>
<li>认证服务器的token关联，本例基于jwt</li>
<li>注意这里定义的是抽象类，还没有声明客户端的配置，具体参加下文说明<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.oauth2authserverdemo.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpMethod;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.AuthenticationManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.password.PasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.AuthorizationServerConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configurers.AuthorizationServerEndpointsConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configurers.AuthorizationServerSecurityConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.TokenEnhancer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.TokenEnhancerChain;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.TokenStore;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.store.JwtAccessTokenConverter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthServerConfig</span> <span class="keyword">extends</span> <span class="title">AuthorizationServerConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">protected</span> UserDetailsService userDetailsService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">protected</span> AuthenticationManager authenticationManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">protected</span> TokenStore jwtTokenStore;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">protected</span> JwtAccessTokenConverter jwtAccessTokenConverter;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">protected</span> TokenEnhancer jwtTokenEnhancer;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">protected</span> PasswordEncoder passwordEncoder;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 1.增加jwt 增强模式</span></span><br><span class="line"><span class="comment">     * 2.调用userDetailsService实现UserDetailsService接口,对客户端信息进行认证与授权</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> endpoints</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthorizationServerEndpointsConfigurer endpoints)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//   jwt 增强模式</span></span><br><span class="line">        <span class="comment">//   对令牌的增强操作就在enhance方法中</span></span><br><span class="line">        <span class="comment">//   面在配置类中,将TokenEnhancer和JwtAccessConverter加到一个enhancerChain中</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">//   通俗点讲它做了两件事：</span></span><br><span class="line">        <span class="comment">//   给JWT令牌中设置附加信息和jti：jwt的唯一身份标识,主要用来作为一次性token,从而回避重放攻击</span></span><br><span class="line">        <span class="comment">//   判断请求中是否有refreshToken,如果有,就重新设置refreshToken并加入附加信息</span></span><br><span class="line">        TokenEnhancerChain enhancerChain = <span class="keyword">new</span> TokenEnhancerChain();</span><br><span class="line">        List&lt;TokenEnhancer&gt; enhancerList = <span class="keyword">new</span> ArrayList&lt;TokenEnhancer&gt;();</span><br><span class="line">        enhancerList.add(jwtTokenEnhancer);</span><br><span class="line">        enhancerList.add(jwtAccessTokenConverter);</span><br><span class="line">        enhancerChain.setTokenEnhancers(enhancerList); <span class="comment">//将自定义Enhancer加入EnhancerChain的delegates数组中</span></span><br><span class="line"></span><br><span class="line">        endpoints</span><br><span class="line">                <span class="comment">//设置tokenStore</span></span><br><span class="line">                .tokenStore(jwtTokenStore)</span><br><span class="line">                <span class="comment">//支持 refresh_token 模式</span></span><br><span class="line">                .userDetailsService(userDetailsService)</span><br><span class="line">                <span class="comment">//支持 password 模式</span></span><br><span class="line">                .authenticationManager(authenticationManager)</span><br><span class="line">                <span class="comment">//token扩展属性</span></span><br><span class="line">                .tokenEnhancer(enhancerChain)</span><br><span class="line">                <span class="comment">//设置token转换器</span></span><br><span class="line">                .accessTokenConverter(jwtAccessTokenConverter)</span><br><span class="line">                <span class="comment">//设置每次通过refresh_token获取新的access_token时，是否重新生成一个新的refresh_token。</span></span><br><span class="line">                <span class="comment">//默认true，不重新生成</span></span><br><span class="line">                <span class="comment">//.reuseRefreshTokens(true)</span></span><br><span class="line">                <span class="comment">//设置允许处理的请求类型</span></span><br><span class="line">                .allowedTokenEndpointRequestMethods(HttpMethod.GET,HttpMethod.POST);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthorizationServerSecurityConfigurer security)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        security</span><br><span class="line">                <span class="comment">//获取公钥的请求全部允许</span></span><br><span class="line">                .tokenKeyAccess(<span class="string">&quot;permitAll()&quot;</span>)</span><br><span class="line">                <span class="comment">//验证token有效性的请求需要先登录认证</span></span><br><span class="line">                .checkTokenAccess(<span class="string">&quot;isAuthenticated()&quot;</span>)</span><br><span class="line">                <span class="comment">//允许客户端form表单认证，就是可以将client_id和client_secret放到form中提交，否则必须使用Basic认证</span></span><br><span class="line">                .allowFormAuthenticationForClients();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="JwtTokenConfig"><a href="#JwtTokenConfig" class="headerlink" title="JwtTokenConfig"></a>JwtTokenConfig</h3><ul>
<li>本例基于JWTToken</li>
<li>支持两种密钥策略，对称密钥和基于jks证书的非对称密钥<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.oauth2authserverdemo.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.oauth2authserverdemo.security.jwt.JWTokenEnhancer;</span><br><span class="line"><span class="keyword">import</span> com.example.oauth2authserverdemo.security.jwt.JwtTokenProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.TokenEnhancer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.TokenStore;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.store.JwtAccessTokenConverter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.store.JwtTokenStore;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.store.KeyStoreKeyFactory;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * JwtTokenConfig配置类</span></span><br><span class="line"><span class="comment"> * 使用TokenStore将引入JwtTokenStore</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 注：Spring-Sceurity使用TokenEnhancer和JwtAccessConverter增强jwt令牌</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtTokenConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JwtTokenProperties jwtTokenProperties;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TokenStore <span class="title">jwtTokenStore</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JwtTokenStore(jwtAccessTokenConverter());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * JwtAccessTokenConverter：TokenEnhancer的子类,帮助程序在JWT编码的令牌值和OAuth身份验证信息之间进行转换(在两个方向上),同时充当TokenEnhancer授予令牌的时间。</span></span><br><span class="line"><span class="comment">     * 自定义的JwtAccessTokenConverter：把自己设置的jwt签名加入accessTokenConverter中(这里设置&#x27;demo&#x27;,项目可将此在配置文件设置)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JwtAccessTokenConverter <span class="title">jwtAccessTokenConverter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        JwtAccessTokenConverter accessTokenConverter = <span class="keyword">new</span> JwtAccessTokenConverter();</span><br><span class="line"></span><br><span class="line">        String type = jwtTokenProperties.getType();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (type)&#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;secret&quot;</span>:</span><br><span class="line">                <span class="comment">//设置加密token的密码</span></span><br><span class="line">                accessTokenConverter.setSigningKey(jwtTokenProperties.getSecret());</span><br><span class="line">                <span class="comment">//实际上资源服务器只需要设置验证token的密码</span></span><br><span class="line">                accessTokenConverter.setVerifierKey(jwtTokenProperties.getSecret());</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;jks&quot;</span>:</span><br><span class="line">                <span class="comment">//非对称加密,jks证书</span></span><br><span class="line">                KeyStoreKeyFactory keyStoreKeyFactory =</span><br><span class="line">                        <span class="keyword">new</span> KeyStoreKeyFactory(jwtTokenProperties.getJksKeyFileResource(), jwtTokenProperties.getJksStorePassword().toCharArray());</span><br><span class="line">                accessTokenConverter.setKeyPair(keyStoreKeyFactory.getKeyPair(jwtTokenProperties.getJksKeyAlias(),jwtTokenProperties.getJksKeyPassword().toCharArray()));</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;请正确配置密钥类型:secret,jks&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> accessTokenConverter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 引入自定义JWTokenEnhancer:</span></span><br><span class="line"><span class="comment">     * 自定义JWTokenEnhancer实现TokenEnhancer并重写enhance方法,将附加信息加入oAuth2AccessToken中</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TokenEnhancer <span class="title">jwtTokenEnhancer</span><span class="params">()</span></span>&#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> JWTokenEnhancer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="JWTokenEnhancer"><a href="#JWTokenEnhancer" class="headerlink" title="JWTokenEnhancer"></a>JWTokenEnhancer</h3><ul>
<li>jwt自定义属性<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.oauth2authserverdemo.security.jwt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.User;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.common.DefaultOAuth2AccessToken;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.common.OAuth2AccessToken;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.OAuth2Authentication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.TokenEnhancer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * TokenEnhancer：在AuthorizationServerTokenServices 实现存储访问令牌之前增强访问令牌的策略。</span></span><br><span class="line"><span class="comment"> * 自定义TokenEnhancer的代码：把附加信息加入oAuth2AccessToken中</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JWTokenEnhancer</span> <span class="keyword">implements</span> <span class="title">TokenEnhancer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 重写enhance方法,将附加信息加入oAuth2AccessToken中</span></span><br><span class="line"><span class="comment">     * 这里只是提供附加信息的方式，没需要可以不配置这个类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> oAuth2AccessToken</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> oAuth2Authentication</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> OAuth2AccessToken <span class="title">enhance</span><span class="params">(OAuth2AccessToken oAuth2AccessToken, OAuth2Authentication oAuth2Authentication)</span> </span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line">        User user = (User) oAuth2Authentication.getUserAuthentication().getPrincipal();</span><br><span class="line">        map.put(<span class="string">&quot;_username&quot;</span>, user.getUsername());</span><br><span class="line">        map.put(<span class="string">&quot;_authorities&quot;</span>, user.getAuthorities());</span><br><span class="line">        map.put(<span class="string">&quot;_jwt-ext&quot;</span>, <span class="string">&quot;JWT 扩展信息&quot;</span>);</span><br><span class="line">        ((DefaultOAuth2AccessToken) oAuth2AccessToken).setAdditionalInformation(map);</span><br><span class="line">        <span class="keyword">return</span> oAuth2AccessToken;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="JwtTokenProperties"><a href="#JwtTokenProperties" class="headerlink" title="JwtTokenProperties"></a>JwtTokenProperties</h3><ul>
<li><p>自定义的jwt相关属性类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.oauth2authserverdemo.security.jwt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.ClassPathResource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.PathResource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Jwt工具类</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;jwt&quot;)</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtTokenProperties</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 密钥类型:secret，jks</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String type;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 密钥</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String secret;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * accessToken过期时间，单位秒</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer accessTokenValiditySeconds;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * refreshToken过期时间，单位秒</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer refreshTokenValiditySeconds;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * jks证书文件路径</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String jksKeyFile;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * jks证书密钥库密码</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">private</span> String jksStorePassword;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * jks证书密码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String jksKeyPassword;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * jks证书别名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String jksKeyAlias;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取jks证书Resource</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Resource <span class="title">getJksKeyFileResource</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Resource resource;</span><br><span class="line">        <span class="keyword">if</span> (jksKeyFile.startsWith(<span class="string">&quot;classpath:&quot;</span>)) &#123;</span><br><span class="line">            resource = <span class="keyword">new</span> ClassPathResource(jksKeyFile.replace(<span class="string">&quot;classpath:&quot;</span>, <span class="string">&quot;&quot;</span>));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            resource = <span class="keyword">new</span> PathResource(Paths.get(jksKeyFile));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> resource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>配置文件：</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment">#自定义jwt属性信息</span></span><br><span class="line"><span class="attr">jwt:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">jks</span> <span class="comment"># 密钥类型：secret，jks</span></span><br><span class="line">  <span class="comment">#  SECRET 是签名密钥，只生成一次即可，生成方法：</span></span><br><span class="line">  <span class="comment">#  Key key = Keys.secretKeyFor(SignatureAlgorithm.HS512);</span></span><br><span class="line">  <span class="comment">#  String secretString = Encoders.BASE64.encode(key.getEncoded()); # 使用 BASE64 编码</span></span><br><span class="line">  <span class="attr">secret:</span> <span class="string">Ayl7bn+aFwxlakekKCJiqUYguKS80bEVb7OZtd2qfZjdCbAwKxDmM6PWezGy5JIkiJfemtHNPc7Av1l+OWQSqQ==</span> <span class="comment"># 秘钥</span></span><br><span class="line">  <span class="attr">accessTokenValiditySeconds:</span> <span class="number">43200</span>   <span class="comment"># access_token过期时间 (秒) ,默认值12小时</span></span><br><span class="line">  <span class="attr">refreshTokenValiditySeconds:</span> <span class="number">2592000</span> <span class="comment"># refresh_token过期时间 (秒) ,默认值30天</span></span><br><span class="line">  <span class="attr">jksKeyFile:</span> <span class="string">classpath:oauth2_key.jks</span></span><br><span class="line">  <span class="attr">jksStorePassword:</span> <span class="number">123456</span></span><br><span class="line">  <span class="attr">jksKeyAlias:</span> <span class="string">oauth2</span></span><br><span class="line">  <span class="attr">jksKeyPassword:</span> <span class="number">123456</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="客户端配置"><a href="#客户端配置" class="headerlink" title="客户端配置"></a>客户端配置</h3><ul>
<li>Oauth2支持两种客户端配置方式，基于内存和基于数据库<h4 id="AuthServerConfigByMemory"><a href="#AuthServerConfigByMemory" class="headerlink" title="AuthServerConfigByMemory"></a>AuthServerConfigByMemory</h4></li>
<li>基于内存<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.oauth2authserverdemo.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.oauth2authserverdemo.security.jwt.JwtTokenProperties;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.configurers.ClientDetailsServiceConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.EnableAuthorizationServer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAuthorizationServer</span></span><br><span class="line"><span class="meta">@ConditionalOnProperty(prefix = &quot;oauth2.clients.config&quot;,name = &quot;jdbc&quot;,havingValue = &quot;false&quot;,matchIfMissing = true)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthServerConfigByMemory</span> <span class="keyword">extends</span> <span class="title">AuthServerConfig</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JwtTokenProperties jwtTokenProperties;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 配置OAuth2的客户端信息：clientId、client_secret、authorization_type、redirect_url等。</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> clients</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(ClientDetailsServiceConfigurer clients)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        clients.inMemory()</span><br><span class="line">                .withClient(<span class="string">&quot;postman&quot;</span>)</span><br><span class="line">                .secret(passwordEncoder.encode(<span class="string">&quot;postman&quot;</span>))</span><br><span class="line">                .scopes(<span class="string">&quot;any&quot;</span>,<span class="string">&quot;all&quot;</span>) <span class="comment">//指定用户的访问范围</span></span><br><span class="line">                <span class="comment">//.autoApprove(true) //设置true跳过用户确认授权操作页面直接同意，默认false，必须设置scopes</span></span><br><span class="line">                .autoApprove(<span class="string">&quot;any&quot;</span>) <span class="comment">//指定客户端访问哪些范围时，跳过用户确认授权操作页面直接同意，必须设置scopes，请求参数必须加上&amp;scope=any</span></span><br><span class="line">                .authorizedGrantTypes(<span class="string">&quot;password&quot;</span>, <span class="string">&quot;authorization_code&quot;</span>, <span class="string">&quot;refresh_token&quot;</span>,<span class="string">&quot;implicit&quot;</span>,<span class="string">&quot;client_credentials&quot;</span>)</span><br><span class="line">                .redirectUris(<span class="string">&quot;http://localhost:8080/redirect&quot;</span>)</span><br><span class="line">                .accessTokenValiditySeconds(jwtTokenProperties.getAccessTokenValiditySeconds()) <span class="comment">//默认12小时</span></span><br><span class="line">                .refreshTokenValiditySeconds(jwtTokenProperties.getRefreshTokenValiditySeconds()) <span class="comment">//默认30天</span></span><br><span class="line">                .and()</span><br><span class="line">                .withClient(<span class="string">&quot;demo-client&quot;</span>)</span><br><span class="line">                .secret(passwordEncoder.encode(<span class="string">&quot;demo-client&quot;</span>))</span><br><span class="line">                .scopes(<span class="string">&quot;any&quot;</span>)</span><br><span class="line">                .authorizedGrantTypes(<span class="string">&quot;password&quot;</span>, <span class="string">&quot;authorization_code&quot;</span>, <span class="string">&quot;refresh_token&quot;</span>,<span class="string">&quot;implicit&quot;</span>)</span><br><span class="line">                .redirectUris(<span class="string">&quot;http://localhost:8080/redirect&quot;</span>);</span><br><span class="line">        log.info(<span class="string">&quot;OAuth2的client信息基于内存&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="AuthServerConfigByJDBC"><a href="#AuthServerConfigByJDBC" class="headerlink" title="AuthServerConfigByJDBC"></a>AuthServerConfigByJDBC</h4><ul>
<li><p>基于数据库</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.oauth2authserverdemo.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.configurers.ClientDetailsServiceConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.EnableAuthorizationServer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAuthorizationServer</span></span><br><span class="line"><span class="meta">@ConditionalOnProperty(prefix = &quot;oauth2.clients.config&quot;, name = &quot;jdbc&quot;, havingValue = &quot;true&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthServerConfigByJDBC</span> <span class="keyword">extends</span> <span class="title">AuthServerConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DataSource dataSource;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 配置OAuth2的客户端信息：clientId、client_secret、authorization_type、redirect_url等。</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> clients</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(ClientDetailsServiceConfigurer clients)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//方式1 也可以自定义ClientDetailsService的实现类</span></span><br><span class="line">        <span class="comment">//JdbcClientDetailsService detailsService = new JdbcClientDetailsService(dataSource);</span></span><br><span class="line">        <span class="comment">//detailsService.setPasswordEncoder(passwordEncoder);</span></span><br><span class="line">        <span class="comment">//clients.withClientDetails(detailsService);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//方式2 等价于方式1</span></span><br><span class="line">        clients.jdbc(dataSource)</span><br><span class="line">                <span class="comment">//指定密码的加密算法</span></span><br><span class="line">                .passwordEncoder(passwordEncoder);</span><br><span class="line">        log.info(<span class="string">&quot;OAuth2的client信息基于数据库&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>为了支持jdbc需要引入依赖</p>
<figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line"><span class="comment">//mysql</span></span><br><span class="line">runtimeOnly <span class="string">&#x27;mysql:mysql-connector-java&#x27;</span></span><br><span class="line"><span class="comment">//为了使用datasource</span></span><br><span class="line">implementation <span class="string">&#x27;org.springframework.boot:spring-boot-starter-jdbc&#x27;</span></span><br></pre></td></tr></table></figure></li>
<li><p>配置文件</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="comment">#数据源配置</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/springboot?useUnicode=true&amp;characterEncoding=utf-8&amp;useTimezone=true&amp;serverTimezone=GMT%2B8</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">newpwd</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">hikari:</span></span><br><span class="line">      <span class="attr">connection-timeout:</span> <span class="number">30000</span> <span class="comment">#毫秒，默认30秒</span></span><br><span class="line">      <span class="attr">idle-timeout:</span> <span class="number">600000</span>      <span class="comment">#毫秒，默认10分钟</span></span><br><span class="line">      <span class="attr">max-lifetime:</span> <span class="number">1800000</span>     <span class="comment">#毫秒，默认30分钟</span></span><br><span class="line">      <span class="attr">maximum-pool-size:</span> <span class="number">10</span>     <span class="comment">#默认10</span></span><br></pre></td></tr></table></figure></li>
<li><p>数据表</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- oauth2中规定的数据表,需要手动创建,一般项目中提供服务接口插入,参数由用户定义,在请求时会自动查询服务器中对应的参数数据匹配认证</span></span><br><span class="line"># 客户端注册信息表</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `oauth_client_details` (</span><br><span class="line">    `client_id` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;客户端的id&#x27;</span>,</span><br><span class="line">    `resource_ids` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;资源服务器的id，多个用，(逗号)隔开&#x27;</span>,</span><br><span class="line">    `client_secret` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;客户端的秘钥，需要PasswordEncoder加密&#x27;</span>,</span><br><span class="line">    `<span class="keyword">scope</span>` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;客户端的访问范围，多个逗号分隔&#x27;</span>,</span><br><span class="line">    `authorized_grant_types` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;认证的方式，可选值 授权码模式:authorization_code,密码模式:password,刷新token: refresh_token, 隐式模式: implicit: 客户端模式: client_credentials。支持多个用逗号分隔&#x27;</span>,</span><br><span class="line">    `web_server_redirect_uri` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;授权码模式认证成功跳转的地址。authorization_code和implicit需要该值进行校验，注册时填写，多个逗号分隔&#x27;</span>,</span><br><span class="line">    `authorities` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `access_token_validity` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;access_token的有效时间(秒),默认(60 * 60 * 12,12小时)&#x27;</span>,</span><br><span class="line">    `refresh_token_validity` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;refresh_token有效期(秒)，默认(60 *60 * 24 * 30, 30天)&#x27;</span>,</span><br><span class="line">    `additional_information` <span class="type">varchar</span>(<span class="number">4096</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;附加信息，值必须是json格式&#x27;</span>,</span><br><span class="line">    `autoapprove` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;默认false,适用于authorization_code模式,设置用户是否自动approval操作,设置true跳过用户确认授权操作页面，直接跳到redirect_uri，也可以这只scope中设置的值，表示只有这个scope会跳过授权页面，多个scope逗号分隔&#x27;</span>,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`client_id`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 ROW_FORMAT<span class="operator">=</span><span class="keyword">DYNAMIC</span>;</span><br><span class="line"></span><br><span class="line"># 初始化数据，密码要经过PasswordEncoder加密</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `oauth_client_details` <span class="keyword">VALUES</span> (<span class="string">&#x27;postman&#x27;</span>, <span class="keyword">NULL</span>, <span class="string">&#x27;$2a$10$Owubqs9VaN.vmskZ2B0UTe0GmOMwgTmhGtlIFBjrfCz2glBqISHSu&#x27;</span>, <span class="string">&#x27;any,all&#x27;</span>, <span class="string">&#x27;authorization_code,refresh_token,implicit,password,client_credentials&#x27;</span>, <span class="string">&#x27;http://localhost:8080/redirect,http://localhost:8088/postman/login&#x27;</span>, <span class="keyword">NULL</span>, <span class="number">42300</span>, <span class="number">2592000</span>, <span class="keyword">NULL</span>, <span class="string">&#x27;any&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `oauth_client_details` <span class="keyword">VALUES</span> (<span class="string">&#x27;demo-client&#x27;</span>, <span class="keyword">NULL</span>, <span class="string">&#x27;$2a$10$v/B9.6c9NUXFbJDHqc28he6VWeyJNOBOD1UI7bwBDfBZTwY4zzcda&#x27;</span>, <span class="string">&#x27;any&#x27;</span>, <span class="string">&#x27;authorization_code,refresh_token,password&#x27;</span>, <span class="string">&#x27;http://localhost:8080/redirect&#x27;</span>, <span class="keyword">NULL</span>, <span class="number">42300</span>, <span class="number">2592000</span>, <span class="keyword">NULL</span>, <span class="string">&#x27;&#x27;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>为了方便在内存和jdbc中切换，增加了自定义属性</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment">#oauth2的client信息是基于内存还是基于数据库，如果不配置，默认为基于内存</span></span><br><span class="line"><span class="attr">oauth2:</span></span><br><span class="line">  <span class="attr">clients:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">jdbc:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="jks证书创建"><a href="#jks证书创建" class="headerlink" title="jks证书创建"></a>jks证书创建</h3><h4 id="生成jks证书"><a href="#生成jks证书" class="headerlink" title="生成jks证书"></a>生成jks证书</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 默认证书有效期3个月</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> keytool -genkeypair -<span class="built_in">alias</span> oauth2 -keyalg RSA -keysize 2048 -keypass 123456 -keystore oauth2_key.jks -storepass 123456</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 指定证书有效期，这里设置有效期大约10年</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> keytool -genkeypair -<span class="built_in">alias</span> oauth2 -keyalg RSA -keysize 2048 -validity 36500 -keypass 123456 -keystore oauth2_key.jks -storepass 123456</span></span><br><span class="line"></span><br><span class="line">您的名字与姓氏是什么?</span><br><span class="line">  [Unknown]:  han</span><br><span class="line">您的组织单位名称是什么?</span><br><span class="line">  [Unknown]:  han</span><br><span class="line">您的组织名称是什么?</span><br><span class="line">  [Unknown]:  han</span><br><span class="line">您所在的城市或区域名称是什么?</span><br><span class="line">  [Unknown]:  bj</span><br><span class="line">您所在的省/市/自治区名称是什么?</span><br><span class="line">  [Unknown]:  bj</span><br><span class="line">该单位的双字母国家/地区代码是什么?</span><br><span class="line">  [Unknown]:  zh</span><br><span class="line">CN=han, OU=han, O=han, L=bj, ST=bj, C=zh是否正确?</span><br><span class="line">  [否]:  y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Warning:</span><br><span class="line">JKS 密钥库使用专用格式。建议使用 &quot;keytool -importkeystore -srckeystore oauth2_key.jks -destkeystore oauth2_key.jks -deststoretype pkcs12&quot; 迁移到行业标准格式 PKCS12。</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 按照警告执行如下命令</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> keytool -importkeystore -srckeystore oauth2_key.jks -destkeystore oauth2_key.jks -deststoretype pkcs12</span></span><br><span class="line">输入源密钥库口令:</span><br><span class="line">已成功导入别名 oauth2 的条目。</span><br><span class="line">已完成导入命令: 1 个条目成功导入, 0 个条目失败或取消</span><br><span class="line"></span><br><span class="line">Warning:</span><br><span class="line">已将 &quot;oauth2_key.jks&quot; 迁移到 Non JKS/JCEKS。将 JKS 密钥库作为 &quot;oauth2_key.jks.old&quot; 进行了备份。</span><br></pre></td></tr></table></figure>


<h4 id="导出公钥"><a href="#导出公钥" class="headerlink" title="导出公钥"></a>导出公钥</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> keytool -list -rfc --keystore oauth2_key.jks | openssl x509 -inform pem -pubkey</span></span><br><span class="line">输入密钥库口令:  123456</span><br><span class="line">-----BEGIN PUBLIC KEY-----</span><br><span class="line">MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAmVdbw3XtFamdasjItlko</span><br><span class="line">m8SyJiH0DnSUm1tqJDHY9orHA+0oa+VAlvxiHHBegKMX6FmCX3HAoVzHuAlWAZp0</span><br><span class="line">FyV0SUR4/tuOKOw/N7HbKGa/JZJSfaNdJAEobRxzd8woaLNlCRLelzDPhMy9kGtp</span><br><span class="line">x+Kc60smeo6XpC7RT25Mf5DRvKRJo4RGbPQNj18hWKZtY/TFZYySpa57eI9VOM5u</span><br><span class="line">fvWJkh3Jm5cOXHiHScmF4mdNATR3XQTHXD+TDu0rLgn7H4ap9uYDRTNVGVJ/JfYu</span><br><span class="line">aCrzszMFt4b+JNxz1UL42tTgbtKj8TxUrTRGTI/7KiwD5wjtpISSxlqoK1c0qgCh</span><br><span class="line">KQIDAQAB</span><br><span class="line">-----END PUBLIC KEY-----</span><br><span class="line">-----BEGIN CERTIFICATE-----</span><br><span class="line">MIIDQTCCAimgAwIBAgIEZ0BO+jANBgkqhkiG9w0BAQsFADBRMQswCQYDVQQGEwJ6</span><br><span class="line">aDELMAkGA1UECBMCYmoxCzAJBgNVBAcTAmJqMQwwCgYDVQQKEwNoYW4xDDAKBgNV</span><br><span class="line">BAsTA2hhbjEMMAoGA1UEAxMDaGFuMB4XDTIwMTEwODEyNDI0M1oXDTIxMDIwNjEy</span><br><span class="line">NDI0M1owUTELMAkGA1UEBhMCemgxCzAJBgNVBAgTAmJqMQswCQYDVQQHEwJiajEM</span><br><span class="line">MAoGA1UEChMDaGFuMQwwCgYDVQQLEwNoYW4xDDAKBgNVBAMTA2hhbjCCASIwDQYJ</span><br><span class="line">KoZIhvcNAQEBBQADggEPADCCAQoCggEBAJlXW8N17RWpnWrIyLZZKJvEsiYh9A50</span><br><span class="line">lJtbaiQx2PaKxwPtKGvlQJb8YhxwXoCjF+hZgl9xwKFcx7gJVgGadBcldElEeP7b</span><br><span class="line">jijsPzex2yhmvyWSUn2jXSQBKG0cc3fMKGizZQkS3pcwz4TMvZBracfinOtLJnqO</span><br><span class="line">l6Qu0U9uTH+Q0bykSaOERmz0DY9fIVimbWP0xWWMkqWue3iPVTjObn71iZIdyZuX</span><br><span class="line">Dlx4h0nJheJnTQE0d10Ex1w/kw7tKy4J+x+GqfbmA0UzVRlSfyX2Lmgq87MzBbeG</span><br><span class="line">/iTcc9VC+NrU4G7So/E8VK00RkyP+yosA+cI7aSEksZaqCtXNKoAoSkCAwEAAaMh</span><br><span class="line">MB8wHQYDVR0OBBYEFKM+xW8pT4EHc+5/svExkEKw8c3CMA0GCSqGSIb3DQEBCwUA</span><br><span class="line">A4IBAQB3OHZ1BrT+2hUFxhAk7K/7hC8tHVF8iRXhGBdnZWHNz2GRfzxOeyS4Amkp</span><br><span class="line">wCixoKg9GPhUL1fxBya7Z7wjn4jS5f9b5q40c/fP23zIrmbJ3rsqlMnx3vqrcnJB</span><br><span class="line">KF1l9i9h4iLDoTSS1HC42CuPSCSV/4/g2zXrZPWMVMHPHM9Ul8q+aTE7VaRzRsf8</span><br><span class="line">h7xCeqZXRg2z+wFHH4B1LMcfOHwpGWVJ46xgNqt3cx4IovVTcuXbcQGKgd2+/UuQ</span><br><span class="line">vugI0kWUCOH+CME9wbncIEJlDT1510GJIyt4EWyU3nio+vsLnlKz2jRP7QSE5dxY</span><br><span class="line">ps3Y1u9/nrBl1yK4+KEFAguUikbp</span><br><span class="line">-----END CERTIFICATE-----</span><br></pre></td></tr></table></figure>


<ul>
<li>这段就是公钥，保存到文件即可<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">-----BEGIN PUBLIC KEY-----</span><br><span class="line">MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAmVdbw3XtFamdasjItlko</span><br><span class="line">m8SyJiH0DnSUm1tqJDHY9orHA+0oa+VAlvxiHHBegKMX6FmCX3HAoVzHuAlWAZp0</span><br><span class="line">FyV0SUR4/tuOKOw/N7HbKGa/JZJSfaNdJAEobRxzd8woaLNlCRLelzDPhMy9kGtp</span><br><span class="line">x+Kc60smeo6XpC7RT25Mf5DRvKRJo4RGbPQNj18hWKZtY/TFZYySpa57eI9VOM5u</span><br><span class="line">fvWJkh3Jm5cOXHiHScmF4mdNATR3XQTHXD+TDu0rLgn7H4ap9uYDRTNVGVJ/JfYu</span><br><span class="line">aCrzszMFt4b+JNxz1UL42tTgbtKj8TxUrTRGTI/7KiwD5wjtpISSxlqoK1c0qgCh</span><br><span class="line">KQIDAQAB</span><br><span class="line">-----END PUBLIC KEY-----</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="查看密钥信息"><a href="#查看密钥信息" class="headerlink" title="查看密钥信息"></a>查看密钥信息</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> keytool -list -v -keystore oauth2_key.jks</span></span><br><span class="line">输入密钥库口令:</span><br><span class="line">密钥库类型: PKCS12</span><br><span class="line">密钥库提供方: SUN</span><br><span class="line"></span><br><span class="line">您的密钥库包含 1 个条目</span><br><span class="line"></span><br><span class="line">别名: oauth2</span><br><span class="line">创建日期: 2020-11-9</span><br><span class="line">条目类型: PrivateKeyEntry</span><br><span class="line">证书链长度: 1</span><br><span class="line">证书[1]:</span><br><span class="line">所有者: CN=han, OU=han, O=han, L=bj, ST=bj, C=zh</span><br><span class="line">发布者: CN=han, OU=han, O=han, L=bj, ST=bj, C=zh</span><br><span class="line">序列号: 67404efa</span><br><span class="line">有效期为 Sun Nov 08 20:42:43 CST 2020 至 Sat Feb 06 20:42:43 CST 2021</span><br><span class="line">证书指纹:</span><br><span class="line">         MD5:  3E:15:19:80:91:10:00:A8:63:A6:5E:19:5A:0E:A9:E5</span><br><span class="line">         SHA1: E8:BB:68:99:7E:33:6D:51:40:EF:C0:AC:91:A6:93:15:ED:FE:F8:3A</span><br><span class="line">         SHA256: CE:C7:C3:BF:BB:94:28:64:1B:EC:1C:F3:A9:DC:40:C5:53:AD:F2:27:01:83:8D:37:90:E0:EB:DB:C9:73:A5:5C</span><br><span class="line">签名算法名称: SHA256withRSA</span><br><span class="line">主体公共密钥算法: 2048 位 RSA 密钥</span><br><span class="line">版本: 3</span><br><span class="line"></span><br><span class="line">扩展:</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">1: ObjectId: 2.5.29.14 Criticality=<span class="literal">false</span></span></span><br><span class="line">SubjectKeyIdentifier [</span><br><span class="line">KeyIdentifier [</span><br><span class="line">0000: A3 3E C5 6F 29 4F 81 07   73 EE 7F B2 F1 31 90 42  .&gt;.o)O..s....1.B</span><br><span class="line">0010: B0 F1 CD C2                                        ....</span><br><span class="line">]</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">*******************************************</span><br><span class="line">*******************************************</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="OAuth2支持获取access-token的方式"><a href="#OAuth2支持获取access-token的方式" class="headerlink" title="OAuth2支持获取access_token的方式"></a>OAuth2支持获取access_token的方式</h2><ul>
<li>authorization_code 验证码模式</li>
<li>implicit 隐式模式</li>
<li>password 密码模式</li>
<li>client_credentials 客户端模式</li>
<li>refresh_token 刷新token模式</li>
</ul>
<h3 id="Oauth2提供的默认端点（endpoints）"><a href="#Oauth2提供的默认端点（endpoints）" class="headerlink" title="Oauth2提供的默认端点（endpoints）"></a>Oauth2提供的默认端点（endpoints）</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/oauth/authorize：授权端点 AuthorizationEndpoint 按照OAuth 2.0规范的授权实现</span><br><span class="line">/oauth/token：令牌端点 TokenEndpoint 按照OAuth 2.0规范请求Token</span><br><span class="line">/oauth/confirm_access：用户确认授权提交端点</span><br><span class="line">/oauth/error：授权服务错误信息端点</span><br><span class="line">/oauth/check_token：用于资源服务访问的令牌解析端点 CheckTokenEndpoint 解码Client的Access Token用来检查和确认生成的Token</span><br><span class="line">/oauth/token_key：提供公有密匙的端点，如果使用JWT令牌的话 TokenKeyEndpoint 提供JWT编码的Token</span><br></pre></td></tr></table></figure>


<h3 id="验证码模式–authorization-code，最常用的模式"><a href="#验证码模式–authorization-code，最常用的模式" class="headerlink" title="验证码模式–authorization_code，最常用的模式"></a>验证码模式–authorization_code，最常用的模式</h3><ol>
<li><p>获取验证码</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">浏览器GET</span><br><span class="line">http://localhost:8080/oauth/authorize?client_id=postman&amp;response_type=code&amp;redirect_uri=http://localhost:8080/redirect</span><br></pre></td></tr></table></figure>
<ul>
<li>1.1 参数说明<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">response_type</span>=<span class="string">code #授权码认证，固定值</span></span><br><span class="line"><span class="attr">client_id</span>=<span class="string">postman #客户端id</span></span><br><span class="line"><span class="attr">redirect_uri</span>=<span class="string">http://localhost:8080/redirect #重定向url，这个值要与配置的值一致，配置这个值时可以配置一个不存在的路径</span></span><br><span class="line"><span class="attr">scope</span>=<span class="string">any 可选参数，指定请求范围，如果不希望跳转到确认页面而是直接通过，需要在代码中配置autoApprove(true)或者autoApprove(&quot;any&quot;)</span></span><br></pre></td></tr></table></figure></li>
<li>1.2 跳转到登录页面，使用<code>admin/123456</code>登录</li>
<li>1.3 登录成功后跳转到认证确认页面(如果不希望跳转到确认页面而是直接通过，需要在代码中配置autoApprove(true))，点击<code>Authorize</code>按钮，页面会跳转到<code>http://localhost:8080/redirect?code=7ak4gI</code></li>
<li>1.4 复制code的值进入第二步</li>
</ul>
</li>
<li><p>获取access_token和refresh_token</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST</span><br><span class="line">http://localhost:8080/oauth/token?grant_type=authorization_code&amp;client_id=postman&amp;client_secret=postman&amp;redirect_uri=http://localhost:8080/redirect&amp;code=7ak4gI</span><br></pre></td></tr></table></figure>
<ul>
<li>2.1 code存在有效期，且只能使用一次，所以这个请求只能使用一次，参数说明<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">grant_type</span>=<span class="string">authorization_code #验证code并获取access_token，固定值</span></span><br><span class="line"><span class="attr">client_id</span>=<span class="string">postman #客户端id</span></span><br><span class="line"><span class="attr">client_secret</span>=<span class="string">postman #客户端密码</span></span><br><span class="line"><span class="attr">redirect_uri</span>=<span class="string">http://localhost:8080/redirect #重定向url</span></span><br><span class="line"><span class="attr">code</span>=<span class="string">7ak4gI #上一步中获取到的code值</span></span><br></pre></td></tr></table></figure></li>
<li>2.2 响应结果如下，默认access_token有效期12小时，refresh_token有效期30天<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;access_token&quot;</span>: <span class="string">&quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX25hbWUiOiJhZG1pbiIsImp3dC1leHQiOiJKV1Qg5omp5bGV5L-h5oGvIiwic2NvcGUiOlsiYW55Il0sImV4cCI6MTYwNDYxMzI3MywiYXV0aG9yaXRpZXMiOlsiUk9MRV9hZG1pbiJdLCJqdGkiOiJhNzFhMDJhYy02NzgyLTRiODEtOGJiMi1mMGI3ZWVkODk2YTgiLCJjbGllbnRfaWQiOiJwb3N0bWFuIn0.SKl-0KbdVvv3acqLlXre66PX-fFIruTLwOkCO3peby0&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;token_type&quot;</span>: <span class="string">&quot;bearer&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;refresh_token&quot;</span>: <span class="string">&quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX25hbWUiOiJhZG1pbiIsImp3dC1leHQiOiJKV1Qg5omp5bGV5L-h5oGvIiwic2NvcGUiOlsiYW55Il0sImF0aSI6ImE3MWEwMmFjLTY3ODItNGI4MS04YmIyLWYwYjdlZWQ4OTZhOCIsImV4cCI6MTYwNzE2MjA3MywiYXV0aG9yaXRpZXMiOlsiUk9MRV9hZG1pbiJdLCJqdGkiOiI5NzRjMDRkOS03NTQ0LTRjZTEtODMzZS05NjlmODMyNmRiNmQiLCJjbGllbnRfaWQiOiJwb3N0bWFuIn0.vy16MpRikSFFz_n2zJEgI5Cfy1APNDrvnuP7Sj1jqJU&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;expires_in&quot;</span>: <span class="number">43199</span>,</span><br><span class="line">    <span class="attr">&quot;scope&quot;</span>: <span class="string">&quot;any&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;jwt-ext&quot;</span>: <span class="string">&quot;JWT 扩展信息&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;jti&quot;</span>: <span class="string">&quot;a71a02ac-6782-4b81-8bb2-f0b7eed896a8&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>2.3 复制refresh_token的值进入第三步</li>
<li>2.4 请求时支持base认证方式，详见3.3</li>
</ul>
</li>
<li><p>通过refresh_token获取新的access_token</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST</span><br><span class="line">http://localhost:8080/oauth/token?grant_type=refresh_token&amp;client_id=postman&amp;client_secret=postman&amp;refresh_token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX25hbWUiOiJhZG1pbiIsImp3dC1leHQiOiJKV1Qg5omp5bGV5L-h5oGvIiwic2NvcGUiOlsiYW55Il0sImF0aSI6ImE3MWEwMmFjLTY3ODItNGI4MS04YmIyLWYwYjdlZWQ4OTZhOCIsImV4cCI6MTYwNzE2MjA3MywiYXV0aG9yaXRpZXMiOlsiUk9MRV9hZG1pbiJdLCJqdGkiOiI5NzRjMDRkOS03NTQ0LTRjZTEtODMzZS05NjlmODMyNmRiNmQiLCJjbGllbnRfaWQiOiJwb3N0bWFuIn0.vy16MpRikSFFz_n2zJEgI5Cfy1APNDrvnuP7Sj1jqJU</span><br></pre></td></tr></table></figure>
<ul>
<li>3.1 参数说明，这个就是refresh_token模式，需要先获取到上一次的refresh_token<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">grant_type</span>=<span class="string">refresh_token #刷新token的参数，固定值</span></span><br><span class="line"><span class="attr">client_id</span>=<span class="string">postman #客户端id</span></span><br><span class="line"><span class="attr">client_secret</span>=<span class="string">postman #客户端密码</span></span><br><span class="line"><span class="attr">refresh_token</span>=<span class="string">xxx #上一步中获取的refresh_token值</span></span><br></pre></td></tr></table></figure></li>
<li>3.2 响应结果如下，获取到新的access_token和refresh_token，注意保存，access_token过期时，可以通过该请求重新获得新的access_token<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;access_token&quot;</span>: <span class="string">&quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX25hbWUiOiJhZG1pbiIsImp3dC1leHQiOiJKV1Qg5omp5bGV5L-h5oGvIiwic2NvcGUiOlsiYW55Il0sImV4cCI6MTYwNDYxMzc4NSwiYXV0aG9yaXRpZXMiOlsiUk9MRV9hZG1pbiJdLCJqdGkiOiI5YWQ1MTBhNy00MzQyLTQ5M2UtYjQyMS1iNzNmMDU2NmU3OWYiLCJjbGllbnRfaWQiOiJwb3N0bWFuIn0.L0TPZ-NDzT4hSSivQ0WR-5rPz6xoLbC_HmdvvKOzP_Y&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;token_type&quot;</span>: <span class="string">&quot;bearer&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;refresh_token&quot;</span>: <span class="string">&quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX25hbWUiOiJhZG1pbiIsImp3dC1leHQiOiJKV1Qg5omp5bGV5L-h5oGvIiwic2NvcGUiOlsiYW55Il0sImF0aSI6IjlhZDUxMGE3LTQzNDItNDkzZS1iNDIxLWI3M2YwNTY2ZTc5ZiIsImV4cCI6MTYwNzE2MjA3MywiYXV0aG9yaXRpZXMiOlsiUk9MRV9hZG1pbiJdLCJqdGkiOiI5NzRjMDRkOS03NTQ0LTRjZTEtODMzZS05NjlmODMyNmRiNmQiLCJjbGllbnRfaWQiOiJwb3N0bWFuIn0.ekAST3MRc0PqW3FZgnFQv1g-HykCqA4_TuzLRTplCIM&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;expires_in&quot;</span>: <span class="number">43199</span>,</span><br><span class="line">    <span class="attr">&quot;scope&quot;</span>: <span class="string">&quot;any&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;jwt-ext&quot;</span>: <span class="string">&quot;JWT 扩展信息&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;jti&quot;</span>: <span class="string">&quot;9ad510a7-4342-493e-b421-b73f0566e79f&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>3.3 请求时支持base认证方式</li>
</ul>
 <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 将client_id和client_secret放到url的前面</span></span><br><span class="line">POST http://postman:postman@localhost:8080/oauth/token?grant_type=refresh_token&amp;refresh_token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX25hbWUiOiJhZG1pbiIsImp3dC1leHQiOiJKV1Qg5omp5bGV5L-h5oGvIiwic2NvcGUiOlsiYW55Il0sImF0aSI6ImM4NWM0YjJlLTBlNTktNDJhYy05M2RlLWI2N2I0OWI1ZDU5OSIsImV4cCI6MTYwNzIyMDAxMiwiYXV0aG9yaXRpZXMiOlsiUk9MRV9hZG1pbiJdLCJqdGkiOiI2M2U2MGYxOS1iOTU1LTRlMmUtODk2Yy1mYWUxN2IyODUzMzkiLCJjbGllbnRfaWQiOiJwb3N0bWFuIn0.jVZWYRjr4VwTYwbKXP-sav_08vwc8iAxzEbg0I_jVTw</span><br></pre></td></tr></table></figure>
<p> 或者在header中增加<code>Authorization</code>请求头，值为<code>Basic xxxxxxxxx</code>，<code>xxxxxxxxx</code>是通过<code>base64.encode(client_id + 空格 + client_secret)</code>得到。<br> 使用Postman接口测试工具时，也可以使用其提供的认证功能[Authorization–&gt;TYPE–&gt;Basic Auth]，直接填写用户名和密码就可以方便进行测试，注意这里用户名和密码是client_id 和 client_secret。</p>
 <figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;access_token&quot;</span>: <span class="string">&quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX25hbWUiOiJhZG1pbiIsImp3dC1leHQiOiJKV1Qg5omp5bGV5L-h5oGvIiwic2NvcGUiOlsiYW55Il0sImV4cCI6MTYwNDY4NTE3NiwiYXV0aG9yaXRpZXMiOlsiUk9MRV9hZG1pbiJdLCJqdGkiOiJhNDhiNzZhNC1kNWM0LTRkNTYtYmQ2Yy0zOWYxODQ0MGYwNTMiLCJjbGllbnRfaWQiOiJwb3N0bWFuIn0.mhNUhWk1M9p267bOsv3fYXnLGeXitvnny6mUT9FyNdw&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;token_type&quot;</span>: <span class="string">&quot;bearer&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;refresh_token&quot;</span>: <span class="string">&quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX25hbWUiOiJhZG1pbiIsImp3dC1leHQiOiJKV1Qg5omp5bGV5L-h5oGvIiwic2NvcGUiOlsiYW55Il0sImF0aSI6ImE0OGI3NmE0LWQ1YzQtNGQ1Ni1iZDZjLTM5ZjE4NDQwZjA1MyIsImV4cCI6MTYwNzIyMDAxMiwiYXV0aG9yaXRpZXMiOlsiUk9MRV9hZG1pbiJdLCJqdGkiOiI2M2U2MGYxOS1iOTU1LTRlMmUtODk2Yy1mYWUxN2IyODUzMzkiLCJjbGllbnRfaWQiOiJwb3N0bWFuIn0.DT_cBdcow7pDv_S9RTHknKLHxZAIT45Byw1Rdw93K8U&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;expires_in&quot;</span>: <span class="number">43199</span>,</span><br><span class="line">    <span class="attr">&quot;scope&quot;</span>: <span class="string">&quot;any&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;jwt-ext&quot;</span>: <span class="string">&quot;JWT 扩展信息&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;jti&quot;</span>: <span class="string">&quot;a48b76a4-d5c4-4d56-bd6c-39f18440f053&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>3.4 access_token信息<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="comment">//HEADER</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;alg&quot;</span>: <span class="string">&quot;HS256&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;typ&quot;</span>: <span class="string">&quot;JWT&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//PAYLOAD</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;user_name&quot;</span>: <span class="string">&quot;admin&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;jwt-ext&quot;</span>: <span class="string">&quot;JWT 扩展信息&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;scope&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;any&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;exp&quot;</span>: <span class="number">1604613785</span>,</span><br><span class="line">  <span class="attr">&quot;authorities&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;ROLE_admin&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;jti&quot;</span>: <span class="string">&quot;9ad510a7-4342-493e-b421-b73f0566e79f&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;client_id&quot;</span>: <span class="string">&quot;postman&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ol>
<h3 id="implicit模式"><a href="#implicit模式" class="headerlink" title="implicit模式"></a>implicit模式</h3><ul>
<li>仅可获取access_token，不能获取refresh_token</li>
<li>跳转到登录页面<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">浏览器GET</span><br><span class="line">http://localhost:8080/oauth/authorize?client_id=postman&amp;response_type=token&amp;redirect_uri=http://localhost:8080/redirect</span><br></pre></td></tr></table></figure></li>
<li>然后登录，然后同意授权</li>
<li>返回结果直接拼接在redirect_uri的后面，因为是以<code>#</code>开头，所以服务器端无法收到数据，只能从浏览器中获取了  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://localhost:8080/redirect#access_token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX25hbWUiOiJhZG1pbiIsImp3dC1leHQiOiJKV1Qg5omp5bGV5L-h5oGvIiwic2NvcGUiOlsiYW55Il0sImV4cCI6MTYwNDY3NTMwNSwiYXV0aG9yaXRpZXMiOlsiUk9MRV9hZG1pbiJdLCJqdGkiOiI4ZDcyODM5NC0zODhjLTRiMjAtYjgwYy1jNTk4OWJjZmJlM2IiLCJjbGllbnRfaWQiOiJwb3N0bWFuIn0.OStAhkT6fBoNLdF7vTaztwhfNV5J8K1MpE1A7pxbyCs&amp;token_type=bearer&amp;expires_in=43199&amp;scope=any&amp;jwt-ext=JWT%20%E6%89%A9%E5%B1%95%E4%BF%A1%E6%81%AF&amp;jti=8d728394-388c-4b20-b80c-c5989bcfbe3b</span><br></pre></td></tr></table></figure></li>
<li>access_token信息<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="comment">//HEADER</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;alg&quot;</span>: <span class="string">&quot;HS256&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;typ&quot;</span>: <span class="string">&quot;JWT&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//PAYLOAD</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;user_name&quot;</span>: <span class="string">&quot;admin&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;jwt-ext&quot;</span>: <span class="string">&quot;JWT 扩展信息&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;scope&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;any&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;exp&quot;</span>: <span class="number">1604675305</span>,</span><br><span class="line">  <span class="attr">&quot;authorities&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;ROLE_admin&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;jti&quot;</span>: <span class="string">&quot;8d728394-388c-4b20-b80c-c5989bcfbe3b&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;client_id&quot;</span>: <span class="string">&quot;postman&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="password-模式"><a href="#password-模式" class="headerlink" title="password 模式"></a>password 模式</h3><ul>
<li>密码模式（Resource Owner Password Credentials Grant）中，用户向客户端提供自己的用户名和密码。客户端使用这些信息，向”服务商提供商”索要授权。</li>
<li>在这种模式中，用户必须把自己的密码给客户端，但是客户端不得储存密码。这通常用在用户对客户端高度信任的情况下，比如客户端是操作系统的一部分，或者由一个著名公司出品。而认证服务器只有在其他授权模式无法执行的情况下，才能考虑使用这种模式。</li>
<li>获取access_token和refresh_token<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST</span><br><span class="line">http://localhost:8080/oauth/token?username=admin&amp;password=123456&amp;grant_type=password&amp;client_id=postman&amp;client_secret=postman</span><br></pre></td></tr></table></figure></li>
<li>请求时支持base认证方式，认证用户名和密码是client_id 和 client_secret</li>
<li>grant_type=password，需要携带用户的用户名和密码</li>
<li>返回结果<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;access_token&quot;: &quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX25hbWUiOiJhZG1pbiIsImp3dC1leHQiOiJKV1Qg5omp5bGV5L-h5oGvIiwic2NvcGUiOlsiYW55Il0sImV4cCI6MTYwNDY3NzU1MiwiYXV0aG9yaXRpZXMiOlsiUk9MRV9hZG1pbiJdLCJqdGkiOiJlNjZiMWFjOS04M2RmLTRiNTMtYjNmYS1mMTQyYzA2MTYzMjkiLCJjbGllbnRfaWQiOiJwb3N0bWFuIn0.jfBeoA-AeNaMUSWHKBktN8IOFbGJHtQSIQUgxP8zzg0&quot;,</span><br><span class="line">    &quot;token_type&quot;: &quot;bearer&quot;,</span><br><span class="line">    &quot;refresh_token&quot;: &quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX25hbWUiOiJhZG1pbiIsImp3dC1leHQiOiJKV1Qg5omp5bGV5L-h5oGvIiwic2NvcGUiOlsiYW55Il0sImF0aSI6ImU2NmIxYWM5LTgzZGYtNGI1My1iM2ZhLWYxNDJjMDYxNjMyOSIsImV4cCI6MTYwNzIyNjM1MiwiYXV0aG9yaXRpZXMiOlsiUk9MRV9hZG1pbiJdLCJqdGkiOiI5MDUwNTQ0Yi00OGVmLTQ2OWMtYjM3OS1lMWQyZDViOTcyYjkiLCJjbGllbnRfaWQiOiJwb3N0bWFuIn0.fGDixRXD68cYdRTjprH3TM7gAGmFqDAaKxs3RTxphMs&quot;,</span><br><span class="line">    &quot;expires_in&quot;: 43199,</span><br><span class="line">    &quot;scope&quot;: &quot;any&quot;,</span><br><span class="line">    &quot;jwt-ext&quot;: &quot;JWT 扩展信息&quot;,</span><br><span class="line">    &quot;jti&quot;: &quot;e66b1ac9-83df-4b53-b3fa-f142c0616329&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>access_token信息<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="comment">//HEADER</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;alg&quot;</span>: <span class="string">&quot;HS256&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;typ&quot;</span>: <span class="string">&quot;JWT&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//PAYLOAD</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;user_name&quot;</span>: <span class="string">&quot;admin&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;jwt-ext&quot;</span>: <span class="string">&quot;JWT 扩展信息&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;scope&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;any&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;exp&quot;</span>: <span class="number">1604677552</span>,</span><br><span class="line">  <span class="attr">&quot;authorities&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;ROLE_admin&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;jti&quot;</span>: <span class="string">&quot;e66b1ac9-83df-4b53-b3fa-f142c0616329&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;client_id&quot;</span>: <span class="string">&quot;postman&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="client-credentials-客户端模式"><a href="#client-credentials-客户端模式" class="headerlink" title="client_credentials 客户端模式"></a>client_credentials 客户端模式</h3><ul>
<li>客户端模式（Client Credentials Grant）指客户端以自己的名义，而不是以用户的名义，向”服务提供商”进行认证。严格地说，客户端模式并不属于OAuth框架所要解决的问题。在这种模式中，用户直接向客户端注册，客户端以自己的名义要求”服务提供商”提供服务，其实不存在授权问题。</li>
<li>获取access_token<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST</span><br><span class="line">http://localhost:8080/oauth/token?grant_type=client_credentials&amp;client_id=postman&amp;client_secret=postman</span><br></pre></td></tr></table></figure></li>
<li>不需要用户的用户名和密码，只是认证客户端是否有效，返回的access_token的payload中也不包含任何用户信息(user_name,authorities)</li>
<li>没有refresh_token</li>
<li>返回结果<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;access_token&quot;: &quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqd3QtZXh0IjoiSldUIOaJqeWxleS_oeaBryIsInNjb3BlIjpbImFueSJdLCJleHAiOjE2MDQ2Nzc4NjksImp0aSI6ImU3ZjJhYTEyLTFhMWUtNGFmMC04MjJkLTkxNzg5NmYyMGMwMyIsImNsaWVudF9pZCI6InBvc3RtYW4ifQ.OHy0IUGf9KSmCDKlqq1IZ8bICAhBHFtpazwK1gcbCOI&quot;,</span><br><span class="line">    &quot;token_type&quot;: &quot;bearer&quot;,</span><br><span class="line">    &quot;expires_in&quot;: 43199,</span><br><span class="line">    &quot;scope&quot;: &quot;any&quot;,</span><br><span class="line">    &quot;jwt-ext&quot;: &quot;JWT 扩展信息&quot;,</span><br><span class="line">    &quot;jti&quot;: &quot;e7f2aa12-1a1e-4af0-822d-917896f20c03&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>access_token信息<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="comment">//HEADER</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;alg&quot;</span>: <span class="string">&quot;HS256&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;typ&quot;</span>: <span class="string">&quot;JWT&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//PAYLOAD</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;jwt-ext&quot;</span>: <span class="string">&quot;JWT 扩展信息&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;scope&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;any&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;exp&quot;</span>: <span class="number">1604677869</span>,</span><br><span class="line">  <span class="attr">&quot;jti&quot;</span>: <span class="string">&quot;e7f2aa12-1a1e-4af0-822d-917896f20c03&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;client_id&quot;</span>: <span class="string">&quot;postman&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="refresh-token模式，见验证码模式第3部分"><a href="#refresh-token模式，见验证码模式第3部分" class="headerlink" title="refresh_token模式，见验证码模式第3部分"></a>refresh_token模式，见验证码模式第3部分</h3><p>通过已有的refresh_token获取新的access_token和refresh_token</p>
<h3 id="验证token有效性–Basic-Auth"><a href="#验证token有效性–Basic-Auth" class="headerlink" title="验证token有效性–Basic Auth"></a>验证token有效性–Basic Auth</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST http://postman:postman@localhost:8080/oauth/check_token?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX25hbWUiOiJhZG1pbiIsImp3dC1leHQiOiJKV1Qg5omp5bGV5L-h5oGvIiwic2NvcGUiOlsiYW55IiwiYWxsIl0sImV4cCI6MTYwNDcxNjMyMCwiYXV0aG9yaXRpZXMiOlsiUk9MRV9hZG1pbiJdLCJqdGkiOiIxNjc4ZTNhYy0yYmNjLTQ4NGUtOTBkMy02ZWFjYTVkNzkyM2IiLCJjbGllbnRfaWQiOiJwb3N0bWFuIn0.8piTJdoAf-4lB0Tn-yeSFWoV3WpkJkqBs7AsoNPoohw</span><br></pre></td></tr></table></figure>
<p>或者加上Header参数<code>Authorization</code> 值为 <code>Basic cG9zdG1hbjpwb3N0bWFu</code></p>
<p>返回值</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;user_name&quot;</span>: <span class="string">&quot;admin&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;jwt-ext&quot;</span>: <span class="string">&quot;JWT 扩展信息&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;scope&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;any&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;active&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">&quot;exp&quot;</span>: <span class="number">1604767911</span>,</span><br><span class="line">    <span class="attr">&quot;authorities&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;ROLE_admin&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;jti&quot;</span>: <span class="string">&quot;5597b675-a617-4e02-959f-86d62024a237&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;client_id&quot;</span>: <span class="string">&quot;postman&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="获取公钥，比如JWT的密钥"><a href="#获取公钥，比如JWT的密钥" class="headerlink" title="获取公钥，比如JWT的密钥"></a>获取公钥，比如JWT的密钥</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET http://postman:postman@localhost:8080/oauth/token_key</span><br></pre></td></tr></table></figure>
<p>或者加上Header参数<code>Authorization</code> 值为 <code>Basic cG9zdG1hbjpwb3N0bWFu</code></p>
<p>返回值</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;alg&quot;</span>: <span class="string">&quot;HMACSHA256&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;value&quot;</span>: <span class="string">&quot;Ayl7bn+aFwxlakekKCJiqUYguKS80bEVb7OZtd2qfZjdCbAwKxDmM6PWezGy5JIkiJfemtHNPc7Av1l+OWQSqQ==&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="自定义登录和授权页面"><a href="#自定义登录和授权页面" class="headerlink" title="自定义登录和授权页面"></a>自定义登录和授权页面</h2><h3 id="依赖-1"><a href="#依赖-1" class="headerlink" title="依赖"></a>依赖</h3><figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line">implementation <span class="string">&#x27;org.springframework.boot:spring-boot-starter-thymeleaf&#x27;</span></span><br><span class="line"><span class="comment">//webjars https://www.webjars.org</span></span><br><span class="line">implementation <span class="string">&#x27;org.webjars:bootstrap:4.5.3&#x27;</span></span><br><span class="line">implementation <span class="string">&#x27;org.webjars.bower:jquery:3.5.1&#x27;</span></span><br><span class="line"><span class="comment">// 可以在html中去掉webjars的版本号，这样升级的时候直接修改上面引入的webjars中的版本号即可，页面中不需要修改</span></span><br><span class="line">implementation <span class="string">&#x27;org.webjars:webjars-locator:0.40&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="OAuth2Controller"><a href="#OAuth2Controller" class="headerlink" title="OAuth2Controller"></a>OAuth2Controller</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.oauth2authserverdemo.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.istack.internal.Nullable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ui.Model;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.SessionAttributes;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@SessionAttributes(&#123;&quot;authorizationRequest&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OAuth2Controller</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义授权页面，注意：一定要在类上加<span class="doctag">@SessionAttributes</span>(&#123;&quot;authorizationRequest&quot;&#125;)</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> model   model</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> String</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/oauth/confirm_access&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getAccessConfirmation</span><span class="params">(Map&lt;String, Object&gt; model, HttpServletRequest request)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        List&lt;String&gt; scopeList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        String scope = request.getParameter(<span class="string">&quot;scope&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (scope != <span class="keyword">null</span>) &#123;</span><br><span class="line">            String[] split = scope.split(<span class="string">&quot; &quot;</span>);</span><br><span class="line">            <span class="keyword">for</span>(String s:split) &#123;</span><br><span class="line">                scopeList.add(s);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        model.put(<span class="string">&quot;scopeList&quot;</span>, scopeList);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;oauth2/confirm_access&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;h2&gt;自定义登录&lt;/h2&gt;</span></span><br><span class="line"><span class="comment">     * Created by hanqf on 2020/11/13 10:13. &lt;br&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> java.lang.String</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> hanqf</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/oauth/login&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">login</span><span class="params">(Model model,<span class="meta">@Nullable</span> Boolean error,HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(error!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            model.addAttribute(<span class="string">&quot;error&quot;</span>,error);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">//从客户端logout后，第一次重新登录会不成功，这里加一个处理逻辑，如果发现其queryString的值为logout就重定向到首页</span></span><br><span class="line">            <span class="comment">//暂时不清楚客户端登出后该如何设置才能直接重新登录客户端，可以在认证服务器首页增加客户端入口</span></span><br><span class="line">            <span class="keyword">if</span>(<span class="string">&quot;logout&quot;</span>.equals(request.getQueryString()))&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;redirect:/&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;oauth2/login&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="login-html"><a href="#login-html" class="headerlink" title="login.html"></a>login.html</h3><ul>
<li>登录页面<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1, shrink-to-fit=no&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;/webjars/bootstrap/css/bootstrap.min.css&#125;&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">th:src</span>=<span class="string">&quot;@&#123;/webjars/jquery/jquery.min.js&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">th:src</span>=<span class="string">&quot;@&#123;/webjars/bootstrap/js/bootstrap.min.js&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width: 320px;margin-top: 100px;&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h3</span> <span class="attr">align</span>=<span class="string">&quot;center&quot;</span>&gt;</span>OAuth2登录<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;alert-danger&quot;</span> <span class="attr">style</span>=<span class="string">&quot;text-align: center&quot;</span> <span class="attr">th:if</span>=<span class="string">&quot;$&#123;error&#125;&quot;</span>&gt;</span>用户名或密码错误!<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">&quot;notice_null&quot;</span> <span class="attr">class</span>=<span class="string">&quot;alert-danger&quot;</span> <span class="attr">style</span>=<span class="string">&quot;text-align: center;&quot;</span>&gt;</span>用户名或密码不能为空!<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">th:action</span>=<span class="string">&quot;@&#123;/login&#125;&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">onsubmit</span>=<span class="string">&quot;return onsubmitCheck()&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">table</span> <span class="attr">class</span>=<span class="string">&quot;table&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span>用户名:<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">label</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">id</span>=<span class="string">&quot;username&quot;</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span>/&gt;</span><span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span>密码:<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">label</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">id</span>=<span class="string">&quot;password&quot;</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span>/&gt;</span><span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;btn-success&quot;</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="javascript"></span></span><br><span class="line"><span class="javascript">    $(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="comment">//默认不显示错误提醒</span></span></span><br><span class="line"><span class="javascript">        $(<span class="string">&quot;#notice_null&quot;</span>).hide();</span></span><br><span class="line"><span class="javascript">    &#125;);</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">onsubmitCheck</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> username = $(<span class="string">&quot;#username&quot;</span>).val();</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> password = $(<span class="string">&quot;#password&quot;</span>).val();</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript">        <span class="keyword">if</span>(username == <span class="string">&quot;&quot;</span> || password == <span class="string">&quot;&quot;</span>)&#123;</span></span><br><span class="line"><span class="javascript">            $(<span class="string">&quot;#notice_null&quot;</span>).show();</span></span><br><span class="line"><span class="javascript">            <span class="keyword">return</span> <span class="literal">false</span>;</span></span><br><span class="line"><span class="javascript">        &#125;</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript">        <span class="keyword">return</span> <span class="literal">true</span>;</span></span><br><span class="line"><span class="javascript">    &#125;</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="confirm-access-html"><a href="#confirm-access-html" class="headerlink" title="confirm_access.html"></a>confirm_access.html</h3><ul>
<li>授权页面<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1, shrink-to-fit=no&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>确认授权页面<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">META</span> <span class="attr">http-equiv</span>=<span class="string">&quot;Pragma&quot;</span> <span class="attr">content</span>=<span class="string">&quot;no-cache&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">META</span> <span class="attr">http-equiv</span>=<span class="string">&quot;Cache-Control&quot;</span> <span class="attr">content</span>=<span class="string">&quot;no-cache&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">META</span> <span class="attr">http-equiv</span>=<span class="string">&quot;Expire&quot;</span> <span class="attr">content</span>=<span class="string">&quot;0&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;/webjars/bootstrap/css/bootstrap.min.css&#125;&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">th:src</span>=<span class="string">&quot;@&#123;/webjars/jquery/jquery.min.js&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">th:src</span>=<span class="string">&quot;@&#123;/webjars/bootstrap/js/bootstrap.min.js&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">section</span> <span class="attr">class</span>=<span class="string">&quot;alert alert-warning&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>是否授权[ <span class="tag">&lt;<span class="name">span</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;session.authorizationRequest.clientId&#125;&quot;</span>&gt;</span>clientId<span class="tag">&lt;/<span class="name">span</span>&gt;</span> ]的访问您的资源：<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;alert alert-info&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">&#x27;confirmationForm&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;confirmationForm&#x27;</span> <span class="attr">action</span>=<span class="string">&quot;/oauth/authorize&quot;</span> <span class="attr">method</span>=<span class="string">&#x27;post&#x27;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&quot;user_oauth_approval&quot;</span> <span class="attr">name</span>=<span class="string">&#x27;user_oauth_approval&#x27;</span> <span class="attr">value</span>=<span class="string">&#x27;true&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;hidden&#x27;</span>/&gt;</span></span><br><span class="line">                <span class="comment">&lt;!--授权访问领域--&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">span</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;&#x27;[&#x27;+s+&#x27;]&#x27;&#125;&quot;</span>  <span class="attr">th:each</span>=<span class="string">&quot;s : $&#123;scopeList&#125;&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">class</span>=<span class="string">&quot;btn-success&quot;</span> <span class="attr">id</span>=<span class="string">&quot;authorize&quot;</span> <span class="attr">name</span>=<span class="string">&#x27;authorize&#x27;</span> <span class="attr">value</span>=<span class="string">&#x27;授权&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;submit&#x27;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">class</span>=<span class="string">&quot;btn-primary&quot;</span> <span class="attr">id</span>=<span class="string">&quot;refuse&quot;</span> <span class="attr">name</span>=<span class="string">&#x27;refuse&#x27;</span> <span class="attr">value</span>=<span class="string">&#x27;拒绝&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;button&#x27;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">section</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="javascript"></span></span><br><span class="line"><span class="javascript">    $(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">        $(<span class="string">&quot;#refuse&quot;</span>).click(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">            $(<span class="string">&quot;#user_oauth_approval&quot;</span>).val(<span class="string">&#x27;false&#x27;</span>);</span></span><br><span class="line"><span class="javascript">            $(<span class="string">&quot;#confirmationForm&quot;</span>).submit();</span></span><br><span class="line"><span class="javascript">        &#125;);</span></span><br><span class="line"><span class="javascript">    &#125;);</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="SecurityConfig中开启自定义登录页配置"><a href="#SecurityConfig中开启自定义登录页配置" class="headerlink" title="SecurityConfig中开启自定义登录页配置"></a>SecurityConfig中开启自定义登录页配置</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">http.formLogin()</span><br><span class="line">        .loginPage(<span class="string">&quot;/oauth/login&quot;</span>)</span><br><span class="line">        .loginProcessingUrl(<span class="string">&quot;/login&quot;</span>)</span><br><span class="line">        <span class="comment">//.defaultSuccessUrl(&quot;/&quot;)</span></span><br><span class="line">        .failureForwardUrl(<span class="string">&quot;/oauth/login?error=true&quot;</span>)</span><br><span class="line">        .permitAll(); <span class="comment">//登记界面，默认是permitAll</span></span><br></pre></td></tr></table></figure>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2>至此，一个基于SpringBoot-OAuth2-JWT的认证服务器就搭建好了，如果client-server和resource-server都是基于spring-security-oauth2搭建的，则认证服务器就不需要其它配置了，client-server和resource-server的代码可以参考<br><a href="https://github.com/hanqunfeng/springbootchapter/tree/master/chapter48/oauth2-client-demo">oauth2-client-demo</a>和<a href="https://github.com/hanqunfeng/springbootchapter/tree/master/chapter48/oauth2-resource-server-demo">oauth2-resource-server-demo</a>，不过spring-security-oauth2已经不再维护了，所以建议搭建client-server和resource-server的时候，还是使用springboot官方提供的<code>spring-boot-starter-oauth2-client</code>和<code>spring-boot-starter-oauth2-resource-server</code>，此时还需要为认证服务增加一些功能，这部分留到后面讲解client-server和resource-server的搭建的时候再说。</li>
</ul>
]]></content>
      <categories>
        <category>技术</category>
        <category>springboot2</category>
        <category>Java</category>
      </categories>
      <tags>
        <tag>springboot</tag>
        <tag>oauth2</tag>
        <tag>springsecurity</tag>
        <tag>jwt</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot配置文件属性加密</title>
    <url>/2020/10/27/jasypt-springboot/</url>
    <content><![CDATA[<h2 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h2><ul>
<li><a href="https://github.com/ulisesbocchio/jasypt-spring-boot">jasypt-spring-boot官网</a></li>
<li>本文使用版本：springboot:2.3.4.RELEASE，jasypt-spring-boot-starter:3.0.3</li>
</ul>
<span id="more"></span>

<h2 id="添加依赖"><a href="#添加依赖" class="headerlink" title="添加依赖"></a>添加依赖</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">implementation &#x27;com.github.ulisesbocchio:jasypt-spring-boot-starter:3.0.3&#x27;</span><br></pre></td></tr></table></figure>

<h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">jasypt:</span></span><br><span class="line">  <span class="attr">encryptor:</span></span><br><span class="line">    <span class="comment">#默认加密算法:PBEWITHHMACSHA512ANDAES_256，sha512+AES算法，安全性更高，但是需要 Java JDK 1.9+</span></span><br><span class="line">    <span class="comment">#本服务使用jdk1.8，所以使用 PBEWithMD5AndDES md5+des算法</span></span><br><span class="line">    <span class="comment">#默认使用 com.ulisesbocchio.jasyptspringboot.encryptor.DefaultLazyEncryptor 进行加解密 ，PooledPBEStringEncryptor可以对其加密的内容进行解密</span></span><br><span class="line">    <span class="attr">algorithm:</span> <span class="string">PBEWithMD5AndDES</span></span><br><span class="line">    <span class="comment"># 加密密钥，使用方式 spring.datasource.password=ENC(密文)，不要设置在配置文件中，建议使用环境变量或者启动参数: --jasypt.encryptor.password=123456</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="comment">#设置密文前缀和后缀</span></span><br><span class="line">    <span class="attr">property:</span></span><br><span class="line">      <span class="attr">prefix:</span> <span class="string">ENC(</span></span><br><span class="line">      <span class="attr">suffix:</span> <span class="string">)</span></span><br><span class="line">    <span class="attr">iv-generator-classname:</span> <span class="string">org.jasypt.iv.RandomIvGenerator</span></span><br></pre></td></tr></table></figure>

<h3 id="可用属性"><a href="#可用属性" class="headerlink" title="可用属性"></a>可用属性</h3><table>
<thead>
<tr>
<th>Key</th>
<th>Required</th>
<th>Default Value</th>
</tr>
</thead>
<tbody><tr>
<td>jasypt.encryptor.password</td>
<td>True</td>
<td>-</td>
</tr>
<tr>
<td>jasypt.encryptor.algorithm</td>
<td>False</td>
<td>PBEWITHHMACSHA512ANDAES_256</td>
</tr>
<tr>
<td>jasypt.encryptor.key-obtention-iterations</td>
<td>False</td>
<td>1000</td>
</tr>
<tr>
<td>jasypt.encryptor.pool-size</td>
<td>False</td>
<td>1</td>
</tr>
<tr>
<td>jasypt.encryptor.provider-name</td>
<td>False</td>
<td>SunJCE</td>
</tr>
<tr>
<td>jasypt.encryptor.provider-class-name</td>
<td>False</td>
<td>null</td>
</tr>
<tr>
<td>jasypt.encryptor.salt-generator-classname</td>
<td>False</td>
<td>org.jasypt.salt.RandomSaltGenerator</td>
</tr>
<tr>
<td>jasypt.encryptor.iv-generator-classname</td>
<td>False</td>
<td>org.jasypt.iv.RandomIvGenerator</td>
</tr>
<tr>
<td>jasypt.encryptor.string-output-type</td>
<td>False</td>
<td>base64</td>
</tr>
<tr>
<td>jasypt.encryptor.proxy-property-sources</td>
<td>False</td>
<td>false</td>
</tr>
<tr>
<td>jasypt.encryptor.skip-property-sources</td>
<td>False</td>
<td>empty list</td>
</tr>
</tbody></table>
<h2 id="生成密文"><a href="#生成密文" class="headerlink" title="生成密文"></a>生成密文</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> jar下载地址：https://repo1.maven.org/maven2/org/jasypt/jasypt/1.9.3/jasypt-1.9.3.jar</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 实际上使用maven或者gradle配置jasypt-spring-boot-starter依赖后，这个jar就已经下载到本地仓库了，去本地仓库找找吧</span></span><br><span class="line"><span class="meta">#</span><span class="bash">加密</span></span><br><span class="line">java -cp jasypt-1.9.3.jar org.jasypt.intf.cli.JasyptPBEStringEncryptionCLI password=123456 algorithm=PBEWithMD5AndDES ivGeneratorClassName=org.jasypt.iv.RandomIvGenerator input=newpwd</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">解密</span></span><br><span class="line">java -cp jasypt-1.9.3.jar org.jasypt.intf.cli.JasyptPBEStringDecryptionCLI password=123456 algorithm=PBEWithMD5AndDES ivGeneratorClassName=org.jasypt.iv.RandomIvGenerator input=BwNPdUi+syCTKFj/nlbI5fAtGUKuhN8r</span><br></pre></td></tr></table></figure>

<h2 id="属性加密"><a href="#属性加密" class="headerlink" title="属性加密"></a>属性加密</h2><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="comment">#数据源配置</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/springboot?useUnicode=true&amp;characterEncoding=utf-8&amp;useTimezone=true&amp;serverTimezone=GMT%2B8</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">ENC(BwNPdUi+syCTKFj/nlbI5fAtGUKuhN8r)</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">#配置redis连接</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">ENC(FE4cpSc+2u9NFEY+Q5n9kNSxW6BUiNXGNTUPuhoQbPA=)</span></span><br></pre></td></tr></table></figure>

<h3 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h3><ul>
<li>配置文件将需要加密的属性使用<code>ENC(密文)</code>的方式进行配置，密文前缀和后缀可以在配置文件中进行配置</li>
<li>jasypt-spring-boot-starter在服务运行时会自动对密文进行解密处理</li>
</ul>
<h2 id="密钥传递方式"><a href="#密钥传递方式" class="headerlink" title="密钥传递方式"></a>密钥传递方式</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">1.启动参数</span></span><br><span class="line">java -jar jasypt-spring-boot-demo.jar --jasypt.encryptor.password=password</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">2.系统属性</span></span><br><span class="line">java -Djasypt.encryptor.password=password -jar jasypt-spring-boot-demo.jar</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">3.环境变量</span></span><br><span class="line">jasypt:</span><br><span class="line">    encryptor:</span><br><span class="line">        password: $&#123;JASYPT_ENCRYPTOR_PASSWORD:&#125;</span><br><span class="line"></span><br><span class="line">JASYPT_ENCRYPTOR_PASSWORD=password java -jar jasypt-spring-boot-demo.jar</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">也可以先设置环境变量</span></span><br><span class="line">export JASYPT_ENCRYPTOR_PASSWORD=password</span><br><span class="line">java -jar jasypt-spring-boot-demo.jar</span><br></pre></td></tr></table></figure>

<h2 id="代码中使用Jasypt"><a href="#代码中使用Jasypt" class="headerlink" title="代码中使用Jasypt"></a>代码中使用Jasypt</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 引入jasypt-spring-boot-starter就会自动注入</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> StringEncryptor stringEncryptor;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">StringEncryptor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String encrypt = stringEncryptor.encrypt(<span class="string">&quot;newpwd&quot;</span>);</span><br><span class="line">    System.out.println(encrypt);</span><br><span class="line"></span><br><span class="line">    String decrypt = stringEncryptor.decrypt(encrypt);</span><br><span class="line">    System.out.println(decrypt);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="非springboot项目"><a href="#非springboot项目" class="headerlink" title="非springboot项目"></a>非springboot项目</h2><h3 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">implementation &#x27;org.jasypt:jasypt:1.9.3&#x27;</span><br></pre></td></tr></table></figure>

<h3 id="工具类"><a href="#工具类" class="headerlink" title="工具类"></a>工具类</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.jasypt.encryption.pbe.PooledPBEStringEncryptor;</span><br><span class="line"><span class="keyword">import</span> org.jasypt.encryption.pbe.StandardPBEStringEncryptor;</span><br><span class="line"><span class="keyword">import</span> org.jasypt.encryption.pbe.config.EnvironmentStringPBEConfig;</span><br><span class="line"><span class="keyword">import</span> org.jasypt.encryption.pbe.config.SimpleStringPBEConfig;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;h1&gt;属性加密工具类&lt;/h1&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JasyptUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">encrypt</span><span class="params">(String secretKey, String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> stringEncryptor(secretKey, message, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">decrypt</span><span class="params">(String secretKey, String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> stringEncryptor(secretKey, message, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> StringEncryptor&#125; 加解密。</span></span><br><span class="line"><span class="comment">     * 同一个密钥（secretKey）对同一个内容执行加密，生成的密文都是不一样的，但是根据根据这些密文解密成明文都是可以.</span></span><br><span class="line"><span class="comment">     * 1、Jasypt 默认使用 &#123;<span class="doctag">@link</span> StringEncryptor&#125; 来解密全局配置文件中的属性，所以提供密文时，也需要提供 &#123;<span class="doctag">@link</span> StringEncryptor&#125; 加密的密文</span></span><br><span class="line"><span class="comment">     * 2、&#123;<span class="doctag">@link</span> StringEncryptor&#125; 接口有很多的实现类，比如常用的 &#123;<span class="doctag">@link</span> PooledPBEStringEncryptor&#125;</span></span><br><span class="line"><span class="comment">     * 3、setConfig(final PBEConfig config)：为对象设置 &#123;<span class="doctag">@link</span> PBEConfig&#125; 配置对象</span></span><br><span class="line"><span class="comment">     * 4、encrypt(final String message)：加密内容</span></span><br><span class="line"><span class="comment">     * 5、decrypt(final String encryptedMessage)：解密内容</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> secretKey ：密钥。加/解密必须使用同一个密钥</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message   ：加/解密的内容</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> isEncrypt ：true 表示加密、false 表示解密</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">stringEncryptor</span><span class="params">(String secretKey, String message, <span class="keyword">boolean</span> isEncrypt)</span> </span>&#123;</span><br><span class="line">        PooledPBEStringEncryptor pooledPBEStringEncryptor = <span class="keyword">new</span> PooledPBEStringEncryptor();</span><br><span class="line">        pooledPBEStringEncryptor.setConfig(getSimpleStringPBEConfig(secretKey));</span><br><span class="line">        String result = isEncrypt ? pooledPBEStringEncryptor.encrypt(message) : pooledPBEStringEncryptor.decrypt(message);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置 &#123;<span class="doctag">@link</span> PBEConfig&#125; 配置对象，SimpleStringPBEConfig 是它的实现类</span></span><br><span class="line"><span class="comment">     * 1、所有的配置项建议与全局配置文件中的配置项保持一致，特别是 password、algorithm 等等选项，如果不一致，则应用启动时解密失败而报错.</span></span><br><span class="line"><span class="comment">     * 2、setPassword(final String password)：设置加密密钥，必须与全局配置文件中配置的保存一致，否则应用启动时会解密失败而报错.</span></span><br><span class="line"><span class="comment">     * 3、setPoolSize(final String poolSize)：设置要创建的加密程序池的大小.</span></span><br><span class="line"><span class="comment">     * 4、setAlgorithm(final String algorithm): 设置加密算法的值， 此算法必须由 JCE 提供程序支持</span></span><br><span class="line"><span class="comment">     * 5、setKeyObtentionIterations: 设置应用于获取加密密钥的哈希迭代次数。</span></span><br><span class="line"><span class="comment">     * 6、setProviderName(final String providerName)：设置要请求加密算法的安全提供程序的名称</span></span><br><span class="line"><span class="comment">     * 7、setSaltGeneratorClassName：设置 Sal 发生器</span></span><br><span class="line"><span class="comment">     * 8、setIvGeneratorClassName：设置 IV 发生器</span></span><br><span class="line"><span class="comment">     * 9、setStringOutputType：设置字符串输出的编码形式。可用的编码类型有 base64、hexadecimal</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> secretKey</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> SimpleStringPBEConfig <span class="title">getSimpleStringPBEConfig</span><span class="params">(String secretKey)</span> </span>&#123;</span><br><span class="line">        SimpleStringPBEConfig config = <span class="keyword">new</span> SimpleStringPBEConfig();</span><br><span class="line">        config.setPassword(secretKey);</span><br><span class="line">        config.setAlgorithm(<span class="string">&quot;PBEWithMD5AndDES&quot;</span>);</span><br><span class="line">        <span class="comment">//以下都是默认值</span></span><br><span class="line">        config.setPoolSize(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        config.setKeyObtentionIterations(<span class="string">&quot;1000&quot;</span>);</span><br><span class="line">        config.setProviderName(<span class="string">&quot;SunJCE&quot;</span>);</span><br><span class="line">        config.setSaltGeneratorClassName(<span class="string">&quot;org.jasypt.salt.RandomSaltGenerator&quot;</span>);</span><br><span class="line">        <span class="comment">//命令行执行时要指定这个参数</span></span><br><span class="line">        config.setIvGeneratorClassName(<span class="string">&quot;org.jasypt.iv.RandomIvGenerator&quot;</span>);</span><br><span class="line">        config.setStringOutputType(<span class="string">&quot;base64&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> config;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>技术</category>
        <category>springboot2</category>
      </categories>
      <tags>
        <tag>springboot</tag>
        <tag>yasypt</tag>
      </tags>
  </entry>
  <entry>
    <title>CAS客户端使用SpringSecurity访问CAS发布的属性</title>
    <url>/2020/09/25/springsecurity-cas-attrs/</url>
    <content><![CDATA[<h2 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h2><ul>
<li>CAS服务端基于cas-overlay-template-5.3.14，已实现基于jdbc的自定义登录策略、验证码、动态service配置、多属性返回，等等</li>
<li>CAS客户端基于spring-boot-2.3.3.RELEASE，spring-security-cas-5.3.4.RELEASE</li>
<li>本文代码地址：<a href="https://github.com/hanqunfeng/springbootchapter/tree/master/chapter36">https://github.com/hanqunfeng/springbootchapter/tree/master/chapter36</a></li>
<li>其重点是client的UserDetailsService的实现类要继承自AbstractCasAssertionUserDetailsService</li>
</ul>
<span id="more"></span>

<h2 id="cas服务配置"><a href="#cas服务配置" class="headerlink" title="cas服务配置"></a>cas服务配置</h2><ul>
<li>如果是json配置方式：services目录下需要为每个客户端配置一个json文件，如client1-10000005.json</li>
</ul>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;@class&quot;</span> : <span class="string">&quot;org.apereo.cas.services.RegexRegisteredService&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;serviceId&quot;</span> : <span class="string">&quot;^(https|http|imaps)://localhost:8081.*&quot;</span>, #对应客户端的地址匹配路径</span><br><span class="line">  <span class="attr">&quot;name&quot;</span> : <span class="string">&quot;client1&quot;</span>,  #与文件名称对应</span><br><span class="line">  <span class="attr">&quot;id&quot;</span> : <span class="number">10000005</span>,     #与文件名称对应</span><br><span class="line">  <span class="attr">&quot;description&quot;</span> : <span class="string">&quot;This service definition authorizes all application urls that support HTTPS and IMAPS protocols.&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;evaluationOrder&quot;</span> : <span class="number">10</span>, #顺序id不能重复</span><br><span class="line">  <span class="attr">&quot;logoutType&quot;</span> : <span class="string">&quot;BACK_CHANNEL&quot;</span>, #固定写法</span><br><span class="line">  <span class="attr">&quot;logoutUrl&quot;</span> : <span class="string">&quot;http://localhost:8081/&quot;</span>,  #客户端地址，用于单点登出时通知客户端使用</span><br><span class="line">  <span class="attr">&quot;attributeReleasePolicy&quot;</span>: &#123; # 属性返回策略</span><br><span class="line">    <span class="attr">&quot;@class&quot;</span>: <span class="string">&quot;org.apereo.cas.services.ReturnAllAttributeReleasePolicy&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;accessStrategy&quot;</span> : &#123; #是否允许该客户端访问单点登录，肯定是要开启的啊</span><br><span class="line">    <span class="attr">&quot;@class&quot;</span> : <span class="string">&quot;org.apereo.cas.services.DefaultRegisteredServiceAccessStrategy&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;enabled&quot;</span> : <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">&quot;ssoEnabled&quot;</span> : <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="cas多属性返回"><a href="#cas多属性返回" class="headerlink" title="cas多属性返回"></a>cas多属性返回</h2><ul>
<li>services的json文件中要增加如下配置<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"># 返回全部配置属性</span><br><span class="line"><span class="string">&quot;attributeReleasePolicy&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;@class&quot;</span>: <span class="string">&quot;org.apereo.cas.services.ReturnAllAttributeReleasePolicy&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"># 返回指定配置属性，这里指定只返回username和email两个属性</span><br><span class="line">  <span class="string">&quot;attributeReleasePolicy&quot;</span> : &#123;</span><br><span class="line">  	<span class="attr">&quot;@class&quot;</span> : <span class="string">&quot;org.apereo.cas.services.ReturnAllowedAttributeReleasePolicy&quot;</span>,</span><br><span class="line"> 	<span class="attr">&quot;allowedAttributes&quot;</span> : [ <span class="string">&quot;java.util.ArrayList&quot;</span>, [ <span class="string">&quot;username&quot;</span>, <span class="string">&quot;email&quot;</span> ] ]</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="动态service"><a href="#动态service" class="headerlink" title="动态service"></a>动态service</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">如果使用代码的方式维护service,则也要根据情况来创建返回策略，</span><br><span class="line">参考代码chapter36/cas-overlay-template-5.3.14/src/main/java/com/cas/controller/ServiceController.java</span><br></pre></td></tr></table></figure>

<ul>
<li><p>配置属性</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 动态services配置</span></span><br><span class="line"><span class="comment">################################################</span></span><br><span class="line"><span class="comment"># 开启识别Json文件，默认false</span></span><br><span class="line"><span class="comment"># 这一段表示从json文件里面初始化服务，如果我们配置了这个，就会将这写json里面的数据，都会自动导入到数据库中</span></span><br><span class="line"><span class="meta">cas.serviceRegistry.initFromJson</span>=<span class="string">true</span></span><br><span class="line"><span class="meta">cas.serviceRegistry.watcherEnabled</span>=<span class="string">true</span></span><br><span class="line"><span class="comment">#设置配置的服务，一直都有，不会给清除掉 ， 第一次使用，需要配置为 create-drop</span></span><br><span class="line"><span class="comment">#create-drop 重启cas服务的时候，就会给干掉</span></span><br><span class="line"><span class="comment">#create  没有表就创建，有就不创建</span></span><br><span class="line"><span class="comment">#none 什么也不做</span></span><br><span class="line"><span class="comment">#update 更新</span></span><br><span class="line"><span class="comment">#Unrecognized legacy `hibernate.hbm2ddl.auto` value : create-drops</span></span><br><span class="line"><span class="meta">cas.serviceRegistry.jpa.ddlAuto</span>=<span class="string">update</span></span><br><span class="line"><span class="comment">#配置将service配置到数据库中</span></span><br><span class="line"><span class="meta">cas.serviceRegistry.jpa.isolateInternalQueries</span>=<span class="string">false</span></span><br><span class="line"><span class="meta">cas.serviceRegistry.jpa.url</span>=<span class="string">$&#123;jdbc.url&#125;</span></span><br><span class="line"><span class="meta">cas.serviceRegistry.jpa.user</span>=<span class="string">$&#123;jdbc.username&#125;</span></span><br><span class="line"><span class="meta">cas.serviceRegistry.jpa.password</span>=<span class="string">$&#123;jdbc.password&#125;</span></span><br><span class="line"><span class="comment">#这个必须是org.hibernate.dialect.MySQL5Dialect ,我就是这个问题导致表创建失败</span></span><br><span class="line"><span class="meta">cas.serviceRegistry.jpa.dialect</span>=<span class="string">org.hibernate.dialect.MySQL5Dialect</span></span><br><span class="line"><span class="meta">cas.serviceRegistry.jpa.driverClass</span>=<span class="string">$&#123;jdbc.driver&#125;</span></span><br><span class="line"><span class="meta">cas.serviceRegistry.jpa.leakThreshold</span>=<span class="string">10</span></span><br><span class="line"><span class="meta">cas.serviceRegistry.jpa.batchSize</span>=<span class="string">1</span></span><br><span class="line"><span class="meta">cas.serviceRegistry.jpa.autocommit</span>=<span class="string">true</span></span><br><span class="line"><span class="meta">cas.serviceRegistry.jpa.idleTimeout</span>=<span class="string">5000</span></span><br><span class="line"><span class="comment">#配置结束</span></span><br><span class="line"><span class="comment">################################################</span></span><br></pre></td></tr></table></figure></li>
<li><p>这里说一下delete异常的问题，可以引入jdbcTemplate直接操作数据表，参考chapter36/cas-overlay-template-5.3.14/src/main/java/com/cas/config/DataSourceConfig.java</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;Map&lt;String, Object&gt;&gt; list = jdbcTemplate.queryForList(<span class="string">&quot;select * from regexregisteredservice where serviceId = &#x27;&quot;</span> + serviceId + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (list != <span class="keyword">null</span> &amp;&amp; list.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    has_data = <span class="keyword">true</span>;</span><br><span class="line">    jdbcTemplate.update(<span class="string">&quot;delete from regexregisteredservice where serviceId = &#x27;&quot;</span> + serviceId + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">//执行load生效</span></span><br><span class="line"> servicesManager.load();</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="基于配置文件返回属性"><a href="#基于配置文件返回属性" class="headerlink" title="基于配置文件返回属性"></a>基于配置文件返回属性</h2><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment">#####################################################</span></span><br><span class="line"><span class="comment">## 属性返回</span></span><br><span class="line"><span class="meta">cas.authn.attributeRepository.jdbc[0].sql</span>=<span class="string">select username,password,email from cas_user where username=?</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 格式cas.authn.attributeRepository.jdbc[0].attributes.key=value</span></span><br><span class="line"><span class="comment"># 返回上面查询结果的username，属性key名称也为username ,以下雷同</span></span><br><span class="line"><span class="meta">cas.authn.attributeRepository.jdbc[0].attributes.username</span>=<span class="string">username</span></span><br><span class="line"><span class="meta">cas.authn.attributeRepository.jdbc[0].attributes.password</span>=<span class="string">password</span></span><br><span class="line"><span class="meta">cas.authn.attributeRepository.jdbc[0].attributes.email</span>=<span class="string">email</span></span><br><span class="line"></span><br><span class="line"><span class="meta">cas.authn.attributeRepository.jdbc[0].singleRow</span>=<span class="string">true</span></span><br><span class="line"><span class="meta">cas.authn.attributeRepository.jdbc[0].order</span>=<span class="string">0</span></span><br><span class="line"><span class="meta">cas.authn.attributeRepository.jdbc[0].requireAllAttributes</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"># cas.authn.attributeRepository.jdbc[0].caseCanonicalization=NONE|LOWER|UPPER</span></span><br><span class="line"><span class="comment"># cas.authn.attributeRepository.jdbc[0].queryType=OR|AND</span></span><br><span class="line"></span><br><span class="line"><span class="meta">cas.authn.attributeRepository.jdbc[0].username</span>=<span class="string">username</span></span><br><span class="line"><span class="comment">#数据库连接</span></span><br><span class="line"><span class="meta">cas.authn.attributeRepository.jdbc[0].url</span>=<span class="string">$&#123;jdbc.url&#125;</span></span><br><span class="line"><span class="comment">#数据库dialect配置</span></span><br><span class="line"><span class="meta">cas.authn.attributeRepository.jdbc[0].dialect</span>=<span class="string">$&#123;jdbc.dialect&#125;</span></span><br><span class="line"><span class="comment">#数据库用户名</span></span><br><span class="line"><span class="meta">cas.authn.attributeRepository.jdbc[0].user</span>=<span class="string">$&#123;jdbc.username&#125;</span></span><br><span class="line"><span class="comment">#数据库用户密码</span></span><br><span class="line"><span class="meta">cas.authn.attributeRepository.jdbc[0].password</span>=<span class="string">$&#123;jdbc.password&#125;</span></span><br><span class="line"><span class="comment">#数据库事务自动提交</span></span><br><span class="line"><span class="meta">cas.authn.attributeRepository.jdbc[0].autocommit</span>=<span class="string">true</span></span><br><span class="line"><span class="comment">#数据库驱动</span></span><br><span class="line"><span class="meta">cas.authn.attributeRepository.jdbc[0].driverClass</span>=<span class="string">$&#123;jdbc.driver&#125;</span></span><br><span class="line"><span class="comment">#超时配置</span></span><br><span class="line"><span class="meta">cas.authn.attributeRepository.jdbc[0].idleTimeout</span>=<span class="string">5000</span></span><br><span class="line"><span class="meta">cas.authn.attributeRepository.jdbc[0].ddlAuto</span>=<span class="string">none</span></span><br><span class="line"><span class="meta">cas.authn.attributeRepository.jdbc[0].leakThreshold</span>=<span class="string">10</span></span><br><span class="line"><span class="meta">cas.authn.attributeRepository.jdbc[0].batchSize</span>=<span class="string">1</span></span><br><span class="line"><span class="meta">cas.authn.attributeRepository.jdbc[0].dataSourceProxy</span>=<span class="string">false</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#####################################################</span></span><br></pre></td></tr></table></figure>

<h2 id="代码实现返回属性内容"><a href="#代码实现返回属性内容" class="headerlink" title="代码实现返回属性内容"></a>代码实现返回属性内容</h2><ul>
<li>这个需要结合自定义登录策略来实现，代码参考：chapter36/cas-overlay-template-5.3.14/src/main/java/com/cas/security/CustomerHandlerAuthentication.java，注意要关闭配置文件的登录策略，否则会失效</li>
<li>注册自定义登录策略，代码参考：chapter36/cas-overlay-template-5.3.14/src/main/java/com/cas/config/CustomAuthenticationConfig.java</li>
<li>然后将其加入自动配置中,chapter36/cas-overlay-template-5.3.14/src/main/resources/META-INF/spring.factories<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">org.springframework.boot.autoconfigure.EnableAutoConfiguration</span>=<span class="string">\</span></span><br><span class="line"><span class="string">  org.apereo.cas.config.CasEmbeddedContainerTomcatConfiguration,\</span></span><br><span class="line"><span class="string">  org.apereo.cas.config.CasEmbeddedContainerTomcatFiltersConfiguration,\</span></span><br><span class="line"><span class="string">  com.cas.config.MyConfiguration,\ #自定义的其它需要加入spring上下文的bean</span></span><br><span class="line">  <span class="attr">com.cas.config.DataSourceConfig,\ #数据源配置，为了引入JdbcTemplate</span></span><br><span class="line">  <span class="meta">com.cas.config.CustomAuthenticationConfig,\ </span> <span class="string">#自定义登录策略配置</span></span><br><span class="line">  <span class="meta">com.cas.config.CustomerAuthWebflowConfiguration</span> <span class="string">#自定义登录流程配置</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="cas-client-springsecurity"><a href="#cas-client-springsecurity" class="headerlink" title="cas-client-springsecurity"></a>cas-client-springsecurity</h2><ul>
<li><p>这里说一下，如果不使用springsecurity，而是直接依赖cas-client，其获取cas返回属性的方式</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Principal principal = request.getUserPrincipal();</span><br><span class="line"><span class="keyword">if</span>(principal <span class="keyword">instanceof</span> AttributePrincipal)&#123;</span><br><span class="line">    <span class="comment">//cas传递过来的数据</span></span><br><span class="line">    Map&lt;String,Object&gt; result =( (AttributePrincipal)principal).getAttributes();</span><br><span class="line">    <span class="keyword">for</span>(Map.Entry&lt;String, Object&gt; entry :result.entrySet()) &#123;</span><br><span class="line">        String key = entry.getKey();</span><br><span class="line">        Object val = entry.getValue();</span><br><span class="line">        System.out.printf(<span class="string">&quot;%s:%s\r\n&quot;</span>,key,val);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>使用springsecurity的配置类代码参考：chapter36/springsecurity-client-demo/src/main/java/com/example/springsecuritydemo/config/WebSecurityConfigByCASByAttrs.java</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * cas 认证 Provider</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CasAuthenticationProvider <span class="title">casAuthenticationProvider</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//创建CAS授权认证器</span></span><br><span class="line">        CasAuthenticationProvider casAuthenticationProvider = <span class="keyword">new</span> CasAuthenticationProvider();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置Cas授权认证器相关配置</span></span><br><span class="line">        casAuthenticationProvider.setServiceProperties(serviceProperties());</span><br><span class="line">        <span class="comment">//设置票据校验器</span></span><br><span class="line">        casAuthenticationProvider.setTicketValidator(cas30ServiceTicketValidator());</span><br><span class="line">        casAuthenticationProvider.setKey(<span class="string">&quot;casAuthenticationProviderKey&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//setUserDetailsService和setAuthenticationUserDetailsService只能设置一个，其目的都是为了初始化属性authenticationUserDetailsService</span></span><br><span class="line">        <span class="comment">//setUserDetailsService的类型为UserDetailsService</span></span><br><span class="line">        <span class="comment">//setAuthenticationUserDetailsService的类型为AuthenticationUserDetailsService&lt;CasAssertionAuthenticationToken&gt;</span></span><br><span class="line">        <span class="comment">// 如果使用setUserDetailsService，则其会对UserDetailsService进行封装，new UserDetailsByNameServiceWrapper(userDetailsService)，</span></span><br><span class="line">        <span class="comment">// 将其转换为AuthenticationUserDetailsService&lt;CasAssertionAuthenticationToken&gt;类型</span></span><br><span class="line">        <span class="comment">//这里使用setAuthenticationUserDetailsService是为了接收cas服务端返回的属性，因为CasAssertionAuthenticationToken会接收到返回的属性</span></span><br><span class="line">        casAuthenticationProvider.setAuthenticationUserDetailsService(userDetailsServiceImplByAttrs());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> casAuthenticationProvider;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDetailsServiceImplByAttrs <span class="title">userDetailsServiceImplByAttrs</span><span class="params">()</span></span>&#123;</span><br><span class="line">        UserDetailsServiceImplByAttrs userDetailsServiceImplByAttrs = <span class="keyword">new</span> UserDetailsServiceImplByAttrs();</span><br><span class="line">        <span class="keyword">return</span> userDetailsServiceImplByAttrs;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>UserDetailsServiceImplByAttrs的重点就是要继承AbstractCasAssertionUserDetailsService，而不是实现UserDetailsService</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//实际可以接收的属性</span></span><br><span class="line">Map&lt;String, Object&gt; objectMap = assertion.getPrincipal().getAttributes();</span><br></pre></td></tr></table></figure></li>
<li><p>这里说一下AbstractCasAssertionUserDetailsService，它有一个实现类GrantedAuthorityFromAssertionAttributesUserDetailsService<br>不过其将返回数据都做为用户的权限了，所以其只是用来从服务器端获取用户权限使用</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">CasAuthenticationToken principal = (CasAuthenticationToken) request.getUserPrincipal();</span><br><span class="line">UserDetails userDetails = principal.getUserDetails();</span><br><span class="line">Collection&lt;SimpleGrantedAuthority&gt; authorities = (Collection&lt;SimpleGrantedAuthority&gt;) userDetails.getAuthorities();</span><br><span class="line">authorities.stream().forEach(System.out::println);</span><br></pre></td></tr></table></figure></li>
<li><p>如果希望灵活使用cas返回属性，则需要自定义实现类，笔者这里将获取到的属性map存储到自定义的CustomerUser属性中了</p>
</li>
<li><p>代码中使用属性</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">#获取登录的用户名称</span><br><span class="line">String username = request.getRemoteUser();</span><br><span class="line">#获取cas返回属性</span><br><span class="line">CasAuthenticationToken principal = (CasAuthenticationToken) request.getUserPrincipal();</span><br><span class="line">UserDetails userDetails = principal.getUserDetails();</span><br><span class="line"><span class="keyword">if</span>(userDetails <span class="keyword">instanceof</span> CustomerUser)&#123;</span><br><span class="line">    Map&lt;String, Object&gt; map = ((CustomerUser) userDetails).getMap();</span><br><span class="line">    <span class="keyword">for</span> (String key : map.keySet()) &#123;</span><br><span class="line">        Object value = map.get(key);</span><br><span class="line">        <span class="keyword">if</span> (value != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (value <span class="keyword">instanceof</span> List) &#123;</span><br><span class="line">                List list = (List) value;</span><br><span class="line">                Iterator iterator = list.iterator();</span><br><span class="line">                <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">                    Object object = iterator.next();</span><br><span class="line">                    System.out.println(<span class="string">&quot;key:&quot;</span> + key + <span class="string">&quot;,values[&quot;</span> + i + <span class="string">&quot;]:&quot;</span> + object.toString());</span><br><span class="line">                    i++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;key:&quot;</span> + key + <span class="string">&quot;,value:&quot;</span> + value.toString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
]]></content>
      <categories>
        <category>技术</category>
        <category>springboot2</category>
        <category>Java</category>
      </categories>
      <tags>
        <tag>cas</tag>
      </tags>
  </entry>
  <entry>
    <title>AAAAOrder2020-0000001之面试题</title>
    <url>/2020/09/03/mysql100w-delete2/</url>
    <content><![CDATA[<h2 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h2><ul>
<li>本文内容基于10.4.8-MariaDB</li>
</ul>
<div class="note info"><p>Q: 假设一个订单的编号规则是AAAAOrder2020-0000001，AAAAOrder2020-0000002…后面的数字是自增长，如果订单号码达到AAAAOrder2020-1000000(100万)，数据库中应该有100万条数据，此时我随机删除2条数据（物理删除，且不考虑日志和备份），请问怎么找到删掉的数据的编号？给出解题思路即可，答案需要在1秒内运行得到。</p>
</div>
<span id="more"></span>

<h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><div class="note info"><ol>
<li>其实查找丢失数据方法有很多，不过这里重点强调1秒内运行得到，就限制成了只能在数据库层面完成，实现方法基本上就是sql或者存储过程，而且要尽量减少表的扫描次数和扫描范围、尽可能的使用索引。</li>
<li>订单编号的序号是自增长，所以可以认为数据是按照编号自增的顺序插入数据表的,如果数据表存在单独的自增主键Id，则可以基于错位法得到缺失的主键Id，这样可以使用主键索引，而且主键自增索引的查询效率是最高的。</li>
<li>如果没有独立的主键Id，而是使用的orderId作为主键，则需要对orderId截断后进行比较，查询条件一定要使用完整的orderId，以便使用索引，也可以使用行号和截断后的订单编号进行比较的方法。具体实现见下文。</li>
</ol>
</div>

<h2 id="参考答案，作者水平有限，仅供学习交流"><a href="#参考答案，作者水平有限，仅供学习交流" class="headerlink" title="参考答案，作者水平有限，仅供学习交流"></a>参考答案，作者水平有限，仅供学习交流</h2><div class="note info"><ol>
<li>存在自增主键Id，与orderId序号一致，可以通过错位法计算不存在的Id值。<br>运行时间基本符合要求。</li>
</ol>
</div>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> id<span class="number">-1</span> <span class="keyword">as</span> id_del <span class="keyword">from</span> test_order <span class="keyword">where</span> id <span class="keyword">not</span> <span class="keyword">in</span> (<span class="keyword">select</span> id<span class="operator">+</span><span class="number">1</span> <span class="keyword">from</span> test_order);</span><br><span class="line"><span class="operator">+</span><span class="comment">--------+</span></span><br><span class="line"><span class="operator">|</span> id_del <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">233490</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">943220</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">0</span> <span class="operator">|</span>  #这里去除<span class="number">0</span>号记录，因为不存在id为<span class="number">0</span>的记录</span><br><span class="line"><span class="operator">+</span><span class="comment">--------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">1.063</span> sec)</span><br></pre></td></tr></table></figure>


<div class="note info"><ol start="2">
<li>如果不存在自增主键ID，而是使用orderId作为主键，则也可以通过错位法计算不存在的Id值，主要比较时一定要用完整的orderId，否则不能使用索引。<br>运行时间超过要求。</li>
</ol>
</div>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">RIGHT</span>(orderId, <span class="number">7</span>) <span class="operator">-</span> <span class="number">1</span> <span class="keyword">AS</span> id_del <span class="keyword">FROM</span> test_order</span><br><span class="line">  <span class="keyword">WHERE</span> orderId <span class="keyword">NOT</span> <span class="keyword">in</span>(</span><br><span class="line">    <span class="keyword">SELECT</span> concat( <span class="keyword">left</span>(orderId, <span class="number">14</span>), LPAD( <span class="keyword">RIGHT</span>(orderId, <span class="number">7</span>) <span class="operator">+</span> <span class="number">1</span>, <span class="number">7</span>, <span class="number">0</span>))</span><br><span class="line">    <span class="keyword">FROM</span> test_order);</span><br><span class="line"><span class="operator">+</span><span class="comment">--------+</span></span><br><span class="line"><span class="operator">|</span> id_del <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">0</span> <span class="operator">|</span>   #这里去除<span class="number">0</span>号记录，因为不存在id为<span class="number">0</span>的记录</span><br><span class="line"><span class="operator">|</span> <span class="number">233490</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">943220</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">2.999</span> sec)</span><br></pre></td></tr></table></figure>


<div class="note info"><ol start="3">
<li>如果不存在自增主键ID，而是使用orderId作为主键，也可以比较orderId的序号与行号，获取到不一致的第一条记录，然后在从该记录开始继续比较获得下一条不一致的记录，也可以通过存储过程实现。<br>运行时间符合要求。</li>
</ol>
</div>

<h3 id="sql示例1"><a href="#sql示例1" class="headerlink" title="sql示例1"></a>sql示例1</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查询第一条丢失记录</span></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">substring</span>(a.orderId,<span class="number">15</span>)<span class="number">-1</span> <span class="keyword">as</span> orderId <span class="keyword">from</span> (</span><br><span class="line">     <span class="keyword">SELECT</span> <span class="variable">@rownum</span>:<span class="operator">=</span><span class="variable">@rownum</span><span class="operator">+</span><span class="number">1</span> <span class="keyword">AS</span> rownum, test_order.orderId  <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> <span class="variable">@rownum</span>:<span class="operator">=</span><span class="number">0</span>) r, test_order</span><br><span class="line">     ) a <span class="keyword">where</span> <span class="built_in">substring</span>(a.orderId,<span class="number">15</span>) <span class="operator">!=</span> a.rownum limit <span class="number">1</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------+</span></span><br><span class="line"><span class="operator">|</span> orderId <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">233490</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.341</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 将上面查询结果作为第二条sql的参数，这里上一条查询结果为 233490，所以下面手工填写对应的值，</span></span><br><span class="line"><span class="comment">-- 这里因为limit不能写变量，所以需要手工填写，如果希望一次执行，可以参考后面的sql示例2和存储过程示例</span></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">substring</span>(a.orderId,<span class="number">15</span>)<span class="number">-1</span> <span class="keyword">as</span> orderId <span class="keyword">from</span> (</span><br><span class="line">     <span class="keyword">SELECT</span> <span class="variable">@rownum</span>:<span class="operator">=</span><span class="variable">@rownum</span><span class="operator">+</span><span class="number">1</span> <span class="keyword">AS</span> rownum, test_order.orderId  <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> <span class="variable">@rownum</span>:<span class="operator">=</span><span class="number">0</span>) r, test_order</span><br><span class="line">     limit <span class="number">233489</span>,<span class="number">1000000</span></span><br><span class="line">     ) a <span class="keyword">where</span> <span class="built_in">substring</span>(a.orderId,<span class="number">15</span>)<span class="number">-233490</span> <span class="operator">!=</span> a.rownum limit <span class="number">1</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------+</span></span><br><span class="line"><span class="operator">|</span> orderId <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">943220</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.372</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 验证是否准确</span></span><br><span class="line"><span class="keyword">select</span> orderId <span class="keyword">from</span> test_order limit <span class="number">233488</span>,<span class="number">2</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------+</span></span><br><span class="line"><span class="operator">|</span> orderId              <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------+</span></span><br><span class="line"><span class="operator">|</span> aaaaorder2020<span class="number">-233489</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> aaaaorder2020<span class="number">-233491</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.036</span> sec)</span><br></pre></td></tr></table></figure>

<h3 id="sql示例2"><a href="#sql示例2" class="headerlink" title="sql示例2"></a>sql示例2</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 可以直接粘贴到mysql终端执行，也可以保存到文件，然后在mysql终端执行source /xx/xx/xx.sql</span></span><br><span class="line"><span class="comment">-- 这里修改定界符，就是为了方便看到一个总的执行时间</span></span><br><span class="line">delimiter ;;</span><br><span class="line"><span class="keyword">select</span> <span class="built_in">substring</span>(a.orderId,<span class="number">15</span>)<span class="number">-1</span> <span class="keyword">as</span> orderId <span class="keyword">into</span> <span class="variable">@first</span>_order_id <span class="keyword">from</span> (</span><br><span class="line">     <span class="keyword">SELECT</span> <span class="variable">@rownum</span>:<span class="operator">=</span><span class="variable">@rownum</span><span class="operator">+</span><span class="number">1</span> <span class="keyword">AS</span> rownum, test_order.orderId  <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> <span class="variable">@rownum</span>:<span class="operator">=</span><span class="number">0</span>) r, test_order</span><br><span class="line">     ) a <span class="keyword">where</span> <span class="built_in">substring</span>(a.orderId,<span class="number">15</span>) <span class="operator">!=</span> a.rownum limit <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> <span class="variable">@second</span>_limit <span class="operator">=</span> <span class="variable">@first</span>_order_id <span class="operator">-</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> <span class="variable">@limitsql</span> <span class="operator">=</span> CONCAT( <span class="string">&#x27;SELECT @rownum:=@rownum+1 AS rownum, test_order.orderId  FROM (SELECT @rownum:=0) r, test_order</span></span><br><span class="line"><span class="string">limit &#x27;</span>, <span class="variable">@second</span>_limit, <span class="string">&#x27;,1000000&#x27;</span> );</span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> <span class="variable">@SQL</span> <span class="operator">=</span> CONCAT( <span class="string">&#x27;select substring(a.orderId,15)-1 as orderId into @second_order_id from (&#x27;</span>, <span class="variable">@limitsql</span>, <span class="string">&#x27;</span></span><br><span class="line"><span class="string">) a where substring(a.orderId,15)-&#x27;</span>, <span class="variable">@first</span>_order_id, <span class="string">&#x27; != a.rownum limit 1&#x27;</span> );</span><br><span class="line"></span><br><span class="line"><span class="keyword">PREPARE</span> stmt <span class="keyword">FROM</span> <span class="variable">@SQL</span>;</span><br><span class="line"><span class="keyword">EXECUTE</span> stmt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> <span class="variable">@del</span>_ids <span class="operator">=</span> concat( <span class="variable">@first</span>_order_id, <span class="string">&#x27;,&#x27;</span>, <span class="variable">@second</span>_order_id );</span><br><span class="line">;;</span><br><span class="line">delimiter ;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="variable">@del</span>_ids;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">source <span class="operator">/</span>Users<span class="operator">/</span>hanqf<span class="operator">/</span>Desktop<span class="operator">/</span>exec.sql</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.710</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.710</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.710</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.710</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.710</span> sec)</span><br><span class="line">Statement prepared</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.710</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.710</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="variable">@del</span>_ids      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">233490</span>,<span class="number">943220</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.000</span> sec)</span><br></pre></td></tr></table></figure>

<h3 id="存储过程示例"><a href="#存储过程示例" class="headerlink" title="存储过程示例"></a>存储过程示例</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">PROCEDURE</span> IF <span class="keyword">EXISTS</span> find_delete_order_id;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> `find_delete_order_id`(<span class="keyword">OUT</span> del_ids <span class="type">varchar</span>(<span class="number">255</span>))</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">  <span class="keyword">DECLARE</span> first_order_id <span class="type">INT</span>;</span><br><span class="line">  <span class="keyword">DECLARE</span> second_order_id <span class="type">INT</span>;</span><br><span class="line">  <span class="keyword">DECLARE</span> second_limit <span class="type">INT</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">select</span> <span class="built_in">substring</span>(a.orderId,<span class="number">15</span>)<span class="number">-1</span> <span class="keyword">as</span> orderId <span class="keyword">into</span> first_order_id <span class="keyword">from</span> (</span><br><span class="line">     <span class="keyword">SELECT</span> <span class="variable">@rownum</span>:<span class="operator">=</span><span class="variable">@rownum</span><span class="operator">+</span><span class="number">1</span> <span class="keyword">AS</span> rownum, test_order.orderId  <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> <span class="variable">@rownum</span>:<span class="operator">=</span><span class="number">0</span>) r, test_order</span><br><span class="line">     ) a <span class="keyword">where</span> <span class="built_in">substring</span>(a.orderId,<span class="number">15</span>) <span class="operator">!=</span> a.rownum limit <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">set</span> second_limit <span class="operator">=</span> first_order_id<span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">select</span> <span class="built_in">substring</span>(a.orderId,<span class="number">15</span>)<span class="number">-1</span> <span class="keyword">as</span> orderId <span class="keyword">into</span> second_order_id <span class="keyword">from</span> (</span><br><span class="line">     <span class="keyword">SELECT</span> <span class="variable">@rownum</span>:<span class="operator">=</span><span class="variable">@rownum</span><span class="operator">+</span><span class="number">1</span> <span class="keyword">AS</span> rownum, test_order.orderId  <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> <span class="variable">@rownum</span>:<span class="operator">=</span><span class="number">0</span>) r, test_order</span><br><span class="line">     limit second_limit,<span class="number">1000000</span></span><br><span class="line">     ) a <span class="keyword">where</span> <span class="built_in">substring</span>(a.orderId,<span class="number">15</span>)<span class="operator">-</span>first_order_id <span class="operator">!=</span> a.rownum limit <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">set</span> del_ids <span class="operator">=</span> concat(first_order_id,<span class="string">&#x27;,&#x27;</span>,second_order_id);</span><br><span class="line">  <span class="comment">-- 此处为了方便测试，所以在存储过程中就打印了结果</span></span><br><span class="line">  <span class="keyword">select</span> del_ids;</span><br><span class="line"></span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CALL</span> `find_delete_order_id`(<span class="variable">@del</span>_ids);</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+</span></span><br><span class="line"><span class="operator">|</span> del_ids       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">233490</span>,<span class="number">943220</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.704</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">2</span> <span class="keyword">rows</span> affected (<span class="number">0.704</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="variable">@del</span>_ids;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="variable">@del</span>_ids      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">233490</span>,<span class="number">943220</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.000</span> sec)</span><br></pre></td></tr></table></figure>

<h2 id="表结构"><a href="#表结构" class="headerlink" title="表结构"></a>表结构</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `test_order`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `test_order` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `orderId` <span class="type">varchar</span>(<span class="number">30</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `index_order_id` (`orderId`) <span class="keyword">USING</span> HASH</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">1</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br></pre></td></tr></table></figure>

<h2 id="数据初始化"><a href="#数据初始化" class="headerlink" title="数据初始化"></a>数据初始化</h2><div class="note info"><p>说明：</p>
<ol>
<li><p>直接将100w的数据插入数据表有点慢，实测130多秒吧，这里可以先将数据初始化到内存表中，然后再从内存表导入即可，总时间大概只需要12秒左右。</p>
</li>
<li><p>因为数据都是写入内存中，所以写入数据时可能会报内存不足，解决方法如下：<br>a.永久修改，在my.cnf中增加如下配置:<br> tmp_table_size=1G<br> max_heap_table_size=1G</p>
<p>b.临时修改,mysql终端执行：<br> set tmp_table_size = 1073741824;<br> set max_heap_table_size = 1073741824;<br> show variables like “%table_size%”;</p>
</li>
</ol>
</div>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 创建内存表，重启数据库后，内存表中的数据会被清空，但是表结构依旧存在，不需要时可以drop掉</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `test_order_memory`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `test_order_memory` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `orderId` <span class="type">varchar</span>(<span class="number">30</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `index_order_id` (`orderId`) <span class="keyword">USING</span> HASH</span><br><span class="line">) ENGINE<span class="operator">=</span>MEMORY AUTO_INCREMENT<span class="operator">=</span><span class="number">1</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 初始化内存表</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">PROCEDURE</span> IF <span class="keyword">EXISTS</span> add_test_order_memory;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> `add_test_order_memory`(<span class="keyword">IN</span> n <span class="type">int</span>)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">  <span class="keyword">DECLARE</span> i <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">1</span>;</span><br><span class="line">    WHILE (i <span class="operator">&lt;=</span> n ) DO</span><br><span class="line">      <span class="keyword">INSERT</span> <span class="keyword">INTO</span> test_order_memory (orderId) <span class="keyword">VALUES</span> (concat(<span class="string">&#x27;aaaaorder2020-&#x27;</span>,LPAD(i, <span class="number">7</span>, <span class="number">0</span>)));</span><br><span class="line">      <span class="keyword">set</span> i<span class="operator">=</span>i<span class="operator">+</span><span class="number">1</span>;</span><br><span class="line">    <span class="keyword">END</span> WHILE;</span><br><span class="line"><span class="keyword">END</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 创建1000000条数据</span></span><br><span class="line"><span class="keyword">call</span> add_test_order_memory(<span class="number">1000000</span>);</span><br><span class="line">Query OK, <span class="number">1000000</span> <span class="keyword">rows</span> affected (<span class="number">7.354</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 将内存表中数据导入实际表中</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">into</span> test_order <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">from</span>  test_order_memory;</span><br><span class="line">Query OK, <span class="number">1000000</span> <span class="keyword">rows</span> affected (<span class="number">5.035</span> sec)</span><br><span class="line">Records: <span class="number">1000000</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看结果</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test_order limit <span class="number">5</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-----------------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> orderId               <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-----------------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> aaaaorder2020<span class="number">-0000001</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> aaaaorder2020<span class="number">-0000002</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">3</span> <span class="operator">|</span> aaaaorder2020<span class="number">-0000003</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">4</span> <span class="operator">|</span> aaaaorder2020<span class="number">-0000004</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">5</span> <span class="operator">|</span> aaaaorder2020<span class="number">-0000005</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-----------------------+</span></span><br><span class="line"><span class="number">5</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.000</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除两条数据，这里就随便填两个id号</span></span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> test_order <span class="keyword">where</span> id <span class="keyword">in</span> (<span class="number">233490</span>,<span class="number">943220</span>);</span><br><span class="line">Query OK, <span class="number">2</span> <span class="keyword">rows</span> affected (<span class="number">0.001</span> sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>技术</category>
      </categories>
      <tags>
        <tag>mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot动态更新外部属性文件</title>
    <url>/2020/04/17/spring-boot-ExternalPropertiesRefresh/</url>
    <content><![CDATA[<h2 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h2><ul>
<li>本文内容基于springboot2.2.6</li>
<li>SpringBoot可以通过<code>@PropertySource(value = &quot;file:demo.properties&quot;)</code>的方式加载外部配置文件，这样打好jar包后只要将这个属性文件放到相同路径即可</li>
<li>如果能够在不重启服务的情况下就可以重新加载这个属性文件，就可以很方便的实现动态更新，那么要怎么做呢？</li>
<li>github：<a href="https://github.com/hanqunfeng/springbootchapter/tree/master/chapter27">https://github.com/hanqunfeng/springbootchapter/tree/master/chapter27</a></li>
</ul>
<span id="more"></span>

<h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><div class="note info"><p>SpringCloud可以通过config组件实现配置的动态加载，我们也可以将数据存在数据库或者缓存中，可是如果只是一个小项目，不想依赖任何中间件，那么就可以通过如下的方式实现。</p>
</div>

<ul>
<li>获取所有注解了<code>@PropertySource</code>的对象，并且获取其value属性数组中是以<code>file:</code>开头的文件路径</li>
<li>判断是否同时注解了<code>@ConfigurationProperties</code>，并且获取其<code>prefix</code>的值</li>
<li>对每个属性文件进行遍历，通过反射找到对象的field名称（去除<code>prefix</code>后的名字），并将属性值赋值给该field</li>
</ul>
<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><div class="note info"><p>这个类要注册到spring上下文，并在需要的地方调用该对象的refresh方法即可重新加载所有外部属性文件。</p>
</div>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.SneakyThrows;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.config.ConfigurableListableBeanFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.PropertySource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.FileSystemResource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.support.PropertiesLoaderUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Annotation;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;动态加载外部属性处理类&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExternalPropertiesRefresh</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ConfigurableListableBeanFactory configurableListableBeanFactory;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;根据属性名获取属性值&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fieldName bean的属性名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> object    bean对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> java.lang.Object get方法返回值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> hanqf</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Object <span class="title">getFieldValueByName</span><span class="params">(String fieldName, Object object)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String firstLetter = fieldName.substring(<span class="number">0</span>, <span class="number">1</span>).toUpperCase();</span><br><span class="line">            String getter = <span class="string">&quot;get&quot;</span> + firstLetter + fieldName.substring(<span class="number">1</span>);</span><br><span class="line">            Method method = object.getClass().getMethod(getter, <span class="keyword">new</span> Class[]&#123;&#125;);</span><br><span class="line">            Object value = method.invoke(object, <span class="keyword">new</span> Object[]&#123;&#125;);</span><br><span class="line">            <span class="keyword">return</span> value;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(e.getMessage(), e);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;根据属性名设置属性值&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fieldName  bean的属性名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> object     bean对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> paramTypes set方法参数类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> params     set方法参数值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> hanqf</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setFieldValueByName</span><span class="params">(String fieldName, Object object, Class[] paramTypes, Object[] params)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String firstLetter = fieldName.substring(<span class="number">0</span>, <span class="number">1</span>).toUpperCase();</span><br><span class="line">            String setter = <span class="string">&quot;set&quot;</span> + firstLetter + fieldName.substring(<span class="number">1</span>);</span><br><span class="line">            Method method = object.getClass().getMethod(setter, paramTypes);</span><br><span class="line">            method.invoke(object, params);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;获取属性名称，去除前缀&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   属性key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> prefix 属性key前缀</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> java.lang.String</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> hanqf</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">fieldName</span><span class="params">(String key, String prefix)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(prefix)) &#123;</span><br><span class="line">            <span class="keyword">return</span> key.replace(prefix + <span class="string">&quot;.&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;将属性文件值绑定到bean对象&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bean</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> properties</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> prefix</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> hanqf</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Object <span class="title">bind</span><span class="params">(Object bean, Properties[] properties, String prefix)</span> </span>&#123;</span><br><span class="line">        String fieldName = <span class="string">&quot;&quot;</span>;<span class="comment">//属性名称</span></span><br><span class="line">        String pValue = <span class="string">&quot;&quot;</span>;<span class="comment">//属性值</span></span><br><span class="line">        String[] sp = <span class="keyword">null</span>; <span class="comment">//map属性分割key和value</span></span><br><span class="line">        <span class="keyword">for</span> (Properties pro : properties) &#123;</span><br><span class="line">            Map&lt;String, Map&lt;String, String&gt;&gt; fidleMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">            Map&lt;String, Set&lt;String&gt;&gt; fidleSet = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">            Map&lt;String, List&lt;String&gt;&gt; fidleList = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">            <span class="comment">//遍历属性</span></span><br><span class="line">            <span class="keyword">for</span> (Object key : pro.keySet()) &#123;</span><br><span class="line">                pValue = (String) (pro.get(key));</span><br><span class="line">                fieldName = fieldName((String) key, prefix);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//map</span></span><br><span class="line">                sp = fieldName.split(<span class="string">&quot;\\.&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (sp.length == <span class="number">2</span>) &#123;</span><br><span class="line">                    fieldName = sp[<span class="number">0</span>];</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//list&amp;&amp;set</span></span><br><span class="line">                <span class="keyword">if</span> (fieldName.indexOf(<span class="string">&quot;[&quot;</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    fieldName = fieldName.substring(<span class="number">0</span>, fieldName.indexOf(<span class="string">&quot;[&quot;</span>));</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//属性类型</span></span><br><span class="line">                Object object = getFieldValueByName(fieldName, bean);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//类型匹配</span></span><br><span class="line">                <span class="keyword">if</span> (object <span class="keyword">instanceof</span> Map) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (fidleMap.get(fieldName) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        object = fidleMap.get(fieldName);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        object = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (sp.length == <span class="number">2</span>) &#123;</span><br><span class="line">                        ((Map) object).put(sp[<span class="number">1</span>], pValue);</span><br><span class="line">                        fidleMap.put(fieldName, (Map&lt;String, String&gt;) object);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (object <span class="keyword">instanceof</span> Set) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (fidleSet.get(fieldName) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        object = fidleSet.get(fieldName);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        object = <span class="keyword">new</span> HashSet&lt;String&gt;();</span><br><span class="line">                    &#125;</span><br><span class="line">                    ((Set) object).add(pValue);</span><br><span class="line">                    fidleSet.put(fieldName, (Set&lt;String&gt;) object);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (object <span class="keyword">instanceof</span> List) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (fidleList.get(fieldName) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        object = fidleList.get(fieldName);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        object = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">                    &#125;</span><br><span class="line">                    ((List) object).add(pValue);</span><br><span class="line">                    fidleList.put(fieldName, (List&lt;String&gt;) object);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (object <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">                    setFieldValueByName(fieldName, bean, <span class="keyword">new</span> Class[]&#123;String.class&#125;, <span class="keyword">new</span> Object[]&#123;pValue&#125;);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (object <span class="keyword">instanceof</span> Integer) &#123;</span><br><span class="line">                    setFieldValueByName(fieldName, bean, <span class="keyword">new</span> Class[]&#123;Integer.class&#125;, <span class="keyword">new</span> Object[]&#123;Integer.valueOf(pValue)&#125;);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (object <span class="keyword">instanceof</span> Long) &#123;</span><br><span class="line">                    setFieldValueByName(fieldName, bean, <span class="keyword">new</span> Class[]&#123;Long.class&#125;, <span class="keyword">new</span> Object[]&#123;Long.valueOf(pValue)&#125;);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (object <span class="keyword">instanceof</span> Double) &#123;</span><br><span class="line">                    setFieldValueByName(fieldName, bean, <span class="keyword">new</span> Class[]&#123;Double.class&#125;, <span class="keyword">new</span> Object[]&#123;Double.valueOf(pValue)&#125;);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (object <span class="keyword">instanceof</span> Float) &#123;</span><br><span class="line">                    setFieldValueByName(fieldName, bean, <span class="keyword">new</span> Class[]&#123;Float.class&#125;, <span class="keyword">new</span> Object[]&#123;Float.valueOf(pValue)&#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//map类型赋值</span></span><br><span class="line">            <span class="keyword">if</span> (fidleMap.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (String fname : fidleMap.keySet()) &#123;</span><br><span class="line">                    setFieldValueByName(fname, bean, <span class="keyword">new</span> Class[]&#123;Map.class&#125;, <span class="keyword">new</span> Object[]&#123;fidleMap.get(fname)&#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//set类型赋值</span></span><br><span class="line">            <span class="keyword">if</span> (fidleSet.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (String fname : fidleSet.keySet()) &#123;</span><br><span class="line">                    setFieldValueByName(fname, bean, <span class="keyword">new</span> Class[]&#123;Set.class&#125;, <span class="keyword">new</span> Object[]&#123;fidleSet.get(fname)&#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//list类型赋值</span></span><br><span class="line">            <span class="keyword">if</span> (fidleList.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (String fname : fidleList.keySet()) &#123;</span><br><span class="line">                    setFieldValueByName(fname, bean, <span class="keyword">new</span> Class[]&#123;List.class&#125;, <span class="keyword">new</span> Object[]&#123;fidleList.get(fname)&#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;刷新指定属性类&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> hanqf</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> beanName bean的注册名称，默认类名称首字母小写</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">refresh</span><span class="params">(String beanName)</span></span>&#123;</span><br><span class="line">        Class&lt;?&gt; cls = configurableListableBeanFactory.getType(beanName);</span><br><span class="line">        Object bean = configurableListableBeanFactory.getBean(cls);</span><br><span class="line">        Properties[] propertiesArray = <span class="keyword">null</span>;</span><br><span class="line">        String prefix = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (cls.getAnnotations() != <span class="keyword">null</span> &amp;&amp; cls.getAnnotations().length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Annotation annotation : cls.getAnnotations()) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (annotation <span class="keyword">instanceof</span> PropertySource) &#123;</span><br><span class="line">                    PropertySource propertySource = (PropertySource) annotation;</span><br><span class="line">                    String[] values = propertySource.value();</span><br><span class="line">                    <span class="keyword">if</span> (values.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        propertiesArray = <span class="keyword">new</span> Properties[values.length];</span><br><span class="line">                        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; values.length; i++) &#123;</span><br><span class="line">                            <span class="comment">//如果引用的是外部文件，则重新加载</span></span><br><span class="line">                            <span class="keyword">if</span> (values[i].startsWith(<span class="string">&quot;file:&quot;</span>)) &#123;</span><br><span class="line">                                String path = values[i].replace(<span class="string">&quot;file:&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">                                Properties properties = PropertiesLoaderUtils.loadProperties(<span class="keyword">new</span> FileSystemResource(path));</span><br><span class="line">                                propertiesArray[i] = properties;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (annotation <span class="keyword">instanceof</span> ConfigurationProperties) &#123;</span><br><span class="line">                    ConfigurationProperties configurationProperties = (ConfigurationProperties) annotation;</span><br><span class="line">                    prefix = configurationProperties.prefix();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (propertiesArray != <span class="keyword">null</span> &amp;&amp; propertiesArray.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//将属性绑定到对象</span></span><br><span class="line">            bind(bean, propertiesArray, prefix);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;重新加载属性文件&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> hanqf</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">refresh</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String[] ary = configurableListableBeanFactory.getBeanNamesForAnnotation(PropertySource.class);</span><br><span class="line">        <span class="keyword">if</span> (ary != <span class="keyword">null</span> &amp;&amp; ary.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (String beanName : ary) &#123;</span><br><span class="line">                <span class="comment">//通过Spring的beanName获取bean的类型</span></span><br><span class="line">                refresh(beanName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="下面通过http请求刷新配置文件"><a href="#下面通过http请求刷新配置文件" class="headerlink" title="下面通过http请求刷新配置文件"></a>下面通过http请求刷新配置文件</h2><div class="note info"><p>启动服务器后，任意修改属性文件的值，然后请求/refresh，即可重新加载全部属性文件，然后请求/demo查看是否生效，也可以请求/propertiesDemo/refresh，指定要刷新的对象。</p>
</div>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ExternalPropertiesRefresh externalPropertiesRefresh;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PropertiesDemo propertiesDemo;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/refresh&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">refreshpro</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        externalPropertiesRefresh.refresh();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;refresh properties success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/&#123;beanName&#125;/refresh&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">refreshProByBeanName</span><span class="params">(<span class="meta">@PathVariable</span> String beanName)</span> </span>&#123;</span><br><span class="line">        externalPropertiesRefresh.refresh(beanName);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;refresh properties success for &quot;</span> + beanName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/demo&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PropertiesDemo <span class="title">demo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> propertiesDemo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="PropertiesDemo-java"><a href="#PropertiesDemo-java" class="headerlink" title="PropertiesDemo.java"></a>PropertiesDemo.java</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@PropertySource(value = &quot;file:demo.properties&quot;,encoding = &quot;utf-8&quot;)</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;demo.data&quot;)</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PropertiesDemo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, String&gt; map2 = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> Set&lt;String&gt; set = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> Set&lt;String&gt; set2 = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; list2 = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> Double salary;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="demo-properties"><a href="#demo-properties" class="headerlink" title="demo.properties"></a>demo.properties</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">demo.data.map.client=client</span><br><span class="line">demo.data.map.token=token</span><br><span class="line"></span><br><span class="line">demo.data.map2.client=client</span><br><span class="line">demo.data.map2.token=token</span><br><span class="line"></span><br><span class="line">demo.data.name=张三</span><br><span class="line">demo.data.age=<span class="number">20</span></span><br><span class="line">demo.data.salary=<span class="number">12345.67</span></span><br><span class="line"></span><br><span class="line">demo.data.set[<span class="number">0</span>]=beijing</span><br><span class="line">demo.data.set[<span class="number">1</span>]=shanghai</span><br><span class="line">demo.data.set[<span class="number">2</span>]=tianjin</span><br><span class="line"></span><br><span class="line">demo.data.set2[<span class="number">0</span>]=guangzhou</span><br><span class="line">demo.data.set2[<span class="number">1</span>]=shenzheng</span><br><span class="line">demo.data.set2[<span class="number">2</span>]=hangzhou</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">demo.data.list[<span class="number">0</span>]=南极</span><br><span class="line">demo.data.list[<span class="number">1</span>]=北极</span><br><span class="line">demo.data.list[<span class="number">2</span>]=赤道</span><br><span class="line"></span><br><span class="line">demo.data.list2[<span class="number">0</span>]=喜马拉雅山</span><br><span class="line">demo.data.list2[<span class="number">1</span>]=噶麦斯山</span><br><span class="line">demo.data.list2[<span class="number">2</span>]=阿尔卑斯山</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>技术</category>
        <category>springboot2</category>
        <category>Java</category>
      </categories>
      <tags>
        <tag>springboot</tag>
      </tags>
  </entry>
  <entry>
    <title>HttpClient、OkHttp、RestTemplate、WebClient的基本使用</title>
    <url>/2020/04/18/http-utils/</url>
    <content><![CDATA[<h2 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h2><ul>
<li>本文内容基于org.apache.httpcomponents:httpclient:4.5.12，com.squareup.okhttp3:okhttp:4.5.0，springboot:2.2.6.RELEASE，spring-boot-starter-webflux:2.2.6.RELEASE</li>
<li>工具类，实现get/post[参数，json，输入流，文件，gzip]等方法</li>
<li>提供了测试用例及服务端demo</li>
<li>github：<a href="https://github.com/hanqunfeng/springbootchapter/tree/master/chapter26">https://github.com/hanqunfeng/springbootchapter/tree/master/chapter26</a></li>
</ul>
<span id="more"></span>
<h2 id="HttpClientUtil"><a href="#HttpClientUtil" class="headerlink" title="HttpClientUtil"></a>HttpClientUtil</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.SneakyThrows;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.Header;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.HttpEntity;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.HttpResponse;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.NameValuePair;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.client.config.RequestConfig;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.client.entity.UrlEncodedFormEntity;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.client.methods.CloseableHttpResponse;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.client.methods.HttpGet;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.client.methods.HttpPost;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.client.methods.HttpRequestBase;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.client.utils.URIBuilder;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.concurrent.FutureCallback;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.entity.ByteArrayEntity;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.entity.ContentType;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.entity.StringEntity;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.entity.mime.MultipartEntityBuilder;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.impl.client.CloseableHttpClient;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.impl.client.DefaultHttpRequestRetryHandler;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.impl.client.HttpClientBuilder;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.impl.nio.client.CloseableHttpAsyncClient;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.impl.nio.client.HttpAsyncClients;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.message.BasicNameValuePair;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.util.EntityUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.net.URI;</span><br><span class="line"><span class="keyword">import</span> java.net.URLEncoder;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.zip.GZIPInputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.zip.GZIPOutputStream;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;HttpClient工具类&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * Created by hanqf on 2020/4/18 14:54.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpClientUtil</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 配置信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> RequestConfig requestConfig = RequestConfig.custom()</span><br><span class="line">            <span class="comment">// 设置连接超时时间(单位毫秒)</span></span><br><span class="line">            .setConnectTimeout(<span class="number">5000</span>)</span><br><span class="line">            <span class="comment">// 设置请求超时时间(单位毫秒)</span></span><br><span class="line">            .setConnectionRequestTimeout(<span class="number">5000</span>)</span><br><span class="line">            <span class="comment">// socket读写超时时间(单位毫秒)</span></span><br><span class="line">            .setSocketTimeout(<span class="number">5000</span>)</span><br><span class="line">            <span class="comment">// 设置是否允许重定向(默认为true)</span></span><br><span class="line">            .setRedirectsEnabled(<span class="keyword">true</span>)</span><br><span class="line">            <span class="comment">//是否启用内容压缩，默认true</span></span><br><span class="line">            .setContentCompressionEnabled(<span class="keyword">true</span>)</span><br><span class="line">            .build();</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获得Http客户端</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> CloseableHttpClient HTTP_CLIENT = HttpClientBuilder.create()</span><br><span class="line">            .setRetryHandler(<span class="keyword">new</span> DefaultHttpRequestRetryHandler()) <span class="comment">//失败重试，默认3次</span></span><br><span class="line">            .build();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 异步Http客户端</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> CloseableHttpAsyncClient HTTP_ASYNC_CLIENT = HttpAsyncClients.custom()</span><br><span class="line">            .setDefaultRequestConfig(requestConfig)</span><br><span class="line">            .build();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;异步请求&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> httpRequestBase</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> hanqf</span></span><br><span class="line"><span class="comment">     * 2020/4/22 21:16</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">executeAsync</span><span class="params">(HttpRequestBase httpRequestBase)</span> </span>&#123;</span><br><span class="line">        HTTP_ASYNC_CLIENT.start();</span><br><span class="line">        HTTP_ASYNC_CLIENT.execute(httpRequestBase, <span class="keyword">new</span> FutureCallback&lt;HttpResponse&gt;() &#123;</span><br><span class="line">            <span class="meta">@SneakyThrows</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">completed</span><span class="params">(HttpResponse httpResponse)</span> </span>&#123;</span><br><span class="line">                log.info(<span class="string">&quot; callback thread id is : &quot;</span> + Thread.currentThread().getId());</span><br><span class="line">                log.info(httpRequestBase.getRequestLine() + <span class="string">&quot;-&gt;&quot;</span> + httpResponse.getStatusLine());</span><br><span class="line"></span><br><span class="line">                StringBuffer stringBuffer = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">                <span class="keyword">for</span> (Header header : httpRequestBase.getAllHeaders()) &#123;</span><br><span class="line">                    stringBuffer.append(header.toString()).append(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                log.info(String.format(<span class="string">&quot;请求头信息: [%s]&quot;</span>, stringBuffer.toString()));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                String responseResult = <span class="keyword">null</span>;</span><br><span class="line">                HttpEntity responseEntity = httpResponse.getEntity();</span><br><span class="line">                log.debug(<span class="string">&quot;响应状态为:&quot;</span> + httpResponse.getStatusLine());</span><br><span class="line">                <span class="keyword">if</span> (responseEntity != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    responseResult = EntityUtils.toString(responseEntity, StandardCharsets.UTF_8);</span><br><span class="line">                    log.info(<span class="string">&quot;响应内容为:&quot;</span> + responseResult);</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                stringBuffer = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">                <span class="keyword">for</span> (Header header : httpResponse.getAllHeaders()) &#123;</span><br><span class="line">                    stringBuffer.append(header.toString()).append(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                log.info(String.format(<span class="string">&quot;响应头信息: [%s]&quot;</span>, stringBuffer.toString()));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">failed</span><span class="params">(Exception e)</span> </span>&#123;</span><br><span class="line">                log.info(<span class="string">&quot; callback thread id is : &quot;</span> + Thread.currentThread().getId());</span><br><span class="line">                log.info(<span class="string">&quot;Get responseResult：&quot;</span>, e);</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancelled</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                log.info(httpRequestBase.getRequestLine() + <span class="string">&quot; cancelled&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;请求的执行方法，需要提前封装好httpRequestBase对象，如请求url和请求参数&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> httpRequestBase</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> java.lang.String</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> hanqf</span></span><br><span class="line"><span class="comment">     * 2020/4/18 22:08</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">execute</span><span class="params">(HttpRequestBase httpRequestBase)</span> </span>&#123;</span><br><span class="line">        log.info(String.format(<span class="string">&quot;请求地址: [%s]&quot;</span>, httpRequestBase.getURI().toString()));</span><br><span class="line">        log.info(String.format(<span class="string">&quot;请求类型: [%s]&quot;</span>, httpRequestBase.getMethod()));</span><br><span class="line"></span><br><span class="line">        StringBuffer stringBuffer = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        <span class="keyword">for</span> (Header header : httpRequestBase.getAllHeaders()) &#123;</span><br><span class="line">            stringBuffer.append(header.toString()).append(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(String.format(<span class="string">&quot;请求头信息: [%s]&quot;</span>, stringBuffer.toString()));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        log.info(String.format(<span class="string">&quot;请求参数: [%s]&quot;</span>, httpRequestBase.getURI().getQuery()));</span><br><span class="line"></span><br><span class="line">        String responseResult = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// 响应模型</span></span><br><span class="line">        CloseableHttpResponse response = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 将上面的配置信息 运用到这个Get请求里</span></span><br><span class="line">            httpRequestBase.setConfig(requestConfig);</span><br><span class="line">            <span class="keyword">long</span> t1 = System.nanoTime();<span class="comment">//请求发起的时间</span></span><br><span class="line">            response = HTTP_CLIENT.execute(httpRequestBase);</span><br><span class="line">            <span class="comment">// 从响应模型中获取响应实体</span></span><br><span class="line">            HttpEntity responseEntity = response.getEntity();</span><br><span class="line">            log.debug(<span class="string">&quot;响应状态为:&quot;</span> + response.getStatusLine());</span><br><span class="line">            <span class="keyword">long</span> t2 = System.nanoTime();<span class="comment">//收到响应的时间</span></span><br><span class="line">            <span class="keyword">if</span> (responseEntity != <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">                responseResult = EntityUtils.toString(responseEntity, StandardCharsets.UTF_8);</span><br><span class="line"></span><br><span class="line">                log.debug(<span class="string">&quot;响应内容为:&quot;</span> + responseResult);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            stringBuffer = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">            <span class="keyword">for</span> (Header header : response.getAllHeaders()) &#123;</span><br><span class="line">                stringBuffer.append(header.toString()).append(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            log.info(String.format(<span class="string">&quot;响应头信息: [%s]&quot;</span>, stringBuffer.toString()));</span><br><span class="line"></span><br><span class="line">            log.info(String.format(<span class="string">&quot;执行时间: [%.1fms]&quot;</span>, (t2 - t1) / <span class="number">1e6d</span>));</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;Get responseResult：&quot;</span>, e);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (response != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    response.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> responseResult;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;请求的执行方法，需要提前封装好httpRequestBase对象，如请求url和请求参数&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> httpRequestBase</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> byte[]</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> hanqf</span></span><br><span class="line"><span class="comment">     * 2020/4/29 13:33</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] executeBytes(HttpRequestBase httpRequestBase) &#123;</span><br><span class="line">        log.info(String.format(<span class="string">&quot;请求地址: [%s]&quot;</span>, httpRequestBase.getURI().toString()));</span><br><span class="line">        log.info(String.format(<span class="string">&quot;请求类型: [%s]&quot;</span>, httpRequestBase.getMethod()));</span><br><span class="line">        StringBuffer stringBuffer = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        <span class="keyword">for</span> (Header header : httpRequestBase.getAllHeaders()) &#123;</span><br><span class="line">            stringBuffer.append(header.toString()).append(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(String.format(<span class="string">&quot;请求头信息: [%s]&quot;</span>, stringBuffer.toString()));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        log.info(String.format(<span class="string">&quot;请求参数: [%s]&quot;</span>, httpRequestBase.getURI().getQuery()));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[] bytes = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// 响应模型</span></span><br><span class="line">        CloseableHttpResponse response = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 将上面的配置信息 运用到这个Get请求里</span></span><br><span class="line">            httpRequestBase.setConfig(requestConfig);</span><br><span class="line">            <span class="keyword">long</span> t1 = System.nanoTime();<span class="comment">//请求发起的时间</span></span><br><span class="line">            response = HTTP_CLIENT.execute(httpRequestBase);</span><br><span class="line">            <span class="comment">// 从响应模型中获取响应实体</span></span><br><span class="line">            HttpEntity responseEntity = response.getEntity();</span><br><span class="line">            log.debug(<span class="string">&quot;响应状态为:&quot;</span> + response.getStatusLine());</span><br><span class="line">            <span class="keyword">long</span> t2 = System.nanoTime();<span class="comment">//收到响应的时间</span></span><br><span class="line">            <span class="keyword">if</span> (responseEntity != <span class="keyword">null</span>) &#123;</span><br><span class="line">                bytes = EntityUtils.toByteArray(responseEntity);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//判断是否需要解压，即服务器返回是否经过了gzip压缩--start</span></span><br><span class="line">                Header responseHeader = response.getFirstHeader(<span class="string">&quot;Content-Encoding&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (responseHeader != <span class="keyword">null</span> &amp;&amp; responseHeader.getValue().contains(<span class="string">&quot;gzip&quot;</span>)) &#123;</span><br><span class="line">                    GZIPInputStream gzipInputStream = <span class="keyword">null</span>;</span><br><span class="line">                    ByteArrayOutputStream out = <span class="keyword">null</span>;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        gzipInputStream = <span class="keyword">new</span> GZIPInputStream(<span class="keyword">new</span> ByteArrayInputStream(bytes));</span><br><span class="line">                        out = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">                        <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">                        <span class="keyword">int</span> offset = -<span class="number">1</span>;</span><br><span class="line">                        <span class="keyword">while</span> ((offset = gzipInputStream.read(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                            out.write(buffer, <span class="number">0</span>, offset);</span><br><span class="line">                        &#125;</span><br><span class="line">                        bytes = out.toByteArray();</span><br><span class="line"></span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            gzipInputStream.close();</span><br><span class="line">                            out.close();</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                            e.printStackTrace();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//判断是否需要解压，即服务器返回是否经过了gzip压缩--end</span></span><br><span class="line"></span><br><span class="line">                log.debug(<span class="string">&quot;响应byte长度:&quot;</span> + bytes.length);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            stringBuffer = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">            <span class="keyword">for</span> (Header header : response.getAllHeaders()) &#123;</span><br><span class="line">                stringBuffer.append(header.toString()).append(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            log.info(String.format(<span class="string">&quot;响应头信息: [%s]&quot;</span>, stringBuffer.toString()));</span><br><span class="line"></span><br><span class="line">            log.info(String.format(<span class="string">&quot;执行时间: [%.1fms]&quot;</span>, (t2 - t1) / <span class="number">1e6d</span>));</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;Get responseResult：&quot;</span>, e);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (response != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    response.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bytes;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;get请求&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url 请求地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> java.lang.String 响应结果</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> hanqf</span></span><br><span class="line"><span class="comment">     * 2020/4/18 15:57</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">get</span><span class="params">(String url)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> get(url, <span class="keyword">new</span> HashMap&lt;&gt;());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;get请求&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url 请求地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> java.lang.String 响应结果</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> hanqf</span></span><br><span class="line"><span class="comment">     * 2020/4/18 15:49</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">get</span><span class="params">(String url, Map&lt;String, Object&gt; params)</span> </span>&#123;</span><br><span class="line">        HttpGet httpGet = <span class="keyword">null</span>;</span><br><span class="line">        List&lt;NameValuePair&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (String key : params.keySet()) &#123;</span><br><span class="line">            list.add(<span class="keyword">new</span> BasicNameValuePair(key, params.get(key).toString()));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 由客户端执行(发送)Get请求</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            URI uri = <span class="keyword">new</span> URIBuilder(url).addParameters(list).build();</span><br><span class="line">            <span class="comment">// 创建Get请求</span></span><br><span class="line">            httpGet = <span class="keyword">new</span> HttpGet(uri);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;Get responseResult：&quot;</span>, e);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> execute(httpGet);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;get请求，返回字节数组&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> params</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> byte[]</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> hanqf</span></span><br><span class="line"><span class="comment">     * 2020/4/29 13:35</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] getBytes(String url, Map&lt;String, Object&gt; params) &#123;</span><br><span class="line">        HttpGet httpGet = <span class="keyword">null</span>;</span><br><span class="line">        List&lt;NameValuePair&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (String key : params.keySet()) &#123;</span><br><span class="line">            list.add(<span class="keyword">new</span> BasicNameValuePair(key, params.get(key).toString()));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 由客户端执行(发送)Get请求</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            URI uri = <span class="keyword">new</span> URIBuilder(url).addParameters(list).build();</span><br><span class="line">            <span class="comment">// 创建Get请求</span></span><br><span class="line">            httpGet = <span class="keyword">new</span> HttpGet(uri);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;Get responseResult：&quot;</span>, e);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> executeBytes(httpGet);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;post请求&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url 请求地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> java.lang.String 响应结果</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> hanqf</span></span><br><span class="line"><span class="comment">     * 2020/4/18 15:54</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">post</span><span class="params">(String url)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> post(url, <span class="keyword">new</span> HashMap&lt;&gt;());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;post请求&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url    请求地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> params 请求参数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> java.lang.String 响应结果</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> hanqf</span></span><br><span class="line"><span class="comment">     * 2020/4/18 15:50</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">post</span><span class="params">(String url, Map&lt;String, Object&gt; params)</span> </span>&#123;</span><br><span class="line">        HttpPost httpPost = <span class="keyword">null</span>;</span><br><span class="line">        List&lt;NameValuePair&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (String key : params.keySet()) &#123;</span><br><span class="line">            list.add(<span class="keyword">new</span> BasicNameValuePair(key, params.get(key).toString()));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            URI uri = <span class="keyword">new</span> URIBuilder(url).addParameters(list).build();</span><br><span class="line">            httpPost = <span class="keyword">new</span> HttpPost(uri);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;Get responseResult：&quot;</span>, e);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> execute(httpPost);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;post请求，返回字节数组&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> params</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> byte[]</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> hanqf</span></span><br><span class="line"><span class="comment">     * 2020/4/29 13:35</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] postBytes(String url, Map&lt;String, Object&gt; params) &#123;</span><br><span class="line">        HttpPost httpPost = <span class="keyword">null</span>;</span><br><span class="line">        List&lt;NameValuePair&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (String key : params.keySet()) &#123;</span><br><span class="line">            list.add(<span class="keyword">new</span> BasicNameValuePair(key, params.get(key).toString()));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            URI uri = <span class="keyword">new</span> URIBuilder(url).addParameters(list).build();</span><br><span class="line">            httpPost = <span class="keyword">new</span> HttpPost(uri);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;Get responseResult：&quot;</span>, e);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> executeBytes(httpPost);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;post请求，请求体为json&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url  请求地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> json 请求json</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> java.lang.String 响应结果</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> hanqf</span></span><br><span class="line"><span class="comment">     * 2020/4/18 16:02</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">postJson</span><span class="params">(String url, String json)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> postJson(url, json, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;post请求，请求体为json&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url  请求地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> json 请求json</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> gzip 是否开启gzip压缩</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> java.lang.String 响应结果</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> hanqf</span></span><br><span class="line"><span class="comment">     * 2020/4/18 16:02</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">postJson</span><span class="params">(String url, String json, <span class="keyword">boolean</span> gzip)</span> </span>&#123;</span><br><span class="line">        HttpPost httpPost = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            URI uri = <span class="keyword">new</span> URIBuilder(url).build();</span><br><span class="line">            httpPost = <span class="keyword">new</span> HttpPost(uri);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// post请求是将参数放在请求体里面传过去的,这里将entity放入post请求体中</span></span><br><span class="line"></span><br><span class="line">            httpPost.setHeader(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/json;charset=utf8&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (gzip) &#123;</span><br><span class="line">                httpPost.setHeader(<span class="string">&quot;Content-Encoding&quot;</span>, <span class="string">&quot;gzip&quot;</span>);</span><br><span class="line">                ByteArrayOutputStream originalContent = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">                originalContent.write(json.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">                ByteArrayOutputStream baos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">                GZIPOutputStream gzipOut = <span class="keyword">new</span> GZIPOutputStream(baos);</span><br><span class="line">                originalContent.writeTo(gzipOut);</span><br><span class="line">                gzipOut.finish();</span><br><span class="line">                httpPost.setEntity(<span class="keyword">new</span> ByteArrayEntity(baos</span><br><span class="line">                        .toByteArray(), ContentType.create(<span class="string">&quot;text/plain&quot;</span>, <span class="string">&quot;utf-8&quot;</span>)));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                StringEntity entity = <span class="keyword">new</span> StringEntity(json, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">                httpPost.setEntity(entity);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;Get responseResult：&quot;</span>, e);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> execute(httpPost);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;post请求，请求参数中有中文的话可以使用这个请求&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url    请求地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> params 请求参数，只可以为中文</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> java.lang.String</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> hanqf</span></span><br><span class="line"><span class="comment">     * 2020/4/18 16:30</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">postForm</span><span class="params">(String url, Map&lt;String, Object&gt; params)</span> </span>&#123;</span><br><span class="line">        HttpPost httpPost = <span class="keyword">null</span>;</span><br><span class="line">        List&lt;NameValuePair&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (String key : params.keySet()) &#123;</span><br><span class="line">            list.add(<span class="keyword">new</span> BasicNameValuePair(key, params.get(key).toString()));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            UrlEncodedFormEntity urlEncodedFormEntity = <span class="keyword">new</span> UrlEncodedFormEntity(list, StandardCharsets.UTF_8);</span><br><span class="line">            URI uri = <span class="keyword">new</span> URIBuilder(url).build();</span><br><span class="line">            httpPost = <span class="keyword">new</span> HttpPost(uri);</span><br><span class="line">            httpPost.setHeader(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/x-www-form-urlencoded&quot;</span>);</span><br><span class="line">            httpPost.setEntity(urlEncodedFormEntity);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;Get responseResult：&quot;</span>, e);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> execute(httpPost);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;post请求，输入流&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url   请求地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bytes 请求输入流</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> java.lang.String</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> hanqf</span></span><br><span class="line"><span class="comment">     * 2020/4/18 16:37</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">postInputBytes</span><span class="params">(String url, <span class="keyword">byte</span>[] bytes)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> postInputBytes(url, bytes, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;post请求，输入流&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url   请求地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bytes 请求输入流</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> gzip  是否开启gzip压缩</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> java.lang.String</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> hanqf</span></span><br><span class="line"><span class="comment">     * 2020/4/18 16:37</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">postInputBytes</span><span class="params">(String url, <span class="keyword">byte</span>[] bytes, <span class="keyword">boolean</span> gzip)</span> </span>&#123;</span><br><span class="line">        HttpPost httpPost = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            URI uri = <span class="keyword">new</span> URIBuilder(url).build();</span><br><span class="line">            httpPost = <span class="keyword">new</span> HttpPost(uri);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// post请求是将参数放在请求体里面传过去的,这里将entity放入post请求体中</span></span><br><span class="line">            <span class="keyword">if</span> (gzip) &#123;</span><br><span class="line">                httpPost.setHeader(<span class="string">&quot;Content-Encoding&quot;</span>, <span class="string">&quot;gzip&quot;</span>);</span><br><span class="line">                ByteArrayOutputStream originalContent = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">                originalContent.write(bytes);</span><br><span class="line">                ByteArrayOutputStream baos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">                GZIPOutputStream gzipOut = <span class="keyword">new</span> GZIPOutputStream(baos);</span><br><span class="line">                originalContent.writeTo(gzipOut);</span><br><span class="line">                gzipOut.finish();</span><br><span class="line">                httpPost.setEntity(<span class="keyword">new</span> ByteArrayEntity(baos</span><br><span class="line">                        .toByteArray(), ContentType.create(<span class="string">&quot;text/plain&quot;</span>, <span class="string">&quot;utf-8&quot;</span>)));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ByteArrayEntity entity = <span class="keyword">new</span> ByteArrayEntity(bytes, ContentType.create(<span class="string">&quot;text/plain&quot;</span>, <span class="string">&quot;utf-8&quot;</span>));</span><br><span class="line">                httpPost.setEntity(entity);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;Get responseResult：&quot;</span>, e);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> execute(httpPost);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;post请求，流&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> is</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> java.lang.String</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> hanqf</span></span><br><span class="line"><span class="comment">     * 2020/4/21 22:24</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">postInputStream</span><span class="params">(String url, InputStream is)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> postInputStream(url, is, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;post请求，流&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> is</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> gzip</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> java.lang.String</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> hanqf</span></span><br><span class="line"><span class="comment">     * 2020/4/21 22:24</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">postInputStream</span><span class="params">(String url, InputStream is, <span class="keyword">boolean</span> gzip)</span> </span>&#123;</span><br><span class="line">        ByteArrayOutputStream byteArrayOutputStream = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="keyword">int</span> ch;</span><br><span class="line">        <span class="keyword">byte</span>[] bytes = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> ((ch = is.read(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                byteArrayOutputStream.write(buffer, <span class="number">0</span>, ch);</span><br><span class="line">            &#125;</span><br><span class="line">            bytes = byteArrayOutputStream.toByteArray();</span><br><span class="line">            byteArrayOutputStream.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> postInputBytes(url, bytes, gzip);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;post请求，传输附件&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url   请求地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> files 文件列表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> java.lang.String</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> hanqf</span></span><br><span class="line"><span class="comment">     * 2020/4/18 16:52</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">postFile</span><span class="params">(String url, File[] files)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> postFile(url, <span class="keyword">new</span> HashMap&lt;&gt;(), files);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;post请求，传输附件&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url    请求地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> params 其它参数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> files  文件列表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> java.lang.String</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> hanqf</span></span><br><span class="line"><span class="comment">     * 2020/4/18 16:50</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">postFile</span><span class="params">(String url, Map&lt;String, Object&gt; params, File[] files)</span> </span>&#123;</span><br><span class="line">        HttpPost httpPost = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            URI uri = <span class="keyword">new</span> URIBuilder(url).build();</span><br><span class="line">            httpPost = <span class="keyword">new</span> HttpPost(uri);</span><br><span class="line"></span><br><span class="line">            MultipartEntityBuilder multipartEntityBuilder = MultipartEntityBuilder.create();</span><br><span class="line">            String filesKey = <span class="string">&quot;files&quot;</span>;</span><br><span class="line">            <span class="keyword">for</span> (File file : files) &#123;</span><br><span class="line">                <span class="comment">//multipartEntityBuilder.addPart(filesKey,new FileBody(file)); //与下面的语句作用相同</span></span><br><span class="line">                <span class="comment">//multipartEntityBuilder.addBinaryBody(filesKey, file);</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// 防止服务端收到的文件名乱码。 我们这里可以先将文件名URLEncode，然后服务端拿到文件名时在URLDecode。就能避免乱码问题。</span></span><br><span class="line">                <span class="comment">// 文件名其实是放在请求头的Content-Disposition里面进行传输的，如其值为form-data; name=&quot;files&quot;; filename=&quot;头像.jpg&quot;</span></span><br><span class="line">                multipartEntityBuilder.addBinaryBody(filesKey, file, ContentType.DEFAULT_BINARY, URLEncoder.encode(file.getName(), <span class="string">&quot;utf-8&quot;</span>));</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 其它参数(注:自定义contentType，设置UTF-8是为了防止服务端拿到的参数出现乱码)</span></span><br><span class="line">            ContentType contentType = ContentType.create(<span class="string">&quot;text/plain&quot;</span>, StandardCharsets.UTF_8);</span><br><span class="line">            <span class="keyword">for</span> (String key : params.keySet()) &#123;</span><br><span class="line">                multipartEntityBuilder.addTextBody(key, params.get(key).toString(), contentType);</span><br><span class="line">            &#125;</span><br><span class="line">            HttpEntity entity = multipartEntityBuilder.build();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// post请求是将参数放在请求体里面传过去的,这里将entity放入post请求体中</span></span><br><span class="line">            httpPost.setEntity(entity);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;Get responseResult：&quot;</span>, e);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> execute(httpPost);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="OkHttpUtil"><a href="#OkHttpUtil" class="headerlink" title="OkHttpUtil"></a>OkHttpUtil</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONArray;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> okhttp3.*;</span><br><span class="line"><span class="keyword">import</span> okio.BufferedSink;</span><br><span class="line"><span class="keyword">import</span> okio.GzipSink;</span><br><span class="line"><span class="keyword">import</span> okio.Okio;</span><br><span class="line"><span class="keyword">import</span> org.jetbrains.annotations.NotNull;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.net.URLEncoder;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Objects;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> java.util.zip.GZIPInputStream;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;OkHttp工具类&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * Created by hanqf on 2020/4/18 21:54.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OkHttpUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获得OkHttpClient客户端</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> OkHttpClient client = <span class="keyword">new</span> OkHttpClient.Builder()</span><br><span class="line">            .connectTimeout(<span class="number">5L</span>, TimeUnit.SECONDS) <span class="comment">//连接超时时间，5秒</span></span><br><span class="line">            .readTimeout(<span class="number">5L</span>, TimeUnit.SECONDS) <span class="comment">//读超时时间，5秒</span></span><br><span class="line">            .writeTimeout(<span class="number">5L</span>, TimeUnit.SECONDS) <span class="comment">//写超时时间，5秒</span></span><br><span class="line">            .followRedirects(<span class="keyword">true</span>) <span class="comment">//设置是否允许重定向，默认true</span></span><br><span class="line">            <span class="comment">//注意拦截器的顺序</span></span><br><span class="line">            .addInterceptor(<span class="keyword">new</span> GzipRequestInterceptor()) <span class="comment">//开启gzip压缩，支持对流或Json进行gzip压缩，服务端需要支持解压缩</span></span><br><span class="line">            .addInterceptor(<span class="keyword">new</span> RetryIntercepter()) <span class="comment">//重试拦截器，默认3次</span></span><br><span class="line">            .addInterceptor(<span class="keyword">new</span> HeadersLoggingInterceper()) <span class="comment">//header拦截器</span></span><br><span class="line">            .build();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;异步调用&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> hanqf</span></span><br><span class="line"><span class="comment">     * 2020/4/22 20:37</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">executeAsync</span><span class="params">(Request request)</span></span>&#123;</span><br><span class="line">        Call call = client.newCall(request);</span><br><span class="line">        call.enqueue(<span class="keyword">new</span> Callback() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(<span class="meta">@NotNull</span> Call call, <span class="meta">@NotNull</span> IOException e)</span> </span>&#123;</span><br><span class="line">                log.info(<span class="string">&quot;Get responseResult：&quot;</span>, e);</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(<span class="meta">@NotNull</span> Call call, <span class="meta">@NotNull</span> Response response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                String responseResult = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (response.isSuccessful()) &#123;</span><br><span class="line">                    responseResult = Objects.requireNonNull(response.body()).string();</span><br><span class="line">                &#125;</span><br><span class="line">                Headers headers = response.headers();</span><br><span class="line">                StringBuilder stringBuffer = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;headers.size();i++)&#123;</span><br><span class="line">                    stringBuffer.append(headers.name(i)).append(<span class="string">&quot;:&quot;</span>).append(headers.value(i)).append(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                log.info(String.format(<span class="string">&quot;响应头信息: [%s]&quot;</span>, stringBuffer.toString()));</span><br><span class="line">                log.info(String.format(<span class="string">&quot;响应结果：%s&quot;</span>,responseResult));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;请求的执行方法，需要提前封装好Request对象，如请求url和请求参数&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> java.lang.String</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> hanqf</span></span><br><span class="line"><span class="comment">     * 2020/4/18 23:47</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">execute</span><span class="params">(Request request)</span> </span>&#123;</span><br><span class="line">        String responseResult = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">long</span> t1 = System.nanoTime();<span class="comment">//请求发起的时间</span></span><br><span class="line">            Response response = client.newCall(request).execute();</span><br><span class="line">            <span class="keyword">if</span> (response.isSuccessful()) &#123;</span><br><span class="line">                responseResult = Objects.requireNonNull(response.body()).string();</span><br><span class="line">                <span class="comment">//byte[] bytes = response.body().bytes();</span></span><br><span class="line">                <span class="comment">//responseResult = new String(bytes,&quot;utf-8&quot;);</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">long</span> t2 = System.nanoTime();<span class="comment">//收到响应的时间</span></span><br><span class="line">            Headers headers = response.headers();</span><br><span class="line"></span><br><span class="line">            StringBuilder stringBuffer = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;headers.size();i++)&#123;</span><br><span class="line">                stringBuffer.append(headers.name(i)).append(<span class="string">&quot;:&quot;</span>).append(headers.value(i)).append(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            log.info(String.format(<span class="string">&quot;响应头信息: [%s]&quot;</span>, stringBuffer.toString()));</span><br><span class="line"></span><br><span class="line">            log.info(String.format(<span class="string">&quot;执行时间: [%.1fms]&quot;</span>, (t2 - t1) / <span class="number">1e6d</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;Get responseResult：&quot;</span>, e);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> responseResult;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] executeBytes(Request request) &#123;</span><br><span class="line">        <span class="keyword">byte</span>[] bytes = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">long</span> t1 = System.nanoTime();<span class="comment">//请求发起的时间</span></span><br><span class="line">            Response response = client.newCall(request).execute();</span><br><span class="line">            <span class="keyword">if</span> (response.isSuccessful()) &#123;</span><br><span class="line">                bytes = Objects.requireNonNull(response.body()).bytes();</span><br><span class="line"></span><br><span class="line">                <span class="comment">//判断是否需要解压，即服务器返回是否经过了gzip压缩--start</span></span><br><span class="line">                String responseHeader = response.header(<span class="string">&quot;Content-Encoding&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (responseHeader != <span class="keyword">null</span> &amp;&amp; responseHeader.contains(<span class="string">&quot;gzip&quot;</span>)) &#123;</span><br><span class="line">                    GZIPInputStream gzipInputStream = <span class="keyword">null</span>;</span><br><span class="line">                    ByteArrayOutputStream out = <span class="keyword">null</span>;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        gzipInputStream = <span class="keyword">new</span> GZIPInputStream(<span class="keyword">new</span> ByteArrayInputStream(bytes));</span><br><span class="line">                        out = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">                        <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">                        <span class="keyword">int</span> offset = -<span class="number">1</span>;</span><br><span class="line">                        <span class="keyword">while</span> ((offset = gzipInputStream.read(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                            out.write(buffer, <span class="number">0</span>, offset);</span><br><span class="line">                        &#125;</span><br><span class="line">                        bytes = out.toByteArray();</span><br><span class="line"></span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            gzipInputStream.close();</span><br><span class="line">                            out.close();</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                            e.printStackTrace();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//判断是否需要解压，即服务器返回是否经过了gzip压缩--end</span></span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">long</span> t2 = System.nanoTime();<span class="comment">//收到响应的时间</span></span><br><span class="line">            Headers headers = response.headers();</span><br><span class="line">            StringBuilder stringBuffer = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;headers.size();i++)&#123;</span><br><span class="line">                stringBuffer.append(headers.name(i)).append(<span class="string">&quot;:&quot;</span>).append(headers.value(i)).append(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            log.info(String.format(<span class="string">&quot;响应头信息: [%s]&quot;</span>, stringBuffer.toString()));</span><br><span class="line"></span><br><span class="line">            log.info(String.format(<span class="string">&quot;执行时间: [%.1fms]&quot;</span>, (t2 - t1) / <span class="number">1e6d</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;Get responseResult：&quot;</span>, e);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bytes;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;get请求&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url 请求url</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> java.lang.String</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> hanqf</span></span><br><span class="line"><span class="comment">     * 2020/4/18 23:48</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">get</span><span class="params">(String url)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> get(url, <span class="keyword">new</span> HashMap&lt;&gt;());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;get请求&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> params</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> java.lang.String</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> hanqf</span></span><br><span class="line"><span class="comment">     * 2020/4/20 16:40</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">get</span><span class="params">(String url, Map&lt;String, Object&gt; params)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (params.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            StringBuilder stringBuffer = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">            stringBuffer.append(url);</span><br><span class="line">            <span class="keyword">if</span> (url.contains(<span class="string">&quot;?&quot;</span>)) &#123;</span><br><span class="line">                stringBuffer.append(<span class="string">&quot;&amp;&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                stringBuffer.append(<span class="string">&quot;?&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (String key : params.keySet()) &#123;</span><br><span class="line">                stringBuffer.append(key).append(<span class="string">&quot;=&quot;</span>).append(params.get(key).toString()).append(<span class="string">&quot;&amp;&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            url = stringBuffer.toString();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Request request = <span class="keyword">new</span> Request.Builder()</span><br><span class="line">                .url(url)</span><br><span class="line">                .get()</span><br><span class="line">                .build();</span><br><span class="line">        log.info(String.format(<span class="string">&quot;请求地址: [%s]&quot;</span>, request.url()));</span><br><span class="line">        <span class="keyword">if</span> (params.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            JSONArray jArray = <span class="keyword">new</span> JSONArray();</span><br><span class="line">            jArray.add(params);</span><br><span class="line">            log.info(String.format(<span class="string">&quot;请求参数: %s&quot;</span>, jArray.toJSONString()));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//executeAsync(request);</span></span><br><span class="line">        <span class="keyword">return</span> execute(request);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] getBytes(String url, Map&lt;String, Object&gt; params) &#123;</span><br><span class="line">        <span class="keyword">if</span> (params.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            StringBuilder stringBuffer = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">            stringBuffer.append(url);</span><br><span class="line">            <span class="keyword">if</span> (url.contains(<span class="string">&quot;?&quot;</span>)) &#123;</span><br><span class="line">                stringBuffer.append(<span class="string">&quot;&amp;&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                stringBuffer.append(<span class="string">&quot;?&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (String key : params.keySet()) &#123;</span><br><span class="line">                stringBuffer.append(key).append(<span class="string">&quot;=&quot;</span>).append(params.get(key).toString()).append(<span class="string">&quot;&amp;&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            url = stringBuffer.toString();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Request request = <span class="keyword">new</span> Request.Builder()</span><br><span class="line">                .url(url)</span><br><span class="line">                .get()</span><br><span class="line">                .build();</span><br><span class="line">        log.info(String.format(<span class="string">&quot;请求地址: [%s]&quot;</span>, request.url()));</span><br><span class="line">        <span class="keyword">if</span> (params.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            JSONArray jArray = <span class="keyword">new</span> JSONArray();</span><br><span class="line">            jArray.add(params);</span><br><span class="line">            log.info(String.format(<span class="string">&quot;请求参数: %s&quot;</span>, jArray.toJSONString()));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> executeBytes(request);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;post请求&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url 请求url</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> java.lang.String</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> hanqf</span></span><br><span class="line"><span class="comment">     * 2020/4/18 23:48</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">post</span><span class="params">(String url)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> post(url, <span class="keyword">new</span> HashMap&lt;&gt;());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;post请求&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * form请求</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url    请求url</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> params 请求参数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> java.lang.String</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> hanqf</span></span><br><span class="line"><span class="comment">     * 2020/4/18 23:49</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">post</span><span class="params">(String url, Map&lt;String, Object&gt; params)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//请求头会加入：application/x-www-form-urlencoded</span></span><br><span class="line">        FormBody.Builder builder = <span class="keyword">new</span> FormBody.Builder();</span><br><span class="line">        <span class="keyword">for</span> (String key : params.keySet()) &#123;</span><br><span class="line">            builder.add(key, params.get(key).toString());</span><br><span class="line">        &#125;</span><br><span class="line">        RequestBody requestBody = builder.build();</span><br><span class="line">        Request request = <span class="keyword">new</span> Request.Builder()</span><br><span class="line">                .url(url)</span><br><span class="line">                .post(requestBody)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        log.info(String.format(<span class="string">&quot;请求地址: [%s]&quot;</span>, request.url()));</span><br><span class="line">        <span class="keyword">if</span> (params.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            JSONArray jArray = <span class="keyword">new</span> JSONArray();</span><br><span class="line">            jArray.add(params);</span><br><span class="line">            log.info(String.format(<span class="string">&quot;请求参数: %s&quot;</span>, jArray.toJSONString()));</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(String.format(<span class="string">&quot;请求类型: %s&quot;</span>, Objects.requireNonNull(Objects.requireNonNull(request.body()).contentType()).toString()));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> execute(request);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] postBytes(String url, Map&lt;String, Object&gt; params) &#123;</span><br><span class="line">        <span class="comment">//请求头会加入：application/x-www-form-urlencoded</span></span><br><span class="line">        FormBody.Builder builder = <span class="keyword">new</span> FormBody.Builder();</span><br><span class="line">        <span class="keyword">for</span> (String key : params.keySet()) &#123;</span><br><span class="line">            builder.add(key, params.get(key).toString());</span><br><span class="line">        &#125;</span><br><span class="line">        RequestBody requestBody = builder.build();</span><br><span class="line">        Request request = <span class="keyword">new</span> Request.Builder()</span><br><span class="line">                .url(url)</span><br><span class="line">                .post(requestBody)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        log.info(String.format(<span class="string">&quot;请求地址: [%s]&quot;</span>, request.url()));</span><br><span class="line">        <span class="keyword">if</span> (params.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            JSONArray jArray = <span class="keyword">new</span> JSONArray();</span><br><span class="line">            jArray.add(params);</span><br><span class="line">            log.info(String.format(<span class="string">&quot;请求参数: %s&quot;</span>, jArray.toJSONString()));</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(String.format(<span class="string">&quot;请求类型: %s&quot;</span>, Objects.requireNonNull(Objects.requireNonNull(request.body()).contentType()).toString()));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> executeBytes(request);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;post请求，json请求&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url  请求url</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> json json数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> java.lang.String</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> hanqf</span></span><br><span class="line"><span class="comment">     * 2020/4/18 23:50</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">post</span><span class="params">(String url, String json)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        MediaType mediaType = MediaType.parse(<span class="string">&quot;application/json; charset=utf8&quot;</span>);</span><br><span class="line">        RequestBody requestBody = RequestBody.create(json, mediaType);</span><br><span class="line">        Request request = <span class="keyword">new</span> Request.Builder()</span><br><span class="line">                .url(url)</span><br><span class="line">                .post(requestBody)</span><br><span class="line">                .build();</span><br><span class="line">        log.info(String.format(<span class="string">&quot;请求地址: [%s]&quot;</span>, request.url()));</span><br><span class="line">        log.info(String.format(<span class="string">&quot;请求参数: %s&quot;</span>, json));</span><br><span class="line">        log.info(String.format(<span class="string">&quot;请求类型: %s&quot;</span>, Objects.requireNonNull(Objects.requireNonNull(request.body()).contentType()).toString()));</span><br><span class="line">        <span class="keyword">return</span> execute(request);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;post请求，字节流&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url   请求url</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bytes 字节数组</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> java.lang.String</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> hanqf</span></span><br><span class="line"><span class="comment">     * 2020/4/18 23:51</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">post</span><span class="params">(String url, <span class="keyword">byte</span>[] bytes)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        MediaType mediaType = MediaType.parse(<span class="string">&quot;application/octet-stream&quot;</span>);</span><br><span class="line">        RequestBody requestBody = <span class="keyword">null</span>;</span><br><span class="line">        requestBody = RequestBody.create(bytes, mediaType);</span><br><span class="line"></span><br><span class="line">        Request request = <span class="keyword">new</span> Request.Builder()</span><br><span class="line">                .url(url)</span><br><span class="line">                .post(requestBody)</span><br><span class="line">                .build();</span><br><span class="line">        log.info(String.format(<span class="string">&quot;请求地址: [%s]&quot;</span>, request.url()));</span><br><span class="line">        log.info(String.format(<span class="string">&quot;请求类型: %s&quot;</span>, Objects.requireNonNull(Objects.requireNonNull(request.body()).contentType()).toString()));</span><br><span class="line">        <span class="keyword">return</span> execute(request);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;post请求，字节流&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> is</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> java.lang.String</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> hanqf</span></span><br><span class="line"><span class="comment">     * 2020/4/21 22:45</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">post</span><span class="params">(String url, InputStream is)</span> </span>&#123;</span><br><span class="line">        ByteArrayOutputStream byteArrayOutputStream = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="keyword">int</span> ch;</span><br><span class="line">        <span class="keyword">byte</span>[] bytes = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> ((ch = is.read(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                byteArrayOutputStream.write(buffer, <span class="number">0</span>, ch);</span><br><span class="line">            &#125;</span><br><span class="line">            bytes = byteArrayOutputStream.toByteArray();</span><br><span class="line">            byteArrayOutputStream.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> post(url, bytes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;post请求，文件传输&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url   请求url</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> files 文件列表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> java.lang.String</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> hanqf</span></span><br><span class="line"><span class="comment">     * 2020/4/18 23:52</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">post</span><span class="params">(String url, File[] files)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> post(url, <span class="keyword">new</span> HashMap&lt;&gt;(), files);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;post请求，文件传输&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url    请求url</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> params 参数map</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> files  文件列表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> java.lang.String</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> hanqf</span></span><br><span class="line"><span class="comment">     * 2020/4/18 23:52</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">post</span><span class="params">(String url, Map&lt;String, Object&gt; params, File[] files)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        MultipartBody.Builder builder = <span class="keyword">new</span> MultipartBody.Builder()</span><br><span class="line">                .setType(MultipartBody.FORM);</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String filesKey = <span class="string">&quot;files&quot;</span>;</span><br><span class="line">            <span class="keyword">for</span> (File file : files) &#123;</span><br><span class="line">                <span class="comment">//URLEncoder.encode(file.getName(), &quot;utf-8&quot;) //中文文件名使用encode，服务端使用decode解析</span></span><br><span class="line">                builder.addFormDataPart(filesKey, URLEncoder.encode(file.getName(), <span class="string">&quot;utf-8&quot;</span>),</span><br><span class="line">                        RequestBody.create(file, MediaType.parse(<span class="string">&quot;multipart/form-data&quot;</span>)));</span><br><span class="line">                i++;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (String key : params.keySet()) &#123;</span><br><span class="line">                builder.addFormDataPart(key, params.get(key).toString());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        RequestBody requestBody = builder.build();</span><br><span class="line">        Request request = <span class="keyword">new</span> Request.Builder()</span><br><span class="line">                .url(url)</span><br><span class="line">                .post(requestBody)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        log.info(String.format(<span class="string">&quot;请求地址: [%s]&quot;</span>, request.url()));</span><br><span class="line">        <span class="keyword">if</span> (params != <span class="keyword">null</span> &amp;&amp; params.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            JSONArray jArray = <span class="keyword">new</span> JSONArray();</span><br><span class="line">            jArray.add(params);</span><br><span class="line">            log.info(String.format(<span class="string">&quot;请求参数: %s&quot;</span>, jArray.toJSONString()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (files != <span class="keyword">null</span> &amp;&amp; files.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            JSONArray jArray = <span class="keyword">new</span> JSONArray();</span><br><span class="line">            jArray.add(files);</span><br><span class="line">            log.info(String.format(<span class="string">&quot;请求参数: %s&quot;</span>, jArray.toJSONString()));</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(String.format(<span class="string">&quot;请求类型: %s&quot;</span>, Objects.requireNonNull(Objects.requireNonNull(request.body()).contentType()).toString()));</span><br><span class="line">        <span class="keyword">return</span> execute(request);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * This interceptor compresses the HTTP request body. Many webservers can&#x27;t handle this!</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">GzipRequestInterceptor</span> <span class="keyword">implements</span> <span class="title">Interceptor</span> </span>&#123;</span><br><span class="line">        <span class="meta">@NotNull</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Response <span class="title">intercept</span><span class="params">(Chain chain)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">            Request originalRequest = chain.request();</span><br><span class="line">            <span class="keyword">if</span> (originalRequest.body() == <span class="keyword">null</span> || originalRequest.header(<span class="string">&quot;Content-Encoding&quot;</span>) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> chain.proceed(originalRequest);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            MediaType mediaType = Objects.requireNonNull(originalRequest.body()).contentType();</span><br><span class="line">            <span class="comment">//对流和json开启压缩</span></span><br><span class="line">            <span class="keyword">if</span> (mediaType != <span class="keyword">null</span> &amp;&amp; (<span class="string">&quot;application/octet-stream&quot;</span>.equals(mediaType.toString()) || <span class="string">&quot;application/json; charset=utf8&quot;</span>.equals(mediaType.toString()))) &#123;</span><br><span class="line">                Request compressedRequest = originalRequest.newBuilder()</span><br><span class="line">                        .header(<span class="string">&quot;Content-Encoding&quot;</span>, <span class="string">&quot;gzip&quot;</span>)</span><br><span class="line">                        .method(originalRequest.method(), gzip(originalRequest.body()))</span><br><span class="line">                        .build();</span><br><span class="line">                <span class="keyword">return</span> chain.proceed(compressedRequest);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> chain.proceed(originalRequest);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> RequestBody <span class="title">gzip</span><span class="params">(<span class="keyword">final</span> RequestBody body)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> RequestBody() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> MediaType <span class="title">contentType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> body.contentType();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">contentLength</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> -<span class="number">1</span>; <span class="comment">// We don&#x27;t know the compressed length in advance!</span></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeTo</span><span class="params">(<span class="meta">@NotNull</span> BufferedSink sink)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                    BufferedSink gzipSink = Okio.buffer(<span class="keyword">new</span> GzipSink(sink));</span><br><span class="line">                    body.writeTo(gzipSink);</span><br><span class="line">                    gzipSink.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;重试拦截器&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">RetryIntercepter</span> <span class="keyword">implements</span> <span class="title">Interceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> maxRetry = <span class="number">3</span>;<span class="comment">//最大重试次数，默认3次</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> retryNum = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">RetryIntercepter</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">RetryIntercepter</span><span class="params">(<span class="keyword">int</span> maxRetry)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.maxRetry = maxRetry;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@NotNull</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Response <span class="title">intercept</span><span class="params">(Chain chain)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">            Request request = chain.request();</span><br><span class="line">            Response response = chain.proceed(request);</span><br><span class="line">            <span class="keyword">while</span> (!response.isSuccessful() &amp;&amp; retryNum &lt; maxRetry) &#123;</span><br><span class="line">                retryNum++;</span><br><span class="line">                response = chain.proceed(request);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> response;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;Headers拦截器&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">HeadersLoggingInterceper</span> <span class="keyword">implements</span> <span class="title">Interceptor</span> </span>&#123;</span><br><span class="line">        <span class="meta">@NotNull</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Response <span class="title">intercept</span><span class="params">(<span class="meta">@NotNull</span> Chain chain)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">            Request request = chain.request();</span><br><span class="line">            Headers headers = request.headers();</span><br><span class="line">            StringBuilder stringBuffer = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;headers.size();i++)&#123;</span><br><span class="line">                stringBuffer.append(headers.name(i)).append(<span class="string">&quot;:&quot;</span>).append(headers.value(i)).append(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            log.info(String.format(<span class="string">&quot;请求头信息: [%s]&quot;</span>, stringBuffer.toString()));</span><br><span class="line">            <span class="keyword">return</span> chain.proceed(request);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="RestTemplateUtil"><a href="#RestTemplateUtil" class="headerlink" title="RestTemplateUtil"></a>RestTemplateUtil</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.FileSystemResource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.client.ClientHttpRequestExecution;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.client.ClientHttpRequestInterceptor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.client.ClientHttpResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.client.SimpleClientHttpRequestFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.LinkedMultiValueMap;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.MultiValueMap;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.zip.GZIPInputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.zip.GZIPOutputStream;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;RestTemplate工具类&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * Created by hanqf on 2020/4/22 16:54.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RestTemplateUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> SimpleClientHttpRequestFactory factory = <span class="keyword">new</span> SimpleClientHttpRequestFactory();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        factory.setReadTimeout(<span class="number">5000</span>);<span class="comment">//单位为ms</span></span><br><span class="line">        factory.setConnectTimeout(<span class="number">5000</span>);<span class="comment">//单位为ms</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//拦截器</span></span><br><span class="line">        List&lt;ClientHttpRequestInterceptor&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        list.add(<span class="keyword">new</span> RetryIntercepter()); <span class="comment">//重试拦截器</span></span><br><span class="line">        list.add(<span class="keyword">new</span> HeadersLoggingInterceper()); <span class="comment">//header拦截器</span></span><br><span class="line"></span><br><span class="line">        restTemplate = <span class="keyword">new</span> RestTemplate(factory);</span><br><span class="line">        restTemplate.setInterceptors(list);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">get</span><span class="params">(String url)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> get(url, <span class="keyword">new</span> HashMap&lt;&gt;());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;get请求&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> map</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> java.lang.String</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> hanqf</span></span><br><span class="line"><span class="comment">     * 2020/4/22 16:57</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">get</span><span class="params">(String url, Map&lt;String, Object&gt; map)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (map.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            StringBuilder stringBuffer = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">            stringBuffer.append(url);</span><br><span class="line">            <span class="keyword">if</span> (url.contains(<span class="string">&quot;?&quot;</span>)) &#123;</span><br><span class="line">                stringBuffer.append(<span class="string">&quot;&amp;&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                stringBuffer.append(<span class="string">&quot;?&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (String key : map.keySet()) &#123;</span><br><span class="line">                stringBuffer.append(key).append(<span class="string">&quot;=&quot;</span>).append(map.get(key).toString()).append(<span class="string">&quot;&amp;&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            url = stringBuffer.toString();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> restTemplate.getForObject(url, String.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] getBytes(String url, Map&lt;String, Object&gt; map) &#123;</span><br><span class="line">        <span class="keyword">if</span> (map.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            StringBuilder stringBuffer = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">            stringBuffer.append(url);</span><br><span class="line">            <span class="keyword">if</span> (url.contains(<span class="string">&quot;?&quot;</span>)) &#123;</span><br><span class="line">                stringBuffer.append(<span class="string">&quot;&amp;&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                stringBuffer.append(<span class="string">&quot;?&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (String key : map.keySet()) &#123;</span><br><span class="line">                stringBuffer.append(key).append(<span class="string">&quot;=&quot;</span>).append(map.get(key).toString()).append(<span class="string">&quot;&amp;&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            url = stringBuffer.toString();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//return restTemplate.getForObject(url, byte[].class);</span></span><br><span class="line">        ResponseEntity&lt;<span class="keyword">byte</span>[]&gt; exchange = restTemplate.exchange(url, HttpMethod.GET, <span class="keyword">null</span>, <span class="keyword">byte</span>[].class);</span><br><span class="line">        <span class="keyword">byte</span>[] bytes = exchange.getBody();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//判断是否需要解压，即服务器返回是否经过了gzip压缩--start</span></span><br><span class="line">        List&lt;String&gt; strings = exchange.getHeaders().get(<span class="string">&quot;Content-Encoding&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (strings != <span class="keyword">null</span> &amp;&amp; strings.contains(<span class="string">&quot;gzip&quot;</span>)) &#123;</span><br><span class="line">            GZIPInputStream gzipInputStream = <span class="keyword">null</span>;</span><br><span class="line">            ByteArrayOutputStream out = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                gzipInputStream = <span class="keyword">new</span> GZIPInputStream(<span class="keyword">new</span> ByteArrayInputStream(bytes));</span><br><span class="line">                out = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">                <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">                <span class="keyword">int</span> offset = -<span class="number">1</span>;</span><br><span class="line">                <span class="keyword">while</span> ((offset = gzipInputStream.read(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                    out.write(buffer, <span class="number">0</span>, offset);</span><br><span class="line">                &#125;</span><br><span class="line">                bytes = out.toByteArray();</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    gzipInputStream.close();</span><br><span class="line">                    out.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//判断是否需要解压，即服务器返回是否经过了gzip压缩--end</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> bytes;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">post</span><span class="params">(String url)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> post(url, <span class="keyword">new</span> HashMap&lt;&gt;());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;post请求&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> params</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> java.lang.String</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> hanqf</span></span><br><span class="line"><span class="comment">     * 2020/4/22 16:59</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">post</span><span class="params">(String url, Map&lt;String, Object&gt; params)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        MultiValueMap&lt;String, Object&gt; map = <span class="keyword">new</span> LinkedMultiValueMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span> (params != <span class="keyword">null</span> &amp;&amp; params.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            map.setAll(params);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        HttpHeaders headers = <span class="keyword">new</span> HttpHeaders();</span><br><span class="line">        headers.setContentType(MediaType.APPLICATION_FORM_URLENCODED);</span><br><span class="line">        HttpEntity&lt;MultiValueMap&lt;String, Object&gt;&gt; httpEntity = <span class="keyword">new</span> HttpEntity&lt;&gt;(map, headers);</span><br><span class="line">        <span class="keyword">return</span> restTemplate.postForObject(url, httpEntity, String.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] postBytes(String url, Map&lt;String, Object&gt; params) &#123;</span><br><span class="line"></span><br><span class="line">        MultiValueMap&lt;String, Object&gt; map = <span class="keyword">new</span> LinkedMultiValueMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span> (params != <span class="keyword">null</span> &amp;&amp; params.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            map.setAll(params);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        HttpHeaders headers = <span class="keyword">new</span> HttpHeaders();</span><br><span class="line">        headers.setContentType(MediaType.APPLICATION_FORM_URLENCODED);</span><br><span class="line">        HttpEntity&lt;MultiValueMap&lt;String, Object&gt;&gt; httpEntity = <span class="keyword">new</span> HttpEntity&lt;&gt;(map, headers);</span><br><span class="line">        <span class="comment">//byte[] bytes = restTemplate.postForObject(url, httpEntity, byte[].class);</span></span><br><span class="line"></span><br><span class="line">        ResponseEntity&lt;<span class="keyword">byte</span>[]&gt; exchange = restTemplate.exchange(url, HttpMethod.POST, httpEntity, <span class="keyword">byte</span>[].class);</span><br><span class="line">        <span class="keyword">byte</span>[] bytes = exchange.getBody();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//判断是否需要解压，即服务器返回是否经过了gzip压缩--start</span></span><br><span class="line">        List&lt;String&gt; strings = exchange.getHeaders().get(<span class="string">&quot;Content-Encoding&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (strings != <span class="keyword">null</span> &amp;&amp; strings.contains(<span class="string">&quot;gzip&quot;</span>)) &#123;</span><br><span class="line">            GZIPInputStream gzipInputStream = <span class="keyword">null</span>;</span><br><span class="line">            ByteArrayOutputStream out = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                gzipInputStream = <span class="keyword">new</span> GZIPInputStream(<span class="keyword">new</span> ByteArrayInputStream(bytes));</span><br><span class="line">                out = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">                <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">                <span class="keyword">int</span> offset = -<span class="number">1</span>;</span><br><span class="line">                <span class="keyword">while</span> ((offset = gzipInputStream.read(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                    out.write(buffer, <span class="number">0</span>, offset);</span><br><span class="line">                &#125;</span><br><span class="line">                bytes = out.toByteArray();</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    gzipInputStream.close();</span><br><span class="line">                    out.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//判断是否需要解压，即服务器返回是否经过了gzip压缩--end</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> bytes;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">postJson</span><span class="params">(String url, String json)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> postJson(url, json, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;post请求json&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> json</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> java.lang.String</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> hanqf</span></span><br><span class="line"><span class="comment">     * 2020/4/22 17:04</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">postJson</span><span class="params">(String url, String json, <span class="keyword">boolean</span> gzip)</span> </span>&#123;</span><br><span class="line">        HttpHeaders headers = <span class="keyword">new</span> HttpHeaders();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (gzip) &#123;</span><br><span class="line">            headers.setContentType(<span class="keyword">new</span> MediaType(<span class="string">&quot;application&quot;</span>, <span class="string">&quot;octet-stream&quot;</span>));</span><br><span class="line">            HttpEntity&lt;<span class="keyword">byte</span>[]&gt; httpEntity = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                headers.add(<span class="string">&quot;Content-Encoding&quot;</span>, <span class="string">&quot;gzip&quot;</span>);</span><br><span class="line">                ByteArrayOutputStream originalContent = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">                originalContent.write(json.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">                ByteArrayOutputStream baos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">                GZIPOutputStream gzipOut = <span class="keyword">new</span> GZIPOutputStream(baos);</span><br><span class="line">                originalContent.writeTo(gzipOut);</span><br><span class="line">                gzipOut.finish();</span><br><span class="line">                httpEntity = <span class="keyword">new</span> HttpEntity&lt;&gt;(baos.toByteArray(), headers);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> restTemplate.postForObject(url, httpEntity, String.class);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            headers.setContentType(<span class="keyword">new</span> MediaType(<span class="string">&quot;application&quot;</span>, <span class="string">&quot;json&quot;</span>, StandardCharsets.UTF_8));</span><br><span class="line">            <span class="comment">//headers.add(&quot;Content-Type&quot;, &quot;application/json;charset=utf8&quot;);</span></span><br><span class="line">            HttpEntity&lt;String&gt; httpEntity = <span class="keyword">new</span> HttpEntity&lt;&gt;(json, headers);</span><br><span class="line">            <span class="keyword">return</span> restTemplate.postForObject(url, httpEntity, String.class);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">postBytes</span><span class="params">(String url, <span class="keyword">byte</span>[] bytes)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> postBytes(url, bytes, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;post字节流&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bytes</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> gzip</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> java.lang.String</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> hanqf</span></span><br><span class="line"><span class="comment">     * 2020/4/22 17:10</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">postBytes</span><span class="params">(String url, <span class="keyword">byte</span>[] bytes, <span class="keyword">boolean</span> gzip)</span> </span>&#123;</span><br><span class="line">        HttpHeaders headers = <span class="keyword">new</span> HttpHeaders();</span><br><span class="line">        headers.setContentType(<span class="keyword">new</span> MediaType(<span class="string">&quot;application&quot;</span>, <span class="string">&quot;octet-stream&quot;</span>));</span><br><span class="line">        HttpEntity&lt;<span class="keyword">byte</span>[]&gt; httpEntity = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (gzip) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                headers.add(<span class="string">&quot;Content-Encoding&quot;</span>, <span class="string">&quot;gzip&quot;</span>);</span><br><span class="line">                ByteArrayOutputStream originalContent = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">                originalContent.write(bytes);</span><br><span class="line">                ByteArrayOutputStream baos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">                GZIPOutputStream gzipOut = <span class="keyword">new</span> GZIPOutputStream(baos);</span><br><span class="line">                originalContent.writeTo(gzipOut);</span><br><span class="line">                gzipOut.finish();</span><br><span class="line">                httpEntity = <span class="keyword">new</span> HttpEntity&lt;&gt;(baos.toByteArray(), headers);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            httpEntity = <span class="keyword">new</span> HttpEntity&lt;&gt;(bytes, headers);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> restTemplate.postForObject(url, httpEntity, String.class);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">postStream</span><span class="params">(String url, InputStream is)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> postStream(url, is, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;post请求，流&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> is</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> gzip</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> java.lang.String</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> hanqf</span></span><br><span class="line"><span class="comment">     * 2020/4/22 17:12</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">postStream</span><span class="params">(String url, InputStream is, <span class="keyword">boolean</span> gzip)</span> </span>&#123;</span><br><span class="line">        ByteArrayOutputStream byteArrayOutputStream = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="keyword">int</span> ch;</span><br><span class="line">        <span class="keyword">byte</span>[] bytes = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> ((ch = is.read(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                byteArrayOutputStream.write(buffer, <span class="number">0</span>, ch);</span><br><span class="line">            &#125;</span><br><span class="line">            bytes = byteArrayOutputStream.toByteArray();</span><br><span class="line">            byteArrayOutputStream.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> postBytes(url, bytes, gzip);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">postFiles</span><span class="params">(String url, File[] files)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> postFiles(url, <span class="keyword">new</span> HashMap&lt;&gt;(), files);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;post请求，传输文件&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> params</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> files</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> java.lang.String</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> hanqf</span></span><br><span class="line"><span class="comment">     * 2020/4/22 17:16</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">postFiles</span><span class="params">(String url, Map&lt;String, Object&gt; params, File[] files)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        MultiValueMap&lt;String, Object&gt; map = <span class="keyword">new</span> LinkedMultiValueMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span> (params != <span class="keyword">null</span> &amp;&amp; params.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            map.setAll(params);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (File file : files) &#123;</span><br><span class="line">            map.add(<span class="string">&quot;files&quot;</span>, <span class="keyword">new</span> FileSystemResource(file));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> restTemplate.postForObject(url, map, String.class);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;重试拦截器&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">RetryIntercepter</span> <span class="keyword">implements</span> <span class="title">ClientHttpRequestInterceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> maxRetry = <span class="number">3</span>;<span class="comment">//最大重试次数，默认3次</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> retryNum = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">RetryIntercepter</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">RetryIntercepter</span><span class="params">(<span class="keyword">int</span> maxRetry)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.maxRetry = maxRetry;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> ClientHttpResponse <span class="title">intercept</span><span class="params">(HttpRequest httpRequest, <span class="keyword">byte</span>[] bytes, ClientHttpRequestExecution clientHttpRequestExecution)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">            ClientHttpResponse response = clientHttpRequestExecution.execute(httpRequest, bytes);</span><br><span class="line">            <span class="keyword">if</span> (!response.getStatusCode().equals(HttpStatus.OK) &amp;&amp; retryNum &lt; maxRetry) &#123;</span><br><span class="line">                retryNum++;</span><br><span class="line">                response = clientHttpRequestExecution.execute(httpRequest, bytes);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> response;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;Headers拦截器&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">HeadersLoggingInterceper</span> <span class="keyword">implements</span> <span class="title">ClientHttpRequestInterceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> ClientHttpResponse <span class="title">intercept</span><span class="params">(HttpRequest httpRequest, <span class="keyword">byte</span>[] bytes, ClientHttpRequestExecution clientHttpRequestExecution)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">            log.info(String.format(<span class="string">&quot;请求地址: %s&quot;</span>, httpRequest.getURI()));</span><br><span class="line">            log.info(String.format(<span class="string">&quot;请求头信息: %s&quot;</span>, httpRequest.getHeaders()));</span><br><span class="line">            ClientHttpResponse response = clientHttpRequestExecution.execute(httpRequest, bytes);</span><br><span class="line">            log.info(String.format(<span class="string">&quot;响应头信息: %s&quot;</span>, response.getHeaders()));</span><br><span class="line">            <span class="keyword">return</span> response;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="WebClientUtil"><a href="#WebClientUtil" class="headerlink" title="WebClientUtil"></a>WebClientUtil</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelOption;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.timeout.ReadTimeoutHandler;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.timeout.WriteTimeoutHandler;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.FileSystemResource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.client.reactive.ClientHttpConnector;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.client.reactive.ReactorClientHttpConnector;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.client.reactive.ReactorResourceFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.LinkedMultiValueMap;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.MultiValueMap;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.reactive.function.client.ClientResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.reactive.function.client.WebClient;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Mono;</span><br><span class="line"><span class="keyword">import</span> reactor.netty.http.client.HttpClient;</span><br><span class="line"><span class="keyword">import</span> reactor.netty.resources.ConnectionProvider;</span><br><span class="line"><span class="keyword">import</span> reactor.netty.resources.LoopResources;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.function.Function;</span><br><span class="line"><span class="keyword">import</span> java.util.zip.GZIPInputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.zip.GZIPOutputStream;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * Created by hanqf on 2020/4/23 21:33.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebClientUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ReactorResourceFactory factory = <span class="keyword">new</span> ReactorResourceFactory();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> WebClient webClient;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        factory.setUseGlobalResources(<span class="keyword">false</span>);</span><br><span class="line">        factory.setConnectionProvider(ConnectionProvider.create(<span class="string">&quot;httpClient&quot;</span>, <span class="number">50</span>));</span><br><span class="line">        factory.setLoopResources(LoopResources.create(<span class="string">&quot;httpClient&quot;</span>, <span class="number">50</span>, <span class="keyword">true</span>));</span><br><span class="line"></span><br><span class="line">        Function&lt;HttpClient, HttpClient&gt; mapper = client -&gt;</span><br><span class="line">                client.tcpConfiguration(c -&gt;</span><br><span class="line">                        c.option(ChannelOption.CONNECT_TIMEOUT_MILLIS, <span class="number">5000</span>)</span><br><span class="line">                                .option(ChannelOption.TCP_NODELAY, <span class="keyword">true</span>)</span><br><span class="line">                                .doOnConnected(conn -&gt; &#123;</span><br><span class="line">                                    conn.addHandlerLast(<span class="keyword">new</span> ReadTimeoutHandler(<span class="number">10</span>));</span><br><span class="line">                                    conn.addHandlerLast(<span class="keyword">new</span> WriteTimeoutHandler(<span class="number">10</span>));</span><br><span class="line">                                &#125;));</span><br><span class="line"></span><br><span class="line">        ClientHttpConnector connector =</span><br><span class="line">                <span class="keyword">new</span> ReactorClientHttpConnector(factory, mapper);</span><br><span class="line"></span><br><span class="line">        webClient = WebClient.builder()</span><br><span class="line">                .filter((request, next) -&gt; &#123;  <span class="comment">//过滤器，3次重试，header打印</span></span><br><span class="line">                    log.info(String.format(<span class="string">&quot;请求地址: %s&quot;</span>, request.url()));</span><br><span class="line">                    log.info(String.format(<span class="string">&quot;请求头信息: %s&quot;</span>, request.headers()));</span><br><span class="line">                    Mono&lt;ClientResponse&gt; exchange = next.exchange(request).retry(<span class="number">3</span>);</span><br><span class="line">                    ClientResponse clientResponse = exchange.block();</span><br><span class="line">                    log.info(String.format(<span class="string">&quot;响应头信息: %s&quot;</span>, clientResponse.headers().asHttpHeaders()));</span><br><span class="line">                    <span class="keyword">return</span> exchange;</span><br><span class="line">                &#125;)</span><br><span class="line">                .clientConnector(connector).build();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">get</span><span class="params">(String url)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> get(url, <span class="keyword">new</span> HashMap&lt;&gt;());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;get请求&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> map</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> java.lang.String</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> hanqf</span></span><br><span class="line"><span class="comment">     * 2020/4/24 14:44</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">get</span><span class="params">(String url, Map&lt;String, Object&gt; map)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (map.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            StringBuilder stringBuffer = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">            stringBuffer.append(url);</span><br><span class="line">            <span class="keyword">if</span> (url.contains(<span class="string">&quot;?&quot;</span>)) &#123;</span><br><span class="line">                stringBuffer.append(<span class="string">&quot;&amp;&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                stringBuffer.append(<span class="string">&quot;?&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (String key : map.keySet()) &#123;</span><br><span class="line">                stringBuffer.append(key).append(<span class="string">&quot;=&quot;</span>).append(map.get(key).toString()).append(<span class="string">&quot;&amp;&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            url = stringBuffer.toString();</span><br><span class="line">        &#125;</span><br><span class="line">        String responseResult = <span class="keyword">null</span>;</span><br><span class="line">        Mono&lt;String&gt; mono = webClient.get().uri(url).retrieve().bodyToMono(String.class);</span><br><span class="line">        responseResult = mono.block();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> responseResult;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] getBytes(String url, Map&lt;String, Object&gt; map) &#123;</span><br><span class="line">        <span class="keyword">if</span> (map.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            StringBuilder stringBuffer = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">            stringBuffer.append(url);</span><br><span class="line">            <span class="keyword">if</span> (url.contains(<span class="string">&quot;?&quot;</span>)) &#123;</span><br><span class="line">                stringBuffer.append(<span class="string">&quot;&amp;&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                stringBuffer.append(<span class="string">&quot;?&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (String key : map.keySet()) &#123;</span><br><span class="line">                stringBuffer.append(key).append(<span class="string">&quot;=&quot;</span>).append(map.get(key).toString()).append(<span class="string">&quot;&amp;&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            url = stringBuffer.toString();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">byte</span>[] bytes = <span class="keyword">null</span>;</span><br><span class="line">        Mono&lt;ClientResponse&gt; exchange = webClient.get().uri(url).exchange();</span><br><span class="line">        ClientResponse response = exchange.block();</span><br><span class="line">        <span class="keyword">if</span> (response.statusCode() == HttpStatus.OK) &#123;</span><br><span class="line">            Mono&lt;<span class="keyword">byte</span>[]&gt; mono =  response.bodyToMono(<span class="keyword">byte</span>[].class);</span><br><span class="line">            bytes = mono.block();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//判断是否需要解压，即服务器返回是否经过了gzip压缩--start</span></span><br><span class="line">            List&lt;String&gt; header = response.headers().header(<span class="string">&quot;Content-Encoding&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (header.contains(<span class="string">&quot;gzip&quot;</span>)) &#123;</span><br><span class="line">                GZIPInputStream gzipInputStream = <span class="keyword">null</span>;</span><br><span class="line">                ByteArrayOutputStream out = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    gzipInputStream = <span class="keyword">new</span> GZIPInputStream(<span class="keyword">new</span> ByteArrayInputStream(bytes));</span><br><span class="line">                    out = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">                    <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">                    <span class="keyword">int</span> offset = -<span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">while</span> ((offset = gzipInputStream.read(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                        out.write(buffer, <span class="number">0</span>, offset);</span><br><span class="line">                    &#125;</span><br><span class="line">                    bytes = out.toByteArray();</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        gzipInputStream.close();</span><br><span class="line">                        out.close();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//判断是否需要解压，即服务器返回是否经过了gzip压缩--end</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> bytes;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">post</span><span class="params">(String url)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> post(url, <span class="keyword">new</span> HashMap&lt;&gt;());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;post请求&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> params</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> java.lang.String</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> hanqf</span></span><br><span class="line"><span class="comment">     * 2020/4/24 14:43</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">post</span><span class="params">(String url, Map&lt;String, Object&gt; params)</span> </span>&#123;</span><br><span class="line">        MultiValueMap&lt;String, Object&gt; map = <span class="keyword">new</span> LinkedMultiValueMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span> (params != <span class="keyword">null</span> &amp;&amp; params.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            map.setAll(params);</span><br><span class="line">        &#125;</span><br><span class="line">        String responseResult = <span class="keyword">null</span>;</span><br><span class="line">        Mono&lt;String&gt; mono = webClient.post().uri(url).bodyValue(map).retrieve().bodyToMono(String.class);</span><br><span class="line">        responseResult = mono.block();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> responseResult;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] postBytes(String url, Map&lt;String, Object&gt; params) &#123;</span><br><span class="line">        MultiValueMap&lt;String, Object&gt; map = <span class="keyword">new</span> LinkedMultiValueMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span> (params != <span class="keyword">null</span> &amp;&amp; params.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            map.setAll(params);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">byte</span>[] bytes = <span class="keyword">null</span>;</span><br><span class="line">        Mono&lt;ClientResponse&gt; exchange = webClient.post().uri(url).bodyValue(map).exchange();</span><br><span class="line">        ClientResponse response = exchange.block();</span><br><span class="line">        <span class="keyword">if</span> (response.statusCode() == HttpStatus.OK) &#123;</span><br><span class="line">            Mono&lt;<span class="keyword">byte</span>[]&gt; mono =  response.bodyToMono(<span class="keyword">byte</span>[].class);</span><br><span class="line">            bytes = mono.block();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//判断是否需要解压，即服务器返回是否经过了gzip压缩--start</span></span><br><span class="line">            List&lt;String&gt; header = response.headers().header(<span class="string">&quot;Content-Encoding&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (header.contains(<span class="string">&quot;gzip&quot;</span>)) &#123;</span><br><span class="line">                GZIPInputStream gzipInputStream = <span class="keyword">null</span>;</span><br><span class="line">                ByteArrayOutputStream out = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    gzipInputStream = <span class="keyword">new</span> GZIPInputStream(<span class="keyword">new</span> ByteArrayInputStream(bytes));</span><br><span class="line">                    out = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">                    <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">                    <span class="keyword">int</span> offset;</span><br><span class="line">                    <span class="keyword">while</span> ((offset = gzipInputStream.read(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                        out.write(buffer, <span class="number">0</span>, offset);</span><br><span class="line">                    &#125;</span><br><span class="line">                    bytes = out.toByteArray();</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        gzipInputStream.close();</span><br><span class="line">                        out.close();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//判断是否需要解压，即服务器返回是否经过了gzip压缩--end</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> bytes;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;post请求，form表单提交&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> params 这里要注意将参数值转为字符串，否则会报类型错误</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> java.lang.String</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> hanqf</span></span><br><span class="line"><span class="comment">     * 2020/4/24 14:43</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">postForm</span><span class="params">(String url, Map&lt;String, Object&gt; params)</span> </span>&#123;</span><br><span class="line">        MultiValueMap&lt;String, Object&gt; map = <span class="keyword">new</span> LinkedMultiValueMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span> (params != <span class="keyword">null</span> &amp;&amp; params.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (String key : params.keySet()) &#123;</span><br><span class="line">                map.add(key, params.get(key).toString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        String responseResult;</span><br><span class="line">        Mono&lt;String&gt; mono = webClient.post().uri(url).contentType(MediaType.APPLICATION_FORM_URLENCODED).bodyValue(map).retrieve().bodyToMono(String.class);</span><br><span class="line">        responseResult = mono.block();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> responseResult;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">postJson</span><span class="params">(String url, String json)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> postJson(url, json, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;post请求，json&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> json</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> gzip</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> java.lang.String</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> hanqf</span></span><br><span class="line"><span class="comment">     * 2020/4/24 15:45</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">postJson</span><span class="params">(String url, String json, <span class="keyword">boolean</span> gzip)</span> </span>&#123;</span><br><span class="line">        String responseResult;</span><br><span class="line">        <span class="keyword">if</span> (gzip) &#123;</span><br><span class="line">            <span class="keyword">byte</span>[] bytes = json.getBytes(StandardCharsets.UTF_8);</span><br><span class="line">            <span class="keyword">return</span> postBytes(url, bytes, <span class="keyword">true</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Mono&lt;String&gt; mono = webClient.post().uri(url).contentType(MediaType.APPLICATION_JSON).bodyValue(json).retrieve().bodyToMono(String.class);</span><br><span class="line">            responseResult = mono.block();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> responseResult;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">postBytes</span><span class="params">(String url, <span class="keyword">byte</span>[] bytes)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> postBytes(url, bytes, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;post请求，字节流&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bytes</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> gzip</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> java.lang.String</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> hanqf</span></span><br><span class="line"><span class="comment">     * 2020/4/24 15:45</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">postBytes</span><span class="params">(String url, <span class="keyword">byte</span>[] bytes, <span class="keyword">boolean</span> gzip)</span> </span>&#123;</span><br><span class="line">        String responseResult;</span><br><span class="line">        Mono&lt;String&gt; mono = <span class="keyword">null</span>;</span><br><span class="line">        WebClient.RequestBodySpec requestBodySpec = webClient.post().uri(url).contentType(MediaType.APPLICATION_OCTET_STREAM);</span><br><span class="line">        <span class="keyword">if</span> (gzip) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//headers.add(&quot;Content-Encoding&quot;, &quot;gzip&quot;);</span></span><br><span class="line">                ByteArrayOutputStream originalContent = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">                originalContent.write(bytes);</span><br><span class="line">                ByteArrayOutputStream baos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">                GZIPOutputStream gzipOut = <span class="keyword">new</span> GZIPOutputStream(baos);</span><br><span class="line">                originalContent.writeTo(gzipOut);</span><br><span class="line">                gzipOut.finish();</span><br><span class="line">                bytes = baos.toByteArray();</span><br><span class="line">                mono = requestBodySpec.header(<span class="string">&quot;Content-Encoding&quot;</span>, <span class="string">&quot;gzip&quot;</span>).bodyValue(bytes).retrieve().bodyToMono(String.class);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mono = requestBodySpec.bodyValue(bytes).retrieve().bodyToMono(String.class);</span><br><span class="line">        &#125;</span><br><span class="line">        responseResult = mono.block();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> responseResult;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">postStream</span><span class="params">(String url, InputStream is)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> postStream(url, is, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;post请求，流&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> is</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> gzip</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> java.lang.String</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> hanqf</span></span><br><span class="line"><span class="comment">     * 2020/4/22 17:12</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">postStream</span><span class="params">(String url, InputStream is, <span class="keyword">boolean</span> gzip)</span> </span>&#123;</span><br><span class="line">        ByteArrayOutputStream byteArrayOutputStream = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="keyword">int</span> ch;</span><br><span class="line">        <span class="keyword">byte</span>[] bytes = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> ((ch = is.read(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                byteArrayOutputStream.write(buffer, <span class="number">0</span>, ch);</span><br><span class="line">            &#125;</span><br><span class="line">            bytes = byteArrayOutputStream.toByteArray();</span><br><span class="line">            byteArrayOutputStream.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> postBytes(url, bytes, gzip);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">postFiles</span><span class="params">(String url, File[] files)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> postFiles(url, <span class="keyword">new</span> HashMap&lt;&gt;(), files);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;post请求，文件&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> params</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> files</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> java.lang.String</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> hanqf</span></span><br><span class="line"><span class="comment">     * 2020/4/24 15:46</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">postFiles</span><span class="params">(String url, Map&lt;String, Object&gt; params, File[] files)</span> </span>&#123;</span><br><span class="line">        String responseResult;</span><br><span class="line">        MultiValueMap&lt;String, Object&gt; map = <span class="keyword">new</span> LinkedMultiValueMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span> (params != <span class="keyword">null</span> &amp;&amp; params.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            map.setAll(params);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (File file : files) &#123;</span><br><span class="line">            map.add(<span class="string">&quot;files&quot;</span>, <span class="keyword">new</span> FileSystemResource(file));</span><br><span class="line">        &#125;</span><br><span class="line">        Mono&lt;String&gt; mono = webClient.post().uri(url).contentType(MediaType.MULTIPART_FORM_DATA).bodyValue(map).retrieve().bodyToMono(String.class);</span><br><span class="line">        responseResult = mono.block();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> responseResult;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>技术</category>
      </categories>
      <tags>
        <tag>http</tag>
      </tags>
  </entry>
  <entry>
    <title>MongoDB 分片集群搭建</title>
    <url>/2020/03/19/mongodb-mongos/</url>
    <content><![CDATA[<h2 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h2><ul>
<li>本文内容基于mongodb4.2.3</li>
<li>本文基于本地安装，也就是ip相同，端口不同</li>
<li>3个shard复制集(3台)，1个config复制集(3台)，2个router</li>
</ul>
<span id="more"></span>

<h2 id="安装MongoDB"><a href="#安装MongoDB" class="headerlink" title="安装MongoDB"></a>安装MongoDB</h2><p>下载地址 ： <a href="https://www.mongodb.com/download-center">https://www.mongodb.com/download-center</a></p>
<p>下载后解压即可，可以将bin目录配置到$PATH中</p>
<h2 id="目录设计"><a href="#目录设计" class="headerlink" title="目录设计"></a>目录设计</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">├── config</span><br><span class="line">│  ├── node1</span><br><span class="line">│  │  ├── db</span><br><span class="line">│  │  ├── logs</span><br><span class="line">│  │  └── mongod.conf</span><br><span class="line">│  ├── node2</span><br><span class="line">│  │  ├── db</span><br><span class="line">│  │  ├── logs</span><br><span class="line">│  │  └── mongod.conf</span><br><span class="line">│  └── node3</span><br><span class="line">│     ├── db</span><br><span class="line">│     ├── logs</span><br><span class="line">│     └── mongod.conf</span><br><span class="line">├── keyfile.key</span><br><span class="line">├── router</span><br><span class="line">│  ├── node1</span><br><span class="line">│  │  ├── logs</span><br><span class="line">│  │  └── mongos.conf</span><br><span class="line">│  └── node2</span><br><span class="line">│     ├── logs</span><br><span class="line">│     └── mongos.conf</span><br><span class="line">├── shard1</span><br><span class="line">│  ├── node1</span><br><span class="line">│  │  ├── db</span><br><span class="line">│  │  ├── logs</span><br><span class="line">│  │  └── mongod.conf</span><br><span class="line">│  ├── node2</span><br><span class="line">│  │  ├── db</span><br><span class="line">│  │  ├── logs</span><br><span class="line">│  │  └── mongod.conf</span><br><span class="line">│  └── node3</span><br><span class="line">│     ├── db</span><br><span class="line">│     ├── logs</span><br><span class="line">│     └── mongod.conf</span><br><span class="line">├── shard2</span><br><span class="line">│  ├── node1</span><br><span class="line">│  │  ├── db</span><br><span class="line">│  │  ├── logs</span><br><span class="line">│  │  └── mongod.conf</span><br><span class="line">│  ├── node2</span><br><span class="line">│  │  ├── db</span><br><span class="line">│  │  ├── logs</span><br><span class="line">│  │  └── mongod.conf</span><br><span class="line">│  └── node3</span><br><span class="line">│     ├── db</span><br><span class="line">│     ├── logs</span><br><span class="line">│     └── mongod.conf</span><br><span class="line">└── shard3</span><br><span class="line">   ├── node1</span><br><span class="line">   │  ├── db</span><br><span class="line">   │  ├── logs</span><br><span class="line">   │  └── mongod.conf</span><br><span class="line">   ├── node2</span><br><span class="line">   │  ├── db</span><br><span class="line">   │  ├── logs</span><br><span class="line">   │  └── mongod.conf</span><br><span class="line">   └── node3</span><br><span class="line">      ├── db</span><br><span class="line">      ├── logs</span><br><span class="line">      └── mongod.conf</span><br></pre></td></tr></table></figure>

<h2 id="端口分配"><a href="#端口分配" class="headerlink" title="端口分配"></a>端口分配</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">shard1 28011~28013</span><br><span class="line">shard2 28021~28023</span><br><span class="line">shard3 28031~28033</span><br><span class="line">config 29011~29013</span><br><span class="line">router 29021~29022</span><br></pre></td></tr></table></figure>
<h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><h3 id="shard"><a href="#shard" class="headerlink" title="shard"></a>shard</h3><p>以shard1为例，三个node下都有mongod.conf，要注意替换文件路径和端口</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">systemLog:</span><br><span class="line">   destination: file</span><br><span class="line">   path: <span class="string">&quot;/Users/hanqf/myservice_dir/mongodb-mongos/shard1/node1/logs/mongo.log&quot;</span> <span class="comment">#注意修改路径</span></span><br><span class="line">   logAppend: <span class="literal">true</span></span><br><span class="line">storage:</span><br><span class="line">   journal:</span><br><span class="line">      enabled: <span class="literal">true</span></span><br><span class="line">   dbPath: <span class="string">&quot;/Users/hanqf/myservice_dir/mongodb-mongos/shard1/node1/db&quot;</span> <span class="comment">#注意修改路径</span></span><br><span class="line">processManagement:</span><br><span class="line">   fork: <span class="literal">true</span></span><br><span class="line">net:</span><br><span class="line">   bindIp: 0.0.0.0</span><br><span class="line">   port: 28011   <span class="comment">#注意修改端口</span></span><br><span class="line">setParameter:</span><br><span class="line">   enableLocalhostAuthBypass: <span class="literal">true</span></span><br><span class="line">replication:</span><br><span class="line">   replSetName: <span class="string">&quot;shard1&quot;</span> <span class="comment">#复制集名称</span></span><br><span class="line">sharding:</span><br><span class="line">   clusterRole: shardsvr <span class="comment">#作为分片服务</span></span><br><span class="line">security:</span><br><span class="line">    authorization: <span class="string">&quot;enabled&quot;</span></span><br><span class="line">    keyFile: /Users/hanqf/myservice_dir/mongodb-mongos/keyFile.key <span class="comment">#密钥文件，用于集群内部认证</span></span><br></pre></td></tr></table></figure>

<h3 id="config"><a href="#config" class="headerlink" title="config"></a>config</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">systemLog:</span><br><span class="line">   destination: file</span><br><span class="line">   path: <span class="string">&quot;/Users/hanqf/myservice_dir/mongodb-mongos/config/node1/logs/mongo.log&quot;</span> <span class="comment">#注意修改路径</span></span><br><span class="line">   logAppend: <span class="literal">true</span></span><br><span class="line">storage:</span><br><span class="line">   journal:</span><br><span class="line">      enabled: <span class="literal">true</span></span><br><span class="line">   dbPath: <span class="string">&quot;/Users/hanqf/myservice_dir/mongodb-mongos/config/node1/db&quot;</span> <span class="comment">#注意修改路径</span></span><br><span class="line">processManagement:</span><br><span class="line">   fork: <span class="literal">true</span></span><br><span class="line">net:</span><br><span class="line">   bindIp: 0.0.0.0</span><br><span class="line">   port: 29011  <span class="comment">#注意修改端口</span></span><br><span class="line">setParameter:</span><br><span class="line">   enableLocalhostAuthBypass: <span class="literal">true</span></span><br><span class="line">replication:</span><br><span class="line">   replSetName: <span class="string">&quot;config&quot;</span> <span class="comment">#复制集名称</span></span><br><span class="line">sharding:</span><br><span class="line">   clusterRole: configsvr <span class="comment">#作为配置服务</span></span><br><span class="line">security:</span><br><span class="line">  authorization: <span class="string">&quot;enabled&quot;</span></span><br><span class="line">  keyFile: /Users/hanqf/myservice_dir/mongodb-mongos/keyFile.key <span class="comment">#密钥文件，用于集群内部认证</span></span><br></pre></td></tr></table></figure>

<h3 id="router"><a href="#router" class="headerlink" title="router"></a>router</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">systemLog:</span><br><span class="line">   destination: file</span><br><span class="line">   path: <span class="string">&quot;/Users/hanqf/myservice_dir/mongodb-mongos/router/node1/logs/mongos.log&quot;</span> <span class="comment">#注意修改路径</span></span><br><span class="line">   logAppend: <span class="literal">true</span></span><br><span class="line">processManagement:</span><br><span class="line">   fork: <span class="literal">true</span></span><br><span class="line">net:</span><br><span class="line">   bindIp: 0.0.0.0</span><br><span class="line">   port: 29021   <span class="comment">#注意修改端口</span></span><br><span class="line">setParameter:</span><br><span class="line">   enableLocalhostAuthBypass: <span class="literal">true</span></span><br><span class="line">replication:</span><br><span class="line">   localPingThresholdMs: 15</span><br><span class="line">sharding:</span><br><span class="line">   configDB: config/127.0.0.1:29011,127.0.0.1:29012,127.0.0.1:29013 <span class="comment">#关联配置服务</span></span><br><span class="line">security:</span><br><span class="line">    keyFile: /Users/hanqf/myservice_dir/mongodb-mongos/keyFile.key <span class="comment">#密钥文件，用于集群内部认证</span></span><br></pre></td></tr></table></figure>

<h3 id="keyFile"><a href="#keyFile" class="headerlink" title="keyFile"></a>keyFile</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /Users/hanqf/myservice_dir/mongodb-mongos</span><br><span class="line">openssl rand -base64 741 &gt; keyFile.key</span><br><span class="line">chmod 400 mongodb-keyfile</span><br></pre></td></tr></table></figure>

<h2 id="配置config复制集"><a href="#配置config复制集" class="headerlink" title="配置config复制集"></a>配置config复制集</h2><h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mongod --config /Users/hanqf/myservice_dir/mongodb-mongos/config/node1/mongod.conf</span><br><span class="line">mongod --config /Users/hanqf/myservice_dir/mongodb-mongos/config/node2/mongod.conf</span><br><span class="line">mongod --config /Users/hanqf/myservice_dir/mongodb-mongos/config/node3/mongod.conf</span><br></pre></td></tr></table></figure>
<h3 id="登录及配置"><a href="#登录及配置" class="headerlink" title="登录及配置"></a>登录及配置</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#登录任意一台config</span></span><br><span class="line">mongo --host 127.0.0.1:29011</span><br><span class="line"></span><br><span class="line">&gt;rs.initiate(</span><br><span class="line">  &#123;</span><br><span class="line">    _id: <span class="string">&quot;config&quot;</span>,</span><br><span class="line">    configsvr: <span class="literal">true</span>,</span><br><span class="line">    members: [</span><br><span class="line">      &#123; _id : 0, host : <span class="string">&quot;127.0.0.1:29011&quot;</span> &#125;,</span><br><span class="line">      &#123; _id : 1, host : <span class="string">&quot;127.0.0.1:29012&quot;</span> &#125;,</span><br><span class="line">      &#123; _id : 2, host : <span class="string">&quot;127.0.0.1:29013&quot;</span> &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建超级管理员，此时要求登录的是主库</span></span><br><span class="line">&gt;rs.isMaster() <span class="comment">#验证是否主库</span></span><br><span class="line">&gt;use admin</span><br><span class="line">&gt;db.createUser(</span><br><span class="line">   &#123;</span><br><span class="line">     user: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">     <span class="built_in">pwd</span>: <span class="string">&quot;password&quot;</span>,</span><br><span class="line">     roles: [ &#123; role: <span class="string">&quot;root&quot;</span>, db: <span class="string">&quot;admin&quot;</span> &#125; ]</span><br><span class="line">   &#125;</span><br><span class="line"> );</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>验证用户是否可以登录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mongo --host 127.0.0.1:29011</span><br><span class="line">&gt;use admin</span><br><span class="line">&gt;db.auth(<span class="string">&quot;root&quot;</span>,<span class="string">&quot;password&quot;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="配置shard复制集"><a href="#配置shard复制集" class="headerlink" title="配置shard复制集"></a>配置shard复制集</h2><h3 id="启动shard1服务"><a href="#启动shard1服务" class="headerlink" title="启动shard1服务"></a>启动shard1服务</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mongod --config /Users/hanqf/myservice_dir/mongodb-mongos/shard1/node1/mongod.conf</span><br><span class="line">mongod --config /Users/hanqf/myservice_dir/mongodb-mongos/shard1/node2/mongod.conf</span><br><span class="line">mongod --config /Users/hanqf/myservice_dir/mongodb-mongos/shard1/node3/mongod.conf</span><br></pre></td></tr></table></figure>
<h3 id="登录及配置-1"><a href="#登录及配置-1" class="headerlink" title="登录及配置"></a>登录及配置</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#登录任意一台config</span></span><br><span class="line">mongo --host 127.0.0.1:28011</span><br><span class="line"></span><br><span class="line">&gt;rs.initiate(</span><br><span class="line">  &#123;</span><br><span class="line">    _id: <span class="string">&quot;shard1&quot;</span>,</span><br><span class="line">    members: [</span><br><span class="line">      &#123; _id : 0, host : <span class="string">&quot;127.0.0.1:28011&quot;</span> &#125;,</span><br><span class="line">      &#123; _id : 1, host : <span class="string">&quot;127.0.0.1:28012&quot;</span> &#125;,</span><br><span class="line">      &#123; _id : 2, host : <span class="string">&quot;127.0.0.1:28013&quot;</span> &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建超级管理员，此时要求登录的是主库</span></span><br><span class="line">&gt;rs.isMaster() <span class="comment">#验证是否主库</span></span><br><span class="line">&gt;use admin</span><br><span class="line">&gt;db.createUser(</span><br><span class="line">   &#123;</span><br><span class="line">     user: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">     <span class="built_in">pwd</span>: <span class="string">&quot;password&quot;</span>,</span><br><span class="line">     roles: [ &#123; role: <span class="string">&quot;root&quot;</span>, db: <span class="string">&quot;admin&quot;</span> &#125; ]</span><br><span class="line">   &#125;</span><br><span class="line"> );</span><br></pre></td></tr></table></figure>

<h3 id="启动shard2服务"><a href="#启动shard2服务" class="headerlink" title="启动shard2服务"></a>启动shard2服务</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mongod --config /Users/hanqf/myservice_dir/mongodb-mongos/shard2/node1/mongod.conf</span><br><span class="line">mongod --config /Users/hanqf/myservice_dir/mongodb-mongos/shard2/node2/mongod.conf</span><br><span class="line">mongod --config /Users/hanqf/myservice_dir/mongodb-mongos/shard2/node3/mongod.conf</span><br></pre></td></tr></table></figure>
<h3 id="登录及配置-2"><a href="#登录及配置-2" class="headerlink" title="登录及配置"></a>登录及配置</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#登录任意一台config</span></span><br><span class="line">mongo --host 127.0.0.1:28021</span><br><span class="line"></span><br><span class="line">&gt;rs.initiate(</span><br><span class="line">  &#123;</span><br><span class="line">    _id: <span class="string">&quot;shard2&quot;</span>,</span><br><span class="line">    members: [</span><br><span class="line">      &#123; _id : 0, host : <span class="string">&quot;127.0.0.1:28021&quot;</span> &#125;,</span><br><span class="line">      &#123; _id : 1, host : <span class="string">&quot;127.0.0.1:28022&quot;</span> &#125;,</span><br><span class="line">      &#123; _id : 2, host : <span class="string">&quot;127.0.0.1:28023&quot;</span> &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建超级管理员，此时要求登录的是主库</span></span><br><span class="line">&gt;rs.isMaster() <span class="comment">#验证是否主库</span></span><br><span class="line">&gt;use admin</span><br><span class="line">&gt;db.createUser(</span><br><span class="line">   &#123;</span><br><span class="line">     user: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">     <span class="built_in">pwd</span>: <span class="string">&quot;password&quot;</span>,</span><br><span class="line">     roles: [ &#123; role: <span class="string">&quot;root&quot;</span>, db: <span class="string">&quot;admin&quot;</span> &#125; ]</span><br><span class="line">   &#125;</span><br><span class="line"> );</span><br></pre></td></tr></table></figure>

<h3 id="启动shard3服务"><a href="#启动shard3服务" class="headerlink" title="启动shard3服务"></a>启动shard3服务</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mongod --config /Users/hanqf/myservice_dir/mongodb-mongos/shard3/node1/mongod.conf</span><br><span class="line">mongod --config /Users/hanqf/myservice_dir/mongodb-mongos/shard3/node2/mongod.conf</span><br><span class="line">mongod --config /Users/hanqf/myservice_dir/mongodb-mongos/shard3/node3/mongod.conf</span><br></pre></td></tr></table></figure>
<h3 id="登录及配置-3"><a href="#登录及配置-3" class="headerlink" title="登录及配置"></a>登录及配置</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#登录任意一台config</span></span><br><span class="line">mongo --host 127.0.0.1:28031</span><br><span class="line"></span><br><span class="line">&gt;rs.initiate(</span><br><span class="line">  &#123;</span><br><span class="line">    _id: <span class="string">&quot;shard3&quot;</span>,</span><br><span class="line">    members: [</span><br><span class="line">      &#123; _id : 0, host : <span class="string">&quot;127.0.0.1:28031&quot;</span> &#125;,</span><br><span class="line">      &#123; _id : 1, host : <span class="string">&quot;127.0.0.1:28032&quot;</span> &#125;,</span><br><span class="line">      &#123; _id : 2, host : <span class="string">&quot;127.0.0.1:28033&quot;</span> &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建超级管理员，此时要求登录的是主库</span></span><br><span class="line">&gt;rs.isMaster() <span class="comment">#验证是否主库</span></span><br><span class="line">&gt;use admin</span><br><span class="line">&gt;db.createUser(</span><br><span class="line">   &#123;</span><br><span class="line">     user: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">     <span class="built_in">pwd</span>: <span class="string">&quot;password&quot;</span>,</span><br><span class="line">     roles: [ &#123; role: <span class="string">&quot;root&quot;</span>, db: <span class="string">&quot;admin&quot;</span> &#125; ]</span><br><span class="line">   &#125;</span><br><span class="line"> );</span><br></pre></td></tr></table></figure>


<h2 id="重启router服务"><a href="#重启router服务" class="headerlink" title="重启router服务"></a>重启router服务</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mongos --config /Users/hanqf/myservice_dir/mongodb-mongos/router/node1/mongos.conf</span><br><span class="line">mongos --config /Users/hanqf/myservice_dir/mongodb-mongos/router/node2/mongos.conf</span><br></pre></td></tr></table></figure>

<h2 id="分片配置"><a href="#分片配置" class="headerlink" title="分片配置"></a>分片配置</h2><p>登录任意router</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mongo --host 127.0.0.1:29021</span><br><span class="line">&gt;use admin</span><br><span class="line">&gt;db.auth(<span class="string">&quot;root&quot;</span>,<span class="string">&quot;password&quot;</span>)</span><br><span class="line"></span><br><span class="line">&gt;sh.addShard( <span class="string">&quot;shard1/127.0.0.1:28011,127.0.0.1:28012,127.0.0.1:28013&quot;</span>)</span><br><span class="line">&gt;sh.addShard( <span class="string">&quot;shard2/127.0.0.1:28021,127.0.0.1:28022,127.0.0.1:28023&quot;</span>)</span><br><span class="line">&gt;sh.addShard( <span class="string">&quot;shard3/127.0.0.1:28031,127.0.0.1:28032,127.0.0.1:28033&quot;</span>)</span><br><span class="line"><span class="comment">#查看集群状态</span></span><br><span class="line">&gt;sh.status()</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建数据库用户，客户端可以使用该用户连接mongo路由</span></span><br><span class="line">&gt;use springboot</span><br><span class="line">&gt;db.createUser(</span><br><span class="line">   &#123;</span><br><span class="line">     user: <span class="string">&quot;springboot&quot;</span>,</span><br><span class="line">     <span class="built_in">pwd</span>: <span class="string">&quot;123456&quot;</span>,</span><br><span class="line">     roles: [ &#123; role: <span class="string">&quot;dbOwner&quot;</span>, db: <span class="string">&quot;springboot&quot;</span> &#125; ]</span><br><span class="line">   &#125;</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line"><span class="comment">#指定要分片的数据库</span></span><br><span class="line">&gt;sh.enableSharding(<span class="string">&quot;springboot&quot;</span>)</span><br><span class="line"><span class="comment">#指定集合的分片规则</span></span><br><span class="line"><span class="comment">#这里表示指定springboot库下的user集合的_id字段（也就是主键，每个集合都有这个字段）按hash散列进行分片，&#123; id : 1 &#125;表示按字段id进度范围分片，这里id必须是整型</span></span><br><span class="line"><span class="comment">#要分片存储的集合都需要指定分片规则，分片规则一经创建不可修改，只能删除集合再重新设置</span></span><br><span class="line">&gt;sh.shardCollection(<span class="string">&quot;springboot.user&quot;</span>, &#123; _id : <span class="string">&quot;hashed&quot;</span> &#125; )</span><br><span class="line"></span><br><span class="line">&gt;use springboot</span><br><span class="line"><span class="comment">#查询user的集合状态</span></span><br><span class="line">&gt;db.user.stats()</span><br></pre></td></tr></table></figure>
<!--
这是一个注释，可以写很多内容，哈哈
-->
<blockquote class="blockquote-center">
<h3 id="小贴士"><a href="#小贴士" class="headerlink" title="小贴士"></a>小贴士</h3>
</blockquote>

<div class="note info"><h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h3><ul>
<li>正式环境注意权限控制，使客户端只能连接router</li>
<li>可以创建任意多个router</li>
<li>springboot连接方式：<br><code>spring.data.mongodb.uri=mongodb://springboot:123456@127.0.0.1:29021,127.0.0.1:29022/springboot?authSource=springboot</code></li>
</ul>
</div>
]]></content>
      <categories>
        <category>技术</category>
      </categories>
      <tags>
        <tag>mongo</tag>
      </tags>
  </entry>
  <entry>
    <title>Redis集群</title>
    <url>/2018/12/27/redis-cluster/</url>
    <content><![CDATA[<h2 id="一、摘要"><a href="#一、摘要" class="headerlink" title="一、摘要"></a>一、摘要</h2><p>看完本文你将掌握如下知识点：</p>
<ul>
<li>redis集群的构建方法【redis-5.0.2】</li>
<li>redis早期的版本中使用基于ruby的<code>redis-trib.rb</code>命令进行集群创建，新版本推荐使用 <code>redis-cli --cluster</code>，本文就是通过<code>redis-cli --cluster</code>命令实现集群构建。</li>
</ul>
<span id="more"></span>

<h2 id="二、快速创建集群"><a href="#二、快速创建集群" class="headerlink" title="二、快速创建集群"></a>二、快速创建集群</h2><p>redis为我们提供了快速创建集群的工具，安装好redis后，在其<code>/redis-5.0.2/utils/create-cluster/</code>目录下存在一个<code>create-cluster</code>命令，通过该命令可以快速创建一个基于本机端口30001~30006的三主三从的redis集群，可以通过修改端口号及服务数量来改变集群的配置。<br>1.启动6个redis服务，<code>./create-cluster start</code><br>2.创建集群，<code>./create-cluster create</code><br>3.关闭集群服务，<code>./create-cluster stop</code><br>4.清除数据及日志文件，<code>./create-cluster clean</code></p>
<h2 id="三、源码分析"><a href="#三、源码分析" class="headerlink" title="三、源码分析"></a>三、源码分析</h2><p>通过看源码可以很清楚其创建过程<br>1.启动6个reids服务，通过参数的方式进行启动，在生产环境中建议通过配置文件启动</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">if [ &quot;$1&quot; == &quot;start&quot; ]</span><br><span class="line">then</span><br><span class="line">    while [ $((PORT &lt; ENDPORT)) != &quot;0&quot; ]; do</span><br><span class="line">        PORT=$((PORT+1))</span><br><span class="line">        echo &quot;Starting $PORT&quot;</span><br><span class="line">        ../../src/redis-server --port $PORT --cluster-enabled yes --cluster-config-file nodes-$&#123;PORT&#125;.conf --cluster-node-timeout $TIMEOUT --appendonly yes --appendfilename appendonly-$&#123;PORT&#125;.aof --dbfilename dump</span><br><span class="line">-$&#123;PORT&#125;.rdb --logfile $&#123;PORT&#125;.log --daemonize yes</span><br><span class="line">    done</span><br><span class="line">    exit 0</span><br><span class="line">fi</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>参数说明：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#端口：</span><br><span class="line">port $PORT</span><br><span class="line">#是否启用集群：</span><br><span class="line">cluster-enabled yes</span><br><span class="line">#集群关联文件路径，创建redis集群时自动创建</span><br><span class="line">cluster-config-file nodes-$&#123;PORT&#125;.conf</span><br><span class="line">#集群节点间通信的超时时间，毫秒，建议2000，默认15000</span><br><span class="line">cluster-node-timeout $TIMEOUT</span><br><span class="line">#开启aof</span><br><span class="line">appendonly yes</span><br><span class="line">#aof文件名称，注意这里只能是文件名称，若要修改路径需要设置dir属性 ，如dir /home/hanqf/redis-dir/redis-5.0.2/cluster-conf/files/</span><br><span class="line">appendfilename appendonly-$&#123;PORT&#125;.aof</span><br><span class="line">#rdb文件名称，同样只能是文件名称，同上路径共用dir属性</span><br><span class="line">dbfilename dump-$&#123;PORT&#125;.rdb</span><br><span class="line">#日志文件路径</span><br><span class="line">logfile $&#123;PORT&#125;.log</span><br><span class="line">#后台运行模式启动</span><br><span class="line">daemonize yes</span><br></pre></td></tr></table></figure>

<p>2.构建集群，这里使用的就是<code>redis-cli --cluster</code>命令，可以看出与<code>redis-trib.rb</code>命令类似</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">if [ &quot;$1&quot; == &quot;create&quot; ]</span><br><span class="line">then</span><br><span class="line">    HOSTS=&quot;&quot;</span><br><span class="line">    while [ $((PORT &lt; ENDPORT)) != &quot;0&quot; ]; do</span><br><span class="line">        PORT=$((PORT+1))</span><br><span class="line">        HOSTS=&quot;$HOSTS 127.0.0.1:$PORT&quot;</span><br><span class="line">    done</span><br><span class="line">    ../../src/redis-cli --cluster create $HOSTS --cluster-replicas $REPLICAS</span><br><span class="line">    exit 0</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
<p><code>create</code>后根的<code>$HOSTS</code>就是redis服务列表</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">127.0.0.1:30001 127.0.0.1:30002 127.0.0.1:30003 127.0.0.1:30004 127.0.0.1:30005 127.0.0.1:30006</span><br></pre></td></tr></table></figure>
<p><code>--cluster-replicas $REPLICAS</code>，这里$REPLICAS值为1，表示为每一个master节点分配一个slave节点</p>
<h2 id="四、实际应用"><a href="#四、实际应用" class="headerlink" title="四、实际应用"></a>四、实际应用</h2><p>这里我们使用2台服务器，分别启动3个redis服务，来构建一个三主三从的redis集群。</p>
<h3 id="1-服务器IP"><a href="#1-服务器IP" class="headerlink" title="1.服务器IP"></a>1.服务器IP</h3><ul>
<li>10.211.55.15</li>
<li>10.211.55.16</li>
</ul>
<h3 id="2-端口设置"><a href="#2-端口设置" class="headerlink" title="2.端口设置"></a>2.端口设置</h3><p>分别开启俩台服务器的如下端口，前面是redis服务端口，后面是集群通信端口（默认服务端口+10000）</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">6379，16379</span><br><span class="line">6380，16380</span><br><span class="line">6381，16381</span><br></pre></td></tr></table></figure>

<h3 id="3-redis-port-conf"><a href="#3-redis-port-conf" class="headerlink" title="3.redis-{port}.conf"></a>3.redis-{port}.conf</h3><p>这里需要按照上面的参数说明进行配置，如我们配置号redis-6379.conf后，可以通过如下命令进行复制</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">more redis-6379.conf | sed &#x27;s/6379/6380/g&#x27; &gt; redis-6380.conf</span><br><span class="line">more redis-6379.conf | sed &#x27;s/6379/6381/g&#x27; &gt; redis-6381.conf</span><br></pre></td></tr></table></figure>

<h3 id="4-启动服务"><a href="#4-启动服务" class="headerlink" title="4.启动服务"></a>4.启动服务</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#10.211.55.15</span><br><span class="line">./redis-server redis-6379.conf</span><br><span class="line">./redis-server redis-6380.conf</span><br><span class="line">./redis-server redis-6381.conf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#10.211.55.16</span><br><span class="line">./redis-server redis-6379.conf</span><br><span class="line">./redis-server redis-6380.conf</span><br><span class="line">./redis-server redis-6381.conf</span><br></pre></td></tr></table></figure>

<h3 id="5-构建集群"><a href="#5-构建集群" class="headerlink" title="5.构建集群"></a>5.构建集群</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">./redis-cli --cluster create 10.211.55.15:6379 10.211.55.15:6380 10.211.55.15:6381 10.211.55.16:6379 10.211.55.16:6380 10.211.55.16:6381  --cluster-replicas 1</span><br></pre></td></tr></table></figure>

<h2 id="五、集群相关命令"><a href="#五、集群相关命令" class="headerlink" title="五、集群相关命令"></a>五、集群相关命令</h2><h3 id="1-健康检查"><a href="#1-健康检查" class="headerlink" title="1.健康检查"></a>1.健康检查</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 后面可以是集群中任意节点</span><br><span class="line">./redis-cli --cluster check 10.211.55.15:6380</span><br></pre></td></tr></table></figure>

<p>输出如下，可以看到集群中的主从关系，以及每个master中含有key的数量：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">10.211.55.15:6380 (c39c1e8a...) -&gt; 2 keys | 5461 slots | 1 slaves.</span><br><span class="line">10.211.55.16:6380 (3edc1dae...) -&gt; 5 keys | 5461 slots | 1 slaves.</span><br><span class="line">10.211.55.16:6379 (4dd31f17...) -&gt; 2 keys | 5462 slots | 1 slaves.</span><br><span class="line">[OK] 9 keys in 3 masters.</span><br><span class="line">0.00 keys per slot on average.</span><br><span class="line">&gt;&gt;&gt; Performing Cluster Check (using node 10.211.55.15:6380)</span><br><span class="line">M: c39c1e8aa6e07e337aaab03eab3727f739201cd2 10.211.55.15:6380</span><br><span class="line">   slots:[10923-16383] (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: a83903f50621d7627f3ce59f1210af4938b8acc4 10.211.55.15:6381</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 4dd31f17e83ef7aa6c7a36474f7f54d842e0ed64</span><br><span class="line">M: 3edc1daeaf3a848156ad8cc601b1374dd0459d9c 10.211.55.16:6380</span><br><span class="line">   slots:[0-5460] (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">M: 4dd31f17e83ef7aa6c7a36474f7f54d842e0ed64 10.211.55.16:6379</span><br><span class="line">   slots:[5461-10922] (5462 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: cb6a94201d6f5a4e016b1549afc8c976a1a3dda4 10.211.55.15:6379</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 3edc1daeaf3a848156ad8cc601b1374dd0459d9c</span><br><span class="line">S: 3f41a95296cb2681ea599f47aaff9c662b3338ad 10.211.55.16:6381</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates c39c1e8aa6e07e337aaab03eab3727f739201cd2</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line">&gt;&gt;&gt; Check for open slots...</span><br><span class="line">&gt;&gt;&gt; Check slots coverage...</span><br><span class="line">[OK] All 16384 slots covered.</span><br></pre></td></tr></table></figure>

<p>说明：此时如果关闭其中一个master节点，那么其对应的从节点就会升级为主节点，当重新启动原master节点后，则该节点会自动加入集群，并作为从节点。</p>
<h3 id="2-集群扩容，即为集群添加新的主机和从机"><a href="#2-集群扩容，即为集群添加新的主机和从机" class="headerlink" title="2.集群扩容，即为集群添加新的主机和从机"></a>2.集群扩容，即为集群添加新的主机和从机</h3><h4 id="2-1通过如下命令添加新的node"><a href="#2-1通过如下命令添加新的node" class="headerlink" title="2.1通过如下命令添加新的node"></a>2.1通过如下命令添加新的node</h4><p>说明：10.211.55.15:6382 是新的服务地址，10.211.55.16:6380 是集群中任意一个的服务地址,添加后的服务类型为master。</p>
<p>此时我们通过健康检查可以看到新加入的服务没有分配槽点：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">./redis-cli --cluster check 10.211.55.15:6380</span><br><span class="line">Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.</span><br><span class="line">Could not connect to Redis at 10.211.55.15:6379: Connection refused</span><br><span class="line">10.211.55.15:6380 (a5f63b8e...) -&gt; 2 keys | 5461 slots | 1 slaves.</span><br><span class="line">10.211.55.16:6379 (15506850...) -&gt; 2 keys | 5462 slots | 1 slaves.</span><br><span class="line">10.211.55.15:6382 (316e068f...) -&gt; 0 keys | 0 slots | 0 slaves.   #注意，这里新添加的主机没有分配槽（slot），需要先进行分配才能使用</span><br><span class="line">10.211.55.16:6380 (d944c0b1...) -&gt; 5 keys | 5461 slots | 0 slaves.</span><br><span class="line">[OK] 9 keys in 4 masters.</span><br><span class="line">0.00 keys per slot on average.</span><br><span class="line">&gt;&gt;&gt; Performing Cluster Check (using node 10.211.55.15:6380)</span><br><span class="line">M: a5f63b8e4f24a73d36da9e0bbf84988d7c5558d3 10.211.55.15:6380</span><br><span class="line">  slots:[10923-16383] (5461 slots) master</span><br><span class="line">  1 additional replica(s)</span><br><span class="line">M: 15506850b235f4277306368533cacf4a5ec1bbd1 10.211.55.16:6379</span><br><span class="line">  slots:[5461-10922] (5462 slots) master</span><br><span class="line">  1 additional replica(s)</span><br><span class="line">M: 316e068fd71ee228299198a271efd839d3493835 10.211.55.15:6382</span><br><span class="line">  slots: (0 slots) master</span><br><span class="line">S: b3c0e06da5b5d694c3a68408fb4c8f7607d7e9e0 10.211.55.16:6381</span><br><span class="line">  slots: (0 slots) slave</span><br><span class="line">  replicates a5f63b8e4f24a73d36da9e0bbf84988d7c5558d3</span><br><span class="line">M: d944c0b19e92af325b882e3a86ff09c2b6b53f47 10.211.55.16:6380</span><br><span class="line">  slots:[0-5460] (5461 slots) master</span><br><span class="line">S: 4bce4c24959bda55d087296e86f58ec03186d3ae 10.211.55.15:6381</span><br><span class="line">  slots: (0 slots) slave</span><br><span class="line">  replicates 15506850b235f4277306368533cacf4a5ec1bbd1</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line">&gt;&gt;&gt; Check for open slots...</span><br><span class="line">&gt;&gt;&gt; Check slots coverage...</span><br><span class="line">[OK] All 16384 slots covered.</span><br></pre></td></tr></table></figure>

<h4 id="2-2分配槽"><a href="#2-2分配槽" class="headerlink" title="2.2分配槽"></a>2.2分配槽</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">./redis-cli --cluster reshard 10.211.55.15:6382</span><br></pre></td></tr></table></figure>
<p>执行命令后会有如下设置：<br>  1.问你是否从原有的1-16384个槽中分配多少到新的主节点，我们这里分配4000为例，回车<br>    2：然后紧接着会询问你给id为谁的主节点分配，这里就是新加的节点10.211.55.15:6382，其对应的Id为:316e068fd71ee228299198a271efd839d3493835<br>    3：询问你是从所有的空间去给这个节点分配空间还是从某一个节点分配，我这里输入all  回车继续<br>    4：然后会给你分配出一个分配计划，输入yes开始分配。完成ok</p>
<p>此时再次运行健康检查可以看到槽点已经分配成功</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">./redis-cli --cluster check localhost:6380</span><br><span class="line">Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.</span><br><span class="line">localhost:6380 (a5f63b8e...) -&gt; 1 keys | 4128 slots | 1 slaves.</span><br><span class="line">10.211.55.16:6379 (15506850...) -&gt; 2 keys | 4128 slots | 1 slaves.</span><br><span class="line">10.211.55.15:6382 (316e068f...) -&gt; 2 keys | 4000 slots | 0 slaves.</span><br><span class="line">10.211.55.16:6380 (d944c0b1...) -&gt; 4 keys | 4128 slots | 1 slaves.</span><br><span class="line">[OK] 9 keys in 4 masters.</span><br><span class="line">0.00 keys per slot on average.</span><br><span class="line">………………………………</span><br></pre></td></tr></table></figure>


<h4 id="2-3平衡槽，就是均匀分配集群中的所有槽到所有的节点，该步非必须，只是看着好看点"><a href="#2-3平衡槽，就是均匀分配集群中的所有槽到所有的节点，该步非必须，只是看着好看点" class="headerlink" title="2.3平衡槽，就是均匀分配集群中的所有槽到所有的节点，该步非必须，只是看着好看点"></a>2.3平衡槽，就是均匀分配集群中的所有槽到所有的节点，该步非必须，只是看着好看点</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">./redis-cli --cluster rebalance --cluster-threshold 1 10.211.55.15:6382</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">./redis-cli --cluster info localhost:6380</span><br><span class="line">Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.</span><br><span class="line">localhost:6380 (a5f63b8e...) -&gt; 1 keys | 4096 slots | 1 slaves.</span><br><span class="line">10.211.55.16:6379 (15506850...) -&gt; 2 keys | 4096 slots | 1 slaves.</span><br><span class="line">10.211.55.15:6382 (316e068f...) -&gt; 2 keys | 4096 slots | 0 slaves.</span><br><span class="line">10.211.55.16:6380 (d944c0b1...) -&gt; 4 keys | 4096 slots | 1 slaves.</span><br><span class="line">[OK] 9 keys in 4 masters.</span><br><span class="line">0.00 keys per slot on average.</span><br></pre></td></tr></table></figure>


<h4 id="2-4为新加入的master添加slave"><a href="#2-4为新加入的master添加slave" class="headerlink" title="2.4为新加入的master添加slave"></a>2.4为新加入的master添加slave</h4><p>同样需要先加入集群</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">./redis-cli --cluster add-node 10.211.55.16:6382 10.211.55.16:6380</span><br></pre></td></tr></table></figure>

<p>之后不需要做分配和平衡槽的操作<br>登录这个redis， <code>./redis-cli -h 10.211.55.16 -p 6382</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">127.0.0.1:6382&gt; cluster replicate 316e068fd71ee228299198a271efd839d3493835 #主节点的id</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>


<h3 id="3-删除节点"><a href="#3-删除节点" class="headerlink" title="3.删除节点"></a>3.删除节点</h3><h4 id="3-1删除主节点"><a href="#3-1删除主节点" class="headerlink" title="3.1删除主节点"></a>3.1删除主节点</h4><p>删除节点前，节点上的槽要被清空</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">./redis-cli --cluster reshard 10.211.55.15:6382 #集群中任意ip即可</span><br></pre></td></tr></table></figure>
<p>  1.问你是否从原有的1-16384个槽中分配多少到新的主节点我们这里分配4096，即该节点上的槽数<br>    2：然后紧接着会询问你给id为谁的主节点分配，这里我们分配给10.211.55.16:6379，即15506850b235f4277306368533cacf4a5ec1bbd1<br>    3：询问你是从所有的空间去给这个节点分配空间还是从某一个节点分配<br>    我这里输入要移出的节点ID ,即316e068fd71ee228299198a271efd839d3493835 回车继续 输入 done<br>    4：然后会给你分配出一个分配计划，输入yes开始分配。完成ok</p>
<p>执行删除节点命令</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">./redis-cli --cluster del-node 10.211.55.16:6379 316e068fd71ee228299198a271efd839d3493835</span><br><span class="line">Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.</span><br><span class="line">&gt;&gt;&gt; Removing node 316e068fd71ee228299198a271efd839d3493835 from cluster 10.211.55.16:6379</span><br><span class="line">&gt;&gt;&gt; Sending CLUSTER FORGET messages to the cluster...</span><br><span class="line">&gt;&gt;&gt; SHUTDOWN the node.</span><br></pre></td></tr></table></figure>

<p>说明：<br>删除节点会自动关闭被移出的redis服务，此时，该主节点的从节点会自动转为其它主节点的从节点，而不会升级为主节点</p>
<h4 id="3-2删除从节点"><a href="#3-2删除从节点" class="headerlink" title="3.2删除从节点"></a>3.2删除从节点</h4><p>直接执行节点删除命令</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">./redis-cli --cluster del-node 10.211.55.16:6379 从节点ID</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>技术</category>
      </categories>
      <tags>
        <tag>redis</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Boot2学习笔记--activemq</title>
    <url>/2018/12/12/activemq-springboot/</url>
    <content><![CDATA[<h2 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h2><p>看完本文你将掌握如下知识点：</p>
<ul>
<li>Spring Boot(2.1.1.RELEASE)中使用<a href="http://activemq.apache.org/">activemq(5.15.8)</a>的方法</li>
</ul>
<span id="more"></span>

<h2 id="引入依赖"><a href="#引入依赖" class="headerlink" title="引入依赖"></a>引入依赖</h2><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- activemq自动配置依赖 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-activemq<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 连接池依赖 --&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.activemq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>activemq-pool<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">&lt;!-- 如果springboot是2.x.x的版本如果启用连接池（spring.activemq.pool.enabled=true），就必须引入这个依赖，否则启动时会报错，提示找不到JmsMessagingTemplate</span></span><br><span class="line"><span class="comment">      springboot是1.5.x的版本就不需要引入，</span></span><br><span class="line"><span class="comment">      这是因为springboot1.5.x使用的是org.apache.activemq.pool.PooledConnectionFactory，</span></span><br><span class="line"><span class="comment">      而springboot2.x.x时候用的org.messaginghub.pooled.jms.JmsPoolConnectionFactory，</span></span><br><span class="line"><span class="comment">      可以通过源码查看：</span></span><br><span class="line"><span class="comment">      org.springframework.boot.autoconfigure.jms.activemq.ActiveMQConnectionFactoryConfiguration : 负责初始化ConnectionFactory</span></span><br><span class="line"><span class="comment">      org.springframework.boot.autoconfigure.jms.JmsAutoConfiguration  : 负责初始化JmsMessagingTemplate --&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.messaginghub<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>pooled-jms<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">spring.activemq.broker-url</span>=<span class="string">tcp://localhost:61616</span></span><br><span class="line"><span class="meta">spring.activemq.user</span>=<span class="string">admin</span></span><br><span class="line"><span class="meta">spring.activemq.password</span>=<span class="string">admin</span></span><br><span class="line"><span class="comment">#启用连接池</span></span><br><span class="line"><span class="meta">spring.activemq.pool.enabled</span>=<span class="string">true</span></span><br><span class="line"><span class="comment">#最大连接数</span></span><br><span class="line"><span class="meta">spring.activemq.pool.max-connections</span>=<span class="string">100</span></span><br></pre></td></tr></table></figure>

<h2 id="配置类"><a href="#配置类" class="headerlink" title="配置类"></a>配置类</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableJms</span> <span class="comment">//启用jms功能</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ActiveMqConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果要使用topic类型的消息，则需要配置该bean</span></span><br><span class="line">    <span class="meta">@Bean(&quot;jmsTopicListenerContainerFactory&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JmsListenerContainerFactory <span class="title">jmsTopicListenerContainerFactory</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">            ConnectionFactory connectionFactory</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>&#123;</span><br><span class="line">        DefaultJmsListenerContainerFactory factory</span><br><span class="line">                = <span class="keyword">new</span> DefaultJmsListenerContainerFactory();</span><br><span class="line">        factory.setConnectionFactory(connectionFactory);</span><br><span class="line">        factory.setPubSubDomain(<span class="keyword">true</span>); <span class="comment">//这里必须设置为true，false则表示是queue类型</span></span><br><span class="line">        <span class="keyword">return</span> factory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;springboot.queue&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Queue <span class="title">queue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ActiveMQQueue(<span class="string">&quot;springboot.queue&quot;</span>) ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;springboot.topic&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Topic <span class="title">topic</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ActiveMQTopic(<span class="string">&quot;springboot.topic&quot;</span>) ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;springboot.queuereply&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Queue <span class="title">queuereply</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ActiveMQQueue(<span class="string">&quot;springboot.queuereply&quot;</span>) ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="消费者"><a href="#消费者" class="headerlink" title="消费者"></a>消费者</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Consumer</span> </span>&#123;</span><br><span class="line">    <span class="comment">//监听队列，queue类型</span></span><br><span class="line">    <span class="meta">@JmsListener(destination=&quot;springboot.queue.a&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receiveQueueA</span><span class="params">(String text)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="keyword">this</span>.getClass().getName()+ <span class="string">&quot;收到的报文为:&quot;</span>+text);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JmsListener(destination=&quot;springboot.*.b&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receiveQueueB</span><span class="params">(String text)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="keyword">this</span>.getClass().getName()+ <span class="string">&quot;收到的报文为:&quot;</span>+text);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JmsListener(destination=&quot;springboot.&gt;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receiveQueueAll</span><span class="params">(String text)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="keyword">this</span>.getClass().getName()+ <span class="string">&quot;收到的报文为:&quot;</span>+text);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//监听队列，topic类型，这里containerFactory要配置为jmsTopicListenerContainerFactory</span></span><br><span class="line">    <span class="meta">@JmsListener(destination = &quot;springboot.topic&quot;,</span></span><br><span class="line"><span class="meta">            containerFactory = &quot;jmsTopicListenerContainerFactory&quot;</span></span><br><span class="line"><span class="meta">    )</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receiveTopic</span><span class="params">(String text)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="keyword">this</span>.getClass().getName()+<span class="string">&quot; 收到的报文为:&quot;</span>+text);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@JmsListener(destination=&quot;springboot.queuereply&quot;)</span></span><br><span class="line">    <span class="meta">@SendTo(&quot;out.replyTo.queue&quot;)</span> <span class="comment">//消费者应答后通知生产者</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">receiveQueueReply</span><span class="params">(String text)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="keyword">this</span>.getClass().getName()+ <span class="string">&quot;收到的报文为:&quot;</span>+text);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;out.replyTo.queue receiveQueueReply&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="生产者"><a href="#生产者" class="headerlink" title="生产者"></a>生产者</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Producer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource(&quot;springboot.queue.a&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Queue queuea;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource(&quot;springboot.queue.b&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Queue queueb;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource(&quot;springboot.topic&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Topic topic;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource(&quot;springboot.queuereply&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Queue queuereply;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JmsMessagingTemplate jmsTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发送消息，destination是发送到的队列，message是待发送的消息</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendMessage</span><span class="params">(Destination destination, <span class="keyword">final</span> String message)</span></span>&#123;</span><br><span class="line">        jmsTemplate.convertAndSend(destination, message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendQueueAMessage</span><span class="params">(<span class="keyword">final</span> String message)</span></span>&#123;</span><br><span class="line">        sendMessage(queuea, message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendQueueBMessage</span><span class="params">(<span class="keyword">final</span> String message)</span></span>&#123;</span><br><span class="line">        sendMessage(queueb, message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendTopicMessage</span><span class="params">(<span class="keyword">final</span> String message)</span></span>&#123;</span><br><span class="line">        sendMessage(topic, message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendQueueMessageReply</span><span class="params">(<span class="keyword">final</span> String message)</span></span>&#123;</span><br><span class="line">        sendMessage(queuereply, message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//生产者监听消费者的应答</span></span><br><span class="line">    <span class="meta">@JmsListener(destination = &quot;out.replyTo.queue&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">consumerMessage</span><span class="params">(String text)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;从out.replyTo.queue收到报文&quot;</span>+text);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>技术</category>
        <category>springboot2</category>
        <category>Java</category>
      </categories>
      <tags>
        <tag>springboot</tag>
        <tag>activemq</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Boot2学习笔记--thymeleaf</title>
    <url>/2018/10/10/thymeleaf_study/</url>
    <content><![CDATA[<h2 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h2><p>看完本文你将掌握如下知识点：</p>
<ul>
<li>Spring Boot(2.0.4)中使用<a href="https://www.thymeleaf.org/">thymeleaf(3.0.9)</a>的常用语法</li>
</ul>
<span id="more"></span>

<h2 id="项目准备"><a href="#项目准备" class="headerlink" title="项目准备"></a>项目准备</h2><h3 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--spring对thymeleaf的支持--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="开启spring-boot对thymeleaf的支持"><a href="#开启spring-boot对thymeleaf的支持" class="headerlink" title="开启spring boot对thymeleaf的支持"></a>开启spring boot对thymeleaf的支持</h3><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment">##thymeleaf</span></span><br><span class="line"><span class="meta">spring.thymeleaf.enabled</span>=<span class="string">true</span></span><br><span class="line"><span class="meta">spring.thymeleaf.prefix</span>=<span class="string">classpath:/templates/</span></span><br><span class="line"><span class="meta">spring.thymeleaf.suffix</span>=<span class="string">.html</span></span><br><span class="line"><span class="meta">spring.thymeleaf.encoding</span>=<span class="string">UTF-8</span></span><br><span class="line"><span class="meta">spring.thymeleaf.mode</span>=<span class="string">HTML</span></span><br><span class="line"><span class="comment">#关闭页面缓存</span></span><br><span class="line"><span class="meta">spring.thymeleaf.cache</span>=<span class="string">false</span></span><br><span class="line"><span class="meta">spring.thymeleaf.servlet.content-type</span>=<span class="string">text/html</span></span><br></pre></td></tr></table></figure>

<p>也可以通过@Bean的方式开启支持</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ThymeleafViewResolver <span class="title">thymeleafViewResolver</span><span class="params">()</span></span>&#123;</span><br><span class="line">    log.info(<span class="string">&quot;thymeleafViewResolver&quot;</span>);</span><br><span class="line">    ThymeleafViewResolver viewResolver = <span class="keyword">new</span> ThymeleafViewResolver();</span><br><span class="line">    viewResolver.setTemplateEngine(templateEngine());</span><br><span class="line">    viewResolver.setOrder(<span class="number">1</span>);</span><br><span class="line">    viewResolver.setCharacterEncoding(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">    viewResolver.setContentType(<span class="string">&quot;text/html&quot;</span>);</span><br><span class="line">    viewResolver.setCache(<span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">return</span> viewResolver;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> SpringResourceTemplateResolver <span class="title">templateResolver</span><span class="params">()</span></span>&#123;</span><br><span class="line">    SpringResourceTemplateResolver templateResolver = <span class="keyword">new</span> SpringResourceTemplateResolver();</span><br><span class="line">    templateResolver.setApplicationContext(<span class="keyword">this</span>.applicationContext);</span><br><span class="line">    templateResolver.setPrefix(<span class="string">&quot;classpath:/templates/&quot;</span>);</span><br><span class="line">    templateResolver.setSuffix(<span class="string">&quot;.html&quot;</span>);</span><br><span class="line">    templateResolver.setTemplateMode(TemplateMode.HTML);</span><br><span class="line">    templateResolver.setCacheable(<span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">return</span> templateResolver;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> SpringTemplateEngine <span class="title">templateEngine</span><span class="params">()</span></span>&#123;</span><br><span class="line">    SpringTemplateEngine templateEngine = <span class="keyword">new</span> SpringTemplateEngine();</span><br><span class="line">    templateEngine.setTemplateResolver(templateResolver());</span><br><span class="line">    templateEngine.setEnableSpringELCompiler(<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">return</span> templateEngine;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="开启html页面对thymeleaf语法的支持"><a href="#开启html页面对thymeleaf语法的支持" class="headerlink" title="开启html页面对thymeleaf语法的支持"></a>开启html页面对thymeleaf语法的支持</h3><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h2><h3 id="各种表达式语法"><a href="#各种表达式语法" class="headerlink" title="各种表达式语法"></a>各种表达式语法</h3><ol>
<li><p>${…} 变量表达式，用于展示后台传递过来的变量（request和session中的值）</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;modify&quot;</span> <span class="attr">th:value</span>=<span class="string">&quot;$&#123;modify&#125;&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;id&quot;</span> <span class="attr">th:value</span>=<span class="string">&quot;$&#123;dataObj.id&#125;&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">textarea</span>  <span class="attr">name</span>=<span class="string">&quot;logParamData&quot;</span> <span class="attr">id</span>=<span class="string">&quot;logParamData&quot;</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;dataObj.logParamData&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line"></span><br><span class="line">以下两种方式效果一致</span><br><span class="line"><span class="tag">&lt;<span class="name">span</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;dataObj.name&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">span</span>&gt;</span>[[$&#123;dataObj.name&#125;]]<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"></span><br><span class="line">字符串拼接，可以使用加号，也可以使用竖线，以下两种方式效果一致</span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span> <span class="attr">name</span>=<span class="string">&quot;accessTypes&quot;</span> <span class="attr">th:value</span>=<span class="string">&quot;$&#123;item.id&#125;+&#x27;_&#x27;+$&#123;type.id&#125;&quot;</span> <span class="attr">checked</span>=<span class="string">&quot;checked&quot;</span>&gt;</span> [[$&#123;type.name&#125;]</span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span> <span class="attr">name</span>=<span class="string">&quot;accessTypes&quot;</span> <span class="attr">th:value</span>=<span class="string">&quot;$&#123;|$&#123;item.id&#125;_$&#123;type.id&#125;|&#125;&quot;</span> <span class="attr">checked</span>=<span class="string">&quot;checked&quot;</span>&gt;</span> [[$&#123;type.name&#125;]</span><br><span class="line"></span><br><span class="line">#dates与java.util.Date对象的方法对应，格式化、日期组件抽取等等</span><br><span class="line"><span class="tag">&lt;<span class="name">td</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;#dates.format(item.logTime, &#x27;yyyy-MM-dd&#x27;)&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">td</span>&gt;</span>[[$&#123;#dates.format(item.logTime, &#x27;yyyy-MM-dd&#x27;)&#125;]]<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p>#{…} 国际化消息表达式，用于展示message.properties等国际化资源文件中的内容</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span> <span class="attr">name</span>=<span class="string">&quot;selectAll&quot;</span> <span class="attr">id</span>=<span class="string">&quot;selectAll&quot;</span> <span class="attr">th:text</span>=<span class="string">&quot;#&#123;common.choose&#125;&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">消息中需要传递变量的情况，多个变量逗号分割</span><br><span class="line"><span class="tag">&lt;<span class="name">strong</span> <span class="attr">th:text</span>=<span class="string">&quot;#&#123;common.page.summary($&#123;_pageBean.pageCount&#125;,$&#123;_pageBean.total&#125;)&#125;&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">以下两种方式效果一致</span><br><span class="line"><span class="tag">&lt;<span class="name">td</span> <span class="attr">th:text</span>=<span class="string">&quot;#&#123;common.operate&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">td</span>&gt;</span>[[#&#123;common.operate&#125;]]<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p>@{…} 链接url表达式，用于封装url，如contextPath补全</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;/resource/css/netqin.css&#125;&quot;</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span>/&gt;</span></span><br><span class="line">用两个竖线来拼接带表达式的字符串</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span> <span class="attr">th:src</span>=<span class="string">&quot;@&#123;|/resource/js/i18n/list.#&#123;locale&#125;.js|&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">带请求参数的url，多个用逗号分割</span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;/auth/systemLogger/edit.do(id=$&#123;item.id&#125;,flag=$&#123;flag&#125;)&#125;&quot;</span> <span class="attr">th:text</span>=<span class="string">&quot;#&#123;common.edit&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p>js和css中用到表达式时使用双中括号的方式</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> modify = <span class="string">&quot;[[$&#123;modify&#125;]]&quot;</span>;</span><br><span class="line"><span class="keyword">if</span>(modify != <span class="string">&quot;add&quot;</span>)&#123;</span><br><span class="line">    $(<span class="string">&quot;#password&quot;</span>).attr(<span class="string">&quot;placeholder&quot;</span>,<span class="string">&quot;[[#&#123;user.detail.changeNotice&#125;]]&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>*{…} 选择变量表达式，用于简写变量名称，需要配合th:object一起使用</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">th:object</span>=<span class="string">&quot;$&#123;user&#125;&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>firstName: <span class="tag">&lt;<span class="name">span</span> <span class="attr">th:text</span>=<span class="string">&quot;*&#123;firstName&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>lastName: <span class="tag">&lt;<span class="name">span</span> <span class="attr">th:text</span>=<span class="string">&quot;*&#123;lastName&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">相当于</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>firstName: <span class="tag">&lt;<span class="name">span</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;user.firstName&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>lastName: <span class="tag">&lt;<span class="name">span</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;user.lastName&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p><del>{…} 代码块表达式，用于在html中复用相同的结构<br>语法：</del>{templatename::fragmentname}<br>示例：<br>common/model.html，th:fragment=”header”指定代码块名称</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span> <span class="attr">th:fragment</span>=<span class="string">&quot;header&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;Content-Type&quot;</span> <span class="attr">content</span>=<span class="string">&quot;text/html; charset=UTF-8&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">META</span> <span class="attr">http-equiv</span>=<span class="string">&quot;Pragma&quot;</span> <span class="attr">content</span>=<span class="string">&quot;no-cache&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">META</span> <span class="attr">http-equiv</span>=<span class="string">&quot;Cache-Control&quot;</span> <span class="attr">content</span>=<span class="string">&quot;no-cache&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">META</span> <span class="attr">http-equiv</span>=<span class="string">&quot;Expire&quot;</span> <span class="attr">content</span>=<span class="string">&quot;0&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;/resource/css/bootstrap.min.css&#125;&quot;</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;/resource/css/ace.min.css&#125;&quot;</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;/resource/css/font-awesome.min.css&#125;&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">th:src</span>=<span class="string">&quot;@&#123;/resource/js/jquery-1.11.0.min.js&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<p>demo.html，th:replace=”common/model::header”，模板名称::代码块名称</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">header</span> <span class="attr">th:replace</span>=<span class="string">&quot;common/model::header&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">header</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>说明：代码块表达式需要配合th属性（th:insert，th:replace，th:include）一起使用。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">th:insert：将代码块片段整个插入到使用了th:insert的HTML标签中，</span><br><span class="line">th:replace：将代码块片段整个替换使用了th:replace的HTML标签中，</span><br><span class="line">th:include：将代码块片段包含的内容插入到使用了th:include的HTML标签中，</span><br></pre></td></tr></table></figure>

<h3 id="遍历"><a href="#遍历" class="headerlink" title="遍历"></a>遍历</h3><h4 id="简单示例"><a href="#简单示例" class="headerlink" title="简单示例"></a>简单示例</h4><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tr</span> <span class="attr">th:each</span>=<span class="string">&quot;item:$&#123;results&#125;&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span> <span class="attr">name</span>=<span class="string">&quot;ids&quot;</span> <span class="attr">th:value</span>=<span class="string">&quot;$&#123;item.id&#125;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;noborder&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">td</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;item.id&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">    [[$&#123;#dates.format(item.logTime, &#x27;yyyy-MM-dd&#x27;)&#125;]]</span><br><span class="line"><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">td</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;item.logDesc&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">td</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;item.logUser&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="带遍历状态的示例"><a href="#带遍历状态的示例" class="headerlink" title="带遍历状态的示例"></a>带遍历状态的示例</h4><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tr</span> <span class="attr">th:each</span>=<span class="string">&quot;item,status:$&#123;results&#125;&quot;</span> <span class="attr">th:class</span>=<span class="string">&quot;$&#123;status.odd&#125;? &#x27;odd&#x27;:&#x27;even&#x27;&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span> <span class="attr">name</span>=<span class="string">&quot;ids&quot;</span> <span class="attr">th:value</span>=<span class="string">&quot;$&#123;item.id&#125;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;noborder&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">td</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;item.id&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">    [[$&#123;#dates.format(item.logTime, &#x27;yyyy-MM-dd&#x27;)&#125;]]</span><br><span class="line"><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">td</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;item.logDesc&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">td</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;item.logUser&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>状态说明<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">index：当前遍历索引，从0开始</span><br><span class="line">count：当前遍历索引，从1开始</span><br><span class="line">size：总元素数量</span><br><span class="line">current：每一次遍历的iter变量</span><br><span class="line">even/odd：当前遍历是even还是odd，布尔属性</span><br><span class="line">first：当前遍历是第一个，布尔属性</span><br><span class="line">last：当前遍历是最后一个，布尔属性</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="遍历时可以自定义变量"><a href="#遍历时可以自定义变量" class="headerlink" title="遍历时可以自定义变量"></a>遍历时可以自定义变量</h4><figure class="highlight html"><table><tr><td class="code"><pre><span class="line">th:with：用于定义变量，多个使用逗号分割</span><br><span class="line"><span class="tag">&lt;<span class="name">span</span> <span class="attr">th:each</span>=<span class="string">&quot;type,status:$&#123;accessTypes&#125;&quot;</span> <span class="attr">th:with</span>=<span class="string">&quot;shwoName=$&#123;item.id&#125;+&#x27;_&#x27;+$&#123;item.name&#125;&quot;</span>&gt;</span></span><br><span class="line">[[$&#123;shwoName&#125;]]</span><br><span class="line"><span class="tag">&lt;<span class="name">span</span> <span class="attr">th:if</span>=<span class="string">&quot;$&#123;not status.last&#125;&quot;</span>&gt;</span>,<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="条件判断"><a href="#条件判断" class="headerlink" title="条件判断"></a>条件判断</h3><h4 id="th-if"><a href="#th-if" class="headerlink" title="th:if"></a>th:if</h4><figure class="highlight html"><table><tr><td class="code"><pre><span class="line">判断为true时才会显示div，authorities为Set类型，所以判断是否包含时可以使用#sets.contains()方法，测试时发现使用#arrays.contains()方法时也可以</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">th:if</span>=<span class="string">&quot;$&#123;dataObj.reserved&#125;&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">th:each</span>=<span class="string">&quot;item:$&#123;dataObj.authorities&#125;&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span> <span class="attr">name</span>=<span class="string">&quot;authorities&quot;</span> <span class="attr">th:value</span>=<span class="string">&quot;$&#123;item.id&#125;&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">th:if</span>=<span class="string">&quot;$&#123;dataObj.authorities ==null or not #sets.contains(dataObj.authorities,item)&#125;&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span> <span class="attr">name</span>=<span class="string">&quot;authorities&quot;</span> <span class="attr">th:value</span>=<span class="string">&quot;$&#123;item.id&#125;&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">checked</span>=<span class="string">&quot;checked&quot;</span> <span class="attr">th:if</span>=<span class="string">&quot;$&#123;dataObj.authorities !=null and #sets.contains(dataObj.authorities,item)&#125;&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;item.showNameRole&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">如果要判断为false时才会显示div，可以判断值是否等于false，或者使用th:unless</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">th:if</span>=<span class="string">&quot;$&#123;dataObj.reserved==false&#125;&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">th:each</span>=<span class="string">&quot;item:$&#123;dataObj.authorities&#125;&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span> <span class="attr">name</span>=<span class="string">&quot;authorities&quot;</span> <span class="attr">th:value</span>=<span class="string">&quot;$&#123;item.id&#125;&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;item.showNameRole&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">th:unless</span>=<span class="string">&quot;$&#123;dataObj.reserved&#125;&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">th:each</span>=<span class="string">&quot;item:$&#123;dataObj.authorities&#125;&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span> <span class="attr">name</span>=<span class="string">&quot;authorities&quot;</span> <span class="attr">th:value</span>=<span class="string">&quot;$&#123;item.id&#125;&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;item.showNameRole&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>th:if 以下情况运算为true<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">值不为null</span><br><span class="line">值为boolean且为true</span><br><span class="line">值为数字且非0</span><br><span class="line">值为字符且非0</span><br><span class="line">值是字符串且不是：“false”，“off”，“no”</span><br><span class="line">值是object,但不为null</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="th-switch-和-th-case"><a href="#th-switch-和-th-case" class="headerlink" title="th:switch 和 th:case"></a>th:switch 和 th:case</h4><figure class="highlight html"><table><tr><td class="code"><pre><span class="line">bool匹配</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">th:switch</span>=<span class="string">&quot;$&#123;dataObj.reserved&#125;&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">th:case</span>=<span class="string">&quot;true&quot;</span>&gt;</span>true<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">th:case</span>=<span class="string">&quot;false&quot;</span>&gt;</span>false<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">字符串匹配，要加单引号</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">th:switch</span>=<span class="string">&quot;$&#123;item.showNameRole&#125;&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">th:case</span>=<span class="string">&quot;&#x27;admin&#x27;&quot;</span>&gt;</span>administrator<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">th:case</span>=<span class="string">&quot;&#x27;manager&#x27;&quot;</span>&gt;</span>manager<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">th:switch</span>=<span class="string">&quot;$&#123;item.showNameRole&#125;&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">th:case</span>=<span class="string">&quot;&#x27;admin&#x27;&quot;</span>&gt;</span>administrator<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">th:case</span>=<span class="string">&quot;&#x27;manager&#x27;&quot;</span>&gt;</span>manager<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">th:case</span>=<span class="string">&quot;*&quot;</span>&gt;</span>unknow<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>说明：th:case=”*” 表示没有匹配成功时显示的内容</li>
</ul>
<h3 id="运算符"><a href="#运算符" class="headerlink" title="运算符"></a>运算符</h3><ul>
<li>字符串连接<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">　　+ : $&#123;item.id&#125;+&#x27;_&#x27;+$&#123;type.id&#125;</span><br><span class="line">　　|xxxx| : |The name is $&#123;name&#125;|</span><br></pre></td></tr></table></figure></li>
<li>算术运算<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">　　+ , - , * , / , %  (二元运算符)</span><br><span class="line">　　-  :负号（一元运算符）</span><br></pre></td></tr></table></figure></li>
<li>布尔操作<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">　　and :且,or :或 (二元运算符)</span><br><span class="line">　　!,not :非（一元操作符）</span><br></pre></td></tr></table></figure></li>
<li>关系操作符<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">　　&gt; , &lt; , &gt;= , &lt;= (gt , lt , ge , le)</span><br><span class="line">　　== , != (eq, ne)</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="表达式工具对象"><a href="#表达式工具对象" class="headerlink" title="表达式工具对象"></a>表达式工具对象</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#dates 与java.util.Date对象的方法对应，格式化、日期组件抽取等等</span><br><span class="line">#calendars 类似#dates，与java.util.Calendar对象对应</span><br><span class="line">#numbers 格式化数字对象的工具方法</span><br><span class="line">#strings 与java.lang.String对应的工具方法：contains、startsWith、prepending/appending等等</span><br><span class="line">#objects 用于对象的工具方法</span><br><span class="line">#bools 用于布尔运算的工具方法</span><br><span class="line">#arrays 用于数组的工具方法</span><br><span class="line">#lists 用于列表的工具方法</span><br><span class="line">#sets 用于set的工具方法</span><br><span class="line">#maps 用于map的工具方法</span><br><span class="line">#aggregates 用于创建数组或集合的聚合的工具方法</span><br><span class="line">#messages 用于在变量表达式内部获取外化消息的工具方法，与#&#123;…&#125;语法获取的方式相同</span><br><span class="line">#ids 用于处理可能重复出现（例如，作为遍历的结果）的id属性的工具方法</span><br></pre></td></tr></table></figure>


<h2 id="使用springsecurity权限标签的方法"><a href="#使用springsecurity权限标签的方法" class="headerlink" title="使用springsecurity权限标签的方法"></a>使用springsecurity权限标签的方法</h2><p>添加依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--如果项目中使用到了springsecurity4， 则要加入下面的依赖来使用权限标签--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.thymeleaf.extras<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>thymeleaf-extras-springsecurity4<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.2.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>开启命名空间支持</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;http://www.thymeleaf.org&quot;</span> <span class="attr">xmlns:sec</span>=<span class="string">&quot;http://www.thymeleaf.org/thymeleaf-extras-springsecurity4&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line">使用方式与jsp标签类似：</span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;/auth/systemLogger/edit.do&#125;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-success btn-xs no-hover&quot;</span> <span class="attr">th:text</span>=<span class="string">&quot;#&#123;common.create&#125;&quot;</span> <span class="attr">sec:authorize</span>=<span class="string">&quot;hasRole(&#x27;LOGGER_ADD&#x27;)&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-danger btn-xs&quot;</span> <span class="attr">id</span>=<span class="string">&quot;delete&quot;</span> <span class="attr">th:text</span>=<span class="string">&quot;#&#123;common.delete&#125;&quot;</span> <span class="attr">sec:authorize</span>=<span class="string">&quot;hasRole(&#x27;LOGGER_DELETE&#x27;)&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="调用spring管理的bean的方法"><a href="#调用spring管理的bean的方法" class="headerlink" title="调用spring管理的bean的方法"></a>调用spring管理的bean的方法</h2><p>语法：${@beanName.methodName(param,…)}<br>说明：beanName就是注册时的名称<br>示例：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">#httpSession就是javax.servlet.http.HttpSession对象</span><br><span class="line">#httpServletRequest就是javax.servlet.http.HttpServletRequest对象</span><br><span class="line"><span class="tag">&lt;<span class="name">span</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;@commonService.clearSessionMessage(#httpServletRequest)&#125;&quot;</span> <span class="attr">style</span>=<span class="string">&quot;display: none&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="https://www.cnblogs.com/itdragon/archive/2018/04/13/8724291.html">https://www.cnblogs.com/itdragon/archive/2018/04/13/8724291.html</a></li>
<li><a href="https://blog.csdn.net/abap_brave/article/details/53009149">https://blog.csdn.net/abap_brave/article/details/53009149</a></li>
</ul>
]]></content>
      <categories>
        <category>技术</category>
        <category>springboot2</category>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Spring Boot</tag>
      </tags>
  </entry>
  <entry>
    <title>Python--virtualenv</title>
    <url>/2018/04/28/python_virtualenv/</url>
    <content><![CDATA[<h2 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h2><p>官方网站：<a href="https://virtualenv.pypa.io/en/stable/installation/">https://virtualenv.pypa.io/en/stable/installation/</a></p>
<ul>
<li>执行python项目时都需要为其安装运行环境需要的依赖，比如有些项目需要在python2下运行，有些项目需要在python3下运行，有些项目需要安装mysqlclient依赖，有些项目需要django依赖，如果这些依赖都被安装在统一的系统环境中，势必彼此之间会造成干扰，特别是需要同一个依赖的不同版本时更是难以维护；</li>
<li>virtualenv可以为python项目创建独立的虚拟运行环境，这样不同的项目可以运行在各自独立的执行环境中而彼此之间不受干扰；</li>
<li>在使用pycharm创建项目时，需要指定python执行器，此时就是创建的虚拟环境。<span id="more"></span></li>
</ul>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p><code>pip3 install virtualenv</code></p>
<ul>
<li>本文使用python3的pip命令安装virtualenv，所以默认情况下创建虚拟环境时都是python3的执行环境，可以通过<code>--python</code>参数指定python的执行环境，详见下文『创建新的虚拟环境』</li>
</ul>
<h2 id="创建新的虚拟环境"><a href="#创建新的虚拟环境" class="headerlink" title="创建新的虚拟环境"></a>创建新的虚拟环境</h2><p><code>virtualenv venv1</code> # 当前目录下创建venv1文件夹，并在其下创建python环境</p>
<ul>
<li><p>默认情况下，除了python本身的命令外不包含系统环境下的第三方依赖，比如系统环境已经安装好django、mysqlclient等，都不会带过来，需要重新在当前虚拟环境下安装。</p>
</li>
<li><p>如果希望访问系统环境中的某些第三方依赖，可以在创建虚拟环境时执行如下命令：<br><code>virtualenv venv1 --system-site-packages</code> #此时当前虚拟环境就可以访问系统环境了</p>
</li>
<li><p>python本身支持python2和python3同时共存，可以指定python命令路径，比如使用python2的环境</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">virtualenv --python=`which python` venv1</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="激活虚拟环境"><a href="#激活虚拟环境" class="headerlink" title="激活虚拟环境"></a>激活虚拟环境</h2><p><code>source activate</code></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd venv1/bin</span><br><span class="line">hanqunfengdeMacBook-Pro:bin hanqunfeng$ source activate</span><br><span class="line">(venv1) hanqunfengdeMacBook-Pro:bin hanqunfeng$</span><br></pre></td></tr></table></figure>

<ul>
<li>激活后所有python相关命令都变为venv1下的命令了</li>
</ul>
<h2 id="退出虚拟环境"><a href="#退出虚拟环境" class="headerlink" title="退出虚拟环境"></a>退出虚拟环境</h2><p><code>deactivate</code></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">(venv1) hanqunfengdeMacBook-Pro:bin hanqunfeng$ deactivate</span><br><span class="line">hanqunfengdeMacBook-Pro:bin hanqunfeng$</span><br></pre></td></tr></table></figure>
<h2 id="删除虚拟环境"><a href="#删除虚拟环境" class="headerlink" title="删除虚拟环境"></a>删除虚拟环境</h2><p><code>rm -rf venv1</code> 删除venv1目录即可</p>
]]></content>
      <categories>
        <category>技术</category>
      </categories>
      <tags>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>Django2学习笔记</title>
    <url>/2018/04/28/django2_study/</url>
    <content><![CDATA[<h2 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h2><ul>
<li><p>版本：python3.6.4+django2.0.3<br>Demo：<a href="https://github.com/hanqunfeng/DjangoHelloWorld">https://github.com/hanqunfeng/DjangoHelloWorld</a></p>
</li>
<li><p>参考资料：<br><a href="https://docs.djangoproject.com/en/2.0/">官方资料</a><br><a href="https://yiyibooks.cn/xx/django_182/index.html">Django 1.8.2 文档</a><br><a href="https://yiyibooks.cn/xx/Django_1.11.6/index.html">Django 1.11.6 文档</a><br><a href="https://yiyibooks.cn/qy/django2/index.html">Django 2.0.2文档</a><br><a href="https://code.ziqiangxuetang.com/django/django-internationalization.html">Django中文教程</a></p>
<span id="more"></span></li>
</ul>
<h2 id="1-安装"><a href="#1-安装" class="headerlink" title="1.安装"></a>1.安装</h2><p><code>pip install Django</code><br><code>python -m django --version</code></p>
<h2 id="2-创建新项目"><a href="#2-创建新项目" class="headerlink" title="2.创建新项目"></a>2.创建新项目</h2><p><code>django-admin startproject mysite</code>  # mysite就是项目名称</p>
<h2 id="3-创建新的应用"><a href="#3-创建新的应用" class="headerlink" title="3.创建新的应用"></a>3.创建新的应用</h2><p><code>python manage.py startapp polls</code> # polls是应用名称<br>settings.py中加入新应用配置</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">INSTALLED_APPS = [</span><br><span class="line">    <span class="string">&#x27;polls.apps.PollsConfig&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.admin&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.auth&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.contenttypes&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.sessions&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.messages&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.staticfiles&#x27;</span>,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h2 id="4-创建和更新数据库："><a href="#4-创建和更新数据库：" class="headerlink" title="4.创建和更新数据库："></a>4.创建和更新数据库：</h2><p><code>python manage.py makemigrations</code> # 全部应用都会创建迁移文件</p>
<p><code>python manage.py makemigrations polls</code> # 只创建指定的应用</p>
<p><code>python manage.py migrate</code> # 执行迁移文件到数据库</p>
<p>查看迁移文件生成的sql:<br> sqlmigrate命令接收迁移文件的名字并返回它们的SQL语句：#只是打印出要执行的sql语句</p>
<p><code>python manage.py sqlmigrate polls 0001</code>  # 这里迁移文件的后缀_initial.py不需要。</p>
<h2 id="5-启动服务器"><a href="#5-启动服务器" class="headerlink" title="5.启动服务器"></a>5.启动服务器</h2><p>Django的管理后台站点是默认启用的。 让我们启动开发服务器，然后探索它。<br>如果服务器没有运行，像下面这样启动它：</p>
<p><code>python manage.py runserver</code></p>
<p>现在，打开一个浏览器访问你本地域名中的 “/admin/” — 例如<a href="http://127.0.0.1:8000/admin/%E3%80%82">http://127.0.0.1:8000/admin/。</a></p>
<p>启动：</p>
<p><code>python manage.py runserver 9000</code> #指定启动端口</p>
<p><code>python manage.py runserver 0.0.0.0:9000</code> #指定启动ip+端口</p>
<h2 id="6-测试："><a href="#6-测试：" class="headerlink" title="6.测试："></a>6.测试：</h2><p><code>python manage.py test</code> #运行整个项目的全部tests.py</p>
<p><code>python manage.py test django2</code> #运行指定模块的tests.py</p>
<p><code>python manage.py test django2.tests.Django2Test</code> #测试指定模块的指定测试类</p>
<p><code>python manage.py test django2.tests.Django2Test.test_sql</code> #测试指定模块的指定测试类指定方法</p>
<h2 id="7-检查代码覆盖率："><a href="#7-检查代码覆盖率：" class="headerlink" title="7.检查代码覆盖率："></a>7.检查代码覆盖率：</h2><p><code>pip install coverage</code></p>
<p><code>coverage run my_program.py arg1 arg2</code></p>
<p>django检查方法：</p>
<p><code>coverage run --source=&#39;.&#39; manage.py test myapp</code></p>
<p>之后可以运行</p>
<p><code>coverage report</code> ：显示结果</p>
<p><code>coverage html</code>：生成html  测试会在当前项目下生成htmlcov目录，运行index.html即可查看</p>
<h2 id="8-mysql"><a href="#8-mysql" class="headerlink" title="8.mysql:"></a>8.mysql:</h2><p><code>brew install mysql-connector-c</code></p>
<p><code>pip install mysqlclient</code></p>
<p>需要提前创建好数据库<br>settings.py:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">DATABASES = &#123;</span><br><span class="line">    <span class="string">&#x27;default&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;ENGINE&#x27;</span>: <span class="string">&#x27;django.db.backends.mysql&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;NAME&#x27;</span>: <span class="string">&#x27;django&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;USER&#x27;</span>: <span class="string">&#x27;django&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;PASSWORD&#x27;</span>: <span class="string">&#x27;django&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;HOST&#x27;</span>: <span class="string">&#x27;127.0.0.1&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;PORT&#x27;</span>: <span class="string">&#x27;3306&#x27;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>数据库更新：<br>一般情况下，我们使用如下两个命令更新数据库</p>
<p><code>python manage.py makemigrations</code> #生成数据库模型文件</p>
<p><code>python manage.py migrate</code> #执行模型文件</p>
<p>或者：<br><code>python  manage.py migrate --database=users</code> #指定数据库，默认为default</p>
<p>如果由于默写原因删除了数据库中对应的表，则再次执行上面的命令是不能重新创建成功的，原因是每次django执行模型文件时都会在django_migrations表中新增对应的log记录，删掉对应的log记录即可重新执行成功。</p>
<h2 id="9-多数据源配置"><a href="#9-多数据源配置" class="headerlink" title="9.多数据源配置"></a>9.多数据源配置</h2><p>django配置连接多个数据库，自定义表名称：<br><a href="https://www.cnblogs.com/dreamer-fish/p/5469141.html">https://www.cnblogs.com/dreamer-fish/p/5469141.html</a></p>
<p>使用models文件夹维护model时，一定要在其下的__init__.py中添加对model的引用，<br>否则<code>python manage.py makemigrations</code> 命令不会创建出对应的迁移文件<br>比如：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> .person <span class="keyword">import</span> Person</span><br><span class="line"><span class="keyword">from</span> .user <span class="keyword">import</span> User</span><br><span class="line"><span class="keyword">from</span> .identity_card <span class="keyword">import</span> IdentityCard</span><br><span class="line"><span class="keyword">from</span> .car <span class="keyword">import</span> Car</span><br></pre></td></tr></table></figure>
<p>数据库路由:<br>settings.py:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">DATABASE_ROUTERS = [<span class="string">&#x27;django2.router.django2_router.Django2Router&#x27;</span>, ]</span><br></pre></td></tr></table></figure>

<p>可以将对应的迁移文件的sql导入到指定的db，所以路由器的设置很重要</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">allow_migrate</span>(<span class="params">self, db, app_label, model_name=<span class="literal">None</span>, **hints</span>):</span></span><br><span class="line">    <span class="keyword">if</span> db == <span class="string">&#x27;django2_db&#x27;</span>:  <span class="comment">#如果指定了数据库</span></span><br><span class="line">        <span class="keyword">return</span> app_label == <span class="string">&#x27;django2&#x27;</span> <span class="comment">#并且model被设置了正确的app_label，则可以执行迁移文件</span></span><br><span class="line">    <span class="keyword">elif</span> app_label == <span class="string">&#x27;django2&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure>
<p>设置好数据库路由器后，执行python manage.py migrate –database=django2_db</p>
<h2 id="10-缓存"><a href="#10-缓存" class="headerlink" title="10.缓存"></a>10.缓存</h2><p>说明：不推荐使用站点级缓存和页面级缓存，除非是展示信息类的网站，如果是频繁修改的站点，最好手工在代码中维护缓存。</p>
<p>1).memcached</p>
<p><code>brew install memcached</code></p>
<p>启动：<code>memcached -d -p 11211 -c 1024 -m 64</code></p>
<p>-d:后台运行<br>-p:端口<br>-c:最大连接数<br>-m:最多分配内存</p>
<p>1.使用memcached：<code>pip install python-memcached</code></p>
<p>2.settings</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 缓存设置</span></span><br><span class="line">CACHES = &#123;</span><br><span class="line">    <span class="string">&#x27;default&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;BACKEND&#x27;</span>: <span class="string">&#x27;django.core.cache.backends.memcached.MemcachedCache&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;LOCATION&#x27;</span>: <span class="string">&#x27;127.0.0.1:11211&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;TIMEOUT&#x27;</span>: <span class="number">600</span>,  <span class="comment"># 单位秒，默认300s, 60s * 10 = 10min</span></span><br><span class="line">        <span class="string">&#x27;KEY_PREFIX&#x27;</span>: <span class="string">&#x27;myapp&#x27;</span>,  <span class="comment"># 缓存键的字符串前缀</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3.代码中</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> django.core.cache <span class="keyword">import</span> caches</span><br><span class="line">cache = caches[<span class="string">&#x27;default&#x27;</span>]</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#如果希望使用默认的default，也可以</span></span><br><span class="line"><span class="keyword">from</span> django.core.cache <span class="keyword">import</span> cache</span><br><span class="line"></span><br><span class="line">cache.<span class="built_in">set</span>(<span class="string">&#x27;user_list&#x27;</span>, user_list)</span><br><span class="line">user_list = cache.get(<span class="string">&#x27;user_list&#x27;</span>)</span><br><span class="line">user_list = cache.delete(<span class="string">&#x27;user_list&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>2).redis</p>
<p>参考资料：<a href="http://django-redis-chs.readthedocs.io/zh_CN/latest/">http://django-redis-chs.readthedocs.io/zh_CN/latest/</a></p>
<p>1.<code>brew install redis</code></p>
<p>启动：<code>redis-server /usr/local/etc/redis.conf</code></p>
<p>2.<code>pip install django-redis</code></p>
<p>3.settings</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 缓存设置</span></span><br><span class="line">CACHES = &#123;</span><br><span class="line">    <span class="string">&#x27;default&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;BACKEND&#x27;</span>: <span class="string">&#x27;django.core.cache.backends.memcached.MemcachedCache&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;LOCATION&#x27;</span>: <span class="string">&#x27;127.0.0.1:11211&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;TIMEOUT&#x27;</span>: <span class="number">600</span>,  <span class="comment"># 单位秒，默认300s, 60s * 10 = 10min</span></span><br><span class="line">        <span class="string">&#x27;KEY_PREFIX&#x27;</span>: <span class="string">&#x27;myapp&#x27;</span>,  <span class="comment"># 缓存键的字符串前缀</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;redis&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;BACKEND&quot;</span>: <span class="string">&quot;django_redis.cache.RedisCache&quot;</span>,</span><br><span class="line">        <span class="string">&quot;LOCATION&quot;</span>: <span class="string">&quot;redis://127.0.0.1:6379/1&quot;</span>,</span><br><span class="line">        <span class="string">&#x27;TIMEOUT&#x27;</span>: <span class="number">600</span>,</span><br><span class="line">        <span class="string">&quot;OPTIONS&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;CLIENT_CLASS&quot;</span>: <span class="string">&quot;django_redis.client.DefaultClient&quot;</span>,</span><br><span class="line">            <span class="string">&quot;SOCKET_CONNECT_TIMEOUT&quot;</span>: <span class="number">5</span>,  <span class="comment"># in seconds socket 建立连接超时设置</span></span><br><span class="line">            <span class="string">&quot;SOCKET_TIMEOUT&quot;</span>: <span class="number">5</span>,  <span class="comment"># in seconds 连接建立后的读写操作超时设置</span></span><br><span class="line">            <span class="string">&quot;COMPRESSOR&quot;</span>: <span class="string">&quot;django_redis.compressors.zlib.ZlibCompressor&quot;</span>,  <span class="comment"># 压缩支持</span></span><br><span class="line">            <span class="string">&quot;IGNORE_EXCEPTIONS&quot;</span>: <span class="literal">True</span>,  <span class="comment"># 如果redis服务关闭，不会引起异常，memcached默认支持</span></span><br><span class="line">            <span class="string">&quot;CONNECTION_POOL_KWARGS&quot;</span>: &#123;<span class="string">&quot;max_connections&quot;</span>: <span class="number">100</span>&#125;  <span class="comment"># 连接池</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># redis记录异常日志</span></span><br><span class="line">DJANGO_REDIS_LOG_IGNORED_EXCEPTIONS = <span class="literal">True</span></span><br></pre></td></tr></table></figure>
<p>4.代码中</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> django.core.cache <span class="keyword">import</span> caches</span><br><span class="line">redis_cache = caches[<span class="string">&#x27;redis&#x27;</span>]</span><br><span class="line"></span><br><span class="line">redis_cache.<span class="built_in">set</span>(<span class="string">&#x27;user_list&#x27;</span>, user_list)</span><br><span class="line">user_list = redis_cache.get(<span class="string">&#x27;user_list&#x27;</span>)</span><br><span class="line">user_list = redis_cache.delete(<span class="string">&#x27;user_list&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="11-注册模板自定义方法"><a href="#11-注册模板自定义方法" class="headerlink" title="11.注册模板自定义方法:"></a>11.注册模板自定义方法:</h2><p>1.创建myapp.libraries.utils.py</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> django <span class="keyword">import</span> template</span><br><span class="line">register = template.Library()</span><br><span class="line">color = ((<span class="number">1</span>, <span class="string">&#x27;red&#x27;</span>), (<span class="number">2</span>, <span class="string">&#x27;black&#x27;</span>), (<span class="number">3</span>, <span class="string">&#x27;blue&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># @register.filter使用方法，最多两个参数</span></span><br><span class="line"><span class="comment"># &#123;&#123; car.carColor|getcolorstr &#125;&#125;</span></span><br><span class="line"><span class="comment"># &#123;&#123; car.carColor|getcolorstr:param2 &#125;&#125; 前面的表示第一个参数</span></span><br><span class="line"><span class="meta">@register.filter</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getcolorstr</span>(<span class="params">colorNum</span>):</span></span><br><span class="line">    <span class="keyword">return</span> color[colorNum - <span class="number">1</span>][<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># @register.simple_tag使用方法，不限制参数个数</span></span><br><span class="line"><span class="comment"># &#123;% getcolorstr2 car.carColor %&#125;</span></span><br><span class="line"><span class="comment"># &#123;% getcolorstr2 param1 param2 param3 %&#125;</span></span><br><span class="line"><span class="meta">@register.simple_tag</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getcolorstr2</span>(<span class="params">colorNum</span>):</span></span><br><span class="line">    <span class="keyword">return</span> color[colorNum - <span class="number">1</span>][<span class="number">1</span>]</span><br></pre></td></tr></table></figure>

<p>2.settings:在模板配置中加入libraries配置</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">TEMPLATES = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&#x27;BACKEND&#x27;</span>: <span class="string">&#x27;django.template.backends.django.DjangoTemplates&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;DIRS&#x27;</span>: [os.path.join(BASE_DIR, <span class="string">&#x27;templates&#x27;</span>)]</span><br><span class="line">        ,</span><br><span class="line">        <span class="string">&#x27;APP_DIRS&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line">        <span class="string">&#x27;OPTIONS&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;context_processors&#x27;</span>: [</span><br><span class="line">                <span class="string">&#x27;django.template.context_processors.debug&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;django.template.context_processors.request&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;django.contrib.auth.context_processors.auth&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;django.contrib.messages.context_processors.messages&#x27;</span>,</span><br><span class="line">            ],</span><br><span class="line">            <span class="string">&#x27;libraries&#x27;</span>: &#123;  <span class="comment"># Adding this section should work around the issue.</span></span><br><span class="line">                <span class="string">&#x27;utils&#x27;</span>: <span class="string">&#x27;myapp.libraries.utils&#x27;</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>3.模板页面中使用</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">&#123;% load utils %&#125;</span><br><span class="line">&#123;&#123; car.carColor|getcolorstr &#125;&#125;</span><br><span class="line">&#123;% getcolorstr2 car.carColor %&#125;</span><br></pre></td></tr></table></figure>
<h2 id="12-模板"><a href="#12-模板" class="headerlink" title="12.模板"></a>12.模板</h2><p>1.转义:<br>由于模板系统没有“转义”的概念，为了显示模板标签中使用的一个位，必须使用{％ templatetag ％}标记。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">论据 输出</span><br><span class="line">openblock &#123;％</span><br><span class="line">closeblock ％&#125;</span><br><span class="line">openvariable &#123;&#123;</span><br><span class="line">closevariable &#125;&#125;</span><br><span class="line">openbrace &#123;</span><br><span class="line">closebrace &#125;</span><br><span class="line">opencomment &#123;＃</span><br><span class="line">closecomment ＃&#125;</span><br></pre></td></tr></table></figure>
<p>例如：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;% templatetag openblock %&#125; url &#x27;entry_list&#x27; &#123;% templatetag closeblock %&#125;</span><br></pre></td></tr></table></figure>
<p>或者使用如下方式：被包含的内容不会被模板引擎转意，将直接输出</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;% verbatim myblock %&#125;</span><br><span class="line">    Avoid template rendering via the &#123;% verbatim %&#125;&#123;% endverbatim %&#125; block.</span><br><span class="line">&#123;% endverbatim myblock %&#125;</span><br></pre></td></tr></table></figure>
<p>2.for:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">变量 描述</span><br><span class="line">forloop.counter 循环的当前迭代（1索引）</span><br><span class="line">forloop.counter0 循环的当前迭代（0索引）</span><br><span class="line">forloop.revcounter 循环结束的迭代次数（1索引）</span><br><span class="line">forloop.revcounter0 循环结束的迭代次数（0索引）</span><br><span class="line">forloop.first 如果这是第一次通过循环，则为真</span><br><span class="line">forloop.last 如果这是最后一次循环，则为真</span><br><span class="line">forloop.parentloop 对于嵌套循环，这是围绕当前循环的循环</span><br></pre></td></tr></table></figure>

<h2 id="13-自定义400、403、404、500页面"><a href="#13-自定义400、403、404、500页面" class="headerlink" title="13.自定义400、403、404、500页面"></a>13.自定义400、403、404、500页面</h2><p>1.settings.py中DEBUG = False，否则自定义页面不起作用</p>
<p>2.在任意模块下的views.py中增加如下方法，也可以在主模块中创建一个views.py<br>方法处理逻辑可以参考：~venv/lib/python3.6/site-packages/django/views/defaults.py中对各个方法的定义</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bad_request</span>(<span class="params">request, exception, template_name=<span class="string">&#x27;400.html&#x27;</span></span>):</span></span><br><span class="line">    <span class="keyword">return</span> render(request, template_name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">permission_denied</span>(<span class="params">request, exception, template_name=<span class="string">&#x27;403.html&#x27;</span></span>):</span></span><br><span class="line">    <span class="keyword">return</span> render(request, template_name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">page_not_found</span>(<span class="params">request, exception, template_name=<span class="string">&#x27;404.html&#x27;</span></span>):</span></span><br><span class="line">    context = &#123;<span class="string">&#x27;exception&#x27;</span>: exception&#125;</span><br><span class="line">    <span class="keyword">return</span> render(request, template_name, context=context)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">server_error</span>(<span class="params">request, template_name=<span class="string">&#x27;500.html&#x27;</span></span>):</span></span><br><span class="line">    <span class="keyword">return</span> render(request, template_name)</span><br></pre></td></tr></table></figure>

<p>3.在项目根目录下的templates下创建对应的400.html、403.html、404.html、500.html，内容更加需要自定义，也可以参考~venv/lib/python3.6/site-packages/django/views/templates下的对应文件</p>
<p>4.在主模块下urls.py中增加如下配置:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">handler400 = <span class="string">&#x27;DjangoHelloWorld.views.bad_request&#x27;</span> <span class="comment">#模块名称.views.方法名称</span></span><br><span class="line">handler403 = <span class="string">&#x27;DjangoHelloWorld.views.permission_denied&#x27;</span></span><br><span class="line">handler404 = <span class="string">&#x27;DjangoHelloWorld.views.page_not_found&#x27;</span></span><br><span class="line">handler500 = <span class="string">&#x27;DjangoHelloWorld.views.server_error&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="14-Django配置session超时"><a href="#14-Django配置session超时" class="headerlink" title="14.Django配置session超时"></a>14.Django配置session超时</h2><p>#配置失效时间为半个小时<br>SESSION_COOKIE_AGE = 60*30<br>#关闭浏览器清除cookie<br>SESSION_EXPIRE_AT_BROWSER_CLOSE = True</p>
<h2 id="15-json与xml"><a href="#15-json与xml" class="headerlink" title="15.json与xml"></a>15.json与xml</h2><p>1.json<br>创建一个JSONUtil工具类，用于返回json数据</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> django.core.serializers <span class="keyword">import</span> serialize, deserialize</span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> django.db.models.query <span class="keyword">import</span> QuerySet</span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> JsonResponse</span><br><span class="line"></span><br><span class="line"><span class="comment"># 反序列化</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">json_to_list</span>(<span class="params">json</span>):</span></span><br><span class="line">    <span class="keyword">if</span> json[<span class="number">0</span>] == <span class="string">&#x27;[&#x27;</span>:</span><br><span class="line">        deserializedObjectList = deserialize(<span class="string">&#x27;json&#x27;</span>, json)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        deserializedObjectList = deserialize(<span class="string">&#x27;json&#x27;</span>, <span class="string">&#x27;[&#x27;</span> + json + <span class="string">&#x27;]&#x27;</span>)</span><br><span class="line">    <span class="built_in">list</span> = []</span><br><span class="line">    <span class="keyword">for</span> deserializedObject <span class="keyword">in</span> deserializedObjectList:</span><br><span class="line">        <span class="built_in">list</span>.append(deserializedObject.<span class="built_in">object</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">list</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 序列化</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">to_json</span>(<span class="params">obj</span>):</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(obj, models.Model):</span><br><span class="line">        obj = [obj]  <span class="comment"># 因为serialize只支持可迭代对象，比如querySet对象</span></span><br><span class="line">    data = serialize(<span class="string">&quot;json&quot;</span>, obj)</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 该方法没有做严格的验证，只支持dict,models.Model,models.QuerySet，可以根据需要自行扩展</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">render_json</span>(<span class="params">data, dict_key=<span class="string">&#x27;data&#x27;</span>, **response_kwargs</span>):</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(data, <span class="built_in">dict</span>):</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(data)</span><br><span class="line">    data = to_json(data)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;safe&#x27;</span> <span class="keyword">in</span> response_kwargs <span class="keyword">and</span> response_kwargs[<span class="string">&#x27;safe&#x27;</span>] <span class="keyword">is</span> <span class="literal">False</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        data = &#123;dict_key: data&#125;  <span class="comment"># 默认必须传递字典数据</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(data, <span class="built_in">str</span>):  <span class="comment"># 由于非字典类型的数据会被当做字符串处理，即返回结果两边都有引号，所以此处将其转换为对象，否则ajax调用时不方便处理</span></span><br><span class="line">        data = json.loads(data)</span><br><span class="line">    <span class="keyword">return</span> JsonResponse(data, **response_kwargs)</span><br></pre></td></tr></table></figure>

<p>view.py中：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">user_query_json</span>(<span class="params">request</span>):</span></span><br><span class="line">    user_list = User.objects.<span class="built_in">all</span>()</span><br><span class="line">    <span class="keyword">return</span> JSONUtil.render_json(user_list, safe=<span class="literal">False</span>) <span class="comment"># safe=False可以传递对象，否则必须传递一个dict，ajax请求时这样要设置safe=False，这样页面可以直接获取到对象</span></span><br></pre></td></tr></table></figure>
<p>返回结果，可以看到两边没有引号：<br>[{“model”: “myapp.user”, “pk”: 4, “fields”: {“name”: “\u54c8\u54c8”, “birth_day”: “2018-04-09”, “phone”: “None”, “email”: “None”}}, {“model”: “myapp.user”, “pk”: 9, “fields”: {“name”: “\u5929\u738b\u5c71”, “birth_day”: “2018-09-10”, “phone”: “123”, “email”: “<a href="mailto:&#x31;&#50;&#51;&#x40;&#x31;&#x32;&#51;&#46;&#99;&#x6f;&#109;">&#x31;&#50;&#51;&#x40;&#x31;&#x32;&#51;&#46;&#99;&#x6f;&#109;</a>“}}]</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">user_query_json_get</span>(<span class="params">request, user_id</span>):</span></span><br><span class="line">    user = User.objects.get(pk=user_id)</span><br><span class="line">    <span class="comment"># user = User.objects.filter(pk=user_id)</span></span><br><span class="line">    <span class="keyword">return</span> JSONUtil.render_json(user, dict_key=<span class="string">&#x27;user&#x27;</span>, safe=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<p>返回结果：[{“model”: “myapp.user”, “pk”: 1, “fields”: {“name”: “\u97e9\u7fa4\u5cf0”, “birth_day”: “2018-04-07”, “phone”: “None”, “email”: “<a href="mailto:&#x71;&#x75;&#110;&#x66;&#101;&#x6e;&#x67;&#x5f;&#x68;&#97;&#x6e;&#x40;&#49;&#50;&#x36;&#46;&#99;&#111;&#x6d;">&#x71;&#x75;&#110;&#x66;&#101;&#x6e;&#x67;&#x5f;&#x68;&#97;&#x6e;&#x40;&#49;&#50;&#x36;&#46;&#99;&#111;&#x6d;</a>“}}]</p>
<p>模板中：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;&#123;% static &#x27;polls/js/jquery-1.11.0.min.js&#x27; %&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span> #注意这里必须有闭合标签<span class="tag">&lt;/<span class="name">script</span>&gt;</span>，否则显示会有问题</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;userdiv&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;userlistdiv&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript">    $.getJSON(<span class="string">&quot;&#123;% url &#x27;myapp:user_query_json_get&#x27; 1 %&#125;&quot;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">ret</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        $.each(ret, <span class="function"><span class="keyword">function</span> (<span class="params">key, value</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="comment">// key 为字典的 key，value 为对应的值</span></span></span><br><span class="line"><span class="javascript">            $(<span class="string">&quot;#userdiv&quot;</span>).append(value.pk+<span class="string">&quot;#&quot;</span>+value.fields.name+<span class="string">&quot;#&quot;</span>+value.fields.birth_day+<span class="string">&quot;#&quot;</span>+value.fields.phone+<span class="string">&quot;#&quot;</span>+value.fields.email+<span class="string">&quot;&lt;br&gt;&quot;</span>)</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript">        &#125;);</span></span><br><span class="line"><span class="javascript">    &#125;);</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript">    $.getJSON(<span class="string">&quot;&#123;% url &#x27;myapp:user_query_json&#x27; %&#125;&quot;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">ret</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        $.each(ret, <span class="function"><span class="keyword">function</span> (<span class="params">key, value</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="comment">// key 为字典的 key，value 为对应的值</span></span></span><br><span class="line"><span class="javascript">            $(<span class="string">&quot;#userlistdiv&quot;</span>).append(value.pk+<span class="string">&quot;#&quot;</span>+value.fields.name+<span class="string">&quot;#&quot;</span>+value.fields.birth_day+<span class="string">&quot;#&quot;</span>+value.fields.phone+<span class="string">&quot;#&quot;</span>+value.fields.email+<span class="string">&quot;&lt;br&gt;&quot;</span>)</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript">        &#125;);</span></span><br><span class="line"><span class="javascript">    &#125;)</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2.xml</p>
<p>XMLUtil.py</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding=utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> django.core <span class="keyword">import</span> serializers</span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> django.db.models.query <span class="keyword">import</span> QuerySet</span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">render_xml</span>(<span class="params">data</span>):</span></span><br><span class="line">    data = to_xml(data)</span><br><span class="line">    response = HttpResponse(data)</span><br><span class="line">    response[<span class="string">&#x27;Content-Type&#x27;</span>] = <span class="string">&#x27;application/xml&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line"><span class="comment"># 序列化</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">to_xml</span>(<span class="params">data</span>):</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(data, models.Model):</span><br><span class="line">        data = [data]  <span class="comment"># 因为serialize只支持可迭代对象，比如querySet对象</span></span><br><span class="line">    <span class="keyword">elif</span> <span class="built_in">isinstance</span>(data, QuerySet):</span><br><span class="line">        data = data</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    data = serializers.serialize(<span class="string">&quot;xml&quot;</span>, data)</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line"><span class="comment"># 反序列化</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">xml_to_list</span>(<span class="params">xml</span>):</span></span><br><span class="line">    deserializedObjectList = serializers.deserialize(<span class="string">&quot;xml&quot;</span>, xml)</span><br><span class="line">    <span class="built_in">list</span> = []</span><br><span class="line">    <span class="keyword">for</span> deserializedObject <span class="keyword">in</span> deserializedObjectList:</span><br><span class="line">        <span class="built_in">list</span>.append(deserializedObject.<span class="built_in">object</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">list</span></span><br></pre></td></tr></table></figure>
<p>views.py</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> utils <span class="keyword">import</span> XMLUtil</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">user_query_xml</span>(<span class="params">request</span>):</span></span><br><span class="line">    user_list = User.objects.<span class="built_in">all</span>()</span><br><span class="line">    <span class="keyword">return</span> XMLUtil.render_xml(user_list)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">user_query_xml_get</span>(<span class="params">request, user_id</span>):</span></span><br><span class="line">    user = User.objects.get(pk=user_id)</span><br><span class="line">    <span class="keyword">return</span> XMLUtil.render_xml(user)</span><br></pre></td></tr></table></figure>
<p>输出结果</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">django-objects</span> <span class="attr">version</span>=<span class="string">&quot;1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">object</span> <span class="attr">model</span>=<span class="string">&quot;myapp.user&quot;</span> <span class="attr">pk</span>=<span class="string">&quot;4&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">type</span>=<span class="string">&quot;CharField&quot;</span>&gt;</span>哈哈<span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;birth_day&quot;</span> <span class="attr">type</span>=<span class="string">&quot;DateField&quot;</span>&gt;</span>2018-04-09<span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;phone&quot;</span> <span class="attr">type</span>=<span class="string">&quot;CharField&quot;</span>&gt;</span>13800138000<span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;email&quot;</span> <span class="attr">type</span>=<span class="string">&quot;CharField&quot;</span>&gt;</span>138@qq.com<span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">object</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">object</span> <span class="attr">model</span>=<span class="string">&quot;myapp.user&quot;</span> <span class="attr">pk</span>=<span class="string">&quot;2&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">type</span>=<span class="string">&quot;CharField&quot;</span>&gt;</span>张三<span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;birth_day&quot;</span> <span class="attr">type</span>=<span class="string">&quot;DateField&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">None</span>&gt;</span><span class="tag">&lt;/<span class="name">None</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;phone&quot;</span> <span class="attr">type</span>=<span class="string">&quot;CharField&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">None</span>&gt;</span><span class="tag">&lt;/<span class="name">None</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;email&quot;</span> <span class="attr">type</span>=<span class="string">&quot;CharField&quot;</span>&gt;</span>zhansan@163.com<span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">object</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">django-objects</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>js:</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">$.ajax(&#123;</span><br><span class="line">    <span class="attr">url</span>:<span class="string">&quot;&#123;% url &#x27;myapp:user_query_xml&#x27; %&#125;&quot;</span>,</span><br><span class="line">    <span class="attr">type</span>:<span class="string">&quot;GET&quot;</span>,</span><br><span class="line">    <span class="attr">dataType</span>:<span class="string">&#x27;xml&#x27;</span>,</span><br><span class="line">    <span class="attr">success</span>:<span class="function"><span class="keyword">function</span>(<span class="params">xml</span>)</span>&#123;</span><br><span class="line">        $(xml).find(<span class="string">&quot;object&quot;</span>).each(<span class="function"><span class="keyword">function</span>(<span class="params">i</span>) </span>&#123;</span><br><span class="line">            <span class="comment">//获取id</span></span><br><span class="line">            <span class="keyword">var</span> id=$(<span class="built_in">this</span>).attr(<span class="string">&quot;pk&quot;</span>);</span><br><span class="line">            <span class="keyword">var</span> content = <span class="string">&quot;&quot;</span>;</span><br><span class="line">            $(<span class="built_in">this</span>).find(<span class="string">&quot;field&quot;</span>).each(<span class="function"><span class="keyword">function</span>(<span class="params">j</span>)</span>&#123;</span><br><span class="line">                content += $(<span class="built_in">this</span>).attr(<span class="string">&#x27;name&#x27;</span>) + <span class="string">&quot;==&quot;</span> + $(<span class="built_in">this</span>).text() + <span class="string">&quot;#&quot;</span></span><br><span class="line">            &#125;)</span><br><span class="line">            $(<span class="string">&quot;#userdivxml&quot;</span>).append(id+ <span class="string">&quot;#&quot;</span> + content +<span class="string">&quot;&lt;br&gt;&quot;</span>)</span><br><span class="line"></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">error</span>:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123; alert(<span class="string">&quot;加载失败&quot;</span>); &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="16-response添加相应头"><a href="#16-response添加相应头" class="headerlink" title="16.response添加相应头"></a>16.response添加相应头</h2><p>一般我们返回视图时都是调用<br>from django.shortcuts import render的render(request, ‘myapp/user/index.html’, context)<br>实际上它返回的是一个HttpResponse对象，我们可以这样为其添加返回头</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">response = render(request, <span class="string">&#x27;myapp/user/index.html&#x27;</span>, context)</span><br><span class="line">response[<span class="string">&#x27;Last-Modified&#x27;</span>] = date.strftime(<span class="string">&#x27;%a, %d %b %Y %H:%M:%S GMT&#x27;</span>)</span><br><span class="line"><span class="keyword">return</span> response</span><br></pre></td></tr></table></figure>


<h2 id="17-多语言"><a href="#17-多语言" class="headerlink" title="17.多语言"></a>17.多语言</h2><p>参考：<a href="https://code.ziqiangxuetang.com/django/django-internationalization.html">https://code.ziqiangxuetang.com/django/django-internationalization.html</a></p>
<p>1.<code>brew install gettext</code></p>
<p>2.pip的bug，需要手工处理<br>/venv/lib/python3.6/site-packages/pip-9.0.1-py3.6.egg/pip/_vendor/webencodings/<br>修改3个文件：<br><strong>init</strong>.py，<br>tests.py，<br>x_user_defined.py，<br>将：utf8 修改为 utf-8.<br>3.settings.py</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">LANGUAGE_CODE = <span class="string">&#x27;zh-hans&#x27;</span>  <span class="comment"># 英文是en，这里是中文，注意这里必须配置为zh-hans，而下面创建和编译语言文件是要使用zh_hans</span></span><br><span class="line">USE_I18N = <span class="literal">True</span></span><br><span class="line">LOCALE_PATHS = (</span><br><span class="line">    os.path.join(BASE_DIR, <span class="string">&#x27;myapp/locale&#x27;</span>), <span class="comment"># 应用下的路径</span></span><br><span class="line">    os.path.join(BASE_DIR, <span class="string">&#x27;locale&#x27;</span>),</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>注意：这里『locale』文件夹需要手工创建，默认就是项目根路径下的locale目录。<br>这里需要注意一点，如果应用下面创建了locale并且配置到LOCALE_PATHS中，则后面执行创建命令时，无论是在项目根路径下执行还是在应用下执行，都只会将语言文件创建到应用下的locale中。如果应用下没用locale目录则需要在项目根路径下执行命令，并且创建到项目根路径下的locale目录中。</p>
<p>4.在代码中加入一些多语言对应的内容<br>代码中</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> django.utils.translation <span class="keyword">import</span> ugettext <span class="keyword">as</span> _</span><br><span class="line"> output = _(<span class="string">&#x27;Today is %(month)s %(day)s.&#x27;</span>) % &#123;<span class="string">&#x27;month&#x27;</span>: m, <span class="string">&#x27;day&#x27;</span>: d&#125;</span><br></pre></td></tr></table></figure>
<p>模板页面中可以直接使用下划线的别名形式</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">&#123;&#123; _(&#x27;Django site admin&#x27;) &#125;&#125;<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">&#123;&#123; _(&#x27;my test local&#x27;) &#125;&#125;<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br></pre></td></tr></table></figure>


<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">这里注意，如果要使用『trans』标签，必须在页面中加载 i18n</span><br><span class="line">&#123;% load i18n %&#125;</span><br><span class="line">&#123;% trans &quot;my test local&quot; %&#125;<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line"></span><br><span class="line">&#123;#将翻译结果保存到变量中#&#125;</span><br><span class="line">&#123;% trans &quot;my test local&quot; as mylocal %&#125;</span><br><span class="line">&#123;&#123; mylocal &#125;&#125;<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line"></span><br><span class="line">&#123;#设置局部显示的语言，下面的内容将显示对应的英文内容，但只在区块内有效#&#125;</span><br><span class="line">&#123;% language &#x27;en&#x27; %&#125;</span><br><span class="line">    &#123;% get_current_language as LANGUAGE_CODE %&#125;</span><br><span class="line">    Current language: &#123;&#123; LANGUAGE_CODE &#125;&#125; <span class="tag">&lt;<span class="name">br</span>&gt;</span>  #区块内显示en</span><br><span class="line">    &#123;&#123; _(&#x27;Django site admin&#x27;) &#125;&#125;<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">&#123;% endlanguage %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% get_current_language as LANGUAGE_CODE %&#125;</span><br><span class="line">    Current language: &#123;&#123; LANGUAGE_CODE &#125;&#125; <span class="tag">&lt;<span class="name">br</span>&gt;</span>  #区块外显示zh-hans</span><br></pre></td></tr></table></figure>
<p>如果没有找到对应的key值，则会直接显示待翻译的key值字符串；<br>如果对应的语言包下没有找到key值，而默认语言包下有对应的key值，则会显示默认的语言，如LANGUAGE_CODE = ‘zh-hans’</p>
<p>PS:如果需要翻译的内容包含变量，比如_(‘Today is %(month)s %(day)s.’) ，最好在后台处理好后做为变量传递到模板页面上，目前暂不知道如何在模板中直接处理。</p>
<p>5.创建或更新语言文件</p>
<p><code>django-admin makemessages -l en</code> # 英文</p>
<p><code>django-admin makemessages -l zh_hans</code> #指定中文语言，注意这里不要写成zh-hans</p>
<p>会在locale目录下生成对应的语言包django.po</p>
<p><code>django-admin makemessages -a</code> #全部语言</p>
<p>说明：如果在项目根路径下执行，会将项目中所有应用都扫描一遍并汇总合并到一起，如果在某个应用下执行命令，则只会扫描当前应用，并在其下的locale目录下创建文件，优先级根据settings中配置的LOCALE_PATHS的顺序而定。</p>
<p>6.编译</p>
<p><code>django-admin compilemessages --locale zh_hans</code> #指定语言</p>
<p><code>django-admin compilemessages</code> # 全部语言</p>
<ul>
<li>django.po—-&gt;diango.mo</li>
</ul>
<p>7.语言切换</p>
<p>1）在settings中的中间件配置中加入如下配置：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">MIDDLEWARE = [</span><br><span class="line">    <span class="string">&#x27;django.middleware.security.SecurityMiddleware&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.sessions.middleware.SessionMiddleware&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.middleware.locale.LocaleMiddleware&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.middleware.common.CommonMiddleware&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.middleware.csrf.CsrfViewMiddleware&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.auth.middleware.AuthenticationMiddleware&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.messages.middleware.MessageMiddleware&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.middleware.clickjacking.XFrameOptionsMiddleware&#x27;</span>,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>2）url中加入配置：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">path(<span class="string">&#x27;i18n/&#x27;</span>, include(<span class="string">&#x27;django.conf.urls.i18n&#x27;</span>)), <span class="comment">#对应下面的&#123;% url &#x27;set_language&#x27; %&#125;</span></span><br></pre></td></tr></table></figure>
<p>变更后的语言会保存在session中，可以通过<code>request.session[&#39;_language&#39;]</code>获得</p>
<p>3）在模板页面中需要切换语言的地方加入如下代码：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;&#123;% url &#x27;set_language&#x27; %&#125;&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span>&#123;% csrf_token %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;next&quot;</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&#123;&#123; redirect_to &#125;&#125;&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">name</span>=<span class="string">&quot;language&quot;</span>&gt;</span></span><br><span class="line">        &#123;% get_current_language as LANGUAGE_CODE %&#125;</span><br><span class="line">        &#123;% get_available_languages as LANGUAGES %&#125;</span><br><span class="line">        &#123;% get_language_info_list for LANGUAGES as languages %&#125;</span><br><span class="line">        &#123;% for language in languages %&#125;</span><br><span class="line">            <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;&#123;&#123; language.code &#125;&#125;&quot;</span>&#123;% <span class="attr">if</span> <span class="attr">language.code</span> == <span class="string">LANGUAGE_CODE</span> %&#125; <span class="attr">selected</span>&#123;% <span class="attr">endif</span> %&#125;&gt;</span></span><br><span class="line">                &#123;&#123; language.name_local &#125;&#125; (&#123;&#123; language.code &#125;&#125;)</span><br><span class="line">            <span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">        &#123;% endfor %&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Go&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>说明：<br>redirect_to：如果不设置就会返回当前页面，设置的话就会跳转到设置的页面<br>这里get_available_languages会显示所有支持的语言，不过一般项目不会支持这么多的语言，所以可以在settings中增加配置来明确语言范围：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">LANGUAGES = (</span><br><span class="line">    (<span class="string">&#x27;en&#x27;</span>, (<span class="string">&#x27;English&#x27;</span>)),</span><br><span class="line">    (<span class="string">&#x27;zh-hans&#x27;</span>, (<span class="string">&#x27;中文简体&#x27;</span>)),</span><br><span class="line">    (<span class="string">&#x27;zh-hant&#x27;</span>, (<span class="string">&#x27;中文繁體&#x27;</span>)),</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>4）js中使用多语言<br>js需要单独处理，比如我们写了一个js文件，路径为project/myapp/static/myapp/js/test.js</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">a = gettext(<span class="string">&#x27;wwww hhhh&#x27;</span>)</span><br><span class="line">alert(a)</span><br></pre></td></tr></table></figure>
<p>模板中引入：<br>#下面这个是动态js，必须引入，否则gettext方法不起作用</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span> <span class="attr">src</span>=<span class="string">&quot;&#123;% url &#x27;javascript-catalog&#x27; %&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;&#123;% static &#x27;myapp/js/test.js&#x27; %&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>urls加入对javascript-catalog的支持：<br>`path(‘jsi18n/‘, JavaScriptCatalog.as_view(), name=’javascript-catalog’),``</p>
<p>执行如下命令：</p>
<p><code>django-admin makemessages -d djangojs  -l zh_hans</code><br>此时会在应用下的locale中生成djangojs.po文件（如果配置了应用locale，否则会在项目下的locale中创建）</p>
<p><code>django-admin compilemessages --locale zh_hans</code><br>此时会将djangojs.po编译为djangojs.mo</p>
<p>如果直接将带翻译的js代码写在模板页面中，暂时不清楚要通过什么命令实现，不过可以有个折中的办法，就是创建一个js文件，然后将所有需要翻译的内容都加上，然后运行上面两个命令，这样django在运行模板中的js时同样可以完成翻译<br>模板中：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    alert(gettext(<span class="string">&#x27;hello js&#x27;</span>))</span><br><span class="line">    alert(gettext(<span class="string">&#x27;o my god&#x27;</span>))</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>js中：只要js代码中出现翻译方法的地方都会被加入翻译，这个js不需要被任何模板引入，也不需要被同步到静态文件夹中，仅仅是为生成翻译文件而存在</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">gettext(<span class="string">&#x27;hello js&#x27;</span>)</span><br><span class="line">gettext(<span class="string">&#x27;o my god&#x27;</span>)</span><br></pre></td></tr></table></figure>


<h2 id="18-日志"><a href="#18-日志" class="headerlink" title="18.日志"></a>18.日志</h2><p>1.settings</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">LOGGING = &#123;</span><br><span class="line">    <span class="string">&#x27;version&#x27;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">&#x27;disable_existing_loggers&#x27;</span>: <span class="literal">False</span>,  <span class="comment"># 是否禁用logger，建议设置为False</span></span><br><span class="line">    <span class="string">&#x27;formatters&#x27;</span>: &#123;  <span class="comment"># 日志格式，提供给handler使用，非必须，如果不设置格式，默认只会打印消息体</span></span><br><span class="line">        <span class="string">&#x27;verbose&#x27;</span>: &#123;  <span class="comment"># 格式名称</span></span><br><span class="line">            <span class="comment"># INFO 2018-04-25 15:43:27,586 views 8756 123145350217728 这是一个日志</span></span><br><span class="line">            <span class="string">&#x27;format&#x27;</span>: <span class="string">&#x27;%(levelname)s %(asctime)s %(module)s %(process)d %(thread)d %(message)s&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&#x27;simple&#x27;</span>: &#123;</span><br><span class="line">            <span class="comment"># INFO  这是一个日志</span></span><br><span class="line">            <span class="string">&#x27;format&#x27;</span>: <span class="string">&#x27;%(levelname)s %(message)s&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&#x27;standard&#x27;</span>: &#123;</span><br><span class="line">            <span class="comment"># 2018-04-25 16:40:00,195 [Thread-7:123145575223296] [myapp.log:282] [views:user_query_json_get] [INFO]- 这是一个日志</span></span><br><span class="line">            <span class="string">&#x27;format&#x27;</span>: <span class="string">&#x27;%(asctime)s [%(threadName)s:%(thread)d] [%(name)s:%(lineno)d] [%(module)s:%(funcName)s] [%(levelname)s]- %(message)s&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line"></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&#x27;filters&#x27;</span>: &#123;  <span class="comment"># 过滤器，提供给handler使用，非必须</span></span><br><span class="line">        <span class="string">&#x27;require_debug_true&#x27;</span>: &#123;  <span class="comment"># 要求DEBUG=True时才打印日志</span></span><br><span class="line">            <span class="string">&#x27;()&#x27;</span>: <span class="string">&#x27;django.utils.log.RequireDebugTrue&#x27;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&#x27;handlers&#x27;</span>: &#123;  <span class="comment"># 处理器，设置日志记录方式，必须</span></span><br><span class="line">        <span class="string">&#x27;console&#x27;</span>: &#123;  <span class="comment"># 处理器名称</span></span><br><span class="line">            <span class="string">&#x27;level&#x27;</span>: <span class="string">&#x27;DEBUG&#x27;</span>,  <span class="comment"># 设置级别</span></span><br><span class="line">            <span class="string">&#x27;filters&#x27;</span>: [<span class="string">&#x27;require_debug_true&#x27;</span>],  <span class="comment"># 设置过滤器，多个用逗号分割</span></span><br><span class="line">            <span class="string">&#x27;class&#x27;</span>: <span class="string">&#x27;logging.StreamHandler&#x27;</span>,  <span class="comment"># 处理器，这里是控制台打印</span></span><br><span class="line">            <span class="string">&#x27;formatter&#x27;</span>: <span class="string">&#x27;verbose&#x27;</span>  <span class="comment"># 设置日志格式</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&#x27;file&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;level&#x27;</span>: <span class="string">&#x27;DEBUG&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;class&#x27;</span>: <span class="string">&#x27;logging.FileHandler&#x27;</span>,  <span class="comment"># 记录到文件</span></span><br><span class="line">            <span class="string">&#x27;filename&#x27;</span>: <span class="string">&#x27;/Users/hanqunfeng/python_workspace/log/file.log&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;formatter&#x27;</span>: <span class="string">&#x27;verbose&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&#x27;rotatingFile&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;level&#x27;</span>: <span class="string">&#x27;DEBUG&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;class&#x27;</span>: <span class="string">&#x27;logging.handlers.RotatingFileHandler&#x27;</span>,  <span class="comment"># 按文件大小切割日志</span></span><br><span class="line">            <span class="comment"># &#x27;filename&#x27;: &#x27;log/all.log&#x27;,  # 日志输出文件 默认在当前项目根路径下</span></span><br><span class="line">            <span class="string">&#x27;filename&#x27;</span>: <span class="string">&#x27;/Users/hanqunfeng/python_workspace/log/rotatingFile.log&#x27;</span>,  <span class="comment"># 日志输出文件</span></span><br><span class="line">            <span class="string">&#x27;maxBytes&#x27;</span>: <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">5</span>,  <span class="comment"># 每个文件大小</span></span><br><span class="line">            <span class="string">&#x27;backupCount&#x27;</span>: <span class="number">5</span>,  <span class="comment"># 保留日志份数，只保留最后5份，如果都保留，设置为0，默认就是0</span></span><br><span class="line">            <span class="string">&#x27;formatter&#x27;</span>: <span class="string">&#x27;standard&#x27;</span>,  <span class="comment"># 使用哪种formatters日志格式</span></span><br><span class="line">        &#125;,</span><br><span class="line">		<span class="string">&#x27;timedRotatingFile&#x27;</span>: &#123;</span><br><span class="line">		    <span class="string">&#x27;level&#x27;</span>: <span class="string">&#x27;DEBUG&#x27;</span>,</span><br><span class="line">		    <span class="string">&#x27;class&#x27;</span>: <span class="string">&#x27;logging.handlers.TimedRotatingFileHandler&#x27;</span>,  <span class="comment"># 按时间切割日志</span></span><br><span class="line">		    <span class="string">&#x27;filename&#x27;</span>: <span class="string">&#x27;/Users/hanqunfeng/python_workspace/log/timedRotatingFile.log&#x27;</span>,  <span class="comment"># 日志输出文件</span></span><br><span class="line">		    <span class="string">&#x27;when&#x27;</span>: <span class="string">&#x27;D&#x27;</span>,  <span class="comment"># 按天分割</span></span><br><span class="line">		    <span class="string">&#x27;backupCount&#x27;</span>: <span class="number">5</span>,  <span class="comment"># 保留日志份数，只保留最后5份，如果都保留，设置为0，默认就是0</span></span><br><span class="line">		    <span class="string">&#x27;formatter&#x27;</span>: <span class="string">&#x27;standard&#x27;</span>,  <span class="comment"># 使用哪种formatters日志格式</span></span><br><span class="line">		&#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&#x27;loggers&#x27;</span>: &#123;<span class="comment">#日志记录器</span></span><br><span class="line">        <span class="string">&#x27;django&#x27;</span>: &#123;<span class="comment">#日志名称路径前缀，即logging.getLogger(__name__)获取logger对象时，_name__得到的前缀与之匹配即可，比如__name__得到的是django.server</span></span><br><span class="line">            <span class="string">&#x27;handlers&#x27;</span>: [<span class="string">&#x27;console&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;propagate&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line">            <span class="string">&#x27;level&#x27;</span>: os.getenv(<span class="string">&#x27;DJANGO_LOG_LEVEL&#x27;</span>, <span class="string">&#x27;DEBUG&#x27;</span>),  <span class="comment"># 只有设置DEBUG = True时，该配置才会打印sql信息</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&#x27;django.request&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;handlers&#x27;</span>: [<span class="string">&#x27;rotatingFile&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;level&#x27;</span>: <span class="string">&#x27;ERROR&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;propagate&#x27;</span>: <span class="literal">False</span>,  <span class="comment"># 设置为False，表示不像其父级别传递日志内容</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&#x27;myapp.log&#x27;</span>: &#123; <span class="comment"># 也可以这样创建logger对象，logging.getLogger(&#x27;myapp.log&#x27;)</span></span><br><span class="line">            <span class="string">&#x27;handlers&#x27;</span>: [<span class="string">&#x27;file&#x27;</span>, <span class="string">&#x27;timedRotatingFile&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;level&#x27;</span>: <span class="string">&#x27;INFO&#x27;</span>,  <span class="comment"># 这里的日志级别不能低于处理器中设置的日志级别</span></span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>代码中使用方式：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 导入logging库</span></span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="comment"># 获取logger的一个实例</span></span><br><span class="line"><span class="comment"># logger = logging.getLogger(__name__)</span></span><br><span class="line">logger = logging.getLogger(<span class="string">&#x27;myapp.log&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方法中：</span></span><br><span class="line">logger.info(<span class="string">&#x27;这是一个日志&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="19-发送邮件"><a href="#19-发送邮件" class="headerlink" title="19.发送邮件"></a>19.发送邮件</h2><p>1.settings</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">EMAIL_BACKEND = <span class="string">&#x27;django.core.mail.backends.smtp.EmailBackend&#x27;</span></span><br><span class="line">EMAIL_USE_SSL = <span class="literal">True</span></span><br><span class="line">EMAIL_HOST = <span class="string">&#x27;smtp.163.com&#x27;</span></span><br><span class="line">EMAIL_PORT = <span class="number">465</span></span><br><span class="line">EMAIL_HOST_USER = <span class="string">&#x27;xxx@163.com&#x27;</span>  <span class="comment"># 帐号</span></span><br><span class="line">EMAIL_HOST_PASSWORD = <span class="string">&#x27;xxxxxxx&#x27;</span>  <span class="comment"># 密码</span></span><br><span class="line">DEFAULT_FROM_EMAIL = <span class="string">&#x27;hanqf &lt;xxx@163.com&gt;&#x27;</span></span><br></pre></td></tr></table></figure>
<p>2.代码里</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings</span><br><span class="line"><span class="comment"># 发送邮件</span></span><br><span class="line"><span class="keyword">from</span> django.core.mail <span class="keyword">import</span> send_mail</span><br><span class="line">send_mail(<span class="string">&#x27;Subject here主题&#x27;</span>, <span class="string">&#x27;Here is the message.消息&#x27;</span>, settings.DEFAULT_FROM_EMAIL,</span><br><span class="line">          [<span class="string">&#x27;aaaaa@126.com&#x27;</span>], fail_silently=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 一次可以发送多组邮件</span></span><br><span class="line"><span class="keyword">from</span> django.core.mail <span class="keyword">import</span> send_mass_mail</span><br><span class="line"></span><br><span class="line">message1 = (<span class="string">&#x27;Subject here&#x27;</span>, <span class="string">&#x27;Here is the message&#x27;</span>, settings.DEFAULT_FROM_EMAIL,</span><br><span class="line">            [<span class="string">&#x27;aaaaa@126.com&#x27;</span>, <span class="string">&#x27;aaaaa@163.com&#x27;</span>])</span><br><span class="line">message2 = (<span class="string">&#x27;Another Subject&#x27;</span>, <span class="string">&#x27;Here is another message&#x27;</span>, settings.DEFAULT_FROM_EMAIL, [<span class="string">&#x27;aaaaa@126.com&#x27;</span>])</span><br><span class="line">send_mass_mail((message1, message2), fail_silently=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可以这是抄送附件等</span></span><br><span class="line"><span class="keyword">from</span> django.core.mail <span class="keyword">import</span> EmailMultiAlternatives</span><br><span class="line">msg = EmailMultiAlternatives(<span class="string">&#x27;主题&#x27;</span>, <span class="string">&#x27;内容&#x27;</span>, settings.DEFAULT_FROM_EMAIL, [<span class="string">&#x27;aaaaa@126.com&#x27;</span>],</span><br><span class="line">                             cc=[<span class="string">&#x27;aaaaa@163.com&#x27;</span>])</span><br><span class="line"><span class="comment"># msg.content_subtype = &quot;html&quot; # 设置邮件格式，html可以发送内容为html，不推荐这么使用，可以使用下面的方式</span></span><br><span class="line">html_content = <span class="string">&#x27;&lt;p&gt;这是一封&lt;strong&gt;重要的&lt;/strong&gt;邮件.&lt;/p&gt;&#x27;</span></span><br><span class="line">msg.attach_alternative(html_content, <span class="string">&quot;text/html&quot;</span>)  <span class="comment"># 如果接收方的邮件支持html，则显示该信息，否则显示原「内容」</span></span><br><span class="line"><span class="comment"># 添加附件（可选）</span></span><br><span class="line">msg.attach_file(<span class="string">&#x27;/Users/hanqunfeng/python_workspace/STATIC_ROOT/polls/images/background.jpg&#x27;</span>)</span><br><span class="line"><span class="comment"># 发送</span></span><br><span class="line">msg.send()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="20-main方法测试"><a href="#20-main方法测试" class="headerlink" title="20.main方法测试"></a>20.main方法测试</h2><p>mian方法测试一定要在如下情况下使用，这样可以保证当前模块被别处引用时不会触发如下测试代码，只有独立运行该模块时才会执行。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># 加载环境配置</span></span><br><span class="line">    <span class="keyword">import</span> django, os</span><br><span class="line">    os.environ.setdefault(<span class="string">&quot;DJANGO_SETTINGS_MODULE&quot;</span>, <span class="string">&quot;DjangoHelloWorld.settings&quot;</span>)</span><br><span class="line">    django.setup()</span><br><span class="line">    <span class="comment"># 以下是测试内容</span></span><br><span class="line">    <span class="keyword">from</span> myapp.models.user <span class="keyword">import</span> User</span><br><span class="line">    user_list = User.objects.<span class="built_in">all</span>()</span><br><span class="line">    xml = to_xml(user_list)</span><br><span class="line">    <span class="built_in">print</span>(xml)</span><br></pre></td></tr></table></figure>

<h2 id="21-Signal，信号，有点类似MQ"><a href="#21-Signal，信号，有点类似MQ" class="headerlink" title="21.Signal，信号，有点类似MQ"></a>21.Signal，信号，有点类似MQ</h2><p>1.定义信号和接收器</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> django.dispatch <span class="keyword">import</span> Signal, receiver</span><br><span class="line"><span class="comment"># my_singal = Signal()</span></span><br><span class="line">my_singal = Signal(providing_args=[<span class="string">&quot;key1&quot;</span>, <span class="string">&quot;key2&quot;</span>]) <span class="comment"># 定义信号接收的参数，不指定参数也可以</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@receiver(<span class="params">my_singal</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_callback</span>(<span class="params">sender, **kwargs</span>):</span> <span class="comment"># 接收器回调函数</span></span><br><span class="line">    <span class="built_in">print</span>(sender)</span><br><span class="line">    <span class="built_in">print</span>(kwargs)</span><br><span class="line">    <span class="keyword">for</span> key <span class="keyword">in</span> kwargs:</span><br><span class="line">        <span class="built_in">print</span>(key)</span><br><span class="line">        <span class="built_in">print</span>(kwargs[key])</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Request finished!&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>2.发送信号，发送信号时接收器就会被执行</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> signals.signals <span class="keyword">import</span> my_singal</span><br><span class="line">my_singal.send(sender=__name__, key1=<span class="string">&#x27;qqq&#x27;</span>, key2=<span class="number">10</span>, key3=<span class="number">100</span>) <span class="comment"># 实际上可以多发送一些参数</span></span><br></pre></td></tr></table></figure>


<h2 id="22-Django管理后台简介"><a href="#22-Django管理后台简介" class="headerlink" title="22.Django管理后台简介"></a>22.Django管理后台简介</h2><p>首先，我们需要创建一个能够登录管理后台站点的用户。<br>运行如下命令：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">python manage.py createsuperuser</span><br></pre></td></tr></table></figure>

<p>键入你想要使用的用户名，然后按下回车键：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Username: admin</span><br></pre></td></tr></table></figure>

<p>然后提示你输入想要使用的邮件地址：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Email address: admin@example.com</span><br></pre></td></tr></table></figure>

<p>你需要输入两次密码，第二次输入是确认密码</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Password: **********</span><br><span class="line">Password (again): *********</span><br><span class="line">Superuser created successfully.</span><br></pre></td></tr></table></figure>

<p>PS：管理员密码忘记了可以通过如下方法修改：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> python manage.py shell</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; from django.contrib.auth.models import User</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; user = User.objects.get(pk=1) <span class="comment"># 可以通过查询获得用户对象</span></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; user.set_password(<span class="string">&#x27;xxxxxxxx&#x27;</span>)</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; user.save()</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; quit()</span></span><br></pre></td></tr></table></figure>




<h2 id="23-部署正式环境"><a href="#23-部署正式环境" class="headerlink" title="23.部署正式环境"></a>23.部署正式环境</h2><p>settings.py:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">DEBUG = <span class="literal">False</span> <span class="comment"># 此时很多问题就会出现，需要增加很多额外的配置才能正常工作，这也是为了包含生产环境吧</span></span><br><span class="line"></span><br><span class="line">ALLOWED_HOSTS = [<span class="string">&#x27;127.0.0.1&#x27;</span>]</span><br><span class="line"><span class="comment"># ALLOWED_HOSTS = [&#x27;*&#x27;, ]  # 允许所有机器访问</span></span><br><span class="line"></span><br><span class="line">STATIC_URL = <span class="string">&#x27;http://localhost/static/&#x27;</span>      <span class="comment"># apache部署的静态文件服务器访问地址</span></span><br><span class="line"></span><br><span class="line">STATIC_ROOT = <span class="string">&quot;/Users/hanqunfeng/python_workspace/STATIC_ROOT/&quot;</span>  <span class="comment">#apache 服务目录</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 上传文件路径</span></span><br><span class="line">MEDIA_URL = <span class="string">&#x27;http://localhost/media/&#x27;</span></span><br><span class="line">MEDIA_ROOT = <span class="string">&#x27;/Users/hanqunfeng/python_workspace/MEDIA/&#x27;</span></span><br></pre></td></tr></table></figure>

<p>apache配置：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Alias /media/ /Users/hanqunfeng/python_workspace/MEDIA/</span><br><span class="line">Alias /static/ /Users/hanqunfeng/python_workspace/STATIC_ROOT/</span><br><span class="line"></span><br><span class="line">&lt;Directory /Users/hanqunfeng/python_workspace/STATIC_ROOT&gt;</span><br><span class="line">Require all granted</span><br><span class="line">&lt;/Directory&gt;</span><br><span class="line"></span><br><span class="line">&lt;Directory /Users/hanqunfeng/python_workspace/MEDIA/&gt;</span><br><span class="line">Require all granted</span><br><span class="line">&lt;/Directory&gt;</span><br></pre></td></tr></table></figure>
<p>使用如下命令可以将本地的静态资源部署到apache服务目录：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">python manage.py collectstatic</span><br></pre></td></tr></table></figure>

<p>模板页面：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">&#123;% load static %&#125;</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span> <span class="attr">href</span>=<span class="string">&quot;&#123;% static &#x27;polls/style.css&#x27; %&#125;&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>上传文件：<br>model中：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">photo = models.ImageField(upload_to=<span class="string">&quot;photo&quot;</span>, default=<span class="string">&quot;default/django.jpeg&quot;</span>)  <span class="comment"># 路径相对于MEDIA_ROOT的配置</span></span><br></pre></td></tr></table></figure>
<p>之后要注意更新数据库。</p>
<p>需要安装Pillow，否则会报错</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ERRORS:</span><br><span class="line">polls.Question.photo: (fields.E210) Cannot use ImageField because Pillow is not installed.</span><br><span class="line">	HINT: Get Pillow at https://pypi.python.org/pypi/Pillow or run command &quot;pip install Pillow&quot;.</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pip install Pillow</span><br></pre></td></tr></table></figure>

<p>如果要在页面中使用settings中的变量，需要在当前应用中创建一个context_processors.py 文件</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings  <span class="comment"># import the settings file</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">settings_constant</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="comment"># return the value you want as a dictionnary. you may add multiple values in there.</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&#x27;MEDIA_URL&#x27;</span>: settings.MEDIA_URL, <span class="string">&#x27;DEBUG&#x27;</span>: settings.DEBUG&#125;</span><br></pre></td></tr></table></figure>
<p>并在settings文件配置如下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">TEMPLATES = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&#x27;BACKEND&#x27;</span>: <span class="string">&#x27;django.template.backends.django.DjangoTemplates&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;DIRS&#x27;</span>: [os.path.join(BASE_DIR, <span class="string">&#x27;templates&#x27;</span>)]</span><br><span class="line">        ,</span><br><span class="line">        <span class="string">&#x27;APP_DIRS&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line">        <span class="string">&#x27;OPTIONS&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;context_processors&#x27;</span>: [</span><br><span class="line">                <span class="string">&#x27;django.template.context_processors.debug&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;django.template.context_processors.request&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;django.contrib.auth.context_processors.auth&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;django.contrib.messages.context_processors.messages&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;polls.context_processors.settings_constant&#x27;</span>, <span class="comment">#应用名称.文件名称.方法名称</span></span><br><span class="line">            ],</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>模板页面中：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">enctype</span>=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;&#123;&#123;MEDIA_URL&#125;&#125;abc/a.png&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;photo&quot;</span> <span class="attr">id</span>=<span class="string">&quot;id_photo&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line">也可以使用下面的形式获得上传文件的url，</span><br><span class="line">即使用上传文件字段的url属性：&#123;&#123; question.photo.url &#125;&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;&#123;&#123;MEDIA_URL&#125;&#125;&#123;&#123; question.photo &#125;&#125;&quot;</span>&gt;</span>&#123;&#123; question.photo &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span> ##</span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;&#123;&#123; question.photo.url &#125;&#125;&quot;</span>&gt;</span>&#123;&#123; question.photo &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>views处理代码中：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">input_img = request.FILES[<span class="string">&#x27;photo&#x27;</span>]</span><br><span class="line">question.photo = input_img</span><br><span class="line">question.save()</span><br></pre></td></tr></table></figure>


<p>部署到apache：</p>
<p>下载mod_wsgi：<a href="https://github.com/GrahamDumpleton/mod_wsgi/releases">https://github.com/GrahamDumpleton/mod_wsgi/releases</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tar xvfz mod_wsgi-X.Y.tar.gz</span><br><span class="line">./configure --with-apxs=/Applications/XAMPP/bin/apxs --with-python=/Library/Frameworks/Python.framework/Versions/3.6/bin/python3</span><br><span class="line"></span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<p>然后在apache配置文件中加入如下配置</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">LoadModule wsgi_module modules/mod_wsgi.so</span><br></pre></td></tr></table></figure>
<p>普通模式：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">WSGIPythonHome /Users/hanqunfeng/python_workspace/DjangoHelloWorld/venv</span><br><span class="line">WSGIPythonPath /Users/hanqunfeng/python_workspace/DjangoHelloWorld</span><br></pre></td></tr></table></figure>
<p>或者采用守护进程模式：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">WSGIDaemonProcess example.com python-home=/Users/hanqunfeng/python_workspace/DjangoHelloWorld/venv python-path=/Users/hanqunfeng/python_workspace/DjangoHelloWorld</span><br><span class="line"></span><br><span class="line">WSGIProcessGroup example.com</span><br></pre></td></tr></table></figure>
<p>配置项目访问路径</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">WSGIScriptAlias /mysite /Users/hanqunfeng/python_workspace/DjangoHelloWorld/DjangoHelloWorld/wsgi.py</span><br><span class="line"></span><br><span class="line">&lt;Directory /Users/hanqunfeng/python_workspace/DjangoHelloWorld/DjangoHelloWorld&gt;</span><br><span class="line">&lt;Files wsgi.py&gt;</span><br><span class="line">Require all granted</span><br><span class="line">&lt;/Files&gt;</span><br><span class="line">&lt;/Directory&gt;</span><br></pre></td></tr></table></figure>
<p>访问地址：<a href="http://127.0.0.1/mysite/polls">http://127.0.0.1/mysite/polls</a></p>
]]></content>
      <categories>
        <category>技术</category>
      </categories>
      <tags>
        <tag>Django</tag>
      </tags>
  </entry>
  <entry>
    <title>Protocol Buffer学习笔记(Python)</title>
    <url>/2018/03/27/protocol-buffer-study-python/</url>
    <content><![CDATA[<h2 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h2><ul>
<li>本文内容基于python3.6.4，protobuf3.5.1，但实际上python2和protobuf2.x.x同样适用</li>
<li><a href="https://www.jianshu.com/p/55f4b4b22dd2">Protocol Buffer学习笔记(Java&amp;NodeJS)</a></li>
<li><a href="https://www.jianshu.com/p/7b12fa3ca8e3">Protocol Buffer学习笔记(PHP)</a></li>
</ul>
<span id="more"></span>
<h2 id="项目中引入proto的依赖"><a href="#项目中引入proto的依赖" class="headerlink" title="项目中引入proto的依赖"></a>项目中引入proto的依赖</h2><p>【两种方法】：<br>方法1、 <a href="https://github.com/google/protobuf/releases">官网下载对应的语言包</a>，这里下载<a href="https://github.com/google/protobuf/releases/download/v3.5.1/protobuf-python-3.5.1.tar.gz">protobuf-python-3.5.1.tar.gz</a>，解压后进入<code>python-protobuf-3.5.1/python</code>目录，执行<code>python3 setup.py install</code><br>方法2 、【推荐】命令行执行<code>pip3 install protobuf</code>，此时会下载最新的protobuf版本，如果下载的版本与本地安装的proto命令版本不一致，有可能导致异常，所以此时最好指定要下载的版本号：<code>pip3 install protobuf==3.5.1</code></p>
<p>【注意】</p>
<ul>
<li>上面的安装方式是全局安装，安装成功后对应的依赖包都会被安装到对应的site-packages目录下，比如<code>/Library/Frameworks/Python.framework/Versions/3.6/lib/python3.6/site-packages</code>使用IDE开发时，如PyCharm，绑定interpreter时要注意勾选<code>inherit global site-packages</code>，这样项目才能使用全局依赖中的所有包</li>
<li>如果只是为当前项目安装依赖包可以不勾选<code>inherit global site-packages</code>，然后进入当前项目依赖的pip目录，即<code>Location</code>指定的路径下，执行<code>./bin/pip install protobuf==3.5.1</code>来安装需要的依赖包</li>
</ul>
<h2 id="准备proto文件"><a href="#准备proto文件" class="headerlink" title="准备proto文件"></a>准备proto文件</h2><ul>
<li>proto示例文件参考[Protocol Buffer学习笔记(Java&amp;NodeJS)]<br>(<a href="https://www.jianshu.com/p/55f4b4b22dd2">https://www.jianshu.com/p/55f4b4b22dd2</a>)</li>
<li>python同时支持proto2和proto3，所以如果基于proto3，这里注意去掉其中的<code>required</code>、<code>optional</code>，因为这里要求语法严格遵循proto3，不能在属性前出现<code>required</code>、<code>optional</code>，同时文件顶端要明确<code>syntax = &quot;proto3&quot;;</code></li>
</ul>
<h2 id="生成proto对应的python文件"><a href="#生成proto对应的python文件" class="headerlink" title="生成proto对应的python文件"></a>生成proto对应的python文件</h2><ul>
<li>命令行执行<br><code>protoc   --python_out=. OTIpcDef.proto</code></li>
<li>此时会在当前目录下生成<code>OTIpcDef_pb2.py</code>，将该文件拷贝到项目中，比如放到项目根目录的proto目录下</li>
</ul>
<h2 id="python中使用protobuf"><a href="#python中使用protobuf" class="headerlink" title="python中使用protobuf"></a>python中使用protobuf</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> proto <span class="keyword">import</span> OTIpcDef_pb2</span><br><span class="line"></span><br><span class="line">otIpcList = OTIpcDef_pb2.OTIpcList()</span><br><span class="line"></span><br><span class="line"><span class="comment"># list类型数据创建方式</span></span><br><span class="line">otIpc = otIpcList.otpic.add()</span><br><span class="line">otIpc.CompanyId = <span class="string">&quot;companyId&quot;</span></span><br><span class="line">otIpc.Source = <span class="string">&quot;Source&quot;</span></span><br><span class="line">otIpc.IPCType = OTIpcDef_pb2.baseInfoCompany</span><br><span class="line"><span class="comment"># list类型数据创建方式</span></span><br><span class="line">baseInfoCompany = otIpc.baseInfoCompany.add()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># print(type(baseInfoCompany))</span></span><br><span class="line"></span><br><span class="line">baseInfoCompany.Address = <span class="number">110011</span></span><br><span class="line">baseInfoCompany.CompanyId = <span class="string">&quot;companyId&quot;</span></span><br><span class="line">baseInfoCompany.CompanyName = <span class="string">&quot;companyName中文&quot;</span></span><br><span class="line">baseInfoCompany.Identifier = <span class="string">&quot;identifier&quot;</span></span><br><span class="line">baseInfoCompany.BusinessScope = <span class="string">&quot;BusinessScope&quot;</span></span><br><span class="line">baseInfoCompany.ContactAddress = <span class="string">&quot;ContactAddress&quot;</span></span><br><span class="line">baseInfoCompany.EconomicType = <span class="string">&quot;EconomicType&quot;</span></span><br><span class="line">baseInfoCompany.RegCapital = <span class="string">&quot;RegCapital&quot;</span></span><br><span class="line">baseInfoCompany.LegalName = <span class="string">&quot;LegalName&quot;</span></span><br><span class="line">baseInfoCompany.LegalID = <span class="string">&quot;LegalID&quot;</span></span><br><span class="line">baseInfoCompany.LegalPhone = <span class="string">&quot;LegalPhone&quot;</span></span><br><span class="line">baseInfoCompany.State = <span class="number">0</span></span><br><span class="line">baseInfoCompany.Flag = <span class="number">1</span></span><br><span class="line">baseInfoCompany.UpdateTime = <span class="number">20180226121212</span></span><br><span class="line"></span><br><span class="line">otIpc2 = otIpcList.otpic.add()</span><br><span class="line">otIpc2.CompanyId = <span class="string">&quot;companyId&quot;</span></span><br><span class="line">otIpc2.Source = <span class="string">&quot;Source&quot;</span></span><br><span class="line">otIpc2.IPCType = OTIpcDef_pb2.baseInfoCompanyStat</span><br><span class="line">baseInfoCompanyStat = otIpc2.baseInfoCompanyStat.add()</span><br><span class="line">baseInfoCompanyStat.CompanyId = <span class="string">&quot;companyId&quot;</span></span><br><span class="line">baseInfoCompanyStat.DriverNum = <span class="number">10</span></span><br><span class="line">baseInfoCompanyStat.Flag = <span class="number">0</span></span><br><span class="line">baseInfoCompanyStat.UpdateTime = <span class="number">20180226121212</span></span><br><span class="line">baseInfoCompanyStat.VehicleNum = <span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;============================================&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># print(otIpc)</span></span><br><span class="line"><span class="built_in">print</span>(otIpcList)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;============================================&quot;</span>)</span><br><span class="line"><span class="comment"># 序列化</span></span><br><span class="line">b = otIpcList.SerializeToString()</span><br><span class="line"><span class="comment"># 打印二进制数据</span></span><br><span class="line"><span class="built_in">print</span>(b)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;============================================&quot;</span>)</span><br><span class="line"></span><br><span class="line">otIpcList2 = OTIpcDef_pb2.OTIpcList()</span><br><span class="line"><span class="comment"># 反序列化</span></span><br><span class="line">otIpcList2.ParseFromString(b)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(otIpcList2)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>技术</category>
      </categories>
      <tags>
        <tag>protocbuf</tag>
      </tags>
  </entry>
  <entry>
    <title>Protocol Buffer学习笔记(PHP)</title>
    <url>/2018/03/19/protocol-buffer-study-php/</url>
    <content><![CDATA[<h2 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h2><ul>
<li>本文内容基于laravel5.4.*框架</li>
<li><a href="http://blog.hanqunfeng.com/2018/02/26/protocol-buffer-study/">Protocol Buffer学习笔记(Java&amp;NodeJS)</a></li>
</ul>
<span id="more"></span>

<h2 id="项目中引入proto的依赖"><a href="#项目中引入proto的依赖" class="headerlink" title="项目中引入proto的依赖"></a>项目中引入proto的依赖</h2><p>在项目根目录下执行如下命令，composer会自动下载最新版本，目前是”google/protobuf”: “^3.5”<br><code>composer require &quot;google/protobuf&quot; </code></p>
<h2 id="准备proto文件"><a href="#准备proto文件" class="headerlink" title="准备proto文件"></a>准备proto文件</h2><ul>
<li>注意事项参考：<a href="https://developers.google.com/protocol-buffers/docs/reference/php-generated">PHP Generated Code</a></li>
<li>proto示例文件参考<a href="http://blog.hanqunfeng.com/2018/02/26/protocol-buffer-study/">Protocol Buffer学习笔记(Java&amp;NodeJS)</a>，这里注意去掉其中的<code>required</code>、<code>optional</code>，因为这里要求语法严格遵循proto3，不能在属性前出现<code>required</code>、<code>optional</code>，所以文件顶端要明确<code>syntax = &quot;proto3&quot;;</code>，另外增加package配置为<code>package app.proto;</code></li>
</ul>
<h2 id="生成proto对应的php文件"><a href="#生成proto对应的php文件" class="headerlink" title="生成proto对应的php文件"></a>生成proto对应的php文件</h2><ul>
<li><p>将准备好的proto文件放到laravel根目录下，并在根目录下执行如下命令<br><code>protoc   --php_out=. OTIpcDef.proto</code></p>
</li>
<li><p>此时会在app目录下自动创建Proto目录，并在其目录下生成对应的php类文件</p>
</li>
<li><p>同时在根目录下会生成GPBMetadata\OTIpcDef.php</p>
</li>
<li><p>由于laravel要求所有的class都必须在app目录下，所以需要移动GPBMetadata目录到app目录下，同时修改对应的namespace 为<code>namespace App\GPBMetadata;</code>;</p>
</li>
<li><p>同时需要修改app\Proto下的各个class的构造方法</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    \App\GPBMetadata\OTIpcDef::initOnce();</span><br><span class="line">    <span class="built_in">parent</span>::__construct();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="php中使用protobuf"><a href="#php中使用protobuf" class="headerlink" title="php中使用protobuf"></a>php中使用protobuf</h2><p>创建ProtoController</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Proto</span>\<span class="title">BaseInfoCompany</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Helper</span>\<span class="title">HttpUtils</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProtoController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ProtoController constructor.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-主动获取protobuf数据"><a href="#1-主动获取protobuf数据" class="headerlink" title="1.主动获取protobuf数据"></a>1.主动获取protobuf数据</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">build_proto_data</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$baseInfoCompany</span>  = <span class="keyword">new</span> BaseInfoCompany();</span><br><span class="line">        <span class="variable">$baseInfoCompany</span>-&gt;setAddress(<span class="number">110011</span>);</span><br><span class="line">        <span class="variable">$baseInfoCompany</span>-&gt;setCompanyId(<span class="string">&quot;companyId&quot;</span>);</span><br><span class="line">        <span class="variable">$baseInfoCompany</span>-&gt;setCompanyName(<span class="string">&quot;companyName中文&quot;</span>);</span><br><span class="line">        <span class="variable">$baseInfoCompany</span>-&gt;setIdentifier(<span class="string">&quot;identifier&quot;</span>);</span><br><span class="line">        <span class="variable">$baseInfoCompany</span>-&gt;setBusinessScope(<span class="string">&quot;BusinessScope&quot;</span>);</span><br><span class="line">        <span class="variable">$baseInfoCompany</span>-&gt;setContactAddress(<span class="string">&quot;ContactAddress&quot;</span>);</span><br><span class="line">        <span class="variable">$baseInfoCompany</span>-&gt;setEconomicType(<span class="string">&quot;EconomicType&quot;</span>);</span><br><span class="line">        <span class="variable">$baseInfoCompany</span>-&gt;setRegCapital(<span class="string">&quot;RegCapital&quot;</span>);</span><br><span class="line">        <span class="variable">$baseInfoCompany</span>-&gt;setLegalName(<span class="string">&quot;LegalName&quot;</span>);</span><br><span class="line">        <span class="variable">$baseInfoCompany</span>-&gt;setLegalID(<span class="string">&quot;LegalID&quot;</span>);</span><br><span class="line">        <span class="variable">$baseInfoCompany</span>-&gt;setLegalPhone(<span class="string">&quot;LegalPhone&quot;</span>);</span><br><span class="line">        <span class="variable">$baseInfoCompany</span>-&gt;setState(<span class="number">0</span>);</span><br><span class="line">        <span class="variable">$baseInfoCompany</span>-&gt;setFlag(<span class="number">1</span>);</span><br><span class="line">        <span class="variable">$baseInfoCompany</span>-&gt;setUpdateTime(<span class="number">20180226121212</span>);</span><br><span class="line">        <span class="comment">// $protostr = $baseInfoCompany-&gt;serializeToString();</span></span><br><span class="line">        <span class="comment">//生成json</span></span><br><span class="line">        <span class="variable">$protostr</span> = <span class="variable">$baseInfoCompany</span>-&gt;serializeToJsonString();</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$protostr</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">receive_proto_data</span>(<span class="params"></span>)</span>&#123;       </span><br><span class="line">        <span class="variable">$protoData</span> = file_get_contents(<span class="string">&quot;http://localhost:83/proto/build&quot;</span>);     </span><br><span class="line">        <span class="keyword">try</span> &#123;   </span><br><span class="line">            <span class="variable">$baseInfoCompany</span> = <span class="keyword">new</span> BaseInfoCompany();</span><br><span class="line"><span class="comment">//            $baseInfoCompany-&gt;mergeFromString($protoData);</span></span><br><span class="line">            <span class="variable">$baseInfoCompany</span>-&gt;mergeFromJsonString(<span class="variable">$protoData</span>);</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$baseInfoCompany</span>-&gt;getCompanyName();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$baseInfoCompany</span>-&gt;serializeToJsonString();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="built_in">Exception</span> <span class="variable">$ex</span>) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;something is wrong&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-被动接收protobuf数据"><a href="#2-被动接收protobuf数据" class="headerlink" title="2.被动接收protobuf数据"></a>2.被动接收protobuf数据</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">send_proto_data</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$data</span> = <span class="keyword">$this</span>-&gt;build_proto_data();</span><br><span class="line">        <span class="variable">$receive</span> = HttpUtils::request_by_curl(<span class="string">&quot;http://localhost:83/proto/receive&quot;</span>,<span class="variable">$data</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$receive</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">receive_proto_data</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="comment">// $protoData = file_get_contents(&quot;http://localhost:83/proto/build&quot;);   </span></span><br><span class="line">        <span class="variable">$protoData</span> = <span class="variable">$_POST</span>[<span class="string">&quot;data&quot;</span>];</span><br><span class="line">        <span class="keyword">try</span> &#123;       </span><br><span class="line">            <span class="variable">$baseInfoCompany</span> = <span class="keyword">new</span> BaseInfoCompany();</span><br><span class="line"><span class="comment">//            $baseInfoCompany-&gt;mergeFromString($protoData);</span></span><br><span class="line">            <span class="variable">$baseInfoCompany</span>-&gt;mergeFromJsonString(<span class="variable">$protoData</span>);</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$baseInfoCompany</span>-&gt;getCompanyName();</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$baseInfoCompany</span>-&gt;serializeToJsonString();        </span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="built_in">Exception</span> <span class="variable">$ex</span>) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;something is wrong&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>这里用到一个工具类<code>App\Helper\HttpUtils</code><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Helper</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HttpUtils</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">request_by_curl</span>(<span class="params"><span class="variable">$remote_server</span>, <span class="variable">$post_string</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$ch</span> = curl_init();</span><br><span class="line">        curl_setopt(<span class="variable">$ch</span>, CURLOPT_URL, <span class="variable">$remote_server</span>);</span><br><span class="line">        curl_setopt(<span class="variable">$ch</span>, CURLOPT_POSTFIELDS, <span class="string">&#x27;data=&#x27;</span> . <span class="variable">$post_string</span>);</span><br><span class="line">        curl_setopt(<span class="variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="literal">true</span>);</span><br><span class="line">        curl_setopt(<span class="variable">$ch</span>, CURLOPT_USERAGENT, <span class="string">&#x27;Mozilla/5.0 (compatible; MSIE 5.01; Windows NT 5.0)&#x27;</span>);</span><br><span class="line">        curl_setopt(<span class="variable">$ch</span>, CURLOPT_TIMEOUT, <span class="number">1</span>);<span class="comment">//异步处理</span></span><br><span class="line">        <span class="variable">$data</span> = curl_exec(<span class="variable">$ch</span>);</span><br><span class="line">        <span class="keyword">if</span> (curl_errno(<span class="variable">$ch</span>)) &#123; <span class="comment">//响应错误的处理</span></span><br><span class="line">        &#125;</span><br><span class="line">        curl_close(<span class="variable">$ch</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$data</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
]]></content>
      <categories>
        <category>技术</category>
      </categories>
      <tags>
        <tag>protocbuf</tag>
      </tags>
  </entry>
  <entry>
    <title>JAVA与NodeJS实现AES加密</title>
    <url>/2018/03/09/java_nodejs_aes/</url>
    <content><![CDATA[<h2 id="内容要点"><a href="#内容要点" class="headerlink" title="内容要点"></a>内容要点</h2><p>本文实现java与nodejs的AES加密方式如下，并可实现java加密，nodejs解密或者nodejs加密，java解密</p>
<ul>
<li>aes-128-ecb</li>
<li>aes-256-ecb</li>
<li>aes-128-cbc</li>
<li>aes-256-cbc</li>
</ul>
<span id="more"></span>

<h2 id="java实现AES"><a href="#java实现AES" class="headerlink" title="java实现AES"></a>java实现AES</h2><h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h3><p>Java本身限制密钥的长度最多128位，而AES256需要的密钥长度是256位，因此需要到Java官网上下载一个<a href="http://www.oracle.com/technetwork/java/javase/downloads/jce8-download-2133166.html">Java Cryptography Extension (JCE) Unlimited Strength Jurisdiction Policy Files</a>。在<a href="http://www.oracle.com/technetwork/java/javase/downloads/index.html">Java SE的下载页面</a>下面的Additional Resources那里会有下载链接。下载后打开压缩包，里面有两个jar文件:<br><code>local_policy.jar </code>和<code>US_export_policy.jar</code><br>把这两个jar文件解压到JRE目录下的lib/security文件夹，覆盖原来的文件。这样Java就不再限制密钥的长度了，否则编译会报错：</p>
<p><code>java.security.InvalidKeyException: Illegal key size</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.lang.StringUtils;</span><br><span class="line"><span class="keyword">import</span> sun.misc.BASE64Decoder;</span><br><span class="line"><span class="keyword">import</span> sun.misc.BASE64Encoder;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.Cipher;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.spec.IvParameterSpec;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.spec.SecretKeySpec;</span><br><span class="line"><span class="keyword">import</span> java.security.spec.AlgorithmParameterSpec;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EncodeUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//key是16进制，需要转换为bytes，转换后bytes长度为16，即aes128，如果bytes长度是32则是aes256</span></span><br><span class="line">        <span class="comment">//也就是说keybytes.length须满足16的整数倍</span></span><br><span class="line">        String key128 = <span class="string">&quot;c4b84456c1379bec99c4d1b7e9f13173&quot;</span>;</span><br><span class="line">        String key256 = <span class="string">&quot;c4b84456c1379bec99c4d1b7e9f13173c4b84456c1379bec99c4d1b7e9f13173&quot;</span>;</span><br><span class="line">        <span class="comment">//iv.length须满足16的整数倍</span></span><br><span class="line">        <span class="keyword">byte</span>[] iv = <span class="string">&quot;abcdefgh12345678&quot;</span>.getBytes(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        String content_str = <span class="string">&quot;helloworld 你好&quot;</span>;</span><br><span class="line">        <span class="keyword">byte</span>[] contentbytes = content_str.getBytes(<span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//ecb128 bytes</span></span><br><span class="line">        <span class="keyword">byte</span>[] encryptbytes = EncodeUtil.aesEncryptToECB(contentbytes,key128);</span><br><span class="line">        <span class="keyword">byte</span>[] decryptbytes = EncodeUtil.aesDecryptToECB(encryptbytes,key128);</span><br><span class="line">        System.out.println(<span class="keyword">new</span> String(decryptbytes,<span class="string">&quot;utf-8&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//ecb256 bytes</span></span><br><span class="line">        encryptbytes = EncodeUtil.aesEncryptToECB(contentbytes,key256);</span><br><span class="line">        decryptbytes = EncodeUtil.aesDecryptToECB(encryptbytes,key256);</span><br><span class="line">        System.out.println(<span class="keyword">new</span> String(decryptbytes,<span class="string">&quot;utf-8&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//ecb128 String</span></span><br><span class="line">        String encryptString = EncodeUtil.aesEncryptToECB(content_str,key128);</span><br><span class="line">        String decryptString = EncodeUtil.aesDecryptToECB(encryptString,key128);</span><br><span class="line">        System.out.println(decryptString);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//ecb256 String</span></span><br><span class="line">        encryptString = EncodeUtil.aesEncryptToECB(content_str,key256);</span><br><span class="line">        decryptString = EncodeUtil.aesDecryptToECB(encryptString,key256);</span><br><span class="line">        System.out.println(decryptString);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//cbc128 bytes</span></span><br><span class="line">        encryptbytes = EncodeUtil.aesEncryptToCBC(contentbytes,key128,iv);</span><br><span class="line">        decryptbytes = EncodeUtil.aesDecryptToCBC(encryptbytes,key128,iv);</span><br><span class="line">        System.out.println(<span class="keyword">new</span> String(decryptbytes,<span class="string">&quot;utf-8&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//cbc256 bytes</span></span><br><span class="line">        encryptbytes = EncodeUtil.aesEncryptToCBC(contentbytes,key256,iv);</span><br><span class="line">        decryptbytes = EncodeUtil.aesDecryptToCBC(encryptbytes,key256,iv);</span><br><span class="line">        System.out.println(<span class="keyword">new</span> String(decryptbytes,<span class="string">&quot;utf-8&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//cbc128 String</span></span><br><span class="line">        encryptString = EncodeUtil.aesEncryptToCBC(content_str,key128,iv);</span><br><span class="line">        decryptString = EncodeUtil.aesDecryptToCBC(encryptString,key128,iv);</span><br><span class="line">        System.out.println(decryptString);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//cbc256 String</span></span><br><span class="line">        encryptString = EncodeUtil.aesEncryptToCBC(content_str,key256,iv);</span><br><span class="line">        decryptString = EncodeUtil.aesDecryptToCBC(encryptString,key256,iv);</span><br><span class="line">        System.out.println(decryptString);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * base 64 encode</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bytes 待编码的byte[]</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 编码后的base 64 code</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">base64Encode</span><span class="params">(<span class="keyword">byte</span>[] bytes)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BASE64Encoder().encode(bytes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * base 64 decode</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> base64Code 待解码的base 64 code</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 解码后的byte[]</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] base64Decode(String base64Code) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> StringUtils.isEmpty(base64Code) ? <span class="keyword">null</span> : <span class="keyword">new</span> BASE64Decoder().decodeBuffer(base64Code);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 验证密钥长度是否有效</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 密钥bytes</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">checkkey</span><span class="params">(<span class="keyword">byte</span>[] key)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(key.length != <span class="number">16</span> &amp;&amp; key.length != <span class="number">32</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;密钥长度错误，必须是16后者32位&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * AES加密 aes-128/256-ecb</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> content    待加密的内容</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> encryptKey 加密密钥</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 加密后的byte[]</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] aesEncryptToECB(<span class="keyword">byte</span>[] content, String encryptKey) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">byte</span>[] key = org.apache.commons.codec.binary.Hex.decodeHex(encryptKey.toCharArray());</span><br><span class="line">        checkkey(key);</span><br><span class="line">        Cipher cipher = Cipher.getInstance(<span class="string">&quot;AES/ECB/PKCS5Padding&quot;</span>);</span><br><span class="line">        cipher.init(Cipher.ENCRYPT_MODE, <span class="keyword">new</span> SecretKeySpec(key, <span class="string">&quot;AES&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> cipher.doFinal(content);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * AES加密 aes-128/256-ecb</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> content    待加密的内容</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> encryptKey 加密密钥</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 加密后的base64字符串</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">aesEncryptToECB</span><span class="params">(String content, String encryptKey)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">byte</span>[] key = org.apache.commons.codec.binary.Hex.decodeHex(encryptKey.toCharArray());</span><br><span class="line">        checkkey(key);</span><br><span class="line">        Cipher cipher = Cipher.getInstance(<span class="string">&quot;AES/ECB/PKCS5Padding&quot;</span>);</span><br><span class="line">        cipher.init(Cipher.ENCRYPT_MODE, <span class="keyword">new</span> SecretKeySpec(key, <span class="string">&quot;AES&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> base64Encode(cipher.doFinal(content.getBytes(<span class="string">&quot;utf-8&quot;</span>)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * AES解密 aes-128/256-ecb</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> content 待解密的byte[]</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> decryptKey   解密密钥</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 解密后的byte[]</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] aesDecryptToECB(<span class="keyword">byte</span>[] content, String decryptKey) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">byte</span>[] key = org.apache.commons.codec.binary.Hex.decodeHex(decryptKey.toCharArray());</span><br><span class="line">        checkkey(key);</span><br><span class="line">        Cipher cipher = Cipher.getInstance(<span class="string">&quot;AES/ECB/PKCS5Padding&quot;</span>);</span><br><span class="line">        cipher.init(Cipher.DECRYPT_MODE, <span class="keyword">new</span> SecretKeySpec(key, <span class="string">&quot;AES&quot;</span>));</span><br><span class="line">        <span class="keyword">byte</span>[] decryptBytes = cipher.doFinal(content);</span><br><span class="line">        <span class="keyword">return</span> decryptBytes;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * AES解密 aes-128/256-ecb</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> content 待解密的byte[]</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> decryptKey   解密密钥</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 解密后的String</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">aesDecryptToECB</span><span class="params">(String content, String decryptKey)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">byte</span>[] key = org.apache.commons.codec.binary.Hex.decodeHex(decryptKey.toCharArray());</span><br><span class="line">        checkkey(key);</span><br><span class="line">        Cipher cipher = Cipher.getInstance(<span class="string">&quot;AES/ECB/PKCS5Padding&quot;</span>);</span><br><span class="line">        cipher.init(Cipher.DECRYPT_MODE, <span class="keyword">new</span> SecretKeySpec(key, <span class="string">&quot;AES&quot;</span>));</span><br><span class="line">        <span class="keyword">byte</span>[] decryptBytes = cipher.doFinal(base64Decode(content));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> String(decryptBytes,<span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * AES加密 aes-128/256-cbc</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> content 待解密的byte[]</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> encryptKey   加密密钥</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> iv 偏移</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 解密后的byte[]</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] aesEncryptToCBC(<span class="keyword">byte</span>[] content, String encryptKey,<span class="keyword">byte</span>[] iv) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">byte</span>[] key = org.apache.commons.codec.binary.Hex.decodeHex(encryptKey.toCharArray());</span><br><span class="line">        checkkey(key);</span><br><span class="line">        Cipher cipher = Cipher.getInstance(<span class="string">&quot;AES/CBC/PKCS5Padding&quot;</span>);</span><br><span class="line">        <span class="comment">//算法参数</span></span><br><span class="line">        AlgorithmParameterSpec paramSpec = <span class="keyword">new</span> IvParameterSpec(iv);</span><br><span class="line">        cipher.init(Cipher.ENCRYPT_MODE, <span class="keyword">new</span> SecretKeySpec(key, <span class="string">&quot;AES&quot;</span>),paramSpec);</span><br><span class="line">        <span class="keyword">return</span> cipher.doFinal(content);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * AES解密 aes-128/256-cbc</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> content 待解密的byte[]</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> decryptKey   解密密钥</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> iv 偏移</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 解密后的byte[]</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] aesDecryptToCBC(<span class="keyword">byte</span>[] content, String decryptKey,<span class="keyword">byte</span>[] iv) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">byte</span>[] key = org.apache.commons.codec.binary.Hex.decodeHex(decryptKey.toCharArray());</span><br><span class="line">        checkkey(key);</span><br><span class="line">        Cipher cipher = Cipher.getInstance(<span class="string">&quot;AES/CBC/PKCS5Padding&quot;</span>);</span><br><span class="line">        <span class="comment">//算法参数</span></span><br><span class="line">        AlgorithmParameterSpec paramSpec = <span class="keyword">new</span> IvParameterSpec(iv);</span><br><span class="line">        cipher.init(Cipher.DECRYPT_MODE, <span class="keyword">new</span> SecretKeySpec(key, <span class="string">&quot;AES&quot;</span>),paramSpec);</span><br><span class="line">        <span class="keyword">return</span> cipher.doFinal(content);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * AES加密 aes-128/256-cbc</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> content 待解密的byte[]</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> encryptKey   加密密钥</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> iv 偏移</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 解密后的byte[]</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">aesEncryptToCBC</span><span class="params">(String content, String encryptKey,<span class="keyword">byte</span>[] iv)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">byte</span>[] key = org.apache.commons.codec.binary.Hex.decodeHex(encryptKey.toCharArray());</span><br><span class="line">        checkkey(key);</span><br><span class="line">        Cipher cipher = Cipher.getInstance(<span class="string">&quot;AES/CBC/PKCS5Padding&quot;</span>);</span><br><span class="line">        <span class="comment">//算法参数</span></span><br><span class="line">        AlgorithmParameterSpec paramSpec = <span class="keyword">new</span> IvParameterSpec(iv);</span><br><span class="line">        cipher.init(Cipher.ENCRYPT_MODE, <span class="keyword">new</span> SecretKeySpec(key, <span class="string">&quot;AES&quot;</span>),paramSpec);</span><br><span class="line">        <span class="keyword">return</span> base64Encode(cipher.doFinal(content.getBytes(<span class="string">&quot;utf-8&quot;</span>)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * AES解密 aes-128/256-cbc</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> content 待解密的byte[]</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> decryptKey   解密密钥</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> iv 偏移</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 解密后的byte[]</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">aesDecryptToCBC</span><span class="params">(String content, String decryptKey,<span class="keyword">byte</span>[] iv)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">byte</span>[] key = org.apache.commons.codec.binary.Hex.decodeHex(decryptKey.toCharArray());</span><br><span class="line">        checkkey(key);</span><br><span class="line">        Cipher cipher = Cipher.getInstance(<span class="string">&quot;AES/CBC/PKCS5Padding&quot;</span>);</span><br><span class="line">        <span class="comment">//算法参数</span></span><br><span class="line">        AlgorithmParameterSpec paramSpec = <span class="keyword">new</span> IvParameterSpec(iv);</span><br><span class="line">        cipher.init(Cipher.DECRYPT_MODE, <span class="keyword">new</span> SecretKeySpec(key, <span class="string">&quot;AES&quot;</span>),paramSpec);</span><br><span class="line">        <span class="keyword">byte</span>[] decryptBytes = cipher.doFinal(base64Decode(content));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> String(decryptBytes,<span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="nodejs"><a href="#nodejs" class="headerlink" title="nodejs"></a>nodejs</h2><h3 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h3><p>以下nodejs代码来源于 <a href="https://github.com/keel/aes-cross">aes-cross</a>项目</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &quot;AES/cbc/pkcs5Padding&quot; encription and decription.</span></span><br><span class="line"><span class="comment"> * setAutoPadding(true) is actually pkcs5Padding,.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> crypto = <span class="built_in">require</span>(<span class="string">&#x27;crypto&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> CBC = <span class="string">&#x27;cbc&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> ECB = <span class="string">&#x27;ecb&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> NULL_IV = <span class="keyword">new</span> Buffer([]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> IV = <span class="keyword">new</span> Buffer([<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]);</span><br><span class="line"><span class="keyword">var</span> cipherMode = ECB;</span><br><span class="line"><span class="keyword">var</span> keySize = <span class="number">128</span>;</span><br><span class="line"><span class="keyword">var</span> algorithm;</span><br><span class="line">setAlgorithm();</span><br><span class="line"><span class="keyword">var</span> outputEncoding = <span class="string">&#x27;base64&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> inputEncoding = <span class="string">&#x27;utf8&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setAlgorithm</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    algorithm = <span class="string">&#x27;aes-&#x27;</span> + keySize + <span class="string">&#x27;-&#x27;</span> + cipherMode;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setCipherMode</span>(<span class="params">mode</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mode !== CBC &amp;&amp; mode !== ECB) &#123;</span><br><span class="line">        <span class="keyword">throw</span> (<span class="string">&#x27;AES.setCipherMode error: &#x27;</span> + mode);</span><br><span class="line">    &#125;</span><br><span class="line">    cipherMode = mode;</span><br><span class="line">    setAlgorithm();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setKeySize</span>(<span class="params">size</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (size !== <span class="number">128</span> &amp;&amp; size !== <span class="number">256</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> (<span class="string">&#x27;AES.setKeySize error: &#x27;</span> + size);</span><br><span class="line">    &#125;</span><br><span class="line">    keySize = size;</span><br><span class="line">    setAlgorithm();</span><br><span class="line">    <span class="comment">// console.log(&#x27;setKeySize:%j&#x27;,keySize);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * the key must match the keySize/8 , like:16 ,32</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;Buffer&#125;</span> <span class="variable">key</span></span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return <span class="type">&#123;&#125;</span></span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkKey</span>(<span class="params">key</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!key) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="string">&#x27;AES.checkKey error: key is null &#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (key.length !== (keySize / <span class="number">8</span>)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="string">&#x27;AES.checkKey error: key length is not &#x27;</span> + (keySize / <span class="number">8</span>) + <span class="string">&#x27;: &#x27;</span> + key.length;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * buffer/bytes encription</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;Buffer&#125;</span> <span class="variable">buff</span></span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;Buffer&#125;</span> </span>key  the length must be 16 or 32</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;Buffer&#125;</span> </span>[newIv]   default is [0,0...0]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return <span class="type">&#123;encripted Buffer&#125;</span></span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">encBytes</span>(<span class="params">buff, key, newIv</span>) </span>&#123;</span><br><span class="line">    checkKey(key);</span><br><span class="line">    <span class="keyword">var</span> iv = newIv || IV;</span><br><span class="line">    <span class="keyword">if</span> (cipherMode === ECB) iv = NULL_IV;</span><br><span class="line">    <span class="keyword">var</span> cipher = crypto.createCipheriv(algorithm, key, iv);</span><br><span class="line">    cipher.setAutoPadding(<span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">var</span> re = Buffer.concat([cipher.update(buff), cipher.final()]);</span><br><span class="line">    <span class="comment">// console.log(&#x27;enc re:%s,len:%d&#x27;, printBuf(re), re.length);</span></span><br><span class="line">    <span class="keyword">return</span> re;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * text encription</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;string&#125;</span> <span class="variable">text</span></span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;Buffer&#125;</span> </span>key         the length must be 16 or 32</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;Buffer&#125;</span> </span>[newIv]       default is [0,0...0]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;string&#125;</span> </span>[input_encoding]  [&quot;utf8&quot; -default,&quot;ascii&quot;,&quot;base64&quot;,&quot;binary&quot;...](https://nodejs.org/api/buffer.html#buffer_buffer)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;string&#125;</span> </span>[output_encoding] [&quot;base64&quot; -default,&quot;hex&quot;]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return <span class="type">&#123;string&#125;</span>                 </span>encription result</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">encText</span>(<span class="params">text, key, newIv, input_encoding, output_encoding</span>) </span>&#123;</span><br><span class="line">    checkKey(key);</span><br><span class="line">    <span class="keyword">var</span> iv = newIv || IV;</span><br><span class="line">    <span class="keyword">if</span> (cipherMode === ECB) iv = NULL_IV;</span><br><span class="line">    <span class="keyword">var</span> inEncoding = input_encoding || inputEncoding;</span><br><span class="line">    <span class="keyword">var</span> outEncoding = output_encoding || outputEncoding;</span><br><span class="line">    <span class="keyword">var</span> buff = <span class="keyword">new</span> Buffer(text, inEncoding);</span><br><span class="line">    <span class="keyword">var</span> out = encBytes(buff, key, iv);</span><br><span class="line">    <span class="keyword">var</span> re = <span class="keyword">new</span> Buffer(out).toString(outEncoding);</span><br><span class="line">    <span class="keyword">return</span> re;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * buffer/bytes decription</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;Buffer&#125;</span> <span class="variable">buff</span></span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;Buffer&#125;</span> </span>key  the length must be 16 or 32</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;Buffer&#125;</span> </span>[newIv] default is [0,0...0]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return <span class="type">&#123;encripted Buffer&#125;</span></span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">decBytes</span>(<span class="params">buff, key, newIv</span>) </span>&#123;</span><br><span class="line">    checkKey(key);</span><br><span class="line">    <span class="keyword">var</span> iv = newIv || IV;</span><br><span class="line">    <span class="keyword">if</span> (cipherMode === ECB) iv = NULL_IV;</span><br><span class="line">    <span class="keyword">var</span> decipher = crypto.createDecipheriv(algorithm, key, iv);</span><br><span class="line">    decipher.setAutoPadding(<span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">var</span> out = Buffer.concat([decipher.update(buff), decipher.final()]);</span><br><span class="line">    <span class="keyword">return</span> out;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * text decription</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;string&#125;</span> <span class="variable">text</span></span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;Buffer&#125;</span> </span>key         the length must be 16 or 32</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;Buffer&#125;</span> </span>[newIv]       default is [0,0...0]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;string&#125;</span> </span>[input_encoding]  [&quot;utf8&quot; - default,&quot;ascii&quot;,&quot;base64&quot;,&quot;binary&quot;...](https://nodejs.org/api/buffer.html#buffer_buffer)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;string&#125;</span> </span>[output_encoding] [&quot;base64&quot;- default ,&quot;hex&quot;]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return <span class="type">&#123;string&#125;</span>                 </span>decription result</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">decText</span>(<span class="params">text, key, newIv, input_encoding, output_encoding</span>) </span>&#123;</span><br><span class="line">    checkKey(key);</span><br><span class="line">    <span class="keyword">var</span> iv = newIv || IV;</span><br><span class="line">    <span class="keyword">if</span> (cipherMode === ECB) iv = NULL_IV;</span><br><span class="line">    <span class="keyword">var</span> inEncoding = input_encoding || inputEncoding;</span><br><span class="line">    <span class="keyword">var</span> outEncoding = output_encoding || outputEncoding;</span><br><span class="line">    <span class="keyword">var</span> buff = <span class="keyword">new</span> Buffer(text, outEncoding);</span><br><span class="line">    <span class="keyword">var</span> re = <span class="keyword">new</span> Buffer(decBytes(buff, key, iv)).toString(inEncoding);</span><br><span class="line">    <span class="keyword">return</span> re;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">exports</span>.setCipherMode = setCipherMode;</span><br><span class="line"><span class="built_in">exports</span>.setKeySize = setKeySize;</span><br><span class="line"><span class="built_in">exports</span>.encText = encText;</span><br><span class="line"><span class="built_in">exports</span>.encBytes = encBytes;</span><br><span class="line"><span class="built_in">exports</span>.decText = decText;</span><br><span class="line"><span class="built_in">exports</span>.decBytes = decBytes;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 以下为测试部分</span></span><br><span class="line"><span class="comment">// //key是16进制，需要转换为buffer，转换后buffer长度为16，即aes128，如果buffer长度是32则是aes256</span></span><br><span class="line"><span class="comment">// var key = new Buffer(&quot;c4b84456c1379bec99c4d1b7e9f13173&quot;, &#x27;hex&#x27;);</span></span><br><span class="line"><span class="comment">// var key256 = new Buffer(&quot;c4b84456c1379bec99c4d1b7e9f13173c4b84456c1379bec99c4d1b7e9f13173&quot;, &#x27;hex&#x27;);</span></span><br><span class="line"><span class="comment">// var str = &quot;helloworld 你好&quot;;</span></span><br><span class="line"><span class="comment">// var buffer = new Buffer(str,&quot;utf8&quot;);</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// //aes-ecb-128 buffer</span></span><br><span class="line"><span class="comment">// var buffer_encrypt = encBytes(buffer,key);</span></span><br><span class="line"><span class="comment">// var crypto_buffer =decBytes(buffer_encrypt,key);</span></span><br><span class="line"><span class="comment">// var str = crypto_buffer.toString();</span></span><br><span class="line"><span class="comment">// console.log(str);</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// //aes-ecb-128 string</span></span><br><span class="line"><span class="comment">// var text_encrypt = encText(str,key);</span></span><br><span class="line"><span class="comment">// var text_decrypt =decText(text_encrypt,key);</span></span><br><span class="line"><span class="comment">// console.log(text_decrypt);</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// text_encrypt = encText(str,key,null,&#x27;utf8&#x27;,&#x27;base64&#x27;);</span></span><br><span class="line"><span class="comment">// text_decrypt =decText(text_encrypt,key,null,&#x27;utf8&#x27;,&#x27;base64&#x27;);</span></span><br><span class="line"><span class="comment">// console.log(text_decrypt);</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// //aes-cbc-128 buffer</span></span><br><span class="line"><span class="comment">// setCipherMode(CBC);</span></span><br><span class="line"><span class="comment">// var iv = new Buffer(&quot;abcdefgh12345678&quot;,&quot;utf8&quot;);//字符串一定是16位</span></span><br><span class="line"><span class="comment">// buffer_encrypt = encBytes(buffer,key,iv);</span></span><br><span class="line"><span class="comment">// crypto_buffer =decBytes(buffer_encrypt,key,iv);</span></span><br><span class="line"><span class="comment">// str = crypto_buffer.toString();</span></span><br><span class="line"><span class="comment">// console.log(str);</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// //aes-cbc-128 string</span></span><br><span class="line"><span class="comment">// text_encrypt = encText(str,key,iv);</span></span><br><span class="line"><span class="comment">// text_decrypt =decText(text_encrypt,key,iv);</span></span><br><span class="line"><span class="comment">// console.log(text_decrypt);</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// text_encrypt = encText(str,key,iv,&#x27;utf8&#x27;,&#x27;base64&#x27;);</span></span><br><span class="line"><span class="comment">// text_decrypt =decText(text_encrypt,key,iv,&#x27;utf8&#x27;,&#x27;base64&#x27;);</span></span><br><span class="line"><span class="comment">// console.log(text_decrypt);</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// //aes-ecb-256 buffer</span></span><br><span class="line"><span class="comment">// setKeySize(256);</span></span><br><span class="line"><span class="comment">// setCipherMode(ECB);</span></span><br><span class="line"><span class="comment">// buffer_encrypt = encBytes(buffer,key256);</span></span><br><span class="line"><span class="comment">// crypto_buffer =decBytes(buffer_encrypt,key256);</span></span><br><span class="line"><span class="comment">// str = crypto_buffer.toString();</span></span><br><span class="line"><span class="comment">// console.log(&quot;256==&quot;+str);</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li> <a href="http://blog.csdn.net/u011363981/article/details/51149360">用Java进行AES256-ECB-PKCS7Padding加密</a></li>
<li><a href="https://github.com/keel/aes-cross">aes-cross</a></li>
</ul>
]]></content>
      <categories>
        <category>技术</category>
      </categories>
      <tags>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>Protocol Buffer学习笔记(Java&amp;NodeJS)</title>
    <url>/2018/02/26/protocol-buffer-study/</url>
    <content><![CDATA[<h2 id="什么是Protocol-Buffer"><a href="#什么是Protocol-Buffer" class="headerlink" title="什么是Protocol Buffer"></a>什么是Protocol Buffer</h2><p>Protocol Buffers(也称protobuf)是Google公司出品的一种独立于开发语言，独立于平台的可扩展的结构化数据序列机制。通俗点来讲它跟xml和json是一类。是一种数据交互格式协议。<br>主要优点是它是基于二进制的，所以比起结构化的xml协议来说，它的体积很少，数据在传输过程中会更快。另外它也支持c++、java、python、php、javascript等主流开发语言。</p>
<p><a href="https://developers.google.com/protocol-buffers/">官网地址：https://developers.google.com/protocol-buffers/</a></p>
<span id="more"></span>

<h2 id="Proto3安装"><a href="#Proto3安装" class="headerlink" title="Proto3安装"></a>Proto3安装</h2><p><a href="https://github.com/google/protobuf/releases">下载地址</a>：3.x.x的版本基本都按照操作系统和语言进行了区分，系统包里只包含了protoc命令，语言包则是用于编译后使用，比如java需要生成对应的jar包。这里可以根据需要下载对应的操作系统和语言包，比如这里我下载的是protoc-3.5.1-osx-x86_64.zip（苹果系统）和protobuf-java-3.5.1.tar.gz（java语言）。</p>
<ul>
<li><code>unzip protoc-3.5.1-osx-x86_64.zip</code></li>
<li>在/etc/profile中添加环境变量PROTOCTL_BUFFER_HOME（protoc-3.5.1-osx-x86_64.zip解压后目录），并在PATH中添加$PROTOCTL_BUFFER_HOME/bin</li>
<li>查看版本：<code>protoc --version</code> ：输出 libprotoc 3.5.1</li>
</ul>
<p><code>以下部分只为自行编译生成对应的jar包，实际上maven中央仓库中已经存在了</code></p>
<ul>
<li><code>tar -zxcf protobuf-java-3.5.1.tar.gz</code>，解压后目录名称为protobuf-3.5.1</li>
<li><code>cd protobuf-3.5.1/src</code>，创建软连接 <code>ln -s $PROTOCTL_BUFFER_HOME/bin/protoc protoc</code></li>
<li><code>cd protobuf-3.5.1/java</code>，<code>mvn package</code>（maven请自行安装），成功后会在protobuf-3.5.1/java/code/target下生成protobuf-java-3.5.1.jar</li>
<li>然后将protobuf-java-3.5.1.jar上传到maven私服或者安装到本地仓库就可以使用了<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mvn install:install-file -Dfile=protobuf-java-3.5.1.jar -DgroupId=com.google.protobuf -DartifactId=protobuf-java -Dversion=3.5.1 -Dpackaging=jar</span><br></pre></td></tr></table></figure></li>
<li>pom中添加依赖<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- protocol buffer --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.protobuf<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>protobuf-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.5.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="Proto2安装"><a href="#Proto2安装" class="headerlink" title="Proto2安装"></a>Proto2安装</h2><p><a href="http://repo1.maven.org/maven2/com/google/protobuf/protoc/">下载地址</a>：这里只是操作系统包，比如这里我下载的是protoc-2.6.1-osx-x86_64.exe，<a href="https://github.com/google/protobuf/releases/tag/v2.6.1">语言包protobuf-2.6.1.tar.gz</a>。</p>
<ul>
<li>mv protoc-2.6.1-osx-x86_64.exe protoc</li>
<li>将上面重命名后的protoc文件所在目录加到系统环境变量PATH中</li>
<li>查看版本：<code>protoc --version</code> ：输出 libprotoc 2.6.1</li>
</ul>
<p><code>以下部分只为自行编译生成对应的jar包，实际上maven中央仓库中已经存在了</code></p>
<ul>
<li><code>tar -zxcf protobuf-2.6.1.tar.gz</code>，解压后目录名称为protobuf-2.6.1</li>
<li><code>cd protobuf-2.6.1/src</code>，创建软连接 <code>ln -s $PROTOCTL_BUFFER_HOME/bin/protoc protoc</code></li>
<li><code>cd protobuf-2.6.1/java</code>，<code>mvn package</code>（maven请自行安装），成功后会在protobuf-2.6.1/java/target下生成protobuf-java-2.6.1.jar</li>
<li>然后将protobuf-java-2.6.1.jar上传到maven私服或者安装到本地仓库就可以使用了<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mvn install:install-file -Dfile=protobuf-java-2.6.1.jar -DgroupId=com.google.protobuf -DartifactId=protobuf-java -Dversion=2.6.1 -Dpackaging=jar</span><br></pre></td></tr></table></figure></li>
<li>pom中添加依赖<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- protocol buffer --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.protobuf<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>protobuf-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="Proto使用"><a href="#Proto使用" class="headerlink" title="Proto使用"></a>Proto使用</h2><ul>
<li>先编写proto文件，具体语法请参考<a href="http://blog.csdn.net/briblue/article/details/53187780">通信协议之Protocol buffer(Java篇)</a></li>
<li>生成java文件：<code>protoc --java_out=.  XXXX.proto</code></li>
<li>生成js文件：<code>protoc --js_out=import_style=commonjs,binary:. XXXX.proto</code> 『只有proto3支持该命令』</li>
<li>proto2与proto3语法上有一些不同，但是在使用时却没有特别的不同之处，此外proto3向下兼容proto2，所以可以只安装proto3，然后通过在proto文件中声明『syntax = “proto2”;或者syntax = “proto3”;』来指定类型</li>
</ul>
<h3 id="proto例子"><a href="#proto例子" class="headerlink" title="proto例子"></a>proto例子</h3><figure class="highlight protobuf"><table><tr><td class="code"><pre><span class="line"><span class="comment">//syntax = &quot;proto2&quot;;</span></span><br><span class="line"><span class="keyword">package</span> com.data.upload.proto;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4.1 网约车平台公司基本信息接口</span></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">BaseInfoCompany</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">	<span class="comment">// 公司标识</span></span><br><span class="line">	<span class="keyword">required</span> <span class="built_in">string</span> CompanyId       = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 公司名称</span></span><br><span class="line">	<span class="keyword">required</span> <span class="built_in">string</span> CompanyName     = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 统一社会信用代码</span></span><br><span class="line">	<span class="keyword">required</span> <span class="built_in">string</span> Identifier      = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 注册地行政区划代码</span></span><br><span class="line">	<span class="keyword">required</span> <span class="built_in">uint32</span> Address         = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 经营范围</span></span><br><span class="line">	<span class="keyword">required</span> <span class="built_in">string</span> BusinessScope   = <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 通讯地址</span></span><br><span class="line">	<span class="keyword">required</span> <span class="built_in">string</span> ContactAddress  = <span class="number">6</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 经营业户经济类型</span></span><br><span class="line">	<span class="keyword">required</span> <span class="built_in">string</span> EconomicType    = <span class="number">7</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 注册资本</span></span><br><span class="line">	<span class="keyword">required</span> <span class="built_in">string</span> RegCapital      = <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 法人代表姓名</span></span><br><span class="line">	<span class="keyword">required</span> <span class="built_in">string</span> LegalName       = <span class="number">9</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 法人代表身份证号</span></span><br><span class="line">	<span class="keyword">required</span> <span class="built_in">string</span> LegalID         = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 法人代表电话</span></span><br><span class="line">	<span class="keyword">required</span> <span class="built_in">string</span> LegalPhone      = <span class="number">11</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 法人代表身份证扫描件文件编号</span></span><br><span class="line">	<span class="keyword">optional</span> <span class="built_in">string</span> LegalPhoto      = <span class="number">12</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 状态</span></span><br><span class="line">	<span class="keyword">required</span> <span class="built_in">uint32</span> State           = <span class="number">13</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 操作标识</span></span><br><span class="line">	<span class="keyword">required</span> <span class="built_in">uint32</span> Flag            = <span class="number">14</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 更新时间</span></span><br><span class="line">	<span class="keyword">required</span> <span class="built_in">uint64</span> UpdateTime      = <span class="number">15</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 保留字段</span></span><br><span class="line">	<span class="keyword">optional</span> <span class="built_in">string</span> Reserved        = <span class="number">16</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4.2 网约车平台公司营运规模信息信息接口</span></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">BaseInfoCompanyStat</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">	<span class="comment">// 公司标识</span></span><br><span class="line">	<span class="keyword">required</span> <span class="built_in">string</span> CompanyId       = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 平台注册网约车辆数</span></span><br><span class="line">	<span class="keyword">required</span> <span class="built_in">uint32</span> VehicleNum      = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 平台注册驾驶员数</span></span><br><span class="line">	<span class="keyword">required</span> <span class="built_in">uint32</span> DriverNum       = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 操作标识</span></span><br><span class="line">	<span class="keyword">required</span> <span class="built_in">uint32</span> Flag            = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 更新时间</span></span><br><span class="line">	<span class="keyword">required</span> <span class="built_in">uint64</span> UpdateTime      = <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 保留字段</span></span><br><span class="line">	<span class="keyword">optional</span> <span class="built_in">string</span> Reserved        = <span class="number">6</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">IpcType</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">	<span class="comment">// 4.1 网约车平台公司基本信息接口</span></span><br><span class="line">	baseInfoCompany 							= <span class="number">0</span>x1001;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 4.2 网约车平台公司营运规模信息信息接口</span></span><br><span class="line">	baseInfoCompanyStat 						= <span class="number">0</span>x1002;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">OTIpc</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">	 <span class="comment">// 公司标识</span></span><br><span class="line">	 <span class="keyword">required</span> <span class="built_in">string</span> CompanyId                       			= <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	 <span class="comment">// 消息来源标识</span></span><br><span class="line">	 <span class="keyword">required</span> <span class="built_in">string</span> Source	                        			= <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">	 <span class="comment">// 业务接口代码</span></span><br><span class="line">     <span class="keyword">required</span> IpcType IPCType                           		= <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 4.1 网约车平台公司基本信息接口</span></span><br><span class="line">	<span class="keyword">repeated</span> BaseInfoCompany baseInfoCompany 					= <span class="number">0</span>x1001;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 4.2 网约车平台公司营运规模信息信息接口</span></span><br><span class="line">	<span class="keyword">repeated</span> BaseInfoCompanyStat baseInfoCompanyStat 			= <span class="number">0</span>x1002;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">OTIpcList</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">     <span class="keyword">repeated</span> OTIpc otpic                     = <span class="number">1</span>;</span><br><span class="line">&#125;  </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="java中使用Protocol-Buffer"><a href="#java中使用Protocol-Buffer" class="headerlink" title="java中使用Protocol Buffer"></a>java中使用Protocol Buffer</h3><ul>
<li>添加依赖<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- protocol buffer --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.protobuf<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>protobuf-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>Client端<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//创建对象</span></span><br><span class="line">OTIpcDef.BaseInfoCompany.Builder baseInfoCompanyBuilder = OTIpcDef.BaseInfoCompany.newBuilder();</span><br><span class="line">baseInfoCompanyBuilder.setAddress(<span class="number">110011</span>);</span><br><span class="line">baseInfoCompanyBuilder.setCompanyId(<span class="string">&quot;companyId&quot;</span>);</span><br><span class="line">baseInfoCompanyBuilder.setCompanyName(<span class="string">&quot;companyName&quot;</span>);</span><br><span class="line">baseInfoCompanyBuilder.setIdentifier(<span class="string">&quot;identifier&quot;</span>);</span><br><span class="line">baseInfoCompanyBuilder.setBusinessScope(<span class="string">&quot;BusinessScope&quot;</span>);</span><br><span class="line">baseInfoCompanyBuilder.setContactAddress(<span class="string">&quot;ContactAddress&quot;</span>);</span><br><span class="line">baseInfoCompanyBuilder.setEconomicType(<span class="string">&quot;EconomicType&quot;</span>);</span><br><span class="line">baseInfoCompanyBuilder.setRegCapital(<span class="string">&quot;RegCapital&quot;</span>);</span><br><span class="line">baseInfoCompanyBuilder.setLegalName(<span class="string">&quot;LegalName&quot;</span>);</span><br><span class="line">baseInfoCompanyBuilder.setLegalID(<span class="string">&quot;LegalID&quot;</span>);</span><br><span class="line">baseInfoCompanyBuilder.setLegalPhone(<span class="string">&quot;LegalPhone&quot;</span>);</span><br><span class="line">baseInfoCompanyBuilder.setState(<span class="number">0</span>);</span><br><span class="line">baseInfoCompanyBuilder.setFlag(<span class="number">1</span>);</span><br><span class="line">baseInfoCompanyBuilder.setUpdateTime(<span class="number">20180226121212l</span>);</span><br><span class="line"></span><br><span class="line">OTIpcDef.BaseInfoCompany baseInfoCompany = baseInfoCompanyBuilder.build();</span><br><span class="line"></span><br><span class="line">OTIpcDef.OTIpc.Builder otIpcBuilder = OTIpcDef.OTIpc.newBuilder();</span><br><span class="line">otIpcBuilder.setCompanyId(<span class="string">&quot;companyId&quot;</span>);</span><br><span class="line">otIpcBuilder.setSource(<span class="string">&quot;Source&quot;</span>);</span><br><span class="line">otIpcBuilder.setIPCType(OTIpcDef.IpcType.baseInfoCompany);</span><br><span class="line"></span><br><span class="line"><span class="comment">//如果一次传递多条记录可以使用list</span></span><br><span class="line"><span class="comment">//List&lt;OTIpcDef.BaseInfoCompany&gt; list  = new ArrayList&lt;OTIpcDef.BaseInfoCompany&gt;();</span></span><br><span class="line"><span class="comment">//list.add(baseInfoCompany);</span></span><br><span class="line"><span class="comment">//otIpcBuilder.addAllBaseInfoCompany(list);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//也可以用add方法一个一个的添加</span></span><br><span class="line">otIpcBuilder.addBaseInfoCompany(baseInfoCompany);</span><br><span class="line">otIpcBuilder.addBaseInfoCompany(baseInfoCompany);</span><br><span class="line"></span><br><span class="line">OTIpcDef.OTIpc otIpc = otIpcBuilder.build();</span><br><span class="line"></span><br><span class="line">OTIpcDef.BaseInfoCompanyStat.Builder baseInfoCompanyStatBuilder = OTIpcDef.BaseInfoCompanyStat.newBuilder();</span><br><span class="line">baseInfoCompanyStatBuilder.setCompanyId(<span class="string">&quot;companyId&quot;</span>);</span><br><span class="line">baseInfoCompanyStatBuilder.setDriverNum(<span class="number">10</span>);</span><br><span class="line">baseInfoCompanyStatBuilder.setFlag(<span class="number">0</span>);</span><br><span class="line">baseInfoCompanyStatBuilder.setUpdateTime(<span class="number">20180226121212l</span>);</span><br><span class="line">baseInfoCompanyStatBuilder.setVehicleNum(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">OTIpcDef.BaseInfoCompanyStat baseInfoCompanyStat = baseInfoCompanyStatBuilder.build();</span><br><span class="line"></span><br><span class="line">OTIpcDef.OTIpc.Builder otIpcBuilder2 = OTIpcDef.OTIpc.newBuilder();</span><br><span class="line">otIpcBuilder2.setCompanyId(<span class="string">&quot;companyId&quot;</span>);</span><br><span class="line">otIpcBuilder2.setSource(<span class="string">&quot;Source&quot;</span>);</span><br><span class="line">otIpcBuilder2.setIPCType(OTIpcDef.IpcType.baseInfoCompanyStat);</span><br><span class="line"></span><br><span class="line">otIpcBuilder2.addBaseInfoCompanyStat(baseInfoCompanyStat);</span><br><span class="line"></span><br><span class="line">OTIpcDef.OTIpc otIpc2 = otIpcBuilder2.build();</span><br><span class="line"></span><br><span class="line">OTIpcDef.OTIpcList.Builder oTIpcListBuilder = OTIpcDef.OTIpcList.newBuilder();</span><br><span class="line">oTIpcListBuilder.addOtpic(otIpc);</span><br><span class="line">oTIpcListBuilder.addOtpic(otIpc2);</span><br><span class="line"></span><br><span class="line">OTIpcDef.OTIpcList otIpcList = oTIpcListBuilder.build();</span><br><span class="line"><span class="comment">//序列话数据</span></span><br><span class="line"><span class="keyword">byte</span>[] array = otIpcList.toByteArray();</span><br><span class="line"></span><br><span class="line">HttpClientUtils httpClientUtils = <span class="keyword">new</span> HttpClientUtils();</span><br><span class="line">httpClientUtils.doPost4ProtocleBuffer(<span class="string">&quot;http://localhost:3000/demo/protoc&quot;</span>,array);</span><br></pre></td></tr></table></figure></li>
</ul>
<p>HttpClientUtils.java</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.yipin.entity.HttpResult;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.client.config.RequestConfig;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.client.methods.CloseableHttpResponse;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.client.methods.HttpPost;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.entity.ByteArrayEntity;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.impl.client.CloseableHttpClient;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.impl.client.HttpClients;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.impl.client.LaxRedirectStrategy;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.impl.conn.PoolingHttpClientConnectionManager;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.util.EntityUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpClientUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> CloseableHttpClient httpClient;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RequestConfig requestConfig;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HttpClientUtils</span><span class="params">()</span></span>&#123;</span><br><span class="line">        init();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        PoolingHttpClientConnectionManager httpClientConnectionManager = <span class="keyword">new</span> PoolingHttpClientConnectionManager();</span><br><span class="line">        <span class="comment">// 创建全局的requestConfig</span></span><br><span class="line">        <span class="keyword">this</span>.requestConfig = RequestConfig.custom().build();</span><br><span class="line">        <span class="comment">// 声明重定向策略对象</span></span><br><span class="line">        LaxRedirectStrategy redirectStrategy = <span class="keyword">new</span> LaxRedirectStrategy();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.httpClient = HttpClients.custom().setConnectionManager(httpClientConnectionManager)</span><br><span class="line">                .setDefaultRequestConfig(requestConfig)</span><br><span class="line">                .setRedirectStrategy(redirectStrategy)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> HttpResult <span class="title">doPost4ProtocleBuffer</span><span class="params">(String url, <span class="keyword">byte</span>[] bytes)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建http POST请求</span></span><br><span class="line">        HttpPost httpPost = <span class="keyword">new</span> HttpPost(url);</span><br><span class="line">        httpPost.setConfig(<span class="keyword">this</span>.requestConfig);</span><br><span class="line">        httpPost.setHeader(<span class="string">&quot;Connection&quot;</span>, <span class="string">&quot;keep-alive&quot;</span>);</span><br><span class="line">        httpPost.setHeader(<span class="string">&quot;Content-type&quot;</span>, <span class="string">&quot;application/x-protobuf&quot;</span>);</span><br><span class="line">        httpPost.setHeader(<span class="string">&quot;Accept-Encoding&quot;</span>, <span class="string">&quot;gzip&quot;</span>);</span><br><span class="line">        httpPost.setHeader(<span class="string">&quot;Accept-Charset&quot;</span>, <span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (bytes != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 构造一个请求实体</span></span><br><span class="line">            ByteArrayEntity byteArrayEntity = <span class="keyword">new</span> ByteArrayEntity(bytes);</span><br><span class="line">            byteArrayEntity.setContentType(<span class="string">&quot;application/x-protobuf&quot;</span>);</span><br><span class="line">            <span class="comment">// 将请求实体设置到httpPost对象中</span></span><br><span class="line">            httpPost.setEntity(byteArrayEntity);</span><br><span class="line">        &#125;</span><br><span class="line">        CloseableHttpResponse response = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 执行请求</span></span><br><span class="line">            response = <span class="keyword">this</span>.httpClient.execute(httpPost);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> HttpResult(response.getStatusLine().getStatusCode(),</span><br><span class="line">                    EntityUtils.toString(response.getEntity(), <span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (response != <span class="keyword">null</span>) &#123;</span><br><span class="line">                response.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>server端<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">InputStream in = request.getInputStream();</span><br><span class="line">OTIpcDef.OTIpcList otIpcList = OTIpcDef.OTIpcList.parseFrom(in);</span><br><span class="line">List&lt;OTIpcDef.OTIpc&gt; list= otIpcList.getOtpicList();</span><br><span class="line"><span class="keyword">for</span>(OTIpcDef.OTIpc otIpc : list)&#123;</span><br><span class="line">    String companyid = otIpc.getCompanyId();</span><br><span class="line">    String source = otIpc.getSource();</span><br><span class="line">    OTIpcDef.IpcType ipcType = otIpc.getIPCType();</span><br><span class="line">    <span class="keyword">if</span>(ipcType == OTIpcDef.IpcType.baseInfoCompany)&#123;</span><br><span class="line">        List&lt;OTIpcDef.BaseInfoCompany&gt; baseInfoCompanyList = otIpc.getBaseInfoCompanyList();</span><br><span class="line">        <span class="keyword">for</span>(OTIpcDef.BaseInfoCompany baseInfoCompany : baseInfoCompanyList)&#123;</span><br><span class="line">            String companyName = baseInfoCompany.getCompanyName();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(ipcType == OTIpcDef.IpcType.baseInfoCompanyStat)&#123;</span><br><span class="line">        List&lt;OTIpcDef.BaseInfoCompanyStat&gt; baseInfoCompanyStatList = otIpc.getBaseInfoCompanyStatList();</span><br><span class="line">        <span class="keyword">for</span>(OTIpcDef.BaseInfoCompanyStat baseInfoCompanyStat : baseInfoCompanyStatList)&#123;</span><br><span class="line">            <span class="keyword">int</span> driverNum = baseInfoCompanyStat.getDriverNum();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="nodejs中使用Protocol-Buffer"><a href="#nodejs中使用Protocol-Buffer" class="headerlink" title="nodejs中使用Protocol Buffer"></a>nodejs中使用Protocol Buffer</h3><ul>
<li><p>安装依赖<br><code>npm install google-protobuf --save</code><br><code>npm install bufferhelper --save</code></p>
</li>
<li><p>Client端</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> OTIpcDefProto = <span class="built_in">require</span>(<span class="string">&#x27;../protocbuf/OTIpcDef_pb&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//业务对象封装</span></span><br><span class="line"><span class="keyword">var</span> baseInfoCompany = <span class="keyword">new</span> OTIpcDefProto.BaseInfoCompany();</span><br><span class="line">baseInfoCompany.setAddress(<span class="number">110011</span>);</span><br><span class="line">baseInfoCompany.setCompanyid(<span class="string">&quot;companyId&quot;</span>);</span><br><span class="line">baseInfoCompany.setIdentifier(<span class="string">&quot;identifier&quot;</span>);</span><br><span class="line">baseInfoCompany.setCompanyname(<span class="string">&quot;companyName公司名称&quot;</span>);</span><br><span class="line">baseInfoCompany.setBusinessscope(<span class="string">&quot;BusinessScope&quot;</span>);</span><br><span class="line">baseInfoCompany.setContactaddress(<span class="string">&quot;ContactAddress&quot;</span>);</span><br><span class="line">baseInfoCompany.setEconomictype(<span class="string">&quot;EconomicType&quot;</span>);</span><br><span class="line">baseInfoCompany.setRegcapital(<span class="string">&quot;RegCapital&quot;</span>);</span><br><span class="line">baseInfoCompany.setLegalname(<span class="string">&quot;LegalName&quot;</span>);</span><br><span class="line">baseInfoCompany.setLegalid(<span class="string">&quot;LegalID&quot;</span>);</span><br><span class="line">baseInfoCompany.setLegalphone(<span class="string">&quot;LegalPhone&quot;</span>);</span><br><span class="line">baseInfoCompany.setState(<span class="number">0</span>);</span><br><span class="line">baseInfoCompany.setFlag(<span class="number">1</span>);</span><br><span class="line">baseInfoCompany.setUpdatetime(<span class="number">20180226121212</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//业务类型封装</span></span><br><span class="line"><span class="keyword">var</span> otIpc = <span class="keyword">new</span> OTIpcDefProto.OTIpc();</span><br><span class="line">otIpc.setCompanyid(<span class="string">&quot;companyId&quot;</span>);</span><br><span class="line">otIpc.setSource(<span class="string">&quot;Source&quot;</span>);</span><br><span class="line">otIpc.setIpctype(OTIpcDefProto.IpcType.BASEINFOCOMPANY);</span><br><span class="line"><span class="comment">//可以多次调用add方法添加多条业务对象数据</span></span><br><span class="line">otIpc.addBaseinfocompany(baseInfoCompany);</span><br><span class="line"></span><br><span class="line"><span class="comment">//统一封装为list传输</span></span><br><span class="line"><span class="keyword">var</span> otIpcList = <span class="keyword">new</span> OTIpcDefProto.OTIpcList();</span><br><span class="line"><span class="comment">//可以通过add方法条件多条业务类型数据</span></span><br><span class="line">otIpcList.addOtpic(otIpc);</span><br><span class="line"></span><br><span class="line"><span class="comment">//序列化对象</span></span><br><span class="line"><span class="keyword">var</span> contents = otIpcList.serializeBinary();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> options = &#123;</span><br><span class="line">    <span class="attr">host</span>: <span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">    <span class="attr">port</span>: <span class="number">3000</span>,</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/demo2/protoc&#x27;</span>,</span><br><span class="line">    <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">    <span class="attr">headers</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/x-protobuf&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//发送请求</span></span><br><span class="line"><span class="keyword">var</span> req = http.request(options, <span class="function"><span class="keyword">function</span>(<span class="params">res</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// res.setEncoding(&#x27;uft8&#x27;);</span></span><br><span class="line">    res.on(<span class="string">&#x27;data&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(data);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//转成buffer</span></span><br><span class="line"><span class="keyword">var</span> buffer = <span class="keyword">new</span> Buffer(contents);</span><br><span class="line"><span class="comment">//只支持string和buffer类型</span></span><br><span class="line">req.write(buffer);</span><br><span class="line">req.end();</span><br></pre></td></tr></table></figure></li>
<li><p>Server端（express）</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> router = express.Router();</span><br><span class="line"><span class="keyword">var</span> OTIpcDefProto = <span class="built_in">require</span>(<span class="string">&#x27;../protocbuf/OTIpcDef_pb&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> BufferHelper = <span class="built_in">require</span>(<span class="string">&#x27;bufferhelper&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// http://localhost:3000/demo/</span></span><br><span class="line">router.post(<span class="string">&#x27;/protoc&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//数据接收，可以使用bufferHelper接收protocolbuffer数据</span></span><br><span class="line">    <span class="keyword">var</span> bufferHelper = <span class="keyword">new</span> BufferHelper();</span><br><span class="line">    req.on(<span class="string">&quot;data&quot;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">chunk</span>) </span>&#123;</span><br><span class="line">        bufferHelper.concat(chunk);</span><br><span class="line">    &#125;);</span><br><span class="line">    req.on(<span class="string">&#x27;end&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> buffer = bufferHelper.toBuffer();</span><br><span class="line">        <span class="comment">//buffer转换为proto对象</span></span><br><span class="line">        <span class="keyword">var</span> otIpcList = OTIpcDefProto.OTIpcList.deserializeBinary(<span class="keyword">new</span> <span class="built_in">Uint8Array</span>(buffer));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;otIpcList.getOtpicList().length;i++) &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(i+<span class="string">&quot;========================================&quot;</span>);</span><br><span class="line">            <span class="keyword">var</span> otIpc = otIpcList.getOtpicList()[i];</span><br><span class="line">            <span class="keyword">var</span> companyid = otIpc.getCompanyid();</span><br><span class="line">            <span class="keyword">var</span> source = otIpc.getSource();</span><br><span class="line">            <span class="keyword">var</span> iPCType = otIpc.getIpctype();</span><br><span class="line">            <span class="built_in">console</span>.log(companyid);</span><br><span class="line">            <span class="built_in">console</span>.log(source);</span><br><span class="line">            <span class="built_in">console</span>.log(iPCType);</span><br><span class="line">            <span class="keyword">if</span>(iPCType == OTIpcDefProto.IpcType.BASEINFOCOMPANY)&#123;</span><br><span class="line">                <span class="keyword">var</span> baseInfoCompanyList = otIpc.getBaseinfocompanyList();</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">var</span> j=<span class="number">0</span>;j&lt;baseInfoCompanyList.length;j++)&#123;</span><br><span class="line">                    <span class="built_in">console</span>.log(j+<span class="string">&quot;===============baseInfoCompanyList=================&quot;</span>);</span><br><span class="line">                    <span class="keyword">var</span> baseInfoCompany = baseInfoCompanyList[j];</span><br><span class="line">                    <span class="built_in">console</span>.log(baseInfoCompany.toObject());</span><br><span class="line">                    <span class="built_in">console</span>.log(baseInfoCompany.getCompanyid());</span><br><span class="line">                    <span class="built_in">console</span>.log(baseInfoCompany.getCompanyname());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span>(iPCType == OTIpcDefProto.IpcType.BASEINFOCOMPANYSTAT)&#123;</span><br><span class="line">                <span class="keyword">var</span> baseInfoCompanyStatList = otIpc.getBaseinfocompanystatList();</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">var</span> j=<span class="number">0</span>;j&lt;baseInfoCompanyStatList.length;j++)&#123;</span><br><span class="line">                    <span class="built_in">console</span>.log(j+<span class="string">&quot;===============baseInfoCompanyStatList=================&quot;</span>);</span><br><span class="line">                    <span class="keyword">var</span> baseInfoCompanyStat = baseInfoCompanyStatList[j];</span><br><span class="line">                    <span class="built_in">console</span>.log(baseInfoCompanyStat.toObject());</span><br><span class="line">                    <span class="built_in">console</span>.log(baseInfoCompanyStat.getCompanyid());</span><br><span class="line">                    <span class="built_in">console</span>.log(baseInfoCompanyStat.getDrivernum());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">console</span>.log(otIpcList.toObject());</span><br><span class="line"></span><br><span class="line">        res.send(otIpcList.toObject());</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>这里可以将protocolbuffer数据的接收过程封装到app.js中</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//以下代码要在路由映射的最上方声明，以保证其先被执行</span></span><br><span class="line">app.use(<span class="string">&#x27;/*&#x27;</span>,<span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> contentType = req.get(<span class="string">&#x27;Content-Type&#x27;</span>);</span><br><span class="line">  <span class="comment">//判断contentType，如果是protobuf类型则将数据封装到req.body中</span></span><br><span class="line">  <span class="keyword">if</span>(contentType==<span class="string">&#x27;application/x-protobuf&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">var</span> bufferHelper = <span class="keyword">new</span> BufferHelper();</span><br><span class="line">      req.on(<span class="string">&quot;data&quot;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">chunk</span>) </span>&#123;</span><br><span class="line">          bufferHelper.concat(chunk);</span><br><span class="line">      &#125;);</span><br><span class="line">      req.on(<span class="string">&#x27;end&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">          <span class="keyword">var</span> buffer = bufferHelper.toBuffer();</span><br><span class="line">          req.body = buffer;</span><br><span class="line">          <span class="built_in">console</span>.log(req.body);</span><br><span class="line">          next();</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      next();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>然后在路由js中只需要按照如下方式接收数据即可</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> otIpcList = OTIpcDefProto.OTIpcList.deserializeBinary(<span class="keyword">new</span> <span class="built_in">Uint8Array</span>(req.body));</span><br></pre></td></tr></table></figure>

<ul>
<li>Server端（restify）<br>restify中接收proto数据比较简单，因为proto数据已经被封装到req.body中了，所以使用方式类似于上面express的第二种方法<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> otIpcList = OTIpcDefProto.OTIpcList.deserializeBinary(<span class="keyword">new</span> <span class="built_in">Uint8Array</span>(req.body));</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="JSON与Protobuf相互转换"><a href="#JSON与Protobuf相互转换" class="headerlink" title="JSON与Protobuf相互转换"></a>JSON与Protobuf相互转换</h2><h3 id="JAVA"><a href="#JAVA" class="headerlink" title="JAVA"></a>JAVA</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- protocol buffer format --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.googlecode.protobuf-java-format<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>protobuf-java-format<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>json to proto</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">com.googlecode.protobuf.format.JsonFormat jsonFormat = <span class="keyword">new</span> JsonFormat();</span><br><span class="line">com.google.protobuf.Message.Builder builder = OTIpcDef.BaseInfoCompany.newBuilder();</span><br><span class="line"><span class="comment">//这里实际上需要提供一个json字符串，这里假设这个json是从某个对象转换而来的</span></span><br><span class="line">String json = com.alibaba.fastjson.JSON.toJSONString(myObject);</span><br><span class="line"><span class="comment">//该方法会将json中与builder所代表的对象中的属性做merge，也就是说只要字段名称和类型一致即可进行封装，对于字段名称和类型匹配不上的属性不予处理，方法成功后builder对象会完成属性值的封装。</span></span><br><span class="line">jsonFormat.merge(<span class="keyword">new</span> ByteArrayInputStream(json.getBytes()), builder);     </span><br></pre></td></tr></table></figure></li>
<li><p>proto to json</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">OTIpcDef.OTIpcList otIpcList = oTIpcListBuilder.build();</span><br><span class="line"><span class="comment">//proto对象转json</span></span><br><span class="line">com.googlecode.protobuf.format.JsonFormat jsonFormat = <span class="keyword">new</span> JsonFormat();</span><br><span class="line">String json =jsonFormat.printToString(otIpcList);</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="nodejs"><a href="#nodejs" class="headerlink" title="nodejs"></a>nodejs</h3><ul>
<li>json to proto<br>编写json2Proto.js，里面就一个方法，用于将json字符串转换为封装好的proto对象<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> json2proto = <span class="function"><span class="keyword">function</span> (<span class="params">json_str,protoObject</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Array</span>.prototype.contains = <span class="function"><span class="keyword">function</span> (<span class="params"> needle </span>) </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="built_in">this</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>[i] == needle) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> p_json_str = json_str;</span><br><span class="line">    <span class="keyword">var</span> p_json = <span class="built_in">eval</span>(<span class="string">&quot;(&quot;</span> + p_json_str + <span class="string">&quot;)&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> p_json_key_array = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> p <span class="keyword">in</span> p_json)&#123;<span class="comment">//遍历json对象的每个key/value对,p为key</span></span><br><span class="line">        p_json_key_array[i] = p;</span><br><span class="line">        i++;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> s_json = protoObject.toObject();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> p <span class="keyword">in</span> s_json)&#123;<span class="comment">//遍历json对象的每个key/value对,p为key</span></span><br><span class="line">        <span class="keyword">if</span> (p_json_key_array.contains(p)) &#123;</span><br><span class="line">            <span class="keyword">var</span> setMethod = <span class="string">&quot;set&quot;</span>+p.charAt(<span class="number">0</span>).toUpperCase() + p.slice(<span class="number">1</span>);    </span><br><span class="line">            protoObject[setMethod](p_json[p]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> protoObject;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = json2proto;</span><br></pre></td></tr></table></figure>
调用方法<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> OTIpcDefProto = <span class="built_in">require</span>(<span class="string">&#x27;../protocbuf/OTIpcDef_pb&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> json2proto = <span class="built_in">require</span>(<span class="string">&#x27;../json2Proto&#x27;</span>);</span><br><span class="line"><span class="comment">//json字符串</span></span><br><span class="line"><span class="keyword">var</span> p_json_str = <span class="string">&quot;&#123; companyid: &#x27;公司ID&#x27;,&quot;</span> +</span><br><span class="line">    <span class="string">&quot;companyname: &#x27;companyId&#x27;,&quot;</span> +</span><br><span class="line">    <span class="string">&quot;identifier : &#x27;identifier&#x27;,&quot;</span> +</span><br><span class="line">    <span class="string">&quot;address : 111111,&quot;</span> +</span><br><span class="line">    <span class="string">&quot;businessscope : &#x27;businessscope&#x27;,&quot;</span> +</span><br><span class="line">    <span class="string">&quot;contactaddress : &#x27;contactaddress&#x27;,&quot;</span> +</span><br><span class="line">    <span class="string">&quot;economictype : &#x27;economictype&#x27;,&quot;</span> +</span><br><span class="line">    <span class="string">&quot;regcapital : &#x27;regcapital&#x27;,&quot;</span> +</span><br><span class="line">    <span class="string">&quot;legalname : &#x27;legalname&#x27;,&quot;</span> +</span><br><span class="line">    <span class="string">&quot;legalid : &#x27;legalid&#x27;,&quot;</span> +</span><br><span class="line">    <span class="string">&quot;legalphone : &#x27;legalphone&#x27;,&quot;</span> +</span><br><span class="line">    <span class="string">&quot;legalphoto : &#x27;legalphoto&#x27;,&quot;</span> +</span><br><span class="line">    <span class="string">&quot;state : 0,&quot;</span> +</span><br><span class="line">    <span class="string">&quot;flag : 1,&quot;</span> +</span><br><span class="line">    <span class="string">&quot;updatetime: 20180226121212&#125;&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> baseInfoCompany = json2proto(p_json_str,<span class="keyword">new</span> OTIpcDefProto.BaseInfoCompany());</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(baseInfoCompany.toObject());</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="http://blog.csdn.net/fangzhangsc2006/article/details/8687415">springMVC项目中实现Protocol Buffers对象自动转换</a></li>
<li><a href="http://blog.csdn.net/zhuyijian135757/article/details/52294745">protobuf实现js与java间的http通信</a></li>
</ul>
]]></content>
      <categories>
        <category>技术</category>
      </categories>
      <tags>
        <tag>protocbuf</tag>
      </tags>
  </entry>
  <entry>
    <title>钉钉与企业微信之OA产品分析</title>
    <url>/2017/08/08/dingtalk-weixin-oa/</url>
    <content><![CDATA[<h2 id="网站"><a href="#网站" class="headerlink" title="网站"></a>网站</h2><ul>
<li><a href="https://www.dingtalk.com/">钉钉</a></li>
<li><a href="https://work.weixin.qq.com/">企业微信</a></li>
</ul>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><ul>
<li>钉钉自身就实现了OA中的绝大部分功能，且流程配置更加灵活，目前我们用到的只有CRM需要依赖于第三方的销帮帮。</li>
<li>销帮帮不支持区间设置，但只有合同审批会受此影响（目前正在和对方沟通希望其能进行升级）。</li>
<li>微信自身提供的功能和第三方应用都不如钉钉的多。</li>
<li>从功能、使用方式、价格和技术支持等多个维度对比，钉钉更有优势。</li>
</ul>
<h2 id="平台对比"><a href="#平台对比" class="headerlink" title="平台对比"></a>平台对比</h2><table>
<thead>
<tr>
<th align="left">功能</th>
<th align="center">钉钉</th>
<th align="center">企业微信</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">web端</td>
<td align="center">支持</td>
<td align="center">支持</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">手机客户端</td>
<td align="center">支持</td>
<td align="center">支持</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">PC客户端</td>
<td align="center">支持</td>
<td align="center">支持</td>
<td align="left">钉钉：除第三方功能（销帮帮CRM）外，都可以在客户端上完成，第三方功能会跳转到web端。<br>企业微信：部分内置审批功能都需要跳转到web端，第三方（企微云）支持客户端直接发起申请很审批。</td>
</tr>
<tr>
<td align="left">微信插件</td>
<td align="center">无</td>
<td align="center">有</td>
<td align="left">使用微信插件可以不安装企业微信客户端，只使用微信就可以。</td>
</tr>
<tr>
<td align="left">自定义表单</td>
<td align="center">支持</td>
<td align="center">支持</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">自定义流程</td>
<td align="center">支持</td>
<td align="center">支持</td>
<td align="left">企业微信：分支流程不支持区间设置，所以不能实现超过2个分支的情况，比如按请假天数走不同的审批流：小于3天，大于等于3天且小于10天，大于等于10天。企微云mac系统支持不好。销帮帮不支持区间设置。</td>
</tr>
<tr>
<td align="left">自定义工作台布局</td>
<td align="center">支持</td>
<td align="center">不支持</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">使用方式</td>
<td align="center">多公司</td>
<td align="center">单公司</td>
<td align="left">钉钉：登录后可同时接收多家公司的消息，在工作台中对某个公司进行切换。<br>企业微信：登录时选择公司，只接收登录公司的信息</td>
</tr>
</tbody></table>
<span id="more"></span>

<h2 id="OA功能对比"><a href="#OA功能对比" class="headerlink" title="OA功能对比"></a>OA功能对比</h2><table>
<thead>
<tr>
<th align="left">功能</th>
<th align="center">钉钉</th>
<th align="center">企业微信</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">出勤休假–考勤打卡（签到）</td>
<td align="center">有</td>
<td align="center">有</td>
<td>企微云平台 - 移动办公</td>
</tr>
<tr>
<td align="left">出勤休假–请假</td>
<td align="center">有</td>
<td align="center">有</td>
<td>适用于请假申请，精确扣减出勤时间，并同步考勤报表</td>
</tr>
<tr>
<td align="left">出勤休假–出差</td>
<td align="center">有</td>
<td align="center">有</td>
<td>适用于出差申请，精确汇总至考勤报表</td>
</tr>
<tr>
<td align="left">出勤休假–外出</td>
<td align="center">有</td>
<td align="center">有</td>
<td>适用于外出申请，精确汇总至考勤报表</td>
</tr>
<tr>
<td align="left">出勤休假–加班</td>
<td align="center">有</td>
<td align="center">有</td>
<td>适用于加班申请，精确汇总至考勤报表</td>
</tr>
<tr>
<td align="left">出勤休假–补卡</td>
<td align="center">有</td>
<td align="center">有（企微云）</td>
<td>当员工考勤出现缺卡时，可发起补卡审批，审批通过后考勤报表中的缺卡记录改为正常</td>
</tr>
<tr>
<td align="left">人事–转正</td>
<td align="center">有</td>
<td align="center">无（可以创建）</td>
<td>用于试用期内员工的员工转正申请</td>
</tr>
<tr>
<td align="left">人事–招聘</td>
<td align="center">有</td>
<td align="center">无（可以创建）</td>
<td>用于用人部门需求申请</td>
</tr>
<tr>
<td align="left">人事–调岗申请单</td>
<td align="center">有</td>
<td align="center">无（可以创建）</td>
<td>适用于调岗审批</td>
</tr>
<tr>
<td align="left">人事–离职申请单</td>
<td align="center">有</td>
<td align="center">无（可以创建）</td>
<td>适用于离职审批</td>
</tr>
<tr>
<td align="left">行政–用车申请</td>
<td align="center">有</td>
<td align="center">有（企微云）</td>
<td>适用于因公使用车辆的申请</td>
</tr>
<tr>
<td align="left">行政–物品领用</td>
<td align="center">有</td>
<td align="center">有（企微云）</td>
<td>适用于物品领用申请</td>
</tr>
<tr>
<td align="left">行政–用印申请</td>
<td align="center">有</td>
<td align="center">无（可以创建）</td>
<td>适用于公司印章使用</td>
</tr>
<tr>
<td align="left">行政–通用审批</td>
<td align="center">有</td>
<td align="center">有</td>
<td>适用于通用审批</td>
</tr>
<tr>
<td align="left">财务–报销</td>
<td align="center">有</td>
<td align="center">有</td>
<td>适用于公司报销审批</td>
</tr>
<tr>
<td align="left">财务–备用金申请</td>
<td align="center">有</td>
<td align="center">无（可以创建）</td>
<td>用于企业员工出差或外出办事填写的备用金申请单</td>
</tr>
<tr>
<td align="left">财务–付款申请</td>
<td align="center">有</td>
<td align="center">无（可以创建）</td>
<td>适用于付款审批</td>
</tr>
<tr>
<td align="left">其它–立项申请</td>
<td align="center">有</td>
<td align="center">无（可以创建）</td>
<td>适用于项目立项时的申请</td>
</tr>
<tr>
<td align="left">其它–采购</td>
<td align="center">有</td>
<td align="center">无（可以创建）</td>
<td>用于企业办公或所需材料的采购申请</td>
</tr>
<tr>
<td align="left">合同和CRM</td>
<td align="center">无（销帮帮）</td>
<td align="center">企微云</td>
<td>均为第三方产品，都支持自定义合同表单和审批流程。<br>钉钉中第三方产品比较多。<br>企业微信比较少。</td>
</tr>
</tbody></table>
<h2 id="手机客户端界面对比"><a href="#手机客户端界面对比" class="headerlink" title="手机客户端界面对比"></a>手机客户端界面对比</h2><table>
<thead>
<tr>
<th align="center">功能页</th>
<th align="center">钉钉</th>
<th align="center">企业微信</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">首页</td>
<td align="center"><img src="/images_glob/dingtalk-weixin-oa/dingtalk-index.PNG"></td>
<td align="center"><img src="/images_glob/dingtalk-weixin-oa/weixin-index.PNG"></td>
<td align="left">钉钉：显示多个公司的信息。<br>企业微信：显示单个公司的信息。</td>
</tr>
<tr>
<td align="center">工作台</td>
<td align="center"><img src="/images_glob/dingtalk-weixin-oa/dingtalk-work.PNG"></td>
<td align="center"><img src="/images_glob/dingtalk-weixin-oa/weixin-work.PNG"></td>
<td align="left"></td>
</tr>
<tr>
<td align="center">审批</td>
<td align="center"><img src="/images_glob/dingtalk-weixin-oa/dingtalk-approve.PNG"></td>
<td align="center"><img src="/images_glob/dingtalk-weixin-oa/weixin-approve.PNG"><img src="/images_glob/dingtalk-weixin-oa/weixin-approve-thd.PNG"></td>
<td align="left">企业微信：第一个是微信的，第二张图是第三方的（指掌天下）</td>
</tr>
<tr>
<td align="center">CRM(合同)</td>
<td align="center"><img src="/images_glob/dingtalk-weixin-oa/dingtalk-crm-index.PNG"><img src="/images_glob/dingtalk-weixin-oa/dingtalk-crm-create.PNG"></td>
<td align="center"><img src="/images_glob/dingtalk-weixin-oa/weixin-crm.PNG"></td>
<td align="left">钉钉：销帮帮（第三方）。<br> 企业微信：企微云（第三方）</td>
</tr>
</tbody></table>
<h2 id="PC客户端界面对比"><a href="#PC客户端界面对比" class="headerlink" title="PC客户端界面对比"></a>PC客户端界面对比</h2><table>
<thead>
<tr>
<th align="center">功能页</th>
<th align="center">钉钉</th>
<th align="center">企业微信</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">首页</td>
<td align="center"><img src="/images_glob/dingtalk-weixin-oa/dt-index.png"></td>
<td align="center"><img src="/images_glob/dingtalk-weixin-oa/wx-index.png"></td>
<td align="left"></td>
</tr>
<tr>
<td align="center">工作台</td>
<td align="center"><img src="/images_glob/dingtalk-weixin-oa/dt-work.png"></td>
<td align="center"></td>
<td align="left">企业微信：首页即为工作台</td>
</tr>
<tr>
<td align="center">审批</td>
<td align="center"><img src="/images_glob/dingtalk-weixin-oa/dt-approve.png"><img src="/images_glob/dingtalk-weixin-oa/dt-approve-create.png"></td>
<td align="center"><img src="/images_glob/dingtalk-weixin-oa/wx-approve-create.png"></td>
<td align="left">企业微信：内置审批需要跳转到web申请</td>
</tr>
<tr>
<td align="center">CRM(合同)</td>
<td align="center"></td>
<td align="center"><img src="/images_glob/dingtalk-weixin-oa/wx-crm.png"></td>
<td align="left">钉钉：跳转到web</td>
</tr>
</tbody></table>
<h2 id="销帮帮"><a href="#销帮帮" class="headerlink" title="销帮帮"></a>销帮帮</h2><ul>
<li><a href="https://dingtalk.xbongbong.com//user/crmIndex.html">网址</a><br><img src="/images_glob/dingtalk-weixin-oa/xbb-index.png"></li>
<li>使用手册<br><a href="/images_glob/dingtalk-weixin-oa/%E9%94%80%E5%B8%AE%E5%B8%AECRM%E9%92%89%E9%92%89%E7%89%88%E7%AE%A1%E7%90%86%E5%91%98%E4%BD%BF%E7%94%A8%E6%89%8B%E5%86%8CV3.4.pptx">销帮帮CRM钉钉版管理员使用手册V3.4.pptx</a><br><a href="/images_glob/dingtalk-weixin-oa/%E9%94%80%E5%B8%AE%E5%B8%AECRM%E9%92%89%E9%92%89%E7%89%88%E7%94%A8%E6%88%B7%E4%BD%BF%E7%94%A8%E6%89%8B%E5%86%8CV3.4.ppt">销帮帮CRM钉钉版用户使用手册V3.4.ppt</a></li>
<li>费用<br><img src="/images_glob/dingtalk-weixin-oa/xbb-price.png"></li>
</ul>
<h2 id="企微云"><a href="#企微云" class="headerlink" title="企微云"></a>企微云</h2><ul>
<li><a href="http://qy.do1.com.cn/qwy/manager/form_flow/main.jsp">网址</a><br><img src="/images_glob/dingtalk-weixin-oa/qwy-index.png"></li>
<li>使用手册<br><a href="/images_glob/dingtalk-weixin-oa/%E4%BC%81%E5%BE%AE%E4%BA%91%E5%B9%B3%E5%8F%B0-%E5%BE%AE%E4%BF%A1%E5%8A%9E%E5%85%AC%E7%AC%AC%E4%B8%80%E5%93%81%E7%89%8C8.0.pdf">企微云平台-微信办公第一品牌8.0.pdf</a></li>
<li><a href="http://qy.do1.com.cn/qwy/qiweipublicity/companysrv/vip/vip_single_buy.jsp?tabCode=3">免费版与收费版区别</a></li>
<li>费用:服务价格：100人（含）内2万元/年，超出部分，每50人增加2千元（不足50人按50人计算) ，超过2千人价格面议</li>
</ul>
]]></content>
      <categories>
        <category>学习笔记</category>
      </categories>
      <tags>
        <tag>学习笔记</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Boot学习笔记08--NoSql之MongoDB&amp;Redis</title>
    <url>/2016/12/30/spring-boot-study-nosql/</url>
    <content><![CDATA[<h2 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h2><p>看完本文你将掌握如下知识点：</p>
<ol>
<li>Spring Boot对MongoDB的支持</li>
<li>Spring Boot对Redis的支持</li>
</ol>
<span id="more"></span>

<hr>
<p><strong>SpringBoot系列</strong>：<a href="/tags/Spring-Boot/">Spring Boot学习笔记</a></p>
<hr>
<h2 id="Spring-Boot对MongoDB的支持"><a href="#Spring-Boot对MongoDB的支持" class="headerlink" title="Spring Boot对MongoDB的支持"></a>Spring Boot对MongoDB的支持</h2><p><strong>pom</strong>中加入依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-mongodb<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>自定义Repository需要继承于<strong>MongoRepository</strong>，与JPA类似，同样支持命名方法和@Query接口查询。</p>
<p>按方法名进行查询，规则与JPA一致，@Query接口查询就是mongo的原生查询语句的语法类似。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PersonRepository</span> <span class="keyword">extends</span> <span class="title">MongoRepository</span>&lt;<span class="title">Person</span>, <span class="title">String</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//等于</span></span><br><span class="line">    <span class="function">List&lt;Person&gt; <span class="title">findByName</span><span class="params">(String name)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//And --- 等价于 SQL 中的 and 关键字；</span></span><br><span class="line">    <span class="function">List&lt;Person&gt; <span class="title">findByNameAndAge</span><span class="params">(String name, Integer age)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Or --- 等价于 SQL 中的 or 关键字；</span></span><br><span class="line">    <span class="function">List&lt;Person&gt; <span class="title">findByNameOrAge</span><span class="params">(String name, Integer age)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//分页</span></span><br><span class="line">    <span class="function">Page&lt;Person&gt; <span class="title">findByNameNot</span><span class="params">(String name, Pageable pageable)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//mongo原生查询语句</span></span><br><span class="line">    <span class="comment">//等于</span></span><br><span class="line">    <span class="meta">@Query(&quot;&#123;&#x27;age&#x27;:?0&#125;&quot;)</span></span><br><span class="line">    <span class="function">List&lt;Person&gt; <span class="title">withQueryFindByAge</span><span class="params">(Integer age)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//大于</span></span><br><span class="line">    <span class="meta">@Query(&quot;&#123;&#x27;age&#x27;: &#123;&#x27;$gt&#x27; : ?0&#125;&#125;&quot;)</span></span><br><span class="line">    <span class="function">List&lt;Person&gt; <span class="title">findByAgeGreaterThan</span><span class="params">(<span class="keyword">int</span> age)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//正则匹配name，age范围</span></span><br><span class="line">    <span class="meta">@Query(&quot;&#123; &#x27;name&#x27;:&#123;&#x27;$regex&#x27;:?0,&#x27;$options&#x27;:&#x27;i&#x27;&#125;, &#x27;age&#x27;: &#123;&#x27;$gte&#x27;:?1,&#x27;$lte&#x27;:?2&#125;&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Page&lt;Person&gt; <span class="title">findByNameAndAgeRange</span><span class="params">(String name,<span class="keyword">int</span> ageFrom,<span class="keyword">int</span> ageTo,Pageable page)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//正则匹配name，age范围，查询结果只封装name和age，当然默认ID是必须封装的</span></span><br><span class="line">    <span class="meta">@Query(value = &quot;&#123; &#x27;name&#x27;:&#123;&#x27;$regex&#x27;:?0,&#x27;$options&#x27;:&#x27;i&#x27;&#125;, &#x27;age&#x27;: &#123;&#x27;$gte&#x27;:?1,&#x27;$lte&#x27;:?2&#125;&#125;&quot;,fields = &quot;&#123; &#x27;name&#x27; : 1, &#x27;age&#x27; : 1&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Page&lt;Person&gt; <span class="title">findByNameAndAgeRangeShow</span><span class="params">(String name,<span class="keyword">int</span> ageFrom,<span class="keyword">int</span> ageTo,Pageable page)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p>关于Mongo原生语句的说明可以参考：<a href="http://www.cnblogs.com/egger/archive/2013/06/14/3135847.html">http://www.cnblogs.com/egger/archive/2013/06/14/3135847.html</a></p>
<hr>
<p>如果希望接管spring boot对mongo的自动配置，可以创建如下配置类，这样我们也可以像前文介绍的JPA绑定多数据源那样，绑定多个mongo数据源。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mongo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.mongodb.MongoClient;</span><br><span class="line"><span class="keyword">import</span> com.mongodb.MongoClientURI;</span><br><span class="line"><span class="keyword">import</span> com.mongodb.ServerAddress;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.MongoDbFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.MongoTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.SimpleMongoDbFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.repository.config.EnableMongoRepositories;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableMongoRepositories(basePackages = &#123;&quot;com.example.mongo.dao&quot;&#125;,mongoTemplateRef = &quot;mongoTemplate&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MongoConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.data.mongodb.host&#125;&quot;)</span></span><br><span class="line">    String mongoHost;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.data.mongodb.uri&#125;&quot;)</span></span><br><span class="line">    String mongoUrl;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MongoClient <span class="title">mongoClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        MongoClient mongoClient = <span class="keyword">new</span> MongoClient(<span class="keyword">new</span> ServerAddress(mongoHost));</span><br><span class="line">        <span class="keyword">return</span> mongoClient;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MongoDbFactory <span class="title">mongoDbFactory</span><span class="params">()</span></span>&#123;</span><br><span class="line">        String database = <span class="keyword">new</span> MongoClientURI(mongoUrl).getDatabase();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SimpleMongoDbFactory(mongoClient(),database);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;mongoTemplate&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MongoTemplate <span class="title">mongoTemplate</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MongoTemplate(mongoDbFactory());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Spring-Boot对Redis的支持"><a href="#Spring-Boot对Redis的支持" class="headerlink" title="Spring Boot对Redis的支持"></a>Spring Boot对Redis的支持</h2><p><strong>pom</strong>中加入依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后就可以通过**@Autowired<strong>注解注入</strong>RedisTemplate**，比如：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.redis.dao;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.redis.domain.Student;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.ValueOperations;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Repository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StudentDao</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RedisTemplate&lt;Object,Object&gt; redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource(name = &quot;stringRedisTemplate&quot;)</span></span><br><span class="line">    ValueOperations&lt;String,String&gt; valueOperationsStr;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource(name = &quot;redisTemplate&quot;)</span></span><br><span class="line">    ValueOperations&lt;Object,Object&gt; valueOperations;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setString</span><span class="params">(String key,String value)</span></span>&#123;</span><br><span class="line">        valueOperationsStr.set(key,value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getString</span><span class="params">(String key)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> valueOperationsStr.get(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveStudent</span><span class="params">(Student student)</span></span>&#123;</span><br><span class="line">        valueOperations.set(student.getId(),student);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Student <span class="title">getStudent</span><span class="params">(String id)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (Student)valueOperations.get(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同样，如果希望接管spring boot对redis的自动配置，可以创建如下自动配置类：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.redis;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.jedis.JedisConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.Jackson2JsonRedisSerializer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.StringRedisSerializer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.redis.database&#125;&quot;)</span></span><br><span class="line">    String redisDatabase;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.redis.host&#125;&quot;)</span></span><br><span class="line">    String redisHost;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JedisConnectionFactory <span class="title">connectionFactory</span><span class="params">()</span></span>&#123;</span><br><span class="line">        JedisConnectionFactory jedisConnectionFactory = <span class="keyword">new</span> JedisConnectionFactory();</span><br><span class="line">        jedisConnectionFactory.setDatabase(Integer.valueOf(redisDatabase));</span><br><span class="line">        jedisConnectionFactory.setHostName(redisHost);</span><br><span class="line">        <span class="keyword">return</span> jedisConnectionFactory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Jackson2JsonRedisSerializer&lt;Object&gt; <span class="title">jackson2JsonRedisSerializer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">        Jackson2JsonRedisSerializer&lt;Object&gt; jackson2JsonRedisSerializer = <span class="keyword">new</span> Jackson2JsonRedisSerializer&lt;Object&gt;(</span><br><span class="line">                Object.class);</span><br><span class="line">        jackson2JsonRedisSerializer.setObjectMapper(objectMapper);</span><br><span class="line">        <span class="keyword">return</span> jackson2JsonRedisSerializer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//用于对存储内容转换为json格式</span></span><br><span class="line">    <span class="meta">@Bean(name = &quot;redisTemplate&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedisTemplate&lt;Object, Object&gt; <span class="title">objRedisTemplate</span><span class="params">(JedisConnectionFactory connectionFactory,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                   Jackson2JsonRedisSerializer&lt;Object&gt; jackson2JsonRedisSerializer)</span> </span>&#123;</span><br><span class="line">        RedisTemplate&lt;Object, Object&gt; redisTemplate = <span class="keyword">new</span> RedisTemplate&lt;Object, Object&gt;();</span><br><span class="line">        redisTemplate.setConnectionFactory(connectionFactory);</span><br><span class="line">        redisTemplate.setDefaultSerializer(jackson2JsonRedisSerializer);</span><br><span class="line">        StringRedisSerializer stringRedisSerializer = <span class="keyword">new</span> StringRedisSerializer();</span><br><span class="line">        redisTemplate.setKeySerializer(stringRedisSerializer);</span><br><span class="line">        redisTemplate.setHashKeySerializer(stringRedisSerializer);</span><br><span class="line">        <span class="keyword">return</span> redisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;stringRedisTemplate&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> StringRedisTemplate <span class="title">stringRedisTemplate</span><span class="params">(JedisConnectionFactory connectionFactory)</span> </span>&#123;</span><br><span class="line">        StringRedisTemplate stringRedisTemplate = <span class="keyword">new</span> StringRedisTemplate(connectionFactory);</span><br><span class="line">        <span class="keyword">return</span> stringRedisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p>本文示例代码下载地址：<a href="https://github.com/hanqunfeng/SpringBootStudy">https://github.com/hanqunfeng/SpringBootStudy</a></p>
]]></content>
      <categories>
        <category>技术</category>
        <category>Java</category>
        <category>springboot</category>
      </categories>
      <tags>
        <tag>Spring Boot</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Boot学习笔记07--DataSource的创建方法</title>
    <url>/2016/12/22/spring-boot-study-datasource/</url>
    <content><![CDATA[<h2 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h2><p>看完本文你将掌握如下知识点：</p>
<ol>
<li>Spring Boot项目中DataSource的创建方法</li>
</ol>
<span id="more"></span>

<hr>
<p><strong>SpringBoot系列</strong>：<a href="/tags/Spring-Boot/">Spring Boot学习笔记</a></p>
<hr>
<h2 id="DataSource的创建方法"><a href="#DataSource的创建方法" class="headerlink" title="DataSource的创建方法"></a>DataSource的创建方法</h2><p>前面讲了很多Spring Boot数据访问方面的内容，在讲到自己扩展数据访问的时候，示例代码中给出的DataSource创建方式都是<strong>DriverManagerDataSource</strong>，比如：</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment">#datasource</span></span><br><span class="line"><span class="string">spring.datasource.driver-class-name=com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="string">spring.datasource.url=jdbc:mysql://localhost:3306/springboot1?useUnicode=true&amp;characterEncoding=utf-8</span></span><br><span class="line"><span class="string">spring.datasource.username=root</span></span><br><span class="line"><span class="string">spring.datasource.password=newpwd</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Value(&quot;$&#123;spring.datasource.driver-class-name&#125;&quot;)</span></span><br><span class="line">String driverClass;</span><br><span class="line"><span class="meta">@Value(&quot;$&#123;spring.datasource.url&#125;&quot;)</span></span><br><span class="line">String url;</span><br><span class="line"><span class="meta">@Value(&quot;$&#123;spring.datasource.username&#125;&quot;)</span></span><br><span class="line">String userName;</span><br><span class="line"><span class="meta">@Value(&quot;$&#123;spring.datasource.password&#125;&quot;)</span></span><br><span class="line">String passWord;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean(name = &quot;dataSource&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    DriverManagerDataSource dataSource = <span class="keyword">new</span> DriverManagerDataSource();</span><br><span class="line">    dataSource.setDriverClassName(driverClass);</span><br><span class="line">    dataSource.setUrl(url);</span><br><span class="line">    dataSource.setUsername(userName);</span><br><span class="line">    dataSource.setPassword(passWord);</span><br><span class="line">    <span class="keyword">return</span> dataSource;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果有多个数据源，就再创建多个<strong>DriverManagerDataSource</strong>。<br>一般生产项目中我们不会这样使用，通常可以使用<strong>org.apache.commons.dbcp.BasicDataSource</strong>。</p>
<hr>
<p>实际上Spring Boot为我们提供了简便的创建DataSource的方法：</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment">#datasource</span></span><br><span class="line"><span class="comment">#需要执行数据源的类型</span></span><br><span class="line"><span class="string">spring.datasource.ds1.type=org.apache.tomcat.jdbc.pool.DataSource</span></span><br><span class="line"><span class="string">spring.datasource.ds1.driver-class-name=com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="string">spring.datasource.ds1.url=jdbc:mysql://localhost:3306/springboot1?useUnicode=true&amp;characterEncoding=utf-8</span></span><br><span class="line"><span class="string">spring.datasource.ds1.username=root</span></span><br><span class="line"><span class="string">spring.datasource.ds1.password=newpwd</span></span><br><span class="line"></span><br><span class="line"><span class="string">spring.datasource.ds2.type=org.apache.tomcat.jdbc.pool.DataSource</span></span><br><span class="line"><span class="string">spring.datasource.ds2.driver-class-name=com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="string">spring.datasource.ds2.url=jdbc:mysql://localhost:3306/springboot2?useUnicode=true&amp;characterEncoding=utf-8</span></span><br><span class="line"><span class="string">spring.datasource.ds2.username=root</span></span><br><span class="line"><span class="string">spring.datasource.ds2.password=newpwd</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean(name = &quot;dataSource1&quot;)</span></span><br><span class="line"><span class="comment">//application.properties中属性名称的前缀</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;spring.datasource.ds1&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> DataSourceBuilder.create().build();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean(name = &quot;dataSource2&quot;)</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;spring.datasource.ds2&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> DataSourceBuilder.create().build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>目前，此种方式支持如下几种数据源类型：</p>
<p>“org.apache.tomcat.jdbc.pool.DataSource”, “com.zaxxer.hikari.HikariDataSource”, “org.apache.commons.dbcp.BasicDataSource”, “org.apache.commons.dbcp2.BasicDataSource”</p>
<p>使用哪种数据源类型，就要在项目中加入相应的jar依赖，<br>比如<strong>org.apache.tomcat.jdbc.pool.DataSource</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.5.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>技术</category>
        <category>Java</category>
        <category>springboot</category>
      </categories>
      <tags>
        <tag>Spring Boot</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Boot学习笔记06--JPA</title>
    <url>/2016/12/21/spring-boot-study-jpa/</url>
    <content><![CDATA[<h2 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h2><p>看完本文你将掌握如下知识点：</p>
<ol>
<li>Spring Boot项目中JPA的配置及使用方法</li>
<li>Spring Boot项目配置Spring Data JPA的方法</li>
<li>Spring Data JPA与Atomikos整合实现多数据源事务管理</li>
<li>扩展JPA的方法</li>
</ol>
<span id="more"></span>

<hr>
<p><strong>SpringBoot系列</strong>：<a href="/tags/Spring-Boot/">Spring Boot学习笔记</a></p>
<hr>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>JPA即Java Persistence API，是一个基于O/R映射的标准规范，该规范只负责定义规则的标准（注解或接口），而不需要提供具体实现，具体的实现交由软件提供商来实现，目前主要的JPA提供商为Hibernate，EclipseLink和OperJPA。</p>
<p><a href="http://projects.spring.io/spring-data-jpa/">Spring Data JPA</a>是Spring Data的一个子项目，通过提供基于JPA的Repository来简化代码量。<br>其提供了一个<strong>org.springframework.data.jpa.repository.JpaRepository</strong>，我们的Repository只要继承该JpaRepository，即可享受到JPA带来的好处。</p>
<p>Spring Boot通过<strong>spring-boot-starter-data-jpa</strong>来提供对JPA的支持，Spring Boot默认的JPA实现者是Hibernate。</p>
<hr>
<p><strong>说明</strong><br>在讲解下面的内容前，我们先在数据库中创建一张表</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"># 创建库<span class="number">1</span></span><br><span class="line"><span class="keyword">CREATE</span> SCHEMA `springboot1` <span class="keyword">DEFAULT</span> <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 ;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `springboot1`.`person` (</span><br><span class="line">  `p_id` <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;主键&#x27;</span>,</span><br><span class="line">  `p_name` <span class="type">VARCHAR</span>(<span class="number">45</span>) <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;姓名&#x27;</span>,</span><br><span class="line">  `p_age` <span class="type">INT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;年龄&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`p_id`))</span><br><span class="line">ENGINE <span class="operator">=</span> InnoDB</span><br><span class="line">COMMENT <span class="operator">=</span> <span class="string">&#x27;人员信息表&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `springboot1`.`person` (`p_id`, `p_name`, `p_age`) <span class="keyword">VALUES</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;张三&#x27;</span>, <span class="string">&#x27;20&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `springboot1`.`person` (`p_id`, `p_name`, `p_age`) <span class="keyword">VALUES</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;李四&#x27;</span>, <span class="string">&#x27;25&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `springboot1`.`person` (`p_id`, `p_name`, `p_age`) <span class="keyword">VALUES</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;王五&#x27;</span>, <span class="string">&#x27;18&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `springboot1`.`person` (`p_id`, `p_name`, `p_age`) <span class="keyword">VALUES</span> (<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;王五&#x27;</span>, <span class="string">&#x27;18&#x27;</span>);</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Spring-Boot项目中使用JPA"><a href="#Spring-Boot项目中使用JPA" class="headerlink" title="Spring Boot项目中使用JPA"></a>Spring Boot项目中使用JPA</h2><p>创建项目时选择JPA依赖，或者手工将<strong>spring-boot-starter-data-jpa</strong>添加到pom中。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>此时项目会自动开启如下两个自动配置类：</p>
<blockquote>
<p>JpaRepositoriesAutoConfiguration<br>HibernateJpaAutoConfiguration</p>
</blockquote>
<p><strong>application.properties</strong>中增加jpa相关配置</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment">#datasource</span></span><br><span class="line"><span class="string">spring.datasource.driver-class-name=com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="string">spring.datasource.url=jdbc:mysql://localhost:3306/springboot1?useUnicode=true&amp;characterEncoding=utf-8</span></span><br><span class="line"><span class="string">spring.datasource.username=root</span></span><br><span class="line"><span class="string">spring.datasource.password=newpwd</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#spring_jpa</span></span><br><span class="line"><span class="comment">#启动时会根据实体类生成数据表，或者更新表结构，不清空数据，开发阶段使用；validate：表结构稳定后使用，可用于正式环境；</span></span><br><span class="line"><span class="string">spring.jpa.hibernate.ddl-auto=update</span></span><br><span class="line"><span class="comment">#控制台打印sql</span></span><br><span class="line"><span class="string">spring.jpa.show-sql=true</span></span><br><span class="line"><span class="comment">#让控制器输出的json格式更美观</span></span><br><span class="line"><span class="string">spring.jackson.serialization.indent-output=true</span></span><br></pre></td></tr></table></figure>

<p>在项目中使用JPA时，只需要创建一个继承于<strong>JpaRepository</strong>的Repository接口，即可拥有<strong>JpaRepository</strong>及其父类中提供的全部数据访问方法。如果提供的方法不满足业务需要，可以按如下规则扩展数据方法。</p>
<p><strong>JpaRepository</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.data.jpa.repository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.Example;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.Sort;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.repository.NoRepositoryBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.repository.PagingAndSortingRepository;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.repository.query.QueryByExampleExecutor;</span><br><span class="line"></span><br><span class="line"><span class="meta">@NoRepositoryBean</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">JpaRepository</span>&lt;<span class="title">T</span>, <span class="title">ID</span> <span class="keyword">extends</span> <span class="title">Serializable</span>&gt; <span class="keyword">extends</span> <span class="title">PagingAndSortingRepository</span>&lt;<span class="title">T</span>, <span class="title">ID</span>&gt;, <span class="title">QueryByExampleExecutor</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function">List&lt;T&gt; <span class="title">findAll</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">List&lt;T&gt; <span class="title">findAll</span><span class="params">(Sort var1)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">List&lt;T&gt; <span class="title">findAll</span><span class="params">(Iterable&lt;ID&gt; var1)</span></span>;</span><br><span class="line"></span><br><span class="line">    &lt;S extends T&gt; <span class="function">List&lt;S&gt; <span class="title">save</span><span class="params">(Iterable&lt;S&gt; var1)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">flush</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    &lt;S extends T&gt; <span class="function">S <span class="title">saveAndFlush</span><span class="params">(S var1)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">deleteInBatch</span><span class="params">(Iterable&lt;T&gt; var1)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">deleteAllInBatch</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">T <span class="title">getOne</span><span class="params">(ID var1)</span></span>;</span><br><span class="line"></span><br><span class="line">    &lt;S extends T&gt; <span class="function">List&lt;S&gt; <span class="title">findAll</span><span class="params">(Example&lt;S&gt; var1)</span></span>;</span><br><span class="line"></span><br><span class="line">    &lt;S extends T&gt; <span class="function">List&lt;S&gt; <span class="title">findAll</span><span class="params">(Example&lt;S&gt; var1, Sort var2)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>自定义Repository：<strong>PersonRepository</strong>，并扩展数据访问方法，具体扩展方法参看示例代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.dao;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.model.Person;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.Page;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.Pageable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.jpa.repository.JpaRepository;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.jpa.repository.Modifying;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.jpa.repository.Query;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.repository.query.Param;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PersonRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">Person</span>, <span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1.以下方法基于属性名称和查询关键字，所以方法名称必须遵循命名规则，并且参数类型要与实体的参数类型一致。</span></span><br><span class="line">    <span class="comment">// 只用于查询方法，以下给出常用的示例</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//等于</span></span><br><span class="line">    <span class="function">List&lt;Person&gt; <span class="title">findByPName</span><span class="params">(String PName)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//And --- 等价于 SQL 中的 and 关键字；</span></span><br><span class="line">    <span class="function">List&lt;Person&gt; <span class="title">findByPNameAndPAge</span><span class="params">(String PName, Integer PAge)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Or --- 等价于 SQL 中的 or 关键字；</span></span><br><span class="line">    <span class="function">List&lt;Person&gt; <span class="title">findByPNameOrPAge</span><span class="params">(String PName, Integer PAge)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Between --- 等价于 SQL 中的 between 关键字；</span></span><br><span class="line">    <span class="function">List&lt;Person&gt; <span class="title">findByPAgeBetween</span><span class="params">(Integer min, Integer max)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//LessThan --- 等价于 SQL 中的 &quot;&lt;&quot;；  日期类型也可以使用Before关键字</span></span><br><span class="line">    <span class="function">List&lt;Person&gt; <span class="title">findByPAgeLessThan</span><span class="params">(Integer max)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//LessThanEqual --- 等价于 SQL 中的 &quot;&lt;=&quot;；</span></span><br><span class="line">    <span class="function">List&lt;Person&gt; <span class="title">findByPAgeLessThanEqual</span><span class="params">(Integer max)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//GreaterThan --- 等价于 SQL 中的&quot;&gt;&quot;；日期类型也可以使用After关键字</span></span><br><span class="line">    <span class="function">List&lt;Person&gt; <span class="title">findByPAgeGreaterThan</span><span class="params">(Integer min)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//GreaterThanEqual --- 等价于 SQL 中的&quot;&gt;=&quot;；</span></span><br><span class="line">    <span class="function">List&lt;Person&gt; <span class="title">findByPAgeGreaterThanEqual</span><span class="params">(Integer min)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//IsNull --- 等价于 SQL 中的 &quot;is null&quot;；</span></span><br><span class="line">    <span class="function">List&lt;Person&gt; <span class="title">findByPNameIsNull</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//IsNotNull --- 等价于 SQL 中的 &quot;is not null&quot;；</span></span><br><span class="line">    <span class="function">List&lt;Person&gt; <span class="title">findByPNameIsNotNull</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//NotNull --- 与 IsNotNull 等价；</span></span><br><span class="line">    <span class="function">List&lt;Person&gt; <span class="title">findByPNameNotNull</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Like --- 等价于 SQL 中的 &quot;like&quot;;</span></span><br><span class="line">    <span class="function">List&lt;Person&gt; <span class="title">findByPNameLike</span><span class="params">(String PName)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//NotLike --- 等价于 SQL 中的 &quot;not like&quot;；</span></span><br><span class="line">    <span class="function">List&lt;Person&gt; <span class="title">findByPNameNotLike</span><span class="params">(String PName)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//OrderBy --- 等价于 SQL 中的 &quot;order by&quot;；</span></span><br><span class="line">    <span class="function">List&lt;Person&gt; <span class="title">findByPNameNotNullOrderByPAgeAsc</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Not --- 等价于 SQL 中的 &quot;！ =&quot;；</span></span><br><span class="line">    <span class="function">List&lt;Person&gt; <span class="title">findByPNameNot</span><span class="params">(String PName)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//In --- 等价于 SQL 中的 &quot;in&quot;;</span></span><br><span class="line">    <span class="function">List&lt;Person&gt; <span class="title">findByPNameIn</span><span class="params">(String PName)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//NotIn --- 等价于 SQL 中的 &quot;not in&quot;;</span></span><br><span class="line">    <span class="function">List&lt;Person&gt; <span class="title">findByPNameNotIn</span><span class="params">(String PName)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//Top --- 查询符合条件的前两条记录，等价与First关键字</span></span><br><span class="line">    <span class="function">List&lt;Person&gt; <span class="title">findTop2ByPName</span><span class="params">(String PName)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.以下方法基于@Query注解，方法名称可以随意，可用于查询和更新方法，更新方法要设置@Modifying注解</span></span><br><span class="line">    <span class="comment">//使用命名参数</span></span><br><span class="line">    <span class="meta">@Query(&quot;select p from Person p where p.pName = :name and p.pAge = :age&quot;)</span></span><br><span class="line">    <span class="function">List&lt;Person&gt; <span class="title">withNameAndAgeQuery</span><span class="params">(<span class="meta">@Param(&quot;name&quot;)</span> String name, <span class="meta">@Param(&quot;age&quot;)</span> Integer age)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//使用参数索引</span></span><br><span class="line">    <span class="meta">@Query(&quot;select p from Person p where p.pName = ?1 and p.pAge = ?2&quot;)</span></span><br><span class="line">    <span class="function">List&lt;Person&gt; <span class="title">withNameAndAgeQuery2</span><span class="params">(String name, Integer age)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//删除操作，使用hql，如果要使用sql，需要增加nativeQuery = true</span></span><br><span class="line">    <span class="meta">@Query(value = &quot;delete from Person where pId=?1&quot;)</span></span><br><span class="line">    <span class="meta">@Modifying</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">deletePersonById</span><span class="params">(Integer id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//修改操作</span></span><br><span class="line">    <span class="meta">@Query(value = &quot;update Person set pName=?1 where pId=?2 &quot;)</span></span><br><span class="line">    <span class="meta">@Modifying</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">updatePersonName</span><span class="params">(String name, Integer id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//插入操作，使用sql操作</span></span><br><span class="line">    <span class="meta">@Query(value = &quot;insert into person(p_name,p_age) value(?1,?2)&quot;,nativeQuery = true)</span></span><br><span class="line">    <span class="meta">@Modifying</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">insertPersonByParam</span><span class="params">(String name, Integer age)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//3.以下方法实现分页查询功能，只需要在方法中增加Pageable pageable参数即可，返回结果为Page集合</span></span><br><span class="line">    <span class="function">Page&lt;Person&gt; <span class="title">findByPNameNot</span><span class="params">(String name, Pageable pageable)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//使用命名参数</span></span><br><span class="line">    <span class="meta">@Query(&quot;select p from Person p where p.pName = :name &quot;)</span></span><br><span class="line">    <span class="function">Page&lt;Person&gt; <span class="title">withNameQueryPage</span><span class="params">(<span class="meta">@Param(&quot;name&quot;)</span> String name, Pageable pageable)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>POJO实体对象：<strong>Person</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.model;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> javax.persistence.GenerationType.IDENTITY;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table(name = &quot;person&quot;</span></span><br><span class="line"><span class="meta">        , catalog = &quot;springboot1&quot;</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> <span class="keyword">implements</span> <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue(strategy = IDENTITY)</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;p_id&quot;, unique = true, nullable = false)</span></span><br><span class="line">    <span class="keyword">private</span> Integer pId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(name = &quot;p_name&quot;, length = 45)</span></span><br><span class="line">    <span class="keyword">private</span> String pName;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(name = &quot;p_age&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer pAge;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//setter and getter</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Person&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;pId=&quot;</span> + pId +</span><br><span class="line">                <span class="string">&quot;, pName=&#x27;&quot;</span> + pName + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, pAge=&quot;</span> + pAge +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="测试演示"><a href="#测试演示" class="headerlink" title="测试演示"></a>测试演示</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.dao.PersonRepository;</span><br><span class="line"><span class="keyword">import</span> com.example.model.Person;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.Page;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.PageRequest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.Pageable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.Sort;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JpaSingleDatasourceApplicationTests</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PersonRepository personRepository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findByPName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String name = <span class="string">&quot;王五&quot;</span>;</span><br><span class="line">        List&lt;Person&gt; list = personRepository.findByPName(name);</span><br><span class="line">        System.out.println(list.size());</span><br><span class="line">        <span class="keyword">for</span>(Person person : list)&#123;</span><br><span class="line">            System.out.println(person);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findByPNameAndPAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String name = <span class="string">&quot;王五&quot;</span>;</span><br><span class="line">        <span class="keyword">int</span> age = <span class="number">18</span>;</span><br><span class="line">        List&lt;Person&gt; list = personRepository.findByPNameAndPAge(name,age);</span><br><span class="line">        System.out.println(list.size());</span><br><span class="line">        <span class="keyword">for</span>(Person person : list)&#123;</span><br><span class="line">            System.out.println(person);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findByPNameOrPAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String name = <span class="string">&quot;王五&quot;</span>;</span><br><span class="line">        <span class="keyword">int</span> age = <span class="number">25</span>;</span><br><span class="line">        List&lt;Person&gt; list = personRepository.findByPNameOrPAge(name,age);</span><br><span class="line">        System.out.println(list.size());</span><br><span class="line">        <span class="keyword">for</span>(Person person : list)&#123;</span><br><span class="line">            System.out.println(person);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findTop2ByPName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String name = <span class="string">&quot;王五&quot;</span>;</span><br><span class="line">        List&lt;Person&gt; list = personRepository.findTop2ByPName(name);</span><br><span class="line">        System.out.println(list.size());</span><br><span class="line">        <span class="keyword">for</span>(Person person : list)&#123;</span><br><span class="line">            System.out.println(person);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">withNameAndAgeQuery</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String name = <span class="string">&quot;王五&quot;</span>;</span><br><span class="line">        <span class="keyword">int</span> age = <span class="number">18</span>;</span><br><span class="line">        List&lt;Person&gt; list = personRepository.withNameAndAgeQuery(name,age);</span><br><span class="line">        System.out.println(list.size());</span><br><span class="line">        <span class="keyword">for</span>(Person person : list)&#123;</span><br><span class="line">            System.out.println(person);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">withNameAndAgeQuery2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String name = <span class="string">&quot;王五&quot;</span>;</span><br><span class="line">        <span class="keyword">int</span> age = <span class="number">18</span>;</span><br><span class="line">        List&lt;Person&gt; list = personRepository.withNameAndAgeQuery2(name,age);</span><br><span class="line">        System.out.println(list.size());</span><br><span class="line">        <span class="keyword">for</span>(Person person : list)&#123;</span><br><span class="line">            System.out.println(person);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deletePersonById</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> id = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">int</span> result = personRepository.deletePersonById(id);</span><br><span class="line">        System.out.println(<span class="string">&quot;result = &quot;</span> + result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updatePersonName</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> id = <span class="number">1</span>;</span><br><span class="line">        String name = <span class="string">&quot;哈哈&quot;</span>;</span><br><span class="line">        <span class="keyword">int</span> result = personRepository.updatePersonName(name,id);</span><br><span class="line">        System.out.println(<span class="string">&quot;result = &quot;</span> + result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertPersonByParam</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> age = <span class="number">10</span>;</span><br><span class="line">        String name = <span class="string">&quot;哈哈&quot;</span>;</span><br><span class="line">        <span class="keyword">int</span> result = personRepository.insertPersonByParam(name,age);</span><br><span class="line">        System.out.println(<span class="string">&quot;result = &quot;</span> + result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findByPNameNot</span><span class="params">()</span></span>&#123;</span><br><span class="line">        String name = <span class="string">&quot;哈哈&quot;</span>;</span><br><span class="line">        <span class="comment">//排序</span></span><br><span class="line">        Sort sort = <span class="keyword">new</span> Sort(Sort.Direction.DESC, <span class="string">&quot;pId&quot;</span>);</span><br><span class="line">        <span class="comment">//查询第一页，按一页三行分页</span></span><br><span class="line">        Pageable pageable = <span class="keyword">new</span> PageRequest(<span class="number">0</span>, <span class="number">3</span>, sort);</span><br><span class="line"></span><br><span class="line">        Page&lt;Person&gt; pages = personRepository.findByPNameNot(name,pageable);</span><br><span class="line">        System.out.println(<span class="string">&quot;pages.getTotalElements()&quot;</span> + pages.getTotalElements());</span><br><span class="line">        System.out.println(<span class="string">&quot;pages.getTotalPages()&quot;</span> + pages.getTotalPages());</span><br><span class="line">        Iterator&lt;Person&gt; it=pages.iterator();</span><br><span class="line">        <span class="keyword">while</span>(it.hasNext())&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;value:&quot;</span>+((Person)it.next()));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">withNameQueryPage</span><span class="params">()</span></span>&#123;</span><br><span class="line">        String name = <span class="string">&quot;王五&quot;</span>;</span><br><span class="line">        <span class="comment">//排序</span></span><br><span class="line">        Sort sort = <span class="keyword">new</span> Sort(Sort.Direction.DESC, <span class="string">&quot;pId&quot;</span>);</span><br><span class="line">        <span class="comment">//查询第二页，按一页三行分页</span></span><br><span class="line">        Pageable pageable = <span class="keyword">new</span> PageRequest(<span class="number">1</span>, <span class="number">3</span>, sort);</span><br><span class="line"></span><br><span class="line">        Page&lt;Person&gt; pages = personRepository.withNameQueryPage(name,pageable);</span><br><span class="line">        System.out.println(<span class="string">&quot;pages.getTotalElements()&quot;</span> + pages.getTotalElements());</span><br><span class="line">        System.out.println(<span class="string">&quot;pages.getTotalPages()&quot;</span> + pages.getTotalPages());</span><br><span class="line">        Iterator&lt;Person&gt; it=pages.iterator();</span><br><span class="line">        <span class="keyword">while</span>(it.hasNext())&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;value:&quot;</span>+((Person)it.next()));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<hr>
<h2 id="Spring-Boot项目配置Spring-Data-JPA的方法"><a href="#Spring-Boot项目配置Spring-Data-JPA的方法" class="headerlink" title="Spring Boot项目配置Spring Data JPA的方法"></a>Spring Boot项目配置Spring Data JPA的方法</h2><p>如果不想依赖于<strong>spring-boot-starter-data-jpa</strong>，我们依然可以通过配置类来实现Spring Boot对Spring Data JPA的支持。</p>
<p><strong>pom</strong>替换依赖<br>这里说明一下，实际上我们可以不用替换掉<strong>spring-boot-starter-data-jpa</strong>的依赖，替换掉的好处仅仅是减少对不需要的jar的依赖。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.37<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.transaction<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jta<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.aspectj<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aspectjweaver<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.8.9<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- hibernate --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.hibernate<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hibernate-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.3.5.Final<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.hibernate<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hibernate-entitymanager<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.3.5.Final<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-orm<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.3.3.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.data<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-data-jpa<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.10.5.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">&lt;dependency&gt;</span></span><br><span class="line"><span class="comment">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span></span><br><span class="line"><span class="comment">    &lt;artifactId&gt;spring-boot-starter-data-jpa&lt;/artifactId&gt;</span></span><br><span class="line"><span class="comment">&lt;/dependency&gt;--&gt;</span></span><br></pre></td></tr></table></figure>

<p>自定义配置类：<strong>DataSourceConfig</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.hibernate.jpa.HibernatePersistenceProvider;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.jpa.repository.config.EnableJpaRepositories;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jdbc.datasource.DriverManagerDataSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.orm.jpa.JpaTransactionManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.orm.jpa.JpaVendorAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.orm.jpa.vendor.Database;</span><br><span class="line"><span class="keyword">import</span> org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.PlatformTransactionManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.EnableTransactionManagement;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement(proxyTargetClass = true)</span></span><br><span class="line"><span class="comment">//开启Spring Data JPA的支持</span></span><br><span class="line"><span class="meta">@EnableJpaRepositories(basePackages = &quot;com.example.dao&quot;, entityManagerFactoryRef = &quot;entityManagerFactory&quot;, transactionManagerRef = &quot;transactionManager&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSourceConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.datasource.driver-class-name&#125;&quot;)</span></span><br><span class="line">    String driverClass;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.datasource.url&#125;&quot;)</span></span><br><span class="line">    String url;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.datasource.username&#125;&quot;)</span></span><br><span class="line">    String userName;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.datasource.password&#125;&quot;)</span></span><br><span class="line">    String passWord;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;dataSource&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        DriverManagerDataSource dataSource = <span class="keyword">new</span> DriverManagerDataSource();</span><br><span class="line">        dataSource.setDriverClassName(driverClass);</span><br><span class="line">        dataSource.setUrl(url);</span><br><span class="line">        dataSource.setUsername(userName);</span><br><span class="line">        dataSource.setPassword(passWord);</span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  jpa事务管理器</span></span><br><span class="line">    <span class="meta">@Bean(name = &quot;transactionManager&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PlatformTransactionManager <span class="title">transactionManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        JpaTransactionManager jpaTransactionManager = <span class="keyword">new</span> JpaTransactionManager();</span><br><span class="line">        jpaTransactionManager.setDataSource(dataSource());</span><br><span class="line">        jpaTransactionManager.setEntityManagerFactory(entityManagerFactory().getObject());</span><br><span class="line">        <span class="keyword">return</span> jpaTransactionManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JpaVendorAdapter <span class="title">jpaVendorAdapter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        HibernateJpaVendorAdapter adapter = <span class="keyword">new</span> HibernateJpaVendorAdapter();</span><br><span class="line">        adapter.setShowSql(<span class="keyword">true</span>);</span><br><span class="line">        adapter.setDatabase(Database.MYSQL);</span><br><span class="line">        adapter.setGenerateDdl(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> adapter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;entityManagerFactory&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LocalContainerEntityManagerFactoryBean <span class="title">entityManagerFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        LocalContainerEntityManagerFactoryBean entityManager = <span class="keyword">new</span> LocalContainerEntityManagerFactoryBean();</span><br><span class="line">        entityManager.setDataSource(dataSource());</span><br><span class="line">        entityManager.setJpaVendorAdapter(jpaVendorAdapter());</span><br><span class="line">        entityManager.setPackagesToScan(<span class="string">&quot;com.example.model&quot;</span>);<span class="comment">// entity package</span></span><br><span class="line">        entityManager.setPersistenceProviderClass(HibernatePersistenceProvider.class);</span><br><span class="line">        <span class="keyword">return</span> entityManager;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>项目启动类中要关闭jpa的自动配置：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication(exclude = &#123;DataSourceAutoConfiguration.class,JpaRepositoriesAutoConfiguration.class, HibernateJpaAutoConfiguration.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JpaSingleDatasourceApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(JpaSingleDatasourceApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<hr>
<h2 id="Spring-Data-JPA与Atomikos整合实现多数据源事务管理"><a href="#Spring-Data-JPA与Atomikos整合实现多数据源事务管理" class="headerlink" title="Spring Data JPA与Atomikos整合实现多数据源事务管理"></a>Spring Data JPA与Atomikos整合实现多数据源事务管理</h2><p>spring-data-jpa虽说默认使用的是Hibernate，但是其与Atomikos整合方式与Hibernate略有不同。</p>
<p><strong>pom</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atomikos<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>transactions-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atomikos<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>transactions-jta<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atomikos<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>transactions<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atomikos<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>atomikos-util<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.transaction<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jta<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.aspectj<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aspectjweaver<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.8.9<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- hibernate --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.hibernate<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hibernate-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.3.5.Final<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-orm<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.3.3.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.data<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-data-jpa<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.10.5.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.hibernate<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hibernate-entitymanager<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.3.5.Final<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.37<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>application.properties</strong></p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment">#datasource</span></span><br><span class="line"><span class="string">spring.datasource.driver-class-name=com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="string">spring.datasource.url=jdbc:mysql://localhost:3306/springboot1?useUnicode=true&amp;characterEncoding=utf-8</span></span><br><span class="line"><span class="string">spring.datasource.username=root</span></span><br><span class="line"><span class="string">spring.datasource.password=newpwd</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#datasource2</span></span><br><span class="line"><span class="string">spring.datasource.driver-class-name2=com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="string">spring.datasource.url2=jdbc:mysql://localhost:3306/springboot2?useUnicode=true&amp;characterEncoding=utf-8</span></span><br><span class="line"><span class="string">spring.datasource.username2=root</span></span><br><span class="line"><span class="string">spring.datasource.password2=newpwd</span></span><br></pre></td></tr></table></figure>


<p><strong>MainConfig</strong>：用于注册Atomikos事务管理器</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atomikos.icatch.jta.UserTransactionImp;</span><br><span class="line"><span class="keyword">import</span> com.atomikos.icatch.jta.UserTransactionManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.DependsOn;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.PlatformTransactionManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.jta.JtaTransactionManager;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.transaction.TransactionManager;</span><br><span class="line"><span class="keyword">import</span> javax.transaction.UserTransaction;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;userTransaction&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserTransaction <span class="title">userTransaction</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        UserTransactionImp userTransactionImp = <span class="keyword">new</span> UserTransactionImp();</span><br><span class="line">        userTransactionImp.setTransactionTimeout(<span class="number">10000</span>);</span><br><span class="line">        <span class="keyword">return</span> userTransactionImp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;atomikosTransactionManager&quot;, initMethod = &quot;init&quot;, destroyMethod = &quot;close&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TransactionManager <span class="title">atomikosTransactionManager</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        UserTransactionManager userTransactionManager = <span class="keyword">new</span> UserTransactionManager();</span><br><span class="line">        userTransactionManager.setForceShutdown(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> userTransactionManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;transactionManager&quot;)</span></span><br><span class="line">    <span class="meta">@DependsOn(&#123; &quot;userTransaction&quot;, &quot;atomikosTransactionManager&quot; &#125;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PlatformTransactionManager <span class="title">transactionManager</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        UserTransaction userTransaction = userTransaction();</span><br><span class="line">        TransactionManager atomikosTransactionManager = atomikosTransactionManager();</span><br><span class="line">        JtaTransactionManager jtaTransactionManager = <span class="keyword">new</span> JtaTransactionManager(userTransaction, atomikosTransactionManager);</span><br><span class="line">        jtaTransactionManager.setAllowCustomIsolationLevels(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> jtaTransactionManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//上面三个都认识，下面说一下这个bean</span></span><br><span class="line">    <span class="meta">@Bean(name = &quot;atomikosJtaPlatfom&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AtomikosJtaPlatfom <span class="title">atomikosJtaPlatfom</span><span class="params">()</span></span>&#123;</span><br><span class="line">        AtomikosJtaPlatfom atomikosJtaPlatfom = <span class="keyword">new</span> AtomikosJtaPlatfom();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            atomikosJtaPlatfom.setTm(atomikosTransactionManager());</span><br><span class="line">            atomikosJtaPlatfom.setUt(userTransaction());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">            throwable.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> atomikosJtaPlatfom;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>配置JPA的LocalContainerEntityManagerFactoryBean时候，如果要使其能够支持JTA事务，则在配置其<strong>JpaProperties</strong>时需要为其指定如下参数：</p>
<blockquote>
<p>hibernate.transaction.jta.platform<br>hibernate.current_session_context_class<br>hibernate.transaction.factory_class</p>
</blockquote>
<p>后面我们配置LocalContainerEntityManagerFactoryBean的时候会看到相应的配置，<br>这里要说的是，<code>hibernate.transaction.jta.platform</code>需要指定<code>org.hibernate.engine.transaction.jta.platform.spi.JtaPlatform</code>的实现类，其主要功能就是要绑定<strong>javax.transaction.TransactionManager</strong>和<strong>javax.transaction.UserTransaction</strong>。</p>
<p>spring-data-jpa没有提供该实现类，但是hibernate提供了许多实现类，spring boot也提供了一个实现类–<strong>SpringJtaPlatform</strong>，<br>但是这些实现类都是通过构造函数绑定<strong>javax.transaction.TransactionManager</strong>和<strong>javax.transaction.UserTransaction</strong>，而没有提供缺省的构造方法，这就导致通过属性指定<code>hibernate.transaction.jta.platform</code>时，spring不能初始化该实现类（可能是我还没有搞明白吧）。</p>
<p>所以，可以自己创建一个实现类，并通过set方法来绑定<strong>javax.transaction.TransactionManager</strong>和<strong>javax.transaction.UserTransaction</strong>。<br>这就是<strong>AtomikosJtaPlatfom</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.hibernate.engine.transaction.jta.platform.internal.AbstractJtaPlatform;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.transaction.TransactionManager;</span><br><span class="line"><span class="keyword">import</span> javax.transaction.UserTransaction;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AtomikosJtaPlatfom</span> <span class="keyword">extends</span> <span class="title">AbstractJtaPlatform</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> UserTransaction ut;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> TransactionManager tm;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> TransactionManager <span class="title">locateTransactionManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> tm;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> UserTransaction <span class="title">locateUserTransaction</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ut;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserTransaction <span class="title">getUt</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ut;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUt</span><span class="params">(UserTransaction ut)</span> </span>&#123;</span><br><span class="line">        AtomikosJtaPlatfom.ut = ut;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TransactionManager <span class="title">getTm</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> tm;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTm</span><span class="params">(TransactionManager tm)</span> </span>&#123;</span><br><span class="line">        AtomikosJtaPlatfom.tm = tm;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>接下来需要在配置类中注册<strong>LocalContainerEntityManagerFactoryBean</strong>，<br>由于*@EnableJpaRepositories*注解不能在同一个配置类上声明两次，所以就按数据源进行分别设置：</p>
<p><strong>JpaConfigDs1</strong>：数据源1</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atomikos.jdbc.AtomikosDataSourceBean;</span><br><span class="line"><span class="keyword">import</span> com.mysql.jdbc.jdbc2.optional.MysqlXADataSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.DependsOn;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.jpa.repository.config.EnableJpaRepositories;</span><br><span class="line"><span class="keyword">import</span> org.springframework.orm.jpa.JpaVendorAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.orm.jpa.vendor.Database;</span><br><span class="line"><span class="keyword">import</span> org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.EnableTransactionManagement;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement(proxyTargetClass = true)</span></span><br><span class="line"><span class="comment">//指定数据源1的Repository路径，数据源1的entityManagerFactory，事务是公共事务</span></span><br><span class="line"><span class="meta">@EnableJpaRepositoryies(basePackages = &quot;com.example.dao.ds1&quot;, entityManagerFactoryRef = &quot;entityManagerFactory&quot;, transactionManagerRef = &quot;transactionManager&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JpaConfigDs1</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.datasource.driver-class-name&#125;&quot;)</span></span><br><span class="line">    String driverClass;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.datasource.url&#125;&quot;)</span></span><br><span class="line">    String url;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.datasource.username&#125;&quot;)</span></span><br><span class="line">    String userName;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.datasource.password&#125;&quot;)</span></span><br><span class="line">    String passWord;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;dataSource&quot;, initMethod = &quot;init&quot;, destroyMethod = &quot;close&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;dataSource init&quot;</span>);</span><br><span class="line">        MysqlXADataSource mysqlXaDataSource = <span class="keyword">new</span> MysqlXADataSource();</span><br><span class="line">        mysqlXaDataSource.setUrl(url);</span><br><span class="line">        mysqlXaDataSource.setPassword(passWord);</span><br><span class="line">        mysqlXaDataSource.setUser(userName);</span><br><span class="line">        mysqlXaDataSource.setPinGlobalTxToPhysicalConnection(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        AtomikosDataSourceBean xaDataSource = <span class="keyword">new</span> AtomikosDataSourceBean();</span><br><span class="line">        xaDataSource.setXaDataSource(mysqlXaDataSource);</span><br><span class="line">        xaDataSource.setUniqueResourceName(<span class="string">&quot;dataSource&quot;</span>);</span><br><span class="line">        xaDataSource.setMinPoolSize(<span class="number">10</span>);</span><br><span class="line">        xaDataSource.setPoolSize(<span class="number">10</span>);</span><br><span class="line">        xaDataSource.setMaxPoolSize(<span class="number">30</span>);</span><br><span class="line">        xaDataSource.setBorrowConnectionTimeout(<span class="number">60</span>);</span><br><span class="line">        xaDataSource.setReapTimeout(<span class="number">20</span>);</span><br><span class="line">        xaDataSource.setMaxIdleTime(<span class="number">60</span>);</span><br><span class="line">        xaDataSource.setMaintenanceInterval(<span class="number">60</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> xaDataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;jpaVendorAdapter&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JpaVendorAdapter <span class="title">jpaVendorAdapter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;jpaVendorAdapter init&quot;</span>);</span><br><span class="line">        HibernateJpaVendorAdapter adapter = <span class="keyword">new</span> HibernateJpaVendorAdapter();</span><br><span class="line">        adapter.setShowSql(<span class="keyword">true</span>);</span><br><span class="line">        adapter.setDatabase(Database.MYSQL);</span><br><span class="line">        adapter.setDatabasePlatform(<span class="string">&quot;org.hibernate.dialect.MySQLDialect&quot;</span>);</span><br><span class="line">        adapter.setGenerateDdl(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> adapter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;entityManagerFactory&quot;)</span></span><br><span class="line">    <span class="meta">@DependsOn(&#123;&quot;atomikosJtaPlatfom&quot;&#125;)</span> <span class="comment">//需要先注册atomikosJtaPlatfom</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LocalContainerEntityManagerFactoryBean <span class="title">entityManagerFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;entityManagerFactory init&quot;</span>);</span><br><span class="line">        LocalContainerEntityManagerFactoryBean entityManager = <span class="keyword">new</span> LocalContainerEntityManagerFactoryBean();</span><br><span class="line"></span><br><span class="line">        entityManager.setJpaVendorAdapter(jpaVendorAdapter());</span><br><span class="line">        <span class="comment">// entity package</span></span><br><span class="line">        entityManager.setPackagesToScan(<span class="string">&quot;com.example.model.ds1&quot;</span>);</span><br><span class="line">        entityManager.setJtaDataSource(dataSource());</span><br><span class="line"></span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        properties.put(<span class="string">&quot;hibernate.dialect&quot;</span>, <span class="string">&quot;org.hibernate.dialect.MySQLDialect&quot;</span>);</span><br><span class="line">        properties.put(<span class="string">&quot;hibernate.show_sql&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">        properties.put(<span class="string">&quot;hibernate.format_sql&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//jta设置</span></span><br><span class="line">        properties.put(<span class="string">&quot;hibernate.current_session_context_class&quot;</span>, <span class="string">&quot;jta&quot;</span>);</span><br><span class="line">        properties.put(<span class="string">&quot;hibernate.transaction.factory_class&quot;</span>, <span class="string">&quot;org.hibernate.engine.transaction.internal.jta.CMTTransactionFactory&quot;</span>);</span><br><span class="line">        <span class="comment">//这里指定我们自己创建的AtomikosJtaPlatfom</span></span><br><span class="line">        properties.put(<span class="string">&quot;hibernate.transaction.jta.platform&quot;</span>,<span class="string">&quot;com.example.AtomikosJtaPlatfom&quot;</span>);</span><br><span class="line">        entityManager.setJpaProperties(properties);</span><br><span class="line">        <span class="keyword">return</span> entityManager;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p><strong>JpaConfigDs2</strong>：数据源2</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atomikos.jdbc.AtomikosDataSourceBean;</span><br><span class="line"><span class="keyword">import</span> com.mysql.jdbc.jdbc2.optional.MysqlXADataSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.DependsOn;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.jpa.repository.config.EnableJpaRepositories;</span><br><span class="line"><span class="keyword">import</span> org.springframework.orm.jpa.JpaVendorAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.orm.jpa.vendor.Database;</span><br><span class="line"><span class="keyword">import</span> org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.EnableTransactionManagement;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement(proxyTargetClass = true)</span></span><br><span class="line"><span class="meta">@EnableJpaRepositories(basePackages = &quot;com.example.dao.ds2&quot;, entityManagerFactoryRef = &quot;entityManagerFactory2&quot;, transactionManagerRef = &quot;transactionManager&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JpaConfigDs2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.datasource.driver-class-name2&#125;&quot;)</span></span><br><span class="line">    String driverClass;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.datasource.url2&#125;&quot;)</span></span><br><span class="line">    String url;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.datasource.username2&#125;&quot;)</span></span><br><span class="line">    String userName;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.datasource.password2&#125;&quot;)</span></span><br><span class="line">    String passWord;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;dataSource2&quot;, initMethod = &quot;init&quot;, destroyMethod = &quot;close&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;dataSource2 init&quot;</span>);</span><br><span class="line">        MysqlXADataSource mysqlXaDataSource = <span class="keyword">new</span> MysqlXADataSource();</span><br><span class="line">        mysqlXaDataSource.setUrl(url);</span><br><span class="line">        mysqlXaDataSource.setPassword(passWord);</span><br><span class="line">        mysqlXaDataSource.setUser(userName);</span><br><span class="line">        mysqlXaDataSource.setPinGlobalTxToPhysicalConnection(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        AtomikosDataSourceBean xaDataSource = <span class="keyword">new</span> AtomikosDataSourceBean();</span><br><span class="line">        xaDataSource.setXaDataSource(mysqlXaDataSource);</span><br><span class="line">        xaDataSource.setUniqueResourceName(<span class="string">&quot;dataSource2&quot;</span>);</span><br><span class="line">        xaDataSource.setMinPoolSize(<span class="number">10</span>);</span><br><span class="line">        xaDataSource.setPoolSize(<span class="number">10</span>);</span><br><span class="line">        xaDataSource.setMaxPoolSize(<span class="number">30</span>);</span><br><span class="line">        xaDataSource.setBorrowConnectionTimeout(<span class="number">60</span>);</span><br><span class="line">        xaDataSource.setReapTimeout(<span class="number">20</span>);</span><br><span class="line">        xaDataSource.setMaxIdleTime(<span class="number">60</span>);</span><br><span class="line">        xaDataSource.setMaintenanceInterval(<span class="number">60</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> xaDataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;jpaVendorAdapter2&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JpaVendorAdapter <span class="title">jpaVendorAdapter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;jpaVendorAdapter2 init&quot;</span>);</span><br><span class="line">        HibernateJpaVendorAdapter adapter = <span class="keyword">new</span> HibernateJpaVendorAdapter();</span><br><span class="line">        adapter.setShowSql(<span class="keyword">true</span>);</span><br><span class="line">        adapter.setDatabase(Database.MYSQL);</span><br><span class="line">        adapter.setDatabasePlatform(<span class="string">&quot;org.hibernate.dialect.MySQLDialect&quot;</span>);</span><br><span class="line">        adapter.setGenerateDdl(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> adapter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;entityManagerFactory2&quot;)</span></span><br><span class="line">    <span class="meta">@DependsOn(&#123;&quot;atomikosJtaPlatfom&quot;&#125;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LocalContainerEntityManagerFactoryBean <span class="title">entityManagerFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;entityManagerFactory2 init&quot;</span>);</span><br><span class="line">        LocalContainerEntityManagerFactoryBean entityManager = <span class="keyword">new</span> LocalContainerEntityManagerFactoryBean();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        entityManager.setJpaVendorAdapter(jpaVendorAdapter());</span><br><span class="line">        entityManager.setPackagesToScan(<span class="string">&quot;com.example.model.ds2&quot;</span>);<span class="comment">// entity package</span></span><br><span class="line">        entityManager.setJtaDataSource(dataSource());</span><br><span class="line"></span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        properties.put(<span class="string">&quot;hibernate.transaction.jta.platform&quot;</span>,<span class="string">&quot;com.example.AtomikosJtaPlatfom&quot;</span>);</span><br><span class="line"></span><br><span class="line">        properties.put(<span class="string">&quot;hibernate.dialect&quot;</span>, <span class="string">&quot;org.hibernate.dialect.MySQLDialect&quot;</span>);</span><br><span class="line">        properties.put(<span class="string">&quot;hibernate.show_sql&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">        properties.put(<span class="string">&quot;hibernate.format_sql&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">        properties.put(<span class="string">&quot;hibernate.current_session_context_class&quot;</span>, <span class="string">&quot;jta&quot;</span>);</span><br><span class="line">        properties.put(<span class="string">&quot;hibernate.transaction.factory_class&quot;</span>, <span class="string">&quot;org.hibernate.engine.transaction.internal.jta.CMTTransactionFactory&quot;</span>);</span><br><span class="line"></span><br><span class="line">        entityManager.setJpaProperties(properties);</span><br><span class="line">        <span class="keyword">return</span> entityManager;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其它方面与单数据源使用JPA没有区别，这里就不罗列代码了。</p>
<hr>
<h2 id="扩展JPA的方法"><a href="#扩展JPA的方法" class="headerlink" title="扩展JPA的方法"></a>扩展JPA的方法</h2><p>上面我们介绍过，一般情况下我们的Repository接口继承JpaRepository，所以可以默认使用JpaRepository提供的所有方法，如果提供的方法不满足需求时，可以在自己的Repository中通过命名规则或者@Query注解等实现方法的扩展。那么，我们如果希望将一些自己扩展公共的方法放在父类中，以便我们所有的Repository都能拥有该扩展功能，该如何实现呢？</p>
<p>本例只举例说明，实现的功能为接收查询条件的分页查询，查询时按传递实体对象的属性进行处理，如果是字符串就按模糊匹配，否则就按精确匹配。</p>
<h3 id="定义父类接口–BaseJpaRepository"><a href="#定义父类接口–BaseJpaRepository" class="headerlink" title="定义父类接口–BaseJpaRepository"></a>定义父类接口–BaseJpaRepository</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@NoRepositoryBean</span> <span class="comment">//说明这不是一个需要被扫描到的Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BaseJpaRepository</span>&lt;<span class="title">T</span>, <span class="title">ID</span> <span class="keyword">extends</span> <span class="title">Serializable</span>&gt; <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">T</span>, <span class="title">ID</span>&gt;,<span class="title">JpaSpecificationExecutor</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">Page&lt;T&gt; <span class="title">findByAuto</span><span class="params">(T example, Pageable pageable)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="创建实现类–BaseJpaRepositoryImpl"><a href="#创建实现类–BaseJpaRepositoryImpl" class="headerlink" title="创建实现类–BaseJpaRepositoryImpl"></a>创建实现类–BaseJpaRepositoryImpl</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseJpaRepositoryImpl</span>&lt;<span class="title">T</span>, <span class="title">ID</span> <span class="keyword">extends</span> <span class="title">Serializable</span>&gt; <span class="keyword">extends</span> <span class="title">SimpleJpaRepository</span>&lt;<span class="title">T</span>, <span class="title">ID</span>&gt; <span class="keyword">implements</span> <span class="title">BaseJpaRepository</span>&lt;<span class="title">T</span>, <span class="title">ID</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//通过构造方法初始化EntityManager</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> EntityManager entityManager;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BaseJpaRepositoryImpl</span><span class="params">(Class&lt;T&gt; domainClass, EntityManager entityManager)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(domainClass, entityManager);</span><br><span class="line">        <span class="keyword">this</span>.entityManager = entityManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//具体方法实现，这里使用了一个自定义工具类BaseSpecs</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Page&lt;T&gt; <span class="title">findByAuto</span><span class="params">(T example, Pageable pageable)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> findAll(BaseSpecs.byAuto(entityManager,example),pageable);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BaseSpecs的byAuto方法负责封装查询对象Specification，按传递实体对象的属性进行处理，如果是字符串就按模糊匹配，否则就按精确匹配。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseSpecs</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">Specification&lt;T&gt; <span class="title">byAuto</span><span class="params">(<span class="keyword">final</span> EntityManager entityManager, <span class="keyword">final</span> T example)</span></span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Class&lt;T&gt; type = (Class&lt;T&gt;) example.getClass();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Specification&lt;T&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Predicate <span class="title">toPredicate</span><span class="params">(Root&lt;T&gt; root, CriteriaQuery&lt;?&gt; criteriaQuery, CriteriaBuilder criteriaBuilder)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">                List&lt;Predicate&gt; predicateList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">                EntityType&lt;T&gt; entityType = entityManager.getMetamodel().entity(type);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span>(Attribute&lt;T,?&gt; attribute : entityType.getDeclaredAttributes())&#123;</span><br><span class="line">                    Object attrValue = getValue(example,attribute);</span><br><span class="line">                    <span class="keyword">if</span>(attrValue != <span class="keyword">null</span>)&#123;</span><br><span class="line">                        <span class="keyword">if</span>(attribute.getJavaType() == String.class)&#123;</span><br><span class="line">                            <span class="keyword">if</span>(!StringUtils.isEmpty(attrValue))&#123;</span><br><span class="line">                                predicateList.add(criteriaBuilder.like(root.get(attribute(entityType,attribute.getName(),String.class)),pattern((String)attrValue)));</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                            predicateList.add(criteriaBuilder.equal(root.get(attribute(entityType,attribute.getName(),attrValue.getClass())),attrValue));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> predicateList.isEmpty()?criteriaBuilder.conjunction():criteriaBuilder.and(toArray(predicateList));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">private</span> &lt;T&gt; <span class="function">Object <span class="title">getValue</span><span class="params">(T example,Attribute&lt;T,?&gt; attr)</span></span>&#123;</span><br><span class="line">                <span class="keyword">return</span> ReflectionUtils.getField((Field)attr.getJavaMember(),example);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">private</span> &lt;E,T&gt; <span class="function">SingularAttribute&lt;T,E&gt; <span class="title">attribute</span><span class="params">(EntityType&lt;T&gt; entityType,String fieldName,Class&lt;E&gt; fieldClass)</span></span>&#123;</span><br><span class="line">                <span class="keyword">return</span> entityType.getDeclaredSingularAttribute(fieldName,fieldClass);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">private</span> Predicate[] toArray(List&lt;Predicate&gt; predicateList)&#123;</span><br><span class="line">                Predicate[] array = predicateList.toArray(<span class="keyword">new</span> Predicate[predicateList.size()]);</span><br><span class="line">                <span class="keyword">return</span> array;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">private</span> String <span class="title">pattern</span><span class="params">(String str)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;%&quot;</span> + str + <span class="string">&quot;%&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<hr>
<p><strong>说明</strong><br>当我们的Repository实现的是JpaRepository的时候，<em>Spring-data-jpa</em>会为我们动态使用JpaRepository的实现类<em>SimpleJpaRepository</em>，这也是为什么我们只需要创建接口而不需要提供实现类。</p>
<p>这里，我们创建了新的父类接口<em>BaseJpaRepository</em>，并为其提供了实现类<em>BaseJpaRepositoryImpl</em>，所以我们要告诉<em>Spring-data-jpa</em>要使用我们自己的实现类，而不能去使用<em>SimpleJpaRepository</em>，所以我们要改写<em>JpaRepositoryFactoryBean</em>；</p>
<p>创建一个<strong>BaseRepositoryFactoryBean</strong>继承于<em>JpaRepositoryFactoryBean</em>：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseRepositoryFactoryBean</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">S</span>, <span class="title">ID</span>&gt;, <span class="title">S</span>, <span class="title">ID</span> <span class="keyword">extends</span> <span class="title">Serializable</span>&gt;   <span class="keyword">extends</span> <span class="title">JpaRepositoryFactoryBean</span>&lt;<span class="title">T</span>,<span class="title">S</span>,<span class="title">ID</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> RepositoryFactorySupport <span class="title">createRepositoryFactory</span><span class="params">(EntityManager entityManager)</span>    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BaseRepositoryFactory(entityManager);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseRepositoryFactory</span> <span class="keyword">extends</span> <span class="title">JpaRepositoryFactory</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BaseRepositoryFactory</span><span class="params">(EntityManager entityManager)</span></span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(entityManager);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//指定实现类</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> &lt;T, ID extends Serializable&gt; SimpleJpaRepository&lt;?, ?&gt; getTargetRepository(RepositoryInformation information, EntityManager entityManager) &#123;</span><br><span class="line">        BaseJpaRepositoryImpl customRepository = <span class="keyword">new</span> BaseJpaRepositoryImpl&lt;T,ID&gt;((Class&lt;T&gt;)information.getDomainType(),entityManager);</span><br><span class="line">        <span class="keyword">return</span> customRepository;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//指定实现类类型</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; getRepositoryBaseClass(RepositoryMetadata metadata)</span><br><span class="line">        <span class="keyword">return</span> BaseJpaRepositoryImpl.class;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>并且在*@EnableJpaRepositories*注解中进行指定：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@EnableJpaRepositories(basePackages = &quot;com.example.dao&quot;, entityManagerFactoryRef = &quot;entityManagerFactory&quot;, transactionManagerRef = &quot;transactionManager&quot;,repositoryFactoryBeanClass=BaseRepositoryFactoryBean.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JpaConfig</span> </span>&#123;</span><br><span class="line">    <span class="comment">//………………</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="自定义Repository继承BaseJpaRepository"><a href="#自定义Repository继承BaseJpaRepository" class="headerlink" title="自定义Repository继承BaseJpaRepository"></a>自定义Repository继承BaseJpaRepository</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PersonRepository</span> <span class="keyword">extends</span> <span class="title">BaseJpaRepository</span>&lt;<span class="title">Person</span>, <span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">//………依然可以在该接口中对功能进行扩展………</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JpaExtendApplicationTests</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PersonRepository personRepository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findByAuto</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Person person = <span class="keyword">new</span> Person();</span><br><span class="line">        person.setpName(<span class="string">&quot;王五&quot;</span>);</span><br><span class="line">        person.setpAge(<span class="number">18</span>);</span><br><span class="line">        Sort sort = <span class="keyword">new</span> Sort(Sort.Direction.DESC, <span class="string">&quot;pId&quot;</span>);</span><br><span class="line">        <span class="comment">//查询第一页，按一页三行分页</span></span><br><span class="line">        Pageable pageable = <span class="keyword">new</span> PageRequest(<span class="number">0</span>, <span class="number">3</span>, sort);</span><br><span class="line">        Page&lt;Person&gt; list = personRepository.findByAuto(person,pageable);</span><br><span class="line">        <span class="keyword">for</span>(Person p:list)&#123;</span><br><span class="line">            System.out.println(p);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p>本文示例代码下载地址：<a href="https://github.com/hanqunfeng/SpringBootStudy">https://github.com/hanqunfeng/SpringBootStudy</a></p>
]]></content>
      <categories>
        <category>技术</category>
        <category>Java</category>
        <category>springboot</category>
      </categories>
      <tags>
        <tag>Spring Boot</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Boot学习笔记05--Mybatis+通用Mapper+分页插件</title>
    <url>/2016/12/20/spring-boot-study-mybatis/</url>
    <content><![CDATA[<h2 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h2><p>看完本文你将掌握如下知识点：</p>
<ol>
<li>Spring Boot项目中，Mybatis+通用Mapper+分页插件的配置方法</li>
</ol>
<span id="more"></span>

<hr>
<p><strong>SpringBoot系列</strong>：<a href="/tags/Spring-Boot/">Spring Boot学习笔记</a></p>
<hr>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>前文已经对Spring Boot中各种类型的数据访问做了说明，本文是对Spring Boot中使用Mybatis的扩展，重点说明如何在mybatis中集成通用Mapper和分页插件。</p>
<p>本文代码是在上文中讲到的mybatis单数据源配置的基础上进行扩展。</p>
<h2 id="配置说明"><a href="#配置说明" class="headerlink" title="配置说明"></a>配置说明</h2><p><strong>pom</strong>中增加通用Mapper和分页插件的依赖：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--分页插件--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.pagehelper<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>pagehelper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--通用Mapper--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>tk.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mapper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.3.9<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>MyBatisConfig</strong>：在SqlSessionFactory中增加分页插件配置，因为通用Mapper是基于注解的，所以这里去掉xml的加载。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean(name = &quot;sqlSessionFactory&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> SqlSessionFactory <span class="title">sqlSessionFactoryBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    SqlSessionFactoryBean bean = <span class="keyword">new</span> SqlSessionFactoryBean();</span><br><span class="line">    bean.setDataSource(dataSource());</span><br><span class="line"></span><br><span class="line">    bean.setTypeAliasesPackage(<span class="string">&quot;com.example.pojo&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//分页插件设置</span></span><br><span class="line">    PageHelper pageHelper = <span class="keyword">new</span> PageHelper();</span><br><span class="line">    Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">    properties.setProperty(<span class="string">&quot;reasonable&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">    properties.setProperty(<span class="string">&quot;supportMethodsArguments&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">    properties.setProperty(<span class="string">&quot;returnPageInfo&quot;</span>, <span class="string">&quot;check&quot;</span>);</span><br><span class="line">    properties.setProperty(<span class="string">&quot;params&quot;</span>, <span class="string">&quot;count=countSql&quot;</span>);</span><br><span class="line">    pageHelper.setProperties(properties);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//添加分页插件</span></span><br><span class="line">    bean.setPlugins(<span class="keyword">new</span> Interceptor[]&#123;pageHelper&#125;);</span><br><span class="line"></span><br><span class="line">    ResourcePatternResolver resolver = <span class="keyword">new</span> PathMatchingResourcePatternResolver();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//基于注解扫描Mapper，不需配置xml路径</span></span><br><span class="line">        <span class="comment">//bean.setMapperLocations(resolver.getResources(&quot;classpath:mapper/*.xml&quot;));</span></span><br><span class="line">        <span class="keyword">return</span> bean.getObject();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p><strong>MyBatisMapperScannerConfig</strong><br>注意这里使用的是<strong>tk.mybatis.spring.mapper.MapperScannerConfigurer</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.AutoConfigureAfter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> tk.mybatis.spring.mapper.MapperScannerConfigurer;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">//必须在MyBatisConfig注册后再加载MapperScannerConfigurer，否则会报错</span></span><br><span class="line"><span class="meta">@AutoConfigureAfter(MyBatisConfig.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBatisMapperScannerConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MapperScannerConfigurer <span class="title">mapperScannerConfigurer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        MapperScannerConfigurer mapperScannerConfigurer = <span class="keyword">new</span> MapperScannerConfigurer();</span><br><span class="line">        mapperScannerConfigurer.setSqlSessionFactoryBeanName(<span class="string">&quot;sqlSessionFactory&quot;</span>);</span><br><span class="line">        mapperScannerConfigurer.setBasePackage(<span class="string">&quot;com.example.mapper&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//初始化扫描器的相关配置，这里我们要创建一个Mapper的父类</span></span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        properties.setProperty(<span class="string">&quot;mappers&quot;</span>, <span class="string">&quot;com.example.MyMapper&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;notEmpty&quot;</span>, <span class="string">&quot;false&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;IDENTITY&quot;</span>, <span class="string">&quot;MYSQL&quot;</span>);</span><br><span class="line"></span><br><span class="line">        mapperScannerConfigurer.setProperties(properties);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> mapperScannerConfigurer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>MyMapper</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> tk.mybatis.mapper.common.Mapper;</span><br><span class="line"><span class="keyword">import</span> tk.mybatis.mapper.common.MySqlMapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MyMapper</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">Mapper</span>&lt;<span class="title">T</span>&gt;, <span class="title">MySqlMapper</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">//TODO</span></span><br><span class="line">    <span class="comment">//FIXME 特别注意，该接口不能被扫描到，否则会出错</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p><strong>PersonMapper</strong>：实体mapper继承<em>MyMapper</em>即可，业务方法中我们就可以使用通用Mapper提供的各种方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.MyMapper;</span><br><span class="line"><span class="keyword">import</span> com.example.pojo.Person;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PersonMapper</span> <span class="keyword">extends</span> <span class="title">MyMapper</span>&lt;<span class="title">Person</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//以下方法用于演示，当通用Mapper不能买足需求时，可以自己扩展相应的方法</span></span><br><span class="line">    <span class="comment">//不允许查询参数为空的情况</span></span><br><span class="line">    <span class="meta">@Select(&#123;</span></span><br><span class="line"><span class="meta">            &quot;select&quot;,</span></span><br><span class="line"><span class="meta">            &quot;p_id, p_name, p_age&quot;,</span></span><br><span class="line"><span class="meta">            &quot;from person&quot;,</span></span><br><span class="line"><span class="meta">            &quot;where  p_age between #&#123;startAge&#125; and #&#123;endAge&#125;&quot;</span></span><br><span class="line"><span class="meta">    &#125;)</span></span><br><span class="line">    <span class="meta">@Results(&#123;</span></span><br><span class="line"><span class="meta">            @Result(column=&quot;p_id&quot;, property=&quot;pId&quot;, jdbcType= JdbcType.INTEGER, id=true),</span></span><br><span class="line"><span class="meta">            @Result(column=&quot;p_name&quot;, property=&quot;pName&quot;, jdbcType=JdbcType.VARCHAR),</span></span><br><span class="line"><span class="meta">            @Result(column=&quot;p_age&quot;, property=&quot;pAge&quot;, jdbcType=JdbcType.INTEGER)</span></span><br><span class="line"><span class="meta">    &#125;)</span></span><br><span class="line">    <span class="function">List&lt;Person&gt; <span class="title">queryListByParam</span><span class="params">(Person person)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//允许查询参数为空的情况</span></span><br><span class="line">    <span class="meta">@SelectProvider(type = PersonSqlProvider.class,method = &quot;selectSelective&quot;)</span></span><br><span class="line">    <span class="meta">@Results(&#123;</span></span><br><span class="line"><span class="meta">            @Result(column=&quot;p_id&quot;, property=&quot;pId&quot;, jdbcType= JdbcType.INTEGER, id=true),</span></span><br><span class="line"><span class="meta">            @Result(column=&quot;p_name&quot;, property=&quot;pName&quot;, jdbcType=JdbcType.VARCHAR),</span></span><br><span class="line"><span class="meta">            @Result(column=&quot;p_age&quot;, property=&quot;pAge&quot;, jdbcType=JdbcType.INTEGER)</span></span><br><span class="line"><span class="meta">    &#125;)</span></span><br><span class="line">    <span class="function">List&lt;Person&gt; <span class="title">queryListByParamSelective</span><span class="params">(Person person)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.pojo.Person;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.apache.ibatis.jdbc.SqlBuilder.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PersonSqlProvider</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">selectSelective</span><span class="params">(Person record)</span></span>&#123;</span><br><span class="line">        BEGIN();</span><br><span class="line"></span><br><span class="line">        SELECT(<span class="string">&quot;p_id, p_name, p_age&quot;</span>);</span><br><span class="line">        FROM(<span class="string">&quot;person&quot;</span>);</span><br><span class="line">        WHERE(<span class="string">&quot;1=1&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(record.getStartAge()!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            AND();</span><br><span class="line">            WHERE(<span class="string">&quot;p_age &gt;= #&#123;startAge&#125;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(record.getEndAge()!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            AND();</span><br><span class="line">            WHERE(<span class="string">&quot;p_age &lt;= #&#123;endAge&#125;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> SQL();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里要注意，使用通用<strong>Mapper</strong>时，实体类必须有一个叫做<strong>id</strong>的整型主键，另外，为了方便使用分页插件，要在每个实体对象中定义两个属性–<em>page</em>和<em>rows</em>，我们可以把这些通用的属性放到父类中，比如我们创建一个父类：BaseEntity</p>
<p><strong>BaseEntity</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.persistence.Transient;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseEntity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="comment">//注意，如果是老的项目，表中的主键可能不叫做id，这时可以在父类中去掉这个属性，改在子类中实现</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;id&quot;)</span></span><br><span class="line">    <span class="meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span></span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transient</span></span><br><span class="line">    <span class="keyword">private</span> Integer page = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transient</span></span><br><span class="line">    <span class="keyword">private</span> Integer rows = <span class="number">10</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.persistence.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Table(name = &quot;person&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> <span class="keyword">extends</span> <span class="title">BaseEntity</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String pName;</span><br><span class="line">    <span class="keyword">private</span> Integer pAge;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//以下属性用于演示范围查询</span></span><br><span class="line">    <span class="meta">@Transient</span></span><br><span class="line">    <span class="keyword">private</span> Integer startAge;</span><br><span class="line">    <span class="meta">@Transient</span></span><br><span class="line">    <span class="keyword">private</span> Integer endAge;</span><br><span class="line">    <span class="comment">//setter and getter</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="测试演示"><a href="#测试演示" class="headerlink" title="测试演示"></a>测试演示</h3><p><strong>业务方法</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.mapper.PersonMapper;</span><br><span class="line"><span class="keyword">import</span> com.example.pojo.Person;</span><br><span class="line"><span class="keyword">import</span> com.github.pagehelper.PageHelper;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.RowBounds;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Propagation;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Transactional(propagation = Propagation.REQUIRED, readOnly = false, rollbackFor = &#123;Exception.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PersonService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PersonMapper personMapper;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">insert</span><span class="params">(Person person)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> personMapper.insert(person);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional(readOnly = true)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Person <span class="title">selectByPrimaryKey</span><span class="params">(Integer pId)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> personMapper.selectByPrimaryKey(pId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional(readOnly = true)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Person&gt; <span class="title">getAllPersonList</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> personMapper.selectAll();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional(readOnly = true)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Person&gt; <span class="title">getPagePersonList</span><span class="params">(Person person, RowBounds rowBounds)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> personMapper.selectByRowBounds(person,rowBounds);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Person&gt; <span class="title">getPagePersonList</span><span class="params">(Person person)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (person.getPage() != <span class="keyword">null</span> &amp;&amp; person.getRows() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            PageHelper.startPage(person.getPage(), person.getRows(), <span class="string">&quot;p_id&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> personMapper.selectAll();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Person&gt; <span class="title">queryListByParam</span><span class="params">(Person person)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (person.getPage() != <span class="keyword">null</span> &amp;&amp; person.getRows() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            PageHelper.startPage(person.getPage(), person.getRows(), <span class="string">&quot;p_id&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> personMapper.queryListByParam(person);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Person&gt; <span class="title">queryListByParamSelective</span><span class="params">(Person person)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (person.getPage() != <span class="keyword">null</span> &amp;&amp; person.getRows() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            PageHelper.startPage(person.getPage(), person.getRows(), <span class="string">&quot;p_id&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> personMapper.queryListByParamSelective(person);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>单元测试</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.pojo.Person;</span><br><span class="line"><span class="keyword">import</span> com.example.service.PersonService;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.RowBounds;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MybatisMapperPagehelperApplicationTests</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    PersonService personService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">selectByPrimaryKey</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Person person = personService.selectByPrimaryKey(<span class="number">1</span>);</span><br><span class="line">        System.out.println(person);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insert</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Person person = <span class="keyword">new</span> Person();</span><br><span class="line">        person.setpName(<span class="string">&quot;王五&quot;</span>);</span><br><span class="line">        person.setpAge(<span class="number">18</span>);</span><br><span class="line">        System.out.println(personService.insert(person));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getAllPersonList</span><span class="params">()</span></span>&#123;</span><br><span class="line">        List&lt;Person&gt; list = personService.getAllPersonList();</span><br><span class="line">        System.out.println(list.size());</span><br><span class="line">        <span class="keyword">for</span>(Person person : list)&#123;</span><br><span class="line">            System.out.println(person);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getPagePersonList</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Person person = <span class="keyword">new</span> Person();</span><br><span class="line">        person.setpName(<span class="string">&quot;王五&quot;</span>);</span><br><span class="line">        <span class="comment">//指定limit和offset</span></span><br><span class="line">        List&lt;Person&gt; list = personService.getPagePersonList(person,<span class="keyword">new</span> RowBounds(<span class="number">2</span>,<span class="number">3</span>));</span><br><span class="line">        System.out.println(list.size());</span><br><span class="line">        <span class="keyword">for</span>(Person p : list)&#123;</span><br><span class="line">            System.out.println(p);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getPagePersonList2</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Person person = <span class="keyword">new</span> Person();</span><br><span class="line">        <span class="comment">//每页2行，查询第二页</span></span><br><span class="line">        person.setPage(<span class="number">2</span>);</span><br><span class="line">        person.setRows(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        List&lt;Person&gt; list = personService.getPagePersonList(person);</span><br><span class="line">        System.out.println(list.size());</span><br><span class="line">        <span class="keyword">for</span>(Person p : list)&#123;</span><br><span class="line">            System.out.println(p);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">queryListByParam</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Person person = <span class="keyword">new</span> Person();</span><br><span class="line">        <span class="comment">//每页2行，查询第二页</span></span><br><span class="line">        person.setPage(<span class="number">2</span>);</span><br><span class="line">        person.setRows(<span class="number">2</span>);</span><br><span class="line">        <span class="comment">//查询年龄在15到22之间的数据</span></span><br><span class="line">        person.setStartAge(<span class="number">15</span>);</span><br><span class="line">        person.setEndAge(<span class="number">22</span>);</span><br><span class="line"></span><br><span class="line">        List&lt;Person&gt; list = personService.queryListByParam(person);</span><br><span class="line">        System.out.println(list.size());</span><br><span class="line">        <span class="keyword">for</span>(Person p : list)&#123;</span><br><span class="line">            System.out.println(p);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">queryListByParamSelective</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Person person = <span class="keyword">new</span> Person();</span><br><span class="line">        <span class="comment">//每页2行，查询第一页</span></span><br><span class="line">        person.setPage(<span class="number">1</span>);</span><br><span class="line">        person.setRows(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//查询年龄大于等于15的数据</span></span><br><span class="line">        person.setStartAge(<span class="number">15</span>);</span><br><span class="line">        <span class="comment">//person.setEndAge(22);</span></span><br><span class="line"></span><br><span class="line">        List&lt;Person&gt; list = personService.queryListByParamSelective(person);</span><br><span class="line">        System.out.println(list.size());</span><br><span class="line">        <span class="keyword">for</span>(Person p : list)&#123;</span><br><span class="line">            System.out.println(p);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p>本文示例代码下载地址：<a href="https://github.com/hanqunfeng/SpringBootStudy">https://github.com/hanqunfeng/SpringBootStudy</a></p>
<p>项目参考：<a href="https://github.com/abel533/MyBatis-Spring-Boot">https://github.com/abel533/MyBatis-Spring-Boot</a></p>
]]></content>
      <categories>
        <category>技术</category>
        <category>Java</category>
        <category>springboot</category>
      </categories>
      <tags>
        <tag>Spring Boot</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Boot学习笔记04--数据访问</title>
    <url>/2016/12/17/spring-boot-study-data/</url>
    <content><![CDATA[<h2 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h2><p>看完本文你将掌握如下知识点：</p>
<ol>
<li>Spring Boot对JDBC的支持</li>
<li>Spring Boot项目多数据源的配置</li>
<li>Spring Boot的事务管理</li>
<li>Spring Boot项目多数据源的事务管理</li>
<li>Spring Boot项目中使用Hibernate4的方法</li>
<li>Spring Boot项目中使用Mybatis的方法</li>
</ol>
<span id="more"></span>

<hr>
<p><strong>SpringBoot系列</strong>：<a href="/tags/Spring-Boot/">Spring Boot学习笔记</a></p>
<hr>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Spring Boot针对企业开发场景提供了各种『开箱即用』的<strong>spring-boot-starter-xxx</strong>自动配置依赖模块，这就使得我们开发Spring应用更加快速和高效。比如我们前面创建web项目时使用到的<strong>spring-boot-starter-web</strong>。</p>
<p>这些<strong>spring-boot-starter-xxx</strong>不但包含了对该功能的全部依赖包，同时也提供了该功能的自动配置类。我们本节要讨论的『数据访问』就是基于这些<strong>spring-boot-starter-xxx</strong>的自动配置依赖模块。</p>
<hr>
<h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><p><strong>jdk版本</strong>：java version “1.8.0_31”<br><strong>数据库</strong>：10.1.16-MariaDB<br><strong>脚本</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"># 创建库<span class="number">1</span></span><br><span class="line"><span class="keyword">CREATE</span> SCHEMA `springboot1` <span class="keyword">DEFAULT</span> <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 ;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `springboot1`.`person` (</span><br><span class="line">  `p_id` <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;主键&#x27;</span>,</span><br><span class="line">  `p_name` <span class="type">VARCHAR</span>(<span class="number">45</span>) <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;姓名&#x27;</span>,</span><br><span class="line">  `p_age` <span class="type">INT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;年龄&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`p_id`))</span><br><span class="line">ENGINE <span class="operator">=</span> InnoDB</span><br><span class="line">COMMENT <span class="operator">=</span> <span class="string">&#x27;人员信息表&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `springboot1`.`person` (`p_id`, `p_name`, `p_age`) <span class="keyword">VALUES</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;张三&#x27;</span>, <span class="string">&#x27;20&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `springboot1`.`person` (`p_id`, `p_name`, `p_age`) <span class="keyword">VALUES</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;李四&#x27;</span>, <span class="string">&#x27;25&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 创建库<span class="number">2</span></span><br><span class="line"><span class="keyword">CREATE</span> SCHEMA `springboot2` <span class="keyword">DEFAULT</span> <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 ;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `springboot2`.`person` (</span><br><span class="line">  `p_id` <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;主键&#x27;</span>,</span><br><span class="line">  `p_name` <span class="type">VARCHAR</span>(<span class="number">45</span>) <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;姓名&#x27;</span>,</span><br><span class="line">  `p_age` <span class="type">INT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;年龄&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`p_id`))</span><br><span class="line">ENGINE <span class="operator">=</span> InnoDB</span><br><span class="line">COMMENT <span class="operator">=</span> <span class="string">&#x27;人员信息表&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `springboot2`.`person` (`p_id`, `p_name`, `p_age`) <span class="keyword">VALUES</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;张三&#x27;</span>, <span class="string">&#x27;20&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `springboot2`.`person` (`p_id`, `p_name`, `p_age`) <span class="keyword">VALUES</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;李四&#x27;</span>, <span class="string">&#x27;25&#x27;</span>);</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Spring-Boot对JDBC的支持"><a href="#Spring-Boot对JDBC的支持" class="headerlink" title="Spring Boot对JDBC的支持"></a>Spring Boot对JDBC的支持</h2><h3 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h3><p>新建一个springboot项目，依赖选择web和jdbc<br><img src="/images_glob/spring-boot-study-data/jdbc1.png"></p>
<p>项目创建成功后查看pom，会看到添加了<strong>spring-boot-starter-jdbc</strong>的依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="配置项目"><a href="#配置项目" class="headerlink" title="配置项目"></a>配置项目</h3><p>在pom中增加MySQL依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.37<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在<em>application.properties</em>中添加数据源配置信息</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment">#datasource</span></span><br><span class="line"><span class="string">spring.datasource.driver-class-name=com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="string">spring.datasource.url=jdbc:mysql://localhost:3306/springboot1?useUnicode=true&amp;characterEncoding=utf-8</span></span><br><span class="line"><span class="string">spring.datasource.username=root</span></span><br><span class="line"><span class="string">spring.datasource.password=newpwd</span></span><br></pre></td></tr></table></figure>

<h3 id="项目代码"><a href="#项目代码" class="headerlink" title="项目代码"></a>项目代码</h3><p>本例只做简单演示，所以只创建如下3个类，并用一个单元测试类进行测试<br>Model:<strong>Person</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">1L</span>;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//getter and setter</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Person&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;id=&quot;</span> + id +</span><br><span class="line">                <span class="string">&quot;, name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, age=&quot;</span> + age +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Dao:<strong>PersonDao</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PersonDao</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">savePerson</span><span class="params">(Person person)</span></span>&#123;</span><br><span class="line">        String sql = <span class="string">&quot;INSERT INTO `springboot1`.`person` (`p_name`, `p_age`) VALUES (?, ?)&quot;</span>;</span><br><span class="line">        <span class="keyword">int</span> result = jdbcTemplate.update(sql,<span class="keyword">new</span> Object[]&#123;person.getName(),person.getAge()&#125;);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Person&gt; <span class="title">getAllPersonList</span><span class="params">()</span></span>&#123;</span><br><span class="line">        String sql = <span class="string">&quot;select * from person s&quot;</span>;</span><br><span class="line">        List&lt;Person&gt; list = jdbcTemplate.query(sql,<span class="keyword">new</span> PersonMapper());</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">PersonMapper</span> <span class="keyword">implements</span> <span class="title">RowMapper</span>&lt;<span class="title">Person</span>&gt;</span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Person <span class="title">mapRow</span><span class="params">(ResultSet resultSet, <span class="keyword">int</span> i)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">            Person person = <span class="keyword">new</span> Person();</span><br><span class="line">            person.setId(resultSet.getLong(<span class="string">&quot;p_id&quot;</span>));</span><br><span class="line">            person.setName(resultSet.getString(<span class="string">&quot;p_name&quot;</span>));</span><br><span class="line">            person.setAge(resultSet.getInt(<span class="string">&quot;p_age&quot;</span>));</span><br><span class="line">            <span class="keyword">return</span> person;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Service:<strong>PersonService</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PersonService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PersonDao personDao;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">savePserson</span><span class="params">(Person person)</span></span>&#123;</span><br><span class="line">       <span class="keyword">return</span> personDao.savePerson(person);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Person&gt; <span class="title">getAllPersonList</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> personDao.getAllPersonList();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>单元测试:<strong>SpringbootjdbcdemoApplicationTests</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringbootjdbcdemoApplicationTests</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PersonService personService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">savePerson</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Person person = <span class="keyword">new</span> Person();</span><br><span class="line">        person.setName(<span class="string">&quot;王五&quot;</span>);</span><br><span class="line">        person.setAge(<span class="number">18</span>);</span><br><span class="line">        <span class="keyword">int</span> result = personService.savePserson(person);</span><br><span class="line">        Assert.assertEquals(<span class="number">1</span>,result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getAllPersonList</span><span class="params">()</span></span>&#123;</span><br><span class="line">        List&lt;Person&gt; list = personService.getAllPersonList();</span><br><span class="line">        System.out.println(list.size());</span><br><span class="line">        <span class="keyword">for</span>(Person person : list)&#123;</span><br><span class="line">            System.out.println(person);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<hr>
<p><strong>说明</strong><br>实际上，项目加入<strong>spring-boot-starter-jdbc</strong>的依赖后，即可在项目代码中通过@Autowired自动注入JdbcTemplate。而数据源的配置则在<em>application.properties</em>中进行配置。</p>
<p>如果不想使用<strong>spring-boot-starter-jdbc</strong>带来的默认依赖和自动配置，那么采用如下的方式，效果是一样的。</p>
<hr>
<h3 id="使用自定义的DataSourceConfig"><a href="#使用自定义的DataSourceConfig" class="headerlink" title="使用自定义的DataSourceConfig"></a>使用自定义的DataSourceConfig</h3><p>修改pom中的依赖，去掉对<strong>spring-boot-starter-jdbc</strong>的依赖，并加入对<strong>spring-jdbc</strong>的依赖，这样我们就失去了对JDBC的自动配置功能了。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">&lt;dependency&gt;</span></span><br><span class="line"><span class="comment">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span></span><br><span class="line"><span class="comment">    &lt;artifactId&gt;spring-boot-starter-jdbc&lt;/artifactId&gt;</span></span><br><span class="line"><span class="comment">&lt;/dependency&gt;</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.3.4.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>启动类中去掉对<strong>DataSourceAutoConfiguration</strong>的自动配置支持</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication(exclude=&#123;DataSourceAutoConfiguration.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringbootjdbcdemoApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(SpringbootjdbcdemoApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建<strong>DataSourceConfig</strong>配置类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSourceConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.datasource.driver-class-name&#125;&quot;)</span></span><br><span class="line">    String driverClass;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.datasource.url&#125;&quot;)</span></span><br><span class="line">    String url;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.datasource.username&#125;&quot;)</span></span><br><span class="line">    String userName;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.datasource.password&#125;&quot;)</span></span><br><span class="line">    String passWord;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;dataSource&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        DriverManagerDataSource dataSource = <span class="keyword">new</span> DriverManagerDataSource();</span><br><span class="line">        dataSource.setDriverClassName(driverClass);</span><br><span class="line">        dataSource.setUrl(url);</span><br><span class="line">        dataSource.setUsername(userName);</span><br><span class="line">        dataSource.setPassword(passWord);</span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;jdbcTemplate&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JdbcTemplate <span class="title">jdbcTemplate</span><span class="params">()</span></span>&#123;</span><br><span class="line">        JdbcTemplate jdbcTemplate = <span class="keyword">new</span> JdbcTemplate(dataSource());</span><br><span class="line">        <span class="keyword">return</span> jdbcTemplate;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其它代码不需要任何修改，运行效果一致。</p>
<hr>
<p><strong>说明</strong><br>为什么SpringBoot为我们提供了<strong>spring-boot-starter-jdbc</strong>的自动配置解决方案，我们还要自己配置呢，这是因为自动配置并不是那么的强大，<strong>spring-boot-starter-jdbc</strong>只能支持单一的数据源配置，如果项目中需要关联多个数据源，就需要我们自己处理了。</p>
<p>比如我们在环境准备中创建了两个数据库，接下来我们在项目中增加多数据源的配置。</p>
<hr>
<p>在<em>application.properties</em>中添加数据源配置信息</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment">#datasource2</span></span><br><span class="line"><span class="string">spring.datasource.driver-class-name2=com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="string">spring.datasource.url2=jdbc:mysql://localhost:3306/springboot2?useUnicode=true&amp;characterEncoding=utf-8</span></span><br><span class="line"><span class="string">spring.datasource.username2=root</span></span><br><span class="line"><span class="string">spring.datasource.password2=newpwd</span></span><br></pre></td></tr></table></figure>

<p>然后在<strong>DataSourceConfig</strong>配置类中增加如下内容：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Value(&quot;$&#123;spring.datasource.driver-class-name2&#125;&quot;)</span></span><br><span class="line">String driverClass2;</span><br><span class="line"><span class="meta">@Value(&quot;$&#123;spring.datasource.url2&#125;&quot;)</span></span><br><span class="line">String url2;</span><br><span class="line"><span class="meta">@Value(&quot;$&#123;spring.datasource.username2&#125;&quot;)</span></span><br><span class="line">String userName2;</span><br><span class="line"><span class="meta">@Value(&quot;$&#123;spring.datasource.password2&#125;&quot;)</span></span><br><span class="line">String passWord2;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean(name = &quot;dataSource2&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    DriverManagerDataSource dataSource = <span class="keyword">new</span> DriverManagerDataSource();</span><br><span class="line">    dataSource.setDriverClassName(driverClass2);</span><br><span class="line">    dataSource.setUrl(url2);</span><br><span class="line">    dataSource.setUsername(userName2);</span><br><span class="line">    dataSource.setPassword(passWord2);</span><br><span class="line">    <span class="keyword">return</span> dataSource;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean(name = &quot;jdbcTemplate2&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> JdbcTemplate <span class="title">jdbcTemplate2</span><span class="params">()</span></span>&#123;</span><br><span class="line">    JdbcTemplate jdbcTemplate = <span class="keyword">new</span> JdbcTemplate(dataSource2());</span><br><span class="line">    <span class="keyword">return</span> jdbcTemplate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时需要在Dao中将@Autowired注解替换成<code>@Resource(name = &quot;jdbcTemplate&quot;)</code>，来明确指定要使用哪一个jdbcTemplate对象。</p>
<hr>
<p><strong>说明</strong><br>关于如何在项目中使用Hibernate4框架，可以参考:<a href="http://hanqunfeng.iteye.com/blog/2114975">SpringMVC4零配置</a></p>
<hr>
<h2 id="Spring-Boot的事务管理"><a href="#Spring-Boot的事务管理" class="headerlink" title="Spring Boot的事务管理"></a>Spring Boot的事务管理</h2><h3 id="JDBC事务管理"><a href="#JDBC事务管理" class="headerlink" title="JDBC事务管理"></a>JDBC事务管理</h3><p>如果我们项目中使用的是JDBC的数据访问方案，并且容器中只注册了一个<strong>DataSource</strong>，那么SpringBoot就会为我们开启<strong>DataSourceTransactionManagerAutoConfiguration</strong>的自动配置类，其会在容器中注册一个<strong>DataSourceTransactionManager</strong>事务管理器，同时会开启对注解式事务**@Transactional<strong>的支持。感兴趣的可以看一下</strong>DataSourceTransactionManagerAutoConfiguration**的源码。</p>
<hr>
<p><strong>@Transactional</strong>是Spring框架提供的，配置方法参考下面的代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//一般我们会在业务实现类上声明事务注解</span></span><br><span class="line"><span class="comment">//当前表示需要在事务中运行，可以执行更新和删除操作，遇到异常则回滚</span></span><br><span class="line"><span class="meta">@Transactional(propagation = Propagation.REQUIRED, readOnly = false, rollbackFor = &#123; Exception.class &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PersonService</span></span>&#123;</span><br><span class="line">    <span class="comment">//方法上也可以标注事务注解，方法上注解声明会覆盖类上的</span></span><br><span class="line">    <span class="comment">//一般查询操作readOnly设置为true，增删该操作设置为false</span></span><br><span class="line">    <span class="meta">@Transactional(readOnly = true)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Person&gt; <span class="title">getAllPersonList</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//do something</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//不加@Transactiona注解，则使用类上的设置</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">savePserson</span><span class="params">(Person person)</span></span>&#123;</span><br><span class="line">        <span class="comment">//do something</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果在测试类上声明**@Transactional**，则会开启自动回滚，不会产生脏数据</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringbootjdbcdemoApplicationTests</span> </span>&#123;…………&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p>如果希望自己配置事务，可以在配置类中增加事务管理器的配置，比如，我们在<strong>DataSourceConfig</strong>中增加如下配置：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">//启用注解事务管理，使用CGLib代理</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement(proxyTargetClass = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSourceConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.datasource.driver-class-name&#125;&quot;)</span></span><br><span class="line">    String driverClass;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.datasource.url&#125;&quot;)</span></span><br><span class="line">    String url;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.datasource.username&#125;&quot;)</span></span><br><span class="line">    String userName;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.datasource.password&#125;&quot;)</span></span><br><span class="line">    String passWord;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;dataSource&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        DriverManagerDataSource dataSource = <span class="keyword">new</span> DriverManagerDataSource();</span><br><span class="line">        dataSource.setDriverClassName(driverClass);</span><br><span class="line">        dataSource.setUrl(url);</span><br><span class="line">        dataSource.setUsername(userName);</span><br><span class="line">        dataSource.setPassword(passWord);</span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;jdbcTemplate&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JdbcTemplate <span class="title">jdbcTemplate</span><span class="params">()</span></span>&#123;</span><br><span class="line">        JdbcTemplate jdbcTemplate = <span class="keyword">new</span> JdbcTemplate(dataSource());</span><br><span class="line">        <span class="keyword">return</span> jdbcTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSourceTransactionManager <span class="title">transactionManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DataSourceTransactionManager(dataSource());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<hr>
<p><strong>说明</strong><br>上面的方法只是针对单一数据源进行事务管理的，但是项目中经常会用到多数据源的情况，那么要如何进行事务管理呢？</p>
<hr>
<p>我们上文讲到了可以在项目中通过配置类，自己配置多个数据源，并通过<strong>DataSourceConfig</strong>进行了演示，接下来我们添加多个事务管理器。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">//启用注解事务管理，使用CGLib代理</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement(proxyTargetClass = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSourceConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.datasource.driver-class-name&#125;&quot;)</span></span><br><span class="line">    String driverClass;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.datasource.url&#125;&quot;)</span></span><br><span class="line">    String url;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.datasource.username&#125;&quot;)</span></span><br><span class="line">    String userName;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.datasource.password&#125;&quot;)</span></span><br><span class="line">    String passWord;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.datasource.driver-class-name2&#125;&quot;)</span></span><br><span class="line">    String driverClass2;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.datasource.url2&#125;&quot;)</span></span><br><span class="line">    String url2;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.datasource.username2&#125;&quot;)</span></span><br><span class="line">    String userName2;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.datasource.password2&#125;&quot;)</span></span><br><span class="line">    String passWord2;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;dataSource&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        DriverManagerDataSource dataSource = <span class="keyword">new</span> DriverManagerDataSource();</span><br><span class="line">        dataSource.setDriverClassName(driverClass);</span><br><span class="line">        dataSource.setUrl(url);</span><br><span class="line">        dataSource.setUsername(userName);</span><br><span class="line">        dataSource.setPassword(passWord);</span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;jdbcTemplate&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JdbcTemplate <span class="title">jdbcTemplate</span><span class="params">()</span></span>&#123;</span><br><span class="line">        JdbcTemplate jdbcTemplate = <span class="keyword">new</span> JdbcTemplate(dataSource());</span><br><span class="line">        <span class="keyword">return</span> jdbcTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;transactionManager&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSourceTransactionManager <span class="title">transactionManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DataSourceTransactionManager(dataSource());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;dataSource2&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        DriverManagerDataSource dataSource = <span class="keyword">new</span> DriverManagerDataSource();</span><br><span class="line">        dataSource.setDriverClassName(driverClass2);</span><br><span class="line">        dataSource.setUrl(url2);</span><br><span class="line">        dataSource.setUsername(userName2);</span><br><span class="line">        dataSource.setPassword(passWord2);</span><br><span class="line">        System.out.println(url2);</span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;jdbcTemplate2&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JdbcTemplate <span class="title">jdbcTemplate2</span><span class="params">()</span></span>&#123;</span><br><span class="line">        JdbcTemplate jdbcTemplate = <span class="keyword">new</span> JdbcTemplate(dataSource2());</span><br><span class="line">        <span class="keyword">return</span> jdbcTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;transactionManager2&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSourceTransactionManager <span class="title">transactionManager2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DataSourceTransactionManager(dataSource2());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这时，我们必须在**@Transactional**注解中指定要使用哪一个事务管理器</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Transactional(transactionManager = &quot;transactionManager&quot;,propagation = Propagation.REQUIRED, readOnly = false, rollbackFor = &#123; Exception.class &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PersonService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PersonDao personDao;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">savePserson</span><span class="params">(Person person)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> personDao.savePerson(person);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Transactional(transactionManager = &quot;transactionManager&quot;,readOnly = true)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Person&gt; <span class="title">getAllPersonList</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> personDao.getAllPersonList();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional(transactionManager = &quot;transactionManager2&quot;,propagation = Propagation.REQUIRED, readOnly = false, rollbackFor = &#123; Exception.class &#125;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">savePserson2</span><span class="params">(Person person)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> personDao.savePerson2(person);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Transactional(transactionManager = &quot;transactionManager2&quot;,readOnly = true)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Person&gt; <span class="title">getAllPersonList2</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> personDao.getAllPersonList2();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<p><strong>说明</strong><br>这样做并不美好，不能对多个数据源同时进行事务管理，比如，我们在一个业务方法里同时对两个数据源进行操作，我们希望只要有一个发生异常，则两个数据源的数据都进行回滚。</p>
<p>那要怎么做呢，我们接着往下看。</p>
<hr>
<h3 id="多数据源事务管理"><a href="#多数据源事务管理" class="headerlink" title="多数据源事务管理"></a>多数据源事务管理</h3><p>这里推荐使用**<a href="https://www.atomikos.com/">Atomikos</a>**，Atomikos支持Mysql、Oracle等多种数据库，可与多种ORM框架集成，如MyBatis、JPA、Hibernate等等，同时支持各种容器下JNDI的多数据源管理。Atomikos官网提供了各种情况下使用Atomikos的Example，本文只对使用JDBC时的情况进行说明。</p>
<p>目前maven中央仓库的最新版本是4.0.4，使用Atomikos，需要在项目中加入如下依赖：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atomikos<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>transactions-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atomikos<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>transactions-jta<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atomikos<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>transactions<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atomikos<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>atomikos-util<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.transaction<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jta<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>


<p>对<strong>DataSourceConfig</strong>进行改造：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atomikos.icatch.jta.UserTransactionImp;</span><br><span class="line"><span class="keyword">import</span> com.atomikos.icatch.jta.UserTransactionManager;</span><br><span class="line"><span class="keyword">import</span> com.atomikos.jdbc.AtomikosDataSourceBean;</span><br><span class="line"><span class="keyword">import</span> com.mysql.jdbc.jdbc2.optional.MysqlXADataSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.DependsOn;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jdbc.core.JdbcTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.PlatformTransactionManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.EnableTransactionManagement;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.jta.JtaTransactionManager;</span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"><span class="keyword">import</span> javax.transaction.TransactionManager;</span><br><span class="line"><span class="keyword">import</span> javax.transaction.UserTransaction;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">//启用注解事务管理，使用CGLib代理</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement(proxyTargetClass = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSourceConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.datasource.driver-class-name&#125;&quot;)</span></span><br><span class="line">    String driverClass;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.datasource.url&#125;&quot;)</span></span><br><span class="line">    String url;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.datasource.username&#125;&quot;)</span></span><br><span class="line">    String userName;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.datasource.password&#125;&quot;)</span></span><br><span class="line">    String passWord;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.datasource.driver-class-name2&#125;&quot;)</span></span><br><span class="line">    String driverClass2;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.datasource.url2&#125;&quot;)</span></span><br><span class="line">    String url2;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.datasource.username2&#125;&quot;)</span></span><br><span class="line">    String userName2;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.datasource.password2&#125;&quot;)</span></span><br><span class="line">    String passWord2;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;userTransaction&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserTransaction <span class="title">userTransaction</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        UserTransactionImp userTransactionImp = <span class="keyword">new</span> UserTransactionImp();</span><br><span class="line">        userTransactionImp.setTransactionTimeout(<span class="number">300</span>);</span><br><span class="line">        <span class="keyword">return</span> userTransactionImp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;atomikosTransactionManager&quot;, initMethod = &quot;init&quot;, destroyMethod = &quot;close&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TransactionManager <span class="title">atomikosTransactionManager</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        UserTransactionManager userTransactionManager = <span class="keyword">new</span> UserTransactionManager();</span><br><span class="line">        userTransactionManager.setForceShutdown(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> userTransactionManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;transactionManager&quot;)</span></span><br><span class="line">    <span class="meta">@DependsOn(&#123; &quot;userTransaction&quot;, &quot;atomikosTransactionManager&quot; &#125;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PlatformTransactionManager <span class="title">transactionManager</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        UserTransaction userTransaction = userTransaction();</span><br><span class="line">        TransactionManager atomikosTransactionManager = atomikosTransactionManager();</span><br><span class="line">        JtaTransactionManager jtaTransactionManager = <span class="keyword">new</span> JtaTransactionManager(userTransaction, atomikosTransactionManager);</span><br><span class="line">        jtaTransactionManager.setAllowCustomIsolationLevels(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> jtaTransactionManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;dataSource&quot;, initMethod = &quot;init&quot;, destroyMethod = &quot;close&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;dataSource init&quot;</span>);</span><br><span class="line">        <span class="comment">//Oracle:oracle.jdbc.xa.client.OracleXADataSource</span></span><br><span class="line">        <span class="comment">//Druid:com.alibaba.druid.pool.xa.DruidXADataSource</span></span><br><span class="line">        <span class="comment">//Postgresql:org.postgresql.xa.PGXADataSource</span></span><br><span class="line">        MysqlXADataSource mysqlXaDataSource = <span class="keyword">new</span> MysqlXADataSource();</span><br><span class="line">        mysqlXaDataSource.setUrl(url);</span><br><span class="line">        mysqlXaDataSource.setPassword(passWord);</span><br><span class="line">        mysqlXaDataSource.setUser(userName);</span><br><span class="line">        mysqlXaDataSource.setPinGlobalTxToPhysicalConnection(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        AtomikosDataSourceBean xaDataSource = <span class="keyword">new</span> AtomikosDataSourceBean();</span><br><span class="line">        xaDataSource.setXaDataSource(mysqlXaDataSource);</span><br><span class="line">        xaDataSource.setUniqueResourceName(<span class="string">&quot;dataSource&quot;</span>);</span><br><span class="line">        xaDataSource.setMinPoolSize(<span class="number">10</span>);</span><br><span class="line">        xaDataSource.setPoolSize(<span class="number">10</span>);</span><br><span class="line">        xaDataSource.setMaxPoolSize(<span class="number">30</span>);</span><br><span class="line">        xaDataSource.setBorrowConnectionTimeout(<span class="number">60</span>);</span><br><span class="line">        xaDataSource.setReapTimeout(<span class="number">20</span>);</span><br><span class="line">        xaDataSource.setMaxIdleTime(<span class="number">60</span>);</span><br><span class="line">        xaDataSource.setMaintenanceInterval(<span class="number">60</span>);</span><br><span class="line">        <span class="keyword">return</span> xaDataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;dataSource2&quot;, initMethod = &quot;init&quot;, destroyMethod = &quot;close&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;dataSource2 init&quot;</span>);</span><br><span class="line">        MysqlXADataSource mysqlXaDataSource = <span class="keyword">new</span> MysqlXADataSource();</span><br><span class="line">        mysqlXaDataSource.setUrl(url2);</span><br><span class="line">        mysqlXaDataSource.setPassword(passWord2);</span><br><span class="line">        mysqlXaDataSource.setUser(userName2);</span><br><span class="line">        mysqlXaDataSource.setPinGlobalTxToPhysicalConnection(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        AtomikosDataSourceBean xaDataSource = <span class="keyword">new</span> AtomikosDataSourceBean();</span><br><span class="line">        xaDataSource.setXaDataSource(mysqlXaDataSource);</span><br><span class="line">        xaDataSource.setUniqueResourceName(<span class="string">&quot;dataSource2&quot;</span>);</span><br><span class="line">        xaDataSource.setMinPoolSize(<span class="number">10</span>);</span><br><span class="line">        xaDataSource.setPoolSize(<span class="number">10</span>);</span><br><span class="line">        xaDataSource.setMaxPoolSize(<span class="number">30</span>);</span><br><span class="line">        xaDataSource.setBorrowConnectionTimeout(<span class="number">60</span>);</span><br><span class="line">        xaDataSource.setReapTimeout(<span class="number">20</span>);</span><br><span class="line">        xaDataSource.setMaxIdleTime(<span class="number">60</span>);</span><br><span class="line">        xaDataSource.setMaintenanceInterval(<span class="number">60</span>);</span><br><span class="line">        <span class="keyword">return</span> xaDataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;jdbcTemplate&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JdbcTemplate <span class="title">jdbcTemplate</span><span class="params">()</span></span>&#123;</span><br><span class="line">        JdbcTemplate jdbcTemplate = <span class="keyword">new</span> JdbcTemplate(dataSource());</span><br><span class="line">        <span class="keyword">return</span> jdbcTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;jdbcTemplate2&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JdbcTemplate <span class="title">jdbcTemplate2</span><span class="params">()</span></span>&#123;</span><br><span class="line">        JdbcTemplate jdbcTemplate = <span class="keyword">new</span> JdbcTemplate(dataSource2());</span><br><span class="line">        <span class="keyword">return</span> jdbcTemplate;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>项目编译路径下可以创建一个<strong>jta.properties</strong>文件，用于对Atomikos的相关属性进行配置，不过也可以不加这个文件，因为所有的属性都有默认值。</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="string">com.atomikos.icatch.enable_logging=true</span></span><br><span class="line"><span class="string">com.atomikos.icatch.force_shutdown_on_vm_exit=false</span></span><br><span class="line"><span class="string">com.atomikos.icatch.automatic_resource_registration=true</span></span><br><span class="line"><span class="string">com.atomikos.icatch.checkpoint_interval=500</span></span><br><span class="line"><span class="string">com.atomikos.icatch.serial_jta_transactions=true</span></span><br><span class="line"><span class="string">com.atomikos.icatch.default_jta_timeout=10000</span></span><br><span class="line"><span class="string">com.atomikos.icatch.max_timeout=300000</span></span><br><span class="line"><span class="string">com.atomikos.icatch.log_base_dir=./</span></span><br><span class="line"><span class="string">com.atomikos.icatch.threaded_2pc=false</span></span><br><span class="line"><span class="string">com.atomikos.icatch.max_actives=50</span></span><br><span class="line"><span class="string">com.atomikos.icatch.log_base_name=tmlog</span></span><br><span class="line"><span class="string">java.naming.factory.initial=com.sun.jndi.rmi.registry.RegistryContextFactory</span></span><br><span class="line"><span class="string">com.atomikos.icatch.client_demarcation=false</span></span><br><span class="line"><span class="string">java.naming.provider.url=rmi://localhost:1099</span></span><br><span class="line"><span class="string">com.atomikos.icatch.rmi_export_class=none</span></span><br><span class="line"><span class="string">com.atomikos.icatch.trust_client_tm=false</span></span><br><span class="line"><span class="string">com.atomikos.icatch.forget_orphaned_log_entries_delay=86400000</span></span><br><span class="line"><span class="string">com.atomikos.icatch.recovery_delay=$&#123;com.atomikos.icatch.default_jta_timeout&#125;</span></span><br><span class="line"><span class="string">com.atomikos.icatch.oltp_max_retries=5</span></span><br><span class="line"><span class="string">com.atomikos.icatch.oltp_retry_interval=10000</span></span><br><span class="line"><span class="string">com.atomikos.icatch.allow_subtransactions=true</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Spring-Boot中Atomikos与Hibernate4多数据源集成方法"><a href="#Spring-Boot中Atomikos与Hibernate4多数据源集成方法" class="headerlink" title="Spring Boot中Atomikos与Hibernate4多数据源集成方法"></a>Spring Boot中Atomikos与Hibernate4多数据源集成方法</h2><p>Atomikos与Hibernate4集成方法与JDBC类似，我们在pom中加入hibernate的依赖，并对<strong>DataSourceConfig</strong>进行改造<br><strong>pom</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.hibernate<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hibernate-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.3.5.Final<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>DataSourceConfig</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atomikos.icatch.jta.UserTransactionImp;</span><br><span class="line"><span class="keyword">import</span> com.atomikos.icatch.jta.UserTransactionManager;</span><br><span class="line"><span class="keyword">import</span> com.atomikos.jdbc.AtomikosDataSourceBean;</span><br><span class="line"><span class="keyword">import</span> com.example.hibernate.CP_HibernateDAO;</span><br><span class="line"><span class="keyword">import</span> com.example.hibernate.impl.CP_Hibernate4DAOImpl;</span><br><span class="line"><span class="keyword">import</span> com.mysql.jdbc.jdbc2.optional.MysqlXADataSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.DependsOn;</span><br><span class="line"><span class="keyword">import</span> org.springframework.orm.hibernate4.LocalSessionFactoryBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.PlatformTransactionManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.EnableTransactionManagement;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.jta.JtaTransactionManager;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"><span class="keyword">import</span> javax.transaction.TransactionManager;</span><br><span class="line"><span class="keyword">import</span> javax.transaction.UserTransaction;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement(proxyTargetClass = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSourceConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.datasource.driver-class-name&#125;&quot;)</span></span><br><span class="line">    String driverClass;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.datasource.url&#125;&quot;)</span></span><br><span class="line">    String url;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.datasource.username&#125;&quot;)</span></span><br><span class="line">    String userName;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.datasource.password&#125;&quot;)</span></span><br><span class="line">    String passWord;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.datasource.driver-class-name2&#125;&quot;)</span></span><br><span class="line">    String driverClass2;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.datasource.url2&#125;&quot;)</span></span><br><span class="line">    String url2;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.datasource.username2&#125;&quot;)</span></span><br><span class="line">    String userName2;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.datasource.password2&#125;&quot;)</span></span><br><span class="line">    String passWord2;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;userTransaction&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserTransaction <span class="title">userTransaction</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        UserTransactionImp userTransactionImp = <span class="keyword">new</span> UserTransactionImp();</span><br><span class="line">        userTransactionImp.setTransactionTimeout(<span class="number">10000</span>);</span><br><span class="line">        <span class="keyword">return</span> userTransactionImp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;atomikosTransactionManager&quot;, initMethod = &quot;init&quot;, destroyMethod = &quot;close&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TransactionManager <span class="title">atomikosTransactionManager</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        UserTransactionManager userTransactionManager = <span class="keyword">new</span> UserTransactionManager();</span><br><span class="line">        userTransactionManager.setForceShutdown(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> userTransactionManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;transactionManager&quot;)</span></span><br><span class="line">    <span class="meta">@DependsOn(&#123; &quot;userTransaction&quot;, &quot;atomikosTransactionManager&quot; &#125;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PlatformTransactionManager <span class="title">transactionManager</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        System.out.println();</span><br><span class="line">        UserTransaction userTransaction = userTransaction();</span><br><span class="line">        TransactionManager atomikosTransactionManager = atomikosTransactionManager();</span><br><span class="line">        JtaTransactionManager jtaTransactionManager = <span class="keyword">new</span> JtaTransactionManager(userTransaction, atomikosTransactionManager);</span><br><span class="line">        jtaTransactionManager.setAllowCustomIsolationLevels(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> jtaTransactionManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;dataSource&quot;, initMethod = &quot;init&quot;, destroyMethod = &quot;close&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println();</span><br><span class="line"></span><br><span class="line">        MysqlXADataSource mysqlXaDataSource = <span class="keyword">new</span> MysqlXADataSource();</span><br><span class="line">        mysqlXaDataSource.setUrl(url);</span><br><span class="line">        mysqlXaDataSource.setPassword(passWord);</span><br><span class="line">        mysqlXaDataSource.setUser(userName);</span><br><span class="line">        mysqlXaDataSource.setPinGlobalTxToPhysicalConnection(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        AtomikosDataSourceBean xaDataSource = <span class="keyword">new</span> AtomikosDataSourceBean();</span><br><span class="line">        xaDataSource.setXaDataSource(mysqlXaDataSource);</span><br><span class="line">        xaDataSource.setUniqueResourceName(<span class="string">&quot;dataSource&quot;</span>);</span><br><span class="line">        xaDataSource.setMinPoolSize(<span class="number">10</span>);</span><br><span class="line">        xaDataSource.setPoolSize(<span class="number">10</span>);</span><br><span class="line">        xaDataSource.setMaxPoolSize(<span class="number">30</span>);</span><br><span class="line">        xaDataSource.setBorrowConnectionTimeout(<span class="number">60</span>);</span><br><span class="line">        xaDataSource.setReapTimeout(<span class="number">20</span>);</span><br><span class="line">        xaDataSource.setMaxIdleTime(<span class="number">60</span>);</span><br><span class="line">        xaDataSource.setMaintenanceInterval(<span class="number">60</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> xaDataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;dataSource2&quot;, initMethod = &quot;init&quot;, destroyMethod = &quot;close&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println();</span><br><span class="line">        MysqlXADataSource mysqlXaDataSource = <span class="keyword">new</span> MysqlXADataSource();</span><br><span class="line">        mysqlXaDataSource.setUrl(url2);</span><br><span class="line">        mysqlXaDataSource.setPassword(passWord2);</span><br><span class="line">        mysqlXaDataSource.setUser(userName2);</span><br><span class="line">        mysqlXaDataSource.setPinGlobalTxToPhysicalConnection(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        AtomikosDataSourceBean xaDataSource = <span class="keyword">new</span> AtomikosDataSourceBean();</span><br><span class="line">        xaDataSource.setXaDataSource(mysqlXaDataSource);</span><br><span class="line">        xaDataSource.setUniqueResourceName(<span class="string">&quot;dataSource2&quot;</span>);</span><br><span class="line">        xaDataSource.setMinPoolSize(<span class="number">10</span>);</span><br><span class="line">        xaDataSource.setPoolSize(<span class="number">10</span>);</span><br><span class="line">        xaDataSource.setMaxPoolSize(<span class="number">30</span>);</span><br><span class="line">        xaDataSource.setBorrowConnectionTimeout(<span class="number">60</span>);</span><br><span class="line">        xaDataSource.setReapTimeout(<span class="number">20</span>);</span><br><span class="line">        xaDataSource.setMaxIdleTime(<span class="number">60</span>);</span><br><span class="line">        xaDataSource.setMaintenanceInterval(<span class="number">60</span>);</span><br><span class="line">        <span class="keyword">return</span> xaDataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;sessionFactory&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LocalSessionFactoryBean <span class="title">localSessionFactoryBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;sessionFactory&quot;</span>);</span><br><span class="line">        LocalSessionFactoryBean sessionFactory = <span class="keyword">new</span> LocalSessionFactoryBean();</span><br><span class="line">        sessionFactory.setDataSource(dataSource());</span><br><span class="line">        <span class="comment">//扫描实体对象的目录，不同的数据源，实体要存放不同的目录</span></span><br><span class="line">        String[] packagesToScan = <span class="keyword">new</span> String[] &#123; <span class="string">&quot;com.example.model.ds1&quot;</span> &#125;;</span><br><span class="line">        sessionFactory.setPackagesToScan(packagesToScan);</span><br><span class="line"></span><br><span class="line">        Properties hibernateProperties = <span class="keyword">new</span> Properties();</span><br><span class="line">        hibernateProperties.setProperty(<span class="string">&quot;hibernate.dialect&quot;</span>, <span class="string">&quot;org.hibernate.dialect.MySQLDialect&quot;</span>);</span><br><span class="line">        hibernateProperties.setProperty(<span class="string">&quot;hibernate.show_sql&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//开启Hibernate对JTA的支持</span></span><br><span class="line">        hibernateProperties.setProperty(<span class="string">&quot;hibernate.current_session_context_class&quot;</span>, <span class="string">&quot;jta&quot;</span>);</span><br><span class="line">        hibernateProperties.setProperty(<span class="string">&quot;hibernate.transaction.factory_class&quot;</span>, <span class="string">&quot;org.hibernate.transaction.JTATransactionFactory&quot;</span>);</span><br><span class="line"></span><br><span class="line">        sessionFactory.setHibernateProperties(hibernateProperties);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> sessionFactory;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;sessionFactory2&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LocalSessionFactoryBean <span class="title">localSessionFactoryBean2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;sessionFactory2&quot;</span>);</span><br><span class="line">        LocalSessionFactoryBean sessionFactory = <span class="keyword">new</span> LocalSessionFactoryBean();</span><br><span class="line">        sessionFactory.setDataSource(dataSource2());</span><br><span class="line">        <span class="comment">//扫描实体对象的目录，不同的数据源，实体要存放不同的目录</span></span><br><span class="line">        String[] packagesToScan = <span class="keyword">new</span> String[] &#123; <span class="string">&quot;com.example.model.ds2&quot;</span> &#125;;</span><br><span class="line">        sessionFactory.setPackagesToScan(packagesToScan);</span><br><span class="line"></span><br><span class="line">        Properties hibernateProperties = <span class="keyword">new</span> Properties();</span><br><span class="line">        hibernateProperties.setProperty(<span class="string">&quot;hibernate.dialect&quot;</span>, <span class="string">&quot;org.hibernate.dialect.MySQLDialect&quot;</span>);</span><br><span class="line">        hibernateProperties.setProperty(<span class="string">&quot;hibernate.show_sql&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//开启Hibernate对JTA的支持</span></span><br><span class="line">        hibernateProperties.setProperty(<span class="string">&quot;hibernate.current_session_context_class&quot;</span>, <span class="string">&quot;jta&quot;</span>);</span><br><span class="line">        hibernateProperties.setProperty(<span class="string">&quot;hibernate.transaction.factory_class&quot;</span>, <span class="string">&quot;org.hibernate.transaction.JTATransactionFactory&quot;</span>);</span><br><span class="line"></span><br><span class="line">        sessionFactory.setHibernateProperties(hibernateProperties);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> sessionFactory;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;hibernateDAO&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CP_HibernateDAO <span class="title">hibernate4Dao</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;hibernateDAO&quot;</span>);</span><br><span class="line">        CP_Hibernate4DAOImpl dao = <span class="keyword">new</span> CP_Hibernate4DAOImpl();</span><br><span class="line">        <span class="comment">//绑定SessionFactory</span></span><br><span class="line">        dao.setSessionFactory(localSessionFactoryBean().getObject());</span><br><span class="line">        <span class="keyword">return</span> dao;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;hibernateDAO2&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CP_HibernateDAO <span class="title">hibernate4Dao2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;hibernateDAO2&quot;</span>);</span><br><span class="line">        CP_Hibernate4DAOImpl dao = <span class="keyword">new</span> CP_Hibernate4DAOImpl();</span><br><span class="line">        <span class="comment">//绑定SessionFactory2</span></span><br><span class="line">        dao.setSessionFactory(localSessionFactoryBean2().getObject());</span><br><span class="line">        <span class="keyword">return</span> dao;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table(name = &quot;person&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue(strategy = GenerationType.AUTO)</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;p_id&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="meta">@Column(name = &quot;p_name&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="meta">@Column(name = &quot;p_age&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="comment">//setter and getter</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>CP_HibernateDAO</strong>是我们自定义的Hibernate的通用Dao接口，其定义的方法和和实现类<strong>CP_Hibernate4DAOImpl</strong>代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.hibernate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CP_HibernateDAO</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;?&gt; findAll(Class&lt;?&gt; entityClazz, String... str);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">(Object entity)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.hibernate.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.hibernate.CP_HibernateDAO;</span><br><span class="line"><span class="keyword">import</span> org.hibernate.Criteria;</span><br><span class="line"><span class="keyword">import</span> org.hibernate.Session;</span><br><span class="line"><span class="keyword">import</span> org.hibernate.SessionFactory;</span><br><span class="line"><span class="keyword">import</span> org.hibernate.criterion.DetachedCriteria;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CP_Hibernate4DAOImpl</span> <span class="keyword">implements</span> <span class="title">CP_HibernateDAO</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> SessionFactory sessionFactory;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SessionFactory <span class="title">getSessionFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> sessionFactory;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//绑定SessionFactory</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSessionFactory</span><span class="params">(SessionFactory sessionFactory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.sessionFactory = sessionFactory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Session <span class="title">getHibernateSession</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Session session = sessionFactory.openSession();</span><br><span class="line">        <span class="keyword">return</span> session;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * @see com.example.hibernate.CP_HibernateDAO#findAll()</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;?&gt; findAll(Class&lt;?&gt; entityClazz, String... str) &#123;</span><br><span class="line">        DetachedCriteria dc = DetachedCriteria.forClass(entityClazz);</span><br><span class="line">        List&lt;?&gt; list = findAllByCriteria(dc);</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * @see com.example.hibernate.CP_HibernateDAO#save(java.lang.Object)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">(Object entity)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        getHibernateSession().save(entity);</span><br><span class="line">        <span class="comment">//注意这里一定要执行flush方法</span></span><br><span class="line">        getHibernateSession().flush();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;?&gt; findAllByCriteria(DetachedCriteria detachedCriteria) &#123;</span><br><span class="line">        <span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">        Criteria criteria = detachedCriteria</span><br><span class="line">                .getExecutableCriteria(getHibernateSession());</span><br><span class="line">        <span class="keyword">return</span> criteria.list();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>说明</strong><br>需要注意两点：</p>
<ol>
<li>session必须使用sessionFactory.openSession()的方式获得，不能使用sessionFactory.getCurrentSession()。</li>
<li>更新操作必须调用session.flush()方法。</li>
</ol>
<p>Spring配置文件的方式，可以参考：<a href="http://hanqunfeng.iteye.com/blog/2121427">Spring4+Hibernate4+Atomikos3.3多数据源事务管理</a></p>
<hr>
<h2 id="Spring-Boot中Mybitas的使用"><a href="#Spring-Boot中Mybitas的使用" class="headerlink" title="Spring Boot中Mybitas的使用"></a>Spring Boot中Mybitas的使用</h2><p>创建项目时，我们可以选择<strong>mybatis-spring-boot-starter</strong>依赖，这样可以激活SpringBoot对Mybatis的自动配置类。</p>
<p><strong>pom</strong>中添加依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>application.properties</strong>中添加mybaits的自动配置属性，可以查看<strong>MybatisProperties</strong>了解可以配置哪些属性</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment">#mapper配置文件路径，如果是基于注解的形式可以不需要配置该属性</span></span><br><span class="line"><span class="string">mybatis.mapper-locations=classpath:mapper/*.xml</span></span><br></pre></td></tr></table></figure>

<p>Mapper接口上要配置**@Mapper<strong>注解，因为</strong>mybatis-spring-boot-starter<strong>的自动配置会扫描</strong>@Mapper**注解来注册Mapper接口。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PersonMapper</span> </span>&#123;</span><br><span class="line">    <span class="comment">//………………</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时同样可以使用**@Transactional**注解</p>
<hr>
<p><strong>说明</strong><br>可以使用maven的mybatis-generator插件自动生成代码，参考<a href="http://hanqunfeng.iteye.com/admin/blogs/2328749">maven插件–MyBatis自动生成代码</a></p>
<hr>
<p><strong>mybatis-spring-boot-starter</strong>不利于扩展，所以还是我们自己实现个mybitas的配置类吧。</p>
<p><strong>pom</strong>中去掉<strong>mybatis-spring-boot-starter</strong>的依赖，增加mybatis的依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">&lt;dependency&gt;</span></span><br><span class="line"><span class="comment">    &lt;groupId&gt;org.mybatis.spring.boot&lt;/groupId&gt;</span></span><br><span class="line"><span class="comment">    &lt;artifactId&gt;mybatis-spring-boot-starter&lt;/artifactId&gt;</span></span><br><span class="line"><span class="comment">    &lt;version&gt;1.1.1&lt;/version&gt;</span></span><br><span class="line"><span class="comment">&lt;/dependency&gt;--&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--Mybatis--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.3.4.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>创建<strong>MyBatisConfig</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement(proxyTargetClass = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBatisConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.datasource.driver-class-name&#125;&quot;)</span></span><br><span class="line">    String driverClass;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.datasource.url&#125;&quot;)</span></span><br><span class="line">    String url;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.datasource.username&#125;&quot;)</span></span><br><span class="line">    String userName;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.datasource.password&#125;&quot;)</span></span><br><span class="line">    String passWord;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;dataSource&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        DriverManagerDataSource dataSource = <span class="keyword">new</span> DriverManagerDataSource();</span><br><span class="line">        dataSource.setDriverClassName(driverClass);</span><br><span class="line">        dataSource.setUrl(url);</span><br><span class="line">        dataSource.setUsername(userName);</span><br><span class="line">        dataSource.setPassword(passWord);</span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;sqlSessionFactory&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SqlSessionFactory <span class="title">sqlSessionFactoryBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        SqlSessionFactoryBean bean = <span class="keyword">new</span> SqlSessionFactoryBean();</span><br><span class="line">        bean.setDataSource(dataSource());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//添加XML目录</span></span><br><span class="line">        ResourcePatternResolver resolver = <span class="keyword">new</span> PathMatchingResourcePatternResolver();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            bean.setMapperLocations(resolver.getResources(<span class="string">&quot;classpath:mapper/*.xml&quot;</span>));</span><br><span class="line">            <span class="keyword">return</span> bean.getObject();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SqlSessionTemplate <span class="title">sqlSessionTemplate</span><span class="params">(SqlSessionFactory sqlSessionFactory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SqlSessionTemplate(sqlSessionFactory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PlatformTransactionManager <span class="title">annotationDrivenTransactionManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DataSourceTransactionManager(dataSource());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>MyBatisMapperScannerConfig</strong>，基于包扫描Mapper，此时不需要配置**@Mapper**注解</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">//必须在MyBatisConfig注册后再加载MapperScannerConfigurer，否则会报错</span></span><br><span class="line"><span class="meta">@AutoConfigureAfter(MyBatisConfig.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBatisMapperScannerConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MapperScannerConfigurer <span class="title">mapperScannerConfigurer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        MapperScannerConfigurer mapperScannerConfigurer = <span class="keyword">new</span> MapperScannerConfigurer();</span><br><span class="line">        mapperScannerConfigurer.setSqlSessionFactoryBeanName(<span class="string">&quot;sqlSessionFactory&quot;</span>);</span><br><span class="line">        mapperScannerConfigurer.setBasePackage(<span class="string">&quot;com.example.mapper&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> mapperScannerConfigurer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>关闭<strong>DataSourceAutoConfiguration</strong>，因为这里我们配置了数据源，所以需要关闭该自动配置，另外，<strong>MybatisAutoConfiguration</strong>也是基于<strong>DataSourceAutoConfiguration</strong>的，所以关闭了<strong>DataSourceAutoConfiguration</strong>也就同时关闭了<strong>MybatisAutoConfiguration</strong>。</p>
<hr>
<h2 id="Spring-Boot中Atomikos与Mybatis多数据源集成方法"><a href="#Spring-Boot中Atomikos与Mybatis多数据源集成方法" class="headerlink" title="Spring Boot中Atomikos与Mybatis多数据源集成方法"></a>Spring Boot中Atomikos与Mybatis多数据源集成方法</h2><p><strong>pom</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.3.4.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--Mybatis--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atomikos<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>transactions-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atomikos<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>transactions-jta<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atomikos<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>transactions<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atomikos<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>atomikos-util<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.transaction<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jta<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.37<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>MyBatisConfig</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement(proxyTargetClass = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBatisConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.datasource.driver-class-name&#125;&quot;)</span></span><br><span class="line">    String driverClass;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.datasource.url&#125;&quot;)</span></span><br><span class="line">    String url;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.datasource.username&#125;&quot;)</span></span><br><span class="line">    String userName;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.datasource.password&#125;&quot;)</span></span><br><span class="line">    String passWord;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.datasource.driver-class-name2&#125;&quot;)</span></span><br><span class="line">    String driverClass2;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.datasource.url2&#125;&quot;)</span></span><br><span class="line">    String url2;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.datasource.username2&#125;&quot;)</span></span><br><span class="line">    String userName2;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.datasource.password2&#125;&quot;)</span></span><br><span class="line">    String passWord2;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;userTransaction&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserTransaction <span class="title">userTransaction</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        UserTransactionImp userTransactionImp = <span class="keyword">new</span> UserTransactionImp();</span><br><span class="line">        userTransactionImp.setTransactionTimeout(<span class="number">10000</span>);</span><br><span class="line">        <span class="keyword">return</span> userTransactionImp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;atomikosTransactionManager&quot;, initMethod = &quot;init&quot;, destroyMethod = &quot;close&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TransactionManager <span class="title">atomikosTransactionManager</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        UserTransactionManager userTransactionManager = <span class="keyword">new</span> UserTransactionManager();</span><br><span class="line">        userTransactionManager.setForceShutdown(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> userTransactionManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;transactionManager&quot;)</span></span><br><span class="line">    <span class="meta">@DependsOn(&#123; &quot;userTransaction&quot;, &quot;atomikosTransactionManager&quot; &#125;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PlatformTransactionManager <span class="title">transactionManager</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        UserTransaction userTransaction = userTransaction();</span><br><span class="line">        TransactionManager atomikosTransactionManager = atomikosTransactionManager();</span><br><span class="line">        JtaTransactionManager jtaTransactionManager = <span class="keyword">new</span> JtaTransactionManager(userTransaction, atomikosTransactionManager);</span><br><span class="line">        jtaTransactionManager.setAllowCustomIsolationLevels(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> jtaTransactionManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;dataSource&quot;, initMethod = &quot;init&quot;, destroyMethod = &quot;close&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;dataSource init&quot;</span>);</span><br><span class="line">        MysqlXADataSource mysqlXaDataSource = <span class="keyword">new</span> MysqlXADataSource();</span><br><span class="line">        mysqlXaDataSource.setUrl(url);</span><br><span class="line">        mysqlXaDataSource.setPassword(passWord);</span><br><span class="line">        mysqlXaDataSource.setUser(userName);</span><br><span class="line">        mysqlXaDataSource.setPinGlobalTxToPhysicalConnection(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        AtomikosDataSourceBean xaDataSource = <span class="keyword">new</span> AtomikosDataSourceBean();</span><br><span class="line">        xaDataSource.setXaDataSource(mysqlXaDataSource);</span><br><span class="line">        xaDataSource.setUniqueResourceName(<span class="string">&quot;dataSource&quot;</span>);</span><br><span class="line">        xaDataSource.setMinPoolSize(<span class="number">10</span>);</span><br><span class="line">        xaDataSource.setPoolSize(<span class="number">10</span>);</span><br><span class="line">        xaDataSource.setMaxPoolSize(<span class="number">30</span>);</span><br><span class="line">        xaDataSource.setBorrowConnectionTimeout(<span class="number">60</span>);</span><br><span class="line">        xaDataSource.setReapTimeout(<span class="number">20</span>);</span><br><span class="line">        xaDataSource.setMaxIdleTime(<span class="number">60</span>);</span><br><span class="line">        xaDataSource.setMaintenanceInterval(<span class="number">60</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> xaDataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;dataSource2&quot;, initMethod = &quot;init&quot;, destroyMethod = &quot;close&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;dataSource2 init&quot;</span>);</span><br><span class="line">        MysqlXADataSource mysqlXaDataSource = <span class="keyword">new</span> MysqlXADataSource();</span><br><span class="line">        mysqlXaDataSource.setUrl(url2);</span><br><span class="line">        mysqlXaDataSource.setPassword(passWord2);</span><br><span class="line">        mysqlXaDataSource.setUser(userName2);</span><br><span class="line">        mysqlXaDataSource.setPinGlobalTxToPhysicalConnection(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        AtomikosDataSourceBean xaDataSource = <span class="keyword">new</span> AtomikosDataSourceBean();</span><br><span class="line">        xaDataSource.setXaDataSource(mysqlXaDataSource);</span><br><span class="line">        xaDataSource.setUniqueResourceName(<span class="string">&quot;dataSource2&quot;</span>);</span><br><span class="line">        xaDataSource.setMinPoolSize(<span class="number">10</span>);</span><br><span class="line">        xaDataSource.setPoolSize(<span class="number">10</span>);</span><br><span class="line">        xaDataSource.setMaxPoolSize(<span class="number">30</span>);</span><br><span class="line">        xaDataSource.setBorrowConnectionTimeout(<span class="number">60</span>);</span><br><span class="line">        xaDataSource.setReapTimeout(<span class="number">20</span>);</span><br><span class="line">        xaDataSource.setMaxIdleTime(<span class="number">60</span>);</span><br><span class="line">        xaDataSource.setMaintenanceInterval(<span class="number">60</span>);</span><br><span class="line">        <span class="keyword">return</span> xaDataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//基于xml式Mapper</span></span><br><span class="line">    <span class="meta">@Bean(name = &quot;sqlSessionFactory&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SqlSessionFactory <span class="title">sqlSessionFactoryBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        SqlSessionFactoryBean bean = <span class="keyword">new</span> SqlSessionFactoryBean();</span><br><span class="line">        bean.setDataSource(dataSource());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//添加Mapper配置文件的目录</span></span><br><span class="line">        ResourcePatternResolver resolver = <span class="keyword">new</span> PathMatchingResourcePatternResolver();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            bean.setMapperLocations(resolver.getResources(<span class="string">&quot;classpath:mapper/ds1/*.xml&quot;</span>));</span><br><span class="line">            <span class="keyword">return</span> bean.getObject();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;sqlSessionTemplate&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SqlSessionTemplate <span class="title">sqlSessionTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SqlSessionTemplate(sqlSessionFactoryBean());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//基于注解式Mapper</span></span><br><span class="line">    <span class="meta">@Bean(name = &quot;sqlSessionFactory2&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SqlSessionFactory <span class="title">sqlSessionFactoryBean2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        SqlSessionFactoryBean bean = <span class="keyword">new</span> SqlSessionFactoryBean();</span><br><span class="line">        bean.setDataSource(dataSource2());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> bean.getObject();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;sqlSessionTemplate2&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SqlSessionTemplate <span class="title">sqlSessionTemplate2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SqlSessionTemplate(sqlSessionFactoryBean2());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>MyBatisMapperScannerConfig</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">//必须在MyBatisConfig注册后再加载MapperScannerConfigurer，否则会报错</span></span><br><span class="line"><span class="meta">@AutoConfigureAfter(MyBatisConfig.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBatisMapperScannerConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MapperScannerConfigurer <span class="title">mapperScannerConfigurer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        MapperScannerConfigurer mapperScannerConfigurer = <span class="keyword">new</span> MapperScannerConfigurer();</span><br><span class="line">        <span class="comment">//绑定datasorce的sqlSessionFactory</span></span><br><span class="line">        mapperScannerConfigurer.setSqlSessionFactoryBeanName(<span class="string">&quot;sqlSessionFactory&quot;</span>);</span><br><span class="line">        <span class="comment">//扫描ds1目录来注册Mapper接口</span></span><br><span class="line">        mapperScannerConfigurer.setBasePackage(<span class="string">&quot;com.example.mapper.ds1&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> mapperScannerConfigurer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MapperScannerConfigurer <span class="title">mapperScannerConfigurer2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        MapperScannerConfigurer mapperScannerConfigurer = <span class="keyword">new</span> MapperScannerConfigurer();</span><br><span class="line">        <span class="comment">//绑定datasorce2的sqlSessionFactory</span></span><br><span class="line">        mapperScannerConfigurer.setSqlSessionFactoryBeanName(<span class="string">&quot;sqlSessionFactory2&quot;</span>);</span><br><span class="line">        <span class="comment">//扫描ds2目录来注册Mapper接口</span></span><br><span class="line">        mapperScannerConfigurer.setBasePackage(<span class="string">&quot;com.example.mapper.ds2&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> mapperScannerConfigurer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里要说明的是，如果两个数据源下的Mapper起了相同的类名，虽然他们在不同的包路径下，启动也会报错了，因为默认注册Mapper时使用的是类名称（不含包名），此时可以在Mapper上加上**@Component(“personMapper”)**注解</p>
<hr>
<h2 id="写在后面的话"><a href="#写在后面的话" class="headerlink" title="写在后面的话"></a>写在后面的话</h2><p>Spring Boot为我们提供了大量的<strong>spring-boot-starter-xxx</strong>来加快我们的开发流程，创建项目时就可以看到可供选择的各种<strong>spring-boot-starter-xxx</strong>，那么这么多的<strong>spring-boot-starter-xxx</strong>，我们是否都需要了解呢，如果项目中需要用到某一个功能，是否就应该加入这个<strong>spring-boot-starter-xxx</strong>呢？</p>
<p>笔者人为，<strong>spring-boot-starter-xxx</strong>提供的完整jar包依赖和自动配置固然很好，但是当我们要在项目中加入某一个功能时，作为开发人员，是应该清楚的知道该功能的依赖关系和配置逻辑的，所以并不一定需要引入SpringBoot的<strong>spring-boot-starter-xxx</strong>，而且SpringBoot对这些<strong>spring-boot-starter-xxx</strong>做的自动配置，如果我们并不熟悉和十分清楚，往往会给我们开发人员造成不明所以的困扰，所以，笔者建议，在对SpringBoot提供的某一个<strong>spring-boot-starter-xxx</strong>所提供的功能并不十分清楚时，还是使用配置类的方式吧。</p>
<p>还有，由于某些自动配置类的激活是根据项目中是否包含某个class或容器中是否注册了某个bean，所以笔者建议，如果项目中引入了新的jar包，或者手工注册了某个bean，都要通过debug的方式查看是否开启了某个自动配置。</p>
<p>另外，本文代码只是为了辅助说明，比如<strong>DriverManagerDataSource</strong>正式环境不建议使用，请更换为其它数据源，比如<strong>BasicDataSource</strong>。</p>
<p>本文示例代码下载地址：<a href="https://github.com/hanqunfeng/SpringBootStudy">https://github.com/hanqunfeng/SpringBootStudy</a></p>
]]></content>
      <categories>
        <category>技术</category>
        <category>Java</category>
        <category>springboot</category>
      </categories>
      <tags>
        <tag>Spring Boot</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Boot学习笔记03--深入了解SpringBoot的启动过程</title>
    <url>/2016/12/13/spring-boot-study-springapplication/</url>
    <content><![CDATA[<h2 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h2><p>看完本文你将掌握如下知识点：</p>
<ol>
<li>SpringApplication的作用及运行过程</li>
<li>SpringBootServletInitializer的作用及运行过程</li>
</ol>
<p><strong>PS:本节内容略显枯燥，如果对SpringBoot的启动过程不感兴趣，可以略过。</strong></p>
<span id="more"></span>

<hr>
<p><strong>SpringBoot系列</strong>：<a href="/tags/Spring-Boot/">Spring Boot学习笔记</a></p>
<hr>
<h2 id="深入了解SpringApplication"><a href="#深入了解SpringApplication" class="headerlink" title="深入了解SpringApplication"></a>深入了解SpringApplication</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringBootWebDemoApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(SpringBootWebDemoApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这就是SpringBoot的启动入口，通过前面的学习我们大体上了解了**@SpringBootApplication<strong>的作用，接下来我们来认识一下</strong>SpringApplication**。<br><a href="http://docs.spring.io/spring-boot/docs/current/api/org/springframework/boot/SpringApplication.html">SpringApplication (Spring Boot Docs 1.4.2.RELEASE API)</a>。</p>
<h3 id="SpringApplication-run-SpringBootWebDemoApplication-class-args"><a href="#SpringApplication-run-SpringBootWebDemoApplication-class-args" class="headerlink" title="SpringApplication.run(SpringBootWebDemoApplication.class, args);"></a>SpringApplication.run(SpringBootWebDemoApplication.class, args);</h3><p>通过源码我们来看一下**SpringApplication.run()**方法的执行过程<br>1.调用static方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//1</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ConfigurableApplicationContext <span class="title">run</span><span class="params">(Object source, String... args)</span> </span>&#123;<span class="keyword">return</span> run(<span class="keyword">new</span> Object[]&#123;source&#125;, args);&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ConfigurableApplicationContext <span class="title">run</span><span class="params">(Object[] sources, String[] args)</span></span></span><br><span class="line"><span class="function"></span>&#123;<span class="keyword">return</span> (<span class="keyword">new</span> SpringApplication(sources)).run(args);&#125;</span><br></pre></td></tr></table></figure>

<p>2.创建SpringApplication对象</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//2</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">SpringApplication</span><span class="params">(Object... sources)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.bannerMode = Mode.CONSOLE; <span class="comment">//banner的打印模式，此时是控制台模式</span></span><br><span class="line">        <span class="keyword">this</span>.logStartupInfo = <span class="keyword">true</span>; <span class="comment">//开启日志</span></span><br><span class="line">        <span class="keyword">this</span>.addCommandLineProperties = <span class="keyword">true</span>;<span class="comment">//启用CommandLineProperties</span></span><br><span class="line">        <span class="keyword">this</span>.headless = <span class="keyword">true</span>;<span class="comment">//开启headless模式支持</span></span><br><span class="line">        <span class="keyword">this</span>.registerShutdownHook = <span class="keyword">true</span>;<span class="comment">//启用注册ShutdownHook，用于在非Web应用中关闭IoC容器和资源</span></span><br><span class="line">        <span class="keyword">this</span>.additionalProfiles = <span class="keyword">new</span> HashSet();</span><br><span class="line">        <span class="keyword">this</span>.initialize(sources);<span class="comment">//初始化</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>PS：Headless参考资料：<a href="https://www.oschina.net/translate/using-headless-mode-in-java-se">在 Java SE 平台上使用 Headless 模式</a></p>
<p>3.初始化相关对象和属性</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//3</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(Object[] sources)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(sources != <span class="keyword">null</span> &amp;&amp; sources.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.sources.addAll(Arrays.asList(sources));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//3.1判断是否是web运行环境，如果classpath中是否含有**WEB_ENVIRONMENT_CLASSES**指定的全部类，则返回true</span></span><br><span class="line">        <span class="keyword">this</span>.webEnvironment = <span class="keyword">this</span>.deduceWebEnvironment();</span><br><span class="line">        <span class="comment">//3.2找到*META-INF/spring.factories*中声明的所有ApplicationContextInitializer的实现类并将其实例化</span></span><br><span class="line">        <span class="keyword">this</span>.setInitializers(<span class="keyword">this</span>.getSpringFactoriesInstances(ApplicationContextInitializer.class));</span><br><span class="line">        <span class="comment">//3.3找到*META-INF/spring.factories*中声明的所有ApplicationListener的实现类并将其实例化</span></span><br><span class="line">        <span class="keyword">this</span>.setListeners(<span class="keyword">this</span>.getSpringFactoriesInstances(ApplicationListener.class));</span><br><span class="line">        <span class="comment">//3.4获得当前执行main方法的类对象，这里就是SpringBootWebDemoApplication的实例</span></span><br><span class="line">        <span class="keyword">this</span>.mainApplicationClass = <span class="keyword">this</span>.deduceMainApplicationClass();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>3.1 判断是否是web运行环境<br>如果classpath中是否含有<strong>WEB_ENVIRONMENT_CLASSES</strong>指定的全部类，则返回true，用于创建指定类型的ApplicationContext对象。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//3.1</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] WEB_ENVIRONMENT_CLASSES = <span class="keyword">new</span> String[]&#123;<span class="string">&quot;javax.servlet.Servlet&quot;</span>, <span class="string">&quot;org.springframework.web.context.ConfigurableWebApplicationContext&quot;</span>&#125;;</span><br></pre></td></tr></table></figure>

<p>3.2 大体的过程就是通过<em>SpringFactoriesLoader</em>检索<em>META-INF/spring.factories</em>，找到声明的所有ApplicationContextInitializer的实现类并将其实例化。<br><strong>ApplicationContextInitializer</strong>是Spring框架中的接口，其作用可以理解为在ApplicationContext执行refresh之前，调用<em>ApplicationContextInitializer</em>的initialize()方法，对ApplicationContext做进一步的设置和处理。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ApplicationContextInitializer</span>&lt;<span class="title">C</span> <span class="keyword">extends</span> <span class="title">ConfigurableApplicationContext</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">initialize</span><span class="params">(C var1)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><em>spring-boot-1.4.2.RELEASE.jar</em>中的<em>META-INF/spring.factories</em>包含的<strong>ApplicationContextInitializer</strong></p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Application Context Initializers</span></span><br><span class="line"><span class="string">org.springframework.context.ApplicationContextInitializer=\</span></span><br><span class="line"><span class="string">org.springframework.boot.context.ConfigurationWarningsApplicationContextInitializer,\</span></span><br><span class="line"><span class="string">org.springframework.boot.context.ContextIdApplicationContextInitializer,\</span></span><br><span class="line"><span class="string">org.springframework.boot.context.config.DelegatingApplicationContextInitializer,\</span></span><br><span class="line"><span class="string">org.springframework.boot.context.web.ServerPortInfoApplicationContextInitializer</span></span><br></pre></td></tr></table></figure>

<p><em>spring-boot-autoconfigure-1.4.2.RELEASE.jar</em>中的<em>META-INF/spring.factories</em>包含的<strong>ApplicationContextInitializer</strong></p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Initializers</span></span><br><span class="line"><span class="string">org.springframework.context.ApplicationContextInitializer=\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.SharedMetadataReaderFactoryContextInitializer,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.logging.AutoConfigurationReportLoggingInitializer</span></span><br></pre></td></tr></table></figure>

<p>3.3 大体的过程就是通过<em>SpringFactoriesLoader</em>检索<em>META-INF/spring.factories</em>，找到声明的所有ApplicationListener的实现类并将其实例化。<br><strong>ApplicationListener</strong>是Spring框架中的接口，就是事件监听器，其作用可以理解为在<strong>SpringApplicationRunListener</strong>发布通知事件时，由<strong>ApplicationListener</strong>负责接收。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ApplicationListener</span>&lt;<span class="title">E</span> <span class="keyword">extends</span> <span class="title">ApplicationEvent</span>&gt; <span class="keyword">extends</span> <span class="title">EventListener</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(E var1)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SpringBoot只提供了一个<strong>SpringApplicationRunListener</strong>的实现类，就是<strong>EventPublishingRunListener</strong>，起作用就是在SpringBoot启动过程中，负责注册<em>ApplicationListener</em>监听器，在不同的时点发布不同的事件类型，如果有哪些<strong>ApplicationListener</strong>的实现类监听了这些事件，则可以接收并处理。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SpringApplicationRunListener</span> </span>&#123;</span><br><span class="line">    <span class="comment">//通知监听器，SpringBoot开始执行</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">started</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">//通知监听器，Environment准备完成</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">environmentPrepared</span><span class="params">(ConfigurableEnvironment var1)</span></span>;</span><br><span class="line">    <span class="comment">//通知监听器，ApplicationContext已经创建并初始化完成</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">contextPrepared</span><span class="params">(ConfigurableApplicationContext var1)</span></span>;</span><br><span class="line">    <span class="comment">//通知监听器，ApplicationContext已经完成IoC配置加载</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">contextLoaded</span><span class="params">(ConfigurableApplicationContext var1)</span></span>;</span><br><span class="line">    <span class="comment">//通知监听器，SpringBoot启动完成</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">finished</span><span class="params">(ConfigurableApplicationContext var1, Throwable var2)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><em>spring-boot-1.4.2.RELEASE.jar</em>中的<em>META-INF/spring.factories</em>包含的<strong>ApplicationListener</strong></p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Application Listeners</span></span><br><span class="line"><span class="string">org.springframework.context.ApplicationListener=\</span></span><br><span class="line"><span class="string">org.springframework.boot.ClearCachesApplicationListener,\</span></span><br><span class="line"><span class="string">org.springframework.boot.builder.ParentContextCloserApplicationListener,\</span></span><br><span class="line"><span class="string">org.springframework.boot.context.FileEncodingApplicationListener,\</span></span><br><span class="line"><span class="string">org.springframework.boot.context.config.AnsiOutputApplicationListener,\</span></span><br><span class="line"><span class="string">org.springframework.boot.context.config.ConfigFileApplicationListener,\</span></span><br><span class="line"><span class="string">org.springframework.boot.context.config.DelegatingApplicationListener,\</span></span><br><span class="line"><span class="string">org.springframework.boot.liquibase.LiquibaseServiceLocatorApplicationListener,\</span></span><br><span class="line"><span class="string">org.springframework.boot.logging.ClasspathLoggingApplicationListener,\</span></span><br><span class="line"><span class="string">org.springframework.boot.logging.LoggingApplicationListener</span></span><br></pre></td></tr></table></figure>

<p><em>spring-boot-autoconfigure-1.4.2.RELEASE.jar</em>中的<em>META-INF/spring.factories</em>包含的<strong>ApplicationListener</strong></p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Application Listeners</span></span><br><span class="line"><span class="string">org.springframework.context.ApplicationListener=\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.BackgroundPreinitializer</span></span><br></pre></td></tr></table></figure>

<p><em>spring-boot-1.4.2.RELEASE.jar</em>中的<em>META-INF/spring.factories</em>包含的<strong>SpringApplicationRunListener</strong></p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Run Listeners</span></span><br><span class="line"><span class="string">org.springframework.boot.SpringApplicationRunListener=\</span></span><br><span class="line"><span class="string">org.springframework.boot.context.event.EventPublishingRunListener</span></span><br></pre></td></tr></table></figure>


<p>3.4 获得当前执行main方法的类对象，这里就是SpringBootWebDemoApplication的实例。</p>
<p>4.核心方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//4</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ConfigurableApplicationContext <span class="title">run</span><span class="params">(String... args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//开启任务执行时间监听器</span></span><br><span class="line">        StopWatch stopWatch = <span class="keyword">new</span> StopWatch();</span><br><span class="line">        stopWatch.start();</span><br><span class="line"></span><br><span class="line">        ConfigurableApplicationContext context = <span class="keyword">null</span>;</span><br><span class="line">        Object analyzers = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置系统属性『java.awt.headless』，为true则启用headless模式支持</span></span><br><span class="line">        <span class="keyword">this</span>.configureHeadlessProperty();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//通过*SpringFactoriesLoader*检索*META-INF/spring.factories*，</span></span><br><span class="line">        <span class="comment">//找到声明的所有SpringApplicationRunListener的实现类并将其实例化，</span></span><br><span class="line">        <span class="comment">//之后逐个调用其started()方法，广播SpringBoot要开始执行了。</span></span><br><span class="line">        SpringApplicationRunListeners listeners = <span class="keyword">this</span>.getRunListeners(args);</span><br><span class="line">        listeners.started();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            DefaultApplicationArguments ex = <span class="keyword">new</span> DefaultApplicationArguments(args);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//创建并配置当前SpringBoot应用将要使用的Environment（包括配置要使用的PropertySource以及Profile）,</span></span><br><span class="line">            <span class="comment">//并遍历调用所有的SpringApplicationRunListener的environmentPrepared()方法，广播Environment准备完毕。</span></span><br><span class="line">            ConfigurableEnvironment environment = <span class="keyword">this</span>.prepareEnvironment(listeners, ex);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//决定是否打印Banner</span></span><br><span class="line">            Banner printedBanner = <span class="keyword">this</span>.printBanner(environment);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//根据webEnvironment的值来决定创建何种类型的ApplicationContext对象</span></span><br><span class="line">            <span class="comment">//如果是web环境，则创建org.springframework.boot.context.embedded.AnnotationConfigEmbeddedWebApplicationContext</span></span><br><span class="line">            <span class="comment">//否则创建org.springframework.context.annotation.AnnotationConfigApplicationContext</span></span><br><span class="line">            context = <span class="keyword">this</span>.createApplicationContext();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//注册异常分析器</span></span><br><span class="line">            <span class="keyword">new</span> FailureAnalyzers(context);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//为ApplicationContext加载environment，之后逐个执行ApplicationContextInitializer的initialize()方法来进一步封装ApplicationContext，</span></span><br><span class="line">            <span class="comment">//并调用所有的SpringApplicationRunListener的contextPrepared()方法，【EventPublishingRunListener只提供了一个空的contextPrepared()方法】，</span></span><br><span class="line">            <span class="comment">//之后初始化IoC容器，并调用SpringApplicationRunListener的contextLoaded()方法，广播ApplicationContext的IoC加载完成，</span></span><br><span class="line">            <span class="comment">//这里就包括通过**@EnableAutoConfiguration**导入的各种自动配置类。</span></span><br><span class="line">            <span class="keyword">this</span>.prepareContext(context, environment, listeners, ex, printedBanner);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//初始化所有自动配置类，调用ApplicationContext的refresh()方法</span></span><br><span class="line">            <span class="keyword">this</span>.refreshContext(context);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//遍历所有注册的ApplicationRunner和CommandLineRunner，并执行其run()方法。</span></span><br><span class="line">            <span class="comment">//该过程可以理解为是SpringBoot完成ApplicationContext初始化前的最后一步工作，</span></span><br><span class="line">            <span class="comment">//我们可以实现自己的ApplicationRunner或者CommandLineRunner，来对SpringBoot的启动过程进行扩展。</span></span><br><span class="line">            <span class="keyword">this</span>.afterRefresh(context, ex);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//调用所有的SpringApplicationRunListener的finished()方法，广播SpringBoot已经完成了ApplicationContext初始化的全部过程。</span></span><br><span class="line">            listeners.finished(context, (Throwable)<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//关闭任务执行时间监听器</span></span><br><span class="line">            stopWatch.stop();</span><br><span class="line">            <span class="comment">//如果开启日志，则答应执行是时间</span></span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">this</span>.logStartupInfo) &#123;</span><br><span class="line">                (<span class="keyword">new</span> StartupInfoLogger(<span class="keyword">this</span>.mainApplicationClass)).logStarted(<span class="keyword">this</span>.getApplicationLog(), stopWatch);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> context;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var9) &#123;</span><br><span class="line">            <span class="comment">//调用异常分析器打印报告，调用所有的SpringApplicationRunListener的finished()方法将异常信息发布出去</span></span><br><span class="line">            <span class="keyword">this</span>.handleRunFailure(context, listeners, (FailureAnalyzers)analyzers, var9);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(var9);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><em>spring-boot-1.4.2.RELEASE.jar</em>中的<em>META-INF/spring.factories</em>包含的<strong>FailureAnalyzer</strong>和<strong>FailureAnalysisReporters</strong></p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Failure Analyzers</span></span><br><span class="line"><span class="string">org.springframework.boot.diagnostics.FailureAnalyzer=\</span></span><br><span class="line"><span class="string">org.springframework.boot.diagnostics.analyzer.BeanCurrentlyInCreationFailureAnalyzer,\</span></span><br><span class="line"><span class="string">org.springframework.boot.diagnostics.analyzer.BeanNotOfRequiredTypeFailureAnalyzer,\</span></span><br><span class="line"><span class="string">org.springframework.boot.diagnostics.analyzer.BindFailureAnalyzer,\</span></span><br><span class="line"><span class="string">org.springframework.boot.diagnostics.analyzer.ConnectorStartFailureAnalyzer,\</span></span><br><span class="line"><span class="string">org.springframework.boot.diagnostics.analyzer.NoUniqueBeanDefinitionFailureAnalyzer,\</span></span><br><span class="line"><span class="string">org.springframework.boot.diagnostics.analyzer.PortInUseFailureAnalyzer,\</span></span><br><span class="line"><span class="string">org.springframework.boot.diagnostics.analyzer.ValidationExceptionFailureAnalyzer</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># FailureAnalysisReporters</span></span><br><span class="line"><span class="string">org.springframework.boot.diagnostics.FailureAnalysisReporter=\</span></span><br><span class="line"><span class="string">org.springframework.boot.diagnostics.LoggingFailureAnalysisReporter</span></span><br></pre></td></tr></table></figure>

<hr>
<p><strong>说明</strong></p>
<ul>
<li>SpringBoot的启动过程，实际上就是对ApplicationContext的初始化过程。</li>
<li>ApplicationContext创建后立刻为其设置Environmen，并由<strong>ApplicationContextInitializer</strong>对其进一步封装。</li>
<li>通过<em>SpringApplicationRunListener</em>在ApplicationContext初始化过程中各个时点发布各种广播事件，并由<em>ApplicationListener</em>负责接收广播事件。</li>
<li>初始化过程中完成IoC的注入，包括通过**@EnableAutoConfiguration**导入的各种自动配置类。</li>
<li>初始化完成前调用ApplicationRunner和CommandLineRunner的实现类。</li>
</ul>
<hr>
<h3 id="扩展SpringApplication"><a href="#扩展SpringApplication" class="headerlink" title="扩展SpringApplication"></a>扩展SpringApplication</h3><p>通过上面的学习，我们基本上了解了，如果要对SpringApplication进行扩展，我们可以选择如下三种方案：</p>
<ul>
<li>创建ApplicationContextInitializer的实现类</li>
<li>创建ApplicationListener的实现类</li>
<li>创建ApplicationRunner和CommandLineRunner的实现类</li>
</ul>
<p>1.可以通过如下方式加载自定义的<em>ApplicationContextInitializer</em>和<em>ApplicationListener</em></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringBootWebDemoApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//SpringApplication.run(SpringBootWebDemoApplication.class, args);</span></span><br><span class="line">        SpringApplication springApplication = <span class="keyword">new</span> SpringApplication(SpringBootWebDemoApplication.class);</span><br><span class="line"></span><br><span class="line">        springApplication.addInitializers(MyApplicationContextInitializer1,MyApplicationContextInitializer2);</span><br><span class="line"></span><br><span class="line">        springApplication.addListeners(MyApplicationListener1,MyApplicationListener2);</span><br><span class="line"></span><br><span class="line">        springApplication.run(args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2.也可以在当前项目的类路径下创建<em>META-INF/spring.factories</em>文件，并声明相应的<em>ApplicationContextInitializer</em>和<em>ApplicationListener</em></p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="string">org.springframework.context.ApplicationContextInitializer=\</span></span><br><span class="line"><span class="string">xxx.xxx.MyApplicationContextInitializer1,\</span></span><br><span class="line"><span class="string">xxx.xxx.MyApplicationContextInitializer2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Application Listeners</span></span><br><span class="line"><span class="string">org.springframework.context.ApplicationListener=\</span></span><br><span class="line"><span class="string">xxx.xxx.MyApplicationListener1,\</span></span><br><span class="line"><span class="string">xxx.xxx.MyApplicationListener2</span></span><br></pre></td></tr></table></figure>

<p>3.至于ApplicationRunner和CommandLineRunner，只需要在其实现类上加上**@Component**注解或者在@Configuration配置类中通过@Bean注解注入。</p>
<hr>
<h2 id="深入了解SpringBootServletInitializer"><a href="#深入了解SpringBootServletInitializer" class="headerlink" title="深入了解SpringBootServletInitializer"></a>深入了解SpringBootServletInitializer</h2><p>熟悉了<strong>SpringApplication</strong>的原理之后，我们再来了解<strong>SpringBootServletInitializer</strong>的原理就比较容易了。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServletInitializer</span> <span class="keyword">extends</span> <span class="title">SpringBootServletInitializer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> SpringApplicationBuilder <span class="title">configure</span><span class="params">(SpringApplicationBuilder application)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> application.sources(DemoWarApplication.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SpringBootServletInitializer就是一个<em>org.springframework.web.WebApplicationInitializer</em>，容器启动时会调用其onStartup(ServletContext servletContext)方法，接下来我么就来看一下这个方法:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStartup</span><span class="params">(ServletContext servletContext)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.logger = LogFactory.getLog(<span class="keyword">this</span>.getClass());</span><br><span class="line">        <span class="keyword">final</span> WebApplicationContext rootAppContext = <span class="keyword">this</span>.createRootApplicationContext(servletContext);</span><br><span class="line">        <span class="keyword">if</span>(rootAppContext != <span class="keyword">null</span>) &#123;</span><br><span class="line">            servletContext.addListener(<span class="keyword">new</span> ContextLoaderListener(rootAppContext) &#123;</span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextInitialized</span><span class="params">(ServletContextEvent event)</span> </span>&#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.logger.debug(<span class="string">&quot;No ContextLoaderListener registered, as createRootApplicationContext() did not return an application context&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这里的核心方法就是createRootApplicationContext(servletContext)：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> WebApplicationContext <span class="title">createRootApplicationContext</span><span class="params">(ServletContext servletContext)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建SpringApplicationBuilder，并用其生产出SpringApplication对象</span></span><br><span class="line">        SpringApplicationBuilder builder = <span class="keyword">this</span>.createSpringApplicationBuilder();</span><br><span class="line">        builder.main(<span class="keyword">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">        ApplicationContext parent = <span class="keyword">this</span>.getExistingRootWebApplicationContext(servletContext);</span><br><span class="line">        <span class="keyword">if</span>(parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.logger.info(<span class="string">&quot;Root context already created (using as parent).&quot;</span>);</span><br><span class="line">            servletContext.setAttribute(WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE, (Object)<span class="keyword">null</span>);</span><br><span class="line">            builder.initializers(<span class="keyword">new</span> ApplicationContextInitializer[]&#123;<span class="keyword">new</span> ParentContextApplicationContextInitializer(parent)&#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//初始化并封装SpringApplicationBuilder对象，为SpringApplication对象增加ApplicationContextInitializer和ApplicationListener做准备</span></span><br><span class="line">        builder.initializers(<span class="keyword">new</span> ApplicationContextInitializer[]&#123;<span class="keyword">new</span> ServletContextApplicationContextInitializer(servletContext)&#125;);</span><br><span class="line">        builder.listeners(<span class="keyword">new</span> ApplicationListener[]&#123;<span class="keyword">new</span> ServletContextApplicationListener(servletContext)&#125;);</span><br><span class="line">        <span class="comment">//指定创建的ApplicationContext类型</span></span><br><span class="line">        builder.contextClass(AnnotationConfigEmbeddedWebApplicationContext.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//传递入口类，并构建SpringApplication对象</span></span><br><span class="line">        <span class="comment">//可以通过configure()方法对SpringBootServletInitializer进行扩展</span></span><br><span class="line">        builder = <span class="keyword">this</span>.configure(builder);</span><br><span class="line">        SpringApplication application = builder.build();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(application.getSources().isEmpty() &amp;&amp; AnnotationUtils.findAnnotation(<span class="keyword">this</span>.getClass(), Configuration.class) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            application.getSources().add(<span class="keyword">this</span>.getClass());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Assert.state(!application.getSources().isEmpty(), <span class="string">&quot;No SpringApplication sources have been defined. Either override the configure method or add an @Configuration annotation&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.registerErrorPageFilter) &#123;</span><br><span class="line">            application.getSources().add(ErrorPageFilter.class);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//最后调用SpringApplication的run方法</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.run(application);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>说明</strong><br><strong>SpringBootServletInitializer</strong>的执行过程，简单来说就是通过<em>SpringApplicationBuilder</em>构建并封装SpringApplication对象，并最终调用SpringApplication的run方法的过程。</p>
<hr>
<h3 id="扩展SpringBootServletInitializer"><a href="#扩展SpringBootServletInitializer" class="headerlink" title="扩展SpringBootServletInitializer"></a>扩展SpringBootServletInitializer</h3><p>与扩展<em>SpringApplication</em>类似，<em>ApplicationContextInitializer</em>和<em>ApplicationListener</em>可以基于<em>SpringApplicationBuilder</em>提供的public方法进行扩展</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServletInitializer</span> <span class="keyword">extends</span> <span class="title">SpringBootServletInitializer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> SpringApplicationBuilder <span class="title">configure</span><span class="params">(SpringApplicationBuilder application)</span> </span>&#123;</span><br><span class="line">        application.initializers(MyApplicationContextInitializer1,MyApplicationContextInitializer2);</span><br><span class="line">        application.listeners(MyApplicationListener1,MyApplicationListener2)</span><br><span class="line">        <span class="keyword">return</span> application.sources(DemoWarApplication.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>技术</category>
        <category>Java</category>
        <category>springboot</category>
      </categories>
      <tags>
        <tag>Spring Boot</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Boot学习笔记02--深入了解自动配置</title>
    <url>/2016/12/10/spring-boot-study-web/</url>
    <content><![CDATA[<h2 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h2><p>看完本文你将掌握如下知识点：</p>
<ol>
<li>SpringBoot都帮我们做了哪些自动配置</li>
<li>我们如何接管SpringBoot的自动配置</li>
<li>注册Servlet、Filter、Listener的方法</li>
</ol>
<span id="more"></span>

<hr>
<p><strong>SpringBoot系列</strong>：<a href="/tags/Spring-Boot/">Spring Boot学习笔记</a></p>
<hr>
<h2 id="SpringBoot的自动配置"><a href="#SpringBoot的自动配置" class="headerlink" title="SpringBoot的自动配置"></a>SpringBoot的自动配置</h2><p>1.自动配置类都存放在<em>spring-boot-autoconfigure-1.4.2.RELEASE.jar</em>下的<br><em>org.springframework.boot.autoconfigure</em>路径下；<br>2.application.properties中配置<code>debug=true</code>后启动容器，可以看到服务器初始化的自动配置如下:</p>
<ul>
<li>DispatcherServletAutoConfiguration<br>注册<strong>org.springframework.web.servlet.DispatcherServlet</strong></li>
<li>EmbeddedServletContainerAutoConfiguration<br>注册容器类型，如类路径下存在<strong>org.apache.catalina.startup.Tomcat</strong>，就会注册Tomcat容器</li>
<li>ErrorMvcAutoConfiguration<br>注册异常处理器</li>
<li>HttpEncodingAutoConfiguration<br>注册http编码过滤器</li>
<li>HttpMessageConvertersAutoConfiguration<br>注册json或者xml处理器</li>
<li>JacksonAutoConfiguration<br>注册json对象解析器</li>
<li>JmxAutoConfiguration<br>注册<a href="http://baike.baidu.com/link?url=UrBouL697r00U6pJyc5IXwk_GiFaWf0di0wZEpG9J9obYa69_7nApO5iddAuj4ajDz0hwJZ8CA-iBghoyqI39a">JMX</a>管理器<blockquote>
<p><a href="https://my.oschina.net/bayuanqian/blog/90043">JMX与Spring集成</a><br><a href="http://blog.csdn.net/yaerfeng/article/details/28232435">spring通过annotation注解注册MBean到JMX实现监控java运行状态</a></p>
</blockquote>
</li>
<li>MultipartAutoConfiguration<br>注册文件传输处理器</li>
<li>ServerPropertiesAutoConfiguration<br>用于初始化容器相关的配置属性，如服务地址、端口、contextPath，并根据当前容器类型初始化各个容器的特有属性，如tomcat的maxThreads、uriEncoding等等，其对应的属性类为<strong>ServerProperties</strong>；</li>
<li>WebClientAutoConfiguration<br>注册RestTemplate</li>
<li>WebMvcAutoConfiguration<br>注册SpringMvc相关处理器，如ResourceResolver、RequestMappingHandlerAdapter、ExceptionHandlerExceptionResolver、ViewResolver、LocaleResolver，等等</li>
<li>WebSocketAutoConfiguration<br>注册webSocket相关处理器，根据容器类型注册不同的处理器</li>
</ul>
<p>3.如果依赖中加入了其它功能的依赖，SpringBoot还会实现这些功能的自动适配，比如我们增加数据库的JPA的功能，就会启用对<em>JpaRepositoriesAutoConfiguration</em>的自动配置功能。关于数据库方面的内容将在后文介绍。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<hr>
<p><strong>说明</strong><br>从各个AutoConfiguration配置类中可以看到如下注解，基于这些注解可以确定这些AutoConfiguration的初始化顺序：</p>
<ul>
<li>@AutoConfigureOrder(-2147483648)：数越小越先初始化</li>
<li>@AutoConfigureAfter({EmbeddedServletContainerAutoConfiguration.class})：在指定的配置类初始化后再加载</li>
<li>@AutoConfigureBefore({WebMvcAutoConfiguration.class})：在指定的配置类初始化前加载</li>
</ul>
<hr>
<h2 id="接管SpringBoot的自动配置"><a href="#接管SpringBoot的自动配置" class="headerlink" title="接管SpringBoot的自动配置"></a>接管SpringBoot的自动配置</h2><p>我们介绍过**@SpringBootApplication<strong>这个注解，因其包含</strong>@EnableAutoConfiguration<strong>和</strong>@ComponentScan**注解，可以自动扫描相关的自动配置类，从而实现自动配置功能的。<br>上面介绍默认情况下SpringBoot默认会初始化很多的自动配置，这些配置有些我们在项目中可能用不到，那要如何去掉呢？</p>
<h3 id="去掉不需要的自动配置类"><a href="#去掉不需要的自动配置类" class="headerlink" title="去掉不需要的自动配置类"></a>去掉不需要的自动配置类</h3><p>比如我们不需要开启webSocket和JMX的自动配置，我们需要在**@SpringBootApplication<strong>这个注解中指定</strong>exclude**属性</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication(exclude = &#123;WebSocketAutoConfiguration.class,JmxAutoConfiguration.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringBootWebDemoApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(SpringBootWebDemoApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="明确指定需要启用哪些自动配置"><a href="#明确指定需要启用哪些自动配置" class="headerlink" title="明确指定需要启用哪些自动配置"></a>明确指定需要启用哪些自动配置</h3><p>我们可以去掉**@SpringBootApplication<strong>注解，改用*@Configuration、@Import、@ComponentScan*注解，在</strong>@Import**注解中明确指定需要启用哪些自动配置</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//@SpringBootApplication(exclude = &#123;WebSocketAutoConfiguration.class,JmxAutoConfiguration.class&#125;)</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Import(&#123;</span></span><br><span class="line"><span class="meta">        DispatcherServletAutoConfiguration.class,</span></span><br><span class="line"><span class="meta">        EmbeddedServletContainerAutoConfiguration.class,</span></span><br><span class="line"><span class="meta">        ErrorMvcAutoConfiguration.class,</span></span><br><span class="line"><span class="meta">        HttpEncodingAutoConfiguration.class,</span></span><br><span class="line"><span class="meta">        HttpMessageConvertersAutoConfiguration.class,</span></span><br><span class="line"><span class="meta">        JacksonAutoConfiguration.class,</span></span><br><span class="line"><span class="meta">        MultipartAutoConfiguration.class,</span></span><br><span class="line"><span class="meta">        ServerPropertiesAutoConfiguration.class,</span></span><br><span class="line"><span class="meta">        WebMvcAutoConfiguration.class</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="meta">@ComponentScan</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringBootWebDemoApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(SpringBootWebDemoApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>说明：</strong></p>
<ul>
<li>这里推荐使用第一种方式：**@SpringBootApplication(exclude={})**；</li>
<li>实际上，开启默认的自动配置功能，只是会影响项目启动时间，所以没有特殊需要，可以不需要关闭某个自动配置功能；</li>
<li>在某些情况，比如项目需要多数据源时，在项目中就会包含多个DataSource的Bean，因为<strong>DataSourceAutoConfiguration</strong>自动配置只能绑定一个数据源，此时发现多个DataSource的Bean被Spring注册就会抛出异常。<blockquote>
<p>1.这时就可以采用去掉<strong>DataSourceAutoConfiguration</strong>的方式;<br>2.或者也可以在某一个DataSource的Bean上声明**@Primary<strong>注解，指定其为主数据源，这时</strong>DataSourceAutoConfiguration<strong>只会加载被指定</strong>@Primary**注解的主数据源，这样就可以享受到SpringBoot自动配置带来的好处。</p>
</blockquote>
</li>
</ul>
<hr>
<h3 id="接管WebMvc自动配置"><a href="#接管WebMvc自动配置" class="headerlink" title="接管WebMvc自动配置"></a>接管WebMvc自动配置</h3><p>对于一个web项目，最重要的就是Mvc相关的控制，SpringBoot通过<strong>WebMvcAutoConfiguration</strong>来完成与Mvc有关的自动配置。如果希望完全接管WebMvc自动配置，可以在项目中创建一个注解了**@EnableWebMvc**的配置类，比如：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.MessageSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ComponentScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.FilterType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.ResourceBundleMessageSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.commons.CommonsMultipartResolver;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.HandlerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.HandlerMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.ViewResolver;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.EnableWebMvc;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.InterceptorRegistry;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.ResourceHandlerRegistry;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurationSupport;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.handler.SimpleMappingExceptionResolver;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.handler.SimpleServletHandlerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.i18n.CookieLocaleResolver;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.i18n.LocaleChangeInterceptor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.view.InternalResourceViewResolver;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebMvc</span></span><br><span class="line"><span class="meta">@ComponentScan(basePackages = &quot;com.example&quot;, useDefaultFilters = false, includeFilters = &#123;</span></span><br><span class="line"><span class="meta">        @ComponentScan.Filter(type = FilterType.ANNOTATION, value = &#123;Controller.class&#125;)</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MvcConfig</span> <span class="keyword">extends</span> <span class="title">WebMvcConfigurationSupport</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = Logger</span><br><span class="line">            .getLogger(MvcConfig.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 描述 : &lt;注册视图处理器&gt;. &lt;br&gt;</span></span><br><span class="line"><span class="comment">     *&lt;p&gt;</span></span><br><span class="line"><span class="comment">     &lt;使用方法说明&gt;</span></span><br><span class="line"><span class="comment">     &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ViewResolver <span class="title">viewResolver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">&quot;ViewResolver&quot;</span>);</span><br><span class="line">        InternalResourceViewResolver viewResolver = <span class="keyword">new</span> InternalResourceViewResolver();</span><br><span class="line">        viewResolver.setPrefix(<span class="string">&quot;/WEB-INF/views/jsp/function/&quot;</span>);</span><br><span class="line">        viewResolver.setSuffix(<span class="string">&quot;.jsp&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> viewResolver;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 描述 : &lt;注册消息资源处理器&gt;. &lt;br&gt;</span></span><br><span class="line"><span class="comment">     *&lt;p&gt;</span></span><br><span class="line"><span class="comment">     &lt;使用方法说明&gt;</span></span><br><span class="line"><span class="comment">     &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MessageSource <span class="title">messageSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">&quot;MessageSource&quot;</span>);</span><br><span class="line">        ResourceBundleMessageSource messageSource = <span class="keyword">new</span> ResourceBundleMessageSource();</span><br><span class="line">        messageSource.setBasename(<span class="string">&quot;config.messages.messages&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> messageSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 描述 : &lt;注册servlet适配器&gt;. &lt;br&gt;</span></span><br><span class="line"><span class="comment">     *&lt;p&gt;</span></span><br><span class="line"><span class="comment">     &lt;只需要在自定义的servlet上用<span class="doctag">@Controller</span>(&quot;映射路径&quot;)标注即可&gt;</span></span><br><span class="line"><span class="comment">     &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> HandlerAdapter <span class="title">servletHandlerAdapter</span><span class="params">()</span></span>&#123;</span><br><span class="line">        logger.info(<span class="string">&quot;HandlerAdapter&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SimpleServletHandlerAdapter();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 描述 : &lt;本地化拦截器&gt;. &lt;br&gt;</span></span><br><span class="line"><span class="comment">     *&lt;p&gt;</span></span><br><span class="line"><span class="comment">     &lt;使用方法说明&gt;</span></span><br><span class="line"><span class="comment">     &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LocaleChangeInterceptor <span class="title">localeChangeInterceptor</span><span class="params">()</span></span>&#123;</span><br><span class="line">        logger.info(<span class="string">&quot;LocaleChangeInterceptor&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LocaleChangeInterceptor();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 描述 : &lt;基于cookie的本地化资源处理器&gt;. &lt;br&gt;</span></span><br><span class="line"><span class="comment">     *&lt;p&gt;</span></span><br><span class="line"><span class="comment">     &lt;使用方法说明&gt;</span></span><br><span class="line"><span class="comment">     &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(name=&quot;localeResolver&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CookieLocaleResolver <span class="title">cookieLocaleResolver</span><span class="params">()</span></span>&#123;</span><br><span class="line">        logger.info(<span class="string">&quot;CookieLocaleResolver&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CookieLocaleResolver();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 描述 : &lt;添加拦截器&gt;. &lt;br&gt;</span></span><br><span class="line"><span class="comment">     *&lt;p&gt;</span></span><br><span class="line"><span class="comment">     &lt;使用方法说明&gt;</span></span><br><span class="line"><span class="comment">     &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> registry</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">        logger.info(<span class="string">&quot;addInterceptors start&quot;</span>);</span><br><span class="line">        registry.addInterceptor(localeChangeInterceptor());</span><br><span class="line">        logger.info(<span class="string">&quot;addInterceptors end&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 描述 : &lt;资源访问处理器&gt;. &lt;br&gt;</span></span><br><span class="line"><span class="comment">     *&lt;p&gt;</span></span><br><span class="line"><span class="comment">     &lt;可以在jsp中使用/static/**的方式访问/WEB-INF/static/下的内容&gt;</span></span><br><span class="line"><span class="comment">     &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> registry</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">addResourceHandlers</span><span class="params">(ResourceHandlerRegistry registry)</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">&quot;addResourceHandlers&quot;</span>);</span><br><span class="line">        registry.addResourceHandler(<span class="string">&quot;/static/**&quot;</span>).addResourceLocations(<span class="string">&quot;/WEB-INF/static/&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 描述 : &lt;文件上传处理器&gt;. &lt;br&gt;</span></span><br><span class="line"><span class="comment">     *&lt;p&gt;</span></span><br><span class="line"><span class="comment">     &lt;使用方法说明&gt;</span></span><br><span class="line"><span class="comment">     &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(name=&quot;multipartResolver&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommonsMultipartResolver <span class="title">commonsMultipartResolver</span><span class="params">()</span></span>&#123;</span><br><span class="line">        logger.info(<span class="string">&quot;CommonsMultipartResolver&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CommonsMultipartResolver();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 描述 : &lt;异常处理器&gt;. &lt;br&gt;</span></span><br><span class="line"><span class="comment">     *&lt;p&gt;</span></span><br><span class="line"><span class="comment">     &lt;系统运行时遇到指定的异常将会跳转到指定的页面&gt;</span></span><br><span class="line"><span class="comment">     &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(name=&quot;exceptionResolver&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SimpleMappingExceptionResolver <span class="title">simpleMappingExceptionResolver</span><span class="params">()</span></span>&#123;</span><br><span class="line">        logger.info(<span class="string">&quot;CP_SimpleMappingExceptionResolver&quot;</span>);</span><br><span class="line">        SimpleMappingExceptionResolver simpleMappingExceptionResolver= <span class="keyword">new</span> SimpleMappingExceptionResolver();</span><br><span class="line">        simpleMappingExceptionResolver.setDefaultErrorView(<span class="string">&quot;common_error&quot;</span>);</span><br><span class="line">        simpleMappingExceptionResolver.setExceptionAttribute(<span class="string">&quot;exception&quot;</span>);</span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        properties.setProperty(<span class="string">&quot;java.lang.RuntimeException&quot;</span>, <span class="string">&quot;common_error&quot;</span>);</span><br><span class="line">        simpleMappingExceptionResolver.setExceptionMappings(properties);</span><br><span class="line">        <span class="keyword">return</span> simpleMappingExceptionResolver;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此时debug模式运行项目，会看到<strong>WebMvcAutoConfiguration</strong>没有被自动配置，说明我们自己定义的<code>MvcConfig</code>已经完全接管了默认的自动配置，这是因为<strong>WebMvcAutoConfiguration</strong>有一个条件注解:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ConditionalOnMissingBean(&#123;WebMvcConfigurationSupport.class&#125;)</span></span><br></pre></td></tr></table></figure>
<p>而我们本例中<code>MvcConfig</code>就是WebMvcConfigurationSupport的实现类，同时加入**@EnableWebMvc**注解也会导入一个WebMvcConfigurationSupport的实现类：DelegatingWebMvcConfiguration<br>，所以<code>MvcConfig</code>继承WebMvcConfigurationSupport不是必须的，但是可以方便我们编码。</p>
<hr>
<p>参考：<a href="http://hanqunfeng.iteye.com/blog/2114987">SpringMVC4零配置–Web上下文配置【MvcConfig】</a></p>
<hr>
<p>如果希望可以继续使用<strong>WebMvcAutoConfiguration</strong>的自动配置，而只是需要修改或者增加MVC中的某些配置时，我们可以创建一个配置类，并继承于抽象类<strong>WebMvcConfigurerAdapter</strong>，我们可以通过实现抽象类的方法来注册自己的控制器。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">WebMvcConfigurerAdapter</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WebMvcConfigurerAdapter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configurePathMatch</span><span class="params">(PathMatchConfigurer configurer)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configureContentNegotiation</span><span class="params">(ContentNegotiationConfigurer configurer)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configureAsyncSupport</span><span class="params">(AsyncSupportConfigurer configurer)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configureDefaultServletHandling</span><span class="params">(DefaultServletHandlerConfigurer configurer)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addFormatters</span><span class="params">(FormatterRegistry registry)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addResourceHandlers</span><span class="params">(ResourceHandlerRegistry registry)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addCorsMappings</span><span class="params">(CorsRegistry registry)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addViewControllers</span><span class="params">(ViewControllerRegistry registry)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configureViewResolvers</span><span class="params">(ViewResolverRegistry registry)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addArgumentResolvers</span><span class="params">(List&lt;HandlerMethodArgumentResolver&gt; argumentResolvers)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addReturnValueHandlers</span><span class="params">(List&lt;HandlerMethodReturnValueHandler&gt; returnValueHandlers)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configureMessageConverters</span><span class="params">(List&lt;HttpMessageConverter&lt;?&gt;&gt; converters)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">extendMessageConverters</span><span class="params">(List&lt;HttpMessageConverter&lt;?&gt;&gt; converters)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configureHandlerExceptionResolvers</span><span class="params">(List&lt;HandlerExceptionResolver&gt; exceptionResolvers)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">extendHandlerExceptionResolvers</span><span class="params">(List&lt;HandlerExceptionResolver&gt; exceptionResolvers)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Validator <span class="title">getValidator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MessageCodesResolver <span class="title">getMessageCodesResolver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>比如我们可以增加一个视图跳转控制器，如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebMvcConfig</span> <span class="keyword">extends</span> <span class="title">WebMvcConfigurerAdapter</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addViewControllers</span><span class="params">(ViewControllerRegistry registry)</span> </span>&#123;</span><br><span class="line">        registry.addViewController(<span class="string">&quot;/demo/123&quot;</span>).setViewName(<span class="string">&quot;/demo&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="注册Servlet、Filter、Listener的方法"><a href="#注册Servlet、Filter、Listener的方法" class="headerlink" title="注册Servlet、Filter、Listener的方法"></a>注册Servlet、Filter、Listener的方法</h2><p>1.如果是war包项目，我们可以将Servlet、Filter、Listener注册到<strong>WebApplicationInitializer</strong>的实现类中</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Order(1)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommonInitializer</span> <span class="keyword">implements</span> <span class="title">WebApplicationInitializer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStartup</span><span class="params">(ServletContext servletContext)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Log4jConfigListener</span></span><br><span class="line">        servletContext.setInitParameter(<span class="string">&quot;log4jConfigLocation&quot;</span>, <span class="string">&quot;classpath:log4j.properties&quot;</span>);</span><br><span class="line">        servletContext.addListener(Log4jConfigListener.class);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//OpenSessionInViewFilter</span></span><br><span class="line">        OpenSessionInViewFilter hibernateSessionInViewFilter = <span class="keyword">new</span> OpenSessionInViewFilter();</span><br><span class="line">        FilterRegistration.Dynamic filterRegistration = servletContext.addFilter(</span><br><span class="line">                <span class="string">&quot;hibernateFilter&quot;</span>, hibernateSessionInViewFilter);</span><br><span class="line">        filterRegistration.addMappingForUrlPatterns(</span><br><span class="line">                EnumSet.of(DispatcherType.REQUEST, DispatcherType.FORWARD, DispatcherType.INCLUDE), <span class="keyword">false</span>, <span class="string">&quot;/&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//DemoServlet</span></span><br><span class="line">        DemoServlet demoServlet = <span class="keyword">new</span> DemoServlet();</span><br><span class="line">        ServletRegistration.Dynamic dynamic = servletContext.addServlet(</span><br><span class="line">                <span class="string">&quot;demoServlet&quot;</span>, demoServlet);</span><br><span class="line">        dynamic.setLoadOnStartup(<span class="number">2</span>);</span><br><span class="line">        dynamic.addMapping(<span class="string">&quot;/demo_servlet&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2.如果是jar包部署方式，则可以将其注册到任意一个**@Configuration**配置类中</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServletRegistrationBean <span class="title">servletRegistrationBean_demo1</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ServletRegistrationBean(<span class="keyword">new</span> DemoServlet(),<span class="string">&quot;/demo-servlet1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServletRegistrationBean <span class="title">servletRegistrationBean_demo2</span><span class="params">()</span></span>&#123;</span><br><span class="line">        ServletRegistrationBean servletRegistrationBean = <span class="keyword">new</span> ServletRegistrationBean();</span><br><span class="line">        servletRegistrationBean.addUrlMappings(<span class="string">&quot;/demo-servlet2&quot;</span>);</span><br><span class="line">        servletRegistrationBean.setServlet(<span class="keyword">new</span> DemoServlet2());</span><br><span class="line">        <span class="keyword">return</span> servletRegistrationBean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FilterRegistrationBean <span class="title">filterRegistrationBean</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        FilterRegistrationBean filterRegistrationBean = <span class="keyword">new</span> FilterRegistrationBean();</span><br><span class="line">        filterRegistrationBean.setFilter(<span class="keyword">new</span> OpenSessionInViewFilter());</span><br><span class="line">        Set&lt;String&gt; set = <span class="keyword">new</span> HashSet&lt;String&gt;();</span><br><span class="line">        set.add(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        filterRegistrationBean.setUrlPatterns(set);</span><br><span class="line">        <span class="keyword">return</span> filterRegistrationBean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServletListenerRegistrationBean <span class="title">servletListenerRegistrationBean</span><span class="params">()</span></span>&#123;</span><br><span class="line">        ServletListenerRegistrationBean servletListenerRegistrationBean =  <span class="keyword">new</span> ServletListenerRegistrationBean();</span><br><span class="line">        servletListenerRegistrationBean.setListener(<span class="keyword">new</span> Log4jConfigListener());</span><br><span class="line">        servletListenerRegistrationBean.addInitParameter(<span class="string">&quot;log4jConfigLocation&quot;</span>,<span class="string">&quot;classpath:log4j.properties&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> servletListenerRegistrationBean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<hr>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>一句话概括SpringBoot的自动配置–<strong>就是一组基于条件注解实现Bean注册的Spring配置类。</strong></p>
]]></content>
      <categories>
        <category>技术</category>
        <category>Java</category>
        <category>springboot</category>
      </categories>
      <tags>
        <tag>Spring Boot</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Boot学习笔记01--基本介绍</title>
    <url>/2016/12/09/spring-boot-study/</url>
    <content><![CDATA[<h2 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h2><p>看完本文你将掌握如下知识点：</p>
<ol>
<li>如何搭建一个SpringBoot项目</li>
<li>SpringBoot自动配置原理</li>
<li>SpringBoot属性配置方法</li>
<li>修改默认的Logback日志为log4j和log4j2的方法</li>
<li>修改默认的内置tomcat容器为Jetty容器和Undertow容器的方法</li>
<li>SpringBoot单元测试方法</li>
<li>使用war包运行项目</li>
</ol>
<span id="more"></span>

<hr>
<p><strong>SpringBoot系列</strong>：<a href="/tags/Spring-Boot/">Spring Boot学习笔记</a></p>
<hr>
<h2 id="Spring-Boot简介"><a href="#Spring-Boot简介" class="headerlink" title="Spring Boot简介"></a>Spring Boot简介</h2><ul>
<li>要我给<a href="http://projects.spring.io/spring-boot/">Spring Boot</a>做个定义，简单来说就是一个基于强大的Spring框架的、推崇JavaConfig的极简配置的web开发框架；</li>
<li>Spring Boot通过内嵌Servlet容器（Tomcat、Jetty，等等）的方式，可以以jar包的形式独立运行一个web项目；</li>
<li>Spring Boot提倡JavaConfig和注解的零配置方式，并且默认配置满足绝大多数场景的需要，意味着少量修改默认配置即可快速搭建一个web项目，极大的提高开发效率；</li>
<li>项目中加入某一个<code>spring-boot-starter-*</code>依赖，就可以引入该功能的完整jar包，降低pom的复杂度</li>
<li>本文基于Spring Boot的版本为<a href="http://docs.spring.io/spring-boot/docs/1.4.2.RELEASE/reference/htmlsingle/#appendix-dependency-versions">1.4.2.RELEASE</a></li>
</ul>
<h2 id="Spring-Boot项目创建方法"><a href="#Spring-Boot项目创建方法" class="headerlink" title="Spring Boot项目创建方法"></a>Spring Boot项目创建方法</h2><ul>
<li><a href="http://start.spring.io/">http://start.spring.io</a>：可以通过网页创建项目结构并下载；</li>
<li><a href="http://docs.spring.io/spring-boot/docs/current/reference/html/getting-started-installing-spring-boot.html">Spring Boot CLI</a>：通过命令行的方式创建Spring Boot项目；</li>
<li><a href="http://spring.io/tools/sts">Spring Tool Suite</a>：习惯Eclipse的用户可以使用STS创建『Spring Starter Project』项目;</li>
<li><a href="https://www.jetbrains.com/idea/">IntelliJ IDEA</a>：强大的生产力工具，推荐使用，创建『Spring Initializr』项目;</li>
</ul>
<h2 id="使用IntelliJ-IDEA创建一个web项目"><a href="#使用IntelliJ-IDEA创建一个web项目" class="headerlink" title="使用IntelliJ IDEA创建一个web项目"></a>使用IntelliJ IDEA创建一个web项目</h2><ol>
<li>新建Spring Initializr项目<br><img src="/images_glob/spring-boot-study/create1.png"><blockquote>
<p>说明：Spring Boot要求JDK1.6+</p>
</blockquote>
</li>
<li>填写项目信息，构建工具使用maven<br><img src="/images_glob/spring-boot-study/create2.png"></li>
<li>选择项目使用的依赖，这里我们只需要勾选web<br><img src="/images_glob/spring-boot-study/create3.png"><blockquote>
<ol>
<li>Spring Boot当前最新的稳定版是1.4.2；</li>
<li> 所有依赖可以在创建时勾选，也可以在创建后手工将依赖添加到pom中，如果对依赖比较熟悉，推荐手工添加，这样可以加快创建项目的时间；</li>
</ol>
</blockquote>
</li>
<li>填写项目名称，点击Finish<br><img src="/images_glob/spring-boot-study/create4.png"></li>
<li>新建的项目结构如下<br><img src="/images_glob/spring-boot-study/create5.png"><blockquote>
<p>SpringBoot项目只会在项目根目录下生成一个类–SpringBootWebDemoApplication(artifactId+Application)，它就是一个带有main函数的启动类；</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringBootWebDemoApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		SpringApplication.run(SpringBootWebDemoApplication.class, args);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<ul>
<li>pom.xml说明<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">	<span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springbootwebdemo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">packaging</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">name</span>&gt;</span>SpringBootWebDemo<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">description</span>&gt;</span>Demo project for Spring Boot<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- 创建的Springboot项目需要继承于spring-boot-starter-parent --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.2.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.reporting.outputEncoding</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 创建项目是勾选的web依赖 --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 每个项目都会自动添加一个test依赖 --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- Springboot的编译插件 --&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<blockquote>
<p>这就是一个web项目的pom文件，可以看到只关联了很少的依赖，这是因为我们继承的spring-boot-starter-parent和关联的spring-boot-starter-web本身已经为我们关联了全部的依赖，如下是该项目所有的依赖包<br><img src="/images_glob/spring-boot-study/create6.png"><br><img src="/images_glob/spring-boot-study/create7.png"></p>
</blockquote>
</li>
</ul>
<h2 id="运行Spring-Boot项目"><a href="#运行Spring-Boot项目" class="headerlink" title="运行Spring Boot项目"></a>运行Spring Boot项目</h2><ol>
<li>maven运行：<code>mvn spring-boot:run</code>；</li>
<li>main函数运行：右键单击SpringBootWebDemoApplication，选择『Run 或者 Debug』；</li>
<li>推荐安装JRebel插件，支持热部署；</li>
<li>当然，也可以maven先打成jar，然后通过命令行执行<code>java -jar xx.jar</code>；<blockquote>
<ul>
<li>运行成功会看到控制台打印了如下信息<br><img src="/images_glob/spring-boot-study/run1.png"></li>
<li>可以看到打印信息中有tomcat的启动信息，说明springboot默认使用tomcat作为web运行容器，这点从上面的依赖包中也可以看到。因为当前项目并没有开放任何服务，所以此时访问8080端口会提示无服务<br><img src="/images_glob/spring-boot-study/run2.png"></li>
</ul>
</blockquote>
</li>
</ol>
<h3 id="添加服务"><a href="#添加服务" class="headerlink" title="添加服务"></a>添加服务</h3><ul>
<li>我们可以在项目中创建一个Controller控制器，比如DemoController<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.Controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/&quot;)</span></span><br><span class="line">    <span class="function">String <span class="title">index</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello Spring Boot!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>运行SpringBootWebDemoApplication，再次访问<a href="http://localhost:8080/">http://localhost:8080</a><br><img src="/images_glob/spring-boot-study/run3.png"></li>
</ul>
<hr>
<p><strong>一切似乎就是那么美好，我们什么都没配置，一个web项目就这样运行起来了，SpringBoot自动帮我们默认了一些常用的配置</strong></p>
<hr>
<h2 id="自动配置原理说明"><a href="#自动配置原理说明" class="headerlink" title="自动配置原理说明"></a>自动配置原理说明</h2><h3 id="SpringBootWebDemoApplication类上的注解：-SpringBootApplication"><a href="#SpringBootWebDemoApplication类上的注解：-SpringBootApplication" class="headerlink" title="SpringBootWebDemoApplication类上的注解：@SpringBootApplication"></a>SpringBootWebDemoApplication类上的注解：@SpringBootApplication</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.boot.autoconfigure;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Documented;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.ElementType;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Inherited;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.RetentionPolicy;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringBootConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.EnableAutoConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.TypeExcludeFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ComponentScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.FilterType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ComponentScan.Filter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.annotation.AliasFor;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@SpringBootConfiguration</span></span><br><span class="line"><span class="meta">@EnableAutoConfiguration</span></span><br><span class="line"><span class="meta">@ComponentScan(</span></span><br><span class="line"><span class="meta">    excludeFilters = &#123;@Filter(</span></span><br><span class="line"><span class="meta">    type = FilterType.CUSTOM,</span></span><br><span class="line"><span class="meta">    classes = &#123;TypeExcludeFilter.class&#125;</span></span><br><span class="line"><span class="meta">)&#125;</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> SpringBootApplication &#123;</span><br><span class="line">    Class&lt;?&gt;[] exclude() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    String[] excludeName() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AliasFor(</span></span><br><span class="line"><span class="meta">        annotation = ComponentScan.class,</span></span><br><span class="line"><span class="meta">        attribute = &quot;basePackages&quot;</span></span><br><span class="line"><span class="meta">    )</span></span><br><span class="line">    String[] scanBasePackages() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AliasFor(</span></span><br><span class="line"><span class="meta">        annotation = ComponentScan.class,</span></span><br><span class="line"><span class="meta">        attribute = &quot;basePackageClasses&quot;</span></span><br><span class="line"><span class="meta">    )</span></span><br><span class="line">    Class&lt;?&gt;[] scanBasePackageClasses() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>@SpringBootConfiguration实际上就是@Configuration，说明这是一个JavaConfig</li>
<li>@ComponentScan，启用注解自动扫描</li>
<li>@EnableAutoConfiguration的作用是根据类路径中jar包是否存在来决定是否开启某一个功能的自动配置，比如，我们项目中添加了spring-boot-starter-web依赖，因其关联Tomcat和Srping MVC，所以类路径下就会存在Tomcat和Spring MVC的jar包，SpringBoot项目扫描到这些jar包后会自动开启两者的配置，当然，这个配置是默认配置，我们可以根据需要进行修改（下文介绍）。</li>
<li>exclude和excludeName用于关闭指定的自动配置，比如关闭数据源相关的自动配置<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication(exclude=&#123;DataSourceAutoConfiguration.class&#125;)</span></span><br></pre></td></tr></table></figure></li>
<li>scanBasePackages和scanBasePackageClasses用于指定扫描的路径，默认情况下会自动扫描被@SpringBootApplication注解的类（这里是SpringBootWebDemoApplication）的同级包以及子包中的Bean。比如我们创建的DemoController，因为开启了SpringMVC自动配置，同时又在对应的路径下，所以该Controller会被自动加载。比如我们这里指定扫描的包路径如下：<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication(scanBasePackages = &#123;&quot;com.temp.Controller&quot;&#125;)</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>再次运行程序，发现原来的DemoController不能被访问了，而『com.temp.Controller』下的controller却可以被访问。</p>
</blockquote>
</li>
</ul>
<h3 id="那么问题来了，SpringBoot到底为我们自动配置了哪些功能呢？"><a href="#那么问题来了，SpringBoot到底为我们自动配置了哪些功能呢？" class="headerlink" title="那么问题来了，SpringBoot到底为我们自动配置了哪些功能呢？"></a>那么问题来了，SpringBoot到底为我们自动配置了哪些功能呢？</h3><ul>
<li>开启Debug模式，方式有多种:<blockquote>
<ul>
<li>java -jar xx.jar –debug</li>
<li>在IDE中执行Run时添加VM arguments:<code>-Ddebug</code></li>
<li>在项目resources下的application.properties文件中增加<code>debug=true</code></li>
</ul>
</blockquote>
</li>
<li>Debug模式运行程序，打印信息中会显示如下内容<blockquote>
<p>启动的自动配置<br><img src="/images_glob/spring-boot-study/conf1.png"><br>未启用的自动配置<br><img src="/images_glob/spring-boot-study/conf2.png"></p>
</blockquote>
</li>
<li>从打印结果中看到，每一个<code>*AutoConfiguration*</code>都对应着一类功能的自动配置类，比如<em>HttpEncodingAutoConfiguration</em>:<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">HttpEncodingAutoConfiguration matched:</span><br><span class="line">      - @ConditionalOnClass found required class &#x27;org.springframework.web.filter.CharacterEncodingFilter&#x27; (OnClassCondition)</span><br><span class="line">      - @ConditionalOnWebApplication (required) found StandardServletEnvironment (OnWebApplicationCondition)</span><br><span class="line">      - @ConditionalOnProperty (spring.http.encoding.enabled) matched (OnPropertyCondition)</span><br></pre></td></tr></table></figure></li>
<li>开启的自动配置中都会有<code>@ConditionalOnClass</code>、<code>@ConditionalOnWebApplication</code>等标识，这是什么意思呢？为了弄清楚这个，我们需要先来认识一下<code>@EnableAutoConfiguration</code>；</li>
</ul>
<h3 id="EnableAutoConfiguration"><a href="#EnableAutoConfiguration" class="headerlink" title="@EnableAutoConfiguration"></a>@EnableAutoConfiguration</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.boot.autoconfigure;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Documented;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.ElementType;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Inherited;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.RetentionPolicy;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.AutoConfigurationPackage;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.EnableAutoConfigurationImportSelector;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Import;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@AutoConfigurationPackage</span></span><br><span class="line"><span class="meta">@Import(&#123;EnableAutoConfigurationImportSelector.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableAutoConfiguration &#123;</span><br><span class="line">    String ENABLED_OVERRIDE_PROPERTY = <span class="string">&quot;spring.boot.enableautoconfiguration&quot;</span>;</span><br><span class="line"></span><br><span class="line">    Class&lt;?&gt;[] exclude() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    String[] excludeName() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>这里我们需要了解一下@Import注解中的EnableAutoConfigurationImportSelector<blockquote>
<p>感兴趣的可以看一下源码，大体的功能就是扫描jar包里是否含有<code>META-INF/spring.factories</code>文件;<br>并在spring.factories中找到**@EnableAutoConfiguration<strong>的全路径名称</strong>org.springframework.boot.autoconfigure.EnableAutoConfiguration*<em>这个key，该key对应的value就是用于声明都需要启用哪些自动配置类;<br>比如</em>spring-boot-autoconfigure-1.4.2.RELEASE.jar<em>中就有一个spring.factories，可以看到</em>org.springframework.boot.autoconfigure.EnableAutoConfiguration<em>参数中列出了自动配置类列表，而</em>HttpEncodingAutoConfiguration*这个自动配置类就是其声明的;<br><img src="/images_glob/spring-boot-study/conf3.png"></p>
</blockquote>
</li>
</ul>
<h3 id="HttpEncodingAutoConfiguration"><a href="#HttpEncodingAutoConfiguration" class="headerlink" title="HttpEncodingAutoConfiguration"></a>HttpEncodingAutoConfiguration</h3><ul>
<li>先看下源码<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(&#123;HttpEncodingProperties.class&#125;)</span></span><br><span class="line"><span class="meta">@ConditionalOnWebApplication</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(&#123;CharacterEncodingFilter.class&#125;)</span></span><br><span class="line"><span class="meta">@ConditionalOnProperty(</span></span><br><span class="line"><span class="meta">    prefix = &quot;spring.http.encoding&quot;,</span></span><br><span class="line"><span class="meta">    value = &#123;&quot;enabled&quot;&#125;,</span></span><br><span class="line"><span class="meta">    matchIfMissing = true</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpEncodingAutoConfiguration</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HttpEncodingProperties properties;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HttpEncodingAutoConfiguration</span><span class="params">(HttpEncodingProperties properties)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.properties = properties;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean(&#123;CharacterEncodingFilter.class&#125;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CharacterEncodingFilter <span class="title">characterEncodingFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        OrderedCharacterEncodingFilter filter = <span class="keyword">new</span> OrderedCharacterEncodingFilter();</span><br><span class="line">        filter.setEncoding(<span class="keyword">this</span>.properties.getCharset().name());</span><br><span class="line">        filter.setForceRequestEncoding(<span class="keyword">this</span>.properties.shouldForce(Type.REQUEST));</span><br><span class="line">        filter.setForceResponseEncoding(<span class="keyword">this</span>.properties.shouldForce(Type.RESPONSE));</span><br><span class="line">        <span class="keyword">return</span> filter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//.......省略以下........</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>熟悉JavaConfig的都会明白，这就是一个配置类<code>@Configuration</code>，并且通过<code>@Bean</code>注册了一个<code>CharacterEncodingFilter</code>;</li>
</ul>
<hr>
<p>但是还有一些注解，是什么意思呢，我们分别说明：</p>
<hr>
<ul>
<li>@EnableConfigurationProperties：开启属性注入<blockquote>
<p>本例中表示<em>HttpEncodingProperties</em>是属性类，并使用@Autowired自动注入；<br>属性类实际上是一个是注解了<code>@ConfigurationProperties</code>的JavaBean，SpringBoot将属性文件（application.properties）中的键值对与JavaBean的属性建立起一一对应关系:</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ConfigurationProperties(</span></span><br><span class="line"><span class="meta">    prefix = &quot;spring.http.encoding&quot; //属性值的前缀</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">举例：application.properties中设置如下属性</span></span><br><span class="line"><span class="comment">spring.http.encoding.charset=UTF-8</span></span><br><span class="line"><span class="comment">spring.http.encoding.force=true</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpEncodingProperties</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Charset charset;</span><br><span class="line">    <span class="keyword">private</span> Boolean force;</span><br><span class="line">    <span class="comment">//....属性声明及set、get方法........</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<p>所有**@ConditionalOn**开头的注解都是用于进行条件判断的</p>
<hr>
<ul>
<li>@ConditionalOnWebApplication：当前项目是web项目的条件下才加载当前配置类</li>
<li>@ConditionalOnClass：当类路径下有指定的类的条件下才加载当前配置类<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//本例表示，当前类路径（含jar）下必须存在CharacterEncodingFilter</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(&#123;CharacterEncodingFilter.class&#125;)</span></span><br></pre></td></tr></table></figure></li>
<li>@ConditionalOnProperty：当指定的属性等于指定的值的情况下加载当前配置类<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// spring.http.encoding=enabled</span></span><br><span class="line"><span class="comment">// matchIfMissing = true表示如果没有在application.properties设置该属性，则默认为条件符合</span></span><br><span class="line"><span class="meta">@ConditionalOnProperty(</span></span><br><span class="line"><span class="meta">    prefix = &quot;spring.http.encoding&quot;,</span></span><br><span class="line"><span class="meta">    value = &#123;&quot;enabled&quot;&#125;,</span></span><br><span class="line"><span class="meta">    matchIfMissing = true</span></span><br><span class="line"><span class="meta">)</span></span><br></pre></td></tr></table></figure></li>
<li>@ConditionalOnMissingBean：当前容器里没有指定的Bean的情况下<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 如果当前容器中找不到CharacterEncodingFilter实例，则创建当前的Bean</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean(&#123;CharacterEncodingFilter.class&#125;)</span></span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<p>通过上面的分析，应该可以明白SpringBoot是如何做到自动配置的，简单总结如下：</p>
<ol>
<li>@SpringBootConfiguration实际上就是@Configuration，说明这是一个JavaConfig</li>
<li>@EnableAutoConfiguration负责扫描jar包中的<code>META-INF/spring.factories</code>来找到要初始化的各种<strong>AutoConfiguration</strong>类</li>
<li>各种@Conditional注解决定哪些Bean可以被容器初始化</li>
<li>如果希望进一步了解SpringBoot的自动配置，建议查看每一个<strong>AutoConfiguration</strong>类的源码</li>
</ol>
<hr>
<h3 id="除了上面介绍的，-Conditional注解还有如下形式"><a href="#除了上面介绍的，-Conditional注解还有如下形式" class="headerlink" title="除了上面介绍的，@Conditional注解还有如下形式"></a>除了上面介绍的，@Conditional注解还有如下形式</h3><ul>
<li>@ConditionalOnExpression：基于SpEL表达式作为条件判断</li>
<li>@ConditionalOnJava：基于JAVA版本作为判断条件</li>
<li>@ConditionalOnJndi：在JNDI存在的条件下查找指定的位置</li>
<li>@ConditionalOnMissingClass：当前类路径下没有指定的类的条件下</li>
<li>@ConditionalOnNotWebApplication：当前项目不是web项目的条件下</li>
<li>@ConditionalOnResource：类路径下是否有指定的值</li>
<li>@ConditionalOnSingleCandidate：当指定的Bean在容器中只有一个的情况下</li>
</ul>
<hr>
<p>如果我们希望自己创建一个自动配置类(AutoConfiguration)，则只需要在我们自己创建的JavaConfig中加上**@ConditionalOn**注解，并且在类路径下创建<code>META-INF/spring.factories</code>，加入参数<code>org.springframework.boot.autoconfigure.EnableAutoConfiguration=xxxxAutoConfiguration</code></p>
<hr>
<h2 id="SpringBoot的配置文件"><a href="#SpringBoot的配置文件" class="headerlink" title="SpringBoot的配置文件"></a>SpringBoot的配置文件</h2><ul>
<li>SpringBoot支持常规的properties配置文件(application.properties)，还支持<a href="http://baike.baidu.com/link?url=Fe_VBwl7yKA6SO6fZF6USjJwefUUGq5VeN3tSjp3gpRTm7l3ZIoRvTye4QsIz95qJmaW6LC99Nkvb2vnLHBU4_">yaml</a>语言的配置文件(application.yml)</li>
<li>SpringBoot会从classpath下的/config目录或者classpath的根目录查找application.properties或application.yml</li>
<li>如果要修改SpringBoot自动配置中默认配置，可以通过在配置文件中配置相应的参数即可</li>
<li>比如，项目启动时，tomcat默认的端口号是『8080』，访问路径是『/』，修改如下：</li>
<li><strong>application.properties</strong><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">server.port</span>=<span class="string">8081</span></span><br><span class="line"><span class="meta">server.context-path</span>=<span class="string">/demo</span></span><br></pre></td></tr></table></figure></li>
<li><strong>application.yml</strong><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8081</span></span><br><span class="line">  <span class="attr">context-path:</span> <span class="string">/demo</span></span><br></pre></td></tr></table></figure></li>
<li>IntelliJ IDEA支持对properties和yml的代码提示功能，编辑起来还是很方便的，不需要特别记住这些属性名称</li>
<li>SpringBoot默认使用priperites进行配置</li>
</ul>
<hr>
<p>SpringBoot的属性可以通过多种方式指定，配置文件只是其中一种方式，常用的方式还有如下几种，按加载的优先级列出：</p>
<blockquote>
<p>命令行参数：<code>java -jar xx.jar --server.port=8081 --server.context-path=/demo</code><br>操作系统环境变量：有些OS不支持使用.这种名字，如server.port，可以使用SERVER_PORT来配置。<br>项目中的配置文件：application.properties或者application.yml<br>项目依赖jar包中的配置文件：application.properties或者application.yml</p>
</blockquote>
<p><strong>关于SpringBoot支持的配置属性可以查看<a href="http://docs.spring.io/spring-boot/docs/1.4.2.RELEASE/reference/htmlsingle/#common-application-properties">官网地址1.4.2.RELEASE</a></strong></p>
<hr>
<h3 id="Profile配置"><a href="#Profile配置" class="headerlink" title="Profile配置"></a>Profile配置</h3><ul>
<li>不同的环境可以使用不同的配置文件，application-{profile}.properties，比如<blockquote>
<p>开发：application-rnd.properties<br>测试：application-release.properties<br>验证：application-verify.properties<br>生产：application-prod.properties</p>
</blockquote>
</li>
<li>通过在application.properties(项目中必须包含该文件)中设置<code>spring.profiles.active=prod</code>来指定启用哪一个Profile。</li>
</ul>
<h2 id="关于属性配置还想多说的一些内容"><a href="#关于属性配置还想多说的一些内容" class="headerlink" title="关于属性配置还想多说的一些内容"></a>关于属性配置还想多说的一些内容</h2><ul>
<li><p>application.properties也可以配置自定义属性：my.name=hanqf</p>
</li>
<li><p>通过<code>@Value</code>将属性注入Bean属性</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Value(&quot;$&#123;my.name&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String myName;</span><br></pre></td></tr></table></figure></li>
<li><p>通过<code>@ConfigurationProperties</code>将属性注入Bean对象</p>
</li>
</ul>
<p>使用<code>prefix</code></p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="string">my.name=hanqf</span></span><br><span class="line"><span class="string">my.servers[0]=rnd.hanqf.com</span></span><br><span class="line"><span class="string">my.servers[1]=release.hanqf.com</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ConfigurationProperties(prefix=&quot;my&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Config</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; servers = <span class="keyword">new</span> ArrayList&lt;String&gt;();<span class="comment">//list需要初始化</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//....set and get method</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>不使用<code>prefix</code></p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="string">name=hanqf</span></span><br><span class="line"><span class="string">jdbc.username=root</span></span><br><span class="line"><span class="string">jdbc.password=root</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ConfigurationProperties</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Config</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Jdbc jdbc;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Jdbc</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> String username;</span><br><span class="line">        <span class="keyword">private</span> String password;</span><br><span class="line">        <span class="comment">//....set and get method</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//....set and get method</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>属性占位符</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="string">app.name=MyApp</span></span><br><span class="line"><span class="string">app.description=$&#123;app.name&#125;</span> <span class="string">is</span> <span class="string">a</span> <span class="string">Spring</span> <span class="string">Boot</span> <span class="string">application</span></span><br><span class="line"></span><br><span class="line"><span class="string">server.port=$&#123;port:8080&#125;</span> <span class="comment"># 如果没有设置port，则使用默认值8080</span></span><br></pre></td></tr></table></figure></li>
<li><p>属性名匹配规则</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ConfigurationProperties(prefix=&quot;person&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Config</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String firstName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//....set and get method</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p><code>firstName</code>可以使用的属性名如下：</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="string">person.firstName，标准的驼峰式命名</span></span><br><span class="line"><span class="string">person.first-name，虚线（-）分割方式，推荐在.properties和.yml配置文件中使用</span></span><br><span class="line"><span class="string">PERSON_FIRST_NAME，大写下划线形式，建议在系统环境变量中使用</span></span><br></pre></td></tr></table></figure>

<h2 id="日志配置"><a href="#日志配置" class="headerlink" title="日志配置"></a>日志配置</h2><ul>
<li><p>Spring Boot默认使用Logback作为日志框架，这是推荐的方式，如果希望修改为熟悉的log4j可以看下文</p>
<blockquote>
<p>创建项目时我们引入了<code>spring-boot-starter-web</code>，其依赖<code>spring-boot-starter</code>，<code>spring-boot-starter</code>又依赖于<code>spring-boot-starter-logging</code>，该依赖内容就是Spring Boot默认的日志框架Logback<br>Logback相关设置，可以在<code>application.properties</code>中进行如下配置：</p>
</blockquote>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 日志文件路径</span></span><br><span class="line"><span class="string">logging.file=D:/my_log.log</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置日志打印级别</span></span><br><span class="line"><span class="string">logging.level.org.springframework=INFO</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>当然，也可以直接将自己的<code>logback.xml</code>放到项目根路径下</p>
</blockquote>
</li>
<li><p>修改为log4j框架<br>pom中排除对<code>spring-boot-starter-logging</code>的依赖，并加入对<code>spring-boot-starter-log4j</code>的依赖<br>目前maven中央仓库的最新版本是<a href="http://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-log4j">1.3.8.RELEASE</a></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-log4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.8.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>项目根路径下添加<code>log4j.properties</code></p>
</li>
<li><p>修改为log4j2框架<br>与log4j类似，修改pom，增加<code>spring-boot-starter-log4j2</code>依赖<br>目前maven中央仓库的最新版本是<a href="http://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-log4j2">1.4.2.RELEASE</a></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-log4j2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.2.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>项目根路径下添加<code>log4j2.xml</code></p>
</li>
</ul>
<hr>
<p><strong>说明</strong><br>这里需要说明一个问题，如果切换为其它log框架，<code>debug=true</code>将会失效，需要在各自的log配置文件中声明，比如log4j需要添加<code>log4j.logger.org.springframework.boot=debug</code></p>
<hr>
<h2 id="修改内置Tomcat为Jetty"><a href="#修改内置Tomcat为Jetty" class="headerlink" title="修改内置Tomcat为Jetty"></a>修改内置Tomcat为Jetty</h2><ul>
<li>修改pom，去除<code>spring-boot-starter-tomcat</code>的依赖，增加<code>spring-boot-starter-jetty</code>依赖<br>目前maven中央仓库的最新版本是<a href="http://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-jetty">1.4.2.RELEASE</a><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-tomcat<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jetty<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.2.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><code>application.properties</code>中的属性配置与tomcat一致</li>
</ul>
<h2 id="修改内置Tomcat为Undertow容器"><a href="#修改内置Tomcat为Undertow容器" class="headerlink" title="修改内置Tomcat为Undertow容器"></a>修改内置Tomcat为Undertow容器</h2><ul>
<li>修改pom，去除<code>spring-boot-starter-tomcat</code>的依赖，增加<code>spring-boot-starter-undertow</code>依赖<br>目前maven中央仓库的最新版本是<a href="http://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-undertow">1.4.2.RELEASE</a><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-tomcat<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-undertow<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.2.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><code>application.properties</code>中的属性配置与tomcat一致</li>
</ul>
<h2 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a>单元测试</h2><ul>
<li><p>创建一个单元测试的抽象父类，用于初始化必要的对象</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.common;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Before;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.web.servlet.MockMvc;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.web.servlet.setup.MockMvcBuilders;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.WebApplicationContext;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="comment">//1.4.2.RELEASE中不再需要@SpringApplicationConfiguration和@WebAppConfiguration</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringBootTestParent</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> MockMvc mockMvc;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    WebApplicationContext webApplicationContext;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        mockMvc = MockMvcBuilders.webAppContextSetup(webApplicationContext).build();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>继承抽象父类，并实现测试逻辑</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringBootWebDemoApplicationTests</span> <span class="keyword">extends</span> <span class="title">SpringBootTestParent</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    DemoService demoService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">content</span><span class="params">()</span></span>&#123;</span><br><span class="line">        String content = <span class="string">&quot;456&quot;</span>;</span><br><span class="line">        System.out.println(demoService.printContent(content));</span><br><span class="line">        Assert.assertEquals(content,demoService.printContent(content));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span>  <span class="title">DemoControllerContent</span><span class="params">()</span></span>&#123;</span><br><span class="line">        String uri = <span class="string">&quot;/content/123&quot;</span>;</span><br><span class="line">        MvcResult mvcResult;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mvcResult = mockMvc.perform(MockMvcRequestBuilders.get(uri)).andReturn();</span><br><span class="line">            System.out.println(mvcResult.getResponse().getStatus() + <span class="string">&quot;##&quot;</span> + mvcResult.getResponse().getContentAsString());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="使用war包的形式运行项目"><a href="#使用war包的形式运行项目" class="headerlink" title="使用war包的形式运行项目"></a>使用war包的形式运行项目</h2><p>上面我们介绍了SpringBoot通过jar的形式运行项目的方法，这也是SpringBoot推荐的方式，因其内置Servlet容器，所以发布和部署都非常方便，但是某些情况下（比如使用JSP作为VIEW层，内置容器的形式并不能支持），我们希望将web项目部署到自己的容器中，这时候就需要将SpringBoot项目打成war包部署，有两种方式：<br>1.创建项目时打包方式选择：war<br><img src="/images_glob/spring-boot-study/war1.png"></p>
<blockquote>
<p>war项目目录结构<br><img src="/images_glob/spring-boot-study/war2.png"></p>
</blockquote>
<p>2.将原打包方式为jar的项目修改为war形式<br>与war项目对比发现，通过修改如下内容，可以将jar项目修改为war项目<br>2.1 pom中将<code>&lt;packaging&gt;jar&lt;/packaging&gt;</code>==&gt;<code>&lt;packaging&gt;war&lt;/packaging&gt;</code><br>2.2 pom中添加tomcat依赖，显示声明scope为provided，这样打包时就不会将tomcat的jar包打到war中</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-tomcat<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>2.3 创建<em>ServletInitializer</em>类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServletInitializer</span> <span class="keyword">extends</span> <span class="title">SpringBootServletInitializer</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> SpringApplicationBuilder <span class="title">configure</span><span class="params">(SpringApplicationBuilder application)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> application.sources(DemoWarApplication.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2><ul>
<li>Servlet3.0规范，支持将web.xml相关配置也硬编码到代码中，并由<code>javax.servlet.ServletContainerInitializer</code>的实现类负责在容器启动时进行加载</li>
<li>spring提供了一个实现类<code>org.springframework.web.SpringServletContainerInitializer</code>,<br>该类会调用所有<code>org.springframework.web.WebApplicationInitializer</code>的实现类的onStartup(ServletContext servletContext)方法，从而将相关的容器组件注册到容器；</li>
<li>SpringBootServletInitializer就是WebApplicationInitializer的实现类；</li>
<li>我之前写过一篇<a href="http://hanqunfeng.iteye.com/blog/2113820">SpringMVC4零配置</a>的文章，对零配置感兴趣的同学可以参考。</li>
</ul>
<hr>
]]></content>
      <categories>
        <category>技术</category>
        <category>Java</category>
        <category>springboot</category>
      </categories>
      <tags>
        <tag>Spring Boot</tag>
      </tags>
  </entry>
  <entry>
    <title>Markdown编辑器--Sublime Text和Atom</title>
    <url>/2016/12/06/md-subl-atom/</url>
    <content><![CDATA[<h2 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h2><ul>
<li>Markdown 是一种轻量级的「标记语言」，相对于更为复杂的 HTML 标记语言来说Markdown的语法十分简单。<a href="http://baike.baidu.com/link?url=O9XKK1evEVJwA5MXb3ocPV8O5tsSKxUTLUByaLLP6j96MEJfABRnD9u43H_MY2z9HdaZWNy1boxsfGh10Tju3FZclXQnf2XCIALFVxBhiKS">Markdown百度百科</a>；</li>
<li>Markdown语法说明<a href="http://wowubuntu.com/markdown/#list">『中文』</a>，<a href="http://daringfireball.net/projects/markdown/syntax">『英文』</a>，Hexo就是基于Markdown语法；</li>
<li>支持Markdown的编辑器很多，这里推荐使用Sublime Text和Atom，因为这两种编辑器对于喜欢编程的人来说都非常熟悉，支持多种语法并且跨平台，所以如果你已经在使用其中之一，就没必要为了使用markdown再安装其它的编辑器了；</li>
</ul>
<span id="more"></span>
<h2 id="Sublime-Text"><a href="#Sublime-Text" class="headerlink" title="Sublime Text"></a>Sublime Text</h2><ul>
<li><a href="http://www.sublimetext.com/">官方网站</a></li>
<li>Sublime默认不支持Markdown语法，需要安装插件，而要为Sublime Text安装插件，需要先安装<code>package control</code>；</li>
<li><a href="https://packagecontrol.io/installation">Package Control安装方法</a>，简单说就是按『ctrl+`』调出控制台，并根据Sublime Text的版本粘贴相应的脚本并回车执行；</li>
<li>安装完成后按<code>ctrl+shift+p</code> (Win, Linux) or <code>cmd+shift+p</code> (OS X)，调出『Command Palette』，输入<code>package control install</code>回车，等待左下角的缓冲结束会弹出一个输入框，我们在里面输入插件的名称，即可快速筛选出可用的插件；<br><img src="/images_glob/md-subl-atom/subl1.png"><br><img src="/images_glob/md-subl-atom/subl2.png"></li>
<li>安装markdown编辑插件：<a href="https://github.com/SublimeText-Markdown/MarkdownEditing">MarkdownEditing</a><blockquote>
<ol>
<li>在弹出的输入框中输入<code>MarkdownEditing</code>，回车安装，安装后需要重新启动Sublime Text；</li>
</ol>
<ul>
<li>新建文件后缀为md，则会自动开启markdown语法支持；</li>
<li>非md后缀文件，可以按<code>ctrl+shift+p</code> (Win, Linux) or <code>cmd+shift+p</code> (OS X)，调出『Command Palette』，输入<code>markdown</code>回车来开启markdown语法支持；</li>
</ul>
</blockquote>
</li>
<li>安装markdown查看插件：<a href="http://theo.im/OmniMarkupPreviewer/">OmniMarkupPreviwer</a><blockquote>
<ol>
<li>在弹出的输入框中输入<code>OmniMarkupPreviwer</code>，回车安装，安装后需要重新启动Sublime Text；</li>
</ol>
<ul>
<li>打开markdown的文档，按<code>ctrl+alt+o</code> (Win, Linux) or <code>cmd+alt+o</code> (OS X)，会打开浏览器对当前文档查看效果；</li>
</ul>
</blockquote>
</li>
<li>可以通过下面的方式查看所有安装的插件，并对其进行个性化配置；<br><img src="/images_glob/md-subl-atom/subl3.png"></li>
</ul>
<h2 id="Atom"><a href="#Atom" class="headerlink" title="Atom"></a>Atom</h2><ul>
<li><a href="https://atom.io/">官方网站</a></li>
<li>Atom是github开发的开源跨平台的编辑器，Atom的强大可以与大名鼎鼎的Sublime Text相媲美。其使用方式与Sublime Text类似，所以如果会使用Sublime Text，上手Atom会很快。而且与Sublime Text相比，Atom是免费的，但是由于其安装包大小接近百兆，所以对于轻量级编辑器来说略显笨重；</li>
<li>Atom内置了对markdown的支持，编辑markdown文档时，按<code>ctrl+shift+M</code>即可打开实时预览窗口，这点比Sublime Text方便很多；</li>
<li>对于非md结尾的文档，可以通过点击右下角的语法格式条，在弹出筛选框输入<code>markdown</code>进行语法切换；</li>
<li>可以按<code>ctrl+,</code> (Win, Linux) or <code>cmd+,</code>(OS X)，调出Atom的Settings，对其进行设置以及插件的管理;<br><img src="/images_glob/md-subl-atom/atom1.png"></li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li><p>Atom相比Sublime Text来说一个新的产物，目前还不是很普及，不过Atom从一开始就整合了Sublime Text优点，同时提供了更友好的配置和管理方式，安装与卸载插件更加的方便；</p>
</li>
<li><p>编程时我们经常喜欢使用<code>snippets+tab</code>补全的方式来快速生成代码块，Atom和Sublime Text都支持snippets</p>
</li>
<li><p>Atom</p>
<blockquote>
<p>按<code>ctrl+shift+p</code> (Win, Linux) or <code>cmd+shift+p</code> (OS X)，调出『Command Palette』，输入<code>Snippet: Available</code>，可以调出snippets筛选框；</p>
</blockquote>
</li>
<li><p>Sublime Text</p>
<blockquote>
<p>按<code>ctrl+shift+p</code> (Win, Linux) or <code>cmd+shift+p</code> (OS X)，调出『Command Palette』，输入<code>Snippet:</code>，可以调出snippets筛选框；</p>
</blockquote>
</li>
<li><p>在Atom的Settings中，我们可以搜索相应的插件，并点击『settings』，可以在其中查看到其所支持的snippets，语法与Sublime Text一致；<br><img src="/images_glob/md-subl-atom/atom2.png"><br><img src="/images_glob/md-subl-atom/atom3.png"></p>
</li>
</ul>
]]></content>
      <categories>
        <category>随笔</category>
      </categories>
      <tags>
        <tag>Markdown</tag>
      </tags>
  </entry>
  <entry>
    <title>Hexo--解决百度不能索引git page的问题</title>
    <url>/2016/12/05/hexo-baidu-coding/</url>
    <content><![CDATA[<h2 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h2><ul>
<li>由于git page网站对百度spider进行了屏蔽，所以导致了百度是无法对我们发布在git page上的网站进行索引；</li>
<li>解决方式是将我们的代码发布到国内的coding站点，其同样可以提供代码托管和Pages服务；<span id="more"></span></li>
</ul>
<h2 id="Coding配置"><a href="#Coding配置" class="headerlink" title="Coding配置"></a>Coding配置</h2><ul>
<li><a href="https://coding.net/">Coding站点地址</a>，注册个帐号</li>
<li>新建一个项目，比如：<br><img src="/images_glob/hexo-baidu-coding/coding1.png"></li>
<li>设置SSH公钥，实现免密提交代码，如下图，将我们设置github page时生成的公钥填入其中，这里注意，要去掉最后面的邮箱地址。<a href="/2016/11/14/hexo_gitpage/">参考</a><br><img src="/images_glob/hexo-baidu-coding/coding2.png"></li>
<li>新建coding-pages分支，并设置为默认<br><img src="/images_glob/hexo-baidu-coding/coding3.png"></li>
<li>开启Pages服务<br><img src="/images_glob/hexo-baidu-coding/coding4.png"><blockquote>
<p>注意，此时提交代码后，可以通过<a href="http://hanqunfeng.coding.me/">http://hanqunfeng.coding.me</a>访问</p>
</blockquote>
</li>
</ul>
<h2 id="Hexo配置"><a href="#Hexo配置" class="headerlink" title="Hexo配置"></a>Hexo配置</h2><ul>
<li><p>hexo支持多仓库发布</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">deploy:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">git</span></span><br><span class="line">  <span class="attr">repo:</span> <span class="string">https://github.com/hanqunfeng/hanqunfeng.github.io.git</span></span><br><span class="line">  <span class="attr">branch:</span> <span class="string">master</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">git</span></span><br><span class="line">  <span class="attr">repo:</span> <span class="string">https://git.coding.net/hanqunfeng/hanqunfeng.git</span></span><br><span class="line">  <span class="attr">branch:</span> <span class="string">coding-pages</span></span><br></pre></td></tr></table></figure></li>
<li><p>执行<code>hexo d</code>，会将代码同时发布到github和coding</p>
</li>
</ul>
<h2 id="域名解析–Dnspod"><a href="#域名解析–Dnspod" class="headerlink" title="域名解析–Dnspod"></a>域名解析–Dnspod</h2><ul>
<li>因为代码同时发布到github和coding，所以我希望国内用户访问coding，国外用户访问github，这样可以提高访问效率；</li>
<li>使用Dnspod实现域名解析，其支持让来源为指定线路的用户访问特定的地址；</li>
<li>注册一个Dnspod帐号，注册成功后在【域名解析】中添加一个域名，我这里添加的就是<code>hanqunfeng.com</code>；<br><img src="/images_glob/hexo-baidu-coding/coding5.png"></li>
<li>添加成功后会自动解析出两个记录类型为A的记录，选择导入；</li>
<li>之后手工添加两条记录，一个CNAME到hanqunfeng.github.io.【国外】，一个CNAME到hanqunfeng.coding.me.【国内】，如下：<br><img src="/images_glob/hexo-baidu-coding/coding6.png"><blockquote>
<p>注意记录值最后都要加个点</p>
</blockquote>
</li>
</ul>
<h2 id="修改万网的域名DNS"><a href="#修改万网的域名DNS" class="headerlink" title="修改万网的域名DNS"></a>修改万网的域名DNS</h2><ul>
<li>因为我的域名是在万网购买的，所以要想Dnspod起作用，需要修改万网中的DNS为Dnspod提供的地址；</li>
<li><a href="https://help.aliyun.com/knowledge_detail/39845.html">万网域名修改 DNS 方法</a><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">f1g1ns1.dnspod.net</span><br><span class="line">f1g1ns2.dnspod.net</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="Coding-Pages服务中配置映射域名"><a href="#Coding-Pages服务中配置映射域名" class="headerlink" title="Coding Pages服务中配置映射域名"></a>Coding Pages服务中配置映射域名</h2><p><img src="/images_glob/hexo-baidu-coding/coding7.png"></p>
]]></content>
      <categories>
        <category>随笔</category>
      </categories>
      <tags>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>Hexo--百度和谷歌搜索引擎索引方法</title>
    <url>/2016/12/05/hexo-baidu-google/</url>
    <content><![CDATA[<h2 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h2><ul>
<li>让百度和谷歌搜索引擎对当前站点进行索引的方法。</li>
<li>由于国内对谷歌的访问限制，所以可以使用chrome浏览器安装『谷歌访问助手』插件，<a href="http://jingyan.baidu.com/article/fa4125acdb25fa28ac70921d.html">安装方法</a><span id="more"></span></li>
</ul>
<h2 id="百度搜索"><a href="#百度搜索" class="headerlink" title="百度搜索"></a>百度搜索</h2><ul>
<li>需要拥有百度帐号，并进行<a href="http://zhanzhang.baidu.com/site/siteadd">网站验证</a>，因为我已经验证过blog.hanqunfneg.com，所以这里为了演示，使用<a href="http://www.hanqunfeng.com进行验证./">www.hanqunfeng.com进行验证。</a><br><img src="/images_glob/hexo-baidu-google/b1.png"></li>
<li>推荐『HTML 文件上传』的方式进行验证</li>
<li>将百度的验证文件，如我的是baidu_verify_5T5OVCioxp.html下载到本地，并拷贝到source目录下，并在文件上方增加如下内容,这样可以保证该文件不会被编译：<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">layout: <span class="literal">false</span></span><br><span class="line">---</span><br><span class="line">5T5OVCioxp</span><br></pre></td></tr></table></figure></li>
<li>编译并发布，之后在刚才的下载页面进行验证<br><img src="/images_glob/hexo-baidu-google/b2.png"></li>
</ul>
<h2 id="谷歌搜索"><a href="#谷歌搜索" class="headerlink" title="谷歌搜索"></a>谷歌搜索</h2><ul>
<li>需要拥有谷歌帐号，并进行<a href="https://www.google.com/webmasters/tools/home?hl=zh-CN">网站验证</a><br><img src="/images_glob/hexo-baidu-google/g1.png"></li>
<li>推荐『HTML 文件上传』的方式进行验证</li>
<li>将谷歌的验证文件，如我的是googleea53a22ff4210278.html下载到本地，并拷贝到source目录下，并在文件上方增加如下内容,这样可以保证该文件不会被编译：<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">layout: <span class="literal">false</span></span><br><span class="line">---</span><br><span class="line">google-site-verification: googleea53a22ff4210278.html</span><br></pre></td></tr></table></figure></li>
<li>编译并发布，之后在刚才的下载页面进行验证<br><img src="/images_glob/hexo-baidu-google/g2.png"></li>
</ul>
<h2 id="插件站点地图安装"><a href="#插件站点地图安装" class="headerlink" title="插件站点地图安装"></a>插件站点地图安装</h2><ul>
<li><p>分别使用以下命令来安装针对百度和Google的地图插件，在站点的根目录下执行以下命令：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ npm install hexo-generator-sitemap --save</span><br><span class="line">$ npm install hexo-generator-baidu-sitemap --save</span><br></pre></td></tr></table></figure></li>
<li><p>配置hexo的站点配置文件_config.yml</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment">#启用相应插件</span></span><br><span class="line"><span class="attr">Plugins:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">hexo-generator-sitemap</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">hexo-generator-baidu-sitemap</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#配置站点地图文件</span></span><br><span class="line"><span class="comment">#sitemap</span></span><br><span class="line"><span class="attr">sitemap:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">sitemap.xml</span>    </span><br><span class="line"><span class="attr">baidusitemap:</span></span><br><span class="line"><span class="attr">path:</span> <span class="string">baidusitemap.xml</span></span><br></pre></td></tr></table></figure></li>
<li><p>执行<code>hexo g</code>，当你成功编译并在Public目录下生成对应的baidusitemap.xml(针对百度)，sitemap.xml(针对Google)表明你已经成功建立的站点地图。</p>
</li>
</ul>
<h2 id="收录站点地图"><a href="#收录站点地图" class="headerlink" title="收录站点地图"></a>收录站点地图</h2><ul>
<li>百度推送<blockquote>
<p>入口：<a href="http://zhanzhang.baidu.com/linksubmit/index">百度站长–网页抓取–链接提交</a><br><img src="/images_glob/hexo-baidu-google/bt1.png"></p>
</blockquote>
</li>
<li>谷歌推送<blockquote>
<p>入口：<a href="https://www.google.com/webmasters/tools/home?hl=zh-CN">Google Search Console–抓取–站点地图</a><br><img src="/images_glob/hexo-baidu-google/gt1.png"></p>
</blockquote>
</li>
</ul>
<h2 id="百度推送方式–自动推送"><a href="#百度推送方式–自动推送" class="headerlink" title="百度推送方式–自动推送"></a>百度推送方式–自动推送</h2><ul>
<li>索引效率：主动推送&gt;自动推送&gt;sitemap</li>
<li>百度的网站上有说明，<a href="http://zhanzhang.baidu.com/linksubmit/index">地址</a></li>
<li>将自动推送的js脚本拷贝到<code>themes\next\layout\_partials\footer.swig</code>文件的最下方即可</li>
</ul>
]]></content>
      <categories>
        <category>随笔</category>
      </categories>
      <tags>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>Dubbo初体验</title>
    <url>/2016/12/01/dubbo_dubbox/</url>
    <content><![CDATA[<h2 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h2><ul>
<li><a href="http://dubbo.io/Home-zh.htm">官网地址</a>，官网有完整的资料以帮助使用者快速熟悉dubbo，不过目前相关下载地址已经失效，代码已经迁移到github，请参看下面的代码地址，自行编译打包</li>
</ul>
<span id="more"></span>

<h2 id="dubbo代码地址"><a href="#dubbo代码地址" class="headerlink" title="dubbo代码地址"></a>dubbo代码地址</h2><blockquote>
<ul>
<li><a href="https://github.com/alibaba/dubbo">2.5.4(官方版本)</a>，基于spring3.2.16.RELEASE</li>
<li><a href="https://github.com/dangdangdotcom/dubbox">2.8.4(第三方基于2.5.3修改)</a>，基于spring3.2.9.RELEASE,项目名称为dubbox，但生成的包名依然是dubbo</li>
</ul>
</blockquote>
<h2 id="git、maven、jdk、tomcat、nexus请自行安装，我安装的版本如下"><a href="#git、maven、jdk、tomcat、nexus请自行安装，我安装的版本如下" class="headerlink" title="git、maven、jdk、tomcat、nexus请自行安装，我安装的版本如下"></a>git、maven、jdk、tomcat、nexus请自行安装，我安装的版本如下</h2><blockquote>
<p>git version 2.9.3<br>Apache Maven 3.3.9<br>java version “1.8.0_31”<br>tomcat version 8.5.4<br>nexus version 2.5.0-04</p>
</blockquote>
<h2 id="编译打包"><a href="#编译打包" class="headerlink" title="编译打包"></a>编译打包</h2><h3 id="以dubbo2-8-4为例"><a href="#以dubbo2-8-4为例" class="headerlink" title="以dubbo2.8.4为例"></a>以dubbo2.8.4为例</h3><blockquote>
<ul>
<li>git clone <a href="https://github.com/dangdangdotcom/dubbox.git">https://github.com/dangdangdotcom/dubbox.git</a></li>
<li>cd dubbox</li>
<li>mvn clean package install -Dmaven.test.skip=true</li>
</ul>
</blockquote>
<h3 id="发布dubbo2-8-4到nexus的3rd-party仓库"><a href="#发布dubbo2-8-4到nexus的3rd-party仓库" class="headerlink" title="发布dubbo2.8.4到nexus的3rd party仓库"></a>发布dubbo2.8.4到nexus的3rd party仓库</h3><blockquote>
<ul>
<li>登录nexus，设置3rd party的Deployment Policy=Allow Redeploy(在Configuration中配置)</li>
<li>vi ~/.m2/settings.xml，在servers中增加如下配置</li>
</ul>
</blockquote>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">server</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>thirdparty<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">username</span>&gt;</span>admin<span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">password</span>&gt;</span>admin123<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">server</span>&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>修改dubbox的pom.xml，增加如下配置</li>
</ul>
</blockquote>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">distributionManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>thirdparty<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://192.168.36.49:8080/nexus/content/repositories/thirdparty/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">distributionManagement</span>&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>mvn clean package deploy -Dmaven.test.skip=true</li>
</ul>
</blockquote>
<h3 id="发布dubbo2-5-4到nexus的3rd-party仓库"><a href="#发布dubbo2-5-4到nexus的3rd-party仓库" class="headerlink" title="发布dubbo2.5.4到nexus的3rd party仓库"></a>发布dubbo2.5.4到nexus的3rd party仓库</h3><blockquote>
<ul>
<li>因为目前2.5.4是Snapshots版本，所以不能直接发布到3rd party中，如果要发布到3rd party，需要修改pom.xml，去掉版本号中的Snapshots，比如在intellij IDEA中，使用快捷键Command+Shift+R；</li>
</ul>
</blockquote>
<h2 id="dubbo包含四个组件"><a href="#dubbo包含四个组件" class="headerlink" title="dubbo包含四个组件"></a>dubbo包含四个组件</h2><ul>
<li>Provider: 暴露服务的服务提供方。这里我们自己提供(基于2.8.4)；</li>
<li>Consumer: 调用远程服务的服务消费方。这里我们自己提供(基于2.8.4)；</li>
<li>Registry: 服务注册与发现的注册中心。这里使用zookeeper；</li>
<li>Monitor: 统计服务的调用次调和调用时间的监控中心。这里介绍两个，一个是dubbo提供的dubbo-monitor-simple，另一个是第三方对dubbo-monitor-simple的改进版本：<a href="http://git.oschina.net/handu/dubbo-monitor">改版的monitor(基于2.8.4)</a></li>
</ul>
<hr>
<p>下面分别介绍：顺序为Registry，Provider，Consumer，Monitor。</p>
<hr>
<h2 id="ZooKeeper-Registry注册中心"><a href="#ZooKeeper-Registry注册中心" class="headerlink" title="ZooKeeper Registry注册中心"></a>ZooKeeper Registry注册中心</h2><p><a href="http://zookeeper.apache.org/">官网地址</a></p>
<h3 id="下载安装"><a href="#下载安装" class="headerlink" title="下载安装"></a>下载安装</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ wget http://apache.fayea.com/zookeeper/zookeeper-3.4.9/zookeeper-3.4.9.tar.gz</span><br><span class="line">$ tar zxvf zookeeper-3.4.9.tar.gz</span><br><span class="line">$ <span class="built_in">cd</span> zookeeper-3.4.9</span><br><span class="line">$ cp conf/zoo_sample.cfg conf/zoo.cfg</span><br></pre></td></tr></table></figure>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>$ vi conf/zoo.cfg</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">tickTime=2000</span><br><span class="line">initLimit=10</span><br><span class="line">syncLimit=5</span><br><span class="line"><span class="comment">#实际上只需要配置dataDir，这里修改为自己的存储目录</span></span><br><span class="line">dataDir=/usr/<span class="built_in">local</span>/zookeeper-3.4.9/data</span><br><span class="line">clientPort=2181</span><br></pre></td></tr></table></figure>

<h3 id="集群配置"><a href="#集群配置" class="headerlink" title="集群配置"></a>集群配置</h3><ul>
<li><p>分别在两台主机上按上述方法安装zookeeper，比如两台主机的IP分别为192.168.37.144、192.168.37.143；</p>
</li>
<li><p>分别在两台主机的zoo.cfg中增加如下配置</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">server.1=192.168.37.144:2555:3555</span><br><span class="line">server.2=192.168.37.143:2555:3555</span><br></pre></td></tr></table></figure></li>
<li><p>在144主机的dataDir指定的目录(/usr/local/zookeeper-3.4.9/data)下创建文件myid</p>
<blockquote>
<p>vi myid<br>设置内容为1  #就是zoo.cfg中server.后面对应的数字</p>
</blockquote>
</li>
<li><p>同理将143的myid文件中内容设置为2</p>
</li>
</ul>
<h3 id="开放端口"><a href="#开放端口" class="headerlink" title="开放端口"></a>开放端口</h3><ul>
<li>两台主机分别开放2181，2555，3555端口<br>vi /etc/sysconfig/iptablse，加入如下内容<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#zookeeper</span></span><br><span class="line">-A INPUT -p tcp -m state --state NEW -m tcp --dport 2181 -j ACCEPT</span><br><span class="line">-A INPUT -p tcp -m state --state NEW -m tcp --dport 2555 -j ACCEPT</span><br><span class="line">-A INPUT -p tcp -m state --state NEW -m tcp --dport 3555 -j ACCEPT</span><br></pre></td></tr></table></figure></li>
<li>重启iptables</li>
</ul>
<h3 id="启动与关闭zookeeper"><a href="#启动与关闭zookeeper" class="headerlink" title="启动与关闭zookeeper"></a>启动与关闭zookeeper</h3><p>./bin/zkServer.sh start<br>./bin/zkServer.sh stop</p>
<h3 id="查看在zookeeper中注册的信息"><a href="#查看在zookeeper中注册的信息" class="headerlink" title="查看在zookeeper中注册的信息"></a>查看在zookeeper中注册的信息</h3><p>echo dump | nc 192.168.37.144 2181<br>OR<br>telnet 192.168.37.144 2188<br>dump</p>
<hr>
<p>关于Provider&amp;Consumer，阿里官方的实例很详细了，网上也有很多资料，这里只做简单的说明，示例项目依赖于dubbo2.8.4,spring替换为4.3.3，使用中并未见异常，示例源码地址:<a href="https://github.com/hanqunfeng/DubboStudy">https://github.com/hanqunfeng/DubboStudy</a></p>
<hr>
<h2 id="Provider-服务提供者"><a href="#Provider-服务提供者" class="headerlink" title="Provider 服务提供者"></a>Provider 服务提供者</h2><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:dubbo</span>=<span class="string">&quot;http://code.alibabatech.com/schema/dubbo&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.3.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">    http://code.alibabatech.com/schema/dubbo http://code.alibabatech.com/schema/dubbo/dubbo.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 一个项目中只能有一个dubbo:application配置项 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:application</span> <span class="attr">name</span>=<span class="string">&quot;demo-provider&quot;</span> <span class="attr">owner</span>=<span class="string">&quot;hanqf&quot;</span> <span class="attr">organization</span>=<span class="string">&quot;dubbox&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 使用zookeeper注册中心暴露服务地址--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:registry</span></span></span><br><span class="line"><span class="tag">            <span class="attr">address</span>=<span class="string">&quot;zookeeper://192.168.37.144:2181?backup=192.168.37.143:2181&quot;</span> <span class="attr">timeout</span>=<span class="string">&quot;50000&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 用dubbo协议在20880端口暴露服务 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:protocol</span> <span class="attr">name</span>=<span class="string">&quot;dubbo&quot;</span> <span class="attr">port</span>=<span class="string">&quot;20880&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 声明需要暴露的服务接口 服务实现类是通过注解注册的，所以此处不需要声明实现类 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:service</span> <span class="attr">interface</span>=<span class="string">&quot;web.function.demo.service.DemoService&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;demoService&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:service</span> <span class="attr">interface</span>=<span class="string">&quot;web.function.demo.service.Demo2Service&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;demo2Service&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 启用monitor服务，只有配置这个，才会主动向monitor推送信息 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:monitor</span> <span class="attr">protocol</span>=<span class="string">&quot;registry&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>不同的Provider之间可以使用相同的应用名称（比如这里是name=”demo-provider”），因为注册的服务只基于服务所在服务器的ip地址和dubbo协议开放的端口号，两者有一个不相同即可，但是不建议这样做。</li>
<li>对于提供相同服务的Provider，也就是副本（同一个war包，部署到不同主机），则可以不去修改name，但是对于提供不同服务的Provider，不要使用相同的name，这样不便于在monitor中查看。</li>
<li>对于同一个Provider，要在同一台主机中部署（同一个war包，部署到同一台主机），则需要修改duboo协议端口，比如示例代码中的dubbo-provider和dubbo-provider02，因为两者提供相同的服务，所以应用名称相同，但是因为都在本机部署，所以一个用20880，一个使用20881</li>
</ul>
</blockquote>
<h2 id="Consumer-服务消费者"><a href="#Consumer-服务消费者" class="headerlink" title="Consumer 服务消费者"></a>Consumer 服务消费者</h2><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:dubbo</span>=<span class="string">&quot;http://code.alibabatech.com/schema/dubbo&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.3.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">    http://code.alibabatech.com/schema/dubbo http://code.alibabatech.com/schema/dubbo/dubbo.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:application</span> <span class="attr">name</span>=<span class="string">&quot;demo-consumer&quot;</span> <span class="attr">owner</span>=<span class="string">&quot;hanqf&quot;</span> <span class="attr">organization</span>=<span class="string">&quot;dubbox&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 设置check的缺省值，如果配置中有显式的声明，如：&lt;dubbo:reference check=&quot;true&quot;/&gt;，不会受影响 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 关闭所有服务的启动时检查,注意：如果关闭某个服务的启动时检查，需要在指定的服务单独配置check=&quot;false&quot; --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:consumer</span> <span class="attr">check</span>=<span class="string">&quot;false&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:registry</span> <span class="attr">protocol</span>=<span class="string">&quot;zookeeper&quot;</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">address</span>=<span class="string">&quot;192.168.37.144:2181,192.168.37.143:2181&quot;</span> <span class="attr">timeout</span>=<span class="string">&quot;50000&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 用dubbo协议在20880端口暴露服务 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:protocol</span> <span class="attr">name</span>=<span class="string">&quot;dubbo&quot;</span> <span class="attr">port</span>=<span class="string">&quot;20880&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 声明需要暴露的服务接口 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:reference</span> <span class="attr">interface</span>=<span class="string">&quot;web.function.demo.service.DemoService&quot;</span> <span class="attr">id</span>=<span class="string">&quot;demoService&quot;</span> <span class="attr">timeout</span>=<span class="string">&quot;50000&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:reference</span> <span class="attr">interface</span>=<span class="string">&quot;web.function.demo.service.Demo2Service&quot;</span> <span class="attr">id</span>=<span class="string">&quot;demo2Service&quot;</span> <span class="attr">timeout</span>=<span class="string">&quot;50000&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:monitor</span> <span class="attr">protocol</span>=<span class="string">&quot;registry&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>Consumer和Provider如果部署在同一台主机，可以使用相同的dubbo协议端口，两者不受影响</li>
</ul>
</blockquote>
<hr>
<p>关于相关配置属性的说明，还是参考官方资料吧，在dubbo源码中已经包含了Consumer和Provider的示例，可以作为参考。</p>
<hr>
<h2 id="Monitor"><a href="#Monitor" class="headerlink" title="Monitor"></a>Monitor</h2><h3 id="dubbo-monitor-simple-简易监控中心"><a href="#dubbo-monitor-simple-简易监控中心" class="headerlink" title="dubbo-monitor-simple 简易监控中心"></a>dubbo-monitor-simple 简易监控中心</h3><ul>
<li>dubbo项目源码中已经自带了一个Monitor，就是dubbo-monitor-simple，使用maven编译后，会在dubbox/dubbo-simple/dubbo-monitor-simple/target下生成dubbo-monitor-simple-2.8.4-assembly.tar.gz</li>
<li>将dubbo-monitor-simple-2.8.4-assembly.tar.gz拷贝的合适的地方并解压<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ tar -zxvf dubbo-monitor-simple-2.8.4-assembly.tar.gz</span><br><span class="line">$ <span class="built_in">cd</span> dubbo-monitor-simple-2.8.4</span><br><span class="line">$ vi conf/dubbo.properties</span><br></pre></td></tr></table></figure></li>
<li>主要修改zookeeper地址、端口、绘图目录（该目录必须手工创建，比如这里是/Users/hanqunfeng/monitor）：<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">dubbo.container=log4j,spring,registry,jetty</span><br><span class="line">dubbo.application.name=simple-monitor</span><br><span class="line">dubbo.application.owner=</span><br><span class="line"><span class="comment">#dubbo.registry.address=multicast://224.5.6.7:1234</span></span><br><span class="line">dubbo.registry.address=zookeeper://192.168.37.144:2181?backup=192.168.37.143:2181</span><br><span class="line"><span class="comment">#dubbo.registry.address=redis://127.0.0.1:6379</span></span><br><span class="line"><span class="comment">#dubbo.registry.address=dubbo://127.0.0.1:9090</span></span><br><span class="line">dubbo.protocol.port=7070</span><br><span class="line">dubbo.jetty.port=8085</span><br><span class="line">dubbo.jetty.directory=/Users/hanqunfeng/monitor</span><br><span class="line">dubbo.charts.directory=<span class="variable">$&#123;dubbo.jetty.directory&#125;</span>/charts</span><br><span class="line">dubbo.statistics.directory=/Users/hanqunfeng/monitor/statistics</span><br><span class="line">dubbo.log4j.file=logs/dubbo-monitor-simple.log</span><br><span class="line">dubbo.log4j.level=WARN</span><br></pre></td></tr></table></figure></li>
<li>启动与关闭<blockquote>
<p>./bin/start.sh<br>./bin/stop.sh</p>
</blockquote>
</li>
<li>浏览器访问 <code>http://localhost:8085</code> ，图表中的效果是注册了Provider，Consumer的效果<br><img src="/images_glob/dubbo_simple_monitor.png"></li>
</ul>
<h3 id="改版的monitor-基于2-8-4"><a href="#改版的monitor-基于2-8-4" class="headerlink" title="改版的monitor(基于2.8.4)"></a>改版的monitor(基于2.8.4)</h3><ul>
<li>特点：使用mysql作为数据存储，界面使用bootstrap进行优化</li>
<li>下载<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> http://git.oschina.net/handu/dubbo-monitor</span><br><span class="line">$ <span class="built_in">cd</span> dubbo-monitor</span><br></pre></td></tr></table></figure></li>
<li>配置<br>vi src/main/resources/application.properties，修改zookeeper地址，端口，数据库信息<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">dubbo.application.name=dubbo-monitor</span><br><span class="line">dubbo.application.owner=hanqunfeng</span><br><span class="line">dubbo.registry.address=zookeeper://192.168.37.144:2181?backup=192.168.37.143:2181</span><br><span class="line">dubbo.protocol.port=6060</span><br><span class="line"></span><br><span class="line"><span class="comment"># Database Settings</span></span><br><span class="line">db.url=jdbc:mysql://127.0.0.1:3306/monitor?prepStmtCacheSize=517&amp;cachePrepStmts=<span class="literal">true</span>&amp;autoReconnect=<span class="literal">true</span>&amp;characterEncoding=utf-8</span><br><span class="line">db.username=root</span><br><span class="line">db.password=password</span><br><span class="line">db.maxActive=500</span><br><span class="line"></span><br><span class="line"><span class="comment"># System Manager</span></span><br><span class="line">manager.username=admin</span><br><span class="line">manager.password=admin</span><br></pre></td></tr></table></figure></li>
</ul>
<ul>
<li><p>数据库初始化</p>
<blockquote>
<ul>
<li>创建monitor数据库</li>
<li>执行sql目录下的create.sql</li>
</ul>
</blockquote>
</li>
<li><p>打包<br>mvn clean package -Dmaven.test.skip=true</p>
<blockquote>
<p>基于本地nexus编译打包时，提示找不到jetbrick-template-2.0.10.jar，去maven中央仓库<a href="http://mvnrepository.com/artifact/com.github.subchen/jetbrick-template/2.0.10">下载</a>再上传到nexus中吧。</p>
</blockquote>
</li>
<li><p>部署<br>将生成的dubbo-monitor.war包部署到tomcat中，启动tomcat（端口8084）<br>访问地址<a href="http://localhost:8084/dubbo-monitor">http://localhost:8084/dubbo-monitor</a><br><img src="/images_glob/dubbo-monitor.png"></p>
</li>
</ul>
<hr>
<p>最后说一下dubbo-admin，这个是dubbo官方提供的dubbo管理控制台<br>官方说明：管理控制台为内部裁剪版本，开源部分主要包含：路由规则，动态配置，服务降级，访问控制，权重调整，负载均衡，等管理功能。</p>
<hr>
<h2 id="dubbo-admin-管理控制台"><a href="#dubbo-admin-管理控制台" class="headerlink" title="dubbo-admin 管理控制台"></a>dubbo-admin 管理控制台</h2><p>dubbo项目源码中有一个模块叫做dubbo-admin</p>
<blockquote>
<p>cd dubbox/dubbo-admin/src/main/webapp/WEB-INF<br>vi dubbo.properties<br>配置dubbo.registry.address=zookeeper://192.168.37.144:2181?backup=192.168.37.143:2181<br>编译打包，将生成的dubbo-admin-2.8.4.war部署到tomcat<br><img src="/images_glob/dubbo-admin.png"></p>
</blockquote>
]]></content>
      <categories>
        <category>技术</category>
      </categories>
      <tags>
        <tag>dubbo</tag>
      </tags>
  </entry>
  <entry>
    <title>Hexo--NexT主题</title>
    <url>/2016/11/17/hexo-theme-next/</url>
    <content><![CDATA[<h2 id="NexT主题简介"><a href="#NexT主题简介" class="headerlink" title="NexT主题简介"></a>NexT主题简介</h2><ul>
<li>NexT有着完善的使用文档，<a href="http://theme-next.iissnan.com/getting-started.html">NexT官方资料</a>；</li>
<li>NexT整合了常用的插件，如评论、分享、统计；</li>
<li>下载安装<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~/blog</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/iissnan/hexo-theme-next themes/next</span><br></pre></td></tr></table></figure></li>
<li><a href="http://www.joryhe.com/2016-05-17-hexoxo-series-for-site-build-basic.html">第三方参考资料</a></li>
</ul>
<span id="more"></span>
<h2 id="我的配置"><a href="#我的配置" class="headerlink" title="我的配置"></a>我的配置</h2><h3 id="多说评论和百度统计"><a href="#多说评论和百度统计" class="headerlink" title="多说评论和百度统计"></a>多说评论和百度统计</h3><ul>
<li>NexT主题的_config.yml，配置方式参考<a href="http://blog.hanqunfeng.com/2016/11/16/hexo_duoshuo_baidutongji">Hexo–添加多说评论插件和百度统计插件</a><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 多说配置：</span></span><br><span class="line"><span class="comment"># Duoshuo ShortName</span></span><br><span class="line"><span class="attr">duoshuo_shortname:</span> <span class="string">注册前缀</span></span><br><span class="line"><span class="comment"># 开启热评文章</span></span><br><span class="line"><span class="attr">duoshuo_hotartical:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 可以看到评论用户的UA信息</span></span><br><span class="line"><span class="comment"># Make duoshuo show UA</span></span><br><span class="line"><span class="comment"># user_id must NOT be null when admin_enable is true!</span></span><br><span class="line"><span class="comment"># you can visit http://dev.duoshuo.com get duoshuo user id.</span></span><br><span class="line"><span class="attr">duoshuo_info:</span></span><br><span class="line">  <span class="attr">ua_enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">admin_enable:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">user_id:</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 百度统计配置：</span></span><br><span class="line"><span class="comment"># Baidu Analytics ID</span></span><br><span class="line"><span class="comment"># 这里只需要填写js代码中hm.js链接的参数(如下：xxxxxxx)部分，而不再需要将整个js配置到模板中</span></span><br><span class="line"><span class="attr">baidu_analytics:</span> <span class="string">xxxxxxx</span> </span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li>百度统计代码<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> _hmt = _hmt || [];</span><br><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> hm = <span class="built_in">document</span>.createElement(<span class="string">&quot;script&quot;</span>);</span><br><span class="line">  hm.src = <span class="string">&quot;https://hm.baidu.com/hm.js?xxxxxxx&quot;</span>;</span><br><span class="line">  <span class="keyword">var</span> s = <span class="built_in">document</span>.getElementsByTagName(<span class="string">&quot;script&quot;</span>)[<span class="number">0</span>]; </span><br><span class="line">  s.parentNode.insertBefore(hm, s);</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="百度分享"><a href="#百度分享" class="headerlink" title="百度分享"></a>百度分享</h3><ul>
<li>NexT主题的_config.yml，其它主题配置方式<a href="http://share.baidu.com/">参考地址</a><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Baidu Share</span></span><br><span class="line"><span class="comment"># Available value:</span></span><br><span class="line"><span class="comment">#    button | slide</span></span><br><span class="line"><span class="comment"># Warning: Baidu Share does not support https.</span></span><br><span class="line"><span class="attr">baidushare:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">button</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="阅读次数"><a href="#阅读次数" class="headerlink" title="阅读次数"></a>阅读次数</h3><ul>
<li>注册<a href="https://leancloud.cn/">LeanCloud</a>帐号，在LeanCloud中创建应用，具体配置方式查看<a href="https://notes.wanghao.work/2015-10-21-%E4%B8%BANexT%E4%B8%BB%E9%A2%98%E6%B7%BB%E5%8A%A0%E6%96%87%E7%AB%A0%E9%98%85%E8%AF%BB%E9%87%8F%E7%BB%9F%E8%AE%A1%E5%8A%9F%E8%83%BD.html#%E9%85%8D%E7%BD%AELeanCloud">参考资料</a>。</li>
<li>复制AppID以及AppKey并在NexT主题的_config.yml文件中我们相应的位置填入即可，正确配置之后文件内容像这个样子:<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">leancloud_visitors:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">app_id:</span> <span class="string">joaeuuc4hsqudUUwx4gIvGF6-gzGzoHsz</span></span><br><span class="line">  <span class="attr">app_key:</span> <span class="string">E9UJsJpw1omCHuS22PdSpKoh</span></span><br></pre></td></tr></table></figure></li>
<li>这里要注意，一定要在LeanCloud中的安全中心配置Web安全域名，否则不能正常统计</li>
</ul>
<h3 id="字数统计和阅读时常"><a href="#字数统计和阅读时常" class="headerlink" title="字数统计和阅读时常"></a>字数统计和阅读时常</h3><ul>
<li><a href="http://www.joryhe.com/2016-06-06-hexo_wordcount_setting_your_post.html">参考资料</a></li>
<li>安装hexo-wordcount插件，在站点的根目录下执行以下命令：<br><code>npm install hexo-wordcount --save</code></li>
<li>修改模板位置：<code>themes\next\layout\_macro\post.swig</code>，插入代码如下：<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"># 查找如下代码段：</span><br><span class="line">         &#123;# LeanCould PageView #&#125;</span><br><span class="line">         &#123;% if theme.leancloud_visitors.enable %&#125;</span><br><span class="line">            <span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">&quot;&#123;&#123; url_for(post.path) &#125;&#125;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;leancloud_visitors&quot;</span> <span class="attr">data-flag-title</span>=<span class="string">&quot;&#123;&#123; post.title &#125;&#125;&quot;</span>&gt;</span></span><br><span class="line">         <span class="symbol">&amp;nbsp;</span> | <span class="symbol">&amp;nbsp;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;post-meta-item-icon&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fa fa-eye&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;post-meta-item-text&quot;</span>&gt;</span>&#123;&#123;__(&#x27;post.visitors&#x27;)&#125;&#125; <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;leancloud-visitors-count&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">             <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">         &#123;% endif %&#125;</span><br><span class="line"></span><br><span class="line"># 添加如下代码段：      </span><br><span class="line"># 以下部分为：字数统计、阅读时长插入代码</span><br><span class="line">         <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;post-time&quot;</span>&gt;</span></span><br><span class="line">       <span class="symbol">&amp;nbsp;</span> | <span class="symbol">&amp;nbsp;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;post-meta-item-icon&quot;</span>&gt;</span></span><br><span class="line">             <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fa fa-calendar-o&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;post-meta-item-text&quot;</span>&gt;</span>字数统计:<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;post-count&quot;</span>&gt;</span>&#123;&#123; wordcount(post.content) &#125;&#125;(字)<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">           </span><br><span class="line">         <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">      </span><br><span class="line">      <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;post-time&quot;</span>&gt;</span></span><br><span class="line">       <span class="symbol">&amp;nbsp;</span> | <span class="symbol">&amp;nbsp;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;post-meta-item-icon&quot;</span>&gt;</span></span><br><span class="line">             <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fa fa-calendar-o&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;post-meta-item-text&quot;</span>&gt;</span>阅读时长:<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;post-count&quot;</span>&gt;</span>&#123;&#123; min2read(post.content) &#125;&#125;(分)<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">           </span><br><span class="line">         <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"># 以上部分为：字数统计、阅读时长插入代码</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="Local-Search"><a href="#Local-Search" class="headerlink" title="Local Search"></a>Local Search</h3><ul>
<li>安装 hexo-generator-searchdb，在站点的根目录下执行以下命令：<br><code>$ npm install hexo-generator-searchdb --save</code></li>
<li>NexT主题的_config.yml<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">search:</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">search.xml</span></span><br><span class="line">  <span class="attr">field:</span> <span class="string">post</span></span><br><span class="line">  <span class="attr">format:</span> <span class="string">html</span></span><br><span class="line">  <span class="attr">limit:</span> <span class="number">10000</span></span><br></pre></td></tr></table></figure></li>
<li>重新编译之后会发现左侧导航栏最下方多出一个搜索菜单</li>
</ul>
<h3 id="标签页和分类页"><a href="#标签页和分类页" class="headerlink" title="标签页和分类页"></a>标签页和分类页</h3><ul>
<li>默认情况下，NexT没有开启标签页和分类页功能</li>
<li>新增标签页</li>
</ul>
<blockquote>
<p>使用命令<code>hexp new page “tags”</code> 并将页面类型设置为tags</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">---</span><br><span class="line">title: 标签</span><br><span class="line">date: 2016-11-17 23:03:47</span><br><span class="line">type: &quot;tags&quot;</span><br><span class="line">---</span><br></pre></td></tr></table></figure>
<p>通常情况下你的标签页并不需要评论框，取消评论代码</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">---</span><br><span class="line">title: 标签</span><br><span class="line">date: 2016-11-17 23:03:47</span><br><span class="line">type: &quot;tags&quot;</span><br><span class="line">comments: false</span><br><span class="line">---</span><br></pre></td></tr></table></figure>
<blockquote>
<p>在主题配置文件下的菜单设置项memu下设置，设置完成在主页导航可以看到标签导航栏</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">menu:</span><br><span class="line">  tags: /tags</span><br></pre></td></tr></table></figure>

<ul>
<li>新增分类页</li>
</ul>
<blockquote>
<p>使用命令<code>hexp new page categories</code> 并将页面类型设置为categories</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">---</span><br><span class="line">title: 分类</span><br><span class="line">date: 2016-11-17 23:08:35</span><br><span class="line">type: &quot;categories&quot;</span><br><span class="line">---</span><br></pre></td></tr></table></figure>

<blockquote>
<p>通常情况下你的标签页并不需要评论框，取消评论代码</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">---</span><br><span class="line">title: 分类</span><br><span class="line">date: 2016-11-17 23:08:35</span><br><span class="line">type: &quot;categories&quot;</span><br><span class="line">comments: false</span><br><span class="line">---</span><br></pre></td></tr></table></figure>
<blockquote>
<p>在主题配置文件下的菜单设置项memu下设置，设置完成在主页导航可以看到分类导航栏</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">menu:</span><br><span class="line">  categories: /categories</span><br></pre></td></tr></table></figure>

<h3 id="设定首页-归档-标签页面文章的篇数"><a href="#设定首页-归档-标签页面文章的篇数" class="headerlink" title="设定首页/归档/标签页面文章的篇数"></a>设定首页/归档/标签页面文章的篇数</h3><ul>
<li>安装如下插件，在站点的根目录下执行以下命令：<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ npm install hexo-generator-index --save</span><br><span class="line">$ npm install hexo-generator-archive --save</span><br><span class="line">$ npm install hexo-generator-tag --save</span><br></pre></td></tr></table></figure></li>
<li>NexT主题的_config.yml<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">index_generator:</span></span><br><span class="line">  <span class="attr">per_page:</span> <span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="attr">archive_generator:</span></span><br><span class="line">  <span class="attr">per_page:</span> <span class="number">20</span></span><br><span class="line">  <span class="attr">yearly:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">monthly:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">tag_generator:</span></span><br><span class="line">  <span class="attr">per_page:</span> <span class="number">10</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="RSS设置"><a href="#RSS设置" class="headerlink" title="RSS设置"></a>RSS设置</h3><ul>
<li>安装 hexo-generator-feed，在站点的根目录下执行以下命令：<br><code>$ npm install hexo-generator-feed --save</code></li>
<li>NexT主题的_config.yml<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Set rss to false to disable feed link.</span></span><br><span class="line"><span class="comment"># Leave rss as empty to use site&#x27;s feed link.</span></span><br><span class="line"><span class="comment"># Set rss to specific value if you have burned your feed already.</span></span><br><span class="line"><span class="attr">rss:</span> <span class="string">/atom.xml</span></span><br></pre></td></tr></table></figure></li>
<li>编译后，会看到左侧头像下方会显示RSS入口</li>
</ul>
<h3 id="跳过指定文件的渲染"><a href="#跳过指定文件的渲染" class="headerlink" title="跳过指定文件的渲染"></a>跳过指定文件的渲染</h3><ul>
<li>如果某些资源希望放到source下，但是又不希望被编译，可以在hexo的_config.yml中增加如下配置：<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">skip_render:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">zabbix/**</span> <span class="comment">#跳过zabbix文件夹下的全部子目录和文件</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">abc.html</span>  <span class="comment">#跳过某一个具体的文件</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">*.html</span>    <span class="comment">#跳过以html结尾的文件</span></span><br></pre></td></tr></table></figure></li>
<li>比如我的导航菜单中的『资料』，其下面配置的资源就是我从为知笔记中导出的html。</li>
</ul>
]]></content>
      <categories>
        <category>随笔</category>
      </categories>
      <tags>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>Hexo--绑定域名到githubpage</title>
    <url>/2016/11/17/hexo-domain-name/</url>
    <content><![CDATA[<h2 id="申请域名"><a href="#申请域名" class="headerlink" title="申请域名"></a>申请域名</h2><ul>
<li>可以通过<a href="https://wanwang.aliyun.com/">万网</a>购买域名;</li>
<li>比如博主的域名为<code>hanqunfeng.com</code>;</li>
</ul>
<h2 id="添加解析规则"><a href="#添加解析规则" class="headerlink" title="添加解析规则"></a>添加解析规则</h2><ul>
<li>登录阿里云的控制台，进入【域名】，找到自己的域名，点击【解析】</li>
<li>点击【添加解析】<blockquote>
<ul>
<li>『记录类型』：CNAME</li>
<li>『主机记录』：blog #说明：设置为二级域名，也可以设置为www的一级域名</li>
<li>『记录值』：hanqunfeng.github.io.  #注意最后面有个点</li>
</ul>
</blockquote>
</li>
<li>上面的配置表示将blog.hanqunfeng.com的请求定向到hanqunfeng.github.io</li>
</ul>
<span id="more"></span>
<h2 id="blog目录下创建CNAME文件"><a href="#blog目录下创建CNAME文件" class="headerlink" title="blog目录下创建CNAME文件"></a>blog目录下创建CNAME文件</h2><ul>
<li>在自己的blog目录下的<code>/source</code>目录下新建一个文件，命名为CNAME，内容为：blog.hanqunfeng.com</li>
<li><code>hexo cl</code>，<code>hexo g</code>，<code>hexo d</code>，发布到github page</li>
</ul>
<h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2><ul>
<li>购买域名需要进行实名认证；</li>
<li>官方说域名解析最长等待48小时就可以全球生效；</li>
<li>博主配置时，只是提交了实名认证申请，域名解析不到5分钟就可以访问了；</li>
</ul>
]]></content>
      <categories>
        <category>技术</category>
      </categories>
      <tags>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>Hexo--添加多说评论插件和百度统计插件</title>
    <url>/2016/11/16/hexo_duoshuo_baidutongji/</url>
    <content><![CDATA[<h2 id="添加多说评论插件"><a href="#添加多说评论插件" class="headerlink" title="添加多说评论插件"></a>添加多说评论插件</h2><ul>
<li>登录<a href="http://duoshuo.com/">多说官网</a>，多说不支持注册，仅支持绑定社交帐号登录，比如QQ，新浪微博，等等。</li>
<li>登录后会要求进行站点设置，这里需要设置域名、站点名称、首页网址等信息，域名的后缀已经默认为<code>.duoshuo.com</code>,所以我们只需要设置前缀，记住这个前缀。站点名称随便起个名字，首页网站填写<code>https://hanqunfeng.github.io</code>；</li>
</ul>
<span id="more"></span>

<ul>
<li>编辑yilia主题的_config.yml文件，设置如下：<blockquote>
<p> duoshuo: 域名前缀</p>
</blockquote>
</li>
<li>重新发布即可，效果见页面下方的评论区；</li>
<li>在多说管理后台中可以对评论进行管理。</li>
</ul>
<h2 id="添加百度统计插件"><a href="#添加百度统计插件" class="headerlink" title="添加百度统计插件"></a>添加百度统计插件</h2><ul>
<li>注册<a href="http://tongji.baidu.com/web/welcome/login">百度统计</a>帐号;</li>
<li>新注册用户会要求创建一个网站，设置如下：<br><img src="/images_glob/baidu_tj_net.png" alt="baidu_tj"></li>
<li>登录后在<code>代码管理--》代码获取</code>中复制代码，将其粘贴到yilia主题下的<code>layout/_partial/after-footer.gjs</code>的最下面；</li>
<li>重新发布到github page；</li>
<li>在百度统计管理平台中的<code>代码管理--》代码安装检查</code>查看是否配置正确；</li>
<li>配置无误后，可以通过百度统计平台查看统计数据。</li>
</ul>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="http://m.blog.csdn.net/article/details?id=51049695">http://m.blog.csdn.net/article/details?id=51049695</a></li>
</ul>
]]></content>
      <categories>
        <category>技术</category>
      </categories>
      <tags>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>Hexo+GitHub Page搭建自己的Blog</title>
    <url>/2016/11/14/hexo_gitpage/</url>
    <content><![CDATA[<h2 id="什么是Hexo"><a href="#什么是Hexo" class="headerlink" title="什么是Hexo"></a>什么是Hexo</h2><ul>
<li><p><a href="https://hexo.io/">Hexo</a> 是一个简单地、轻量地、基于Node的一个静态博客框架，可以方便的生成静态网页托管在github和Heroku上，引用Hexo作者 @tommy351 的话：</p>
</li>
<li><p>快速、简单且功能强大的 Node.js 博客框架。A fast, simple &amp; powerful blog framework, powered by Node.js.</p>
</li>
</ul>
<h2 id="GitHub-Pages是什么？"><a href="#GitHub-Pages是什么？" class="headerlink" title="GitHub Pages是什么？"></a>GitHub Pages是什么？</h2><ul>
<li><a href="https://pages.github.com/">GitHub Pages</a> 可以被认为是用户编写的、托管在github上的静态网页。由于它的空间免费稳定， 可以用于介绍托管在github上的Project或者搭建网站。</li>
</ul>
<span id="more"></span>
<p>以下环境为mac下安装。</p>
<h2 id="Hexo安装"><a href="#Hexo安装" class="headerlink" title="Hexo安装"></a>Hexo安装</h2><p>需要安装git和Node.js运行环境</p>
<h3 id="git安装"><a href="#git安装" class="headerlink" title="git安装"></a>git安装</h3><ul>
<li>mac自带git，如果需要重新安装，可去<a href="https://git-scm.com/downloads">官网下载</a><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git --version</span><br><span class="line">git version 2.9.3 (Apple Git-75)</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="安装npm"><a href="#安装npm" class="headerlink" title="安装npm"></a>安装npm</h3><ul>
<li>基于<a href="http://brew.sh/">brew</a>方式安装npm<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ brew install npm</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="安装Hexo"><a href="#安装Hexo" class="headerlink" title="安装Hexo"></a>安装Hexo</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ npm install hexo-cli -g</span><br></pre></td></tr></table></figure>
<p>npm安装Hexo：<a href="https://www.npmjs.com/package/hexo">参考资料</a></p>
<h3 id="查看Hexo版本"><a href="#查看Hexo版本" class="headerlink" title="查看Hexo版本"></a>查看Hexo版本</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo version</span><br><span class="line">hexo: 3.2.2</span><br><span class="line">hexo-cli: 1.0.2</span><br><span class="line">os: Darwin 16.1.0 darwin x64</span><br><span class="line">http_parser: 2.7.0</span><br><span class="line">node: 6.6.0</span><br><span class="line">v8: 5.1.281.83</span><br><span class="line">uv: 1.9.1</span><br><span class="line">zlib: 1.2.8</span><br><span class="line">ares: 1.10.1-DEV</span><br><span class="line">icu: 57.1</span><br><span class="line">modules: 48</span><br><span class="line">openssl: 1.0.2h</span><br></pre></td></tr></table></figure>


<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Setup-your-blog"><a href="#Setup-your-blog" class="headerlink" title="Setup your blog"></a>Setup your blog</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ~</span><br><span class="line">$ hexo init blog</span><br><span class="line">$ <span class="built_in">cd</span> blog</span><br></pre></td></tr></table></figure>
<ul>
<li>此命令会在当前用户的家目录下创建一个blog目录，并初始化相关文件，如下为初始化的目录结构：<br><img src="/images_glob/blog_dir.png" alt="blog目录结构" title="blog目录结构"></li>
</ul>
<h3 id="blog目录结构说明"><a href="#blog目录结构说明" class="headerlink" title="blog目录结构说明"></a>blog目录结构说明</h3><ul>
<li>scaffolds ：模板文件夹，新建文章时，Hexo 会根据 scaffold 来建立文件。Hexo 有三种默认布局： post 、 page 和 draft ，它们分别对应不同的路径。新建文件的默认布局是 post ，可以在配置文件中更改布局。用 draft 布局生成的文件会被保存到 source/_drafts 文件夹。</li>
<li>source ：资源文件夹是存放用户资源的地方。</li>
<li>source/_post ：文件箱。除 _posts 文件夹之外，开头命名为 _ (下划线)的文件或者文件夹和隐藏的文件将会被忽略。Markdown文件会被解析并放到 public 文件夹。</li>
<li>themes ：主题 文件夹。Hexo 会根据主题来生成静态页面。我们可以将自己的主题放到该目录下，然后在_config.yml中修改默认的主题即可。</li>
<li>themes/landscape ：默认的皮肤文件夹</li>
<li>_config.yml ：全局的配置文件，每次更改要重启服务。</li>
</ul>
<h3 id="config-yml简介"><a href="#config-yml简介" class="headerlink" title="_config.yml简介"></a>_config.yml简介</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Hexo Configuration</span></span><br><span class="line"><span class="comment">## Docs: https://hexo.io/docs/configuration.html</span></span><br><span class="line"><span class="comment">## Source: https://github.com/hexojs/hexo/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Site 站点配置</span></span><br><span class="line">title: Study Zone <span class="comment">#网站标题</span></span><br><span class="line">subtitle: Spring--java程序员的春天 <span class="comment">#网站副标题</span></span><br><span class="line">description: 分享成长与快乐的地方 <span class="comment">#网站描述</span></span><br><span class="line">author: hanqunfeng <span class="comment">#作者，网站所有者</span></span><br><span class="line">language: zh-CN <span class="comment">#网站使用的语言</span></span><br><span class="line">timezone: Asia/Shanghai <span class="comment">#网站时区</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># URL 可以不配置</span></span><br><span class="line"><span class="comment">## If your site is put in a subdirectory, set url as &#x27;http://yoursite.com/child&#x27; and root as &#x27;/child/&#x27;</span></span><br><span class="line">url: http://hanqunfeng.github.io <span class="comment">#网址，搜索时会在搜索引擎中显示</span></span><br><span class="line">root: / <span class="comment">#网站根目录</span></span><br><span class="line">permalink: :year/:month/:day/:title/ <span class="comment">#永久链接格式</span></span><br><span class="line">permalink_defaults: <span class="comment">#永久链接中各部分的默认值</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Directory 目录配置</span></span><br><span class="line">source_dir: <span class="built_in">source</span> <span class="comment">#资源文件夹，这个文件夹用来存放内容</span></span><br><span class="line">public_dir: public <span class="comment">#公共文件夹，这个文件夹用于存放生成的站点文件</span></span><br><span class="line">tag_dir: tags <span class="comment">#标签文件夹</span></span><br><span class="line">archive_dir: archives <span class="comment">#归档文件夹</span></span><br><span class="line">category_dir: categories <span class="comment">#分类文件夹</span></span><br><span class="line">code_dir: downloads/code <span class="comment">#Include code 文件夹</span></span><br><span class="line">i18n_dir: :lang <span class="comment">#国际化文件夹</span></span><br><span class="line">skip_render: <span class="comment">#跳过指定文件的渲染，您可使用 glob 来配置路径</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Writing 写作配置</span></span><br><span class="line">new_post_name: :title.md <span class="comment"># File name of new posts # 新文章的文件名称</span></span><br><span class="line">default_layout: post <span class="comment">#默认布局</span></span><br><span class="line">titlecase: <span class="literal">false</span> <span class="comment"># Transform title into titlecase</span></span><br><span class="line">external_link: <span class="literal">true</span> <span class="comment"># Open external links in new tab</span></span><br><span class="line">filename_case: 0 <span class="comment">#把文件名称转换为 (1) 小写或 (2) 大写</span></span><br><span class="line">render_drafts: <span class="literal">false</span> <span class="comment">#显示草稿</span></span><br><span class="line">post_asset_folder: <span class="literal">false</span> <span class="comment">#是否启动资源文件夹</span></span><br><span class="line">relative_link: <span class="literal">false</span> <span class="comment">#把链接改为与根目录的相对位址</span></span><br><span class="line">future: <span class="literal">true</span></span><br><span class="line">highlight: <span class="comment">#代码块的设置</span></span><br><span class="line">  <span class="built_in">enable</span>: <span class="literal">true</span></span><br><span class="line">  line_number: <span class="literal">true</span></span><br><span class="line">  auto_detect: <span class="literal">false</span></span><br><span class="line">  tab_replace:</span><br><span class="line"></span><br><span class="line"><span class="comment"># Category &amp; Tag 分类 &amp; 标签</span></span><br><span class="line">default_category: uncategorized <span class="comment">#默认分类</span></span><br><span class="line">category_map: <span class="comment">#分类别名</span></span><br><span class="line">tag_map: <span class="comment">#标签别名</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Date / Time format 时间和日期</span></span><br><span class="line"><span class="comment">## Hexo uses Moment.js to parse and display date</span></span><br><span class="line"><span class="comment">## You can customize the date format as defined in</span></span><br><span class="line"><span class="comment">## http://momentjs.com/docs/#/displaying/format/</span></span><br><span class="line">date_format: YYYY-MM-DD</span><br><span class="line">time_format: HH:mm:ss</span><br><span class="line"></span><br><span class="line"><span class="comment"># Pagination 分页</span></span><br><span class="line"><span class="comment">## Set per_page to 0 to disable pagination</span></span><br><span class="line">per_page: 10 <span class="comment">#每页显示的文章量 (0 = 关闭分页功能)</span></span><br><span class="line">pagination_dir: page <span class="comment">#分页目录</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Extensions 扩展</span></span><br><span class="line"><span class="comment">## Plugins: https://hexo.io/plugins/ 插件</span></span><br><span class="line"><span class="comment">## Themes: https://hexo.io/themes/ 主题</span></span><br><span class="line"><span class="comment"># theme: landscape #当前主题名称</span></span><br><span class="line">theme: yilia <span class="comment">#当前主题名称</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Deployment #部署到github</span></span><br><span class="line"><span class="comment">## Docs: https://hexo.io/docs/deployment.html</span></span><br><span class="line">deploy:</span><br><span class="line">  <span class="built_in">type</span>: git</span><br><span class="line">  repo: https://github.com/hanqunfeng/hanqunfeng.github.io.git</span><br><span class="line">  branch: master</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>注意：以下所有命令，都必须在blog目录下执行。</p>
<h3 id="Start-the-server"><a href="#Start-the-server" class="headerlink" title="Start the server"></a>Start the server</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo server</span><br><span class="line">INFO  Start processing</span><br><span class="line">INFO  Hexo is running at http://localhost:4000/. Press Ctrl+C to stop.</span><br></pre></td></tr></table></figure>
<ul>
<li>我们可以通过浏览器访问<a href="http://localhost:4000/">http://localhost:4000/</a>，就可以看到blog的页面了。</li>
<li>创建文件、生成静态文件以及发布到github，都不需要启动服务，启动服务的目的仅是为了能在本地看到效果。</li>
<li><code>hexo server</code> == <code>hexo s</code></li>
</ul>
<h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;Hello Hexo&quot;</span></span><br><span class="line">INFO  Created: ~/blog/<span class="built_in">source</span>/_posts/Hello-Hexo.md</span><br></pre></td></tr></table></figure>
<ul>
<li>创建好的文件基于<a href="http://www.appinn.com/markdown/">makedown</a>语法，可以使用sublime或者atom编辑器，进行编辑与管理。</li>
<li>编辑完成后不需要执行<code>hexo generate</code>命令即可在浏览器中查看效果，但是修改了主题内容，有时会不生效，需要先生成静态文件才能看到最终效果。</li>
<li><code>hexo new</code> == <code>hexo n</code></li>
</ul>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<ul>
<li>该命令用于将makedown文件转换为静态html文件，并放到public文件夹下。</li>
<li>可以使用<code>hexo clean</code>命令来删除public文件夹，之后再使用<code>hexo generate</code>来重新生成静态文件。</li>
<li><code>hexo generate</code> == <code>hexo g</code></li>
</ul>
<h3 id="Clean-static-files"><a href="#Clean-static-files" class="headerlink" title="Clean static files"></a>Clean static files</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo clean</span><br><span class="line">INFO  Deleted database.</span><br><span class="line">INFO  Deleted public folder.</span><br></pre></td></tr></table></figure>
<ul>
<li><code>hexo clean</code> == <code>hexo cl</code></li>
</ul>
<h2 id="主题"><a href="#主题" class="headerlink" title="主题"></a>主题</h2><h3 id="更换主题"><a href="#更换主题" class="headerlink" title="更换主题"></a>更换主题</h3><ul>
<li>github上有许多技术达人为Hexo制作的主题，可以clone到本地，并拷贝到themes文件夹下，然后修改_config.yml中的theme属性，修改主题需要重启Hexo才能生效。</li>
<li>比如博主使用主题为<a href="https://github.com/litten/hexo-theme-yilia">yilia下载地址</a>:<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ~/blog</span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/litten/hexo-theme-yilia.git themes/yilia</span><br></pre></td></tr></table></figure></li>
<li>更新主题时，在themes/yilia目录下执行<code>git pull</code>。</li>
</ul>
<h3 id="添加资源"><a href="#添加资源" class="headerlink" title="添加资源"></a>添加资源</h3><ul>
<li>可以在当前主题的source目录下放入自己的资源，执行<code>hexo generate</code>命令时，会将主题中的source目录下的内容拷贝到public目录下。</li>
<li>但是这样做如果更换主题，则资源就失效了，所以一般是在source目录下创建资源文件，执行<code>hexo generate</code>命令时，会将source目录下的内容拷贝到public目录下。</li>
</ul>
<h2 id="发布到Github"><a href="#发布到Github" class="headerlink" title="发布到Github"></a>发布到Github</h2><h3 id="安装hexo的git发布包"><a href="#安装hexo的git发布包" class="headerlink" title="安装hexo的git发布包"></a>安装hexo的git发布包</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ npm install hexo-deployer-git -S</span><br></pre></td></tr></table></figure>

<h3 id="创建SSH密钥"><a href="#创建SSH密钥" class="headerlink" title="创建SSH密钥"></a>创建SSH密钥</h3><ul>
<li>创建密钥可以在执行发布时不需要每次都输入用户名和密码，具体创建方法查看如下资料:<blockquote>
<ul>
<li><a href="https://help.github.com/articles/generating-an-ssh-key/">github官网</a></li>
<li><a href="http://www.xuanfengge.com/using-ssh-key-link-github-photo-tour.html">图文教程</a></li>
</ul>
</blockquote>
</li>
</ul>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><ul>
<li>因为使用<a href="https://pages.github.com/">GitPage</a>，所以需要申请一个Github帐号，并创建一个仓库，仓库名称为”your_name.github.io”。</li>
<li>创建好仓库后，在_config.yml中按上文中的内容配置好deploy属性。</li>
<li>执行如下命令，会将public下的文件发布到该仓库中，一般执行deploy前先执行clean和generate保证文件最新。</li>
<li>访问<a href="https://hanqunfeng.github.io/">https://hanqunfeng.github.io</a>，查看blog页面。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo clean</span><br><span class="line">$ hexo generate</span><br><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<ul>
<li><code>hexo deploy</code> == <code>hexo d</code></li>
</ul>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="http://www.tuicool.com/articles/ueI7naV">http://www.tuicool.com/articles/ueI7naV</a></li>
<li><a href="http://www.jianshu.com/p/465830080ea9">http://www.jianshu.com/p/465830080ea9</a></li>
</ul>
]]></content>
      <categories>
        <category>技术</category>
      </categories>
      <tags>
        <tag>hexo</tag>
      </tags>
  </entry>
</search>
