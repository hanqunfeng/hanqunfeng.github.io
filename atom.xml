<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>飘逸峰的博客</title>
  
  <subtitle>Spring--Java程序员的春天</subtitle>
  <link href="https://blog.hanqunfeng.com/atom.xml" rel="self"/>
  
  <link href="https://blog.hanqunfeng.com/"/>
  <updated>2023-07-19T12:02:03.518Z</updated>
  <id>https://blog.hanqunfeng.com/</id>
  
  <author>
    <name>飘逸峰</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>AWS-EKS-19--Autoscaling 之 Karpenter</title>
    <link href="https://blog.hanqunfeng.com/2023/07/19/aws-eks19-autoscaler-karpenter/"/>
    <id>https://blog.hanqunfeng.com/2023/07/19/aws-eks19-autoscaler-karpenter/</id>
    <published>2023-07-19T12:30:05.000Z</published>
    <updated>2023-07-19T12:02:03.518Z</updated>
    
    <content type="html"><![CDATA[<!-- **加粗** *斜体* ***加粗并斜体*** ~~删除线~~ ==突出显示== `突出显示(推荐)` ++下划线++ ~下标~ ^上标^ 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference. 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600) +++ **点击折叠** 这是被隐藏的内容 +++::: tips success warning danger这里是容器内的内容:::% note info % success warning danger这里是容器内的内容% endnote % --><h2 id="摘要">摘要</h2><ul class="lvl-0"><li class="lvl-2"><p>本文介绍EKS集群Autoscaling 之 Karpenter</p></li><li class="lvl-2"><p>参考资料：</p><ul class="lvl-2"><li class="lvl-6"><a href="https://docs.aws.amazon.com/zh_cn/eks/latest/userguide">Amazon EKS用户指南</a></li><li class="lvl-6"><a href="https://kubernetes.io/zh-cn/docs/home/">Kubernetes 文档</a></li></ul></li></ul><span id="more"></span><h2 id="Karperter是什么？">Karperter是什么？</h2><ul class="lvl-0"><li class="lvl-2"><p>Karpenter 是aws为 k8s 构建的能用于生产环境的开源的工作节点动态调度控制器。</p></li><li class="lvl-2"><p>相较于传统的 Cluster Autoscaler 工具，Karpenter 具有调度速度快、更灵活、资源利用率高等众多优势，是 EKS 自动扩缩容的首选方案，两者的比较可以参考下图。</p></li></ul><table><thead><tr><th>特 性</th><th>Cluster Autoscaler</th><th>Karpenter</th></tr></thead><tbody><tr><td>资源管理</td><td>Cluster Autoscaler基于现有节点的资源利用率采用反应性方法来扩展节点。</td><td>Karpenter基于未调度的Pod的当前资源需求采取主动方法来进行节点预配。</td></tr><tr><td>节点管理</td><td>Cluster Autoscaler根据当前工作负载的资源需求来管理节点，使用预定义的自动缩放组。</td><td>Karpenter根据自定义预配程序的配置来扩展、预配和管理节点。</td></tr><tr><td>扩展</td><td>Cluster Autoscaler更专注于节点级别的扩展，这意味着它可以有效地添加更多的节点以满足需求的增加。 但这也意味着它在缩减资源方面可能不太有效。</td><td>Karpenter根据特定的工作负载需求提供更有效和精细的扩展功能。换句话说，它根据实际使用情况进行扩展。它还允许用户指定特定的扩展策略或规则以满足其需求。</td></tr><tr><td>调度</td><td>使用Cluster Autoscaler进行调度更简单，因为它是根据工作负载的当前需求设计的进行扩展或缩减。</td><td>Karpenter可以根据可用区和资源需求有效地调度工作负载。它可以尝试通过Spot实例来优化成本，但它不会知道你已经在aws帐号中做的任何承诺，如RI（预留实例）或Savings Plans（储蓄计划）。</td></tr></tbody></table><h2 id="Karpenter-运行环境准备">Karpenter 运行环境准备</h2><h3 id="设置环境变量">设置环境变量</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># aws认证profile</span></span><br><span class="line">$ AWS_PROFILE=eks-us-west-2</span><br><span class="line"><span class="comment"># EKS集群名称</span></span><br><span class="line">$ CLUSTER_NAME=eks-lexing</span><br><span class="line"><span class="comment"># AWS分区</span></span><br><span class="line"><span class="comment"># if you are not using standard partitions, you may need to configure to aws-cn / aws-us-gov</span></span><br><span class="line">$ AWS_PARTITION=<span class="string">&quot;aws&quot;</span></span><br><span class="line"><span class="comment"># EKS所在的Region</span></span><br><span class="line">$ AWS_REGION=<span class="string">&quot;<span class="subst">$(aws configure list | grep region | tr -s <span class="string">&quot; &quot;</span> | cut -d<span class="string">&quot; &quot;</span> -f3)</span>&quot;</span></span><br><span class="line"><span class="comment"># EKS配置OIDC的Endpoint</span></span><br><span class="line">$ OIDC_ENDPOINT=<span class="string">&quot;<span class="subst">$(aws eks describe-cluster --name $&#123;CLUSTER_NAME&#125; --query <span class="string">&quot;cluster.identity.oidc.issuer&quot;</span> --output text)</span>&quot;</span></span><br><span class="line"><span class="comment"># aws帐号ID</span></span><br><span class="line">$ AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query <span class="string">&#x27;Account&#x27;</span> --output text)</span><br></pre></td></tr></table></figure><h3 id="创建-Karpenter-的-node-需要的-role">创建 Karpenter 的 node 需要的 role</h3><ul class="lvl-0"><li class="lvl-2"><p>1.创建role</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">    &quot;Version&quot;: &quot;2012-10-17&quot;,</span></span><br><span class="line"><span class="string">    &quot;Statement&quot;: [</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            &quot;Effect&quot;: &quot;Allow&quot;,</span></span><br><span class="line"><span class="string">            &quot;Principal&quot;: &#123;</span></span><br><span class="line"><span class="string">                &quot;Service&quot;: &quot;ec2.amazonaws.com&quot;</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            &quot;Action&quot;: &quot;sts:AssumeRole&quot;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    ]</span></span><br><span class="line"><span class="string">&#125;&#x27;</span> &gt; node-trust-policy.json</span><br><span class="line"></span><br><span class="line">$ aws iam create-role --role-name <span class="string">&quot;KarpenterNodeRole-<span class="variable">$&#123;CLUSTER_NAME&#125;</span>&quot;</span> \</span><br><span class="line">    --assume-role-policy-document file://node-trust-policy.json</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;Role&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;Path&quot;</span>: <span class="string">&quot;/&quot;</span>,</span><br><span class="line">        <span class="string">&quot;RoleName&quot;</span>: <span class="string">&quot;KarpenterNodeRole-eks-lexing&quot;</span>,</span><br><span class="line">        <span class="string">&quot;RoleId&quot;</span>: <span class="string">&quot;AROA22DP3G4GH4RZQFGR7&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Arn&quot;</span>: <span class="string">&quot;arn:aws:iam::743263909644:role/KarpenterNodeRole-eks-lexing&quot;</span>,</span><br><span class="line">        <span class="string">&quot;CreateDate&quot;</span>: <span class="string">&quot;2023-07-19T07:20:17+00:00&quot;</span>,</span><br><span class="line">        <span class="string">&quot;AssumeRolePolicyDocument&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Version&quot;</span>: <span class="string">&quot;2012-10-17&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Statement&quot;</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">&quot;Effect&quot;</span>: <span class="string">&quot;Allow&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;Principal&quot;</span>: &#123;</span><br><span class="line">                        <span class="string">&quot;Service&quot;</span>: <span class="string">&quot;ec2.amazonaws.com&quot;</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="string">&quot;Action&quot;</span>: <span class="string">&quot;sts:AssumeRole&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>2.给这个 role 添加 policy</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ aws iam attach-role-policy --role-name <span class="string">&quot;KarpenterNodeRole-<span class="variable">$&#123;CLUSTER_NAME&#125;</span>&quot;</span> \</span><br><span class="line">    --policy-arn arn:<span class="variable">$&#123;AWS_PARTITION&#125;</span>:iam::aws:policy/AmazonEKSWorkerNodePolicy</span><br><span class="line"></span><br><span class="line">$ aws iam attach-role-policy --role-name <span class="string">&quot;KarpenterNodeRole-<span class="variable">$&#123;CLUSTER_NAME&#125;</span>&quot;</span> \</span><br><span class="line">    --policy-arn arn:<span class="variable">$&#123;AWS_PARTITION&#125;</span>:iam::aws:policy/AmazonEKS_CNI_Policy</span><br><span class="line"></span><br><span class="line">$ aws iam attach-role-policy --role-name <span class="string">&quot;KarpenterNodeRole-<span class="variable">$&#123;CLUSTER_NAME&#125;</span>&quot;</span> \</span><br><span class="line">    --policy-arn arn:<span class="variable">$&#123;AWS_PARTITION&#125;</span>:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly</span><br><span class="line"></span><br><span class="line">$ aws iam attach-role-policy --role-name <span class="string">&quot;KarpenterNodeRole-<span class="variable">$&#123;CLUSTER_NAME&#125;</span>&quot;</span> \</span><br><span class="line">    --policy-arn arn:<span class="variable">$&#123;AWS_PARTITION&#125;</span>:iam::aws:policy/AmazonSSMManagedInstanceCore</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>3.把 role 授予 EC2 的 instance profile</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ aws iam create-instance-profile \</span><br><span class="line">    --instance-profile-name <span class="string">&quot;KarpenterNodeInstanceProfile-<span class="variable">$&#123;CLUSTER_NAME&#125;</span>&quot;</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;InstanceProfile&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;Path&quot;</span>: <span class="string">&quot;/&quot;</span>,</span><br><span class="line">        <span class="string">&quot;InstanceProfileName&quot;</span>: <span class="string">&quot;KarpenterNodeInstanceProfile-eks-lexing&quot;</span>,</span><br><span class="line">        <span class="string">&quot;InstanceProfileId&quot;</span>: <span class="string">&quot;AIPA22DP3G4GBMSNSBEQF&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Arn&quot;</span>: <span class="string">&quot;arn:aws:iam::743263909644:instance-profile/KarpenterNodeInstanceProfile-eks-lexing&quot;</span>,</span><br><span class="line">        <span class="string">&quot;CreateDate&quot;</span>: <span class="string">&quot;2023-07-19T07:24:19+00:00&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Roles&quot;</span>: []</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ aws iam add-role-to-instance-profile \</span><br><span class="line">    --instance-profile-name <span class="string">&quot;KarpenterNodeInstanceProfile-<span class="variable">$&#123;CLUSTER_NAME&#125;</span>&quot;</span> \</span><br><span class="line">    --role-name <span class="string">&quot;KarpenterNodeRole-<span class="variable">$&#123;CLUSTER_NAME&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure><h3 id="创建-Karpenter-controller-需要的-role">创建 Karpenter controller 需要的 role</h3><ul class="lvl-0"><li class="lvl-2"><p>1.创建role</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> &lt;&lt; <span class="string">EOF &gt; controller-trust-policy.json</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    &quot;Version&quot;: &quot;2012-10-17&quot;,</span></span><br><span class="line"><span class="string">    &quot;Statement&quot;: [</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            &quot;Effect&quot;: &quot;Allow&quot;,</span></span><br><span class="line"><span class="string">            &quot;Principal&quot;: &#123;</span></span><br><span class="line"><span class="string">                &quot;Federated&quot;: &quot;arn:$&#123;AWS_PARTITION&#125;:iam::$&#123;AWS_ACCOUNT_ID&#125;:oidc-provider/$&#123;OIDC_ENDPOINT#*//&#125;&quot;</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            &quot;Action&quot;: &quot;sts:AssumeRoleWithWebIdentity&quot;,</span></span><br><span class="line"><span class="string">            &quot;Condition&quot;: &#123;</span></span><br><span class="line"><span class="string">                &quot;StringEquals&quot;: &#123;</span></span><br><span class="line"><span class="string">                    &quot;$&#123;OIDC_ENDPOINT#*//&#125;:aud&quot;: &quot;sts.amazonaws.com&quot;,</span></span><br><span class="line"><span class="string">                    &quot;$&#123;OIDC_ENDPOINT#*//&#125;:sub&quot;: &quot;system:serviceaccount:karpenter:karpenter&quot;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    ]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">$ aws iam create-role --role-name KarpenterControllerRole-<span class="variable">$&#123;CLUSTER_NAME&#125;</span> \</span><br><span class="line">    --assume-role-policy-document file://controller-trust-policy.json</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;Role&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;Path&quot;</span>: <span class="string">&quot;/&quot;</span>,</span><br><span class="line">        <span class="string">&quot;RoleName&quot;</span>: <span class="string">&quot;KarpenterControllerRole-eks-lexing&quot;</span>,</span><br><span class="line">        <span class="string">&quot;RoleId&quot;</span>: <span class="string">&quot;AROA22DP3G4GLRLLAPW6T&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Arn&quot;</span>: <span class="string">&quot;arn:aws:iam::743263909644:role/KarpenterControllerRole-eks-lexing&quot;</span>,</span><br><span class="line">        <span class="string">&quot;CreateDate&quot;</span>: <span class="string">&quot;2023-07-19T07:28:09+00:00&quot;</span>,</span><br><span class="line">        <span class="string">&quot;AssumeRolePolicyDocument&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Version&quot;</span>: <span class="string">&quot;2012-10-17&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Statement&quot;</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">&quot;Effect&quot;</span>: <span class="string">&quot;Allow&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;Principal&quot;</span>: &#123;</span><br><span class="line">                        <span class="string">&quot;Federated&quot;</span>: <span class="string">&quot;arn:aws:iam::743263909644:oidc-provider/oidc.eks.us-west-2.amazonaws.com/id/1029FF88CB872B6B7A1CC65D44191A56&quot;</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="string">&quot;Action&quot;</span>: <span class="string">&quot;sts:AssumeRoleWithWebIdentity&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;Condition&quot;</span>: &#123;</span><br><span class="line">                        <span class="string">&quot;StringEquals&quot;</span>: &#123;</span><br><span class="line">                            <span class="string">&quot;oidc.eks.us-west-2.amazonaws.com/id/1029FF88CB872B6B7A1CC65D44191A56:aud&quot;</span>: <span class="string">&quot;sts.amazonaws.com&quot;</span>,</span><br><span class="line">                            <span class="string">&quot;oidc.eks.us-west-2.amazonaws.com/id/1029FF88CB872B6B7A1CC65D44191A56:sub&quot;</span>: <span class="string">&quot;system:serviceaccount:karpenter:karpenter&quot;</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>2.为role配置policy</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> &lt;&lt; <span class="string">EOF &gt; controller-policy.json</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    &quot;Statement&quot;: [</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            &quot;Action&quot;: [</span></span><br><span class="line"><span class="string">                &quot;ssm:GetParameter&quot;,</span></span><br><span class="line"><span class="string">                &quot;ec2:DescribeImages&quot;,</span></span><br><span class="line"><span class="string">                &quot;ec2:RunInstances&quot;,</span></span><br><span class="line"><span class="string">                &quot;ec2:DescribeSubnets&quot;,</span></span><br><span class="line"><span class="string">                &quot;ec2:DescribeSecurityGroups&quot;,</span></span><br><span class="line"><span class="string">                &quot;ec2:DescribeLaunchTemplates&quot;,</span></span><br><span class="line"><span class="string">                &quot;ec2:DescribeInstances&quot;,</span></span><br><span class="line"><span class="string">                &quot;ec2:DescribeInstanceTypes&quot;,</span></span><br><span class="line"><span class="string">                &quot;ec2:DescribeInstanceTypeOfferings&quot;,</span></span><br><span class="line"><span class="string">                &quot;ec2:DescribeAvailabilityZones&quot;,</span></span><br><span class="line"><span class="string">                &quot;ec2:DeleteLaunchTemplate&quot;,</span></span><br><span class="line"><span class="string">                &quot;ec2:CreateTags&quot;,</span></span><br><span class="line"><span class="string">                &quot;ec2:CreateLaunchTemplate&quot;,</span></span><br><span class="line"><span class="string">                &quot;ec2:CreateFleet&quot;,</span></span><br><span class="line"><span class="string">                &quot;ec2:DescribeSpotPriceHistory&quot;,</span></span><br><span class="line"><span class="string">                &quot;pricing:GetProducts&quot;</span></span><br><span class="line"><span class="string">            ],</span></span><br><span class="line"><span class="string">            &quot;Effect&quot;: &quot;Allow&quot;,</span></span><br><span class="line"><span class="string">            &quot;Resource&quot;: &quot;*&quot;,</span></span><br><span class="line"><span class="string">            &quot;Sid&quot;: &quot;Karpenter&quot;</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            &quot;Action&quot;: &quot;ec2:TerminateInstances&quot;,</span></span><br><span class="line"><span class="string">            &quot;Condition&quot;: &#123;</span></span><br><span class="line"><span class="string">                &quot;StringLike&quot;: &#123;</span></span><br><span class="line"><span class="string">                    &quot;ec2:ResourceTag/karpenter.sh/provisioner-name&quot;: &quot;*&quot;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            &quot;Effect&quot;: &quot;Allow&quot;,</span></span><br><span class="line"><span class="string">            &quot;Resource&quot;: &quot;*&quot;,</span></span><br><span class="line"><span class="string">            &quot;Sid&quot;: &quot;ConditionalEC2Termination&quot;</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            &quot;Effect&quot;: &quot;Allow&quot;,</span></span><br><span class="line"><span class="string">            &quot;Action&quot;: &quot;iam:PassRole&quot;,</span></span><br><span class="line"><span class="string">            &quot;Resource&quot;: &quot;arn:$&#123;AWS_PARTITION&#125;:iam::$&#123;AWS_ACCOUNT_ID&#125;:role/KarpenterNodeRole-$&#123;CLUSTER_NAME&#125;&quot;,</span></span><br><span class="line"><span class="string">            &quot;Sid&quot;: &quot;PassNodeIAMRole&quot;</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            &quot;Effect&quot;: &quot;Allow&quot;,</span></span><br><span class="line"><span class="string">            &quot;Action&quot;: &quot;eks:DescribeCluster&quot;,</span></span><br><span class="line"><span class="string">            &quot;Resource&quot;: &quot;arn:$&#123;AWS_PARTITION&#125;:eks:$&#123;AWS_REGION&#125;:$&#123;AWS_ACCOUNT_ID&#125;:cluster/$&#123;CLUSTER_NAME&#125;&quot;,</span></span><br><span class="line"><span class="string">            &quot;Sid&quot;: &quot;EKSClusterEndpointLookup&quot;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    ],</span></span><br><span class="line"><span class="string">    &quot;Version&quot;: &quot;2012-10-17&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">$ aws iam put-role-policy --role-name KarpenterControllerRole-<span class="variable">$&#123;CLUSTER_NAME&#125;</span> \</span><br><span class="line">    --policy-name KarpenterControllerPolicy-<span class="variable">$&#123;CLUSTER_NAME&#125;</span> \</span><br><span class="line">    --policy-document file://controller-policy.json</span><br></pre></td></tr></table></figure><h3 id="为所有子网和安全组添加标签">为所有子网和安全组添加标签</h3><ul class="lvl-0"><li class="lvl-2"><p>1.为节点组内的子网打标签</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="keyword">for</span> NODEGROUP <span class="keyword">in</span> $(aws eks list-nodegroups --cluster-name <span class="variable">$&#123;CLUSTER_NAME&#125;</span> --query <span class="string">&#x27;nodegroups&#x27;</span> --output text)</span><br><span class="line">  <span class="keyword">do</span> aws ec2 create-tags \</span><br><span class="line">        --tags <span class="string">&quot;Key=karpenter.sh/discovery,Value=<span class="variable">$&#123;CLUSTER_NAME&#125;</span>&quot;</span> \</span><br><span class="line">        --resources $(aws eks describe-nodegroup --cluster-name <span class="variable">$&#123;CLUSTER_NAME&#125;</span> \</span><br><span class="line">        --nodegroup-name <span class="variable">$NODEGROUP</span> --query <span class="string">&#x27;nodegroup.subnets&#x27;</span> --output text )</span><br><span class="line">  <span class="keyword">done</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>2.给托管节点组的运行模版的安全组打标签</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获取节点组</span></span><br><span class="line">$ NODEGROUP=$(aws eks list-nodegroups --cluster-name <span class="variable">$&#123;CLUSTER_NAME&#125;</span> \</span><br><span class="line">    --query <span class="string">&#x27;nodegroups[0]&#x27;</span> --output text)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取节点组的启动模板及其版本号</span></span><br><span class="line">$ LAUNCH_TEMPLATE=$(aws eks describe-nodegroup --cluster-name <span class="variable">$&#123;CLUSTER_NAME&#125;</span> \</span><br><span class="line">    --nodegroup-name <span class="variable">$&#123;NODEGROUP&#125;</span> --query <span class="string">&#x27;nodegroup.launchTemplate.&#123;id:id,version:version&#125;&#x27;</span> \</span><br><span class="line">    --output text | <span class="built_in">tr</span> -s <span class="string">&quot;\t&quot;</span> <span class="string">&quot;,&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取启动模板的安全组</span></span><br><span class="line">$ SECURITY_GROUPS=$(aws ec2 describe-launch-template-versions \</span><br><span class="line">    --launch-template-id <span class="variable">$&#123;LAUNCH_TEMPLATE%,*&#125;</span> --versions <span class="variable">$&#123;LAUNCH_TEMPLATE#*,&#125;</span> \</span><br><span class="line">    --query <span class="string">&#x27;LaunchTemplateVersions[0].LaunchTemplateData.[NetworkInterfaces[0].Groups||SecurityGroupIds]&#x27;</span> \</span><br><span class="line">    --output text)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 为安全组打标签</span></span><br><span class="line">$ aws ec2 create-tags \</span><br><span class="line">    --tags <span class="string">&quot;Key=karpenter.sh/discovery,Value=<span class="variable">$&#123;CLUSTER_NAME&#125;</span>&quot;</span> \</span><br><span class="line">    --resources <span class="variable">$&#123;SECURITY_GROUPS&#125;</span></span><br></pre></td></tr></table></figure><h3 id="更新-aws-auth-ConfigMap">更新 aws-auth ConfigMap</h3><ul class="lvl-0"><li class="lvl-2"><p>将上面为node创建的role加入到集群权限</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl edit configmap aws-auth -n kube-system</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 mapRoles 下添加如下内容</span></span><br><span class="line">- <span class="built_in">groups</span>:</span><br><span class="line">  - system:bootstrappers</span><br><span class="line">  - system:nodes</span><br><span class="line">  rolearn: arn:aws:iam::743263909644:role/KarpenterNodeRole-eks-lexing</span><br><span class="line">  username: system:node:&#123;&#123;EC2PrivateDNSName&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者通过命令行直接添加</span></span><br><span class="line">$ eksctl create iamidentitymapping --cluster eks-lexing \</span><br><span class="line">  --arn arn:aws:iam::743263909644:role/KarpenterNodeRole-eks-lexing \</span><br><span class="line">  --username system:node:&#123;&#123;EC2PrivateDNSName&#125;&#125; \</span><br><span class="line">  --group system:bootstrappers \</span><br><span class="line">  --group system:nodes \</span><br><span class="line">  --no-duplicate-arns</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>编辑后完整的内容如下:</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">mapRoles:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    - groups:</span></span><br><span class="line"><span class="string">      - system:bootstrappers</span></span><br><span class="line"><span class="string">      - system:nodes</span></span><br><span class="line"><span class="string">      rolearn: arn:aws:iam::743263909644:role/eksctl-eks-lexing-nodegroup-ng-4d-NodeInstanceRole-Y28EPJO9XYDG</span></span><br><span class="line"><span class="string">      username: system:node:&#123;&#123;EC2PrivateDNSName&#125;&#125;</span></span><br><span class="line"><span class="string">    - groups:</span></span><br><span class="line"><span class="string">      - system:bootstrappers</span></span><br><span class="line"><span class="string">      - system:nodes</span></span><br><span class="line"><span class="string">      rolearn: arn:aws:iam::743263909644:role/KarpenterNodeRole-eks-lexing</span></span><br><span class="line"><span class="string">      username: system:node:&#123;&#123;EC2PrivateDNSName&#125;&#125;</span></span><br><span class="line"><span class="string"></span>  <span class="attr">mapUsers:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    - groups:</span></span><br><span class="line"><span class="string">      - eks-console-dashboard-full-access-group</span></span><br><span class="line"><span class="string">      userarn: arn:aws:iam::743263909644:user/ekstest</span></span><br><span class="line"><span class="string"></span><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="string">&quot;2023-06-28T06:30:56Z&quot;</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">aws-auth</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;7544319&quot;</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">5e488d60-6ce0-4657-9a08-bbd17d048f0c</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>查看授权信息</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ eksctl get iamidentitymapping --cluster eks-lexing</span><br><span class="line">ARNUSERNAMEGROUPSACCOUNT</span><br><span class="line">arn:aws:iam::743263909644:role/KarpenterNodeRole-eks-lexingsystem:node:&#123;&#123;EC2PrivateDNSName&#125;&#125;system:bootstrappers,system:nodes</span><br><span class="line">arn:aws:iam::743263909644:role/eksctl-eks-lexing-nodegroup-ng-4d-NodeInstanceRole-Y28EPJO9XYDGsystem:node:&#123;&#123;EC2PrivateDNSName&#125;&#125;system:bootstrappers,system:nodes</span><br><span class="line">arn:aws:iam::743263909644:user/ekstesteks-console-dashboard-full-access-group</span><br></pre></td></tr></table></figure><h2 id="部署-Karpenter">部署 Karpenter</h2><ul class="lvl-0"><li class="lvl-2"><p>1.设置环境变量</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 当前最新版是 v0.29.1 , https://github.com/aws/karpenter/releases</span></span><br><span class="line"><span class="built_in">export</span> KARPENTER_VERSION=v0.29.1</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>2.部署 karpenter 相关资源</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create namespace karpenter</span><br><span class="line"><span class="comment"># karpenter的版本分支，正常karpenter发布时都会打branch，比如：release-v0.28.1，不过我在github上没有找到v0.29.1的branch，所以这里就指定 main 了</span></span><br><span class="line">$ KARPENTER_BRANCH=main</span><br><span class="line">$ curl -O <span class="string">&quot;https://raw.githubusercontent.com/aws/karpenter/<span class="variable">$&#123;KARPENTER_BRANCH&#125;</span>/pkg/apis/crds/karpenter.sh_provisioners.yaml&quot;</span></span><br><span class="line">$ curl -O <span class="string">&quot;https://raw.githubusercontent.com/aws/karpenter/<span class="variable">$&#123;KARPENTER_BRANCH&#125;</span>/pkg/apis/crds/karpenter.k8s.aws_awsnodetemplates.yaml&quot;</span></span><br><span class="line">$ curl -O <span class="string">&quot;https://raw.githubusercontent.com/aws/karpenter/<span class="variable">$&#123;KARPENTER_BRANCH&#125;</span>/pkg/apis/crds/karpenter.sh_machines.yaml &quot;</span></span><br><span class="line"></span><br><span class="line">$ kubectl apply -f karpenter.sh_provisioners.yaml</span><br><span class="line">$ kubectl apply -f crds/karpenter.k8s.aws_awsnodetemplates.yaml</span><br><span class="line">$ kubectl apply -f karpenter.sh_machines.yaml</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>3.创建 karpenter.yaml 模版并部署</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ helm template karpenter oci://public.ecr.aws/karpenter/karpenter --version <span class="variable">$&#123;KARPENTER_VERSION&#125;</span> \</span><br><span class="line">    --namespace karpenter \</span><br><span class="line">    --<span class="built_in">set</span> settings.aws.defaultInstanceProfile=KarpenterNodeInstanceProfile-<span class="variable">$&#123;CLUSTER_NAME&#125;</span> \</span><br><span class="line">    --<span class="built_in">set</span> settings.aws.clusterName=<span class="variable">$&#123;CLUSTER_NAME&#125;</span> \</span><br><span class="line">    --<span class="built_in">set</span> serviceAccount.annotations.<span class="string">&quot;eks\.amazonaws\.com/role-arn&quot;</span>=<span class="string">&quot;arn:<span class="variable">$&#123;AWS_PARTITION&#125;</span>:iam::<span class="variable">$&#123;AWS_ACCOUNT_ID&#125;</span>:role/KarpenterControllerRole-<span class="variable">$&#123;CLUSTER_NAME&#125;</span>&quot;</span> \</span><br><span class="line">    --<span class="built_in">set</span> controller.resources.requests.cpu=1 \</span><br><span class="line">    --<span class="built_in">set</span> controller.resources.requests.memory=1Gi \</span><br><span class="line">    --<span class="built_in">set</span> controller.resources.limits.cpu=1 \</span><br><span class="line">    --<span class="built_in">set</span> controller.resources.limits.memory=1Gi &gt; karpenter.yaml</span><br><span class="line">$ k apply -f karpenter.yaml</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>4.创建默认的 provisioner</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | kubectl apply -f -</span></span><br><span class="line"><span class="string">apiVersion: karpenter.sh/v1alpha5</span></span><br><span class="line"><span class="string">kind: Provisioner</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: default</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  requirements:</span></span><br><span class="line"><span class="string">    - key: karpenter.k8s.aws/instance-category</span></span><br><span class="line"><span class="string">      operator: In</span></span><br><span class="line"><span class="string">      values: [c, m, r]</span></span><br><span class="line"><span class="string">    - key: karpenter.k8s.aws/instance-generation</span></span><br><span class="line"><span class="string">      operator: Gt</span></span><br><span class="line"><span class="string">      values: [&quot;2&quot;]</span></span><br><span class="line"><span class="string">  providerRef:</span></span><br><span class="line"><span class="string">    name: default</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: karpenter.k8s.aws/v1alpha1</span></span><br><span class="line"><span class="string">kind: AWSNodeTemplate</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: default</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  subnetSelector:</span></span><br><span class="line"><span class="string">    karpenter.sh/discovery: &quot;$&#123;CLUSTER_NAME&#125;&quot;</span></span><br><span class="line"><span class="string">  securityGroupSelector:</span></span><br><span class="line"><span class="string">    karpenter.sh/discovery: &quot;$&#123;CLUSTER_NAME&#125;&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>查看 karpenter 状态</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ k get pod -n karpenter</span><br><span class="line">NAME                         READY   STATUS    RESTARTS   AGE</span><br><span class="line">karpenter-789bbcbfd7-htj6z   1/1     Running   0          101s</span><br><span class="line">karpenter-789bbcbfd7-rlxfp   1/1     Running   0          101s</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>karpenter创建新的节点时不会在原有的节点组中进行，所以为了摆脱从节点组添加的实例，我们可以将节点组缩小到最小大小</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如果您有一个多AZ节点组，我们建议至少2个实例。</span></span><br><span class="line">$ aws eks update-nodegroup-config --cluster-name <span class="variable">$&#123;CLUSTER_NAME&#125;</span> \</span><br><span class="line">    --nodegroup-name <span class="variable">$&#123;NODEGROUP&#125;</span> \</span><br><span class="line">    --scaling-config <span class="string">&quot;minSize=2,maxSize=2,desiredSize=2&quot;</span></span><br></pre></td></tr></table></figure><h2 id="测试">测试</h2><ul class="lvl-0"><li class="lvl-2"><p>查看当前node信息</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ k get node</span><br><span class="line">NAME                                           STATUS   ROLES    AGE   VERSION</span><br><span class="line">ip-192-168-16-155.us-west-2.compute.internal   Ready    &lt;none&gt;   19d   v1.26.4-eks-0a21954</span><br><span class="line">ip-192-168-48-14.us-west-2.compute.internal    Ready    &lt;none&gt;   19d   v1.26.4-eks-0a21954</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>采用 <a href="/2023/07/18/aws-eks18-autoscaler-cas/" title="AWS-EKS-18--Autoscaling 之 Cluster Autoscaler(CAS)">AWS-EKS-18--Autoscaling 之 Cluster Autoscaler(CAS)</a> 中的测试方法，将deploy的副本数设置为50，过一会查看node情况</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 可以看到node数量已经变为3了，说明扩容成功</span></span><br><span class="line">$ k get node</span><br><span class="line">NAME                                           STATUS   ROLES    AGE   VERSION</span><br><span class="line">ip-192-168-16-155.us-west-2.compute.internal   Ready    &lt;none&gt;   19d   v1.26.4-eks-0a21954</span><br><span class="line">ip-192-168-34-126.us-west-2.compute.internal   Ready    &lt;none&gt;   47s   v1.26.6-eks-a5565ad</span><br><span class="line">ip-192-168-48-14.us-west-2.compute.internal    Ready    &lt;none&gt;   20d   v1.26.4-eks-0a21954</span><br></pre></td></tr></table></figure><p><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/Rx3wJO.png" alt="" width="1000" height="800"></p>]]></content>
    
    
    <summary type="html">&lt;!--
 **加粗**
 *斜体*
 ***加粗并斜体***
 ~~删除线~~
 ==突出显示==
 `突出显示(推荐)`
 ++下划线++
 ~下标~
 ^上标^
 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.
 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600)

 +++ **点击折叠**
 这是被隐藏的内容
 +++

::: tips success warning danger
这里是容器内的内容
:::

% note info % success warning danger
这里是容器内的内容
% endnote %

 --&gt;
&lt;h2 id=&quot;摘要&quot;&gt;摘要&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;本文介绍EKS集群Autoscaling 之 Karpenter&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;参考资料：&lt;/p&gt;
&lt;ul class=&quot;lvl-2&quot;&gt;
&lt;li class=&quot;lvl-6&quot;&gt;&lt;a href=&quot;https://docs.aws.amazon.com/zh_cn/eks/latest/userguide&quot;&gt;Amazon EKS用户指南&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-6&quot;&gt;&lt;a href=&quot;https://kubernetes.io/zh-cn/docs/home/&quot;&gt;Kubernetes 文档&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="技术" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="aws" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/aws/"/>
    
    <category term="eks" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/aws/eks/"/>
    
    
    <category term="java" scheme="https://blog.hanqunfeng.com/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>AWS-EKS-18--Autoscaling 之 Cluster Autoscaler(CAS)</title>
    <link href="https://blog.hanqunfeng.com/2023/07/18/aws-eks18-autoscaler-cas/"/>
    <id>https://blog.hanqunfeng.com/2023/07/18/aws-eks18-autoscaler-cas/</id>
    <published>2023-07-18T12:30:05.000Z</published>
    <updated>2023-07-19T10:27:12.344Z</updated>
    
    <content type="html"><![CDATA[<!-- **加粗** *斜体* ***加粗并斜体*** ~~删除线~~ ==突出显示== `突出显示(推荐)` ++下划线++ ~下标~ ^上标^ 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference. 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600) +++ **点击折叠** 这是被隐藏的内容 +++::: tips success warning danger这里是容器内的内容:::% note info % success warning danger这里是容器内的内容% endnote % --><h2 id="摘要">摘要</h2><ul class="lvl-0"><li class="lvl-2"><p>本文介绍EKS集群Autoscaling 之 Cluster Autoscaler(CAS)</p></li><li class="lvl-2"><p>参考资料：</p><ul class="lvl-2"><li class="lvl-6"><a href="https://docs.aws.amazon.com/zh_cn/eks/latest/userguide">Amazon EKS用户指南</a></li><li class="lvl-6"><a href="https://kubernetes.io/zh-cn/docs/home/">Kubernetes 文档</a></li></ul></li></ul><span id="more"></span><h2 id="EKS集群Autoscaling">EKS集群Autoscaling</h2><ul class="lvl-0"><li class="lvl-2"><p>弹性伸缩是一项功能，可以自动上下伸缩您的资源以满足不断变化的需求。</p></li><li class="lvl-2"><p>Amazon EKS 支持两款自动扩缩产品:</p><ul class="lvl-2"><li class="lvl-6"><a href="https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/cloudprovider/aws/README.md">Cluster Autoscaler(CAS) </a>，本文就介绍这款产品的使用方法。</li><li class="lvl-6"><a href="https://karpenter.sh/docs/">Karpenter</a></li></ul></li></ul><h2 id="Cluster-Autoscaler-CAS-是什么？">Cluster Autoscaler(CAS)是什么？</h2><ul class="lvl-0"><li class="lvl-2"><p><code>Cluster Autoscaler</code> 是一个可以自动调整<code>Kubernetes</code>集群大小的组件，以便所有<code>pod</code>都有运行的地方，并且没有不需要的节点。支持多个公共云提供商。</p></li><li class="lvl-2"><p><code>AWS EKS</code>集群自动扩容功能可以基于<code>Cluster Autoscaler</code>自动调整集群中node的数量以适应需求变化。</p></li><li class="lvl-2"><p><code>Cluster Autoscaler</code>一般以Deployment的方式部署在K8s中，通过<code>service account</code>赋予的权限来访问<code>AWS autoscaling group</code>资源，并控制node（EC2）的增减。</p></li><li class="lvl-2"><p><code>AWS EKS Cluster Autoscaler</code> 以 <code>Amazon EC2 Auto Scaling Groups</code>服务为基础对node进行扩容，所以其扩容或缩容时，也要遵守节点组扩缩中的配置<br><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/igPla5.png" alt="" width="300" height="300"></p></li><li class="lvl-2"><p>当有新的Pod无法在现有node上schedule时会触发扩容，当node空闲超过10min时，会触发缩容。</p></li><li class="lvl-2"><p><code>Cluster Autoscaler</code>的镜像版本要求与K8s版本匹配，所以当EKS(K8s)升级时，<code>Cluster Autoscaler</code>的镜像也要进行升级。</p></li></ul><h2 id="创建IAM策略和角色">创建IAM策略和角色</h2><ul class="lvl-0"><li class="lvl-2"><p>创建Policy：<code>cluster-autoscaler-policy.json</code></p></li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2012-10-17&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Statement&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="string">&quot;autoscaling:DescribeAutoScalingGroups&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="string">&quot;autoscaling:DescribeAutoScalingInstances&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="string">&quot;autoscaling:DescribeLaunchConfigurations&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="string">&quot;autoscaling:DescribeScalingActivities&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="string">&quot;autoscaling:DescribeTags&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="string">&quot;ec2:DescribeInstanceTypes&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="string">&quot;ec2:DescribeLaunchTemplateVersions&quot;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;*&quot;</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="string">&quot;autoscaling:SetDesiredCapacity&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="string">&quot;autoscaling:TerminateInstanceInAutoScalingGroup&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="string">&quot;ec2:DescribeImages&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="string">&quot;ec2:GetInstanceTypesFromInstanceRequirements&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="string">&quot;eks:DescribeNodegroup&quot;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;*&quot;</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">export</span> AWS_PROFILE=eks-ty-old</span><br><span class="line">$ aws iam create-policy \</span><br><span class="line">    --policy-name AmazonEKSClusterAutoscalerPolicy \</span><br><span class="line">    --policy-document file://cluster-autoscaler-policy.json</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;Policy&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;PolicyName&quot;</span>: <span class="string">&quot;AmazonEKSClusterAutoscalerPolicy&quot;</span>,</span><br><span class="line">        <span class="string">&quot;PolicyId&quot;</span>: <span class="string">&quot;ANPA22DP3G4GBZ4RXQA2J&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Arn&quot;</span>: <span class="string">&quot;arn:aws:iam::743263909644:policy/AmazonEKSClusterAutoscalerPolicy&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Path&quot;</span>: <span class="string">&quot;/&quot;</span>,</span><br><span class="line">        <span class="string">&quot;DefaultVersionId&quot;</span>: <span class="string">&quot;v1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;AttachmentCount&quot;</span>: 0,</span><br><span class="line">        <span class="string">&quot;PermissionsBoundaryUsageCount&quot;</span>: 0,</span><br><span class="line">        <span class="string">&quot;IsAttachable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">&quot;CreateDate&quot;</span>: <span class="string">&quot;2023-07-18T09:31:24+00:00&quot;</span>,</span><br><span class="line">        <span class="string">&quot;UpdateDate&quot;</span>: <span class="string">&quot;2023-07-18T09:31:24+00:00&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>创建IAM Role的信任关系：<code>trust-policy.json</code></p></li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2012-10-17&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Statement&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Principal&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;Federated&quot;</span><span class="punctuation">:</span> <span class="string">&quot;arn:aws:iam::743263909644:oidc-provider/oidc.eks.us-west-2.amazonaws.com/id/1029FF88CB872B6B7A1CC65D44191A56&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sts:AssumeRoleWithWebIdentity&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Condition&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;StringEquals&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;oidc.eks.us-west-2.amazonaws.com/id/1029FF88CB872B6B7A1CC65D44191A56:aud&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sts.amazonaws.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;oidc.eks.us-west-2.amazonaws.com/id/1029FF88CB872B6B7A1CC65D44191A56:sub&quot;</span><span class="punctuation">:</span> <span class="string">&quot;system:serviceaccount:kube-system:cluster-autoscaler&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>创建 IAM Role</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$ aws iam create-role \</span><br><span class="line">  --role-name AmazonEKSClusterAutoscalerRole \</span><br><span class="line">  --assume-role-policy-document file://<span class="string">&quot;trust-policy.json&quot;</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;Role&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;Path&quot;</span>: <span class="string">&quot;/&quot;</span>,</span><br><span class="line">        <span class="string">&quot;RoleName&quot;</span>: <span class="string">&quot;AmazonEKSClusterAutoscalerRole&quot;</span>,</span><br><span class="line">        <span class="string">&quot;RoleId&quot;</span>: <span class="string">&quot;AROA22DP3G4GHSSPEOMUH&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Arn&quot;</span>: <span class="string">&quot;arn:aws:iam::743263909644:role/AmazonEKSClusterAutoscalerRole&quot;</span>,</span><br><span class="line">        <span class="string">&quot;CreateDate&quot;</span>: <span class="string">&quot;2023-07-18T09:39:54+00:00&quot;</span>,</span><br><span class="line">        <span class="string">&quot;AssumeRolePolicyDocument&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Version&quot;</span>: <span class="string">&quot;2012-10-17&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Statement&quot;</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">&quot;Effect&quot;</span>: <span class="string">&quot;Allow&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;Principal&quot;</span>: &#123;</span><br><span class="line">                        <span class="string">&quot;Federated&quot;</span>: <span class="string">&quot;arn:aws:iam::743263909644:oidc-provider/oidc.eks.us-west-2.amazonaws.com/id/1029FF88CB872B6B7A1CC65D44191A56&quot;</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="string">&quot;Action&quot;</span>: <span class="string">&quot;sts:AssumeRoleWithWebIdentity&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;Condition&quot;</span>: &#123;</span><br><span class="line">                        <span class="string">&quot;StringEquals&quot;</span>: &#123;</span><br><span class="line">                            <span class="string">&quot;oidc.eks.us-west-2.amazonaws.com/id/1029FF88CB872B6B7A1CC65D44191A56:aud&quot;</span>: <span class="string">&quot;sts.amazonaws.com&quot;</span>,</span><br><span class="line">                            <span class="string">&quot;oidc.eks.us-west-2.amazonaws.com/id/1029FF88CB872B6B7A1CC65D44191A56:sub&quot;</span>: <span class="string">&quot;system:serviceaccount:kube-system:cluster-autoscaler&quot;</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>为 Role 添加 Policy</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ aws iam attach-role-policy \</span><br><span class="line">  --policy-arn arn:aws:iam::743263909644:policy/AmazonEKSClusterAutoscalerPolicy \</span><br><span class="line">  --role-name AmazonEKSClusterAutoscalerRole</span><br></pre></td></tr></table></figure><h2 id="部署Cluster-Autoscaler">部署Cluster Autoscaler</h2><ul class="lvl-0"><li class="lvl-2"><p>下载Autoscaler yaml文件</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#下载yaml文件，github仓库中的文件下载路径格式为：https://raw.githubusercontent.com/&lt;Owner&gt;/&lt;RepositoryName&gt;/&lt;branch&gt;/&lt;FilePath&gt;</span></span><br><span class="line">$ wget https://raw.githubusercontent.com/kubernetes/autoscaler/master/cluster-autoscaler/cloudprovider/aws/examples/cluster-autoscaler-autodiscover.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取使用git命令，这里只clone出指定文件</span></span><br><span class="line">$ git <span class="built_in">clone</span> --depth 1 https://github.com/kubernetes/autoscaler --branch master --single-branch cluster-autoscaler/cloudprovider/aws/examples/cluster-autoscaler-autodiscover.yaml</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>修改yaml文件配置<br>打开<code>Cluster Autoscaler</code>的<a href="https://github.com/kubernetes/autoscaler/releases">github地址</a>，查看与EKS版本匹配的最新Autoscaler镜像版本<br><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/GBArR8.png" alt="" width="600" height="600"></p><ul class="lvl-2"><li class="lvl-6">1.把cluster-autoscaler的镜像版本换成上面查到的版本1.26.3</li><li class="lvl-6">2.查找并替换“<YOUR CLUSTER NAME>”为我们EKS的名称: <code>eks-lexing</code></li><li class="lvl-6">3.在EKS的名称“tsEKS”下面，并添加以下两行</li></ul>  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- --balance-similar-node-groups</span><br><span class="line">- --skip-nodes-with-system-pods=false</span><br></pre></td></tr></table></figure><blockquote><p><code>--balance-similar-node-groups</code>：此选项用于启用集群节点组的负载均衡功能。当你有多个具有相似容量的节点组时，启用此选项可以确保 Cluster Autoscaler 尽可能均衡地在这些节点组之间分配 Pod。它帮助确保节点组的资源利用率更加平衡，以提高集群的整体性能。<br><code>--skip-nodes-with-system-pods=false</code>：此选项用于设置是否跳过具有系统 Pod 的节点。默认情况下，Cluster Autoscaler 会跳过具有系统 Pod（如 kube-system 命名空间中的核心组件）的节点，以确保这些关键组件的正常运行。将该选项设置为 false，即禁用跳过具有系统 Pod 的节点，可以让 Cluster Autoscaler 考虑包括具有系统 Pod 的节点在内的所有节点进行调整。</p></blockquote><ul class="lvl-2"><li class="lvl-6">4.为ServiceAccount添加IMA Role注解，注意一定要添加这个注解后再进行部署，否则会提示没有权限<br><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/98SQ9l.png" alt="" width="1200" height="600"><br><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/88IL8W.png" alt="" width="1200" height="300"></li></ul></li><li class="lvl-2"><p>部署Cluster Autoscaler</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f cluster-autoscaler-autodiscover.yaml</span><br><span class="line">serviceaccount/cluster-autoscaler created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/cluster-autoscaler created</span><br><span class="line">role.rbac.authorization.k8s.io/cluster-autoscaler created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/cluster-autoscaler created</span><br><span class="line">rolebinding.rbac.authorization.k8s.io/cluster-autoscaler created</span><br><span class="line">deployment.apps/cluster-autoscaler created</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>查看Cluster Autoscaler Deployment</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cluster-autoscaler</span></span><br><span class="line">$ k get deploy</span><br><span class="line">NAME                           READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">aws-load-balancer-controller   2/2     2            2           14d</span><br><span class="line">cluster-autoscaler             1/1     1            1           9m10s</span><br><span class="line">coredns                        2/2     2            2           20d</span><br><span class="line">ebs-csi-controller             2/2     2            2           20d</span><br><span class="line">efs-csi-controller             2/2     2            2           15d</span><br><span class="line">metrics-server                 1/1     1            1           20d</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>给autoscaler deployment打patch，增加annotation</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 这个注解的作用是告诉 Kubernetes 系统不要将这些 Pod 标记为可以被安全驱逐（evict）的 Pod。</span></span><br><span class="line"><span class="comment"># 通过将 cluster-autoscaler 部署的 Pod 标记为不可安全驱逐，可以避免 Cluster Autoscaler 将这些关键组件的 Pod 视为可以被删除的对象。</span></span><br><span class="line">$ kubectl patch deployment cluster-autoscaler \</span><br><span class="line">  -n kube-system \</span><br><span class="line">  -p <span class="string">&#x27;&#123;&quot;spec&quot;:&#123;&quot;template&quot;:&#123;&quot;metadata&quot;:&#123;&quot;annotations&quot;:&#123;&quot;cluster-autoscaler.kubernetes.io/safe-to-evict&quot;: &quot;false&quot;&#125;&#125;&#125;&#125;&#125;&#x27;</span></span><br><span class="line">deployment.apps/cluster-autoscaler patched</span><br></pre></td></tr></table></figure><h2 id="测试">测试</h2><ul class="lvl-0"><li class="lvl-2"><p>查看当前node节点</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ k get node</span><br><span class="line">NAME                                           STATUS   ROLES    AGE   VERSION</span><br><span class="line">ip-192-168-16-155.us-west-2.compute.internal   Ready    &lt;none&gt;   18d   v1.26.4-eks-0a21954</span><br><span class="line">ip-192-168-48-14.us-west-2.compute.internal    Ready    &lt;none&gt;   18d   v1.26.4-eks-0a21954</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>创建测试用的deployment：<code>testDeploy.yaml</code></p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:1.20.2</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ k apply -f testDeploy.yaml</span><br><span class="line">deployment.apps/nginx-deployment created</span><br><span class="line"></span><br><span class="line"><span class="comment"># 扩容</span></span><br><span class="line"><span class="comment"># 因为我这里的节点实例类型为 m5.large，所以replicas要设置的大一些</span></span><br><span class="line">k scale deploy nginx-deployment --replicas 50 -n <span class="built_in">test</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>过一会查看node情况</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 可以看到新创建了一个node节点</span></span><br><span class="line">$ k get node</span><br><span class="line">NAME                                           STATUS   ROLES    AGE   VERSION</span><br><span class="line">ip-192-168-16-155.us-west-2.compute.internal   Ready    &lt;none&gt;   18d   v1.26.4-eks-0a21954</span><br><span class="line">ip-192-168-48-14.us-west-2.compute.internal    Ready    &lt;none&gt;   18d   v1.26.4-eks-0a21954</span><br><span class="line">ip-192-168-86-167.us-west-2.compute.internal   Ready    &lt;none&gt;   68s   v1.26.4-eks-0a21954</span><br><span class="line"></span><br><span class="line"><span class="comment"># pod也都正常运行</span></span><br><span class="line">$ k get pod -n <span class="built_in">test</span></span><br><span class="line">NAME                                     READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-deployment-7876b754ff-2nd5k        1/1     Running   0          111s</span><br><span class="line">nginx-deployment-7876b754ff-2ppvw        1/1     Running   0          111s</span><br><span class="line">nginx-deployment-7876b754ff-45csw        1/1     Running   0          110s</span><br><span class="line">nginx-deployment-7876b754ff-46tmf        1/1     Running   0          111s</span><br><span class="line">nginx-deployment-7876b754ff-5vt8p        1/1     Running   0          110s</span><br><span class="line">nginx-deployment-7876b754ff-66ztw        1/1     Running   0          111s</span><br><span class="line">nginx-deployment-7876b754ff-77f4d        1/1     Running   0          110s</span><br><span class="line">nginx-deployment-7876b754ff-8jj92        1/1     Running   0          111s</span><br><span class="line">nginx-deployment-7876b754ff-8kj97        1/1     Running   0          111s</span><br><span class="line">nginx-deployment-7876b754ff-9c8kr        1/1     Running   0          111s</span><br><span class="line">nginx-deployment-7876b754ff-9szmq        1/1     Running   0          111s</span><br><span class="line">nginx-deployment-7876b754ff-blbqd        1/1     Running   0          111s</span><br><span class="line">nginx-deployment-7876b754ff-bpppd        1/1     Running   0          111s</span><br><span class="line">nginx-deployment-7876b754ff-c46sb        1/1     Running   0          111s</span><br><span class="line">nginx-deployment-7876b754ff-d5b45        1/1     Running   0          111s</span><br><span class="line">………………………………</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>缩容deploy</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将副本降为1</span></span><br><span class="line">$ k scale deploy nginx-deployment --replicas 1 -n <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试完成可以删除</span></span><br><span class="line">$ k delete -f testDeploy.yaml</span><br><span class="line">deployment.apps <span class="string">&quot;nginx-deployment&quot;</span> deleted</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>大约过10几分钟就可以看到新增的node已经下线</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ k get node</span><br><span class="line">NAME                                           STATUS   ROLES    AGE   VERSION</span><br><span class="line">ip-192-168-16-155.us-west-2.compute.internal   Ready    &lt;none&gt;   18d   v1.26.4-eks-0a21954</span><br><span class="line">ip-192-168-48-14.us-west-2.compute.internal    Ready    &lt;none&gt;   18d   v1.26.4-eks-0a21954</span><br></pre></td></tr></table></figure><h2 id="升级Cluster-Autoscaler">升级Cluster Autoscaler</h2><ul class="lvl-0"><li class="lvl-2"><p><code>Cluster Autoscaler</code>的镜像版本要求与K8s版本匹配，所以当EKS(K8s)升级时，<code>Cluster Autoscaler</code>的镜像也要进行升级。</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="built_in">set</span> image deployment cluster-autoscaler \</span><br><span class="line">  -n kube-system \</span><br><span class="line">  cluster-autoscaler=registry.k8s.io/autoscaling/cluster-autoscaler:v&lt;x.x.x&gt;</span><br><span class="line"><span class="comment"># 或者直接编辑也是可以的</span></span><br><span class="line">$ k edit deploy -n kube-system cluster-autoscaler</span><br></pre></td></tr></table></figure><h2 id="关闭Cluster-Autoscaler">关闭Cluster Autoscaler</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ k scale deploy cluster-autoscaler -n kube-system --replicas 0</span><br><span class="line">deployment.apps/cluster-autoscaler scaled</span><br><span class="line"></span><br><span class="line">$ k get deploy</span><br><span class="line">NAME                           READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">aws-load-balancer-controller   2/2     2            2           14d</span><br><span class="line">cluster-autoscaler             0/0     0            0           20h</span><br><span class="line">coredns                        2/2     2            2           21d</span><br><span class="line">ebs-csi-controller             2/2     2            2           20d</span><br><span class="line">efs-csi-controller             2/2     2            2           15d</span><br><span class="line">metrics-server                 1/1     1            1           21d</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;!--
 **加粗**
 *斜体*
 ***加粗并斜体***
 ~~删除线~~
 ==突出显示==
 `突出显示(推荐)`
 ++下划线++
 ~下标~
 ^上标^
 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.
 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600)

 +++ **点击折叠**
 这是被隐藏的内容
 +++

::: tips success warning danger
这里是容器内的内容
:::

% note info % success warning danger
这里是容器内的内容
% endnote %

 --&gt;
&lt;h2 id=&quot;摘要&quot;&gt;摘要&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;本文介绍EKS集群Autoscaling 之 Cluster Autoscaler(CAS)&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;参考资料：&lt;/p&gt;
&lt;ul class=&quot;lvl-2&quot;&gt;
&lt;li class=&quot;lvl-6&quot;&gt;&lt;a href=&quot;https://docs.aws.amazon.com/zh_cn/eks/latest/userguide&quot;&gt;Amazon EKS用户指南&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-6&quot;&gt;&lt;a href=&quot;https://kubernetes.io/zh-cn/docs/home/&quot;&gt;Kubernetes 文档&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="技术" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="aws" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/aws/"/>
    
    <category term="eks" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/aws/eks/"/>
    
    
    <category term="java" scheme="https://blog.hanqunfeng.com/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>AWS-EKS-17--Horizontal Pod Autoscaler（HPA）</title>
    <link href="https://blog.hanqunfeng.com/2023/07/17/aws-eks17-hpa/"/>
    <id>https://blog.hanqunfeng.com/2023/07/17/aws-eks17-hpa/</id>
    <published>2023-07-17T12:30:05.000Z</published>
    <updated>2023-07-17T10:01:56.834Z</updated>
    
    <content type="html"><![CDATA[<!-- **加粗** *斜体* ***加粗并斜体*** ~~删除线~~ ==突出显示== `突出显示(推荐)` ++下划线++ ~下标~ ^上标^ 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference. 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600) +++ **点击折叠** 这是被隐藏的内容 +++::: tips success warning danger这里是容器内的内容:::% note info % success warning danger这里是容器内的内容% endnote % --><h2 id="摘要">摘要</h2><ul class="lvl-0"><li class="lvl-2"><p>本文介绍在EKS集群下创建HPA的方法</p></li><li class="lvl-2"><p>参考资料：</p><ul class="lvl-2"><li class="lvl-6"><a href="https://docs.aws.amazon.com/zh_cn/eks/latest/userguide">Amazon EKS用户指南</a></li><li class="lvl-6"><a href="https://kubernetes.io/zh-cn/docs/home/">Kubernetes 文档</a></li></ul></li></ul><span id="more"></span><h2 id="Horizontal-Pod-Autoscaler-简介">Horizontal Pod Autoscaler 简介</h2><ul class="lvl-0"><li class="lvl-2"><p>Horizontal Pod Autoscaler（HPA）基于资源 CPU 利用率自动调整 deployment、replication controller 或者 replica 中 pod 的数量，这有助于您的应用程序进行扩展以满足增长的需求，或在不需要资源时进行缩减，从而释放出节点用于其他应用程序。当您设置目标 CPU 利用率百分比时，HPA 扩展或缩减应用程序来尝试满足该目标。</p></li><li class="lvl-2"><p>Kubernetes 本身已经包含了 HPA 的 controller，所以不需要额外的安装或部署。</p></li><li class="lvl-2"><p>HPA 需要获取 metrics 信息，metrics 信息需要从 Metrics Server 中获取或者从第三方软件获取，关于如何在EKS中安装Metrics Server可以查看 <a href="/2023/07/07/aws-eks11-metrics/" title="AWS-EKS-11--安装 Kubernetes Metrics Server">AWS-EKS-11--安装 Kubernetes Metrics Server</a>。</p></li><li class="lvl-2"><p>HPA 会周期性(默认15秒)查询目标资源的使用情况，然后和 HPA 中定义的值做比较，并根据比较结果相应的调整 pod 数量。</p></li><li class="lvl-2"><p>创建pod时，必须为其设定cpu资源，用于与目标值进行比较，目前v2版本的HPA除了支持CPU的对比，还可以设定其它指标，具体参考<a href="https://kubernetes.io/zh-cn/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/">HorizontalPodAutoscaler 演练</a>。</p></li></ul><h2 id="示例">示例</h2><p>参考<a href="https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/horizontal-pod-autoscaler.html">官方示例</a></p><ul class="lvl-0"><li class="lvl-2"><p>定义资源yaml</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># php-apache.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">php-apache</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">php-apache</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">php-apache</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">php-apache</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">registry.k8s.io/hpa-example</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">500m</span>   <span class="comment"># 最多可使用资源，500m（0.5 个 CPU）</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">200m</span>   <span class="comment"># 期望使用资源（desiredMetricValue），200m（0.2 个 CPU）</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">php-apache</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">php-apache</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">php-apache</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>部署yaml</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ k apply -f php-apache.yaml</span><br><span class="line">deployment.apps/php-apache created</span><br><span class="line">service/php-apache created</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>创建HPA</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建了一个叫“php-apache”的 HPA，与 deployment 的名称相同，可以用 --name=&#x27;hpa-name&#x27; 指定hpa的名称</span></span><br><span class="line"><span class="comment"># replicas 变动范围是最小 1，最大 10</span></span><br><span class="line"><span class="comment"># 目标cpu利用率为 50%，上面我们设定 CPU request 值为 200m，所以当平均cpu值为 100m 时就会触发 autoscale</span></span><br><span class="line"><span class="comment"># 这里说平均cpu，是指所有pod的cpu利用率的平均值</span></span><br><span class="line">$ k autoscale deployment php-apache --cpu-percent=50 --min=1 --max=10</span><br><span class="line">horizontalpodautoscaler.autoscaling/php-apache autoscaled</span><br><span class="line"></span><br><span class="line"><span class="comment"># 也可以通过yaml创建</span></span><br><span class="line">apiVersion: autoscaling/v2</span><br><span class="line">kind: HorizontalPodAutoscaler</span><br><span class="line">metadata:</span><br><span class="line">  name: php-apache</span><br><span class="line">  namespace: <span class="built_in">test</span></span><br><span class="line">spec:</span><br><span class="line">  maxReplicas: 10</span><br><span class="line">  minReplicas: 1</span><br><span class="line">  metrics:</span><br><span class="line">  - resource:</span><br><span class="line">      name: cpu</span><br><span class="line">      target:</span><br><span class="line">        averageUtilization: 50</span><br><span class="line">        <span class="built_in">type</span>: Utilization</span><br><span class="line">    <span class="built_in">type</span>: Resource</span><br><span class="line">  scaleTargetRef:</span><br><span class="line">    apiVersion: apps/v1</span><br><span class="line">    kind: Deployment</span><br><span class="line">    name: php-apache</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>查看HPA</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ k get hpa</span><br><span class="line">NAME         REFERENCE               TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">php-apache   Deployment/php-apache   0%/50%    1         10        1          29s</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>测试HPA</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 通过运行容器为 Web 服务器创建负载</span></span><br><span class="line"><span class="comment"># 这里利用 busybox 镜像临时生成一个 pod，用 while 循环不停的访问 php-apache 的 service，而 php-apache 中的 hpa-example 镜像已经配置了进行消耗 CPU 的计算网页，所以 php-apache pod 的 CPU 负载会很快增长</span></span><br><span class="line"><span class="comment"># 该命令会一直运行，直到 Ctrl+C</span></span><br><span class="line">$ kubectl run -i \</span><br><span class="line">    --<span class="built_in">tty</span> load-generator \</span><br><span class="line">    --<span class="built_in">rm</span> --image=busybox \</span><br><span class="line">    --restart=Never \</span><br><span class="line">    -- /bin/sh -c <span class="string">&quot;while sleep 0.01; do wget -q -O- http://php-apache; done&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 上面的命令运行一会后再开一个终端查看hpa的情况，可以看到已经发生扩容了</span></span><br><span class="line">$ k get hpa</span><br><span class="line">NAME         REFERENCE               TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">php-apache   Deployment/php-apache   57%/50%   1         10        7          5m27s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行一段时间后发现hpa稳定在8个，说明此时pod的数量已经满足平均cpu使用率小于50%的目标</span></span><br><span class="line">$ k get hpa</span><br><span class="line">NAME         REFERENCE               TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">php-apache   Deployment/php-apache   43%/50%   1         10        8          20m</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看pod的cpu使用情况，虽然此时也有个别的pod大于100m，但是8个pod的平均cpu是小于100m的，此时就不会再进行扩容了</span></span><br><span class="line">$ k top pod</span><br><span class="line">NAME                                     CPU(cores)   MEMORY(bytes)</span><br><span class="line">php-apache-7495ff8f5b-2kjsc              98m          11Mi</span><br><span class="line">php-apache-7495ff8f5b-49vb9              85m          11Mi</span><br><span class="line">php-apache-7495ff8f5b-65r62              100m         11Mi</span><br><span class="line">php-apache-7495ff8f5b-7mn9l              79m          11Mi</span><br><span class="line">php-apache-7495ff8f5b-7njtt              74m          11Mi</span><br><span class="line">php-apache-7495ff8f5b-8n5t6              88m          11Mi</span><br><span class="line">php-apache-7495ff8f5b-spvnh              103m         11Mi</span><br><span class="line">php-apache-7495ff8f5b-w64f4              101m         11Mi</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>此时<code>Ctrl+C</code>中断测试容器，过一会查看hpa和pod的情况，可以看到平均 CPU 负载已经降到 0 了，但 REPLICAS 还是 8 个，不会立即降低，不要着急，大约5分钟左右 REPLICAS 最终变为 1</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ k get hpa</span><br><span class="line">NAME         REFERENCE               TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">php-apache   Deployment/php-apache   0%/50%    1         10        8          26m</span><br><span class="line">$ k top pod</span><br><span class="line">NAME                                     CPU(cores)   MEMORY(bytes)</span><br><span class="line">php-apache-7495ff8f5b-2kjsc              1m           11Mi</span><br><span class="line">php-apache-7495ff8f5b-49vb9              1m           11Mi</span><br><span class="line">php-apache-7495ff8f5b-65r62              1m           11Mi</span><br><span class="line">php-apache-7495ff8f5b-7mn9l              1m           11Mi</span><br><span class="line">php-apache-7495ff8f5b-7njtt              1m           11Mi</span><br><span class="line">php-apache-7495ff8f5b-8n5t6              1m           11Mi</span><br><span class="line">php-apache-7495ff8f5b-spvnh              1m           11Mi</span><br><span class="line">php-apache-7495ff8f5b-w64f4              1m           11Mi</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可以看到hpa的 AGE 在26m时还是8个，30m时就降为1个了</span></span><br><span class="line">$ k get hpa</span><br><span class="line">NAME         REFERENCE               TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">php-apache   Deployment/php-apache   0%/50%    1         10        1          30m</span><br></pre></td></tr></table></figure><h2 id="删除HPA">删除HPA</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ k delete hpa php-apache</span><br><span class="line">horizontalpodautoscaler.autoscaling <span class="string">&quot;php-apache&quot;</span> deleted</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;!--
 **加粗**
 *斜体*
 ***加粗并斜体***
 ~~删除线~~
 ==突出显示==
 `突出显示(推荐)`
 ++下划线++
 ~下标~
 ^上标^
 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.
 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600)

 +++ **点击折叠**
 这是被隐藏的内容
 +++

::: tips success warning danger
这里是容器内的内容
:::

% note info % success warning danger
这里是容器内的内容
% endnote %

 --&gt;
&lt;h2 id=&quot;摘要&quot;&gt;摘要&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;本文介绍在EKS集群下创建HPA的方法&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;参考资料：&lt;/p&gt;
&lt;ul class=&quot;lvl-2&quot;&gt;
&lt;li class=&quot;lvl-6&quot;&gt;&lt;a href=&quot;https://docs.aws.amazon.com/zh_cn/eks/latest/userguide&quot;&gt;Amazon EKS用户指南&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-6&quot;&gt;&lt;a href=&quot;https://kubernetes.io/zh-cn/docs/home/&quot;&gt;Kubernetes 文档&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="技术" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="aws" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/aws/"/>
    
    <category term="eks" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/aws/eks/"/>
    
    
    <category term="java" scheme="https://blog.hanqunfeng.com/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>AWS-EKS-16--聊一聊ServiceAccount</title>
    <link href="https://blog.hanqunfeng.com/2023/07/14/aws-eks16-servcieaccount/"/>
    <id>https://blog.hanqunfeng.com/2023/07/14/aws-eks16-servcieaccount/</id>
    <published>2023-07-14T12:30:05.000Z</published>
    <updated>2023-07-18T10:05:41.353Z</updated>
    
    <content type="html"><![CDATA[<!-- **加粗** *斜体* ***加粗并斜体*** ~~删除线~~ ==突出显示== `突出显示(推荐)` ++下划线++ ~下标~ ^上标^ 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference. 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600) +++ **点击折叠** 这是被隐藏的内容 +++::: tips success warning danger这里是容器内的内容:::% note info % success warning danger这里是容器内的内容% endnote % --><h2 id="摘要">摘要</h2><ul class="lvl-0"><li class="lvl-2"><p>本文聊一聊ServiceAccount</p></li><li class="lvl-2"><p>参考资料：</p><ul class="lvl-2"><li class="lvl-6"><a href="https://docs.aws.amazon.com/zh_cn/eks/latest/userguide">Amazon EKS用户指南</a></li><li class="lvl-6"><a href="https://kubernetes.io/zh-cn/docs/home/">Kubernetes 文档</a></li></ul></li></ul><span id="more"></span><h2 id="聊一聊ServiceAccount">聊一聊ServiceAccount</h2><ul class="lvl-0"><li class="lvl-2"><p>网上关于ServiceAccount的介绍有很多，但大多都比较晦涩难懂，不好理解，这里我基于自己的理解聊一聊ServiceAccount。</p></li><li class="lvl-2"><p>ServiceAccount是k8s中的用户，其被定义在namespace下，可以被关联到pod上，使其获得相应的权限。</p><ul class="lvl-2"><li class="lvl-6">ServiceAccount可以与k8s中的Role或者ClusterRole进行绑定，以使其具有访问k8s内部资源的权限，当pod关联ServiceAccount后也就获得了相应的权限。参考<a href="/2023/07/07/aws-eks12-dashboard/" title="AWS-EKS-12--部署 Dashboard UI">AWS-EKS-12--部署 Dashboard UI</a></li></ul>  <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># dashboard-adminuser.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">admin-user</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">admin-user</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-admin</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">admin-user</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br></pre></td></tr></table></figure><ul class="lvl-2"><li class="lvl-6">ServiceAccount也可以被关联到IAM Role，以使其具有访问AWS资源的权限。当pod关联ServiceAccount后就获得了访问AWS资源的权限。参考<a href="/2023/07/13/aws-eks15-auth-pod/" title="AWS-EKS-15--EKS权限管理(下)Pod 是如何调用 AWS 资源的">AWS-EKS-15--EKS权限管理(下)Pod 是如何调用 AWS 资源的</a></li></ul>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ eksctl create iamserviceaccount \</span><br><span class="line">--cluster=eks-lexing \</span><br><span class="line">--profile eks-us-west-2 \</span><br><span class="line">--namespace=kube-system \</span><br><span class="line">--name=aws-load-balancer-controller \</span><br><span class="line">--role-name AmazonEKSLoadBalancerControllerRole \</span><br><span class="line">--attach-policy-arn=arn:aws:iam::743263909644:policy/AWSLoadBalancerControllerIAMPolicy \</span><br><span class="line">--approve</span><br></pre></td></tr></table></figure></li><li class="lvl-2"><p>ServiceAccount default 在 Kubernetes 中是默认存在的，它通常与运行在 Pod 内的应用程序关联，用于与 Kubernetes API 服务器进行身份验证和授权。default ServiceAccount 是每个命名空间中的默认 ServiceAccount，如果没有为 Pod 显式指定 ServiceAccount，则会自动关联到 default ServiceAccount。</p></li><li class="lvl-2"><p>default ServiceAccount的权限是由所分配的角色（Role）或集群角色（ClusterRole）定义的。在默认情况下，default ServiceAccount没有任何特权或访问权限。它只能访问其所在命名空间的一些基本资源，例如查看自身的 Pod、Service、Endpoints 等。</p></li></ul><h3 id="创建SA">创建SA</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 方式1，使用kubectl命令行直接创建</span></span><br><span class="line">$ kubectl create serviceaccount &lt;serviceaccount-name&gt; -n &lt;namespace&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方式2，基于yaml</span></span><br><span class="line"><span class="comment"># sa.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: &lt;serviceaccount-name&gt;</span><br><span class="line">  namespace: &lt;namespace&gt;</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f sa.yaml</span><br></pre></td></tr></table></figure><h3 id="查询SA">查询SA</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ k get sa -n kubernetes-dashboard</span><br><span class="line">NAME                   SECRETS   AGE</span><br><span class="line">admin-user             0         8d</span><br><span class="line">default                0         8d</span><br><span class="line">kubernetes-dashboard   0         8d</span><br></pre></td></tr></table></figure><h3 id="SA与Role或者ClusterRole进行绑定">SA与Role或者ClusterRole进行绑定</h3><ul class="lvl-0"><li class="lvl-2"><p>SA绑定Role</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-service-account</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-role</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test</span>                                <span class="comment"># 与ClusterRole的区别就是Role要绑定到Namespace</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]                                <span class="comment"># 限定API组，为空则为默认的 core API 组</span></span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>, <span class="string">&quot;services&quot;</span>, <span class="string">&quot;configmaps&quot;</span>]  <span class="comment"># 要访问的资源</span></span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]                <span class="comment"># 开放的权限</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-role-binding</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-service-account</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-role</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>SA绑定ClusterRole</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-service-account</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-cluster-role</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>, <span class="string">&quot;services&quot;</span>, <span class="string">&quot;configmaps&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-cluster-role-binding</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-service-account</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-cluster-role</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure><div class="tips"><p><em><strong>API组</strong></em><br>Kubernetes中有许多常见的API组，每个API组都包含一组相关的资源。以下是一些常见的API组：</p><ul class="lvl-1"><li class="lvl-2"><code>core</code>：该API组是Kubernetes中的默认API组，包含核心资源，如pods、services、configmaps、secrets等。</li><li class="lvl-2"><code>apps</code>：该API组包含应用程序相关的资源，如deployments、replicasets、daemonsets、statefulsets等。</li><li class="lvl-2"><code>batch</code>：该API组包含批处理作业相关的资源，如jobs、cronjobs等。</li><li class="lvl-2"><code>extensions</code>：这是Kubernetes早期版本中广泛使用的API组，现在已经被<code>apps</code>和<code>networking.k8s.io</code> API组所取代。它包含一些资源，如replicationcontrollers、ingresses等。</li><li class="lvl-2"><code>networking.k8s.io</code>：该API组包含与网络相关的资源，如ingresses、networkpolicies等。</li><li class="lvl-2"><code>storage.k8s.io</code>：该API组包含存储相关的资源，如storageclasses、persistentvolumes、persistentvolumeclaims等。</li><li class="lvl-2"><code>autoscaling</code>：该API组包含自动扩展相关的资源，如horizontalpodautoscalers。</li><li class="lvl-2"><code>rbac.authorization.k8s.io</code>：该API组包含与角色和访问控制相关的资源，如roles、rolebindings、clusterroles、clusterrolebindings等。<br>这只是一小部分常见的API组，实际上还有许多其他的API组，根据您的Kubernetes集群的版本和所使用的插件，可能会有其他自定义的API组。您可以使用<code>kubectl api-resources</code>命令查看集群中所有可用的API组和资源。</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 这里 APIVERSION 中版本中斜线前面的就是 API组名称 ,没有斜线的就是默认的 core 组</span></span><br><span class="line">$ kubectl api-resources</span><br><span class="line">NAME                              SHORTNAMES   APIVERSION                             NAMESPACED   KIND</span><br><span class="line">bindings                                       v1                                     <span class="literal">true</span>         Binding</span><br><span class="line">componentstatuses                 cs           v1                                     <span class="literal">false</span>        ComponentStatus</span><br><span class="line">configmaps                        cm           v1                                     <span class="literal">true</span>         ConfigMap</span><br><span class="line">endpoints                         ep           v1                                     <span class="literal">true</span>         Endpoints</span><br><span class="line">events                            ev           v1                                     <span class="literal">true</span>         Event</span><br><span class="line">limitranges                       limits       v1                                     <span class="literal">true</span>         LimitRange</span><br><span class="line">namespaces                        ns           v1                                     <span class="literal">false</span>        Namespace</span><br><span class="line">nodes                             no           v1                                     <span class="literal">false</span>        Node</span><br><span class="line">persistentvolumeclaims            pvc          v1                                     <span class="literal">true</span>         PersistentVolumeClaim</span><br><span class="line">persistentvolumes                 pv           v1                                     <span class="literal">false</span>        PersistentVolume</span><br><span class="line">pods                              po           v1                                     <span class="literal">true</span>         Pod</span><br><span class="line">podtemplates                                   v1                                     <span class="literal">true</span>         PodTemplate</span><br><span class="line">replicationcontrollers            rc           v1                                     <span class="literal">true</span>         ReplicationController</span><br><span class="line">resourcequotas                    quota        v1                                     <span class="literal">true</span>         ResourceQuota</span><br><span class="line">secrets                                        v1                                     <span class="literal">true</span>         Secret</span><br><span class="line">serviceaccounts                   sa           v1                                     <span class="literal">true</span>         ServiceAccount</span><br><span class="line">services                          svc          v1                                     <span class="literal">true</span>         Service</span><br><span class="line">mutatingwebhookconfigurations                  admissionregistration.k8s.io/v1        <span class="literal">false</span>        MutatingWebhookConfiguration</span><br><span class="line">validatingwebhookconfigurations                admissionregistration.k8s.io/v1        <span class="literal">false</span>        ValidatingWebhookConfiguration</span><br><span class="line">customresourcedefinitions         crd,crds     apiextensions.k8s.io/v1                <span class="literal">false</span>        CustomResourceDefinition</span><br><span class="line">apiservices                                    apiregistration.k8s.io/v1              <span class="literal">false</span>        APIService</span><br><span class="line">controllerrevisions                            apps/v1                                <span class="literal">true</span>         ControllerRevision</span><br><span class="line">daemonsets                        ds           apps/v1                                <span class="literal">true</span>         DaemonSet</span><br><span class="line">deployments                       deploy       apps/v1                                <span class="literal">true</span>         Deployment</span><br><span class="line">replicasets                       rs           apps/v1                                <span class="literal">true</span>         ReplicaSet</span><br><span class="line">statefulsets                      sts          apps/v1                                <span class="literal">true</span>         StatefulSet</span><br><span class="line">tokenreviews                                   authentication.k8s.io/v1               <span class="literal">false</span>        TokenReview</span><br><span class="line">localsubjectaccessreviews                      authorization.k8s.io/v1                <span class="literal">true</span>         LocalSubjectAccessReview</span><br><span class="line">selfsubjectaccessreviews                       authorization.k8s.io/v1                <span class="literal">false</span>        SelfSubjectAccessReview</span><br><span class="line">selfsubjectrulesreviews                        authorization.k8s.io/v1                <span class="literal">false</span>        SelfSubjectRulesReview</span><br><span class="line">subjectaccessreviews                           authorization.k8s.io/v1                <span class="literal">false</span>        SubjectAccessReview</span><br><span class="line">horizontalpodautoscalers          hpa          autoscaling/v2                         <span class="literal">true</span>         HorizontalPodAutoscaler</span><br><span class="line">cronjobs                          cj           batch/v1                               <span class="literal">true</span>         CronJob</span><br><span class="line"><span class="built_in">jobs</span>                                           batch/v1                               <span class="literal">true</span>         Job</span><br><span class="line">certificatesigningrequests        csr          certificates.k8s.io/v1                 <span class="literal">false</span>        CertificateSigningRequest</span><br><span class="line">leases                                         coordination.k8s.io/v1                 <span class="literal">true</span>         Lease</span><br><span class="line">eniconfigs                                     crd.k8s.amazonaws.com/v1alpha1         <span class="literal">false</span>        ENIConfig</span><br><span class="line">endpointslices                                 discovery.k8s.io/v1                    <span class="literal">true</span>         EndpointSlice</span><br><span class="line">ingressclassparams                             elbv2.k8s.aws/v1beta1                  <span class="literal">false</span>        IngressClassParams</span><br><span class="line">targetgroupbindings                            elbv2.k8s.aws/v1beta1                  <span class="literal">true</span>         TargetGroupBinding</span><br><span class="line">events                            ev           events.k8s.io/v1                       <span class="literal">true</span>         Event</span><br><span class="line">flowschemas                                    flowcontrol.apiserver.k8s.io/v1beta3   <span class="literal">false</span>        FlowSchema</span><br><span class="line">prioritylevelconfigurations                    flowcontrol.apiserver.k8s.io/v1beta3   <span class="literal">false</span>        PriorityLevelConfiguration</span><br><span class="line">nodes                                          metrics.k8s.io/v1beta1                 <span class="literal">false</span>        NodeMetrics</span><br><span class="line">pods                                           metrics.k8s.io/v1beta1                 <span class="literal">true</span>         PodMetrics</span><br><span class="line">ingressclasses                                 networking.k8s.io/v1                   <span class="literal">false</span>        IngressClass</span><br><span class="line">ingresses                         ing          networking.k8s.io/v1                   <span class="literal">true</span>         Ingress</span><br><span class="line">networkpolicies                   netpol       networking.k8s.io/v1                   <span class="literal">true</span>         NetworkPolicy</span><br><span class="line">runtimeclasses                                 node.k8s.io/v1                         <span class="literal">false</span>        RuntimeClass</span><br><span class="line">poddisruptionbudgets              pdb          policy/v1                              <span class="literal">true</span>         PodDisruptionBudget</span><br><span class="line">clusterrolebindings                            rbac.authorization.k8s.io/v1           <span class="literal">false</span>        ClusterRoleBinding</span><br><span class="line">clusterroles                                   rbac.authorization.k8s.io/v1           <span class="literal">false</span>        ClusterRole</span><br><span class="line">rolebindings                                   rbac.authorization.k8s.io/v1           <span class="literal">true</span>         RoleBinding</span><br><span class="line">roles                                          rbac.authorization.k8s.io/v1           <span class="literal">true</span>         Role</span><br><span class="line">priorityclasses                   pc           scheduling.k8s.io/v1                   <span class="literal">false</span>        PriorityClass</span><br><span class="line">csidrivers                                     storage.k8s.io/v1                      <span class="literal">false</span>        CSIDriver</span><br><span class="line">csinodes                                       storage.k8s.io/v1                      <span class="literal">false</span>        CSINode</span><br><span class="line">csistoragecapacities                           storage.k8s.io/v1                      <span class="literal">true</span>         CSIStorageCapacity</span><br><span class="line">storageclasses                    sc           storage.k8s.io/v1                      <span class="literal">false</span>        StorageClass</span><br><span class="line">volumeattachments                              storage.k8s.io/v1                      <span class="literal">false</span>        VolumeAttachment</span><br><span class="line">securitygrouppolicies             sgp          vpcresources.k8s.aws/v1beta1           <span class="literal">true</span>         SecurityGroupPolicy</span><br></pre></td></tr></table></figure></div><h3 id="SA与Deployment或者Pod关联">SA与Deployment或者Pod关联</h3><ul class="lvl-0"><li class="lvl-2"><p>SA与Deployment关联</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">my-app</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">my-app</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">my-service-account</span>  <span class="comment"># 指定sa名称</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">my-container</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">my-image</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>SA与Pod关联</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceAccountName:</span> <span class="string">my-service-account</span>     <span class="comment"># 指定sa名称</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">my-container</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">my-image</span></span><br></pre></td></tr></table></figure><div class="tips"><p><em><strong>小贴士</strong></em></p><ul class="lvl-1"><li class="lvl-2">serviceAccount 和 serviceAccountName 是 Kubernetes YAML 配置中用于关联 Service Account 的两个属性，它们有一些区别：</li><li class="lvl-2">serviceAccountName：这是一个字符串属性，用于指定要与 Pod 或 Deployment 关联的 Service Account 的名称。它是最常用的属性，只需提供 Service Account 的名称即可。示例：serviceAccountName: my-service-account</li><li class="lvl-2">serviceAccount：这是一个对象属性，用于指定要与 Pod 或 Deployment 关联的 Service Account 的更详细信息。它可以提供 Service Account 的名称和命名空间。示例：</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">serviceAccount:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-service-account</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">my-namespace</span></span><br></pre></td></tr></table></figure><p>注意：namespace 字段是可选的，如果不指定，它将使用当前 Pod 或 Deployment 所在的命名空间。</p><ul class="lvl-1"><li class="lvl-2">总结来说，serviceAccountName 是一种更简洁的方式，只需提供 Service Account 的名称。而 serviceAccount 则可以提供更多关于 Service Account 的详细信息，如名称和命名空间。在大多数情况下，使用 serviceAccountName 就足够了，除非需要更精细地控制 Service Account 的属性。</li></ul></div><h3 id="查询指定的SA被绑定到哪些角色">查询指定的SA被绑定到哪些角色</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get rolebindings,clusterrolebindings -A \</span><br><span class="line">-o <span class="string">&#x27;custom-columns=KIND:.kind,NAMESPACE:.metadata.namespace,NAME:.metadata.name,ROLE-KIND:.roleRef.kind,ROLE:.roleRef.name, SUBJECT-KIND:.subjects[*].kind,SUBJECT-NAMESPACE:.subjects[*].namespace,SUBJECT-NAME:.subjects[*].name&#x27;</span> \</span><br><span class="line">| (<span class="built_in">head</span> -n 1 &amp;&amp; awk <span class="string">&#x27;&#123;if ($8 == &quot;kubernetes-dashboard&quot;) print&#125;&#x27;</span>)</span><br><span class="line">KIND                 NAMESPACE              NAME                                                           ROLE-KIND     ROLE                                                    SUBJECT-KIND         SUBJECT-NAMESPACE      SUBJECT-NAME</span><br><span class="line">RoleBinding          kubernetes-dashboard   kubernetes-dashboard                                           Role          kubernetes-dashboard                                   ServiceAccount        kubernetes-dashboard   kubernetes-dashboard</span><br><span class="line">ClusterRoleBinding   &lt;none&gt;                 kubernetes-dashboard                                           ClusterRole   kubernetes-dashboard                                   ServiceAccount        kubernetes-dashboard   kubernetes-dashboard</span><br></pre></td></tr></table></figure><h3 id="查询指定的SA被关联到哪些deploy">查询指定的SA被关联到哪些deploy</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ k get deploy -A \</span><br><span class="line">-o <span class="string">&#x27;custom-columns=NAMESPACE:.metadata.namespace,NAME:.metadata.name,SERVICEACCOUNT:.spec.template.spec.serviceAccountName&#x27;</span> \</span><br><span class="line">| (<span class="built_in">head</span> -n 1 &amp;&amp; awk <span class="string">&#x27;&#123;if ($3 == &quot;kubernetes-dashboard&quot;) print&#125;&#x27;</span>)</span><br><span class="line">NAMESPACE              NAME                           SERVICEACCOUNT</span><br><span class="line">kubernetes-dashboard   dashboard-metrics-scraper      kubernetes-dashboard</span><br><span class="line">kubernetes-dashboard   kubernetes-dashboard           kubernetes-dashboard</span><br></pre></td></tr></table></figure><h3 id="查询指定的SA被关联到哪些pod">查询指定的SA被关联到哪些pod</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ k get pod -A \</span><br><span class="line">-o <span class="string">&#x27;custom-columns=NAMESPACE:.metadata.namespace,NAME:.metadata.name,SERVICEACCOUNT:.spec.serviceAccountName&#x27;</span> \</span><br><span class="line">| (<span class="built_in">head</span> -n 1 &amp;&amp; awk <span class="string">&#x27;&#123;if ($3 == &quot;kubernetes-dashboard&quot;) print&#125;&#x27;</span>)</span><br><span class="line">NAMESPACE              NAME                                            SERVICEACCOUNT</span><br><span class="line">kubernetes-dashboard   dashboard-metrics-scraper-7bc864c59-sqjq8       kubernetes-dashboard</span><br><span class="line">kubernetes-dashboard   kubernetes-dashboard-6c7ccbcf87-zb2hb           kubernetes-dashboard</span><br></pre></td></tr></table></figure><h3 id="编辑SA">编辑SA</h3><ul class="lvl-0"><li class="lvl-2"><p>比如我们要为已经创建好的SA关联AWS IAM角色，需要编辑SA，将IAM角色添加到SA的注释中。</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">k</span> <span class="string">edit</span> <span class="string">sa</span> <span class="string">-n</span> <span class="string">kube-system</span> <span class="string">aws-load-balancer-controller</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">eks.amazonaws.com/role-arn:</span> <span class="string">arn:aws:iam::743263909644:role/AmazonEKSLoadBalancerControllerRole</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="string">&quot;2023-07-04T09:20:41Z&quot;</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/managed-by:</span> <span class="string">eksctl</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">aws-load-balancer-controller</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;1707669&quot;</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">857200a6-2e16-4939-bbbc-483dd579acbb</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>也可以直接通过命令行添加注解</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl annotate serviceaccount aws-load-balancer-controller \</span><br><span class="line">  -n kube-system \</span><br><span class="line">  eks.amazonaws.com/role-arn=arn:aws:iam::743263909644:role/AmazonEKSLoadBalancerControll</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>ServiceAccount被修改过后，关联的pod需要重新启动才能生效。</p></li></ul>]]></content>
    
    
    <summary type="html">&lt;!--
 **加粗**
 *斜体*
 ***加粗并斜体***
 ~~删除线~~
 ==突出显示==
 `突出显示(推荐)`
 ++下划线++
 ~下标~
 ^上标^
 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.
 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600)

 +++ **点击折叠**
 这是被隐藏的内容
 +++

::: tips success warning danger
这里是容器内的内容
:::

% note info % success warning danger
这里是容器内的内容
% endnote %

 --&gt;
&lt;h2 id=&quot;摘要&quot;&gt;摘要&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;本文聊一聊ServiceAccount&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;参考资料：&lt;/p&gt;
&lt;ul class=&quot;lvl-2&quot;&gt;
&lt;li class=&quot;lvl-6&quot;&gt;&lt;a href=&quot;https://docs.aws.amazon.com/zh_cn/eks/latest/userguide&quot;&gt;Amazon EKS用户指南&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-6&quot;&gt;&lt;a href=&quot;https://kubernetes.io/zh-cn/docs/home/&quot;&gt;Kubernetes 文档&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="技术" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="aws" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/aws/"/>
    
    <category term="eks" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/aws/eks/"/>
    
    
    <category term="java" scheme="https://blog.hanqunfeng.com/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>AWS-EKS-15--EKS权限管理(下)Pod 是如何调用 AWS 资源的</title>
    <link href="https://blog.hanqunfeng.com/2023/07/13/aws-eks15-auth-pod/"/>
    <id>https://blog.hanqunfeng.com/2023/07/13/aws-eks15-auth-pod/</id>
    <published>2023-07-13T12:30:05.000Z</published>
    <updated>2023-07-17T03:36:18.718Z</updated>
    
    <content type="html"><![CDATA[<!-- **加粗** *斜体* ***加粗并斜体*** ~~删除线~~ ==突出显示== `突出显示(推荐)` ++下划线++ ~下标~ ^上标^ 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference. 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600) +++ **点击折叠** 这是被隐藏的内容 +++::: tips success warning danger这里是容器内的内容:::% note info % success warning danger这里是容器内的内容% endnote % --><h2 id="摘要">摘要</h2><ul class="lvl-0"><li class="lvl-2"><p>本文介绍为EKS集群的 Pod 调用 AWS 资源的方法</p></li><li class="lvl-2"><p>参考资料：</p><ul class="lvl-2"><li class="lvl-6"><a href="https://docs.aws.amazon.com/zh_cn/eks/latest/userguide">Amazon EKS用户指南</a></li><li class="lvl-6"><a href="https://kubernetes.io/zh-cn/docs/home/">Kubernetes 文档</a></li></ul></li></ul><span id="more"></span><h2 id="原理解析">原理解析</h2><ul class="lvl-0"><li class="lvl-2"><p>在Pod中访问AWS资源，如获取S3中的文件，将ingress绑定到ELB，等等，这些操作都需要被授予相应的权限才可以正常访问。</p></li><li class="lvl-2"><p>在AWS IAM中的Role可以被授权给基于OIDC身份提供商的外部用户，而在EKS集群中的pod对于AWS IAM来说就属于外部用户，AWS会通过IAM OIDC对这些外部用户的有效性进行校验。</p></li><li class="lvl-2"><p>前文已经介绍过<a href="/2023/07/07/aws-eks03-oidc/" title="AWS-EKS-03--创建 IAM OIDC 身份提供商">如何为EKS创建 IAM OIDC 身份提供商</a>，在EKS(K8s)中，并不是直接对Pod进行权限校验，而是ServcieAccount，在 K8s 中，ServiceAccount 是一种用于身份验证和授权的机制，它为 Pod 提供了一个身份标识。每个 Pod 都与一个 ServiceAccount 相关联，并且可以使用该 ServiceAccount 获取与其关联的身份凭据。</p></li><li class="lvl-2"><p>在EKS（K8s）中可以将ServcieAccount与AWS IAM Role进行绑定，同时将ServcieAccount与Pod进行关联，这样Pod也就具备了相应的IAM Role。</p></li><li class="lvl-2"><p>EKS（K8s）的 ServcieAccount 通过 Idp（EKS OpenID Connect provider）获得 ID_token并将其发送给 IAM Identity providers ，IAM Identity providers负责获取OIDC的key并验证ID_token的有效性。</p></li><li class="lvl-2"><p>当ServcieAccount通过IAM OIDC身份校验后，关联的Pod就可以使用相对应的Role获得访问AWS资源的权限。</p></li><li class="lvl-2"><p>创建Pod时，如果没有为其指定关联的ServcieAccount，则默认使用Pod所在Namespace下的名称为<code>default</code>的ServcieAccount，创建Namespace时会自动为其创建该缺省的ServcieAccount，默认其没有绑定任何IAM Role，则缺省继承NodeGroup的IAM Role，NodeGroup的IAM Role是在创建EKS集群时自动创建的，其具有对ECR存储库的只读访问、允许Amazon EKS工作节点连接到Amazon EKS群集等权限。<br><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/fXD4pY.png" alt="" width="1200" height="800"></p></li><li class="lvl-2"><p>Amazon EKS Pod Identity Webhook 会查看与 service account 关联的 Pods，并向 Pod 提供下列环境变量</p><ul class="lvl-2"><li class="lvl-6">AWS_ROLE_ARN=arn:aws:iam::&lt;ACCOUNT_ID&gt;:role/&lt;IAM_ROLE_NAME&gt;</li><li class="lvl-6">AWS_WEB_IDENTITY_TOKEN_FILE=/var/run/secrets/eks.amazonaws.com/serviceaccount/token</li></ul></li><li class="lvl-2"><p><code>AWS_ROLE_ARN</code>就是绑定到ServiceAccount上的IAM Role，<code>AWS_WEB_IDENTITY_TOKEN_FILE</code>就是要发送给IAM Identity providers的ID_token。</p></li><li class="lvl-2"><p>默认只有以 root 用户运行的容器才有权限访问 web identity token 文件，当以其它用户运行容器时，需要用 fsGroup 指定一个 groupID。在 Amazon EKS 中，可以将 fsGroup 设置为 65534。这是 Kubernetes 中的推荐做法，因为这个值对应于 nobody 用户和 nogroup 组的 ID。使用 fsGroup: 65534 将确保容器中的非 root 用户具有适当的权限来访问 Web Identity Token 文件。</p></li></ul><h2 id="案例分析">案例分析</h2><ul class="lvl-0"><li class="lvl-2"><p>前面在<a href="/2023/07/07/aws-eks07-loadbalancer/" title="AWS-EKS-07--安装 AWS Load Balancer Controller 附加组件">安装 AWS Load Balancer Controller 附加组件</a>时，通过如下方式进行授权</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ curl -O https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/v2.4.7/docs/install/iam_policy.json</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用上一步中下载的策略创建一个 IAM policy</span></span><br><span class="line">$ aws iam create-policy \</span><br><span class="line">    --profile eks-us-west-2 \</span><br><span class="line">    --policy-name AWSLoadBalancerControllerIAMPolicy \</span><br><span class="line">    --policy-document file://iam_policy.json</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 AWS Load Balancer Controller 的 kube-system 命名空间中创建名为 aws-load-balancer-controller 的 Kubernetes 服务账户，并使用 IAM 角色的名称注释 Kubernetes 服务账户。</span></span><br><span class="line">$ eksctl create iamserviceaccount \</span><br><span class="line">  --cluster=eks-lexing \</span><br><span class="line">  --profile eks-us-west-2 \</span><br><span class="line">  --namespace=kube-system \</span><br><span class="line">  --name=aws-load-balancer-controller \</span><br><span class="line">  --role-name AmazonEKSLoadBalancerControllerRole \</span><br><span class="line">  --attach-policy-arn=arn:aws:iam::743263909644:policy/AWSLoadBalancerControllerIAMPolicy \</span><br><span class="line">  --approve</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>上面是先通过<code>aws iam create-policy</code>命令创建了一个策略，然后通过<code>eksctl create iamserviceaccount</code>命令为EKS(K8s)创建了一个ServiceAccount，同时创建了一个IAM Role与ServiceAccount绑定，并将该Role与上面创建的策略进行关联。</p></li><li class="lvl-2"><p>所以实际上，上面的一个命令干了四件事</p><ul class="lvl-2"><li class="lvl-6"><p>1.创建了一个名称为<code>AmazonEKSLoadBalancerControllerRole</code>的IAM角色并关联新建的名称为<code>AWSLoadBalancerControllerIAMPolicy</code>的策略<br><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/xl0OSL.png" alt="" width="1200" height="600"></p></li><li class="lvl-6"><p>2.在k8s的<code>kube-system</code>namespace下创建了一个名称为<code>aws-load-balancer-controller</code>的ServiceAccount</p></li></ul>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ k get sa -n kube-system aws-load-balancer-controller</span><br><span class="line">NAME                           SECRETS   AGE</span><br><span class="line">aws-load-balancer-controller   0         9d</span><br></pre></td></tr></table></figure><ul class="lvl-2"><li class="lvl-6">3.在名称为<code>AmazonEKSLoadBalancerControllerRole</code>的IAM角色的信任关系中指定认证方式为OIDC，并且关联名称为<code>aws-load-balancer-controller</code>的ServiceAccount。</li></ul><p><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/MkTXd5.png" alt="" width="1200" height="500"></p><ul class="lvl-2"><li class="lvl-6"><p>4.在名称为<code>aws-load-balancer-controller</code>的ServiceAccount中关联上面的角色<code>AmazonEKSLoadBalancerControllerRole</code>，就是添加注释<code>eks.amazonaws.com/role-arn: arn:aws:iam::743263909644:role/AmazonEKSLoadBalancerControll</code>。</p></li></ul>  <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">k</span> <span class="string">edit</span> <span class="string">sa</span> <span class="string">-n</span> <span class="string">kube-system</span> <span class="string">aws-load-balancer-controller</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">eks.amazonaws.com/role-arn:</span> <span class="string">arn:aws:iam::743263909644:role/AmazonEKSLoadBalancerControll</span></span><br><span class="line"><span class="attr">creationTimestamp:</span> <span class="string">&quot;2023-07-04T09:20:41Z&quot;</span></span><br><span class="line"><span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/managed-by:</span> <span class="string">eksctl</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">aws-load-balancer-controller</span></span><br><span class="line"><span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">resourceVersion:</span> <span class="string">&quot;1707669&quot;</span></span><br><span class="line"><span class="attr">uid:</span> <span class="string">857200a6-2e16-4939-bbbc-483dd579acbb</span></span><br></pre></td></tr></table></figure></li><li class="lvl-2"><p>然后在创建Pod时，为Pod指定<code>serviceAccountName: aws-load-balancer-controller</code></p><ul class="lvl-2"><li class="lvl-4">默认情况下，在 Kubernetes 中启动的 Pod 不会以 root 用户身份运行，所以在使用基于 OIDC 的身份认证时，当以非 root 用户运行容器时，可以使用 fsGroup 来指定一个组 ID（group ID），以便容器中的用户具有访问 Web Identity Token 文件的权限。在 Amazon EKS 中，可以将 fsGroup 设置为 65534。这是 Kubernetes 中的推荐做法，因为这个值对应于 nobody 用户和 nogroup 组的 ID。使用 fsGroup: 65534 将确保容器中的非 root 用户具有适当的权限来访问 Web Identity Token 文件，确保容器中的用户具有访问 <code>/var/run/secrets/eks.amazonaws.com/serviceaccount/token</code> 文件的权限。</li></ul></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl edit deployment -n kube-system aws-load-balancer-controller</span><br></pre></td></tr></table></figure><p><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/rSKtJm.png" alt=""></p><div class="tips"><p><em><strong>使用aws命令创建角色并关联SA</strong></em></p><ul class="lvl-1"><li class="lvl-2">创建Policy</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ curl -O https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/v2.4.7/docs/install/iam_policy.json</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用上一步中下载的策略创建一个 IAM policy</span></span><br><span class="line">$ aws iam create-policy \</span><br><span class="line">    --profile eks-us-west-2 \</span><br><span class="line">    --policy-name AWSLoadBalancerControllerIAMPolicy \</span><br><span class="line">    --policy-document file://iam_policy.json</span><br></pre></td></tr></table></figure><ul class="lvl-1"><li class="lvl-2">创建<code>trust-policy.json</code>，用于描述IAM Role的信任关系</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2012-10-17&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Statement&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Principal&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;Federated&quot;</span><span class="punctuation">:</span> <span class="string">&quot;arn:aws:iam::743263909644:oidc-provider/oidc.eks.us-west-2.amazonaws.com/id/1029FF88CB872B6B7A1CC65D44191A56&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sts:AssumeRoleWithWebIdentity&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Condition&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;StringEquals&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;oidc.eks.us-west-2.amazonaws.com/id/1029FF88CB872B6B7A1CC65D44191A56:aud&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sts.amazonaws.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;oidc.eks.us-west-2.amazonaws.com/id/1029FF88CB872B6B7A1CC65D44191A56:sub&quot;</span><span class="punctuation">:</span> <span class="string">&quot;system:serviceaccount:kube-system:aws-load-balancer-controller&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><blockquote><p>上述配置中的 “Condition” 部分是用于在 IAM 角色的信任策略中定义条件。该条件会限制什么样的令牌可以被信任并用于角色的身份验证和授权。<br>具体来说，“Condition” 对象中的 “StringEquals” 表示字符串相等的条件比较。它包含两个键值对，每个键值对都描述了一个条件。<br>“<a href="http://oidc.eks.us-west-2.amazonaws.com/id/1029FF88CB872B6B7A1CC65D44191A56:aud">oidc.eks.us-west-2.amazonaws.com/id/1029FF88CB872B6B7A1CC65D44191A56:aud</a>”: “<a href="http://sts.amazonaws.com">sts.amazonaws.com</a>”：这个条件表示 OIDC 令牌中的 “aud”（受众）字段必须与 “<a href="http://sts.amazonaws.com">sts.amazonaws.com</a>” 相等。也就是说，令牌的受众必须是 AWS Security Token Service (STS)。<br>“<a href="http://oidc.eks.us-west-2.amazonaws.com/id/1029FF88CB872B6B7A1CC65D44191A56:sub">oidc.eks.us-west-2.amazonaws.com/id/1029FF88CB872B6B7A1CC65D44191A56:sub</a>”: “system:serviceaccount:kube-system:aws-load-balancer-controller”：这个条件表示 OIDC 令牌中的 “sub”（主题）字段必须与 “system:serviceaccount:kube-system:aws-load-balancer-controller” 相等。也就是说，令牌的主题必须是 kube-system 命名空间下的 aws-load-balancer-controller Service Account。<br>这些条件的目的是确保只有满足这两个条件的 OIDC 令牌才能被信任，并被用于通过 OIDC 进行的身份验证和授权操作。这样可以限制对角色的访问，仅允许特定的 OIDC 令牌来获取访问权限。</p></blockquote><ul class="lvl-1"><li class="lvl-2">创建 IAM Role</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ aws iam create-role \</span><br><span class="line">  --profile eks-us-west-2 \</span><br><span class="line">  --role-name AmazonEKSLoadBalancerControllerRole \</span><br><span class="line">  --assume-role-policy-document file://<span class="string">&quot;trust-policy.json&quot;</span></span><br></pre></td></tr></table></figure><ul class="lvl-1"><li class="lvl-2"><p>为 Role 添加 Policy</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ aws iam attach-role-policy \</span><br><span class="line">  --profile eks-us-west-2 \</span><br><span class="line">  --policy-arn arn:aws:iam::743263909644:policy/AWSLoadBalancerControllerIAMPolicy \</span><br><span class="line">  --role-name AmazonEKSLoadBalancerControllerRole</span><br></pre></td></tr></table></figure><ul class="lvl-1"><li class="lvl-2"><p>创建SA</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create serviceaccount aws-load-balancer-controller -n kube-system</span><br></pre></td></tr></table></figure><ul class="lvl-1"><li class="lvl-2"><p>为SA绑定IAM Role</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl annotate serviceaccount aws-load-balancer-controller \</span><br><span class="line">  -n kube-system \</span><br><span class="line">  eks.amazonaws.com/role-arn=arn:aws:iam::743263909644:role/AmazonEKSLoadBalancerControllerRole</span><br></pre></td></tr></table></figure></div><h2 id="动手实践">动手实践</h2><ul class="lvl-0"><li class="lvl-2"><p>搞明白了上面的原理，我们只需要按照上面那的步骤做就可以了，接下来就以Pod访问S3为例进行说明。</p></li><li class="lvl-2"><p>创建新的策略或使用现有策略，这里我们使用已有的策略<code>arn:aws:iam::aws:policy/AmazonS3FullAccess</code></p></li><li class="lvl-2"><p>使用<code>eksctl create iamserviceaccount</code>创建Service和IAM Role，并将它们进行绑定关联</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$ eksctl create iamserviceaccount \</span><br><span class="line">  --cluster=eks-lexing \</span><br><span class="line">  --namespace=<span class="built_in">test</span> \</span><br><span class="line">  --name=test-s3-sa-new \</span><br><span class="line">  --role-name TestS3Role \</span><br><span class="line">  --attach-policy-arn=arn:aws:iam::aws:policy/AmazonS3FullAccess \</span><br><span class="line">  --approve</span><br><span class="line">2023-07-13 19:59:18 [ℹ]  6 existing iamserviceaccount(s) (kube-system/aws-load-balancer-controller,kube-system/aws-node,kube-system/ebs-csi-controller-sa,kube-system/efs-csi-controller-sa,<span class="built_in">test</span>/test-s3-sa,<span class="built_in">test</span>/testS3SA) will be excluded</span><br><span class="line">2023-07-13 19:59:18 [ℹ]  1 iamserviceaccount (<span class="built_in">test</span>/test-s3-sa-new) was included (based on the include/exclude rules)</span><br><span class="line">2023-07-13 19:59:18 [!]  serviceaccounts that exist <span class="keyword">in</span> Kubernetes will be excluded, use --override-existing-serviceaccounts to override</span><br><span class="line">2023-07-13 19:59:18 [ℹ]  1 task: &#123;</span><br><span class="line">    2 sequential sub-tasks: &#123;</span><br><span class="line">        create IAM role <span class="keyword">for</span> serviceaccount <span class="string">&quot;test/test-s3-sa-new&quot;</span>,</span><br><span class="line">        create serviceaccount <span class="string">&quot;test/test-s3-sa-new&quot;</span>,</span><br><span class="line">    &#125; &#125;2023-07-13 19:59:18 [ℹ]  building iamserviceaccount stack <span class="string">&quot;eksctl-eks-lexing-addon-iamserviceaccount-test-test-s3-sa-new&quot;</span></span><br><span class="line">2023-07-13 19:59:18 [ℹ]  deploying stack <span class="string">&quot;eksctl-eks-lexing-addon-iamserviceaccount-test-test-s3-sa-new&quot;</span></span><br><span class="line">2023-07-13 19:59:19 [ℹ]  waiting <span class="keyword">for</span> CloudFormation stack <span class="string">&quot;eksctl-eks-lexing-addon-iamserviceaccount-test-test-s3-sa-new&quot;</span></span><br><span class="line">2023-07-13 19:59:50 [ℹ]  waiting <span class="keyword">for</span> CloudFormation stack <span class="string">&quot;eksctl-eks-lexing-addon-iamserviceaccount-test-test-s3-sa-new&quot;</span></span><br><span class="line">2023-07-13 19:59:51 [ℹ]  created serviceaccount <span class="string">&quot;test/test-s3-sa-new&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看sa，确认是否已关联IAM Role</span></span><br><span class="line">$ k describe sa test-s3-sa-new</span><br><span class="line">Name:                test-s3-sa-new</span><br><span class="line">Namespace:           <span class="built_in">test</span></span><br><span class="line">Labels:              app.kubernetes.io/managed-by=eksctl</span><br><span class="line">Annotations:         eks.amazonaws.com/role-arn: arn:aws:iam::743263909644:role/TestS3Role</span><br><span class="line">Image pull secrets:  &lt;none&gt;</span><br><span class="line">Mountable secrets:   &lt;none&gt;</span><br><span class="line">Tokens:              &lt;none&gt;</span><br><span class="line">Events:              &lt;none&gt;</span><br></pre></td></tr></table></figure><p><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/IOszUm.png" alt="" width="1200" height="600"><br><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/oQ6D30.png" alt="" width="1200" height="400"></p><ul class="lvl-0"><li class="lvl-2"><p>创建一个已经安装过AWS CLI的Pod，这里镜像就使用<code>amazon/aws-cli</code>，注意要指定<code>serviceAccountName: test-s3-sa-new</code></p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">deployment-test-s3-sa</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app.kubernetes.io/name:</span> <span class="string">app-test-s3-sa</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app.kubernetes.io/name:</span> <span class="string">app-test-s3-sa</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">test-s3-sa-new</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">amazon/aws-cli</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">app-test-s3-sa</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>]</span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">tail</span> <span class="string">-f</span> <span class="string">/dev/null</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 部署</span></span><br><span class="line">$ k apply -f testS3SA.yaml</span><br><span class="line">deployment.apps/deployment-test-s3-sa created</span><br><span class="line"><span class="comment"># 进入pod</span></span><br><span class="line">$ k <span class="built_in">exec</span> -it deployment-test-s3-sa-5bd985845d-mqjjp -- bash</span><br><span class="line"><span class="comment"># 查看当前的AWS用户信息，可以看到这里关联的是一个临时用户，但是从Arn中也能看出来其关联的角色 TestS3Role</span></span><br><span class="line">bash-4.2<span class="comment"># aws sts get-caller-identity</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;UserId&quot;</span>: <span class="string">&quot;AROA22DP3G4GNBLHPZBAM:botocore-session-1689250618&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Account&quot;</span>: <span class="string">&quot;743263909644&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Arn&quot;</span>: <span class="string">&quot;arn:aws:sts::743263909644:assumed-role/TestS3Role/botocore-session-1689250618&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 查看s3存储桶列表，查询成功，说明当前pod已经具备的访问AWS S3资源的权限</span></span><br><span class="line">bash-4.2<span class="comment"># aws s3 ls</span></span><br><span class="line">2023-07-10 09:34:45 lexing-helm-charts</span><br><span class="line"><span class="comment"># 查看环境变量</span></span><br><span class="line">bash-4.2<span class="comment"># echo $AWS_ROLE_ARN</span></span><br><span class="line">arn:aws:iam::743263909644:role/TestS3Role</span><br><span class="line">bash-4.2<span class="comment"># echo $AWS_WEB_IDENTITY_TOKEN_FILE</span></span><br><span class="line">/var/run/secrets/eks.amazonaws.com/serviceaccount/token</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;!--
 **加粗**
 *斜体*
 ***加粗并斜体***
 ~~删除线~~
 ==突出显示==
 `突出显示(推荐)`
 ++下划线++
 ~下标~
 ^上标^
 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.
 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600)

 +++ **点击折叠**
 这是被隐藏的内容
 +++

::: tips success warning danger
这里是容器内的内容
:::

% note info % success warning danger
这里是容器内的内容
% endnote %

 --&gt;
&lt;h2 id=&quot;摘要&quot;&gt;摘要&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;本文介绍为EKS集群的 Pod 调用 AWS 资源的方法&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;参考资料：&lt;/p&gt;
&lt;ul class=&quot;lvl-2&quot;&gt;
&lt;li class=&quot;lvl-6&quot;&gt;&lt;a href=&quot;https://docs.aws.amazon.com/zh_cn/eks/latest/userguide&quot;&gt;Amazon EKS用户指南&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-6&quot;&gt;&lt;a href=&quot;https://kubernetes.io/zh-cn/docs/home/&quot;&gt;Kubernetes 文档&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="技术" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="aws" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/aws/"/>
    
    <category term="eks" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/aws/eks/"/>
    
    
    <category term="java" scheme="https://blog.hanqunfeng.com/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>AWS-EKS-14--Helm</title>
    <link href="https://blog.hanqunfeng.com/2023/07/10/aws-eks14-helm/"/>
    <id>https://blog.hanqunfeng.com/2023/07/10/aws-eks14-helm/</id>
    <published>2023-07-10T12:30:05.000Z</published>
    <updated>2023-07-11T02:17:14.118Z</updated>
    
    <content type="html"><![CDATA[<!-- **加粗** *斜体* ***加粗并斜体*** ~~删除线~~ ==突出显示== `突出显示(推荐)` ++下划线++ ~下标~ ^上标^ 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference. 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600) +++ **点击折叠** 这是被隐藏的内容 +++::: tips success warning danger这里是容器内的内容:::% note info % success warning danger这里是容器内的内容% endnote % --><h2 id="摘要">摘要</h2><ul class="lvl-0"><li class="lvl-2"><p>本文介绍为Helm的使用方法</p></li><li class="lvl-2"><p>参考资料：</p><ul class="lvl-2"><li class="lvl-6"><a href="https://docs.aws.amazon.com/zh_cn/eks/latest/userguide">Amazon EKS用户指南</a></li><li class="lvl-6"><a href="https://kubernetes.io/zh-cn/docs/home/">Kubernetes 文档</a></li></ul></li></ul><span id="more"></span><h2 id="Helm">Helm</h2><ul class="lvl-0"><li class="lvl-2"><p><a href="https://helm.sh/zh/docs/">官网文档</a></p></li><li class="lvl-2"><p>Helm 是 Kubernetes 的包管理器，类似于 Linux 下的包管理工具如 yum、apt 等。可以方便的将之前打包好的 yaml 文件部署到 Kunernetes 上。</p></li></ul><h3 id="为什么要引入-Helm">为什么要引入 Helm</h3><ul class="lvl-0"><li class="lvl-2"><p>在以往的应用部署过程当中，我们需要先编写一个 yaml 文件，然后该文件中包含 deployment、Service、Ingress 等等。</p></li><li class="lvl-2"><p>如果说需要部署的是单一、少数服务的应用，那么完全可以使用 yaml 文件的方式，这样会很简单。但是在实际的项目当中，微服务的数量基本不可能是一个，可能是几十个，如果说再用 yaml 文件的部署方式，那就意味着需要编写几十个 yaml 文件，这就会导致 数量多、维护难 等诸多问题。</p></li><li class="lvl-2"><p>针对上述问题，Helm 的引入使用则可以将所有的 yaml 文件进行一个整体的管理，而且它能够实现 yaml 文件的高效复用。</p></li><li class="lvl-2"><p>Helm 具备如下的能力：<br>简化部署 ：Helm允许使用单个命令轻松部署和管理应用程序，从而简化了整个部署过程；<br>高度可配置：Helm Charts提供了高度可配置的选项，可以轻松自定义和修改应用程序的部署配置；<br>版本控制 ：Helm允许管理应用程序的多个版本，从而轻松实现版本控制和回滚；<br>模板化：Helm Charts使用YAML模板来定义Kubernetes对象的配置，从而简化了配置过程，并提高了可重复性和可扩展性；<br>应用程序库：Helm具有应用程序库的概念，可以轻松地共享和重用Helm Charts，从而简化了多个应用程序的部署和管理；<br>插件系统：Helm拥有一个强大的插件系统，允许您扩展和定制Helm的功能，以满足特定的需求和要求。</p></li></ul><h3 id="核心概念">核心概念</h3><table><thead><tr><th>概念</th><th>描述</th></tr></thead><tbody><tr><td>Chart</td><td>一个Helm包，其中包含了运行一个应用所需要的镜像、依赖和资源定义等，还可能包含Kubernetes集群中的服务定义，类似Homebrew中的formula、APT的dpkg或者Yum的rpm文件</td></tr><tr><td>Repository</td><td>存储Helm Charts的地方</td></tr><tr><td>Release</td><td>Chart在k8s上运行的Chart的一个实例，例如，如果一个MySQL Chart想在服务器上运行两个数据库，可以将这个Chart安装两次，并在每次安装中生成自己的Release以及Release名称。</td></tr><tr><td>Value</td><td>Helm Chart的参数，用于配置Kubernetes对象</td></tr><tr><td>Template</td><td>使用Go模板语言生成Kubernetes对象的定义文件</td></tr><tr><td>Namespace</td><td>Kubernetes中用于隔离资源的逻辑分区</td></tr></tbody></table><h3 id="Helm的基本使用">Helm的基本使用</h3><ul class="lvl-0"><li class="lvl-2"><p>当您已经安装好了Helm之后，您可以添加一个chart 仓库。从 <a href="https://artifacthub.io/packages/search?kind=0">Artifact Hub</a> 中查找有效的Helm chart仓库。</p></li><li class="lvl-2"><p>另外常用的仓库有<a href="https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts">阿里云</a>、<a href="http://mirror.azure.cn/kubernetes/charts/">微软</a></p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加仓库</span></span><br><span class="line"><span class="comment"># 语法 ：helm repo add 仓库名称 仓库地址</span></span><br><span class="line"><span class="comment"># 添加 eks-charts 存储库</span></span><br><span class="line">$ helm repo add eks https://aws.github.io/eks-charts</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新指定仓库索引，以确保您拥有最新的图表</span></span><br><span class="line">$ helm repo update eks</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新全部仓库索引</span></span><br><span class="line">$ helm repo update</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看已经添加的仓库</span></span><br><span class="line">$ helm repo list</span><br><span class="line">NAME              URL</span><br><span class="line">eks               https://aws.github.io/eks-charts</span><br><span class="line"></span><br><span class="line"><span class="comment"># 搜索，默认展示最新的版本</span></span><br><span class="line">$ helm search repo load-balancer</span><br><span class="line">NAME                            CHART VERSIONAPP VERSIONDESCRIPTION</span><br><span class="line">eks/aws-load-balancer-controller1.5.4        v2.5.3     AWS Load Balancer Controller Helm chart <span class="keyword">for</span> Kub...</span><br><span class="line"></span><br><span class="line"><span class="comment"># 搜索全部版本</span></span><br><span class="line">$ helm search repo load-balancer -l</span><br><span class="line">NAME                            CHART VERSIONAPP VERSIONDESCRIPTION</span><br><span class="line">eks/aws-load-balancer-controller1.5.4        v2.5.3     AWS Load Balancer Controller Helm chart <span class="keyword">for</span> Kub...</span><br><span class="line">eks/aws-load-balancer-controller1.5.3        v2.5.2     AWS Load Balancer Controller Helm chart <span class="keyword">for</span> Kub...</span><br><span class="line">eks/aws-load-balancer-controller1.5.2        v2.5.1     AWS Load Balancer Controller Helm chart <span class="keyword">for</span> Kub...</span><br><span class="line">eks/aws-load-balancer-controller1.5.1        v2.5.1     AWS Load Balancer Controller Helm chart <span class="keyword">for</span> Kub...</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在全部版本中搜索大于等于指定版本</span></span><br><span class="line">$ helm search repo load-balancer --version ^1.5.1 -l</span><br><span class="line">NAME                            CHART VERSIONAPP VERSIONDESCRIPTION</span><br><span class="line">eks/aws-load-balancer-controller1.5.4        v2.5.3     AWS Load Balancer Controller Helm chart <span class="keyword">for</span> Kub...</span><br><span class="line">eks/aws-load-balancer-controller1.5.3        v2.5.2     AWS Load Balancer Controller Helm chart <span class="keyword">for</span> Kub...</span><br><span class="line">eks/aws-load-balancer-controller1.5.2        v2.5.1     AWS Load Balancer Controller Helm chart <span class="keyword">for</span> Kub...</span><br><span class="line">eks/aws-load-balancer-controller1.5.1        v2.5.1     AWS Load Balancer Controller Helm chart <span class="keyword">for</span> Kub...</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 AWS Load Balancer Controller 的最新版本，--set指定Values</span></span><br><span class="line">$ helm install aws-load-balancer-controller eks/aws-load-balancer-controller \</span><br><span class="line">  -n kube-system \</span><br><span class="line">  --<span class="built_in">set</span> clusterName=eks-lexing \</span><br><span class="line">  --<span class="built_in">set</span> serviceAccount.create=<span class="literal">false</span> \</span><br><span class="line">  --<span class="built_in">set</span> serviceAccount.name=aws-load-balancer-controller</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 AWS Load Balancer Controller 的指定版本，--version 1.5.4</span></span><br><span class="line">$ helm install aws-load-balancer-controller eks/aws-load-balancer-controller \</span><br><span class="line">  -n kube-system \</span><br><span class="line">  --<span class="built_in">set</span> clusterName=eks-lexing \</span><br><span class="line">  --<span class="built_in">set</span> serviceAccount.create=<span class="literal">false</span> \</span><br><span class="line">  --<span class="built_in">set</span> serviceAccount.name=aws-load-balancer-controller</span><br><span class="line">  --version 1.5.4</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看全部命名空间下已经安装的包</span></span><br><span class="line">$ helm list --all-namespaces</span><br><span class="line">NAME                        NAMESPACE  REVISIONUPDATED                             STATUS  CHART                             APP VERSION</span><br><span class="line">aws-load-balancer-controllerkube-system2       2023-07-04 17:31:37.839466 +0800 CSTdeployedaws-load-balancer-controller-1.5.4v2.5.3</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看指定命名空间下已经安装的包</span></span><br><span class="line">$ helm list -n kube-system</span><br><span class="line"><span class="comment"># 关键字过滤</span></span><br><span class="line">$ helm list -n kube-system --filter load-balancer</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取Values，用户指定的，即安装或升级时通过--set等方式设置的</span></span><br><span class="line">$ helm get values aws-load-balancer-controller -n kube-system</span><br><span class="line">USER-SUPPLIED VALUES:</span><br><span class="line">clusterName: eks-lexing</span><br><span class="line">serviceAccount:</span><br><span class="line">  create: <span class="literal">false</span></span><br><span class="line">  name: aws-load-balancer-controller</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取Values，全部Values，都可以进行替换</span></span><br><span class="line">$ helm get values aws-load-balancer-controller -n kube-system --all</span><br><span class="line"></span><br><span class="line"><span class="comment"># 升级安装，升级时只需要指定要改变的部分</span></span><br><span class="line">$ helm upgrade aws-load-balancer-controller eks/aws-load-balancer-controller \</span><br><span class="line">  -n kube-system \</span><br><span class="line">  --<span class="built_in">set</span> clusterName=eks-lexing \</span><br><span class="line">  --<span class="built_in">set</span> serviceAccount.create=<span class="literal">false</span> \</span><br><span class="line">  --<span class="built_in">set</span> serviceAccount.name=aws-load-balancer-controller</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看历史安装记录</span></span><br><span class="line">$ helm <span class="built_in">history</span> -n kube-system aws-load-balancer-controller</span><br><span class="line">REVISIONUPDATED                 STATUS    CHART                             APP VERSIONDESCRIPTION</span><br><span class="line">1       Tue Jul  4 17:26:05 2023supersededaws-load-balancer-controller-1.5.4v2.5.3     Install complete</span><br><span class="line">2       Tue Jul  4 17:31:37 2023deployed  aws-load-balancer-controller-1.5.4v2.5.3     Upgrade complete</span><br><span class="line"></span><br><span class="line"><span class="comment"># 回滚到指定修订号，修订号通过 helm history 查看</span></span><br><span class="line">$ helm rollback -n kube-system aws-load-balancer-controller 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示已命名发布的状态</span></span><br><span class="line">$ helm status -n kube-system aws-load-balancer-controller</span><br><span class="line">NAME: aws-load-balancer-controller</span><br><span class="line">LAST DEPLOYED: Tue Jul  4 17:31:37 2023</span><br><span class="line">NAMESPACE: kube-system</span><br><span class="line">STATUS: deployed</span><br><span class="line">REVISION: 2</span><br><span class="line">TEST SUITE: None</span><br><span class="line">NOTES:</span><br><span class="line">AWS Load Balancer controller installed!</span><br><span class="line"></span><br><span class="line"><span class="comment"># 卸载</span></span><br><span class="line">$ helm uninstall aws-load-balancer-controller -n kube-system</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除仓库</span></span><br><span class="line">$ helm repo remove eks</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看helm客户端环境信息</span></span><br><span class="line">$ helm <span class="built_in">env</span></span><br><span class="line">HELM_BIN=<span class="string">&quot;helm&quot;</span></span><br><span class="line">HELM_BURST_LIMIT=<span class="string">&quot;100&quot;</span></span><br><span class="line">HELM_CACHE_HOME=<span class="string">&quot;/Users/hanqf/Library/Caches/helm&quot;</span></span><br><span class="line">HELM_CONFIG_HOME=<span class="string">&quot;/Users/hanqf/Library/Preferences/helm&quot;</span></span><br><span class="line">HELM_DATA_HOME=<span class="string">&quot;/Users/hanqf/Library/helm&quot;</span></span><br><span class="line">HELM_DEBUG=<span class="string">&quot;false&quot;</span></span><br><span class="line">HELM_KUBEAPISERVER=<span class="string">&quot;&quot;</span></span><br><span class="line">HELM_KUBEASGROUPS=<span class="string">&quot;&quot;</span></span><br><span class="line">HELM_KUBEASUSER=<span class="string">&quot;&quot;</span></span><br><span class="line">HELM_KUBECAFILE=<span class="string">&quot;&quot;</span></span><br><span class="line">HELM_KUBECONTEXT=<span class="string">&quot;&quot;</span></span><br><span class="line">HELM_KUBEINSECURE_SKIP_TLS_VERIFY=<span class="string">&quot;false&quot;</span></span><br><span class="line">HELM_KUBETLS_SERVER_NAME=<span class="string">&quot;&quot;</span></span><br><span class="line">HELM_KUBETOKEN=<span class="string">&quot;&quot;</span></span><br><span class="line">HELM_MAX_HISTORY=<span class="string">&quot;10&quot;</span></span><br><span class="line">HELM_NAMESPACE=<span class="string">&quot;test&quot;</span></span><br><span class="line">HELM_PLUGINS=<span class="string">&quot;/Users/hanqf/Library/helm/plugins&quot;</span></span><br><span class="line">HELM_REGISTRY_CONFIG=<span class="string">&quot;/Users/hanqf/Library/Preferences/helm/registry/config.json&quot;</span></span><br><span class="line">HELM_REPOSITORY_CACHE=<span class="string">&quot;/Users/hanqf/Library/Caches/helm/repository&quot;</span></span><br><span class="line">HELM_REPOSITORY_CONFIG=<span class="string">&quot;/Users/hanqf/Library/Preferences/helm/repositories.yaml&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 展示指定chart的全部信息 （values.yaml, Chart.yaml, README）</span></span><br><span class="line">$ helm show all eks/aws-load-balancer-controller</span><br><span class="line"><span class="comment"># 只展示chart.yaml</span></span><br><span class="line">$ helm show chart eks/aws-load-balancer-controller</span><br><span class="line"><span class="comment"># 只展示values.yaml</span></span><br><span class="line">$ helm show values eks/aws-load-balancer-controller</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#下载指定的包，这里会下载 aws-load-balancer-controller-1.5.4.tgz</span></span><br><span class="line">$ helm pull eks/aws-load-balancer-controller</span><br><span class="line"><span class="comment"># 下载并解压到指定目录</span></span><br><span class="line">$ helm pull eks/aws-load-balancer-controller --untar --untardir ./</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="自定义-Chart-部署应用">自定义 Chart 部署应用</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建一个chart</span></span><br><span class="line">$ helm create mychart</span><br><span class="line">Creating mychart</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">ls</span></span><br><span class="line">mychart</span><br><span class="line"></span><br><span class="line">$ exa -T mychart</span><br><span class="line">mychart</span><br><span class="line">├── Chart.yaml</span><br><span class="line">├── charts</span><br><span class="line">├── templates</span><br><span class="line">│  ├── _helpers.tpl</span><br><span class="line">│  ├── deployment.yaml</span><br><span class="line">│  ├── hpa.yaml</span><br><span class="line">│  ├── ingress.yaml</span><br><span class="line">│  ├── NOTES.txt</span><br><span class="line">│  ├── service.yaml</span><br><span class="line">│  ├── serviceaccount.yaml</span><br><span class="line">│  └── tests</span><br><span class="line">│     └── test-connection.yaml</span><br><span class="line">└── values.yaml</span><br></pre></td></tr></table></figure><table><thead><tr><th>文件</th><th>含义</th></tr></thead><tbody><tr><td>charts</td><td>一个普通的空文件，一般也不会写入内容</td></tr><tr><td>Chart.yaml</td><td>当前 chart 属性的配置信息</td></tr><tr><td>templates</td><td>自己定义的 yaml 文件存于此</td></tr><tr><td>values.yaml</td><td>定义 yaml 文件的全局配置</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>Chart.yaml: 包含Chart的元数据和依赖项</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">chart</span> <span class="string">API</span> <span class="string">版本</span> <span class="string">（必需）</span>  <span class="comment">#必须有</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">chart名称</span> <span class="string">（必需）</span>     <span class="comment"># 必须有</span></span><br><span class="line"><span class="attr">version:</span> <span class="string">指定</span> <span class="string">chart</span> <span class="string">版本（必需），打包时的版本号</span> <span class="comment"># 必须有</span></span><br><span class="line"></span><br><span class="line"><span class="attr">kubeVersion:</span> <span class="string">兼容Kubernetes版本的语义化版本（可选）</span></span><br><span class="line"><span class="attr">description:</span> <span class="string">一句话对这个项目的描述（可选）</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">chart类型</span> <span class="string">（可选）</span></span><br><span class="line"><span class="attr">keywords:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">关于项目的一组关键字（可选）</span></span><br><span class="line"><span class="attr">home:</span> <span class="string">项目home页面的URL</span> <span class="string">（可选）</span></span><br><span class="line"><span class="attr">sources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">项目源码的URL列表（可选）</span></span><br><span class="line"><span class="attr">dependencies:</span> <span class="comment"># chart 依赖列表 （可选）</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">chart名称</span> <span class="string">(nginx)</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">chart版本</span> <span class="string">(&quot;1.2.3&quot;)</span></span><br><span class="line">    <span class="attr">repository:</span> <span class="string">（可选）仓库URL</span> <span class="string">(&quot;https://example.com/charts&quot;)</span> <span class="string">或别名</span> <span class="string">(&quot;@repo-name&quot;)</span></span><br><span class="line">    <span class="attr">condition:</span> <span class="string">（可选）</span> <span class="string">解析为布尔值的yaml路径，用于启用/禁用chart</span> <span class="string">(e.g.</span> <span class="string">subchart1.enabled</span> <span class="string">)</span></span><br><span class="line">    <span class="attr">tags:</span> <span class="comment"># （可选）</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">用于一次启用/禁用</span> <span class="string">一组chart的tag</span></span><br><span class="line">    <span class="attr">import-values:</span> <span class="comment"># （可选）</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ImportValue</span> <span class="string">保存源值到导入父键的映射。每项可以是字符串或者一对子/父列表项</span></span><br><span class="line">    <span class="attr">alias:</span> <span class="string">（可选）</span> <span class="string">chart中使用的别名。当你要多次添加相同的chart时会很有用</span></span><br><span class="line"></span><br><span class="line"><span class="attr">maintainers:</span> <span class="comment"># （可选） # 可能用到</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">维护者名字</span> <span class="string">（每个维护者都需要）</span></span><br><span class="line">    <span class="attr">email:</span> <span class="string">维护者邮箱</span> <span class="string">（每个维护者可选）</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">维护者URL</span> <span class="string">（每个维护者可选）</span></span><br><span class="line"></span><br><span class="line"><span class="attr">icon:</span> <span class="string">用做icon的SVG或PNG图片URL</span> <span class="string">（可选）</span></span><br><span class="line"><span class="attr">appVersion:</span> <span class="string">包含的应用版本（可选）。不需要是语义化，建议使用引号</span></span><br><span class="line"><span class="attr">deprecated:</span> <span class="string">不被推荐的chart</span> <span class="string">（可选，布尔值）</span></span><br><span class="line"><span class="attr">annotations:</span></span><br><span class="line">  <span class="attr">example:</span> <span class="string">按名称输入的批注列表</span> <span class="string">（可选）.</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>示例：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v2</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">mychart</span></span><br><span class="line"><span class="attr">description:</span> <span class="string">A</span> <span class="string">Helm</span> <span class="string">chart</span> <span class="string">for</span> <span class="string">Kubernetes</span></span><br><span class="line"><span class="attr">version:</span> <span class="number">0.1</span><span class="number">.0</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>values.yaml: 包含应用程序的默认配置值，如下示例：</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">image:</span></span><br><span class="line">  <span class="attr">repository:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">tag:</span> <span class="string">&#x27;1.19.8&#x27;</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>templates: 模板文件，各种k8s资源yaml，在模板文件中可以通过 .Values对象访问到 values.yaml里的配置<br>示例：我们可以依据需要创建各种k8s资源的yaml文件，这里为了演示方便，删除templates下全部文件，然后创建deployment.yaml</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># deployment.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-helm-&#123;&#123;</span> <span class="string">.Values.image.repository</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx-helm</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx-helm</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-helm</span></span><br><span class="line">        <span class="attr">image:</span> &#123;&#123; <span class="string">.Values.image.repository</span> &#125;&#125;<span class="string">:&#123;&#123;</span> <span class="string">.Values.image.tag</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>安装自定义Chart</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ helm install mychart mychart</span><br><span class="line">NAME: mychart</span><br><span class="line">LAST DEPLOYED: Mon Jul 10 16:36:13 2023</span><br><span class="line">NAMESPACE: <span class="built_in">test</span></span><br><span class="line">STATUS: deployed</span><br><span class="line">REVISION: 1</span><br><span class="line">TEST SUITE: None</span><br><span class="line"></span><br><span class="line">$ helm list</span><br><span class="line">NAME   NAMESPACEREVISIONUPDATED                             STATUS  CHART        APP VERSION</span><br><span class="line">mychart<span class="built_in">test</span>     1       2023-07-10 16:36:13.707877 +0800 CSTdeployedmychart-0.1.0</span><br><span class="line"></span><br><span class="line">$ k get deploy</span><br><span class="line">NAME               READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">nginx-helm-nginx   1/1     1            1           94s</span><br><span class="line"></span><br><span class="line">$ k describe deploy nginx-helm-nginx | grep Image</span><br><span class="line">    Image:        nginx:1.19.8</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>升级Chart<br>这里修改 values.yaml 中镜像的版本</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">image:</span></span><br><span class="line">  <span class="attr">repository:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">tag:</span> <span class="string">&#x27;1.20.2&#x27;</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ upgrade mychart mychart</span><br><span class="line">Release <span class="string">&quot;mychart&quot;</span> has been upgraded. Happy Helming!</span><br><span class="line">NAME: mychart</span><br><span class="line">LAST DEPLOYED: Mon Jul 10 16:46:03 2023</span><br><span class="line">NAMESPACE: <span class="built_in">test</span></span><br><span class="line">STATUS: deployed</span><br><span class="line">REVISION: 2</span><br><span class="line">TEST SUITE: None</span><br><span class="line"></span><br><span class="line">$ k describe deploy nginx-helm-nginx | grep Image</span><br><span class="line">    Image:        nginx:1.20.2</span><br></pre></td></tr></table></figure><h3 id="发布Chart">发布Chart</h3><ul class="lvl-0"><li class="lvl-2"><p>需要一个Chart仓库，可以使用harbor构建私有仓库，我这里使用aws，所以就用S3作为Chart仓库。</p></li><li class="lvl-2"><p><a href="https://aws.amazon.com/cn/blogs/china/build-helm-chart-warehouse-based-on-aws-ecr-or-s3/">基于 AWS ECR 或 S3 搭建 Helm Chart 仓库</a></p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装helm-S3插件</span></span><br><span class="line">$ helm plugin install https://github.com/hypnoglow/helm-s3.git</span><br><span class="line">Downloading and installing helm-s3 v0.14.0 ...</span><br><span class="line">Checksum is valid.</span><br><span class="line">Installed plugin: s3</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定操作s3的profile，因为helm不支持指定profile，所以这里可以使用环境变量的方式</span></span><br><span class="line">$ <span class="built_in">export</span> AWS_PROFILE=eks-us-west-2</span><br><span class="line"><span class="comment"># 初始化 S3 目录（假设名为 lexing-helm-charts 的S3存储桶已经存在）</span></span><br><span class="line">$ helm s3 init s3://lexing-helm-charts/charts/</span><br><span class="line">Initialized empty repository at s3://lexing-helm-charts/charts/</span><br><span class="line"><span class="comment"># 添加仓库到本地</span></span><br><span class="line">$ helm repo add lexing-helm-charts s3://lexing-helm-charts/charts/</span><br><span class="line"><span class="comment"># 查看lexing-helm-charts repo是否已经添加到本地</span></span><br><span class="line">$ helm repo list</span><br><span class="line">NAME              URL</span><br><span class="line">aws-efs-csi-driverhttps://kubernetes-sigs.github.io/aws-efs-csi-driver/</span><br><span class="line">eks               https://aws.github.io/eks-charts</span><br><span class="line">aliyun            https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts</span><br><span class="line">lexing-helm-chartss3://lexing-helm-charts/charts/</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>打包Chart</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ helm package mychart</span><br><span class="line">Successfully packaged chart and saved it to: /Users/hanqf/Desktop/k8sDir/helm-chart/mychart-0.1.0.tgz</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>chart 上传到 S3</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 指定操作s3的profile，因为helm不支持指定profile，所以这里可以使用环境变量的方式</span></span><br><span class="line">$ <span class="built_in">export</span> AWS_PROFILE=eks-us-west-2</span><br><span class="line"><span class="comment"># 推送my-nginx helm chart 到 S3</span></span><br><span class="line">$ helm s3 push mychart-0.1.0.tgz lexing-helm-charts --force</span><br><span class="line">Successfully uploaded the chart to the repository.</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>搜索chart并安装</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 搜索</span></span><br><span class="line">$ helm search repo mychart</span><br><span class="line">NAME                      CHART VERSIONAPP VERSIONDESCRIPTION</span><br><span class="line">lexing-helm-charts/mychart0.1.0                   A Helm chart <span class="keyword">for</span> Kubernetes</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从Helm s3 repo 安装my-nginx chart到EKS/ Kubernetes集群</span></span><br><span class="line">$ helm install mychart lexing-helm-charts/mychart</span><br><span class="line"></span><br><span class="line"><span class="comment"># 升级安装</span></span><br><span class="line">$ helm upgrade mychart lexing-helm-charts/mychart --<span class="built_in">set</span> image.tag=1.20.2</span><br></pre></td></tr></table></figure><h2 id="Helm的执行安装顺序">Helm的执行安装顺序</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">Namespace</span><br><span class="line">NetworkPolicy</span><br><span class="line">ResourceQuota</span><br><span class="line">LimitRange</span><br><span class="line">PodSecurityPolicy</span><br><span class="line">PodDisruptionBudget</span><br><span class="line">ServiceAccount</span><br><span class="line">Secret</span><br><span class="line">SecretList</span><br><span class="line">ConfigMap</span><br><span class="line">StorageClass</span><br><span class="line">PersistentVolume</span><br><span class="line">PersistentVolumeClaim</span><br><span class="line">CustomResourceDefinition</span><br><span class="line">ClusterRole</span><br><span class="line">ClusterRoleList</span><br><span class="line">ClusterRoleBinding</span><br><span class="line">ClusterRoleBindingList</span><br><span class="line">Role</span><br><span class="line">RoleList</span><br><span class="line">RoleBinding</span><br><span class="line">RoleBindingList</span><br><span class="line">Service</span><br><span class="line">DaemonSet</span><br><span class="line">Pod</span><br><span class="line">ReplicationController</span><br><span class="line">ReplicaSet</span><br><span class="line">Deployment</span><br><span class="line">HorizontalPodAutoscaler</span><br><span class="line">StatefulSet</span><br><span class="line">Job</span><br><span class="line">CronJob</span><br><span class="line">Ingress</span><br><span class="line">APIService</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;!--
 **加粗**
 *斜体*
 ***加粗并斜体***
 ~~删除线~~
 ==突出显示==
 `突出显示(推荐)`
 ++下划线++
 ~下标~
 ^上标^
 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.
 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600)

 +++ **点击折叠**
 这是被隐藏的内容
 +++

::: tips success warning danger
这里是容器内的内容
:::

% note info % success warning danger
这里是容器内的内容
% endnote %

 --&gt;
&lt;h2 id=&quot;摘要&quot;&gt;摘要&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;本文介绍为Helm的使用方法&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;参考资料：&lt;/p&gt;
&lt;ul class=&quot;lvl-2&quot;&gt;
&lt;li class=&quot;lvl-6&quot;&gt;&lt;a href=&quot;https://docs.aws.amazon.com/zh_cn/eks/latest/userguide&quot;&gt;Amazon EKS用户指南&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-6&quot;&gt;&lt;a href=&quot;https://kubernetes.io/zh-cn/docs/home/&quot;&gt;Kubernetes 文档&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="技术" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="aws" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/aws/"/>
    
    <category term="eks" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/aws/eks/"/>
    
    
    <category term="java" scheme="https://blog.hanqunfeng.com/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>AWS-EKS-13--Kubectl</title>
    <link href="https://blog.hanqunfeng.com/2023/07/07/aws-eks13-kubectl/"/>
    <id>https://blog.hanqunfeng.com/2023/07/07/aws-eks13-kubectl/</id>
    <published>2023-07-07T15:50:05.000Z</published>
    <updated>2023-07-10T04:25:54.687Z</updated>
    
    <content type="html"><![CDATA[<!-- **加粗** *斜体* ***加粗并斜体*** ~~删除线~~ ==突出显示== `突出显示(推荐)` ++下划线++ ~下标~ ^上标^ 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference. 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600) +++ **点击折叠** 这是被隐藏的内容 +++::: tips success warning danger这里是容器内的内容:::% note info % success warning danger这里是容器内的内容% endnote % --><h2 id="摘要">摘要</h2><ul class="lvl-0"><li class="lvl-2"><p>本文介绍kubectl命令的使用方法</p></li><li class="lvl-2"><p>参考资料：</p><ul class="lvl-2"><li class="lvl-6"><a href="https://docs.aws.amazon.com/zh_cn/eks/latest/userguide">Amazon EKS用户指南</a></li><li class="lvl-6"><a href="https://kubernetes.io/zh-cn/docs/home/">Kubernetes 文档</a></li></ul></li></ul><span id="more"></span><h2 id="kubectl命令">kubectl命令</h2><ul class="lvl-0"><li class="lvl-2"><p>Kubernetes 提供 kubectl 是使用 Kubernetes API 与 Kubernetes 集群的控制面进行通信的命令行工具。</p></li><li class="lvl-2"><p><a href="https://kubernetes.io/zh-cn/docs/reference/kubectl/">官网文档</a></p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="built_in">help</span></span><br><span class="line">kubectl controls the Kubernetes cluster manager.</span><br><span class="line"></span><br><span class="line"> Find more information at: https://kubernetes.io/docs/reference/kubectl/</span><br><span class="line"></span><br><span class="line">Basic Commands (Beginner):</span><br><span class="line">  create          Create a resource from a file or from stdin</span><br><span class="line">  expose          Take a replication controller, service, deployment or pod and</span><br><span class="line">expose it as a new Kubernetes service</span><br><span class="line">  run             在集群上运行特定镜像</span><br><span class="line">  <span class="built_in">set</span>             为对象设置指定特性</span><br><span class="line"></span><br><span class="line">Basic Commands (Intermediate):</span><br><span class="line">  explain         Get documentation <span class="keyword">for</span> a resource</span><br><span class="line">  get             显示一个或多个资源</span><br><span class="line">  edit            编辑服务器上的资源</span><br><span class="line">  delete          Delete resources by file names, stdin, resources and names, or</span><br><span class="line">by resources and label selector</span><br><span class="line"></span><br><span class="line">Deploy Commands:</span><br><span class="line">  rollout         Manage the rollout of a resource</span><br><span class="line">  scale           Set a new size <span class="keyword">for</span> a deployment, replica <span class="built_in">set</span>, or replication</span><br><span class="line">controller</span><br><span class="line">  autoscale       Auto-scale a deployment, replica <span class="built_in">set</span>, stateful <span class="built_in">set</span>, or</span><br><span class="line">replication controller</span><br><span class="line"></span><br><span class="line">Cluster Management Commands:</span><br><span class="line">  certificate     修改证书资源。</span><br><span class="line">  cluster-info    Display cluster information</span><br><span class="line">  top             Display resource (CPU/memory) usage</span><br><span class="line">  cordon          标记节点为不可调度</span><br><span class="line">  uncordon        标记节点为可调度</span><br><span class="line">  drain           清空节点以准备维护</span><br><span class="line">  taint           更新一个或者多个节点上的污点</span><br><span class="line"></span><br><span class="line">Troubleshooting and Debugging Commands:</span><br><span class="line">  describe        显示特定资源或资源组的详细信息</span><br><span class="line">  logs            打印 Pod 中容器的日志</span><br><span class="line">  attach          挂接到一个运行中的容器</span><br><span class="line">  <span class="built_in">exec</span>            在某个容器中执行一个命令</span><br><span class="line">  port-forward    将一个或多个本地端口转发到某个 Pod</span><br><span class="line">  proxy           运行一个指向 Kubernetes API 服务器的代理</span><br><span class="line">  <span class="built_in">cp</span>              Copy files and directories to and from containers</span><br><span class="line">  auth            Inspect authorization</span><br><span class="line">  debug           Create debugging sessions <span class="keyword">for</span> troubleshooting workloads and nodes</span><br><span class="line">  events          List events</span><br><span class="line"></span><br><span class="line">Advanced Commands:</span><br><span class="line">  diff            Diff the live version against a would-be applied version</span><br><span class="line">  apply           Apply a configuration to a resource by file name or stdin</span><br><span class="line">  patch           Update fields of a resource</span><br><span class="line">  replace         Replace a resource by file name or stdin</span><br><span class="line">  <span class="built_in">wait</span>            Experimental: Wait <span class="keyword">for</span> a specific condition on one or many</span><br><span class="line">resources</span><br><span class="line">  kustomize       Build a kustomization target from a directory or URL.</span><br><span class="line"></span><br><span class="line">Settings Commands:</span><br><span class="line">  label           更新某资源上的标签</span><br><span class="line">  annotate        更新一个资源的注解</span><br><span class="line">  completion      Output shell completion code <span class="keyword">for</span> the specified shell (bash, zsh, fish, or powershell)</span><br><span class="line"></span><br><span class="line">Other Commands:</span><br><span class="line">  alpha           Commands <span class="keyword">for</span> features <span class="keyword">in</span> alpha</span><br><span class="line">  api-resources   Print the supported API resources on the server</span><br><span class="line">  api-versions    Print the supported API versions on the server, <span class="keyword">in</span> the form of <span class="string">&quot;group/version&quot;</span></span><br><span class="line">  config          修改 kubeconfig 文件</span><br><span class="line">  plugin          Provides utilities <span class="keyword">for</span> interacting with plugins</span><br><span class="line">  version         输出客户端和服务端的版本信息</span><br></pre></td></tr></table></figure><h2 id="context-集群-相关">context[集群]相关</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看client和server版本，注意此时必须连上server端</span></span><br><span class="line">k version</span><br><span class="line">k version --output=yaml/json</span><br><span class="line"></span><br><span class="line"><span class="comment"># 只查看client版本</span></span><br><span class="line">k version --client --short</span><br><span class="line">k version --client --output=yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看所有资源信息，会显示name，shortname，版本，KIND等等</span></span><br><span class="line">k api-resources</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看全部context配置，会显示所有context，当前context前面会用星号标识，同时显示其默认的namespace</span></span><br><span class="line">k config get-contexts</span><br><span class="line"><span class="comment"># 查看当前context</span></span><br><span class="line">k config current-context</span><br><span class="line"></span><br><span class="line"><span class="comment"># 切换到指定的context，后面跟上面命令查询出来的context的名称，同时修改k8s的配置文件，默认在~/.kube/config 文件</span></span><br><span class="line">k config use-context eks-lexing</span><br><span class="line"><span class="comment"># 作用同上，都是切换上下文</span></span><br><span class="line">k config <span class="built_in">set</span> current-context ekstest</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改当前context的名称</span></span><br><span class="line">k config rename-context $(k config current-context) ty-hk-eks</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看~/.kube/config 文件</span></span><br><span class="line">k config view</span><br><span class="line"></span><br><span class="line"><span class="comment"># 列出所有插件文件路径</span></span><br><span class="line">k plugin list</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看集群信息</span></span><br><span class="line">k cluster-info</span><br></pre></td></tr></table></figure><h2 id="节点相关">节点相关</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看当前集群下的node</span></span><br><span class="line">k get nodes</span><br><span class="line"><span class="comment"># 显示更多信息，比如ip地址</span></span><br><span class="line">k get nodes -o wide</span><br></pre></td></tr></table></figure><h2 id="namespace–ns相关">namespace–ns相关</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获取当前集群下所有namespace</span></span><br><span class="line">k get namespaces</span><br><span class="line"><span class="comment"># namespace可以简写为ns</span></span><br><span class="line">k get ns</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看当前默认的namespace</span></span><br><span class="line">k config get-contexts $(k config current-context)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置当前集群缺省的namespace，同时修改k8s的配置文件，默认在~/.kube/config 文件</span></span><br><span class="line">k config set-context --current --namespace=default</span><br><span class="line">k config set-context $(k config current-context) --namespace default</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个新的namespace</span></span><br><span class="line">k create namespace hanqf</span><br><span class="line">k create ns hanqf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 不创建，只生成yaml文件</span></span><br><span class="line">k create ns hanqf --dry-run=client -o yaml &gt; namespace_hanqf.yaml</span><br><span class="line"><span class="comment"># 基于yaml创建namespace</span></span><br><span class="line">k apply -f namespace_hanqf.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除namespace，删除的同时会删除namespace下的所有资源</span></span><br><span class="line">k delete namespace hanqf</span><br></pre></td></tr></table></figure><h2 id="pod–po相关">pod–po相关</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获取当前namespace下的pod</span></span><br><span class="line">k get pods</span><br><span class="line"><span class="comment"># 显示更多信息，比如ip地址</span></span><br><span class="line">k get pods -o wide</span><br><span class="line"><span class="comment"># 列出标签</span></span><br><span class="line">k get pods --show-labels</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示所有namespace下的pod</span></span><br><span class="line">k get pods -A</span><br><span class="line"><span class="comment"># 显示指定namespace下的pod</span></span><br><span class="line">k get pods -n jx-git-operator</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建pod</span></span><br><span class="line">k run nginx --image=nginx:1.9 --port=80</span><br><span class="line"><span class="comment"># 生成yaml</span></span><br><span class="line">k run nginx --image=nginx:1.9 --port=80 --dry-run=client -o yaml &gt; nginx.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看pod创建后的配置信息，可以使用k apply -f nginx2.yaml重新创建pod</span></span><br><span class="line">k get pods nginx --output=yaml &gt; nginx2.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行yaml配置创建</span></span><br><span class="line">k apply -f pod.yaml</span><br></pre></td></tr></table></figure><h2 id="controller相关">controller相关</h2><p><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/oYVIIm.jpg" alt=""><br><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/MyEcr0.jpg" alt="" width="1200" height="400"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获取当前namespace下的deployment</span></span><br><span class="line">k get deployments</span><br><span class="line"><span class="comment"># 查看指定的deployment的配置信息</span></span><br><span class="line">k describe deployments test-nginx</span><br><span class="line"><span class="comment"># 编辑指定的deployment</span></span><br><span class="line">k edit deployments test-nginx</span><br><span class="line"><span class="comment"># 删除指定的deployment</span></span><br><span class="line">k delete deployments test-nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 以下同上</span></span><br><span class="line"><span class="comment"># 获取当前namespace下的statefulset，job,cronjob，daemonset</span></span><br><span class="line">k get statefulsets</span><br><span class="line">k get <span class="built_in">jobs</span></span><br><span class="line">k get cronjobs</span><br><span class="line">k get daemonsets</span><br></pre></td></tr></table></figure><h3 id="deployment–deploy">deployment–deploy</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># deploy.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myngx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">myngx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">     <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">myngx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx:1.7.9</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">myngx</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">8m</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 命令行创建deploy</span></span><br><span class="line">k create deployment test-nginx --image=nginx:1.9 --port=80 --replicas=2</span><br><span class="line"><span class="comment"># 创建yaml</span></span><br><span class="line">k create deployment test-nginx --image=nginx:1.9 --port=80 --replicas=2 --dry-run=client -o yaml &gt; deploy_new.yaml</span><br><span class="line"><span class="comment"># 创建delpoyment</span></span><br><span class="line">k apply -f deploy_new.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看deploy对应的rs信息，会显示升级历史</span></span><br><span class="line">k get rs -owide -l app=test-nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重新启动deploy</span></span><br><span class="line">kubectl rollout restart deployment test-nginx</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看全部deployment</span></span><br><span class="line">k get deploy</span><br><span class="line"><span class="comment"># 将指定的deployment输出到yaml</span></span><br><span class="line">k get deploy myngx -o yaml &gt; deploy_nginx.yaml</span><br><span class="line"><span class="comment"># 删除deployment</span></span><br><span class="line">k delete deploy myngx</span><br><span class="line"><span class="comment"># 重新创建deployment</span></span><br><span class="line">k apply -f deploy_nginx.yaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 扩缩容，pod不支持扩缩容，只有rs,deploy,sts等高级别controller才有扩缩容能力</span></span><br><span class="line">k scale deploy myngx --replicas=4</span><br><span class="line"><span class="comment"># rs,deploy,sts等高级别controller都具有自愈能力，如果其下的pod被删除了，会自动重新创建新的pod</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改deploy</span></span><br><span class="line"><span class="comment"># 方式1：编辑配置，就是vim，保存后立即生效</span></span><br><span class="line">k edit deploy test-nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方式2: 命令行，比如修改过镜像版本</span></span><br><span class="line"><span class="comment"># k set image deployment deploy名称 镜像名称=镜像</span></span><br><span class="line">k <span class="built_in">set</span> image deployment test-nginx nginx=nginx:1.7.9</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看升级是否成功</span></span><br><span class="line">k rollout status -w deployment test-nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看deploy对应的rs信息，会显示升级历史</span></span><br><span class="line">k get rs -owide -l app=test-nginx</span><br><span class="line"><span class="comment"># 查看历史版本记录，每行前有个版本号</span></span><br><span class="line">k rollout <span class="built_in">history</span> deploy test-nginx</span><br><span class="line"><span class="comment"># 查看指定历史版本号的详细信息</span></span><br><span class="line">k rollout <span class="built_in">history</span> deploy test-nginx --revision=2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 回退到上一个版本</span></span><br><span class="line">k rollout undo deploy test-nginx</span><br><span class="line"><span class="comment"># 回退到指定的版本</span></span><br><span class="line">k rollout undo deploy test-nginx --to-revision=2</span><br></pre></td></tr></table></figure><h3 id="daemonset–ds">daemonset–ds</h3><ul class="lvl-0"><li class="lvl-2"><p>每个node都会创建一个pod，当有新的node加入进来时，pod会自动被daemonset调度到新的node上，同理删除node，该node上的pod也会被移除</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ds1.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ds1</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">fluentd-logging</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">mynginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">mynginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">node-role.kubernetes.io/master</span></span><br><span class="line">        <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mynginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:1.7.9</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">200Mi</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">200Mi</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建ds</span></span><br><span class="line">k apply -f ds1.yaml</span><br><span class="line"><span class="comment"># daemonset不支持使用create创建，但其格式与deployment差不多，可以先通过create创建deploy的yaml，然后对其进行修改，</span></span><br><span class="line"><span class="comment"># 如修改 apiVersion 和 kind，同时还要去掉replicas，另外需要加上tolerance的配置，保证其在master节点上也能部署</span></span><br><span class="line">k run nginx --image=nginx:1.9 --dry-run -o yaml &gt; ds_new.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询ds</span></span><br><span class="line">k get ds -n kube-system</span><br><span class="line"><span class="comment"># 删除</span></span><br><span class="line">k delete ds -n kube-system ds1</span><br></pre></td></tr></table></figure><h3 id="job">job</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># job.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Job</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">job-demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">job-demo</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">counter</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;bin/sh&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;-c&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;for i in 9 8 7 6 5 4 3 2 1; do echo $i; done&quot;</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">k apply -f job.yaml</span><br><span class="line">k get <span class="built_in">jobs</span></span><br></pre></td></tr></table></figure><h3 id="cronjob–cj">cronjob–cj</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cronjob.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CronJob</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cronjob-demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">schedule:</span> <span class="string">&quot;*/1 * * * *&quot;</span></span><br><span class="line">  <span class="attr">jobTemplate:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">template:</span></span><br><span class="line">        <span class="attr">spec:</span></span><br><span class="line">          <span class="attr">restartPolicy:</span> <span class="string">OnFailure</span></span><br><span class="line">          <span class="attr">containers:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">hello</span></span><br><span class="line">            <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">            <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;bin/sh&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;-c&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;for i in 9 8 7 6 5 4 3 2 1; do echo $i; done&quot;</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">k apply -f cronjob.yaml</span><br><span class="line">k get cronjob -o wide</span><br><span class="line">k get job</span><br></pre></td></tr></table></figure><h3 id="statefulset–sts">statefulset–sts</h3><ul class="lvl-0"><li class="lvl-2"><p>sts的特性<br>● 稳定的、唯一的网络标识。<br>● 稳定的、持久化的存储。<br>● 有序的、优雅的部署和扩展。<br>● 有序的、优雅的删除和停止。</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># sts.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">&quot;nginx&quot;</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:1.9</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">web</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">k apply -f sts.yaml</span><br><span class="line">k get sts -owide</span><br></pre></td></tr></table></figure><h2 id="label标签">label标签</h2><ul class="lvl-0"><li class="lvl-2"><p>controller和service等都是基于标签选择器关联pod的，所以在指定label时一定要准确唯一</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 可以为任何资源设置标签</span></span><br><span class="line"><span class="comment"># k label 资源类型 资源名称 key=value</span></span><br><span class="line">k label deploy myngx app=<span class="built_in">test</span></span><br><span class="line"><span class="comment"># 查看标签</span></span><br><span class="line">k get deploy --show-labels</span><br><span class="line"><span class="comment"># 查看指定的标签值，标签会占用一列进行展示，多个标签使用逗号分隔，如果资源不存在该标签，则为空</span></span><br><span class="line">k get pod -L app,run</span><br><span class="line"><span class="comment"># 只列出给定标签和值的资源</span></span><br><span class="line">k get pod -l app=<span class="built_in">test</span></span><br></pre></td></tr></table></figure><h2 id="Configmap–cm">Configmap–cm</h2><ul class="lvl-0"><li class="lvl-2"><p>用来存储配置文件的 kubernetes 资源对象，配置内容都存储在 etcd 中</p></li><li class="lvl-2"><p>创建方法</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 通过直接在命令行中指定 configmap 参数创建，即--from-literal</span></span><br><span class="line">$ k create configmap config-map1 --from-literal=db.host=mysql.db --from-literal=db.port=<span class="string">&#x27;3306&#x27;</span></span><br><span class="line">$ k describe cm config-map1</span><br><span class="line">Name:         config-map1</span><br><span class="line">Namespace:    <span class="built_in">test</span></span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  &lt;none&gt;</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">db.host:</span><br><span class="line">----</span><br><span class="line">mysql.db</span><br><span class="line">db.port:</span><br><span class="line">----</span><br><span class="line">3306</span><br><span class="line"></span><br><span class="line">BinaryData</span><br><span class="line">====</span><br><span class="line"></span><br><span class="line">Events:  &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过指定文件创建，即将一个配置文件创建为一个 ConfigMap --from-file=&lt;文件&gt;</span></span><br><span class="line"><span class="comment"># 如果不指定key，则文件名称作为key</span></span><br><span class="line">$ vi configs/app.properties</span><br><span class="line">db.host mysql.db</span><br><span class="line">db.port 3306</span><br><span class="line"></span><br><span class="line">$ k create configmap config-map2 --from-file=key1=./configs/app.properties</span><br><span class="line">$ k describe cm config-map2</span><br><span class="line">Name:         config-map2</span><br><span class="line">Namespace:    <span class="built_in">test</span></span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  &lt;none&gt;</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">key1:</span><br><span class="line">----</span><br><span class="line">db.host mysql.db</span><br><span class="line">db.port 3306</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">BinaryData</span><br><span class="line">====</span><br><span class="line"></span><br><span class="line">Events:  &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过指定目录创建，即将一个目录下的所有配置文件创建为一个 ConfigMap，--from-file=&lt;目录&gt;</span></span><br><span class="line">$ k create configmap config-map3 --from-file=./configs</span><br><span class="line">$ k describe cm config-map3</span><br><span class="line">Name:         config-map3</span><br><span class="line">Namespace:    <span class="built_in">test</span></span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  &lt;none&gt;</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">app-copy.properties:</span><br><span class="line">----</span><br><span class="line">db.host mysql.db</span><br><span class="line">db.port 3306</span><br><span class="line"></span><br><span class="line">app.properties:</span><br><span class="line">----</span><br><span class="line">db.host mysql.db</span><br><span class="line">db.port 3306</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">BinaryData</span><br><span class="line">====</span><br><span class="line"></span><br><span class="line">Events:  &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 事先写好标准的 configmap 的 yaml 文件，然后 kubectl create -f 创建</span></span><br><span class="line">$ vim config-map4.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  db.host: mysql.db</span><br><span class="line">  db.port: <span class="string">&quot;3306&quot;</span> <span class="comment"># 数字一定要用双引号括起来</span></span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: config-map4</span><br><span class="line"></span><br><span class="line">$ k apply -f config-map4.yaml</span><br><span class="line">$ k describe cm config-map4</span><br><span class="line">Name:         config-map4</span><br><span class="line">Namespace:    <span class="built_in">test</span></span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  &lt;none&gt;</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">db.host:</span><br><span class="line">----</span><br><span class="line">mysql.db</span><br><span class="line">db.port:</span><br><span class="line">----</span><br><span class="line">3306</span><br><span class="line"></span><br><span class="line">BinaryData</span><br><span class="line">====</span><br><span class="line"></span><br><span class="line">Events:  &lt;none&gt;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>使用方法</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 通过环境变量使用</span></span><br><span class="line"><span class="comment"># 1.使用 valueFrom、configMapKeyRef、name、key 指定要用的 key:</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: app</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: app</span><br><span class="line">    image: centos</span><br><span class="line">    <span class="built_in">env</span>:</span><br><span class="line">    - name: DB_HOST  <span class="comment"># 环境变量名称</span></span><br><span class="line">      valueFrom:</span><br><span class="line">        configMapKeyRef:</span><br><span class="line">          name: config-map4 <span class="comment"># cm名称</span></span><br><span class="line">          key: db.host      <span class="comment"># cm中的key</span></span><br><span class="line"><span class="comment"># 2.通过 envFrom、configMapRef、name 使得 configmap 中的所有 key/value 对都自动变成环境变量</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: app</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: app</span><br><span class="line">    image: centos</span><br><span class="line">    envFrom:</span><br><span class="line">      configMapRef:</span><br><span class="line">        name: config-map4</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 在启动命令中引用</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: app</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: app</span><br><span class="line">    image: centos</span><br><span class="line">    <span class="built_in">command</span>: [<span class="string">&quot;/bin/sh&quot;</span>]</span><br><span class="line">    args: [<span class="string">&quot;-c&quot;</span>, <span class="string">&quot;while true; do echo <span class="subst">$(DB_HOST)</span> <span class="subst">$(DB_PORT)</span> &gt;&gt; /out.txt; sleep 5; done&quot;</span>]</span><br><span class="line">    <span class="built_in">env</span>:</span><br><span class="line">    - name: DB_HOST</span><br><span class="line">      valueFrom:</span><br><span class="line">        configMapKeyRef:</span><br><span class="line">          name: config-map4</span><br><span class="line">          key: db.host</span><br><span class="line">    - name: DB_PORT</span><br><span class="line">      valueFrom:</span><br><span class="line">        configMapKeyRef:</span><br><span class="line">          name: config-map4</span><br><span class="line">          key: db.port</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 作为 volume 挂载使用</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: app</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: app</span><br><span class="line">    image: centos</span><br><span class="line">    <span class="built_in">command</span>: [<span class="string">&quot;/bin/sh&quot;</span>]</span><br><span class="line">    args: [<span class="string">&quot;-c&quot;</span>, <span class="string">&quot;while true; do cat /tmp/config.properties &gt;&gt; /out.txt; sleep 5; done&quot;</span>]</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: config-map3</span><br><span class="line">      mountPath: /tmp/config.properties <span class="comment"># 挂载到的文件</span></span><br><span class="line">      subPath: app.properties  <span class="comment"># 被挂载的文件，即cm中的多个文件中的一个</span></span><br><span class="line">  volumes:</span><br><span class="line">  - name: config-map3</span><br><span class="line">    configMap:</span><br><span class="line">      name: config-map3</span><br></pre></td></tr></table></figure><h2 id="Secrets">Secrets</h2><ul class="lvl-0"><li class="lvl-2"><p>Secret 解决了密码、token、密钥等敏感数据的配置问题，而不需要把这些敏感数据暴露到镜像或者 Pod Spec 中。</p></li><li class="lvl-2"><p>Secret 可以以 Volume 或者环境变量的方式使用。</p></li></ul><h3 id="Secrets-类型">Secrets 类型</h3><ul class="lvl-0"><li class="lvl-2"><p>创建 Secret 时，你可以使用 Secret 资源的 type 字段，或者与其等价的 kubectl 命令行参数（如果有的话）为其设置类型。</p></li><li class="lvl-2"><p>Kubernetes 提供若干种内置的类型，用于一些常见的使用场景。 针对这些类型，Kubernetes 所执行的合法性检查操作以及对其所实施的限制各不相同。</p></li></ul><table><thead><tr><th>内置类型</th><th>用法</th></tr></thead><tbody><tr><td><code>Opaque</code></td><td>用户定义的任意数据</td></tr><tr><td><code>kubernetes.io/service-account-token</code></td><td>服务账号令牌</td></tr><tr><td><code>kubernetes.io/dockercfg</code></td><td>~/.dockercfg 文件的序列化形式</td></tr><tr><td><code>kubernetes.io/dockerconfigjson</code></td><td>~/.docker/config.json 文件的序列化形式</td></tr><tr><td><code>kubernetes.io/basic-auth</code></td><td>用于基本身份认证的凭据</td></tr><tr><td><code>kubernetes.io/ssh-auth</code></td><td>用于 SSH 身份认证的凭据</td></tr><tr><td><code>kubernetes.io/tls</code></td><td>用于 TLS 客户端或者服务器端的数据</td></tr><tr><td><code>bootstrap.kubernetes.io/token</code></td><td>启动引导令牌数据</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>通过为 Secret 对象的 type 字段设置一个非空的字符串值，你也可以定义并使用自己 Secret 类型（如果 type 值为空字符串，则被视为 Opaque 类型）。</p></li><li class="lvl-2"><p>关于Secret类型的进一步说请查看<a href="https://kubernetes.io/zh-cn/docs/concepts/configuration/secret/">https://kubernetes.io/zh-cn/docs/concepts/configuration/secret/</a>，以下示例仅对常用的<code>Opaque</code>进行说明。</p></li></ul><h3 id="创建-Secret">创建 Secret</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置文件创建</span></span><br><span class="line">$ <span class="built_in">echo</span> -n <span class="string">&#x27;my-app&#x27;</span> | <span class="built_in">base64</span></span><br><span class="line">bXktYXBw</span><br><span class="line">$ <span class="built_in">echo</span> -n <span class="string">&#x27;39528$vdg7Jb&#x27;</span> | <span class="built_in">base64</span></span><br><span class="line">Mzk1MjgkdmRnN0pi</span><br><span class="line"><span class="comment"># 配置文件</span></span><br><span class="line"><span class="comment"># secret.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  name: test-secret</span><br><span class="line">data:</span><br><span class="line">  username: bXktYXBw  <span class="comment"># value必须是警告base64加密后的值</span></span><br><span class="line">  password: Mzk1MjgkdmRnN0pi</span><br><span class="line"></span><br><span class="line">$ k apply -f secret.yaml</span><br><span class="line">$ k describe secrets test-secret</span><br><span class="line">Name:         test-secret</span><br><span class="line">Namespace:    <span class="built_in">test</span></span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  &lt;none&gt;</span><br><span class="line"></span><br><span class="line">Type:  Opaque</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">username:  6 bytes</span><br><span class="line">password:  12 bytes</span><br><span class="line"></span><br><span class="line"><span class="comment"># 命令行创建，此时明文创建即可</span></span><br><span class="line">$ kubectl create secret generic test-secret2 --from-literal=<span class="string">&#x27;username=my-app&#x27;</span> --from-literal=<span class="string">&#x27;password=39528$vdg7Jb&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 文件创建</span></span><br><span class="line">$ kubectl create secret generic ssh-key-secret --from-file=ssh-privatekey=/path/to/.ssh/id_rsa --from-file=ssh-publickey=/path/to/.ssh/id_rsa.pub</span><br></pre></td></tr></table></figure><h3 id="使用-Secret">使用 Secret</h3><ul class="lvl-0"><li class="lvl-2"><p>创建一个可以通过卷访问 Secret 数据的 Pod</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># secret-pod.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: secret-test-pod</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">    - name: test-container</span><br><span class="line">      image: nginx</span><br><span class="line">      volumeMounts:</span><br><span class="line">        <span class="comment"># name 必须与下面的卷名匹配</span></span><br><span class="line">        - name: secret-volume</span><br><span class="line">          mountPath: /etc/secret-volume</span><br><span class="line">          readOnly: <span class="literal">true</span></span><br><span class="line">  <span class="comment"># Secret 数据通过一个卷暴露给该 Pod 中的容器</span></span><br><span class="line">  volumes:</span><br><span class="line">    - name: secret-volume</span><br><span class="line">      secret:</span><br><span class="line">        secretName: test-secret</span><br><span class="line"></span><br><span class="line">$ k apply -f secret-pod.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出包含两个文件，每个对应一个 Secret 数据条目</span></span><br><span class="line">$ kubectl <span class="built_in">exec</span> -i -t secret-test-pod -- <span class="built_in">ls</span> /etc/secret-volume</span><br><span class="line">password  username</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>映射 Secret 键到特定文件路径</p><ul class="lvl-2"><li class="lvl-6">来自 mysecret 的键 username 可以在路径 /etc/foo/my-group/my-username 下供容器使用，而不是路径 /etc/foo/username</li><li class="lvl-6">来自该 Secret 的键 password 没有映射到任何路径</li></ul></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: mypod</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: mypod</span><br><span class="line">    image: redis</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: foo</span><br><span class="line">      mountPath: <span class="string">&quot;/etc/foo&quot;</span></span><br><span class="line">      readOnly: <span class="literal">true</span></span><br><span class="line">  volumes:</span><br><span class="line">  - name: foo</span><br><span class="line">    secret:</span><br><span class="line">      secretName: mysecret</span><br><span class="line">      items:</span><br><span class="line">      - key: username</span><br><span class="line">        path: my-group/my-username</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>使用来自 Secret 中的数据定义容器变量</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ k create secret generic backend-user --from-literal=backend-username=<span class="string">&#x27;backend-admin&#x27;</span></span><br><span class="line"><span class="comment"># pod-single-secret-env-variable.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">  kind: Pod</span><br><span class="line">  metadata:</span><br><span class="line">    name: env-single-secret</span><br><span class="line">  spec:</span><br><span class="line">    containers:</span><br><span class="line">    - name: envars-test-container</span><br><span class="line">      image: nginx</span><br><span class="line">      <span class="built_in">env</span>:</span><br><span class="line">      - name: SECRET_USERNAME</span><br><span class="line">        valueFrom:</span><br><span class="line">          secretKeyRef:</span><br><span class="line">            name: backend-user</span><br><span class="line">            key: backend-username</span><br><span class="line">$ k apply -f pod-single-secret-env-variable.yaml</span><br><span class="line">$ k <span class="built_in">exec</span> -i -t env-single-secret -- /bin/sh -c <span class="string">&#x27;echo $SECRET_USERNAME&#x27;</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>将 Secret 中的所有键值偶对定义为环境变量</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ k create secret generic test-secret --from-literal=username=<span class="string">&#x27;my-app&#x27;</span> --from-literal=password=<span class="string">&#x27;39528$vdg7Jb&#x27;</span></span><br><span class="line"><span class="comment"># pod-secret-envFrom.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">  kind: Pod</span><br><span class="line">  metadata:</span><br><span class="line">    name: envfrom-secret</span><br><span class="line">  spec:</span><br><span class="line">    containers:</span><br><span class="line">    - name: envars-test-container</span><br><span class="line">      image: nginx</span><br><span class="line">      envFrom:</span><br><span class="line">      - secretRef:</span><br><span class="line">          name: test-secret</span><br><span class="line">$ k apply -f pod-secret-envFrom.yaml</span><br><span class="line">$ k <span class="built_in">exec</span> -i -t envfrom-secret -- /bin/sh -c <span class="string">&#x27;echo &quot;username: $username\npassword: $password\n&quot;&#x27;</span></span><br></pre></td></tr></table></figure><h2 id="service–svc">service–svc</h2><ul class="lvl-0"><li class="lvl-2"><p>svc负责解决端口映射的问题</p></li><li class="lvl-2"><p>Kubernetes ServiceTypes 允许指定你所需要的 Service 类型。</p></li><li class="lvl-2"><p>可用的 type 值及其行为有：</p><ul class="lvl-2"><li class="lvl-6">ClusterIP<br>通过集群的内部 IP 暴露服务，选择该值时服务只能够在集群内部访问。 这也是你没有为服务显式指定 type 时使用的默认值。 你可以使用 Ingress 或者 Gateway API 向公众暴露服务。</li><li class="lvl-6">NodePort<br>通过每个节点上的 IP 和静态端口（NodePort）暴露服务。 为了让节点端口可用，Kubernetes 设置了集群 IP 地址，这等同于你请求 type: ClusterIP 的服务。</li><li class="lvl-6">LoadBalancer<br>使用云提供商的负载均衡器向外部暴露服务。 Kubernetes 不直接提供负载均衡组件；你必须提供一个，或者将你的 Kubernetes 集群与云提供商集成。</li><li class="lvl-6">ExternalName<br>将服务映射到 externalName 字段的内容（例如，映射到主机名 api.foo.bar.example）。 该映射将集群的 DNS 服务器配置为返回具有该外部主机名值的 CNAME 记录。 无需创建任何类型代理。</li></ul></li></ul><h3 id="NodePort">NodePort</h3><ul class="lvl-0"><li class="lvl-2"><p>可以让 kubernetes 在其所在节点上保留一个端口（所有节点上都使用相同的端口号），然后将传入的连接转发给 pod</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># svc-nodeport.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">   <span class="attr">name:</span> <span class="string">svc-nodeport</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">   <span class="attr">ports:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-nginx</span></span><br><span class="line">     <span class="attr">port:</span> <span class="number">3080</span></span><br><span class="line">     <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">     <span class="attr">nodePort:</span> <span class="number">32115</span> <span class="comment"># 此处指定具体的端口，不能重复，如果没有配置则随机创建</span></span><br><span class="line">   <span class="attr">selector:</span></span><br><span class="line">     <span class="attr">app:</span> <span class="string">test-nginx</span></span><br><span class="line">   <span class="attr">type:</span> <span class="string">NodePort</span></span><br></pre></td></tr></table></figure><h3 id="ClusterIP">ClusterIP</h3><ul class="lvl-0"><li class="lvl-2"><p>提供虚拟ip</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 基于delpoyment创建service</span></span><br><span class="line">k expose deployment test-nginx --name svc-cluster-ip --port=3280 --target-port=80 --<span class="built_in">type</span>=ClusterIP</span><br><span class="line"><span class="comment"># 不创建，只生成yaml文件</span></span><br><span class="line">k expose deployment test-nginx --name svc-cluster-ip --port=3280 --target-port=80 --<span class="built_in">type</span>=ClusterIP --dry-run=client -o yaml &gt; svc-cluster-ip.yaml</span><br><span class="line"><span class="comment"># 基于yaml创建service</span></span><br><span class="line">k apply -f svc-cluster-ip.yaml</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>Headless service clusterIP：基于statefulset创建service</p><ul class="lvl-2"><li class="lvl-6">不提供虚拟ip，而是返回具体的pod地址，并且基于如下规则查找：<br><code>$&#123;podName&#125;.$&#123;headlessServiceName即svcName&#125;.$&#123;namespace&#125;.$&#123;clusterDomainName&#125;</code>，<br>同一个namespace的pod访问时一般指定到${headlessServiceName}即可，跨namespace时需要指定到${namespace}</li></ul></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># svc-sts-web.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span> <span class="comment"># 这里必须设置为None</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure><h3 id="LoadBalancer">LoadBalancer</h3><ul class="lvl-0"><li class="lvl-2"><p>相比 NodePort 方式可以通过任何节点的 指定 端口访问内部的 pod，LoadBalancer 方式拥有自己独一无二的可公开访问的 IP 地址；</p></li><li class="lvl-2"><p>LoadBalance 其实是 NodePort 的一种扩展，使得服务可以通过一个专用的负载均衡器来访问。</p></li><li class="lvl-2"><p>如果是自建k8s，Kubernetes 没 有 为 裸 机 集 群 提 供 网 络 负 载 平 衡 器 的 实 现，所以需要安装一个LoadBalancer，比如 MetaLb 负载均衡，这里不做赘述。</p></li><li class="lvl-2"><p>EKS<a href="/2023/07/07/aws-eks07-loadbalancer/" title="AWS-EKS-07--安装 AWS Load Balancer Controller 附加组件">安装 AWS Load Balancer Controller 附加组件</a>后即可提供支持。</p></li></ul><h3 id="可以基于pod直接创建svc">可以基于pod直接创建svc</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动一个pod，默认的label是 run=nginx-app</span></span><br><span class="line">kubectl run nginx-app --image=nginx --restart=Never --port=80</span><br><span class="line"><span class="comment"># 为pod添加标签</span></span><br><span class="line">k label pod nginx-app app=nginx-app</span><br><span class="line"><span class="comment"># 创建一个svc的yaml文件，其selector为app: nginx-app，这里没有指定nodePort，创建时会随机分配一个端口</span></span><br><span class="line"><span class="comment"># 也可以修改生成的yaml文件，使其符合要求</span></span><br><span class="line">kubectl create svc nodeport nginx-app --tcp=80:80 --dry-run -o yaml &gt; svc_pod.yaml</span><br><span class="line">k apply -f svc_pod.yaml</span><br></pre></td></tr></table></figure><h3 id="查看svc">查看svc</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看svc，注意查看TYPE，CLUSTER-IP ，EXTERNAL-IP，PORT显示的不同之处</span></span><br><span class="line">&gt; k get svc -o wide</span><br><span class="line">NAME                    TYPE           CLUSTER-IP       EXTERNAL-IP                                                               PORT(S)          AGE    SELECTOR</span><br><span class="line">nginx                   ClusterIP      None             &lt;none&gt;                                                                    80/TCP           130m   app=nginx</span><br><span class="line">svc-loadbalance-nginx   LoadBalancer   172.20.57.83     aa39ab20daad5447da7ee7d283ab2a83-1210832584.ap-east-1.elb.amazonaws.com   3081:32116/TCP   10m    app=test-nginx</span><br><span class="line">svc-test-nginx          NodePort       172.20.39.12     &lt;none&gt;                                                                    3080:32115/TCP   18h    app=test-nginx</span><br><span class="line">test-loadbalancer-new   LoadBalancer   172.20.242.126   a2774e4dc02ad42cc97c54fc9968624b-882652598.ap-east-1.elb.amazonaws.com    3282:31212/TCP   10s    app=test-nginx</span><br><span class="line">test-nginx-new          ClusterIP      172.20.144.96    &lt;none&gt;                                                                    3280/TCP         162m   app=test-nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看endpoint--ep</span></span><br><span class="line">k get endpoints</span><br><span class="line">&gt; k get ep</span><br><span class="line">NAME                    ENDPOINTS                                            AGE</span><br><span class="line">nginx                   10.25.113.205:80,10.25.142.172:80,10.25.148.165:80   132m</span><br><span class="line">svc-loadbalance-nginx   10.25.116.40:80,10.25.121.198:80,10.25.122.75:80     12m</span><br><span class="line">svc-test-nginx          10.25.116.40:80,10.25.121.198:80,10.25.122.75:80     18h</span><br><span class="line">test-loadbalancer-new   10.25.116.40:80,10.25.121.198:80,10.25.122.75:80     2m11s</span><br><span class="line">test-nginx-new          10.25.116.40:80,10.25.121.198:80,10.25.122.75:80     164m</span><br></pre></td></tr></table></figure><h2 id="Ingress">Ingress</h2><ul class="lvl-0"><li class="lvl-2"><p>Ingress将来自集群外部的 HTTP 和 HTTPS 路由暴露给集群 内的服务。流量路由由 Ingress 资源上定义的规则控制。</p></li><li class="lvl-2"><p>私有k8s不提供Ingress，需要自行安装。</p></li><li class="lvl-2"><p>基于aws-eks等云服务通过<a href="/2023/07/07/aws-eks07-loadbalancer/" title="AWS-EKS-07--安装 AWS Load Balancer Controller 附加组件">安装 AWS Load Balancer Controller 附加组件</a>提供Ingress功能。</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">k get ing</span><br><span class="line">k get ing -A</span><br><span class="line">k get ing -n <span class="built_in">test</span></span><br></pre></td></tr></table></figure><h2 id="HPA：Horizontal-Pod-Autoscaler-自动弹性伸缩">HPA：Horizontal Pod Autoscaler 自动弹性伸缩</h2><ul class="lvl-0"><li class="lvl-2"><p>实现hpa的前提是k8s集群中<a href="/2023/07/07/aws-eks11-metrics/" title="AWS-EKS-11--安装 Kubernetes Metrics Server">部署 metrics-server</a>，其可对node和pod占用CPU、内存的情况进行监控。</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 基于deployment创建hpa</span></span><br><span class="line">k autoscale deployment test-nginx --max=3 --min=1 --cpu-percent=60</span><br><span class="line"><span class="comment"># 最多3个pod，最少1个pod，基于cpu使用情况，超过60%时进行扩容</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看hpa</span></span><br><span class="line">k get hpa</span><br></pre></td></tr></table></figure><h2 id="其它命令">其它命令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入pod</span></span><br><span class="line">k <span class="built_in">exec</span> podName -it -- sh</span><br><span class="line">k <span class="built_in">exec</span> podName -it -- /bin/bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 监视变化 -w</span></span><br><span class="line">k get deploy -w</span><br><span class="line"></span><br><span class="line"><span class="comment"># 不显示标题头 --no-headers=true</span></span><br><span class="line">k get pods --no-headers=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看pod的日志输出</span></span><br><span class="line">k logs podName</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编辑一个资源，直接编辑已经部署的资源yaml</span></span><br><span class="line">k edit deploy app</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看一个资源的部署情况</span></span><br><span class="line">k describe deploy app</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;!--
 **加粗**
 *斜体*
 ***加粗并斜体***
 ~~删除线~~
 ==突出显示==
 `突出显示(推荐)`
 ++下划线++
 ~下标~
 ^上标^
 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.
 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600)

 +++ **点击折叠**
 这是被隐藏的内容
 +++

::: tips success warning danger
这里是容器内的内容
:::

% note info % success warning danger
这里是容器内的内容
% endnote %

 --&gt;
&lt;h2 id=&quot;摘要&quot;&gt;摘要&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;本文介绍kubectl命令的使用方法&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;参考资料：&lt;/p&gt;
&lt;ul class=&quot;lvl-2&quot;&gt;
&lt;li class=&quot;lvl-6&quot;&gt;&lt;a href=&quot;https://docs.aws.amazon.com/zh_cn/eks/latest/userguide&quot;&gt;Amazon EKS用户指南&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-6&quot;&gt;&lt;a href=&quot;https://kubernetes.io/zh-cn/docs/home/&quot;&gt;Kubernetes 文档&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="技术" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="aws" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/aws/"/>
    
    <category term="eks" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/aws/eks/"/>
    
    
    <category term="java" scheme="https://blog.hanqunfeng.com/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>AWS-EKS-12--部署 Dashboard UI</title>
    <link href="https://blog.hanqunfeng.com/2023/07/07/aws-eks12-dashboard/"/>
    <id>https://blog.hanqunfeng.com/2023/07/07/aws-eks12-dashboard/</id>
    <published>2023-07-07T15:30:05.000Z</published>
    <updated>2023-07-14T03:32:39.624Z</updated>
    
    <content type="html"><![CDATA[<!-- **加粗** *斜体* ***加粗并斜体*** ~~删除线~~ ==突出显示== `突出显示(推荐)` ++下划线++ ~下标~ ^上标^ 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference. 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600) +++ **点击折叠** 这是被隐藏的内容 +++::: tips success warning danger这里是容器内的内容:::% note info % success warning danger这里是容器内的内容% endnote % --><h2 id="摘要">摘要</h2><ul class="lvl-0"><li class="lvl-2"><p>本文介绍为EKS集群部署 Dashboard UI</p></li><li class="lvl-2"><p>参考资料：</p><ul class="lvl-2"><li class="lvl-6"><a href="https://docs.aws.amazon.com/zh_cn/eks/latest/userguide">Amazon EKS用户指南</a></li><li class="lvl-6"><a href="https://kubernetes.io/zh-cn/docs/home/">Kubernetes 文档</a></li></ul></li></ul><span id="more"></span><h2 id="部署-Dashboard-UI">部署 Dashboard UI</h2><ul class="lvl-0"><li class="lvl-2"><p><a href="https://kubernetes.io/zh-cn/docs/tasks/access-application-cluster/web-ui-dashboard/">官方文档</a></p></li><li class="lvl-2"><p>部署服务</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.7.0/aio/deploy/recommended.yaml</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>创建用户</p><ul class="lvl-2"><li class="lvl-6">Dashboard 支持使用 Bearer 令牌登录。</li><li class="lvl-6"><a href="https://github.com/kubernetes/dashboard/blob/master/docs/user/access-control/creating-sample-user.md">创建用户</a></li></ul></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># dashboard-adminuser.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">admin-user</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">admin-user</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-admin</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">admin-user</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>授权</p><ul class="lvl-2"><li class="lvl-4">这里创建一个 sa <code>admin-user</code>和 ClusterRoleBinding <code>admin-user</code>，利用 ClusterRoleBinding 赋予 sa 访问集群的 admin 权限</li></ul></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 向dashboard的服务帐户授予管理员权限</span></span><br><span class="line">$ k apply -f dashboard-adminuser.yaml</span><br><span class="line">serviceaccount/admin-user created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/admin-user created</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>获取登录令牌<br><em><strong>k8s-1.24后就不再为ServiceAccout提供默认的无到期时间的Secret了，而是需要获取有效期为3600秒的token</strong></em></p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获取登录令牌，这就是一个JWT，可以在 https://jwt.io 中查看解析后的内容</span></span><br><span class="line">$ kubectl -n kubernetes-dashboard create token admin-user</span><br><span class="line">eyJhbGciOiJSUzI1NiIsImtpZCI6IjgzMWNkMmM1YTE0YWYzZmYzZWU1MzQwYWIxZWRmNmRjN2Q3ZmI1NGQifQ.eyJhdWQiOlsiaHR0cHM6Ly9rdWJlcm5ldGVzLmRlZmF1bHQuc3ZjIl0sImV4cCI6MTY4OTMwNjUyMSwiaWF0IjoxNjg5MzAyOTIxLCJpc3MiOiJodHRwczovL29pZGMuZWtzLnVzLXdlc3QtMi5hbCIsInNlcnZpY2VhY2NvdW50Ijp7Im5hbWUiOiJhZG1pbi11c2VyIiwidWlkIjoiNDdiZGE0MmQtYTc3YS00NzUzLTg3NjItOTZmNmFmODA3ODI2In19LCJuYmYiOjE2ODkzMDI5MjEsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlcm5ldGVzLWRhc2hib2FyZDphZG1pbi11c2VyIn0.fELZiBXQfh2Mn0h8EHbb6BjDSCvHvB2cUDPenbwgMuKIE2NY-pHJdWA0ydZZYGM1aGg2TN0CHZQSMCEAyD3xqXzJF12dThlgVIAXWUWB_PK5_OQ9FSEHJuY2pSvnS0yhtRirbhJFzovYuxymFZjnZWuAJiPlt9k4DCp7rSIIZu89TRzwAlKh_SEnjCMaV4Fvy_Eq7eAxaXHPtatYLrz7vO12vZSA</span><br><span class="line"></span><br><span class="line"><span class="comment"># 令牌有效期为3600秒，到期后需要重启获取令牌并重新登录。这点不是很方便。加上 -o yaml 即可看到过期时间</span></span><br><span class="line">$ kubectl -n kubernetes-dashboard create token admin-user -o yaml</span><br><span class="line">apiVersion: authentication.k8s.io/v1</span><br><span class="line">kind: TokenRequest</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: <span class="string">&quot;2023-07-07T02:48:41Z&quot;</span></span><br><span class="line">  name: admin-user</span><br><span class="line">  namespace: kubernetes-dashboard</span><br><span class="line">spec:</span><br><span class="line">  audiences:</span><br><span class="line">  - https://kubernetes.default.svc</span><br><span class="line">  boundObjectRef: null</span><br><span class="line">  expirationSeconds: 3600</span><br><span class="line">status:</span><br><span class="line">  expirationTimestamp: <span class="string">&quot;2023-07-07T03:48:41Z&quot;</span></span><br><span class="line">  token: eyJhbGciOiJSUzI1NiIsImtpZCI6IjgzMWNkMmM1YTE0YWYzZmYzZWU1MzQwYWIxZWRmNmRjN2Q3ZmI1NGQifQ.eyJhdWQiOlsiaHR0cHM6Ly9rdWJlcm5ldGVzLmRlZmF1bHQuc3ZjIl0sImV4cCI6MTY4OTMwNjUyMSwiaWF0IjoxNjg5MzAyOTIxLCJpc3MiOiJodHRwczovL29pZGMuZWtzLnVzLXdlc3QtMi5hbCIsInNlcnZpY2VhY2NvdW50Ijp7Im5hbWUiOiJhZG1pbi11c2VyIiwidWlkIjoiNDdiZGE0MmQtYTc3YS00NzUzLTg3NjItOTZmNmFmODA3ODI2In19LCJuYmYiOjE2ODkzMDI5MjEsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlcm5ldGVzLWRhc2hib2FyZDphZG1pbi11c2VyIn0.fELZiBXQfh2Mn0h8EHbb6BjDSCvHvB2cUDPenbwgMuKIE2NY-pHJdWA0ydZZYGM1aGg2TN0CHZQSMCEAyD3xqXzJF12dThlgVIAXWUWB_PK5_OQ9FSEHJuY2pSvnS0yhtRirbhJFzovYuxymFZjnZWuAJiPlt9k4DCp7rSIIZu89TRzwAlKh_SEnjCMaV4Fvy_Eq7eAxaXHPtatYLrz7vO12vZSA</span><br></pre></td></tr></table></figure><h2 id="访问Dashboard">访问Dashboard</h2><ul class="lvl-0"><li class="lvl-2"><p>查看Dashboard 的 service，可以看到 Dashboard 的 Service 的类型都是 ClusterIP，所以我们是无法从外部访问到 Dashboard 的。</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get svc -n kubernetes-dashboard</span><br><span class="line">NAME                        TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">dashboard-metrics-scraper   ClusterIP   10.100.76.198   &lt;none&gt;        8000/TCP   12m</span><br><span class="line">kubernetes-dashboard        ClusterIP   10.100.171.79   &lt;none&gt;        443/TCP    12m</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>这时我们有两种方法访问 Dashboard</p><ul class="lvl-2"><li class="lvl-4">把 Dashboard 映射到本地</li><li class="lvl-4">利用 ingress 和 ALB 把外部请求转发到 Dashboard</li></ul></li></ul><h3 id="把-Dashboard-映射到本地">把 Dashboard 映射到本地</h3><ul class="lvl-0"><li class="lvl-2"><p>我们可以用 kubectl proxy，也可以用 port-forward</p></li></ul><h4 id="利用-kubectl-proxy">利用 kubectl proxy</h4><ul class="lvl-0"><li class="lvl-2"><p>开启代理</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 默认8001端口</span></span><br><span class="line">~ kubectl proxy</span><br><span class="line">Starting to serve on 127.0.0.1:8001</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定端口</span></span><br><span class="line">~ kubectl proxy --port 8888</span><br><span class="line">Starting to serve on 127.0.0.1:8888</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭代理</span></span><br><span class="line">Ctrl+C</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>本地访问</p><ul class="lvl-2"><li class="lvl-6">可以通过 <a href="http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/">http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/</a> 访问。</li><li class="lvl-6">登录时选择token登录，输入上面获取到的令牌即可，令牌有效期为3600秒，到期后需要重启获取令牌并重新登录。</li></ul></li></ul><p><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/IDKZ0Z.jpg" alt="" width="1200" height="700"></p><h4 id="利用-kubectl-port-forward">利用 kubectl port-forward</h4><ul class="lvl-0"><li class="lvl-2"><p>上面利用 kubectl proxy的方法是把整个 apiserver 通过 proxy 映射到本地，下面我们只把 dashboard 的 deployment(Pod)映射到本地。</p></li><li class="lvl-2"><p>首先，我们先要获得 Pod 的访问端口</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get ep -n kubernetes-dashboard</span><br><span class="line">NAME                        ENDPOINTS             AGE</span><br><span class="line">dashboard-metrics-scraper   192.168.10.200:8000   5d4h</span><br><span class="line">kubernetes-dashboard        192.168.20.125:8443   5d4h</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-4"><p>说明：kubernetes-dashboard 对应的 ENDPOINTS 就是pod的ip和端口，这里开启的就是pod的8443端口。</p></li></ul><ul class="lvl-0"><li class="lvl-2"><p>运行以下命令获得 Dashboard deployment 的 name</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get deployment -n kubernetes-dashboard</span><br><span class="line">NAME                        READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">dashboard-metrics-scraper   1/1     1            1           5d4h</span><br><span class="line">kubernetes-dashboard        1/1     1            1           5d4h</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-4"><p>说明：kubernetes-dashboard 是 Deployment 的名称</p></li></ul><ul class="lvl-0"><li class="lvl-2"><p>开启本地端口映射，这里映射到本地的8888端口</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl port-forward deployment/kubernetes-dashboard -n kubernetes-dashboard 8888:8443</span><br><span class="line">Forwarding from 127.0.0.1:8888 -&gt; 8443</span><br><span class="line">Forwarding from [::1]:8888 -&gt; 8443</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-4"><p>可以通过 <a href="https://localhost:8888/#/login">https://localhost:8888/#/login</a> 访问。</p></li><li class="lvl-4"><p>登录时选择token登录，输入上面获取到的令牌即可，令牌有效期为3600秒，到期后需要重启获取令牌并重新登录。</p></li></ul><h3 id="利用-ingress-和-ALB-把外部请求转发到-Dashboard">利用 ingress 和 ALB 把外部请求转发到 Dashboard</h3><ul class="lvl-0"><li class="lvl-2"><p>proxy，port-forward 可以把 apiserver 或者某个 deployment 映射到本地，这对调试一些应用来说很有用处。</p></li><li class="lvl-2"><p>不过，这两个都是前台命令，每次查看 Dashboard 都要先运行一下，使用起来确实不方便，下面介绍如何利用 ALB 访问 Dashboard。</p></li><li class="lvl-2"><p>前面我们已经介绍过<a href="/2023/07/07/aws-eks09-service-ingress/" title="AWS-EKS-09--创建基于LoadBalancer的service和ingress">创建基于LoadBalancer的service和ingress</a>，接下来我们就在此基础上完成后续的步骤。</p></li></ul><h4 id="创建ingress">创建ingress</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># dashboard-ingress.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dashboard</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">alb.ingress.kubernetes.io/actions.ssl-redirect:</span> <span class="string">&#x27;&#123;&quot;Type&quot;: &quot;redirect&quot;, &quot;RedirectConfig&quot;:&#123; &quot;Protocol&quot;: &quot;HTTPS&quot;, &quot;Port&quot;: &quot;443&quot;, &quot;StatusCode&quot;: &quot;HTTP_301&quot;&#125;&#125;&#x27;</span>  <span class="comment"># http重定向到https</span></span><br><span class="line">    <span class="attr">alb.ingress.kubernetes.io/certificate-arn:</span> <span class="string">arn:aws:acm:us-west-2:743263909655:certificate/e2e3fa54-98ab-427a-9f09-4861122831323e</span> <span class="comment"># https证书，就是上面创建的证书的arn</span></span><br><span class="line">    <span class="attr">alb.ingress.kubernetes.io/listen-ports:</span> <span class="string">&#x27;[&#123;&quot;HTTP&quot;: 80&#125;, &#123;&quot;HTTPS&quot;:443&#125;]&#x27;</span> <span class="comment"># 监听端口</span></span><br><span class="line">    <span class="attr">alb.ingress.kubernetes.io/scheme:</span> <span class="string">internet-facing</span> <span class="comment"># 开放外网访问</span></span><br><span class="line">    <span class="attr">alb.ingress.kubernetes.io/target-type:</span> <span class="string">ip</span></span><br><span class="line">    <span class="attr">alb.ingress.kubernetes.io/backend-protocol:</span> <span class="string">HTTPS</span> <span class="comment"># 转发请求用的协议，默认是HTTP</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">alb</span> <span class="comment"># 指定ingressclass类型，k8s-1.18及以后的版本推荐这种配置方式，旧版本需要在注释中加入 kubernetes.io/ingress.class: alb</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">dashboard.hanqunfeng.com</span> <span class="comment"># 域名绑定，需要到域名服务商处进行域名解析，CNAME到当前生成的elb</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span> <span class="comment"># 重定向配置，这里必须配置，否则不能实现重定向</span></span><br><span class="line">          <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">          <span class="attr">backend:</span></span><br><span class="line">            <span class="attr">service:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">ssl-redirect</span></span><br><span class="line">              <span class="attr">port:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">use-annotation</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">          <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">          <span class="attr">backend:</span></span><br><span class="line">            <span class="attr">service:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">              <span class="attr">port:</span></span><br><span class="line">                <span class="attr">number:</span> <span class="number">443</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-4"><p>这里要注意一点，一定要配置<code>alb.ingress.kubernetes.io/backend-protocol: HTTPS</code>，这是转发请求用的协议，默认是HTTP，但是Dashboard应用本身要求访问请求使用HTTPS，所以这里指定HTTPS。如果不指定，则在后面用浏览器访问Dashboard时会报下列错误</p></li></ul>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Client sent an HTTP request to an HTTPS server.</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 部署ingress</span></span><br><span class="line">$ k apply -f dashboard-ingress.yaml</span><br><span class="line">ingress.networking.k8s.io/dashboard created</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看ingress状态</span></span><br><span class="line">$ k describe ing -n kubernetes-dashboard dashboard</span><br><span class="line">Name:             dashboard</span><br><span class="line">Labels:           &lt;none&gt;</span><br><span class="line">Namespace:        kubernetes-dashboard</span><br><span class="line">Address:          k8s-kubernet-dashboar-043481379b-1952890389.us-west-2.elb.amazonaws.com</span><br><span class="line">Ingress Class:    alb</span><br><span class="line">Default backend:  &lt;default&gt;</span><br><span class="line">Rules:</span><br><span class="line">  Host                      Path  Backends</span><br><span class="line">  ----                      ----  --------</span><br><span class="line">  dashboard.hanqunfeng.com</span><br><span class="line">                            /   ssl-redirect:use-annotation (&lt;error: endpoints <span class="string">&quot;ssl-redirect&quot;</span> not found&gt;)</span><br><span class="line">                            /   kubernetes-dashboard:443 (192.168.20.125:8443)</span><br><span class="line">Annotations:                alb.ingress.kubernetes.io/actions.ssl-redirect:</span><br><span class="line">                              &#123;<span class="string">&quot;Type&quot;</span>: <span class="string">&quot;redirect&quot;</span>, <span class="string">&quot;RedirectConfig&quot;</span>:&#123; <span class="string">&quot;Protocol&quot;</span>: <span class="string">&quot;HTTPS&quot;</span>, <span class="string">&quot;Port&quot;</span>: <span class="string">&quot;443&quot;</span>, <span class="string">&quot;StatusCode&quot;</span>: <span class="string">&quot;HTTP_301&quot;</span>&#125;&#125;</span><br><span class="line">                            alb.ingress.kubernetes.io/backend-protocol: HTTPS</span><br><span class="line">                            alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:us-west-2:743263909655:certificate/e2e3fa54-98ab-427a-9f09-4861122831323e</span><br><span class="line">                            alb.ingress.kubernetes.io/listen-ports: [&#123;<span class="string">&quot;HTTP&quot;</span>: 80&#125;, &#123;<span class="string">&quot;HTTPS&quot;</span>:443&#125;]</span><br><span class="line">                            alb.ingress.kubernetes.io/scheme: internet-facing</span><br><span class="line">                            alb.ingress.kubernetes.io/target-type: ip</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason                  Age    From     Message</span><br><span class="line">  ----    ------                  ----   ----     -------</span><br><span class="line">  Normal  SuccessfullyReconciled  9m16s  ingress  Successfully reconciled</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>完成域名解析后可以访问：<a href="https://dashboard.hanqunfeng.com">https://dashboard.hanqunfeng.com</a></p></li></ul><h2 id="清理帐号">清理帐号</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 删除管理员ServiceAccount和ClusterRoleBinding</span></span><br><span class="line">$ kubectl -n kubernetes-dashboard delete serviceaccount admin-user</span><br><span class="line">$ kubectl -n kubernetes-dashboard delete clusterrolebinding admin-user</span><br></pre></td></tr></table></figure><h2 id="后记">后记</h2><p>这玩意就是查看资源方便一些，创建资源还是需要精通yaml。</p>]]></content>
    
    
    <summary type="html">&lt;!--
 **加粗**
 *斜体*
 ***加粗并斜体***
 ~~删除线~~
 ==突出显示==
 `突出显示(推荐)`
 ++下划线++
 ~下标~
 ^上标^
 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.
 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600)

 +++ **点击折叠**
 这是被隐藏的内容
 +++

::: tips success warning danger
这里是容器内的内容
:::

% note info % success warning danger
这里是容器内的内容
% endnote %

 --&gt;
&lt;h2 id=&quot;摘要&quot;&gt;摘要&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;本文介绍为EKS集群部署 Dashboard UI&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;参考资料：&lt;/p&gt;
&lt;ul class=&quot;lvl-2&quot;&gt;
&lt;li class=&quot;lvl-6&quot;&gt;&lt;a href=&quot;https://docs.aws.amazon.com/zh_cn/eks/latest/userguide&quot;&gt;Amazon EKS用户指南&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-6&quot;&gt;&lt;a href=&quot;https://kubernetes.io/zh-cn/docs/home/&quot;&gt;Kubernetes 文档&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="技术" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="aws" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/aws/"/>
    
    <category term="eks" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/aws/eks/"/>
    
    
    <category term="java" scheme="https://blog.hanqunfeng.com/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>AWS-EKS-11--安装 Kubernetes Metrics Server</title>
    <link href="https://blog.hanqunfeng.com/2023/07/07/aws-eks11-metrics/"/>
    <id>https://blog.hanqunfeng.com/2023/07/07/aws-eks11-metrics/</id>
    <published>2023-07-07T15:20:05.000Z</published>
    <updated>2023-07-07T08:34:58.885Z</updated>
    
    <content type="html"><![CDATA[<!-- **加粗** *斜体* ***加粗并斜体*** ~~删除线~~ ==突出显示== `突出显示(推荐)` ++下划线++ ~下标~ ^上标^ 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference. 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600) +++ **点击折叠** 这是被隐藏的内容 +++::: tips success warning danger这里是容器内的内容:::% note info % success warning danger这里是容器内的内容% endnote % --><h2 id="摘要">摘要</h2><ul class="lvl-0"><li class="lvl-2"><p>本文介绍为EKS集群安装 Kubernetes Metrics Server</p></li><li class="lvl-2"><p>参考资料：</p><ul class="lvl-2"><li class="lvl-6"><a href="https://docs.aws.amazon.com/zh_cn/eks/latest/userguide">Amazon EKS用户指南</a></li><li class="lvl-6"><a href="https://kubernetes.io/zh-cn/docs/home/">Kubernetes 文档</a></li></ul></li></ul><span id="more"></span><h2 id="安装-Kubernetes-Metrics-Server">安装 Kubernetes Metrics Server</h2><ul class="lvl-0"><li class="lvl-2"><p>Metrics Server是Kubernetes内置自动缩放管道的可扩展、高效的容器资源指标来源。</p></li><li class="lvl-2"><p>Metrics Server从Kubelets收集资源指标，并通过Metrics API在Kubernetes apiserver中公开它们，供Horizontal Pod Autoscaler和Vertical Pod Autoscaler使用。</p></li><li class="lvl-2"><p>指标API也可以通过kubectl top访问，从而更容易调试自动缩放管道。</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用以下命令部署 Metrics Server</span></span><br><span class="line">~ kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml</span><br><span class="line"><span class="comment"># 使用以下命令验证 metrics-server 部署是否运行所需数量的 Pods</span></span><br><span class="line">~ kubectl get deployment metrics-server -n kube-system</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看metrics-server的资源</span></span><br><span class="line">~ k get all -n kube-system -l k8s-app=metrics-server</span><br><span class="line">NAME                                  READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/metrics-server-55c774cdbb-6qpz8   1/1     Running   0          14h</span><br><span class="line"></span><br><span class="line">NAME                     TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">service/metrics-server   ClusterIP   10.100.231.92   &lt;none&gt;        443/TCP   43h</span><br><span class="line"></span><br><span class="line">NAME                             READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/metrics-server   1/1     1            1           43h</span><br><span class="line"></span><br><span class="line">NAME                                        DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/metrics-server-55c774cdbb   1         1         1       43h</span><br><span class="line"></span><br><span class="line"><span class="comment"># 自能查看node和pod的指标</span></span><br><span class="line">~ k top node</span><br><span class="line">NAME                                           CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%</span><br><span class="line">ip-192-168-16-155.us-west-2.compute.internal   29m          1%     544Mi           7%</span><br><span class="line">ip-192-168-48-14.us-west-2.compute.internal    32m          1%     569Mi           8%</span><br><span class="line"></span><br><span class="line">~ k top pod</span><br><span class="line">NAMESPACE     NAME                                  CPU(cores)   MEMORY(bytes)</span><br><span class="line">kube-system   aws-node-fzh9v                        3m           36Mi</span><br><span class="line">kube-system   aws-node-t62f8                        3m           36Mi</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;!--
 **加粗**
 *斜体*
 ***加粗并斜体***
 ~~删除线~~
 ==突出显示==
 `突出显示(推荐)`
 ++下划线++
 ~下标~
 ^上标^
 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.
 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600)

 +++ **点击折叠**
 这是被隐藏的内容
 +++

::: tips success warning danger
这里是容器内的内容
:::

% note info % success warning danger
这里是容器内的内容
% endnote %

 --&gt;
&lt;h2 id=&quot;摘要&quot;&gt;摘要&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;本文介绍为EKS集群安装 Kubernetes Metrics Server&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;参考资料：&lt;/p&gt;
&lt;ul class=&quot;lvl-2&quot;&gt;
&lt;li class=&quot;lvl-6&quot;&gt;&lt;a href=&quot;https://docs.aws.amazon.com/zh_cn/eks/latest/userguide&quot;&gt;Amazon EKS用户指南&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-6&quot;&gt;&lt;a href=&quot;https://kubernetes.io/zh-cn/docs/home/&quot;&gt;Kubernetes 文档&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="技术" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="aws" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/aws/"/>
    
    <category term="eks" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/aws/eks/"/>
    
    
    <category term="java" scheme="https://blog.hanqunfeng.com/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>AWS-EKS-10--EKS权限管理(上)向其他 IAM 用户授予权限</title>
    <link href="https://blog.hanqunfeng.com/2023/07/07/aws-eks10-iam-share/"/>
    <id>https://blog.hanqunfeng.com/2023/07/07/aws-eks10-iam-share/</id>
    <published>2023-07-07T15:10:05.000Z</published>
    <updated>2023-07-14T02:34:20.406Z</updated>
    
    <content type="html"><![CDATA[<!-- **加粗** *斜体* ***加粗并斜体*** ~~删除线~~ ==突出显示== `突出显示(推荐)` ++下划线++ ~下标~ ^上标^ 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference. 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600) +++ **点击折叠** 这是被隐藏的内容 +++::: tips success warning danger这里是容器内的内容:::% note info % success warning danger这里是容器内的内容% endnote % --><h2 id="摘要">摘要</h2><ul class="lvl-0"><li class="lvl-2"><p>本文介绍EKS集群如何向其他 IAM 用户授予权限</p></li><li class="lvl-2"><p>参考资料：</p><ul class="lvl-2"><li class="lvl-6"><a href="https://docs.aws.amazon.com/zh_cn/eks/latest/userguide">Amazon EKS用户指南</a></li><li class="lvl-6"><a href="https://kubernetes.io/zh-cn/docs/home/">Kubernetes 文档</a></li></ul></li></ul><span id="more"></span><h2 id="EKS权限管理">EKS权限管理</h2><ul class="lvl-0"><li class="lvl-2"><p>创建EKS集群后，默认只有创建集群的 IAM 主体可以访问并管理EKS集群，实际业务中，我们需要将EKS的全部或部分权限分配给指定的用户，就需要对该用户进行授权。</p></li><li class="lvl-2"><p>对于 AWS EKS 的权限管理，主要有以下三个方面内容</p><ul class="lvl-2"><li class="lvl-6">IAM 用户、Role 或者 Account 访问 EKS 相关资源。这里的资源是指 EKS 集群本身的 AWS 资源。比如，EKS 集群信息配置，EC2 节点等等，这里不包括 K8s 中的资源。这部分直接在AWS IAM中进行授权即可。</li><li class="lvl-6">IAM 用户、Role 或者 Account 访问 EKS K8s 资源，这里的资源是指 K8s 内部的资源，比如，K8s 内部的 service account、deployment、service 等等。本章重点讲这部分内容。</li><li class="lvl-6">K8s 内部 Pod 调用 AWS 的资源。比如，通过创建 Ingress 来创建 AWS ALB。这部分在<a href="/2023/07/13/aws-eks15-auth-pod/" title="AWS-EKS-15--EKS权限管理(下)Pod 是如何调用 AWS 资源的">EKS权限管理(下)Pod 是如何调用 AWS 资源的</a>中介绍。</li></ul></li><li class="lvl-2"><p>与IAM用户授权相关的是头两条，即要使 IAM 用户能够访问 EKS 集群本身的 AWS 资源，又要能够访问 K8s 内部的资源。</p></li></ul><h2 id="创建-IAM-用户并授权其访问EKS资源">创建 IAM 用户并授权其访问EKS资源</h2><ul class="lvl-0"><li class="lvl-2"><p>关于如何在IAM中创建用户并授予相应的策略属于<a href="https://docs.aws.amazon.com/zh_cn/IAM/latest/UserGuide/introduction.html">AWS IAM权限管理</a>的范畴，不是本文的重点，作者默认读者已掌握这些内容，重点理解用户、组、角色和策略之间的关系。读者也可以参考<a href="https://zhuanlan.zhihu.com/p/379235758">一文搞懂 AWS IAM 权限 基础篇上 理论</a></p></li><li class="lvl-2"><p>在AWS控制台中创建一个用户<code>ekstest</code>，为了保证最小权限原则，这里只为其分配一个内联策略(只针对关联用户)，同时为其创建访问密钥。注意必须为用户至少分配如下策略，以保证IAM用户有权限查看 EKS 集群，否则使用密钥无法通过命令行连通EKS。</p></li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;Version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2012-10-17&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;Statement&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;Sid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;VisualEditor0&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="string">&quot;eks:DescribeCluster&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;arn:aws:eks:us-west-2:743263909655:cluster/eks-lexing&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h2 id="向-IAM-用户授予访问K8s资源的权限">向 IAM 用户授予访问K8s资源的权限</h2><ul class="lvl-0"><li class="lvl-2"><p>创建集群的 IAM 主体是唯一可以访问集群的主体。向其他 IAM 主体授予权限，以便它们可以访问您的集群。</p></li><li class="lvl-2"><p>ConfigMap aws-auth 在我们向 EKS 添加 node 时就自动创建了，它的作用是允许 node 加入集群。</p></li><li class="lvl-2"><p>aws-auth 的另一个作用是控制 AWS 用户或者 role 访问 K8s 内部的资源（准确的说是把外部 IAM 用户与 K8s 内部用户做映射）。</p></li><li class="lvl-2"><p>现在 aws-auth 中只有一个 mapRoles，这里的 rolearn 就是我们之前创建EKS时自动创建的，为 EC2 提供权限。</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 通过eksctl查看 ConfigMap 中的aws-auth映射</span></span><br><span class="line">$ eksctl get iamidentitymapping --cluster eks-lexing --profile eks-us-west-2</span><br><span class="line">ARN                                                USERNAME                GROUPS                    ACCOUNT</span><br><span class="line">arn:aws:iam::743263909655:role/eksctl-eks-lexing-nodegroup-ng-4d-NodeInstanceRole-Y55EPJO9XYDG    system:node:&#123;&#123;EC2PrivateDNSName&#125;&#125;    system:bootstrappers,system:nodes</span><br><span class="line"></span><br><span class="line"><span class="comment"># 也可以通过kubectl查看configmap aws-auth</span></span><br><span class="line">$ kubectl describe configmap -n kube-system aws-auth</span><br><span class="line">Name:         aws-auth</span><br><span class="line">Namespace:    kube-system</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  &lt;none&gt;</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">mapRoles:</span><br><span class="line">----</span><br><span class="line">- <span class="built_in">groups</span>:</span><br><span class="line">  - system:bootstrappers</span><br><span class="line">  - system:nodes</span><br><span class="line">  rolearn: arn:aws:iam::743263909655:role/eksctl-eks-lexing-nodegroup-ng-4d-NodeInstanceRole-Y55EPJO9XYDG</span><br><span class="line">  username: system:node:&#123;&#123;EC2PrivateDNSName&#125;&#125;</span><br><span class="line"></span><br><span class="line">mapUsers:</span><br><span class="line">----</span><br><span class="line">[]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">BinaryData</span><br><span class="line">====</span><br><span class="line"></span><br><span class="line">Events:  &lt;none&gt;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>授权–1.角色与组绑定</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 所有命名空间中的 Kubernetes 资源，文件中的组名称为 eks-console-dashboard-full-access-group</span></span><br><span class="line">$ curl -O https://s3.us-west-2.amazonaws.com/amazon-eks/docs/eks-console-full-access.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 特定命名空间中的 Kubernetes 资源 - 此文件中的命名空间为 default，请依据需要修改命名空间名称。文件中的组名为 eks-console-dashboard-restricted-access-group</span></span><br><span class="line">$ curl -O https://s3.us-west-2.amazonaws.com/amazon-eks/docs/eks-console-restricted-access.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里以所有资源为例</span></span><br><span class="line">$ kubectl apply -f eks-console-full-access.yaml</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/eks-console-dashboard-full-access-clusterrole created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/eks-console-dashboard-full-access-binding created</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>查看上面的yaml文件，可以看到里面定义了<code>ClusterRole</code>和<code>ClusterRoleBinding</code>以及<code>Role</code>和<code>RoleBinding</code>，这是K8s中的 <code>RBAC(Role-based access control )</code> 授权模块中的4个对象:</p><ul class="lvl-2"><li class="lvl-6"><code>Role</code>：设置对 K8s 资源访问的具体权限，与某个 namesapce 相关联</li><li class="lvl-6"><code>ClusterRole</code>：与 <code>Role</code> 类似，区别是不与某个 namepsace 相关联，针对整个 Cluster</li><li class="lvl-6"><code>RoleBinding</code>：把<code>User|Group|ServiceAccount</code>和 <code>Role</code> 绑定，使其获得具体权限</li><li class="lvl-6"><code>ClusterRoleBinding</code>：与 <code>RoleBinding</code> 类似，把<code>User|Group|ServiceAccount</code>和<code>ClusterRole</code>绑定，区别是不与某个 namepsace 相关联</li></ul></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看集群角色及其绑定</span></span><br><span class="line">k get ClusterRole</span><br><span class="line">k get ClusterRoleBinding</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看角色及其绑定</span></span><br><span class="line">k get Role -A</span><br><span class="line">k get RoleBinding -A</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>授权–2.用户与组绑定</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 为用户添加映射，这里为用户 ekstest 添加权限策略</span></span><br><span class="line">$ eksctl create iamidentitymapping \</span><br><span class="line">    --cluster eks-lexing --profile eks-us-west-2 \</span><br><span class="line">    --arn arn:aws:iam::743263909655:user/ekstest \</span><br><span class="line">    --group eks-console-dashboard-full-access-group \</span><br><span class="line">    --no-duplicate-arns</span><br><span class="line">2023-07-05 16:28:51 [ℹ]  checking arn arn:aws:iam::743263909655:user/ekstest against entries <span class="keyword">in</span> the auth ConfigMap</span><br><span class="line">2023-07-05 16:28:51 [ℹ]  adding identity <span class="string">&quot;arn:aws:iam::743263909655:user/ekstest&quot;</span> to auth ConfigMap</span><br><span class="line"></span><br><span class="line"><span class="comment"># 再次通过eksctl查看 ConfigMap 中的aws-auth映射</span></span><br><span class="line">$ eksctl get iamidentitymapping --cluster eks-lexing --profile eks-us-west-2</span><br><span class="line">ARN                                                USERNAME                GROUPS                    ACCOUNT</span><br><span class="line">arn:aws:iam::743263909655:role/eksctl-eks-lexing-nodegroup-ng-4d-NodeInstanceRole-Y55EPJO9XYDG    system:node:&#123;&#123;EC2PrivateDNSName&#125;&#125;    system:bootstrappers,system:nodes</span><br><span class="line">arn:aws:iam::743263909655:user/ekstest                                                    eks-console-dashboard-full-access-group</span><br><span class="line"></span><br><span class="line"><span class="comment"># 也可以通过kubectl再次查看configmap aws-auth</span></span><br><span class="line"><span class="comment"># 实际上直接编辑也可以: kubectl edit configmap -n kube-system aws-auth</span></span><br><span class="line">$ kubectl describe configmap -n kube-system aws-auth</span><br><span class="line">Name:         aws-auth</span><br><span class="line">Namespace:    kube-system</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  &lt;none&gt;</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">mapRoles:</span><br><span class="line">----</span><br><span class="line">- <span class="built_in">groups</span>:</span><br><span class="line">  - system:bootstrappers</span><br><span class="line">  - system:nodes</span><br><span class="line">  rolearn: arn:aws:iam::743263909655:role/eksctl-eks-lexing-nodegroup-ng-4d-NodeInstanceRole-Y55EPJO9XYDG</span><br><span class="line">  username: system:node:&#123;&#123;EC2PrivateDNSName&#125;&#125;</span><br><span class="line"></span><br><span class="line">mapUsers:</span><br><span class="line">----</span><br><span class="line">- <span class="built_in">groups</span>:</span><br><span class="line">  - eks-console-dashboard-full-access-group</span><br><span class="line">  userarn: arn:aws:iam::743263909655:user/ekstest</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">BinaryData</span><br><span class="line">====</span><br><span class="line"></span><br><span class="line">Events:  &lt;none&gt;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>此时使用 ekstest 的访问密钥就可以通过命令行访问eks了</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置aws访问密钥</span></span><br><span class="line">$ aws configure --profile ekstest</span><br><span class="line">AWS Access Key ID [None]: AKIA22DP3</span><br><span class="line">AWS Secret Access Key [None]: 9ajQeyy/AiaAC0n1</span><br><span class="line">Default region name [None]: us-west-2</span><br><span class="line">Default output format [None]: json</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新 ~/.kube/config</span></span><br><span class="line">$ <span class="built_in">export</span> AWS_PROFILE=ekstest</span><br><span class="line">$ aws eks update-kubeconfig --name eks-lexing</span><br><span class="line">Added new context arn:aws:eks:us-west-2:743263909655:cluster/eks-lexing to /Users/hanqf/.kube/config</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试命令</span></span><br><span class="line">$ k get node</span><br><span class="line">NAME                                           STATUS   ROLES    AGE   VERSION</span><br><span class="line">ip-192-168-16-155.us-west-2.compute.internal   Ready    &lt;none&gt;   13d   v1.26.4-eks-0a21954</span><br><span class="line">ip-192-168-48-14.us-west-2.compute.internal    Ready    &lt;none&gt;   13d   v1.26.4-eks-0a21954</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>此时 ekstest 还不能通过aws控制台中访问eks资源，还需要为其在IAM中授予必要的EKS策略，下面的策略是授予IAM用户对EKS的完全访问权限。</p></li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2012-10-17&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Statement&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Sid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;VisualEditor0&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="string">&quot;eks:*&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h2 id="取消授权">取消授权</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ eksctl delete iamidentitymapping \</span><br><span class="line">    --cluster eks-lexing --profile eks-us-west-2 \</span><br><span class="line">    --arn arn:aws:iam::743263909655:user/ekstest</span><br><span class="line">2023-07-05 09:12:29 [ℹ]  removing identity <span class="string">&quot;arn:aws:iam::743263909655:user/ekstest&quot;</span> from auth ConfigMap (username = <span class="string">&quot;&quot;</span>, <span class="built_in">groups</span> = [<span class="string">&quot;eks-console-dashboard-full-access-group&quot;</span>])</span><br><span class="line"></span><br><span class="line">$ eksctl get iamidentitymapping --cluster eks-lexing --profile eks-ty-old</span><br><span class="line">ARN                                                USERNAME                GROUPS                    ACCOUNT</span><br><span class="line">arn:aws:iam::743263909655:role/eksctl-eks-lexing-nodegroup-ng-4d-NodeInstanceRole-Y55EPJO9XYDG    system:node:&#123;&#123;EC2PrivateDNSName&#125;&#125;    system:bootstrappers,system:nodes</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;!--
 **加粗**
 *斜体*
 ***加粗并斜体***
 ~~删除线~~
 ==突出显示==
 `突出显示(推荐)`
 ++下划线++
 ~下标~
 ^上标^
 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.
 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600)

 +++ **点击折叠**
 这是被隐藏的内容
 +++

::: tips success warning danger
这里是容器内的内容
:::

% note info % success warning danger
这里是容器内的内容
% endnote %

 --&gt;
&lt;h2 id=&quot;摘要&quot;&gt;摘要&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;本文介绍EKS集群如何向其他 IAM 用户授予权限&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;参考资料：&lt;/p&gt;
&lt;ul class=&quot;lvl-2&quot;&gt;
&lt;li class=&quot;lvl-6&quot;&gt;&lt;a href=&quot;https://docs.aws.amazon.com/zh_cn/eks/latest/userguide&quot;&gt;Amazon EKS用户指南&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-6&quot;&gt;&lt;a href=&quot;https://kubernetes.io/zh-cn/docs/home/&quot;&gt;Kubernetes 文档&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="技术" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="aws" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/aws/"/>
    
    <category term="eks" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/aws/eks/"/>
    
    
    <category term="java" scheme="https://blog.hanqunfeng.com/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>AWS-EKS-09--创建基于LoadBalancer的service和ingress</title>
    <link href="https://blog.hanqunfeng.com/2023/07/07/aws-eks09-service-ingress/"/>
    <id>https://blog.hanqunfeng.com/2023/07/07/aws-eks09-service-ingress/</id>
    <published>2023-07-07T14:50:05.000Z</published>
    <updated>2023-07-11T08:54:40.935Z</updated>
    
    <content type="html"><![CDATA[<!-- **加粗** *斜体* ***加粗并斜体*** ~~删除线~~ ==突出显示== `突出显示(推荐)` ++下划线++ ~下标~ ^上标^ 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference. 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600) +++ **点击折叠** 这是被隐藏的内容 +++::: tips success warning danger这里是容器内的内容:::% note info % success warning danger这里是容器内的内容% endnote % --><h2 id="摘要">摘要</h2><ul class="lvl-0"><li class="lvl-2"><p>本文介绍为EKS集群创建基于LoadBalancer的service和ingress</p></li><li class="lvl-2"><p>参考资料：</p><ul class="lvl-2"><li class="lvl-6"><a href="https://docs.aws.amazon.com/zh_cn/eks/latest/userguide">Amazon EKS用户指南</a></li><li class="lvl-6"><a href="https://kubernetes.io/zh-cn/docs/home/">Kubernetes 文档</a></li></ul></li></ul><span id="more"></span><p>前置条件：<a href="/2023/07/07/aws-eks07-loadbalancer/" title="AWS-EKS-07--安装 AWS Load Balancer Controller 附加组件">安装 AWS Load Balancer Controller 附加组件</a></p><h2 id="Service">Service</h2><ul class="lvl-0"><li class="lvl-2"><p>service与elb的绑定关系是通过注释实现的。这里service必须设置为LoadBalancer，一个service就对应一个elb。</p></li><li class="lvl-2"><p>创建服务后，请勿编辑注释。如果需要对其进行修改，请删除相应服务对象，然后使用此注释的所需值重新创建它。</p></li><li class="lvl-2"><p><code>service.beta.kubernetes.io/aws-load-balancer-scheme: internet-facing</code> 表示允许外网访问，如果只允许集群内部访问，则去掉该注释即可。</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># eks-loadbalancer-service.yaml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nlb-sample-app</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nlb-sample-app</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">nlb-sample-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">public.ecr.aws/nginx/nginx:1.21</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tcp</span></span><br><span class="line">              <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nlb-sample-service</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">nlb-sample-app</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">service.beta.kubernetes.io/aws-load-balancer-type:</span> <span class="string">external</span></span><br><span class="line">    <span class="attr">service.beta.kubernetes.io/aws-load-balancer-nlb-target-type:</span> <span class="string">ip</span></span><br><span class="line">    <span class="attr">service.beta.kubernetes.io/aws-load-balancer-scheme:</span> <span class="string">internet-facing</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">LoadBalancer</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ k apply -f eks-loadbalancer-service.yaml</span><br><span class="line">$ k get svc -n nlb-sample-app</span><br><span class="line">NAME                 TYPE           CLUSTER-IP       EXTERNAL-IP                                                                     PORT(S)        AGE</span><br><span class="line">nlb-sample-service   LoadBalancer   10.100.176.186   k8s-nlbsampl-nlbsampl-f492eca1e5-b4b9dd61dd8724e6.elb.us-west-2.amazonaws.com   80:31743/TCP   6m11s</span><br></pre></td></tr></table></figure><p><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/3mCM0b.jpg" alt="" width="1200" height="600"><br><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/1sPJve.jpg" alt="" width="800" height="400"></p><h2 id="Ingress">Ingress</h2><ul class="lvl-0"><li class="lvl-2"><p>ingress与elb的绑定关系也是通过注释实现的，一个ingress绑定一个elb，可以同时对多个service提供映射。</p></li><li class="lvl-2"><p>为了支持https，需要先创建证书，我这里有一个域名<code>hanqunfeng.com</code>，通过<code>AWS Certificate Manager</code>创建证书</p><ul class="lvl-2"><li class="lvl-6">我这里使用的是根证书，注意这里一定要添加一个 <code>*.hanqunfeng.com</code> 的域名，否则使用子域名时会提示证书不匹配<br><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/AWgUqD.jpg" alt="" width="1200" height="800"></li><li class="lvl-6">去域名服务商处进行域名解析，配制好后等待证书颁发，耗时10分钟左右吧<br><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/myJkbW.jpg" alt="" width="1200" height="800"><br><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/uuAGn7.jpg" alt="" width="1200" height="150"></li></ul></li><li class="lvl-2"><p>测试用的service.yaml</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">game-2048</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">game-2048</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">deployment-2048</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app.kubernetes.io/name:</span> <span class="string">app-2048</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">5</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app.kubernetes.io/name:</span> <span class="string">app-2048</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">public.ecr.aws/l6m2t8p7/docker-2048:latest</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">app-2048</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">game-2048</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">service-2048</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span>   <span class="comment"># 也可以配置为 NodePort 或者 LoadBalancer</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">app-2048</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ k apply -f service.yaml</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>测试用的ingress.yaml</p><ul class="lvl-2"><li class="lvl-6">这里为了演示，host都指向了同一个service</li><li class="lvl-6">ingress是通过注释实现与elb的绑定，包括监听端口、80重定向到443、https证书等等</li></ul></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">game-2048</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-2048</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">alb.ingress.kubernetes.io/actions.ssl-redirect:</span> <span class="string">&#x27;&#123;&quot;Type&quot;: &quot;redirect&quot;, &quot;RedirectConfig&quot;:&#123; &quot;Protocol&quot;: &quot;HTTPS&quot;, &quot;Port&quot;: &quot;443&quot;, &quot;StatusCode&quot;: &quot;HTTP_301&quot;&#125;&#125;&#x27;</span>  <span class="comment"># http重定向到https</span></span><br><span class="line">    <span class="attr">alb.ingress.kubernetes.io/certificate-arn:</span> <span class="string">arn:aws:acm:us-west-2:743263909655:certificate/e2e3fa54-98ab-427a-9f09-486a9831323e</span> <span class="comment"># https证书，就是上面创建的证书的arn</span></span><br><span class="line">    <span class="attr">alb.ingress.kubernetes.io/listen-ports:</span> <span class="string">&#x27;[&#123;&quot;HTTP&quot;: 80&#125;, &#123;&quot;HTTPS&quot;:443&#125;]&#x27;</span> <span class="comment"># 监听端口</span></span><br><span class="line">    <span class="attr">alb.ingress.kubernetes.io/scheme:</span> <span class="string">internet-facing</span> <span class="comment"># 开放外网访问</span></span><br><span class="line">    <span class="attr">alb.ingress.kubernetes.io/target-type:</span> <span class="string">ip</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">alb</span> <span class="comment"># 指定ingressclass类型，k8s-1.18及以后的版本推荐这种配置方式，旧版本需要在注释中加入 kubernetes.io/ingress.class: alb</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">eks.hanqunfeng.com</span> <span class="comment"># 域名绑定，需要到域名服务商处进行域名解析，CNAME到当前生成的elb</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span> <span class="comment"># 重定向配置，这里必须配置，否则不能实现重定向</span></span><br><span class="line">          <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">          <span class="attr">backend:</span></span><br><span class="line">            <span class="attr">service:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">ssl-redirect</span></span><br><span class="line">              <span class="attr">port:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">use-annotation</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">          <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">          <span class="attr">backend:</span></span><br><span class="line">            <span class="attr">service:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">service-2048</span></span><br><span class="line">              <span class="attr">port:</span></span><br><span class="line">                <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">aws.hanqunfeng.com</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/*</span></span><br><span class="line">          <span class="attr">pathType:</span> <span class="string">ImplementationSpecific</span></span><br><span class="line">          <span class="attr">backend:</span></span><br><span class="line">            <span class="attr">service:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">ssl-redirect</span></span><br><span class="line">              <span class="attr">port:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">use-annotation</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/*</span></span><br><span class="line">          <span class="attr">pathType:</span> <span class="string">ImplementationSpecific</span></span><br><span class="line">          <span class="attr">backend:</span></span><br><span class="line">            <span class="attr">service:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">service-2048</span></span><br><span class="line">              <span class="attr">port:</span></span><br><span class="line">                <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 部署ingress</span></span><br><span class="line">$ k apply -f ingress.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看ingress</span></span><br><span class="line">$ k describe ing -n game-2048 ingress-2048</span><br><span class="line">Name:             ingress-2048</span><br><span class="line">Labels:           &lt;none&gt;</span><br><span class="line">Namespace:        game-2048</span><br><span class="line">Address:          k8s-game2048-ingress2-1ca4fafb1f-272829398.us-west-2.elb.amazonaws.com</span><br><span class="line">Ingress Class:    alb</span><br><span class="line">Default backend:  &lt;default&gt;</span><br><span class="line">Rules:</span><br><span class="line">  Host                Path  Backends</span><br><span class="line">  ----                ----  --------</span><br><span class="line">  eks.hanqunfeng.com</span><br><span class="line">                      /   ssl-redirect:use-annotation (&lt;error: endpoints <span class="string">&quot;ssl-redirect&quot;</span> not found&gt;)</span><br><span class="line">                      /   service-2048:80 (192.168.0.196:80,192.168.20.125:80,192.168.22.188:80 + 2 more...)</span><br><span class="line">  aws.hanqunfeng.com</span><br><span class="line">                      /*   ssl-redirect:use-annotation (&lt;error: endpoints <span class="string">&quot;ssl-redirect&quot;</span> not found&gt;)</span><br><span class="line">                      /*   service-2048:80 (192.168.0.196:80,192.168.20.125:80,192.168.22.188:80 + 2 more...)</span><br><span class="line">Annotations:          alb.ingress.kubernetes.io/actions.ssl-redirect:</span><br><span class="line">                        &#123;<span class="string">&quot;Type&quot;</span>: <span class="string">&quot;redirect&quot;</span>, <span class="string">&quot;RedirectConfig&quot;</span>:&#123; <span class="string">&quot;Protocol&quot;</span>: <span class="string">&quot;HTTPS&quot;</span>, <span class="string">&quot;Port&quot;</span>: <span class="string">&quot;443&quot;</span>, <span class="string">&quot;StatusCode&quot;</span>: <span class="string">&quot;HTTP_301&quot;</span>&#125;&#125;</span><br><span class="line">                      alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:us-west-2:743263909655:certificate/e2e3fa54-98ab-427a-9f09-486a9831323e</span><br><span class="line">                      alb.ingress.kubernetes.io/listen-ports: [&#123;<span class="string">&quot;HTTP&quot;</span>: 80&#125;, &#123;<span class="string">&quot;HTTPS&quot;</span>:443&#125;]</span><br><span class="line">                      alb.ingress.kubernetes.io/scheme: internet-facing</span><br><span class="line">                      alb.ingress.kubernetes.io/target-type: ip</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason                  Age   From     Message</span><br><span class="line">  ----    ------                  ----  ----     -------</span><br><span class="line">  Normal  SuccessfullyReconciled  2s    ingress  Successfully reconciled</span><br></pre></td></tr></table></figure><div class="tips"><p><em><strong>在 Kubernetes Ingress 规则中，pathType 有三种可能的取值</strong></em></p><ul class="lvl-1"><li class="lvl-2">Exact: 使用 Exact 类型时，请求的路径必须与规则中指定的路径完全匹配，包括大小写。这是最精确的匹配方式。</li><li class="lvl-2">Prefix: 使用 Prefix 类型时，请求的路径只需以规则中指定的路径为前缀即可匹配。这种方式可以处理以指定路径为前缀的所有请求。</li><li class="lvl-2">ImplementationSpecific: 使用 ImplementationSpecific 类型时，路径匹配的行为由 Ingress 控制器的具体实现决定。这种类型的路径匹配方式在不同的 Ingress 控制器中可能会有所差异，因此具体行为可能会因实现而异。在 AWS ALB Ingress Controller 中，pathType 的 ImplementationSpecific 类型可以与多个 AWS Load Balancer 的功能集成，包括 Application Load Balancer (ALB)、Network Load Balancer (NLB) 和 Classic Load Balancer (CLB)。我们这里使用的是ALB。</li></ul></div><ul class="lvl-0"><li class="lvl-2"><p>ingress创建的elb<br><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/X1v4p4.jpg" alt="" width="1200" height="800"><br><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/36bhEE.jpg" alt="" width="1200" height="500"><br><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/UilkuJ.jpg" alt="" width="1200" height="500"></p></li><li class="lvl-2"><p>域名解析配置<br><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/AcPHl2.jpg" alt="" width="1200" height="300"><br><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/DSZBrG.jpg" alt="" width="800" height="800"></p></li></ul>]]></content>
    
    
    <summary type="html">&lt;!--
 **加粗**
 *斜体*
 ***加粗并斜体***
 ~~删除线~~
 ==突出显示==
 `突出显示(推荐)`
 ++下划线++
 ~下标~
 ^上标^
 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.
 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600)

 +++ **点击折叠**
 这是被隐藏的内容
 +++

::: tips success warning danger
这里是容器内的内容
:::

% note info % success warning danger
这里是容器内的内容
% endnote %

 --&gt;
&lt;h2 id=&quot;摘要&quot;&gt;摘要&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;本文介绍为EKS集群创建基于LoadBalancer的service和ingress&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;参考资料：&lt;/p&gt;
&lt;ul class=&quot;lvl-2&quot;&gt;
&lt;li class=&quot;lvl-6&quot;&gt;&lt;a href=&quot;https://docs.aws.amazon.com/zh_cn/eks/latest/userguide&quot;&gt;Amazon EKS用户指南&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-6&quot;&gt;&lt;a href=&quot;https://kubernetes.io/zh-cn/docs/home/&quot;&gt;Kubernetes 文档&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="技术" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="aws" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/aws/"/>
    
    <category term="eks" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/aws/eks/"/>
    
    
    <category term="java" scheme="https://blog.hanqunfeng.com/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>AWS-EKS-08--升级集群与删除集群</title>
    <link href="https://blog.hanqunfeng.com/2023/07/07/aws-eks08-upgrade-eks/"/>
    <id>https://blog.hanqunfeng.com/2023/07/07/aws-eks08-upgrade-eks/</id>
    <published>2023-07-07T14:40:05.000Z</published>
    <updated>2023-07-12T14:57:05.644Z</updated>
    
    <content type="html"><![CDATA[<!-- **加粗** *斜体* ***加粗并斜体*** ~~删除线~~ ==突出显示== `突出显示(推荐)` ++下划线++ ~下标~ ^上标^ 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference. 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600) +++ **点击折叠** 这是被隐藏的内容 +++::: tips success warning danger这里是容器内的内容:::% note info % success warning danger这里是容器内的内容% endnote % --><h2 id="摘要">摘要</h2><ul class="lvl-0"><li class="lvl-2"><p>本文介绍为EKS集群升级和集群删除的方法</p></li><li class="lvl-2"><p>参考资料：</p><ul class="lvl-2"><li class="lvl-6"><a href="https://docs.aws.amazon.com/zh_cn/eks/latest/userguide">Amazon EKS用户指南</a></li><li class="lvl-6"><a href="https://kubernetes.io/zh-cn/docs/home/">Kubernetes 文档</a></li></ul></li></ul><span id="more"></span><h2 id="升级集群">升级集群</h2><ul class="lvl-0"><li class="lvl-2"><p>eks升级分为server端升级，工作节点升级，客户端kubectl升级</p></li><li class="lvl-2"><p>可以通过aws控制台升级集群，页面上点点按钮就可以了，这里给出的是通过命令行升级集群的方式</p></li><li class="lvl-2"><p>每次升级只能升级一个次要版本</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 每次升级只能升级一个次要版本，先查看当前版本，当前server端是1.25，client端是1.24，最好也升级一下本地的kubectl client</span></span><br><span class="line">$ kubectl version --short</span><br><span class="line"></span><br><span class="line">Flag --short has been deprecated, and will be removed <span class="keyword">in</span> the future. The --short output will become the default.</span><br><span class="line">Client Version: v1.24.2</span><br><span class="line">Kustomize Version: v4.5.4</span><br><span class="line">Server Version: v1.25.10-eks-c12679a</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>将集群升级到1.26</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ eksctl upgrade cluster --name eks-lexing --profile eks-us-west-2 --version 1.26 --approve</span><br><span class="line">2023-06-29 19:03:35 [ℹ]  will upgrade cluster <span class="string">&quot;eks-lexing&quot;</span> control plane from current version <span class="string">&quot;1.25&quot;</span> to <span class="string">&quot;1.26&quot;</span></span><br><span class="line">2023-06-29 19:11:27 [✔]  cluster <span class="string">&quot;eks-lexing&quot;</span> control plane has been upgraded to version <span class="string">&quot;1.26&quot;</span></span><br><span class="line">2023-06-29 19:11:27 [ℹ]  you will need to follow the upgrade procedure <span class="keyword">for</span> all of nodegroups and add-ons</span><br><span class="line">2023-06-29 19:11:29 [ℹ]  re-building cluster stack <span class="string">&quot;eksctl-eks-lexing-cluster&quot;</span></span><br><span class="line">2023-06-29 19:11:29 [✔]  all resources <span class="keyword">in</span> cluster stack <span class="string">&quot;eksctl-eks-lexing-cluster&quot;</span> are up-to-date</span><br><span class="line">2023-06-29 19:11:30 [ℹ]  checking security group configuration <span class="keyword">for</span> all nodegroups</span><br><span class="line">2023-06-29 19:11:30 [ℹ]  all nodegroups have up-to-date cloudformation templates</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看server版本</span></span><br><span class="line">$ kubectl version --short</span><br><span class="line">Flag --short has been deprecated, and will be removed <span class="keyword">in</span> the future. The --short output will become the default.</span><br><span class="line">Client Version: v1.24.2</span><br><span class="line">Kustomize Version: v4.5.4</span><br><span class="line">Server Version: v1.26.6-eks-a5565ad</span><br><span class="line">WARNING: version difference between client (1.24) and server (1.26) exceeds the supported minor version skew of +/-1</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>升级kubectl: 参看<a href="https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/install-kubectl.html">安装或更新 kubectl</a></p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入到kubectl命令所在目录</span></span><br><span class="line">$ <span class="built_in">cd</span> /usr/local/bin</span><br><span class="line"><span class="comment"># 备份原命令</span></span><br><span class="line">$ <span class="built_in">mv</span> kubectl kubectl.back</span><br><span class="line"><span class="comment"># 下载指定版本</span></span><br><span class="line">$ curl -O https://s3.us-west-2.amazonaws.com/amazon-eks/1.26.4/2023-05-11/bin/darwin/amd64/kubectl</span><br><span class="line"><span class="comment"># 授予执行权限</span></span><br><span class="line">$ <span class="built_in">chmod</span> +x kubectl</span><br><span class="line"><span class="comment"># 查看版本</span></span><br><span class="line">$ k version --short</span><br><span class="line">Flag --short has been deprecated, and will be removed <span class="keyword">in</span> the future. The --short output will become the default.</span><br><span class="line">Client Version: v1.26.4-eks-0a21954</span><br><span class="line">Kustomize Version: v4.5.7</span><br><span class="line">Server Version: v1.26.6-eks-a5565ad</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>升级work节点机版本</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看节点组信息，看到type为managed，表示被托管的节点组，这里要注意，托管和非托管升级方式是不一样的</span></span><br><span class="line">$ eksctl get nodegroup --cluster eks-lexing --profile eks-us-west-2</span><br><span class="line">CLUSTER        NODEGROUP    STATUS    CREATED            MIN SIZE    MAX SIZE    DESIRED CAPACITY    INSTANCE TYPE    IMAGE ID    ASG NAME                    TYPE</span><br><span class="line">eks-lexing    ng-4d9024eb    ACTIVE    2023-06-28T06:30:03Z    2        2        m5.large    AL2_x86_64    eks-ng-4d9024eb-20c48058-e974-c6ec-786a-516c31131604    managed</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看节点组上的k8s版本信息，实际上节点组信息可以通过控制台查看--&gt; EKS-集群--计算</span></span><br><span class="line">$ aws eks describe-nodegroup --cluster-name eks-lexing --profile eks-us-west-2 --nodegroup-name ng-4d9024eb --query <span class="string">&#x27;nodegroup.version&#x27;</span> --output text</span><br><span class="line">1.25</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看节点信息，这里也会显示k8s的版本，可以看到是v1.25.9</span></span><br><span class="line">$ k get node -owide</span><br><span class="line">NAME                                           STATUS   ROLES    AGE   VERSION               INTERNAL-IP      EXTERNAL-IP     OS-IMAGE         KERNEL-VERSION                  CONTAINER-RUNTIME</span><br><span class="line">ip-192-168-25-29.us-west-2.compute.internal    Ready    &lt;none&gt;   28h   v1.25.9-eks-0a21954   192.168.25.29    35.87.26.4      Amazon Linux 2   5.10.179-168.710.amzn2.x86_64   containerd://1.6.19</span><br><span class="line">ip-192-168-47-168.us-west-2.compute.internal   Ready    &lt;none&gt;   28h   v1.25.9-eks-0a21954   192.168.47.168   54.185.178.28   Amazon Linux 2   5.10.179-168.710.amzn2.x86_64   containerd://1.6.19</span><br><span class="line"></span><br><span class="line"><span class="comment"># 升级节点组，每次也只升级一个次要版本，2个node就用时20多分钟，还是比较慢的</span></span><br><span class="line">$ eksctl upgrade nodegroup --name=ng-4d9024eb --cluster=eks-lexing --profile=eks-us-west-2 --kubernetes-version=1.26</span><br><span class="line">2023-06-29 19:31:24 [ℹ]  setting ForceUpdateEnabled value to <span class="literal">false</span></span><br><span class="line">2023-06-29 19:31:24 [ℹ]  updating nodegroup stack</span><br><span class="line">2023-06-29 19:31:26 [ℹ]  waiting <span class="keyword">for</span> CloudFormation changeset <span class="string">&quot;eksctl-update-nodegroup-1688038284&quot;</span> <span class="keyword">for</span> stack <span class="string">&quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;</span></span><br><span class="line">2023-06-29 19:31:57 [ℹ]  waiting <span class="keyword">for</span> CloudFormation changeset <span class="string">&quot;eksctl-update-nodegroup-1688038284&quot;</span> <span class="keyword">for</span> stack <span class="string">&quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;</span></span><br><span class="line">2023-06-29 19:31:58 [ℹ]  waiting <span class="keyword">for</span> CloudFormation stack <span class="string">&quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;</span></span><br><span class="line">2023-06-29 19:32:29 [ℹ]  waiting <span class="keyword">for</span> CloudFormation stack <span class="string">&quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;</span></span><br><span class="line">2023-06-29 19:32:30 [ℹ]  upgrading nodegroup version</span><br><span class="line">2023-06-29 19:32:30 [ℹ]  updating nodegroup stack</span><br><span class="line">2023-06-29 19:32:31 [ℹ]  waiting <span class="keyword">for</span> CloudFormation changeset <span class="string">&quot;eksctl-update-nodegroup-1688038350&quot;</span> <span class="keyword">for</span> stack <span class="string">&quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;</span></span><br><span class="line">2023-06-29 19:33:03 [ℹ]  waiting <span class="keyword">for</span> CloudFormation changeset <span class="string">&quot;eksctl-update-nodegroup-1688038350&quot;</span> <span class="keyword">for</span> stack <span class="string">&quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;</span></span><br><span class="line">2023-06-29 19:33:04 [ℹ]  waiting <span class="keyword">for</span> CloudFormation stack <span class="string">&quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;</span></span><br><span class="line">2023-06-29 19:33:35 [ℹ]  waiting <span class="keyword">for</span> CloudFormation stack <span class="string">&quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;</span></span><br><span class="line">2023-06-29 19:34:33 [ℹ]  waiting <span class="keyword">for</span> CloudFormation stack <span class="string">&quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;</span></span><br><span class="line">2023-06-29 19:36:24 [ℹ]  waiting <span class="keyword">for</span> CloudFormation stack <span class="string">&quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;</span></span><br><span class="line">2023-06-29 19:38:11 [ℹ]  waiting <span class="keyword">for</span> CloudFormation stack <span class="string">&quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;</span></span><br><span class="line">2023-06-29 19:39:11 [ℹ]  waiting <span class="keyword">for</span> CloudFormation stack <span class="string">&quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;</span></span><br><span class="line">2023-06-29 19:39:58 [ℹ]  waiting <span class="keyword">for</span> CloudFormation stack <span class="string">&quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;</span></span><br><span class="line">2023-06-29 19:41:28 [ℹ]  waiting <span class="keyword">for</span> CloudFormation stack <span class="string">&quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;</span></span><br><span class="line">2023-06-29 19:43:27 [ℹ]  waiting <span class="keyword">for</span> CloudFormation stack <span class="string">&quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;</span></span><br><span class="line">2023-06-29 19:44:26 [ℹ]  waiting <span class="keyword">for</span> CloudFormation stack <span class="string">&quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;</span></span><br><span class="line">2023-06-29 19:45:48 [ℹ]  waiting <span class="keyword">for</span> CloudFormation stack <span class="string">&quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;</span></span><br><span class="line">2023-06-29 19:47:06 [ℹ]  waiting <span class="keyword">for</span> CloudFormation stack <span class="string">&quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;</span></span><br><span class="line">2023-06-29 19:48:35 [ℹ]  waiting <span class="keyword">for</span> CloudFormation stack <span class="string">&quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;</span></span><br><span class="line">2023-06-29 19:50:04 [ℹ]  waiting <span class="keyword">for</span> CloudFormation stack <span class="string">&quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;</span></span><br><span class="line">2023-06-29 19:50:44 [ℹ]  waiting <span class="keyword">for</span> CloudFormation stack <span class="string">&quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;</span></span><br><span class="line">2023-06-29 19:51:57 [ℹ]  waiting <span class="keyword">for</span> CloudFormation stack <span class="string">&quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;</span></span><br><span class="line">2023-06-29 19:53:36 [ℹ]  waiting <span class="keyword">for</span> CloudFormation stack <span class="string">&quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;</span></span><br><span class="line">2023-06-29 19:53:36 [ℹ]  nodegroup successfully upgraded</span><br><span class="line"></span><br><span class="line"><span class="comment"># 再次查看版本</span></span><br><span class="line">$ aws eks describe-nodegroup --cluster-name eks-lexing --profile eks-us-west-2 --nodegroup-name ng-4d9024eb --query <span class="string">&#x27;nodegroup.version&#x27;</span> --output text</span><br><span class="line">1.26</span><br><span class="line"></span><br><span class="line">$ k get node -owide</span><br><span class="line">NAME                                          STATUS   ROLES    AGE   VERSION               INTERNAL-IP     EXTERNAL-IP      OS-IMAGE         KERNEL-VERSION                  CONTAINER-RUNTIME</span><br><span class="line">ip-192-168-48-14.us-west-2.compute.internal   Ready    &lt;none&gt;   20m   v1.26.4-eks-0a21954   192.168.48.14   54.212.74.15     Amazon Linux 2   5.10.179-168.710.amzn2.x86_64   containerd://1.6.19</span><br><span class="line">ip-192-168-69-81.us-west-2.compute.internal   Ready    &lt;none&gt;   21m   v1.26.4-eks-0a21954   192.168.69.81   44.242.163.187   Amazon Linux 2   5.10.179-168.710.amzn2.x86_64   containerd://1.6.19</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>升级之后可以登录aws控制台查看一下相关插件是否需要升级，如果需要直接在页面上点击升级即可。</p></li></ul><h2 id="删除集群">删除集群</h2><ul class="lvl-0"><li class="lvl-2"><p>从<a href="https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/delete-cluster.html">官方文档</a>中可以看到可以使用 eksctl、AWS Management Console 或 AWS CLI 删除集群，这里以eksctl为例说明。</p></li><li class="lvl-2"><p>如果集群中具有与负载均衡器关联的有效服务，则必须先删除这些服务，然后再删除集群，以便正确删除负载均衡器。否则，VPC 中可能有阻止您删除 VPC 的孤立资源。</p></li><li class="lvl-2"><p>列出集群中运行的所有服务</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get svc --all-namespaces</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>删除具有关联的 EXTERNAL-IP 值的任何服务。这些服务的前面配置了一个 Elastic Load Balancing 负载均衡器，您必须从 Kubernetes 中将其删除才能释放负载均衡器和关联资源</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl delete svc `service-name`</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>删除集群</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 运行时间基于当前集群所使用的资源规模，超过10分钟</span></span><br><span class="line">$ eksctl delete cluster --name eks-lexing  --profile myProfile</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>删除完成后检查一下对应的ec2,负载均衡器,目标群组,vpc,安全组,弹性ip,卷,net网关以及CloudFormation<br>是否都已经删除，如果有遗漏需要手工删除。</p></li></ul>]]></content>
    
    
    <summary type="html">&lt;!--
 **加粗**
 *斜体*
 ***加粗并斜体***
 ~~删除线~~
 ==突出显示==
 `突出显示(推荐)`
 ++下划线++
 ~下标~
 ^上标^
 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.
 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600)

 +++ **点击折叠**
 这是被隐藏的内容
 +++

::: tips success warning danger
这里是容器内的内容
:::

% note info % success warning danger
这里是容器内的内容
% endnote %

 --&gt;
&lt;h2 id=&quot;摘要&quot;&gt;摘要&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;本文介绍为EKS集群升级和集群删除的方法&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;参考资料：&lt;/p&gt;
&lt;ul class=&quot;lvl-2&quot;&gt;
&lt;li class=&quot;lvl-6&quot;&gt;&lt;a href=&quot;https://docs.aws.amazon.com/zh_cn/eks/latest/userguide&quot;&gt;Amazon EKS用户指南&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-6&quot;&gt;&lt;a href=&quot;https://kubernetes.io/zh-cn/docs/home/&quot;&gt;Kubernetes 文档&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="技术" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="aws" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/aws/"/>
    
    <category term="eks" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/aws/eks/"/>
    
    
    <category term="java" scheme="https://blog.hanqunfeng.com/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>AWS-EKS-07--安装 AWS Load Balancer Controller 附加组件</title>
    <link href="https://blog.hanqunfeng.com/2023/07/07/aws-eks07-loadbalancer/"/>
    <id>https://blog.hanqunfeng.com/2023/07/07/aws-eks07-loadbalancer/</id>
    <published>2023-07-07T14:33:05.000Z</published>
    <updated>2023-07-11T08:01:26.592Z</updated>
    
    <content type="html"><![CDATA[<!-- **加粗** *斜体* ***加粗并斜体*** ~~删除线~~ ==突出显示== `突出显示(推荐)` ++下划线++ ~下标~ ^上标^ 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference. 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600) +++ **点击折叠** 这是被隐藏的内容 +++::: tips success warning danger这里是容器内的内容:::% note info % success warning danger这里是容器内的内容% endnote % --><h2 id="摘要">摘要</h2><ul class="lvl-0"><li class="lvl-2"><p>本文介绍为EKS集群安装 AWS Load Balancer Controller 附加组件</p></li><li class="lvl-2"><p>参考资料：</p><ul class="lvl-2"><li class="lvl-6"><a href="https://docs.aws.amazon.com/zh_cn/eks/latest/userguide">Amazon EKS用户指南</a></li><li class="lvl-6"><a href="https://kubernetes.io/zh-cn/docs/home/">Kubernetes 文档</a></li></ul></li></ul><span id="more"></span><h2 id="安装-AWS-Load-Balancer-Controller-附加组件">安装 AWS Load Balancer Controller 附加组件</h2><ul class="lvl-0"><li class="lvl-2"><p>AWS Load Balancer Controller 管理适用于 Kubernetes 集群的 AWS 弹性负载均衡器。此控制器预置以下资源：</p><ul class="lvl-2"><li class="lvl-6">当您创建 Kubernetes Ingress 时的 AWS 应用程序负载均衡器 (ALB, Application Load Balancer)。</li><li class="lvl-6">当您创建 LoadBalancer 类型的 Kubernetes 服务时的 AWS 网络负载均衡器（NLB）。</li></ul></li><li class="lvl-2"><p>关于如何创建ingress和service，后面会介绍。</p></li></ul><h3 id="创建一个-IAM-policy">创建一个 IAM policy</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载 AWS Load Balancer Controller 的 IAM policy，该策略允许负载均衡器代表您调用 AWS API。</span></span><br><span class="line">$ curl -O https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/v2.4.7/docs/install/iam_policy.json</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用上一步中下载的策略创建一个 IAM policy</span></span><br><span class="line">$ aws iam create-policy \</span><br><span class="line">    --profile eks-us-west-2 \</span><br><span class="line">    --policy-name AWSLoadBalancerControllerIAMPolicy \</span><br><span class="line">    --policy-document file://iam_policy.json</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;Policy&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;PolicyName&quot;</span>: <span class="string">&quot;AWSLoadBalancerControllerIAMPolicy&quot;</span>,</span><br><span class="line">        <span class="string">&quot;PolicyId&quot;</span>: <span class="string">&quot;ANPA22DP3G4GO5O54MRRX&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Arn&quot;</span>: <span class="string">&quot;arn:aws:iam::743263909655:policy/AWSLoadBalancerControllerIAMPolicy&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Path&quot;</span>: <span class="string">&quot;/&quot;</span>,</span><br><span class="line">        <span class="string">&quot;DefaultVersionId&quot;</span>: <span class="string">&quot;v1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;AttachmentCount&quot;</span>: 0,</span><br><span class="line">        <span class="string">&quot;PermissionsBoundaryUsageCount&quot;</span>: 0,</span><br><span class="line">        <span class="string">&quot;IsAttachable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">&quot;CreateDate&quot;</span>: <span class="string">&quot;2023-07-04T09:15:56+00:00&quot;</span>,</span><br><span class="line">        <span class="string">&quot;UpdateDate&quot;</span>: <span class="string">&quot;2023-07-04T09:15:56+00:00&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="创建一个-IAM-角色">创建一个 IAM 角色</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在 AWS Load Balancer Controller 的 kube-system 命名空间中创建名为 aws-load-balancer-controller 的 Kubernetes 服务账户，并使用 IAM 角色的名称注释 Kubernetes 服务账户。</span></span><br><span class="line">$ eksctl create iamserviceaccount \</span><br><span class="line">  --cluster=eks-lexing \</span><br><span class="line">  --profile eks-us-west-2 \</span><br><span class="line">  --namespace=kube-system \</span><br><span class="line">  --name=aws-load-balancer-controller \</span><br><span class="line">  --role-name AmazonEKSLoadBalancerControllerRole \</span><br><span class="line">  --attach-policy-arn=arn:aws:iam::743263909655:policy/AWSLoadBalancerControllerIAMPolicy \</span><br><span class="line">  --approve</span><br><span class="line">2023-07-04 17:20:08 [ℹ]  3 existing iamserviceaccount(s) (kube-system/aws-node,kube-system/ebs-csi-controller-sa,kube-system/efs-csi-controller-sa) will be excluded</span><br><span class="line">2023-07-04 17:20:08 [ℹ]  1 iamserviceaccount (kube-system/aws-load-balancer-controller) was included (based on the include/exclude rules)</span><br><span class="line">2023-07-04 17:20:08 [!]  serviceaccounts that exist <span class="keyword">in</span> Kubernetes will be excluded, use --override-existing-serviceaccounts to override</span><br><span class="line">2023-07-04 17:20:08 [ℹ]  1 task: &#123;</span><br><span class="line">    2 sequential sub-tasks: &#123;</span><br><span class="line">        create IAM role <span class="keyword">for</span> serviceaccount <span class="string">&quot;kube-system/aws-load-balancer-controller&quot;</span>,</span><br><span class="line">        create serviceaccount <span class="string">&quot;kube-system/aws-load-balancer-controller&quot;</span>,</span><br><span class="line">    &#125; &#125;2023-07-04 17:20:08 [ℹ]  building iamserviceaccount stack <span class="string">&quot;eksctl-eks-lexing-addon-iamserviceaccount-kube-system-aws-load-balancer-controller&quot;</span></span><br><span class="line">2023-07-04 17:20:09 [ℹ]  deploying stack <span class="string">&quot;eksctl-eks-lexing-addon-iamserviceaccount-kube-system-aws-load-balancer-controller&quot;</span></span><br><span class="line">2023-07-04 17:20:09 [ℹ]  waiting <span class="keyword">for</span> CloudFormation stack <span class="string">&quot;eksctl-eks-lexing-addon-iamserviceaccount-kube-system-aws-load-balancer-controller&quot;</span></span><br><span class="line">2023-07-04 17:20:40 [ℹ]  waiting <span class="keyword">for</span> CloudFormation stack <span class="string">&quot;eksctl-eks-lexing-addon-iamserviceaccount-kube-system-aws-load-balancer-controller&quot;</span></span><br><span class="line">2023-07-04 17:20:41 [ℹ]  created serviceaccount <span class="string">&quot;kube-system/aws-load-balancer-controller&quot;</span></span><br></pre></td></tr></table></figure><h3 id="使用-Helm-V3来安装-AWS-Load-Balancer-Controller">使用 Helm V3来安装 AWS Load Balancer Controller</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加 eks-charts 存储库</span></span><br><span class="line">$ helm repo add eks https://aws.github.io/eks-charts</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新您的本地存储库，以确保您拥有最新的图表</span></span><br><span class="line">$ helm repo update eks</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 AWS Load Balancer Controller</span></span><br><span class="line">$ helm install aws-load-balancer-controller eks/aws-load-balancer-controller \</span><br><span class="line">  -n kube-system \</span><br><span class="line">  --<span class="built_in">set</span> clusterName=eks-lexing \</span><br><span class="line">  --<span class="built_in">set</span> serviceAccount.create=<span class="literal">false</span> \</span><br><span class="line">  --<span class="built_in">set</span> serviceAccount.name=aws-load-balancer-controller</span><br><span class="line">NAME: aws-load-balancer-controller</span><br><span class="line">LAST DEPLOYED: Tue Jul  4 17:26:05 2023</span><br><span class="line">NAMESPACE: kube-system</span><br><span class="line">STATUS: deployed</span><br><span class="line">REVISION: 1</span><br><span class="line">TEST SUITE: None</span><br><span class="line">NOTES:</span><br><span class="line">AWS Load Balancer controller installed!</span><br></pre></td></tr></table></figure><h3 id="验证控制器是否已经安装">验证控制器是否已经安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看deployment</span></span><br><span class="line">$ kubectl get deployment -n kube-system aws-load-balancer-controller</span><br><span class="line">NAME                           READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">aws-load-balancer-controller   2/2     2            2           21s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看ingressclasses</span></span><br><span class="line">$ k get ingressclasses</span><br><span class="line">NAME   CONTROLLER            PARAMETERS   AGE</span><br><span class="line">alb    ingress.k8s.aws/alb   &lt;none&gt;       21s</span><br></pre></td></tr></table></figure><h3 id="更新AWS-Load-Balancer-Controller">更新AWS Load Balancer Controller</h3><ul class="lvl-0"><li class="lvl-2"><p>已部署的图表不会自动接收安全更新。当新图表可用时，您需要手动升级到新图表。</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 更新AWS Load Balancer Controller</span></span><br><span class="line">$ kubectl apply -k <span class="string">&quot;github.com/aws/eks-charts/stable/aws-load-balancer-controller/crds?ref=master&quot;</span></span><br><span class="line">Warning: resource customresourcedefinitions/ingressclassparams.elbv2.k8s.aws is missing the kubectl.kubernetes.io/last-applied-configuration annotation <span class="built_in">which</span> is required by kubectl apply. kubectl apply should only be used on resources created declaratively by either kubectl create --save-config or kubectl apply. The missing annotation will be patched automatically.</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/ingressclassparams.elbv2.k8s.aws configured</span><br><span class="line">Warning: resource customresourcedefinitions/targetgroupbindings.elbv2.k8s.aws is missing the kubectl.kubernetes.io/last-applied-configuration annotation <span class="built_in">which</span> is required by kubectl apply. kubectl apply should only be used on resources created declaratively by either kubectl create --save-config or kubectl apply. The missing annotation will be patched automatically.</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/targetgroupbindings.elbv2.k8s.aws configured</span><br><span class="line"></span><br><span class="line">$ helm upgrade aws-load-balancer-controller eks/aws-load-balancer-controller \</span><br><span class="line">  -n kube-system \</span><br><span class="line">  --<span class="built_in">set</span> clusterName=eks-lexing \</span><br><span class="line">  --<span class="built_in">set</span> serviceAccount.create=<span class="literal">false</span> \</span><br><span class="line">  --<span class="built_in">set</span> serviceAccount.name=aws-load-balancer-controller</span><br><span class="line">Release <span class="string">&quot;aws-load-balancer-controller&quot;</span> has been upgraded. Happy Helming!</span><br><span class="line">NAME: aws-load-balancer-controller</span><br><span class="line">LAST DEPLOYED: Tue Jul  4 17:31:37 2023</span><br><span class="line">NAMESPACE: kube-system</span><br><span class="line">STATUS: deployed</span><br><span class="line">REVISION: 2</span><br><span class="line">TEST SUITE: None</span><br><span class="line">NOTES:</span><br><span class="line">AWS Load Balancer controller installed!</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>可以先查看是否有可用更新</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看通过helm已经安装了哪些发布包及其版本</span></span><br><span class="line">$ helm list --all-namespaces</span><br><span class="line">NAME                        NAMESPACE  REVISIONUPDATED                             STATUS  CHART                             APP VERSION</span><br><span class="line">aws-efs-csi-driver          kube-system3       2023-07-03 16:08:38.481521 +0800 CSTdeployedaws-efs-csi-driver-2.4.6          1.5.7</span><br><span class="line">aws-load-balancer-controllerkube-system2       2023-07-04 17:31:37.839466 +0800 CSTdeployedaws-load-balancer-controller-1.5.4v2.5.3</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新仓库最新的索引</span></span><br><span class="line">$ helm repo update</span><br><span class="line">Hang tight <span class="keyword">while</span> we grab the latest from your chart repositories...</span><br><span class="line">...Successfully got an update from the <span class="string">&quot;aws-efs-csi-driver&quot;</span> chart repository</span><br><span class="line">...Successfully got an update from the <span class="string">&quot;eks&quot;</span> chart repository</span><br><span class="line">Update Complete. ⎈Happy Helming!⎈</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看可用的最新版本</span></span><br><span class="line">$ helm search repo load-balancer</span><br><span class="line">NAME                            CHART VERSIONAPP VERSIONDESCRIPTION</span><br><span class="line">eks/aws-load-balancer-controller1.5.4        v2.5.3     AWS Load Balancer Controller Helm chart <span class="keyword">for</span> Kub...</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看所有版本</span></span><br><span class="line">$ helm search repo load-balancer -l</span><br><span class="line">NAME                            CHART VERSIONAPP VERSIONDESCRIPTION</span><br><span class="line">eks/aws-load-balancer-controller1.5.4        v2.5.3     AWS Load Balancer Controller Helm chart <span class="keyword">for</span> Kub...</span><br><span class="line">eks/aws-load-balancer-controller1.5.3        v2.5.2     AWS Load Balancer Controller Helm chart <span class="keyword">for</span> Kub...</span><br><span class="line">eks/aws-load-balancer-controller1.5.2        v2.5.1     AWS Load Balancer Controller Helm chart <span class="keyword">for</span> Kub...</span><br><span class="line">eks/aws-load-balancer-controller1.5.1        v2.5.1     AWS Load Balancer Controller Helm chart <span class="keyword">for</span> Kub...</span><br><span class="line">eks/aws-load-balancer-controller1.5.0        v2.5.0     AWS Load Balancer Controller Helm chart <span class="keyword">for</span> Kub...</span><br><span class="line">eks/aws-load-balancer-controller1.4.8        v2.4.7     AWS Load Balancer Controller Helm chart <span class="keyword">for</span> Kub...</span><br><span class="line">eks/aws-load-balancer-controller1.4.7        v2.4.6     AWS Load Balancer Controller Helm chart <span class="keyword">for</span> Kub...</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;!--
 **加粗**
 *斜体*
 ***加粗并斜体***
 ~~删除线~~
 ==突出显示==
 `突出显示(推荐)`
 ++下划线++
 ~下标~
 ^上标^
 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.
 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600)

 +++ **点击折叠**
 这是被隐藏的内容
 +++

::: tips success warning danger
这里是容器内的内容
:::

% note info % success warning danger
这里是容器内的内容
% endnote %

 --&gt;
&lt;h2 id=&quot;摘要&quot;&gt;摘要&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;本文介绍为EKS集群安装 AWS Load Balancer Controller 附加组件&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;参考资料：&lt;/p&gt;
&lt;ul class=&quot;lvl-2&quot;&gt;
&lt;li class=&quot;lvl-6&quot;&gt;&lt;a href=&quot;https://docs.aws.amazon.com/zh_cn/eks/latest/userguide&quot;&gt;Amazon EKS用户指南&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-6&quot;&gt;&lt;a href=&quot;https://kubernetes.io/zh-cn/docs/home/&quot;&gt;Kubernetes 文档&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="技术" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="aws" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/aws/"/>
    
    <category term="eks" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/aws/eks/"/>
    
    
    <category term="java" scheme="https://blog.hanqunfeng.com/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>AWS-EKS-06--安装 Amazon EFS CSI 驱动程序</title>
    <link href="https://blog.hanqunfeng.com/2023/07/07/aws-eks06-efs-csi/"/>
    <id>https://blog.hanqunfeng.com/2023/07/07/aws-eks06-efs-csi/</id>
    <published>2023-07-07T14:31:05.000Z</published>
    <updated>2023-07-17T08:28:44.555Z</updated>
    
    <content type="html"><![CDATA[<!-- **加粗** *斜体* ***加粗并斜体*** ~~删除线~~ ==突出显示== `突出显示(推荐)` ++下划线++ ~下标~ ^上标^ 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference. 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600) +++ **点击折叠** 这是被隐藏的内容 +++::: tips success warning danger这里是容器内的内容:::% note info % success warning danger这里是容器内的内容% endnote % --><h2 id="摘要">摘要</h2><ul class="lvl-0"><li class="lvl-2"><p>本文介绍为EKS集群安装 Amazon EFS CSI 驱动程序</p></li><li class="lvl-2"><p>参考资料：</p><ul class="lvl-2"><li class="lvl-6"><a href="https://docs.aws.amazon.com/zh_cn/eks/latest/userguide">Amazon EKS用户指南</a></li><li class="lvl-6"><a href="https://kubernetes.io/zh-cn/docs/home/">Kubernetes 文档</a></li></ul></li></ul><span id="more"></span><h2 id="EFS和EBS的选择？">EFS和EBS的选择？</h2><ul class="lvl-0"><li class="lvl-2"><p>如果是同一个Pod内的多个容器之间的存储共享，您可以考虑使用EBS卷。</p></li><li class="lvl-2"><p>如果是不同的Pod之间的存储共享，此时由于可能跨可用区，您可以考虑使用EFS文件系统。</p></li></ul><h2 id="安装-Amazon-EFS-CSI-驱动程序">安装 Amazon EFS CSI 驱动程序</h2><ul class="lvl-0"><li class="lvl-2"><p>创建 IAM policy和角色</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 从 GitHub 下载 IAM policy 文档</span></span><br><span class="line">$ curl -O https://raw.githubusercontent.com/kubernetes-sigs/aws-efs-csi-driver/master/docs/iam-policy-example.json</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建策略</span></span><br><span class="line">$ aws iam create-policy --profile eks-us-west-2 \</span><br><span class="line">    --policy-name AmazonEKS_EFS_CSI_Driver_Policy \</span><br><span class="line">    --policy-document file://iam-policy-example.json</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;Policy&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;PolicyName&quot;</span>: <span class="string">&quot;AmazonEKS_EFS_CSI_Driver_Policy&quot;</span>,</span><br><span class="line">        <span class="string">&quot;PolicyId&quot;</span>: <span class="string">&quot;ANPA22DP3G4GHPABMGFXG&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Arn&quot;</span>: <span class="string">&quot;arn:aws:iam::743263909655:policy/AmazonEKS_EFS_CSI_Driver_Policy&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Path&quot;</span>: <span class="string">&quot;/&quot;</span>,</span><br><span class="line">        <span class="string">&quot;DefaultVersionId&quot;</span>: <span class="string">&quot;v1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;AttachmentCount&quot;</span>: 0,</span><br><span class="line">        <span class="string">&quot;PermissionsBoundaryUsageCount&quot;</span>: 0,</span><br><span class="line">        <span class="string">&quot;IsAttachable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">&quot;CreateDate&quot;</span>: <span class="string">&quot;2023-07-03T07:35:31+00:00&quot;</span>,</span><br><span class="line">        <span class="string">&quot;UpdateDate&quot;</span>: <span class="string">&quot;2023-07-03T07:35:31+00:00&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 创建 IAM 角色并向其附加此 IAM policy</span></span><br><span class="line"><span class="comment"># 注意这里并没有指定角色名称，所以会自动生成一个角色名称并绑定到SA上</span></span><br><span class="line">$ eksctl create iamserviceaccount \</span><br><span class="line">    --cluster eks-lexing \</span><br><span class="line">    --profile eks-us-west-2 \</span><br><span class="line">    --namespace kube-system \</span><br><span class="line">    --name efs-csi-controller-sa \</span><br><span class="line">    --attach-policy-arn arn:aws:iam::743263909655:policy/AmazonEKS_EFS_CSI_Driver_Policy \</span><br><span class="line">    --approve</span><br><span class="line">2023-07-03 15:38:07 [ℹ]  2 existing iamserviceaccount(s) (kube-system/aws-node,kube-system/ebs-csi-controller-sa) will be excluded</span><br><span class="line">2023-07-03 15:38:07 [ℹ]  1 iamserviceaccount (kube-system/efs-csi-controller-sa) was included (based on the include/exclude rules)</span><br><span class="line">2023-07-03 15:38:07 [!]  serviceaccounts that exist <span class="keyword">in</span> Kubernetes will be excluded, use --override-existing-serviceaccounts to override</span><br><span class="line">2023-07-03 15:38:07 [ℹ]  1 task: &#123;</span><br><span class="line">    2 sequential sub-tasks: &#123;</span><br><span class="line">        create IAM role <span class="keyword">for</span> serviceaccount <span class="string">&quot;kube-system/efs-csi-controller-sa&quot;</span>,</span><br><span class="line">        create serviceaccount <span class="string">&quot;kube-system/efs-csi-controller-sa&quot;</span>,</span><br><span class="line">    &#125; &#125;2023-07-03 15:38:07 [ℹ]  building iamserviceaccount stack <span class="string">&quot;eksctl-eks-lexing-addon-iamserviceaccount-kube-system-efs-csi-controller-sa&quot;</span></span><br><span class="line">2023-07-03 15:38:08 [ℹ]  deploying stack <span class="string">&quot;eksctl-eks-lexing-addon-iamserviceaccount-kube-system-efs-csi-controller-sa&quot;</span></span><br><span class="line">2023-07-03 15:38:08 [ℹ]  waiting <span class="keyword">for</span> CloudFormation stack <span class="string">&quot;eksctl-eks-lexing-addon-iamserviceaccount-kube-system-efs-csi-controller-sa&quot;</span></span><br><span class="line">2023-07-03 15:38:39 [ℹ]  waiting <span class="keyword">for</span> CloudFormation stack <span class="string">&quot;eksctl-eks-lexing-addon-iamserviceaccount-kube-system-efs-csi-controller-sa&quot;</span></span><br><span class="line">2023-07-03 15:38:40 [ℹ]  created serviceaccount <span class="string">&quot;kube-system/efs-csi-controller-sa&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看创建后的SA，这里可以看到自动创建的角色名称</span></span><br><span class="line">$ k describe sa efs-csi-controller-sa</span><br><span class="line">Name:                efs-csi-controller-sa</span><br><span class="line">Namespace:           kube-system</span><br><span class="line">Labels:              app.kubernetes.io/managed-by=eksctl</span><br><span class="line">Annotations:         eks.amazonaws.com/role-arn: arn:aws:iam::743263909644:role/eksctl-eks-lexing-addon-iamserviceaccount-ku-Role1-BOQ7WRWAQDOY</span><br><span class="line">Image pull secrets:  &lt;none&gt;</span><br><span class="line">Mountable secrets:   &lt;none&gt;</span><br><span class="line">Tokens:              &lt;none&gt;</span><br><span class="line">Events:              &lt;none&gt;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>安装 Amazon EFS 驱动程序</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加 Helm 存储库。</span></span><br><span class="line">$ helm repo add aws-efs-csi-driver https://kubernetes-sigs.github.io/aws-efs-csi-driver/</span><br><span class="line"><span class="comment"># 更新存储库</span></span><br><span class="line">$ helm repo update aws-efs-csi-driver</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 Helm Chart 安装驱动程序的版本。</span></span><br><span class="line"><span class="comment"># 请将存储库地址替换为集群的容器镜像地址:https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/add-ons-images.html</span></span><br><span class="line">$ helm upgrade -i aws-efs-csi-driver aws-efs-csi-driver/aws-efs-csi-driver \</span><br><span class="line">    --namespace kube-system \</span><br><span class="line">    --<span class="built_in">set</span> image.repository=602401143452.dkr.ecr.us-west-2.amazonaws.com/eks/aws-efs-csi-driver \</span><br><span class="line">    --<span class="built_in">set</span> controller.serviceAccount.create=<span class="literal">false</span> \</span><br><span class="line">    --<span class="built_in">set</span> controller.serviceAccount.name=efs-csi-controller-sa</span><br><span class="line">Release <span class="string">&quot;aws-efs-csi-driver&quot;</span> has been upgraded. Happy Helming!</span><br><span class="line">NAME: aws-efs-csi-driver</span><br><span class="line">LAST DEPLOYED: Mon Jul  3 16:08:38 2023</span><br><span class="line">NAMESPACE: kube-system</span><br><span class="line">STATUS: deployed</span><br><span class="line">REVISION: 1</span><br><span class="line">TEST SUITE: None</span><br><span class="line">NOTES:</span><br><span class="line">To verify that aws-efs-csi-driver has started, run:</span><br><span class="line"></span><br><span class="line">    kubectl get pod -n kube-system -l <span class="string">&quot;app.kubernetes.io/name=aws-efs-csi-driver,app.kubernetes.io/instance=aws-efs-csi-driver&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看pod启动情况</span></span><br><span class="line">$ kubectl get pod -n kube-system -l <span class="string">&quot;app.kubernetes.io/name=aws-efs-csi-driver,app.kubernetes.io/instance=aws-efs-csi-driver&quot;</span></span><br><span class="line">NAME                                  READY   STATUS    RESTARTS   AGE</span><br><span class="line">efs-csi-controller-5c86cf4947-77dxh   3/3     Running   0          23s</span><br><span class="line">efs-csi-controller-5c86cf4947-w6s6m   3/3     Running   0          23s</span><br><span class="line">efs-csi-node-22mbf                    3/3     Running   0          7m41s</span><br><span class="line">efs-csi-node-swc6t                    3/3     Running   0          7m40s</span><br><span class="line"></span><br><span class="line"><span class="comment">#  如果pod启动失败，可能是镜像下载的问题，可以先删除deploy后重新执行 helm upgrade ...</span></span><br><span class="line">$ k delete deploy -n kube-system efs-csi-controller</span><br></pre></td></tr></table></figure><h2 id="创建-Amazon-EFS-文件系统">创建 Amazon EFS 文件系统</h2><ul class="lvl-0"><li class="lvl-2"><p>创建安全组</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检索您的集群所在的 VPC ID，并将其存储在变量中，以便在后续步骤中使用。</span></span><br><span class="line">$ vpc_id=$(aws eks describe-cluster \</span><br><span class="line">    --name eks-lexing \</span><br><span class="line">    --profile eks-us-west-2 \</span><br><span class="line">    --query <span class="string">&quot;cluster.resourcesVpcConfig.vpcId&quot;</span> \</span><br><span class="line">    --output text)</span><br><span class="line">$ <span class="built_in">echo</span> <span class="variable">$vpc_id</span></span><br><span class="line">vpc-088a65d5af782c20a</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检索您的集群的 VPC 的 CIDR 范围，并将其存储在变量中，以便在后续步骤中使用</span></span><br><span class="line">$ cidr_range=$(aws ec2 describe-vpcs \</span><br><span class="line">    --vpc-ids <span class="variable">$vpc_id</span> \</span><br><span class="line">    --profile eks-us-west-2 \</span><br><span class="line">    --query <span class="string">&quot;Vpcs[].CidrBlock&quot;</span> \</span><br><span class="line">    --output text)</span><br><span class="line">$ <span class="built_in">echo</span> <span class="variable">$cidr_range</span></span><br><span class="line">192.168.0.0/16</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个安全组，该安全组包含一条允许您的 Amazon EFS 挂载点的入站 NFS 流量的入站规则</span></span><br><span class="line">$ security_group_id=$(aws ec2 create-security-group \</span><br><span class="line">    --group-name MyEfsSecurityGroup \</span><br><span class="line">    --description <span class="string">&quot;My EFS security group&quot;</span> \</span><br><span class="line">    --vpc-id <span class="variable">$vpc_id</span> \</span><br><span class="line">    --profile eks-us-west-2 \</span><br><span class="line">    --output text)</span><br><span class="line">$ <span class="built_in">echo</span> <span class="variable">$security_group_id</span></span><br><span class="line">sg-0d77e111b519834be</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一条入站规则，该入站规则允许来自您的集群 VPC 的 CIDR 的入站 NFS 流量。</span></span><br><span class="line">$ aws ec2 authorize-security-group-ingress \</span><br><span class="line">    --profile eks-us-west-2 \</span><br><span class="line">    --group-id <span class="variable">$security_group_id</span> \</span><br><span class="line">    --protocol tcp \</span><br><span class="line">    --port 2049 \</span><br><span class="line">    --cidr <span class="variable">$cidr_range</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;Return&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;SecurityGroupRules&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;SecurityGroupRuleId&quot;</span>: <span class="string">&quot;sgr-09e1d9d2ec6d9bbe9&quot;</span>,</span><br><span class="line">            <span class="string">&quot;GroupId&quot;</span>: <span class="string">&quot;sg-0d77e111b519834be&quot;</span>,</span><br><span class="line">            <span class="string">&quot;GroupOwnerId&quot;</span>: <span class="string">&quot;743263909644&quot;</span>,</span><br><span class="line">            <span class="string">&quot;IsEgress&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;IpProtocol&quot;</span>: <span class="string">&quot;tcp&quot;</span>,</span><br><span class="line">            <span class="string">&quot;FromPort&quot;</span>: 2049,</span><br><span class="line">            <span class="string">&quot;ToPort&quot;</span>: 2049,</span><br><span class="line">            <span class="string">&quot;CidrIpv4&quot;</span>: <span class="string">&quot;192.168.0.0/16&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/mgMVfF.jpg" alt="" width="1200" height="600"></p><ul class="lvl-0"><li class="lvl-2"><p>创建EFS</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建文件系统</span></span><br><span class="line">$ file_system_id=$(aws efs create-file-system \</span><br><span class="line">    --profile eks-us-west-2 \</span><br><span class="line">    --performance-mode generalPurpose \</span><br><span class="line">    --query <span class="string">&#x27;FileSystemId&#x27;</span> \</span><br><span class="line">    --output text)</span><br><span class="line">$ <span class="built_in">echo</span> <span class="variable">$file_system_id</span></span><br><span class="line">fs-09447193939058538</span><br></pre></td></tr></table></figure><p><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/pt4Y4d.jpg" alt="" width="1200" height="300"></p><h2 id="EFS挂载目标和安全组（网络配置）">EFS挂载目标和安全组（网络配置）</h2><ul class="lvl-0"><li class="lvl-2"><p>确定集群中节点所在的子网的 ID 以及子网所在的可用区</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建挂载目标</span></span><br><span class="line"><span class="comment"># 确定您的集群节点的 IP 地址</span></span><br><span class="line">$ kubectl get nodes</span><br><span class="line">NAME                                           STATUS   ROLES    AGE     VERSION</span><br><span class="line">ip-192-168-16-155.us-west-2.compute.internal   Ready    &lt;none&gt;   3d20h   v1.26.4-eks-0a21954</span><br><span class="line">ip-192-168-48-14.us-west-2.compute.internal    Ready    &lt;none&gt;   3d21h   v1.26.4-eks-0a21954</span><br><span class="line"></span><br><span class="line"><span class="comment"># 确定 VPC 中子网的 ID 以及子网所在的可用区</span></span><br><span class="line">$ aws ec2 describe-subnets \</span><br><span class="line">    --profile eks-us-west-2 \</span><br><span class="line">    --filters <span class="string">&quot;Name=vpc-id,Values=<span class="variable">$vpc_id</span>&quot;</span> \</span><br><span class="line">    --query <span class="string">&#x27;Subnets[*].&#123;SubnetId: SubnetId,AvailabilityZone: AvailabilityZone,CidrBlock: CidrBlock&#125;&#x27;</span> \</span><br><span class="line">    --output table</span><br><span class="line">----------------------------------------------------------------------</span><br><span class="line">|                           DescribeSubnets                          |</span><br><span class="line">+------------------+--------------------+----------------------------+</span><br><span class="line">| AvailabilityZone |     CidrBlock      |         SubnetId           |</span><br><span class="line">+------------------+--------------------+----------------------------+</span><br><span class="line">|  us-west-2b      |  192.168.128.0/19  |  subnet-0e3290a40a483710d  |</span><br><span class="line">|  us-west-2a      |  192.168.96.0/19   |  subnet-0f6ec8eb7dafcccc0  |</span><br><span class="line">|  us-west-2b      |  192.168.32.0/19   |  subnet-035d3e96d37614fc4  |</span><br><span class="line">|  us-west-2d      |  192.168.64.0/19   |  subnet-0ca60ec494d31c2cb  |</span><br><span class="line">|  us-west-2a      |  192.168.0.0/19    |  subnet-04c4cbdbfdfd8d0d5  |</span><br><span class="line">|  us-west-2d      |  192.168.160.0/19  |  subnet-026f4c6fd339f0dbd  |</span><br><span class="line">+------------------+--------------------+----------------------------+</span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算node节点的网络地址</span></span><br><span class="line"><span class="comment"># 如下为linux下使用ipcalc命令的方式</span></span><br><span class="line">$ ipcalc -n 192.168.16.155/19</span><br><span class="line">NETWORK=192.168.0.0</span><br><span class="line">$ ipcalc -n 192.168.48.14/19</span><br><span class="line">NETWORK=192.168.32.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># mac下使用ipcalc命令，安装 ： brew install ipcalc</span></span><br><span class="line">$ ipcalc -b 192.168.16.155/19 | grep Network</span><br><span class="line">Network:   192.168.0.0/19</span><br><span class="line"></span><br><span class="line"><span class="comment"># 192-168-16-155 节点的ip地址是属于 |  us-west-2a      |  192.168.0.0/19    |  subnet-04c4cbdbfdfd8d0d5  |</span></span><br><span class="line"><span class="comment"># 192-168-48-14  节点的ip地址是属于 |  us-west-2b      |  192.168.32.0/19   |  subnet-035d3e96d37614fc4  |</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>为节点所在的子网添加挂载目标</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 为每个 AZ 中有节点的子网运行一次挂载命令，注意替换相应的子网 ID，所以这里两个节点都要创建挂载目标</span></span><br><span class="line">$ aws efs create-mount-target \</span><br><span class="line">    --profile eks-us-west-2 \</span><br><span class="line">    --file-system-id <span class="variable">$file_system_id</span> \</span><br><span class="line">    --subnet-id subnet-04c4cbdbfdfd8d0d5 \</span><br><span class="line">    --security-groups <span class="variable">$security_group_id</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;OwnerId&quot;</span>: <span class="string">&quot;743263909644&quot;</span>,</span><br><span class="line">    <span class="string">&quot;MountTargetId&quot;</span>: <span class="string">&quot;fsmt-0368ff60b5e4c39ed&quot;</span>,</span><br><span class="line">    <span class="string">&quot;FileSystemId&quot;</span>: <span class="string">&quot;fs-09447193939058538&quot;</span>,</span><br><span class="line">    <span class="string">&quot;SubnetId&quot;</span>: <span class="string">&quot;subnet-04c4cbdbfdfd8d0d5&quot;</span>,</span><br><span class="line">    <span class="string">&quot;LifeCycleState&quot;</span>: <span class="string">&quot;creating&quot;</span>,</span><br><span class="line">    <span class="string">&quot;IpAddress&quot;</span>: <span class="string">&quot;192.168.4.196&quot;</span>,</span><br><span class="line">    <span class="string">&quot;NetworkInterfaceId&quot;</span>: <span class="string">&quot;eni-03068e2d0265fe8e8&quot;</span>,</span><br><span class="line">    <span class="string">&quot;AvailabilityZoneId&quot;</span>: <span class="string">&quot;usw2-az1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;AvailabilityZoneName&quot;</span>: <span class="string">&quot;us-west-2a&quot;</span>,</span><br><span class="line">    <span class="string">&quot;VpcId&quot;</span>: <span class="string">&quot;vpc-088a65d5af782c20a&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ aws efs create-mount-target \</span><br><span class="line">    --profile eks-us-west-2 \</span><br><span class="line">    --file-system-id <span class="variable">$file_system_id</span> \</span><br><span class="line">    --subnet-id subnet-035d3e96d37614fc4 \</span><br><span class="line">    --security-groups <span class="variable">$security_group_id</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;OwnerId&quot;</span>: <span class="string">&quot;743263909644&quot;</span>,</span><br><span class="line">    <span class="string">&quot;MountTargetId&quot;</span>: <span class="string">&quot;fsmt-0612899b2439161c7&quot;</span>,</span><br><span class="line">    <span class="string">&quot;FileSystemId&quot;</span>: <span class="string">&quot;fs-09447193939058538&quot;</span>,</span><br><span class="line">    <span class="string">&quot;SubnetId&quot;</span>: <span class="string">&quot;subnet-035d3e96d37614fc4&quot;</span>,</span><br><span class="line">    <span class="string">&quot;LifeCycleState&quot;</span>: <span class="string">&quot;creating&quot;</span>,</span><br><span class="line">    <span class="string">&quot;IpAddress&quot;</span>: <span class="string">&quot;192.168.62.58&quot;</span>,</span><br><span class="line">    <span class="string">&quot;NetworkInterfaceId&quot;</span>: <span class="string">&quot;eni-051bfd62c82bc0b51&quot;</span>,</span><br><span class="line">    <span class="string">&quot;AvailabilityZoneId&quot;</span>: <span class="string">&quot;usw2-az2&quot;</span>,</span><br><span class="line">    <span class="string">&quot;AvailabilityZoneName&quot;</span>: <span class="string">&quot;us-west-2b&quot;</span>,</span><br><span class="line">    <span class="string">&quot;VpcId&quot;</span>: <span class="string">&quot;vpc-088a65d5af782c20a&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检索文件系统的装载目标列表</span></span><br><span class="line">$ aws efs describe-mount-targets --file-system-id <span class="variable">$file_system_id</span> --profile eks-us-west-2</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;MountTargets&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;OwnerId&quot;</span>: <span class="string">&quot;743263909644&quot;</span>,</span><br><span class="line">            <span class="string">&quot;MountTargetId&quot;</span>: <span class="string">&quot;fsmt-0368ff60b5e4c39ed&quot;</span>,</span><br><span class="line">            <span class="string">&quot;FileSystemId&quot;</span>: <span class="string">&quot;fs-09447193939058538&quot;</span>,</span><br><span class="line">            <span class="string">&quot;SubnetId&quot;</span>: <span class="string">&quot;subnet-04c4cbdbfdfd8d0d5&quot;</span>,</span><br><span class="line">            <span class="string">&quot;LifeCycleState&quot;</span>: <span class="string">&quot;available&quot;</span>,</span><br><span class="line">            <span class="string">&quot;IpAddress&quot;</span>: <span class="string">&quot;192.168.4.196&quot;</span>,</span><br><span class="line">            <span class="string">&quot;NetworkInterfaceId&quot;</span>: <span class="string">&quot;eni-03068e2d0265fe8e8&quot;</span>,</span><br><span class="line">            <span class="string">&quot;AvailabilityZoneId&quot;</span>: <span class="string">&quot;usw2-az1&quot;</span>,</span><br><span class="line">            <span class="string">&quot;AvailabilityZoneName&quot;</span>: <span class="string">&quot;us-west-2a&quot;</span>,</span><br><span class="line">            <span class="string">&quot;VpcId&quot;</span>: <span class="string">&quot;vpc-088a65d5af782c20a&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;OwnerId&quot;</span>: <span class="string">&quot;743263909644&quot;</span>,</span><br><span class="line">            <span class="string">&quot;MountTargetId&quot;</span>: <span class="string">&quot;fsmt-0612899b2439161c7&quot;</span>,</span><br><span class="line">            <span class="string">&quot;FileSystemId&quot;</span>: <span class="string">&quot;fs-09447193939058538&quot;</span>,</span><br><span class="line">            <span class="string">&quot;SubnetId&quot;</span>: <span class="string">&quot;subnet-035d3e96d37614fc4&quot;</span>,</span><br><span class="line">            <span class="string">&quot;LifeCycleState&quot;</span>: <span class="string">&quot;available&quot;</span>,</span><br><span class="line">            <span class="string">&quot;IpAddress&quot;</span>: <span class="string">&quot;192.168.62.58&quot;</span>,</span><br><span class="line">            <span class="string">&quot;NetworkInterfaceId&quot;</span>: <span class="string">&quot;eni-051bfd62c82bc0b51&quot;</span>,</span><br><span class="line">            <span class="string">&quot;AvailabilityZoneId&quot;</span>: <span class="string">&quot;usw2-az2&quot;</span>,</span><br><span class="line">            <span class="string">&quot;AvailabilityZoneName&quot;</span>: <span class="string">&quot;us-west-2b&quot;</span>,</span><br><span class="line">            <span class="string">&quot;VpcId&quot;</span>: <span class="string">&quot;vpc-088a65d5af782c20a&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="删除EFS">删除EFS</h2><ul class="lvl-0"><li class="lvl-2"><p>在使用AWS CLI命令删除文件系统之前，必须先删除为文件系统创建的所有装载目标和接入点。</p></li><li class="lvl-2"><p>删除现有的挂载目标</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注意要替换 --mount-target-id fsmt-0368ff60b5e4c39ed，要删除几个挂载目标就执行几次命令</span></span><br><span class="line">$ aws efs delete-mount-target \</span><br><span class="line">    --mount-target-id fsmt-0368ff60b5e4c39ed \</span><br><span class="line">    --profile eks-us-west-2</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>删除efs</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 控制台也可以删除</span></span><br><span class="line">$ aws efs delete-file-system \</span><br><span class="line">    --file-system-id <span class="variable">$file_system_id</span>  \</span><br><span class="line">    --profile eks-us-west-2</span><br></pre></td></tr></table></figure><h2 id="测试">测试</h2><h3 id="Dynamic-demo">Dynamic-demo</h3><ul class="lvl-0"><li class="lvl-2"><p>检索您的 Amazon EFS 文件系统 ID。您可以在 Amazon EFS 控制台中查找此信息，或者使用以下 AWS CLI 命令。</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检索您的 Amazon EFS 文件系统 ID</span></span><br><span class="line">$ aws efs describe-file-systems --profile eks-us-west-2 --query <span class="string">&quot;FileSystems[*].FileSystemId&quot;</span> --output text</span><br><span class="line">fs-09447193939058538</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>创建storageclass</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># storageclass.yaml，fileSystemId: fs-09447193939058538</span></span><br><span class="line">kind: StorageClass</span><br><span class="line">apiVersion: storage.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: efs-sc</span><br><span class="line">provisioner: efs.csi.aws.com <span class="comment"># 指定用于动态卷分配的 CSI 驱动程序</span></span><br><span class="line">parameters:</span><br><span class="line">  provisioningMode: efs-ap <span class="comment"># 指定 EFS 文件系统的挂载模式为 &quot;efs-ap&quot;。这表示 EFS 将以 AccessPoint 的形式挂载到 Kubernetes Pod 中</span></span><br><span class="line">  fileSystemId: fs-09447193939058538 <span class="comment"># 指定用于动态卷分配的 EFS 文件系统的 ID</span></span><br><span class="line">  directoryPerms: <span class="string">&quot;700&quot;</span> <span class="comment"># 指定新创建的目录的权限模式。这里的 &quot;700&quot; 表示目录的权限为 rwx------。</span></span><br><span class="line">  gidRangeStart: <span class="string">&quot;1000&quot;</span> <span class="comment"># 可选参数，指定新创建的目录的 GID 范围的起始值。</span></span><br><span class="line">  gidRangeEnd: <span class="string">&quot;2000&quot;</span> <span class="comment"># 可选参数，指定新创建的目录的 GID 范围的结束值。</span></span><br><span class="line">  basePath: <span class="string">&quot;/dynamic_provisioning&quot;</span> <span class="comment"># 可选参数，指定新创建的目录的基本路径。这里的 &quot;/dynamic_provisioning&quot; 是一个示例路径，你可以根据需要设置合适的基本路径。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># provisioningMode 可以设置以下值：</span></span><br><span class="line"><span class="comment"># efs-ap: 使用 Access Point（访问点）模式挂载 EFS 文件系统。在此模式下，每个挂载点都会创建一个唯一的访问点，并授予 Pod 对该访问点的访问权限。每个访问点都可以独立设置权限和配额，从而实现更好的隔离和控制。</span></span><br><span class="line"><span class="comment"># efs-csi: 使用传统的 EFS CSI 挂载模式。在此模式下，使用文件系统 ID 直接挂载整个 EFS 文件系统，而不是使用访问点。这种模式下的挂载是共享的，所有使用该存储类的 Pod 都将共享相同的文件系统和权限。</span></span><br><span class="line"><span class="comment"># provisioningMode 的默认值是 efs-csi。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 部署</span></span><br><span class="line">$ k apply -f storageclass.yaml</span><br><span class="line">storageclass.storage.k8s.io/efs-sc created</span><br><span class="line"><span class="comment"># 查看sc</span></span><br><span class="line">$ k get sc</span><br><span class="line">NAME            PROVISIONER             RECLAIMPOLICY   VOLUMEBINDINGMODE      ALLOWVOLUMEEXPANSION   AGE</span><br><span class="line">efs-sc          efs.csi.aws.com         Delete          Immediate              <span class="literal">false</span>                  7s</span><br><span class="line">gp2 (default)   kubernetes.io/aws-ebs   Delete          WaitForFirstConsumer   <span class="literal">false</span>                  5d3h</span><br><span class="line">gp3             ebs.csi.aws.com         Delete          WaitForFirstConsumer   <span class="literal">true</span>                   5d</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>创建pvc，指定 storageClassName: efs-sc</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># pvc.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line">  name: efs-claim</span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteMany</span><br><span class="line">  storageClassName: efs-sc</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 5Gi</span><br><span class="line"><span class="comment"># 部署pvc</span></span><br><span class="line">$ k apply -f pvc.yaml</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>创建pod</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># pod.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: efs-app</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">    - name: app</span><br><span class="line">      image: centos</span><br><span class="line">      <span class="built_in">command</span>: [<span class="string">&quot;/bin/sh&quot;</span>]</span><br><span class="line">      args: [<span class="string">&quot;-c&quot;</span>, <span class="string">&quot;while true; do echo <span class="subst">$(date -u)</span> &gt;&gt; /data/out; sleep 5; done&quot;</span>]</span><br><span class="line">      volumeMounts:</span><br><span class="line">        - name: persistent-storage</span><br><span class="line">          mountPath: /data</span><br><span class="line">  volumes:</span><br><span class="line">    - name: persistent-storage</span><br><span class="line">      persistentVolumeClaim:</span><br><span class="line">        claimName: efs-claim</span><br><span class="line"><span class="comment"># 部署pod</span></span><br><span class="line">$ k apply -f pod.yaml</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>查看</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看pv</span></span><br><span class="line">$ k get pv</span><br><span class="line">NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                STORAGECLASS   REASON   AGE</span><br><span class="line">pvc-edc00435-ef8e-49c6-9e3d-9697735e7108   5Gi        RWX            Delete           Bound    <span class="built_in">test</span>/efs-claim       efs-sc                  62s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看pvc</span></span><br><span class="line">$ k get pvc</span><br><span class="line">NAME            STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">efs-claim       Bound    pvc-edc00435-ef8e-49c6-9e3d-9697735e7108   5Gi        RWX            efs-sc         72s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看pod</span></span><br><span class="line">$ k get pods -o wide</span><br><span class="line">NAME                  READY   STATUS    RESTARTS   AGE     IP               NODE                                           NOMINATED NODE   READINESS GATES</span><br><span class="line">efs-app               1/1     Running   0          2m41s   192.168.34.220   ip-192-168-48-14.us-west-2.compute.internal    &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看输出</span></span><br><span class="line">$ k <span class="built_in">exec</span> -it efs-app -- bash -c <span class="string">&quot;cat data/out&quot;</span></span><br><span class="line">Mon Jul 3 09:39:49 UTC 2023</span><br><span class="line">Mon Jul 3 09:39:54 UTC 2023</span><br><span class="line">Mon Jul 3 09:39:59 UTC 2023</span><br><span class="line">Mon Jul 3 09:40:04 UTC 2023</span><br><span class="line">Mon Jul 3 09:40:09 UTC 2023</span><br><span class="line">…………………………………………………………………………</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看挂载</span></span><br><span class="line">$ k <span class="built_in">exec</span> -it efs-app -- bash -c <span class="string">&quot;df -h&quot;</span></span><br><span class="line">Filesystem      Size  Used Avail Use% Mounted on</span><br><span class="line">overlay          80G  4.2G   76G   6% /</span><br><span class="line">tmpfs            64M     0   64M   0% /dev</span><br><span class="line">tmpfs           3.8G     0  3.8G   0% /sys/fs/cgroup</span><br><span class="line">127.0.0.1:/     8.0E     0  8.0E   0% /data</span><br><span class="line">/dev/nvme0n1p1   80G  4.2G   76G   6% /etc/hosts</span><br><span class="line">shm              64M     0   64M   0% /dev/shm</span><br><span class="line">tmpfs           6.9G   12K  6.9G   1% /run/secrets/kubernetes.io/serviceaccount</span><br><span class="line">tmpfs           3.8G     0  3.8G   0% /proc/acpi</span><br><span class="line">tmpfs           3.8G     0  3.8G   0% /sys/firmware</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>此时只删除pod并重新创建pod，则之前的磁盘数据还在。如果删除pvc并重建pvc，则原先的数据就没有了。</p></li><li class="lvl-2"><p>删除测试用例</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ k delete -f pod.yaml</span><br><span class="line">$ k delete -f pvc.yaml</span><br><span class="line">$ k delete -f storageclass.yaml</span><br></pre></td></tr></table></figure><h3 id="Static-demo">Static-demo</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 示例项目</span></span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/kubernetes-sigs/aws-efs-csi-driver.git</span><br><span class="line"><span class="comment"># 这个目录下有很多示例</span></span><br><span class="line">$ <span class="built_in">cd</span> aws-efs-csi-driver/examples/kubernetes/</span><br><span class="line"><span class="comment"># 比如这里以 multiple_pods 为例说明，两个pod挂载同一个efs</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># storageclass.yaml</span></span><br><span class="line"><span class="comment"># provisioningMode 的默认值是 efs-csi</span></span><br><span class="line">kind: StorageClass</span><br><span class="line">apiVersion: storage.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: efs-sc</span><br><span class="line">provisioner: efs.csi.aws.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># pv.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: efs-pv</span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 5Gi  <span class="comment"># efs会忽略，efs是没有大小限制的，但是为了符合k8s创建pv的语法规则，这里随便写一个值</span></span><br><span class="line">  volumeMode: Filesystem</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteMany  <span class="comment"># 支持多个pod同时读写</span></span><br><span class="line">  persistentVolumeReclaimPolicy: Retain</span><br><span class="line">  storageClassName: efs-sc</span><br><span class="line">  csi:</span><br><span class="line">    driver: efs.csi.aws.com</span><br><span class="line">    volumeHandle: fs-09447193939058538</span><br><span class="line"></span><br><span class="line"><span class="comment"># claim.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line">  name: efs-claim</span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteMany  <span class="comment"># 支持多个pod同时读写</span></span><br><span class="line">  storageClassName: efs-sc</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 5Gi</span><br><span class="line"></span><br><span class="line"><span class="comment"># pod1.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: app1</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: app1</span><br><span class="line">    image: busybox</span><br><span class="line">    <span class="built_in">command</span>: [<span class="string">&quot;/bin/sh&quot;</span>]</span><br><span class="line">    args: [<span class="string">&quot;-c&quot;</span>, <span class="string">&quot;while true; do echo <span class="subst">$(date -u)</span> &gt;&gt; /data/out1.txt; sleep 5; done&quot;</span>]</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: persistent-storage</span><br><span class="line">      mountPath: /data</span><br><span class="line">  volumes:</span><br><span class="line">  - name: persistent-storage</span><br><span class="line">    persistentVolumeClaim:</span><br><span class="line">      claimName: efs-claim</span><br><span class="line"></span><br><span class="line"><span class="comment"># pod2.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: app2</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: app2</span><br><span class="line">    image: busybox</span><br><span class="line">    <span class="built_in">command</span>: [<span class="string">&quot;/bin/sh&quot;</span>]</span><br><span class="line">    args: [<span class="string">&quot;-c&quot;</span>, <span class="string">&quot;while true; do echo <span class="subst">$(date -u)</span> &gt;&gt; /data2/out2.txt; sleep 5; done&quot;</span>]</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: persistent-storage</span><br><span class="line">      mountPath: /data2</span><br><span class="line">  volumes:</span><br><span class="line">  - name: persistent-storage</span><br><span class="line">    persistentVolumeClaim:</span><br><span class="line">      claimName: efs-claim</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编辑 specs/pv.yaml 文件并将 volumeHandle 值替换为您的 Amazon EFS 文件系统 ID</span></span><br><span class="line">$ k apply -f specs/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看pv</span></span><br><span class="line">$ k get pv</span><br><span class="line">NAME     CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM            STORAGECLASS   REASON   AGE</span><br><span class="line">efs-pv   5Gi        RWX            Retain           Bound    <span class="built_in">test</span>/efs-claim   efs-sc                  9m11s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看pvc</span></span><br><span class="line">$ k get pvc</span><br><span class="line">NAME        STATUS   VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">efs-claim   Bound    efs-pv   5Gi        RWX            efs-sc         9m16s~</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看pod</span></span><br><span class="line">$ k get pod</span><br><span class="line">NAME   READY   STATUS    RESTARTS   AGE</span><br><span class="line">app1   1/1     Running   0          9m20s</span><br><span class="line">app2   1/1     Running   0          9m19s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 两个pod挂载的是同一个efs，所以两个pod内部会看到对方的文件</span></span><br><span class="line">$ k <span class="built_in">exec</span> -it app1 -- <span class="built_in">ls</span> /data</span><br><span class="line">dynamic_provisioning  out1.txt              out2.txt</span><br><span class="line"></span><br><span class="line">$ k <span class="built_in">exec</span> -it app2 -- <span class="built_in">ls</span> /data2</span><br><span class="line">dynamic_provisioning  out1.txt              out2.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清除测试内容</span></span><br><span class="line">$ k delete -f specs/</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;!--
 **加粗**
 *斜体*
 ***加粗并斜体***
 ~~删除线~~
 ==突出显示==
 `突出显示(推荐)`
 ++下划线++
 ~下标~
 ^上标^
 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.
 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600)

 +++ **点击折叠**
 这是被隐藏的内容
 +++

::: tips success warning danger
这里是容器内的内容
:::

% note info % success warning danger
这里是容器内的内容
% endnote %

 --&gt;
&lt;h2 id=&quot;摘要&quot;&gt;摘要&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;本文介绍为EKS集群安装 Amazon EFS CSI 驱动程序&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;参考资料：&lt;/p&gt;
&lt;ul class=&quot;lvl-2&quot;&gt;
&lt;li class=&quot;lvl-6&quot;&gt;&lt;a href=&quot;https://docs.aws.amazon.com/zh_cn/eks/latest/userguide&quot;&gt;Amazon EKS用户指南&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-6&quot;&gt;&lt;a href=&quot;https://kubernetes.io/zh-cn/docs/home/&quot;&gt;Kubernetes 文档&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="技术" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="aws" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/aws/"/>
    
    <category term="eks" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/aws/eks/"/>
    
    
    <category term="java" scheme="https://blog.hanqunfeng.com/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>AWS-EKS-05--安装 Amazon EBS CSI 驱动程序</title>
    <link href="https://blog.hanqunfeng.com/2023/07/07/aws-eks05-ebs-csi/"/>
    <id>https://blog.hanqunfeng.com/2023/07/07/aws-eks05-ebs-csi/</id>
    <published>2023-07-07T14:30:05.000Z</published>
    <updated>2023-07-17T08:22:17.318Z</updated>
    
    <content type="html"><![CDATA[<!-- **加粗** *斜体* ***加粗并斜体*** ~~删除线~~ ==突出显示== `突出显示(推荐)` ++下划线++ ~下标~ ^上标^ 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference. 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600) +++ **点击折叠** 这是被隐藏的内容 +++::: tips success warning danger这里是容器内的内容:::% note info % success warning danger这里是容器内的内容% endnote % --><h2 id="摘要">摘要</h2><ul class="lvl-0"><li class="lvl-2"><p>本文介绍在EKS集群中安装 Amazon EBS CSI 驱动程序过程</p></li><li class="lvl-2"><p>参考资料：</p><ul class="lvl-2"><li class="lvl-6"><a href="https://docs.aws.amazon.com/zh_cn/eks/latest/userguide">Amazon EKS用户指南</a></li><li class="lvl-6"><a href="https://kubernetes.io/zh-cn/docs/home/">Kubernetes 文档</a></li></ul></li></ul><span id="more"></span><h2 id="安装-Amazon-EBS-CSI-驱动程序">安装 Amazon EBS CSI 驱动程序</h2><ul class="lvl-0"><li class="lvl-2"><p>如果您计划将工作负载部署到使用 Amazon EBS 卷的集群，并且您创建了 1.23 或更高版本的集群，则在部署工作负载之前，您必须将 Amazon EBS CSI 驱动程序 安装到您的集群。</p></li><li class="lvl-2"><p>使用 eksctl 创建 Amazon EBS CSI 驱动程序 IAM 角色</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用以下命令创建 IAM 角色并附加所需的 AWS 托管策略。此命令将部署 AWS CloudFormation 堆栈，该堆栈将创建 IAM 角色，并会将 IAM policy 附加到该堆栈。如果您的集群位于 AWS GovCloud（美国东部）或 AWS GovCloud（美国西部）AWS 区域，则将 arn:aws: 替换为 arn:aws-us-gov:。</span></span><br><span class="line"><span class="comment"># 注意这里附加的策略是AWS托管策略</span></span><br><span class="line">$ eksctl create iamserviceaccount \</span><br><span class="line">    --name ebs-csi-controller-sa \</span><br><span class="line">    --namespace kube-system \</span><br><span class="line">    --cluster eks-lexing \</span><br><span class="line">    --profile eks-us-west-2 \</span><br><span class="line">    --role-name AmazonEKS_EBS_CSI_DriverRole \</span><br><span class="line">    --role-only \</span><br><span class="line">    --attach-policy-arn arn:aws:iam::aws:policy/service-role/AmazonEBSCSIDriverPolicy \</span><br><span class="line">    --approve</span><br><span class="line">2023-06-28 16:16:05 [ℹ]  1 iamserviceaccount (kube-system/ebs-csi-controller-sa) was included (based on the include/exclude rules)</span><br><span class="line">2023-06-28 16:16:05 [!]  serviceaccounts <span class="keyword">in</span> Kubernetes will not be created or modified, since the option --role-only is used</span><br><span class="line">2023-06-28 16:16:05 [ℹ]  1 task: &#123; create IAM role <span class="keyword">for</span> serviceaccount <span class="string">&quot;kube-system/ebs-csi-controller-sa&quot;</span> &#125;</span><br><span class="line">2023-06-28 16:16:05 [ℹ]  building iamserviceaccount stack <span class="string">&quot;eksctl-eks-lexing-addon-iamserviceaccount-kube-system-ebs-csi-controller-sa&quot;</span></span><br><span class="line">2023-06-28 16:16:06 [ℹ]  deploying stack <span class="string">&quot;eksctl-eks-lexing-addon-iamserviceaccount-kube-system-ebs-csi-controller-sa&quot;</span></span><br><span class="line">2023-06-28 16:16:06 [ℹ]  waiting <span class="keyword">for</span> CloudFormation stack <span class="string">&quot;eksctl-eks-lexing-addon-iamserviceaccount-kube-system-ebs-csi-controller-sa&quot;</span></span><br><span class="line">2023-06-28 16:16:37 [ℹ]  waiting <span class="keyword">for</span> CloudFormation stack <span class="string">&quot;eksctl-eks-lexing-addon-iamserviceaccount-kube-system-ebs-csi-controller-sa&quot;</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>将Amazon EBS CSI 驱动程序添加到集群</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 运行以下命令。如果您的集群位于 AWS GovCloud（美国东部）或 AWS GovCloud（美国西部）AWS 区域，则将 arn:aws: 替换为 arn:aws-us-gov:。</span></span><br><span class="line">$ eksctl create addon --name aws-ebs-csi-driver --cluster eks-lexing --profile eks-us-west-2 --service-account-role-arn arn:aws:iam::743263909655:role/AmazonEKS_EBS_CSI_DriverRole --force</span><br><span class="line">2023-06-28 16:23:59 [ℹ]  Kubernetes version <span class="string">&quot;1.25&quot;</span> <span class="keyword">in</span> use by cluster <span class="string">&quot;eks-lexing&quot;</span></span><br><span class="line">2023-06-28 16:24:00 [ℹ]  using provided ServiceAccountRoleARN <span class="string">&quot;arn:aws:iam::743263909655:role/AmazonEKS_EBS_CSI_DriverRole&quot;</span></span><br><span class="line">2023-06-28 16:24:00 [ℹ]  creating addon</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>检查 Amazon EBS CSI 驱动程序的当前版本，注意这里如果有可用更新，UPDATE AVAILABLE会显示，默认安装是最新版本</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ eksctl get addon --name aws-ebs-csi-driver --cluster eks-lexing --profile eks-us-west-2</span><br><span class="line">2023-06-28 16:24:08 [ℹ]  Kubernetes version <span class="string">&quot;1.25&quot;</span> <span class="keyword">in</span> use by cluster <span class="string">&quot;eks-lexing&quot;</span></span><br><span class="line">2023-06-28 16:24:09 [ℹ]  to see issues <span class="keyword">for</span> an addon run `eksctl get addon --name &lt;addon-name&gt; --cluster &lt;cluster-name&gt;`</span><br><span class="line">NAME            VERSION            STATUS        ISSUES    IAMROLE            UPDATE AVAILABLE    CONFIGURATION VALUES</span><br><span class="line">aws-ebs-csi-driver    v1.19.0-eksbuild.2    CREATING    0    arn:aws:iam::743263909655:role/AmazonEKS_EBS_CSI_DriverRole</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>插件安装完成后可以查看已经安装的资源，Name中含有 ebs-csi</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">~ k get all -n kube-system -l app.kubernetes.io/component=csi-driver</span><br><span class="line">NAME                                      READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/ebs-csi-controller-5f945bbdfc-m2smb   6/6     Running   0          10m</span><br><span class="line">pod/ebs-csi-controller-5f945bbdfc-nfl97   6/6     Running   0          10m</span><br><span class="line">pod/ebs-csi-node-kmtv9                    3/3     Running   0          10m</span><br><span class="line">pod/ebs-csi-node-tdw7m                    3/3     Running   0          10m</span><br><span class="line"></span><br><span class="line">NAME                                  DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR              AGE</span><br><span class="line">daemonset.apps/ebs-csi-node           2         2         2       2            2           kubernetes.io/os=linux     42h</span><br><span class="line">daemonset.apps/ebs-csi-node-windows   0         0         0       0            0           kubernetes.io/os=windows   42h</span><br><span class="line"></span><br><span class="line">NAME                                 READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/ebs-csi-controller   2/2     2            2           42h</span><br><span class="line"></span><br><span class="line">NAME                                            DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/ebs-csi-controller-57ff9dc5fc   0         0         0       42h</span><br><span class="line">replicaset.apps/ebs-csi-controller-5f945bbdfc   2         2         2       10m</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>此时可以通过aws控制台对eks的Amazon EBS CSI 驱动程序进行管理，后续升级可以直接在控制台进行<br><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/hTiCSv.png" alt="" width="1200" height="600"></p></li><li class="lvl-2"><p>查看Amazon EBS CSI 驱动程序的所有可用版本号</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ aws eks describe-addon-versions --addon-name aws-ebs-csi-driver --profile eks-us-west-2</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>更新 Amazon EBS CSI 驱动程序 ，–force 表示强制更新</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看是否有更新，可以看到UPDATE下有个可用更新版本 v1.20.0-eksbuild.1</span></span><br><span class="line">$ eksctl get addon --name aws-ebs-csi-driver --cluster eks-lexing --profile eks-us-west-2</span><br><span class="line">2023-06-30 10:21:31 [ℹ]  Kubernetes version <span class="string">&quot;1.26&quot;</span> <span class="keyword">in</span> use by cluster <span class="string">&quot;eks-lexing&quot;</span></span><br><span class="line">2023-06-30 10:21:32 [ℹ]  to see issues <span class="keyword">for</span> an addon run `eksctl get addon --name &lt;addon-name&gt; --cluster &lt;cluster-name&gt;`</span><br><span class="line">NAME            VERSION            STATUS    ISSUES    IAMROLE                                UPDATE AVAILABLE    CONFIGURATION VALUES</span><br><span class="line">aws-ebs-csi-driver    v1.19.0-eksbuild.2    ACTIVE    0    arn:aws:iam::743263909644:role/AmazonEKS_EBS_CSI_DriverRole    v1.20.0-eksbuild.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新到v1.20.0-eksbuild.1</span></span><br><span class="line">$ eksctl update addon --name aws-ebs-csi-driver --version v1.20.0-eksbuild.1 --cluster eks-lexing --profile eks-us-west-2 --force</span><br><span class="line">2023-06-30 10:22:23 [ℹ]  Kubernetes version <span class="string">&quot;1.26&quot;</span> <span class="keyword">in</span> use by cluster <span class="string">&quot;eks-lexing&quot;</span></span><br><span class="line">2023-06-30 10:22:24 [ℹ]  new version provided v1.20.0-eksbuild.1</span><br><span class="line">2023-06-30 10:22:24 [ℹ]  updating addon</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>删除 Amazon EBS CSI 驱动程序</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ eksctl delete addon --cluster eks-lexing --profile eks-us-west-2 --name aws-ebs-csi-driver --preserve</span><br></pre></td></tr></table></figure><div class="tips"><p><em><strong>默认eks为我们创建好了一个sc:gp2</strong></em></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 默认的gp2配置yaml,其被设置为默认存储类</span></span><br><span class="line">kind: StorageClass</span><br><span class="line">apiVersion: storage.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: gp2</span><br><span class="line">  annotations:</span><br><span class="line">    storageclass.kubernetes.io/is-default-class: <span class="string">&quot;true&quot;</span></span><br><span class="line">provisioner: kubernetes.io/aws-ebs</span><br><span class="line">parameters:</span><br><span class="line">  <span class="built_in">type</span>: gp2</span><br><span class="line">  fsType: ext4</span><br><span class="line"></span><br><span class="line"><span class="comment"># storageclass.kubernetes.io/is-default-class: &quot;true&quot; 这个注释表示其是默认存储类</span></span><br></pre></td></tr></table></figure><p><em><strong>关于默认存储类的说明</strong></em></p><ul class="lvl-1"><li class="lvl-2">在 AWS 的 Amazon EKS（Elastic Kubernetes Service）中，将一个 StorageClass（SC）设置为默认存储类具有以下作用：<ul class="lvl-3"><li class="lvl-6">自动分配: 当没有显式指定 StorageClass 的情况下，如果某个 Persistent Volume Claim（PVC）没有指定所需的 StorageClass，则默认会选择设置为默认存储类的 StorageClass 进行 PVC 的动态分配。</li><li class="lvl-6">简化配置: 默认存储类可以简化 PVC 的配置，因为您不需要为每个 PVC 显式指定 StorageClass。只需创建 PVC，并且它将自动使用默认存储类进行分配。</li><li class="lvl-6">默认设置: 默认存储类是集群级别的默认设置，适用于没有显式指定 StorageClass 的 PVC。这样可以确保在没有特定要求的情况下，PVC 可以使用预定义的默认存储类。</li><li class="lvl-6">在 AWS EKS 中，只能有一个 StorageClass 被设置为默认存储类。这是因为默认存储类是集群范围的全局设置，它用于满足未显式指定 StorageClass 的 PVC 的需求。如果有多个 StorageClass 被设置为默认，会导致混乱和不确定性，因为 Kubernetes 将无法确定使用哪个默认存储类。</li><li class="lvl-6">如果需要为不同的 PVC 使用不同的默认存储类，可以通过为每个 PVC 显式指定所需的 StorageClass 来实现，而不是依赖默认存储类。</li><li class="lvl-6">总结来说，通过设置默认存储类，您可以简化 PVC 的配置并定义集群范围的默认设置。但是，在 AWS EKS 中，只能有一个默认存储类。</li></ul></li></ul></div><h2 id="使用说明">使用说明</h2><ul class="lvl-0"><li class="lvl-2"><p>创建StorageClass</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建基于gp3的sc</span></span><br><span class="line"><span class="comment"># create-sc-gp3.yaml</span></span><br><span class="line">apiVersion: storage.k8s.io/v1</span><br><span class="line">kind: StorageClass</span><br><span class="line">metadata:</span><br><span class="line">  name: gp3</span><br><span class="line">provisioner: ebs.csi.aws.com</span><br><span class="line">volumeBindingMode: WaitForFirstConsumer</span><br><span class="line">parameters:</span><br><span class="line">  <span class="built_in">type</span>: gp3</span><br><span class="line">allowVolumeExpansion: <span class="literal">true</span></span><br><span class="line">reclaimPolicy: Delete</span><br><span class="line"></span><br><span class="line"><span class="comment"># 部署</span></span><br><span class="line">$ k apply -f create-sc-gp3.yaml</span><br><span class="line"><span class="comment"># 查看sc</span></span><br><span class="line">$ k get sc</span><br><span class="line">NAME            PROVISIONER             RECLAIMPOLICY   VOLUMEBINDINGMODE      ALLOWVOLUMEEXPANSION   AGE</span><br><span class="line">gp2 (default)   kubernetes.io/aws-ebs   Delete          WaitForFirstConsumer   <span class="literal">false</span>                  175m</span><br><span class="line">gp3             ebs.csi.aws.com         Delete          WaitForFirstConsumer   <span class="literal">true</span>                   6s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 虽然创建sc时没有为其指定默认存储类，我们可以通过如下命令将指定的sc设置为默认存储类</span></span><br><span class="line">$ k annotate storageclass gp3 storageclass.kubernetes.io/is-default-class=<span class="literal">true</span></span><br><span class="line"><span class="comment"># 此时原gp2的默认存储类不会被去掉</span></span><br><span class="line">$ k get sc</span><br><span class="line">NAME            PROVISIONER             RECLAIMPOLICY   VOLUMEBINDINGMODE      ALLOWVOLUMEEXPANSION   AGE</span><br><span class="line">gp2 (default)   kubernetes.io/aws-ebs   Delete          WaitForFirstConsumer   <span class="literal">false</span>                  20h</span><br><span class="line">gp3 (default)   ebs.csi.aws.com         Delete          WaitForFirstConsumer   <span class="literal">true</span>                   17h</span><br><span class="line"></span><br><span class="line"><span class="comment"># 取消指定的sc为默认存储类</span></span><br><span class="line">$ k annotate storageclass --overwrite=<span class="literal">true</span> gp3 storageclass.kubernetes.io/is-default-class=<span class="literal">false</span></span><br></pre></td></tr></table></figure><div class="tips"><p><em><strong>配置说明</strong></em></p><ul class="lvl-1"><li class="lvl-2">provisioner</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># provisioner 定义了用于动态分配 PV 的存储插件或存储后端。它指定了负责创建和管理 PV 的控制器。</span><br><span class="line"># provisioner 的值通常是存储提供商或存储插件的名称，例如</span><br><span class="line"># kubernetes.io/aws-ebs（用于 Amazon EBS）、</span><br><span class="line"># kubernetes.io/gce-pd（用于 Google Compute Engine PD）等。</span><br><span class="line"># 不同的存储插件或存储后端可能具有不同的特性和配置选项。</span><br><span class="line"># 这里的ebs.csi.aws.com就是我们安装的Amazon EBS CSI 附加组件。</span><br><span class="line"></span><br><span class="line"># 在 AWS 的 Amazon EKS（Elastic Kubernetes Service）中，创建 StorageClass（SC）时，支持以下一些常见的 provisioner（供应商）选项：</span><br><span class="line"># kubernetes.io/aws-ebs: 这是用于 Amazon EBS（Elastic Block Store）的默认 provisioner。它允许在 EKS 集群上动态分配和管理基于 Amazon EBS 的持久卷（PV）。</span><br><span class="line"># kubernetes.io/aws-s3: 这是用于 Amazon S3（Simple Storage Service）的 provisioner。它允许在 EKS 集群中创建和管理基于 Amazon S3 的持久卷。</span><br><span class="line"># kubernetes.io/azure-disk: 这是用于 Azure Disk 的 provisioner。它允许在 EKS 集群上动态分配和管理基于 Azure Disk 的持久卷。</span><br><span class="line"># kubernetes.io/azure-file: 这是用于 Azure File 的 provisioner。它允许在 EKS 集群中创建和管理基于 Azure File 的持久卷。</span><br><span class="line"># 这些是一些常见的 provisioner，但实际上，您还可以使用其他存储插件或自定义 provisioner，以满足您特定的存储需求。不同的存储插件和供应商可能会支持不同的 provisioner，具体取决于您所使用的存储插件和存储后端。</span><br><span class="line"># 在创建 StorageClass 时，您需要指定适当的 provisioner 标识符，以便 Kubernetes 和 EKS 能够根据指定的 provisioner 来分配和管理持久卷。</span><br></pre></td></tr></table></figure><ul class="lvl-1"><li class="lvl-2">allowVolumeExpansion</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># allowVolumeExpansion 是一个布尔值参数，用于指定是否允许 PVC 的大小在运行时进行扩展。</span><br><span class="line"># 如果将其设置为 true，则表示 PVC 可以动态扩展其大小以满足需求。</span><br><span class="line"># 如果将其设置为 false，则 PVC 的大小将在创建时被固定，并且不能在后续进行扩展。</span><br><span class="line"># 这取决于存储后端是否支持 PVC 大小的动态调整。</span><br></pre></td></tr></table></figure><ul class="lvl-1"><li class="lvl-2"><p>volumeBindingMode</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 在创建 StorageClass 时，可以指定 volumeBindingMode 来定义持久卷（Persistent Volume，PV）与 Persistent Volume Claim（PVC）之间的绑定行为。volumeBindingMode 可以具有以下几种选项：</span><br><span class="line"># Immediate: 当使用 Immediate 绑定模式时，Kubernetes 立即绑定 PVC 和 PV。这意味着在创建 PVC 时，Kubernetes 将立即选择并绑定一个可用的 PV。这种模式适用于那些支持动态供应的存储后端。</span><br><span class="line"># WaitForFirstConsumer: 使用 WaitForFirstConsumer 绑定模式时，PV 不会立即绑定到 PVC。PV 只有在第一个 Pod 试图使用 PVC 时才会绑定。这种模式适用于那些需要在 Pod 实际使用 PVC 之前进行一些准备工作的存储后端。例如，如果需要在创建 PV 后手动配置外部存储系统。</span><br><span class="line"># Delayed: Delayed 绑定模式类似于 WaitForFirstConsumer，但不支持多个 Pod 使用同一个 PVC。只有当 Pod 被调度到节点并使用 PVC 时，PV 才会绑定。这种模式适用于那些只支持单个 Pod 使用 PVC 的存储后端。与 WaitForFirstConsumer 模式相比，Delayed 模式对 PV 和 PVC 之间的绑定更加延迟。</span><br><span class="line"># Unknown: 如果未指定 volumeBindingMode，则默认为 Unknown。这意味着 Kubernetes 控制器或存储系统将决定如何绑定 PV 和 PVC。这种情况下，存储系统或云提供商的默认行为将适用。</span><br><span class="line"></span><br><span class="line">Amazon EBS CSI 只支持 Immediate 和 WaitForFirstConsumer，默认是Immediate。</span><br></pre></td></tr></table></figure><ul class="lvl-1"><li class="lvl-2"><p>reclaimPolicy</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 在 Kubernetes 中，reclaimPolicy 是指定持久卷（Persistent Volume，PV）的回收策略。reclaimPolicy 可以具有以下几种选项：</span><br><span class="line"># Retain: 使用 Retain 回收策略时，PV 的数据将被保留，而不会被自动删除。当 PV 和其对应的 Persistent Volume Claim（PVC）之间的关系解除时，PV 不会被回收或删除。管理员需要手动处理 PV 的回收或重新使用。</span><br><span class="line"># Delete: Delete 回收策略表示在 PV 和 PVC 之间的关系解除时，PV 将被自动删除和回收。PV 中存储的数据将被清除，且无法恢复。这是最常见的回收策略，适用于临时数据或不需要长期保留的情况。</span><br><span class="line"># Recycle: Recycle 回收策略是 Kubernetes 早期版本中使用的一种策略，但在 Kubernetes v1.7 版本之后已被弃用。该策略在解除 PV 和 PVC 之间的关系后，会尝试清除 PV 中的数据，使其可以被其他 PVC 重新使用。但这个清除过程仅限于删除 PV 上的文件，而不会对 PV 进行格式化或重建。</span><br><span class="line"># External: External 回收策略表示在 PV 和 PVC 之间的关系解除时，PV 的回收和删除操作由外部的存储管理系统或管理员处理。Kubernetes 不会主动回收或删除 PV，而是委托给外部系统进行处理。</span><br><span class="line"></span><br><span class="line">Amazon EBS CSI 只支持 Retain 和 Delete，默认是Delete。</span><br></pre></td></tr></table></figure></div><ul class="lvl-0"><li class="lvl-2"><p>创建PVC</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">create-pvc.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line">  name: ebs-gp3-claim</span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  storageClassName: gp3</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 4Gi</span><br><span class="line"></span><br><span class="line">$ k apply -f create-pvc.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># pvc指定的sc中的volumeBindingMode是WaitForFirstConsumer，只有被使用到时才会去真正申请资源，所以此时看到的状态一直都会是Pending</span></span><br><span class="line">$ k get pvc</span><br><span class="line">NAME            STATUS    VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">ebs-gp3-claim   Pending                                      gp3            2m51s</span><br></pre></td></tr></table></figure><div class="tips"><p><em><strong>配置说明</strong></em></p><ul class="lvl-1"><li class="lvl-2">accessModes</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 在 Kubernetes 中，PVC 是用于声明性地请求持久化存储资源的对象。它定义了 Pod 对持久卷（Persistent Volume，PV）的访问要求。PVC 可以指定不同的 accessModes，以确定 Pod 如何访问与之绑定的 PV。以下是 PVC 可能的 accessModes：</span><br><span class="line"># ReadWriteOnce (RWO): 此模式表示 PVC 可以被一个单个 Pod 以读写的方式挂载。这意味着 PVC 只能被一个 Pod 使用，而且可以同时读取和写入数据。这是许多常见应用程序的默认模式，例如关系型数据库。</span><br><span class="line"># ReadOnlyMany (ROX): 此模式表示 PVC 可以被多个 Pod 以只读的方式挂载。这意味着多个 Pod 可以同时读取数据，但不能写入。通常用于需要共享只读数据的场景，例如日志收集或静态内容的共享。</span><br><span class="line"># ReadWriteMany (RWX): 此模式表示 PVC 可以被多个 Pod 以读写的方式挂载。这意味着多个 Pod 可以同时读取和写入数据。然而，不是所有的存储插件都支持此模式，因此需要确保所使用的存储后端能够满足该要求。这是最具挑战性的模式，因为需要提供多个 Pod 之间的数据同步和一致性。</span><br><span class="line"></span><br><span class="line">需要注意的是，Amazon EBS CSI 目前只支持 ReadWriteOnce 访问模式，即每个卷只能被单个 Pod 以读写方式挂载。ReadOnlyMany 和 ReadWriteMany 访问模式在 Amazon EBS CSI 中尚未支持。</span><br><span class="line"></span><br><span class="line">如果您需要多个 Pod 可以同时以只读方式访问卷，您可以考虑使用 Amazon EFS（Elastic File System），它提供了 ReadWriteMany 访问模式，以满足多个 Pod 的同时只读访问需求。</span><br></pre></td></tr></table></figure></div><ul class="lvl-0"><li class="lvl-2"><p>申请ebs资源</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 可以创建一个pod绑定这个pvc就可以看到资源被申请了</span></span><br><span class="line"><span class="comment"># create-pod.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: app</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: app</span><br><span class="line">    image: centos</span><br><span class="line">    <span class="built_in">command</span>: [<span class="string">&quot;/bin/sh&quot;</span>]</span><br><span class="line">    args: [<span class="string">&quot;-c&quot;</span>, <span class="string">&quot;while true; do echo <span class="subst">$(date -u)</span> &gt;&gt; /data/out.txt; sleep 5; done&quot;</span>]</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: persistent-storage</span><br><span class="line">      mountPath: /data</span><br><span class="line">  volumes:</span><br><span class="line">  - name: persistent-storage</span><br><span class="line">    persistentVolumeClaim:</span><br><span class="line">      claimName: ebs-gp3-claim</span><br><span class="line"></span><br><span class="line">$ k apply -f create-pod.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看pv和pvc</span></span><br><span class="line">$  k get pv</span><br><span class="line">NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                STORAGECLASS   REASON   AGE</span><br><span class="line">pvc-02700260-b5e0-40bf-8c72-c1afad9e103e   4Gi        RWO            Delete           Bound    <span class="built_in">test</span>/ebs-gp3-claim   gp3                     4m34s</span><br><span class="line">$ k get pvc</span><br><span class="line">NAME            STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">ebs-gp3-claim   Bound    pvc-02700260-b5e0-40bf-8c72-c1afad9e103e   4Gi        RWO            gp3            9m27s</span><br><span class="line"></span><br><span class="line"><span class="comment"># VolumeHandle:      vol-0362860fb03d9d618 就是实际的EBS卷ID</span></span><br><span class="line">$ k describe pv pvc-02700260-b5e0-40bf-8c72-c1afad9e103e</span><br><span class="line">Name:              pvc-02700260-b5e0-40bf-8c72-c1afad9e103e</span><br><span class="line">Labels:            &lt;none&gt;</span><br><span class="line">Annotations:       pv.kubernetes.io/provisioned-by: ebs.csi.aws.com</span><br><span class="line">                   volume.kubernetes.io/provisioner-deletion-secret-name:</span><br><span class="line">                   volume.kubernetes.io/provisioner-deletion-secret-namespace:</span><br><span class="line">Finalizers:        [kubernetes.io/pv-protection external-attacher/ebs-csi-aws-com]</span><br><span class="line">StorageClass:      gp3</span><br><span class="line">Status:            Bound</span><br><span class="line">Claim:             <span class="built_in">test</span>/ebs-gp3-claim</span><br><span class="line">Reclaim Policy:    Delete</span><br><span class="line">Access Modes:      RWO</span><br><span class="line">VolumeMode:        Filesystem</span><br><span class="line">Capacity:          4Gi</span><br><span class="line">Node Affinity:</span><br><span class="line">  Required Terms:</span><br><span class="line">    Term 0:        topology.ebs.csi.aws.com/zone <span class="keyword">in</span> [us-west-2b]</span><br><span class="line">Message:</span><br><span class="line">Source:</span><br><span class="line">    Type:              CSI (a Container Storage Interface (CSI) volume <span class="built_in">source</span>)</span><br><span class="line">    Driver:            ebs.csi.aws.com</span><br><span class="line">    FSType:            ext4</span><br><span class="line">    VolumeHandle:      vol-0362860fb03d9d618</span><br><span class="line">    ReadOnly:          <span class="literal">false</span></span><br><span class="line">    VolumeAttributes:      storage.kubernetes.io/csiProvisionerIdentity=1687940646992-1017-ebs.csi.aws.com</span><br><span class="line">Events:                &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Used By 中展示的就是当前正在使用pvc的pod</span></span><br><span class="line">$ k describe pvc ebs-gp3-claim</span><br><span class="line">Name:          ebs-gp3-claim</span><br><span class="line">Namespace:     <span class="built_in">test</span></span><br><span class="line">StorageClass:  gp3</span><br><span class="line">Status:        Bound</span><br><span class="line">Volume:        pvc-02700260-b5e0-40bf-8c72-c1afad9e103e</span><br><span class="line">Labels:        &lt;none&gt;</span><br><span class="line">Annotations:   pv.kubernetes.io/bind-completed: <span class="built_in">yes</span></span><br><span class="line">               pv.kubernetes.io/bound-by-controller: <span class="built_in">yes</span></span><br><span class="line">               volume.beta.kubernetes.io/storage-provisioner: ebs.csi.aws.com</span><br><span class="line">               volume.kubernetes.io/selected-node: ip-192-168-48-14.us-west-2.compute.internal</span><br><span class="line">               volume.kubernetes.io/storage-provisioner: ebs.csi.aws.com</span><br><span class="line">Finalizers:    [kubernetes.io/pvc-protection]</span><br><span class="line">Capacity:      4Gi</span><br><span class="line">Access Modes:  RWO</span><br><span class="line">VolumeMode:    Filesystem</span><br><span class="line">Used By:       app-56df75755d-2phz4</span><br><span class="line">               app-56df75755d-cvjvc</span><br><span class="line">               app-56df75755d-xx9gh</span><br><span class="line">Events:        &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 此时如果删除pod，则其对应的pvc并不会被删除，之前申请到的ebs也不会被清除</span></span><br><span class="line">$ k delete -f create-pod.yaml</span><br><span class="line">$ k get pod</span><br><span class="line">No resources found <span class="keyword">in</span> <span class="built_in">test</span> namespace.</span><br><span class="line"></span><br><span class="line">$ k get pv</span><br><span class="line">NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                STORAGECLASS   REASON   AGE</span><br><span class="line">pvc-02700260-b5e0-40bf-8c72-c1afad9e103e   4Gi        RWO            Delete           Bound    <span class="built_in">test</span>/ebs-gp3-claim   gp3                     9m47s</span><br><span class="line">$ k get pvc</span><br><span class="line">NAME            STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">ebs-gp3-claim   Bound    pvc-02700260-b5e0-40bf-8c72-c1afad9e103e   4Gi        RWO            gp3            14m</span><br><span class="line"></span><br><span class="line"><span class="comment"># 此时如果重新创建pod并关联该pvc，则磁盘依旧有效，并且是不会被清空的</span></span><br><span class="line">$ k apply -f create-pod.yaml</span><br><span class="line"><span class="comment"># 查看pod的输出，可以看到中间有个超过5秒的间隔，这就是pod被删除然后又重建的间隔时间，说明磁盘没有被清空重建</span></span><br><span class="line">$ k <span class="built_in">exec</span> -it app -- <span class="built_in">tail</span> -f /data/out.txt</span><br><span class="line">Thu Jun 29 01:51:31 UTC 2023</span><br><span class="line">Thu Jun 29 01:51:36 UTC 2023</span><br><span class="line">Thu Jun 29 01:51:41 UTC 2023</span><br><span class="line">Thu Jun 29 01:53:25 UTC 2023</span><br><span class="line">Thu Jun 29 01:53:30 UTC 2023</span><br><span class="line">Thu Jun 29 01:53:35 UTC 2023</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果要彻底删除磁盘，需要删除pvc，sc中的reclaimPolicy是Delete才会被删除</span></span><br><span class="line">$ k delete -f create-pvc.yaml</span><br><span class="line">persistentvolumeclaim <span class="string">&quot;ebs-gp3-claim&quot;</span> deleted</span><br><span class="line">$ k get pvc</span><br><span class="line">No resources found <span class="keyword">in</span> <span class="built_in">test</span> namespace.</span><br><span class="line">$ k get pv</span><br><span class="line">No resources found</span><br></pre></td></tr></table></figure><h2 id="一个deployment并挂载ebs的示例">一个deployment并挂载ebs的示例</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># deployment-volume.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line">  name: ebs-gp3-claim</span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  storageClassName: gp3</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 4Gi</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: app</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: app</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">     labels:</span><br><span class="line">        app: app</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: app</span><br><span class="line">        image: centos</span><br><span class="line">        <span class="built_in">command</span>: [<span class="string">&quot;/bin/sh&quot;</span>]</span><br><span class="line">        args: [<span class="string">&quot;-c&quot;</span>, <span class="string">&quot;while true; do echo <span class="subst">$(date -u)</span> &gt;&gt; /data/out.txt; sleep 5; done&quot;</span>]</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: persistent-storage</span><br><span class="line">          mountPath: /data</span><br><span class="line">      volumes:</span><br><span class="line">      - name: persistent-storage</span><br><span class="line">        persistentVolumeClaim:</span><br><span class="line">          claimName: ebs-gp3-claim</span><br><span class="line"></span><br><span class="line"><span class="comment"># 部署</span></span><br><span class="line">~ k deploy -f deployment-volume.yaml</span><br><span class="line"><span class="comment"># 查看deploy</span></span><br><span class="line">~ k get deploy</span><br><span class="line">NAME   READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">app    3/3     3            3           85s</span><br><span class="line"></span><br><span class="line">~ k get pod</span><br><span class="line">NAME                  READY   STATUS              RESTARTS   AGE</span><br><span class="line">app-699cf8fdd-fk8vs   0/1     Running             0          90s</span><br><span class="line">app-699cf8fdd-gpk7m   0/1     Running             0          90s</span><br><span class="line">app-699cf8fdd-h5mbr   0/1     Running             0          90s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可以看到3个pod在同时写入一个文件</span></span><br><span class="line">~ k <span class="built_in">exec</span> -it app-699cf8fdd-fk8vs -- <span class="built_in">head</span> /data/out.txt</span><br><span class="line">Fri Jul 7 09:55:21 UTC 2023</span><br><span class="line">Fri Jul 7 09:55:21 UTC 2023</span><br><span class="line">Fri Jul 7 09:55:21 UTC 2023</span><br><span class="line">Fri Jul 7 09:55:26 UTC 2023</span><br><span class="line">Fri Jul 7 09:55:26 UTC 2023</span><br><span class="line">Fri Jul 7 09:55:26 UTC 2023</span><br><span class="line">Fri Jul 7 09:55:31 UTC 2023</span><br><span class="line">Fri Jul 7 09:55:31 UTC 2023</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启deploy</span></span><br><span class="line">~ k rollout restart deployment app</span><br><span class="line">deployment.apps/app restarted</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可以看到重新启动了3个pod，并且终止了原先启动的3个pod</span></span><br><span class="line">~ k get pod</span><br><span class="line">NAME                   READY   STATUS        RESTARTS   AGE</span><br><span class="line">app-667968b659-62dpl   1/1     Running       0          6s</span><br><span class="line">app-667968b659-7x6wj   1/1     Running       0          4s</span><br><span class="line">app-667968b659-n2rvz   1/1     Running       0          2s</span><br><span class="line">app-699cf8fdd-fk8vs    1/1     Terminating   0          287s</span><br><span class="line">app-699cf8fdd-gpk7m    1/1     Terminating   0          287s</span><br><span class="line">app-699cf8fdd-h5mbr    1/1     Terminating   0          287s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可以看到重启deploy后，文件内容依旧存在</span></span><br><span class="line">~ k <span class="built_in">exec</span> -it app-667968b659-62dpl -- <span class="built_in">head</span> /data/out.txt</span><br><span class="line">Fri Jul 7 09:55:21 UTC 2023</span><br><span class="line">Fri Jul 7 09:55:21 UTC 2023</span><br><span class="line">Fri Jul 7 09:55:21 UTC 2023</span><br><span class="line">Fri Jul 7 09:55:26 UTC 2023</span><br><span class="line">Fri Jul 7 09:55:26 UTC 2023</span><br><span class="line">Fri Jul 7 09:55:26 UTC 2023</span><br><span class="line">Fri Jul 7 09:55:31 UTC 2023</span><br><span class="line">Fri Jul 7 09:55:31 UTC 2023</span><br></pre></td></tr></table></figure><h3 id="讨论">讨论</h3><ul class="lvl-0"><li class="lvl-2"><p>这里注意一下，k8s-1.23版本创建时会成功，但是重启不成功，只会重新启动成功一个pod，另外两个pod会失败，提示pvc已经被一个pod关联了，但是1.25版就可以创建和重启时都可以成功，不确定是否和Amazon EBS CSI 版本有关系。</p></li></ul><h2 id="后记">后记</h2><ul class="lvl-0"><li class="lvl-2"><p>这里要注意一个问题，如果pv被pvc绑定，此时是无法删除pv的，同理pvc被其它资源关联，也是不能被删除的，需要先删除对应的资源才可以。</p></li><li class="lvl-2"><p>EBS不能跨可用区，如果pod部署在不同的可用区，则不能使用ebs作为存储，此时可以使用EFS。</p></li></ul>]]></content>
    
    
    <summary type="html">&lt;!--
 **加粗**
 *斜体*
 ***加粗并斜体***
 ~~删除线~~
 ==突出显示==
 `突出显示(推荐)`
 ++下划线++
 ~下标~
 ^上标^
 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.
 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600)

 +++ **点击折叠**
 这是被隐藏的内容
 +++

::: tips success warning danger
这里是容器内的内容
:::

% note info % success warning danger
这里是容器内的内容
% endnote %

 --&gt;
&lt;h2 id=&quot;摘要&quot;&gt;摘要&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;本文介绍在EKS集群中安装 Amazon EBS CSI 驱动程序过程&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;参考资料：&lt;/p&gt;
&lt;ul class=&quot;lvl-2&quot;&gt;
&lt;li class=&quot;lvl-6&quot;&gt;&lt;a href=&quot;https://docs.aws.amazon.com/zh_cn/eks/latest/userguide&quot;&gt;Amazon EKS用户指南&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-6&quot;&gt;&lt;a href=&quot;https://kubernetes.io/zh-cn/docs/home/&quot;&gt;Kubernetes 文档&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="技术" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="aws" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/aws/"/>
    
    <category term="eks" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/aws/eks/"/>
    
    
    <category term="java" scheme="https://blog.hanqunfeng.com/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>AWS-EKS-04--安装 Amazon VPC CNI</title>
    <link href="https://blog.hanqunfeng.com/2023/07/07/aws-eks04-vpc-cni/"/>
    <id>https://blog.hanqunfeng.com/2023/07/07/aws-eks04-vpc-cni/</id>
    <published>2023-07-07T13:30:05.000Z</published>
    <updated>2023-07-07T07:22:42.351Z</updated>
    
    <content type="html"><![CDATA[<!-- **加粗** *斜体* ***加粗并斜体*** ~~删除线~~ ==突出显示== `突出显示(推荐)` ++下划线++ ~下标~ ^上标^ 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference. 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600) +++ **点击折叠** 这是被隐藏的内容 +++::: tips success warning danger这里是容器内的内容:::% note info % success warning danger这里是容器内的内容% endnote % --><h2 id="摘要">摘要</h2><ul class="lvl-0"><li class="lvl-2"><p>本文介绍在EKS集群中安装 Amazon VPC CNI的过程</p></li><li class="lvl-2"><p>参考资料：</p><ul class="lvl-2"><li class="lvl-6"><a href="https://docs.aws.amazon.com/zh_cn/eks/latest/userguide">Amazon EKS用户指南</a></li><li class="lvl-6"><a href="https://kubernetes.io/zh-cn/docs/home/">Kubernetes 文档</a></li></ul></li></ul><span id="more"></span><h2 id="安装Amazon-VPC-CNI-plugin-for-Kubernetes">安装Amazon VPC CNI plugin for Kubernetes</h2><ul class="lvl-0"><li class="lvl-2"><p>Amazon VPC CNI plugin for Kubernetes 是 Amazon EKS 集群中用于 Pod 联网的联网插件。该插件负责向 Kubernetes 节点分配 VPC IP 地址并为每个节点上的 Pods 配置所需网络。</p></li><li class="lvl-2"><p>如果您使用 AWS Management Console 部署了集群，则可以跳过此步骤。AWS Management Console在默认情况下会部署 Amazon VPC CNI plugin for Kubernetes、CoreDNS、kube-proxy Amazon EKS 附加组件。<br>如果您使用 eksctl 或 AWS CLI 部署集群，则 Amazon VPC CNI plugin for Kubernetes、CoreDNS 和 kube-proxy 自行管理的附加组件将会被部署。您可以将使用您的集群部署的 Amazon VPC CNI plugin for Kubernetes、CoreDNS 和 kube-proxy 自行管理的附加组件迁移到 Amazon EKS 附加组件中。为了遵循最小特权原则，AWS建议我们将<code>AmazonEKS_CNI_Policy</code>策略附加到专门用于Amazon VPC CNI附加组件的单独角色。</p></li><li class="lvl-2"><p>创建 IAM 角色</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 确定您的集群的 IP 系列</span></span><br><span class="line">$ aws eks describe-cluster --name eks-lexing  --profile eks-us-west-2 | grep ipFamily</span><br><span class="line">            <span class="string">&quot;ipFamily&quot;</span>: <span class="string">&quot;ipv4&quot;</span></span><br><span class="line"><span class="comment"># 使用与您的集群的 IP 系列匹配的命令创建 IAM 角色并将 IAM policy 附加到该角色。此命令创建并部署一个创建 IAM 角色的 AWS CloudFormation 堆栈，向其附加您指定的策略，并使用所创建 IAM 角色的 ARN 对现有 aws-node Kubernetes 服务账户添加注释。</span></span><br><span class="line">$ eksctl create iamserviceaccount --name aws-node --namespace kube-system \</span><br><span class="line">    --cluster eks-lexing --profile eks-us-west-2 \</span><br><span class="line">    --role-name AmazonEKSVPCCNIRole \</span><br><span class="line">    --attach-policy-arn arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy \</span><br><span class="line">    --override-existing-serviceaccounts \</span><br><span class="line">    --approve</span><br><span class="line"> 2023-06-30 16:38:30 [ℹ]  1 existing iamserviceaccount(s) (kube-system/ebs-csi-controller-sa) will be excluded</span><br><span class="line">2023-06-30 16:38:30 [ℹ]  1 iamserviceaccount (kube-system/aws-node) was included (based on the include/exclude rules)</span><br><span class="line">2023-06-30 16:38:30 [!]  metadata of serviceaccounts that exist <span class="keyword">in</span> Kubernetes will be updated, as --override-existing-serviceaccounts was <span class="built_in">set</span></span><br><span class="line">2023-06-30 16:38:30 [ℹ]  1 task: &#123;</span><br><span class="line">    2 sequential sub-tasks: &#123;</span><br><span class="line">        create IAM role <span class="keyword">for</span> serviceaccount <span class="string">&quot;kube-system/aws-node&quot;</span>,</span><br><span class="line">        create serviceaccount <span class="string">&quot;kube-system/aws-node&quot;</span>,</span><br><span class="line">    &#125; &#125;2023-06-30 16:38:30 [ℹ]  building iamserviceaccount stack <span class="string">&quot;eksctl-eks-lexing-addon-iamserviceaccount-kube-system-aws-node&quot;</span></span><br><span class="line">2023-06-30 16:38:31 [ℹ]  deploying stack <span class="string">&quot;eksctl-eks-lexing-addon-iamserviceaccount-kube-system-aws-node&quot;</span></span><br><span class="line">2023-06-30 16:38:31 [ℹ]  waiting <span class="keyword">for</span> CloudFormation stack <span class="string">&quot;eksctl-eks-lexing-addon-iamserviceaccount-kube-system-aws-node&quot;</span></span><br><span class="line">2023-06-30 16:39:02 [ℹ]  waiting <span class="keyword">for</span> CloudFormation stack <span class="string">&quot;eksctl-eks-lexing-addon-iamserviceaccount-kube-system-aws-node&quot;</span></span><br><span class="line">2023-06-30 16:39:04 [ℹ]  serviceaccount <span class="string">&quot;kube-system/aws-node&quot;</span> already exists</span><br><span class="line">2023-06-30 16:39:04 [ℹ]  updated serviceaccount <span class="string">&quot;kube-system/aws-node&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 重新部署 Amazon VPC CNI plugin for KubernetesPods</span></span><br><span class="line"><span class="comment"># 删除并重新创建任何与服务账户关联的现有 Pods，以应用凭证环境变量。注释未应用于目前在没有注释的情况下运行的 Pods。以下命令删除现有的 aws-node DaemonSet Pods 并使用服务账户注释部署它们。</span></span><br><span class="line">$ kubectl delete Pods -n kube-system -l k8s-app=aws-node</span><br><span class="line">pod <span class="string">&quot;aws-node-fzh9v&quot;</span> deleted</span><br><span class="line">pod <span class="string">&quot;aws-node-t62f8&quot;</span> deleted</span><br><span class="line"></span><br><span class="line"><span class="comment"># 确认 Pods 已全部重新启动</span></span><br><span class="line">$ kubectl get pods -n kube-system -l k8s-app=aws-node</span><br><span class="line">NAME             READY   STATUS    RESTARTS   AGE</span><br><span class="line">aws-node-q2zfb   1/1     Running   0          11s</span><br><span class="line">aws-node-rmfbk   1/1     Running   0          11s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 描述 Pods 之一并确保 AWS_WEB_IDENTITY_TOKEN_FILE 和 AWS_ROLE_ARN 环境变量存在。</span></span><br><span class="line">$ kubectl describe pod -n kube-system aws-node-q2zfb | grep <span class="string">&#x27;AWS_ROLE_ARN:\|AWS_WEB_IDENTITY_TOKEN_FILE:&#x27;</span></span><br><span class="line">      AWS_ROLE_ARN:                 arn:aws:iam::743263909655:role/AmazonEKSVPCCNIRole</span><br><span class="line">      AWS_WEB_IDENTITY_TOKEN_FILE:  /var/run/secrets/eks.amazonaws.com/serviceaccount/token</span><br><span class="line">      AWS_ROLE_ARN:                           arn:aws:iam::743263909655:role/AmazonEKSVPCCNIRole</span><br><span class="line">      AWS_WEB_IDENTITY_TOKEN_FILE:            /var/run/secrets/eks.amazonaws.com/serviceaccount/token</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>配置好上面的IAM角色后，要从节点 IAM 角色中删除 CNI 策略</p><ul class="lvl-2"><li class="lvl-6">在角色列表中搜索 eksNodeRole、AmazonEKSNodeRole 或 NodeInstanceRole，应该存在一个，我这里就是存在 NodeInstanceRole，如果一个都不存在就先参照上文创建一个新的IAM角色<br><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/Dih0XN.png" alt="" width="900" height="300"></li><li class="lvl-6">删除策略 AmazonEKS_CNI_Policy<br><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/VX6Ro8.png" alt="" width="900" height="600"></li><li class="lvl-6">也可以通过命令行删除角色中的策略</li></ul>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws iam detach-role-policy --profile eks-us-west-2 --role-name eksctl-eks-lexing-nodegroup-ng-4d-NodeInstanceRole-Y28EPJO9XYDG --policy-arn arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy</span><br></pre></td></tr></table></figure></li><li class="lvl-2"><p>安装Amazon VPC CNI plugin for Kubernetes</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看集群上当前安装的附加组件版本</span></span><br><span class="line">$ kubectl describe daemonset aws-node --namespace kube-system | grep amazon-k8s-cni: | <span class="built_in">cut</span> -d : -f 3</span><br><span class="line">v1.12.2-eksbuild.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看集群上当前安装的附加组件类型。根据您创建集群时使用的工具，您的集群上目前可能没有安装 Amazon EKS 附加组件类型</span></span><br><span class="line">$ aws eks describe-addon --cluster-name eks-lexing --profile eks-us-west-2 --addon-name vpc-cni --query addon.addonVersion --output text</span><br><span class="line"></span><br><span class="line">An error occurred (ResourceNotFoundException) when calling the DescribeAddon operation: No addon: vpc-cni found <span class="keyword">in</span> cluster: eks-lexing</span><br><span class="line"><span class="comment"># 如果返回版本号，则表明您的集群上安装有 Amazon EKS 附加组件类型，且您不需要完成此过程的其余步骤。如果返回错误，则表明您的集群上安装有 Amazon EKS 类型的附加组件。完成此过程的其余步骤以进行安装。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 AWS CLI 创建附加组件，注意这里--addon-version的版本号要与https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/managing-vpc-cni.html中的k8s版本相对应</span></span><br><span class="line"><span class="comment"># AmazonEKSVPCCNIRole就是上面创建的角色的名称</span></span><br><span class="line">$ aws eks create-addon --cluster-name eks-lexing --profile eks-us-west-2 \</span><br><span class="line">    --addon-name vpc-cni \</span><br><span class="line">    --addon-version v1.12.6-eksbuild.2 \</span><br><span class="line">    --resolve-conflicts OVERWRITE \</span><br><span class="line">    --service-account-role-arn arn:aws:iam::743263909655:role/AmazonEKSVPCCNIRole</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;addon&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;addonName&quot;</span>: <span class="string">&quot;vpc-cni&quot;</span>,</span><br><span class="line">        <span class="string">&quot;clusterName&quot;</span>: <span class="string">&quot;eks-lexing&quot;</span>,</span><br><span class="line">        <span class="string">&quot;status&quot;</span>: <span class="string">&quot;CREATING&quot;</span>,</span><br><span class="line">        <span class="string">&quot;addonVersion&quot;</span>: <span class="string">&quot;v1.12.6-eksbuild.2&quot;</span>,</span><br><span class="line">        <span class="string">&quot;health&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;issues&quot;</span>: []</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;addonArn&quot;</span>: <span class="string">&quot;arn:aws:eks:us-west-2:743263909655:addon/eks-lexing/vpc-cni/bcc485cc-cf4c-f8c6-84da-55c66044e0ff&quot;</span>,</span><br><span class="line">        <span class="string">&quot;createdAt&quot;</span>: <span class="string">&quot;2023-06-30T17:19:24.457000+08:00&quot;</span>,</span><br><span class="line">        <span class="string">&quot;modifiedAt&quot;</span>: <span class="string">&quot;2023-06-30T17:19:24.475000+08:00&quot;</span>,</span><br><span class="line">        <span class="string">&quot;serviceAccountRoleArn&quot;</span>: <span class="string">&quot;arn:aws:iam::743263909655:role/AmazonEKSVPCCNIRole&quot;</span>,</span><br><span class="line">        <span class="string">&quot;tags&quot;</span>: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 确认您的集群的 Kubernetes 版本的附加组件最新版本已添加到您的集群</span></span><br><span class="line">$ aws eks describe-addon --cluster-name eks-lexing --profile eks-us-west-2 --addon-name vpc-cni --query addon.addonVersion --output text</span><br><span class="line">v1.12.6-eksbuild.2</span><br><span class="line"></span><br><span class="line">$ kubectl describe daemonset aws-node --namespace kube-system | grep amazon-k8s-cni: | <span class="built_in">cut</span> -d : -f 3</span><br><span class="line">v1.12.6-eksbuild.2</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>此时可以通过aws控制台对eks的 Amazon VPC CNI 插件进行管理，后续升级可以直接在控制台进行<br><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/53TeZU.png" alt="" width="1200" height="600"></p></li></ul><h2 id="查看eks的所有可用组件">查看eks的所有可用组件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看都有哪些组件</span></span><br><span class="line">$ eksctl utils describe-addon-versions --kubernetes-version 1.26 --profile eks-us-west-2 | grep AddonName</span><br><span class="line">            <span class="string">&quot;AddonName&quot;</span>: <span class="string">&quot;kube-proxy&quot;</span>,</span><br><span class="line">            <span class="string">&quot;AddonName&quot;</span>: <span class="string">&quot;adot&quot;</span>,</span><br><span class="line">            <span class="string">&quot;AddonName&quot;</span>: <span class="string">&quot;aws-guardduty-agent&quot;</span>,</span><br><span class="line">            <span class="string">&quot;AddonName&quot;</span>: <span class="string">&quot;vpc-cni&quot;</span>,</span><br><span class="line">            <span class="string">&quot;AddonName&quot;</span>: <span class="string">&quot;kubecost_kubecost&quot;</span>,</span><br><span class="line">            <span class="string">&quot;AddonName&quot;</span>: <span class="string">&quot;coredns&quot;</span>,</span><br><span class="line">            <span class="string">&quot;AddonName&quot;</span>: <span class="string">&quot;aws-ebs-csi-driver&quot;</span>,</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看某个组件有哪些版本</span></span><br><span class="line">$ eksctl utils describe-addon-versions --kubernetes-version 1.26 --name vpc-cni --profile eks-us-west-2 | grep AddonVersion</span><br><span class="line">            <span class="string">&quot;AddonVersions&quot;</span>: [</span><br><span class="line">                    <span class="string">&quot;AddonVersion&quot;</span>: <span class="string">&quot;v1.13.2-eksbuild.1&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;AddonVersion&quot;</span>: <span class="string">&quot;v1.13.0-eksbuild.1&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;AddonVersion&quot;</span>: <span class="string">&quot;v1.12.6-eksbuild.2&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;AddonVersion&quot;</span>: <span class="string">&quot;v1.12.6-eksbuild.1&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;AddonVersion&quot;</span>: <span class="string">&quot;v1.12.5-eksbuild.2&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;AddonVersion&quot;</span>: <span class="string">&quot;v1.12.0-eksbuild.2&quot;</span>,</span><br><span class="line"></span><br><span class="line"><span class="comment"># 确定您要创建的附加组件是 Amazon EKS 还是 AWS Marketplace 附加组件，如果未返回输出，则该附加组件是 Amazon EKS。如果返回输出，则该附加组件是 AWS Marketplace 附加组件。</span></span><br><span class="line">$ eksctl utils describe-addon-versions --kubernetes-version 1.26 --name vpc-cni --profile eks-us-west-2 | grep ProductUrl</span><br><span class="line"></span><br><span class="line">$ eksctl utils describe-addon-versions --kubernetes-version 1.26 --name kubecost_kubecost --profile  eks-us-west-2 | grep ProductUrl</span><br><span class="line">                <span class="string">&quot;ProductUrl&quot;</span>: <span class="string">&quot;https://aws.amazon.com/marketplace/pp?sku=753cea16-f450-4cfa-93eb-f55dcde11e91&quot;</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;!--
 **加粗**
 *斜体*
 ***加粗并斜体***
 ~~删除线~~
 ==突出显示==
 `突出显示(推荐)`
 ++下划线++
 ~下标~
 ^上标^
 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.
 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600)

 +++ **点击折叠**
 这是被隐藏的内容
 +++

::: tips success warning danger
这里是容器内的内容
:::

% note info % success warning danger
这里是容器内的内容
% endnote %

 --&gt;
&lt;h2 id=&quot;摘要&quot;&gt;摘要&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;本文介绍在EKS集群中安装 Amazon VPC CNI的过程&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;参考资料：&lt;/p&gt;
&lt;ul class=&quot;lvl-2&quot;&gt;
&lt;li class=&quot;lvl-6&quot;&gt;&lt;a href=&quot;https://docs.aws.amazon.com/zh_cn/eks/latest/userguide&quot;&gt;Amazon EKS用户指南&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-6&quot;&gt;&lt;a href=&quot;https://kubernetes.io/zh-cn/docs/home/&quot;&gt;Kubernetes 文档&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="技术" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="aws" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/aws/"/>
    
    <category term="eks" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/aws/eks/"/>
    
    
    <category term="java" scheme="https://blog.hanqunfeng.com/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>AWS-EKS-03--创建 IAM OIDC 身份提供商</title>
    <link href="https://blog.hanqunfeng.com/2023/07/07/aws-eks03-oidc/"/>
    <id>https://blog.hanqunfeng.com/2023/07/07/aws-eks03-oidc/</id>
    <published>2023-07-07T12:30:05.000Z</published>
    <updated>2023-07-13T08:57:37.298Z</updated>
    
    <content type="html"><![CDATA[<!-- **加粗** *斜体* ***加粗并斜体*** ~~删除线~~ ==突出显示== `突出显示(推荐)` ++下划线++ ~下标~ ^上标^ 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference. 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600) +++ **点击折叠** 这是被隐藏的内容 +++::: tips success warning danger这里是容器内的内容:::% note info % success warning danger这里是容器内的内容% endnote % --><h2 id="摘要">摘要</h2><ul class="lvl-0"><li class="lvl-2"><p>本文介绍为EKS集群创建 IAM OIDC 身份提供商</p></li><li class="lvl-2"><p>参考资料：</p><ul class="lvl-2"><li class="lvl-6"><a href="https://docs.aws.amazon.com/zh_cn/eks/latest/userguide">Amazon EKS用户指南</a></li><li class="lvl-6"><a href="https://kubernetes.io/zh-cn/docs/home/">Kubernetes 文档</a></li></ul></li></ul><span id="more"></span><h2 id="为集群创建-IAM-OIDC-身份提供商">为集群创建 IAM OIDC 身份提供商</h2><ul class="lvl-0"><li class="lvl-2"><p>要使用某些 Amazon EKS 附加组件，或启用个别 Kubernetes 工作负载以具有特定 AWS Identity and Access Management（IAM）权限，请为集群创建 IAM OpenID Connect（OIDC）提供商。</p></li><li class="lvl-2"><p>只需为集群创建一次 IAM OIDC 提供商。</p></li><li class="lvl-2"><p>确定您的账户中是否已存在具有您的集群 ID 的 IAM OIDC 提供商</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 确定集群是否拥有现有 IAM OIDC 提供商。检索集群的 OIDC 提供商 ID 并将其存储在变量中</span></span><br><span class="line">$ oidc_id=$(aws eks describe-cluster --name eks-lexing --profile eks-us-west-2 --query <span class="string">&quot;cluster.identity.oidc.issuer&quot;</span> --output text | <span class="built_in">cut</span> -d <span class="string">&#x27;/&#x27;</span> -f 5)</span><br><span class="line"><span class="comment"># 如果下面的命令返回了输出，则表示您的集群已经有 IAM OIDC 提供商，您可以跳过下一步。如果没有返回输出，则您必须为集群创建 IAM OIDC 提供商。</span></span><br><span class="line">$ aws iam --profile eks-us-west-2 list-open-id-connect-providers | grep <span class="variable">$oidc_id</span> | <span class="built_in">cut</span> -d <span class="string">&quot;/&quot;</span> -f4</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>使用以下命令为您的集群创建 IAM OIDC 身份提供商</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ eksctl utils associate-iam-oidc-provider --cluster eks-lexing --profile eks-us-west-2 --approve</span><br><span class="line">2023-06-28 15:38:20 [ℹ]  will create IAM Open ID Connect provider <span class="keyword">for</span> cluster <span class="string">&quot;eks-lexing&quot;</span> <span class="keyword">in</span> <span class="string">&quot;us-west-2&quot;</span></span><br><span class="line">2023-06-28 15:38:21 [✔]  created IAM Open ID Connect provider <span class="keyword">for</span> cluster <span class="string">&quot;eks-lexing&quot;</span> <span class="keyword">in</span> <span class="string">&quot;us-west-2&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看集群的 OIDC 提供商 URL，如果该命令返回为空，则说明尚未创建IAM OIDC 身份提供商</span></span><br><span class="line">$ aws eks describe-cluster --name eks-lexing --query <span class="string">&quot;cluster.identity.oidc.issuer&quot;</span> --output text --profile eks-us-west-2</span><br><span class="line">https://oidc.eks.us-west-2.amazonaws.com/id/1029FF88CB8725555A1CC65D44191A56</span><br><span class="line"></span><br><span class="line">$ aws iam --profile eks-us-west-2 list-open-id-connect-providers | grep <span class="variable">$oidc_id</span> | <span class="built_in">cut</span> -d <span class="string">&quot;/&quot;</span> -f4</span><br><span class="line">1029FF88CB8725555A1CC65D44191A56<span class="string">&quot;</span></span><br></pre></td></tr></table></figure><h2 id="查看OIDC元数据">查看OIDC元数据</h2><ul class="lvl-0"><li class="lvl-2"><p>在集群的 OIDC 提供商 URL后面加上<code>/.well-known/openid-configuration</code></p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ curl https://oidc.eks.us-west-2.amazonaws.com/id/1029FF88CB8725555A1CC65D44191A56/.well-known/openid-configuration -s| python -m json.tool</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;authorization_endpoint&quot;</span>: <span class="string">&quot;urn:kubernetes:programmatic_authorization&quot;</span>,</span><br><span class="line">    <span class="string">&quot;claims_supported&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;sub&quot;</span>,</span><br><span class="line">        <span class="string">&quot;iss&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;id_token_signing_alg_values_supported&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;RS256&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;issuer&quot;</span>: <span class="string">&quot;https://oidc.eks.us-west-2.amazonaws.com/id/1029FF88CB8725555A1CC65D44191A56&quot;</span>,</span><br><span class="line">    <span class="string">&quot;jwks_uri&quot;</span>: <span class="string">&quot;https://oidc.eks.us-west-2.amazonaws.com/id/1029FF88CB8725555A1CC65D44191A56/keys&quot;</span>,</span><br><span class="line">    <span class="string">&quot;response_types_supported&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;id_token&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;subject_types_supported&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;public&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>然后查看<code>jwks_uri</code>中的url，这里的keys就是 IAM 用来验证 EKS service account 发送过来的 ID_token 是否有效的。</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">curl https://oidc.eks.us-west-2.amazonaws.com/id/1029FF88CB8725555A1CC65D44191A56/keys -s | python -m json.tool</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;keys&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;alg&quot;</span>: <span class="string">&quot;RS256&quot;</span>,</span><br><span class="line">            <span class="string">&quot;e&quot;</span>: <span class="string">&quot;AQAB&quot;</span>,</span><br><span class="line">            <span class="string">&quot;kid&quot;</span>: <span class="string">&quot;4e49f2d2c6c8550c55556b01637a93a8a4f941e5&quot;</span>,</span><br><span class="line">            <span class="string">&quot;kty&quot;</span>: <span class="string">&quot;RSA&quot;</span>,</span><br><span class="line">            <span class="string">&quot;n&quot;</span>: <span class="string">&quot;rEKprAR5nRAHfulQyyI9unXUNpczPCKZO8hXVuTiKrwlzdI7pETs6g0hWQaKe96n4p-KERF-dc-KajboMqrCfsff7boVJdnA9k8CljwKvt-5ILyXe07ASZQkkbDgpY30GNvMB7tbhiwkaNjuBzrLsO2Ipom5rzlK3i6rjHxp3O94BgMbMMt4trvWtJ9vmhWILihkl_e8--5JOOzjjeNcrNoK_o5LxbHSetaALoGAk-XbCmUeFDWvLQ&quot;</span>,</span><br><span class="line">            <span class="string">&quot;use&quot;</span>: <span class="string">&quot;sig&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;alg&quot;</span>: <span class="string">&quot;RS256&quot;</span>,</span><br><span class="line">            <span class="string">&quot;e&quot;</span>: <span class="string">&quot;AQAB&quot;</span>,</span><br><span class="line">            <span class="string">&quot;kid&quot;</span>: <span class="string">&quot;831cd2c5a14af3ff3ee5555ab1edf6dc7d7fb54d&quot;</span>,</span><br><span class="line">            <span class="string">&quot;kty&quot;</span>: <span class="string">&quot;RSA&quot;</span>,</span><br><span class="line">            <span class="string">&quot;n&quot;</span>: <span class="string">&quot;xdlnMmc1lUGyVlt58621Arf-2Ytxxe5HCiBguYe1Y4DYvfxTzknH3x07Q1sMQLNGHV_4d-bT29ufhAnht6AaLcuxtxaonEcMArh95bnuau6-GFMe06XaBYlMDoTcf_czTGdI4On7veJtMpSsNlHNj507Jn6mcH8TGHIl6qRwj9NZSaoADrkDO87O-w71l1c2a3m0us1vWir0QJdZ3J2al4k1Qm7KZT-dN9rs2LquQS0s6MTX-VdQLFb&quot;</span>,</span><br><span class="line">            <span class="string">&quot;use&quot;</span>: <span class="string">&quot;sig&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;alg&quot;</span>: <span class="string">&quot;RS256&quot;</span>,</span><br><span class="line">            <span class="string">&quot;e&quot;</span>: <span class="string">&quot;AQAB&quot;</span>,</span><br><span class="line">            <span class="string">&quot;kid&quot;</span>: <span class="string">&quot;eba5269e0fedd9431af2755550dd09f85bec7ad0&quot;</span>,</span><br><span class="line">            <span class="string">&quot;kty&quot;</span>: <span class="string">&quot;RSA&quot;</span>,</span><br><span class="line">            <span class="string">&quot;n&quot;</span>: <span class="string">&quot;qzfrIdEsOebdO243KkkGOl8r1rXiErQXwjK0RspvrX6roV6uJg6gBT0qBN7nM1J92WNVNte-3UhcBfm_hdBHRfib8zN_AvMNZ04Yc76hri7xTqa1iHFLl8823YEBnP_FSM97rdzsz_wCNkBM8bzsD-Cg4KMqrrY_qzFFymBRHPklBLyJudJN1zv8_dCXbDzBKtQo8UklM3MuSLsIf1TZGDbpemEpvNO-mu9UDVEccw0oeMPPKx6K_br&quot;</span>,</span><br><span class="line">            <span class="string">&quot;use&quot;</span>: <span class="string">&quot;sig&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;!--
 **加粗**
 *斜体*
 ***加粗并斜体***
 ~~删除线~~
 ==突出显示==
 `突出显示(推荐)`
 ++下划线++
 ~下标~
 ^上标^
 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.
 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600)

 +++ **点击折叠**
 这是被隐藏的内容
 +++

::: tips success warning danger
这里是容器内的内容
:::

% note info % success warning danger
这里是容器内的内容
% endnote %

 --&gt;
&lt;h2 id=&quot;摘要&quot;&gt;摘要&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;本文介绍为EKS集群创建 IAM OIDC 身份提供商&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;参考资料：&lt;/p&gt;
&lt;ul class=&quot;lvl-2&quot;&gt;
&lt;li class=&quot;lvl-6&quot;&gt;&lt;a href=&quot;https://docs.aws.amazon.com/zh_cn/eks/latest/userguide&quot;&gt;Amazon EKS用户指南&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-6&quot;&gt;&lt;a href=&quot;https://kubernetes.io/zh-cn/docs/home/&quot;&gt;Kubernetes 文档&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="技术" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="aws" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/aws/"/>
    
    <category term="eks" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/aws/eks/"/>
    
    
    <category term="java" scheme="https://blog.hanqunfeng.com/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>AWS-EKS-02--创建集群</title>
    <link href="https://blog.hanqunfeng.com/2023/07/06/aws-eks02-create-eks/"/>
    <id>https://blog.hanqunfeng.com/2023/07/06/aws-eks02-create-eks/</id>
    <published>2023-07-06T15:30:05.000Z</published>
    <updated>2023-07-19T03:16:32.880Z</updated>
    
    <content type="html"><![CDATA[<!-- **加粗** *斜体* ***加粗并斜体*** ~~删除线~~ ==突出显示== `突出显示(推荐)` ++下划线++ ~下标~ ^上标^ 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference. 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600) +++ **点击折叠** 这是被隐藏的内容 +++::: tips success warning danger这里是容器内的内容:::% note info % success warning danger这里是容器内的内容% endnote % --><h2 id="摘要">摘要</h2><ul class="lvl-0"><li class="lvl-2"><p>本文介绍在AWS中创建EKS集群的过程</p></li><li class="lvl-2"><p>参考资料：</p><ul class="lvl-2"><li class="lvl-6"><a href="https://docs.aws.amazon.com/zh_cn/eks/latest/userguide">Amazon EKS用户指南</a></li><li class="lvl-6"><a href="https://kubernetes.io/zh-cn/docs/home/">Kubernetes 文档</a></li></ul></li></ul><span id="more"></span><h2 id="创建eks集群">创建eks集群</h2><ul class="lvl-0"><li class="lvl-2"><p>使用<code>eksctl</code><a href="https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/create-cluster.html">创建集群</a>，当前默认安装k8s-1.25，如果要安装其它<a href="https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/kubernetes-versions.html">EKS支持的k8s版本</a>，比如要安装1.26，则需要加上<code>--version 1.26</code></p></li><li class="lvl-2"><p>如下命令会创建新的VPC，并基于该VPC创建一个新的eks集群，默认创建2个工作节点</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 当前默认是安装k8s-1.25，安装过程大约15分钟，</span></span><br><span class="line">$ eksctl create cluster --name eks-lexing  --profile eks-us-west-2</span><br><span class="line">2023-06-27 16:49:07 [ℹ]  eksctl version 0.146.0</span><br><span class="line">2023-06-27 16:49:07 [ℹ]  using region us-west-2</span><br><span class="line">2023-06-27 16:49:07 [ℹ]  setting availability zones to [us-west-2a us-west-2b us-west-2d]</span><br><span class="line">2023-06-27 16:49:08 [ℹ]  subnets <span class="keyword">for</span> us-west-2a - public:192.168.0.0/19 private:192.168.96.0/19</span><br><span class="line">2023-06-27 16:49:08 [ℹ]  subnets <span class="keyword">for</span> us-west-2b - public:192.168.32.0/19 private:192.168.128.0/19</span><br><span class="line">2023-06-27 16:49:08 [ℹ]  subnets <span class="keyword">for</span> us-west-2d - public:192.168.64.0/19 private:192.168.160.0/19</span><br><span class="line">2023-06-27 16:49:08 [ℹ]  nodegroup <span class="string">&quot;ng-4d9024eb&quot;</span> will use <span class="string">&quot;&quot;</span> [AmazonLinux2/1.25]</span><br><span class="line">2023-06-27 16:49:08 [ℹ]  using Kubernetes version 1.25</span><br><span class="line">2023-06-27 16:49:08 [ℹ]  creating EKS cluster <span class="string">&quot;eks-lexing&quot;</span> <span class="keyword">in</span> <span class="string">&quot;us-west-2&quot;</span> region with managed nodes</span><br><span class="line">2023-06-27 16:49:08 [ℹ]  will create 2 separate CloudFormation stacks <span class="keyword">for</span> cluster itself and the initial managed nodegroup</span><br><span class="line">2023-06-27 16:49:08 [ℹ]  <span class="keyword">if</span> you encounter any issues, check CloudFormation console or try <span class="string">&#x27;eksctl utils describe-stacks --region=us-west-2 --cluster=eks-lexing&#x27;</span></span><br><span class="line">2023-06-27 16:49:08 [ℹ]  Kubernetes API endpoint access will use default of &#123;publicAccess=<span class="literal">true</span>, privateAccess=<span class="literal">false</span>&#125; <span class="keyword">for</span> cluster <span class="string">&quot;eks-lexing&quot;</span> <span class="keyword">in</span> <span class="string">&quot;us-west-2&quot;</span></span><br><span class="line">2023-06-27 16:49:08 [ℹ]  CloudWatch logging will not be enabled <span class="keyword">for</span> cluster <span class="string">&quot;eks-lexing&quot;</span> <span class="keyword">in</span> <span class="string">&quot;us-west-2&quot;</span></span><br><span class="line">2023-06-27 16:49:08 [ℹ]  you can <span class="built_in">enable</span> it with <span class="string">&#x27;eksctl utils update-cluster-logging --enable-types=&#123;SPECIFY-YOUR-LOG-TYPES-HERE (e.g. all)&#125; --region=us-west-2 --cluster=eks-lexing&#x27;</span></span><br><span class="line">2023-06-27 16:49:08 [ℹ]</span><br><span class="line">2 sequential tasks: &#123; create cluster control plane <span class="string">&quot;eks-lexing&quot;</span>,</span><br><span class="line">    2 sequential sub-tasks: &#123;</span><br><span class="line">        <span class="built_in">wait</span> <span class="keyword">for</span> control plane to become ready,</span><br><span class="line">        create managed nodegroup <span class="string">&quot;ng-4d9024eb&quot;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">2023-06-27 16:49:08 [ℹ]  building cluster stack <span class="string">&quot;eksctl-eks-lexing-cluster&quot;</span></span><br><span class="line">2023-06-27 16:49:09 [ℹ]  deploying stack <span class="string">&quot;eksctl-eks-lexing-cluster&quot;</span></span><br><span class="line">2023-06-27 16:49:39 [ℹ]  waiting <span class="keyword">for</span> CloudFormation stack <span class="string">&quot;eksctl-eks-lexing-cluster&quot;</span></span><br><span class="line">2023-06-27 16:50:09 [ℹ]  waiting <span class="keyword">for</span> CloudFormation stack <span class="string">&quot;eksctl-eks-lexing-cluster&quot;</span></span><br><span class="line">2023-06-27 16:51:09 [ℹ]  waiting <span class="keyword">for</span> CloudFormation stack <span class="string">&quot;eksctl-eks-lexing-cluster&quot;</span></span><br><span class="line">2023-06-27 16:52:09 [ℹ]  waiting <span class="keyword">for</span> CloudFormation stack <span class="string">&quot;eksctl-eks-lexing-cluster&quot;</span></span><br><span class="line">2023-06-27 16:53:09 [ℹ]  waiting <span class="keyword">for</span> CloudFormation stack <span class="string">&quot;eksctl-eks-lexing-cluster&quot;</span></span><br><span class="line">2023-06-27 16:54:09 [ℹ]  waiting <span class="keyword">for</span> CloudFormation stack <span class="string">&quot;eksctl-eks-lexing-cluster&quot;</span></span><br><span class="line">2023-06-27 16:55:09 [ℹ]  waiting <span class="keyword">for</span> CloudFormation stack <span class="string">&quot;eksctl-eks-lexing-cluster&quot;</span></span><br><span class="line">2023-06-27 16:56:10 [ℹ]  waiting <span class="keyword">for</span> CloudFormation stack <span class="string">&quot;eksctl-eks-lexing-cluster&quot;</span></span><br><span class="line">2023-06-27 16:57:10 [ℹ]  waiting <span class="keyword">for</span> CloudFormation stack <span class="string">&quot;eksctl-eks-lexing-cluster&quot;</span></span><br><span class="line">2023-06-27 16:58:10 [ℹ]  waiting <span class="keyword">for</span> CloudFormation stack <span class="string">&quot;eksctl-eks-lexing-cluster&quot;</span></span><br><span class="line">2023-06-27 17:00:15 [ℹ]  building managed nodegroup stack <span class="string">&quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;</span></span><br><span class="line">2023-06-27 17:00:16 [ℹ]  deploying stack <span class="string">&quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;</span></span><br><span class="line">2023-06-27 17:00:16 [ℹ]  waiting <span class="keyword">for</span> CloudFormation stack <span class="string">&quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;</span></span><br><span class="line">2023-06-27 17:00:46 [ℹ]  waiting <span class="keyword">for</span> CloudFormation stack <span class="string">&quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;</span></span><br><span class="line">2023-06-27 17:01:25 [ℹ]  waiting <span class="keyword">for</span> CloudFormation stack <span class="string">&quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;</span></span><br><span class="line">2023-06-27 17:03:16 [ℹ]  waiting <span class="keyword">for</span> CloudFormation stack <span class="string">&quot;eksctl-eks-lexing-nodegroup-ng-4d9024eb&quot;</span></span><br><span class="line">2023-06-27 17:03:16 [ℹ]  waiting <span class="keyword">for</span> the control plane to become ready</span><br><span class="line">2023-06-27 17:03:16 [✔]  saved kubeconfig as <span class="string">&quot;/Users/hanqf/.kube/config&quot;</span></span><br><span class="line">2023-06-27 17:03:16 [ℹ]  no tasks</span><br><span class="line">2023-06-27 17:03:16 [✔]  all EKS cluster resources <span class="keyword">for</span> <span class="string">&quot;eks-lexing&quot;</span> have been created</span><br><span class="line">2023-06-27 17:03:17 [ℹ]  nodegroup <span class="string">&quot;ng-4d9024eb&quot;</span> has 2 node(s)</span><br><span class="line">2023-06-27 17:03:17 [ℹ]  node <span class="string">&quot;ip-192-168-16-155.us-west-2.compute.internal&quot;</span> is ready</span><br><span class="line">2023-06-27 17:03:17 [ℹ]  node <span class="string">&quot;ip-192-168-48-14.us-west-2.compute.internal&quot;</span> is ready</span><br><span class="line">2023-06-27 17:03:17 [ℹ]  waiting <span class="keyword">for</span> at least 2 node(s) to become ready <span class="keyword">in</span> <span class="string">&quot;ng-4d9024eb&quot;</span></span><br><span class="line">2023-06-27 17:03:17 [ℹ]  nodegroup <span class="string">&quot;ng-4d9024eb&quot;</span> has 2 node(s)</span><br><span class="line">2023-06-27 17:03:17 [ℹ]  node <span class="string">&quot;ip-192-168-16-155.us-west-2.compute.internal&quot;</span> is ready</span><br><span class="line">2023-06-27 17:03:17 [ℹ]  node <span class="string">&quot;ip-192-168-48-14.us-west-2.compute.internal&quot;</span> is ready</span><br><span class="line">2023-06-27 17:03:19 [ℹ]  kubectl <span class="built_in">command</span> should work with <span class="string">&quot;/Users/hanqf/.kube/config&quot;</span>, try <span class="string">&#x27;kubectl get nodes&#x27;</span></span><br><span class="line">2023-06-27 17:03:19 [✔]  EKS cluster <span class="string">&quot;eks-lexing&quot;</span> <span class="keyword">in</span> <span class="string">&quot;us-west-2&quot;</span> region is ready</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>eks集群创建成功后会在<code>~/.kube/config</code>文件中自动加上集群的配置信息</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">clusters:</span><br><span class="line">- cluster:</span><br><span class="line">    certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUMvakNDQWVhZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwcmRXSmwKY201bGRHVnpNQjRYRFRJek1EWXlPREEyTWpNeU1Wb1hEVE16TURZeU5UQTJNak15TVZvd0ZURVRNQkVHQTFVRQpBeE1LYTNWaVpYSnVaWFJsY3pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTXJVCk94RHJUTHR1lKeWUzUkQxQXFpeTdnUCtROApGdGNOSkNaUzJHSkV3d1hYcmZEK25YL0F1dFo2NVh0ZVR0KzdNZmdnQW1UVWNSaTM0cEhJcVhmN0R0eHY2VnhJCnVBUk9rbzhQRWIyNUpsYVRDRU9GWkRHeXJPdjlDMjE0ZEdudzJFRFV2QVJMR0E1bW5PN0EwanZlRG1zQWcrTzgKZGx3PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==</span><br><span class="line">    server: https://1029FF88CB872B655555565D44191A56.gr7.us-west-2.eks.amazonaws.com</span><br><span class="line">  name: eks-lexing.us-west-2.eksctl.io</span><br><span class="line">contexts:</span><br><span class="line">- context:</span><br><span class="line">    cluster: eks-lexing.us-west-2.eksctl.io</span><br><span class="line">    user: hanqunfeng@eks-lexing.us-west-2.eksctl.io</span><br><span class="line">  name: hanqunfeng@eks-lexing.us-west-2.eksctl.io</span><br><span class="line">current-context: hanqunfeng@eks-lexing.us-west-2.eksctl.io</span><br><span class="line">kind: Config</span><br><span class="line">preferences: &#123;&#125;</span><br><span class="line"><span class="built_in">users</span>:</span><br><span class="line">- name: hanqunfeng@eks-lexing.us-west-2.eksctl.io</span><br><span class="line">  user:</span><br><span class="line">    <span class="built_in">exec</span>:</span><br><span class="line">      apiVersion: client.authentication.k8s.io/v1beta1</span><br><span class="line">      args:</span><br><span class="line">      - eks</span><br><span class="line">      - get-token</span><br><span class="line">      - --output</span><br><span class="line">      - json</span><br><span class="line">      - --cluster-name</span><br><span class="line">      - eks-lexing</span><br><span class="line">      - --region</span><br><span class="line">      - us-west-2</span><br><span class="line">      <span class="built_in">command</span>: aws</span><br><span class="line">      <span class="built_in">env</span>:</span><br><span class="line">      - name: AWS_STS_REGIONAL_ENDPOINTS</span><br><span class="line">        value: regional</span><br><span class="line">      - name: AWS_PROFILE</span><br><span class="line">        value: eks-us-west-2</span><br><span class="line">      interactiveMode: IfAvailable</span><br><span class="line">      provideClusterInfo: <span class="literal">false</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p><code>~/.kube/config</code>文件说明</p><ul class="lvl-2"><li class="lvl-6"><code>clusters</code> : 集群基本信息，可以配置多个，其包含<code>certificate-authority-data</code>–证书和<code>server</code>–API 服务器终端节点，这部分内容可以在aws控制台&quot;EKS–集群–eks-lexing&quot;中查看到。</li><li class="lvl-6"><code>users</code> : 用户认证信息，可以配置多个，这里可以看到是基于<code>aws</code>命令进行认证的。</li><li class="lvl-6"><code>contexts</code> : 上下文环境信息，这部分会将<code>clusters</code>与<code>users</code>进行一对一关联。</li><li class="lvl-6"><code>current-context</code> : 当前默认的集群上下文。</li><li class="lvl-6">文件内容编辑后立即生效。</li></ul></li><li class="lvl-2"><p>如果要在<code>~/.kube/config</code>中加入已经创建好的集群，可以通过如下命令实现，当然，手工编辑文件也可以。</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ aws eks update-kubeconfig --name eks-lexing  --profile eks-us-west-2</span><br><span class="line"><span class="comment"># 或者</span></span><br><span class="line">$ <span class="built_in">export</span> AWS_PROFILE=eks-us-west-2</span><br><span class="line">$ aws eks update-kubeconfig --name eks-lexing</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>通过当前IAM帐号创建的eks，则只有该帐号有权限管理和查看，如果希望其它帐号也有权限，则需要进行授权，这个后面会介绍。</p></li><li class="lvl-2"><p>验证是否可以访问集群</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看节点组信息</span></span><br><span class="line">$ eksctl get nodegroup --cluster eks-lexing --profile eks-us-west-2</span><br><span class="line">CLUSTERNODEGROUPSTATUSCREATEDMIN SIZEMAX SIZEDESIRED CAPACITYINSTANCE TYPEIMAGE IDASG NAMETYPE</span><br><span class="line">eks-lexingng-4d9024ebACTIVE2023-06-28T06:30:03Z252m5.largeAL2_x86_64eks-ng-4d9024eb-20c48058-e974-c6ec-786a-516c31131604managed</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看集群的命名空间，这里使用了kubectl的别名k</span></span><br><span class="line">$ k get ns</span><br><span class="line">NAME              STATUS   AGE</span><br><span class="line">default           Active   11m</span><br><span class="line">kube-node-lease   Active   11m</span><br><span class="line">kube-public       Active   11m</span><br><span class="line">kube-system       Active   11m</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>登录aws控制台，查看<code>us-west-2</code>下的<code>EC2</code>,<code>VPC</code>,<code>CloudFormation</code>,<code>EKS</code>等等，可以看到相应的资源已经创建完成。<br>EC2实例: 工作节点实例<br><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/eENw5L.png" alt="" width="1200" height="300"><br>EBS: 工作节点挂载的卷<br><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/MQx1yO.png" alt="" width="1200" height="300"><br>Auto Scaling 组: 节点组<br><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/KOusMS.png" alt="" width="900" height="300"><br>弹性IP:<br><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/EdMBgh.png" alt="" width="1200" height="300"><br>安全组：<br><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/N77sRk.png" alt="" width="1200" height="400"><br>VPC:<br><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/ucZYmM.png" alt="" width="1200" height="800"><br>EKS: 这里eks升级到1.26了，升级eks后面会介绍<br><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/pGZpve.png" alt="" width="1200" height="800"></p></li></ul><div class="tips"><p><em><strong>小贴士</strong></em><br>不要手工修改<code>EC2</code>下关于eks的Auto Scaling 组，如果要修改弹性伸缩，需要在<code>EKS</code>的工作节点组的配置中进行修改<br><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/PDOeyT.png" alt="" width="400" height="400"></p></div><h2 id="后续">后续</h2><ul class="lvl-0"><li class="lvl-2"><p>上面我们就完成了通过命令行在新的VPC下创建全新eks集群的过程，其它创建方式详见<a href="https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/create-cluster.html">AWS帮助文档</a>，但是这还没完，为了更好的使用aws为我们提供的资源和服务，我们还需要为这个eks集群做一些必要操作：</p><ul class="lvl-2"><li class="lvl-6"><a href="/2023/07/07/aws-eks03-oidc/" title="AWS-EKS-03--创建 IAM OIDC 身份提供商">创建 IAM OIDC 身份提供商</a></li><li class="lvl-6"><a href="/2023/07/07/aws-eks04-vpc-cni/" title="AWS-EKS-04--安装 Amazon VPC CNI">配置 Amazon VPC CNI plugin for Kubernetes 将 IAM 角色用于服务账户</a></li><li class="lvl-6"><a href="/2023/07/07/aws-eks05-ebs-csi/" title="AWS-EKS-05--安装 Amazon EBS CSI 驱动程序">安装 Amazon EBS CSI 驱动程序</a></li><li class="lvl-6"><a href="/2023/07/07/aws-eks06-efs-csi/" title="AWS-EKS-06--安装 Amazon EFS CSI 驱动程序">安装 Amazon EFS CSI 驱动程序</a></li><li class="lvl-6"><a href="/2023/07/07/aws-eks07-loadbalancer/" title="AWS-EKS-07--安装 AWS Load Balancer Controller 附加组件">安装 AWS Load Balancer Controller 附加组件</a></li><li class="lvl-6"><a href="/2023/07/07/aws-eks11-metrics/" title="AWS-EKS-11--安装 Kubernetes Metrics Server">安装 Kubernetes Metrics Server</a></li><li class="lvl-6"><a href="/2023/07/18/aws-eks18-autoscaler-cas/" title="AWS-EKS-18--Autoscaling 之 Cluster Autoscaler(CAS)">安装 Autoscaling 之 Cluster Autoscaler(CAS)</a></li></ul></li></ul>]]></content>
    
    
    <summary type="html">&lt;!--
 **加粗**
 *斜体*
 ***加粗并斜体***
 ~~删除线~~
 ==突出显示==
 `突出显示(推荐)`
 ++下划线++
 ~下标~
 ^上标^
 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.
 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600)

 +++ **点击折叠**
 这是被隐藏的内容
 +++

::: tips success warning danger
这里是容器内的内容
:::

% note info % success warning danger
这里是容器内的内容
% endnote %

 --&gt;
&lt;h2 id=&quot;摘要&quot;&gt;摘要&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;本文介绍在AWS中创建EKS集群的过程&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;参考资料：&lt;/p&gt;
&lt;ul class=&quot;lvl-2&quot;&gt;
&lt;li class=&quot;lvl-6&quot;&gt;&lt;a href=&quot;https://docs.aws.amazon.com/zh_cn/eks/latest/userguide&quot;&gt;Amazon EKS用户指南&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-6&quot;&gt;&lt;a href=&quot;https://kubernetes.io/zh-cn/docs/home/&quot;&gt;Kubernetes 文档&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="技术" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="aws" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/aws/"/>
    
    <category term="eks" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/aws/eks/"/>
    
    
    <category term="java" scheme="https://blog.hanqunfeng.com/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>AWS-EKS-01--命令行工具</title>
    <link href="https://blog.hanqunfeng.com/2023/07/06/aws-eks01-install-tool/"/>
    <id>https://blog.hanqunfeng.com/2023/07/06/aws-eks01-install-tool/</id>
    <published>2023-07-06T14:30:05.000Z</published>
    <updated>2023-07-11T02:21:25.681Z</updated>
    
    <content type="html"><![CDATA[<!-- **加粗** *斜体* ***加粗并斜体*** ~~删除线~~ ==突出显示== `突出显示(推荐)` ++下划线++ ~下标~ ^上标^ 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference. 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600) +++ **点击折叠** 这是被隐藏的内容 +++::: tips success warning danger这里是容器内的内容:::% note info % success warning danger这里是容器内的内容% endnote % --><h2 id="摘要">摘要</h2><ul class="lvl-0"><li class="lvl-2"><p>本文介绍在AWS中创建EKS集群的过程中会使用到的命令行工具的安装方法</p></li><li class="lvl-2"><p>参考资料：</p><ul class="lvl-2"><li class="lvl-6"><a href="https://docs.aws.amazon.com/zh_cn/eks/latest/userguide">Amazon EKS用户指南</a></li><li class="lvl-6"><a href="https://kubernetes.io/zh-cn/docs/home/">Kubernetes 文档</a></li></ul></li></ul><span id="more"></span><h2 id="安装命令行工具">安装命令行工具</h2><h3 id="AWS-CLI">AWS CLI</h3><ul class="lvl-0"><li class="lvl-2"><p><a href="https://docs.aws.amazon.com/zh_cn/cli/latest/userguide/cli-chap-welcome.html">AWS Command Line Interface (AWS CLI)</a> 是一种开源工具，让您能够在命令行 Shell 中使用命令与 AWS 服务进行交互。</p></li><li class="lvl-2"><p>要使用 AWS CLI 访问 AWS 服务，您需要 AWS 账户 和 IAM 凭证。运行 AWS CLI 命令时，AWS CLI 需要有权访问这些 AWS 凭证。为了提高 AWS 账户的安全性，建议您不要使用根账户凭证。您应创建一个具有最低权限的用户来为将在 AWS 中运行的任务提供访问凭证。</p></li><li class="lvl-2"><p>登录AWS控制台，在IAM里创建一个用户，为了方便对资源进行管理可以授予其管理员访问权限(AdministratorAccess)，并在其安全凭证中创建一个新的访问密钥。</p></li><li class="lvl-2"><p><a href="https://docs.aws.amazon.com/zh_cn/cli/latest/userguide/getting-started-install.html">安装AWS CLI</a>，这里以mac为例</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ curl <span class="string">&quot;https://awscli.amazonaws.com/AWSCLIV2.pkg&quot;</span> -o <span class="string">&quot;AWSCLIV2.pkg&quot;</span></span><br><span class="line">$ sudo installer -pkg AWSCLIV2.pkg -target /</span><br><span class="line">$ <span class="built_in">which</span> aws</span><br><span class="line">/usr/local/bin/aws</span><br><span class="line">$ aws --version</span><br><span class="line">aws-cli/2.12.3 Python/3.11.4 Darwin/21.6.0 exe/x86_64 prompt/off</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>升级时重新执行上面的的安装过程即可</p></li><li class="lvl-2"><p><a href="https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-completion.html">命令提示补全</a>，以zsh为例，在<code>~/.zshrc</code>中添加如下内容，为了立即生效可以执行<code>source ~/.zshrc</code></p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">autoload</span> bashcompinit &amp;&amp; bashcompinit</span><br><span class="line"><span class="built_in">autoload</span> -Uz compinit &amp;&amp; compinit</span><br><span class="line">complete -C <span class="string">&#x27;/usr/local/bin/aws_completer&#x27;</span> aws</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>配置文件在<code>~/.aws</code>目录下，分为 <code>config</code> 和 <code>credentials</code>，可以设置多份凭证，设置时可以直接编辑对应的配置文件，也可以通过如下命令设置</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 默认default，这里配置上用户的访问密钥</span></span><br><span class="line">$ aws configure</span><br><span class="line">AWS Access Key ID [None]: AKIAIOSFODNN7EXAMPLE</span><br><span class="line">AWS Secret Access Key [None]: wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY</span><br><span class="line">Default region name [None]: us-west-1</span><br><span class="line">Default output format [None]: json</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定profile，后面所有命令中涉及到凭证的部分都使用该profile</span></span><br><span class="line">$ aws configure --profile eks-us-west-2</span><br><span class="line">AWS Access Key ID [None]: AKIAIOSFODNN7EXAMPLE</span><br><span class="line">AWS Secret Access Key [None]: wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY</span><br><span class="line">Default region name [None]: us-west-2</span><br><span class="line">Default output format [None]: json</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看配置</span></span><br><span class="line">$ <span class="built_in">cat</span> ~/.aws/config</span><br><span class="line">[default]</span><br><span class="line">region = us-west-1</span><br><span class="line">output = json</span><br><span class="line">[profile eks-us-west-2]</span><br><span class="line">region = us-west-2</span><br><span class="line">output = json</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> ~/.aws/credentials</span><br><span class="line">[default]</span><br><span class="line">aws_access_key_id = AKIAIOSFODNN7EXAMPLE</span><br><span class="line">aws_secret_access_key = wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY</span><br><span class="line">[eks-us-west-2]</span><br><span class="line">aws_access_key_id = AKIAIOSFODNN7EXAMPLE</span><br><span class="line">aws_secret_access_key = wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看所有profile</span></span><br><span class="line">$ aws configure list-profiles</span><br><span class="line">default</span><br><span class="line">eks-us-west-2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看指定的profile的信息</span></span><br><span class="line">$ aws configure list --profile eks-us-west-2</span><br><span class="line">      Name                    Value             Type    Location</span><br><span class="line">      ----                    -----             ----    --------</span><br><span class="line">   profile               eks-us-west-2           manual    --profile</span><br><span class="line">access_key     ****************IP6L shared-credentials-file</span><br><span class="line">secret_key     ****************OIQU shared-credentials-file</span><br><span class="line">    region                us-west-2      config-file    ~/.aws/config</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看与profile对应的用户信息</span></span><br><span class="line">$ aws sts get-caller-identity --profile eks-us-west-2</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;UserId&quot;</span>: <span class="string">&quot;AIDA55DP3G4GIDWF2GNIR&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Account&quot;</span>: <span class="string">&quot;743263909655&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Arn&quot;</span>: <span class="string">&quot;arn:aws:iam::743263909655:user/hanqunfeng&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>使用aws命令时，如果不指定<code>--profile</code>，则默认使用<code>default</code>对应的认证信息，也可以通过环境变量指定要使用的profile</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">export</span> AWS_PROFILE=eks-us-west-2</span><br></pre></td></tr></table></figure><h3 id="kubectl">kubectl</h3><ul class="lvl-0"><li class="lvl-2"><p>Kubectl 是一个命令行工具，用于与 Kubernetes API 服务器进行通信。这个命令非常重要，后面会有一节专门介绍。</p></li><li class="lvl-2"><p><a href="https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/install-kubectl.html">安装或更新 kubectl</a>，这里以mac为例</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 从 Amazon S3 为集群的 Kubernetes 版本下载二进制文件</span></span><br><span class="line"><span class="comment"># 这里下载Kubernetes 1.26</span></span><br><span class="line">$ curl -O https://s3.us-west-2.amazonaws.com/amazon-eks/1.26.4/2023-05-11/bin/darwin/amd64/kubectl</span><br><span class="line"><span class="comment"># 授予执行权限</span></span><br><span class="line">$ <span class="built_in">chmod</span> +x ./kubectl</span><br><span class="line"><span class="comment"># 将命令复制到 $PATH 中</span></span><br><span class="line">$ sudo <span class="built_in">mv</span> ./kubectl /usr/local/bin/kubectl</span><br><span class="line"><span class="comment"># 查看kubectl版本，由于此时还没有配置k8s的server端，所以这里只查看client的的信息</span></span><br><span class="line">$ kubectl version --client -o yaml</span><br><span class="line"></span><br><span class="line">clientVersion:</span><br><span class="line">  buildDate: <span class="string">&quot;2023-04-15T00:36:29Z&quot;</span></span><br><span class="line">  compiler: gc</span><br><span class="line">  gitCommit: 4a3479673cb6d9b63f1c69a67b57de30a4d9b781</span><br><span class="line">  gitTreeState: clean</span><br><span class="line">  gitVersion: v1.26.4-eks-0a21954</span><br><span class="line">  goVersion: go1.19.8</span><br><span class="line">  major: <span class="string">&quot;1&quot;</span></span><br><span class="line">  minor: 26+</span><br><span class="line">  platform: darwin/amd64</span><br><span class="line">kustomizeVersion: v4.5.7</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>升级时重新执行上面的的安装过程即可</p></li><li class="lvl-2"><p><a href="https://kubernetes.io/zh-cn/docs/tasks/tools/install-kubectl-macos/">命令提示补全和别名设置</a>，以zsh为例，在<code>~/.zshrc</code>中添加如下内容，为了立即生效可以执行<code>source ~/.zshrc</code></p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># k8s client kubectl</span></span><br><span class="line"><span class="built_in">source</span> &lt;(kubectl completion zsh)</span><br><span class="line"><span class="built_in">alias</span> k=kubectl</span><br><span class="line"><span class="comment"># change namespace</span></span><br><span class="line"><span class="built_in">alias</span> kn=<span class="string">&quot;k config set-context --current --namespace&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Delete Now</span></span><br><span class="line"><span class="built_in">alias</span> kdp=<span class="string">&quot;k delete pod --grace-period=0 --force&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># View current context</span></span><br><span class="line"><span class="comment"># 直接设置别名的方式不行，因为在设置alias时，$(k config current-context)就会被执行了，所以不会根据当时情况进行替换，可以使用函数来实现</span></span><br><span class="line"><span class="comment"># alias kcc=&quot;k config get-contexts $(k config current-context)&quot;</span></span><br><span class="line"><span class="comment"># 注意这里函数不能使用字母 k 开头，会报错 &quot;defining function based on alias `k&#x27;&quot;</span></span><br><span class="line"><span class="function"><span class="title">cc</span></span>() &#123;</span><br><span class="line">   k config get-contexts $(k config current-context)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 然后再将函数设置别名即可实现</span></span><br><span class="line"><span class="built_in">alias</span> kcc=cc</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>kubectl的配置文件为<code>~/.kube/config</code>，在创建eks集群时会进一步介绍。</p></li></ul><h3 id="eksctl">eksctl</h3><ul class="lvl-0"><li class="lvl-2"><p>eksctl 是一款简单的命令行工具，用于在 Amazon EKS 上创建和管理 Kubernetes 集群。eksctl 提供使用 Amazon EKS 节点创建新集群的最快、最简单的方式。</p></li><li class="lvl-2"><p><code>eksctl</code>与<code>AWS CLI</code>共用认证信息，即<code>~/.aws</code>下的配置</p></li><li class="lvl-2"><p><a href="https://github.com/weaveworks/eksctl/blob/main/README.md#installation">安装或更新 eksctl</a>，这里以mac为例</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># for ARM systems, set ARCH to: `arm64`, `armv6` or `armv7`</span></span><br><span class="line">$ ARCH=amd64</span><br><span class="line">$ PLATFORM=$(<span class="built_in">uname</span> -s)_<span class="variable">$ARCH</span></span><br><span class="line"><span class="comment"># 下载</span></span><br><span class="line">$ curl -sLO <span class="string">&quot;https://github.com/weaveworks/eksctl/releases/latest/download/eksctl_<span class="variable">$PLATFORM</span>.tar.gz&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (Optional) Verify checksum</span></span><br><span class="line">$ curl -sL <span class="string">&quot;https://github.com/weaveworks/eksctl/releases/latest/download/eksctl_checksums.txt&quot;</span> | grep <span class="variable">$PLATFORM</span> | <span class="built_in">sha256sum</span> --check</span><br><span class="line"><span class="comment"># 解压</span></span><br><span class="line">$ tar -xzf eksctl_<span class="variable">$PLATFORM</span>.tar.gz -C /tmp &amp;&amp; <span class="built_in">rm</span> eksctl_<span class="variable">$PLATFORM</span>.tar.gz</span><br><span class="line"><span class="comment"># 移动到$PATH</span></span><br><span class="line">$ sudo <span class="built_in">mv</span> /tmp/eksctl /usr/local/bin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看版本</span></span><br><span class="line">$ eksctl version</span><br><span class="line"></span><br><span class="line">0.146.0</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>升级时重新执行上面的的安装过程即可</p></li><li class="lvl-2"><p><a href="https://eksctl.io/introduction/#shell-completion">代码补全</a>，以zsh为例</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> -p ~/.zsh/completion/</span><br><span class="line">$ eksctl completion zsh &gt; ~/.zsh/completion/_eksctl</span><br><span class="line"></span><br><span class="line"><span class="comment"># 并将以下内容放入~/.zshrc中：</span></span><br><span class="line">fpath=(<span class="variable">$fpath</span> ~/.zsh/completion)</span><br><span class="line"><span class="built_in">autoload</span> -U compinit</span><br><span class="line">compinit</span><br></pre></td></tr></table></figure><h3 id="helm">helm</h3><ul class="lvl-0"><li class="lvl-2"><p><a href="https://helm.sh/zh/docs/">Helm</a> 是 Kubernetes 的包管理器</p></li><li class="lvl-2"><p><a href="https://helm.sh/zh/docs/intro/install/">安装或更新 Helm</a>，在<a href="https://github.com/helm/helm/releases">Helm 版本</a>中下载对应的版本，以mac为例</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载</span></span><br><span class="line">$ curl -O https://get.helm.sh/helm-v3.12.1-darwin-amd64.tar.gz</span><br><span class="line"><span class="comment"># 解压</span></span><br><span class="line">$ tar -zxvf helm-v3.12.1-darwin-amd64.tar.gz</span><br><span class="line"><span class="comment"># 移动到$PATH</span></span><br><span class="line">$ sudo <span class="built_in">mv</span> darwin-amd64/helm /usr/local/bin/helm</span><br><span class="line"><span class="comment"># 查看版本</span></span><br><span class="line">$ helm version --short</span><br><span class="line"></span><br><span class="line">v3.12.1+gf32a527</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>升级时重新执行上面的的安装过程即可</p></li><li class="lvl-2"><p><a href="https://helm.sh/zh/docs/helm/helm_completion_zsh/">命令提示补全</a>，以zsh为例，在<code>~/.zshrc</code>中添加如下内容，为了立即生效可以执行<code>source ~/.zshrc</code></p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> &lt;(helm completion zsh)</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;!--
 **加粗**
 *斜体*
 ***加粗并斜体***
 ~~删除线~~
 ==突出显示==
 `突出显示(推荐)`
 ++下划线++
 ~下标~
 ^上标^
 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.
 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600)

 +++ **点击折叠**
 这是被隐藏的内容
 +++

::: tips success warning danger
这里是容器内的内容
:::

% note info % success warning danger
这里是容器内的内容
% endnote %

 --&gt;
&lt;h2 id=&quot;摘要&quot;&gt;摘要&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;本文介绍在AWS中创建EKS集群的过程中会使用到的命令行工具的安装方法&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;参考资料：&lt;/p&gt;
&lt;ul class=&quot;lvl-2&quot;&gt;
&lt;li class=&quot;lvl-6&quot;&gt;&lt;a href=&quot;https://docs.aws.amazon.com/zh_cn/eks/latest/userguide&quot;&gt;Amazon EKS用户指南&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-6&quot;&gt;&lt;a href=&quot;https://kubernetes.io/zh-cn/docs/home/&quot;&gt;Kubernetes 文档&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="技术" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="aws" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/aws/"/>
    
    <category term="eks" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/aws/eks/"/>
    
    
    <category term="java" scheme="https://blog.hanqunfeng.com/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>Java并发编程--线程池之ForkJoinPool</title>
    <link href="https://blog.hanqunfeng.com/2023/05/29/java-concurrency12-ForkJoinPool/"/>
    <id>https://blog.hanqunfeng.com/2023/05/29/java-concurrency12-ForkJoinPool/</id>
    <published>2023-05-29T14:34:05.000Z</published>
    <updated>2023-06-01T10:47:36.217Z</updated>
    
    <content type="html"><![CDATA[<!-- **加粗** *斜体* ***加粗并斜体*** ~~删除线~~ ==突出显示== `突出显示(推荐)` ++下划线++ ~下标~ ^上标^ 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference. 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600) +++ **点击折叠** 这是被隐藏的内容 +++::: tips success warning danger这里是容器内的内容:::% note info % success warning danger这里是容器内的内容% endnote % --><h2 id="摘要">摘要</h2><ul class="lvl-0"><li class="lvl-2"><p>本文介绍线程池ForkJoinPool相关技术</p></li><li class="lvl-2"><p>本文基于<code>jdk1.8</code></p></li></ul><span id="more"></span><h2 id="Fork-Join框架介绍">Fork/Join框架介绍</h2><ul class="lvl-0"><li class="lvl-2"><p><code>Fork/Join</code>是一个是一个并行计算的框架，主要就是用来支持分治任务模型的，这个计算框架里的 <code>Fork</code>对应的是分治任务模型里的任务分解，<code>Join</code> 对应的是结果合并。</p></li><li class="lvl-2"><p>它的核心思想是将一个大任务分成许多小任务，然后并行执行这些小任务，最终将它们的结果合并成一个大的结果。</p></li><li class="lvl-2"><p><code>Fork/Join</code>模式是实现任务并行性的一种常用模式，它将大任务递归地分解成小任务，然后利用多线程并行执行这些小任务。</p></li><li class="lvl-2"><p><code>Fork/Join</code>框架的主要组成部分是<code>ForkJoinPool</code>、<code>ForkJoinTask</code>。<code>ForkJoinPool</code>是一个线程池，它用于管理<code>Fork/Join</code>任务的执行。<code>ForkJoinTask</code>是一个抽象类，用于表示可以被分割成更小部分的任务。</p></li><li class="lvl-2"><p><code>Fork/Join</code>框架更适合执行CPU密集型任务，同时需要避免在<code>ForkJoinPool</code>中提交大量的阻塞型任务，以免影响整个线程池的性能。</p></li></ul><h3 id="应用场景">应用场景</h3><ul class="lvl-0"><li class="lvl-2"><p>1.递归分解型任务<br><code>Fork/Join</code>框架特别适用于递归分解型的任务，例如排序、归并、遍历等。这些任务通常可以将大的任务分解成若干个子任务，每个子任务可以独立执行，并且可以通过归并操作将子任务的结果合并成一个有序的结果。</p></li><li class="lvl-2"><p>2.数组处理<br><code>Fork/Join</code>框架还可以用于数组的处理，例如数组的排序、查找、统计等。在处理大型数组时，<code>Fork/Join</code>框架可以将数组分成若干个子数组，并行地处理每个子数组，最后将处理后的子数组合并成一个有序的大数组。</p></li><li class="lvl-2"><p>3.并行化算法<br><code>Fork/Join</code>框架还可以用于并行化算法的实现，例如并行化的图像处理算法、并行化的机器学习算法等。在这些算法中，可以将问题分解成若干个子问题，并行地解决每个子问题，然后将子问题的结果合并起来得到最终的解决方案。</p></li><li class="lvl-2"><p>4.大数据处理<br><code>Fork/Join</code>框架还可以用于大数据处理，例如大型日志文件的处理、大型数据库的查询等。在处理大数据时，可以将数据分成若干个分片，并行地处理每个分片，最后将处理后的分片合并成一个完整的结果</p></li></ul><h2 id="ForkJoinPool介绍">ForkJoinPool介绍</h2><ul class="lvl-0"><li class="lvl-2"><p><code>ForkJoinPool</code>是<code>Fork/Join</code>框架中的线程池类，它用于管理<code>Fork/Join</code>任务的线程，基于工作窃取算法（work-stealing）来实现任务的分配和执行。</p></li><li class="lvl-2"><p><code>ForkJoinPool</code>类包括一些重要的方法，例如<code>submit()</code>、<code>invoke()</code>、<code>shutdown()</code>、<code>awaitTermination()</code>等，用于提交任务、执行任务、关闭线程池和等待任务的执行结果。<code>ForkJoinPool</code>类中还包括一些参数，例如线程池的大小、工作线程的优先级、任务队列的容量等，可以根据具体的应用场景进行设置。</p></li><li class="lvl-2"><p>常用API</p></li></ul><table><thead><tr><th>API/方法</th><th>返回值</th><th>描述</th></tr></thead><tbody><tr><td><code>ForkJoinPool(int parallelism)</code></td><td>无</td><td>使用指定的并行度创建一个新的ForkJoinPool。</td></tr><tr><td><code>invoke(ForkJoinTask&lt;T&gt; task)</code></td><td>T</td><td>同步执行给定的任务，并返回结果。</td></tr><tr><td><code>submit(ForkJoinTask&lt;T&gt; task)</code></td><td><code>Future&lt;T&gt;</code></td><td>异步执行给定的任务，并返回一个<code>Future</code>对象，可以用于获取任务的执行结果。</td></tr><tr><td><code>execute(ForkJoinTask&lt;?&gt; task)</code></td><td>无</td><td>异步执行给定的任务，没有返回值。</td></tr><tr><td><code>awaitTermination(long timeout, TimeUnit unit)</code></td><td><code>boolean</code></td><td>阻塞当前线程，直到所有任务执行完成或超过指定的超时时间，并返回是否成功终止。</td></tr><tr><td><code>isShutdown()</code></td><td><code>boolean</code></td><td>判断ForkJoinPool是否已经关闭。</td></tr><tr><td><code>isTerminated()</code></td><td><code>boolean</code></td><td>判断ForkJoinPool中的所有任务是否已经执行完成。</td></tr><tr><td><code>shutdown()</code></td><td>无</td><td>优雅地关闭ForkJoinPool，不再接受新的任务，并等待已提交的任务执行完成。</td></tr><tr><td><code>shutdownNow()</code></td><td><code>List&lt;Runnable&gt;</code></td><td>强制关闭ForkJoinPool，尝试取消所有正在执行的任务，并返回等待执行的任务列表。</td></tr><tr><td><code>getParallelism()</code></td><td><code>int</code></td><td>获取ForkJoinPool的并行度，即同时执行任务的线程数。</td></tr><tr><td><code>getPoolSize()</code></td><td><code>int</code></td><td>获取ForkJoinPool中当前的工作线程数。</td></tr><tr><td><code>getActiveThreadCount()</code></td><td><code>int</code></td><td>获取ForkJoinPool中当前活动的线程数。</td></tr><tr><td><code>getQueuedTaskCount()</code></td><td><code>long</code></td><td>获取ForkJoinPool中当前等待执行的任务数。</td></tr><tr><td><code>getRunningThreadCount()</code></td><td><code>int</code></td><td>获取ForkJoinPool中当前正在执行任务的线程数。</td></tr><tr><td><code>getStealCount()</code></td><td><code>long</code></td><td>获取ForkJoinPool中总共发生的工作窃取次数。</td></tr></tbody></table><h2 id="ForkJoinPool的创建">ForkJoinPool的创建</h2><ul class="lvl-0"><li class="lvl-2"><p>ForkJoinPool中有四个核心参数，用于控制线程池的并行数、工作线程的创建、异常处理和模式指定等。各参数解释如下：</p><ul class="lvl-2"><li class="lvl-6"><code>int parallelism</code>：指定并行级别（parallelism level）。<br>ForkJoinPool将根据这个设定，决定工作线程的数量。如果未设置的话，将使用<code>Runtime.getRuntime().availableProcessors()</code>来设置并行级别；  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ForkJoinPool</span><span class="params">(<span class="type">int</span> parallelism)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>(parallelism, defaultForkJoinWorkerThreadFactory, <span class="literal">null</span>, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li class="lvl-6"><code>ForkJoinWorkerThreadFactory factory</code>：ForkJoinPool在创建线程时，会通过factory来创建。<br>注意，这里需要实现的是<code>ForkJoinWorkerThreadFactory</code>，而不是<code>ThreadFactory</code>。如果你不指定<code>factory</code>，那么将由默认的<code>DefaultForkJoinWorkerThreadFactory</code>负责线程的创建工作；</li><li class="lvl-6"><code>UncaughtExceptionHandler handler</code>：指定异常处理器<br>当任务在运行中出错时，将由设定的处理器处理；</li><li class="lvl-6"><code>boolean asyncMode</code>：设置队列的工作模式。<br>当<code>asyncMode</code>为<code>true</code>时，将使用先进先出队列，而为<code>false</code>时则使用后进先出的模式。  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ForkJoinPool</span><span class="params">(<span class="type">int</span> parallelism,</span></span><br><span class="line"><span class="params">                ForkJoinWorkerThreadFactory factory,</span></span><br><span class="line"><span class="params">                UncaughtExceptionHandler handler,</span></span><br><span class="line"><span class="params">                <span class="type">boolean</span> asyncMode)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>(checkParallelism(parallelism),</span><br><span class="line">        checkFactory(factory),</span><br><span class="line">        handler,</span><br><span class="line">        asyncMode ? FIFO_QUEUE : LIFO_QUEUE,</span><br><span class="line">        <span class="string">&quot;ForkJoinPool-&quot;</span> + nextPoolId() + <span class="string">&quot;-worker-&quot;</span>);</span><br><span class="line">    checkPermission();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取处理器数量</span></span><br><span class="line"><span class="type">int</span> <span class="variable">processors</span> <span class="operator">=</span> Runtime.getRuntime().availableProcessors();</span><br><span class="line"><span class="comment">//构建forkjoin线程池</span></span><br><span class="line"><span class="type">ForkJoinPool</span> <span class="variable">forkJoinPool</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ForkJoinPool</span>(processors);</span><br><span class="line"></span><br><span class="line"><span class="comment">//此时等同于无参创建</span></span><br><span class="line"><span class="type">ForkJoinPool</span> <span class="variable">forkJoinPool</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ForkJoinPool</span>();</span><br></pre></td></tr></table></figure><h2 id="ForkJoinTask介绍">ForkJoinTask介绍</h2><ul class="lvl-0"><li class="lvl-2"><p><code>ForkJoinTask</code>是<code>Fork/Join</code>框架中的抽象类，它定义了执行任务的基本接口。用户可以通过继承<code>ForkJoinTask</code>类来实现自己的任务类，并重写其中的<code>compute()</code>方法来定义任务的执行逻辑。</p></li><li class="lvl-2"><p>通常情况下我们不需要直接继承<code>ForkJoinTask</code>类，而只需要继承它的子类，<code>Fork/Join</code>框架提供了以下三个子类：</p><ul class="lvl-2"><li class="lvl-6"><code>RecursiveAction</code>：用于递归执行但不需要返回结果的任务。</li><li class="lvl-6"><code>RecursiveTask</code> ：用于递归执行需要返回结果的任务。</li><li class="lvl-6"><code>CountedCompleter&lt;T&gt;</code> ：在任务完成执行后会触发执行一个自定义的钩子函数</li></ul></li><li class="lvl-2"><p><code>ForkJoinTask</code> 最核心的是 <code>fork()</code> 方法和 <code>join()</code>方法，承载着主要的任务协调作用，一个用于任务提交，一个用于结果获取。</p><ul class="lvl-2"><li class="lvl-6"><code>fork()</code>–提交任务<br><code>fork()</code>方法用于向当前任务所运行的线程池中提交任务。如果当前线程是<code>ForkJoinWorkerThread</code>类型，将会放入该线程的工作队列，否则放入<code>common</code>线程池的工作队列中。</li><li class="lvl-6"><code>join()</code>–获取任务执行结果<br><code>join()</code>方法用于获取任务的执行结果。调用<code>join()</code>时，将阻塞当前线程直到对应的子任务完成运行并返回结果</li></ul></li></ul><h2 id="ForkJoinPool-与-ForkJoinTask-使用示例">ForkJoinPool 与 ForkJoinTask 使用示例</h2><ul class="lvl-0"><li class="lvl-2"><p>利用<code>fork-join</code>实现数组归并排序算法</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ForkJoinPool;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.RecursiveTask;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 利用fork-join实现数组归并排序算法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MergeSortRecursiveTask</span> <span class="keyword">extends</span> <span class="title class_">RecursiveTask</span>&lt;<span class="type">int</span>[]&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> threshold; <span class="comment">//拆分的阈值，低于此阈值就不再进行拆分</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span>[] arrayToSort; <span class="comment">//要排序的数组</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MergeSortRecursiveTask</span><span class="params">(<span class="keyword">final</span> <span class="type">int</span>[] arrayToSort, <span class="keyword">final</span> <span class="type">int</span> threshold)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.arrayToSort = arrayToSort;</span><br><span class="line">        <span class="built_in">this</span>.threshold = threshold;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">int</span>[] compute() &#123;</span><br><span class="line">        <span class="comment">//拆分后的数组长度小于阈值，直接进行排序</span></span><br><span class="line">        <span class="keyword">if</span> (arrayToSort.length &lt;= threshold) &#123;</span><br><span class="line">            <span class="comment">// 调用jdk提供的排序方法</span></span><br><span class="line">            Arrays.sort(arrayToSort);</span><br><span class="line">            <span class="keyword">return</span> arrayToSort;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 对数组进行拆分</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">midpoint</span> <span class="operator">=</span> arrayToSort.length / <span class="number">2</span>;</span><br><span class="line">        <span class="type">int</span>[] leftArray = Arrays.copyOfRange(arrayToSort, <span class="number">0</span>, midpoint);</span><br><span class="line">        <span class="type">int</span>[] rightArray = Arrays.copyOfRange(arrayToSort, midpoint, arrayToSort.length);</span><br><span class="line"></span><br><span class="line">        <span class="type">MergeSortRecursiveTask</span> <span class="variable">leftTask</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MergeSortRecursiveTask</span>(leftArray, threshold);</span><br><span class="line">        <span class="type">MergeSortRecursiveTask</span> <span class="variable">rightTask</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MergeSortRecursiveTask</span>(rightArray, threshold);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 调用任务,阻塞当前线程，直到所有子任务执行完成</span></span><br><span class="line">        <span class="comment">// 使用invokeAll()方法同时提交多个任务，以提高任务的并行度，相当于同时fork并join</span></span><br><span class="line">        invokeAll(leftTask, rightTask);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//提交任务，多个任务同时提交时，推荐使用invokeAll()</span></span><br><span class="line">        <span class="comment">// leftTask.fork();</span></span><br><span class="line">        <span class="comment">// rightTask.fork();</span></span><br><span class="line">        <span class="comment">//合并结果</span></span><br><span class="line">        <span class="comment">// leftTask.join();</span></span><br><span class="line">        <span class="comment">// rightTask.join();</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 合并排序结果</span></span><br><span class="line">        arrayToSort = merge(leftTask.getSortedArray(), rightTask.getSortedArray());</span><br><span class="line">        <span class="keyword">return</span> arrayToSort;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span>[] getSortedArray() &#123;</span><br><span class="line">        <span class="keyword">return</span> arrayToSort;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 合并两个有序数组，并返回合并后的有序数组</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span>[] merge(<span class="keyword">final</span> <span class="type">int</span>[] leftArray, <span class="keyword">final</span> <span class="type">int</span>[] rightArray) &#123;</span><br><span class="line">        <span class="comment">// 定义用于合并结果的数组</span></span><br><span class="line">        <span class="type">int</span>[] mergedArray = <span class="keyword">new</span> <span class="title class_">int</span>[leftArray.length + rightArray.length];</span><br><span class="line">        <span class="type">int</span> <span class="variable">mergedArrayPos</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// 利用双指针进行两个数的比较</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">leftArrayPos</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">rightArrayPos</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (leftArrayPos &lt; leftArray.length &amp;&amp; rightArrayPos &lt; rightArray.length) &#123;</span><br><span class="line">            <span class="comment">// 比较左右数组中的元素大小，并将较小的元素放入合并结果数组中</span></span><br><span class="line">            <span class="keyword">if</span> (leftArray[leftArrayPos] &lt;= rightArray[rightArrayPos]) &#123;</span><br><span class="line">                mergedArray[mergedArrayPos] = leftArray[leftArrayPos];</span><br><span class="line">                leftArrayPos++;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mergedArray[mergedArrayPos] = rightArray[rightArrayPos];</span><br><span class="line">                rightArrayPos++;</span><br><span class="line">            &#125;</span><br><span class="line">            mergedArrayPos++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将剩余的左数组元素放入合并结果数组中</span></span><br><span class="line">        <span class="keyword">while</span> (leftArrayPos &lt; leftArray.length) &#123;</span><br><span class="line">            mergedArray[mergedArrayPos] = leftArray[leftArrayPos];</span><br><span class="line">            leftArrayPos++;</span><br><span class="line">            mergedArrayPos++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将剩余的右数组元素放入合并结果数组中</span></span><br><span class="line">        <span class="keyword">while</span> (rightArrayPos &lt; rightArray.length) &#123;</span><br><span class="line">            mergedArray[mergedArrayPos] = rightArray[rightArrayPos];</span><br><span class="line">            rightArrayPos++;</span><br><span class="line">            mergedArrayPos++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 返回合并后的有序数组</span></span><br><span class="line">        <span class="keyword">return</span> mergedArray;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 随机生成数组</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> size 数组的大小</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span>[] buildRandomIntArray(<span class="keyword">final</span> <span class="type">int</span> size) &#123;</span><br><span class="line">        <span class="type">int</span>[] arrayToCalculateSumOf = <span class="keyword">new</span> <span class="title class_">int</span>[size];</span><br><span class="line">        <span class="type">Random</span> <span class="variable">generator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; arrayToCalculateSumOf.length; i++) &#123;</span><br><span class="line">            arrayToCalculateSumOf[i] = generator.nextInt(<span class="number">10000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> arrayToCalculateSumOf;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//拆分的阈值</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">threshold</span> <span class="operator">=</span> <span class="number">20</span>;</span><br><span class="line">        <span class="type">int</span>[] arrayToSortByMergeSort = buildRandomIntArray(<span class="number">2000</span>);</span><br><span class="line">        System.out.print(<span class="string">&quot;排序前: &quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> element : arrayToSortByMergeSort) &#123;</span><br><span class="line">            System.out.print(element + <span class="string">&quot; &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println();</span><br><span class="line">        <span class="comment">//利用forkjoin排序</span></span><br><span class="line">        <span class="type">MergeSortRecursiveTask</span> <span class="variable">mergeSortRecursiveTask</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MergeSortRecursiveTask</span>(arrayToSortByMergeSort, threshold);</span><br><span class="line">        <span class="comment">//构建forkjoin线程池</span></span><br><span class="line">        <span class="type">ForkJoinPool</span> <span class="variable">forkJoinPool</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ForkJoinPool</span>();</span><br><span class="line">        <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">        <span class="comment">//执行排序任务</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span>[] mergeSortArray = forkJoinPool.invoke(mergeSortRecursiveTask);</span><br><span class="line">        System.out.print(<span class="string">&quot;排序后: &quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> element : mergeSortArray) &#123;</span><br><span class="line">            System.out.print(element + <span class="string">&quot; &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println();</span><br><span class="line"></span><br><span class="line">        <span class="type">long</span> <span class="variable">duration</span> <span class="operator">=</span> System.nanoTime() - startTime;</span><br><span class="line">        System.out.println(<span class="string">&quot;forkjoin排序时间: &quot;</span> + (duration / (<span class="number">1000f</span> * <span class="number">1000f</span>)) + <span class="string">&quot;毫秒&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ForkJoinPool工作原理">ForkJoinPool工作原理</h2><ul class="lvl-0"><li class="lvl-2"><p><code>ForkJoinPool</code> 内部有多个任务队列，当我们通过 <code>ForkJoinPool</code> 的 <code>invoke()</code> 或者 <code>submit()</code> 方法提交任务时，<code>ForkJoinPool</code> 根据一定的路由规则把任务提交到一个任务队列中，如果任务在执行过程中会创建出子任务，那么子任务会提交到工作线程对应的任务队列中。</p></li><li class="lvl-2"><p>如果工作线程对应的任务队列空了，是不是就没活儿干了呢？不是的，<code>ForkJoinPool</code> 支持一种叫做<code>任务窃取</code>的机制，如果工作线程空闲了，那它可以<code>窃取</code>其他工作任务队列里的任务。如此一来，所有的工作线程都不会闲下来了。</p></li></ul><div class="tips"><p><em><strong>小贴士</strong></em></p><h2 id="工作窃取">工作窃取</h2><ul class="lvl-1"><li class="lvl-2">工作窃取，就是允许空闲线程从繁忙线程的双端队列中窃取任务。</li><li class="lvl-2">默认情况下，工作线程从它自己的双端队列的头部获取任务。但是，当自己的任务为空时，线程会从其他繁忙线程双端队列的尾部中获取任务。这种方法，最大限度地减少了线程竞争任务的可能性。</li></ul></div><ul class="lvl-0"><li class="lvl-2"><p><code>ForkJoinPool</code>执行流程<br><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/1bBSl8.jpg" alt=""></p></li></ul><h2 id="总结">总结</h2><ul class="lvl-0"><li class="lvl-2"><p><code>Fork/Join</code>是一种基于分治思想的模型，在并发处理计算型任务时有着显著的优势。其效率的提升主要得益于两个方面：</p><ul class="lvl-2"><li class="lvl-6">任务切分：将大的任务分割成更小粒度的小任务，让更多的线程参与执行；</li><li class="lvl-6">任务窃取：通过任务窃取，充分地利用空闲线程，并减少竞争。</li></ul></li><li class="lvl-2"><p>在使用<code>ForkJoinPool</code>时，需要特别注意任务的类型是否为纯函数计算类型，也就是这些任务不应该关心状态或者外界的变化，这样才是最安全的做法。如果是阻塞类型任务，那么你需要谨慎评估技术方案。虽然ForkJoinPool也能处理阻塞类型任务，但可能会带来复杂的管理成本。</p></li></ul>]]></content>
    
    
    <summary type="html">&lt;!--
 **加粗**
 *斜体*
 ***加粗并斜体***
 ~~删除线~~
 ==突出显示==
 `突出显示(推荐)`
 ++下划线++
 ~下标~
 ^上标^
 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.
 图片设置宽度和高度 ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/innodb_buffer_pool.png =900x600)

 +++ **点击折叠**
 这是被隐藏的内容
 +++

::: tips success warning danger
这里是容器内的内容
:::

% note info % success warning danger
这里是容器内的内容
% endnote %

 --&gt;
&lt;h2 id=&quot;摘要&quot;&gt;摘要&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;本文介绍线程池ForkJoinPool相关技术&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;本文基于&lt;code&gt;jdk1.8&lt;/code&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="技术" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="java" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/java/"/>
    
    <category term="java多线程" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/java/java%E5%A4%9A%E7%BA%BF%E7%A8%8B/"/>
    
    
    <category term="java" scheme="https://blog.hanqunfeng.com/tags/java/"/>
    
  </entry>
  
</feed>
